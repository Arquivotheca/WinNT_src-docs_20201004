<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpiop.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpiop.h File Reference</h1><code>#include "..\pnp\pnpi.h"</code><br>
<code>#include "<a class="el" href="../../d0/d8/arbiter_8h-source.html">arbiter.h</a>"</code><br>
<code>#include "dockintf.h"</code><br>
<code>#include "<a class="el" href="../../d8/d0/pnprlist_8h-source.html">pnprlist.h</a>"</code><br>

<p>
<a href="../../d0/d0/pnpiop_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">_PENDING_SET_INTERFACE_STATE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">_DEVICE_NODE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/struct__NEW__DEVICE__WORK__ITEM.html">_NEW_DEVICE_WORK_ITEM</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/struct__ADD__CONTEXT.html">_ADD_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d6/struct__START__CONTEXT.html">_START_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">_PI_RESOURCE_ARBITER_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">_PI_RESOURCE_TRANSLATOR_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">_IOP_RESOURCE_REQUEST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html">_PI_DEVICE_REQUEST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">_IOPNP_DEVICE_EXTENSION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/struct__IOP__RESERVED__RESOURCES__RECORD.html">_IOP_RESERVED_RESOURCES_RECORD</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">_NOTIFY_ENTRY_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">_TARGET_DEVICE_NOTIFY_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html">_DEVICE_CLASS_NOTIFY_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html">_SETUP_NOTIFY_DATA</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">_HWPROFILE_NOTIFY_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/struct__BUFFER__INFO.html">_BUFFER_INFO</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">_BUS_TYPE_GUID_LIST</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a0">IOP_DNOD_TAG</a>&nbsp;&nbsp;&nbsp;'donD'</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a1">IOP_DNDT_TAG</a>&nbsp;&nbsp;&nbsp;'tdnD'</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a2">IOP_DPWR_TAG</a>&nbsp;&nbsp;&nbsp;'rwPD'</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a3">DBG_SCOPE</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a4">ASSERT_PDO</a>(d)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>&nbsp;&nbsp;&nbsp;0x00000001</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a6">DNF_DUPLICATE</a>&nbsp;&nbsp;&nbsp;0x00000002</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a7">DNF_HAL_NODE</a>&nbsp;&nbsp;&nbsp;0x00000004</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a>&nbsp;&nbsp;&nbsp;0x00000008</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>&nbsp;&nbsp;&nbsp;0x00000010</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a>&nbsp;&nbsp;&nbsp;0x00000020</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>&nbsp;&nbsp;&nbsp;0x00000040</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>&nbsp;&nbsp;&nbsp;0x00000080</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a13">DNF_BOOT_CONFIG_RESERVED</a>&nbsp;&nbsp;&nbsp;0x00000100</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a14">DNF_START_REQUEST_PENDING</a>&nbsp;&nbsp;&nbsp;0x00000200</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>&nbsp;&nbsp;&nbsp;0x00000400</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a16">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>&nbsp;&nbsp;&nbsp;0x00000800</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>&nbsp;&nbsp;&nbsp;0x00001000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>&nbsp;&nbsp;&nbsp;0x00002000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>&nbsp;&nbsp;&nbsp;0x00004000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>&nbsp;&nbsp;&nbsp;0x00008000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>&nbsp;&nbsp;&nbsp;0x00010000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>&nbsp;&nbsp;&nbsp;0x00020000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>&nbsp;&nbsp;&nbsp;0x00040000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>&nbsp;&nbsp;&nbsp;0x00080000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a25">DNF_NEED_ENUMERATION_ONLY</a>&nbsp;&nbsp;&nbsp;0x00100000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a26">DNF_IO_INVALIDATE_DEVICE_RELATIONS_PENDING</a>&nbsp;&nbsp;&nbsp;0x00200000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a27">DNF_BEING_ENUMERATED</a>&nbsp;&nbsp;&nbsp;0x00400000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a28">DNF_ENUMERATION_REQUEST_QUEUED</a>&nbsp;&nbsp;&nbsp;0x00800000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a29">DNF_ENUMERATION_REQUEST_PENDING</a>&nbsp;&nbsp;&nbsp;0x01000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a30">DNF_HAS_PROBLEM</a>&nbsp;&nbsp;&nbsp;0x02000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a31">DNF_HAS_PRIVATE_PROBLEM</a>&nbsp;&nbsp;&nbsp;0x04000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>&nbsp;&nbsp;&nbsp;0x08000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a33">DNF_DEVICE_GONE</a>&nbsp;&nbsp;&nbsp;0x10000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a34">DNF_LEGACY_RESOURCE_DEVICENODE</a>&nbsp;&nbsp;&nbsp;0x20000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a35">DNF_NEEDS_REBALANCE</a>&nbsp;&nbsp;&nbsp;0x40000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a36">DNF_LOCKED_FOR_EJECT</a>&nbsp;&nbsp;&nbsp;0x80000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a37">DNUF_WILL_BE_REMOVED</a>&nbsp;&nbsp;&nbsp;0x00000001</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a38">DNUF_DONT_SHOW_IN_UI</a>&nbsp;&nbsp;&nbsp;0x00000002</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a39">DNUF_NEED_RESTART</a>&nbsp;&nbsp;&nbsp;0x00000004</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a40">DNUF_NOT_DISABLEABLE</a>&nbsp;&nbsp;&nbsp;0x00000008</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a41">DNF_ADD_PHASE</a>&nbsp;&nbsp;&nbsp;(DNF_HAS_PROBLEM | DNF_HAS_PRIVATE_PROBLEM | DNF_DEVICE_GONE | DNF_REMOVE_PENDING_CLOSES | DNF_ADDED)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a42">OK_TO_ADD_DEVICE</a>(_devnode_)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a43">DNF_START_PHASE</a>&nbsp;&nbsp;&nbsp;(DNF_HAS_PROBLEM | DNF_HAS_PRIVATE_PROBLEM | DNF_DEVICE_GONE | DNF_REMOVE_PENDING_CLOSES | DNF_STARTED | DNF_START_REQUEST_PENDING)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a44">DNF_ASYNC_REQUEST_PENDING</a>&nbsp;&nbsp;&nbsp;(DNF_START_REQUEST_PENDING | DNF_ENUMERATION_REQUEST_PENDING)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a45">DNF_ASSIGN_RESOURCE_PHASE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a46">DNF_HAS_RESOURCE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a47">PNP_ERR_DUPLICATE_PDO</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a48">PNP_ERR_INVALID_PDO</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a49">PNP_ERR_BOGUS_ID</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a50">PNP_ERR_PDO_ENUMERATED_AFTER_DELETION</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a51">PNP_ERR_ACTIVE_PDO_FREED</a>&nbsp;&nbsp;&nbsp;5</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a52">PNP_ERR_DEVICE_MISSING_FROM_EJECT_LIST</a>&nbsp;&nbsp;&nbsp;6</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a53">PNP_ERR_UNEXPECTED_ADD_RELATION_ERR</a>&nbsp;&nbsp;&nbsp;7</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>&nbsp;&nbsp;&nbsp;((<a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>) -1)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a55">SETUP_RESERVED_GROUP</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a56">BUS_DRIVER_GROUP</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a57">PI_MAXIMUM_RESOURCE_TYPE_TRACKED</a>&nbsp;&nbsp;&nbsp;15</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a58">PI_ARBITER_HAS_SOMETHING</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a59">PI_ARBITER_TEST_FAILED</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a60">QUERY_RESOURCE_LIST</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a61">QUERY_RESOURCE_REQUIREMENTS</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a62">REGISTRY_ALLOC_CONFIG</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a63">REGISTRY_FORCED_CONFIG</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a64">REGISTRY_BOOT_CONFIG</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a65">REGISTRY_OVERRIDE_CONFIGVECTOR</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a66">REGISTRY_BASIC_CONFIGVECTOR</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a67">IOP_ASSIGN_RETRY</a>&nbsp;&nbsp;&nbsp;0x00000008</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>&nbsp;&nbsp;&nbsp;0x00000010</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>&nbsp;&nbsp;&nbsp;0x00000020</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a70">IOP_ASSIGN_NO_REBALANCE</a>&nbsp;&nbsp;&nbsp;0x00000080</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a71">IOP_ASSIGN_RESOURCES_RELEASED</a>&nbsp;&nbsp;&nbsp;0x00000100</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a72">IOP_ASSIGN_KEEP_CURRENT_CONFIG</a>&nbsp;&nbsp;&nbsp;0x00000200</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a73">IOP_ASSIGN_CLEAR_RESOURCE_REQUIREMENTS_CHANGE_FLAG</a>&nbsp;&nbsp;&nbsp;0x00000400</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a74">CmResourceTypeReserved</a>&nbsp;&nbsp;&nbsp;0xf0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(k)&nbsp;&nbsp;&nbsp;((PCHAR)(k) + (k)-&gt;DataOffset)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a76">SAVE_FAILURE_INFO</a>(DeviceNode, <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>)&nbsp;&nbsp;&nbsp;(DeviceNode)-&gt;FailureStatus = (<a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(devnode)&nbsp;&nbsp;&nbsp;((devnode)-&gt;Flags &amp; (DNF_HAS_PROBLEM | DNF_HAS_PRIVATE_PROBLEM))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(devnode, problem)&nbsp;&nbsp;&nbsp;(((devnode)-&gt;Flags &amp; DNF_HAS_PROBLEM) &amp;&amp; (devnode)-&gt;Problem == (problem))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(devnode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(devnode, problem)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a81">IopIsProblemReadonly</a>(problem)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(u, p, l)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a83">TITLE_INDEX_VALUE</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a84">PNP_ASSERT</a>(condition, message)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a85">PNP_DETECTION_ENABLED_DEFAULT</a>&nbsp;&nbsp;&nbsp;TRUE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a86">PNP_SCRATCH_BUFFER_SIZE</a>&nbsp;&nbsp;&nbsp;512</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a87">PNP_LARGE_SCRATCH_BUFFER_SIZE</a>&nbsp;&nbsp;&nbsp;(PNP_SCRATCH_BUFFER_SIZE * 8)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a88">DEVINSTANCE_FLAG_HWPROFILE_DISABLED</a>&nbsp;&nbsp;&nbsp;0x1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a89">DEVINSTANCE_FLAG_PNP_ENUMERATED</a>&nbsp;&nbsp;&nbsp;0x2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a90">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a>&nbsp;&nbsp;&nbsp;0x1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a91">FUNCTIONSUBKEY_FLAG_DELETE_SUBKEYS</a>&nbsp;&nbsp;&nbsp;0x2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a92">PLUGPLAY_REGKEY_DEVICE</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a93">PLUGPLAY_REGKEY_DRIVER</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a94">PLUGPLAY_REGKEY_CURRENT_HWPROFILE</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(_devnode_)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(_devnode_)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a97">IopReleaseEnumerationLockForThread</a>(_devnode_, _thread_)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>()&nbsp;&nbsp;&nbsp;ExAcquireResourceExclusive(&amp;<a class="el" href="../../d9/d0/pnpiop_8h.html#a149">IopDeviceTreeLock</a>, TRUE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>()&nbsp;&nbsp;&nbsp;ExReleaseResource(&amp;<a class="el" href="../../d9/d0/pnpiop_8h.html#a149">IopDeviceTreeLock</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(<a class="el" href="../../d4/d4/iafptrap_8c.html#a9">type</a>, field)&nbsp;&nbsp;&nbsp;(sizeof(((<a class="el" href="../../d4/d4/iafptrap_8c.html#a9">type</a> *)0)-&gt;field))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a101">IopDeviceNodeFlagsToCapabilities</a>(DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)&nbsp;&nbsp;&nbsp;( sizeof(<a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>) - sizeof(UNICODE_NULL) )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a103">IopConstStringLength</a>(<a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)&nbsp;&nbsp;&nbsp;( ( sizeof(<a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>) - sizeof(UNICODE_NULL) ) / sizeof(WCHAR) )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a104">IopKMToUMSymbolicLinkName</a>(<a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a105">IopUMToKMSymbolicLinkName</a>(<a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a106">IopHashGuid</a>(_Guid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(Lock)&nbsp;&nbsp;&nbsp;ExAcquireFastMutex(Lock);</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(Lock)&nbsp;&nbsp;&nbsp;ExReleaseFastMutex(Lock);</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(g1, g2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a110">PNP_NOTIFICATION_VERSION</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a111">NOTIFY_DEVICE_CLASS_HASH_BUCKETS</a>&nbsp;&nbsp;&nbsp;13</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">_PENDING_SET_INTERFACE_STATE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a112">PENDING_SET_INTERFACE_STATE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">_PENDING_SET_INTERFACE_STATE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a113">PPENDING_SET_INTERFACE_STATE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a389">_UNLOCK_UNLINK_ACTION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a114">UNLOCK_UNLINK_ACTION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a389">_UNLOCK_UNLINK_ACTION</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a115">PUNLOCK_UNLINK_ACTION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">_DEVICE_NODE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a116">PDEVICE_NODE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">_DEVICE_NODE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a117">DEVICE_NODE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef NTSTATUS(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a118">PENUM_CALLBACK</a> )(IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d1/struct__NEW__DEVICE__WORK__ITEM.html">_NEW_DEVICE_WORK_ITEM</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a119">NEW_DEVICE_WORK_ITEM</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d1/struct__NEW__DEVICE__WORK__ITEM.html">_NEW_DEVICE_WORK_ITEM</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a120">PNEW_DEVICE_WORK_ITEM</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef BOOLEAN(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a121">PIOP_SUBKEY_CALLBACK_ROUTINE</a> )(IN HANDLE, IN PUNICODE_STRING, IN OUT PVOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d5/struct__ADD__CONTEXT.html">_ADD_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a122">ADD_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d5/struct__ADD__CONTEXT.html">_ADD_CONTEXT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a123">PADD_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">_START_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a124">START_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">_START_CONTEXT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a125">PSTART_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a390">_RESOURCE_HANDLER_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a126">RESOURCE_HANDLER_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">_PI_RESOURCE_ARBITER_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a127">PI_RESOURCE_ARBITER_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">_PI_RESOURCE_ARBITER_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a128">PPI_RESOURCE_ARBITER_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">_PI_RESOURCE_TRANSLATOR_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a129">PI_RESOURCE_TRANSLATOR_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">_PI_RESOURCE_TRANSLATOR_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a130">PPI_RESOURCE_TRANSLATOR_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">_IOP_RESOURCE_REQUEST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a131">IOP_RESOURCE_REQUEST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">_IOP_RESOURCE_REQUEST</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a132">PIOP_RESOURCE_REQUEST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a391">_DEVICE_REQUEST_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a133">DEVICE_REQUEST_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html">_PI_DEVICE_REQUEST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a134">PI_DEVICE_REQUEST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html">_PI_DEVICE_REQUEST</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a135">PPI_DEVICE_REQUEST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">_IOPNP_DEVICE_EXTENSION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a136">IOPNP_DEVICE_EXTENSION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">_IOPNP_DEVICE_EXTENSION</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a137">PIOPNP_DEVICE_EXTENSION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d1/struct__IOP__RESERVED__RESOURCES__RECORD.html">_IOP_RESERVED_RESOURCES_RECORD</a> <br>
IOP_RESERVED_RESOURCES_RECORD *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a138">PIOP_RESERVED_RESOURCES_RECORD</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef NTSTATUS(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a164">PIO_RESERVE_RESOURCES_ROUTINE</a> )(IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a> ArbiterRequestSource, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PCM_RESOURCE_LIST BootResources)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">_NOTIFY_ENTRY_HEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a166">NOTIFY_ENTRY_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">_NOTIFY_ENTRY_HEADER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a167">PNOTIFY_ENTRY_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">_TARGET_DEVICE_NOTIFY_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a168">TARGET_DEVICE_NOTIFY_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">_TARGET_DEVICE_NOTIFY_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a169">PTARGET_DEVICE_NOTIFY_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html">_DEVICE_CLASS_NOTIFY_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a170">DEVICE_CLASS_NOTIFY_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html">_DEVICE_CLASS_NOTIFY_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a171">PDEVICE_CLASS_NOTIFY_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html">_SETUP_NOTIFY_DATA</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a172">SETUP_NOTIFY_DATA</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html">_SETUP_NOTIFY_DATA</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a173">PSETUP_NOTIFY_DATA</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">_HWPROFILE_NOTIFY_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a174">HWPROFILE_NOTIFY_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">_HWPROFILE_NOTIFY_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a175">PHWPROFILE_NOTIFY_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d5/struct__BUFFER__INFO.html">_BUFFER_INFO</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a184">BUFFER_INFO</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d5/struct__BUFFER__INFO.html">_BUFFER_INFO</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a185">PBUFFER_INFO</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">_BUS_TYPE_GUID_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a186">BUS_TYPE_GUID_LIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">_BUS_TYPE_GUID_LIST</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a187">PBUS_TYPE_GUID_LIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a392">_HARDWARE_PROFILE_BUS_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a194">HARDWARE_PROFILE_BUS_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a392">_HARDWARE_PROFILE_BUS_TYPE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a195">PHARDWARE_PROFILE_BUS_TYPE</a></td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a387">PROFILE_STATUS</a> { <br>
&nbsp;&nbsp;<a class="el" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a387a206">DOCK_DEPARTING</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a>
<br>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a388">PROFILE_NOTIFICATION_TIME</a> { <a class="el" href="../../d9/d0/pnpiop_8h.html#a388a208">PROFILE_IN_PNPEVENT</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a388a209">PROFILE_NOT_IN_PNPEVENT</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a388a210">PROFILE_PERHAPS_IN_PNPEVENT</a>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a389">_UNLOCK_UNLINK_ACTION</a> { <a class="el" href="../../d9/d0/pnpiop_8h.html#a389a211">UnlinkRemovedDeviceNodes</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a389a212">UnlinkAllDeviceNodesPendingClose</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a389a213">UnlinkOnlyChildDeviceNodesPendingClose</a>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a390">_RESOURCE_HANDLER_TYPE</a> { <a class="el" href="../../d9/d0/pnpiop_8h.html#a390a214">ResourceHandlerNull</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a390a215">ResourceTranslator</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a390a216">ResourceArbiter</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a390a217">ResourceLegacyDeviceDetection</a>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a391">_DEVICE_REQUEST_TYPE</a> { <br>
&nbsp;&nbsp;<a class="el" href="../../d9/d0/pnpiop_8h.html#a391a218">ReenumerateDeviceTree</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a391a219">ReenumerateDeviceOnly</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a391a220">ReenumerateBootDevices</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a391a221">RestartEnumeration</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="../../d9/d0/pnpiop_8h.html#a391a222">AssignResources</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a391a223">ResourceRequirementsChanged</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a391a224">StartDevice</a>, 
<a class="el" href="../../d9/d0/pnpiop_8h.html#a391a225">ReenumerateRootDevices</a>
<br>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a392">_HARDWARE_PROFILE_BUS_TYPE</a> { <a class="el" href="../../d9/d0/pnpiop_8h.html#a392a226">HardwareProfileBusTypeACPI</a>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a227">IopAppendStringToValueKey</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN PWSTR <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, IN PUNICODE_STRING <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>, IN BOOLEAN Create)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a228">IopPrepareDriverLoading</a> (IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN HANDLE KeyHandle, IN PIMAGE_NT_HEADERS <a class="el" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a229">IopRemoveStringFromValueKey</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN PWSTR <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, IN PUNICODE_STRING <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a230">IopIsDuplicatedDevices</a> (IN PCM_RESOURCE_LIST Configuration1, IN PCM_RESOURCE_LIST Configuration2, IN <a class="el" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo1 OPTIONAL, IN <a class="el" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo2 OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a231">IopMarkDuplicateDevice</a> (IN PUNICODE_STRING TargetKeyName, IN ULONG TargetInstance, IN PUNICODE_STRING SourceKeyName, IN ULONG SourceInstance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a232">IopConcatenateUnicodeStrings</a> (OUT PUNICODE_STRING Destination, IN PUNICODE_STRING <a class="el" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>, IN PUNICODE_STRING <a class="el" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a233">IopServiceInstanceToDeviceInstance</a> (IN HANDLE ServiceKeyHandle OPTIONAL, IN PUNICODE_STRING ServiceKeyName OPTIONAL, IN ULONG ServiceInstanceOrdinal, OUT PUNICODE_STRING DeviceInstanceRegistryPath OPTIONAL, OUT PHANDLE DeviceInstanceHandle OPTIONAL, IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a234">IopCreateRegistryKeyEx</a> (OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN HANDLE BaseHandle OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN ACCESS_MASK DesiredAccess, IN ULONG CreateOptions, OUT PULONG Disposition OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a235">IopOpenRegistryKeyEx</a> (OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN HANDLE BaseHandle OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a236">IopCreateMadeupNode</a> (IN PUNICODE_STRING ServiceKeyName, OUT PHANDLE <a class="el" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>, OUT PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, OUT PULONG InstanceOrdinal, IN BOOLEAN ResourceOwned)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a237">IopInitializePlugPlayServices</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock, IN ULONG Phase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a238">IopOpenServiceEnumKeys</a> (IN PUNICODE_STRING ServiceKeyName, IN ACCESS_MASK DesiredAccess, OUT PHANDLE ServiceHandle OPTIONAL, OUT PHANDLE ServiceEnumHandle OPTIONAL, IN BOOLEAN CreateEnum)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a239">IopOpenCurrentHwProfileDeviceInstanceKey</a> (OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN PUNICODE_STRING ServiceKeyName, IN ULONG Instance, IN ACCESS_MASK DesiredAccess, IN BOOLEAN Create)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a240">IopGetDeviceInstanceCsConfigFlags</a> (IN PUNICODE_STRING DeviceInstance, OUT PULONG CsConfigFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a241">IopGetServiceInstanceCsConfigFlags</a> (IN PUNICODE_STRING ServiceKeyName, IN ULONG Instance, OUT PULONG CsConfigFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a242">IopSetServiceInstanceCsConfigFlags</a> (IN PUNICODE_STRING ServiceKeyName, IN ULONG Instance, IN ULONG CsConfigFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a243">IopApplyFunctionToSubKeys</a> (IN HANDLE BaseHandle OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN ACCESS_MASK DesiredAccess, IN ULONG Flags, IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a121">PIOP_SUBKEY_CALLBACK_ROUTINE</a> SubKeyCallbackRoutine, IN OUT PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a244">IopRegMultiSzToUnicodeStrings</a> (IN PKEY_VALUE_FULL_INFORMATION KeyValueInformation, IN PUNICODE_STRING *UnicodeStringList, OUT PULONG UnicodeStringCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a245">IopApplyFunctionToServiceInstances</a> (IN HANDLE ServiceKeyHandle OPTIONAL, IN PUNICODE_STRING ServiceKeyName OPTIONAL, IN ACCESS_MASK DesiredAccess, IN BOOLEAN IgnoreNonCriticalErrors, IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a121">PIOP_SUBKEY_CALLBACK_ROUTINE</a> DevInstCallbackRoutine, IN OUT PVOID Context, OUT PULONG ServiceInstanceOrdinal OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a246">IopFreeUnicodeStringList</a> (IN PUNICODE_STRING UnicodeStringList, IN ULONG StringCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a247">IopDriverLoadingFailed</a> (IN HANDLE KeyHandle OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a248">IopReadDeviceConfiguration</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN ULONG Flags, OUT PCM_RESOURCE_LIST *CmResource, OUT PULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a249">IopIsFirmwareMapperDevicePresent</a> (IN HANDLE KeyHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a250">IopInsertTreeDeviceNode</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> ParentNode, IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a251">IopRemoveTreeDeviceNode</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a252">IopAllocateDeviceNode</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a253">IopForAllDeviceNodes</a> (IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a118">PENUM_CALLBACK</a> Callback, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a254">IopDetermineResourceListSize</a> (IN PCM_RESOURCE_LIST ResourceList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a255">IopQueryDeviceConfigurationVector</a> (IN PUNICODE_STRING ServiceKeyName, IN ULONG InstanceOrdinal, OUT PULONG DeviceInstanceFlags, OUT PIO_RESOURCE_REQUIREMENTS_LIST ConfigurationVector, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, OUT PULONG ActualBufferSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a256">IopReferenceDriverObjectByName</a> (IN PUNICODE_STRING DriverName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a257">IopDeviceObjectFromDeviceInstance</a> (IN HANDLE DeviceInstanceHandle OPTIONAL, IN PUNICODE_STRING DeviceInstance OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a258">IopDeviceObjectToDeviceInstance</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PHANDLE DeviceInstanceHandle, IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a259">IopIsDeviceInstanceEnabled</a> (IN HANDLE DeviceInstanceHandle, IN PUNICODE_STRING DeviceInstance, IN BOOLEAN DisableIfEnabled)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a260">IopAddDevicesToBootDriver</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a261">IopProcessAddDevices</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> StartOrder, IN ULONG DriverStartType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a262">IopProcessAssignResources</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN BOOLEAN Reallocation, IN BOOLEAN BootConfigsOK)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a263">IopProcessStartDevices</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">PSTART_CONTEXT</a> StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a264">IopStartDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> TargetDevice)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a265">IopEjectDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, <a class="el" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a> PendingEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a266">IopRemoveDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> TargetDevice, IN ULONG IrpMinorCode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a267">IopQueryDeviceRelations</a> (IN <a class="el" href="../../d0/d5/io_8h.html#a358">DEVICE_RELATION_TYPE</a> Relations, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN BOOLEAN AsyncOk, OUT <a class="el" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> *DeviceRelations)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a268">IopQueryDeviceState</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a269">IopQueryDeviceSerialNumber</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, OUT PWCHAR *SerialNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a270">IopForAllChildDeviceNodes</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> Parent, IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a118">PENUM_CALLBACK</a> Callback, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a271">IopCleanupDeviceRegistryValues</a> (IN PUNICODE_STRING InstancePath, IN BOOLEAN KeepReference)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a272">IopQueryDeviceId</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, OUT PWCHAR *DeviceId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a273">IopQueryUniqueId</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, OUT PWCHAR *UniqueId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a274">IopMakeGloballyUniqueId</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PWCHAR UniqueId, OUT PWCHAR *GloballyUniqueId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a275">IopQueryCompatibleIds</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d5/io_8h.html#a604">BUS_QUERY_ID_TYPE</a> IdType, OUT PWCHAR *CompatibleIds, OUT ULONG *Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a276">IopQueryDeviceResources</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN ULONG ResourceType, OUT PVOID *<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, OUT ULONG *Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a277">IopGetDeviceResourcesFromRegistry</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN ULONG ResourceType, IN ULONG Preference, OUT PVOID *<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, OUT PULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a278">IopResourceRequirementsChanged</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject, IN BOOLEAN StopRequired)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN BOOLEAN ReserveResources)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a280">IopPnPAddDevice</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a281">IopProcessCriticalDevice</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a282">IopPnPDispatch</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a283">IopPowerDispatch</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a284">IopDestroyDeviceNode</a> (<a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a285">IopStartAndEnumerateDevice</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">PSTART_CONTEXT</a> StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a286">IopCallDriverAddDevice</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN BOOLEAN LoadDriver, IN <a class="el" href="../../d8/d5/struct__ADD__CONTEXT.html">PADD_CONTEXT</a> AddContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a287">IopStartDriverDevices</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a288">IopIsLegacyDriver</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a289">IopNewDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a290">IopProcessNewDeviceNode</a> (IN OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a291">IopSynchronousCall</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> TopStackLocation, OUT PVOID *Information)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a292">IopFilterResourceRequirementsList</a> (IN PIO_RESOURCE_REQUIREMENTS_LIST IoList, IN PCM_RESOURCE_LIST CmList, IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *FilteredList, OUT PBOOLEAN ExactMatch)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a293">IopMergeFilteredResourceRequirementsList</a> (IN PIO_RESOURCE_REQUIREMENTS_LIST IoList1, IN PIO_RESOURCE_REQUIREMENTS_LIST IoList2, IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *MergedList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a294">IopMergeCmResourceLists</a> (IN PCM_RESOURCE_LIST List1, IN PCM_RESOURCE_LIST List2, IN OUT PCM_RESOURCE_LIST *MergedList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a295">IopCmResourcesToIoResources</a> (IN ULONG SlotNumber, IN PCM_RESOURCE_LIST CmResourceList, IN ULONG Priority)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a296">IopReportResourceListToPnp</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject OPTIONAL, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL, IN PCM_RESOURCE_LIST ResourceList, IN ULONG ListSize, IN BOOLEAN Translated)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a297">IopAllocateResources</a> (IN PULONG DeviceCountP, IN OUT <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> *AssignTablePP, IN BOOLEAN Locked, IN BOOLEAN BootConfigsOK)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a298">IopReallocateResources</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a299">IopWriteResourceList</a> (IN HANDLE ResourceMapKey, IN PUNICODE_STRING ClassName, IN PUNICODE_STRING DriverName, IN PUNICODE_STRING DeviceName, IN PCM_RESOURCE_LIST ResourceList, IN ULONG ResourceListSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a300">IopRemoveResourceListFromPnp</a> (IN PLIST_ENTRY ResourceList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN PCM_RESOURCE_LIST ResourceList, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a302">IopGetGroupOrderIndex</a> (IN HANDLE ServiceHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a303">IopDeleteLegacyKey</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a304">IopOpenDeviceParametersSubkey</a> (OUT HANDLE *ParamKeyHandle, IN HANDLE ParentKeyHandle, IN PUNICODE_STRING SubKeyString, IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL, IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a133">DEVICE_REQUEST_TYPE</a> RequestType, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> CompletionEvent OPTIONAL, IN PNTSTATUS CompletionStatus OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN ULONG Problem)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a307">IopRestartDeviceNode</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a308">IopDeleteKeyRecursive</a> (IN HANDLE SubKeyHandle, IN PWCHAR SubKeyName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a309">IopQueryPnpBusInformation</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, OUT LPGUID InterfaceGuid OPTIONAL, OUT INTERFACE_TYPE *<a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a> OPTIONAL, OUT ULONG *<a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a310">IopQueryLegacyBusInformation</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, OUT LPGUID InterfaceGuid OPTIONAL, OUT INTERFACE_TYPE *<a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a> OPTIONAL, OUT ULONG *<a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a311">IopGetRootDevices</a> (<a class="el" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> *DeviceRelations)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a312">IopLockDeviceRemovalRelations</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PLUGPLAY_DEVICE_DELETE_TYPE OperationCode, OUT <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> *RelationsList, IN BOOLEAN IsKernelInitiated)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a313">IopDeleteLockedDeviceNodes</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> RelationsList, IN PLUGPLAY_DEVICE_DELETE_TYPE OperationCode, IN BOOLEAN IsKernelInitiated, IN BOOLEAN ProcessIndirectDescendants, IN ULONG Problem, OUT <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *VetoingDevice OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a314">IopUnlockDeviceRemovalRelations</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> RelationsList, IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a114">UNLOCK_UNLINK_ACTION</a> UnlinkAction)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a315">IopInvalidateRelationsInList</a> (<a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> RelationsList, BOOLEAN OnlyIndirectDescendants, BOOLEAN UnlockDevNode, BOOLEAN RestartDevNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a316">IopChainDereferenceComplete</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a317">IopQueuePendingEject</a> (<a class="el" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a> Entry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a318">IopProcessCompletedEject</a> (IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a319">IopQueuePendingSurpriseRemoval</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List, IN ULONG Problem)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a320">IopIsAnyDeviceInstanceEnabled</a> (IN PUNICODE_STRING ServiceKeyName, IN HANDLE ServiceHandle, IN BOOLEAN LegacyIncluded)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a321">IopQueryResourceHandlerInterface</a> (IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a126">RESOURCE_HANDLER_TYPE</a> HandlerType, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN UCHAR ResourceType, IN OUT PVOID *Interface)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a322">IopQueryReconfiguration</a> (IN UCHAR Request, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a323">IopFindBusDeviceNode</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN INTERFACE_TYPE <a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a>, IN ULONG <a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>, IN ULONG SlotNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a324">IopLegacyResourceAllocation</a> (IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a> AllocationType, IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PIO_RESOURCE_REQUIREMENTS_LIST ResourceRequirements, IN OUT PCM_RESOURCE_LIST *AllocatedResources OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a325">IoReportResourceUsageInternal</a> (IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a> AllocationType, IN PUNICODE_STRING DriverClassName OPTIONAL, IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject, IN PCM_RESOURCE_LIST DriverList OPTIONAL, IN ULONG DriverListSize OPTIONAL, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL, IN PCM_RESOURCE_LIST DeviceList OPTIONAL, IN ULONG DeviceListSize OPTIONAL, IN BOOLEAN OverrideConflict, OUT PBOOLEAN ConflictDetected)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a326">IopDuplicateDetection</a> (IN INTERFACE_TYPE LegacyBusType, IN ULONG <a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>, IN ULONG SlotNumber, OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> *DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a327">IopLoadBootFilterDriver</a> (IN PUNICODE_STRING DriverName, IN ULONG GroupIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a328">IopDeviceNodeCapabilitiesToRegistry</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a329">IopDeviceCapabilitiesToRegistry</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN <a class="el" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a> Capabilities)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a330">IopQueryDeviceCapabilities</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, OUT <a class="el" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a> Capabilities)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a331">IopIncDisableableDepends</a> (IN OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a332">IopDecDisableableDepends</a> (IN OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a333">IopQueryDockRemovalInterface</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN OUT PDOCK_INTERFACE *DockInterface)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a334">IopReserveBootResources</a> (IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a> ArbiterRequestSource, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PCM_RESOURCE_LIST BootResources)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a335">IopAllocateBootResources</a> (IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a> ArbiterRequestSource, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PCM_RESOURCE_LIST BootResources)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a336">IopReserveLegacyBootResources</a> (IN INTERFACE_TYPE <a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a>, IN ULONG <a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a337">IopQueryConflictList</a> (<a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject, IN PCM_RESOURCE_LIST ResourceList, IN ULONG ResourceListSize, OUT PPLUGPLAY_CONTROL_CONFLICT_LIST ConflictList, IN ULONG ConflictListSize, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a338">MapperProcessFirmwareTree</a> (IN BOOLEAN OnlyProcessSerialPorts)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a339">MapperConstructRootEnumTree</a> (IN BOOLEAN CreatePhantomDevices)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a340">MapperFreeList</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a341">EisaBuildEisaDeviceNode</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a342">MapperPhantomizeDetectedComPorts</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a343">IopDumpCmResourceList</a> (IN PCM_RESOURCE_LIST CmList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a344">IopDumpCmResourceDescriptor</a> (IN PUCHAR Indent, IN PCM_PARTIAL_RESOURCE_DESCRIPTOR Desc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a345">IopDumpAllocatedSystemResources</a> (IN UCHAR ResourceType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a346">IopInitializePlugPlayNotification</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a347">IopNotifySetupDeviceArrival</a> (<a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject, HANDLE EnumEntryKey, BOOLEAN InstallDriver)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a348">IopRequestHwProfileChangeNotification</a> (IN LPGUID EventGuid, IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a388">PROFILE_NOTIFICATION_TIME</a> NotificationTime, OUT PPNP_VETO_TYPE VetoType OPTIONAL, OUT PUNICODE_STRING VetoName OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a349">IopNotifyTargetDeviceChange</a> (LPCGUID EventGuid, <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, PVOID NotificationStructure, <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *VetoingDriver)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a350">IopGetRelatedTargetDevice</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> *DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a351">IopNotifyDeviceClassChange</a> (LPGUID EventGuid, LPGUID ClassGuid, PUNICODE_STRING SymbolicLinkName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a352">IopRegisterDeviceInterface</a> (IN PUNICODE_STRING DeviceInstanceName, IN CONST GUID *InterfaceClassGuid, IN PUNICODE_STRING ReferenceString OPTIONAL, IN BOOLEAN UserModeFormat, OUT PUNICODE_STRING SymbolicLinkName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a353">IopUnregisterDeviceInterface</a> (IN PUNICODE_STRING SymbolicLinkName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a354">IopRemoveDeviceInterfaces</a> (IN PUNICODE_STRING DeviceInstancePath)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a355">IopGetDeviceInterfaces</a> (IN CONST GUID *InterfaceClassGuid, IN PUNICODE_STRING DevicePath OPTIONAL, IN ULONG Flags, IN BOOLEAN UserModeFormat, OUT PWSTR *SymbolicLinkList, OUT PULONG SymbolicLinkListSize OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a356">IopDoDeferredSetInterfaceState</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a357">IopProcessSetInterfaceState</a> (IN PUNICODE_STRING SymbolicLinkName, IN BOOLEAN Enable, IN BOOLEAN DeferNotStarted)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a358">IopReplaceSeperatorWithPound</a> (OUT PUNICODE_STRING OutString, IN PUNICODE_STRING InString)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a359">IopNotifyHwProfileChange</a> (IN LPGUID EventGuid, OUT PPNP_VETO_TYPE VetoType OPTIONAL, OUT PUNICODE_STRING VetoName OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a360">IopUncacheInterfaceInformation</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a361">IopProcessNewProfile</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a362">IopProcessNewProfileWorker</a> (IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a363">IopProcessNewProfileStateCallback</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a364">IopProcessDeferredRegistrations</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a365">IopPortInitialize</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a366">IopMemInitialize</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a367">IopIrqInitialize</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a368">IopDmaInitialize</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a369">IopBusNumberInitialize</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a> (IN <a class="el" href="../../d4/d5/struct__BUFFER__INFO.html">PBUFFER_INFO</a> Info, IN ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a> (IN <a class="el" href="../../d4/d5/struct__BUFFER__INFO.html">PBUFFER_INFO</a> Info, IN ULONG NewSize, IN BOOLEAN CopyContents)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a> (IN <a class="el" href="../../d4/d5/struct__BUFFER__INFO.html">PBUFFER_INFO</a> Info)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a373">IopAllocateUnicodeString</a> (IN OUT PUNICODE_STRING <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a> (PUNICODE_STRING <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a375">PnPBiosGetBiosInfo</a> (OUT PVOID *BiosInfo, OUT ULONG *BiosInfoLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a376">IopFixupDeviceId</a> (PWCHAR DeviceId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a377">IopHardwareProfileBeginTransition</a> (IN BOOLEAN SubsumeExistingDeparture)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a378">IopHardwareProfileMarkDock</a> (<a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387">PROFILE_STATUS</a> ChangeInPresence)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a379">IopHardwareProfileQueryChange</a> (IN BOOLEAN SubsumeExistingDeparture, IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a388">PROFILE_NOTIFICATION_TIME</a> NotificationTime, OUT PPNP_VETO_TYPE VetoType, OUT PUNICODE_STRING VetoName OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a380">IopHardwareProfileCommitStartedDock</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a381">IopHardwareProfileCommitRemovedDock</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a382">IopHardwareProfileCancelRemovedDock</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a383">IopHardwareProfileCancelTransition</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a384">IopHardwareProfileSetMarkedDocksEjected</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a385">IopOrphanNotification</a> (<a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a386">IopWarmEjectDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceToEject, IN SYSTEM_POWER_STATE LightestSleepState)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a139">IopPnpScratchBuffer1</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a140">IopPnpScratchBuffer2</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PCM_RESOURCE_LIST&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a141">IopInitHalResources</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a142">IopInitHalDeviceNode</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d0/pnpiop_8h.html#a138">PIOP_RESERVED_RESOURCES_RECORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a143">IopInitReservedResourceList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a144">IopRootDeviceNode</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a145">IopPnPDriverObject</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a146">IopPnPSpinLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a147">IopPnpDeleteRequestList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a148">IopPnpEnumerationRequestList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a149">IopDeviceTreeLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a150">PiEventQueueEmpty</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a151">PiEnumerationLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a152">IopEnumerationCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a153">IopNumberDeviceNodes</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a154">PnPInitialized</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a155">PnPBootDriversInitialized</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a156">PnPBootDriversLoaded</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a157">IopBootConfigsReserved</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a158">IopResourcesReleased</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a159">PnPDetectionEnabled</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INTERFACE_TYPE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a160">PnpDefaultInterfaceType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a161">PnpAsyncOk</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a162">IopPendingEjects</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a163">IopPendingSurpriseRemovals</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d0/pnpiop_8h.html#a164">PIO_RESERVE_RESOURCES_ROUTINE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a165">IopReserveResourcesRoutine</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a176">IopMaxDeviceNodeLevel</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a177">IoDeviceNodeTreeSequence</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a178">IopDeviceClassNotifyLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a179">IopDeviceClassNotifyList</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html">PSETUP_NOTIFY_DATA</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a180">IopSetupNotifyData</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a181">IopTargetDeviceNotifyLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a182">IopProfileNotifyList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a183">IopHwProfileNotifyLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">PBUS_TYPE_GUID_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a188">IopBusTypeGuidList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d7/struct__ARBITER__INSTANCE.html">ARBITER_INSTANCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a189">IopRootPortArbiter</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d7/struct__ARBITER__INSTANCE.html">ARBITER_INSTANCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a190">IopRootMemArbiter</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d7/struct__ARBITER__INSTANCE.html">ARBITER_INSTANCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a191">IopRootIrqArbiter</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d7/struct__ARBITER__INSTANCE.html">ARBITER_INSTANCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a192">IopRootDmaArbiter</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d7/struct__ARBITER__INSTANCE.html">ARBITER_INSTANCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a193">IopRootBusNumberArbiter</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a196">IopDockDeviceListHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a197">IopDockDeviceListLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a198">IopDockDeviceCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a199">IopProfileChangeSemaphore</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a200">IopDocksInTransition</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a201">IopWarmEjectLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/pnpiop_8h.html#a202">IopWarmEjectPdo</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a4" doxytag="pnpiop.h::ASSERT_PDO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_PDO          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">d&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">do</span> { \
        <span class="keywordflow">if</span> (    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == (d)-&gt;DeviceObjectExtension-&gt;DeviceNode || \
                (((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)(d)-&gt;DeviceObjectExtension-&gt;DeviceNode)-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a34">DNF_LEGACY_RESOURCE_DEVICENODE</a>))  { \
            <a class="code" href="../../d6/d3/cmwraper_8c.html#a23">KeBugCheckEx</a>(PNP_DETECTED_FATAL_ERROR, PNP_ERR_INVALID_PDO, (ULONG_PTR)d, 0, 0); \
        } \
    } \
    <span class="keywordflow">while</span> (0)
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00357">357</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00305">IoErrTerminateErrLog()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03419">IoGetDeviceInterfaces()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00373">IoGetDeviceProperty()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08307">IoGetDmaAdapter()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01395">IoInvalidateDeviceRelations()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06281">IoInvalidateDeviceState()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06017">IoReportTargetDeviceChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06118">IoReportTargetDeviceChangeAsynchronous()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01481">IoRequestDeviceEject()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01291">IoSynchronousInvalidateDeviceRelations()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="pnpiop.h::BUS_DRIVER_GROUP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BUS_DRIVER_GROUP&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00673">673</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="pnpiop.h::CmResourceTypeReserved" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmResourceTypeReserved&nbsp;&nbsp;&nbsp;0xf0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00803">803</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/report_8c-source.html#l00629">IopChangeInterfaceType()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04392">IopCmResourcesToIoResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="pnpiop.h::DBG_SCOPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DBG_SCOPE&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00045">45</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a88" doxytag="pnpiop.h::DEVINSTANCE_FLAG_HWPROFILE_DISABLED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEVINSTANCE_FLAG_HWPROFILE_DISABLED&nbsp;&nbsp;&nbsp;0x1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00906">906</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a89" doxytag="pnpiop.h::DEVINSTANCE_FLAG_PNP_ENUMERATED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEVINSTANCE_FLAG_PNP_ENUMERATED&nbsp;&nbsp;&nbsp;0x2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00907">907</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="pnpiop.h::DNF_ADD_PHASE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_ADD_PHASE&nbsp;&nbsp;&nbsp;(DNF_HAS_PROBLEM | DNF_HAS_PRIVATE_PROBLEM | DNF_DEVICE_GONE | DNF_REMOVE_PENDING_CLOSES | DNF_ADDED)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00613">613</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="pnpiop.h::DNF_ADDED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_ADDED&nbsp;&nbsp;&nbsp;0x00000040          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">408</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">IopInvalidateRelationsInList()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00725">IopLockDeviceRemovalRelations()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01117">IopProcessAddDevicesWorker()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01328">IopProcessAssignResourcesWorker()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">IopProcessStartDevicesWorker()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="pnpiop.h::DNF_ASSIGN_RESOURCE_PHASE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_ASSIGN_RESOURCE_PHASE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a30">DNF_HAS_PROBLEM</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a31">DNF_HAS_PRIVATE_PROBLEM</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a33">DNF_DEVICE_GONE</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a> |  \
                                       <a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>)
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00623">623</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01328">IopProcessAssignResourcesWorker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="pnpiop.h::DNF_ASSIGNING_RESOURCES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_ASSIGNING_RESOURCES&nbsp;&nbsp;&nbsp;0x00001000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00447">447</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">IopProcessAssignResources()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01328">IopProcessAssignResourcesWorker()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04667">IopQueryRebalanceWorker()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="pnpiop.h::DNF_ASYNC_REQUEST_PENDING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_ASYNC_REQUEST_PENDING&nbsp;&nbsp;&nbsp;(DNF_START_REQUEST_PENDING | DNF_ENUMERATION_REQUEST_PENDING)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00621">621</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04667">IopQueryRebalanceWorker()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04508">IopWaitForBootDevicesStarted()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="pnpiop.h::DNF_BEING_ENUMERATED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_BEING_ENUMERATED&nbsp;&nbsp;&nbsp;0x00400000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00515">515</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01395">IoInvalidateDeviceRelations()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01496">IopDeviceRelationsComplete()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="pnpiop.h::DNF_BOOT_CONFIG_RESERVED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_BOOT_CONFIG_RESERVED&nbsp;&nbsp;&nbsp;0x00000100          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00421">421</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02474">IopReleaseFilteredBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07383">IopReleaseResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="pnpiop.h::DNF_DEVICE_GONE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_DEVICE_GONE&nbsp;&nbsp;&nbsp;0x10000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00563">563</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01488">IopProcessNewChildren()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07383">IopReleaseResources()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00948">IovpCallDriver2()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="pnpiop.h::DNF_DUPLICATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_DUPLICATE&nbsp;&nbsp;&nbsp;0x00000002          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00376">376</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00166">IopAddDevicesToBootDriverWorker()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01516">IopGetDriverDeviceListWorker()</a>, and <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="pnpiop.h::DNF_ENUMERATED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_ENUMERATED&nbsp;&nbsp;&nbsp;0x00000010          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00396">396</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">IopInvalidateRelationsInList()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01488">IopProcessNewChildren()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01572">IopUnlockDeviceRemovalRelations()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="pnpiop.h::DNF_ENUMERATION_REQUEST_PENDING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_ENUMERATION_REQUEST_PENDING&nbsp;&nbsp;&nbsp;0x01000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00529">529</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01496">IopDeviceRelationsComplete()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="pnpiop.h::DNF_ENUMERATION_REQUEST_QUEUED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_ENUMERATION_REQUEST_QUEUED&nbsp;&nbsp;&nbsp;0x00800000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00522">522</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01395">IoInvalidateDeviceRelations()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="pnpiop.h::DNF_HAL_NODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_HAL_NODE&nbsp;&nbsp;&nbsp;0x00000004          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00383">383</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00048">IoBuildPoDeviceNotifyList()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="pnpiop.h::DNF_HAS_BOOT_CONFIG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_HAS_BOOT_CONFIG&nbsp;&nbsp;&nbsp;0x00000080          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">415</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05675">IopDeviceCapabilitiesToRegistry()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07383">IopReleaseResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="pnpiop.h::DNF_HAS_PRIVATE_PROBLEM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_HAS_PRIVATE_PROBLEM&nbsp;&nbsp;&nbsp;0x04000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00544">544</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">IopQueryDeviceState()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="pnpiop.h::DNF_HAS_PROBLEM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_HAS_PROBLEM&nbsp;&nbsp;&nbsp;0x02000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00536">536</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="pnpiop.h::DNF_HAS_RESOURCE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_HAS_RESOURCE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a> | \
                                       <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>)
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00625">625</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">IopProcessStartDevicesWorker()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="pnpiop.h::DNF_IO_INVALIDATE_DEVICE_RELATIONS_PENDING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_IO_INVALIDATE_DEVICE_RELATIONS_PENDING&nbsp;&nbsp;&nbsp;0x00200000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00508">508</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01395">IoInvalidateDeviceRelations()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01496">IopDeviceRelationsComplete()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="pnpiop.h::DNF_LEGACY_DRIVER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_LEGACY_DRIVER&nbsp;&nbsp;&nbsp;0x00080000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00493">493</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07775">IopEliminateBogusConflict()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04667">IopQueryRebalanceWorker()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03680">IovpAssertNonLegacyDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="pnpiop.h::DNF_LEGACY_RESOURCE_DEVICENODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_LEGACY_RESOURCE_DEVICENODE&nbsp;&nbsp;&nbsp;0x20000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00570">570</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d8/assign_8c-source.html#l00394">IoAssignResources()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00297">IopDestroyDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">IopFindLegacyDeviceNode()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00297">IoReportResourceForDetection()</a>, and <a class="el" href="../../d2/d7/report_8c-source.html#l00379">IoReportResourceUsage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="pnpiop.h::DNF_LOCKED_FOR_EJECT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_LOCKED_FOR_EJECT&nbsp;&nbsp;&nbsp;0x80000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00583">583</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">IopInvalidateRelationsInList()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00917">IopProcessRelation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="pnpiop.h::DNF_MADEUP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_MADEUP&nbsp;&nbsp;&nbsp;0x00000001          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">370</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01824">IopAssignResourcesToDevices()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">IopDeleteLegacyKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">IopFindLegacyDeviceNode()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07383">IopReleaseResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07291">IopReserveBootResources()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="pnpiop.h::DNF_NEED_ENUMERATION_ONLY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_NEED_ENUMERATION_ONLY&nbsp;&nbsp;&nbsp;0x00100000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00500">500</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="pnpiop.h::DNF_NEED_QUERY_IDS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_NEED_QUERY_IDS&nbsp;&nbsp;&nbsp;0x00000020          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00402">402</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">IopProcessStartDevicesWorker()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01740">IopStartDriverDevices()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="pnpiop.h::DNF_NEEDS_REBALANCE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_NEEDS_REBALANCE&nbsp;&nbsp;&nbsp;0x40000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00576">576</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04667">IopQueryRebalanceWorker()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="pnpiop.h::DNF_NO_RESOURCE_REQUIRED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_NO_RESOURCE_REQUIRED&nbsp;&nbsp;&nbsp;0x00000400          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00433">433</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">IopProcessAssignResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06439">IopResourceRequirementsChanged()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="pnpiop.h::DNF_NON_STOPPED_REBALANCE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_NON_STOPPED_REBALANCE&nbsp;&nbsp;&nbsp;0x00010000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00473">473</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06439">IopResourceRequirementsChanged()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="pnpiop.h::DNF_PROCESSED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_PROCESSED&nbsp;&nbsp;&nbsp;0x00000008          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00390">390</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">IopFindLegacyDeviceNode()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">IopInvalidateRelationsInList()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01488">IopProcessNewChildren()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="pnpiop.h::DNF_REMOVE_PENDING_CLOSES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_REMOVE_PENDING_CLOSES&nbsp;&nbsp;&nbsp;0x08000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00553">553</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06281">IoInvalidateDeviceState()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">IopCompleteUnloadOrDelete()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00557">IopDeleteLockedDeviceNodes()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06387">IopInvalidateDeviceStateWorker()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00917">IopProcessRelation()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01572">IopUnlockDeviceRemovalRelations()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="pnpiop.h::DNF_RESOURCE_ASSIGNED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_RESOURCE_ASSIGNED&nbsp;&nbsp;&nbsp;0x00002000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00453">453</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">IopProcessAssignResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07383">IopReleaseResources()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01572">IopUnlockDeviceRemovalRelations()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="pnpiop.h::DNF_RESOURCE_REPORTED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_RESOURCE_REPORTED&nbsp;&nbsp;&nbsp;0x00004000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00459">459</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">IopProcessAssignResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07383">IopReleaseResources()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="pnpiop.h::DNF_RESOURCE_REQUIREMENTS_CHANGED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_RESOURCE_REQUIREMENTS_CHANGED&nbsp;&nbsp;&nbsp;0x00008000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00466">466</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06439">IopResourceRequirementsChanged()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="pnpiop.h::DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED&nbsp;&nbsp;&nbsp;0x00000800          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00440">440</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="pnpiop.h::DNF_START_PHASE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_START_PHASE&nbsp;&nbsp;&nbsp;(DNF_HAS_PROBLEM | DNF_HAS_PRIVATE_PROBLEM | DNF_DEVICE_GONE | DNF_REMOVE_PENDING_CLOSES | DNF_STARTED | DNF_START_REQUEST_PENDING)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00619">619</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01328">IopProcessAssignResourcesWorker()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">IopProcessStartDevicesWorker()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="pnpiop.h::DNF_START_REQUEST_PENDING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_START_REQUEST_PENDING&nbsp;&nbsp;&nbsp;0x00000200          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00427">427</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="pnpiop.h::DNF_STARTED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_STARTED&nbsp;&nbsp;&nbsp;0x00040000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">487</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01395">IoInvalidateDeviceRelations()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06281">IoInvalidateDeviceState()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">IopDeleteLegacyKey()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00557">IopDeleteLockedDeviceNodes()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05121">IopFindResourcesForArbiter()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06387">IopInvalidateDeviceStateWorker()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05138">IopProcessNewProfileStateCallback()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00917">IopProcessRelation()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00821">IopProcessStartDevices()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06439">IopResourceRequirementsChanged()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01291">IoSynchronousInvalidateDeviceRelations()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="pnpiop.h::DNF_STOPPED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNF_STOPPED&nbsp;&nbsp;&nbsp;0x00020000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00480">480</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04667">IopQueryRebalanceWorker()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="pnpiop.h::DNUF_DONT_SHOW_IN_UI" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNUF_DONT_SHOW_IN_UI&nbsp;&nbsp;&nbsp;0x00000002          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00595">595</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">IopQueryDeviceState()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="pnpiop.h::DNUF_NEED_RESTART" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNUF_NEED_RESTART&nbsp;&nbsp;&nbsp;0x00000004          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00602">602</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="pnpiop.h::DNUF_NOT_DISABLEABLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNUF_NOT_DISABLEABLE&nbsp;&nbsp;&nbsp;0x00000008          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00610">610</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/devnode_8c-source.html#l00297">IopDestroyDeviceNode()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">IopQueryDeviceState()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="pnpiop.h::DNUF_WILL_BE_REMOVED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DNUF_WILL_BE_REMOVED&nbsp;&nbsp;&nbsp;0x00000001          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00589">589</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a100" doxytag="pnpiop.h::FIELD_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FIELD_SIZE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d4/iafptrap_8c.html#a9">type</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>field&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(sizeof(((<a class="el" href="../../d4/d4/iafptrap_8c.html#a9">type</a> *)0)-&gt;field))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01867">1867</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05675">IopDeviceCapabilitiesToRegistry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a91" doxytag="pnpiop.h::FUNCTIONSUBKEY_FLAG_DELETE_SUBKEYS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FUNCTIONSUBKEY_FLAG_DELETE_SUBKEYS&nbsp;&nbsp;&nbsp;0x2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00914">914</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01844">IopApplyFunctionToSubKeys()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05846">IopDeleteKeyRecursiveCallback()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a90" doxytag="pnpiop.h::FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS&nbsp;&nbsp;&nbsp;0x1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00913">913</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01844">IopApplyFunctionToSubKeys()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05846">IopDeleteKeyRecursiveCallback()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00680">IopGetRootDevices()</a>, and <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00819">IopInitializeDeviceKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="pnpiop.h::IOP_ASSIGN_CLEAR_RESOURCE_REQUIREMENTS_CHANGE_FLAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOP_ASSIGN_CLEAR_RESOURCE_REQUIREMENTS_CHANGE_FLAG&nbsp;&nbsp;&nbsp;0x00000400          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00761">761</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="pnpiop.h::IOP_ASSIGN_EXCLUDE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOP_ASSIGN_EXCLUDE&nbsp;&nbsp;&nbsp;0x00000010          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00755">755</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02845">IopIsBestConfiguration()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02474">IopReleaseFilteredBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02997">IopRestoreBestConfiguration()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02906">IopSaveCurrentConfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="pnpiop.h::IOP_ASSIGN_IGNORE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOP_ASSIGN_IGNORE&nbsp;&nbsp;&nbsp;0x00000020          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00756">756</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="pnpiop.h::IOP_ASSIGN_KEEP_CURRENT_CONFIG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOP_ASSIGN_KEEP_CURRENT_CONFIG&nbsp;&nbsp;&nbsp;0x00000200          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00759">759</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01988">IopFreeResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="pnpiop.h::IOP_ASSIGN_NO_REBALANCE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOP_ASSIGN_NO_REBALANCE&nbsp;&nbsp;&nbsp;0x00000080          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00757">757</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="pnpiop.h::IOP_ASSIGN_RESOURCES_RELEASED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOP_ASSIGN_RESOURCES_RELEASED&nbsp;&nbsp;&nbsp;0x00000100          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00758">758</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="pnpiop.h::IOP_ASSIGN_RETRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOP_ASSIGN_RETRY&nbsp;&nbsp;&nbsp;0x00000008          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00754">754</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="pnpiop.h::IOP_DNDT_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOP_DNDT_TAG&nbsp;&nbsp;&nbsp;'tdnD'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00038">38</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="pnpiop.h::IOP_DNOD_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOP_DNOD_TAG&nbsp;&nbsp;&nbsp;'donD'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00037">37</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/devnode_8c-source.html#l00056">IopAllocateDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="pnpiop.h::IOP_DPWR_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOP_DPWR_TAG&nbsp;&nbsp;&nbsp;'rwPD'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00039">39</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00048">IoBuildPoDeviceNotifyList()</a>, and <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00386">IopCaptureObjectName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a98" doxytag="pnpiop.h::IopAcquireDeviceTreeLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopAcquireDeviceTreeLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAcquireResourceExclusive(&amp;<a class="el" href="../../d9/d0/pnpiop_8h.html#a149">IopDeviceTreeLock</a>, TRUE)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01293">1293</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00048">IoBuildPoDeviceNotifyList()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00084">IopChainDereferenceComplete()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00725">IopLockDeviceRemovalRelations()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01417">IopProcessCompletedEject()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01234">IopQueuePendingEject()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01540">IopQueuePendingSurpriseRemoval()</a>, and <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00422">IopWarmEjectDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a95" doxytag="pnpiop.h::IopAcquireEnumerationLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopAcquireEnumerationLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_devnode_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;IopDeviceTreeLock, TRUE);              \
    <span class="keywordflow">if</span> ((_devnode_)) {                                              \
        <a class="code" href="../../d6/d3/cmwraper_8c.html#a20">KeWaitForSingleObject</a>( &amp;((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)(_devnode_))-&gt;EnumerationMutex,      \
                               Executive,                           \
                               KernelMode,                          \
                               FALSE,                               \
                               NULL );                              \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01266">1266</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09712">IoGetLegacyVetoList()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00127">IopForAllDeviceNodes()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00237">IopForAllDeviceNodesCallback()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00826">IopGetDevicePDO()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01053">IopProcessAddDevices()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01117">IopProcessAddDevicesWorker()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">IopProcessAssignResources()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01328">IopProcessAssignResourcesWorker()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00877">IopSetDeviceSecurityDescriptors()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a107" doxytag="pnpiop.h::IopAcquireNotifyLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopAcquireNotifyLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Lock&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAcquireFastMutex(Lock);</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02053">2053</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07330">IopNotifyDeviceClassChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06858">IopNotifyHwProfileChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07055">IopNotifyTargetDeviceChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09301">IopOrphanNotification()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05954">IopProcessDeferredRegistrations()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05829">IoUnregisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a79" doxytag="pnpiop.h::IopClearDevNodeProblem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopClearDevNodeProblem          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">devnode&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(devnode)-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a30">DNF_HAS_PROBLEM</a>;                       \
        (devnode)-&gt;Problem = 0;
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00831">831</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03125">IopDisableDevice()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">IopInvalidateRelationsInList()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04318">IopNotifySetupDevices()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01328">IopProcessAssignResourcesWorker()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03762">IopProcessCriticalDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05138">IopProcessNewProfileStateCallback()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06439">IopResourceRequirementsChanged()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a109" doxytag="pnpiop.h::IopCompareGuid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopCompareGuid          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">g1,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>g2&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>( (g1) == (g2) \
                                    ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> \
                                    : RtlCompareMemory( (g1), (g2), <span class="keyword">sizeof</span>(GUID) ) == <span class="keyword">sizeof</span>(GUID) \
                                    )
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02070">2070</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04425">IopGetBusTypeGuidIndex()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07330">IopNotifyDeviceClassChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06858">IopNotifyHwProfileChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07055">IopNotifyTargetDeviceChange()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06672">IopRequestHwProfileChangeNotification()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06017">IoReportTargetDeviceChange()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06118">IoReportTargetDeviceChangeAsynchronous()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a103" doxytag="pnpiop.h::IopConstStringLength" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopConstStringLength          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( ( sizeof(<a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>) - sizeof(UNICODE_NULL) ) / sizeof(WCHAR) )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01994">1994</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05424">IopParseSymbolicLinkName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a102" doxytag="pnpiop.h::IopConstStringSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopConstStringSize          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( sizeof(<a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>) - sizeof(UNICODE_NULL) )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01983">1983</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04946">IoGetDeviceInterfaceAlias()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05137">IopBuildSymbolicLinkStrings()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04741">IopOpenOrCreateDeviceInterfaceSubKeys()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05424">IopParseSymbolicLinkName()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04140">IopUnregisterDeviceInterface()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a101" doxytag="pnpiop.h::IopDeviceNodeFlagsToCapabilities" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopDeviceNodeFlagsToCapabilities          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">DeviceNode&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>((<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a>) (((PUCHAR) (&amp;(DeviceNode)-&gt;CapabilityFlags)) - \
                              FIELD_OFFSET(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>, Version) - \
                              <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>, Version)))
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01870">1870</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09445">IopGetLegacyVetoListDevice()</a>, and <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a77" doxytag="pnpiop.h::IopDoesDevNodeHaveProblem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopDoesDevNodeHaveProblem          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">devnode&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((devnode)-&gt;Flags &amp; (DNF_HAS_PROBLEM | DNF_HAS_PRIVATE_PROBLEM))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">825</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">IopDeleteLegacyKey()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03125">IopDisableDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01516">IopGetDriverDeviceListWorker()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03762">IopProcessCriticalDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04667">IopQueryRebalanceWorker()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">IopRestartDeviceNode()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01572">IopUnlockDeviceRemovalRelations()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a106" doxytag="pnpiop.h::IopHashGuid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopHashGuid          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_Guid&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>( ( ((PULONG)_Guid)[0] + ((PULONG)_Guid)[1] + ((PULONG)_Guid)[2] \
                + ((PULONG)_Guid)[3]) % <a class="code" href="../../d9/d0/pnpiop_8h.html#a111">NOTIFY_DEVICE_CLASS_HASH_BUCKETS</a>)
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02040">2040</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07330">IopNotifyDeviceClassChange()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a78" doxytag="pnpiop.h::IopIsDevNodeProblem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopIsDevNodeProblem          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">devnode,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>problem&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(((devnode)-&gt;Flags &amp; DNF_HAS_PROBLEM) &amp;&amp; (devnode)-&gt;Problem == (problem))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">828</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03125">IopDisableDevice()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03443">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04318">IopNotifySetupDevices()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01328">IopProcessAssignResourcesWorker()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03762">IopProcessCriticalDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05138">IopProcessNewProfileStateCallback()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a81" doxytag="pnpiop.h::IopIsProblemReadonly" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopIsProblemReadonly          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">problem&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>((problem) != CM_PROB_FAILED_INSTALL      &amp;&amp; \
     (problem) != CM_PROB_FAILED_ADD          &amp;&amp; \
     (problem) != CM_PROB_FAILED_START        &amp;&amp; \
     (problem) != CM_PROB_NOT_CONFIGURED      &amp;&amp; \
     (problem) != CM_PROB_NEED_RESTART        &amp;&amp; \
     (problem) != CM_PROB_REINSTALL           &amp;&amp; \
     (problem) != CM_PROB_REGISTRY            &amp;&amp; \
     (problem) != CM_PROB_DISABLED)
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00842">842</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a104" doxytag="pnpiop.h::IopKMToUMSymbolicLinkName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopKMToUMSymbolicLinkName          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(String) \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length &gt; 4) \
    <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>[1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02008">2008</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a82" doxytag="pnpiop.h::IopRegistryDataToUnicodeString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopRegistryDataToUnicodeString          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">u,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>p,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>l&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                            \
        ULONG len;                               \
                                                 \
        PiRegSzToString((p), (l), &amp;len, NULL);   \
        (u)-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)len;               \
        (u)-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(l);        \
        (u)-&gt;Buffer = (p);                       \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">862</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04946">IoGetDeviceInterfaceAlias()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02209">IopApplyFunctionToServiceInstances()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">IopCreateMadeupNode()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04120">IopGetDriverTagPriority()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05334">IopGetGroupOrderIndex()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09922">IopProcessSetInterfaceState()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">IopRemoveDeviceInterfaces()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00931">IopServiceInstanceToDeviceInstance()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a99" doxytag="pnpiop.h::IopReleaseDeviceTreeLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopReleaseDeviceTreeLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExReleaseResource(&amp;<a class="el" href="../../d9/d0/pnpiop_8h.html#a149">IopDeviceTreeLock</a>)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01294">1294</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00352">IoFreePoDeviceNotifyList()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00084">IopChainDereferenceComplete()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00725">IopLockDeviceRemovalRelations()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01417">IopProcessCompletedEject()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01234">IopQueuePendingEject()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01540">IopQueuePendingSurpriseRemoval()</a>, and <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00422">IopWarmEjectDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a96" doxytag="pnpiop.h::IopReleaseEnumerationLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopReleaseEnumerationLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_devnode_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> ((_devnode_)) {                                              \
        <a class="code" href="../../d4/d9/ke_8h.html#a282">KeSetEvent</a>( &amp;((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)(_devnode_))-&gt;EnumerationMutex, \
                    0,                                              \
                    FALSE );                                        \
    }                                                               \
    <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;IopDeviceTreeLock);
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01276">1276</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09712">IoGetLegacyVetoList()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00127">IopForAllDeviceNodes()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00237">IopForAllDeviceNodesCallback()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00826">IopGetDevicePDO()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01053">IopProcessAddDevices()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01117">IopProcessAddDevicesWorker()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">IopProcessAssignResources()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01328">IopProcessAssignResourcesWorker()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00821">IopProcessStartDevices()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, and <a class="el" href="../../d4/d0/objsup_8c-source.html#l00877">IopSetDeviceSecurityDescriptors()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a97" doxytag="pnpiop.h::IopReleaseEnumerationLockForThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopReleaseEnumerationLockForThread          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_devnode_,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>_thread_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> ((_devnode_)) {                                              \
        <a class="code" href="../../d4/d9/ke_8h.html#a282">KeSetEvent</a>( &amp;((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)(_devnode_))-&gt;EnumerationMutex, \
                    0,                                              \
                    FALSE );                                        \
    }                                                               \
    <a class="code" href="../../d8/d8/ex_2resource_8c.html#a24">ExReleaseResourceForThreadLite</a>(&amp;IopDeviceTreeLock, _thread_);
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01285">1285</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01496">IopDeviceRelationsComplete()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a108" doxytag="pnpiop.h::IopReleaseNotifyLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopReleaseNotifyLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Lock&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExReleaseFastMutex(Lock);</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02061">2061</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07330">IopNotifyDeviceClassChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06858">IopNotifyHwProfileChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07055">IopNotifyTargetDeviceChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09301">IopOrphanNotification()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05954">IopProcessDeferredRegistrations()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05829">IoUnregisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a80" doxytag="pnpiop.h::IopSetDevNodeProblem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopSetDevNodeProblem          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">devnode,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>problem&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((devnode)-&gt;Flags &amp; DNF_PROCESSED) || !((devnode)-&gt;Flags &amp; DNF_ENUMERATED)); \
        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!((devnode)-&gt;Flags &amp; (DNF_STARTED | DNF_HAS_PROBLEM | DNF_HAS_PRIVATE_PROBLEM))); \
        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(problem != 0); \
        (devnode)-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a30">DNF_HAS_PROBLEM</a>;                        \
        (devnode)-&gt;Problem = (problem);
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">835</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">IopDeleteLegacyKey()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03125">IopDisableDevice()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">IopProcessAssignResources()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a105" doxytag="pnpiop.h::IopUMToKMSymbolicLinkName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopUMToKMSymbolicLinkName          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(String) \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length &gt; 4) \
    <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>[1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'?'</span>
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02020">2020</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="pnpiop.h::KEY_VALUE_DATA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define KEY_VALUE_DATA          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">k&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((PCHAR)(k) + (k)-&gt;DataOffset)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">813</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04946">IoGetDeviceInterfaceAlias()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00373">IoGetDeviceProperty()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00810">IoOpenDeviceRegistryKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00546">IopAppendStringToValueKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02209">IopApplyFunctionToServiceInstances()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">IopCreateMadeupNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">IopDeleteLegacyKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03759">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01477">IopGetDeviceInstanceCsConfigFlags()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02707">IopGetDeviceInterfaces()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01411">IopGetDriverDeviceList()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04120">IopGetDriverTagPriority()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05334">IopGetGroupOrderIndex()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01591">IopGetServiceInstanceCsConfigFlags()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01454">IopGetServiceType()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03443">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01572">IopIsFirmwareMapperDevicePresent()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02286">IopIsReportedAlready()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04000">IopProcessCriticalDeviceRoutine()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09922">IopProcessSetInterfaceState()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04283">IopReadDeviceConfiguration()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02080">IopRegMultiSzToUnicodeStrings()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">IopRemoveDeviceInterfaces()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00449">IopRemoveStringFromValueKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00931">IopServiceInstanceToDeviceInstance()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04140">IopUnregisterDeviceInterface()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="pnpiop.h::NO_MORE_GROUP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NO_MORE_GROUP&nbsp;&nbsp;&nbsp;((<a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>) -1)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00671">671</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00728">IopBusCheck()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05334">IopGetGroupOrderIndex()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>, and <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01053">IopProcessAddDevices()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a111" doxytag="pnpiop.h::NOTIFY_DEVICE_CLASS_HASH_BUCKETS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NOTIFY_DEVICE_CLASS_HASH_BUCKETS&nbsp;&nbsp;&nbsp;13          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02360">2360</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06511">IopInitializePlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="pnpiop.h::OK_TO_ADD_DEVICE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OK_TO_ADD_DEVICE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_devnode_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>( (_devnode_)-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a>     &amp;&amp;                     \
      !((_devnode_)-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a41">DNF_ADD_PHASE</a>) )
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00615">615</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00166">IopAddDevicesToBootDriverWorker()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01117">IopProcessAddDevicesWorker()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01488">IopProcessNewChildren()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="pnpiop.h::PI_ARBITER_HAS_SOMETHING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PI_ARBITER_HAS_SOMETHING&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00722">722</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02716">IopAddReqDescsToArbiters()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05016">IopArbitrateDeviceResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02554">IopPlacement()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02780">IopRemoveReqDescsFromArbiters()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="pnpiop.h::PI_ARBITER_TEST_FAILED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PI_ARBITER_TEST_FAILED&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00723">723</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05016">IopArbitrateDeviceResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02554">IopPlacement()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="pnpiop.h::PI_MAXIMUM_RESOURCE_TYPE_TRACKED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PI_MAXIMUM_RESOURCE_TYPE_TRACKED&nbsp;&nbsp;&nbsp;15          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00698">698</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03424">IopFindResourceHandlerInfo()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a94" doxytag="pnpiop.h::PLUGPLAY_REGKEY_CURRENT_HWPROFILE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PLUGPLAY_REGKEY_CURRENT_HWPROFILE&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00922">922</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a92" doxytag="pnpiop.h::PLUGPLAY_REGKEY_DEVICE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PLUGPLAY_REGKEY_DEVICE&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00920">920</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a93" doxytag="pnpiop.h::PLUGPLAY_REGKEY_DRIVER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PLUGPLAY_REGKEY_DRIVER&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00921">921</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a84" doxytag="pnpiop.h::PNP_ASSERT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PNP_ASSERT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">condition,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>message&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00885">885</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a85" doxytag="pnpiop.h::PNP_DETECTION_ENABLED_DEFAULT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PNP_DETECTION_ENABLED_DEFAULT&nbsp;&nbsp;&nbsp;TRUE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00893">893</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="pnpiop.h::PNP_ERR_ACTIVE_PDO_FREED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PNP_ERR_ACTIVE_PDO_FREED&nbsp;&nbsp;&nbsp;5          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00635">635</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/devnode_8c-source.html#l00297">IopDestroyDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="pnpiop.h::PNP_ERR_BOGUS_ID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PNP_ERR_BOGUS_ID&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00633">633</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="pnpiop.h::PNP_ERR_DEVICE_MISSING_FROM_EJECT_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PNP_ERR_DEVICE_MISSING_FROM_EJECT_LIST&nbsp;&nbsp;&nbsp;6          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00637">637</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00917">IopProcessRelation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="pnpiop.h::PNP_ERR_DUPLICATE_PDO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PNP_ERR_DUPLICATE_PDO&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00631">631</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="pnpiop.h::PNP_ERR_INVALID_PDO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PNP_ERR_INVALID_PDO&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00632">632</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d8/assign_8c-source.html#l00394">IoAssignResources()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00297">IoReportResourceForDetection()</a>, and <a class="el" href="../../d2/d7/report_8c-source.html#l00379">IoReportResourceUsage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="pnpiop.h::PNP_ERR_PDO_ENUMERATED_AFTER_DELETION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PNP_ERR_PDO_ENUMERATED_AFTER_DELETION&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00634">634</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="pnpiop.h::PNP_ERR_UNEXPECTED_ADD_RELATION_ERR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PNP_ERR_UNEXPECTED_ADD_RELATION_ERR&nbsp;&nbsp;&nbsp;7          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00638">638</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00917">IopProcessRelation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a87" doxytag="pnpiop.h::PNP_LARGE_SCRATCH_BUFFER_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PNP_LARGE_SCRATCH_BUFFER_SIZE&nbsp;&nbsp;&nbsp;(PNP_SCRATCH_BUFFER_SIZE * 8)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00900">900</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01510">IopDetermineDefaultInterfaceType()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00680">IopGetRootDevices()</a>, and <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a110" doxytag="pnpiop.h::PNP_NOTIFICATION_VERSION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PNP_NOTIFICATION_VERSION&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02359">2359</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07330">IopNotifyDeviceClassChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06858">IopNotifyHwProfileChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08162">IopNotifySetupDeviceArrival()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07055">IopNotifyTargetDeviceChange()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a86" doxytag="pnpiop.h::PNP_SCRATCH_BUFFER_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PNP_SCRATCH_BUFFER_SIZE&nbsp;&nbsp;&nbsp;512          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00899">899</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02209">IopApplyFunctionToServiceInstances()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00680">IopGetRootDevices()</a>, and <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="pnpiop.h::QUERY_RESOURCE_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define QUERY_RESOURCE_LIST&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00740">740</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, and <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="pnpiop.h::QUERY_RESOURCE_REQUIREMENTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define QUERY_RESOURCE_REQUIREMENTS&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00741">741</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="pnpiop.h::REGISTRY_ALLOC_CONFIG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REGISTRY_ALLOC_CONFIG&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00743">743</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04283">IopReadDeviceConfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="pnpiop.h::REGISTRY_BASIC_CONFIGVECTOR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REGISTRY_BASIC_CONFIGVECTOR&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00747">747</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="pnpiop.h::REGISTRY_BOOT_CONFIG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REGISTRY_BOOT_CONFIG&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00745">745</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04283">IopReadDeviceConfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="pnpiop.h::REGISTRY_FORCED_CONFIG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REGISTRY_FORCED_CONFIG&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00744">744</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04283">IopReadDeviceConfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="pnpiop.h::REGISTRY_OVERRIDE_CONFIGVECTOR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REGISTRY_OVERRIDE_CONFIGVECTOR&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00746">746</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a76" doxytag="pnpiop.h::SAVE_FAILURE_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SAVE_FAILURE_INFO          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">DeviceNode,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(DeviceNode)-&gt;FailureStatus = (<a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00820">820</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="pnpiop.h::SETUP_RESERVED_GROUP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SETUP_RESERVED_GROUP&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00672">672</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a83" doxytag="pnpiop.h::TITLE_INDEX_VALUE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TITLE_INDEX_VALUE&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00876">876</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a122" doxytag="pnpiop.h::ADD_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d5/struct__ADD__CONTEXT.html">_ADD_CONTEXT</a>  <a class="el" href="../../d8/d5/struct__ADD__CONTEXT.html">ADD_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a184" doxytag="pnpiop.h::BUFFER_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d5/struct__BUFFER__INFO.html">_BUFFER_INFO</a>  <a class="el" href="../../d4/d5/struct__BUFFER__INFO.html">BUFFER_INFO</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04000">IopProcessCriticalDeviceRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a186" doxytag="pnpiop.h::BUS_TYPE_GUID_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">_BUS_TYPE_GUID_LIST</a>  <a class="el" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">BUS_TYPE_GUID_LIST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04425">IopGetBusTypeGuidIndex()</a>, and <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a170" doxytag="pnpiop.h::DEVICE_CLASS_NOTIFY_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html">_DEVICE_CLASS_NOTIFY_ENTRY</a>  <a class="el" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html">DEVICE_CLASS_NOTIFY_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a117" doxytag="pnpiop.h::DEVICE_NODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">_DEVICE_NODE</a>  <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d6/devnode_8c-source.html#l00056">IopAllocateDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a133" doxytag="pnpiop.h::DEVICE_REQUEST_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a391">_DEVICE_REQUEST_TYPE</a>  <a class="el" href="../../d9/d0/pnpiop_8h.html#a133">DEVICE_REQUEST_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a194" doxytag="pnpiop.h::HARDWARE_PROFILE_BUS_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a392">_HARDWARE_PROFILE_BUS_TYPE</a>  <a class="el" href="../../d9/d0/pnpiop_8h.html#a194">HARDWARE_PROFILE_BUS_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a174" doxytag="pnpiop.h::HWPROFILE_NOTIFY_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">_HWPROFILE_NOTIFY_ENTRY</a>  <a class="el" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">HWPROFILE_NOTIFY_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a131" doxytag="pnpiop.h::IOP_RESOURCE_REQUEST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">_IOP_RESOURCE_REQUEST</a>  <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">IopProcessAssignResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a136" doxytag="pnpiop.h::IOPNP_DEVICE_EXTENSION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">_IOPNP_DEVICE_EXTENSION</a>  <a class="el" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">IOPNP_DEVICE_EXTENSION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a119" doxytag="pnpiop.h::NEW_DEVICE_WORK_ITEM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d1/struct__NEW__DEVICE__WORK__ITEM.html">_NEW_DEVICE_WORK_ITEM</a>  <a class="el" href="../../d8/d1/struct__NEW__DEVICE__WORK__ITEM.html">NEW_DEVICE_WORK_ITEM</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a166" doxytag="pnpiop.h::NOTIFY_ENTRY_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">_NOTIFY_ENTRY_HEADER</a>  <a class="el" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">NOTIFY_ENTRY_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a123" doxytag="pnpiop.h::PADD_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d5/struct__ADD__CONTEXT.html">_ADD_CONTEXT</a> * <a class="el" href="../../d8/d5/struct__ADD__CONTEXT.html">PADD_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01117">IopProcessAddDevicesWorker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a185" doxytag="pnpiop.h::PBUFFER_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d5/struct__BUFFER__INFO.html">_BUFFER_INFO</a> * <a class="el" href="../../d4/d5/struct__BUFFER__INFO.html">PBUFFER_INFO</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a187" doxytag="pnpiop.h::PBUS_TYPE_GUID_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">_BUS_TYPE_GUID_LIST</a> * <a class="el" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">PBUS_TYPE_GUID_LIST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a171" doxytag="pnpiop.h::PDEVICE_CLASS_NOTIFY_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html">_DEVICE_CLASS_NOTIFY_ENTRY</a> * <a class="el" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html">PDEVICE_CLASS_NOTIFY_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07330">IopNotifyDeviceClassChange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a116" doxytag="pnpiop.h::PDEVICE_NODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">_DEVICE_NODE</a>* <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00086">86</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a112" doxytag="pnpiop.h::PENDING_SET_INTERFACE_STATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">_PENDING_SET_INTERFACE_STATE</a>  <a class="el" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">PENDING_SET_INTERFACE_STATE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09922">IopProcessSetInterfaceState()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a118" doxytag="pnpiop.h::PENUM_CALLBACK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef NTSTATUS(* <a class="el" href="../../d9/d0/pnpiop_8h.html#a118">PENUM_CALLBACK</a>)(IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN PVOID Context)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00642">642</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/devnode_8c-source.html#l00127">IopForAllDeviceNodes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a195" doxytag="pnpiop.h::PHARDWARE_PROFILE_BUS_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a392">_HARDWARE_PROFILE_BUS_TYPE</a> *  <a class="el" href="../../d9/d0/pnpiop_8h.html#a195">PHARDWARE_PROFILE_BUS_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a175" doxytag="pnpiop.h::PHWPROFILE_NOTIFY_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">_HWPROFILE_NOTIFY_ENTRY</a> * <a class="el" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">PHWPROFILE_NOTIFY_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06858">IopNotifyHwProfileChange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a134" doxytag="pnpiop.h::PI_DEVICE_REQUEST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html">_PI_DEVICE_REQUEST</a>  <a class="el" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html">PI_DEVICE_REQUEST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a127" doxytag="pnpiop.h::PI_RESOURCE_ARBITER_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">_PI_RESOURCE_ARBITER_ENTRY</a>  <a class="el" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a129" doxytag="pnpiop.h::PI_RESOURCE_TRANSLATOR_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">_PI_RESOURCE_TRANSLATOR_ENTRY</a>  <a class="el" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PI_RESOURCE_TRANSLATOR_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a164" doxytag="pnpiop.h::PIO_RESERVE_RESOURCES_ROUTINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef NTSTATUS(* <a class="el" href="../../d9/d0/pnpiop_8h.html#a164">PIO_RESERVE_RESOURCES_ROUTINE</a>)(IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a> ArbiterRequestSource, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PCM_RESOURCE_LIST BootResources)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01877">1877</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a138" doxytag="pnpiop.h::PIOP_RESERVED_RESOURCES_RECORD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d1/struct__IOP__RESERVED__RESOURCES__RECORD.html">_IOP_RESERVED_RESOURCES_RECORD</a> IOP_RESERVED_RESOURCES_RECORD* <a class="el" href="../../d9/d0/pnpiop_8h.html#a138">PIOP_RESERVED_RESOURCES_RECORD</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00937">937</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07291">IopReserveBootResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a132" doxytag="pnpiop.h::PIOP_RESOURCE_REQUEST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">_IOP_RESOURCE_REQUEST</a> * <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a121" doxytag="pnpiop.h::PIOP_SUBKEY_CALLBACK_ROUTINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef BOOLEAN(* <a class="el" href="../../d9/d0/pnpiop_8h.html#a121">PIOP_SUBKEY_CALLBACK_ROUTINE</a>)(IN HANDLE, IN PUNICODE_STRING, IN OUT PVOID)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00661">661</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a137" doxytag="pnpiop.h::PIOPNP_DEVICE_EXTENSION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">_IOPNP_DEVICE_EXTENSION</a> * <a class="el" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">PIOPNP_DEVICE_EXTENSION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a120" doxytag="pnpiop.h::PNEW_DEVICE_WORK_ITEM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d1/struct__NEW__DEVICE__WORK__ITEM.html">_NEW_DEVICE_WORK_ITEM</a> * <a class="el" href="../../d8/d1/struct__NEW__DEVICE__WORK__ITEM.html">PNEW_DEVICE_WORK_ITEM</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a167" doxytag="pnpiop.h::PNOTIFY_ENTRY_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">_NOTIFY_ENTRY_HEADER</a> * <a class="el" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a113" doxytag="pnpiop.h::PPENDING_SET_INTERFACE_STATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">_PENDING_SET_INTERFACE_STATE</a> * <a class="el" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">PPENDING_SET_INTERFACE_STATE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d6/devnode_8c-source.html#l00297">IopDestroyDeviceNode()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09866">IopDoDeferredSetInterfaceState()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a135" doxytag="pnpiop.h::PPI_DEVICE_REQUEST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html">_PI_DEVICE_REQUEST</a> * <a class="el" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html">PPI_DEVICE_REQUEST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a128" doxytag="pnpiop.h::PPI_RESOURCE_ARBITER_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">_PI_RESOURCE_ARBITER_ENTRY</a> * <a class="el" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a130" doxytag="pnpiop.h::PPI_RESOURCE_TRANSLATOR_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">_PI_RESOURCE_TRANSLATOR_ENTRY</a> * <a class="el" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d6/devnode_8c-source.html#l00297">IopDestroyDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a173" doxytag="pnpiop.h::PSETUP_NOTIFY_DATA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html">_SETUP_NOTIFY_DATA</a> * <a class="el" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html">PSETUP_NOTIFY_DATA</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a125" doxytag="pnpiop.h::PSTART_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">_START_CONTEXT</a> * <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">PSTART_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a169" doxytag="pnpiop.h::PTARGET_DEVICE_NOTIFY_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">_TARGET_DEVICE_NOTIFY_ENTRY</a> * <a class="el" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">PTARGET_DEVICE_NOTIFY_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06600">IopDereferenceNotify()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a115" doxytag="pnpiop.h::PUNLOCK_UNLINK_ACTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a389">_UNLOCK_UNLINK_ACTION</a> * <a class="el" href="../../d9/d0/pnpiop_8h.html#a115">PUNLOCK_UNLINK_ACTION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a126" doxytag="pnpiop.h::RESOURCE_HANDLER_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a390">_RESOURCE_HANDLER_TYPE</a>  <a class="el" href="../../d9/d0/pnpiop_8h.html#a126">RESOURCE_HANDLER_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a172" doxytag="pnpiop.h::SETUP_NOTIFY_DATA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html">_SETUP_NOTIFY_DATA</a>  <a class="el" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html">SETUP_NOTIFY_DATA</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a124" doxytag="pnpiop.h::START_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">_START_CONTEXT</a>  <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">START_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a168" doxytag="pnpiop.h::TARGET_DEVICE_NOTIFY_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">_TARGET_DEVICE_NOTIFY_ENTRY</a>  <a class="el" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">TARGET_DEVICE_NOTIFY_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a114" doxytag="pnpiop.h::UNLOCK_UNLINK_ACTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a389">_UNLOCK_UNLINK_ACTION</a>    <a class="el" href="../../d9/d0/pnpiop_8h.html#a114">UNLOCK_UNLINK_ACTION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01572">IopUnlockDeviceRemovalRelations()</a>.    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a391" doxytag="pnpiop.h::_DEVICE_REQUEST_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a391">_DEVICE_REQUEST_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a391a218" doxytag="ReenumerateDeviceTree" ></a>ReenumerateDeviceTree</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a391a219" doxytag="ReenumerateDeviceOnly" ></a>ReenumerateDeviceOnly</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a391a220" doxytag="ReenumerateBootDevices" ></a>ReenumerateBootDevices</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a391a221" doxytag="RestartEnumeration" ></a>RestartEnumeration</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a391a222" doxytag="AssignResources" ></a>AssignResources</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a391a223" doxytag="ResourceRequirementsChanged" ></a>ResourceRequirementsChanged</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a391a224" doxytag="StartDevice" ></a>StartDevice</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a391a225" doxytag="ReenumerateRootDevices" ></a>ReenumerateRootDevices</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00784">784</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
<pre class="fragment"><div>00784                                   {
00785     <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a218">ReenumerateDeviceTree</a>,
00786     <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a219">ReenumerateDeviceOnly</a>,
00787     <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a220">ReenumerateBootDevices</a>,
00788     <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a221">RestartEnumeration</a>,
00789     <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a222">AssignResources</a>,
00790     <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a223">ResourceRequirementsChanged</a>,
00791     <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a224">StartDevice</a>,
00792     <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a225">ReenumerateRootDevices</a>
00793 } <a class="code" href="../../d9/d0/pnpiop_8h.html#a133">DEVICE_REQUEST_TYPE</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a392" doxytag="pnpiop.h::_HARDWARE_PROFILE_BUS_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a392">_HARDWARE_PROFILE_BUS_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a392a226" doxytag="HardwareProfileBusTypeACPI" ></a>HardwareProfileBusTypeACPI</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02530">2530</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
<pre class="fragment"><div>02530                                         {
02531     <a class="code" href="../../d9/d0/pnpiop_8h.html#a392a226">HardwareProfileBusTypeACPI</a>
02532 } <a class="code" href="../../d9/d0/pnpiop_8h.html#a194">HARDWARE_PROFILE_BUS_TYPE</a>, * <a class="code" href="../../d9/d0/pnpiop_8h.html#a195">PHARDWARE_PROFILE_BUS_TYPE</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a390" doxytag="pnpiop.h::_RESOURCE_HANDLER_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a390">_RESOURCE_HANDLER_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a390a214" doxytag="ResourceHandlerNull" ></a>ResourceHandlerNull</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a390a215" doxytag="ResourceTranslator" ></a>ResourceTranslator</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a390a216" doxytag="ResourceArbiter" ></a>ResourceArbiter</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a390a217" doxytag="ResourceLegacyDeviceDetection" ></a>ResourceLegacyDeviceDetection</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00691">691</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
<pre class="fragment"><div>00691                                     {
00692     <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a214">ResourceHandlerNull</a>,
00693     <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a215">ResourceTranslator</a>,
00694     <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a216">ResourceArbiter</a>,
00695     <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a217">ResourceLegacyDeviceDetection</a>
00696 } <a class="code" href="../../d9/d0/pnpiop_8h.html#a126">RESOURCE_HANDLER_TYPE</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a389" doxytag="pnpiop.h::_UNLOCK_UNLINK_ACTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a389">_UNLOCK_UNLINK_ACTION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a389a211" doxytag="UnlinkRemovedDeviceNodes" ></a>UnlinkRemovedDeviceNodes</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a389a212" doxytag="UnlinkAllDeviceNodesPendingClose" ></a>UnlinkAllDeviceNodesPendingClose</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a389a213" doxytag="UnlinkOnlyChildDeviceNodesPendingClose" ></a>UnlinkOnlyChildDeviceNodesPendingClose</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00080">80</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
<pre class="fragment"><div>00080                                    {
00081     <a class="code" href="../../d9/d0/pnpiop_8h.html#a389a211">UnlinkRemovedDeviceNodes</a>,
00082     <a class="code" href="../../d9/d0/pnpiop_8h.html#a389a212">UnlinkAllDeviceNodesPendingClose</a>,
00083     <a class="code" href="../../d9/d0/pnpiop_8h.html#a389a213">UnlinkOnlyChildDeviceNodesPendingClose</a>
00084 }   <a class="code" href="../../d9/d0/pnpiop_8h.html#a114">UNLOCK_UNLINK_ACTION</a>, *<a class="code" href="../../d9/d0/pnpiop_8h.html#a115">PUNLOCK_UNLINK_ACTION</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a388" doxytag="pnpiop.h::PROFILE_NOTIFICATION_TIME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a388">PROFILE_NOTIFICATION_TIME</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a388a208" doxytag="PROFILE_IN_PNPEVENT" ></a>PROFILE_IN_PNPEVENT</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a388a209" doxytag="PROFILE_NOT_IN_PNPEVENT" ></a>PROFILE_NOT_IN_PNPEVENT</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a388a210" doxytag="PROFILE_PERHAPS_IN_PNPEVENT" ></a>PROFILE_PERHAPS_IN_PNPEVENT</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00065">65</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
<pre class="fragment"><div>00065              {
00066 
00067     <a class="code" href="../../d9/d0/pnpiop_8h.html#a388a208">PROFILE_IN_PNPEVENT</a>,
00068     <a class="code" href="../../d9/d0/pnpiop_8h.html#a388a209">PROFILE_NOT_IN_PNPEVENT</a>,
00069     <a class="code" href="../../d9/d0/pnpiop_8h.html#a388a210">PROFILE_PERHAPS_IN_PNPEVENT</a>
00070 
00071 } <a class="code" href="../../d9/d0/pnpiop_8h.html#a388">PROFILE_NOTIFICATION_TIME</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a387" doxytag="pnpiop.h::PROFILE_STATUS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d9/d0/pnpiop_8h.html#a387">PROFILE_STATUS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a387a203" doxytag="DOCK_NOTDOCKDEVICE" ></a>DOCK_NOTDOCKDEVICE</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a387a204" doxytag="DOCK_QUIESCENT" ></a>DOCK_QUIESCENT</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a387a205" doxytag="DOCK_ARRIVING" ></a>DOCK_ARRIVING</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a387a206" doxytag="DOCK_DEPARTING" ></a>DOCK_DEPARTING</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a387a207" doxytag="DOCK_EJECTIRP_COMPLETED" ></a>DOCK_EJECTIRP_COMPLETED</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00055">55</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
<pre class="fragment"><div>00055              {
00056 
00057     <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>,
00058     <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>,
00059     <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>,
00060     <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a206">DOCK_DEPARTING</a>,
00061     <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a>
00062 
00063 } <a class="code" href="../../d9/d0/pnpiop_8h.html#a387">PROFILE_STATUS</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a341" doxytag="pnpiop.h::EisaBuildEisaDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS EisaBuildEisaDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00059">59</a> of file <a class="el" href="../../d6/d9/pnpeisa_8c-source.html">pnpeisa.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00036">BUFFER_LENGTH</a>, <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00035">EISA_DEVICE_NODE_NAME</a>, <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00201">EisaGetEisaDevicesResources()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.
<p>
<pre class="fragment"><div>00065                    :
00066 
00067     This routine build an registry key to report eisa resources to arbiters.
00068 
00069 Arguments:
00070 
00071     None.
00072 
00073 Return Value:
00074 
00075     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00076 
00077 --*/
00078 
00079 {
00080     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
00081     ULONG               disposition, tmpValue;
00082     WCHAR               buffer[<a class="code" href="../../d5/d0/pnpeisa_8c.html#a1">BUFFER_LENGTH</a>];
00083 
00084     UNICODE_STRING      unicodeString;
00085     HANDLE              rootHandle, deviceHandle, instanceHandle, logConfHandle;
00086 
00087     PCM_RESOURCE_LIST   resourceList;
00088     ULONG               resourceLength;
00089 
00090     status = <a class="code" href="../../d5/d0/pnpeisa_8c.html#a2">EisaGetEisaDevicesResources</a>(&amp;resourceList, &amp;resourceLength);
00091     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || resourceList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00092         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00093     }
00094 
00095     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeString, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Enum\\Root"</span>);
00096     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;rootHandle,
00097                                    NULL,
00098                                    &amp;unicodeString,
00099                                    KEY_ALL_ACCESS
00100                                    );
00101 
00102     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00103         <span class="keywordflow">if</span> (resourceList) {
00104             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (resourceList);
00105         }
00106         <span class="keywordflow">return</span> status;
00107     }
00108 
00109     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeString, EISA_DEVICE_NODE_NAME);
00110     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;deviceHandle,
00111                                      rootHandle,
00112                                      &amp;unicodeString,
00113                                      KEY_ALL_ACCESS,
00114                                      REG_OPTION_NON_VOLATILE,
00115                                      NULL
00116                                      );
00117 
00118     ZwClose(rootHandle);
00119     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00120         <span class="keywordflow">if</span> (resourceList) {
00121             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (resourceList);
00122         }
00123         <span class="keywordflow">return</span> status;
00124     }
00125 
00126     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, L<span class="stringliteral">"0000"</span> );
00127     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;instanceHandle,
00128                                      deviceHandle,
00129                                      &amp;unicodeString,
00130                                      KEY_ALL_ACCESS,
00131                                      REG_OPTION_NON_VOLATILE,
00132                                      &amp;disposition );
00133     ZwClose(deviceHandle);
00134     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))  {
00135         <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {
00136 
00137             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, L<span class="stringliteral">"DeviceDesc"</span> );
00138             swprintf(buffer, L<span class="stringliteral">"%s"</span>, L<span class="stringliteral">"Device to report Eisa Slot Resources"</span>);
00139 
00140             ZwSetValueKey(instanceHandle,
00141                           &amp;unicodeString,
00142                           0,
00143                           REG_SZ,
00144                           buffer,
00145                           (wcslen(buffer) + 1) * <span class="keyword">sizeof</span>(WCHAR)
00146                           );
00147 
00148             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, L<span class="stringliteral">"HardwareID"</span> );
00149             RtlZeroMemory(buffer, BUFFER_LENGTH * <span class="keyword">sizeof</span>(WCHAR));
00150             swprintf(buffer, L<span class="stringliteral">"%s"</span>, L<span class="stringliteral">"*Eisa_Resource_Device"</span>);
00151 
00152             ZwSetValueKey(instanceHandle,
00153                           &amp;unicodeString,
00154                           0,
00155                           REG_MULTI_SZ,
00156                           buffer,
00157                           (wcslen(buffer) + 2) * <span class="keyword">sizeof</span>(WCHAR)
00158                           );
00159 
00160             PiWstrToUnicodeString(&amp;unicodeString, REGSTR_VALUE_CONFIG_FLAGS);
00161             tmpValue = 0;
00162             ZwSetValueKey(instanceHandle,
00163                          &amp;unicodeString,
00164                          TITLE_INDEX_VALUE,
00165                          REG_DWORD,
00166                          &amp;tmpValue,
00167                          <span class="keyword">sizeof</span>(tmpValue)
00168                          );
00169 
00170         }
00171 
00172         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, REGSTR_KEY_LOGCONF );
00173         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;logConfHandle,
00174                                          instanceHandle,
00175                                          &amp;unicodeString,
00176                                          KEY_ALL_ACCESS,
00177                                          REG_OPTION_NON_VOLATILE,
00178                                          NULL
00179                                          );
00180         ZwClose(instanceHandle);
00181         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))  {
00182             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, REGSTR_VAL_BOOTCONFIG );
00183 
00184             status = ZwSetValueKey(logConfHandle,
00185                                    &amp;unicodeString,
00186                                    0,
00187                                    REG_RESOURCE_LIST,
00188                                    resourceList,
00189                                    resourceLength
00190                                    );
00191             ZwClose(logConfHandle);
00192         }
00193     }
00194     <span class="keywordflow">if</span> (resourceList) {
00195         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (resourceList);
00196     }
00197     <span class="keywordflow">return</span> status;
00198 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a260" doxytag="pnpiop.h::IopAddDevicesToBootDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAddDevicesToBootDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00117">117</a> of file <a class="el" href="../../d3/d9/pnpdd_8c-source.html">pnpdd.c</a>.
<p>
References <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00166">IopAddDevicesToBootDriverWorker()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02036">IopApplyFunctionToServiceInstances()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>00123                    :
00124 
00125     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by Pnp manager to inform a boot device driver of
00126     all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can possibly <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> boot
00127     drivers <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
00128 
00129 Parameters:
00130 
00131     DriverObject - Supplies a driver object to receive its boot devices.
00132 
00133 Return Value:
00134 
00135     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00136 
00137 --*/
00138 {
00139     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00140 
00141 
00142     <span class="comment">//</span>
00143     <span class="comment">// For each device instance in the driver's service/enum key, we will</span>
00144     <span class="comment">// invoke the driver's AddDevice routine and perform enumeration on</span>
00145     <span class="comment">// the device.</span>
00146     <span class="comment">// Note, we don't acquire registry lock before calling IopApplyFunction</span>
00147     <span class="comment">// routine.  We know this code is for boot driver initialization.  No</span>
00148     <span class="comment">// one else would access the registry Enum key at this time and most</span>
00149     <span class="comment">// important we need the registry lock in other down level routines.</span>
00150     <span class="comment">//</span>
00151 
00152     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a14">IopApplyFunctionToServiceInstances</a>(
00153                                 NULL,
00154                                 &amp;DriverObject-&gt;DriverExtension-&gt;ServiceKeyName,
00155                                 KEY_ALL_ACCESS,
00156                                 TRUE,
00157                                 IopAddDevicesToBootDriverWorker,
00158                                 DriverObject,
00159                                 NULL
00160                                 );
00161 
00162     <span class="keywordflow">return</span> status;
00163 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a335" doxytag="pnpiop.h::IopAllocateBootResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAllocateBootResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ArbiterRequestSource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>BootResources</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07141">7141</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00337">IopRegistrySemaphore</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07291">IopReserveBootResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>.
<p>
<pre class="fragment"><div>07149                    :
07150 
07151     This routine reports boot resources <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device to
07152     arbiters.
07153 
07154 Arguments:
07155 
07156     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object, could be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
07157         <span class="keywordflow">if</span> DeviceObject <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BootResources are reserved and will not be given
07158             to a device unless there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no other choice. The caller must release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
07159             <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <span class="keywordflow">for</span> BootResources.
07160         <span class="keywordflow">if</span> DeviceObject <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NON_NULL, BootResources are BOOT reserved (preallocated.)
07161 
07162     BootResources - Supplies a pointer to the Boot resources.
07163 
07164 Return Value:
07165 
07166     None.
07167 
07168 --*/
07169 {
07170     NTSTATUS    status;
07171 
07172     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07173 
07174     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>( );
07175 
07176     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;IopRegistrySemaphore,
07177                                     DelayExecution,
07178                                     KernelMode,
07179                                     FALSE,
07180                                     NULL );
07181 
07182     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07183 
07184         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a94">IopReserveBootResourcesInternal</a>(ArbiterRequestSource, DeviceObject, BootResources);
07185         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
07186 
07187     } <span class="keywordflow">else</span> {
07188 
07189         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"IopReserveBootResources: Get RegustrySemaphore failed. Status %x\n"</span>, status));
07190     }
07191 
07192     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
07193 
07194     <span class="keywordflow">return</span> status;
07195 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a370" doxytag="pnpiop.h::IopAllocateBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAllocateBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d5/struct__BUFFER__INFO.html">PBUFFER_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Info</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02427">2427</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02707">IopGetDeviceInterfaces()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04000">IopProcessCriticalDeviceRoutine()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">IopRemoveDeviceInterfaces()</a>.
<p>
<pre class="fragment"><div>02434                    :
02435 
02436     Allocates a buffer of <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> bytes and initialises <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d5/struct__BUFFER__INFO.html">BUFFER_INFO</a>
02437     structure so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current position <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02438 
02439 Parameters:
02440 
02441     Info - Pointer to a buffer info structure to be used to manage <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
02442            buffer
02443 
02444     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - The number of bytes to be allocated <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer
02445 
02446 Return Value:
02447 
02448     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
02449 
02450 --*/
02451 
02452 {
02453     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Info);
02454 
02455     <span class="keywordflow">if</span> (!(Info-&gt;Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, Size))) {
02456         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02457     }
02458 
02459     Info-&gt;Current = Info-&gt;Buffer;
02460     Info-&gt;MaxSize = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02461 
02462     <span class="keywordflow">return</span> STATUS_SUCCESS;
02463 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a252" doxytag="pnpiop.h::IopAllocateDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> IopAllocateDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PhysicalDeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/devnode_8c-source.html#l00056">56</a> of file <a class="el" href="../../d5/d6/devnode_8c-source.html">devnode.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00208">_DEVICE_NODE::BusNumber</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00215">_DEVICE_NODE::ChildBusNumber</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00216">_DEVICE_NODE::ChildBusTypeIndex</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00214">_DEVICE_NODE::ChildInterfaceType</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a117">DEVICE_NODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00239">_DEVICE_NODE::DeviceArbiterList</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00246">_DEVICE_NODE::DeviceTranslatorList</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01159">DO_DEVICE_INITIALIZING</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o42">_DEVICE_NODE::DockInfo</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00170">_DEVICE_NODE::EnumerationMutex</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00207">_DEVICE_NODE::InterfaceType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00037">IOP_DNOD_TAG</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00098">IopNumberDeviceNodes</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00341">_DEVICE_NODE::PendedSetInterfaceState</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00232">_DEVICE_NODE::TargetDeviceNotify</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">IopFindLegacyDeviceNode()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>00062                    :
00063 
00064     This function allocates a device node from nonpaged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> and initializes
00065     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fields which <span class="keywordflow">do</span> not require to hold lock to <span class="keywordflow">do</span> so.  Since adding
00066     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node to pnp mgr's device node tree requires acquiring lock,
00067     <span class="keyword">this</span> routine does not add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node to device node tree.
00068 
00069 Arguments:
00070 
00071     PhysicalDeviceObject - Supplies a pointer to its corresponding physical device
00072         object.
00073 
00074 Return Value:
00075 
00076     a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created device node. Null <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> failed.
00077 
00078 --*/
00079 {
00080     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00081 
00082     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00083 
00084     deviceNode = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00085                     NonPagedPool,
00086                     <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a>),
00087                     IOP_DNOD_TAG
00088                     );
00089 
00090     <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ){
00091         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00092     }
00093 
00094     InterlockedIncrement (&amp;IopNumberDeviceNodes);
00095 
00096     RtlZeroMemory(deviceNode, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a>));
00097     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o17">InterfaceType</a> = InterfaceTypeUndefined;
00098     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o18">BusNumber</a> = (ULONG)-1;
00099     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o19">ChildInterfaceType</a> = InterfaceTypeUndefined;
00100     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o20">ChildBusNumber</a> = (ULONG)-1;
00101     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o21">ChildBusTypeIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)-1;
00102 
00103     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>,
00104                        SynchronizationEvent,
00105                        TRUE );
00106 
00107     InitializeListHead(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o24">DeviceArbiterList</a>);
00108     InitializeListHead(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o25">DeviceTranslatorList</a>);
00109 
00110     <span class="keywordflow">if</span> (PhysicalDeviceObject){
00111 
00112         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a> = PhysicalDeviceObject;
00113         PhysicalDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a> = (PVOID)deviceNode;
00114         PhysicalDeviceObject-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a128">DO_DEVICE_INITIALIZING</a>;
00115     }
00116 
00117     InitializeListHead(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o23">TargetDeviceNotify</a>);
00118 
00119     InitializeListHead(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.ListEntry);
00120 
00121     InitializeListHead(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o44">PendedSetInterfaceState</a>);
00122 
00123     <span class="keywordflow">return</span> deviceNode;
00124 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a297" doxytag="pnpiop.h::IopAllocateResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAllocateResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceCountP</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTablePP</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Locked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>BootConfigsOK</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">720</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00767">_IOP_RESOURCE_REQUEST::AllocationType</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a129">ArbiterRequestPnpDetected</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00576">DNF_NEEDS_REBALANCE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00268">DUMP_INFO</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00060">ExAllocatePoolAT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00755">IOP_ASSIGN_EXCLUDE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00756">IOP_ASSIGN_IGNORE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00757">IOP_ASSIGN_NO_REBALANCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00754">IOP_ASSIGN_RETRY</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00134">IopBootConfigsReserved</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01988">IopFreeResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01878">IopRearrangeAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00337">IopRegistrySemaphore</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02474">IopReleaseFilteredBootResources()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00765">_IOP_RESOURCE_REQUEST::PhysicalDevice</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00771">_IOP_RESOURCE_REQUEST::ResourceAssignment</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00769">_IOP_RESOURCE_REQUEST::ResourceRequirements</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00773">_IOP_RESOURCE_REQUEST::Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01824">IopAssignResourcesToDevices()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>.
<p>
<pre class="fragment"><div>00729                    :
00730 
00731     For each AssignTable entry, <span class="keyword">this</span> routine queries device's IO resource requirements
00732     list and converts <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to our internal REQ_LIST <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>; calls worker routine to perform
00733     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources assignment.
00734 
00735 Parameters:
00736 
00737     AssignTable - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first entry of a <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> table.
00738 
00739     AssignTableEnd - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> table.
00740 
00741     Locked - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
00742 
00743     BootConfigsOK - Indicates whether we should assign BOOT configs.
00744 
00745 Return Value:
00746 
00747     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
00748 
00749 --*/
00750 
00751 {
00752     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignTable;
00753     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignTableEnd;
00754     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignTableTail;
00755     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignEntry;
00756     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignEntryOriginal;
00757     ULONG                   AssignTableCount;
00758     ULONG                   DeviceCount;
00759     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00760     BOOLEAN                 FreeAssignTable;
00761     BOOLEAN                 tryRebalance;
00762 
00763     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00764 
00765     DeviceCount = *DeviceCountP;
00766     FreeAssignTable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00767     tryRebalance = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00768     AssignTable = *AssignTablePP;
00769     AssignTableEnd = AssignTable + DeviceCount;
00770 
00771     <span class="comment">//</span>
00772     <span class="comment">// If legacy device resource allocation, don't rebalance on failure,</span>
00773     <span class="comment">// if the resource they want is already assigned, what they are looking</span>
00774     <span class="comment">// for isn't there.</span>
00775     <span class="comment">//</span>
00776 
00777     <span class="keywordflow">if</span> ((DeviceCount == 1) &amp;&amp; (AssignTable-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a70">IOP_ASSIGN_NO_REBALANCE</a>)) {
00778 
00779         tryRebalance = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00780 
00781     }
00782 
00783     <span class="comment">//</span>
00784     <span class="comment">// Grab the IO registry semaphore to make sure no other device is</span>
00785     <span class="comment">// reporting it's resource usage while we are searching for conflicts.</span>
00786     <span class="comment">//</span>
00787 
00788     <span class="keywordflow">if</span> (!Locked) {
00789 
00790         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00791 
00792         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;IopRegistrySemaphore,
00793                                         DelayExecution,
00794                                         KernelMode,
00795                                         FALSE,
00796                                         NULL );
00797 
00798         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00799 
00800             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"IopAllocateResources: Get RegistrySemaphore failed. Status %x\n"</span>, Status));
00801             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00802             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00803 
00804         }
00805     }
00806 
00807     <span class="comment">//</span>
00808     <span class="comment">// Get the resource requirements.</span>
00809     <span class="comment">//</span>
00810 
00811     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a56">IopGetResourceRequirementsForAssignTable</a>(AssignTable, AssignTableEnd, &amp;DeviceCount);
00812     <span class="keywordflow">if</span> (DeviceCount == 0) {
00813 
00814         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"IopAllocateResources: Get Requirements for Assign Table found nothing. status %x\n"</span>, Status));
00815 
00816         <span class="keywordflow">if</span> (!Locked) {
00817 
00818             <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
00819             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00820 
00821         }
00822 
00823         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00824 
00825     }
00826 
00827     <span class="comment">//</span>
00828     <span class="comment">// Check if it is OK to assign resources to devices with BOOT configs.</span>
00829     <span class="comment">//</span>
00830 
00831     <span class="keywordflow">if</span> (BootConfigsOK) {
00832 
00833         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/pnpdata_8c.html#a18">IopBootConfigsReserved</a>) {
00834 
00835             <span class="comment">//</span>
00836             <span class="comment">// Process devices with BOOT configs or no requirements first.</span>
00837             <span class="comment">//</span>
00838 
00839             <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
00840 
00841                 <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00842 
00843                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>) {
00844 
00845                     <span class="keywordflow">break</span>;
00846                 }
00847             }
00848 
00849             <span class="keywordflow">if</span> (AssignEntry != AssignTableEnd) {
00850 
00851                 <span class="comment">//</span>
00852                 <span class="comment">// There are devices with BOOT config.</span>
00853                 <span class="comment">//</span>
00854 
00855                 <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
00856 
00857                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00858 
00859                     <span class="keywordflow">if</span> (    !(AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>) &amp;&amp;
00860                             !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>) &amp;&amp;
00861                             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> &amp;&amp;
00862                             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> != <a class="code" href="../../d6/d9/pnp_8h.html#a174a129">ArbiterRequestPnpDetected</a>) {
00863 
00864                         DeviceCount--;
00865                         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"Delaying non BOOT config device %ws...\n"</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
00866                         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_RETRY;
00867                         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>;
00868                         <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(AssignEntry, AssignEntry + 1);
00869 
00870                     }
00871                 }
00872             }
00873 
00874             <span class="keywordflow">if</span> (DeviceCount == 0) {
00875 
00876                 <span class="keywordflow">if</span> (!Locked) {
00877 
00878                     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
00879                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00880 
00881                 }
00882 
00883                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00884             }
00885         }
00886 
00887         <span class="comment">//</span>
00888         <span class="comment">// Check if we need to allocate a new table.</span>
00889         <span class="comment">//</span>
00890 
00891         <span class="keywordflow">if</span> (DeviceCount != *DeviceCountP) {
00892 
00893             <span class="comment">//</span>
00894             <span class="comment">// Allocate a new table.</span>
00895             <span class="comment">//</span>
00896 
00897             AssignTable = (<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>) <a class="code" href="../../d5/d1/pnpres_8c.html#a1">ExAllocatePoolAT</a>( PagedPool,
00898                                                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>) * DeviceCount);
00899             <span class="keywordflow">if</span> (AssignTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00900 
00901                 <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(*AssignTablePP, AssignTableEnd);
00902 
00903                 <span class="keywordflow">if</span> (!Locked) {
00904 
00905                     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
00906                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00907 
00908                 }
00909 
00910                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00911             }
00912 
00913             FreeAssignTable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00914 
00915             <span class="comment">//</span>
00916             <span class="comment">// Process the AssignTable to remove any entry which is marked as IOP_ASSIGN_IGNORE.</span>
00917             <span class="comment">//</span>
00918 
00919             AssignEntryOriginal = *AssignTablePP;
00920             AssignTableEnd = AssignTable + DeviceCount;
00921             <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd;) {
00922 
00923                 <span class="keywordflow">if</span> (!(AssignEntryOriginal-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>)) {
00924 
00925                     *AssignEntry = *AssignEntryOriginal;
00926                     AssignEntry++;
00927 
00928                 }
00929                 AssignEntryOriginal++;
00930             }
00931         }
00932 
00933     } <span class="keywordflow">else</span> {
00934 
00935         <span class="comment">//</span>
00936         <span class="comment">// Only process devices with no resource requirements. Rest get STATUS_RETRY.</span>
00937         <span class="comment">//</span>
00938 
00939         <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
00940 
00941             <span class="keywordflow">if</span> (    !(AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>) &amp;&amp;
00942                     AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>) {
00943 
00944                 <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00945 
00946                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"Delaying resources requiring device %ws...\n"</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
00947                 <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(AssignEntry, AssignEntry + 1);
00948                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_RETRY;
00949 
00950             }
00951         }
00952 
00953         <span class="comment">//</span>
00954         <span class="comment">// Release the I/O Registry Semaphore</span>
00955         <span class="comment">//</span>
00956 
00957         <span class="keywordflow">if</span> (!Locked) {
00958 
00959             <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
00960             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00961 
00962         }
00963 
00964         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00965     }
00966     AssignTableCount = (ULONG)(AssignTableEnd - AssignTable);
00967     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AssignTableCount == DeviceCount);
00968 
00969     <span class="comment">//</span>
00970     <span class="comment">// Sort the AssignTable</span>
00971     <span class="comment">//</span>
00972 
00973     <a class="code" href="../../d5/d1/pnpres_8c.html#a59">IopRearrangeAssignTable</a>(AssignTable, DeviceCount);
00974 
00975     <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
00976 
00977         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00978 
00979         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"Pnpres: Trying to allocate resources for %ws.\n"</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
00980 
00981         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a67">IopAssignInner</a>(1, AssignEntry, FALSE);
00982         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00983 
00984             <a class="code" href="../../d5/d1/pnpres_8c.html#a65">IopBuildCmResourceLists</a>(AssignEntry, AssignEntry + 1);
00985             <span class="keywordflow">if</span> (AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>) {
00986 
00987                 <a class="code" href="../../d5/d1/pnpres_8c.html#a96">IopReleaseFilteredBootResources</a>(AssignEntry, AssignEntry + 1);
00988             }
00989         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INSUFFICIENT_RESOURCES) {
00990 
00991             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"IopAllocateResource: Failed to allocate Pool.\n"</span>));
00992             <span class="keywordflow">break</span>;
00993 
00994         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tryRebalance) {
00995 
00996             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"IopAllocateResources: Initiating REBALANCE...\n"</span>));
00997 
00998             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a35">DNF_NEEDS_REBALANCE</a>;
00999             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a85">IopRebalance</a>(1, AssignEntry);
01000             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a35">DNF_NEEDS_REBALANCE</a>;
01001             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01002                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_CONFLICTING_ADDRESSES;
01003             }
01004         } <span class="keywordflow">else</span> {
01005             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_CONFLICTING_ADDRESSES;
01006         }
01007     }
01008 
01009     <span class="comment">//</span>
01010     <span class="comment">// IF we did not go through the entire table without any error,</span>
01011     <span class="comment">// mark remaining entries as RETRY.</span>
01012     <span class="comment">//</span>
01013 
01014     <span class="keywordflow">for</span> (; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
01015 
01016         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_RETRY;
01017     }
01018 
01019     <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(AssignTable, AssignTableEnd);
01020 
01021     <span class="comment">//</span>
01022     <span class="comment">// Release the I/O Registry Semaphore</span>
01023     <span class="comment">//</span>
01024 
01025     <span class="keywordflow">if</span> (!Locked) {
01026         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( &amp;IopRegistrySemaphore, 0, 1, FALSE );
01027         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>( );
01028     }
01029 
01030     <span class="comment">//</span>
01031     <span class="comment">// Copy the information in our own AssignTable to caller's AssignTable</span>
01032     <span class="comment">//</span>
01033 
01034     <span class="keywordflow">if</span> (FreeAssignTable) {
01035         AssignEntryOriginal = *AssignTablePP;
01036         <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd;) {
01037             <span class="keywordflow">if</span> (AssignEntryOriginal-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a67">IOP_ASSIGN_RETRY</a>)) {
01038                 AssignEntryOriginal++;
01039                 <span class="keywordflow">continue</span>;
01040             }
01041             *AssignEntryOriginal = *AssignEntry;
01042             AssignEntry++;
01043             AssignEntryOriginal++;
01044         }
01045         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AssignEntryOriginal &lt;= *AssignTablePP + *DeviceCountP);
01046         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(AssignTable);
01047     }
01048 
01049     AssignEntry = *AssignTablePP;
01050     <span class="keywordflow">while</span> (AssignEntry &lt; *AssignTablePP + *DeviceCountP) {
01051         <span class="keywordflow">if</span> (AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a67">IOP_ASSIGN_RETRY</a>)) {
01052             AssignEntry++;
01053             <span class="keywordflow">continue</span>;
01054         }
01055         <span class="keywordflow">if</span> ((AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>) || AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01056 
01057             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_CONFLICTING_ADDRESSES;
01058         }
01059         AssignEntry++;
01060     }
01061 
01062     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01063 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a373" doxytag="pnpiop.h::IopAllocateUnicodeString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAllocateUnicodeString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>String</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05619">5619</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05137">IopBuildSymbolicLinkStrings()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04741">IopOpenOrCreateDeviceInterfaceSubKeys()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">IopRemoveDeviceInterfaces()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05714">IopSetRegistryStringValue()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04140">IopUnregisterDeviceInterface()</a>.
<p>
<pre class="fragment"><div>05626                    :
05627 
05628     This routine allocates a buffer <span class="keywordflow">for</span> a unicode string of a given length
05629     and initialises <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UNICODE_STRING structure appropriately. When <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05630     string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no longer required <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be freed <span class="keyword">using</span> IopFreeAllocatedString.
05631     The buffer also be directly deleted by <a class="code" href="../../d6/d3/cmwraper_8c.html#a26">ExFreePool</a> and so can be handed
05632     back to a caller.
05633 
05634 Parameters:
05635 
05636     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - Supplies a pointer to an uninitialised unicode string which will
05637         be manipulated by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function.
05638 
05639     Length - The number of <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a12">BYTES</a> <span class="keywordtype">long</span> that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string will be.
05640 
05641 Return Value:
05642 
05643     Either STATUS_INSUFFICIENT_RESOURCES indicating paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> exhausted or
05644     STATUS_SUCCESS.
05645 
05646 Remarks:
05647 
05648     The buffer allocated will be one character (2 bytes) more than length specified.
05649     This is to allow for easy null termination of the strings - eg for registry
05650     storage.
05651 
05652 --*/
05653 
05654 {
05655     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05656 
05657     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length = 0;
05658     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;MaximumLength = Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
05659 
05660     <span class="keywordflow">if</span>(!(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, Length + <span class="keyword">sizeof</span>(UNICODE_NULL)))) {
05661         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05662     } <span class="keywordflow">else</span> {
05663         <span class="keywordflow">return</span> STATUS_SUCCESS;
05664     }
05665 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a227" doxytag="pnpiop.h::IopAppendStringToValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAppendStringToValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>String</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Create</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00546">546</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d5/consubs_8c-source.html#l00023">Create()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
<pre class="fragment"><div>00555                    :
00556 
00557     This routine appends a string to a value entry specified by <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>
00558     under an already opened registry handle.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not present
00559     and <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, a <span class="keyword">new</span> value entry will be created <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name
00560     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.
00561 
00562 Parameters:
00563 
00564     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to a registry key whose value entry will
00565         be modified.
00566 
00567     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> - Supplies a pointer to a string to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
00568 
00569     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - Supplies a unicode string to append to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
00570 
00571     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> - Supplies a BOOLEAN variable to indicate <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>
00572         value entry should be created <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not present.
00573 
00574 Return Value:
00575 
00576     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
00577 
00578 --*/
00579 
00580 {
00581     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00582     PWSTR destinationString, p;
00583     UNICODE_STRING unicodeValueName;
00584     ULONG size;
00585     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00586 
00587     <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> || (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length &lt; <span class="keyword">sizeof</span>(WCHAR)) ) {
00588         <span class="keywordflow">return</span> STATUS_SUCCESS;
00589     }
00590 
00591     <span class="comment">//</span>
00592     <span class="comment">// Read registry value entry data</span>
00593     <span class="comment">//</span>
00594 
00595     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(Handle, ValueName, &amp;keyValueInformation);
00596 
00597     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00598         <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND &amp;&amp; <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
00599 
00600             <span class="comment">//</span>
00601             <span class="comment">// if no valid entry exists and user said ok to create one</span>
00602             <span class="comment">//</span>
00603 
00604             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00605         } <span class="keywordflow">else</span> {
00606             <span class="keywordflow">return</span> status;
00607         }
00608     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(keyValueInformation-&gt;Type != REG_MULTI_SZ) {
00609 
00610         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00611 
00612         <span class="keywordflow">if</span>(<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
00613             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00614         } <span class="keywordflow">else</span> {
00615             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
00616         }
00617 
00618     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(keyValueInformation-&gt;DataLength &lt; <span class="keyword">sizeof</span>(WCHAR) ||
00619               *(PWCHAR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation) == UNICODE_NULL) {  <span class="comment">// empty or one NULL WCHAR</span>
00620 
00621         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00622         keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00623     }
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">// Allocate a buffer to hold new data for the specified key value entry</span>
00627     <span class="comment">// Make sure the buffer is at least an empty MULTI_SZ big.</span>
00628     <span class="comment">//</span>
00629 
00630     <span class="keywordflow">if</span> (keyValueInformation) {
00631         size = keyValueInformation-&gt;DataLength + <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + <span class="keyword">sizeof</span> (UNICODE_NULL);
00632     } <span class="keywordflow">else</span> {
00633         size =  <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + 2 * <span class="keyword">sizeof</span>(UNICODE_NULL);
00634     }
00635 
00636     destinationString = p = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
00637     <span class="keywordflow">if</span> (destinationString == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00638         <span class="keywordflow">if</span> (keyValueInformation) {
00639             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00640         }
00641         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00642     }
00643 
00644     <span class="comment">//</span>
00645     <span class="comment">// Copy the existing data to our newly allocated buffer, if any</span>
00646     <span class="comment">//</span>
00647 
00648     <span class="keywordflow">if</span> (keyValueInformation) {
00649 
00650         <span class="comment">//</span>
00651         <span class="comment">// Note we  need to remove a UNICODE_NULL because the</span>
00652         <span class="comment">// MULTI_SZ has two terminating UNICODE_NULL.</span>
00653         <span class="comment">//</span>
00654 
00655         RtlMoveMemory(p,
00656                       <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00657                       keyValueInformation-&gt;DataLength - <span class="keyword">sizeof</span>(WCHAR)
00658                       );
00659         p += keyValueInformation-&gt;DataLength / <span class="keyword">sizeof</span>(WCHAR) - 1;
00660 
00661         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00662     }
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">// Append the user specified unicode string to our buffer</span>
00666     <span class="comment">//</span>
00667     RtlMoveMemory(p,
00668                   <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer,
00669                   <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length
00670                   );
00671     p += <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00672     *p = UNICODE_NULL;
00673     p++;
00674     *p = UNICODE_NULL;
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">// Finally write the data to the specified registy value entry</span>
00678     <span class="comment">//</span>
00679 
00680     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeValueName, ValueName);
00681     status = ZwSetValueKey(
00682                 Handle,
00683                 &amp;unicodeValueName,
00684                 TITLE_INDEX_VALUE,
00685                 REG_MULTI_SZ,
00686                 destinationString,
00687                 size
00688                 );
00689 
00690     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(destinationString);
00691     <span class="keywordflow">return</span> status;
00692 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a245" doxytag="pnpiop.h::IopApplyFunctionToServiceInstances" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopApplyFunctionToServiceInstances           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE ServiceKeyHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING ServiceKeyName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreNonCriticalErrors</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a121">PIOP_SUBKEY_CALLBACK_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DevInstCallbackRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ServiceInstanceOrdinal&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02209">2209</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00899">PNP_SCRATCH_BUFFER_SIZE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00117">IopAddDevicesToBootDriver()</a>, and <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01411">IopGetDriverDeviceList()</a>.
<p>
<pre class="fragment"><div>02221                    :
02222 
02223     This routine enumerates all device instances referenced by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance
02224     ordinal entries under a service's <span class="keyword">volatile</span> Enum key, and calls
02225     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified callback routine <span class="keywordflow">for</span> each instance's corresponding subkey
02226     under HKLM\System\Enum.
02227 
02228 Arguments:
02229 
02230     ServiceKeyHandle - Optional handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service entry. If <span class="keyword">this</span> parameter
02231         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key name must be given in
02232         ServiceKeyName (<span class="keywordflow">if</span> both parameters are specified, then ServiceKeyHandle
02233         is used, and ServiceKeyName is ignored).
02234 
02235     ServiceKeyName - Optional name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service entry key (under
02236         HKLM\CurrentControlSet\Services). If <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified,
02237         then ServiceKeyHandle must contain a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired service key.
02238 
02239     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine
02240         needs to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumerated device instance keys.  If no desired access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02241         specified (i.e., DesiredAccess is zero), then no handle will be opened
02242         <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance keys, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback will be passed a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">for</span>
02243         its DeviceInstanceHandle parameter.
02244 
02245     IgnoreNonCriticalErrors - Specifies whether <span class="keyword">this</span> function should
02246         immediately terminate on all errors, or <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> on critical ones.
02247         An example of a non-critical error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> when an enumerated device instance
02248         key cannot be opened <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access.
02249 
02250     DevInstCallbackRoutine - Supplies a pointer to a function that will
02251         be called <span class="keywordflow">for</span> each device instance key referenced by a service instance
02252         entry under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service's <span class="keyword">volatile</span> Enum subkey. The prototype of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02253         function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> as follows:
02254 
02255             <span class="keyword">typedef</span> BOOLEAN (*PIOP_SUBKEY_CALLBACK_ROUTINE) (
02256                 IN     HANDLE DeviceInstanceHandle,
02257                 IN     PUNICODE_STRING DeviceInstancePath,
02258                 IN OUT PVOID Context
02259                 );
02260 
02261         where DeviceInstanceHandle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to an enumerated device instance
02262         key, DeviceInstancePath <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> (relative to
02263         HKLM\System\Enum) to <span class="keyword">this</span> device instance, and Context <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to
02264         user-defined data.
02265 
02266         This function should <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to <span class="keywordflow">continue</span> enumeration, or
02267         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to terminate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
02268 
02269     Context - Supplies a pointer to user-defined data that will be passed
02270         in to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine at each device instance key invocation.
02271 
02272     ServiceInstanceOrdinal - Optionally, receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service instance ordinal (1 based)
02273         that terminated the enumeration, or the total number of instances enumerated
02274         if the enumeration completed without being aborted.
02275 
02276 Return Value:
02277 
02278     NT status code indicating whether the device instance keys were successfully
02279     enumerated.  Note that this does not provide information on the success or
02280     failure of the callback routine--if desired, this information should be
02281     stored in the Context structure.
02282 
02283 --*/
02284 
02285 {
02286     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02287     HANDLE ServiceEnumHandle, SystemEnumHandle, DeviceInstanceHandle;
02288     UNICODE_STRING TempUnicodeString;
02289     ULONG ServiceInstanceCount, i, junk;
02290     PKEY_VALUE_FULL_INFORMATION KeyValueInformation;
02291     WCHAR ValueNameString[20];
02292     BOOLEAN ContinueEnumeration;
02293 
02294     <span class="comment">//</span>
02295     <span class="comment">// First, open up the volatile Enum subkey under the specified service entry.</span>
02296     <span class="comment">//</span>
02297 
02298     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceKeyHandle)) {
02299         PiWstrToUnicodeString(&amp;TempUnicodeString, REGSTR_KEY_ENUM);
02300         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;ServiceEnumHandle,
02301                                        ServiceKeyHandle,
02302                                        &amp;TempUnicodeString,
02303                                        KEY_READ
02304                                        );
02305     } <span class="keywordflow">else</span> {
02306         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
02307                                         KEY_READ,
02308                                         NULL,
02309                                         &amp;ServiceEnumHandle,
02310                                         FALSE
02311                                        );
02312     }
02313     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02314         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02315     }
02316 
02317     <span class="comment">//</span>
02318     <span class="comment">// Find out how many instances are referenced in the service's Enum key.</span>
02319     <span class="comment">//</span>
02320 
02321     ServiceInstanceCount = 0;   <span class="comment">// assume none.</span>
02322 
02323     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(ServiceEnumHandle,
02324                                  REGSTR_VALUE_COUNT,
02325                                  &amp;KeyValueInformation
02326                                 );
02327     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02328 
02329         <span class="keywordflow">if</span>((KeyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
02330            (KeyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
02331 
02332             ServiceInstanceCount = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation);
02333 
02334         }
02335         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueInformation);
02336 
02337     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_OBJECT_NAME_NOT_FOUND) {
02338         <span class="keywordflow">goto</span> PrepareForReturn;
02339     } <span class="keywordflow">else</span> {
02340         <span class="comment">//</span>
02341         <span class="comment">// If 'Count' value entry not found, consider this to mean there are simply</span>
02342         <span class="comment">// no device instance controlled by this service.</span>
02343         <span class="comment">//</span>
02344         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02345     }
02346 
02347     <span class="comment">//</span>
02348     <span class="comment">// Now, enumerate each service instance, and call the specified callback function</span>
02349     <span class="comment">// for the corresponding device instance.</span>
02350     <span class="comment">//</span>
02351 
02352     <span class="keywordflow">if</span> (ServiceInstanceCount) {
02353 
02354         <span class="keywordflow">if</span> (DesiredAccess) {
02355             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;SystemEnumHandle,
02356                                            NULL,
02357                                            &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
02358                                            KEY_READ
02359                                            );
02360             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02361                 <span class="keywordflow">goto</span> PrepareForReturn;
02362             }
02363         } <span class="keywordflow">else</span> {
02364             <span class="comment">//</span>
02365             <span class="comment">// Set DeviceInstanceHandle to NULL, since we won't be opening up the</span>
02366             <span class="comment">// device instance keys.</span>
02367             <span class="comment">//</span>
02368             DeviceInstanceHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02369         }
02370         KeyValueInformation = (PKEY_VALUE_FULL_INFORMATION)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
02371                                                               PagedPool,
02372                                                               PNP_SCRATCH_BUFFER_SIZE);
02373         <span class="keywordflow">if</span> (!KeyValueInformation) {
02374             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
02375             <span class="keywordflow">goto</span> PrepareForReturn;
02376         }
02377         i = 0;
02378         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02379             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateValueKey (           <span class="comment">// i was initialized to zero above.</span>
02380                             ServiceEnumHandle,
02381                             i++,
02382                             KeyValueFullInformation,
02383                             KeyValueInformation,
02384                             PNP_SCRATCH_BUFFER_SIZE,
02385                             &amp;junk
02386                             );
02387 
02388             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
02389                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
02390                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02391                     <span class="keywordflow">break</span>;
02392                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(IgnoreNonCriticalErrors) {
02393                     <span class="keywordflow">continue</span>;
02394                 } <span class="keywordflow">else</span> {
02395                     <span class="keywordflow">break</span>;
02396                 }
02397             }
02398 
02399             <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type != REG_SZ) {
02400                 <span class="keywordflow">continue</span>;
02401             }
02402 
02403             ContinueEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02404             TempUnicodeString.Length = 0;
02405             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;TempUnicodeString,
02406                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation),
02407                                            KeyValueInformation-&gt;DataLength
02408                                            );
02409             <span class="keywordflow">if</span> (TempUnicodeString.Length) {
02410 
02411                 <span class="comment">//</span>
02412                 <span class="comment">// We have retrieved a (non-empty) string for this service instance.</span>
02413                 <span class="comment">// If the user specified a non-zero value for the DesiredAccess</span>
02414                 <span class="comment">// parameter, we will attempt to open up the corresponding device</span>
02415                 <span class="comment">// instance key under HKLM\System\Enum.</span>
02416                 <span class="comment">//</span>
02417                 <span class="keywordflow">if</span> (DesiredAccess) {
02418                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;DeviceInstanceHandle,
02419                                                    SystemEnumHandle,
02420                                                    &amp;TempUnicodeString,
02421                                                    DesiredAccess
02422                                                    );
02423                 }
02424 
02425                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02426                     <span class="comment">//</span>
02427                     <span class="comment">// Invoke the specified callback routine for this device instance.</span>
02428                     <span class="comment">//</span>
02429                     ContinueEnumeration = DevInstCallbackRoutine(DeviceInstanceHandle,
02430                                                                  &amp;TempUnicodeString,
02431                                                                  Context
02432                                                                 );
02433                     <span class="keywordflow">if</span> (DesiredAccess) {
02434                         ZwClose(DeviceInstanceHandle);
02435                     }
02436                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IgnoreNonCriticalErrors) {
02437                     <span class="keywordflow">continue</span>;
02438                 } <span class="keywordflow">else</span> {
02439                     <span class="keywordflow">break</span>;
02440                 }
02441             } <span class="keywordflow">else</span> {
02442                 <span class="keywordflow">continue</span>;
02443             }
02444             <span class="keywordflow">if</span> (!ContinueEnumeration) {
02445                 <span class="keywordflow">break</span>;
02446             }
02447         }
02448 
02449         <span class="keywordflow">if</span>(DesiredAccess) {
02450             ZwClose(SystemEnumHandle);
02451         }
02452         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueInformation);
02453     }
02454 
02455     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceInstanceOrdinal)) {
02456         *ServiceInstanceOrdinal = i;
02457     }
02458 
02459 PrepareForReturn:
02460 
02461     ZwClose(ServiceEnumHandle);
02462 
02463     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02464 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a243" doxytag="pnpiop.h::IopApplyFunctionToSubKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopApplyFunctionToSubKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE BaseHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a121">PIOP_SUBKEY_CALLBACK_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SubKeyCallbackRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01844">1844</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
<pre class="fragment"><div>01855                    :
01856 
01857     This routine enumerates all subkeys under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified key, and calls
01858     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified callback routine <span class="keywordflow">for</span> each subkey.
01859 
01860 Arguments:
01861 
01862     BaseHandle - Optional handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>. If <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also
01863         specified, then <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> represents a subkey under <span class="keyword">this</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.  If <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>
01864         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkeys are enumerated under <span class="keyword">this</span> handle.  If <span class="keyword">this</span>
01865         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base key must be
01866         given in <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.
01867 
01868     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - Optional name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key whose subkeys are to be enumerated.
01869 
01870     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine
01871         needs to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkeys.  If no desired access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified (i.e.,
01872         DesiredAccess is zero), then no handle will be opened <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01873         subkeys, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback will be passed a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">for</span> its SubKeyHandle
01874         parameter.
01875 
01876     Flags - Controls <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> behavior of subkey enumeration.  Currently, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01877         following flags are defined:
01878 
01879         <a class="code" href="../../d9/d0/pnpiop_8h.html#a90">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a> - Specifies whether <span class="keyword">this</span>
01880             function should immediately terminate on all errors, or <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> on
01881             critical ones.  An example of a non-critical error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> when an
01882             enumerated subkey cannot be opened <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access.
01883 
01884         FUNCTION_SUBKEY_DELETE_SUBKEYS - Specifies that each subkey should be
01885             deleted after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified SubKeyCallBackRoutine has been performed
01886             on <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  Note that <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NOT a recursive <span class="keyword">delete</span> on each of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01887             subkeys, just an attempt to <span class="keyword">delete</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey itself.  It <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey
01888             contains children, <span class="keyword">this</span> will fail.
01889 
01890     SubKeyCallbackRoutine - Supplies a pointer to a function that will
01891         be called <span class="keywordflow">for</span> each subkey found under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01892         specified key.  The prototype of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function
01893         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> as follows:
01894 
01895             <span class="keyword">typedef</span> BOOLEAN (*PIOP_SUBKEY_CALLBACK_ROUTINE) (
01896                 IN     HANDLE SubKeyHandle,
01897                 IN     PUNICODE_STRING SubKeyName,
01898                 IN OUT PVOID Context
01899                 );
01900 
01901         where SubKeyHandle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to an enumerated subkey under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01902         specified key, SubKeyName <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> its name, and Context <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to
01903         user-defined data.
01904 
01905         This function should <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to <span class="keywordflow">continue</span> enumeration, or
01906         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to terminate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01907 
01908     Context - Supplies a pointer to user-defined data that will be passed
01909         in to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine at each subkey invocation.
01910 
01911 Return Value:
01912 
01913     NT status code indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkeys were successfully
01914     enumerated.  Note that <span class="keyword">this</span> does not provide information on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01915     success or <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine--<span class="keywordflow">if</span> desired, <span class="keyword">this</span>
01916     information should be stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Context structure.
01917 
01918 --*/
01919 
01920 {
01921     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01922     BOOLEAN CloseHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, ContinueEnumeration;
01923     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, SubKeyHandle;
01924     ULONG i, RequiredBufferLength;
01925     PKEY_BASIC_INFORMATION KeyInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01926     <span class="comment">// Use an initial key name buffer size large enough for a 20-character key</span>
01927     <span class="comment">// (+ terminating NULL)</span>
01928     ULONG KeyInformationLength = <span class="keyword">sizeof</span>(KEY_BASIC_INFORMATION) + (20 * <span class="keyword">sizeof</span>(WCHAR));
01929     UNICODE_STRING SubKeyName;
01930 
01931     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(KeyName)) {
01932 
01933         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;Handle,
01934                                        BaseHandle,
01935                                        KeyName,
01936                                        KEY_READ
01937                                        );
01938         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01939             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01940         } <span class="keywordflow">else</span> {
01941             CloseHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01942         }
01943 
01944     } <span class="keywordflow">else</span> {
01945 
01946         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = BaseHandle;
01947     }
01948 
01949     <span class="comment">//</span>
01950     <span class="comment">// Enumerate the subkeys until we run out of them.</span>
01951     <span class="comment">//</span>
01952     i = 0;
01953     SubKeyHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01954 
01955     <span class="keywordflow">while</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01956 
01957         <span class="keywordflow">if</span>(!KeyInformation) {
01958 
01959             KeyInformation = (PKEY_BASIC_INFORMATION)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
01960                                                                     KeyInformationLength
01961                                                                    );
01962             <span class="keywordflow">if</span>(!KeyInformation) {
01963                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01964                 <span class="keywordflow">break</span>;
01965             }
01966         }
01967 
01968         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateKey(Handle,
01969                                 i,
01970                                 KeyBasicInformation,
01971                                 KeyInformation,
01972                                 KeyInformationLength,
01973                                 &amp;RequiredBufferLength
01974                                );
01975 
01976         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01977             <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
01978                 <span class="comment">//</span>
01979                 <span class="comment">// Try again with larger buffer.</span>
01980                 <span class="comment">//</span>
01981                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyInformation);
01982                 KeyInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01983                 KeyInformationLength = RequiredBufferLength;
01984                 <span class="keywordflow">continue</span>;
01985 
01986             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
01987                 <span class="comment">//</span>
01988                 <span class="comment">// break out of loop</span>
01989                 <span class="comment">//</span>
01990                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01991                 <span class="keywordflow">break</span>;
01992 
01993             } <span class="keywordflow">else</span> {
01994                 <span class="comment">//</span>
01995                 <span class="comment">// This is a non-critical error.</span>
01996                 <span class="comment">//</span>
01997                 <span class="keywordflow">if</span>(Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a90">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a>) {
01998                     <span class="keywordflow">goto</span> ContinueWithNextSubKey;
01999                 } <span class="keywordflow">else</span> {
02000                     <span class="keywordflow">break</span>;
02001                 }
02002             }
02003         }
02004 
02005         <span class="comment">//</span>
02006         <span class="comment">// Initialize a unicode string with this key name.  Note that this string</span>
02007         <span class="comment">// WILL NOT be NULL-terminated.</span>
02008         <span class="comment">//</span>
02009         SubKeyName.Length = SubKeyName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)KeyInformation-&gt;NameLength;
02010         SubKeyName.Buffer = KeyInformation-&gt;Name;
02011 
02012         <span class="comment">//</span>
02013         <span class="comment">// If DesiredAccess is non-zero, open a handle to this subkey.</span>
02014         <span class="comment">//</span>
02015         <span class="keywordflow">if</span>(DesiredAccess) {
02016             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;SubKeyHandle,
02017                                            Handle,
02018                                            &amp;SubKeyName,
02019                                            DesiredAccess
02020                                            );
02021             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02022                 <span class="comment">//</span>
02023                 <span class="comment">// This is a non-critical error.</span>
02024                 <span class="comment">//</span>
02025                 <span class="keywordflow">if</span>(Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a90">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a>) {
02026                     <span class="keywordflow">goto</span> ContinueWithNextSubKey;
02027                 } <span class="keywordflow">else</span> {
02028                     <span class="keywordflow">break</span>;
02029                 }
02030             }
02031         }
02032 
02033         <span class="comment">//</span>
02034         <span class="comment">// Invoke the supplied callback function for this subkey.</span>
02035         <span class="comment">//</span>
02036         ContinueEnumeration = SubKeyCallbackRoutine(SubKeyHandle, &amp;SubKeyName, Context);
02037 
02038         <span class="keywordflow">if</span> (DesiredAccess) {
02039             <span class="keywordflow">if</span> (ContinueEnumeration &amp;&amp;
02040                 (Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a91">FUNCTIONSUBKEY_FLAG_DELETE_SUBKEYS</a>)) {
02041                 <span class="comment">//</span>
02042                 <span class="comment">// Delete the key when asked to, only if the callback routine</span>
02043                 <span class="comment">// was successful, otherwise we may not be able to.</span>
02044                 <span class="comment">//</span>
02045                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeleteKey(SubKeyHandle);
02046             }
02047             ZwClose(SubKeyHandle);
02048         }
02049 
02050         <span class="keywordflow">if</span>(!ContinueEnumeration) {
02051             <span class="comment">//</span>
02052             <span class="comment">// Enumeration has been aborted.</span>
02053             <span class="comment">//</span>
02054             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02055             <span class="keywordflow">break</span>;
02056 
02057         }
02058 
02059 ContinueWithNextSubKey:
02060         <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a91">FUNCTIONSUBKEY_FLAG_DELETE_SUBKEYS</a>)) {
02061             <span class="comment">//</span>
02062             <span class="comment">// Only increment the enumeration index for non-deleted subkeys</span>
02063             <span class="comment">//</span>
02064             i++;
02065         }
02066     }
02067 
02068     <span class="keywordflow">if</span>(KeyInformation) {
02069         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyInformation);
02070     }
02071 
02072     <span class="keywordflow">if</span>(CloseHandle) {
02073         ZwClose(Handle);
02074     }
02075 
02076     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02077 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a369" doxytag="pnpiop.h::IopBusNumberInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopBusNumberInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a286" doxytag="pnpiop.h::IopCallDriverAddDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCallDriverAddDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LoadDriver</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d5/struct__ADD__CONTEXT.html">PADD_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AddContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">2525</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00069">ASSERT_INITED</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00147">ASSERTMSG</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00180">CmRegistryMachineSystemCurrentControlSetControlClass</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00052">DebugPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00493">DNF_LEGACY_DRIVER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01159">DO_DEVICE_INITIALIZING</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00089">DOE_BOTTOM_OF_FDO_STACK</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00088">DOE_DESIGNATED_FDO</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00090">DOE_RAW_FDO</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00044">InitSafeBootMode</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09046">IopBootLog()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04759">IopChangeDeviceObjectFromRegistryProperties()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00831">IopClearDevNodeProblem</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01870">IopDeviceNodeFlagsToCapabilities</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02793">IopQueryLegacyBusInformation()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08822">IopSafebootDriverLoad()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d0/pnpenum_8c.html#a41a13">LowerClassFilters</a>, <a class="el" href="../../d6/d0/pnpenum_8c.html#a41a12">LowerDeviceFilters</a>, <a class="el" href="../../d6/d0/pnpenum_8c.html#a41a17">MaximumAddStage</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00037">_DRIVER_LIST_ENTRY::NextEntry</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00615">OK_TO_ADD_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00590">PDRIVER_ADD_DEVICE</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00033">PDRIVER_LIST_ENTRY</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l00744">RtlQueryRegistryValues()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d0/pnpenum_8c.html#a41a16">UpperClassFilters</a>, and <a class="el" href="../../d6/d0/pnpenum_8c.html#a41a15">UpperDeviceFilters</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00166">IopAddDevicesToBootDriverWorker()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01117">IopProcessAddDevicesWorker()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01488">IopProcessNewChildren()</a>.
<p>
<pre class="fragment"><div>02533                    :
02534 
02535     This function checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceNode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present and loads
02536     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <span class="keywordflow">if</span> necessary.
02537 
02538 Arguments:
02539 
02540     DeviceNode - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node to be enumerated.
02541 
02542     LoadDriver - Supplies a BOOLEAN value to indicate should a driver be loaded
02543                  to complete enumeration.
02544 
02545     Context - Supplies a pointer to <a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html">ADD_CONTEXT</a> to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> how <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device be added.
02546 
02547 Return Value:
02548 
02549     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
02550 
02551 --*/
02552 
02553 {
02554     HANDLE enumKey;
02555     HANDLE instanceKey;
02556     HANDLE classKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02557     HANDLE classPropsKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02558     PKEY_VALUE_FULL_INFORMATION keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02559     RTL_QUERY_REGISTRY_TABLE queryTable[3];
02560     <a class="code" href="../../d4/d6/structQUERY__CONTEXT.html">QUERY_CONTEXT</a> queryContext;
02561     BOOLEAN deviceRaw = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02562     BOOLEAN usePdoCharacteristics = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02563     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02564     <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a> capabilities;
02565     ULONG index;
02566     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
02567 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
02568 <span class="preprocessor"></span>    <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> fdoDeviceObject, topOfPdoStack, topOfLowerFilterStack;
02569     BOOLEAN deviceObjectHasBeenAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02570 <span class="preprocessor">#endif</span>
02571 <span class="preprocessor"></span>
02572     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: Processing devnode %#08lx\n"</span>,
02573                    DeviceNode));
02574 
02575     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: DevNode flags going in = %#08lx\n"</span>,
02576                    DeviceNode-&gt;Flags));
02577 
02578     <span class="comment">//</span>
02579     <span class="comment">// The device node may have been started at this point.  This is because</span>
02580     <span class="comment">// some ill-behaved miniport drivers call IopReportedDetectedDevice at</span>
02581     <span class="comment">// DriverEntry for the devices which we already know about.</span>
02582     <span class="comment">//</span>
02583 
02584     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a42">OK_TO_ADD_DEVICE</a>(DeviceNode)) {
02585         <span class="keywordflow">return</span> STATUS_SUCCESS;
02586     }
02587 
02588     <a class="code" href="../../d6/d0/pnpenum_8c.html#a0">ASSERT_INITED</a>(DeviceNode-&gt;PhysicalDeviceObject);
02589 
02590     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t%s load driver\n"</span>,
02591                    (LoadDriver ? <span class="stringliteral">"Will"</span> : <span class="stringliteral">"Won't"</span>)));
02592 
02593     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\tOpening registry key %wZ\n"</span>,
02594                    &amp;DeviceNode-&gt;InstancePath));
02595 
02596     <span class="comment">//</span>
02597     <span class="comment">// Open the HKLM\System\CCS\Enum key.</span>
02598     <span class="comment">//</span>
02599 
02600     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumKey,
02601                                    NULL,
02602                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
02603                                    KEY_READ
02604                                    );
02605 
02606     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02607         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\tUnable to open "</span>
02608                        <span class="stringliteral">"HKLM\\SYSTEM\\CCS\\ENUM\n"</span>));
02609         <span class="keywordflow">return</span> status;
02610     }
02611 
02612     <span class="comment">//</span>
02613     <span class="comment">// Open the instance key for this devnode</span>
02614     <span class="comment">//</span>
02615 
02616     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;instanceKey,
02617                                    enumKey,
02618                                    &amp;DeviceNode-&gt;InstancePath,
02619                                    KEY_READ
02620                                    );
02621 
02622     ZwClose(enumKey);
02623 
02624     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02625 
02626         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\tError %#08lx opening enum key\n"</span>,
02627                     status));
02628         <span class="keywordflow">return</span> status;
02629     }
02630 
02631     <span class="comment">//</span>
02632     <span class="comment">// Get the class value to locate the class key for this devnode</span>
02633     <span class="comment">//</span>
02634 
02635     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(instanceKey,
02636                                  REGSTR_VALUE_CLASSGUID,
02637                                  &amp;keyValueInformation);
02638 
02639     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; ((keyValueInformation-&gt;Type == REG_SZ) &amp;&amp;
02640                               (keyValueInformation-&gt;DataLength != 0))) {
02641 
02642         HANDLE controlKey;
02643         UNICODE_STRING unicodeClassGuid;
02644 
02645         <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(
02646             &amp;unicodeClassGuid,
02647             (PWSTR) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
02648             keyValueInformation-&gt;DataLength);
02649 
02650         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\tClass GUID is %wZ\n"</span>,
02651                        &amp;unicodeClassGuid));
02652 
02653         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/init_8h.html#a18">InitSafeBootMode</a>) {
02654             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a223">IopSafebootDriverLoad</a>(&amp;unicodeClassGuid)) {
02655                 PKEY_VALUE_FULL_INFORMATION ClassValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02656                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> s;
02657 
02658                 <span class="comment">//</span>
02659                 <span class="comment">// don't load the driver</span>
02660                 <span class="comment">//</span>
02661                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SAFEBOOT: skipping device = %wZ\n"</span>,&amp;unicodeClassGuid);
02662                 s = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(instanceKey,
02663                                         REGSTR_VAL_DEVDESC,
02664                                         &amp;ClassValueInformation);
02665                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(s)) {
02666                     UNICODE_STRING ClassString;
02667 
02668                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ClassString, (PCWSTR) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(ClassValueInformation));
02669 
02670                     <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;ClassString, FALSE);
02671                 } <span class="keywordflow">else</span> {
02672                     <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;unicodeClassGuid, FALSE);
02673                 }
02674                 <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02675             }
02676         }
02677 
02678         <span class="comment">//</span>
02679         <span class="comment">// Open the class key</span>
02680         <span class="comment">//</span>
02681 
02682         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;controlKey,
02683                                        NULL,
02684                                        &amp;CmRegistryMachineSystemCurrentControlSetControlClass,
02685                                        KEY_READ
02686                                        );
02687 
02688         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02689 
02690             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\tUnable to open "</span>
02691                         <span class="stringliteral">"HKLM\\SYSTEM\\CCS\\CONTROL\\CLASS - %#08lx\n"</span>,
02692                         status));
02693             classKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02694         } <span class="keywordflow">else</span> {
02695 
02696             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;classKey,
02697                                            controlKey,
02698                                            &amp;unicodeClassGuid,
02699                                            KEY_READ
02700                                            );
02701 
02702             ZwClose(controlKey);
02703 
02704             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02705 
02706                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\tUnable to open GUID key "</span>
02707                             <span class="stringliteral">"%wZ - %#08lx\n"</span>,
02708                             &amp;unicodeClassGuid,
02709                             status));
02710 
02711                 classKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02712             }
02713         }
02714 
02715         <span class="keywordflow">if</span> (classKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02716 
02717             UNICODE_STRING unicodeProperties;
02718 
02719             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeProperties, REGSTR_KEY_DEVICE_PROPERTIES );
02720 
02721             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;classPropsKey,
02722                                            classKey,
02723                                            &amp;unicodeProperties,
02724                                            KEY_READ
02725                                            );
02726 
02727             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02728 
02729                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(2, (<span class="stringliteral">"IopCallDriverAddDevice:\tUnable to open GUID\\Properties key "</span>
02730                             <span class="stringliteral">"%wZ - %#08lx\n"</span>,
02731                             &amp;unicodeClassGuid,
02732                             status));
02733 
02734                 classPropsKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02735             }
02736         }
02737 
02738         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
02739         keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02740 
02741     }
02742 
02743     <span class="comment">//</span>
02744     <span class="comment">// Check to see if there's a service assigned to this device node.  If</span>
02745     <span class="comment">// there's not then we can bail out without wasting too much time.</span>
02746     <span class="comment">//</span>
02747 
02748     RtlZeroMemory(&amp;queryContext, <span class="keyword">sizeof</span>(queryContext));
02749 
02750     queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o0">DeviceNode</a> = DeviceNode;
02751     queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o1">LoadDriver</a> = LoadDriver;
02752 
02753     queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o2">AddContext</a> = Context;
02754 
02755     RtlZeroMemory(queryTable, <span class="keyword">sizeof</span>(queryTable));
02756 
02757     queryTable[0].QueryRoutine =
02758         (PRTL_QUERY_REGISTRY_ROUTINE) <a class="code" href="../../d6/d0/pnpenum_8c.html#a21">IopCallDriverAddDeviceQueryRoutine</a>;
02759     queryTable[0].Name = REGSTR_VAL_LOWERFILTERS;
02760     queryTable[0].EntryContext = (PVOID) UIntToPtr(LowerDeviceFilters);
02761 
02762     status = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_HANDLE,
02763                                     (PWSTR) instanceKey,
02764                                     queryTable,
02765                                     &amp;queryContext,
02766                                     NULL);
02767     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02768 
02769         <span class="keywordflow">if</span> (classKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02770 
02771             queryTable[0].QueryRoutine =
02772                 (PRTL_QUERY_REGISTRY_ROUTINE) <a class="code" href="../../d6/d0/pnpenum_8c.html#a21">IopCallDriverAddDeviceQueryRoutine</a>;
02773             queryTable[0].Name = REGSTR_VAL_LOWERFILTERS;
02774             queryTable[0].EntryContext = (PVOID) UIntToPtr(LowerClassFilters);
02775             status = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_HANDLE,
02776                                             (PWSTR) classKey,
02777                                             queryTable,
02778                                             &amp;queryContext,
02779                                             NULL);
02780         }
02781 
02782         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02783             queryTable[0].QueryRoutine = (PRTL_QUERY_REGISTRY_ROUTINE) <a class="code" href="../../d6/d0/pnpenum_8c.html#a21">IopCallDriverAddDeviceQueryRoutine</a>;
02784             queryTable[0].Name = REGSTR_VALUE_SERVICE;
02785             queryTable[0].EntryContext = (PVOID) UIntToPtr(DeviceService);
02786             queryTable[0].Flags = RTL_QUERY_REGISTRY_REQUIRED;
02787 
02788             status = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_HANDLE,
02789                                             (PWSTR) instanceKey,
02790                                             queryTable,
02791                                             &amp;queryContext,
02792                                             NULL);
02793         }
02794     }
02795 
02796     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>) {
02797 
02798         <span class="comment">//</span>
02799         <span class="comment">// One of the services for this device is a legacy driver.  Don't try</span>
02800         <span class="comment">// to add any filters since we'll just screw up the device stack.</span>
02801         <span class="comment">//</span>
02802 
02803         status = STATUS_SUCCESS;
02804         <span class="keywordflow">goto</span> Cleanup;
02805 
02806     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02807 
02808         <span class="comment">//</span>
02809         <span class="comment">// Call was successful so we must have been able to reference the</span>
02810         <span class="comment">// driver object.</span>
02811         <span class="comment">//</span>
02812 
02813         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[DeviceService] != NULL);
02814 
02815         <span class="keywordflow">if</span> (queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[<a class="code" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a>]-&gt;NextEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02816 
02817             <span class="comment">//</span>
02818             <span class="comment">// There's more than one service assigned to this device.  Configuration</span>
02819             <span class="comment">// error</span>
02820 
02821             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: Configuration Error - more "</span>
02822                         <span class="stringliteral">"than one service in driver list\n"</span>));
02823 
02824             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_REGISTRY);
02825 
02826             status = STATUS_UNSUCCESSFUL;
02827 
02828             <span class="keywordflow">goto</span> Cleanup;
02829         }
02830         <span class="comment">//</span>
02831         <span class="comment">// this is the only case (FDO specified) where we can ignore PDO's characteristics</span>
02832         <span class="comment">//</span>
02833         usePdoCharacteristics = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02834 
02835     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
02836 
02837         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice\t\tError %#08lx reading service "</span>
02838                        <span class="stringliteral">"value for devnode %#08lx\n"</span>, status, DeviceNode));
02839 
02840         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a101">IopDeviceNodeFlagsToCapabilities</a>(DeviceNode)-&gt;RawDeviceOK) {
02841 
02842             <span class="comment">//</span>
02843             <span class="comment">// The device cannot be used raw.  Bail out now.</span>
02844             <span class="comment">//</span>
02845 
02846             status = STATUS_UNSUCCESSFUL;
02847             <span class="keywordflow">goto</span> Cleanup;
02848 
02849         } <span class="keywordflow">else</span> {
02850 
02851             <span class="comment">//</span>
02852             <span class="comment">// Raw device access is okay.</span>
02853             <span class="comment">//</span>
02854 
02855             <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(DeviceNode);
02856 
02857             usePdoCharacteristics = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; <span class="comment">// shouldn't need to do this, but better be safe than sorry</span>
02858             deviceRaw = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02859             status = STATUS_SUCCESS;
02860 
02861         }
02862 
02863     } <span class="keywordflow">else</span> {
02864 
02865         <span class="comment">//</span>
02866         <span class="comment">// something else went wrong while parsing the service key.  The</span>
02867         <span class="comment">// query routine will have set the flags appropriately so we can</span>
02868         <span class="comment">// just bail out.</span>
02869         <span class="comment">//</span>
02870 
02871         <span class="keywordflow">goto</span> Cleanup;
02872 
02873     }
02874 
02875     <span class="comment">//</span>
02876     <span class="comment">// For each type of filter driver we want to build a list of the driver</span>
02877     <span class="comment">// objects to be loaded.  We'll build all the driver lists if we can</span>
02878     <span class="comment">// and deal with error conditions afterwards.</span>
02879     <span class="comment">//</span>
02880 
02881      <span class="comment">//</span>
02882      <span class="comment">// First get all the information we have to out of the instance key and</span>
02883      <span class="comment">// the device node.</span>
02884      <span class="comment">//</span>
02885 
02886      RtlZeroMemory(queryTable, <span class="keyword">sizeof</span>(queryTable));
02887 
02888      queryTable[0].QueryRoutine =
02889          (PRTL_QUERY_REGISTRY_ROUTINE) <a class="code" href="../../d6/d0/pnpenum_8c.html#a21">IopCallDriverAddDeviceQueryRoutine</a>;
02890      queryTable[0].Name = REGSTR_VAL_UPPERFILTERS;
02891      queryTable[0].EntryContext = (PVOID) UIntToPtr(UpperDeviceFilters);
02892      status = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_HANDLE,
02893                                      (PWSTR) instanceKey,
02894                                      queryTable,
02895                                      &amp;queryContext,
02896                                      NULL);
02897 
02898      <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; classKey) {
02899          queryTable[0].QueryRoutine =
02900              (PRTL_QUERY_REGISTRY_ROUTINE) <a class="code" href="../../d6/d0/pnpenum_8c.html#a21">IopCallDriverAddDeviceQueryRoutine</a>;
02901          queryTable[0].Name = REGSTR_VAL_UPPERFILTERS;
02902          queryTable[0].EntryContext = (PVOID) UIntToPtr(UpperClassFilters);
02903 
02904          status = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_HANDLE,
02905                                          (PWSTR) classKey,
02906                                          queryTable,
02907                                          &amp;queryContext,
02908                                          NULL);
02909     }
02910 
02911     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02912 
02913         UCHAR serviceType = 0;
02914         <a class="code" href="../../d6/d0/pnpenum_8c.html#a6">PDRIVER_LIST_ENTRY</a> listEntry = queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[serviceType];
02915 
02916         <span class="comment">//</span>
02917         <span class="comment">// Make sure there's no more than one device service.  Anything else is</span>
02918         <span class="comment">// a configuration error.</span>
02919         <span class="comment">//</span>
02920 
02921         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(DeviceNode-&gt;Flags &amp; DNF_LEGACY_DRIVER));
02922         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(DeviceNode-&gt;Flags &amp; DNF_ADDED));
02923 
02924         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(
02925             <span class="stringliteral">"Error - Device has no service but cannot be run RAW\n"</span>,
02926             ((queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[DeviceService] != NULL) || (deviceRaw)));
02927 
02928 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
02929 <span class="preprocessor"></span>        <span class="comment">//</span>
02930         <span class="comment">// Grab the top of PDO stack</span>
02931         <span class="comment">//</span>
02932         topOfPdoStack = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(DeviceNode-&gt;PhysicalDeviceObject);
02933 <span class="preprocessor">#endif</span>
02934 <span class="preprocessor"></span>
02935         <span class="comment">//</span>
02936         <span class="comment">// It's okay to try adding all the drivers.</span>
02937         <span class="comment">//</span>
02938         <span class="keywordflow">for</span> (serviceType = 0; serviceType &lt; <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a17">MaximumAddStage</a>; serviceType++) {
02939 
02940             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: Adding Services (type %d)\n"</span>,
02941                         serviceType));
02942 
02943             <span class="keywordflow">if</span> (serviceType == <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a>) {
02944 
02945                 <span class="keywordflow">if</span> (deviceRaw&amp;&amp;(queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[serviceType]==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02946 
02947                     <span class="comment">//</span>
02948                     <span class="comment">// Mark the devnode as added, as it has no service.</span>
02949                     <span class="comment">//</span>
02950 
02951                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[serviceType] == NULL);
02952                     DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>;
02953 
02954 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
02955 <span class="preprocessor"></span>                    <span class="comment">//</span>
02956                     <span class="comment">// For the purpose of asserting IRPs, we mark the FDO. We</span>
02957                     <span class="comment">// don't mark a raw PDO as the BOTTOM of the FDO stack as</span>
02958                     <span class="comment">// that would be the lower filter in this case.</span>
02959                     <span class="comment">//</span>
02960                     DeviceNode-&gt;PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags |=
02961                         <a class="code" href="../../d9/d4/trackirp_8h.html#a41">DOE_DESIGNATED_FDO</a> | <a class="code" href="../../d9/d4/trackirp_8h.html#a43">DOE_RAW_FDO</a>;
02962 
02963                 } <span class="keywordflow">else</span> {
02964 
02965                     <span class="comment">//</span>
02966                     <span class="comment">// Since we are going to see a service, grab a pointer to</span>
02967                     <span class="comment">// the current top of the stack. While here, assert there</span>
02968                     <span class="comment">// is exactly one service driver to load...</span>
02969                     <span class="comment">//</span>
02970                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[serviceType]);
02971                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[serviceType]-&gt;NextEntry);
02972                     topOfLowerFilterStack = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(DeviceNode-&gt;PhysicalDeviceObject);
02973 <span class="preprocessor">#endif</span>
02974 <span class="preprocessor"></span>                }
02975             }
02976 
02977             <span class="keywordflow">for</span> (listEntry = queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[serviceType];
02978                 listEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02979                 listEntry = listEntry-&gt;NextEntry) {
02980 
02981                 <a class="code" href="../../d0/d5/io_8h.html#a290">PDRIVER_ADD_DEVICE</a> addDeviceRoutine;
02982 
02983                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\tAdding driver %#08lx\n"</span>,
02984                             listEntry-&gt;DriverObject));
02985 
02986                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(listEntry-&gt;DriverObject);
02987                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(listEntry-&gt;DriverObject-&gt;DriverExtension);
02988                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(listEntry-&gt;DriverObject-&gt;DriverExtension-&gt;AddDevice);
02989 
02990                 <span class="comment">//</span>
02991                 <span class="comment">// Invoke the driver's AddDevice() entry point.</span>
02992                 <span class="comment">//</span>
02993                 addDeviceRoutine =
02994                     listEntry-&gt;DriverObject-&gt;DriverExtension-&gt;AddDevice;
02995 
02996                 status = (addDeviceRoutine)(listEntry-&gt;DriverObject,
02997                                             DeviceNode-&gt;PhysicalDeviceObject);
02998 
02999                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice:\t\tRoutine returned "</span>
03000                             <span class="stringliteral">"%#08lx\n"</span>, status));
03001 
03002                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03003 
03004 <span class="preprocessor">#ifndef NO_SPECIAL_IRP</span>
03005 <span class="preprocessor"></span>                   <span class="keywordflow">if</span> (!deviceObjectHasBeenAttached) {
03006 
03007                        <span class="comment">//</span>
03008                        <span class="comment">// Mark the first driver loaded by this routine as the</span>
03009                        <span class="comment">// bottom of the FDO stack. These must detach on a remove.</span>
03010                        <span class="comment">// Note we can't simply flag the top of the stack, as</span>
03011                        <span class="comment">// someone might attach in AddDevice...</span>
03012                        <span class="comment">//</span>
03013                        fdoDeviceObject = topOfPdoStack-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
03014                        <span class="keywordflow">if</span> (fdoDeviceObject) {
03015 
03016                           fdoDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a42">DOE_BOTTOM_OF_FDO_STACK</a>;
03017                           deviceObjectHasBeenAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03018                        }
03019                    }
03020 
03021                    <span class="comment">//</span>
03022                    <span class="comment">// Also note it is legal for a filter to succeed AddDevice</span>
03023                    <span class="comment">// but fail to attach anything to the top of the stack.</span>
03024                    <span class="comment">//</span>
03025                    <span class="keywordflow">if</span> (serviceType == <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a>) {
03026 
03027                        <span class="comment">//</span>
03028                        <span class="comment">// ADRIAO BUGBUG 10/07/98 - Since we are temporarily</span>
03029                        <span class="comment">// letting successful but Noop'd AddDevice's through,</span>
03030                        <span class="comment">// mark the stack appropriately. We will make it look</span>
03031                        <span class="comment">// like a RAW FDO</span>
03032                        <span class="comment">//</span>
03033                        fdoDeviceObject = topOfLowerFilterStack-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
03034 
03035                        <span class="comment">//ASSERT(fdoDeviceObject != NULL);</span>
03036 
03037                        <span class="keywordflow">if</span> (!fdoDeviceObject) {
03038 
03039                            <span class="comment">//</span>
03040                            <span class="comment">// Nope, didn't get an FDO. Mark the PDO raw.</span>
03041                            <span class="comment">// ADRIAO BUGBUG 10/07/98 -</span>
03042                            <span class="comment">//      Another reason to complain about the legality</span>
03043                            <span class="comment">// of succeeding a FDO AddDevice without attaching</span>
03044                            <span class="comment">// anything - how does the PDO know he also has to</span>
03045                            <span class="comment">// respond as an FDO????</span>
03046                            <span class="comment">//</span>
03047                            fdoDeviceObject = DeviceNode-&gt;PhysicalDeviceObject;
03048                            fdoDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a43">DOE_RAW_FDO</a>;
03049                        }
03050 
03051                        <span class="comment">//</span>
03052                        <span class="comment">// Mark appropriate node "FDO".</span>
03053                        <span class="comment">//</span>
03054                        fdoDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a41">DOE_DESIGNATED_FDO</a>;
03055                    }
03056 <span class="preprocessor">#endif</span>
03057 <span class="preprocessor"></span>
03058                    DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>;
03059                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (serviceType == <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a14">DeviceService</a>) {
03060 
03061                     <span class="comment">//</span>
03062                     <span class="comment">// If filter drivers return failure, keep going.</span>
03063                     <span class="comment">//</span>
03064 
03065                     DeviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>;
03066                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_FAILED_ADD);
03067                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(DeviceNode-&gt;PhysicalDeviceObject, CM_PROB_FAILED_ADD);
03068                     <span class="keywordflow">goto</span> Cleanup;
03069                 }
03070 
03071                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(DeviceNode-&gt;PhysicalDeviceObject)-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a128">DO_DEVICE_INITIALIZING</a>) {
03072                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"***************** DO_DEVICE_INITIALIZING not cleared on %#08lx\n"</span>,
03073                                 <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(DeviceNode-&gt;PhysicalDeviceObject)));
03074                 }
03075 
03076                 <a class="code" href="../../d6/d0/pnpenum_8c.html#a0">ASSERT_INITED</a>(<a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(DeviceNode-&gt;PhysicalDeviceObject));
03077             }
03078         }
03079 
03080         <span class="comment">//</span>
03081         <span class="comment">// change PDO and all attached objects</span>
03082         <span class="comment">// to have properties specified in the registry</span>
03083         <span class="comment">//</span>
03084 
03085         <a class="code" href="../../d6/d0/pnpenum_8c.html#a31">IopChangeDeviceObjectFromRegistryProperties</a>(DeviceNode-&gt;PhysicalDeviceObject, classPropsKey, instanceKey, usePdoCharacteristics);
03086 
03087         <span class="comment">//</span>
03088         <span class="comment">// CapabilityFlags are refreshed with call to IopDeviceCapabilitiesToRegistry after device is started</span>
03089         <span class="comment">//</span>
03090 
03091     } <span class="keywordflow">else</span> {
03092 
03093         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: Error %#08lx while building "</span>
03094                     <span class="stringliteral">"driver load list\n"</span>, status));
03095     }
03096 
03097     deviceObject = DeviceNode-&gt;PhysicalDeviceObject;
03098 
03099     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a30">IopQueryLegacyBusInformation</a>(
03100                  deviceObject,
03101                  NULL,
03102                  &amp;DeviceNode-&gt;InterfaceType,
03103                  &amp;DeviceNode-&gt;BusNumber
03104              );
03105 
03106     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03107 
03108         DeviceNode-&gt;InterfaceType = InterfaceTypeUndefined;
03109         DeviceNode-&gt;BusNumber = 0xfffffff0;
03110 
03111     }
03112 
03113     status = STATUS_SUCCESS;
03114 
03115 Cleanup:
03116     {
03117 
03118         UCHAR i;
03119 
03120         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: DevNode flags leaving = %#08lx\n"</span>,
03121                     DeviceNode-&gt;Flags));
03122 
03123         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: Cleaning up\n"</span>));
03124 
03125         <span class="comment">//</span>
03126         <span class="comment">// Free the entries in the driver load list &amp; release the references on</span>
03127         <span class="comment">// their driver objects.</span>
03128         <span class="comment">//</span>
03129 
03130         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d6/d0/pnpenum_8c.html#a41a17">MaximumAddStage</a>; i++) {
03131 
03132             <a class="code" href="../../d6/d0/pnpenum_8c.html#a6">PDRIVER_LIST_ENTRY</a> listHead = queryContext.<a class="code" href="../../d4/d6/structQUERY__CONTEXT.html#o3">DriverLists</a>[i];
03133 
03134             <span class="keywordflow">while</span>(listHead != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03135 
03136                 <a class="code" href="../../d6/d0/pnpenum_8c.html#a6">PDRIVER_LIST_ENTRY</a> tmp = listHead;
03137 
03138                 listHead = listHead-&gt;<a class="code" href="../../d3/d9/struct__DRIVER__LIST__ENTRY.html#o1">NextEntry</a>;
03139 
03140                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(tmp-&gt;DriverObject != NULL);
03141 
03142                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(tmp-&gt;DriverObject);
03143 
03144                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(tmp);
03145             }
03146         }
03147     }
03148 
03149     ZwClose(instanceKey);
03150 
03151     <span class="keywordflow">if</span> (classKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03152         ZwClose(classKey);
03153     }
03154 
03155     <span class="keywordflow">if</span> (classPropsKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03156         ZwClose(classPropsKey);
03157     }
03158 
03159     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1, (<span class="stringliteral">"IopCallDriverAddDevice: Returning status %#08lx\n"</span>, status));
03160 
03161     <span class="keywordflow">return</span> status;
03162 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a316" doxytag="pnpiop.h::IopChainDereferenceComplete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopChainDereferenceComplete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PhysicalDeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00084">84</a> of file <a class="el" href="../../d4/d9/pnpdel_8c-source.html">pnpdel.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01293">IopAcquireDeviceTreeLock</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00187">IopDelayedRemoveWorker()</a>, <a class="el" href="../../d7/d1/pnprlist_8h.html#a11">IopGetRelationsCount()</a>, <a class="el" href="../../d7/d1/pnprlist_8h.html#a12">IopGetRelationsTaggedCount()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00188">IopPendingSurpriseRemovals</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01294">IopReleaseDeviceTreeLock</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l01232">IopSetRelationsTag()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d1/pnprlist_8h.html#a4">PENDING_RELATIONS_LIST_ENTRY</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00089">_PENDING_RELATIONS_LIST_ENTRY::RelationsList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00086">_PENDING_RELATIONS_LIST_ENTRY::WorkItem</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">IopCompleteUnloadOrDelete()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l04947">IopNotifyPnpWhenChainDereferenced()</a>.
<p>
<pre class="fragment"><div>00090                    :
00091 
00092     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count on a PDO and all its
00093     attached devices transitions to a zero.  It tags <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devnode as ready <span class="keywordflow">for</span>
00094     removal.  If all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devnodes are tagged then <a class="code" href="../../d3/d0/pnpdel_8c.html#a2">IopDelayedRemoveWorker</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00095     called to actually send <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remove IRPs.
00096 
00097 Arguments:
00098 
00099     PhysicalDeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO whose references just
00100         went to zero.
00101 
00102 Return Value:
00103 
00104     None.
00105 
00106 --*/
00107 
00108 {
00109     <a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a>   entry;
00110     PLIST_ENTRY                     link;
00111     ULONG                           count;
00112     ULONG                           taggedCount;
00113     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
00114 
00115     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00116 
00117     <span class="comment">//</span>
00118     <span class="comment">// Lock the whole device node tree so no one can touch the tree.</span>
00119     <span class="comment">//</span>
00120 
00121     <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
00122 
00123     <span class="comment">//</span>
00124     <span class="comment">// Find the relation list this devnode is a member of.</span>
00125     <span class="comment">//</span>
00126     <span class="keywordflow">for</span> (link = <a class="code" href="../../d1/d0/pnpdata_8c.html#a27">IopPendingSurpriseRemovals</a>.Flink;
00127          link != &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a27">IopPendingSurpriseRemovals</a>;
00128          link = link-&gt;Flink) {
00129 
00130         entry = CONTAINING_RECORD(link, <a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PENDING_RELATIONS_LIST_ENTRY</a>, Link);
00131 
00132         <span class="comment">//</span>
00133         <span class="comment">// Tag the devnode as ready for remove.  If it isn't in this list</span>
00134         <span class="comment">//</span>
00135         status = <a class="code" href="../../d7/d1/pnprlist_8h.html#a18">IopSetRelationsTag</a>( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a>, PhysicalDeviceObject, TRUE );
00136 
00137         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00138             taggedCount = <a class="code" href="../../d7/d1/pnprlist_8h.html#a12">IopGetRelationsTaggedCount</a>( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a> );
00139             count = <a class="code" href="../../d7/d1/pnprlist_8h.html#a11">IopGetRelationsCount</a>( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a> );
00140 
00141             <span class="keywordflow">if</span> (taggedCount == count) {
00142                 <span class="comment">//</span>
00143                 <span class="comment">// Remove relations list from list of pending surprise removals.</span>
00144                 <span class="comment">//</span>
00145                 RemoveEntryList( link );
00146 
00147                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00148 
00149                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>) {
00150 
00151                     <span class="comment">//</span>
00152                     <span class="comment">// Queue a work item to do the removal so we call the driver</span>
00153                     <span class="comment">// in the system process context rather than the random one</span>
00154                     <span class="comment">// we're in now.</span>
00155                     <span class="comment">//</span>
00156 
00157                     <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o1">WorkItem</a>,
00158                                         IopDelayedRemoveWorker,
00159                                         entry);
00160 
00161                     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(&amp;entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o1">WorkItem</a>, DelayedWorkQueue);
00162 
00163                 } <span class="keywordflow">else</span> {
00164 
00165                     <span class="comment">//</span>
00166                     <span class="comment">// We are already in the system process, so call the</span>
00167                     <span class="comment">// worker inline.</span>
00168                     <span class="comment">//</span>
00169 
00170                     <a class="code" href="../../d3/d0/pnpdel_8c.html#a2">IopDelayedRemoveWorker</a>( entry );
00171 
00172                 }
00173 
00174                 <span class="keywordflow">return</span>;
00175             }
00176 
00177             <span class="keywordflow">break</span>;
00178         }
00179     }
00180 
00181     <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00182 
00183     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(link != &amp;IopPendingSurpriseRemovals);
00184 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a271" doxytag="pnpiop.h::IopCleanupDeviceRegistryValues" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCleanupDeviceRegistryValues           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>InstancePath</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>KeepReference</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03960">3960</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">IopDeleteLegacyKey()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01572">IopUnlockDeviceRemovalRelations()</a>.
<p>
<pre class="fragment"><div>03967                    :
03968 
03969     This routine cleans up a device instance key when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no
03970     longer present/enumerated.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> registered to a Service
03971     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Service's <span class="keyword">enum</span> key will also been cleaned up.
03972 
03973     Note <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller must lock <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryDeciceResource
03974 
03975 Arguments:
03976 
03977     InstancePath - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance key.
03978 
03979     KeepReference - supplies a <span class="keywordtype">boolean</span> value to indicate <span class="keywordflow">if</span> we should remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03980         device instance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to device object mapping.
03981 
03982 Return Value:
03983 
03984     status
03985 
03986 --*/
03987 
03988 {
03989     HANDLE handle, instanceHandle;
03990     UNICODE_STRING unicodeValueName;
03991     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03992     ULONG count = 0;
03993     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03994 
03995     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03996 
03997     <span class="comment">//</span>
03998     <span class="comment">// Open System\CurrentControlSet\Enum</span>
03999     <span class="comment">//</span>
04000 
04001     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04002                                    NULL,
04003                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
04004                                    KEY_ALL_ACCESS
04005                                    );
04006 
04007     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04008         <span class="keywordflow">return</span> status;
04009     }
04010 
04011     <span class="comment">//</span>
04012     <span class="comment">// Open the device instance key</span>
04013     <span class="comment">//</span>
04014 
04015     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;instanceHandle,
04016                                    handle,
04017                                    InstancePath,
04018                                    KEY_ALL_ACCESS
04019                                    );
04020 
04021     ZwClose(handle);
04022     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04023 
04024         <span class="comment">//</span>
04025         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
04026         <span class="comment">//</span>
04027 
04028         <span class="keywordflow">return</span> status;
04029     }
04030 
04031     <span class="comment">//</span>
04032     <span class="comment">// Delete the DeviceReference value name under Control key</span>
04033     <span class="comment">//</span>
04034 
04035     <span class="keywordflow">if</span> (!KeepReference) {
04036 
04037         <span class="comment">//</span>
04038         <span class="comment">// BUGBUG (lonnym)--verify that removal of the following code fragment is valid.</span>
04039         <span class="comment">//</span>
04040 <span class="preprocessor">#if 0</span>
04041 <span class="preprocessor"></span>        <span class="comment">//</span>
04042         <span class="comment">// Set the 'FoundAtEnum' value to false.</span>
04043         <span class="comment">//</span>
04044 
04045         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_FOUNDATENUM);
04046         tmpValue = 0;
04047         ZwSetValueKey(instanceHandle,
04048                       &amp;unicodeValueName,
04049                       TITLE_INDEX_VALUE,
04050                       REG_DWORD,
04051                       &amp;tmpValue,
04052                       <span class="keyword">sizeof</span>(tmpValue)
04053                       );
04054 <span class="preprocessor">#endif // (lonnym, verify removal to here)</span>
04055 <span class="preprocessor"></span>
04056         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
04057         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04058                                        instanceHandle,
04059                                        &amp;unicodeValueName,
04060                                        KEY_ALL_ACCESS
04061                                        );
04062         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04063             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DEVICE_REFERENCE);
04064             ZwDeleteValueKey(handle, &amp;unicodeValueName);
04065             ZwClose(handle);
04066         }
04067 
04068         <span class="comment">//</span>
04069         <span class="comment">// Deregister the device from its controlling service's service enum key</span>
04070         <span class="comment">//</span>
04071 
04072         status = PiDeviceRegistration( InstancePath, FALSE, NULL );
04073     }
04074 
04075     ZwClose(instanceHandle);
04076 
04077     <span class="keywordflow">return</span> status;
04078 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a295" doxytag="pnpiop.h::IopCmResourcesToIoResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PIO_RESOURCE_REQUIREMENTS_LIST IopCmResourcesToIoResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SlotNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>CmResourceList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Priority</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04392">4392</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00803">CmResourceTypeReserved</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04592">IopFilterResourceRequirementsList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00469">IoReportResourceUsageInternal()</a>, and <a class="el" href="../../d3/d4/mapper_8c-source.html#l01091">MapperMarkKey()</a>.
<p>
<pre class="fragment"><div>04400                    :
04401 
04402     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> converts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input CmResourceList to IO_RESOURCE_REQUIREMENTS_LIST.
04403 
04404 Arguments:
04405 
04406     SlotNumber - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SlotNumber <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources refer to.
04407 
04408     CmResourceList - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cm resource list to convert.
04409 
04410     Priority - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logconfig
04411 
04412 Return Value:
04413 
04414     returns a IO_RESOURCE_REQUIREMENTS_LISTST <span class="keywordflow">if</span> succeeds.  Otherwise a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04415     returned.
04416 
04417 --*/
04418 {
04419     PIO_RESOURCE_REQUIREMENTS_LIST ioResReqList;
04420     ULONG count = 0, size, i, j;
04421     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04422     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
04423     PIO_RESOURCE_DESCRIPTOR ioDesc;
04424 
04425     <span class="comment">//</span>
04426     <span class="comment">// First determine number of descriptors required.</span>
04427     <span class="comment">//</span>
04428 
04429     cmFullDesc = &amp;CmResourceList-&gt;List[0];
04430     <span class="keywordflow">for</span> (i = 0; i &lt; CmResourceList-&gt;Count; i++) {
04431         count += cmFullDesc-&gt;PartialResourceList.Count;
04432         cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04433         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04434             size = 0;
04435             <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04436             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04437                  size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04438                  count--;
04439                  <span class="keywordflow">break</span>;
04440             }
04441             cmPartDesc++;
04442             cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04443         }
04444         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04445     }
04446 
04447     <span class="keywordflow">if</span> (count == 0) {
04448         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04449     }
04450 
04451     <span class="comment">//</span>
04452     <span class="comment">// Count the extra descriptors for InterfaceType and BusNumber information.</span>
04453     <span class="comment">//</span>
04454 
04455     count += CmResourceList-&gt;Count - 1;
04456 
04457     <span class="comment">//</span>
04458     <span class="comment">// Allocate heap space for IO RESOURCE REQUIREMENTS LIST</span>
04459     <span class="comment">//</span>
04460 
04461     count++;           <span class="comment">// add one for CmResourceTypeConfigData</span>
04462     ioResReqList = (PIO_RESOURCE_REQUIREMENTS_LIST)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
04463                        PagedPool,
04464                        <span class="keyword">sizeof</span>(IO_RESOURCE_REQUIREMENTS_LIST) +
04465                            count * <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR)
04466                        );
04467     <span class="keywordflow">if</span> (!ioResReqList) {
04468         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04469     }
04470 
04471     <span class="comment">//</span>
04472     <span class="comment">// Parse the cm resource descriptor and build its corresponding IO resource descriptor</span>
04473     <span class="comment">//</span>
04474 
04475     ioResReqList-&gt;InterfaceType = CmResourceList-&gt;List[0].InterfaceType;
04476     ioResReqList-&gt;BusNumber = CmResourceList-&gt;List[0].BusNumber;
04477     ioResReqList-&gt;SlotNumber = SlotNumber;
04478     ioResReqList-&gt;Reserved[0] = 0;
04479     ioResReqList-&gt;Reserved[1] = 0;
04480     ioResReqList-&gt;Reserved[2] = 0;
04481     ioResReqList-&gt;AlternativeLists = 1;
04482     ioResReqList-&gt;List[0].Version = 1;
04483     ioResReqList-&gt;List[0].Revision = 1;
04484     ioResReqList-&gt;List[0].Count = count;
04485 
04486     <span class="comment">//</span>
04487     <span class="comment">// Generate a CmResourceTypeConfigData descriptor</span>
04488     <span class="comment">//</span>
04489 
04490     ioDesc = &amp;ioResReqList-&gt;List[0].Descriptors[0];
04491     ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04492     ioDesc-&gt;Type = CmResourceTypeConfigData;
04493     ioDesc-&gt;ShareDisposition = CmResourceShareShared;
04494     ioDesc-&gt;Flags = 0;
04495     ioDesc-&gt;Spare1 = 0;
04496     ioDesc-&gt;Spare2 = 0;
04497     ioDesc-&gt;u.ConfigData.Priority = Priority;
04498     ioDesc++;
04499 
04500     cmFullDesc = &amp;CmResourceList-&gt;List[0];
04501     <span class="keywordflow">for</span> (i = 0; i &lt; CmResourceList-&gt;Count; i++) {
04502         <span class="keywordflow">if</span> (i != 0) {
04503 
04504             <span class="comment">//</span>
04505             <span class="comment">// Set up descriptor to remember the InterfaceType and BusNumber.</span>
04506             <span class="comment">//</span>
04507 
04508             ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04509             ioDesc-&gt;Type = <a class="code" href="../../d9/d0/pnpiop_8h.html#a74">CmResourceTypeReserved</a>;
04510             ioDesc-&gt;ShareDisposition = CmResourceShareUndetermined;
04511             ioDesc-&gt;Flags = 0;
04512             ioDesc-&gt;Spare1 = 0;
04513             ioDesc-&gt;Spare2 = 0;
04514             <span class="keywordflow">if</span> (cmFullDesc-&gt;InterfaceType == InterfaceTypeUndefined) {
04515                 ioDesc-&gt;u.DevicePrivate.Data[0] = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04516             } <span class="keywordflow">else</span> {
04517                 ioDesc-&gt;u.DevicePrivate.Data[0] = cmFullDesc-&gt;InterfaceType;
04518             }
04519             ioDesc-&gt;u.DevicePrivate.Data[1] = cmFullDesc-&gt;BusNumber;
04520             ioDesc-&gt;u.DevicePrivate.Data[2] = 0;
04521             ioDesc++;
04522         }
04523         cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04524         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04525             ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04526             ioDesc-&gt;Type = cmPartDesc-&gt;Type;
04527             ioDesc-&gt;ShareDisposition = cmPartDesc-&gt;ShareDisposition;
04528             ioDesc-&gt;Flags = cmPartDesc-&gt;Flags;
04529             ioDesc-&gt;Spare1 = 0;
04530             ioDesc-&gt;Spare2 = 0;
04531 
04532             size = 0;
04533             <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04534             <span class="keywordflow">case</span> CmResourceTypePort:
04535                  ioDesc-&gt;u.Port.MinimumAddress = cmPartDesc-&gt;u.Port.Start;
04536                  ioDesc-&gt;u.Port.MaximumAddress.QuadPart = cmPartDesc-&gt;u.Port.Start.QuadPart +
04537                                                              cmPartDesc-&gt;u.Port.Length - 1;
04538                  ioDesc-&gt;u.Port.Alignment = 1;
04539                  ioDesc-&gt;u.Port.Length = cmPartDesc-&gt;u.Port.Length;
04540                  ioDesc++;
04541                  <span class="keywordflow">break</span>;
04542             <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04543 <span class="preprocessor">#if defined(_X86_)</span>
04544 <span class="preprocessor"></span>                ioDesc-&gt;u.Interrupt.MinimumVector = ioDesc-&gt;u.Interrupt.MaximumVector =
04545                    cmPartDesc-&gt;u.Interrupt.Level;
04546 <span class="preprocessor">#else</span>
04547 <span class="preprocessor"></span>                 ioDesc-&gt;u.Interrupt.MinimumVector = ioDesc-&gt;u.Interrupt.MaximumVector =
04548                     cmPartDesc-&gt;u.Interrupt.Vector;
04549 <span class="preprocessor">#endif</span>
04550 <span class="preprocessor"></span>                 ioDesc++;
04551                  <span class="keywordflow">break</span>;
04552             <span class="keywordflow">case</span> CmResourceTypeMemory:
04553                  ioDesc-&gt;u.Memory.MinimumAddress = cmPartDesc-&gt;u.Memory.Start;
04554                  ioDesc-&gt;u.Memory.MaximumAddress.QuadPart = cmPartDesc-&gt;u.Memory.Start.QuadPart +
04555                                                                cmPartDesc-&gt;u.Memory.Length - 1;
04556                  ioDesc-&gt;u.Memory.Alignment = 1;
04557                  ioDesc-&gt;u.Memory.Length = cmPartDesc-&gt;u.Memory.Length;
04558                  ioDesc++;
04559                  <span class="keywordflow">break</span>;
04560             <span class="keywordflow">case</span> CmResourceTypeDma:
04561                  ioDesc-&gt;u.Dma.MinimumChannel = cmPartDesc-&gt;u.Dma.Channel;
04562                  ioDesc-&gt;u.Dma.MaximumChannel = cmPartDesc-&gt;u.Dma.Channel;
04563                  ioDesc++;
04564                  <span class="keywordflow">break</span>;
04565             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04566                  size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04567                  <span class="keywordflow">break</span>;
04568             <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04569                  ioDesc-&gt;u.BusNumber.MinBusNumber = cmPartDesc-&gt;u.BusNumber.Start;
04570                  ioDesc-&gt;u.BusNumber.MaxBusNumber = cmPartDesc-&gt;u.BusNumber.Start +
04571                                                     cmPartDesc-&gt;u.BusNumber.Length - 1;
04572                  ioDesc-&gt;u.BusNumber.Length = cmPartDesc-&gt;u.BusNumber.Length;
04573                  ioDesc++;
04574                  <span class="keywordflow">break</span>;
04575             <span class="keywordflow">default</span>:
04576                  ioDesc-&gt;u.DevicePrivate.Data[0] = cmPartDesc-&gt;u.DevicePrivate.Data[0];
04577                  ioDesc-&gt;u.DevicePrivate.Data[1] = cmPartDesc-&gt;u.DevicePrivate.Data[1];
04578                  ioDesc-&gt;u.DevicePrivate.Data[2] = cmPartDesc-&gt;u.DevicePrivate.Data[2];
04579                  ioDesc++;
04580                  <span class="keywordflow">break</span>;
04581             }
04582             cmPartDesc++;
04583             cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04584         }
04585         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04586     }
04587     ioResReqList-&gt;ListSize = (ULONG)((ULONG_PTR)ioDesc - (ULONG_PTR)ioResReqList);
04588     <span class="keywordflow">return</span> ioResReqList;
04589 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a232" doxytag="pnpiop.h::IopConcatenateUnicodeStrings" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopConcatenateUnicodeStrings           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Destination</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>String1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING <a class="el" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00695">695</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d9/tcmpmem_8c-source.html#l00037">String1</a>, <a class="el" href="../../d0/d9/tcmpmem_8c-source.html#l00038">String2</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">IopCreateMadeupNode()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00931">IopServiceInstanceToDeviceInstance()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>00703                    :
00704 
00705     This routine returns a buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> concatenation of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00706     two specified strings.  Since <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> optional, <span class="keyword">this</span> function may
00707     also be used to make a copy of a unicode string.  Paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> space
00708     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination string.  Caller must release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00709     space once done with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00710 
00711 Parameters:
00712 
00713     Destination - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00714         newly created key.
00715 
00716     <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> frist UNICODE_STRING.
00717 
00718     <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a> - Supplies an optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second UNICODE_STRING.
00719 
00720 Return Value:
00721 
00722     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
00723 
00724 --*/
00725 
00726 {
00727     ULONG length;
00728     PWSTR buffer;
00729 
00730     length = <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00731     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(String2)) {
00732         length += <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Length;
00733     }
00734     buffer = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, length);
00735     <span class="keywordflow">if</span> (!buffer) {
00736         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00737     }
00738     Destination-&gt;Buffer = buffer;
00739     Destination-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length - <span class="keyword">sizeof</span>(UNICODE_NULL);
00740     Destination-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00741     RtlMoveMemory (Destination-&gt;Buffer, <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Buffer, <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length);
00742     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(String2)) {
00743         RtlMoveMemory((PUCHAR)Destination-&gt;Buffer + <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length,
00744                       <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Buffer,
00745                       <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Length
00746                      );
00747     }
00748     buffer[length / <span class="keyword">sizeof</span>(WCHAR) - 1] = UNICODE_NULL;
00749     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00750 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a236" doxytag="pnpiop.h::IopCreateMadeupNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCreateMadeupNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>InstanceOrdinal</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceOwned</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">91</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00177">CmRegistryMachineSystemCurrentControlSetEnumRootName</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00695">IopConcatenateUnicodeStrings()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01140">IopOpenRegistryKeyPersist()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration()</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00086">ReturnedHandle</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01038">RtlUpcaseUnicodeString()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>.
<p>
<pre class="fragment"><div>00101                    :
00102 
00103     This routine creates a <span class="keyword">new</span> instance node under System\Enum\Root\*Madeup&lt;Name&gt;
00104     key and all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> required <span class="keywordflow">default</span> value entries.  Also a value entry under
00105     Service\ServiceKeyName\Enum <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created madeup
00106     entry.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keyname of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> key are returned to caller.
00107     Caller must free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unicode string when he <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00108 
00109 Parameters:
00110 
00111     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00112         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
00113         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryPath parameter
00114         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> routine.
00115 
00116     <a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a> - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00117         newly created key.
00118 
00119     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created
00120         key.
00121 
00122     InstanceNumber - supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> InstanceNumber value
00123         entry created under service\name\<span class="keyword">enum</span> subkey.
00124 
00125     ResourceOwned - supplies a BOOLEAN variable to indicate <span class="keywordflow">if</span> caller owns
00126         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry resource exclusively.
00127 
00128 Return Value:
00129 
00130     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
00131 
00132 --*/
00133 
00134 {
00135     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00136     UNICODE_STRING tmpKeyName, unicodeInstanceName, unicodeString;
00137     UNICODE_STRING rootKeyName, unicodeValueName, unicodeKeyName;
00138     HANDLE handle, enumRootHandle, hTreeHandle;
00139     ULONG instance;
00140     UCHAR unicodeBuffer[20];
00141     ULONG tmpValue, disposition = 0;
00142     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00143     PWSTR p;
00144     BOOLEAN releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00145     BOOLEAN successful;
00146 
00147     <span class="keywordflow">if</span> (!ResourceOwned) {
00148         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00149         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
00150         releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00151     }
00152 
00153     <span class="comment">//</span>
00154     <span class="comment">// Open LocalMachine\System\CurrentControlSet\Enum\Root</span>
00155     <span class="comment">//</span>
00156 
00157     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumRootHandle,
00158                                    NULL,
00159                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumRootName,
00160                                    KEY_ALL_ACCESS
00161                                    );
00162 
00163     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00164         <span class="keywordflow">goto</span> local_exit0;
00165     }
00166 
00167     <span class="comment">//</span>
00168     <span class="comment">// Open, and create if not already exist, System\Enum\Root\LEGACY_&lt;ServiceName&gt;</span>
00169     <span class="comment">// First, try to find the ServiceName by extracting it from user supplied</span>
00170     <span class="comment">// ServiceKeyName.</span>
00171     <span class="comment">//</span>
00172 
00173     PiWstrToUnicodeString(&amp;tmpKeyName, REGSTR_KEY_MADEUP);
00174     successful = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>( &amp;unicodeKeyName,
00175                                                &amp;tmpKeyName,
00176                                                ServiceKeyName);
00177 
00178     <span class="keywordflow">if</span> (!successful) {
00179         ZwClose(enumRootHandle);
00180         status = STATUS_INSUFFICIENT_RESOURCES;
00181         <span class="keywordflow">goto</span> local_exit0;
00182     }
00183 
00184     <a class="code" href="../../d6/d6/nls_8c.html#a31">RtlUpcaseUnicodeString</a>(&amp;unicodeKeyName, &amp;unicodeKeyName, FALSE);
00185     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a376">IopFixupDeviceId</a>(unicodeKeyName.Buffer)) {
00186         status = STATUS_INVALID_PARAMETER;
00187         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00188         <span class="keywordflow">goto</span> local_exit0;
00189     }
00190 
00191     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
00192                                      enumRootHandle,
00193                                      &amp;unicodeKeyName,
00194                                      KEY_ALL_ACCESS,
00195                                      REG_OPTION_NON_VOLATILE,
00196                                      NULL
00197                                      );
00198     ZwClose(enumRootHandle);
00199     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00200         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00201         <span class="keywordflow">goto</span> local_exit0;
00202     }
00203 
00204     instance = 1;
00205 
00206     PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_NEXT_INSTANCE);
00207     status = ZwSetValueKey(
00208                 handle,
00209                 &amp;unicodeValueName,
00210                 TITLE_INDEX_VALUE,
00211                 REG_DWORD,
00212                 &amp;instance,
00213                 <span class="keyword">sizeof</span>(instance)
00214                 );
00215 
00216     instance--;
00217     *InstanceNumber = instance;
00218     PiUlongToInstanceKeyUnicodeString(&amp;unicodeInstanceName,
00219                                       unicodeBuffer + <span class="keyword">sizeof</span>(WCHAR), <span class="comment">// reserve first WCHAR space</span>
00220                                       20 - <span class="keyword">sizeof</span>(WCHAR),
00221                                       instance
00222                                       );
00223     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( ReturnedHandle,
00224                                      handle,
00225                                      &amp;unicodeInstanceName,
00226                                      KEY_ALL_ACCESS,
00227                                      REG_OPTION_NON_VOLATILE,
00228                                      &amp;disposition
00229                                      );
00230     ZwClose(handle);
00231     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00232         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00233         <span class="keywordflow">goto</span> local_exit0;
00234     }
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">// Prepare newly created registry key name for returning to caller</span>
00238     <span class="comment">//</span>
00239 
00240     *(PWSTR)unicodeBuffer = OBJ_NAME_PATH_SEPARATOR;
00241     unicodeInstanceName.Buffer = (PWSTR)unicodeBuffer;
00242     unicodeInstanceName.Length += <span class="keyword">sizeof</span>(WCHAR);
00243     unicodeInstanceName.MaximumLength += <span class="keyword">sizeof</span>(WCHAR);
00244     PiWstrToUnicodeString(&amp;rootKeyName, REGSTR_KEY_ROOTENUM);
00245     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;tmpKeyName, L<span class="stringliteral">"\\"</span>);
00246     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;unicodeString, &amp;tmpKeyName, &amp;unicodeKeyName);
00247     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00248     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;tmpKeyName, &amp;rootKeyName, &amp;unicodeString);
00249     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeString);
00250     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(KeyName, &amp;tmpKeyName, &amp;unicodeInstanceName);
00251 
00252     <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {
00253 
00254         <span class="comment">//</span>
00255         <span class="comment">// Create all the default value entry for the newly created key.</span>
00256         <span class="comment">// Service = ServiceKeyName</span>
00257         <span class="comment">// FoundAtEnum = 1</span>
00258         <span class="comment">// Class = "LegacyDriver"</span>
00259         <span class="comment">// ClassGUID = GUID for legacy driver class</span>
00260         <span class="comment">// ConfigFlags = 0</span>
00261         <span class="comment">//</span>
00262         <span class="comment">// Create "Control" subkey with "NewlyCreated" value key</span>
00263         <span class="comment">//</span>
00264 
00265         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
00266         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
00267                                          *ReturnedHandle,
00268                                          &amp;unicodeValueName,
00269                                          KEY_ALL_ACCESS,
00270                                          REG_OPTION_VOLATILE,
00271                                          NULL
00272                                          );
00273         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00274             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_NEWLY_CREATED);
00275             tmpValue = 0;
00276             ZwSetValueKey(handle,
00277                           &amp;unicodeValueName,
00278                           TITLE_INDEX_VALUE,
00279                           REG_DWORD,
00280                           &amp;tmpValue,
00281                           <span class="keyword">sizeof</span>(tmpValue)
00282                           );
00283             ZwClose(handle);
00284         }
00285 
00286         handle = *<a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>;
00287 
00288         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_SERVICE);
00289         p = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
00290                                   ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
00291         <span class="keywordflow">if</span>(p) {
00292             RtlMoveMemory(p, ServiceKeyName-&gt;Buffer, ServiceKeyName-&gt;Length);
00293             p[ServiceKeyName-&gt;Length / <span class="keyword">sizeof</span> (WCHAR)] = UNICODE_NULL;
00294             ZwSetValueKey(
00295                         handle,
00296                         &amp;unicodeValueName,
00297                         TITLE_INDEX_VALUE,
00298                         REG_SZ,
00299                         p,
00300                         ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
00301                         );
00302             <span class="comment">//</span>
00303             <span class="comment">// We'll keep the null-terminated service name buffer around for a while,</span>
00304             <span class="comment">// because we may need it later on for the DeviceDesc in case the service</span>
00305             <span class="comment">// has no DisplayName.</span>
00306             <span class="comment">//</span>
00307             <span class="comment">// ExFreePool(p);</span>
00308         }
00309 
00310         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_LEGACY);
00311         tmpValue = 1;
00312         ZwSetValueKey(
00313                     handle,
00314                     &amp;unicodeValueName,
00315                     TITLE_INDEX_VALUE,
00316                     REG_DWORD,
00317                     &amp;tmpValue,
00318                     <span class="keyword">sizeof</span>(tmpValue)
00319                     );
00320 
00321         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CONFIG_FLAGS);
00322         tmpValue = 0;
00323         ZwSetValueKey(
00324                     handle,
00325                     &amp;unicodeValueName,
00326                     TITLE_INDEX_VALUE,
00327                     REG_DWORD,
00328                     &amp;tmpValue,
00329                     <span class="keyword">sizeof</span>(tmpValue)
00330                     );
00331 
00332         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CLASS);
00333         ZwSetValueKey(
00334                     handle,
00335                     &amp;unicodeValueName,
00336                     TITLE_INDEX_VALUE,
00337                     REG_SZ,
00338                     REGSTR_VALUE_LEGACY_DRIVER,
00339                     <span class="keyword">sizeof</span>(REGSTR_VALUE_LEGACY_DRIVER)
00340                     );
00341 
00342         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CLASSGUID);
00343         ZwSetValueKey(
00344                     handle,
00345                     &amp;unicodeValueName,
00346                     TITLE_INDEX_VALUE,
00347                     REG_SZ,
00348                     REGSTR_VALUE_LEGACY_DRIVER_CLASS_GUID,
00349                     <span class="keyword">sizeof</span>(REGSTR_VALUE_LEGACY_DRIVER_CLASS_GUID)
00350                     );
00351 
00352 
00353         <span class="comment">//</span>
00354         <span class="comment">// Initialize DeviceDesc= value entry.  If the service key has a "DisplayName"</span>
00355         <span class="comment">// value entry, it is used as the DeviceDesc value.  Otherwise, the service key</span>
00356         <span class="comment">// name is used.</span>
00357         <span class="comment">//</span>
00358 
00359         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
00360                                         KEY_READ,
00361                                         &amp;handle,
00362                                         NULL,
00363                                         FALSE
00364                                         );
00365         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00366 
00367             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00368             unicodeString.Length = 0;
00369             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
00370                                          REGSTR_VALUE_DISPLAY_NAME,
00371                                          &amp;keyValueInformation
00372                                         );
00373             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00374                 <span class="keywordflow">if</span> (keyValueInformation-&gt;Type == REG_SZ) {
00375                     <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength &gt; <span class="keyword">sizeof</span>(UNICODE_NULL)) {
00376                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;unicodeString,
00377                                                        (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00378                                                        keyValueInformation-&gt;DataLength
00379                                                        );
00380                     }
00381                 }
00382             }
00383             <span class="keywordflow">if</span> ((unicodeString.Length == 0) &amp;&amp; p) {
00384 
00385                 <span class="comment">//</span>
00386                 <span class="comment">// No DisplayName--use the service key name.</span>
00387                 <span class="comment">//</span>
00388 
00389                 unicodeString.Length = ServiceKeyName-&gt;Length;
00390                 unicodeString.MaximumLength = ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00391                 unicodeString.Buffer = p;
00392             }
00393 
00394             <span class="keywordflow">if</span>(unicodeString.Length) {
00395                 PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DEVICE_DESC);
00396                 ZwSetValueKey(*ReturnedHandle,
00397                               &amp;unicodeValueName,
00398                               TITLE_INDEX_VALUE,
00399                               REG_SZ,
00400                               unicodeString.Buffer,
00401                               unicodeString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
00402                               );
00403             }
00404             <span class="keywordflow">if</span> (keyValueInformation) {
00405                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00406             }
00407             ZwClose(handle);
00408         }
00409 
00410         <span class="keywordflow">if</span>(p) {
00411             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(p);
00412         }
00413     }
00414 
00415     <span class="comment">//</span>
00416     <span class="comment">// Create new value entry under ServiceKeyName\Enum to reflect the newly</span>
00417     <span class="comment">// added made-up device instance node.</span>
00418     <span class="comment">//</span>
00419 
00420     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
00421     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00422     releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00423 
00424     status = <a class="code" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration</a>( KeyName, TRUE, NULL );
00425 
00426     <span class="keywordflow">if</span> (ResourceOwned) {
00427         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00428         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
00429     }
00430     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;tmpKeyName);
00431     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00432 
00433         <span class="comment">//</span>
00434         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
00435         <span class="comment">//</span>
00436 
00437         ZwClose(*ReturnedHandle);
00438         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(KeyName);
00439     }
00440 local_exit0:
00441     <span class="keywordflow">if</span> (releaseResource) {
00442         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
00443         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00444     }
00445     <span class="keywordflow">return</span> status;
00446 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a234" doxytag="pnpiop.h::IopCreateRegistryKeyEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCreateRegistryKeyEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE BaseHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateOptions</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG Disposition&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">1156</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/mapper_8c-source.html#l01955">ComPortDBAdd()</a>, <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00059">EisaBuildEisaDeviceNode()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03624">IoOpenDeviceInterfaceRegistryKey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00810">IoOpenDeviceRegistryKey()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">IopBuildCmResourceList()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">IopCreateMadeupNode()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02707">IopGetDeviceInterfaces()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00680">IopGetRootDevices()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l02009">IopIsFirmwareDisabled()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01712">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04741">IopOpenOrCreateDeviceInterfaceSubKeys()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01339">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09922">IopProcessSetInterfaceState()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03929">IopRegisterDeviceInterface()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03862">IopStoreSystemPartitionInformation()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01931">IopWriteAllocatedResourcesToRegistry()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l02663">PnPBiosCopyIoDecode()</a>, and <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l02289">PnPBiosWriteInfo()</a>.
<p>
<pre class="fragment"><div>01167                    :
01168 
01169     Opens or creates a registry key <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name
01170     passed in based at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BaseHandle node. This name may specify a key
01171     that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> actually a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>, in which <span class="keywordflow">case</span> each intermediate subkey
01172     will be created (<span class="keywordflow">if</span> Create is TRUE).
01173 
01174     NOTE: Creating a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> (i.e., more than one of the keys in the path
01175     <span class="keywordflow">do</span> not presently exist) requires that a BaseHandle be specified.
01176 
01177 Arguments:
01178 
01179     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle which will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry key that
01180         was opened.
01181 
01182     BaseHandle - Optional handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> from which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key must be opened.
01183         If <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> specifies a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> that must be created, then <span class="keyword">this</span> parameter
01184         must be specified, and <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> must be a relative <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
01185 
01186     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> that must be opened/created (possibly a registry path)
01187 
01188     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller needs to
01189         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
01190 
01191     CreateOptions - Options passed to ZwCreateKey.
01192 
01193     Disposition - If <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <span class="keyword">this</span> optional pointer receives a ULONG indicating
01194         whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key was newly created:
01195 
01196             REG_CREATED_NEW_KEY - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keyword">new</span> Registry <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> was created
01197             REG_OPENED_EXISTING_KEY - An existing Registry <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> was opened
01198 
01199 Return Value:
01200 
01201    The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
01202 
01203 --*/
01204 
01205 {
01206     OBJECT_ATTRIBUTES objectAttributes;
01207     ULONG disposition, baseHandleIndex = 0, keyHandleIndex = 1, closeBaseHandle;
01208     HANDLE handles[2];
01209     BOOLEAN continueParsing;
01210     PWCHAR pathEndPtr, pathCurPtr, pathBeginPtr;
01211     ULONG pathComponentLength;
01212     UNICODE_STRING unicodeString;
01213     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01214 
01215     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01216 
01217     InitializeObjectAttributes( &amp;objectAttributes,
01218                                 KeyName,
01219                                 OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
01220                                 BaseHandle,
01221                                 (PSECURITY_DESCRIPTOR) NULL
01222                                 );
01223     <span class="comment">//</span>
01224     <span class="comment">// Attempt to create the path as specified. We have to try it this</span>
01225     <span class="comment">// way first, because it allows us to create a key without a BaseHandle</span>
01226     <span class="comment">// (if only the last component of the registry path is not present).</span>
01227     <span class="comment">//</span>
01228     status = ZwCreateKey(&amp;(handles[keyHandleIndex]),
01229                          DesiredAccess,
01230                          &amp;objectAttributes,
01231                          0,
01232                          (PUNICODE_STRING) NULL,
01233                          CreateOptions,
01234                          &amp;disposition
01235                          );
01236 
01237     <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND &amp;&amp; ARGUMENT_PRESENT(BaseHandle)) {
01238         <span class="comment">//</span>
01239         <span class="comment">// If we get to here, then there must be more than one element of the</span>
01240         <span class="comment">// registry path that does not currently exist.  We will now parse the</span>
01241         <span class="comment">// specified path, extracting each component and doing a ZwCreateKey on it.</span>
01242         <span class="comment">//</span>
01243         handles[baseHandleIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01244         handles[keyHandleIndex] = BaseHandle;
01245         closeBaseHandle = 0;
01246         continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01247         pathBeginPtr = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Buffer;
01248         pathEndPtr = (PWCHAR)((PCHAR)pathBeginPtr + <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Length);
01249         status = STATUS_SUCCESS;
01250 
01251         <span class="keywordflow">while</span>(continueParsing) {
01252             <span class="comment">//</span>
01253             <span class="comment">// There's more to do, so close the previous base handle (if necessary),</span>
01254             <span class="comment">// and replace it with the current key handle.</span>
01255             <span class="comment">//</span>
01256             <span class="keywordflow">if</span>(closeBaseHandle &gt; 1) {
01257                 ZwClose(handles[baseHandleIndex]);
01258             }
01259             baseHandleIndex = keyHandleIndex;
01260             keyHandleIndex = (keyHandleIndex + 1) &amp; 1;  <span class="comment">// toggle between 0 and 1.</span>
01261             handles[keyHandleIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01262 
01263             <span class="comment">//</span>
01264             <span class="comment">// Extract next component out of the specified registry path.</span>
01265             <span class="comment">//</span>
01266             <span class="keywordflow">for</span>(pathCurPtr = pathBeginPtr;
01267                 ((pathCurPtr &lt; pathEndPtr) &amp;&amp; (*pathCurPtr != OBJ_NAME_PATH_SEPARATOR));
01268                 pathCurPtr++);
01269 
01270             <span class="keywordflow">if</span>((pathComponentLength = (ULONG)((PCHAR)pathCurPtr - (PCHAR)pathBeginPtr))) {
01271                 <span class="comment">//</span>
01272                 <span class="comment">// Then we have a non-empty path component (key name).  Attempt</span>
01273                 <span class="comment">// to create this key.</span>
01274                 <span class="comment">//</span>
01275                 unicodeString.Buffer = pathBeginPtr;
01276                 unicodeString.Length = unicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)pathComponentLength;
01277 
01278                 InitializeObjectAttributes(&amp;objectAttributes,
01279                                            &amp;unicodeString,
01280                                            OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
01281                                            handles[baseHandleIndex],
01282                                            (PSECURITY_DESCRIPTOR) NULL
01283                                           );
01284                 status = ZwCreateKey(&amp;(handles[keyHandleIndex]),
01285                                      DesiredAccess,
01286                                      &amp;objectAttributes,
01287                                      0,
01288                                      (PUNICODE_STRING) NULL,
01289                                      CreateOptions,
01290                                      &amp;disposition
01291                                     );
01292                 <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01293                     <span class="comment">//</span>
01294                     <span class="comment">// Increment the closeBaseHandle value, which basically tells us whether</span>
01295                     <span class="comment">// the BaseHandle passed in has been 'shifted out' of our way, so that</span>
01296                     <span class="comment">// we should start closing our base handles when we're finished with them.</span>
01297                     <span class="comment">//</span>
01298                     closeBaseHandle++;
01299                 } <span class="keywordflow">else</span> {
01300                     continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01301                     <span class="keywordflow">continue</span>;
01302                 }
01303             } <span class="keywordflow">else</span> {
01304                 <span class="comment">//</span>
01305                 <span class="comment">// Either a path separator ('\') was included at the beginning of</span>
01306                 <span class="comment">// the path, or we hit 2 consecutive separators.</span>
01307                 <span class="comment">//</span>
01308                 status = STATUS_INVALID_PARAMETER;
01309                 continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01310                 <span class="keywordflow">continue</span>;
01311             }
01312 
01313             <span class="keywordflow">if</span>((pathCurPtr == pathEndPtr) ||
01314                ((pathBeginPtr = pathCurPtr + 1) == pathEndPtr)) {
01315                 <span class="comment">//</span>
01316                 <span class="comment">// Then we've reached the end of the path</span>
01317                 <span class="comment">//</span>
01318                 continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01319             }
01320         }
01321 
01322         <span class="keywordflow">if</span>(closeBaseHandle &gt; 1) {
01323             ZwClose(handles[baseHandleIndex]);
01324         }
01325     }
01326 
01327     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01328         *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = handles[keyHandleIndex];
01329 
01330         <span class="keywordflow">if</span>(ARGUMENT_PRESENT(Disposition)) {
01331             *Disposition = disposition;
01332         }
01333     }
01334 
01335     <span class="keywordflow">return</span> status;
01336 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a332" doxytag="pnpiop.h::IopDecDisableableDepends" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDecDisableableDepends           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03152">3152</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">IopQueryDeviceState()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>.
<p>
<pre class="fragment"><div>03157                    :
03158 
03159     Decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DisableableDepends field of <span class="keyword">this</span> devicenode
03160     and potentially every parent device node up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree
03161     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> parent devicenode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> decremented <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child in question
03162     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> decremented from 1 to 0
03163 
03164 Parameters:
03165 
03166     DeviceNode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> depends <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be decremented
03167 
03168 Return Value:
03169 
03170     none.
03171 
03172 --*/
03173 {
03174 
03175     <span class="keywordflow">while</span> (DeviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03176 
03177         LONG newval;
03178 
03179         newval = InterlockedDecrement(&amp; DeviceNode-&gt;DisableableDepends);
03180         <span class="keywordflow">if</span> (newval != 0) {
03181             <span class="comment">//</span>
03182             <span class="comment">// we are still non-disableable, so we don't have to bother parent</span>
03183             <span class="comment">//</span>
03184             <span class="keywordflow">break</span>;
03185         }
03186 
03187         DeviceNode = DeviceNode -&gt;Parent;
03188 
03189     }
03190 
03191 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a308" doxytag="pnpiop.h::IopDeleteKeyRecursive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDeleteKeyRecursive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SubKeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>SubKeyName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a303" doxytag="pnpiop.h::IopDeleteLegacyKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDeleteLegacyKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">5453</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03841">IopCleanupDeviceRegistryValues()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o32">_DEVICE_NODE::OverUsed1</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o34">_DEVICE_NODE::OverUsed2</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>05459                    :
05460 
05461     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Legacy= value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's legacy_xxx key
05462     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one.  If yes, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> deletes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Legacy key.
05463 
05464 Parameters:
05465 
05466     DriverObject - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object.
05467 
05468 Return Value:
05469 
05470     None.  If anything fails in <span class="keyword">this</span> routine, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> legacy key stays.
05471 
05472 --*/
05473 
05474 {
05475     WCHAR buffer[100];
05476     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05477     UNICODE_STRING deviceName, instanceName, unicodeName, *serviceName;
05478     ULONG length;
05479     HANDLE handle, handle1, handlex, enumHandle;
05480     ULONG legacy;
05481     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
05482     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
05483     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
05484 
05485     serviceName = &amp;DriverObject-&gt;DriverExtension-&gt;ServiceKeyName;
05486 
05487     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
05488     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
05489 
05490     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumHandle,
05491                                    NULL,
05492                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
05493                                    KEY_ALL_ACCESS
05494                                    );
05495 
05496     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05497         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05498     }
05499 
05500     length = _snwprintf(buffer, <span class="keyword">sizeof</span>(buffer) / <span class="keyword">sizeof</span>(WCHAR), L<span class="stringliteral">"ROOT\\LEGACY_%s"</span>, serviceName-&gt;Buffer);
05501     deviceName.MaximumLength = <span class="keyword">sizeof</span>(buffer);
05502     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(length &lt;= <span class="keyword">sizeof</span>(buffer) - 10);
05503     deviceName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(length * <span class="keyword">sizeof</span>(WCHAR));
05504     deviceName.Buffer = buffer;
05505 
05506     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
05507                                    enumHandle,
05508                                    &amp;deviceName,
05509                                    KEY_ALL_ACCESS
05510                                    );
05511 
05512     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05513 
05514         deviceName.Buffer[deviceName.Length / <span class="keyword">sizeof</span>(WCHAR)] =
05515                    OBJ_NAME_PATH_SEPARATOR;
05516         deviceName.Length += <span class="keyword">sizeof</span>(WCHAR);
05517         PiUlongToInstanceKeyUnicodeString(
05518                                 &amp;instanceName,
05519                                 buffer + deviceName.Length / <span class="keyword">sizeof</span>(WCHAR),
05520                                 <span class="keyword">sizeof</span>(buffer) - deviceName.Length,
05521                                 0
05522                                 );
05523         deviceName.Length += instanceName.Length;
05524 
05525 
05526         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
05527                                        handle1,
05528                                        &amp;instanceName,
05529                                        KEY_ALL_ACCESS
05530                                        );
05531         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05532             legacy = 1;
05533             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
05534                                           REGSTR_VALUE_LEGACY,
05535                                           &amp;keyValueInformation);
05536             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05537                 <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
05538                     (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
05539                     legacy = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
05540                 }
05541                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05542             }
05543             <span class="keywordflow">if</span> (legacy != 0) {
05544 
05545                 <span class="comment">//</span>
05546                 <span class="comment">// We also want to delete the madeup device node</span>
05547                 <span class="comment">//</span>
05548 
05549                 deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(handle, NULL);
05550                 <span class="keywordflow">if</span> (deviceObject) {
05551 
05552                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNodex, devNodey;
05553 
05554                     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
05555                     <span class="keywordflow">if</span> (deviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>)) {
05556 
05557                         <span class="comment">//</span>
05558                         <span class="comment">// Now mark this one deleted.</span>
05559                         <span class="comment">//</span>
05560                         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(deviceNode)) {
05561                             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>;
05562                             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_DEVICE_NOT_THERE);
05563                         }
05564 
05565                         <span class="comment">//</span>
05566                         <span class="comment">// This is actually doing nothing because DeviceNode-&gt;ResourceList is NULL.</span>
05567                         <span class="comment">//</span>
05568 
05569                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(deviceNode, FALSE);
05570                         devNodex = deviceNode;
05571                         <span class="keywordflow">while</span> (devNodex) {
05572                             devNodey = devNodex;
05573                             devNodex = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode;
05574                             devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05575                             devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.LegacyDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05576                         }
05577 
05578                         deviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>;  <span class="comment">// remove its boot config if any</span>
05579                         <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
05580                     }
05581                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);  <span class="comment">// added via IopDeviceObjectFromDeviceInstance</span>
05582                 }
05583 
05584                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
05585                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handlex,
05586                                                handle,
05587                                                &amp;unicodeName,
05588                                                KEY_ALL_ACCESS
05589                                                );
05590                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05591                     ZwDeleteKey(handlex);
05592                 }
05593                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
05594                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handlex,
05595                                                handle,
05596                                                &amp;unicodeName,
05597                                                KEY_ALL_ACCESS
05598                                                );
05599                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05600                     ZwDeleteKey(handlex);
05601                 }
05602 
05603                 ZwClose(enumHandle);
05604 
05605                 <span class="comment">//</span>
05606                 <span class="comment">// We need to call IopCleanupDeviceRegistryValue even we are going to</span>
05607                 <span class="comment">// delete it.  Because, it also cleans up related value names in other</span>
05608                 <span class="comment">// keys.</span>
05609                 <span class="comment">//</span>
05610 
05611                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a25">IopCleanupDeviceRegistryValues</a>(&amp;deviceName, FALSE);
05612                 ZwDeleteKey(handle);
05613                 ZwDeleteKey(handle1);
05614             } <span class="keywordflow">else</span> {
05615                 ZwClose(handle);
05616                 ZwClose(handle1);
05617                 ZwClose(enumHandle);
05618             }
05619         } <span class="keywordflow">else</span> {
05620             ZwClose(handle1);
05621             ZwClose(enumHandle);
05622         }
05623     } <span class="keywordflow">else</span> {
05624         ZwClose(enumHandle);
05625     }
05626 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
05627     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
05628     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
05629     <span class="keywordflow">return</span>;
05630 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a313" doxytag="pnpiop.h::IopDeleteLockedDeviceNodes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDeleteLockedDeviceNodes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RelationsList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUGPLAY_DEVICE_DELETE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsKernelInitiated</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessIndirectDescendants</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Problem</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *VetoingDevice&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00557">557</a> of file <a class="el" href="../../d4/d9/pnpdel_8c-source.html">pnpdel.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a222">AssignResources</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00553">DNF_REMOVE_PENDING_CLOSES</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00163">IRP_MN_CANCEL_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00161">IRP_MN_QUERY_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00184">IRP_MN_SURPRISE_REMOVAL</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00187">IopDelayedRemoveWorker()</a>.
<p>
<pre class="fragment"><div>00569                    :
00570 
00571     This routine performs requested operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceObject and
00572     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device objects specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceRelations.
00573 
00574 Arguments:
00575 
00576     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object.
00577 
00578     DeviceRelations - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's removal relations.
00579 
00580     OperationCode - Operation code, i.e., QueryRemove, CancelRemove, Remove...
00581 
00582 Return Value:
00583 
00584     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00585 
00586 --*/
00587 
00588 {
00589     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00590     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00591     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject, relatedDeviceObject;
00592     ULONG i;
00593     ULONG marker;
00594     ULONG irpCode;
00595     BOOLEAN tagged, directDescendant;
00596 
00597     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00598 
00599     PIDBGMSG( PIDBG_REMOVAL,
00600               (<span class="stringliteral">"IopDeleteLockedDeviceNodes: Entered\n    DeviceObject = 0x%p\n    RelationsList = 0x%p\n    OperationCode = %d\n"</span>,
00601               DeviceObject,
00602               RelationsList,
00603               OperationCode));
00604 
00605     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00606 
00607     <span class="keywordflow">switch</span> (OperationCode) {
00608     <span class="keywordflow">case</span> QueryRemoveDevice:
00609         irpCode = <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>;
00610         <span class="keywordflow">break</span>;
00611 
00612     <span class="keywordflow">case</span> CancelRemoveDevice:
00613         irpCode = <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>;
00614         <span class="keywordflow">break</span>;
00615 
00616     <span class="keywordflow">case</span> RemoveDevice:
00617         irpCode = <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>;
00618         <span class="keywordflow">break</span>;
00619 
00620     <span class="keywordflow">case</span> SurpriseRemoveDevice:
00621         irpCode = <a class="code" href="../../d0/d5/io_8h.html#a87">IRP_MN_SURPRISE_REMOVAL</a>;
00622         <span class="keywordflow">break</span>;
00623 
00624     <span class="keywordflow">case</span> EjectDevice:
00625     <span class="keywordflow">default</span>:
00626         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
00627         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00628     }
00629 
00630     marker = 0;
00631     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations</a>( RelationsList,
00632                                   &amp;marker,
00633                                   &amp;deviceObject,
00634                                   &amp;directDescendant,
00635                                   &amp;tagged,
00636                                   TRUE)) {
00637 
00638         <span class="comment">//</span>
00639         <span class="comment">// Depending on the operation we need to do different things.</span>
00640         <span class="comment">//</span>
00641         <span class="comment">//  QueryRemoveDevice / CancelRemoveDevice</span>
00642         <span class="comment">//      Ignore tagged relations - they were processed by a previous eject</span>
00643         <span class="comment">//      Process both direct and indirect descendants</span>
00644         <span class="comment">//</span>
00645         <span class="comment">//  SurpriseRemoveDevice / RemoveDevice</span>
00646         <span class="comment">//      None of the relations should be tagged</span>
00647         <span class="comment">//      Ignore indirect descendants</span>
00648         <span class="comment">//</span>
00649 
00650         <span class="keywordflow">if</span> (!tagged &amp;&amp; (directDescendant || ProcessIndirectDescendants)) {
00651             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00652 
00653             <span class="keywordflow">if</span> (OperationCode == SurpriseRemoveDevice) {
00654                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>;
00655             }
00656 
00657             <span class="keywordflow">if</span> (OperationCode == QueryRemoveDevice &amp;&amp; !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>)) {
00658                 <span class="comment">//</span>
00659                 <span class="comment">// Don't send Queries to devices without FDOs (or filters)</span>
00660                 <span class="comment">//</span>
00661                 <span class="keywordflow">continue</span>;
00662             }
00663 
00664             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d0/pnpdel_8c.html#a3">IopDeleteLockedDeviceNode</a>( deviceNode,
00665                                             irpCode,
00666                                             RelationsList,
00667                                             IsKernelInitiated,
00668                                             Problem)) {
00669 
00670                 <span class="keywordflow">if</span> (OperationCode == QueryRemoveDevice) {
00671 
00672                     <span class="keywordflow">if</span> (VetoingDevice != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00673                         *VetoingDevice = deviceObject;
00674                     }
00675 
00676                     <a class="code" href="../../d3/d0/pnpdel_8c.html#a3">IopDeleteLockedDeviceNode</a>( deviceNode,
00677                                                IRP_MN_CANCEL_REMOVE_DEVICE,
00678                                                RelationsList,
00679                                                IsKernelInitiated,
00680                                                Problem);
00681 
00682                     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations</a>( RelationsList,
00683                                                   &amp;marker,
00684                                                   &amp;deviceObject,
00685                                                   NULL,
00686                                                   &amp;tagged,
00687                                                   FALSE)) {
00688 
00689                         <span class="keywordflow">if</span> (!tagged) {
00690 
00691                             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00692 
00693                             <a class="code" href="../../d3/d0/pnpdel_8c.html#a3">IopDeleteLockedDeviceNode</a>( deviceNode,
00694                                                        IRP_MN_CANCEL_REMOVE_DEVICE,
00695                                                        RelationsList,
00696                                                        IsKernelInitiated,
00697                                                        Problem);
00698                         }
00699                     }
00700 
00701                     status = STATUS_UNSUCCESSFUL;
00702                     <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00703                 }
00704             }
00705         }
00706     }
00707 
00708     <span class="comment">//</span>
00709     <span class="comment">// As long as there is device removed, try satisfy the DNF_INSUFFICIENT_RESOURCES</span>
00710     <span class="comment">// devices.</span>
00711     <span class="comment">//</span>
00712 
00713     <span class="keywordflow">if</span> (OperationCode == RemoveDevice) {
00714         PIDBGMSG( PIDBG_REMOVAL,
00715                   (<span class="stringliteral">"IopDeleteLockedDeviceNodes: Calling IopRequestDeviceEnumeration\n"</span>));
00716 
00717         <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>(NULL, AssignResources, NULL, NULL);
00718     }
00719 
00720 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
00721     <span class="keywordflow">return</span> status;
00722 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a284" doxytag="pnpiop.h::IopDestroyDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDestroyDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d4/d0/objsup_8c-source.html#l00769">IopDeleteDevice()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06083">IopRemoveLegacyDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a254" doxytag="pnpiop.h::IopDetermineResourceListSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG IopDetermineResourceListSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ResourceList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03631">3631</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00629">IopChangeInterfaceType()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06955">IopCombineCmResourceList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06726">IopCombineLegacyResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05198">IopMergeCmResourceLists()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07291">IopReserveBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>03637                    :
03638 
03639     This routine determines size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed in ResourceList
03640     structure.
03641 
03642 Arguments:
03643 
03644     Configuration1 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource list.
03645 
03646 Return Value:
03647 
03648     size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource list structure.
03649 
03650 --*/
03651 
03652 {
03653     ULONG totalSize, listSize, descriptorSize, i, j;
03654     PCM_FULL_RESOURCE_DESCRIPTOR fullResourceDesc;
03655     PCM_PARTIAL_RESOURCE_DESCRIPTOR partialDescriptor;
03656 
03657     <span class="keywordflow">if</span> (!ResourceList) {
03658         totalSize = 0;
03659     } <span class="keywordflow">else</span> {
03660         totalSize = FIELD_OFFSET(CM_RESOURCE_LIST, List);
03661         fullResourceDesc = &amp;ResourceList-&gt;List[0];
03662         <span class="keywordflow">for</span> (i = 0; i &lt; ResourceList-&gt;Count; i++) {
03663             listSize = FIELD_OFFSET(CM_FULL_RESOURCE_DESCRIPTOR,
03664                                     PartialResourceList) +
03665                        FIELD_OFFSET(CM_PARTIAL_RESOURCE_LIST,
03666                                     PartialDescriptors);
03667             partialDescriptor = &amp;fullResourceDesc-&gt;PartialResourceList.PartialDescriptors[0];
03668             <span class="keywordflow">for</span> (j = 0; j &lt; fullResourceDesc-&gt;PartialResourceList.Count; j++) {
03669                 descriptorSize = <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR);
03670                 <span class="keywordflow">if</span> (partialDescriptor-&gt;Type == CmResourceTypeDeviceSpecific) {
03671                     descriptorSize += partialDescriptor-&gt;u.DeviceSpecificData.DataSize;
03672                 }
03673                 listSize += descriptorSize;
03674                 partialDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR)
03675                                         ((PUCHAR)partialDescriptor + descriptorSize);
03676             }
03677             totalSize += listSize;
03678             fullResourceDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)
03679                                       ((PUCHAR)fullResourceDesc + listSize);
03680         }
03681     }
03682     <span class="keywordflow">return</span> totalSize;
03683 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a329" doxytag="pnpiop.h::IopDeviceCapabilitiesToRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDeviceCapabilitiesToRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Capabilities</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05675">5675</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
<pre class="fragment"><div>05682                    :
05683 
05684     This routine updates device capabilities, must be called after a valid device instance key has been created
05685     Called directly from <a class="code" href="../../d6/d0/pnpenum_8c.html#a35">IopProcessNewDeviceNode</a>, and indirecly via <a class="code" href="../../d9/d0/pnpiop_8h.html#a328">IopDeviceNodeCapabilitiesToRegistry</a>
05686     after device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> started.
05687 
05688 Arguments:
05689 
05690     DeviceObject - supplies a pointer to a device object whose registry
05691         values are to be updated.
05692 
05693 Return Value:
05694 
05695     status
05696 
05697 --*/
05698 
05699 {
05700     HANDLE handle;
05701     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05702     UNICODE_STRING unicodeName;
05703     ULONG tmpValue;
05704 
05705     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05706 
05707     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode != NULL);
05708     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Capabilities != NULL);
05709 
05710     <span class="comment">//</span>
05711     <span class="comment">// Open the device instance key</span>
05712     <span class="comment">//</span>
05713     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceNode-&gt;PhysicalDeviceObject, &amp;handle, KEY_ALL_ACCESS);
05714     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05715         <span class="keywordflow">return</span> status;
05716     }
05717 
05718     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>) {
05719         Capabilities-&gt;SurpriseRemovalOK = 0;
05720     }
05721 
05722     <span class="comment">//</span>
05723     <span class="comment">// Assert the bit fields are completely contained in a ULONG. This is a</span>
05724     <span class="comment">// public structure, so it shouldn't ever change, but paranoia is a good</span>
05725     <span class="comment">// thing...</span>
05726     <span class="comment">//</span>
05727     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((FIELD_OFFSET(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>, Address) -
05728             FIELD_OFFSET(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>, Version) -
05729             FIELD_SIZE  (DEVICE_CAPABILITIES, Version)) == <span class="keyword">sizeof</span>(ULONG));
05730 
05731     DeviceNode-&gt;CapabilityFlags =
05732         *((PULONG) (((PUCHAR) Capabilities) +
05733         FIELD_OFFSET(DEVICE_CAPABILITIES, Version) +
05734         <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(DEVICE_CAPABILITIES, Version)));
05735 
05736     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_CAPABILITIES);
05737     tmpValue = (Capabilities-&gt;LockSupported)          |
05738                (Capabilities-&gt;EjectSupported    &lt;&lt; 1) |
05739                (Capabilities-&gt;WarmEjectSupported&lt;&lt; 1) |
05740                (Capabilities-&gt;Removable         &lt;&lt; 2) |
05741                (Capabilities-&gt;DockDevice        &lt;&lt; 3) |
05742                (Capabilities-&gt;UniqueID          &lt;&lt; 4) |
05743                (Capabilities-&gt;SilentInstall     &lt;&lt; 5) |
05744                (Capabilities-&gt;RawDeviceOK       &lt;&lt; 6) |
05745                (Capabilities-&gt;SurpriseRemovalOK &lt;&lt; 7) |
05746                (Capabilities-&gt;HardwareDisabled  &lt;&lt; 8) |
05747                (Capabilities-&gt;NonDynamic        &lt;&lt; 9);
05748 
05749     status = ZwSetValueKey(
05750                   handle,
05751                   &amp;unicodeName,
05752                   TITLE_INDEX_VALUE,
05753                   REG_DWORD,
05754                   &amp;tmpValue,
05755                   <span class="keyword">sizeof</span>(tmpValue)
05756                   );
05757 
05758     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_UI_NUMBER);
05759     tmpValue = Capabilities-&gt;UINumber;
05760     <span class="keywordflow">if</span>(tmpValue != (ULONG)-1) {
05761         ZwSetValueKey(handle,
05762                       &amp;unicodeName,
05763                       TITLE_INDEX_VALUE,
05764                       REG_DWORD,
05765                       &amp;tmpValue,
05766                       <span class="keyword">sizeof</span>(tmpValue)
05767                       );
05768     } <span class="keywordflow">else</span> {
05769         ZwDeleteValueKey(handle, &amp;unicodeName);
05770     }
05771 
05772     ZwClose(handle);
05773     <span class="keywordflow">return</span> status;
05774 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a328" doxytag="pnpiop.h::IopDeviceNodeCapabilitiesToRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDeviceNodeCapabilitiesToRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05633">5633</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05524">IopDeviceCapabilitiesToRegistry()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03694">IopQueryDeviceCapabilities()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>.
<p>
<pre class="fragment"><div>05639                    :
05640 
05641     Called after start to refresh Capability flags
05642 
05643 Arguments:
05644 
05645     DeviceObject - supplies a pointer to a device object whose registry
05646         values are to be updated.
05647 
05648 Return Value:
05649 
05650     status
05651 
05652 --*/
05653 
05654 {
05655     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05656     <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a> capabilities;
05657 
05658     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05659 
05660     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode != NULL);
05661 
05662     <span class="comment">//</span>
05663     <span class="comment">// Open the device instance key</span>
05664     <span class="comment">//</span>
05665 
05666     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a330">IopQueryDeviceCapabilities</a>(DeviceNode, &amp;capabilities);
05667     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05668         <span class="keywordflow">return</span> status;
05669     }
05670 
05671     <span class="keywordflow">return</span> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a35">IopDeviceCapabilitiesToRegistry</a>(DeviceNode,&amp;capabilities);
05672 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a257" doxytag="pnpiop.h::IopDeviceObjectFromDeviceInstance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> IopDeviceObjectFromDeviceInstance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE DeviceInstanceHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING DeviceInstance&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03759">3759</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00037">IO_TYPE_DEVICE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01176">_DEVICE_OBJECT::Type</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00166">IopAddDevicesToBootDriverWorker()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">IopDeleteLegacyKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01516">IopGetDriverDeviceListWorker()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03443">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09922">IopProcessSetInterfaceState()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06660">IopSetLegacyDeviceInstance()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>03766                    :
03767 
03768     This routine receives a DeviceInstance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> (or DeviceInstance handle) and
03769     returns a reference to a bus device object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceInstance.
03770 
03771     Note, caller must owner <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a> before calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function,
03772 
03773 Arguments:
03774 
03775     DeviceInstanceHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry Device Instance key.
03776         If <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DeviceInstance must specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
03777 
03778     DeviceInstance - supplies a UNICODE_STRING to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
03779         <span class="keywordflow">if</span> <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DeviceInstanceHandle must specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle
03780         to its registry key.
03781 
03782 Returns:
03783 
03784     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> reference to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired bus device object.
03785 
03786 --*/
03787 
03788 {
03789     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03790     HANDLE handle, deviceHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03791     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03792     UNICODE_STRING unicodeName;
03793     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03794     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03795 
03796     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03797 
03798     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(DeviceInstanceHandle)) {
03799 
03800         <span class="comment">//</span>
03801         <span class="comment">// Treat HTREE\ROOT\0 specially</span>
03802         <span class="comment">//</span>
03803         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_ROOT_DEVNODE);
03804 
03805         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;unicodeName, DeviceInstance, TRUE)) {
03806 
03807             deviceReference = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
03808             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceReference);
03809             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceReference);
03810 
03811             <span class="keywordflow">return</span> deviceReference;
03812         }
03813 
03814         <span class="comment">//</span>
03815         <span class="comment">// first open System\CCS\Enum key and then the device instance key.</span>
03816         <span class="comment">//</span>
03817 
03818         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03819                                        NULL,
03820                                        &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
03821                                        KEY_READ
03822                                        );
03823 
03824         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03825             <span class="keywordflow">return</span> deviceReference;
03826         }
03827 
03828         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceInstance);
03829         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;deviceHandle,
03830                                        handle,
03831                                        DeviceInstance,
03832                                        KEY_READ
03833                                        );
03834         ZwClose(handle);
03835         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03836             <span class="keywordflow">return</span> deviceReference;
03837         }
03838         DeviceInstanceHandle = deviceHandle;
03839     }
03840 
03841     <span class="comment">//</span>
03842     <span class="comment">// Read the address of device object</span>
03843     <span class="comment">//</span>
03844 
03845     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
03846     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03847                                    DeviceInstanceHandle,
03848                                    &amp;unicodeName,
03849                                    KEY_READ
03850                                    );
03851     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03852         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03853     }
03854 
03855     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
03856                                   REGSTR_VALUE_DEVICE_REFERENCE,
03857                                   &amp;keyValueInformation);
03858     ZwClose(handle);
03859     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03860         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03861             (keyValueInformation-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG_PTR))) {
03862 
03863             deviceReference = *(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03864         }
03865         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03866     }
03867     <span class="keywordflow">if</span> (!deviceReference) {
03868         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03869     }
03870 
03871     <span class="comment">//</span>
03872     <span class="comment">// Make sure the address of the device object is not clobbered,</span>
03873     <span class="comment">// unfortunately if the address is truly bogus we will bugcheck since</span>
03874     <span class="comment">// try/except doesn't work for kernel addresses.</span>
03875     <span class="comment">//</span>
03876 
03877     <span class="keywordflow">if</span> (deviceReference-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a2">IO_TYPE_DEVICE</a>) {
03878         deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03879     } <span class="keywordflow">else</span> {
03880         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceReference-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03881         <span class="keywordflow">if</span> (deviceNode &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a> == deviceReference)) {
03882             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceReference);
03883         } <span class="keywordflow">else</span> {
03884             deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03885         }
03886     }
03887 
03888 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
03889     <span class="keywordflow">if</span> (deviceHandle) {
03890         ZwClose(deviceHandle);
03891     }
03892     <span class="keywordflow">return</span> deviceReference;
03893 
03894 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a258" doxytag="pnpiop.h::IopDeviceObjectToDeviceInstance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDeviceObjectToDeviceInstance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceInstanceHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03897">3897</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00373">IoGetDeviceProperty()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00810">IoOpenDeviceRegistryKey()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01824">IopAssignResourcesToDevices()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05675">IopDeviceCapabilitiesToRegistry()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l02009">IopIsFirmwareDisabled()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08162">IopNotifySetupDeviceArrival()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04318">IopNotifySetupDevices()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01931">IopWriteAllocatedResourcesToRegistry()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>03905                    :
03906 
03907     This routine receives a DeviceObject pointer and returns a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
03908     instance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> under registry System\ENUM key.
03909 
03910     Note, caller must owner <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a> before calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function,
03911 
03912 Arguments:
03913 
03914     DeviceObject - supplies a pointer to a physical device object.
03915 
03916     DeviceInstanceHandle - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry
03917              device instance key.
03918 
03919     DesiredAccess - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to <span class="keyword">this</span> key.
03920 
03921 Returns:
03922 
03923     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code to indicate success or <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
03924 
03925 --*/
03926 
03927 {
03928     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03929     HANDLE handle;
03930     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03931 
03932     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03933 
03934     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03935                                    NULL,
03936                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
03937                                    KEY_READ
03938                                    );
03939 
03940     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03941         <span class="keywordflow">return</span> status;
03942     }
03943 
03944     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
03945     <span class="keywordflow">if</span> (deviceNode &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Length != 0)) {
03946         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( DeviceInstanceHandle,
03947                                        handle,
03948                                        &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>,
03949                                        DesiredAccess
03950                                        );
03951     } <span class="keywordflow">else</span> {
03952         status = STATUS_INVALID_DEVICE_REQUEST;
03953     }
03954     ZwClose(handle);
03955 
03956     <span class="keywordflow">return</span> status;
03957 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a368" doxytag="pnpiop.h::IopDmaInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDmaInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a356" doxytag="pnpiop.h::IopDoDeferredSetInterfaceState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDoDeferredSetInterfaceState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09866">9866</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01224">DOE_START_PENDING</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09922">IopProcessSetInterfaceState()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00076">_PENDING_SET_INTERFACE_STATE::LinkName</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a113">PPENDING_SET_INTERFACE_STATE</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>09871                    :
09872 
09873     Process <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queued <a class="code" href="../../d6/d9/pnp_8h.html#a148">IoSetDeviceInterfaceState</a> calls.
09874 
09875 Parameters:
09876 
09877     DeviceNode - Device node which has just been started.
09878 
09879 Return Value:
09880 
09881     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
09882 
09883 --*/
09884 {
09885     KIRQL           irql;
09886     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  attachedDevice;
09887 
09888     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
09889     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;PpRegistryDeviceResource, TRUE);
09890 
09891     ExAcquireFastLock( &amp;IopDatabaseLock, &amp;irql );
09892 
09893     <span class="keywordflow">for</span> (attachedDevice = DeviceNode-&gt;PhysicalDeviceObject;
09894          attachedDevice;
09895          attachedDevice = attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
09896 
09897         attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a142">DOE_START_PENDING</a>;
09898     }
09899 
09900     ExReleaseFastLock( &amp;IopDatabaseLock, irql );
09901 
09902     <span class="keywordflow">while</span> (!IsListEmpty(&amp;DeviceNode-&gt;PendedSetInterfaceState)) {
09903 
09904         <a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">PPENDING_SET_INTERFACE_STATE</a> entry;
09905 
09906         entry = (<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">PPENDING_SET_INTERFACE_STATE</a>)RemoveHeadList(&amp;DeviceNode-&gt;PendedSetInterfaceState);
09907 
09908         <a class="code" href="../../d9/d0/pnpiop_8h.html#a357">IopProcessSetInterfaceState</a>(&amp;entry-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>, TRUE, FALSE);
09909 
09910         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.Buffer);
09911 
09912         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry);
09913     }
09914 
09915     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
09916     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
09917 
09918     <span class="keywordflow">return</span> STATUS_SUCCESS;
09919 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a247" doxytag="pnpiop.h::IopDriverLoadingFailed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDriverLoadingFailed           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE KeyHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a345" doxytag="pnpiop.h::IopDumpAllocatedSystemResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDumpAllocatedSystemResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN UCHAR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ResourceType</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a344" doxytag="pnpiop.h::IopDumpCmResourceDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDumpCmResourceDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Indent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_PARTIAL_RESOURCE_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>Desc</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/report_8c-source.html#l00868">868</a> of file <a class="el" href="../../d2/d7/report_8c-source.html">report.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/report_8c-source.html#l00929">IopDumpCmResourceList()</a>.
<p>
<pre class="fragment"><div>00874                    :
00875 
00876     This routine processes a IO_RESOURCE_DESCRIPTOR and displays <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00877 
00878 Arguments:
00879 
00880     Indent - # <span class="keywordtype">char</span> of indentation.
00881 
00882     Desc - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO_RESOURCE_DESCRIPTOR to be displayed.
00883 
00884 Return Value:
00885 
00886     None.
00887 
00888 --*/
00889 {
00890     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00891 
00892     <span class="keywordflow">switch</span> (Desc-&gt;Type) {
00893         <span class="keywordflow">case</span> CmResourceTypePort:
00894             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"%sIO  Start: %x:%08x, Length:  %x\n"</span>,
00895                 Indent,
00896                 Desc-&gt;u.Port.Start.HighPart, Desc-&gt;u.Port.Start.LowPart,
00897                 Desc-&gt;u.Port.Length
00898                 );
00899             <span class="keywordflow">break</span>;
00900 
00901         <span class="keywordflow">case</span> CmResourceTypeMemory:
00902             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"%sMEM Start: %x:%08x, Length:  %x\n"</span>,
00903                 Indent,
00904                 Desc-&gt;u.Memory.Start.HighPart, Desc-&gt;u.Memory.Start.LowPart,
00905                 Desc-&gt;u.Memory.Length
00906                 );
00907             <span class="keywordflow">break</span>;
00908 
00909         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
00910             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"%sINT Level: %x, Vector: %x, Affinity: %x\n"</span>,
00911                 Indent,
00912                 Desc-&gt;u.Interrupt.Level,
00913                 Desc-&gt;u.Interrupt.Vector,
00914                 Desc-&gt;u.Interrupt.Affinity
00915                 );
00916             <span class="keywordflow">break</span>;
00917 
00918         <span class="keywordflow">case</span> CmResourceTypeDma:
00919             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"%sDMA Channel: %x, Port: %x\n"</span>,
00920                 Indent,
00921                 Desc-&gt;u.Dma.Channel,
00922                 Desc-&gt;u.Dma.Port
00923                 );
00924             <span class="keywordflow">break</span>;
00925     }
00926 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a343" doxytag="pnpiop.h::IopDumpCmResourceList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDumpCmResourceList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CmList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/report_8c-source.html#l00929">929</a> of file <a class="el" href="../../d2/d7/report_8c-source.html">report.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00868">IopDumpCmResourceDescriptor()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>.
<p>
<pre class="fragment"><div>00934                    :
00935 
00936     This routine displays CM resource list.
00937 
00938 Arguments:
00939 
00940     CmList - supplies a pointer to CM resource list
00941 
00942 Return Value:
00943 
00944     None.
00945 
00946 --*/
00947 {
00948     PCM_FULL_RESOURCE_DESCRIPTOR fullDesc;
00949     PCM_PARTIAL_RESOURCE_LIST partialDesc;
00950     PCM_PARTIAL_RESOURCE_DESCRIPTOR desc;
00951     ULONG count, i;
00952 
00953     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00954 
00955     <span class="keywordflow">if</span> (CmList-&gt;Count &gt; 0) {
00956         <span class="keywordflow">if</span> (CmList) {
00957             fullDesc = &amp;CmList-&gt;List[0];
00958             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Cm Resource List -\n"</span>);
00959             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"  List Count = %x, Bus Number = %x\n"</span>, CmList-&gt;Count, fullDesc-&gt;BusNumber);
00960             partialDesc = &amp;fullDesc-&gt;PartialResourceList;
00961             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"  Version = %x, Revision = %x, Desc count = %x\n"</span>, partialDesc-&gt;Version,
00962                      partialDesc-&gt;Revision, partialDesc-&gt;Count);
00963             count = partialDesc-&gt;Count;
00964             desc = &amp;partialDesc-&gt;PartialDescriptors[0];
00965             <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
00966                 <a class="code" href="../../d1/d8/report_8c.html#a16">IopDumpCmResourceDescriptor</a>(<span class="stringliteral">"    "</span>, desc);
00967                 desc++;
00968             }
00969         }
00970     }
00971 }
<span class="comment">//#endif</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a326" doxytag="pnpiop.h::IopDuplicateDetection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDuplicateDetection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN INTERFACE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>LegacyBusType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BusNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SlotNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06528">6528</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01943">_INTERFACE::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01945">_INTERFACE::InterfaceDereference</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06408">IopFindBusDeviceNode()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02617">IopQueryResourceHandlerInterface()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, and <a class="el" href="../../d9/d0/pnpiop_8h.html#a390a217">ResourceLegacyDeviceDetection</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>06537                    :
06538 
06539     This routine searches <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bus device driver <span class="keywordflow">for</span> a given legacy device,
06540     sends a query interface <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> <span class="keywordflow">for</span> legacy device detection, and <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver
06541     implements <span class="keyword">this</span> interface, requests <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given legacy device.
06542 
06543 Parameters:
06544 
06545     LegacyBusType - The legacy device's interface <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
06546 
06547     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> - The legacy device's bus number.
06548 
06549     SlotNumber - The legacy device's slot number.
06550 
06551     DeviceNode - specifies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duplicated device node
06552 
06553 Return Value:
06554 
06555     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
06556 
06557 --*/
06558 
06559 {
06560     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
06561     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> busDeviceObject;
06562     <a class="code" href="../../d0/d0/struct__LEGACY__DEVICE__DETECTION__INTERFACE.html">PLEGACY_DEVICE_DETECTION_INTERFACE</a> interface;
06563     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06564     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
06565 
06566     <span class="comment">//</span>
06567     <span class="comment">// Initialize return parameter to "not found".</span>
06568     <span class="comment">//</span>
06569 
06570     *DeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06571 
06572     <span class="comment">//</span>
06573     <span class="comment">// Search the device tree for the bus of the legacy device.</span>
06574     <span class="comment">//</span>
06575 
06576     deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a>(
06577                      IopRootDeviceNode,
06578                      LegacyBusType,
06579                      BusNumber,
06580                      SlotNumber
06581                  );
06582 
06583     <span class="comment">//</span>
06584     <span class="comment">// Either a bus driver does not exist (or more likely, the legacy bus</span>
06585     <span class="comment">// type and bus number were unspecified).  Either way, we can't make</span>
06586     <span class="comment">// any further progress.</span>
06587     <span class="comment">//</span>
06588 
06589     <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06590 
06591         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
06592 
06593     }
06594 
06595     <span class="comment">//</span>
06596     <span class="comment">// We found the legacy device's bus driver.  Query it to determine</span>
06597     <span class="comment">// whether it implements the LEGACY_DEVICE_DETECTION interface.</span>
06598     <span class="comment">//</span>
06599 
06600     busDeviceObject = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
06601 
06602     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a28">IopQueryResourceHandlerInterface</a>(
06603                  ResourceLegacyDeviceDetection,
06604                  busDeviceObject,
06605                  0,
06606                  (<a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a> *)&amp;interface
06607              );
06608 
06609     <span class="comment">//</span>
06610     <span class="comment">// If it doesn't, we're stuck.</span>
06611     <span class="comment">//</span>
06612 
06613     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || interface == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06614 
06615         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
06616 
06617     }
06618 
06619     <span class="comment">//</span>
06620     <span class="comment">// Invoke the bus driver's legacy device detection method.</span>
06621     <span class="comment">//</span>
06622 
06623     status = (*interface-&gt;<a class="code" href="../../d0/d0/struct__LEGACY__DEVICE__DETECTION__INTERFACE.html#o5">LegacyDeviceDetection</a>)(
06624                  interface-&gt;<a class="code" href="../../d0/d0/struct__LEGACY__DEVICE__DETECTION__INTERFACE.html#o2">Context</a>,
06625                  LegacyBusType,
06626                  <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>,
06627                  SlotNumber,
06628                  &amp;deviceObject
06629              );
06630 
06631     <span class="comment">//</span>
06632     <span class="comment">// If it found a legacy device, update the return parameter.</span>
06633     <span class="comment">//</span>
06634 
06635     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; deviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06636 
06637         *DeviceNode =
06638             (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
06639 
06640         status = STATUS_SUCCESS;
06641 
06642     } <span class="keywordflow">else</span> {
06643 
06644         status = STATUS_INVALID_DEVICE_REQUEST;
06645 
06646     }
06647 
06648     <span class="comment">//</span>
06649     <span class="comment">// Free the interface.</span>
06650     <span class="comment">//</span>
06651 
06652     (*interface-&gt;<a class="code" href="../../d0/d0/struct__LEGACY__DEVICE__DETECTION__INTERFACE.html#o4">InterfaceDereference</a>)(interface-&gt;<a class="code" href="../../d0/d0/struct__LEGACY__DEVICE__DETECTION__INTERFACE.html#o2">Context</a>);
06653 
06654     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(interface);
06655 
06656     <span class="keywordflow">return</span> status;
06657 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a265" doxytag="pnpiop.h::IopEjectDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopEjectDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PendingEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a292" doxytag="pnpiop.h::IopFilterResourceRequirementsList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopFilterResourceRequirementsList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>IoList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>CmList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>FilteredList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ExactMatch</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04592">4592</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04279">IopCmResourcesToIoResources()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>.
<p>
<pre class="fragment"><div>04601                    :
04602 
04603     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> adjusts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input IoList based on input BootConfig.
04604 
04605 
04606 Arguments:
04607 
04608     IoList - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to an IoResourceRequirementsList
04609 
04610     CmList - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to a BootConfig.
04611 
04612     FilteredList - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filtered resource
04613              requirements list.
04614 
04615 Return Value:
04616 
04617     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code to indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function.
04618 
04619 --*/
04620 {
04621     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04622     PIO_RESOURCE_REQUIREMENTS_LIST ioList, newList;
04623     PIO_RESOURCE_LIST ioResourceList, newIoResourceList, selectedResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04624     PIO_RESOURCE_DESCRIPTOR ioResourceDescriptor, ioResourceDescriptorEnd;
04625     PIO_RESOURCE_DESCRIPTOR newIoResourceDescriptor, configDataDescriptor;
04626     LONG ioResourceDescriptorCount = 0;
04627     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> version;
04628     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04629     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDescriptor;
04630     ULONG cmDescriptorCount = 0;
04631     ULONG size, i, j, oldCount, phase;
04632     LONG k, alternativeLists;
04633     BOOLEAN exactMatch;
04634 
04635     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04636 
04637     *FilteredList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04638     *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04639 
04640     <span class="comment">//</span>
04641     <span class="comment">// Make sure there is some resource requirements to be filtered.</span>
04642     <span class="comment">// If no, we will convert CmList/BootConfig to an IoResourceRequirementsList</span>
04643     <span class="comment">//</span>
04644 
04645     <span class="keywordflow">if</span> (IoList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList-&gt;AlternativeLists == 0) {
04646         <span class="keywordflow">if</span> (CmList &amp;&amp; CmList-&gt;Count != 0) {
04647             *FilteredList = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, CmList, LCPRI_BOOTCONFIG);
04648         }
04649         <span class="keywordflow">return</span> STATUS_SUCCESS;
04650     }
04651 
04652     <span class="comment">//</span>
04653     <span class="comment">// Make a copy of the Io Resource Requirements List</span>
04654     <span class="comment">//</span>
04655 
04656     ioList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, IoList-&gt;ListSize);
04657     <span class="keywordflow">if</span> (ioList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04658         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04659     }
04660 
04661     RtlMoveMemory(ioList, IoList, IoList-&gt;ListSize);
04662 
04663     <span class="comment">//</span>
04664     <span class="comment">// If there is no BootConfig, simply return the copy of the input Io list.</span>
04665     <span class="comment">//</span>
04666 
04667     <span class="keywordflow">if</span> (CmList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || CmList-&gt;Count == 0) {
04668         *FilteredList = ioList;
04669         <span class="keywordflow">return</span> STATUS_SUCCESS;
04670     }
04671 
04672     <span class="comment">//</span>
04673     <span class="comment">// First determine minimum number of descriptors required.</span>
04674     <span class="comment">//</span>
04675 
04676     cmFullDesc = &amp;CmList-&gt;List[0];
04677     <span class="keywordflow">for</span> (i = 0; i &lt; CmList-&gt;Count; i++) {
04678         cmDescriptorCount += cmFullDesc-&gt;PartialResourceList.Count;
04679         cmDescriptor = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04680         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04681             size = 0;
04682             <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04683             <span class="keywordflow">case</span> CmResourceTypeConfigData:
04684             <span class="keywordflow">case</span> CmResourceTypeDevicePrivate:
04685                  cmDescriptorCount--;
04686                  <span class="keywordflow">break</span>;
04687             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04688                  size = cmDescriptor-&gt;u.DeviceSpecificData.DataSize;
04689                  cmDescriptorCount--;
04690                  <span class="keywordflow">break</span>;
04691             <span class="keywordflow">default</span>:
04692 
04693                  <span class="comment">//</span>
04694                  <span class="comment">// Invalid cmresource list.  Ignore it and use io resources</span>
04695                  <span class="comment">//</span>
04696 
04697                  <span class="keywordflow">if</span> (cmDescriptor-&gt;Type == CmResourceTypeNull ||
04698                      cmDescriptor-&gt;Type &gt;= CmResourceTypeMaximum) {
04699                      cmDescriptorCount--;
04700                  }
04701             }
04702             cmDescriptor++;
04703             cmDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmDescriptor + size);
04704         }
04705         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmDescriptor;
04706     }
04707 
04708     <span class="keywordflow">if</span> (cmDescriptorCount == 0) {
04709         *FilteredList = ioList;
04710         <span class="keywordflow">return</span> STATUS_SUCCESS;
04711     }
04712 
04713     <span class="comment">//</span>
04714     <span class="comment">// cmDescriptorCount is the number of BootConfig Descriptors needs.</span>
04715     <span class="comment">//</span>
04716     <span class="comment">// For each IO list Alternative ...</span>
04717     <span class="comment">//</span>
04718 
04719     ioResourceList = ioList-&gt;List;
04720     k = ioList-&gt;AlternativeLists;
04721     <span class="keywordflow">while</span> (--k &gt;= 0) {
04722         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04723         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
04724         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04725             ioResourceDescriptor-&gt;Spare1 = 0;
04726             ioResourceDescriptor++;
04727         }
04728         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
04729     }
04730 
04731     ioResourceList = ioList-&gt;List;
04732     k = alternativeLists = ioList-&gt;AlternativeLists;
04733     <span class="keywordflow">while</span> (--k &gt;= 0) {
04734         version = ioResourceList-&gt;Version;
04735         <span class="keywordflow">if</span> (version == 0xffff) {  <span class="comment">// Convert bogus version to valid number</span>
04736             version = 1;
04737         }
04738 
04739         <span class="comment">//</span>
04740         <span class="comment">// We use Version field to store number of BootConfig found.</span>
04741         <span class="comment">// Count field to store new number of descriptor in the alternative list.</span>
04742         <span class="comment">//</span>
04743 
04744         ioResourceList-&gt;Version = 0;
04745         oldCount = ioResourceList-&gt;Count;
04746 
04747         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04748         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
04749 
04750         <span class="keywordflow">if</span> (ioResourceDescriptor == ioResourceDescriptorEnd) {
04751 
04752             <span class="comment">//</span>
04753             <span class="comment">// An alternative list with zero descriptor count</span>
04754             <span class="comment">//</span>
04755 
04756             ioResourceList-&gt;Version = 0xffff;  <span class="comment">// Mark it as invalid</span>
04757             ioList-&gt;AlternativeLists--;
04758             <span class="keywordflow">continue</span>;
04759         }
04760 
04761         exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04762 
04763         <span class="comment">//</span>
04764         <span class="comment">// For each Cm Resource descriptor ... except DevicePrivate and</span>
04765         <span class="comment">// DeviceSpecific...</span>
04766         <span class="comment">//</span>
04767 
04768         cmFullDesc = &amp;CmList-&gt;List[0];
04769         <span class="keywordflow">for</span> (i = 0; i &lt; CmList-&gt;Count; i++) {
04770             cmDescriptor = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04771             <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04772                 size = 0;
04773                 <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04774                 <span class="keywordflow">case</span> CmResourceTypeDevicePrivate:
04775                      <span class="keywordflow">break</span>;
04776                 <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04777                      size = cmDescriptor-&gt;u.DeviceSpecificData.DataSize;
04778                      <span class="keywordflow">break</span>;
04779                 <span class="keywordflow">default</span>:
04780                     <span class="keywordflow">if</span> (cmDescriptor-&gt;Type == CmResourceTypeNull ||
04781                         cmDescriptor-&gt;Type &gt;= CmResourceTypeMaximum) {
04782                         <span class="keywordflow">break</span>;
04783                     }
04784 
04785                     <span class="comment">//</span>
04786                     <span class="comment">// Check CmDescriptor against current Io Alternative list</span>
04787                     <span class="comment">//</span>
04788 
04789                     <span class="keywordflow">for</span> (phase = 0; phase &lt; 2; phase++) {
04790                         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04791                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04792                             <span class="keywordflow">if</span> ((ioResourceDescriptor-&gt;Type == cmDescriptor-&gt;Type) &amp;&amp;
04793                                 (ioResourceDescriptor-&gt;Spare1 == 0)) {
04794                                 ULONGLONG min1, max1, min2, max2;
04795                                 ULONG len1 = 1, len2 = 1, align1, align2;
04796                                 UCHAR share1, share2;
04797 
04798                                 share2 = ioResourceDescriptor-&gt;ShareDisposition;
04799                                 share1 = cmDescriptor-&gt;ShareDisposition;
04800                                 <span class="keywordflow">if</span> ((share1 == CmResourceShareUndetermined) ||
04801                                     (share1 &gt; CmResourceShareShared)) {
04802                                     share1 = share2;
04803                                 }
04804                                 <span class="keywordflow">if</span> ((share2 == CmResourceShareUndetermined) ||
04805                                     (share2 &gt; CmResourceShareShared)) {
04806                                     share2 = share1;
04807                                 }
04808                                 align1 = align2 = 1;
04809 
04810                                 <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04811                                 <span class="keywordflow">case</span> CmResourceTypePort:
04812                                 <span class="keywordflow">case</span> CmResourceTypeMemory:
04813                                     min1 = cmDescriptor-&gt;u.Port.Start.QuadPart;
04814                                     max1 = cmDescriptor-&gt;u.Port.Start.QuadPart + cmDescriptor-&gt;u.Port.Length - 1;
04815                                     len1 = cmDescriptor-&gt;u.Port.Length;
04816                                     min2 = ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart;
04817                                     max2 = ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart;
04818                                     len2 = ioResourceDescriptor-&gt;u.Port.Length;
04819                                     align2 = ioResourceDescriptor-&gt;u.Port.Alignment;
04820                                     <span class="keywordflow">break</span>;
04821                                 <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04822                                     max1 = min1 = cmDescriptor-&gt;u.Interrupt.Vector;
04823                                     min2 = ioResourceDescriptor-&gt;u.Interrupt.MinimumVector;
04824                                     max2 = ioResourceDescriptor-&gt;u.Interrupt.MaximumVector;
04825                                     <span class="keywordflow">break</span>;
04826                                 <span class="keywordflow">case</span> CmResourceTypeDma:
04827                                     min1 = max1 =cmDescriptor-&gt;u.Dma.Channel;
04828                                     min2 = ioResourceDescriptor-&gt;u.Dma.MinimumChannel;
04829                                     max2 = ioResourceDescriptor-&gt;u.Dma.MaximumChannel;
04830                                     <span class="keywordflow">break</span>;
04831                                 <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04832                                     min1 = cmDescriptor-&gt;u.BusNumber.Start;
04833                                     max1 = cmDescriptor-&gt;u.BusNumber.Start + cmDescriptor-&gt;u.BusNumber.Length - 1;
04834                                     len1 = cmDescriptor-&gt;u.BusNumber.Length;
04835                                     min2 = ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber;
04836                                     max2 = ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber;
04837                                     len2 = ioResourceDescriptor-&gt;u.BusNumber.Length;
04838                                     <span class="keywordflow">break</span>;
04839                                 <span class="keywordflow">default</span>:
04840                                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
04841                                     <span class="keywordflow">break</span>;
04842                                 }
04843                                 <span class="keywordflow">if</span> (phase == 0) {
04844                                     <span class="keywordflow">if</span> (share1 == share2 &amp;&amp; min2 == min1 &amp;&amp; max2 &gt;= max1 &amp;&amp; len2 &gt;= len1) {
04845 
04846                                         <span class="comment">//</span>
04847                                         <span class="comment">// For phase 0 match, we want near exact match...</span>
04848                                         <span class="comment">//</span>
04849 
04850                                         <span class="keywordflow">if</span> (max2 != max1) {
04851                                             exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04852                                         }
04853                                         ioResourceList-&gt;Version++;
04854                                         ioResourceDescriptor-&gt;Spare1 = 0x80;
04855                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04856                                             PIO_RESOURCE_DESCRIPTOR ioDesc;
04857 
04858                                             ioDesc = ioResourceDescriptor;
04859                                             ioDesc--;
04860                                             <span class="keywordflow">while</span> (ioDesc &gt;= ioResourceList-&gt;Descriptors) {
04861                                                 ioDesc-&gt;Type = CmResourceTypeNull;
04862                                                 ioResourceList-&gt;Count--;
04863                                                 <span class="keywordflow">if</span> (ioDesc-&gt;Option == IO_RESOURCE_ALTERNATIVE) {
04864                                                     ioDesc--;
04865                                                 } <span class="keywordflow">else</span> {
04866                                                     <span class="keywordflow">break</span>;
04867                                                 }
04868                                             }
04869                                         }
04870                                         ioResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
04871                                         ioResourceDescriptor-&gt;Flags = cmDescriptor-&gt;Flags;
04872                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type == CmResourceTypePort ||
04873                                             ioResourceDescriptor-&gt;Type == CmResourceTypeMemory) {
04874                                             ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart = min1;
04875                                             ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart = min1 + len2 - 1;
04876                                             ioResourceDescriptor-&gt;u.Port.Alignment = 1;
04877                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type == CmResourceTypeBusNumber) {
04878                                             ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber = (ULONG)min1;
04879                                             ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber = (ULONG)(min1 + len2 - 1);
04880                                         }
04881                                         ioResourceDescriptor++;
04882                                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04883                                             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04884                                                 ioResourceDescriptor-&gt;Type = CmResourceTypeNull;
04885                                                 ioResourceDescriptor++;
04886                                                 ioResourceList-&gt;Count--;
04887                                             } <span class="keywordflow">else</span> {
04888                                                 <span class="keywordflow">break</span>;
04889                                             }
04890                                         }
04891                                         phase = 1;   <span class="comment">// skip phase 1</span>
04892                                         <span class="keywordflow">break</span>;
04893                                     } <span class="keywordflow">else</span> {
04894                                         ioResourceDescriptor++;
04895                                     }
04896                                 } <span class="keywordflow">else</span> {
04897                                     exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04898                                     <span class="keywordflow">if</span> (share1 == share2 &amp;&amp; min2 &lt;= min1 &amp;&amp; max2 &gt;= max1 &amp;&amp; len2 &gt;= len1 &amp;&amp;
04899                                         (min1 &amp; (align2 - 1)) == 0) {
04900 
04901                                         <span class="comment">//</span>
04902                                         <span class="comment">// Io range covers Cm range ... Change the Io range to what is specified</span>
04903                                         <span class="comment">// in BootConfig.</span>
04904                                         <span class="comment">//</span>
04905                                         <span class="comment">//</span>
04906 
04907                                         <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04908                                         <span class="keywordflow">case</span> CmResourceTypePort:
04909                                         <span class="keywordflow">case</span> CmResourceTypeMemory:
04910                                             ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart = min1;
04911                                             ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart = min1 + len2 - 1;
04912                                             <span class="keywordflow">break</span>;
04913                                         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04914                                         <span class="keywordflow">case</span> CmResourceTypeDma:
04915                                             ioResourceDescriptor-&gt;u.Interrupt.MinimumVector = (ULONG)min1;
04916                                             ioResourceDescriptor-&gt;u.Interrupt.MaximumVector = (ULONG)max1;
04917                                             <span class="keywordflow">break</span>;
04918                                         <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04919                                             ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber = (ULONG)min1;
04920                                             ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber = (ULONG)(min1 + len2 - 1);
04921                                             <span class="keywordflow">break</span>;
04922                                         }
04923                                         ioResourceList-&gt;Version++;
04924                                         ioResourceDescriptor-&gt;Spare1 = 0x80;
04925                                         ioResourceDescriptor-&gt;Flags = cmDescriptor-&gt;Flags;
04926                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04927                                             PIO_RESOURCE_DESCRIPTOR ioDesc;
04928 
04929                                             ioDesc = ioResourceDescriptor;
04930                                             ioDesc--;
04931                                             <span class="keywordflow">while</span> (ioDesc &gt;= ioResourceList-&gt;Descriptors) {
04932                                                 ioDesc-&gt;Type = CmResourceTypeNull;
04933                                                 ioResourceList-&gt;Count--;
04934                                                 <span class="keywordflow">if</span> (ioDesc-&gt;Option == IO_RESOURCE_ALTERNATIVE) {
04935                                                     ioDesc--;
04936                                                 } <span class="keywordflow">else</span> {
04937                                                     <span class="keywordflow">break</span>;
04938                                                 }
04939                                             }
04940                                         }
04941                                         ioResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
04942                                         ioResourceDescriptor++;
04943                                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04944                                             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04945                                                 ioResourceDescriptor-&gt;Type = CmResourceTypeNull;
04946                                                 ioResourceList-&gt;Count--;
04947                                                 ioResourceDescriptor++;
04948                                             } <span class="keywordflow">else</span> {
04949                                                 <span class="keywordflow">break</span>;
04950                                             }
04951                                         }
04952                                         <span class="keywordflow">break</span>;
04953                                     } <span class="keywordflow">else</span> {
04954                                         ioResourceDescriptor++;
04955                                     }
04956                                 }
04957                             } <span class="keywordflow">else</span> {
04958                                 ioResourceDescriptor++;
04959                             }
04960                         } <span class="comment">// Don't add any instruction after this ...</span>
04961                     } <span class="comment">// phase</span>
04962                 } <span class="comment">// switch</span>
04963 
04964                 <span class="comment">//</span>
04965                 <span class="comment">// Move to next Cm Descriptor</span>
04966                 <span class="comment">//</span>
04967 
04968                 cmDescriptor++;
04969                 cmDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmDescriptor + size);
04970             }
04971 
04972             <span class="comment">//</span>
04973             <span class="comment">// Move to next Cm List</span>
04974             <span class="comment">//</span>
04975 
04976             cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmDescriptor;
04977         }
04978 
04979         <span class="keywordflow">if</span> (ioResourceList-&gt;Version != (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)cmDescriptorCount) {
04980 
04981             <span class="comment">//</span>
04982             <span class="comment">// If the current alternative list does not cover all the boot config</span>
04983             <span class="comment">// descriptors, make it as invalid.</span>
04984             <span class="comment">//</span>
04985 
04986             ioResourceList-&gt;Version = 0xffff;
04987             ioList-&gt;AlternativeLists--;
04988         } <span class="keywordflow">else</span> {
04989             <span class="keywordflow">if</span> ((ioResourceList-&gt;Count == cmDescriptorCount) ||
04990                 (ioResourceList-&gt;Count == (cmDescriptorCount + 1) &amp;&amp;
04991                  ioResourceList-&gt;Descriptors[0].Type == CmResourceTypeConfigData)) {
04992                 <span class="keywordflow">if</span> (selectedResourceList) {
04993                     ioResourceList-&gt;Version = 0xffff;
04994                     ioList-&gt;AlternativeLists--;
04995                 } <span class="keywordflow">else</span> {
04996                     selectedResourceList = ioResourceList;
04997                     ioResourceDescriptorCount += ioResourceList-&gt;Count;
04998                     ioResourceList-&gt;Version = version;
04999                     <span class="keywordflow">if</span> (exactMatch) {
05000                         *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05001                     }
05002                 }
05003             } <span class="keywordflow">else</span> {
05004                 ioResourceDescriptorCount += ioResourceList-&gt;Count;
05005                 ioResourceList-&gt;Version = version;
05006             }
05007         }
05008         ioResourceList-&gt;Count = oldCount;
05009 
05010         <span class="comment">//</span>
05011         <span class="comment">// Move to next Io alternative list.</span>
05012         <span class="comment">//</span>
05013 
05014         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
05015     }
05016 
05017     <span class="comment">//</span>
05018     <span class="comment">// If there is not any valid alternative, convert CmList to Io list.</span>
05019     <span class="comment">//</span>
05020 
05021     <span class="keywordflow">if</span> (ioList-&gt;AlternativeLists == 0) {
05022          *FilteredList = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, CmList, LCPRI_BOOTCONFIG);
05023         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
05024         <span class="keywordflow">return</span> STATUS_SUCCESS;
05025     }
05026 
05027     <span class="comment">//</span>
05028     <span class="comment">// we have finished filtering the resource requirements list.  Now allocate memory</span>
05029     <span class="comment">// and rebuild a new list.</span>
05030     <span class="comment">//</span>
05031 
05032     size = <span class="keyword">sizeof</span>(IO_RESOURCE_REQUIREMENTS_LIST) +
05033                <span class="keyword">sizeof</span>(IO_RESOURCE_LIST) * (ioList-&gt;AlternativeLists - 1) +
05034                <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR) * (ioResourceDescriptorCount);
05035     newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
05036     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05037         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
05038         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05039     }
05040 
05041     <span class="comment">//</span>
05042     <span class="comment">// Walk through the io resource requirements list and pick up any valid descriptor.</span>
05043     <span class="comment">//</span>
05044 
05045     newList-&gt;ListSize = size;
05046     newList-&gt;InterfaceType = CmList-&gt;List-&gt;InterfaceType;
05047     newList-&gt;BusNumber = CmList-&gt;List-&gt;BusNumber;
05048     newList-&gt;SlotNumber = ioList-&gt;SlotNumber;
05049     <span class="keywordflow">if</span> (ioList-&gt;AlternativeLists &gt; 1) {
05050         *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05051     }
05052     newList-&gt;AlternativeLists = ioList-&gt;AlternativeLists;
05053     ioResourceList = ioList-&gt;List;
05054     newIoResourceList = newList-&gt;List;
05055     <span class="keywordflow">while</span> (--alternativeLists &gt;= 0) {
05056         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
05057         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
05058         <span class="keywordflow">if</span> (ioResourceList-&gt;Version == 0xffff) {
05059             ioResourceList = (PIO_RESOURCE_LIST)ioResourceDescriptorEnd;
05060             <span class="keywordflow">continue</span>;
05061         }
05062         newIoResourceList-&gt;Version = ioResourceList-&gt;Version;
05063         newIoResourceList-&gt;Revision = ioResourceList-&gt;Revision;
05064 
05065         newIoResourceDescriptor = newIoResourceList-&gt;Descriptors;
05066         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type != CmResourceTypeConfigData) {
05067             newIoResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
05068             newIoResourceDescriptor-&gt;Type = CmResourceTypeConfigData;
05069             newIoResourceDescriptor-&gt;ShareDisposition = CmResourceShareShared;
05070             newIoResourceDescriptor-&gt;Flags = 0;
05071             newIoResourceDescriptor-&gt;Spare1 = 0;
05072             newIoResourceDescriptor-&gt;Spare2 = 0;
05073             newIoResourceDescriptor-&gt;u.ConfigData.Priority = LCPRI_BOOTCONFIG;
05074             configDataDescriptor = newIoResourceDescriptor;
05075             newIoResourceDescriptor++;
05076         } <span class="keywordflow">else</span> {
05077             newList-&gt;ListSize -= <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR);
05078             configDataDescriptor = newIoResourceDescriptor;
05079         }
05080 
05081         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
05082             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type != CmResourceTypeNull) {
05083                 *newIoResourceDescriptor = *ioResourceDescriptor;
05084                 newIoResourceDescriptor++;
05085             }
05086             ioResourceDescriptor++;
05087         }
05088         newIoResourceList-&gt;Count = (ULONG)(newIoResourceDescriptor - newIoResourceList-&gt;Descriptors);
05089 
05090         <span class="comment">//if (newIoResourceList-&gt;Count == (cmDescriptorCount + 1)) {</span>
05091         configDataDescriptor-&gt;u.ConfigData.Priority =  LCPRI_BOOTCONFIG;
05092         <span class="comment">//}</span>
05093 
05094         <span class="comment">//</span>
05095         <span class="comment">// Move to next Io alternative list.</span>
05096         <span class="comment">//</span>
05097 
05098         newIoResourceList = (PIO_RESOURCE_LIST) newIoResourceDescriptor;
05099         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
05100     }
05101     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((PUCHAR)newIoResourceList == ((PUCHAR)newList + newList-&gt;ListSize));
05102 
05103     *FilteredList = newList;
05104     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
05105     <span class="keywordflow">return</span> STATUS_SUCCESS;
05106 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a323" doxytag="pnpiop.h::IopFindBusDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> IopFindBusDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN INTERFACE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BusNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SlotNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06408">6408</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00269">DUMP_DETAIL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00050">InterfaceType</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06474">IopFindBusDeviceNodeInternal()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03933">IopChildToRootTranslation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06528">IopDuplicateDetection()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05757">IopReleaseResourcesInternal()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>.
<p>
<pre class="fragment"><div>06417                    :
06418 
06419     This routine finds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bus PDO which performs <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a46">translation</a> and arbitration <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06420     specified <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>, <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> and SlotNumber.
06421 
06422 Parameters:
06423 
06424     DeviceNode - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO to start our search
06425 
06426     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO's interface <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
06427 
06428     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO's bus number.
06429 
06430     SlotNumber - specified <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO's slot number (UNUSED).
06431 
06432 Return Value:
06433 
06434     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BUS PDO.
06435 
06436 --*/
06437 
06438 {
06439     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> busDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06440 
06441     UNREFERENCED_PARAMETER(SlotNumber);
06442 
06443     <span class="keywordflow">if</span> (DeviceNode &amp;&amp; <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> != InterfaceTypeUndefined) {
06444 
06445         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> == PNPBus) {
06446             <span class="comment">//</span>
06447             <span class="comment">// if we specified PnpBus as InterfaceType, we know nobody specifies such a bus</span>
06448             <span class="comment">// don't waste time looking for BusNumber because it doesn't exist</span>
06449             <span class="comment">//</span>
06450             busDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06451         } <span class="keywordflow">else</span> {
06452             <span class="comment">//</span>
06453             <span class="comment">// search for bus (recursive)</span>
06454             <span class="comment">//</span>
06455             busDeviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a55">IopFindBusDeviceNodeInternal</a>(DeviceNode, (InterfaceType == Eisa) ? Isa : InterfaceType, BusNumber);
06456         }
06457 
06458         <span class="keywordflow">if</span> (busDeviceNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; DeviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
06459 
06460             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"IopFindBusDeviceNode: Found %ws with interface=%08X &amp; bus=%08X\n"</span>, DeviceNode-&gt;InstancePath.Buffer, InterfaceType, BusNumber));
06461             <span class="keywordflow">return</span> DeviceNode;
06462         }
06463 
06464         <span class="keywordflow">if</span> (busDeviceNode) {
06465 
06466             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"IopFindBusDeviceNode: Found %ws with interface=%08X &amp; bus=%08X\n"</span>, busDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer, InterfaceType, BusNumber));
06467         }
06468     }
06469 
06470     <span class="keywordflow">return</span> busDeviceNode;
06471 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a376" doxytag="pnpiop.h::IopFixupDeviceId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopFixupDeviceId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PWCHAR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">IopCreateMadeupNode()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04559">IopFixupIds()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a270" doxytag="pnpiop.h::IopForAllChildDeviceNodes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopForAllChildDeviceNodes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Parent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a118">PENUM_CALLBACK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Callback</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/devnode_8c-source.html#l00179">179</a> of file <a class="el" href="../../d5/d6/devnode_8c-source.html">devnode.c</a>.
<p>
References <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/devnode_8c-source.html#l00127">IopForAllDeviceNodes()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00237">IopForAllDeviceNodesCallback()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01117">IopProcessAddDevicesWorker()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01328">IopProcessAssignResourcesWorker()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">IopProcessStartDevicesWorker()</a>.
<p>
<pre class="fragment"><div>00187                    :
00188 
00189     This function walks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Parent's device node subtree and perform caller specified
00190     'Callback' function <span class="keywordflow">for</span> each device node under Parent.
00191 
00192     Note, befor calling <span class="keyword">this</span> rotuine, callers must acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration mutex
00193     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 'Parent' device node to make sure its children won'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> go away unless <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00194     call tells them to.
00195 
00196 Arguments:
00197 
00198     Parent - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node whose subtree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be walked.
00199 
00200     Callback - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call back routine <span class="keywordflow">for</span> each device node.
00201 
00202     Context - Supplies a parameter/context <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback function.
00203 
00204 Return Value:
00205 
00206     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value.
00207 
00208 --*/
00209 
00210 {
00211     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> nextChild = Parent-&gt;Child;
00212     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> child;
00213     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00214 
00215     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00216 
00217     <span class="comment">//</span>
00218     <span class="comment">// Process siblings until we find the end of the sibling list or</span>
00219     <span class="comment">// the Callback() returns FALSE.  Set result = TRUE at the top of</span>
00220     <span class="comment">// the loop so that if there are no siblings we will return TRUE,</span>
00221     <span class="comment">// e.g. Keep Enumerating.</span>
00222     <span class="comment">//</span>
00223     <span class="comment">// Note, we need to find next child before calling Callback function</span>
00224     <span class="comment">// in case the current child is deleted by the Callback function.</span>
00225     <span class="comment">//</span>
00226 
00227     <span class="keywordflow">while</span> (nextChild &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00228         child = nextChild;
00229         nextChild = child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00230         status = Callback(child, Context);
00231     }
00232 
00233     <span class="keywordflow">return</span> status;
00234 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a253" doxytag="pnpiop.h::IopForAllDeviceNodes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopForAllDeviceNodes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a118">PENUM_CALLBACK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Callback</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/devnode_8c-source.html#l00127">127</a> of file <a class="el" href="../../d5/d6/devnode_8c-source.html">devnode.c</a>.
<p>
References <a class="el" href="../../d5/d6/devnode_8c-source.html#l00030">_ENUM_CONTEXT::CallersCallback</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00031">_ENUM_CONTEXT::CallersContext</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01266">IopAcquireEnumerationLock</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00179">IopForAllChildDeviceNodes()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00237">IopForAllDeviceNodesCallback()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01276">IopReleaseEnumerationLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00642">PENUM_CALLBACK</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05109">IopProcessNewProfileWorker()</a>.
<p>
<pre class="fragment"><div>00134                    :
00135 
00136     This function walks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node tree and perform caller specified
00137     'Callback' function <span class="keywordflow">for</span> each device node.
00138 
00139     Note, <span class="keyword">this</span> routine (or its worker routine) traverses <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree in a top
00140     down manner.
00141 
00142 Arguments:
00143 
00144     Callback - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call back routine <span class="keywordflow">for</span> each device node.
00145 
00146     Context - Supplies a parameter/context <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback function.
00147 
00148 Return Value:
00149 
00150     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> returned from Callback, <span class="keywordflow">if</span> not successfull then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree walking stops.
00151 
00152 --*/
00153 {
00154     <a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html">ENUM_CONTEXT</a> enumContext;
00155     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00156 
00157     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00158 
00159     enumContext.<a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html#o0">CallersCallback</a> = Callback;
00160     enumContext.<a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html#o1">CallersContext</a> = Context;
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// Start with a pointer to the root device node, recursively examine all the</span>
00164     <span class="comment">// children until we the callback function says stop or we've looked at all</span>
00165     <span class="comment">// of them.</span>
00166     <span class="comment">//</span>
00167 
00168     <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(IopRootDeviceNode);
00169 
00170     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a270">IopForAllChildDeviceNodes</a>(IopRootDeviceNode,
00171                                        IopForAllDeviceNodesCallback,
00172                                        (PVOID)&amp;enumContext );
00173 
00174     <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(IopRootDeviceNode);
00175     <span class="keywordflow">return</span> status;
00176 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a374" doxytag="pnpiop.h::IopFreeAllocatedUnicodeString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeAllocatedUnicodeString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>String</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05668">5668</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04946">IoGetDeviceInterfaceAlias()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05137">IopBuildSymbolicLinkStrings()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04741">IopOpenOrCreateDeviceInterfaceSubKeys()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03762">IopProcessCriticalDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03929">IopRegisterDeviceInterface()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">IopRemoveDeviceInterfaces()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05714">IopSetRegistryStringValue()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04140">IopUnregisterDeviceInterface()</a>.
<p>
<pre class="fragment"><div>05674                    :
05675 
05676     This routine frees a string previously allocated with <a class="code" href="../../d8/d0/pnpioapi_8c.html#a94">IopAllocateUnicodeString</a>.
05677 
05678 Parameters:
05679 
05680     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string that has been previously allocated.
05681 
05682 Return Value:
05683 
05684     None
05685 
05686 --*/
05687 
05688 {
05689     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05690 
05691     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(String);
05692 
05693     <span class="comment">//</span>
05694     <span class="comment">// If we have a buffer free it</span>
05695     <span class="comment">//</span>
05696 
05697     <span class="keywordflow">if</span>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer) {
05698 
05699         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer);
05700 
05701     }
05702 
05703     <span class="comment">//</span>
05704     <span class="comment">// Blank out the string</span>
05705     <span class="comment">//</span>
05706 
05707     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05708     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length = 0;
05709     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;MaximumLength = 0;
05710 
05711 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a372" doxytag="pnpiop.h::IopFreeBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d5/struct__BUFFER__INFO.html">PBUFFER_INFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Info</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02536">2536</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02707">IopGetDeviceInterfaces()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04000">IopProcessCriticalDeviceRoutine()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">IopRemoveDeviceInterfaces()</a>.
<p>
<pre class="fragment"><div>02542                    :
02543 
02544     Frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer associated with Info and resets all Info fields
02545 
02546 Parameters:
02547 
02548     Info - Pointer to a buffer info structure to be used to manage <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer
02549 
02550 Return Value:
02551 
02552     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
02553 
02554 --*/
02555 
02556 {
02557     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Info);
02558 
02559     <span class="comment">//</span>
02560     <span class="comment">// Free the buffer</span>
02561     <span class="comment">//</span>
02562 
02563     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Info-&gt;Buffer);
02564 
02565     <span class="comment">//</span>
02566     <span class="comment">// Zero out the info parameters so we can't accidently used the free buffer</span>
02567     <span class="comment">//</span>
02568 
02569     Info-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02570     Info-&gt;Current = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02571     Info-&gt;MaxSize = 0;
02572 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a246" doxytag="pnpiop.h::IopFreeUnicodeStringList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeUnicodeStringList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeStringList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StringCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02740">2740</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, and <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05334">IopGetGroupOrderIndex()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02080">IopRegMultiSzToUnicodeStrings()</a>.
<p>
<pre class="fragment"><div>02747                    :
02748 
02749     This routine frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer <span class="keywordflow">for</span> each UNICODE_STRING in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified list
02750     (there are StringCount of them), and then frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory used <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02751     string list itself.
02752 
02753 Arguments:
02754 
02755     UnicodeStringList - Supplies a pointer to an array of UNICODE_STRINGs.
02756 
02757     StringCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of strings in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UnicodeStringList array.
02758 
02759 Returns:
02760 
02761     None.
02762 
02763 --*/
02764 
02765 {
02766     ULONG i;
02767 
02768     <span class="keywordflow">if</span>(UnicodeStringList) {
02769         <span class="keywordflow">for</span>(i = 0; i &lt; StringCount; i++) {
02770             <span class="keywordflow">if</span>(UnicodeStringList[i].Buffer) {
02771                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(UnicodeStringList[i].Buffer);
02772             }
02773         }
02774         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(UnicodeStringList);
02775     }
02776 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a240" doxytag="pnpiop.h::IopGetDeviceInstanceCsConfigFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetDeviceInstanceCsConfigFlags           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceInstance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CsConfigFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01477">1477</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
<pre class="fragment"><div>01484                    :
01485 
01486     This routine retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> csconfig flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.
01487 
01488 Arguments:
01489 
01490     DeviceInstance - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devnode's instance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>
01491 
01492     CsConfigFlags - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's CsConfigFlags
01493 
01494 Return Value:
01495 
01496     status
01497 
01498 --*/
01499 
01500 {
01501     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01502     HANDLE handle1, handle2;
01503     UNICODE_STRING tempUnicodeString;
01504     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01505 
01506     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01507 
01508     *CsConfigFlags = 0;
01509 
01510     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
01511                                    NULL,
01512                                    &amp;CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent,
01513                                    KEY_READ
01514                                    );
01515 
01516     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01517 
01518         <span class="keywordflow">return</span> status;
01519     }
01520 
01521     <span class="comment">//</span>
01522     <span class="comment">// Now, we must open the System\CCS\Enum key under this.</span>
01523     <span class="comment">//</span>
01524     <span class="comment">//</span>
01525     <span class="comment">// Open system\CurrentControlSet under current hardware profile key</span>
01526     <span class="comment">//</span>
01527 
01528     PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_PATH_CURRENTCONTROLSET);
01529     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle2,
01530                                    handle1,
01531                                    &amp;tempUnicodeString,
01532                                    KEY_READ
01533                                    );
01534     ZwClose(handle1);
01535 
01536     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01537 
01538         <span class="keywordflow">return</span> status;
01539     }
01540 
01541     PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_KEY_ENUM);
01542 
01543     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
01544                                    handle2,
01545                                    &amp;tempUnicodeString,
01546                                    KEY_READ
01547                                    );
01548 
01549     ZwClose(handle2);
01550 
01551     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01552 
01553         <span class="keywordflow">return</span> status;
01554     }
01555 
01556 
01557     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle2,
01558                                    handle1,
01559                                    DeviceInstance,
01560                                    KEY_READ
01561                                    );
01562 
01563     ZwClose(handle1);
01564 
01565     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01566 
01567         <span class="keywordflow">return</span> status;
01568     }
01569 
01570 
01571     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( handle2,
01572                                   REGSTR_VALUE_CSCONFIG_FLAGS,
01573                                   &amp;keyValueInformation
01574                                   );
01575 
01576     ZwClose(handle2);
01577 
01578     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01579         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
01580             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
01581 
01582             *CsConfigFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01583         }
01584         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01585     }
01586 
01587     <span class="keywordflow">return</span> status;
01588 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a355" doxytag="pnpiop.h::IopGetDeviceInterfaces" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetDeviceInterfaces           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN CONST GUID *&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceClassGuid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING DevicePath&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UserModeFormat</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PWSTR *&nbsp;</td>
          <td class="mdname" nowrap> <em>SymbolicLinkList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG SymbolicLinkListSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02707">2707</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02394">_BUFFER_INFO::Buffer</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02400">_BUFFER_INFO::Current</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00444">DEVICE_INTERFACE_INCLUDE_NONACTIVE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00139">INITIAL_DEVNODE_NAME_BUFFER_SIZE</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00129">INITIAL_INFO_BUFFER_SIZE</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00133">INITIAL_RETURN_BUFFER_SIZE</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00131">INITIAL_SYMLINK_BUFFER_SIZE</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02427">IopAllocateBuffer()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02575">IopAppendBuffer()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02536">IopFreeBuffer()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04741">IopOpenOrCreateDeviceInterfaceSubKeys()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02467">IopResizeBuffer()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00162">KERNEL_SYMLINK_STRING_PREFIX</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00163">KERNEL_SYMLINK_STRING_PREFIX_LENGTH</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02406">_BUFFER_INFO::MaxSize</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01520">RtlCompareUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d2/d6/guid_8c-source.html#l00051">RtlStringFromGUID()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03419">IoGetDeviceInterfaces()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">IopRemoveDeviceInterfaces()</a>.
<p>
<pre class="fragment"><div>02718                    :
02719 
02720     This API allows a WDM driver to get a list of paths that represent all
02721     devices registered <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified interface <span class="keyword">class</span>.
02722 
02723 Parameters:
02724 
02725     InterfaceClassGuid - Supplies a pointer to a GUID representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface <span class="keyword">class</span>
02726 <span class="keyword">        </span>for whom a list of members <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be retrieved
02727 
02728     DevicePath - Optionally, supplies a pointer to a unicode string containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02729         enumeration <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> for a device for whom interfaces of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified class are
02730         to be re-trieved.  If this parameter  <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not supplied, then all interface
02731         devices (regardless of what physical device exposes them) will be returned.
02732 
02733     Flags - Supplies flags that modify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> behavior of list retrieval.
02734         The following flags are presently defined:
02735 
02736         <a class="code" href="../../d6/d9/pnp_8h.html#a5">DEVICE_INTERFACE_INCLUDE_NONACTIVE</a> -- If this flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, then all
02737             interface devices, whether currently active or not, will be returned
02738             (potentially filtered based on the Physi-calDeviceObject, if specified).
02739 
02740     UserModeFormat - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> multi-sz returned will have user mode prefixes
02741         (\\?\) otherwise they will have kernel mode prefixes (\??\).
02742 
02743     SymbolicLinkList - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a character pointer, that on
02744         success will contain a multi-sz list of \??\ symbolic link
02745         names that provide <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested functionality.  The caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02746         responsible for freeing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory via <a class="code" href="../../d6/d3/cmwraper_8c.html#a26">ExFreePool</a>.
02747 
02748 Return Value:
02749 
02750     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
02751 
02752 --*/
02753 
02754 {
02755     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02756     UNICODE_STRING guidString, tempString, defaultString, symLinkString, devnodeString;
02757     <a class="code" href="../../d4/d5/struct__BUFFER__INFO.html">BUFFER_INFO</a> returnBuffer, infoBuffer, symLinkBuffer, devnodeNameBuffer;
02758     PKEY_VALUE_FULL_INFORMATION pDefaultInfo;
02759     ULONG tempLong, keyIndex, instanceKeyIndex, resultSize;
02760     HANDLE hDeviceClasses, hClass, hKey, hInstanceKey, hControl;
02761     BOOLEAN defaultPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02762 
02763     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02764 
02765     <span class="comment">//</span>
02766     <span class="comment">// Initialise out parameters</span>
02767     <span class="comment">//</span>
02768 
02769     *SymbolicLinkList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02770 
02771     <span class="comment">//</span>
02772     <span class="comment">// Convert the GUID into a string</span>
02773     <span class="comment">//</span>
02774 
02775     status = <a class="code" href="../../d1/d7/guid_8c.html#a2">RtlStringFromGUID</a>(InterfaceClassGuid, &amp;guidString);
02776     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02777         <span class="keywordflow">goto</span> finalClean;
02778     }
02779 
02780 <span class="preprocessor">#if DBG_GET_ASSOC</span>
02781 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Getting associations for class %wZ\n"</span>, &amp;guidString);
02782 <span class="preprocessor">#endif</span>
02783 <span class="preprocessor"></span>
02784     <span class="comment">//</span>
02785     <span class="comment">// Allocate initial buffers</span>
02786     <span class="comment">//</span>
02787 
02788     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a>(&amp;returnBuffer,
02789                                INITIAL_RETURN_BUFFER_SIZE
02790                                );
02791 
02792     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02793         <span class="keywordflow">goto</span> clean0;
02794     }
02795 
02796     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a>(&amp;infoBuffer,
02797                                INITIAL_INFO_BUFFER_SIZE
02798                                );
02799 
02800     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02801         <span class="keywordflow">goto</span> clean1;
02802     }
02803 
02804     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a>(&amp;symLinkBuffer,
02805                                INITIAL_SYMLINK_BUFFER_SIZE
02806                                );
02807 
02808     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02809         <span class="keywordflow">goto</span> clean2;
02810     }
02811 
02812     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a>(&amp;devnodeNameBuffer,
02813                                INITIAL_DEVNODE_NAME_BUFFER_SIZE
02814                                );
02815 
02816     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02817         <span class="keywordflow">goto</span> clean2a;
02818     }
02819 
02820     <span class="comment">//</span>
02821     <span class="comment">// Enter critical section and acquire a lock on the registry.  Both these</span>
02822     <span class="comment">// mechanisms are required to prevent deadlock in the case where an APC</span>
02823     <span class="comment">// routine calls this routine after the registry resource has been claimed</span>
02824     <span class="comment">// in this case it would wait blocking this thread so the registry would</span>
02825     <span class="comment">// never be released -&gt; deadlock.  Critical sectioning the registry manipulation</span>
02826     <span class="comment">// portion solves this problem</span>
02827     <span class="comment">//</span>
02828 
02829     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02830     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;PpRegistryDeviceResource, TRUE);
02831 
02832     <span class="comment">//</span>
02833     <span class="comment">// Open HKLM\System\CurrentControlSet\Control\DeviceClasses key</span>
02834     <span class="comment">//</span>
02835 
02836     PiWstrToUnicodeString(&amp;tempString, REGSTR_FULL_PATH_DEVICE_CLASSES);
02837     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;hDeviceClasses,
02838                                      NULL,
02839                                      &amp;tempString,
02840                                      KEY_ALL_ACCESS,
02841                                      REG_OPTION_NON_VOLATILE,
02842                                      NULL
02843                                      );
02844 
02845     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02846         <span class="keywordflow">goto</span> clean3;
02847     }
02848 
02849     <span class="comment">//</span>
02850     <span class="comment">// Open function class GUID key</span>
02851     <span class="comment">//</span>
02852 
02853     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hClass,
02854                                    hDeviceClasses,
02855                                    &amp;guidString,
02856                                    KEY_ALL_ACCESS
02857                                    );
02858     ZwClose(hDeviceClasses);
02859 
02860     <span class="keywordflow">if</span>(status == STATUS_OBJECT_NAME_NOT_FOUND || status == STATUS_OBJECT_PATH_NOT_FOUND) {
02861 
02862         <span class="comment">//</span>
02863         <span class="comment">// The path does not exist - return a single null character buffer</span>
02864         <span class="comment">//</span>
02865 
02866         status = STATUS_SUCCESS;
02867         <span class="keywordflow">goto</span> clean5;
02868     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02869         <span class="keywordflow">goto</span> clean3;
02870     }
02871 
02872     <span class="comment">//</span>
02873     <span class="comment">// Get the default value if it exists</span>
02874     <span class="comment">//</span>
02875 
02876     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hClass,
02877                                  REGSTR_VAL_DEFAULT,
02878                                  &amp;pDefaultInfo
02879                                  );
02880 
02881 
02882     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)
02883         &amp;&amp; pDefaultInfo-&gt;Type == REG_SZ
02884         &amp;&amp; pDefaultInfo-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(WCHAR)) {
02885 
02886         <span class="comment">//</span>
02887         <span class="comment">// We have a default - construct a counted string from the default</span>
02888         <span class="comment">//</span>
02889 
02890         defaultPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02891         defaultString.Buffer = (PWSTR) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(pDefaultInfo);
02892         defaultString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) pDefaultInfo-&gt;DataLength - <span class="keyword">sizeof</span>(UNICODE_NULL);
02893         defaultString.MaximumLength = defaultString.Length;
02894 
02895 <span class="preprocessor">#if DBG_GET_ASSOC</span>
02896 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Class default: %wZ\n"</span>, &amp;defaultString);
02897 <span class="preprocessor">#endif</span>
02898 <span class="preprocessor"></span>
02899         <span class="comment">//</span>
02900         <span class="comment">// Open the device interface instance key for the default name.</span>
02901         <span class="comment">//</span>
02902         status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a72">IopOpenOrCreateDeviceInterfaceSubKeys</a>(NULL,
02903                                                        NULL,
02904                                                        &amp;hKey,
02905                                                        NULL,
02906                                                        hClass,
02907                                                        &amp;defaultString,
02908                                                        KEY_READ,
02909                                                        FALSE
02910                                                       );
02911 
02912         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02913             defaultPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02914             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pDefaultInfo);
02915             <span class="comment">//</span>
02916             <span class="comment">// Continue with the call but ignore the invalid default entry</span>
02917             <span class="comment">//</span>
02918 <span class="preprocessor">#if DBG_GET_ASSOC</span>
02919 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"WDM Warning: Default entry for class %zW is invalid\n"</span>, &amp;guidString);
02920 <span class="preprocessor">#endif</span>
02921 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
02922 
02923             <span class="comment">//</span>
02924             <span class="comment">// If we are just supposed to return live interfaces, then make sure this default</span>
02925             <span class="comment">// interface is linked.</span>
02926             <span class="comment">//</span>
02927 
02928             <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d6/d9/pnp_8h.html#a5">DEVICE_INTERFACE_INCLUDE_NONACTIVE</a>)) {
02929 
02930                 defaultPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02931 
02932                 <span class="comment">//</span>
02933                 <span class="comment">// Open the control subkey</span>
02934                 <span class="comment">//</span>
02935 
02936                 PiWstrToUnicodeString(&amp;tempString, REGSTR_KEY_CONTROL);
02937                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hControl,
02938                                                hKey,
02939                                                &amp;tempString,
02940                                                KEY_ALL_ACCESS
02941                                                );
02942 
02943                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02944                     <span class="comment">//</span>
02945                     <span class="comment">// Get the linked value</span>
02946                     <span class="comment">//</span>
02947 
02948                     PiWstrToUnicodeString(&amp;tempString, REGSTR_VAL_LINKED);
02949                     status = ZwQueryValueKey(hControl,
02950                                              &amp;tempString,
02951                                              KeyValuePartialInformation,
02952                                              (PVOID) infoBuffer.Buffer,
02953                                              infoBuffer.MaxSize,
02954                                              &amp;resultSize
02955                                              );
02956 
02957                     ZwClose(hControl);
02958 
02959                     <span class="comment">//</span>
02960                     <span class="comment">// We don't need to check the buffer was big enough because it starts</span>
02961                     <span class="comment">// off that way and doesn't get any smaller!</span>
02962                     <span class="comment">//</span>
02963 
02964                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)
02965                         &amp;&amp; (((PKEY_VALUE_PARTIAL_INFORMATION)(infoBuffer.Buffer))-&gt;Type == REG_DWORD)
02966                         &amp;&amp; (((PKEY_VALUE_PARTIAL_INFORMATION)(infoBuffer.Buffer))-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG))) {
02967 
02968                         defaultPresent = *(PULONG)(((PKEY_VALUE_PARTIAL_INFORMATION)(infoBuffer.Buffer))-&gt;Data)
02969                                        ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02970                                        : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02971                     }
02972                 }
02973             }
02974 
02975             ZwClose(hKey);
02976 
02977             <span class="keywordflow">if</span>(defaultPresent) {
02978                 <span class="comment">//</span>
02979                 <span class="comment">// Add the default as the first entry in the return buffer and patch to usermode if necessary</span>
02980                 <span class="comment">//</span>
02981                 status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a59">IopAppendBuffer</a>(&amp;returnBuffer,
02982                                          defaultString.Buffer,
02983                                          defaultString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
02984                                         );
02985 
02986                 <span class="keywordflow">if</span> (!UserModeFormat) {
02987 
02988                     RtlCopyMemory(returnBuffer.Buffer,
02989                                   KERNEL_SYMLINK_STRING_PREFIX,
02990                                   KERNEL_SYMLINK_STRING_PREFIX_LENGTH
02991                                   );
02992                 }
02993 
02994             } <span class="keywordflow">else</span> {
02995                 <span class="comment">//</span>
02996                 <span class="comment">// The default device interface isn't active--free the memory for the name buffer now.</span>
02997                 <span class="comment">//</span>
02998                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pDefaultInfo);
02999             }
03000         }
03001 
03002     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND || status == STATUS_OBJECT_PATH_NOT_FOUND) {
03003         <span class="comment">//</span>
03004         <span class="comment">// Do nothing - there is no default</span>
03005         <span class="comment">//</span>
03006     } <span class="keywordflow">else</span> {
03007         <span class="comment">//</span>
03008         <span class="comment">// An unexpected error occured - clean up</span>
03009         <span class="comment">//</span>
03010         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03011 
03012             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pDefaultInfo);
03013             status = STATUS_UNSUCCESSFUL;
03014         }
03015 
03016         ZwClose(hClass);
03017         <span class="keywordflow">goto</span> clean4;
03018     }
03019 
03020     <span class="comment">//</span>
03021     <span class="comment">// Iterate through the subkeys under this interface class key.</span>
03022     <span class="comment">//</span>
03023 
03024     keyIndex = 0;
03025 
03026     <span class="keywordflow">while</span>((status = ZwEnumerateKey(hClass,
03027                                    keyIndex,
03028                                    KeyBasicInformation,
03029                                    (PVOID) infoBuffer.Buffer,
03030                                    infoBuffer.MaxSize,
03031                                    &amp;resultSize
03032                                    )) != STATUS_NO_MORE_ENTRIES)
03033     {
03034 
03035         <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL) {
03036 
03037             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(&amp;infoBuffer, resultSize, FALSE);
03038 
03039             <span class="keywordflow">continue</span>;
03040 
03041         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03042             ZwClose(hClass);
03043             <span class="keywordflow">goto</span> clean4;
03044         }
03045 
03046         <span class="comment">//</span>
03047         <span class="comment">// Open up this interface key.</span>
03048         <span class="comment">//</span>
03049         tempString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((PKEY_BASIC_INFORMATION)(infoBuffer.Buffer))-&gt;NameLength;
03050         tempString.MaximumLength = tempString.Length;
03051         tempString.Buffer = ((PKEY_BASIC_INFORMATION)(infoBuffer.Buffer))-&gt;Name;
03052 
03053 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03054 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Key %u enumerated %wZ\n"</span>, keyIndex, &amp;tempString);
03055 <span class="preprocessor">#endif</span>
03056 <span class="preprocessor"></span>
03057         <span class="comment">//</span>
03058         <span class="comment">// Open the associated key</span>
03059         <span class="comment">//</span>
03060 
03061         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hKey,
03062                                        hClass,
03063                                        &amp;tempString,
03064                                        KEY_READ
03065                                        );
03066 
03067         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03068             <span class="comment">//</span>
03069             <span class="comment">// For some reason we couldn't open this key--skip it and move on.</span>
03070             <span class="comment">//</span>
03071 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03072 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tCouldn't open interface key!\n"</span>);
03073 <span class="preprocessor">#endif</span>
03074 <span class="preprocessor"></span>            keyIndex++;
03075             <span class="keywordflow">continue</span>;
03076         }
03077 
03078         <span class="comment">//</span>
03079         <span class="comment">// If we're filtering on a particular PDO, then retrieve the owning device</span>
03080         <span class="comment">// instance name for this interface key, and make sure they match.</span>
03081         <span class="comment">//</span>
03082         PiWstrToUnicodeString(&amp;tempString, REGSTR_VAL_DEVICE_INSTANCE);
03083         <span class="keywordflow">while</span> ((status = ZwQueryValueKey(hKey,
03084                                          &amp;tempString,
03085                                          KeyValuePartialInformation,
03086                                          devnodeNameBuffer.Buffer,
03087                                          devnodeNameBuffer.MaxSize,
03088                                          &amp;resultSize
03089                                          )) == STATUS_BUFFER_TOO_SMALL ) {
03090 
03091             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(&amp;devnodeNameBuffer, resultSize, FALSE);
03092 
03093             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03094                 ZwClose(hKey);
03095                 ZwClose(hClass);
03096                 <span class="keywordflow">goto</span> clean4;
03097             }
03098         }
03099 
03100         <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)
03101               &amp;&amp; ((PKEY_VALUE_PARTIAL_INFORMATION)(devnodeNameBuffer.Buffer))-&gt;Type == REG_SZ
03102               &amp;&amp; ((PKEY_VALUE_PARTIAL_INFORMATION)(devnodeNameBuffer.Buffer))-&gt;DataLength &gt; <span class="keyword">sizeof</span>(WCHAR) ) ) {
03103 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03104 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tDevice instance entry corrupt\n"</span>);
03105 <span class="preprocessor">#endif</span>
03106 <span class="preprocessor"></span>            <span class="keywordflow">goto</span> CloseInterfaceKeyAndContinue;
03107         }
03108 
03109         <span class="comment">//</span>
03110         <span class="comment">// Build counted string</span>
03111         <span class="comment">//</span>
03112 
03113         devnodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((PKEY_VALUE_PARTIAL_INFORMATION)(devnodeNameBuffer.Buffer))-&gt;DataLength - <span class="keyword">sizeof</span>(UNICODE_NULL);
03114         devnodeString.MaximumLength = tempString.Length;
03115         devnodeString.Buffer = (PWSTR) ((PKEY_VALUE_PARTIAL_INFORMATION)(devnodeNameBuffer.Buffer))-&gt;Data;
03116 
03117         <span class="comment">//</span>
03118         <span class="comment">// Enumerate each interface instance subkey under this PDO's interface key.</span>
03119         <span class="comment">//</span>
03120         instanceKeyIndex = 0;
03121 
03122         <span class="keywordflow">while</span>((status = ZwEnumerateKey(hKey,
03123                                        instanceKeyIndex,
03124                                        KeyBasicInformation,
03125                                        (PVOID) infoBuffer.Buffer,
03126                                        infoBuffer.MaxSize,
03127                                        &amp;resultSize
03128                                        )) != STATUS_NO_MORE_ENTRIES)
03129         {
03130 
03131             <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL) {
03132 
03133                 status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(&amp;infoBuffer, resultSize, FALSE);
03134 
03135                 <span class="keywordflow">continue</span>;
03136 
03137             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03138                 ZwClose(hKey);
03139                 ZwClose(hClass);
03140                 <span class="keywordflow">goto</span> clean4;
03141             }
03142 
03143             <span class="comment">//</span>
03144             <span class="comment">// Open up this interface instance key.</span>
03145             <span class="comment">//</span>
03146             tempString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((PKEY_BASIC_INFORMATION)(infoBuffer.Buffer))-&gt;NameLength;
03147             tempString.MaximumLength = tempString.Length;
03148             tempString.Buffer = ((PKEY_BASIC_INFORMATION)(infoBuffer.Buffer))-&gt;Name;
03149 
03150 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03151 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Instance key %u enumerated %wZ\n"</span>, instanceKeyIndex, &amp;tempString);
03152 <span class="preprocessor">#endif</span>
03153 <span class="preprocessor"></span>
03154             <span class="comment">//</span>
03155             <span class="comment">// Open the associated key</span>
03156             <span class="comment">//</span>
03157 
03158             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hInstanceKey,
03159                                            hKey,
03160                                            &amp;tempString,
03161                                            KEY_READ
03162                                            );
03163 
03164             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03165                 <span class="comment">//</span>
03166                 <span class="comment">// For some reason we couldn't open this key--skip it and move on.</span>
03167                 <span class="comment">//</span>
03168 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03169 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tCouldn't open interface key!\n"</span>);
03170 <span class="preprocessor">#endif</span>
03171 <span class="preprocessor"></span>                instanceKeyIndex++;
03172                 <span class="keywordflow">continue</span>;
03173             }
03174 
03175             <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d6/d9/pnp_8h.html#a5">DEVICE_INTERFACE_INCLUDE_NONACTIVE</a>)) {
03176 
03177                 <span class="comment">//</span>
03178                 <span class="comment">// Open the control subkey</span>
03179                 <span class="comment">//</span>
03180 
03181                 PiWstrToUnicodeString(&amp;tempString, REGSTR_KEY_CONTROL);
03182                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hControl,
03183                                                hInstanceKey,
03184                                                &amp;tempString,
03185                                                KEY_READ
03186                                                );
03187 
03188                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03189 
03190                     <span class="comment">//</span>
03191                     <span class="comment">// We have no control subkey so can't be linked -</span>
03192                     <span class="comment">// continue enumerating the keys ignoring this one</span>
03193                     <span class="comment">//</span>
03194 
03195 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03196 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tNo control subkey\n"</span>);
03197 <span class="preprocessor">#endif</span>
03198 <span class="preprocessor"></span>                    <span class="keywordflow">goto</span> CloseInterfaceInstanceKeyAndContinue;
03199                 }
03200 
03201                 <span class="comment">//</span>
03202                 <span class="comment">// Get the linked value</span>
03203                 <span class="comment">//</span>
03204 
03205                 PiWstrToUnicodeString(&amp;tempString, REGSTR_VAL_LINKED);
03206                 status = ZwQueryValueKey(hControl,
03207                                          &amp;tempString,
03208                                          KeyValuePartialInformation,
03209                                          (PVOID) infoBuffer.Buffer,
03210                                          infoBuffer.MaxSize,
03211                                          &amp;resultSize
03212                                          );
03213 
03214                 ZwClose(hControl);
03215 
03216                 <span class="comment">//</span>
03217                 <span class="comment">// We don't need to check the buffer was big enough because it starts</span>
03218                 <span class="comment">// off that way and doesn't get any smaller!</span>
03219                 <span class="comment">//</span>
03220 
03221                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)
03222                     || (((PKEY_VALUE_PARTIAL_INFORMATION)(infoBuffer.Buffer))-&gt;Type != REG_DWORD)
03223                     || (((PKEY_VALUE_PARTIAL_INFORMATION)(infoBuffer.Buffer))-&gt;DataLength != <span class="keyword">sizeof</span>(ULONG))
03224                     || !*(PULONG)(((PKEY_VALUE_PARTIAL_INFORMATION)(infoBuffer.Buffer))-&gt;Data)) {
03225 
03226                     <span class="comment">//</span>
03227                     <span class="comment">// We are NOT linked so continue enumerating the keys ignoring this one</span>
03228                     <span class="comment">//</span>
03229 
03230 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03231 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tNot Linked\n"</span>);
03232 <span class="preprocessor">#endif</span>
03233 <span class="preprocessor"></span>                    <span class="keywordflow">goto</span> CloseInterfaceInstanceKeyAndContinue;
03234                 }
03235             }
03236 
03237             <span class="comment">//</span>
03238             <span class="comment">// Open the "SymbolicLink" value and place the information into the symLink buffer</span>
03239             <span class="comment">//</span>
03240 
03241             PiWstrToUnicodeString(&amp;tempString, REGSTR_VAL_SYMBOLIC_LINK);
03242             <span class="keywordflow">while</span> ((status = ZwQueryValueKey(hInstanceKey,
03243                                              &amp;tempString,
03244                                              KeyValuePartialInformation,
03245                                              symLinkBuffer.Buffer,
03246                                              symLinkBuffer.MaxSize,
03247                                              &amp;resultSize
03248                                              )) == STATUS_BUFFER_TOO_SMALL ) {
03249 
03250                 status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(&amp;symLinkBuffer, resultSize, FALSE);
03251 
03252                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03253                     ZwClose(hInstanceKey);
03254                     ZwClose(hKey);
03255                     ZwClose(hClass);
03256                     <span class="keywordflow">goto</span> clean4;
03257                 }
03258             }
03259 
03260             <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)
03261                 &amp;&amp; ((PKEY_VALUE_PARTIAL_INFORMATION)(symLinkBuffer.Buffer))-&gt;Type == REG_SZ
03262                 &amp;&amp; ((PKEY_VALUE_PARTIAL_INFORMATION)(symLinkBuffer.Buffer))-&gt;DataLength &gt; <span class="keyword">sizeof</span>(WCHAR) ) ) {
03263 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03264 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tSymbolic link entry corrupt\n"</span>);
03265 <span class="preprocessor">#endif</span>
03266 <span class="preprocessor"></span>                <span class="keywordflow">goto</span> CloseInterfaceInstanceKeyAndContinue;
03267             }
03268 
03269             <span class="comment">//</span>
03270             <span class="comment">// Build counted string from value data</span>
03271             <span class="comment">//</span>
03272 
03273             symLinkString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((PKEY_VALUE_PARTIAL_INFORMATION)(symLinkBuffer.Buffer))-&gt;DataLength - <span class="keyword">sizeof</span>(UNICODE_NULL);
03274             symLinkString.MaximumLength = symLinkString.Length;
03275             symLinkString.Buffer = (PWSTR) ((PKEY_VALUE_PARTIAL_INFORMATION)(symLinkBuffer.Buffer))-&gt;Data;
03276 
03277             <span class="comment">//</span>
03278             <span class="comment">// If we have a default, check this is not it</span>
03279             <span class="comment">//</span>
03280 
03281             <span class="keywordflow">if</span> (defaultPresent) {
03282 
03283                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(&amp;defaultString, &amp;symLinkString, TRUE) == 0) {
03284 
03285                     <span class="comment">//</span>
03286                     <span class="comment">// We have already added the default to the beginning of the buffer so skip it</span>
03287                     <span class="comment">//</span>
03288 
03289 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03290 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tDefault entry skipped\n"</span>);
03291 <span class="preprocessor">#endif</span>
03292 <span class="preprocessor"></span>                    <span class="keywordflow">goto</span> CloseInterfaceInstanceKeyAndContinue;
03293                 }
03294             }
03295 
03296             <span class="comment">//</span>
03297             <span class="comment">// If we are only returning interfaces for a particular PDO then check</span>
03298             <span class="comment">// this is from that PDO</span>
03299             <span class="comment">//</span>
03300             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DevicePath)) {
03301                 <span class="comment">//</span>
03302                 <span class="comment">// Check if it is from the same PDO</span>
03303                 <span class="comment">//</span>
03304                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(DevicePath, &amp;devnodeString, TRUE) != 0) {
03305                     <span class="comment">//</span>
03306                     <span class="comment">// If not then go onto the next key</span>
03307                     <span class="comment">//</span>
03308 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03309 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tNot from the correct PDO\n"</span>);
03310 <span class="preprocessor">#endif</span>
03311 <span class="preprocessor"></span>                    <span class="keywordflow">goto</span> CloseInterfaceInstanceKeyAndContinue;
03312                 }
03313             }
03314 
03315             <span class="comment">//</span>
03316             <span class="comment">// Copy the symLink string to the return buffer including the NULL termination</span>
03317             <span class="comment">//</span>
03318 
03319             status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a59">IopAppendBuffer</a>(&amp;returnBuffer,
03320                                      symLinkString.Buffer,
03321                                      symLinkString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
03322                                      );
03323 
03324             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((PWSTR) returnBuffer.Current)[-1] == UNICODE_NULL);
03325 
03326 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03327 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tAdded to return buffer\n"</span>);
03328 <span class="preprocessor">#endif</span>
03329 <span class="preprocessor"></span>
03330             <span class="comment">//</span>
03331             <span class="comment">// If we are returning KM strings then patch the prefix</span>
03332             <span class="comment">//</span>
03333 
03334             <span class="keywordflow">if</span> (!UserModeFormat) {
03335 
03336                 RtlCopyMemory(returnBuffer.Current - (symLinkString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL)),
03337                               KERNEL_SYMLINK_STRING_PREFIX,
03338                               KERNEL_SYMLINK_STRING_PREFIX_LENGTH
03339                               );
03340             }
03341 
03342 CloseInterfaceInstanceKeyAndContinue:
03343             ZwClose(hInstanceKey);
03344             instanceKeyIndex++;
03345         }
03346 
03347 CloseInterfaceKeyAndContinue:
03348         ZwClose(hKey);
03349         keyIndex++;
03350     }
03351 
03352     ZwClose(hClass);
03353 
03354 clean5:
03355     <span class="comment">//</span>
03356     <span class="comment">// We've got then all!  Resize to leave space for a terminating NULL.</span>
03357     <span class="comment">//</span>
03358 
03359     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(&amp;returnBuffer,
03360                              (ULONG) (returnBuffer.Current - returnBuffer.Buffer + <span class="keyword">sizeof</span>(UNICODE_NULL)),
03361                              TRUE
03362                              );
03363 
03364     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03365 
03366         <span class="comment">//</span>
03367         <span class="comment">// Terminate the buffer</span>
03368         <span class="comment">//</span>
03369         *((PWSTR) returnBuffer.Current) = UNICODE_NULL;
03370     }
03371 
03372 clean4:
03373     <span class="keywordflow">if</span> (defaultPresent) {
03374         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pDefaultInfo);
03375     }
03376 
03377 clean3:
03378     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
03379     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03380     <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;devnodeNameBuffer);
03381 
03382 clean2a:
03383     <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;symLinkBuffer);
03384 
03385 clean2:
03386     <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;infoBuffer);
03387 
03388 clean1:
03389     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03390         <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;returnBuffer);
03391     }
03392 
03393 clean0:
03394     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;guidString);
03395 
03396 finalClean:
03397     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03398 
03399         *SymbolicLinkList = (PWSTR) returnBuffer.Buffer;
03400 
03401         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SymbolicLinkListSize)) {
03402             *SymbolicLinkListSize = returnBuffer.MaxSize;
03403         }
03404 
03405     } <span class="keywordflow">else</span> {
03406 
03407         *SymbolicLinkList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03408 
03409         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SymbolicLinkListSize)) {
03410             *SymbolicLinkListSize = 0;
03411         }
03412 
03413     }
03414 
03415     <span class="keywordflow">return</span> status;
03416 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a277" doxytag="pnpiop.h::IopGetDeviceResourcesFromRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetDeviceResourcesFromRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Preference</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">4081</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04170">IopReadDeviceConfiguration()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00740">QUERY_RESOURCE_LIST</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00743">REGISTRY_ALLOC_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00747">REGISTRY_BASIC_CONFIGVECTOR</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00745">REGISTRY_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00744">REGISTRY_FORCED_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00746">REGISTRY_OVERRIDE_CONFIGVECTOR</a>, and <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>.
<p>
<pre class="fragment"><div>04091                    :
04092 
04093     This routine determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources decoded by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device specified.
04094     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a madeup device, we will <span class="keywordflow">try</span> to read <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources
04095     from registry.  Otherwise, we need to traverse <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> internal assigned resource
04096     list to compose <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource list.
04097 
04098 Arguments:
04099 
04100     DeviceObject - supplies a pointer to a device object whose registry
04101         values are to be cleaned up.
04102 
04103     ResourceType - 0 <span class="keywordflow">for</span> CM_RESOURCE_LIST and 1 <span class="keywordflow">for</span> IO_RESOURCE_REQUIREMENTS_LIS
04104 
04105     Flags - specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> preference.
04106 
04107     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Specified a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> required resources.
04108 
04109     Length - Specified a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource structure.
04110 
04111 Return Value:
04112 
04113     status
04114 
04115 --*/
04116 
04117 {
04118     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
04119     HANDLE handle, handlex;
04120     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04121     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04122     PCM_RESOURCE_LIST cmResource;
04123     PIO_RESOURCE_REQUIREMENTS_LIST ioResource;
04124     ULONG length;
04125     UNICODE_STRING unicodeName;
04126     PWCHAR valueName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04127 
04128     *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04129     *Length = 0;
04130 
04131     <span class="comment">//</span>
04132     <span class="comment">// Open the LogConfig key of the device instance.</span>
04133     <span class="comment">//</span>
04134 
04135     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceObject, &amp;handlex, KEY_READ);
04136     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04137         <span class="keywordflow">return</span> status;
04138     }
04139 
04140     <span class="keywordflow">if</span> (ResourceType == <a class="code" href="../../d9/d0/pnpiop_8h.html#a60">QUERY_RESOURCE_LIST</a>) {
04141 
04142         <span class="comment">//</span>
04143         <span class="comment">// Caller is asking for CM_RESOURCE_LIST</span>
04144         <span class="comment">//</span>
04145 
04146         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a62">REGISTRY_ALLOC_CONFIG</a>) {
04147 
04148             <span class="comment">//</span>
04149             <span class="comment">// Try alloc config first</span>
04150             <span class="comment">//</span>
04151 
04152             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
04153             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04154                                            handlex,
04155                                            &amp;unicodeName,
04156                                            KEY_READ
04157                                            );
04158             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04159                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (handle, REGISTRY_ALLOC_CONFIG, (PCM_RESOURCE_LIST *)Resource, Length);
04160                 ZwClose(handle);
04161                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04162                     ZwClose(handlex);
04163                     <span class="keywordflow">return</span> status;
04164                 }
04165             }
04166         }
04167 
04168         handle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04169         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a63">REGISTRY_FORCED_CONFIG</a>) {
04170 
04171             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04172             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04173                                            handlex,
04174                                            &amp;unicodeName,
04175                                            KEY_READ
04176                                            );
04177             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04178                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (handle, REGISTRY_FORCED_CONFIG, (PCM_RESOURCE_LIST *)Resource, Length);
04179                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04180                     ZwClose(handle);
04181                     ZwClose(handlex);
04182                     <span class="keywordflow">return</span> status;
04183                 }
04184             } <span class="keywordflow">else</span> {
04185                 ZwClose(handlex);
04186                 <span class="keywordflow">return</span> status;
04187             }
04188         }
04189         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a64">REGISTRY_BOOT_CONFIG</a>) {
04190 
04191             <span class="comment">//</span>
04192             <span class="comment">// Try alloc config first</span>
04193             <span class="comment">//</span>
04194 
04195             <span class="keywordflow">if</span> (handle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04196                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04197                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04198                                                handlex,
04199                                                &amp;unicodeName,
04200                                                KEY_READ
04201                                                );
04202                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04203                     ZwClose(handlex);
04204                     <span class="keywordflow">return</span> status;
04205                 }
04206             }
04207             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a>( handle,
04208                                                  REGISTRY_BOOT_CONFIG,
04209                                                  (PCM_RESOURCE_LIST *)Resource,
04210                                                  Length);
04211         }
04212         <span class="keywordflow">if</span> (handle) {
04213             ZwClose(handle);
04214         }
04215     } <span class="keywordflow">else</span> {
04216 
04217         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04218         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04219                                        handlex,
04220                                        &amp;unicodeName,
04221                                        KEY_READ
04222                                        );
04223         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04224 
04225             <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a65">REGISTRY_OVERRIDE_CONFIGVECTOR</a>) {
04226                 valueName = REGSTR_VALUE_OVERRIDE_CONFIG_VECTOR;
04227             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a66">REGISTRY_BASIC_CONFIGVECTOR</a>) {
04228                 valueName = REGSTR_VALUE_BASIC_CONFIG_VECTOR;
04229             }
04230             <span class="keywordflow">if</span> (valueName) {
04231 
04232                 <span class="comment">//</span>
04233                 <span class="comment">// Try to read device's configuration vector</span>
04234                 <span class="comment">//</span>
04235 
04236                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
04237                                               valueName,
04238                                               &amp;keyValueInformation);
04239                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04240 
04241                     <span class="comment">//</span>
04242                     <span class="comment">// Try to read what caller wants.</span>
04243                     <span class="comment">//</span>
04244 
04245                     <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_RESOURCE_REQUIREMENTS_LIST) &amp;&amp;
04246                         (keyValueInformation-&gt;DataLength != 0)) {
04247 
04248                         *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
04249                                                    keyValueInformation-&gt;DataLength);
04250                         <span class="keywordflow">if</span> (*Resource) {
04251                             PIO_RESOURCE_REQUIREMENTS_LIST ioResource;
04252 
04253                             *Length = keyValueInformation-&gt;DataLength;
04254                             RtlMoveMemory(*Resource,
04255                                           <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
04256                                           keyValueInformation-&gt;DataLength);
04257 
04258                             <span class="comment">//</span>
04259                             <span class="comment">// Process the io resource requirements list to change undefined</span>
04260                             <span class="comment">// interface type to our default type.</span>
04261                             <span class="comment">//</span>
04262 
04263                             ioResource = *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
04264                             <span class="keywordflow">if</span> (ioResource-&gt;InterfaceType == InterfaceTypeUndefined) {
04265                                 ioResource-&gt;BusNumber = 0;
04266                                 ioResource-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04267                             }
04268                         } <span class="keywordflow">else</span> {
04269                             status = STATUS_INVALID_PARAMETER_2;
04270                         }
04271                     }
04272                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04273                 }
04274             }
04275             ZwClose(handle);
04276         }
04277     }
04278     ZwClose(handlex);
04279     <span class="keywordflow">return</span> status;
04280 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a302" doxytag="pnpiop.h::IopGetGroupOrderIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> IopGetGroupOrderIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ServiceHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05334">5334</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02570">IopFreeUnicodeStringList()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01907">IopRegMultiSzToUnicodeStrings()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00671">NO_MORE_GROUP</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>05340                    :
05341 
05342     This routine reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key, finds its position in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05343     ServiceOrderList.  If ServiceHandle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> or unrecognized group value, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns
05344     a value with <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> group order + 1.
05345     <span class="keywordflow">if</span> any.
05346 
05347 Parameters:
05348 
05349     ServiceHandle - supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key.
05350 
05351 Return Value:
05352 
05353     group order index.
05354 
05355 --*/
05356 
05357 {
05358     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05359     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
05360     UNICODE_STRING *groupTable, group;
05361     HANDLE handle;
05362     ULONG count, index;
05363 
05364     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05365 
05366     <span class="comment">//</span>
05367     <span class="comment">// Open System\CurrentControlSet\Control\ServiceOrderList</span>
05368     <span class="comment">//</span>
05369 
05370     PiWstrToUnicodeString(&amp;group, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\ServiceGroupOrder"</span>);
05371     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
05372                                    NULL,
05373                                    &amp;group,
05374                                    KEY_READ
05375                                    );
05376 
05377     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
05378         <span class="keywordflow">return</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
05379     }
05380 
05381     <span class="comment">//</span>
05382     <span class="comment">// Read and build a unicode string array containing all the group names.</span>
05383     <span class="comment">//</span>
05384 
05385     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
05386                                   L<span class="stringliteral">"List"</span>,
05387                                   &amp;keyValueInformation);
05388     ZwClose(handle);
05389     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05390 
05391         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_MULTI_SZ) &amp;&amp;
05392             (keyValueInformation-&gt;DataLength != 0)) {
05393 
05394             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a13">IopRegMultiSzToUnicodeStrings</a>(keyValueInformation, &amp;groupTable, &amp;count);
05395         } <span class="keywordflow">else</span> {
05396             status = STATUS_UNSUCCESSFUL;
05397         }
05398         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05399     }
05400 
05401     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05402         <span class="keywordflow">return</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
05403     }
05404 
05405     <span class="keywordflow">if</span> (ServiceHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05406         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05407         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(count + 1);
05408     }
05409 
05410 
05411     <span class="comment">//</span>
05412     <span class="comment">// Read service key's Group value</span>
05413     <span class="comment">//</span>
05414 
05415     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (ServiceHandle,
05416                                   L<span class="stringliteral">"Group"</span>,
05417                                   &amp;keyValueInformation);
05418     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05419 
05420         <span class="comment">//</span>
05421         <span class="comment">// Try to read what caller wants.</span>
05422         <span class="comment">//</span>
05423 
05424         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_SZ) &amp;&amp;
05425             (keyValueInformation-&gt;DataLength != 0)) {
05426             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;group,
05427                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
05428                                            keyValueInformation-&gt;DataLength
05429                                            );
05430         }
05431     } <span class="keywordflow">else</span> {
05432 
05433         <span class="comment">//</span>
05434         <span class="comment">// If we failed to read the Group value, or no Group value...</span>
05435         <span class="comment">//</span>
05436 
05437         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05438         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)count;
05439     }
05440 
05441     index = 0;
05442     <span class="keywordflow">for</span> (index = 0; index &lt; count; index++) {
05443         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;group, &amp;groupTable[index], TRUE)) {
05444             <span class="keywordflow">break</span>;
05445         }
05446     }
05447     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05448     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05449     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)index;
05450 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a350" doxytag="pnpiop.h::IopGetRelatedTargetDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetRelatedTargetDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08036">8036</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01927">_DEVICE_RELATIONS::Count</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01378">_DRIVER_OBJECT::DriverExtension</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00168">IRP_MN_QUERY_DEVICE_RELATIONS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01928">_DEVICE_RELATIONS::Objects</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01337">_DRIVER_EXTENSION::ServiceKeyName</a>, and <a class="el" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08120">IoGetRelatedTargetDevice()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>.
<p>
<pre class="fragment"><div>08043                    :
08044 
08045     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a107">IopGetRelatedTargetDevice</a> retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object associated with
08046     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object and then sends a query device relations irp
08047     to that device object.
08048 
08049     NOTE: The PDO associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned device node has been referenced,
08050     and must be dereferenced when no longer needed.
08051 
08052 Arguments:
08053 
08054     FileObject - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
08055                  object that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query device relations irp.
08056 
08057     DeviceNode - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> related target device node.
08058 
08059 ReturnValue
08060 
08061     Returns an <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value.
08062 
08063 --*/
08064 
08065 {
08066     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
08067     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
08068     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
08069     <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> deviceRelations;
08070 
08071     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FileObject);
08072 
08073     <span class="comment">//</span>
08074     <span class="comment">// Retrieve the device object associated with this file handle.</span>
08075     <span class="comment">//</span>
08076 
08077     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>(FileObject);
08078     <span class="keywordflow">if</span> (!deviceObject) {
08079         <span class="keywordflow">return</span> STATUS_NO_SUCH_DEVICE;
08080     }
08081 
08082     <span class="comment">//</span>
08083     <span class="comment">// Query what the "actual" target device node should be for</span>
08084     <span class="comment">// this file object. Initialize the stack location to pass to</span>
08085     <span class="comment">// IopSynchronousCall() and then send the IRP to the device</span>
08086     <span class="comment">// object that's associated with the file handle.</span>
08087     <span class="comment">//</span>
08088 
08089     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
08090     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
08091     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a>;
08092     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceRelations.Type = <a class="code" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>;
08093     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a> = deviceObject;
08094     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
08095 
08096     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(deviceObject, &amp;irpSp, &amp;deviceRelations);
08097     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08098 <span class="preprocessor">#if 0</span>
08099 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PnpMgr: Contact dev owner for %WZ, which may not correctly support\n"</span>,
08100                  &amp;deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>);
08101         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        IRP_MN_QUERY_DEVICE_RELATIONS:TargetDeviceRelation\n"</span>);
08102         <span class="comment">//ASSERT(0);</span>
08103 <span class="preprocessor">#endif</span>
08104 <span class="preprocessor"></span>        <span class="keywordflow">return</span> status;
08105     }
08106 
08107     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceRelations);
08108     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o0">Count</a> == 1);
08109 
08110     *DeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o1">Objects</a>[0]-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
08111     <span class="keywordflow">if</span> (!*DeviceNode) {
08112         status = STATUS_NO_SUCH_DEVICE;
08113     }
08114 
08115     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceRelations);
08116     <span class="keywordflow">return</span> status;
08117 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a311" doxytag="pnpiop.h::IopGetRootDevices" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetRootDevices           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceRelations</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00680">680</a> of file <a class="el" href="../../d8/d9/pnpinit_8c-source.html">pnpinit.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00177">CmRegistryMachineSystemCurrentControlSetEnumRootName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01927">_DEVICE_RELATIONS::Count</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00046">_ROOT_ENUMERATOR_CONTEXT::DeviceCount</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00047">_ROOT_ENUMERATOR_CONTEXT::DeviceList</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00913">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01690">IopApplyFunctionToSubKeys()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00819">IopInitializeDeviceKey()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00044">_ROOT_ENUMERATOR_CONTEXT::KeyName</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00045">_ROOT_ENUMERATOR_CONTEXT::MaxDeviceCount</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01928">_DEVICE_RELATIONS::Objects</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01213">PDEVICE_OBJECT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00900">PNP_LARGE_SCRATCH_BUFFER_SIZE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00899">PNP_SCRATCH_BUFFER_SIZE</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00663">RtlAppendStringToString()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00043">_ROOT_ENUMERATOR_CONTEXT::Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>.
<p>
<pre class="fragment"><div>00686                    :
00687 
00688     This routine scans through System\Enum\Root subtree to build a device node <span class="keywordflow">for</span>
00689     each root device.
00690 
00691 Arguments:
00692 
00693     DeviceRelations - supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">DEVICE_RELATIONS</a> structure.
00694 
00695 Return Value:
00696 
00697     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00698 
00699 --*/
00700 
00701 {
00702     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00703     HANDLE baseHandle;
00704     UNICODE_STRING workName, tmpName;
00705     PVOID buffer;
00706     <a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">ROOT_ENUMERATOR_CONTEXT</a> context;
00707     ULONG i;
00708     <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> deviceRelations;
00709 
00710     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00711 
00712     *DeviceRelations = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00713     buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, PNP_LARGE_SCRATCH_BUFFER_SIZE);
00714     <span class="keywordflow">if</span> (!buffer) {
00715         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00716     }
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">// Allocate a buffer to store the PDOs enumerated.</span>
00720     <span class="comment">// Note, the the buffer turns out to be not big enough, it will be reallocated dynamically.</span>
00721     <span class="comment">//</span>
00722 
00723     context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a> = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, PNP_SCRATCH_BUFFER_SIZE * 2);
00724     <span class="keywordflow">if</span> (context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a>) {
00725         context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o2">MaxDeviceCount</a> = (<a class="code" href="../../d9/d0/pnpiop_8h.html#a86">PNP_SCRATCH_BUFFER_SIZE</a> * 2) / <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>);
00726         context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a> = 0;
00727     } <span class="keywordflow">else</span> {
00728         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
00729         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00730     }
00731 
00732     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00733     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;PpRegistryDeviceResource, TRUE);
00734 
00735     <span class="comment">//</span>
00736     <span class="comment">// Open System\CurrentControlSet\Enum\Root key and call worker routine to recursively</span>
00737     <span class="comment">// scan through the subkeys.</span>
00738     <span class="comment">//</span>
00739 
00740     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;baseHandle,
00741                                      NULL,
00742                                      &amp;CmRegistryMachineSystemCurrentControlSetEnumRootName,
00743                                      KEY_READ,
00744                                      REG_OPTION_NON_VOLATILE,
00745                                      NULL
00746                                      );
00747 
00748     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00749 
00750         workName.Buffer = (PWSTR)buffer;
00751         RtlFillMemory(buffer, PNP_LARGE_SCRATCH_BUFFER_SIZE, 0);
00752         workName.MaximumLength = <a class="code" href="../../d9/d0/pnpiop_8h.html#a87">PNP_LARGE_SCRATCH_BUFFER_SIZE</a>;
00753         workName.Length = 0;
00754 
00755         <span class="comment">//</span>
00756         <span class="comment">// only look at ROOT key</span>
00757         <span class="comment">//</span>
00758 
00759         PiWstrToUnicodeString(&amp;tmpName, REGSTR_KEY_ROOTENUM);
00760         <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;workName, (PSTRING)&amp;tmpName);
00761 
00762         <span class="comment">//</span>
00763         <span class="comment">// Enumerate all subkeys under the System\CCS\Enum\Root.</span>
00764         <span class="comment">//</span>
00765 
00766         context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o0">Status</a> = STATUS_SUCCESS;
00767         context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o1">KeyName</a> = &amp;workName;
00768 
00769         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a12">IopApplyFunctionToSubKeys</a>(baseHandle,
00770                                            NULL,
00771                                            KEY_ALL_ACCESS,
00772                                            FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS,
00773                                            IopInitializeDeviceKey,
00774                                            &amp;context
00775                                            );
00776         ZwClose(baseHandle);
00777 
00778         <span class="comment">//</span>
00779         <span class="comment">// Build returned information from ROOT_ENUMERATOR_CONTEXT.</span>
00780         <span class="comment">//</span>
00781 
00782 
00783         status = context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o0">Status</a>;
00784         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a> != 0) {
00785             deviceRelations = (<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00786                 PagedPool,
00787                 <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">DEVICE_RELATIONS</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) * context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a>
00788                 );
00789             <span class="keywordflow">if</span> (deviceRelations == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00790                 status = STATUS_INSUFFICIENT_RESOURCES;
00791             } <span class="keywordflow">else</span> {
00792                 deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o0">Count</a> = context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a>;
00793                 RtlMoveMemory(deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o1">Objects</a>,
00794                               context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a>,
00795                               sizeof (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) * context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a>);
00796                 *DeviceRelations = deviceRelations;
00797             }
00798         }
00799         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00800 
00801             <span class="comment">//</span>
00802             <span class="comment">// If somehow the enumeration failed, we need to derefernece all the</span>
00803             <span class="comment">// device objects.</span>
00804             <span class="comment">//</span>
00805 
00806             <span class="keywordflow">for</span> (i = 0; i &lt; context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a>; i++) {
00807                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a>[i]);
00808             }
00809         }
00810     }
00811     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
00812     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00813     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
00814     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a>);
00815     <span class="keywordflow">return</span> status;
00816 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a241" doxytag="pnpiop.h::IopGetServiceInstanceCsConfigFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetServiceInstanceCsConfigFlags           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Instance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CsConfigFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01591">1591</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01588">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>.
<p>
<pre class="fragment"><div>01599                    :
01600 
01601     This routine retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> csconfig flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device
01602     which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number under ServiceKeyName\Enum.
01603 
01604 Arguments:
01605 
01606     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01607         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
01608         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load.
01609 
01610     Instance - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance value under ServiceKeyName\Enum key
01611 
01612     CsConfigFlags - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's CsConfigFlags
01613 
01614 Return Value:
01615 
01616     status
01617 
01618 --*/
01619 
01620 {
01621     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01622     HANDLE handle;
01623     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01624 
01625     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01626 
01627     *CsConfigFlags = 0;
01628 
01629     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a11">IopOpenCurrentHwProfileDeviceInstanceKey</a>(&amp;handle,
01630                                                       ServiceKeyName,
01631                                                       Instance,
01632                                                       KEY_READ,
01633                                                       FALSE
01634                                                      );
01635     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01636         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
01637                                      REGSTR_VALUE_CSCONFIG_FLAGS,
01638                                      &amp;keyValueInformation
01639                                     );
01640         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01641             <span class="keywordflow">if</span>((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
01642                (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
01643                 *CsConfigFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01644             }
01645             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01646         }
01647         ZwClose(handle);
01648     }
01649     <span class="keywordflow">return</span> status;
01650 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a377" doxytag="pnpiop.h::IopHardwareProfileBeginTransition" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopHardwareProfileBeginTransition           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SubsumeExistingDeparture</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00103">103</a> of file <a class="el" href="../../d0/d0/dockhwp_8c-source.html">dockhwp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00035">ASSERT_SEMA_NOT_SIGNALLED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00076">IopDocksInTransition</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00074">IopProfileChangeSemaphore</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.
<p>
<pre class="fragment"><div>00108                    :
00109 
00110     This routine must be called before any dock devnodes can be marked <span class="keywordflow">for</span>
00111     transition (ie arriving or departing). After calling <span class="keyword">this</span> function,
00112     <a class="code" href="../../d9/d0/dockhwp_8c.html#a13">IopHardwareProfileMarkDock</a> should be called <span class="keywordflow">for</span> each dock that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> appearing
00113     or disappearing.
00114 
00115     Functionally, <span class="keyword">this</span> code acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile change semaphore. Future
00116     changes in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> life of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> added dock devnodes cause <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to be released.
00117 
00118 Arguments:
00119 
00120     SubsumeExistingDeparture - Set <span class="keywordflow">if</span> we are ejecting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent of a
00121                                device that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process of
00122                                ejecting...
00123 
00124 Return Value:
00125 
00126     None.
00127 
00128 --*/
00129 {
00130     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status ;
00131 
00132     <span class="keywordflow">if</span> (SubsumeExistingDeparture) {
00133 
00134         <span class="comment">//</span>
00135         <span class="comment">// We will already have queried in this case. Also, enumeration is</span>
00136         <span class="comment">// locked right now, so the appropriate devices found cannot disappear.</span>
00137         <span class="comment">// Assert everything is consistant.</span>
00138         <span class="comment">//</span>
00139         <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;IopProfileChangeSemaphore) ;
00140         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IopDocksInTransition != 0) ;
00141         <span class="keywordflow">return</span> ;
00142     }
00143 
00144     <span class="comment">//</span>
00145     <span class="comment">// Take the profile change semaphore. We do this whenever a dock is</span>
00146     <span class="comment">// in our list, even if no query is going to occur.</span>
00147     <span class="comment">//</span>
00148     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
00149         &amp;IopProfileChangeSemaphore,
00150         Executive,
00151         KernelMode,
00152         FALSE,
00153         NULL
00154         );
00155 
00156     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS) ;
00157 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a382" doxytag="pnpiop.h::IopHardwareProfileCancelRemovedDock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopHardwareProfileCancelRemovedDock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00572">572</a> of file <a class="el" href="../../d0/d0/dockhwp_8c-source.html">dockhwp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00035">ASSERT_SEMA_NOT_SIGNALLED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00073">IopDockDeviceListLock</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00076">IopDocksInTransition</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00827">IopHardwareProfileSendCancel()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00795">IopHardwareProfileSendCommit()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05034">IopProcessNewProfile()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00075">IopProfileChangeCancelRequired</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00074">IopProfileChangeSemaphore</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00862">IopUpdateHardwareProfile()</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, and <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>.
<p>
<pre class="fragment"><div>00577                    :
00578 
00579     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a dock that was marked to disappear didn'<a class="code" href="../../d5/d1/genppc_8c.html#a17">t</a> (ie,
00580     after the eject, the dock device still enumerated). We remove <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00581     transition list and complete/cancel <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a> profile change as appropriate.
00582     See <a class="code" href="../../d9/d0/dockhwp_8c.html#a19">IopHardwareProfileSetMarkedDocksEjected</a>.
00583 
00584 Arguments:
00585 
00586     DeviceNode - Supplies a pointer to a device node which will be started and
00587                  enumerated.
00588 
00589 Return Value:
00590 
00591     None.
00592 
00593 --*/
00594 {
00595     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00596     BOOLEAN  profileChanged ;
00597     LONG     remainingDockCount ;
00598 
00599     <span class="comment">//</span>
00600     <span class="comment">// Acquire the lock on the list of dock devices</span>
00601     <span class="comment">//</span>
00602     ExAcquireFastMutex(&amp;IopDockDeviceListLock);
00603 
00604     <span class="comment">//</span>
00605     <span class="comment">// Since we are about to remove this dock device from the list of</span>
00606     <span class="comment">// all dock devices present, the list should not be empty.</span>
00607     <span class="comment">//</span>
00608     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;IopProfileChangeSemaphore) ;
00609     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;DockInfo.DockStatus == DOCK_EJECTIRP_COMPLETED) ;
00610     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsListEmpty(&amp;DeviceNode-&gt;DockInfo.ListEntry)) ;
00611 
00612     DeviceNode-&gt;DockInfo.DockStatus = <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a> ;
00613     remainingDockCount = InterlockedDecrement(&amp;IopDocksInTransition) ;
00614     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(remainingDockCount &gt;= 0) ;
00615 
00616     <span class="comment">//</span>
00617     <span class="comment">// Release the lock on the list of dock devices</span>
00618     <span class="comment">//</span>
00619     ExReleaseFastMutex(&amp;IopDockDeviceListLock);
00620 
00621     <span class="keywordflow">if</span> (remainingDockCount) {
00622 
00623         <span class="keywordflow">return</span> ;
00624     }
00625 
00626     <span class="comment">//</span>
00627     <span class="comment">// Update the current Hardware Profile after removing this device.</span>
00628     <span class="comment">//</span>
00629     status = <a class="code" href="../../d9/d0/dockhwp_8c.html#a9">IopUpdateHardwareProfile</a>(&amp;profileChanged);
00630 
00631     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00632 
00633         <span class="comment">//</span>
00634         <span class="comment">// So we're there physically, but not mentally? Too bad, where broadcasting</span>
00635         <span class="comment">// change either way.</span>
00636         <span class="comment">//</span>
00637         PIDBGMSG(
00638             PIDBG_HWPROFILE,
00639             (<span class="stringliteral">"IopUpdateHardwareProfile failed with status == %lx\n"</span>, status)
00640             ) ;
00641         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) ;
00642     }
00643 
00644     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; profileChanged) {
00645 
00646         <a class="code" href="../../d9/d0/dockhwp_8c.html#a10">IopHardwareProfileSendCommit</a>() ;
00647         <a class="code" href="../../d9/d0/pnpiop_8h.html#a361">IopProcessNewProfile</a>();
00648 
00649     } <span class="keywordflow">else</span> {
00650 
00651         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IopProfileChangeCancelRequired) ;
00652         <a class="code" href="../../d9/d0/dockhwp_8c.html#a11">IopHardwareProfileSendCancel</a>() ;
00653     }
00654 
00655     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(
00656         &amp;IopProfileChangeSemaphore,
00657         IO_NO_INCREMENT,
00658         1,
00659         FALSE
00660         );
00661 
00662     <span class="keywordflow">return</span> ;
00663 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a383" doxytag="pnpiop.h::IopHardwareProfileCancelTransition" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopHardwareProfileCancelTransition           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00666">666</a> of file <a class="el" href="../../d0/d0/dockhwp_8c-source.html">dockhwp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00035">ASSERT_SEMA_NOT_SIGNALLED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o42">_DEVICE_NODE::DockInfo</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00071">IopDockDeviceListHead</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00073">IopDockDeviceListLock</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00076">IopDocksInTransition</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00827">IopHardwareProfileSendCancel()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00075">IopProfileChangeCancelRequired</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00074">IopProfileChangeSemaphore</a>, and <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.
<p>
<pre class="fragment"><div>00671                    :
00672 
00673     This routine unmarks any marked devnodes (ie, sets them to no change,
00674     appearing or disappearing), and sends <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CancelQueryProfileChange as
00675     appropriate. Once called, other profile changes can occur.
00676 
00677 Arguments:
00678 
00679     None.
00680 
00681 Return Value:
00682 
00683     Nodda.
00684 
00685 --*/
00686 {
00687     PLIST_ENTRY  listEntry;
00688     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNode;
00689 
00690     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;IopProfileChangeSemaphore) ;
00691 
00692     <span class="comment">//</span>
00693     <span class="comment">// Acquire the lock on the list of dock devices</span>
00694     <span class="comment">//</span>
00695     ExAcquireFastMutex(&amp;IopDockDeviceListLock);
00696 
00697     <span class="keywordflow">for</span> (listEntry  = <a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>.Flink;
00698         listEntry != &amp;(<a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>);
00699         listEntry  = listEntry-&gt;Flink ) {
00700 
00701         devNode = CONTAINING_RECORD(listEntry,
00702                                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a>,
00703                                     DockInfo.ListEntry);
00704 
00705         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus != DOCK_NOTDOCKDEVICE)&amp;&amp;
00706                (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus != DOCK_EJECTIRP_COMPLETED)) ;
00707         <span class="keywordflow">if</span> (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus != <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>) {
00708 
00709             InterlockedDecrement(&amp;IopDocksInTransition) ;
00710             devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus = <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a> ;
00711         }
00712     }
00713 
00714     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IopDocksInTransition) ;
00715 
00716     <span class="comment">//</span>
00717     <span class="comment">// Release the lock on the list of dock devices</span>
00718     <span class="comment">//</span>
00719     ExReleaseFastMutex(&amp;IopDockDeviceListLock);
00720 
00721     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/dockhwp_8c.html#a5">IopProfileChangeCancelRequired</a>) {
00722 
00723         <a class="code" href="../../d9/d0/dockhwp_8c.html#a11">IopHardwareProfileSendCancel</a>() ;
00724     }
00725 
00726     <span class="comment">//</span>
00727     <span class="comment">// No need to broadcast the cancels here, as IopQueryHardwareProfileChange</span>
00728     <span class="comment">// will have taken care of the cancels for us.</span>
00729     <span class="comment">//</span>
00730     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(
00731         &amp;IopProfileChangeSemaphore,
00732         IO_NO_INCREMENT,
00733         1,
00734         FALSE
00735         );
00736 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a381" doxytag="pnpiop.h::IopHardwareProfileCommitRemovedDock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopHardwareProfileCommitRemovedDock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00465">465</a> of file <a class="el" href="../../d0/d0/dockhwp_8c-source.html">dockhwp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00035">ASSERT_SEMA_NOT_SIGNALLED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a206">DOCK_DEPARTING</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00072">IopDockDeviceCount</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00073">IopDockDeviceListLock</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00076">IopDocksInTransition</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00827">IopHardwareProfileSendCancel()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00795">IopHardwareProfileSendCommit()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05034">IopProcessNewProfile()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00075">IopProfileChangeCancelRequired</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00074">IopProfileChangeSemaphore</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00862">IopUpdateHardwareProfile()</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>.
<p>
<pre class="fragment"><div>00470                    :
00471 
00472     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of current dock
00473     devices and requests a Hardware Profile change.
00474 
00475 Arguments:
00476 
00477     DeviceNode - Supplies a pointer to a device node which has been listed as
00478                  missing in a previous enumeration, has had <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> remove <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>
00479                  sent to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> about to be deleted.
00480 
00481 Return Value:
00482 
00483     None.
00484 
00485 --*/
00486 {
00487     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00488     BOOLEAN  profileChanged ;
00489     LONG     remainingDockCount ;
00490 
00491     <span class="comment">//</span>
00492     <span class="comment">// Acquire the lock on the list of dock devices</span>
00493     <span class="comment">//</span>
00494     ExAcquireFastMutex(&amp;IopDockDeviceListLock);
00495 
00496     <span class="comment">//</span>
00497     <span class="comment">// Since we are about to remove this dock device from the list of</span>
00498     <span class="comment">// all dock devices present, the list should not be empty.</span>
00499     <span class="comment">//</span>
00500     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;IopProfileChangeSemaphore) ;
00501     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((DeviceNode-&gt;DockInfo.DockStatus == DOCK_DEPARTING)||
00502            (DeviceNode-&gt;DockInfo.DockStatus == DOCK_EJECTIRP_COMPLETED)) ;
00503     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsListEmpty(&amp;DeviceNode-&gt;DockInfo.ListEntry)) ;
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">// Remove the current devnode from the list of docks</span>
00507     <span class="comment">//</span>
00508     RemoveEntryList(&amp;DeviceNode-&gt;DockInfo.ListEntry);
00509     InitializeListHead(&amp;DeviceNode-&gt;DockInfo.ListEntry);
00510     <span class="keywordflow">if</span> (DeviceNode-&gt;DockInfo.SerialNumber) {
00511 
00512         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;DockInfo.SerialNumber);
00513         DeviceNode-&gt;DockInfo.SerialNumber = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00514     }
00515     <a class="code" href="../../d9/d0/dockhwp_8c.html#a2">IopDockDeviceCount</a>--;
00516 
00517     DeviceNode-&gt;DockInfo.DockStatus = <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a> ;
00518     remainingDockCount = InterlockedDecrement(&amp;IopDocksInTransition) ;
00519     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(remainingDockCount &gt;= 0) ;
00520 
00521     <span class="comment">//</span>
00522     <span class="comment">// Release the lock on the list of dock devices</span>
00523     <span class="comment">//</span>
00524     ExReleaseFastMutex(&amp;IopDockDeviceListLock);
00525 
00526     <span class="keywordflow">if</span> (remainingDockCount) {
00527 
00528         <span class="keywordflow">return</span> ;
00529     }
00530 
00531     <span class="comment">//</span>
00532     <span class="comment">// Update the current Hardware Profile after removing this device.</span>
00533     <span class="comment">//</span>
00534     status = <a class="code" href="../../d9/d0/dockhwp_8c.html#a9">IopUpdateHardwareProfile</a>(&amp;profileChanged);
00535 
00536     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00537 
00538         <span class="comment">//</span>
00539         <span class="comment">// So we're there physically, but not mentally? Too bad, where broadcasting</span>
00540         <span class="comment">// change either way.</span>
00541         <span class="comment">//</span>
00542         PIDBGMSG(
00543             PIDBG_HWPROFILE,
00544             (<span class="stringliteral">"IopUpdateHardwareProfile failed with status == %lx\n"</span>, status)
00545             ) ;
00546 
00547         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) ;
00548     }
00549 
00550     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; profileChanged) {
00551 
00552         <a class="code" href="../../d9/d0/dockhwp_8c.html#a10">IopHardwareProfileSendCommit</a>() ;
00553         <a class="code" href="../../d9/d0/pnpiop_8h.html#a361">IopProcessNewProfile</a>();
00554 
00555     } <span class="keywordflow">else</span> {
00556 
00557         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IopProfileChangeCancelRequired) ;
00558         <a class="code" href="../../d9/d0/dockhwp_8c.html#a11">IopHardwareProfileSendCancel</a>() ;
00559     }
00560 
00561     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(
00562         &amp;IopProfileChangeSemaphore,
00563         IO_NO_INCREMENT,
00564         1,
00565         FALSE
00566         );
00567 
00568     <span class="keywordflow">return</span> ;
00569 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a380" doxytag="pnpiop.h::IopHardwareProfileCommitStartedDock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopHardwareProfileCommitStartedDock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00370">370</a> of file <a class="el" href="../../d0/d0/dockhwp_8c-source.html">dockhwp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00035">ASSERT_SEMA_NOT_SIGNALLED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00076">IopDocksInTransition</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00827">IopHardwareProfileSendCancel()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00795">IopHardwareProfileSendCommit()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05034">IopProcessNewProfile()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00075">IopProfileChangeCancelRequired</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00074">IopProfileChangeSemaphore</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03195">IopQueryDeviceSerialNumber()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00862">IopUpdateHardwareProfile()</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.
<p>
<pre class="fragment"><div>00375                    :
00376 
00377     This routine adds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of current dock
00378     devices and requests a Hardware Profile change.
00379 
00380 Arguments:
00381 
00382     DeviceNode  - Supplies a pointer to a device node which will be started and
00383                   enumerated.
00384 
00385 Return Value:
00386 
00387     None.
00388 
00389 --*/
00390 {
00391     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00392     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00393     PWCHAR  deviceSerialNumber;
00394     BOOLEAN profileChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00395 
00396     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;IopProfileChangeSemaphore) ;
00397     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;DockInfo.DockStatus == DOCK_ARRIVING) ;
00398     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsListEmpty(&amp;DeviceNode-&gt;DockInfo.ListEntry)) ;
00399 
00400     DeviceNode-&gt;DockInfo.DockStatus = <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a> ;
00401     InterlockedDecrement(&amp;IopDocksInTransition) ;
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">// We only add one dock at a time. So this should have been the last!</span>
00405     <span class="comment">//</span>
00406     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IopDocksInTransition) ;
00407 
00408     <span class="comment">//</span>
00409     <span class="comment">// Retrieve the Serial Number from this dock device</span>
00410     <span class="comment">//</span>
00411     <span class="keywordflow">if</span> (DeviceNode-&gt;DockInfo.SerialNumber == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00412 
00413         deviceObject = DeviceNode-&gt;PhysicalDeviceObject;
00414 
00415         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a35">IopQueryDeviceSerialNumber</a>(deviceObject,
00416                                             &amp;deviceSerialNumber);
00417 
00418         DeviceNode-&gt;DockInfo.SerialNumber = deviceSerialNumber;
00419 
00420         <span class="comment">//</span>
00421         <span class="comment">// Update the current Hardware Profile after successfully starting this</span>
00422         <span class="comment">// device. This routine does two things for us:</span>
00423         <span class="comment">// 1) It determines whether the profile actually changed and updates</span>
00424         <span class="comment">//    the global flag IopProfileChangeOccured appropriately.</span>
00425         <span class="comment">// 2) If the profile changed, this routine updates the registry, but</span>
00426         <span class="comment">//    does *not* broadcast the profile change around.</span>
00427         <span class="comment">//</span>
00428         status = <a class="code" href="../../d9/d0/dockhwp_8c.html#a9">IopUpdateHardwareProfile</a>(&amp;profileChanged);
00429         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00430 
00431             PIDBGMSG(
00432                 PIDBG_HWPROFILE,
00433                 (<span class="stringliteral">"IopUpdateHardwareProfile failed with status == %lx\n"</span>, status)
00434                 ) ;
00435         }
00436 
00437     } <span class="keywordflow">else</span> {
00438         <span class="comment">//</span>
00439         <span class="comment">// Couldn't get Serial Number for this dock device, or serial number was NULL</span>
00440         <span class="comment">//</span>
00441         status = STATUS_UNSUCCESSFUL;
00442     }
00443 
00444     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; profileChanged) {
00445 
00446         <a class="code" href="../../d9/d0/dockhwp_8c.html#a10">IopHardwareProfileSendCommit</a>() ;
00447         <a class="code" href="../../d9/d0/pnpiop_8h.html#a361">IopProcessNewProfile</a>();
00448 
00449     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/dockhwp_8c.html#a5">IopProfileChangeCancelRequired</a>) {
00450 
00451         <a class="code" href="../../d9/d0/dockhwp_8c.html#a11">IopHardwareProfileSendCancel</a>() ;
00452     }
00453 
00454     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(
00455         &amp;IopProfileChangeSemaphore,
00456         IO_NO_INCREMENT,
00457         1,
00458         FALSE
00459         );
00460 
00461     <span class="keywordflow">return</span> ;
00462 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a378" doxytag="pnpiop.h::IopHardwareProfileMarkDock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopHardwareProfileMarkDock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d0/pnpiop_8h.html#a387">PROFILE_STATUS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ChangeInPresence</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00160">160</a> of file <a class="el" href="../../d0/d0/dockhwp_8c-source.html">dockhwp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00035">ASSERT_SEMA_NOT_SIGNALLED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a206">DOCK_DEPARTING</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o42">_DEVICE_NODE::DockInfo</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00072">IopDockDeviceCount</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00071">IopDockDeviceListHead</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00073">IopDockDeviceListLock</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00076">IopDocksInTransition</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00074">IopProfileChangeSemaphore</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03195">IopQueryDeviceSerialNumber()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.
<p>
<pre class="fragment"><div>00166                    :
00167 
00168     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to mark a dock as <span class="stringliteral">"in transition"</span>, ie <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> either
00169     disappearing or appearing, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> results of which determine our <span class="keyword">final</span>
00170     hardware profile state. After all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> docks that are transitioning have
00171     been passed into <span class="keyword">this</span> function, <a class="code" href="../../d9/d0/dockhwp_8c.html#a14">IopHardwareProfileQueryChange</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00172 
00173 Arguments:
00174 
00175     DeviceNode          - The dock devnode that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> appearing or disappearing
00176     ChangeInPresence    - Either <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a206">DOCK_DEPARTING</a> or <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>
00177 
00178 Return Value:
00179 
00180     Nope.
00181 
00182 --*/
00183 {
00184     PWCHAR          deviceSerialNumber;
00185     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  deviceObject;
00186     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status;
00187 
00188     <span class="comment">//</span>
00189     <span class="comment">// Verify we are under semaphore, we aren't marking the dock twice, and</span>
00190     <span class="comment">// our parameters are sensable.</span>
00191     <span class="comment">//</span>
00192     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;IopProfileChangeSemaphore) ;
00193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == DOCK_QUIESCENT) ;
00194     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ChangeInPresence == DOCK_DEPARTING)||
00195            (ChangeInPresence == DOCK_ARRIVING)) ;
00196 
00197     <span class="keywordflow">if</span> (ChangeInPresence == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>) {
00198 
00199         <span class="comment">//</span>
00200         <span class="comment">// First, ensure this dock is a member of the dock list.</span>
00201         <span class="comment">// ADRIAO BUGBUG 11/12/98 -</span>
00202         <span class="comment">//     We should move this into IopProcessNewDeviceNode.</span>
00203         <span class="comment">//</span>
00204         <span class="keywordflow">if</span> (IsListEmpty(&amp;DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.ListEntry)) {
00205 
00206             <span class="comment">//</span>
00207             <span class="comment">// Acquire the lock on the list of dock devices</span>
00208             <span class="comment">//</span>
00209             ExAcquireFastMutex(&amp;IopDockDeviceListLock);
00210 
00211             <span class="comment">//</span>
00212             <span class="comment">// Add this element to the head of the list</span>
00213             <span class="comment">//</span>
00214             InsertHeadList(&amp;IopDockDeviceListHead,
00215                            &amp;DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.ListEntry);
00216             <a class="code" href="../../d9/d0/dockhwp_8c.html#a2">IopDockDeviceCount</a>++;
00217 
00218             <span class="comment">//</span>
00219             <span class="comment">// Release the lock on the list of dock devices</span>
00220             <span class="comment">//</span>
00221             ExReleaseFastMutex(&amp;IopDockDeviceListLock);
00222         }
00223 
00224         <span class="comment">//</span>
00225         <span class="comment">// Retrieve the Serial Number from this dock device. We do this just</span>
00226         <span class="comment">// to test the BIOS today. Later we will be acquiring the information</span>
00227         <span class="comment">// to determine the profile we are *about* to enter.</span>
00228         <span class="comment">//</span>
00229         deviceObject = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
00230         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a35">IopQueryDeviceSerialNumber</a>(deviceObject,
00231                                             &amp;deviceSerialNumber);
00232 
00233         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (deviceSerialNumber != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00234 
00235             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceSerialNumber) ;
00236         }
00237 
00238     } <span class="keywordflow">else</span> {
00239 
00240         <span class="comment">//</span>
00241         <span class="comment">// DOCK_DEPARTING case, we must be a member of the dock list...</span>
00242         <span class="comment">//</span>
00243         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsListEmpty(&amp;DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.ListEntry)) ;
00244     }
00245 
00246     InterlockedIncrement(&amp;IopDocksInTransition) ;
00247     DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus = ChangeInPresence ;
00248 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a379" doxytag="pnpiop.h::IopHardwareProfileQueryChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopHardwareProfileQueryChange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SubsumeExistingDeparture</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a388">PROFILE_NOTIFICATION_TIME</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotificationTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPNP_VETO_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>VetoType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING VetoName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00251">251</a> of file <a class="el" href="../../d0/d0/dockhwp_8c-source.html">dockhwp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00035">ASSERT_SEMA_NOT_SIGNALLED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o42">_DEVICE_NODE::DockInfo</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00071">IopDockDeviceListHead</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00073">IopDockDeviceListLock</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00076">IopDocksInTransition</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00075">IopProfileChangeCancelRequired</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00074">IopProfileChangeSemaphore</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06672">IopRequestHwProfileChangeNotification()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.
<p>
<pre class="fragment"><div>00259                    :
00260 
00261     This function queries drivers to see <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> OK to <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
00262     hardware profile and enter next one (as determined by which docks have
00263     been marked). One of three <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> should be used subsequently to <span class="keyword">this</span>
00264     call:
00265         <a class="code" href="../../d9/d0/pnpiop_8h.html#a380">IopHardwareProfileCommitStartedDock</a> (call when a dock has successfully
00266                                              started)
00267         <a class="code" href="../../d9/d0/pnpiop_8h.html#a381">IopHardwareProfileCommitRemovedDock</a> (call when a dock is no longer
00268                                              present in the system)
00269         <a class="code" href="../../d9/d0/pnpiop_8h.html#a383">IopHardwareProfileCancelTransition</a>  (call to abort a transition, say
00270                                              <span class="keywordflow">if</span> a dock failed to start or a
00271                                              query returned failure <span class="keywordflow">for</span> eject)
00272 
00273 Arguments:
00274 
00275     InPnpEvent  - This argument indicates whether an operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being done
00276                   within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of another PnpEvent or not. If not, we
00277                   will queue such an event and block on <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>. If so, we cannot
00278                   queue&amp;block (we'd deadlock), so we <span class="keywordflow">do</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query manually.
00279     VetoType    - If <span class="keyword">this</span> function returns <span class="keyword">false</span>, <span class="keyword">this</span> parameter will describe
00280                   who failed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query profile change. The below optional
00281                   parameter will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of said vetoer.
00282     VetoName    - This optional parameter will get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> vetoer (ie
00283                   devinst, service name, application name, etc). If VetoName
00284                   <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller must free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer returned.
00285 
00286 Return Value:
00287 
00288     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>.
00289 
00290 --*/
00291 {
00292     <a class="code" href="../../d2/d6/structPROFILE__WORK__ITEM.html">PROFILE_WORK_ITEM</a> profileWorkItem;
00293     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00294     BOOLEAN arrivingDockFound;
00295     PLIST_ENTRY listEntry ;
00296     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNode ;
00297 
00298     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;IopProfileChangeSemaphore) ;
00299 
00300     <span class="comment">//</span>
00301     <span class="comment">// Acquire the lock on the list of dock devices and determine whether any</span>
00302     <span class="comment">// dock devnodes are arriving.</span>
00303     <span class="comment">//</span>
00304     ExAcquireFastMutex(&amp;IopDockDeviceListLock);
00305 
00306     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IopDocksInTransition) ;
00307 
00308     arrivingDockFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00309     <span class="keywordflow">for</span> (listEntry  = <a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>.Flink;
00310         listEntry != &amp;(<a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>);
00311         listEntry  = listEntry-&gt;Flink ) {
00312 
00313         devNode = CONTAINING_RECORD(listEntry,
00314                                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a>,
00315                                     DockInfo.ListEntry);
00316 
00317         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus != DOCK_NOTDOCKDEVICE)&amp;&amp;
00318                (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus != DOCK_EJECTIRP_COMPLETED)) ;
00319 
00320         <span class="keywordflow">if</span> (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>) {
00321 
00322             arrivingDockFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
00323         }
00324     }
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">// Release the lock on the list of dock devices</span>
00328     <span class="comment">//</span>
00329     ExReleaseFastMutex(&amp;IopDockDeviceListLock);
00330 
00331     <span class="keywordflow">if</span> (SubsumingExistingDeparture) {
00332 
00333         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IopProfileChangeCancelRequired) ;
00334         <span class="comment">//</span>
00335         <span class="comment">// We're nesting. Work off the last query, and don't requery.</span>
00336         <span class="comment">//</span>
00337         <span class="keywordflow">return</span> STATUS_SUCCESS ;
00338     }
00339 
00340     <span class="keywordflow">if</span> (arrivingDockFound) {
00341 
00342         <span class="comment">//</span>
00343         <span class="comment">// We currently don't actually query for hardware profile change on a</span>
00344         <span class="comment">// dock event as the user may have the lid closed. If we ever find a</span>
00345         <span class="comment">// piece of hardware that needs to be updated *prior* to actually</span>
00346         <span class="comment">// switching over, we will have to remove this bit of code.</span>
00347         <span class="comment">//</span>
00348         <a class="code" href="../../d9/d0/dockhwp_8c.html#a5">IopProfileChangeCancelRequired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00349         <span class="keywordflow">return</span> STATUS_SUCCESS ;
00350     }
00351 
00352     PIDBGMSG(PIDBG_HWPROFILE, (<span class="stringliteral">"NTOSKRNL: Sending HW profile change [query]\n"</span>)) ;
00353 
00354     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a348">IopRequestHwProfileChangeNotification</a>(
00355         (LPGUID) &amp;GUID_HWPROFILE_QUERY_CHANGE,
00356         InPnpEvent,
00357         VetoType,
00358         VetoName
00359         );
00360 
00361     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00362         <a class="code" href="../../d9/d0/dockhwp_8c.html#a5">IopProfileChangeCancelRequired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
00363     } <span class="keywordflow">else</span> {
00364         <a class="code" href="../../d9/d0/dockhwp_8c.html#a5">IopProfileChangeCancelRequired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00365     }
00366     <span class="keywordflow">return</span> status ;
00367 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a384" doxytag="pnpiop.h::IopHardwareProfileSetMarkedDocksEjected" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopHardwareProfileSetMarkedDocksEjected           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00739">739</a> of file <a class="el" href="../../d0/d0/dockhwp_8c-source.html">dockhwp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00035">ASSERT_SEMA_NOT_SIGNALLED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a206">DOCK_DEPARTING</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o42">_DEVICE_NODE::DockInfo</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00071">IopDockDeviceListHead</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00073">IopDockDeviceListLock</a>, and <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00074">IopProfileChangeSemaphore</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01417">IopProcessCompletedEject()</a>.
<p>
<pre class="fragment"><div>00744                    :
00745 
00746     This routine moves any departing devnodes to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ejected state. If any
00747     subsequent enumeration lists <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device as present, we know <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> eject
00748     failed and we appropriately cancel that piece of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile change.
00749     <a class="code" href="../../d9/d0/dockhwp_8c.html#a17">IopHardwareProfileCancelRemovedDock</a> can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be called after <span class="keyword">this</span> function
00750     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00751 
00752 Arguments:
00753 
00754     None.
00755 
00756 Return Value:
00757 
00758     Nodda.
00759 
00760 --*/
00761 {
00762     PLIST_ENTRY  listEntry;
00763     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNode;
00764 
00765     <a class="code" href="../../d9/d0/dockhwp_8c.html#a0">ASSERT_SEMA_NOT_SIGNALLED</a>(&amp;IopProfileChangeSemaphore) ;
00766 
00767     <span class="comment">//</span>
00768     <span class="comment">// Acquire the lock on the list of dock devices</span>
00769     <span class="comment">//</span>
00770     ExAcquireFastMutex(&amp;IopDockDeviceListLock);
00771 
00772     <span class="keywordflow">for</span> (listEntry  = <a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>.Flink;
00773         listEntry != &amp;(<a class="code" href="../../d9/d0/dockhwp_8c.html#a1">IopDockDeviceListHead</a>);
00774         listEntry  = listEntry-&gt;Flink ) {
00775 
00776         devNode = CONTAINING_RECORD(listEntry,
00777                                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a>,
00778                                     DockInfo.ListEntry);
00779 
00780         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == DOCK_QUIESCENT)||
00781                (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == DOCK_DEPARTING)) ;
00782         <span class="keywordflow">if</span> (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus != <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>) {
00783 
00784             devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus = <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a> ;
00785         }
00786     }
00787 
00788     <span class="comment">//</span>
00789     <span class="comment">// Release the lock on the list of dock devices</span>
00790     <span class="comment">//</span>
00791     ExReleaseFastMutex(&amp;IopDockDeviceListLock);
00792 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a331" doxytag="pnpiop.h::IopIncDisableableDepends" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopIncDisableableDepends           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03109">3109</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">IopQueryDeviceState()</a>.
<p>
<pre class="fragment"><div>03114                    :
03115 
03116     Increments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DisableableDepends field of <span class="keyword">this</span> devicenode
03117     and potentially every parent device node up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree
03118     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> parent devicenode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> incremented <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child in question
03119     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incremented from 0 to 1
03120 
03121 Parameters:
03122 
03123     DeviceNode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> depends <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be incremented
03124 
03125 Return Value:
03126 
03127     none.
03128 
03129 --*/
03130 {
03131 
03132     <span class="keywordflow">while</span> (DeviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03133 
03134         LONG newval;
03135 
03136         newval = InterlockedIncrement(&amp; DeviceNode-&gt;DisableableDepends);
03137         <span class="keywordflow">if</span> (newval != 1) {
03138             <span class="comment">//</span>
03139             <span class="comment">// we were already non-disableable, so we don't have to bother parent</span>
03140             <span class="comment">//</span>
03141             <span class="keywordflow">break</span>;
03142         }
03143 
03144         DeviceNode = DeviceNode -&gt;Parent;
03145 
03146     }
03147 
03148 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a346" doxytag="pnpiop.h::IopInitializePlugPlayNotification" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopInitializePlugPlayNotification           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a237" doxytag="pnpiop.h::IopInitializePlugPlayServices" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopInitializePlugPlayServices           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Phase</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">93</a> of file <a class="el" href="../../d8/d9/pnpinit_8c-source.html">pnpinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a186">BUS_TYPE_GUID_LIST</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00175">CmRegistryMachineSystemCurrentControlSet</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00396">DNF_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00433">DNF_NO_RESOURCE_REQUIRED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00390">DNF_PROCESSED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01164">DO_BUS_ENUMERATED_DEVICE</a>, <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00059">EisaBuildEisaDeviceNode()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04073">IoCreateDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01071">IoCreateDriver()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01264">IoDeleteDriver()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00056">IopAllocateDeviceNode()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a369">IopBusNumberInitialize()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00161">IopBusTypeGuidList</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01510">IopDetermineDefaultInterfaceType()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00074">IopDeviceTreeLock</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a368">IopDmaInitialize()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00072">IopDockDeviceCount</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00071">IopDockDeviceListHead</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00073">IopDockDeviceListLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a346">IopInitializePlugPlayNotification()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00042">IopInitReservedResourceList</a>, <a class="el" href="../../d1/d1/pnpirq_8c.html#a1">IopIrqInitialize()</a>, <a class="el" href="../../d3/d1/pnpmemio_8c.html#a21">IopMemInitialize()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a136">IOPNP_DEVICE_EXTENSION</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00037">IoPnpDriverObject</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00183">IopPendingEjects</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00188">IopPendingSurpriseRemovals</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00636">IopPnPDriverEntry()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00104">IopPnpEnumerationRequestList</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00038">IopPnpScratchBuffer1</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00039">IopPnpScratchBuffer2</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00068">IopPnPSpinLock</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00349">IopPortInitialize()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07291">IopReserveBootResources()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00148">IopReserveResourcesRoutine</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00193">IopWarmEjectLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00198">IopWarmEjectPdo</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02420">_BUS_TYPE_GUID_LIST::Lock</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01600">MapperConstructRootEnumTree()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01549">MapperFreeList()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l02060">MapperPhantomizeDetectedComPorts()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01009">MapperProcessFirmwareTree()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00086">PiEnumerationLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00080">PiEventQueueEmpty</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00893">PNP_DETECTION_ENABLED_DEFAULT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00900">PNP_LARGE_SCRATCH_BUFFER_SIZE</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l03008">PnPBiosMapper()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00116">PnPDetectionEnabled</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00110">PnPInitialized</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a163">PpInitializeNotification()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a225">ReenumerateRootDevices</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01666">RtlAddAccessAllowedAceEx()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">RtlSetDaclSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02066">RtlValidSecurityDescriptor()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01628">SeLocalSystemSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01609">SeWorldSid</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>00100                    :
00101 
00102     This routine initializes kernel mode Plug and Play services.
00103 
00104 Arguments:
00105 
00106     LoaderBlock - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LoaderBlock passed in from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00107         OS Loader.
00108 
00109 Returns:
00110 
00111     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code <span class="keywordflow">for</span> sucess or <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> of <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00112 
00113 --*/
00114 {
00115     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00116     HANDLE hTreeHandle, parentHandle, handle, hCurrentControlSet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00117     UNICODE_STRING unicodeName;
00118     PKEY_VALUE_FULL_INFORMATION detectionInfo;
00119     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00120     ULONG disposition;
00121 
00122     <span class="keywordflow">if</span> (Phase == 0) {
00123         <a class="code" href="../../d1/d0/pnpdata_8c.html#a14">PnPInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00124 
00125         <span class="comment">//</span>
00126         <span class="comment">// Allocate two one-page scratch buffers to be used by our</span>
00127         <span class="comment">// initialization code.  This avoids constant pool allocations.</span>
00128         <span class="comment">//</span>
00129 
00130         <a class="code" href="../../d1/d0/pnpdata_8c.html#a0">IopPnpScratchBuffer1</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, PNP_LARGE_SCRATCH_BUFFER_SIZE);
00131         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/pnpdata_8c.html#a0">IopPnpScratchBuffer1</a>) {
00132             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00133         }
00134         <a class="code" href="../../d1/d0/pnpdata_8c.html#a1">IopPnpScratchBuffer2</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, PNP_LARGE_SCRATCH_BUFFER_SIZE);
00135         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/pnpdata_8c.html#a1">IopPnpScratchBuffer2</a>) {
00136             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopPnpScratchBuffer1);
00137             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00138         }
00139 
00140         <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00141 
00142         <a class="code" href="../../d1/d0/pnpdata_8c.html#a20">IopReserveResourcesRoutine</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a334">IopReserveBootResources</a>;
00143 
00144         <span class="comment">//</span>
00145         <span class="comment">// Determine the PnpDefaultInterfaceType.  For root enumerated devices if the Interface</span>
00146         <span class="comment">// type of their resource list or resource requirements list are undefined.  We will use</span>
00147         <span class="comment">// the default type instead.</span>
00148         <span class="comment">//</span>
00149 
00150         <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a> = <a class="code" href="../../d7/d0/pnpinit_8c.html#a7">IopDetermineDefaultInterfaceType</a>();
00151 
00152         <span class="comment">//</span>
00153         <span class="comment">// Initialize root arbiters</span>
00154         <span class="comment">//</span>
00155 
00156         status = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a25">IopPortInitialize</a>();
00157         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00158             <span class="keywordflow">goto</span> init_Exit0;
00159         }
00160 
00161         status = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a21">IopMemInitialize</a>();
00162         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00163             <span class="keywordflow">goto</span> init_Exit0;
00164         }
00165 
00166         status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a368">IopDmaInitialize</a>();
00167         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00168             <span class="keywordflow">goto</span> init_Exit0;
00169         }
00170 
00171         status = <a class="code" href="../../d1/d1/pnpirq_8c.html#a1">IopIrqInitialize</a>();
00172         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00173             <span class="keywordflow">goto</span> init_Exit0;
00174         }
00175 
00176         status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a369">IopBusNumberInitialize</a>();
00177         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00178             <span class="keywordflow">goto</span> init_Exit0;
00179         }
00180 
00181         <span class="comment">//</span>
00182         <span class="comment">// Next open/create System\CurrentControlSet\Enum\Root key.</span>
00183         <span class="comment">//</span>
00184 
00185         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hCurrentControlSet,
00186                                        NULL,
00187                                        &amp;CmRegistryMachineSystemCurrentControlSet,
00188                                        KEY_ALL_ACCESS
00189                                        );
00190         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00191             hCurrentControlSet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00192             <span class="keywordflow">goto</span> init_Exit0;
00193         }
00194 
00195         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_ENUM);
00196         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
00197                                          hCurrentControlSet,
00198                                          &amp;unicodeName,
00199                                          KEY_ALL_ACCESS,
00200                                          REG_OPTION_NON_VOLATILE,
00201                                          &amp;disposition
00202                                          );
00203         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00204             <span class="keywordflow">goto</span> init_Exit0;
00205         }
00206 
00207         <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {
00208             SECURITY_DESCRIPTOR     newSD;
00209             PACL                    newDacl;
00210             ULONG                   sizeDacl;
00211 
00212             status = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( &amp;newSD,
00213                                                   SECURITY_DESCRIPTOR_REVISION );
00214             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00215 
00216             <span class="comment">//</span>
00217             <span class="comment">// calculate the size of the new DACL</span>
00218             <span class="comment">//</span>
00219             sizeDacl = <span class="keyword">sizeof</span>(ACL);
00220             sizeDacl += <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE) + <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(SeLocalSystemSid) - <span class="keyword">sizeof</span>(ULONG);
00221 
00222 <span class="preprocessor">#if ALLOW_WORLD_READ_OF_ENUM</span>
00223 <span class="preprocessor"></span>            sizeDacl += <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE) + <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(SeWorldSid) - <span class="keyword">sizeof</span>(ULONG);
00224 <span class="preprocessor">#endif</span>
00225 <span class="preprocessor"></span>
00226             <span class="comment">//</span>
00227             <span class="comment">// create and initialize the new DACL</span>
00228             <span class="comment">//</span>
00229             newDacl = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, sizeDacl);
00230 
00231             <span class="keywordflow">if</span> (newDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00232 
00233                 status = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>(newDacl, sizeDacl, ACL_REVISION);
00234 
00235                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00236 
00237                 <span class="comment">//</span>
00238                 <span class="comment">// Add just the local system full control ace to this new DACL</span>
00239                 <span class="comment">//</span>
00240                 status = <a class="code" href="../../d2/d4/acledit_8c.html#a17">RtlAddAccessAllowedAceEx</a>( newDacl,
00241                                                    ACL_REVISION,
00242                                                    CONTAINER_INHERIT_ACE,
00243                                                    KEY_ALL_ACCESS,
00244                                                    SeLocalSystemSid
00245                                                    );
00246                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00247 
00248 <span class="preprocessor">#if ALLOW_WORLD_READ_OF_ENUM</span>
00249 <span class="preprocessor"></span>                <span class="comment">//</span>
00250                 <span class="comment">// Add just the local system full control ace to this new DACL</span>
00251                 <span class="comment">//</span>
00252                 status = <a class="code" href="../../d2/d4/acledit_8c.html#a17">RtlAddAccessAllowedAceEx</a>( newDacl,
00253                                                    ACL_REVISION,
00254                                                    CONTAINER_INHERIT_ACE,
00255                                                    KEY_READ,
00256                                                    SeWorldSid
00257                                                    );
00258                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00259 
00260 <span class="preprocessor">#endif</span>
00261 <span class="preprocessor"></span>                <span class="comment">//</span>
00262                 <span class="comment">// Set the new DACL in the absolute security descriptor</span>
00263                 <span class="comment">//</span>
00264                 status = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( (PSECURITY_DESCRIPTOR) &amp;newSD,
00265                                                        TRUE,
00266                                                        newDacl,
00267                                                        FALSE
00268                                                        );
00269 
00270                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00271 
00272                 <span class="comment">//</span>
00273                 <span class="comment">// validate the new security descriptor</span>
00274                 <span class="comment">//</span>
00275                 status = <a class="code" href="../../d8/d6/sertl_8c.html#a55">RtlValidSecurityDescriptor</a>(&amp;newSD);
00276 
00277                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00278 
00279                 status = ZwSetSecurityObject( handle,
00280                                               DACL_SECURITY_INFORMATION,
00281                                               &amp;newSD
00282                                               );
00283                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00284 
00285                     KdPrint((<span class="stringliteral">"IopInitializePlugPlayServices: ZwSetSecurityObject on Enum key failed, status = %8.8X\n"</span>, status));
00286                 }
00287 
00288                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(newDacl);
00289             } <span class="keywordflow">else</span> {
00290 
00291                 KdPrint((<span class="stringliteral">"IopInitializePlugPlayServices: ExAllocatePool failed allocating DACL for Enum key\n"</span>));
00292             }
00293         }
00294 
00295         parentHandle = handle;
00296         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_ROOTENUM);
00297         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
00298                                          parentHandle,
00299                                          &amp;unicodeName,
00300                                          KEY_ALL_ACCESS,
00301                                          REG_OPTION_NON_VOLATILE,
00302                                          NULL
00303                                          );
00304         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(parentHandle);
00305         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00306             <span class="keywordflow">goto</span> init_Exit0;
00307         }
00308         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00309 
00310         <span class="comment">//</span>
00311         <span class="comment">// Create the registry entry for the root of the hardware tree (HTREE\ROOT\0).</span>
00312         <span class="comment">//</span>
00313 
00314         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
00315                                        NULL,
00316                                        &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
00317                                        KEY_ALL_ACCESS
00318                                        );
00319         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00320             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_ROOT_DEVNODE);
00321             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;hTreeHandle,
00322                                              handle,
00323                                              &amp;unicodeName,
00324                                              KEY_ALL_ACCESS,
00325                                              REG_OPTION_NON_VOLATILE,
00326                                              NULL
00327                                              );
00328             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00329             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00330                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hTreeHandle);
00331             }
00332         }
00333 
00334         <span class="comment">//</span>
00335         <span class="comment">// Before creating device node tree, we need to initialize the device</span>
00336         <span class="comment">// tree lock.</span>
00337         <span class="comment">//</span>
00338 
00339         InitializeListHead(&amp;IopPendingEjects);
00340         InitializeListHead(&amp;IopPendingSurpriseRemovals);
00341         InitializeListHead(&amp;IopPnpEnumerationRequestList);
00342         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>(&amp;IopDeviceTreeLock);
00343         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;PiEventQueueEmpty, NotificationEvent, TRUE );
00344         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;PiEnumerationLock, NotificationEvent, TRUE );
00345         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;IopPnPSpinLock);
00346 
00347         <span class="comment">//</span>
00348         <span class="comment">// Initialize the list of dock devices, and its lock.</span>
00349         <span class="comment">//</span>
00350         InitializeListHead(&amp;IopDockDeviceListHead);
00351         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;IopDockDeviceListLock);
00352         <a class="code" href="../../d9/d0/dockhwp_8c.html#a2">IopDockDeviceCount</a> = 0;
00353 
00354         <span class="comment">//</span>
00355         <span class="comment">// Initialize warm docking variables.</span>
00356         <span class="comment">//</span>
00357         <a class="code" href="../../d1/d0/pnpdata_8c.html#a29">IopWarmEjectPdo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00358         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;IopWarmEjectLock, SynchronizationEvent, TRUE );
00359 
00360         <span class="comment">//</span>
00361         <span class="comment">// Create a PnP manager's driver object to own all the detected PDOs.</span>
00362         <span class="comment">//</span>
00363 
00364         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, PNPMGR_STR_PNP_DRIVER);
00365         status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a76">IoCreateDriver</a> (&amp;unicodeName, IopPnPDriverEntry);
00366         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00367 
00368             <span class="comment">//</span>
00369             <span class="comment">// Create empty device node tree, i.e., only contains only root device node</span>
00370             <span class="comment">//     (No need to initialize Parent, Child and Sibling links.)</span>
00371 
00372             status = <a class="code" href="../../d4/d6/iosubs_8c.html#a45">IoCreateDevice</a>( IoPnpDriverObject,
00373                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">IOPNP_DEVICE_EXTENSION</a>),
00374                                      NULL,
00375                                      FILE_DEVICE_CONTROLLER,
00376                                      0,
00377                                      FALSE,
00378                                      &amp;deviceObject );
00379 
00380             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00381                 deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>;
00382                 <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a252">IopAllocateDeviceNode</a>(deviceObject);
00383 
00384                 <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
00385                     <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
00386                     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a77">IoDeleteDriver</a>(IoPnpDriverObject);
00387                     status = STATUS_INSUFFICIENT_RESOURCES;
00388                 } <span class="keywordflow">else</span> {
00389                     <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a> +
00390                                                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a> +
00391                                                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>;
00392 
00393                     <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool,
00394                                                                              <span class="keyword">sizeof</span>(REGSTR_VAL_ROOT_DEVNODE));
00395 
00396                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00397                         <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.MaximumLength = <span class="keyword">sizeof</span>(REGSTR_VAL_ROOT_DEVNODE);
00398                         <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Length = <span class="keyword">sizeof</span>(REGSTR_VAL_ROOT_DEVNODE) - <span class="keyword">sizeof</span>(WCHAR);
00399 
00400                         RtlMoveMemory( <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer,
00401                                        REGSTR_VAL_ROOT_DEVNODE,
00402                                        <span class="keyword">sizeof</span>(REGSTR_VAL_ROOT_DEVNODE));
00403                     } <span class="keywordflow">else</span> {
00404                         <span class="comment">//</span>
00405                         <span class="comment">// BUGBUG - Need to bugcheck here</span>
00406                         <span class="comment">//</span>
00407 
00408                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00409                     }
00410                 }
00411             }
00412         }
00413 
00414         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00415             <span class="keywordflow">goto</span> init_Exit0;
00416         }
00417 
00418         <span class="comment">//</span>
00419         <span class="comment">// Initialize PnPDetectionEnabled flag to determine should Wdm driver be loaded</span>
00420         <span class="comment">// to run detection code.</span>
00421         <span class="comment">// This is stored as a REG_DWORD under HKLM\System\CurrentControlSet\Control\Pnp\DetectionEnabled</span>
00422         <span class="comment">// if it is not present then PNP_DETECTION_ENABLED_DEFAULT is used</span>
00423         <span class="comment">//</span>
00424 
00425         <span class="comment">//</span>
00426         <span class="comment">// Open HKLM\System\CurrentControlSet\Control\Pnp</span>
00427         <span class="comment">//</span>
00428 
00429         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_PATH_CONTROL_PNP);
00430         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
00431                                          hCurrentControlSet,
00432                                          &amp;unicodeName,
00433                                          KEY_ALL_ACCESS,
00434                                          REG_OPTION_NON_VOLATILE,
00435                                          NULL
00436                                          );
00437         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00438             <span class="keywordflow">goto</span> init_Exit0;
00439         }
00440 
00441         <span class="comment">//</span>
00442         <span class="comment">// Get the value of DetectionEnabled key if it exisit otherwise use the default</span>
00443         <span class="comment">//</span>
00444 
00445         <a class="code" href="../../d1/d0/pnpdata_8c.html#a15">PnPDetectionEnabled</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a85">PNP_DETECTION_ENABLED_DEFAULT</a>;
00446 
00447         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
00448                                      REGSTR_VALUE_DETECTION_ENABLED,
00449                                      &amp;detectionInfo
00450                                      );
00451 
00452         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00453 
00454             <span class="keywordflow">if</span> (detectionInfo-&gt;Type == REG_DWORD &amp;&amp; detectionInfo-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)) {
00455                 <a class="code" href="../../d1/d0/pnpdata_8c.html#a15">PnPDetectionEnabled</a> = (BOOLEAN) *(<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(detectionInfo));
00456             }
00457 
00458             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(detectionInfo);
00459         }
00460 
00461         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00462 
00463         <span class="comment">//</span>
00464         <span class="comment">// Initialize the kernel mode pnp notification system</span>
00465         <span class="comment">//</span>
00466 
00467         status = <a class="code" href="../../d6/d9/pnp_8h.html#a163">PpInitializeNotification</a>();
00468         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00469             <span class="keywordflow">goto</span> init_Exit0;
00470         }
00471 
00472         <a class="code" href="../../d9/d0/pnpiop_8h.html#a346">IopInitializePlugPlayNotification</a>();
00473 
00474         <span class="comment">//</span>
00475         <span class="comment">// Initialize table for holding bus type guid list.</span>
00476         <span class="comment">//</span>
00477 
00478         <a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">BUS_TYPE_GUID_LIST</a>));
00479         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00480             status = STATUS_INSUFFICIENT_RESOURCES;
00481             <span class="keywordflow">goto</span> init_Exit0;
00482         }
00483 
00484         RtlZeroMemory( IopBusTypeGuidList, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">BUS_TYPE_GUID_LIST</a>));
00485 
00486         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o1">Lock</a>);
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">// Enumerate the ROOT bus synchronously.</span>
00490         <span class="comment">//</span>
00491 
00492         <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>, ReenumerateRootDevices, NULL, NULL);
00493 
00494 init_Exit0:
00495 
00496         <span class="comment">//</span>
00497         <span class="comment">// If we managed to open the Current Control Set close it</span>
00498         <span class="comment">//</span>
00499 
00500         <span class="keywordflow">if</span>(hCurrentControlSet) {
00501             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hCurrentControlSet);
00502         }
00503 
00504         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00505             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopPnpScratchBuffer1);
00506             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopPnpScratchBuffer2);
00507         }
00508 
00509     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Phase == 1) {
00510 
00511         BOOLEAN legacySerialPortMappingOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00512 
00513         <span class="comment">//</span>
00514         <span class="comment">// Next open/create System\CurrentControlSet\Enum\Root key.</span>
00515         <span class="comment">//</span>
00516 
00517         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hCurrentControlSet,
00518                                        NULL,
00519                                        &amp;CmRegistryMachineSystemCurrentControlSet,
00520                                        KEY_ALL_ACCESS
00521                                        );
00522         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00523             hCurrentControlSet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00524             <span class="keywordflow">goto</span> init_Exit1;
00525         }
00526 
00527         <span class="comment">//</span>
00528         <span class="comment">// Open HKLM\System\CurrentControlSet\Control\Pnp</span>
00529         <span class="comment">//</span>
00530 
00531         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_PATH_CONTROL_PNP);
00532         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
00533                                          hCurrentControlSet,
00534                                          &amp;unicodeName,
00535                                          KEY_ALL_ACCESS,
00536                                          REG_OPTION_NON_VOLATILE,
00537                                          NULL
00538                                          );
00539         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00540             <span class="keywordflow">goto</span> init_Exit1;
00541         }
00542 
00543         <span class="comment">//</span>
00544         <span class="comment">// Check the "DisableFirmwareMapper" value entry to see whether we</span>
00545         <span class="comment">// should skip mapping ntdetect/firmware reported devices (except for</span>
00546         <span class="comment">// COM ports, which we always map).</span>
00547         <span class="comment">//</span>
00548 
00549         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
00550                                      REGSTR_VALUE_DISABLE_FIRMWARE_MAPPER,
00551                                      &amp;detectionInfo
00552                                      );
00553 
00554         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00555 
00556             <span class="keywordflow">if</span> (detectionInfo-&gt;Type == REG_DWORD &amp;&amp; detectionInfo-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)) {
00557                 legacySerialPortMappingOnly = (BOOLEAN) *(<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(detectionInfo));
00558             }
00559 
00560             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(detectionInfo);
00561 
00562         }
00563         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00564 
00565         <span class="comment">//</span>
00566         <span class="comment">// Collect the necessary firmware tree information.</span>
00567         <span class="comment">//</span>
00568 
00569         <a class="code" href="../../d9/d0/pnpiop_8h.html#a338">MapperProcessFirmwareTree</a>(legacySerialPortMappingOnly);
00570 
00571         <span class="comment">//</span>
00572         <span class="comment">// Map this into the root enumerator tree</span>
00573         <span class="comment">//</span>
00574 
00575         <a class="code" href="../../d9/d0/pnpiop_8h.html#a339">MapperConstructRootEnumTree</a>(legacySerialPortMappingOnly);
00576 
00577 <span class="preprocessor">#if i386</span>
00578 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!legacySerialPortMappingOnly) {
00579 
00580             <span class="comment">//</span>
00581             <span class="comment">// Now do the PnP BIOS enumerated devnodes.</span>
00582             <span class="comment">//</span>
00583             <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a58">PnPBiosMapper</a>(VOID);
00584 
00585             status = <a class="code" href="../../d2/d1/pnpmap_8c.html#a58">PnPBiosMapper</a>();
00586 
00587             <span class="comment">//</span>
00588             <span class="comment">// If the previous call succeeds, we have a PNPBios, turn any newly</span>
00589             <span class="comment">// created ntdetect COM ports into phantoms</span>
00590             <span class="comment">//</span>
00591             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00592                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a342">MapperPhantomizeDetectedComPorts</a>();
00593             }
00594         }
00595         <a class="code" href="../../d9/d0/pnpiop_8h.html#a341">EisaBuildEisaDeviceNode</a>();
00596 <span class="preprocessor">#endif</span>
00597 <span class="preprocessor"></span>
00598         <span class="comment">//</span>
00599         <span class="comment">// We're done with the firmware mapper device list.</span>
00600         <span class="comment">//</span>
00601 
00602         <a class="code" href="../../d9/d0/pnpiop_8h.html#a340">MapperFreeList</a>();
00603 
00604 
00605         <span class="comment">//</span>
00606         <span class="comment">// Enumerate the ROOT bus synchronously.</span>
00607         <span class="comment">//</span>
00608 
00609         <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>, ReenumerateRootDevices, NULL, NULL);
00610 
00611 init_Exit1:
00612 
00613         <span class="comment">//</span>
00614         <span class="comment">// If we managed to open the Current Control Set close it</span>
00615         <span class="comment">//</span>
00616 
00617         <span class="keywordflow">if</span>(hCurrentControlSet) {
00618             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hCurrentControlSet);
00619         }
00620 
00621         <span class="comment">//</span>
00622         <span class="comment">// Free our scratch buffers and exit.</span>
00623         <span class="comment">//</span>
00624 
00625         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopPnpScratchBuffer1);
00626         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopPnpScratchBuffer2);
00627         status = STATUS_SUCCESS;
00628     } <span class="keywordflow">else</span> {
00629         status = STATUS_INVALID_PARAMETER_1;
00630     }
00631 
00632     <span class="keywordflow">return</span> status;
00633 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a250" doxytag="pnpiop.h::IopInsertTreeDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopInsertTreeDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/devnode_8c-source.html#l00447">447</a> of file <a class="el" href="../../d5/d6/devnode_8c-source.html">devnode.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00155">IoDeviceNodeTreeSequence</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00178">IopMaxDeviceNodeLevel</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>00452 {
00453     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode;
00454     PLIST_ENTRY     *p;
00455     LONG            i;
00456 
00457     <span class="comment">//</span>
00458     <span class="comment">// Put this devnode at the end of the parent's list of children.</span>
00459     <span class="comment">//</span>
00460 
00461     DeviceNode-&gt;Parent = ParentNode;
00462     <span class="keywordflow">if</span> (ParentNode-&gt;LastChild) {
00463         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ParentNode-&gt;LastChild-&gt;Sibling == NULL);
00464         ParentNode-&gt;LastChild-&gt;Sibling = DeviceNode;
00465         ParentNode-&gt;LastChild = DeviceNode;
00466     } <span class="keywordflow">else</span> {
00467         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ParentNode-&gt;Child == NULL);
00468         ParentNode-&gt;Child = ParentNode-&gt;LastChild = DeviceNode;
00469     }
00470 
00471     <span class="comment">//</span>
00472     <span class="comment">// Determine the depth of the devnode.</span>
00473     <span class="comment">//</span>
00474 
00475     <span class="keywordflow">for</span> (deviceNode = DeviceNode;
00476          deviceNode != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>;
00477          deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>) {
00478         DeviceNode-&gt;Level++;
00479     }
00480 
00481     <span class="keywordflow">if</span> (DeviceNode-&gt;Level &gt; <a class="code" href="../../d1/d0/pnpdata_8c.html#a25">IopMaxDeviceNodeLevel</a>) {
00482         <a class="code" href="../../d1/d0/pnpdata_8c.html#a25">IopMaxDeviceNodeLevel</a> = DeviceNode-&gt;Level;
00483     }
00484 
00485     <span class="comment">//</span>
00486     <span class="comment">// Tree has changed</span>
00487     <span class="comment">//</span>
00488 
00489     <a class="code" href="../../d1/d0/pnpdata_8c.html#a21">IoDeviceNodeTreeSequence</a> += 1;
00490 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a315" doxytag="pnpiop.h::IopInvalidateRelationsInList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopInvalidateRelationsInList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RelationsList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>OnlyIndirectDescendants</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UnlockDevNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartDevNode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">1250</a> of file <a class="el" href="../../d4/d9/pnpdel_8c-source.html">pnpdel.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00396">DNF_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00583">DNF_LOCKED_FOR_EJECT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00390">DNF_PROCESSED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00170">_DEVICE_NODE::EnumerationMutex</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00055">IopAddRelationToList()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00239">IopAllocateRelationList()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00831">IopClearDevNodeProblem</a>, <a class="el" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00709">IopFreeRelationList()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05597">IopRestartDeviceNode()</a>, <a class="el" href="../../d7/d1/pnprlist_8h.html#a17">IopSetAllRelationsTags()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l01232">IopSetRelationsTag()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00301">_DEVICE_NODE::LockCount</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a218">ReenumerateDeviceTree</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01417">IopProcessCompletedEject()</a>.
<p>
<pre class="fragment"><div>01259                    :
01260 
01261     Iterate over <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relations in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list creating a second list containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01262     parent of each entry skipping parents which are also in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.  In other
01263     words, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list contains node P and node C where node C <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a child of node
01264     P then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent of node P would be added but not node P itself.
01265 
01266 
01267 Arguments:
01268 
01269     RelationsList           - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> of relations
01270 
01271     OnlyIndirectDescendants - Indirect relations are those which aren'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> direct
01272                               descendants (bus relations) of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO originally
01273                               targetted <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation or its direct
01274                               descendants.  This would include Removal or
01275                               Eject relations.
01276 
01277     UnlockDevNode           - If <span class="keyword">true</span> then any node who's parent was invalidated
01278                               <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unlocked.  In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also
01279                               in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still unlocked as will <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01280                               parent be once we process <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01281 
01282     RestartDevNode          - If <span class="keyword">true</span> then any node who's parent was invalidated
01283                               <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> restarted.  This flag requires that all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01284                               relations in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list have been previously
01285                               sent a remove <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
01286 
01287 
01288 Return Value:
01289 
01290     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01291 
01292 --*/
01293 
01294 {
01295     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>                  parentsList;
01296     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>                  deviceObject, parentObject;
01297     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>                    deviceNode, parentNode;
01298     ULONG                           marker;
01299     BOOLEAN                         directDescendant, tagged;
01300 
01301     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01302 
01303     parentsList = <a class="code" href="../../d6/d1/pnprlist_8c.html#a4">IopAllocateRelationList</a>();
01304 
01305     <span class="keywordflow">if</span> (parentsList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01306         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01307     }
01308 
01309     <a class="code" href="../../d7/d1/pnprlist_8h.html#a17">IopSetAllRelationsTags</a>( RelationsList, FALSE );
01310 
01311     <span class="comment">//</span>
01312     <span class="comment">// Traverse the list creating a new list with the topmost parents of</span>
01313     <span class="comment">// each sublist contained in RelationsList.</span>
01314     <span class="comment">//</span>
01315 
01316     marker = 0;
01317 
01318     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations</a>( RelationsList,
01319                                   &amp;marker,
01320                                   &amp;deviceObject,
01321                                   &amp;directDescendant,
01322                                   &amp;tagged,
01323                                   TRUE)) {
01324 
01325         <span class="keywordflow">if</span> (!OnlyIndirectDescendants || !directDescendant) {
01326 
01327             <span class="keywordflow">if</span> (!tagged) {
01328 
01329                 parentObject = deviceObject;
01330 
01331                 <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/pnprlist_8h.html#a18">IopSetRelationsTag</a>( RelationsList, parentObject, TRUE ) == STATUS_SUCCESS) {
01332 
01333                     deviceNode = parentObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01334 
01335                     <span class="keywordflow">if</span> (RestartDevNode)  {
01336 
01337                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a36">DNF_LOCKED_FOR_EJECT</a>;
01338 
01339                         <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>)) ==
01340                             (<a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>)) {
01341 
01342                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a> == NULL);
01343                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; DNF_ADDED));
01344 
01345                             <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>( deviceNode );
01346                             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a36">IopRestartDeviceNode</a>( deviceNode );
01347                         }
01348                     }
01349 
01350                     <span class="keywordflow">if</span> (UnlockDevNode) {
01351                         parentNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
01352 
01353                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(parentNode != NULL);
01354 
01355                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> &gt; 0);
01356 
01357                         <span class="keywordflow">if</span> (--deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
01358                             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, FALSE);
01359                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
01360                         }
01361 
01362                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> &gt; 0);
01363 
01364                         <span class="keywordflow">if</span> (--parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
01365                             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, FALSE);
01366                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
01367                         }
01368                     }
01369 
01370                     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01371 
01372                         parentObject = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
01373 
01374                     } <span class="keywordflow">else</span> {
01375                         parentObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01376                         <span class="keywordflow">break</span>;
01377                     }
01378                 }
01379 
01380                 <span class="keywordflow">if</span> (parentObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
01381                     <a class="code" href="../../d7/d1/pnprlist_8h.html#a7">IopAddRelationToList</a>( parentsList, parentObject, FALSE, FALSE );
01382                 }
01383             }
01384 
01385         }
01386     }
01387 
01388     <span class="comment">//</span>
01389     <span class="comment">// Reenumerate each of the parents</span>
01390     <span class="comment">//</span>
01391 
01392     marker = 0;
01393 
01394     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations</a>( parentsList,
01395                                   &amp;marker,
01396                                   &amp;deviceObject,
01397                                   NULL,
01398                                   NULL,
01399                                   FALSE)) {
01400 
01401         <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>( deviceObject,
01402                                 ReenumerateDeviceTree,
01403                                 NULL,
01404                                 NULL );
01405     }
01406 
01407     <span class="comment">//</span>
01408     <span class="comment">// Free the parents list</span>
01409     <span class="comment">//</span>
01410 
01411     <a class="code" href="../../d7/d1/pnprlist_8h.html#a10">IopFreeRelationList</a>( parentsList );
01412 
01413     <span class="keywordflow">return</span> STATUS_SUCCESS;
01414 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a367" doxytag="pnpiop.h::IopIrqInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopIrqInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/pnpirq_8c-source.html#l00196">196</a> of file <a class="el" href="../../d2/d0/pnpirq_8c-source.html">pnpirq.c</a>.
<p>
References <a class="el" href="../../d9/d7/arbiter_8c-source.html#l00192">ArbInitializeArbiterInstance()</a>, <a class="el" href="../../d2/d0/pnpirq_8c-source.html#l00338">IopIrqPackResource()</a>, <a class="el" href="../../d2/d0/pnpirq_8c-source.html#l00296">IopIrqScoreRequirement()</a>, <a class="el" href="../../d2/d0/pnpirq_8c-source.html#l00100">IopIrqTranslateOrdering()</a>, <a class="el" href="../../d2/d0/pnpirq_8c-source.html#l00241">IopIrqUnpackRequirement()</a>, <a class="el" href="../../d2/d0/pnpirq_8c-source.html#l00387">IopIrqUnpackResource()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00207">IopRootIrqArbiter</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00525">_ARBITER_INSTANCE::PackResource</a>, <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00527">_ARBITER_INSTANCE::ScoreRequirement</a>, <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00524">_ARBITER_INSTANCE::UnpackRequirement</a>, and <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00526">_ARBITER_INSTANCE::UnpackResource</a>.
<p>
<pre class="fragment"><div>00202                    :
00203 
00204     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arbiter
00205 
00206 Parameters:
00207 
00208     None
00209 
00210 Return Value:
00211 
00212     None
00213 
00214 --*/
00215 
00216 {
00217 
00218     <a class="code" href="../../d1/d0/pnpdata_8c.html#a33">IopRootIrqArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o12">UnpackRequirement</a> = <a class="code" href="../../d1/d1/pnpirq_8c.html#a2">IopIrqUnpackRequirement</a>;
00219     <a class="code" href="../../d1/d0/pnpdata_8c.html#a33">IopRootIrqArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o13">PackResource</a>      = <a class="code" href="../../d1/d1/pnpirq_8c.html#a3">IopIrqPackResource</a>;
00220     <a class="code" href="../../d1/d0/pnpdata_8c.html#a33">IopRootIrqArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o14">UnpackResource</a>    = <a class="code" href="../../d1/d1/pnpirq_8c.html#a5">IopIrqUnpackResource</a>;
00221     <a class="code" href="../../d1/d0/pnpdata_8c.html#a33">IopRootIrqArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o15">ScoreRequirement</a>  = <a class="code" href="../../d1/d1/pnpirq_8c.html#a4">IopIrqScoreRequirement</a>;
00222 
00223     <span class="keywordflow">return</span> <a class="code" href="../../d9/d8/arbiter_8h.html#a67">ArbInitializeArbiterInstance</a>(&amp;IopRootIrqArbiter,
00224                                         NULL,     <span class="comment">// Indicates ROOT arbiter</span>
00225                                         CmResourceTypeInterrupt,
00226                                         L<span class="stringliteral">"RootIRQ"</span>,
00227                                         L<span class="stringliteral">"Root"</span>,
00228 #<span class="keywordflow">if</span> defined(NO_LEGACY_DRIVERS)
00229                                         NULL
00230 #<span class="keywordflow">else</span>
00231                                         IopIrqTranslateOrdering
00232 #endif <span class="comment">// NO_LEGACY_DRIVERS</span>
00233                                         );
00234 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a320" doxytag="pnpiop.h::IopIsAnyDeviceInstanceEnabled" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsAnyDeviceInstanceEnabled           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LegacyIncluded</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">3181</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01471">IopGetDeviceInstanceCsConfigFlags()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">IopIsDevNodeProblem</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>.
<p>
<pre class="fragment"><div>03189                    :
03190 
03191     This routine checks <span class="keywordflow">if</span> any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices instances <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> turned on <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
03192     service. This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> Pnp Driver <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> temporary function to support
03193     SUR.
03194 
03195 Arguments:
03196 
03197     ServiceKeyName - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key unicode name
03198 
03199     ServiceHandle - Optionally supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key to be checked.
03200 
03201     LegacyIncluded - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, a legacy device instance key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> counted as a device instance.
03202                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, a legacy device instance key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not counted.
03203 
03204 Returns:
03205 
03206     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BOOLEAN value.
03207 
03208 --*/
03209 
03210 {
03211     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03212     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03213     HANDLE serviceEnumHandle, handle, controlHandle;
03214     ULONG i, count, deviceFlags;
03215     UNICODE_STRING unicodeName;
03216     BOOLEAN enabled, setProblem, closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03217     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDeviceObject;
03218     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03219 
03220     <span class="comment">//</span>
03221     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
03222     <span class="comment">//</span>
03223 
03224     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(ServiceHandle)) {
03225         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
03226                                         KEY_READ,
03227                                         &amp;ServiceHandle,
03228                                         &amp;serviceEnumHandle,
03229                                         FALSE
03230                                         );
03231         closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03232     } <span class="keywordflow">else</span> {
03233         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_ENUM);
03234         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;serviceEnumHandle,
03235                                        ServiceHandle,
03236                                        &amp;unicodeName,
03237                                        KEY_READ
03238                                        );
03239     }
03240     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03241 
03242         <span class="comment">//</span>
03243         <span class="comment">// No Service Enum key? no device instance.  Return FALSE.</span>
03244         <span class="comment">//</span>
03245 
03246         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03247     }
03248 
03249     <span class="comment">//</span>
03250     <span class="comment">// Find out how many device instances listed in the ServiceName's</span>
03251     <span class="comment">// Enum key.</span>
03252     <span class="comment">//</span>
03253 
03254     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( serviceEnumHandle,
03255                                    REGSTR_VALUE_COUNT,
03256                                    &amp;keyValueInformation
03257                                    );
03258     ZwClose(serviceEnumHandle);
03259     count = 0;
03260     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03261         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03262             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03263 
03264             count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03265         }
03266         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03267     }
03268     <span class="keywordflow">if</span> (count == 0) {
03269         <span class="keywordflow">if</span> (closeHandle) {
03270             ZwClose(ServiceHandle);
03271         }
03272         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03273     }
03274 
03275     <span class="comment">//</span>
03276     <span class="comment">// Walk through each registered device instance to check it is enabled.</span>
03277     <span class="comment">//</span>
03278 
03279     enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03280     <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
03281 
03282         <span class="comment">//</span>
03283         <span class="comment">// Get device instance handle.  If it fails, we will skip this device</span>
03284         <span class="comment">// instance.</span>
03285         <span class="comment">//</span>
03286 
03287         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (
03288                      ServiceHandle,
03289                      NULL,
03290                      i,
03291                      NULL,
03292                      &amp;handle,
03293                      KEY_ALL_ACCESS
03294                      );
03295         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03296             <span class="keywordflow">continue</span>;
03297         }
03298 
03299         physicalDeviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(handle, NULL);
03300         <span class="keywordflow">if</span> (physicalDeviceObject) {
03301             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)physicalDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03302             <span class="keywordflow">if</span> (deviceNode &amp;&amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_DISABLED) || <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_HARDWARE_DISABLED))) {
03303                 ZwClose(handle);
03304                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
03305                 <span class="keywordflow">continue</span>;
03306             }
03307         } <span class="keywordflow">else</span> {
03308             deviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03309         }
03310 
03311         <span class="comment">//</span>
03312         <span class="comment">// Check if the device instance has been disabled.</span>
03313         <span class="comment">// First check global flag: CONFIGFLAG and then CSCONFIGFLAG.</span>
03314         <span class="comment">//</span>
03315 
03316         deviceFlags = 0;
03317         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
03318                                      REGSTR_VALUE_CONFIG_FLAGS,
03319                                      &amp;keyValueInformation);
03320         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03321             <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03322                 (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03323 
03324                 deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03325             }
03326             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03327         }
03328 
03329         <span class="keywordflow">if</span> (deviceFlags &amp; CONFIGFLAG_DISABLED) {
03330 
03331             <span class="comment">//</span>
03332             <span class="comment">// Convert this flag into the hardware profile-specific version, so it'll</span>
03333             <span class="comment">// look the same as the CsConfigFlags we retrieve below.</span>
03334             <span class="comment">//</span>
03335 
03336             deviceFlags = CSCONFIGFLAG_DISABLED;
03337 
03338         } <span class="keywordflow">else</span> {
03339 
03340             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a11">IopGetServiceInstanceCsConfigFlags</a>( ServiceKeyName,
03341                                                          i,
03342                                                          &amp;deviceFlags
03343                                                          );
03344 
03345             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03346                 deviceFlags = 0;
03347             }
03348         }
03349 
03350         <span class="comment">//</span>
03351         <span class="comment">// If the device is disabled (either globally, or specifically for this</span>
03352         <span class="comment">// hardware profile), then mark the devnode as DNF_DISABLED.</span>
03353         <span class="comment">//</span>
03354 
03355         <span class="keywordflow">if</span> ((deviceFlags &amp; CSCONFIGFLAG_DISABLED) || (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_START)) {
03356 
03357             <span class="keywordflow">if</span> (deviceNode) {
03358                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a>(deviceNode, handle);
03359             }
03360         }
03361 
03362         <span class="keywordflow">if</span> (physicalDeviceObject) {
03363             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
03364         }
03365 
03366         <span class="comment">//</span>
03367         <span class="comment">// Finally, we need to set the STATUSFLAGS of the device instance to</span>
03368         <span class="comment">// indicate if the driver is successfully started.</span>
03369         <span class="comment">//</span>
03370 
03371         <span class="keywordflow">if</span> (!(deviceFlags &amp; (CSCONFIGFLAG_DISABLED | CSCONFIGFLAG_DO_NOT_CREATE | CSCONFIGFLAG_DO_NOT_START))) {
03372 
03373             ULONG legacy;
03374 
03375             <span class="comment">//</span>
03376             <span class="comment">// Check should legacy instance key be counted as an enabled device</span>
03377             <span class="comment">//</span>
03378 
03379             <span class="keywordflow">if</span> (LegacyIncluded == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03380 
03381                 <span class="comment">//</span>
03382                 <span class="comment">// The legacy variable must be initialized to zero.  Because the device</span>
03383                 <span class="comment">// instance key may be an enumerated device.  In this case, there is no</span>
03384                 <span class="comment">// legacy value name.</span>
03385                 <span class="comment">//</span>
03386 
03387                 legacy = 0;
03388                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
03389                                              REGSTR_VALUE_LEGACY,
03390                                              &amp;keyValueInformation
03391                                              );
03392                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03393                     <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03394                         (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03395                         legacy = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03396                     }
03397                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03398                 }
03399             } <span class="keywordflow">else</span> {
03400                 legacy = 0;
03401             }
03402 
03403             <span class="keywordflow">if</span> (legacy == 0) {
03404 
03405                 <span class="comment">//</span>
03406                 <span class="comment">// Mark that the driver has at least a device instance to work with.</span>
03407                 <span class="comment">//</span>
03408 
03409                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
03410                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;controlHandle,
03411                                                  handle,
03412                                                  &amp;unicodeName,
03413                                                  KEY_ALL_ACCESS,
03414                                                  REG_OPTION_VOLATILE,
03415                                                  NULL
03416                                                  );
03417                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03418                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_ACTIVESERVICE);
03419                     ZwSetValueKey(
03420                                 controlHandle,
03421                                 &amp;unicodeName,
03422                                 TITLE_INDEX_VALUE,
03423                                 REG_SZ,
03424                                 ServiceKeyName-&gt;Buffer,
03425                                 ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
03426                                 );
03427 
03428                     ZwClose(controlHandle);
03429                 }
03430                 enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03431             }
03432         }
03433         ZwClose(handle);
03434     }
03435 
03436     <span class="keywordflow">if</span> (closeHandle) {
03437         ZwClose(ServiceHandle);
03438     }
03439     <span class="keywordflow">return</span> enabled;
03440 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a259" doxytag="pnpiop.h::IopIsDeviceInstanceEnabled" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsDeviceInstanceEnabled           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceInstanceHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceInstance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DisableIfEnabled</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03443">3443</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00179">CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">IopIsDevNodeProblem</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01516">IopGetDriverDeviceListWorker()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05138">IopProcessNewProfileStateCallback()</a>.
<p>
<pre class="fragment"><div>03451                    :
03452 
03453     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified devices instances <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> enabled.
03454 
03455 Arguments:
03456 
03457     DeviceInstanceHandle - Optionally supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance
03458         key to be checked.
03459 
03460     DeviceInstance - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance key unicode name.  Caller
03461         must at least specified DeviceInstanceHandle or DeviceInstance.
03462 
03463     DisableIfEnabled - If <span class="keyword">this</span> flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device should be disabled
03464         but <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently disabled, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> disabled.
03465 
03466 Returns:
03467 
03468     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BOOLEAN value.
03469 
03470 --*/
03471 
03472 {
03473     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03474     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03475     HANDLE handle, handle1;
03476     ULONG deviceFlags;
03477     BOOLEAN enabled, closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03478     UNICODE_STRING unicodeString;
03479     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03480     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03481 
03482     <span class="comment">//</span>
03483     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
03484     <span class="comment">//</span>
03485 
03486     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(DeviceInstanceHandle)) {
03487         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03488                                        NULL,
03489                                        &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
03490                                        KEY_READ
03491                                        );
03492 
03493         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03494 
03495             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;DeviceInstanceHandle,
03496                                            handle,
03497                                            DeviceInstance,
03498                                            KEY_READ
03499                                            );
03500             ZwClose(handle);
03501         }
03502 
03503         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03504             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03505         }
03506         closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03507     }
03508 
03509     enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03510 
03511     <span class="comment">//</span>
03512     <span class="comment">// First check the device node</span>
03513     <span class="comment">//</span>
03514 
03515     deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(DeviceInstanceHandle, NULL);
03516     <span class="keywordflow">if</span> (deviceObject) {
03517         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03518         <span class="keywordflow">if</span> (deviceNode &amp;&amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_DISABLED) || <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_DISABLED))) {
03519             enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03520             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03521         }
03522     }
03523 
03524     <span class="comment">//</span>
03525     <span class="comment">// Check if the device instance has been disabled.</span>
03526     <span class="comment">// First check global flag: CONFIGFLAG and then CSCONFIGFLAG.</span>
03527     <span class="comment">//</span>
03528 
03529     deviceFlags = 0;
03530     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(DeviceInstanceHandle,
03531                                  REGSTR_VALUE_CONFIG_FLAGS,
03532                                  &amp;keyValueInformation);
03533     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03534         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03535             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03536             deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03537         }
03538         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03539     }
03540     <span class="keywordflow">if</span> (!(deviceFlags &amp; CONFIGFLAG_DISABLED)) {
03541         enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03542 
03543         <span class="comment">//</span>
03544         <span class="comment">// See if we can open current hardware profile</span>
03545         <span class="comment">//</span>
03546         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
03547                                        NULL,
03548                                        &amp;CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent,
03549                                        KEY_READ
03550                                        );
03551 
03552         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; DeviceInstance != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03553 
03554             <span class="comment">//</span>
03555             <span class="comment">// Now, we must open the System\CCS\Enum key under this.</span>
03556             <span class="comment">//</span>
03557             <span class="comment">//</span>
03558             <span class="comment">// Open system\CurrentControlSet under current hardware profile key</span>
03559             <span class="comment">//</span>
03560 
03561             PiWstrToUnicodeString(&amp;unicodeString, REGSTR_PATH_CURRENTCONTROLSET);
03562             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03563                                            handle1,
03564                                            &amp;unicodeString,
03565                                            KEY_READ
03566                                            );
03567             ZwClose(handle1);
03568             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03569                 PiWstrToUnicodeString(&amp;unicodeString, REGSTR_KEY_ENUM);
03570                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
03571                                                handle,
03572                                                &amp;unicodeString,
03573                                                KEY_READ
03574                                                );
03575                 ZwClose(handle);
03576                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03577                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03578                                                    handle1,
03579                                                    DeviceInstance,
03580                                                    KEY_READ
03581                                                    );
03582                     ZwClose(handle1);
03583                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03584                         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(
03585                                         handle,
03586                                         REGSTR_VALUE_CSCONFIG_FLAGS,
03587                                         &amp;keyValueInformation
03588                                         );
03589                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03590                             <span class="keywordflow">if</span>((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03591                                (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03592                                deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03593                             }
03594                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03595                         }
03596                         ZwClose(handle);
03597                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03598                             <span class="keywordflow">if</span> ((deviceFlags &amp; CSCONFIGFLAG_DISABLED) ||
03599                                 (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_CREATE) ||
03600                                 (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_START)) {
03601                                 enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03602                             }
03603                         }
03604                     }
03605                 }
03606             }
03607         }
03608     } <span class="keywordflow">else</span> {
03609         enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03610     }
03611 
03612     <span class="comment">//</span>
03613     <span class="comment">// If the device is disabled and has device node associated with it.</span>
03614     <span class="comment">// disable the device.</span>
03615     <span class="comment">//</span>
03616 
03617     <span class="keywordflow">if</span> (enabled == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; deviceNode &amp;&amp; DisableIfEnabled) {
03618         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a>(deviceNode, DeviceInstanceHandle);
03619     }
03620 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
03621     <span class="keywordflow">if</span> (deviceObject) {
03622         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);
03623     }
03624     <span class="keywordflow">if</span> (closeHandle) {
03625         ZwClose(DeviceInstanceHandle);
03626     }
03627     <span class="keywordflow">return</span> enabled;
03628 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a230" doxytag="pnpiop.h::IopIsDuplicatedDevices" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsDuplicatedDevices           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>Configuration1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>Configuration2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo1&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo2&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02554">2554</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02286">IopIsReportedAlready()</a>.
<p>
<pre class="fragment"><div>02563                    :
02564 
02565     This routine compares two set of configurations and bus information to
02566     determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same device.  If BusInfo1 and
02567     BusInfo2 both are absent, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> means caller wants to compare <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> raw
02568     resources.
02569 
02570 Arguments:
02571 
02572     Configuration1 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first set of resource.
02573 
02574     Configuration2 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second set of resource.
02575 
02576     BusInfo1 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first set of bus information.
02577 
02578     BusInfo2 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second set of bus information.
02579 
02580 Return Value:
02581 
02582     returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two set of resources indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same device;
02583     otherwise a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02584 
02585 --*/
02586 
02587 {
02588     PCM_PARTIAL_RESOURCE_LIST list1, list2;
02589     PCM_PARTIAL_RESOURCE_DESCRIPTOR descriptor1, descriptor2;
02590 
02591     ULONG i, j;
02592     ULONG pass = 0;
02593 
02594     <span class="comment">//</span>
02595     <span class="comment">// The BusInfo for both resources must be both present or not present.</span>
02596     <span class="comment">//</span>
02597 
02598     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT(BusInfo1) &amp;&amp; !ARGUMENT_PRESENT(BusInfo2)) ||
02599         (!ARGUMENT_PRESENT(BusInfo1) &amp;&amp; ARGUMENT_PRESENT(BusInfo2))) {
02600 
02601         <span class="comment">//</span>
02602         <span class="comment">// Unable to determine.</span>
02603         <span class="comment">//</span>
02604 
02605         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02606     }
02607 
02608     <span class="comment">//</span>
02609     <span class="comment">// Next check resources used by the two devices.</span>
02610     <span class="comment">// Currently, we *only* check the Io ports.</span>
02611     <span class="comment">//</span>
02612 
02613     <span class="keywordflow">if</span> (Configuration1-&gt;Count == 0 || Configuration2-&gt;Count == 0) {
02614 
02615         <span class="comment">//</span>
02616         <span class="comment">// If any one of the configuration data is empty, we assume</span>
02617         <span class="comment">// the devices are not duplicates.</span>
02618         <span class="comment">//</span>
02619 
02620         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02621     }
02622 
02623 RedoScan:
02624 
02625     list1 = &amp;(Configuration1-&gt;List[0].PartialResourceList);
02626     list2 = &amp;(Configuration2-&gt;List[0].PartialResourceList);
02627 
02628     <span class="keywordflow">for</span>(i = 0, descriptor1 = list1-&gt;PartialDescriptors;
02629         i &lt; list1-&gt;Count;
02630         i++, descriptor1++) {
02631 
02632         <span class="comment">//</span>
02633         <span class="comment">// If this is an i/o port or a memory range then look for a match</span>
02634         <span class="comment">// in the other list.</span>
02635         <span class="comment">//</span>
02636 
02637         <span class="keywordflow">if</span>((descriptor1-&gt;Type == CmResourceTypePort) ||
02638            (descriptor1-&gt;Type == CmResourceTypeMemory)) {
02639 
02640             <span class="keywordflow">for</span>(j = 0, descriptor2 = list2-&gt;PartialDescriptors;
02641                 j &lt; list2-&gt;Count;
02642                 j++, descriptor2++) {
02643 
02644                 <span class="comment">//</span>
02645                 <span class="comment">// If the types match then check to see if both addresses</span>
02646                 <span class="comment">// match as well.  If bus info was provided then go ahead</span>
02647                 <span class="comment">// and translate the ranges first.</span>
02648                 <span class="comment">//</span>
02649 
02650                 <span class="keywordflow">if</span>(descriptor1-&gt;Type == descriptor2-&gt;Type) {
02651 
02652                     PHYSICAL_ADDRESS range1, range1Translated;
02653                     PHYSICAL_ADDRESS range2, range2Translated;
02654                     ULONG range1IoSpace, range2IoSpace;
02655 
02656                     range1 = descriptor1-&gt;u.Generic.Start;
02657                     range2 = descriptor2-&gt;u.Generic.Start;
02658 
02659                     <span class="keywordflow">if</span>((range1.QuadPart == 0) ||
02660                        (BusInfo1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02661                        (<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>(
02662                             BusInfo1-&gt;BusType,
02663                             BusInfo1-&gt;BusNumber,
02664                             range1,
02665                             &amp;range1IoSpace,
02666                             &amp;range1Translated) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02667 
02668                         range1Translated = range1;
02669                         range1IoSpace =
02670                             (descriptor1-&gt;Type == CmResourceTypePort) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> :
02671                                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02672                     }
02673 
02674                     <span class="keywordflow">if</span>((range2.QuadPart == 0) ||
02675                        (BusInfo2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02676                        (<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>(
02677                             BusInfo2-&gt;BusType,
02678                             BusInfo2-&gt;BusNumber,
02679                             range2,
02680                             &amp;range2IoSpace,
02681                             &amp;range2Translated) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02682 
02683                         range2Translated = range2;
02684                         range2IoSpace =
02685                             (descriptor2-&gt;Type == CmResourceTypePort) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> :
02686                                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02687                     }
02688 
02689                     <span class="comment">//</span>
02690                     <span class="comment">// If the ranges are in the same space and start at the</span>
02691                     <span class="comment">// same location then break out and go on to the next</span>
02692                     <span class="comment">// range</span>
02693                     <span class="comment">//</span>
02694 
02695                     <span class="keywordflow">if</span>((range1Translated.QuadPart == range2Translated.QuadPart) &amp;&amp;
02696                        (range1IoSpace == range2IoSpace)) {
02697 
02698                         <span class="keywordflow">break</span>;
02699                     }
02700                 }
02701             }
02702 
02703             <span class="comment">//</span>
02704             <span class="comment">// If we made it all the way through the resource list without</span>
02705             <span class="comment">// finding a match then these are not duplicates.</span>
02706             <span class="comment">//</span>
02707 
02708             <span class="keywordflow">if</span>(j == list2-&gt;Count) {
02709                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02710             }
02711         }
02712     }
02713 
02714     <span class="comment">//</span>
02715     <span class="comment">// If every resource in list 1 exists in list 2 then we also need to make</span>
02716     <span class="comment">// sure that every resource in list 2 exists in list 1.</span>
02717     <span class="comment">//</span>
02718 
02719     <span class="keywordflow">if</span>(pass == 0) {
02720 
02721         PVOID tmp ;
02722 
02723         tmp = Configuration2;
02724         Configuration2 = Configuration1;
02725         Configuration1 = tmp;
02726 
02727         tmp = BusInfo2;
02728         BusInfo2 = BusInfo1;
02729         BusInfo1 = tmp;
02730 
02731         pass = 1;
02732 
02733         <span class="keywordflow">goto</span> RedoScan;
02734     }
02735 
02736     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02737 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a249" doxytag="pnpiop.h::IopIsFirmwareMapperDevicePresent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsFirmwareMapperDevicePresent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01572">1572</a> of file <a class="el" href="../../d8/d9/pnpinit_8c-source.html">pnpinit.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>.
<p>
<pre class="fragment"><div>01578                    :
01579 
01580     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created by FirmwareMapper.
01581     If Yes, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> further checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present in <span class="keyword">this</span>
01582     boot.
01583 
01584 Parameters:
01585 
01586     KeyHandle - Specifies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry key to be checked.
01587 
01588 Return Value:
01589 
01590     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BOOLEAN vaStatus code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
01591 
01592 --*/
01593 {
01594     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01595     HANDLE handle;
01596     UNICODE_STRING unicodeName;
01597     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01598     ULONG tmp = 0;
01599 
01600     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01601 
01602     <span class="comment">//</span>
01603     <span class="comment">// First check to see if this device instance key is a firmware-created one</span>
01604     <span class="comment">//</span>
01605 
01606     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (KeyHandle,
01607                                   REGSTR_VAL_FIRMWAREIDENTIFIED,
01608                                   &amp;keyValueInformation);
01609     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01610         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
01611             (keyValueInformation-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG))) {
01612 
01613             tmp = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01614         }
01615         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01616     }
01617     <span class="keywordflow">if</span> (tmp == 0) {
01618         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01619     }
01620 
01621     <span class="comment">//</span>
01622     <span class="comment">// Make sure the device is present.</span>
01623     <span class="comment">//</span>
01624 
01625     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
01626     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
01627                                    KeyHandle,
01628                                    &amp;unicodeName,
01629                                    KEY_READ
01630                                    );
01631     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01632         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01633     }
01634 
01635     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
01636                                   REGSTR_VAL_FIRMWAREMEMBER,
01637                                   &amp;keyValueInformation);
01638     ZwClose(handle);
01639     tmp = 0;
01640 
01641     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01642         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
01643             (keyValueInformation-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG))) {
01644 
01645             tmp = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01646         }
01647         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01648     }
01649     <span class="keywordflow">if</span> (!tmp) {
01650         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01651     } <span class="keywordflow">else</span> {
01652         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01653     }
01654 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a288" doxytag="pnpiop.h::IopIsLegacyDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsLegacyDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05290">5290</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01300">DRVO_LEGACY_DRIVER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>05296                    :
05297 
05298     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object specifies a legacy driver.
05299 
05300 Arguments:
05301 
05302     DriverObject - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object to be checked.
05303 
05304 Return Value:
05305 
05306     BOOLEAN
05307 
05308 --*/
05309 
05310 {
05311 
05312     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05313 
05314     <span class="comment">//</span>
05315     <span class="comment">// If AddDevice entry is not empty it is a wdm driver</span>
05316     <span class="comment">//</span>
05317 
05318     <span class="keywordflow">if</span> (DriverObject-&gt;DriverExtension-&gt;AddDevice) {
05319         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05320     }
05321 
05322     <span class="comment">//</span>
05323     <span class="comment">// Else if LEGACY flag is set in the driver object, it's a legacy driver.</span>
05324     <span class="comment">//</span>
05325 
05326     <span class="keywordflow">if</span> (DriverObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a144">DRVO_LEGACY_DRIVER</a>) {
05327         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05328     } <span class="keywordflow">else</span> {
05329         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05330     }
05331 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a324" doxytag="pnpiop.h::IopLegacyResourceAllocation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopLegacyResourceAllocation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceRequirements</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCM_RESOURCE_LIST *AllocatedResources&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">6180</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00767">_IOP_RESOURCE_REQUEST::AllocationType</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a129">ArbiterRequestPnpDetected</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00447">DNF_ASSIGNING_RESOURCES</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00453">DNF_RESOURCE_ASSIGNED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00459">DNF_RESOURCE_REPORTED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01306">DRVO_LEGACY_RESOURCES</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00071">ExAllocatePoolIORL</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00757">IOP_ASSIGN_NO_REBALANCE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06726">IopCombineLegacyResources()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03523">IopDetermineResourceListSize()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">IopFindLegacyDeviceNode()</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00037">IoPnpDriverObject</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00337">IopRegistrySemaphore</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07383">IopReleaseResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06083">IopRemoveLegacyDeviceNode()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o32">_DEVICE_NODE::OverUsed1</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00765">_IOP_RESOURCE_REQUEST::PhysicalDevice</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00161">_DEVICE_NODE::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00163">_DEVICE_NODE::ResourceListTranslated</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00769">_IOP_RESOURCE_REQUEST::ResourceRequirements</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d8/assign_8c-source.html#l00394">IoAssignResources()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, and <a class="el" href="../../d2/d7/report_8c-source.html#l00469">IoReportResourceUsageInternal()</a>.
<p>
<pre class="fragment"><div>06190                    :
06191 
06192     This routine handles legacy interface <a class="code" href="../../d0/d5/io_8h.html#a451">IoAssignResources</a> and IoReportResourcesUsage,
06193     It converts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request to call <a class="code" href="../../d9/d0/pnpiop_8h.html#a297">IopAllocateResources</a>.
06194 
06195 Parameters:
06196 
06197     AllocationType - Allocation <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> legacy request.
06198 
06199     DriverObject - Driver object doing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> legacy allocation.
06200 
06201     DeviceObject - Device object.
06202 
06203     ResourceRequirements - Legacy resource requirements. If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, caller want to free resources.
06204 
06205     AllocatedResources - Pointer to a variable that receives pointer to allocated resources.
06206 
06207 Return Value:
06208 
06209     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
06210 
06211 --*/
06212 
06213 {
06214     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>      pdo;
06215     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>        deviceNode;
06216     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>        legacyDeviceNode;
06217     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
06218     PCM_RESOURCE_LIST   combinedResources;
06219     KIRQL               irql;
06220 
06221     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DriverObject);
06222 
06223     <span class="comment">//</span>
06224     <span class="comment">// Grab the IO registry semaphore to make sure no other device is</span>
06225     <span class="comment">// reporting it's resource usage while we are searching for conflicts.</span>
06226     <span class="comment">//</span>
06227 
06228     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
06229 
06230     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;IopRegistrySemaphore,
06231                                     DelayExecution,
06232                                     KernelMode,
06233                                     FALSE,
06234                                     NULL);
06235     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06236 
06237         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a54">IopFindLegacyDeviceNode</a>(DriverObject, DeviceObject, &amp;deviceNode, &amp;pdo);
06238         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06239 
06240             legacyDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06241             <span class="keywordflow">if</span> (!deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a> &amp;&amp; ResourceRequirements) {
06242 
06243                 <span class="comment">//</span>
06244                 <span class="comment">// Make IopRootDeviceNode the bus pdo so we will search the right bus pdo</span>
06245                 <span class="comment">// on resource descriptor level.</span>
06246                 <span class="comment">//</span>
06247 
06248                 <span class="keywordflow">if</span> (ResourceRequirements-&gt;InterfaceType == InterfaceTypeUndefined) {
06249 
06250                     ResourceRequirements-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
06251 
06252                 }
06253                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a> = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>;
06254 
06255             }
06256 
06257             <span class="comment">//</span>
06258             <span class="comment">// Release resources for this device node.</span>
06259             <span class="comment">//</span>
06260 
06261             <span class="keywordflow">if</span> (    (!ResourceRequirements &amp;&amp; deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>) ||
06262                     (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>))) {
06263 
06264                 <a class="code" href="../../d5/d1/pnpres_8c.html#a88">IopReleaseResources</a>(deviceNode);
06265 
06266             }
06267 
06268             <span class="keywordflow">if</span> (ResourceRequirements) {
06269 
06270                 <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>    requestTable;
06271                 <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>    *requestTablep;
06272                 ULONG                   count;
06273 
06274                 <span class="comment">//</span>
06275                 <span class="comment">// Try to allocate these resource requirements.</span>
06276                 <span class="comment">//</span>
06277 
06278                 count = 1;
06279                 RtlZeroMemory(&amp;requestTable, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>));
06280                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> = ResourceRequirements;
06281                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> = pdo;
06282                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a70">IOP_ASSIGN_NO_REBALANCE</a>;
06283                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> =  AllocationType;
06284 
06285                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
06286                 requestTablep = &amp;requestTable;
06287                 <a class="code" href="../../d5/d1/pnpres_8c.html#a105">IopAllocateResources</a>(&amp;count, &amp;requestTablep, TRUE, TRUE);
06288                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
06289                 status = requestTable.Status;
06290                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06291 
06292                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>;
06293                     <span class="comment">//deviceNode-&gt;Flags &amp;= ~DNF_INSUFFICIENT_RESOURCES;</span>
06294                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a> = requestTable.TranslatedResourceAssignment;
06295                     count = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>((*AllocatedResources) ? *AllocatedResources : requestTable.ResourceAssignment);
06296                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a12">ExAllocatePoolIORL</a>(PagedPool, count);
06297                     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
06298 
06299                         <span class="keywordflow">if</span> (*AllocatedResources) {
06300 
06301                             <span class="comment">//</span>
06302                             <span class="comment">// We got called from IoReportResourceUsage.</span>
06303                             <span class="comment">//</span>
06304 
06305                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(requestTable.ResourceAssignment);
06306                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(requestTable.ResourceAssignment);
06307 
06308                         } <span class="keywordflow">else</span> {
06309 
06310                             <span class="comment">//</span>
06311                             <span class="comment">// We got called from IoAssignResources.</span>
06312                             <span class="comment">//</span>
06313 
06314                             *AllocatedResources = requestTable.ResourceAssignment;
06315 
06316                         }
06317                         RtlCopyMemory(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>, *AllocatedResources, count);
06318                         legacyDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.LegacyDeviceNode;
06319 
06320                     } <span class="keywordflow">else</span> {
06321 
06322                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = requestTable.ResourceAssignment;
06323                         <a class="code" href="../../d5/d1/pnpres_8c.html#a88">IopReleaseResources</a>(deviceNode);
06324                         status = STATUS_INSUFFICIENT_RESOURCES;
06325 
06326                     }
06327                 }
06328 
06329                 <span class="comment">//</span>
06330                 <span class="comment">// Remove the madeup PDO and device node if there was some error.</span>
06331                 <span class="comment">//</span>
06332 
06333                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06334 
06335                     <a class="code" href="../../d5/d1/pnpres_8c.html#a53">IopRemoveLegacyDeviceNode</a>(DeviceObject, deviceNode);
06336 
06337                 }
06338 
06339             } <span class="keywordflow">else</span> {
06340 
06341                 <span class="comment">//</span>
06342                 <span class="comment">// Caller wants to release resources.</span>
06343                 <span class="comment">//</span>
06344 
06345                 legacyDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.LegacyDeviceNode;
06346                 <a class="code" href="../../d5/d1/pnpres_8c.html#a53">IopRemoveLegacyDeviceNode</a>(DeviceObject, deviceNode);
06347 
06348             }
06349 
06350             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06351 
06352                 <span class="keywordflow">if</span> (legacyDeviceNode) {
06353 
06354                     <span class="comment">//</span>
06355                     <span class="comment">// After the resource is modified, update the allocated resource list</span>
06356                     <span class="comment">// for the Root\Legacy_xxxx\0000 device instance.</span>
06357                     <span class="comment">//</span>
06358 
06359                     combinedResources = <a class="code" href="../../d5/d1/pnpres_8c.html#a91">IopCombineLegacyResources</a>(legacyDeviceNode);
06360                     <span class="keywordflow">if</span> (combinedResources) {
06361 
06362                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry</a>(   legacyDeviceNode,
06363                                                                 combinedResources,
06364                                                                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(combinedResources));
06365                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(combinedResources);
06366                     }
06367                 }
06368 
06369                 <span class="comment">//</span>
06370                 <span class="comment">// BUGBUG: Santoshj 10/01/99</span>
06371                 <span class="comment">// Since IoReportDetectedDevice always uses IoPnpDriverObject instead of the one</span>
06372                 <span class="comment">// passed in, we put in this hack so that we dont taint ourselves. Other bugs need</span>
06373                 <span class="comment">// to be fixed before removing this hack (dont do resource allocation if this</span>
06374                 <span class="comment">// was already reported).</span>
06375                 <span class="comment">//</span>
06376 
06377                 <span class="keywordflow">if</span> (AllocationType != <a class="code" href="../../d6/d9/pnp_8h.html#a174a129">ArbiterRequestPnpDetected</a> &amp;&amp; DriverObject != <a class="code" href="../../d6/d9/pnp_8h.html#a14">IoPnpDriverObject</a>) {
06378                     <span class="comment">//</span>
06379                     <span class="comment">// Modify the DRVOBJ flags.</span>
06380                     <span class="comment">//</span>
06381                     ExAcquireFastLock(&amp;IopDatabaseLock, &amp;irql);
06382                     <span class="keywordflow">if</span> (ResourceRequirements) {
06383                         <span class="comment">//</span>
06384                         <span class="comment">// Once tainted, a driver can never lose it's legacy history</span>
06385                         <span class="comment">// (unless unloaded). This is because the device object</span>
06386                         <span class="comment">// field is optional, and we don't bother counting here...</span>
06387                         <span class="comment">//</span>
06388                         DriverObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a149">DRVO_LEGACY_RESOURCES</a>;
06389                     }
06390                     ExReleaseFastLock(&amp;IopDatabaseLock, irql);
06391                 }
06392             }
06393         }
06394 
06395         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
06396 
06397     } <span class="keywordflow">else</span> {
06398 
06399         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PNPRES: IopLegacyResourceAllocation: Failed to acquire registry semaphore, status %08X\n"</span>, status));
06400     }
06401 
06402     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
06403 
06404     <span class="keywordflow">return</span> status;
06405 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a327" doxytag="pnpiop.h::IopLoadBootFilterDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> IopLoadBootFilterDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04654">4654</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00063">_DRIVER_INFORMATION::DataTableEntry</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00062">_DRIVER_INFORMATION::DriverObject</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02072">IopGetDriverNameFromKeyNode()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00081">IopGroupIndex</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00082">IopGroupTable</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d8/d8/cm_8h-source.html#l00103">_BOOT_DRIVER_LIST_ENTRY::LdrEntry</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d9/d5/ioinit_8c.html#a6">PDRIVER_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00522">PDRIVER_INITIALIZE</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00067">_DRIVER_INFORMATION::Processed</a>, <a class="el" href="../../d8/d8/cm_8h-source.html#l00102">_BOOT_DRIVER_LIST_ENTRY::RegistryPath</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00064">_DRIVER_INFORMATION::ServiceHandle</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>.
<p>
<pre class="fragment"><div>04661                    :
04662 
04663     This initializes boot filter drivers.
04664 
04665 Arguments:
04666 
04667     DriverName - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to be initialized.
04668 
04669     GroupIndex - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Driver's group index (could be anything)
04670 
04671 Return Value:
04672 
04673     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>
04674 
04675 --*/
04676 
04677 {
04678     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04679     PLIST_ENTRY nextEntry;
04680     <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">PDRIVER_INFORMATION</a> driverInfo;
04681     UNICODE_STRING completeName;
04682     <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">PBOOT_DRIVER_LIST_ENTRY</a> bootDriver;
04683     PLDR_DATA_TABLE_ENTRY driverEntry;
04684     HANDLE keyHandle;
04685     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04686 
04687     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || GroupIndex &gt;= <a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a>) {
04688 
04689         <span class="comment">//</span>
04690         <span class="comment">// If we have not reached the boot driver initialization phase or</span>
04691         <span class="comment">// the filter driver is not a boot driver.</span>
04692         <span class="comment">//</span>
04693 
04694         <span class="keywordflow">return</span> driverObject;
04695     }
04696 
04697     <span class="comment">//</span>
04698     <span class="comment">// Go thru every driver that we initialized.  If it supports AddDevice entry and</span>
04699     <span class="comment">// did not create any device object after we start it.  We mark it as failure so</span>
04700     <span class="comment">// text mode setup knows this driver is not needed.</span>
04701     <span class="comment">//</span>
04702 
04703     nextEntry = <a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>[GroupIndex].Flink;
04704     <span class="keywordflow">while</span> (nextEntry != &amp;<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>[GroupIndex]) {
04705 
04706         driverInfo = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">DRIVER_INFORMATION</a>, Link);
04707         <span class="keywordflow">if</span> (driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o6">Processed</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04708 
04709             keyHandle = driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o3">ServiceHandle</a>;
04710 
04711             status = <a class="code" href="../../d0/d6/iop_8h.html#a175">IopGetDriverNameFromKeyNode</a>( keyHandle,
04712                                                   &amp;completeName );
04713             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04714                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(DriverName,
04715                                           &amp;completeName,
04716                                           TRUE)) {    <span class="comment">// case-insensitive</span>
04717 
04718                     bootDriver = driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o2">DataTableEntry</a>;
04719                     driverEntry = bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o3">LdrEntry</a>;
04720 
04721                     driverObject = <a class="code" href="../../d9/d5/ioinit_8c.html#a23">IopInitializeBuiltinDriver</a>(
04722                                        &amp;completeName,
04723                                        &amp;bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o2">RegistryPath</a>,
04724                                        (PDRIVER_INITIALIZE) driverEntry-&gt;EntryPoint,
04725                                        driverEntry,
04726                                        FALSE);
04727                     driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o1">DriverObject</a> = driverObject;
04728                     driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o6">Processed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04729                     <span class="comment">//</span>
04730                     <span class="comment">// Pnp might unload the driver before we get a chance to look at this. So take an extra</span>
04731                     <span class="comment">// reference.</span>
04732                     <span class="comment">//</span>
04733                     <span class="keywordflow">if</span> (driverObject) {
04734                         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(driverObject);
04735                     }
04736                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(completeName.Buffer);
04737                     <span class="keywordflow">break</span>;
04738                 }
04739                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(completeName.Buffer);
04740             }
04741         }
04742 
04743         nextEntry = nextEntry-&gt;Flink;
04744     }
04745     <span class="keywordflow">return</span> driverObject;
04746 }
<span class="preprocessor">#if 0</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a312" doxytag="pnpiop.h::IopLockDeviceRemovalRelations" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopLockDeviceRemovalRelations           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUGPLAY_DEVICE_DELETE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>RelationsList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsKernelInitiated</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00725">725</a> of file <a class="el" href="../../d4/d9/pnpdel_8c-source.html">pnpdel.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00170">_DEVICE_NODE::EnumerationMutex</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01293">IopAcquireDeviceTreeLock</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00239">IopAllocateRelationList()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00286">IopCompressRelationList()</a>, <a class="el" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations()</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00709">IopFreeRelationList()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00917">IopProcessRelation()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01294">IopReleaseDeviceTreeLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00301">_DEVICE_NODE::LockCount</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00734                    :
00735 
00736     This routine locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device subtrees <span class="keywordflow">for</span> removal operation and returns
00737     a list of device objects which need to be removed with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00738     DeviceObject.
00739 
00740     Caller must hold a reference to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceObject.
00741 
00742 Arguments:
00743 
00744     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object to be removed.
00745 
00746     OperationCode - Operation code, i.e., QueryEject, CancelEject, Eject...
00747 
00748     DeviceRelations - supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's
00749                    removal relations.
00750 
00751 Return Value:
00752 
00753     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00754 
00755 --*/
00756 
00757 {
00758     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                status;
00759     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>          deviceObject;
00760     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>            deviceNode, parent;
00761     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>          relationsList;
00762     ULONG                   marker;
00763     BOOLEAN                 tagged;
00764 
00765     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00766 
00767     *RelationsList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00768 
00769     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00770 
00771     <span class="keywordflow">if</span> (!IsKernelInitiated &amp;&amp; !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>) &amp;&amp; OperationCode != EjectDevice) {
00772 
00773         <span class="keywordflow">return</span> STATUS_SUCCESS;
00774     }
00775 
00776     <span class="comment">//</span>
00777     <span class="comment">// Obviously no one should try to delete the whole device node tree.</span>
00778     <span class="comment">//</span>
00779 
00780     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceObject != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00781 
00782     <span class="comment">//</span>
00783     <span class="comment">// Lock the whole device node tree so no one can touch the tree.</span>
00784     <span class="comment">//</span>
00785 
00786     <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
00787 
00788     <span class="keywordflow">if</span> (IsKernelInitiated) {
00789         <span class="comment">//</span>
00790         <span class="comment">// For kernel initiated removes it means that the device itself is</span>
00791         <span class="comment">// physically gone.</span>
00792         <span class="comment">//</span>
00793 
00794         <span class="comment">//</span>
00795         <span class="comment">// We'll take advantage of that signal to go and check if there</span>
00796         <span class="comment">// previously was a QueryRemove done on this devnode.  If</span>
00797         <span class="comment">// so, we need to reenumerate the parents of all the relations in</span>
00798         <span class="comment">// case some of them were speculative.</span>
00799         <span class="comment">//</span>
00800     }
00801 
00802     <span class="keywordflow">if</span> ((relationsList = <a class="code" href="../../d6/d1/pnprlist_8c.html#a4">IopAllocateRelationList</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00803 
00804         <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00805         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00806     }
00807 
00808     <span class="comment">//</span>
00809     <span class="comment">// First process the object itself</span>
00810     <span class="comment">//</span>
00811     status = <a class="code" href="../../d3/d0/pnpdel_8c.html#a4">IopProcessRelation</a>( DeviceObject,
00812                                  OperationCode,
00813                                  relationsList,
00814                                  IsKernelInitiated,
00815                                  TRUE);
00816 
00817     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status != STATUS_INVALID_DEVICE_REQUEST);
00818 
00819     marker = 0;
00820     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations</a>( relationsList,
00821                                   &amp;marker,
00822                                   &amp;deviceObject,
00823                                   NULL,
00824                                   &amp;tagged,
00825                                   FALSE)) {
00826 
00827         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00828 
00829         <span class="comment">//</span>
00830         <span class="comment">// If we were successful we need to lock the parents of each of the</span>
00831         <span class="comment">// relations, otherwise we need to unlock each relation.</span>
00832         <span class="comment">//</span>
00833 
00834 
00835         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00836             <span class="comment">//</span>
00837             <span class="comment">// For all the device nodes in the DeviceRelations, we need to lock</span>
00838             <span class="comment">// their parents' enumeration mutex.</span>
00839             <span class="comment">//</span>
00840 
00841             <span class="keywordflow">if</span> (tagged) {
00842 
00843                 <span class="comment">//</span>
00844                 <span class="comment">// If the tagged bit is set then the relation was merged from</span>
00845                 <span class="comment">// a pending eject.  In this case the devnode isn't locked so</span>
00846                 <span class="comment">// we do it now.</span>
00847                 <span class="comment">//</span>
00848 
00849                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a>++ == 0) {
00850                     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00851                     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>);
00852                 }
00853             }
00854 
00855             parent = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
00856 
00857             <span class="keywordflow">if</span> (parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a>++ == 0) {
00858                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00859                 <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(&amp;parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>);
00860             }
00861 
00862         } <span class="keywordflow">else</span> {
00863 
00864             <span class="keywordflow">if</span> (!tagged) {
00865 
00866                 <span class="comment">//</span>
00867                 <span class="comment">// If the tagged bit is set then the relation was merged from</span>
00868                 <span class="comment">// an pending eject.  In this case the devnode isn't locked so</span>
00869                 <span class="comment">// we don't need to unlock it, all the others we unlock now.</span>
00870                 <span class="comment">//</span>
00871 
00872                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> &gt; 0);
00873 
00874                 <span class="keywordflow">if</span> (--deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
00875                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, FALSE);
00876                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);
00877                 }
00878             }
00879         }
00880     }
00881 
00882     <span class="comment">//</span>
00883     <span class="comment">// Release the device tree.</span>
00884     <span class="comment">//</span>
00885 
00886     <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00887 
00888     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00889         <a class="code" href="../../d7/d1/pnprlist_8h.html#a8">IopCompressRelationList</a>(&amp;relationsList);
00890         *RelationsList = relationsList;
00891 
00892         <span class="comment">//</span>
00893         <span class="comment">// At this point we have a list of all the relations, those that are</span>
00894         <span class="comment">// direct descendants of the original device we are ejecting or</span>
00895         <span class="comment">// removing have the DirectDescendant bit set.</span>
00896         <span class="comment">//</span>
00897         <span class="comment">// Relations which were merged from an existing eject have the tagged</span>
00898         <span class="comment">// bit set.</span>
00899         <span class="comment">//</span>
00900         <span class="comment">// All of the relations and their parents are locked.</span>
00901         <span class="comment">//</span>
00902         <span class="comment">// There is a reference on each device object by virtue of it being in</span>
00903         <span class="comment">// the list.  There is another one on each device object because it is</span>
00904         <span class="comment">// locked and the lock count is &gt;= 1.</span>
00905         <span class="comment">//</span>
00906         <span class="comment">// There is also a reference on each relation's parent and it's lock</span>
00907         <span class="comment">// count is &gt;= 1.</span>
00908         <span class="comment">//</span>
00909     } <span class="keywordflow">else</span> {
00910         <a class="code" href="../../d7/d1/pnprlist_8h.html#a10">IopFreeRelationList</a>(relationsList);
00911     }
00912 
00913     <span class="keywordflow">return</span> status;
00914 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a274" doxytag="pnpiop.h::IopMakeGloballyUniqueId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMakeGloballyUniqueId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>UniqueId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PWCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>GloballyUniqueId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01891">1891</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00072">HASH_UNICODE_STRING</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00117">_DEVICE_NODE::Level</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">max</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00085">MAX_PARENT_PREFIX</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01038">RtlUpcaseUnicodeString()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>01896 {
01897     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01898     ULONG length;
01899     PWSTR <span class="keywordtype">id</span>, Prefix = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01900     HANDLE enumKey;
01901     HANDLE instanceKey;
01902     UCHAR keyBuffer[FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + <span class="keyword">sizeof</span>(ULONG)];
01903     PKEY_VALUE_PARTIAL_INFORMATION keyValue, stringValueBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01904     UNICODE_STRING valueName;
01905     ULONG uniqueIdValue, Hash, hashInstance;
01906     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> parentNode;
01907 
01908     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01909 
01910     <span class="comment">//</span>
01911     <span class="comment">// We need to build an instance id to uniquely identify this</span>
01912     <span class="comment">// device.  We will accomplish this by producing a prefix that will be</span>
01913     <span class="comment">// prepended to the non-unique device id supplied.</span>
01914     <span class="comment">//</span>
01915 
01916     <span class="comment">//</span>
01917     <span class="comment">// To 'unique-ify' the child's instance ID, we will retrieve</span>
01918     <span class="comment">// the unique "UniqueParentID" number that has been assigned</span>
01919     <span class="comment">// to the parent and use it to construct a prefix.  This is</span>
01920     <span class="comment">// the legacy mechanism supported here so that existing device</span>
01921     <span class="comment">// settings are not lost on upgrade.</span>
01922     <span class="comment">//</span>
01923 
01924     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01925     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
01926 
01927     parentNode = ((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode)-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
01928 
01929     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumKey,
01930                                    NULL,
01931                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
01932                                    KEY_READ | KEY_WRITE
01933                                    );
01934 
01935     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01936         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopQueryUniqueId:\tUnable to open HKLM\\SYSTEM\\CCS\\ENUM (status %08lx)\n"</span>,
01937                  status
01938                 );
01939         <span class="keywordflow">goto</span> clean0;
01940     }
01941 
01942     <span class="comment">//</span>
01943     <span class="comment">// Open the instance key for this devnode</span>
01944     <span class="comment">//</span>
01945     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;instanceKey,
01946                                    enumKey,
01947                                    &amp;parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>,
01948                                    KEY_READ | KEY_WRITE
01949                                    );
01950 
01951     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01952         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopQueryUniqueId:\tUnable to open registry key for %wZ (status %08lx)\n"</span>,
01953                  &amp;parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>,
01954                  status
01955                 );
01956         <span class="keywordflow">goto</span> clean1;
01957     }
01958 
01959     <span class="comment">//</span>
01960     <span class="comment">// Attempt to retrieve the "UniqueParentID" value from the device</span>
01961     <span class="comment">// instance key.</span>
01962     <span class="comment">//</span>
01963     keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)keyBuffer;
01964     PiWstrToUnicodeString(&amp;valueName, REGSTR_VALUE_UNIQUE_PARENT_ID);
01965 
01966     status = ZwQueryValueKey(instanceKey,
01967                              &amp;valueName,
01968                              KeyValuePartialInformation,
01969                              keyValue,
01970                              <span class="keyword">sizeof</span>(keyBuffer),
01971                              &amp;length
01972                              );
01973 
01974     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01975         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(keyValue-&gt;Type == REG_DWORD);
01976         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(keyValue-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG));
01977         <span class="keywordflow">if</span> ((keyValue-&gt;Type != REG_DWORD) ||
01978             (keyValue-&gt;DataLength != <span class="keyword">sizeof</span>(ULONG))) {
01979             status = STATUS_INVALID_PARAMETER;
01980             <span class="keywordflow">goto</span> clean2;
01981         }
01982 
01983         uniqueIdValue = *(PULONG)(keyValue-&gt;Data);
01984 
01985         <span class="comment">//</span>
01986         <span class="comment">// OK, we have a unique parent ID number to prefix to the</span>
01987         <span class="comment">// instance ID.</span>
01988         Prefix = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, 9 * <span class="keyword">sizeof</span>(WCHAR));
01989         <span class="keywordflow">if</span> (!Prefix) {
01990             status = STATUS_INSUFFICIENT_RESOURCES;
01991             <span class="keywordflow">goto</span> clean2;
01992         }
01993         swprintf(Prefix, L<span class="stringliteral">"%x"</span>, uniqueIdValue);
01994     } <span class="keywordflow">else</span> {
01995 
01996         <span class="comment">//</span>
01997         <span class="comment">// This is the current mechanism for finding existing</span>
01998         <span class="comment">// device instance prefixes and calculating new ones if</span>
01999         <span class="comment">// required.</span>
02000         <span class="comment">//</span>
02001 
02002         <span class="comment">//</span>
02003         <span class="comment">// Attempt to retrieve the "ParentIdPrefix" value from the device</span>
02004         <span class="comment">// instance key.</span>
02005         <span class="comment">//</span>
02006 
02007         PiWstrToUnicodeString(&amp;valueName, REGSTR_VALUE_PARENT_ID_PREFIX);
02008         length = (<a class="code" href="../../d0/d1/pnpirp_8c.html#a2">MAX_PARENT_PREFIX</a> + 1) * <span class="keyword">sizeof</span>(WCHAR) +
02009             FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data);
02010         stringValueBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
02011                                            length);
02012         <span class="keywordflow">if</span> (stringValueBuffer) {
02013             status = ZwQueryValueKey(instanceKey,
02014                                      &amp;valueName,
02015                                      KeyValuePartialInformation,
02016                                      stringValueBuffer,
02017                                      length,
02018                                      &amp;length);
02019         }
02020         <span class="keywordflow">else</span> {
02021             status = STATUS_INSUFFICIENT_RESOURCES;
02022             <span class="keywordflow">goto</span> clean2;
02023         }
02024 
02025         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02026 
02027             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(stringValueBuffer-&gt;Type == REG_SZ);
02028             <span class="keywordflow">if</span> (stringValueBuffer-&gt;Type != REG_SZ) {
02029                 status = STATUS_INVALID_PARAMETER;
02030                 <span class="keywordflow">goto</span> clean2;
02031             }
02032 
02033             <span class="comment">//</span>
02034             <span class="comment">// Parent has already been assigned a "ParentIdPrefix".</span>
02035             <span class="comment">//</span>
02036 
02037             Prefix = (PWSTR) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
02038                                             stringValueBuffer-&gt;DataLength);
02039             <span class="keywordflow">if</span> (!Prefix)
02040             {
02041                 status = STATUS_INSUFFICIENT_RESOURCES;
02042                 <span class="keywordflow">goto</span> clean2;
02043             }
02044             wcscpy(Prefix, (PWSTR) stringValueBuffer-&gt;Data);
02045         }
02046         <span class="keywordflow">else</span>
02047         {
02048             <span class="comment">//</span>
02049             <span class="comment">// Parent has not been assigned a "ParentIdPrefix".</span>
02050             <span class="comment">// Compute the prefix:</span>
02051             <span class="comment">//    * Compute Hash</span>
02052             <span class="comment">//    * Look for value of the form:</span>
02053             <span class="comment">//        NextParentId.&lt;level&gt;.&lt;hash&gt;:REG_DWORD: &lt;NextInstance&gt;</span>
02054             <span class="comment">//      under CCS\Enum.  If not present, create it.</span>
02055             <span class="comment">//    * Assign the new "ParentIdPrefix" which will be of</span>
02056             <span class="comment">//      of the form:</span>
02057             <span class="comment">//        &lt;level&gt;&amp;&lt;hash&gt;&amp;&lt;instance&gt;</span>
02058             <span class="comment">//</span>
02059 
02060             <span class="comment">// Allocate a buffer once for the NextParentId... value</span>
02061             <span class="comment">// and for the prefix.</span>
02062             length = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(wcslen(REGSTR_VALUE_NEXT_PARENT_ID) + 2 + 8 + 8,
02063                          MAX_PARENT_PREFIX) + 1;
02064 
02065             <span class="comment">// Device instances are case in-sensitive.  Upcase before</span>
02066             <span class="comment">// performing hash to ensure that the hash is case-insensitve.</span>
02067             status = <a class="code" href="../../d6/d6/nls_8c.html#a31">RtlUpcaseUnicodeString</a>(&amp;valueName,
02068                                             &amp;parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>,
02069                                             TRUE);
02070             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
02071             {
02072                 <span class="keywordflow">goto</span> clean2;
02073             }
02074             <a class="code" href="../../d0/d1/pnpirp_8c.html#a1">HASH_UNICODE_STRING</a>(&amp;valueName, &amp;Hash);
02075             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;valueName);
02076 
02077             Prefix = (PWSTR) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
02078                                             length * <span class="keyword">sizeof</span>(WCHAR));
02079             <span class="keywordflow">if</span> (!Prefix) {
02080                 status = STATUS_INSUFFICIENT_RESOURCES;
02081                 <span class="keywordflow">goto</span> clean2;
02082             }
02083 
02084             <span class="comment">// Check for existence of "NextParentId...." value and update.</span>
02085             swprintf(Prefix, L<span class="stringliteral">"%s.%x.%x"</span>, REGSTR_VALUE_NEXT_PARENT_ID,
02086                      Hash, parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o4">Level</a>);
02087             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, Prefix);
02088             keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)keyBuffer;
02089             status = ZwQueryValueKey(enumKey,
02090                                      &amp;valueName,
02091                                      KeyValuePartialInformation,
02092                                      keyValue,
02093                                      <span class="keyword">sizeof</span>(keyBuffer),
02094                                      &amp;length
02095                                      );
02096             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (keyValue-&gt;Type == REG_DWORD) &amp;&amp;
02097                 (keyValue-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG))) {
02098                 hashInstance = *(PULONG)(keyValue-&gt;Data);
02099             }
02100             <span class="keywordflow">else</span> {
02101                 hashInstance = 0;
02102             }
02103 
02104             hashInstance++;
02105 
02106             status = ZwSetValueKey(enumKey,
02107                                    &amp;valueName,
02108                                    TITLE_INDEX_VALUE,
02109                                    REG_DWORD,
02110                                    &amp;hashInstance,
02111                                    <span class="keyword">sizeof</span>(hashInstance)
02112                                    );
02113 
02114             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02115                 <span class="keywordflow">goto</span> clean2;
02116             }
02117 
02118             hashInstance--;
02119 
02120             <span class="comment">// Create actual ParentIdPrefix string</span>
02121             PiWstrToUnicodeString(&amp;valueName, REGSTR_VALUE_PARENT_ID_PREFIX);
02122             length = swprintf(Prefix, L<span class="stringliteral">"%x&amp;%x&amp;%x"</span>, parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o4">Level</a>,
02123                      Hash, hashInstance) + 1;
02124             status = ZwSetValueKey(instanceKey,
02125                                    &amp;valueName,
02126                                    TITLE_INDEX_VALUE,
02127                                    REG_SZ,
02128                                    Prefix,
02129                                    length * <span class="keyword">sizeof</span>(WCHAR)
02130                                    );
02131             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
02132             {
02133                 <span class="keywordflow">goto</span> clean2;
02134             }
02135         }
02136     }
02137 
02138     <span class="comment">// Construct the instance id from the non-unique id (if any)</span>
02139     <span class="comment">// provided by the child and the prefix we've constructed.</span>
02140     length = wcslen(Prefix) + (UniqueId ? wcslen(UniqueId) : 0) + 2;
02141     <span class="keywordtype">id</span> = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, length * <span class="keyword">sizeof</span>(WCHAR));
02142     <span class="keywordflow">if</span> (!<span class="keywordtype">id</span>) {
02143         status = STATUS_INSUFFICIENT_RESOURCES;
02144     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UniqueId) {
02145         swprintf(<span class="keywordtype">id</span>, L<span class="stringliteral">"%s&amp;%s"</span>, Prefix, UniqueId);
02146     } <span class="keywordflow">else</span> {
02147         wcscpy(<span class="keywordtype">id</span>, Prefix);
02148     }
02149 
02150 clean2:
02151     ZwClose(instanceKey);
02152 
02153 clean1:
02154     ZwClose(enumKey);
02155 
02156 clean0:
02157     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
02158     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02159 
02160     <span class="keywordflow">if</span> (stringValueBuffer) {
02161         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(stringValueBuffer);
02162     }
02163 
02164     <span class="keywordflow">if</span> (Prefix) {
02165         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Prefix);
02166     }
02167 
02168     *GloballyUniqueId = <span class="keywordtype">id</span>;
02169     <span class="keywordflow">return</span> status;
02170 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a231" doxytag="pnpiop.h::IopMarkDuplicateDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMarkDuplicateDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetInstance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceInstance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02467">2467</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>.
<p>
<pre class="fragment"><div>02476                    :
02477 
02478     This routine marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance specified by TargetKeyName and TargetInstance
02479     as DuplicateOf <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device specified by SourceKeyName and SourceInstance.
02480 
02481 Arguments:
02482 
02483     TargetKeyName - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of service key which will be marked
02484         as duplicate.
02485 
02486     TargetInstance - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target device.
02487 
02488     SourceKeyName - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of service key.
02489 
02490     SourceInstance - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source device.
02491 
02492 
02493 Returns:
02494 
02495     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
02496 
02497 --*/
02498 
02499 {
02500     HANDLE handle;
02501     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02502     UNICODE_STRING sourceDeviceString, unicodeValueName;
02503 
02504     <span class="comment">//</span>
02505     <span class="comment">// Open the handle of the target device instance.</span>
02506     <span class="comment">//</span>
02507 
02508     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(
02509                        NULL,
02510                        TargetKeyName,
02511                        TargetInstance,
02512                        NULL,
02513                        &amp;handle,
02514                        0
02515                        );
02516     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02517         <span class="keywordflow">return</span> status;
02518     }
02519 
02520     <span class="comment">//</span>
02521     <span class="comment">// Get the name of the source device instance</span>
02522     <span class="comment">//</span>
02523 
02524     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(
02525                        NULL,
02526                        SourceKeyName,
02527                        SourceInstance,
02528                        &amp;sourceDeviceString,
02529                        NULL,
02530                        0
02531                        );
02532     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02533         <span class="keywordflow">return</span> status;
02534     }
02535 
02536     <span class="comment">//</span>
02537     <span class="comment">// Write the name of the source device to the DuplicateOf value entry of</span>
02538     <span class="comment">// target device key.</span>
02539     <span class="comment">//</span>
02540 
02541     PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DUPLICATEOF);
02542     status = ZwSetValueKey(
02543                 handle,
02544                 &amp;unicodeValueName,
02545                 TITLE_INDEX_VALUE,
02546                 REG_SZ,
02547                 &amp;sourceDeviceString,
02548                 sourceDeviceString.Length + <span class="keyword">sizeof</span>(WCHAR)
02549                 );
02550     <span class="keywordflow">return</span> status;
02551 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a366" doxytag="pnpiop.h::IopMemInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMemInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00396">396</a> of file <a class="el" href="../../d4/d0/pnpmemio_8c-source.html">pnpmemio.c</a>.
<p>
References <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00475">_ARBITER_INSTANCE::Allocation</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l00192">ArbInitializeArbiterInstance()</a>, <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00548">_ARBITER_INSTANCE::FindSuitableRange</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00630">IopGenericPackResource()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00542">IopGenericScoreRequirement()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00263">IopGenericTranslateOrdering()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00463">IopGenericUnpackRequirement()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00682">IopGenericUnpackResource()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l01342">IopMemFindSuitableRange()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00205">IopRootMemArbiter</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00525">_ARBITER_INSTANCE::PackResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d4/range_8c-source.html#l00340">RtlAddRange()</a>, <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00527">_ARBITER_INSTANCE::ScoreRequirement</a>, <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00524">_ARBITER_INSTANCE::UnpackRequirement</a>, and <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00526">_ARBITER_INSTANCE::UnpackResource</a>.
<p>
<pre class="fragment"><div>00402                    :
00403 
00404     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arbiter
00405 
00406 Parameters:
00407 
00408     None
00409 
00410 Return Value:
00411 
00412     None
00413 
00414 --*/
00415 
00416 {
00417     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00418 
00419     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00420 
00421     <a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o12">UnpackRequirement</a> = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a16">IopGenericUnpackRequirement</a>;
00422     <a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o13">PackResource</a>      = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a17">IopGenericPackResource</a>;
00423     <a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o14">UnpackResource</a>    = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a19">IopGenericUnpackResource</a>;
00424     <a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o15">ScoreRequirement</a>  = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a18">IopGenericScoreRequirement</a>;
00425 
00426     <a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o28">FindSuitableRange</a>    = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a15">IopMemFindSuitableRange</a>;
00427 
00428     status = <a class="code" href="../../d9/d8/arbiter_8h.html#a67">ArbInitializeArbiterInstance</a>(&amp;IopRootMemArbiter,
00429                                           NULL,     <span class="comment">// Indicates ROOT arbiter</span>
00430                                           CmResourceTypeMemory,
00431                                           L<span class="stringliteral">"RootMemory"</span>,
00432                                           L<span class="stringliteral">"Root"</span>,
00433                                           IopGenericTranslateOrdering
00434                                           );
00435 
00436     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00437         <span class="keywordflow">return</span> status;
00438     }
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// Allocate the first page of physical memory as the firmware uses it and</span>
00442     <span class="comment">// doesn't report it as so Mm doesn't reuse it.</span>
00443     <span class="comment">//</span>
00444 
00445     status = <a class="code" href="../../d2/d5/range_8c.html#a16">RtlAddRange</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o4">Allocation</a>,
00446                          0,
00447                          PAGE_SIZE,
00448                          0, <span class="comment">// RangeAttributes</span>
00449                          0, <span class="comment">// Flags</span>
00450                          NULL,
00451                          NULL
00452                          );
00453     <span class="keywordflow">return</span> status;
00454 
00455 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a294" doxytag="pnpiop.h::IopMergeCmResourceLists" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMergeCmResourceLists           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>List1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>List2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCM_RESOURCE_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>MergedList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05198">5198</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03523">IopDetermineResourceListSize()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
<pre class="fragment"><div>05206                    :
05207 
05208     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> merges two IoLists into one.
05209 
05210 
05211 Arguments:
05212 
05213     IoList1 - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first CmResourceList
05214 
05215     IoList2 - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second CmResourceList
05216 
05217     MergedList - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> merged resource
05218              list.
05219 
05220 Return Value:
05221 
05222     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code to indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function.
05223 
05224 --*/
05225 {
05226     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
05227     PCM_RESOURCE_LIST cmList, newList;
05228     ULONG size, size1, size2;
05229     PUCHAR p;
05230 
05231     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05232 
05233     *MergedList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05234 
05235     <span class="comment">//</span>
05236     <span class="comment">// First handle the easy cases that both IO Lists are empty or any one of</span>
05237     <span class="comment">// them is empty.</span>
05238     <span class="comment">//</span>
05239 
05240     <span class="keywordflow">if</span> ((List1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List1-&gt;Count == 0) &amp;&amp;
05241         (List2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List2-&gt;Count == 0)) {
05242         <span class="keywordflow">return</span> status;
05243     }
05244 
05245     cmList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05246     <span class="keywordflow">if</span> (List1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List1-&gt;Count == 0) {
05247         cmList = List2;
05248     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (List2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List2-&gt;Count == 0) {
05249         cmList = List1;
05250     }
05251     <span class="keywordflow">if</span> (cmList) {
05252         size =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(cmList);
05253         newList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
05254         <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05255             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05256         }
05257         RtlMoveMemory(newList, cmList, size);
05258         *MergedList = newList;
05259         <span class="keywordflow">return</span> status;
05260     }
05261 
05262     <span class="comment">//</span>
05263     <span class="comment">// Do real work...</span>
05264     <span class="comment">//</span>
05265 
05266     size1 =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(List1);
05267     size2 =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(List2);
05268     size = size1 + size2;
05269     newList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
05270                           PagedPool,
05271                           size
05272                           );
05273     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05274         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05275     }
05276     p = (PUCHAR)newList;
05277     RtlMoveMemory(p, List1, size1);
05278     p += size1;
05279     RtlMoveMemory(p,
05280                   &amp;List2-&gt;List[0],
05281                   size2 - FIELD_OFFSET(CM_RESOURCE_LIST, List)
05282                   );
05283     newList-&gt;Count = List1-&gt;Count + List2-&gt;Count;
05284     *MergedList = newList;
05285     <span class="keywordflow">return</span> status;
05286 
05287 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a293" doxytag="pnpiop.h::IopMergeFilteredResourceRequirementsList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMergeFilteredResourceRequirementsList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>IoList1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>IoList2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>MergedList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05109">5109</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>.
<p>
<pre class="fragment"><div>05117                    :
05118 
05119     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> merges two IoLists into one.
05120 
05121 
05122 Arguments:
05123 
05124     IoList1 - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first IoResourceRequirementsList
05125 
05126     IoList2 - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second IoResourceRequirementsList
05127 
05128     MergedList - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> merged resource
05129              requirements list.
05130 
05131 Return Value:
05132 
05133     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code to indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function.
05134 
05135 --*/
05136 {
05137     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
05138     PIO_RESOURCE_REQUIREMENTS_LIST ioList, newList;
05139     ULONG size;
05140     PUCHAR p;
05141 
05142     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05143 
05144     *MergedList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05145 
05146     <span class="comment">//</span>
05147     <span class="comment">// First handle the easy cases that both IO Lists are empty or any one of</span>
05148     <span class="comment">// them is empty.</span>
05149     <span class="comment">//</span>
05150 
05151     <span class="keywordflow">if</span> ((IoList1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList1-&gt;AlternativeLists == 0) &amp;&amp;
05152         (IoList2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList2-&gt;AlternativeLists == 0)) {
05153         <span class="keywordflow">return</span> status;
05154     }
05155     ioList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05156     <span class="keywordflow">if</span> (IoList1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList1-&gt;AlternativeLists == 0) {
05157         ioList = IoList2;
05158     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IoList2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList2-&gt;AlternativeLists == 0) {
05159         ioList = IoList1;
05160     }
05161     <span class="keywordflow">if</span> (ioList) {
05162         newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, ioList-&gt;ListSize);
05163         <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05164             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05165         }
05166         RtlMoveMemory(newList, ioList, ioList-&gt;ListSize);
05167         *MergedList = newList;
05168         <span class="keywordflow">return</span> status;
05169     }
05170 
05171     <span class="comment">//</span>
05172     <span class="comment">// Do real work...</span>
05173     <span class="comment">//</span>
05174 
05175     size = IoList1-&gt;ListSize + IoList2-&gt;ListSize - FIELD_OFFSET(IO_RESOURCE_REQUIREMENTS_LIST, List);
05176     newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
05177                           PagedPool,
05178                           size
05179                           );
05180     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05181         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05182     }
05183     p = (PUCHAR)newList;
05184     RtlMoveMemory(p, IoList1, IoList1-&gt;ListSize);
05185     p += IoList1-&gt;ListSize;
05186     RtlMoveMemory(p,
05187                   &amp;IoList2-&gt;List[0],
05188                   size - IoList1-&gt;ListSize
05189                   );
05190     newList-&gt;ListSize = size;
05191     newList-&gt;AlternativeLists += IoList2-&gt;AlternativeLists;
05192     *MergedList = newList;
05193     <span class="keywordflow">return</span> status;
05194 
05195 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a289" doxytag="pnpiop.h::IopNewDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopNewDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">1596</a> of file <a class="el" href="../../d3/d9/pnpdd_8c-source.html">pnpdd.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00684">_START_CONTEXT::AddContext</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00493">DNF_LEGACY_DRIVER</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00402">DNF_NEED_QUERY_IDS</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00433">DNF_NO_RESOURCE_REQUIRED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00453">DNF_RESOURCE_ASSIGNED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00459">DNF_RESOURCE_REPORTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00678">_ADD_CONTEXT::DriverStartType</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00676">_ADD_CONTEXT::GroupsToStart</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00677">_ADD_CONTEXT::GroupToStartNext</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01824">IopAssignResourcesToDevices()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">IopProcessAssignResources()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00821">IopProcessStartDevices()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00682">_START_CONTEXT::LoadDriver</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00683">_START_CONTEXT::NewDevice</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00671">NO_MORE_GROUP</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00765">_IOP_RESOURCE_REQUEST::PhysicalDevice</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00768">_IOP_RESOURCE_REQUEST::Priority</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00771">_IOP_RESOURCE_REQUEST::ResourceAssignment</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00161">_DEVICE_NODE::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00163">_DEVICE_NODE::ResourceListTranslated</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00773">_IOP_RESOURCE_REQUEST::Status</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00772">_IOP_RESOURCE_REQUEST::TranslatedResourceAssignment</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>.
<p>
<pre class="fragment"><div>01602                    :
01603 
01604     This routine handles user-mode initiated starts of devices.
01605 
01606 Parameters:
01607 
01608     DeviceObject - PDO.
01609 
01610 ReturnValue:
01611 
01612     None.
01613 
01614 --*/
01615 
01616 {
01617     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode, parent;
01618     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> requestTable;
01619     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01620     BOOLEAN newDevice;
01621     <a class="code" href="../../d0/d6/struct__START__CONTEXT.html">START_CONTEXT</a> startContext;
01622     <a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html">ADD_CONTEXT</a> addContext;
01623 
01624     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01625 
01626     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
01627 
01628     <span class="comment">//</span>
01629     <span class="comment">// Make sure the device is not started</span>
01630     <span class="comment">//</span>
01631 
01632     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>) {
01633         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01634     }
01635 
01636     <span class="comment">//</span>
01637     <span class="comment">// Need enumeration on IoReportDetectedDevice</span>
01638     <span class="comment">//</span>
01639 
01640     <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a>)) {
01641         <span class="comment">//</span>
01642         <span class="comment">// Invoke the driver's AddDevice() entry and enumerate the device.</span>
01643         <span class="comment">//</span>
01644 
01645         addContext.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o0">GroupsToStart</a> = 0xffff;
01646         addContext.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a> = 0xffff;
01647         addContext.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o2">DriverStartType</a> = SERVICE_DEMAND_START;
01648 
01649         status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a286">IopCallDriverAddDevice</a>(deviceNode, TRUE, &amp;addContext);
01650         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>)) {
01651             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01652         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a>) {
01653 
01654             <span class="comment">//</span>
01655             <span class="comment">// The driver may perform IoReportDetectedDevice</span>
01656             <span class="comment">//</span>
01657 
01658             <span class="keywordflow">goto</span> enumerate;
01659         }
01660 
01661         <span class="comment">//</span>
01662         <span class="comment">// Assign resource to the device</span>
01663         <span class="comment">//</span>
01664 
01665         requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> = DeviceObject;
01666         requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a> = 0;
01667 
01668         <a class="code" href="../../d2/d0/pnpdd_8c.html#a22">IopAssignResourcesToDevices</a>(1, &amp;requestTable, TRUE);
01669 
01670         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a>)) {
01671             <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>) {
01672                 <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>)) {
01673                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>;
01674                 }
01675                 <span class="comment">// deviceNode-&gt;Flags &amp;= ~DNF_INSUFFICIENT_RESOURCES;</span>
01676                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>;
01677                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a> = requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>;
01678             } <span class="keywordflow">else</span> {
01679                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>;
01680             }
01681         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_DEVICE_CONFIGURATION_ERROR) {
01682             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_NO_SOFTCONFIG);
01683             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01684         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_PNP_BAD_MPS_TABLE) {
01685             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_BIOS_TABLE);
01686             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01687         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_PNP_TRANSLATION_FAILED) {
01688             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_TRANSLATION_FAILED);
01689             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01690         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_PNP_IRQ_TRANSLATION_FAILED) {
01691             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_IRQ_TRANSLATION_FAILED);
01692             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01693         } <span class="keywordflow">else</span> {
01694             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_NORMAL_CONFLICT);
01695             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01696         }
01697     }
01698 
01699 enumerate:
01700 
01701     <span class="comment">//</span>
01702     <span class="comment">// Start and enumerate the device</span>
01703     <span class="comment">//</span>
01704 
01705     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o0">LoadDriver</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01706     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01707     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o0">GroupsToStart</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
01708     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
01709     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o2">DriverStartType</a> = SERVICE_DEMAND_START;
01710 
01711     <a class="code" href="../../d9/d0/pnpiop_8h.html#a285">IopStartAndEnumerateDevice</a>(deviceNode, &amp;startContext);
01712     newDevice = startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a>;
01713     <span class="keywordflow">while</span> (newDevice) {
01714 
01715         startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01716 
01717         <span class="comment">//</span>
01718         <span class="comment">// Process the whole device tree to assign resources to those devices who</span>
01719         <span class="comment">// have been successfully added to their drivers.</span>
01720         <span class="comment">//</span>
01721 
01722         newDevice = <a class="code" href="../../d9/d0/pnpiop_8h.html#a262">IopProcessAssignResources</a>(deviceNode, FALSE, TRUE);
01723 
01724         <span class="comment">//</span>
01725         <span class="comment">// Process the whole device tree to start those devices who have been allocated</span>
01726         <span class="comment">// resources and waiting to be started.</span>
01727         <span class="comment">// Note, the IopProcessStartDevices routine may enumerate new devices.</span>
01728         <span class="comment">//</span>
01729 
01730         <a class="code" href="../../d9/d0/pnpiop_8h.html#a263">IopProcessStartDevices</a>(deviceNode, &amp;startContext);
01731         newDevice |= startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a>;
01732 
01733     }
01734 
01735 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
01736     ;
01737 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a351" doxytag="pnpiop.h::IopNotifyDeviceClassChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopNotifyDeviceClassChange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPGUID&nbsp;</td>
          <td class="mdname" nowrap> <em>EventGuid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPGUID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClassGuid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SymbolicLinkName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07330">7330</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02213">_NOTIFY_ENTRY_HEADER::Callback</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00064">_NOTIFICATION_CALLBACK_PARAM_BLOCK::Callout</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02312">_DEVICE_CLASS_NOTIFY_ENTRY::ClassGuid</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02219">_NOTIFY_ENTRY_HEADER::Context</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00066">_NOTIFICATION_CALLBACK_PARAM_BLOCK::Context</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01385">_DRIVER_OBJECT::DriverName</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02226">_NOTIFY_ENTRY_HEADER::DriverObject</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00965">_DEVICE_INTERFACE_CHANGE_NOTIFICATION::Event</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00969">_DEVICE_INTERFACE_CHANGE_NOTIFICATION::InterfaceClassGuid</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02053">IopAcquireNotifyLock</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02070">IopCompareGuid</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06600">IopDereferenceNotify()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00183">IopDeviceClassNotifyList</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00184">IopDeviceClassNotifyLock</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02040">IopHashGuid</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09333">IopPnPHydraCallback()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06564">IopReferenceNotify()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02061">IopReleaseNotifyLock</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00065">_NOTIFICATION_CALLBACK_PARAM_BLOCK::NotificationStructure</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a171">PDEVICE_CLASS_NOTIFY_ENTRY</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00559">PKWIN32_CALLOUT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02359">PNP_NOTIFICATION_VERSION</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00964">_DEVICE_INTERFACE_CHANGE_NOTIFICATION::Size</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00970">_DEVICE_INTERFACE_CHANGE_NOTIFICATION::SymbolicLinkName</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02305">_DEVICE_CLASS_NOTIFY_ENTRY::Unregistered</a>, and <a class="el" href="../../d7/d8/pnp_8h-source.html#l00963">_DEVICE_INTERFACE_CHANGE_NOTIFICATION::Version</a>.
<p>
<pre class="fragment"><div>07338                    :
07339 
07340     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to notify all registered drivers of a changes to a
07341     particular <span class="keyword">class </span>of device. It does not return until all interested parties have
07342     been notified.
07343 
07344 Parameters:
07345 
07346     EventTypeGuid - The event that has occured
07347 
07348     ClassGuid - The device class this change has occured in
07349 
07350     SymbolicLinkName - The kernel mode symbolic link name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface device
07351         that changed
07352 
07353 Return Value:
07354 
07355     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
07356 
07357 Note:
07358 
07359     The contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notification structure *including* all pointers <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
07360     valid during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine to which <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was passed.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
07361     required after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duration of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be physically copied
07362     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine.
07363 
07364 --*/
07365 
07366 {
07367     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
07368     PLIST_ENTRY link;
07369     <a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html">PDEVICE_CLASS_NOTIFY_ENTRY</a> entry;
07370     <a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html">DEVICE_INTERFACE_CHANGE_NOTIFICATION</a> notification;
07371     ULONG hash;
07372 <span class="preprocessor">#if DBG</span>
07373 <span class="preprocessor"></span>    KIRQL originalIrql;
07374     ULONG originalApcDisable;
07375 <span class="preprocessor">#endif</span>
07376 <span class="preprocessor"></span>
07377     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07378 
07379     <span class="comment">//</span>
07380     <span class="comment">// Fill in the notification</span>
07381     <span class="comment">//</span>
07382 
07383     notification.Version = <a class="code" href="../../d9/d0/pnpiop_8h.html#a110">PNP_NOTIFICATION_VERSION</a>;
07384     notification.Size = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html">DEVICE_INTERFACE_CHANGE_NOTIFICATION</a>);
07385     notification.Event = *EventGuid;
07386     notification.InterfaceClassGuid = *ClassGuid;
07387     notification.SymbolicLinkName = SymbolicLinkName;
07388 
07389     <span class="comment">//</span>
07390     <span class="comment">// Lock the notify list</span>
07391     <span class="comment">//</span>
07392 
07393     <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;IopDeviceClassNotifyLock);
07394 
07395     <span class="comment">//</span>
07396     <span class="comment">// Get the first entry</span>
07397     <span class="comment">//</span>
07398 
07399     hash = <a class="code" href="../../d9/d0/pnpiop_8h.html#a106">IopHashGuid</a>(ClassGuid);
07400     link = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a37">IopDeviceClassNotifyList</a>[hash].Flink;
07401 
07402     <span class="comment">//</span>
07403     <span class="comment">// Iterate through the list</span>
07404     <span class="comment">//</span>
07405 
07406     <span class="keywordflow">while</span> (link != &amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a37">IopDeviceClassNotifyList</a>[hash]) {
07407 
07408         entry = (<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html">PDEVICE_CLASS_NOTIFY_ENTRY</a>) link;
07409 
07410         <span class="comment">//</span>
07411         <span class="comment">// Only callback on registered nodes of the correct device class</span>
07412         <span class="comment">//</span>
07413 
07414         <span class="keywordflow">if</span> ( !entry-&gt;Unregistered &amp;&amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(&amp;(entry-&gt;ClassGuid), ClassGuid) ) {
07415 
07416             <a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html">NOTIFICATION_CALLBACK_PARAM_BLOCK</a> callparams;
07417             ULONG Console=0;
07418             <span class="comment">//</span>
07419             <span class="comment">// Reference the entry so that no one deletes during the callback</span>
07420             <span class="comment">// and then release the lock</span>
07421             <span class="comment">//</span>
07422 
07423             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>( (<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>) entry );
07424             <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;IopDeviceClassNotifyLock);
07425 
07426 <span class="preprocessor">#if DBG</span>
07427 <span class="preprocessor"></span>            originalIrql = KeGetCurrentIrql();
07428             originalApcDisable = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable;
07429 <span class="preprocessor">#endif</span>
07430 <span class="preprocessor"></span>
07431             <span class="comment">//</span>
07432             <span class="comment">// Callback the entity that registered and ignore the return value as</span>
07433             <span class="comment">// we arn't interested in it</span>
07434             <span class="comment">//</span>
07435 
07436             callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(entry-&gt;Callback);
07437             callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=&amp;notification;
07438             callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=entry-&gt;Context;
07439 
07440 
07441             <span class="comment">//</span>
07442             <span class="comment">// Dispatch this function via the memory manager.</span>
07443             <span class="comment">// Win32K is a driver that can have multiple copies. If Hydra</span>
07444             <span class="comment">// is running, the Mem. manager will check if the callback exists</span>
07445             <span class="comment">// in "per session" space. If that is the case, it will attach to the</span>
07446             <span class="comment">// console (hence the 3rd param of PULONG containing 0) session and deliver</span>
07447             <span class="comment">// it. If either Hydra is not running, or the callback is outside session space</span>
07448             <span class="comment">// then the callback is called directly.</span>
07449             <span class="comment">//</span>
07450             <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((PKWIN32_CALLOUT)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;IopPnPHydraCallback,&amp;callparams,&amp;Console);
07451 
07452 
07453 
07454 <span class="preprocessor">#if DBG</span>
07455 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (originalIrql != KeGetCurrentIrql()) {
07456                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopNotifyDeviceClassChange: Driver %Z, notification handler @ 0x%p returned at raised IRQL = %d, original = %d\n"</span>,
07457                          &amp;entry-&gt;DriverObject-&gt;DriverName, entry-&gt;Callback, KeGetCurrentIrql(), originalIrql);
07458                 DbgBreakPoint();
07459             }
07460             <span class="keywordflow">if</span> (originalApcDisable != <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable) {
07461                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopNotifyDeviceClassChange: Driver %Z, notification handler @ 0x%p returned with different KernelApcDisable = %d, original = %d\n"</span>,
07462                          &amp;entry-&gt;DriverObject-&gt;DriverName, entry-&gt;Callback, <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable, originalApcDisable);
07463                 DbgBreakPoint();
07464             }
07465 <span class="preprocessor">#endif</span>
07466 <span class="preprocessor"></span>            <span class="comment">//</span>
07467             <span class="comment">// Reacquire the lock and dereference</span>
07468             <span class="comment">//</span>
07469 
07470             <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;IopDeviceClassNotifyLock);
07471             link = link-&gt;Flink;
07472             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>( (<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>) entry );
07473 
07474         } <span class="keywordflow">else</span> {
07475 
07476             <span class="comment">//</span>
07477             <span class="comment">// Advance down the list</span>
07478             <span class="comment">//</span>
07479 
07480             link = link-&gt;Flink;
07481         }
07482     }
07483 
07484     <span class="comment">//</span>
07485     <span class="comment">// Release the lock</span>
07486     <span class="comment">//</span>
07487 
07488     <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;IopDeviceClassNotifyLock);
07489 
07490     <span class="keywordflow">return</span> status;
07491 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a359" doxytag="pnpiop.h::IopNotifyHwProfileChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopNotifyHwProfileChange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN LPGUID&nbsp;</td>
          <td class="mdname" nowrap> <em>EventGuid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPNP_VETO_TYPE VetoType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING VetoName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06858">6858</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02213">_NOTIFY_ENTRY_HEADER::Callback</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00064">_NOTIFICATION_CALLBACK_PARAM_BLOCK::Callout</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02219">_NOTIFY_ENTRY_HEADER::Context</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00066">_NOTIFICATION_CALLBACK_PARAM_BLOCK::Context</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01385">_DRIVER_OBJECT::DriverName</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02226">_NOTIFY_ENTRY_HEADER::DriverObject</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00951">_HWPROFILE_CHANGE_NOTIFICATION::Event</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02053">IopAcquireNotifyLock</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02070">IopCompareGuid</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06600">IopDereferenceNotify()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00188">IopHwProfileNotifyLock</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09333">IopPnPHydraCallback()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00187">IopProfileNotifyList</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06564">IopReferenceNotify()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02061">IopReleaseNotifyLock</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00065">_NOTIFICATION_CALLBACK_PARAM_BLOCK::NotificationStructure</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a175">PHWPROFILE_NOTIFY_ENTRY</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00559">PKWIN32_CALLOUT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02359">PNP_NOTIFICATION_VERSION</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01763">RtlCopyUnicodeString()</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00950">_HWPROFILE_CHANGE_NOTIFICATION::Size</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02240">_NOTIFY_ENTRY_HEADER::Unregistered</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02354">_HWPROFILE_NOTIFY_ENTRY::Unregistered</a>, and <a class="el" href="../../d7/d8/pnp_8h-source.html#l00949">_HWPROFILE_CHANGE_NOTIFICATION::Version</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06672">IopRequestHwProfileChangeNotification()</a>.
<p>
<pre class="fragment"><div>06865                    :
06866 
06867     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to deliver <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> HWProfileNotifications. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
06868     called from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker thread <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
06869     It does not <span class="keywordflow">return</span> until all interested parties have been notified.
06870 
06871 Parameters:
06872 
06873     EventTypeGuid - The event that has occured
06874 
06875 Return Value:
06876 
06877     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
06878 
06879 Note:
06880 
06881     The contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notification structure *including* all pointers <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
06882     valid during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine to which <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was passed.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
06883     required after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duration of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be physically copied
06884     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine.
06885 
06886 --*/
06887 {
06888     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status=STATUS_SUCCESS;
06889     <a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">PHWPROFILE_NOTIFY_ENTRY</a>  pNotifyList;
06890     PLIST_ENTRY link;
06891 <span class="preprocessor">#if DBG</span>
06892 <span class="preprocessor"></span>    ULONG originalApcDisable;
06893 <span class="preprocessor">#endif</span>
06894 <span class="preprocessor"></span>
06895 
06896     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06897 
06898     <span class="comment">//Lock the Profile Notification List</span>
06899     <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a> (&amp;IopHwProfileNotifyLock);
06900 
06901     <span class="comment">//</span>
06902     <span class="comment">//  Grab the list head (inside the lock)</span>
06903     <span class="comment">//</span>
06904     link = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a41">IopProfileNotifyList</a>.Flink;
06905     pNotifyList=(<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">PHWPROFILE_NOTIFY_ENTRY</a>)link;
06906 
06907     <span class="comment">//</span>
06908     <span class="comment">//circular list</span>
06909     <span class="comment">//</span>
06910     <span class="keywordflow">while</span> (link != (PLIST_ENTRY)&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a41">IopProfileNotifyList</a>) {
06911         <span class="keywordflow">if</span> (!pNotifyList-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o6">Unregistered</a>) {
06912 
06913             <a class="code" href="../../d9/d8/struct__HWPROFILE__CHANGE__NOTIFICATION.html">HWPROFILE_CHANGE_NOTIFICATION</a> notification;
06914 
06915             <a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html">NOTIFICATION_CALLBACK_PARAM_BLOCK</a> callparams;
06916             ULONG Console=0;
06917 
06918             <span class="comment">//</span>
06919             <span class="comment">// Reference the entry so that no one deletes during the callback</span>
06920             <span class="comment">// and then release the lock</span>
06921             <span class="comment">//</span>
06922             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)pNotifyList);
06923             <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;IopHwProfileNotifyLock);
06924 
06925             <span class="comment">//</span>
06926             <span class="comment">// Fill in the notification</span>
06927             <span class="comment">//</span>
06928 
06929             notification.<a class="code" href="../../d9/d8/struct__HWPROFILE__CHANGE__NOTIFICATION.html#o0">Version</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a110">PNP_NOTIFICATION_VERSION</a>;
06930             notification.<a class="code" href="../../d9/d8/struct__HWPROFILE__CHANGE__NOTIFICATION.html#o1">Size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__HWPROFILE__CHANGE__NOTIFICATION.html">HWPROFILE_CHANGE_NOTIFICATION</a>);
06931             notification.<a class="code" href="../../d9/d8/struct__HWPROFILE__CHANGE__NOTIFICATION.html#o2">Event</a> = *EventGuid;
06932 
06933 <span class="preprocessor">#if DBG</span>
06934 <span class="preprocessor"></span>            originalApcDisable = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable;
06935 <span class="preprocessor">#endif</span>
06936 <span class="preprocessor"></span>            <span class="comment">//</span>
06937             <span class="comment">// Reference the notify and call back</span>
06938             <span class="comment">//</span>
06939             callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(pNotifyList-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o2">Callback</a>);
06940             callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=&amp;notification;
06941             callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=pNotifyList-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o3">Context</a>;
06942 
06943 
06944             <span class="comment">//</span>
06945             <span class="comment">// Dispatch this function via the memory manager.</span>
06946             <span class="comment">// Win32K is a driver that can have multiple copies. If Hydra</span>
06947             <span class="comment">// is running, the Mem. manager will check if the callback exists</span>
06948             <span class="comment">// in "per session" space. If that is the case, it will attach to the</span>
06949             <span class="comment">// console (hence the 3rd param of PULONG containing 0) session and deliver</span>
06950             <span class="comment">// it. If either Hydra is not running, or the callback is outside session space</span>
06951             <span class="comment">// then the callback is called directly.</span>
06952             <span class="comment">//</span>
06953             status = <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((PKWIN32_CALLOUT)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;IopPnPHydraCallback,&amp;callparams,&amp;Console);
06954 <span class="preprocessor">#if DBG</span>
06955 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (originalApcDisable != <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable) {
06956                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopNotifyHwProfileChange: Driver %Z, notification handler @ 0x%p returned with different KernelApcDisable = %d, original = %d\n"</span>,
06957                          &amp;pNotifyList-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o4">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>, pNotifyList-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o2">Callback</a>, <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable, originalApcDisable);
06958                 DbgBreakPoint();
06959             }
06960 <span class="preprocessor">#endif</span>
06961 <span class="preprocessor"></span>
06962             <span class="comment">//</span>
06963             <span class="comment">// If the caller returned anything other than success and it was a</span>
06964             <span class="comment">// query hardware profile change, we veto the query and send cancels</span>
06965             <span class="comment">// to all callers that already got the query.</span>
06966             <span class="comment">//</span>
06967 
06968             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp;
06969                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid, (LPGUID)&amp;GUID_HWPROFILE_QUERY_CHANGE)) {
06970 
06971                 <span class="keywordflow">if</span> (VetoType) {
06972                     *VetoType = PNP_VetoDriver;
06973                 }
06974                 <span class="keywordflow">if</span> (VetoName) {
06975                     VetoName-&gt;Length = 0;
06976                     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(VetoName, &amp;pNotifyList-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o4">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>);
06977                 }
06978 
06979                 notification.<a class="code" href="../../d9/d8/struct__HWPROFILE__CHANGE__NOTIFICATION.html#o2">Event</a> = GUID_HWPROFILE_CHANGE_CANCELLED;
06980                 notification.<a class="code" href="../../d9/d8/struct__HWPROFILE__CHANGE__NOTIFICATION.html#o1">Size</a> = <span class="keyword">sizeof</span>(GUID_HWPROFILE_CHANGE_CANCELLED);
06981 
06982                 <span class="comment">//</span>
06983                 <span class="comment">// Dereference the entry which vetoed the query change.</span>
06984                 <span class="comment">//</span>
06985                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;IopHwProfileNotifyLock);
06986                 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)pNotifyList);
06987 
06988                 <span class="keywordflow">do</span> {
06989                     pNotifyList = (<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">PHWPROFILE_NOTIFY_ENTRY</a>)link;
06990                     <span class="keywordflow">if</span> (!pNotifyList-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o6">Unregistered</a>) {
06991                         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)pNotifyList);
06992                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;IopHwProfileNotifyLock);
06993 
06994 <span class="preprocessor">#if DBG</span>
06995 <span class="preprocessor"></span>                        originalApcDisable = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable;
06996 <span class="preprocessor">#endif</span>
06997 <span class="preprocessor"></span>                        callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(pNotifyList-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o2">Callback</a>);
06998                         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=&amp;notification;
06999                         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=pNotifyList-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o3">Context</a>;
07000 
07001                         <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((PKWIN32_CALLOUT)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;IopPnPHydraCallback,&amp;callparams,&amp;Console);
07002 <span class="preprocessor">#if DBG</span>
07003 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (originalApcDisable != <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable) {
07004                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopNotifyHwProfileChange: Driver %Z, notification handler @ 0x%p returned with different KernelApcDisable = %d, original = %d\n"</span>,
07005                                      &amp;pNotifyList-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o4">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>, pNotifyList-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o2">Callback</a>, <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable, originalApcDisable);
07006                             DbgBreakPoint();
07007                         }
07008 <span class="preprocessor">#endif</span>
07009 <span class="preprocessor"></span>
07010                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;IopHwProfileNotifyLock);
07011                         link = link-&gt;Blink;
07012                         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)pNotifyList);
07013 
07014                     } <span class="keywordflow">else</span> {
07015                         link = link-&gt;Blink;
07016                     }
07017                 } <span class="keywordflow">while</span> (link != (PLIST_ENTRY)&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a41">IopProfileNotifyList</a>);
07018 
07019                 <span class="keywordflow">goto</span> Clean0;
07020             }
07021 
07022             <span class="comment">//</span>
07023             <span class="comment">// Reacquire the lock, walk forward, and dereference</span>
07024             <span class="comment">//</span>
07025             <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a> (&amp;IopHwProfileNotifyLock);
07026             link = link-&gt;Flink;
07027             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)pNotifyList);
07028             pNotifyList=(<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">PHWPROFILE_NOTIFY_ENTRY</a>)link;
07029 
07030         } <span class="keywordflow">else</span> {
07031             <span class="comment">//</span>
07032             <span class="comment">//Walk forward if we hit an unregistered node</span>
07033             <span class="comment">//</span>
07034             <span class="keywordflow">if</span> (pNotifyList) {
07035                 <span class="comment">//</span>
07036                 <span class="comment">//walk forward</span>
07037                 <span class="comment">//</span>
07038                 link = link-&gt;Flink;
07039                 pNotifyList=(<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">PHWPROFILE_NOTIFY_ENTRY</a>)link;
07040             }
07041         }
07042     }
07043 
07044  Clean0:
07045 
07046     <span class="comment">//UnLock the Profile Notification List</span>
07047     <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a> (&amp;IopHwProfileNotifyLock);
07048 
07049     <span class="keywordflow">return</span> status;
07050 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a347" doxytag="pnpiop.h::IopNotifySetupDeviceArrival" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopNotifySetupDeviceArrival           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalDeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>EnumEntryKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>InstallDriver</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08162">8162</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02328">_SETUP_NOTIFY_DATA::Callback</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00064">_NOTIFICATION_CALLBACK_PARAM_BLOCK::Callout</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02329">_SETUP_NOTIFY_DATA::Context</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00066">_NOTIFICATION_CALLBACK_PARAM_BLOCK::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d9/d0/pnpsetup_8h-source.html#l00044">_SETUP_DEVICE_ARRIVAL_NOTIFICATION::EnumEntryKey</a>, <a class="el" href="../../d9/d0/pnpsetup_8h-source.html#l00045">_SETUP_DEVICE_ARRIVAL_NOTIFICATION::EnumPath</a>, <a class="el" href="../../d9/d0/pnpsetup_8h-source.html#l00039">_SETUP_DEVICE_ARRIVAL_NOTIFICATION::Event</a>, <a class="el" href="../../d9/d0/pnpsetup_8h-source.html#l00046">_SETUP_DEVICE_ARRIVAL_NOTIFICATION::InstallDriver</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09333">IopPnPHydraCallback()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00185">IopSetupNotifyData</a>, <a class="el" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00065">_NOTIFICATION_CALLBACK_PARAM_BLOCK::NotificationStructure</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d0/pnpsetup_8h-source.html#l00043">_SETUP_DEVICE_ARRIVAL_NOTIFICATION::PhysicalDeviceObject</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00559">PKWIN32_CALLOUT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02359">PNP_NOTIFICATION_VERSION</a>, <a class="el" href="../../d8/d1/pnpsetup_8h.html#a0">SETUP_DEVICE_ARRIVAL_NOTIFICATION</a>, <a class="el" href="../../d9/d0/pnpsetup_8h-source.html#l00038">_SETUP_DEVICE_ARRIVAL_NOTIFICATION::Size</a>, and <a class="el" href="../../d9/d0/pnpsetup_8h-source.html#l00037">_SETUP_DEVICE_ARRIVAL_NOTIFICATION::Version</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04318">IopNotifySetupDevices()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>08170                    :
08171 
08172     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to notify setup (during text-mode setup) of arrivals
08173     of a particular device. It does not <span class="keywordflow">return</span> until all interested parties have
08174     been notified.
08175 
08176 Parameters:
08177 
08178     PhysicalDeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly arrived
08179         device.
08180 
08181     EnumEntryKey - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devide under
08182         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Enum\ branch of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.  Can be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> in which <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
08183         will be opened here.
08184 
08185     InstallDriver - Indicates whether setup should attempt to install a driver
08186                     <span class="keywordflow">for</span> <span class="keyword">this</span> object.  Device objects created through
08187                     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a81">IoReportDetectedDevice</a>() already have a driver but we want
08188                     to indicate them to setup anyway.
08189 
08190 Return Value:
08191 
08192     Status code that indicates whether or not the function was successful.
08193 
08194 Note:
08195 
08196     The contents of the notification structure *including* all pointers is only
08197     valid during the callback routine to which it was passed.  If the data is
08198     required after the duration of the callback then it must be physically copied
08199     by the callback routine.
08200 
08201 --*/
08202 
08203 {
08204     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08205 
08206     <span class="comment">//</span>
08207     <span class="comment">// Only perform notifications if someone has registered</span>
08208     <span class="comment">//</span>
08209 
08210     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/pnpioapi_8c.html#a39">IopSetupNotifyData</a>) {
08211 
08212         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
08213         <a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html">SETUP_DEVICE_ARRIVAL_NOTIFICATION</a> notification;
08214         <a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html">NOTIFICATION_CALLBACK_PARAM_BLOCK</a> callparams;
08215         ULONG Console=0;
08216         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
08217         HANDLE enumKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08218 
08219         <span class="comment">//</span>
08220         <span class="comment">// Fill in the notification</span>
08221         <span class="comment">//</span>
08222 
08223         <span class="keywordflow">if</span> (!EnumEntryKey) {
08224             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(PhysicalDeviceObject,
08225                                                      &amp;enumKey,
08226                                                      KEY_WRITE);
08227             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08228                 <span class="keywordflow">return</span> status;
08229             }
08230             EnumEntryKey = enumKey;
08231         }
08232 
08233         notification.<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html#o0">Version</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a110">PNP_NOTIFICATION_VERSION</a>;
08234         notification.<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html#o1">Size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html">SETUP_DEVICE_ARRIVAL_NOTIFICATION</a>);
08235         notification.<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html#o2">Event</a> = GUID_SETUP_DEVICE_ARRIVAL;
08236         notification.<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html#o3">PhysicalDeviceObject</a> = PhysicalDeviceObject;
08237         notification.<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html#o4">EnumEntryKey</a> = EnumEntryKey;
08238         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) PhysicalDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
08239         notification.<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html#o5">EnumPath</a> = &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>;
08240         notification.<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html#o6">InstallDriver</a> = InstallDriver;
08241 
08242         <span class="comment">//</span>
08243         <span class="comment">// Reference the notify and call back</span>
08244         <span class="comment">//</span>
08245 
08246         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a39">IopSetupNotifyData</a>-&gt;<a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html#o2">Callback</a>);
08247         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=&amp;notification;
08248         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=<a class="code" href="../../d8/d0/pnpioapi_8c.html#a39">IopSetupNotifyData</a>-&gt;<a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html#o3">Context</a>;
08249 
08250 
08251         <span class="comment">//</span>
08252         <span class="comment">// Dispatch this function via the memory manager.</span>
08253         <span class="comment">// Win32K is a driver that can have multiple copies. If Hydra</span>
08254         <span class="comment">// is running, the Mem. manager will check if the callback exists</span>
08255         <span class="comment">// in "per session" space. If that is the case, it will attach to the</span>
08256         <span class="comment">// console (hence the 3rd param of PULONG containing 0) session and deliver</span>
08257         <span class="comment">// it. If either Hydra is not running, or the callback is outside session space</span>
08258         <span class="comment">// then the callback is called directly.</span>
08259         <span class="comment">//</span>
08260         status = <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((PKWIN32_CALLOUT)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;IopPnPHydraCallback,&amp;callparams,&amp;Console);
08261         <span class="keywordflow">if</span> (enumKey) {
08262             ZwClose(enumKey);
08263         }
08264 
08265         <span class="keywordflow">return</span> status;
08266 
08267     } <span class="keywordflow">else</span> {
08268 
08269         <span class="keywordflow">return</span> STATUS_OBJECT_NAME_NOT_FOUND;
08270 
08271     }
08272 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a349" doxytag="pnpiop.h::IopNotifyTargetDeviceChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopNotifyTargetDeviceChange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPCGUID&nbsp;</td>
          <td class="mdname" nowrap> <em>EventGuid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NotificationStructure</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>VetoingDriver</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07055">7055</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02213">_NOTIFY_ENTRY_HEADER::Callback</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00064">_NOTIFICATION_CALLBACK_PARAM_BLOCK::Callout</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02219">_NOTIFY_ENTRY_HEADER::Context</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00066">_NOTIFICATION_CALLBACK_PARAM_BLOCK::Context</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01385">_DRIVER_OBJECT::DriverName</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02226">_NOTIFY_ENTRY_HEADER::DriverObject</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00985">_TARGET_DEVICE_REMOVAL_NOTIFICATION::Event</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00989">_TARGET_DEVICE_REMOVAL_NOTIFICATION::FileObject</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l01009">_TARGET_DEVICE_CUSTOM_NOTIFICATION::FileObject</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02053">IopAcquireNotifyLock</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02070">IopCompareGuid</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06600">IopDereferenceNotify()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09333">IopPnPHydraCallback()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06564">IopReferenceNotify()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02061">IopReleaseNotifyLock</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00186">IopTargetDeviceNotifyLock</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00065">_NOTIFICATION_CALLBACK_PARAM_BLOCK::NotificationStructure</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00559">PKWIN32_CALLOUT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02359">PNP_NOTIFICATION_VERSION</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00984">_TARGET_DEVICE_REMOVAL_NOTIFICATION::Size</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00232">_DEVICE_NODE::TargetDeviceNotify</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02240">_NOTIFY_ENTRY_HEADER::Unregistered</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02270">_TARGET_DEVICE_NOTIFY_ENTRY::Unregistered</a>, and <a class="el" href="../../d7/d8/pnp_8h-source.html#l00983">_TARGET_DEVICE_REMOVAL_NOTIFICATION::Version</a>.
<p>
<pre class="fragment"><div>07064                    :
07065 
07066     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to notify all registered drivers of a change to a
07067     particular device. It does not <span class="keywordflow">return</span> until all interested parties have
07068     been notified.
07069 
07070 Parameters:
07071 
07072     EventGuid - The event that has occured
07073 
07074     DeviceObject - The device object that has changed.  The devnode <span class="keywordflow">for</span> <span class="keyword">this</span>
07075         device object contains a list of callback <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> that have registered
07076         <span class="keywordflow">for</span> notification of any changes on <span class="keyword">this</span> device object.
07077 
07078 Return Value:
07079 
07080     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
07081 
07082 Note:
07083 
07084     The contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notification structure *including* all pointers <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
07085     valid during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine to which <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was passed.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
07086     required after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duration of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be physically copied
07087     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine.
07088 
07089 --*/
07090 
07091 {
07092     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
07093     PLIST_ENTRY link, lastLink;
07094     <a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">PTARGET_DEVICE_NOTIFY_ENTRY</a> entry;
07095     <a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html">TARGET_DEVICE_REMOVAL_NOTIFICATION</a> notification;
07096     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
07097     BOOLEAN reverse;
07098 <span class="preprocessor">#if DBG</span>
07099 <span class="preprocessor"></span>    KIRQL originalIrql;
07100     ULONG originalApcDisable;
07101 <span class="preprocessor">#endif</span>
07102 <span class="preprocessor"></span>
07103     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07104 
07105     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceObject != NULL);
07106     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(EventGuid != NULL);
07107 
07108     <span class="comment">//</span>
07109     <span class="comment">// Reference the device object so it can't go away while we're doing notification</span>
07110     <span class="comment">//</span>
07111     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(DeviceObject);
07112 
07113     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
07114 
07115     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode != NULL);
07116 
07117 
07118     <span class="keywordflow">if</span> (NotificationStructure) {
07119         <span class="comment">//</span>
07120         <span class="comment">//We're handling a custom notification</span>
07121         <span class="comment">//</span>
07122 
07123         ((<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">PTARGET_DEVICE_CUSTOM_NOTIFICATION</a>)NotificationStructure)-&gt;Version = <a class="code" href="../../d9/d0/pnpiop_8h.html#a110">PNP_NOTIFICATION_VERSION</a>;
07124 
07125     } <span class="keywordflow">else</span> {
07126         <span class="comment">//</span>
07127         <span class="comment">// Fill in the notification</span>
07128         <span class="comment">//</span>
07129 
07130         notification.<a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html#o0">Version</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a110">PNP_NOTIFICATION_VERSION</a>;
07131         notification.<a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html#o1">Size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html">TARGET_DEVICE_REMOVAL_NOTIFICATION</a>);
07132         notification.<a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html#o2">Event</a> = *EventGuid;
07133     }
07134 
07135     <span class="comment">//</span>
07136     <span class="comment">// Lock the notify list</span>
07137     <span class="comment">//</span>
07138 
07139     <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;IopTargetDeviceNotifyLock);
07140 
07141     <span class="comment">//</span>
07142     <span class="comment">// Get the first entry</span>
07143     <span class="comment">//</span>
07144 
07145     reverse = <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid, (LPGUID)&amp;GUID_TARGET_DEVICE_REMOVE_CANCELLED);
07146 
07147     <span class="keywordflow">if</span> (reverse) {
07148         link = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o23">TargetDeviceNotify</a>.Blink;
07149     } <span class="keywordflow">else</span> {
07150         link = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o23">TargetDeviceNotify</a>.Flink;
07151     }
07152 
07153     <span class="comment">//</span>
07154     <span class="comment">// Iterate through the list</span>
07155     <span class="comment">//</span>
07156 
07157     <span class="keywordflow">while</span> (link != &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o23">TargetDeviceNotify</a>) {
07158 
07159         entry = (<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">PTARGET_DEVICE_NOTIFY_ENTRY</a>)link;
07160 
07161         <span class="comment">//</span>
07162         <span class="comment">// Only callback on registered nodes</span>
07163         <span class="comment">//</span>
07164 
07165         <span class="keywordflow">if</span> (!entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o6">Unregistered</a>) {
07166 
07167             <a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html">NOTIFICATION_CALLBACK_PARAM_BLOCK</a> callparams;
07168             ULONG Console=0;
07169 
07170             <span class="comment">//</span>
07171             <span class="comment">// Reference the entry so that no one deletes during the callback</span>
07172             <span class="comment">// and then release the lock</span>
07173             <span class="comment">//</span>
07174 
07175             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)entry);
07176             <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;IopTargetDeviceNotifyLock);
07177 
07178 <span class="preprocessor">#if DBG</span>
07179 <span class="preprocessor"></span>            originalIrql = KeGetCurrentIrql();
07180             originalApcDisable = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable;
07181 <span class="preprocessor">#endif</span>
07182 <span class="preprocessor"></span>
07183             <span class="comment">//</span>
07184             <span class="comment">// Callback the entity that registered and examine return value</span>
07185             <span class="comment">//</span>
07186 
07187             <span class="keywordflow">if</span> (NotificationStructure) {
07188                 <a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">TARGET_DEVICE_CUSTOM_NOTIFICATION</a> *notificationStructure = NotificationStructure;
07189 
07190                 notificationStructure-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o3">FileObject</a> = entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o8">FileObject</a>;
07191 
07192                 callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o2">Callback</a>);
07193                 callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=NotificationStructure;
07194                 callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o3">Context</a>;
07195 
07196 
07197                 <span class="comment">//</span>
07198                 <span class="comment">// Dispatch this function via the memory manager.</span>
07199                 <span class="comment">// Win32K is a driver that can have multiple copies. If Hydra</span>
07200                 <span class="comment">// is running, the Mem. manager will check if the callback exists</span>
07201                 <span class="comment">// in "per session" space. If that is the case, it will attach to the</span>
07202                 <span class="comment">// console (hence the 3rd param of PULONG containing 0) session and deliver</span>
07203                 <span class="comment">// it. If either Hydra is not running, or the callback is outside session space</span>
07204                 <span class="comment">// then the callback is called directly.</span>
07205                 <span class="comment">//</span>
07206                 status = <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((PKWIN32_CALLOUT)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;IopPnPHydraCallback,&amp;callparams,&amp;Console);
07207 
07208 
07209             } <span class="keywordflow">else</span> {
07210                 notification.<a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html#o3">FileObject</a> = entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o8">FileObject</a>;
07211 
07212                 callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o2">Callback</a>);
07213                 callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=&amp;notification;
07214                 callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o3">Context</a>;
07215 
07216                 status = <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((PKWIN32_CALLOUT)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;IopPnPHydraCallback,&amp;callparams,&amp;Console);
07217 
07218             }
07219 
07220 <span class="preprocessor">#if DBG</span>
07221 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (originalIrql != KeGetCurrentIrql()) {
07222                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopNotifyTargetDeviceChange: Driver %Z, notification handler @ 0x%p returned at raised IRQL = %d, original = %d\n"</span>,
07223                          &amp;entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o4">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>, entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o2">Callback</a>, KeGetCurrentIrql(), originalIrql);
07224                 DbgBreakPoint();
07225             }
07226             <span class="keywordflow">if</span> (originalApcDisable != <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable) {
07227                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopNotifyTargetDeviceChange: Driver %Z, notification handler @ 0x%p returned with different KernelApcDisable = %d, original = %d\n"</span>,
07228                          &amp;entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o4">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>, entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o2">Callback</a>, <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable, originalApcDisable);
07229                 DbgBreakPoint();
07230             }
07231 <span class="preprocessor">#endif</span>
07232 <span class="preprocessor"></span>
07233             <span class="comment">//</span>
07234             <span class="comment">// If the caller returned anything other than success and it was</span>
07235             <span class="comment">// a query remove, we veto the query remove and send cancels to</span>
07236             <span class="comment">// all callers that already got the query remove.</span>
07237             <span class="comment">//</span>
07238 
07239             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp;
07240                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid, (LPGUID)&amp;GUID_TARGET_DEVICE_QUERY_REMOVE)) {
07241 
07242                 <span class="keywordflow">if</span> (VetoingDriver != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07243                     *VetoingDriver = entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o4">DriverObject</a>;
07244                 }
07245 
07246                 notification.<a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html#o2">Event</a> = GUID_TARGET_DEVICE_REMOVE_CANCELLED;
07247 
07248                 <span class="comment">//</span>
07249                 <span class="comment">// Dereference the entry which vetoed the query remove.</span>
07250                 <span class="comment">//</span>
07251                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;IopTargetDeviceNotifyLock);
07252                 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)entry);
07253 
07254                 <span class="keywordflow">do</span> {
07255                     entry = (<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">PTARGET_DEVICE_NOTIFY_ENTRY</a>)link;
07256                     <span class="keywordflow">if</span> (!entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o6">Unregistered</a>) {
07257                         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)entry);
07258                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;IopTargetDeviceNotifyLock);
07259 
07260                         notification.<a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html#o3">FileObject</a> = entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o8">FileObject</a>;
07261 <span class="preprocessor">#if DBG</span>
07262 <span class="preprocessor"></span>                        originalApcDisable = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable;
07263 <span class="preprocessor">#endif</span>
07264 <span class="preprocessor"></span>
07265                         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o2">Callback</a>);
07266                         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=&amp;notification;
07267                         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o3">Context</a>;
07268 
07269                         <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((PKWIN32_CALLOUT)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;IopPnPHydraCallback,&amp;callparams,&amp;Console);
07270 
07271 <span class="preprocessor">#if DBG</span>
07272 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (originalApcDisable != <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable) {
07273                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopNotifyTargetDeviceChange: Driver %Z, notification handler @ 0x%p returned with different KernelApcDisable = %d, original = %d\n"</span>,
07274                                      &amp;entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o4">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>, entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o2">Callback</a>, <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable, originalApcDisable);
07275                             DbgBreakPoint();
07276                         }
07277 <span class="preprocessor">#endif</span>
07278 <span class="preprocessor"></span>
07279                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;IopTargetDeviceNotifyLock);
07280                         link = link-&gt;Blink;
07281                         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>( (<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>) entry );
07282 
07283                     } <span class="keywordflow">else</span> {
07284                         link = link-&gt;Blink;
07285                     }
07286                 } <span class="keywordflow">while</span> (link != &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o23">TargetDeviceNotify</a>);
07287 
07288                 <span class="keywordflow">goto</span> Clean0;
07289             }
07290 
07291             <span class="comment">//</span>
07292             <span class="comment">// Reacquire the lock and dereference</span>
07293             <span class="comment">//</span>
07294             <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;IopTargetDeviceNotifyLock);
07295             <span class="keywordflow">if</span> (reverse) {
07296                 link = link-&gt;Blink;
07297             } <span class="keywordflow">else</span> {
07298                 link = link-&gt;Flink;
07299             }
07300             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)entry);
07301 
07302         } <span class="keywordflow">else</span> {
07303 
07304             <span class="comment">//</span>
07305             <span class="comment">// Advance down the list</span>
07306             <span class="comment">//</span>
07307             <span class="keywordflow">if</span> (reverse) {
07308                 link = link-&gt;Blink;
07309             } <span class="keywordflow">else</span> {
07310                 link = link-&gt;Flink;
07311             }
07312         }
07313     }
07314 
07315 Clean0:
07316 
07317     <span class="comment">//</span>
07318     <span class="comment">// Release the lock and dereference the object</span>
07319     <span class="comment">//</span>
07320 
07321     <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;IopTargetDeviceNotifyLock);
07322 
07323     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DeviceObject);
07324 
07325     <span class="keywordflow">return</span> status;
07326 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a239" doxytag="pnpiop.h::IopOpenCurrentHwProfileDeviceInstanceKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopOpenCurrentHwProfileDeviceInstanceKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Instance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Create</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01712">1712</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00179">CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00023">Create()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01471">IopGetDeviceInstanceCsConfigFlags()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01591">IopGetServiceInstanceCsConfigFlags()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01531">IopSetDeviceInstanceCsConfigFlags()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01653">IopSetServiceInstanceCsConfigFlags()</a>.
<p>
<pre class="fragment"><div>01722                    :
01723 
01724     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> csconfig flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device
01725     which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number under ServiceKeyName\Enum.
01726 
01727 Arguments:
01728 
01729     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01730         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
01731         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryPath parameter
01732         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> routine.
01733 
01734     Instance - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance value under ServiceKeyName\Enum key
01735 
01736     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller needs to
01737         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
01738 
01739     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> - Determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be created <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not exist.
01740 
01741 Return Value:
01742 
01743     status
01744 
01745 --*/
01746 
01747 {
01748     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01749     UNICODE_STRING tempUnicodeString;
01750     HANDLE profileHandle, profileEnumHandle, tmpHandle;
01751 
01752     <span class="comment">//</span>
01753     <span class="comment">// See if we can open current hardware profile</span>
01754     <span class="comment">//</span>
01755 
01756     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
01757         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;profileHandle,
01758                                          NULL,
01759                                          &amp;CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent,
01760                                          KEY_READ,
01761                                          REG_OPTION_NON_VOLATILE,
01762                                          NULL
01763                                          );
01764     } <span class="keywordflow">else</span> {
01765         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;profileHandle,
01766                                        NULL,
01767                                        &amp;CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent,
01768                                        KEY_READ
01769                                        );
01770     }
01771 
01772     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01773         <span class="comment">//</span>
01774         <span class="comment">// Now, we must open the System\CCS\Enum key under this.</span>
01775         <span class="comment">//</span>
01776         <span class="comment">//</span>
01777         <span class="comment">// Open system\CurrentControlSet under current hardware profile key</span>
01778         <span class="comment">//</span>
01779 
01780         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_PATH_CURRENTCONTROLSET);
01781         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;tmpHandle,
01782                                        profileHandle,
01783                                        &amp;tempUnicodeString,
01784                                        DesiredAccess
01785                                        );
01786         ZwClose(profileHandle);
01787         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01788             <span class="keywordflow">return</span> status;
01789         }
01790 
01791         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_KEY_ENUM);
01792 
01793         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
01794             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;profileEnumHandle,
01795                                              tmpHandle,
01796                                              &amp;tempUnicodeString,
01797                                              KEY_READ,
01798                                              REG_OPTION_NON_VOLATILE,
01799                                              NULL
01800                                              );
01801         } <span class="keywordflow">else</span> {
01802             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;profileEnumHandle,
01803                                            tmpHandle,
01804                                            &amp;tempUnicodeString,
01805                                            KEY_READ
01806                                            );
01807         }
01808 
01809         ZwClose(tmpHandle);
01810         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01811 
01812             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(NULL,
01813                                                         ServiceKeyName,
01814                                                         Instance,
01815                                                         &amp;tempUnicodeString,
01816                                                         NULL,
01817                                                         0
01818                                                        );
01819             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01820                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
01821                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( Handle,
01822                                                      profileEnumHandle,
01823                                                      &amp;tempUnicodeString,
01824                                                      DesiredAccess,
01825                                                      REG_OPTION_NON_VOLATILE,
01826                                                      NULL
01827                                                      );
01828                 } <span class="keywordflow">else</span> {
01829                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( Handle,
01830                                                    profileEnumHandle,
01831                                                    &amp;tempUnicodeString,
01832                                                    DesiredAccess
01833                                                    );
01834                 }
01835                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;tempUnicodeString);
01836             }
01837             ZwClose(profileEnumHandle);
01838         }
01839     }
01840     <span class="keywordflow">return</span> status;
01841 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a304" doxytag="pnpiop.h::IopOpenDeviceParametersSubkey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopOpenDeviceParametersSubkey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT HANDLE *&nbsp;</td>
          <td class="mdname" nowrap> <em>ParamKeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentKeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SubKeyString</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">8501</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01666">RtlAddAccessAllowedAceEx()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00718">RtlAddAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00996">RtlGetAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02665">RtlGetDaclSecurityDescriptor()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00460">RtlQueryInformationAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">RtlSetDaclSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02066">RtlValidSecurityDescriptor()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01630">SeAliasAdminsSid</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00810">IoOpenDeviceRegistryKey()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01298">MapperSeedKey()</a>, and <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l02089">PnPBiosCopyDeviceParamKey()</a>.
<p>
<pre class="fragment"><div>08510                    :
08511 
08512     This routine reports whether WDM functionality <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available that
08513     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater than or equal to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified major and minor version.
08514 
08515 Parameters:
08516 
08517     MajorVersion - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> WDM major version that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
08518 
08519     MinorVersion - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> WDM minor version that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
08520 
08521 Return Value:
08522 
08523     If WDM support <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available at _at least_ <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested level, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
08524     <span class="keywordflow">return</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, otherwise <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
08525 
08526 --*/
08527 
08528 {
08529     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    status;
08530     ULONG                       disposition;
08531     ULONG                       lengthSD;
08532     PSECURITY_DESCRIPTOR        oldSD = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08533     SECURITY_DESCRIPTOR         newSD;
08534     ACL_SIZE_INFORMATION        aclSizeInfo;
08535     PACL                        oldDacl;
08536     PACL                        newDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08537     ULONG                       sizeDacl;
08538     BOOLEAN                     daclPresent, daclDefaulted;
08539     PACCESS_ALLOWED_ACE         ace;
08540     ULONG                       aceIndex;
08541     HANDLE                      deviceKeyHandle;
08542     UNICODE_STRING              deviceParamString;
08543 
08544     <span class="comment">//</span>
08545     <span class="comment">// First try and open the device key</span>
08546     <span class="comment">//</span>
08547     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;deviceKeyHandle,
08548                                    ParentKeyHandle,
08549                                    SubKeyString,
08550                                    KEY_WRITE
08551                                    );
08552 
08553     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08554         <span class="keywordflow">return</span> status;
08555     }
08556 
08557     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;deviceParamString, REGSTR_KEY_DEVICEPARAMETERS);
08558 
08559     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( ParamKeyHandle,
08560                                      deviceKeyHandle,
08561                                      &amp;deviceParamString,
08562                                      DesiredAccess | READ_CONTROL | WRITE_DAC,
08563                                      REG_OPTION_NON_VOLATILE,
08564                                      &amp;disposition
08565                                      );
08566 
08567     ZwClose(deviceKeyHandle);
08568 
08569     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08570         KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: IopCreateRegistryKeyEx failed, status = %8.8X\n"</span>, status));
08571         <span class="keywordflow">return</span> status;
08572     }
08573 
08574     <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {
08575 
08576         <span class="comment">//</span>
08577         <span class="comment">// Need to set an ACL on the key if it was created</span>
08578         <span class="comment">//</span>
08579         <span class="comment">//</span>
08580         <span class="comment">// Get the security descriptor from the key so we can add the</span>
08581         <span class="comment">// administrator.</span>
08582         <span class="comment">//</span>
08583         status = ZwQuerySecurityObject(*ParamKeyHandle,
08584                                        DACL_SECURITY_INFORMATION,
08585                                        NULL,
08586                                        0,
08587                                        &amp;lengthSD);
08588 
08589         <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL) {
08590             oldSD = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, lengthSD );
08591 
08592             <span class="keywordflow">if</span> (oldSD != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08593 
08594                 status = ZwQuerySecurityObject(*ParamKeyHandle,
08595                                                DACL_SECURITY_INFORMATION,
08596                                                oldSD,
08597                                                lengthSD,
08598                                                &amp;lengthSD);
08599                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08600                     KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: ZwQuerySecurityObject failed, status = %8.8X\n"</span>, status));
08601                     <span class="keywordflow">goto</span> Cleanup0;
08602                 }
08603             } <span class="keywordflow">else</span>  {
08604 
08605                 KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: Failed to allocate memory, status = %8.8X\n"</span>, status));
08606                 status = STATUS_NO_MEMORY;
08607                 <span class="keywordflow">goto</span> Cleanup0;
08608             }
08609         } <span class="keywordflow">else</span> {
08610            KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: ZwQuerySecurityObject failed %8.8X\n"</span>,status));
08611            status = STATUS_UNSUCCESSFUL;
08612            <span class="keywordflow">goto</span> Cleanup0;
08613         }
08614 
08615         status = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( (PSECURITY_DESCRIPTOR) &amp;newSD,
08616                                               SECURITY_DESCRIPTOR_REVISION );
08617         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
08618 
08619         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08620 
08621             KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlCreateSecurityDescriptor failed, status = %8.8X\n"</span>, status));
08622             <span class="keywordflow">goto</span> Cleanup0;
08623         }
08624         <span class="comment">//</span>
08625         <span class="comment">// get the current DACL</span>
08626         <span class="comment">//</span>
08627         status = <a class="code" href="../../d8/d6/sertl_8c.html#a61">RtlGetDaclSecurityDescriptor</a>(oldSD, &amp;daclPresent, &amp;oldDacl, &amp;daclDefaulted);
08628 
08629         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
08630 
08631         <span class="comment">//</span>
08632         <span class="comment">// calculate the size of the new DACL</span>
08633         <span class="comment">//</span>
08634 
08635         <span class="keywordflow">if</span> (daclPresent) {
08636 
08637             status = <a class="code" href="../../d2/d4/acledit_8c.html#a8">RtlQueryInformationAcl</a>( oldDacl,
08638                                              &amp;aclSizeInfo,
08639                                              <span class="keyword">sizeof</span>(ACL_SIZE_INFORMATION),
08640                                              AclSizeInformation);
08641 
08642 
08643             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08644 
08645                 KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlQueryInformationAcl failed, status = %8.8X\n"</span>, status));
08646                 <span class="keywordflow">goto</span> Cleanup0;
08647             }
08648 
08649             sizeDacl = aclSizeInfo.AclBytesInUse;
08650         } <span class="keywordflow">else</span> {
08651             sizeDacl = <span class="keyword">sizeof</span>(ACL);
08652         }
08653 
08654         sizeDacl += <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE) + <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(SeAliasAdminsSid) - <span class="keyword">sizeof</span>(ULONG);
08655 
08656         <span class="comment">//</span>
08657         <span class="comment">// create and initialize the new DACL</span>
08658         <span class="comment">//</span>
08659         newDacl = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, sizeDacl);
08660 
08661         <span class="keywordflow">if</span> (newDacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08662 
08663             KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: ExAllocatePool failed\n"</span>));
08664             <span class="keywordflow">goto</span> Cleanup0;
08665         }
08666 
08667         status = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>(newDacl, sizeDacl, ACL_REVISION);
08668 
08669         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08670 
08671             KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlCreateAcl failed, status = %8.8X\n"</span>, status));
08672             <span class="keywordflow">goto</span> Cleanup0;
08673         }
08674 
08675         <span class="comment">//</span>
08676         <span class="comment">// copy the current (original) DACL into this new one</span>
08677         <span class="comment">//</span>
08678         <span class="keywordflow">if</span> (daclPresent) {
08679 
08680             <span class="keywordflow">for</span> (aceIndex = 0; aceIndex &lt; aclSizeInfo.AceCount; aceIndex++) {
08681 
08682                 status = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(oldDacl, aceIndex, (PVOID *)&amp;ace);
08683 
08684                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08685 
08686                     KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlGetAce failed, status = %8.8X\n"</span>, status));
08687                     <span class="keywordflow">goto</span> Cleanup0;
08688                 }
08689 
08690                 <span class="comment">//</span>
08691                 <span class="comment">// We need to skip copying any ACEs which refer to the Administrator</span>
08692                 <span class="comment">// to ensure that our full control ACE is the one and only.</span>
08693                 <span class="comment">//</span>
08694                 <span class="keywordflow">if</span> ((ace-&gt;Header.AceType != ACCESS_ALLOWED_ACE_TYPE &amp;&amp;
08695                      ace-&gt;Header.AceType != ACCESS_DENIED_ACE_TYPE) ||
08696                      !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((PSID)&amp;ace-&gt;SidStart, SeAliasAdminsSid)) {
08697 
08698                     status = <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a>( newDacl,
08699                                         ACL_REVISION,
08700                                         ~0U,
08701                                         ace,
08702                                         ace-&gt;Header.AceSize
08703                                         );
08704 
08705                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08706 
08707                         KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlAddAce failed, status = %8.8X\n"</span>, status));
08708                         <span class="keywordflow">goto</span> Cleanup0;
08709                     }
08710                 }
08711             }
08712         }
08713 
08714         <span class="comment">//</span>
08715         <span class="comment">// and my new admin-full ace to this new DACL</span>
08716         <span class="comment">//</span>
08717         status = <a class="code" href="../../d2/d4/acledit_8c.html#a17">RtlAddAccessAllowedAceEx</a>( newDacl,
08718                                            ACL_REVISION,
08719                                            CONTAINER_INHERIT_ACE,
08720                                            KEY_ALL_ACCESS,
08721                                            SeAliasAdminsSid
08722                                            );
08723         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08724 
08725             KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlAddAccessAllowedAceEx failed, status = %8.8X\n"</span>, status));
08726             <span class="keywordflow">goto</span> Cleanup0;
08727         }
08728 
08729         <span class="comment">//</span>
08730         <span class="comment">// Set the new DACL in the absolute security descriptor</span>
08731         <span class="comment">//</span>
08732         status = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( (PSECURITY_DESCRIPTOR) &amp;newSD,
08733                                                TRUE,
08734                                                newDacl,
08735                                                FALSE
08736                                                );
08737 
08738         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08739 
08740             KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlSetDaclSecurityDescriptor failed, status = %8.8X\n"</span>, status));
08741             <span class="keywordflow">goto</span> Cleanup0;
08742         }
08743 
08744         <span class="comment">//</span>
08745         <span class="comment">// validate the new security descriptor</span>
08746         <span class="comment">//</span>
08747         status = <a class="code" href="../../d8/d6/sertl_8c.html#a55">RtlValidSecurityDescriptor</a>(&amp;newSD);
08748 
08749         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08750 
08751             KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlValidSecurityDescriptor failed, status = %8.8X\n"</span>, status));
08752             <span class="keywordflow">goto</span> Cleanup0;
08753         }
08754 
08755 
08756         status = ZwSetSecurityObject( *ParamKeyHandle,
08757                                       DACL_SECURITY_INFORMATION,
08758                                       &amp;newSD
08759                                       );
08760         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08761 
08762             KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: ZwSetSecurityObject failed, status = %8.8X\n"</span>, status));
08763             <span class="keywordflow">goto</span> Cleanup0;
08764         }
08765     }
08766 
08767     <span class="comment">//</span>
08768     <span class="comment">// If we encounter an error updating the DACL we still return success.</span>
08769     <span class="comment">//</span>
08770 
08771 Cleanup0:
08772 
08773     <span class="keywordflow">if</span> (oldSD != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08774         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(oldSD);
08775     }
08776 
08777     <span class="keywordflow">if</span> (newDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08778         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(newDacl);
08779     }
08780 
08781     <span class="keywordflow">return</span> STATUS_SUCCESS;
08782 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a235" doxytag="pnpiop.h::IopOpenRegistryKeyEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopOpenRegistryKeyEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE BaseHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">1104</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00059">EisaBuildEisaDeviceNode()</a>, <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00201">EisaGetEisaDevicesResources()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00373">IoGetDeviceProperty()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00810">IoOpenDeviceRegistryKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02209">IopApplyFunctionToServiceInstances()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01844">IopApplyFunctionToSubKeys()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03960">IopCleanupDeviceRegistryValues()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">IopCreateMadeupNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05902">IopDeleteKeyRecursive()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">IopDeleteLegacyKey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03708">IopDeviceInterfaceKeysFromSymbolicLink()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03759">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03897">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01477">IopGetDeviceInstanceCsConfigFlags()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02707">IopGetDeviceInterfaces()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04120">IopGetDriverTagPriority()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05334">IopGetGroupOrderIndex()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03443">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01572">IopIsFirmwareMapperDevicePresent()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02286">IopIsReportedAlready()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01891">IopMakeGloballyUniqueId()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01712">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04741">IopOpenOrCreateDeviceInterfaceSubKeys()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01339">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03762">IopProcessCriticalDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04000">IopProcessCriticalDeviceRoutine()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">IopRemoveDeviceInterfaces()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00931">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03862">IopStoreSystemPartitionInformation()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04140">IopUnregisterDeviceInterface()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l02089">PnPBiosCopyDeviceParamKey()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l01725">PnPBiosEliminateDupes()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00399">PnPBiosGetBiosInfo()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l02289">PnPBiosWriteInfo()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00788">PnPCheckFixedIoOverrideDecodes()</a>, and <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00759">PnPGetDevnodeExcludeList()</a>.
<p>
<pre class="fragment"><div>01113                    :
01114 
01115     Opens a registry key <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name passed in based at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BaseHandle node.
01116     This name may specify a key that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> actually a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
01117 
01118 Arguments:
01119 
01120     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle which will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry key that
01121         was opened.
01122 
01123     BaseHandle - Optional handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> from which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key must be opened.
01124         If <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> specifies a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> that must be created, then <span class="keyword">this</span> parameter
01125         must be specified, and <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> must be a relative <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
01126 
01127     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> that must be opened/created (possibly a registry path)
01128 
01129     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller needs to
01130         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
01131 
01132 Return Value:
01133 
01134    The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
01135 
01136 --*/
01137 
01138 {
01139     OBJECT_ATTRIBUTES objectAttributes;
01140 
01141     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01142 
01143     InitializeObjectAttributes( &amp;objectAttributes,
01144                                 KeyName,
01145                                 OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
01146                                 BaseHandle,
01147                                 (PSECURITY_DESCRIPTOR) NULL
01148                                 );
01149     <span class="comment">//</span>
01150     <span class="comment">// Simply attempt to open the path, as specified.</span>
01151     <span class="comment">//</span>
01152     <span class="keywordflow">return</span> ZwOpenKey( Handle, DesiredAccess, &amp;objectAttributes );
01153 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a238" doxytag="pnpiop.h::IopOpenServiceEnumKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopOpenServiceEnumKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE ServiceHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE ServiceEnumHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateEnum</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01339">1339</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00178">CmRegistryMachineSystemCurrentControlSetServices</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02209">IopApplyFunctionToServiceInstances()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">IopCreateMadeupNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01411">IopGetDriverDeviceList()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01454">IopGetServiceType()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00931">IopServiceInstanceToDeviceInstance()</a>.
<p>
<pre class="fragment"><div>01349                    :
01350 
01351     This routine opens <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> HKEY_LOCAL_MACHINE\CurrentControlSet\Services\
01352     ServiceKeyName and its Enum subkey and returns handles <span class="keywordflow">for</span> both key.
01353     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> caller's responsibility to close <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned handles.
01354 
01355 Arguments:
01356 
01357     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01358         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
01359         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryPath parameter
01360         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> routine.
01361 
01362     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keys.
01363 
01364     ServiceHandle - Supplies a variable to receive a handle to ServiceKeyName.
01365         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ServiceHandle indicates caller does not want need <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to
01366         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ServiceKeyName.
01367 
01368     ServiceEnumHandle - Supplies a variable to receive a handle to ServiceKeyName\Enum.
01369         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ServiceEnumHandle indicates caller does not need <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to
01370         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ServiceKeyName\Enum.
01371 
01372     CreateEnum - Supplies a BOOLEAN variable to indicate should <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Enum subkey be
01373         created <span class="keywordflow">if</span> not present.
01374 
01375 Return Value:
01376 
01377     status
01378 
01379 --*/
01380 
01381 {
01382     HANDLE handle, serviceHandle, enumHandle;
01383     UNICODE_STRING enumName;
01384     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">// Open System\CurrentControlSet\Services</span>
01388     <span class="comment">//</span>
01389 
01390     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
01391                                    NULL,
01392                                    &amp;CmRegistryMachineSystemCurrentControlSetServices,
01393                                    DesiredAccess
01394                                    );
01395 
01396     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01397         <span class="keywordflow">return</span> status;
01398     }
01399 
01400     <span class="comment">//</span>
01401     <span class="comment">// Open the registry ServiceKeyName key.</span>
01402     <span class="comment">//</span>
01403 
01404     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;serviceHandle,
01405                                    handle,
01406                                    ServiceKeyName,
01407                                    DesiredAccess
01408                                    );
01409 
01410     ZwClose(handle);
01411     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01412 
01413         <span class="comment">//</span>
01414         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
01415         <span class="comment">//</span>
01416 
01417         <span class="keywordflow">return</span> status;
01418     }
01419 
01420     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceEnumHandle) || CreateEnum) {
01421 
01422         <span class="comment">//</span>
01423         <span class="comment">// Open registry ServiceKeyName\Enum branch if caller wants</span>
01424         <span class="comment">// the handle or wants to create it.</span>
01425         <span class="comment">//</span>
01426 
01427         PiWstrToUnicodeString(&amp;enumName, REGSTR_KEY_ENUM);
01428 
01429         <span class="keywordflow">if</span> (CreateEnum) {
01430             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;enumHandle,
01431                                              serviceHandle,
01432                                              &amp;enumName,
01433                                              DesiredAccess,
01434                                              REG_OPTION_VOLATILE,
01435                                              NULL
01436                                              );
01437         } <span class="keywordflow">else</span> {
01438             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumHandle,
01439                                            serviceHandle,
01440                                            &amp;enumName,
01441                                            DesiredAccess
01442                                            );
01443 
01444         }
01445 
01446         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01447 
01448             <span class="comment">//</span>
01449             <span class="comment">// There is no registry key for the ServiceKeyName\Enum information.</span>
01450             <span class="comment">//</span>
01451 
01452             ZwClose(serviceHandle);
01453             <span class="keywordflow">return</span> status;
01454         }
01455         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceEnumHandle)) {
01456             *ServiceEnumHandle = enumHandle;
01457         } <span class="keywordflow">else</span> {
01458             ZwClose(enumHandle);
01459         }
01460     }
01461 
01462     <span class="comment">//</span>
01463     <span class="comment">// if caller wants to have the ServiceKey handle, we return it.  Otherwise</span>
01464     <span class="comment">// we close it.</span>
01465     <span class="comment">//</span>
01466 
01467     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceHandle)) {
01468         *ServiceHandle = serviceHandle;
01469     } <span class="keywordflow">else</span> {
01470         ZwClose(serviceHandle);
01471     }
01472 
01473     <span class="keywordflow">return</span> STATUS_SUCCESS;
01474 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a385" doxytag="pnpiop.h::IopOrphanNotification" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopOrphanNotification           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d6/devnode_8c-source.html#l00494">IopRemoveTreeDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a280" doxytag="pnpiop.h::IopPnPAddDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopPnPAddDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00419">419</a> of file <a class="el" href="../../d3/d9/pnpdd_8c-source.html">pnpdd.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00636">IopPnPDriverEntry()</a>.
<p>
<pre class="fragment"><div>00426                    :
00427 
00428     This routine handles AddDevice <span class="keywordflow">for</span> an madeup PDO device.
00429 
00430 Arguments:
00431 
00432     DriverObject - Pointer to our pseudo driver object.
00433 
00434     DeviceObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <span class="keywordflow">for</span> which <span class="keyword">this</span> requestapplies.
00435 
00436 Return Value:
00437 
00438     NT status.
00439 
00440 --*/
00441 {
00442     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00443 
00444 <span class="preprocessor">#if DBG</span>
00445 <span class="preprocessor"></span>
00446     <span class="comment">//</span>
00447     <span class="comment">// We should never get an AddDevice request.</span>
00448     <span class="comment">//</span>
00449 
00450     DbgBreakPoint();
00451 
00452 <span class="preprocessor">#endif</span>
00453 <span class="preprocessor"></span>
00454     <span class="keywordflow">return</span> STATUS_SUCCESS;
00455 }
<span class="comment">//  PNPRES test</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a282" doxytag="pnpiop.h::IopPnPDispatch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopPnPDispatch           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">648</a> of file <a class="el" href="../../d3/d9/pnpdd_8c-source.html">pnpdd.c</a>.
<p>
References <a class="el" href="../../d9/d7/arbiter_8c-source.html#l01414">ArbArbiterHandler()</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00840">_ARBITER_INTERFACE::ArbiterHandler</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00096">_PNP_BUS_INFORMATION::BusNumber</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a424">BusQueryInstanceID</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00094">_PNP_BUS_INFORMATION::BusTypeGuid</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00929">_IOPNP_DEVICE_EXTENSION::CompatibleIdList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00930">_IOPNP_DEVICE_EXTENSION::CompatibleIdListSize</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00833">_ARBITER_INTERFACE::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01927">_DEVICE_RELATIONS::Count</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01977">_DEVICE_CAPABILITIES::DeviceState</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01968">_DEVICE_CAPABILITIES::HardwareDisabled</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02070">IopCompareGuid</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03967">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00680">IopGetRootDevices()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l02009">IopIsFirmwareDisabled()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01009">IopPnPCompleteRequest()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00208">IopRootBusNumberArbiter</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00206">IopRootDmaArbiter</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00207">IopRootIrqArbiter</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00205">IopRootMemArbiter</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00204">IopRootPortArbiter</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00511">IopTranslatorHandlerCm()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00540">IopTranslatorHandlerIo()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00163">IRP_MN_CANCEL_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00166">IRP_MN_CANCEL_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00183">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00182">IRP_MN_QUERY_BUS_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00170">IRP_MN_QUERY_CAPABILITIES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00168">IRP_MN_QUERY_DEVICE_RELATIONS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00180">IRP_MN_QUERY_ID</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00169">IRP_MN_QUERY_INTERFACE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00161">IRP_MN_QUERY_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00172">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00171">IRP_MN_QUERY_RESOURCES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00165">IRP_MN_QUERY_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00160">IRP_MN_START_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00164">IRP_MN_STOP_DEVICE</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00095">_PNP_BUS_INFORMATION::LegacyBusType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01928">_DEVICE_RELATIONS::Objects</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a137">PIOPNP_DEVICE_EXTENSION</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00740">QUERY_RESOURCE_LIST</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00741">QUERY_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00747">REGISTRY_BASIC_CONFIGVECTOR</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00745">REGISTRY_BOOT_CONFIG</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01952">_DEVICE_CAPABILITIES::Size</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00895">_TRANSLATOR_INTERFACE::TranslateResourceRequirements</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00894">_TRANSLATOR_INTERFACE::TranslateResources</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01953">_DEVICE_CAPABILITIES::Version</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00636">IopPnPDriverEntry()</a>.
<p>
<pre class="fragment"><div>00655                    :
00656 
00657     This routine handles all <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a> IRPs <span class="keywordflow">for</span> madeup PDO device.
00658 
00659 Arguments:
00660 
00661     DeviceObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <span class="keywordflow">for</span> which <span class="keyword">this</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> applies.
00662 
00663     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> to dispatch.
00664 
00665 Return Value:
00666 
00667     NT status.
00668 
00669 --*/
00670 {
00671     <a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">PIOPNP_DEVICE_EXTENSION</a> deviceExtension = DeviceObject-&gt;DeviceExtension;
00672     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00673     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00674     PVOID information = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00675     ULONG length;
00676     PWCHAR <span class="keywordtype">id</span>, wp;
00677     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00678     <a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html">PARBITER_INTERFACE</a> arbiterInterface;  <span class="comment">// PNPRES test</span>
00679     <a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">PTRANSLATOR_INTERFACE</a> translatorInterface;  <span class="comment">// PNPRES test</span>
00680 
00681     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00682 
00683     <span class="comment">//</span>
00684     <span class="comment">// Get a pointer to our stack location and take appropriate action based</span>
00685     <span class="comment">// on the minor function.</span>
00686     <span class="comment">//</span>
00687 
00688     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>(Irp);
00689     <span class="keywordflow">switch</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>){
00690 
00691     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a86">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>:
00692     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a65">IRP_MN_START_DEVICE</a>:
00693 
00694         <span class="comment">//</span>
00695         <span class="comment">// If we get a start device request for a PDO, we simply</span>
00696         <span class="comment">// return success.</span>
00697         <span class="comment">//</span>
00698 
00699         status = STATUS_SUCCESS;
00700         <span class="keywordflow">break</span>;
00701 
00702     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a71">IRP_MN_CANCEL_STOP_DEVICE</a>:
00703 
00704         <span class="comment">//</span>
00705         <span class="comment">// As we fail all STOP's, this cancel is always successful, and we have</span>
00706         <span class="comment">// no work to do.</span>
00707         <span class="comment">//</span>
00708         status = STATUS_SUCCESS;
00709         <span class="keywordflow">break</span>;
00710 
00711     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a70">IRP_MN_QUERY_STOP_DEVICE</a>:
00712     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a69">IRP_MN_STOP_DEVICE</a>:
00713 
00714         <span class="comment">//</span>
00715         <span class="comment">// We can not success the query stop.  We don't handle it.  because</span>
00716         <span class="comment">// we don't know how to stop a root enumerated device.</span>
00717         <span class="comment">//</span>
00718         status = STATUS_UNSUCCESSFUL ;
00719         <span class="keywordflow">break</span>;
00720 
00721     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a75">IRP_MN_QUERY_RESOURCES</a>:
00722 
00723         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a>(
00724                          DeviceObject,
00725                          QUERY_RESOURCE_LIST,
00726                          REGISTRY_BOOT_CONFIG,
00727                          &amp;information,
00728                          &amp;length);
00729         <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
00730             status = STATUS_SUCCESS;
00731             information = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00732         }
00733         <span class="keywordflow">break</span>;
00734 
00735     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a76">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>:
00736 
00737         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a>(
00738                          DeviceObject,
00739                          QUERY_RESOURCE_REQUIREMENTS,
00740                          REGISTRY_BASIC_CONFIGVECTOR,
00741                          &amp;information,
00742                          &amp;length);
00743         <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
00744             status = STATUS_SUCCESS;
00745             information = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00746         }
00747         <span class="keywordflow">break</span>;
00748 
00749     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>:
00750     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>:
00751     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>:
00752 
00753         <span class="comment">//</span>
00754         <span class="comment">// For root enumerated devices we let the device objects stays.</span>
00755         <span class="comment">// So, they will be marked as deleted but still show up in the tree.</span>
00756         <span class="comment">//</span>
00757 
00758         <span class="comment">//IoDeleteDevice(DeviceObject);</span>
00759         status = STATUS_SUCCESS;
00760         <span class="keywordflow">break</span>;
00761 
00762     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a>:
00763 
00764         <span class="keywordflow">if</span> (DeviceObject == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a> &amp;&amp;
00765             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceRelations.Type == <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>) {
00766             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a311">IopGetRootDevices</a>((<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> *)&amp;information);
00767         } <span class="keywordflow">else</span> {
00768             <span class="keywordflow">if</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceRelations.Type == <a class="code" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>) {
00769                 <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> deviceRelations;
00770 
00771                 deviceRelations = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">DEVICE_RELATIONS</a>));
00772                 <span class="keywordflow">if</span> (deviceRelations == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00773                     status = STATUS_INSUFFICIENT_RESOURCES;
00774                 } <span class="keywordflow">else</span> {
00775                     deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o0">Count</a> = 1;
00776                     deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o1">Objects</a>[0] = DeviceObject;
00777                     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(DeviceObject);
00778                     information = (PVOID)deviceRelations;
00779                     status = STATUS_SUCCESS;
00780                 }
00781             } <span class="keywordflow">else</span> {
00782                 information = (PVOID)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
00783                 status = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00784             }
00785         }
00786         <span class="keywordflow">break</span>;
00787 
00788     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a73">IRP_MN_QUERY_INTERFACE</a>:
00789         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00790         <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
00791             <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>((PVOID)irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceType, (PVOID)&amp;GUID_ARBITER_INTERFACE_STANDARD)) {
00792                 status = STATUS_SUCCESS;
00793                 arbiterInterface = (<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html">PARBITER_INTERFACE</a>) irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Interface;
00794                 arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o5">ArbiterHandler</a> = <a class="code" href="../../d8/d8/arbiter_8c.html#a31">ArbArbiterHandler</a>;
00795                 <span class="keywordflow">switch</span> ((UCHAR)((ULONG_PTR)irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceSpecificData)) {
00796                 <span class="keywordflow">case</span> CmResourceTypePort:
00797                     arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a> = (PVOID) &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>;
00798                     <span class="keywordflow">break</span>;
00799                 <span class="keywordflow">case</span> CmResourceTypeMemory:
00800                     arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a> = (PVOID) &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>;
00801                     <span class="keywordflow">break</span>;
00802                 <span class="keywordflow">case</span> CmResourceTypeInterrupt:
00803                     arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a> = (PVOID) &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a33">IopRootIrqArbiter</a>;
00804                     <span class="keywordflow">break</span>;
00805                 <span class="keywordflow">case</span> CmResourceTypeDma:
00806                     arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a> = (PVOID) &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a32">IopRootDmaArbiter</a>;
00807                     <span class="keywordflow">break</span>;
00808                 <span class="keywordflow">case</span> CmResourceTypeBusNumber:
00809                     arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a> = (PVOID) &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a34">IopRootBusNumberArbiter</a>;
00810                     <span class="keywordflow">break</span>;
00811                 <span class="keywordflow">default</span>:
00812                     status = STATUS_INVALID_PARAMETER;
00813                     <span class="keywordflow">break</span>;
00814                 }
00815             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>((PVOID)irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceType, (PVOID)&amp;GUID_TRANSLATOR_INTERFACE_STANDARD)) {
00816                 translatorInterface = (<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">PTRANSLATOR_INTERFACE</a>) irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Interface;
00817                 translatorInterface-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o5">TranslateResources</a> = <a class="code" href="../../d2/d0/pnpdd_8c.html#a14">IopTranslatorHandlerCm</a>;
00818                 translatorInterface-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o6">TranslateResourceRequirements</a> = <a class="code" href="../../d2/d0/pnpdd_8c.html#a15">IopTranslatorHandlerIo</a>;
00819                 status = STATUS_SUCCESS;
00820             }
00821             <span class="keywordflow">break</span>;
00822         }
00823 
00824         status = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00825         <span class="keywordflow">break</span>;
00826 
00827     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a74">IRP_MN_QUERY_CAPABILITIES</a>:
00828 
00829         {
00830             ULONG i;
00831             PDEVICE_POWER_STATE state;
00832             <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a> deviceCapabilities;
00833 
00834             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00835 
00836             deviceCapabilities = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceCapabilities.Capabilities;
00837             deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o0">Size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>);
00838             deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o1">Version</a> = 1;
00839 
00840             deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o23">DeviceState</a>[PowerSystemUnspecified]=PowerDeviceUnspecified;
00841             deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o23">DeviceState</a>[PowerSystemWorking]=PowerDeviceD0;
00842 
00843             state = &amp;deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o23">DeviceState</a>[PowerSystemSleeping1];
00844 
00845             <span class="keywordflow">for</span> (i = PowerSystemSleeping1; i &lt; PowerSystemMaximum; i++) {
00846 
00847                 <span class="comment">//</span>
00848                 <span class="comment">// Only supported state, currently, is off.</span>
00849                 <span class="comment">//</span>
00850 
00851                 *state++ = PowerDeviceD3;
00852             }
00853 
00854 
00855             <span class="keywordflow">if</span>(<a class="code" href="../../d2/d0/pnpdd_8c.html#a9">IopIsFirmwareDisabled</a>(deviceNode)) {
00856                 <span class="comment">//</span>
00857                 <span class="comment">// this device has been disabled by BIOS</span>
00858                 <span class="comment">//</span>
00859                 deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o16">HardwareDisabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00860             }
00861 
00862             status = STATUS_SUCCESS;
00863         }
00864         <span class="keywordflow">break</span>;
00865 
00866     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a83">IRP_MN_QUERY_ID</a>:
00867         <span class="keywordflow">if</span> (DeviceObject != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a> &amp;&amp;
00868             (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status) || !<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information)) {
00869 
00870             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00871             <span class="keywordflow">switch</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryId.IdType) {
00872 
00873             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a424">BusQueryInstanceID</a>:
00874             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>:
00875 
00876                 <span class="keywordtype">id</span> = (PWCHAR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Length);
00877                 <span class="keywordflow">if</span> (<span class="keywordtype">id</span>) {
00878                     ULONG separatorCount = 0;
00879 
00880                     RtlZeroMemory(<span class="keywordtype">id</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Length);
00881                     information = <span class="keywordtype">id</span>;
00882                     status = STATUS_SUCCESS;
00883                     wp = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer;
00884                     <span class="keywordflow">if</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryId.IdType == <a class="code" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>) {
00885                         <span class="keywordflow">while</span>(*wp) {
00886                             <span class="keywordflow">if</span> (*wp == OBJ_NAME_PATH_SEPARATOR) {
00887                                 separatorCount++;
00888                                 <span class="keywordflow">if</span> (separatorCount == 2) {
00889                                     <span class="keywordflow">break</span>;
00890                                 }
00891                             }
00892                             *<span class="keywordtype">id</span> = *wp;
00893                             <span class="keywordtype">id</span>++;
00894                             wp++;
00895                         }
00896                     } <span class="keywordflow">else</span> {
00897                         <span class="keywordflow">while</span>(*wp) {
00898                             <span class="keywordflow">if</span> (*wp == OBJ_NAME_PATH_SEPARATOR) {
00899                                 separatorCount++;
00900                                 <span class="keywordflow">if</span> (separatorCount == 2) {
00901                                     wp++;
00902                                     <span class="keywordflow">break</span>;
00903                                 }
00904                             }
00905                             wp++;
00906                         }
00907                         <span class="keywordflow">while</span> (*wp) {
00908                             *<span class="keywordtype">id</span> = *wp;
00909                             <span class="keywordtype">id</span>++;
00910                             wp++;
00911                         }
00912                     }
00913                 } <span class="keywordflow">else</span> {
00914                     status = STATUS_INSUFFICIENT_RESOURCES;
00915                 }
00916                 <span class="keywordflow">break</span>;
00917 
00918             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>:
00919 
00920                 <span class="keywordflow">if</span>((<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status != STATUS_NOT_SUPPORTED) ||
00921                    (deviceExtension == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))  {
00922 
00923                     <span class="comment">//</span>
00924                     <span class="comment">// Upper driver has given some sort of reply or this device</span>
00925                     <span class="comment">// object wasn't allocated to handle these requests.</span>
00926                     <span class="comment">//</span>
00927 
00928                     status = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00929                     <span class="keywordflow">break</span>;
00930                 }
00931 
00932                 <span class="keywordflow">if</span>(deviceExtension-&gt;<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html#o1">CompatibleIdListSize</a> != 0) {
00933 
00934                     <span class="keywordtype">id</span> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
00935                                         deviceExtension-&gt;<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html#o1">CompatibleIdListSize</a>);
00936 
00937                     <span class="keywordflow">if</span>(<span class="keywordtype">id</span> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00938                         status = STATUS_INSUFFICIENT_RESOURCES;
00939                         <span class="keywordflow">break</span>;
00940                     }
00941 
00942                     RtlCopyMemory(<span class="keywordtype">id</span>,
00943                                   deviceExtension-&gt;<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html#o0">CompatibleIdList</a>,
00944                                   deviceExtension-&gt;<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html#o1">CompatibleIdListSize</a>);
00945 
00946                     information = <span class="keywordtype">id</span>;
00947                     status = STATUS_SUCCESS;
00948                     <span class="keywordflow">break</span>;
00949                 }
00950 
00951             <span class="keywordflow">default</span>:
00952 
00953                 information = (PVOID)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
00954                 status = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00955             }
00956         } <span class="keywordflow">else</span> {
00957             information = (PVOID)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
00958             status = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00959         }
00960 
00961         <span class="keywordflow">break</span>;
00962 <span class="preprocessor">#if 0</span>
00963 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a85">IRP_MN_QUERY_BUS_INFORMATION</a>:
00964         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00965         <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
00966             <a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html">PPNP_BUS_INFORMATION</a> busInfo;
00967 
00968             busInfo = (<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html">PPNP_BUS_INFORMATION</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html">PNP_BUS_INFORMATION</a>));
00969             <span class="keywordflow">if</span> (busInfo) {
00970                 busInfo-&gt;<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html#o1">LegacyBusType</a> = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
00971                 busInfo-&gt;<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html#o2">BusNumber</a> = 0;
00972                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a> == Isa) {
00973                     busInfo-&gt;<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html#o0">BusTypeGuid</a> = GUID_BUS_TYPE_ISAPNP; <span class="comment">// BUGBUG</span>
00974                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a> == Eisa) {
00975                     busInfo-&gt;<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html#o0">BusTypeGuid</a> = GUID_BUS_TYPE_EISA;
00976                 } <span class="keywordflow">else</span> { <span class="comment">// Microchannel</span>
00977                     busInfo-&gt;<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html#o0">BusTypeGuid</a> = GUID_BUS_TYPE_MCA;
00978                 }
00979                 information = busInfo;
00980                 status = STATUS_SUCCESS;
00981             } <span class="keywordflow">else</span> {
00982                 status = STATUS_INSUFFICIENT_RESOURCES;
00983                 information = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00984             }
00985             <span class="keywordflow">break</span>;
00986         }
00987 <span class="preprocessor">#endif</span>
00988 <span class="preprocessor"></span>
00989         <span class="comment">//</span>
00990         <span class="comment">// Otherwise, let it fall through the default path.</span>
00991         <span class="comment">//</span>
00992 
00993     <span class="keywordflow">default</span>:
00994 
00995         information = (PVOID)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
00996         status = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00997         <span class="keywordflow">break</span>;
00998     }
00999 
01000     <span class="comment">//</span>
01001     <span class="comment">// Complete the Irp and return.</span>
01002     <span class="comment">//</span>
01003 
01004     <a class="code" href="../../d2/d0/pnpdd_8c.html#a5">IopPnPCompleteRequest</a>(Irp, status, (ULONG_PTR)information);
01005     <span class="keywordflow">return</span> status;
01006 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a365" doxytag="pnpiop.h::IopPortInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopPortInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00349">349</a> of file <a class="el" href="../../d4/d0/pnpmemio_8c-source.html">pnpmemio.c</a>.
<p>
References <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00549">_ARBITER_INSTANCE::AddAllocation</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l00192">ArbInitializeArbiterInstance()</a>, <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00550">_ARBITER_INSTANCE::BacktrackAllocation</a>, <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00548">_ARBITER_INSTANCE::FindSuitableRange</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00630">IopGenericPackResource()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00542">IopGenericScoreRequirement()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00263">IopGenericTranslateOrdering()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00463">IopGenericUnpackRequirement()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00682">IopGenericUnpackResource()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l01146">IopPortAddAllocation()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00890">IopPortBacktrackAllocation()</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00959">IopPortFindSuitableRange()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00204">IopRootPortArbiter</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00525">_ARBITER_INSTANCE::PackResource</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00527">_ARBITER_INSTANCE::ScoreRequirement</a>, <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00524">_ARBITER_INSTANCE::UnpackRequirement</a>, and <a class="el" href="../../d0/d8/arbiter_8h-source.html#l00526">_ARBITER_INSTANCE::UnpackResource</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.
<p>
<pre class="fragment"><div>00355                    :
00356 
00357     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arbiter
00358 
00359 Parameters:
00360 
00361     None
00362 
00363 Return Value:
00364 
00365     None
00366 
00367 --*/
00368 
00369 {
00370     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// Fill in the non-default action handlers</span>
00374     <span class="comment">//</span>
00375 
00376     <a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o28">FindSuitableRange</a>    = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a14">IopPortFindSuitableRange</a>;
00377     <a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o29">AddAllocation</a>        = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a22">IopPortAddAllocation</a>;
00378     <a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o30">BacktrackAllocation</a>  = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a12">IopPortBacktrackAllocation</a>;
00379 
00380     <a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o12">UnpackRequirement</a>    = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a16">IopGenericUnpackRequirement</a>;
00381     <a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o13">PackResource</a>         = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a17">IopGenericPackResource</a>;
00382     <a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o14">UnpackResource</a>       = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a19">IopGenericUnpackResource</a>;
00383     <a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o15">ScoreRequirement</a>     = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a18">IopGenericScoreRequirement</a>;
00384 
00385     <span class="keywordflow">return</span> <a class="code" href="../../d9/d8/arbiter_8h.html#a67">ArbInitializeArbiterInstance</a>(&amp;IopRootPortArbiter,
00386                                         NULL,     <span class="comment">// Indicates ROOT arbiter</span>
00387                                         CmResourceTypePort,
00388                                         L<span class="stringliteral">"RootPort"</span>,
00389                                         L<span class="stringliteral">"Root"</span>,
00390                                         IopGenericTranslateOrdering
00391                                         );
00392 
00393 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a283" doxytag="pnpiop.h::IopPowerDispatch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopPowerDispatch           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00570">570</a> of file <a class="el" href="../../d3/d9/pnpdd_8c-source.html">pnpdd.c</a>.
<p>
References <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00193">IRP_MN_POWER_SEQUENCE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00195">IRP_MN_QUERY_POWER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00194">IRP_MN_SET_POWER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00192">IRP_MN_WAIT_WAKE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d1/po_8h-source.html#l00461">PoPowerSequence</a>, <a class="el" href="../../d1/d2/po_8h.html#a79">PoStartNextPowerIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01986">_POWER_SEQUENCE::SequenceD1</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01987">_POWER_SEQUENCE::SequenceD2</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01988">_POWER_SEQUENCE::SequenceD3</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00636">IopPnPDriverEntry()</a>.
<p>
<pre class="fragment"><div>00574 {
00575     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>      IrpSp;
00576     <a class="code" href="../../d4/d9/struct__POWER__SEQUENCE.html">PPOWER_SEQUENCE</a>         PowerSequence;
00577     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00578 
00579 
00580     UNREFERENCED_PARAMETER( DeviceObject );
00581 
00582     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a> (Irp);
00583     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00584 
00585     <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>) {
00586         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a89">IRP_MN_WAIT_WAKE</a>:
00587             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_SUPPORTED;
00588             <span class="keywordflow">break</span>;
00589 
00590         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a90">IRP_MN_POWER_SEQUENCE</a>:
00591             PowerSequence = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.PowerSequence.PowerSequence;
00592             PowerSequence-&gt;<a class="code" href="../../d4/d9/struct__POWER__SEQUENCE.html#o0">SequenceD1</a> = <a class="code" href="../../d1/d2/po_8h.html#a52">PoPowerSequence</a>;
00593             PowerSequence-&gt;<a class="code" href="../../d4/d9/struct__POWER__SEQUENCE.html#o1">SequenceD2</a> = <a class="code" href="../../d1/d2/po_8h.html#a52">PoPowerSequence</a>;
00594             PowerSequence-&gt;<a class="code" href="../../d4/d9/struct__POWER__SEQUENCE.html#o2">SequenceD3</a> = <a class="code" href="../../d1/d2/po_8h.html#a52">PoPowerSequence</a>;
00595             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00596             <span class="keywordflow">break</span>;
00597 
00598         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a92">IRP_MN_QUERY_POWER</a>:
00599             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00600             <span class="keywordflow">break</span>;
00601 
00602         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a91">IRP_MN_SET_POWER</a>:
00603             <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Power.Type) {
00604                 <span class="keywordflow">case</span> SystemPowerState:
00605                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00606                     <span class="keywordflow">break</span>;
00607 
00608                 <span class="keywordflow">case</span> DevicePowerState:
00609                     <span class="comment">//</span>
00610                     <span class="comment">// To be here the FDO must have passed the IRP on.</span>
00611                     <span class="comment">// We do not know how to turn the device off, but the</span>
00612                     <span class="comment">// FDO is prepaired for it work</span>
00613                     <span class="comment">//</span>
00614 
00615                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00616                     <span class="keywordflow">break</span>;
00617 
00618                 <span class="keywordflow">default</span>:
00619                     <span class="comment">// Unkown power type</span>
00620                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_SUPPORTED;
00621                     <span class="keywordflow">break</span>;
00622             }
00623             <span class="keywordflow">break</span>;
00624 
00625         <span class="keywordflow">default</span>:
00626             <span class="comment">// Unkown power minor code</span>
00627             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_SUPPORTED;
00628             <span class="keywordflow">break</span>;
00629     }
00630 
00631 
00632     <span class="comment">//</span>
00633     <span class="comment">// For lagecy devices that do not have drivers loaded, complete</span>
00634     <span class="comment">// power irps with success.</span>
00635     <span class="comment">//</span>
00636 
00637     <a class="code" href="../../d1/d2/po_8h.html#a79">PoStartNextPowerIrp</a>(Irp);
00638     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_NOT_SUPPORTED) {
00639        <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00640     } <span class="keywordflow">else</span> {
00641        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00642     }
00643     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( Irp, IO_NO_INCREMENT );
00644     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00645 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a228" doxytag="pnpiop.h::IopPrepareDriverLoading" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopPrepareDriverLoading           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIMAGE_NT_HEADERS&nbsp;</td>
          <td class="mdname" nowrap> <em>Header</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00753">753</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00087">IopCreateMadeupNode()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03071">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00116">PnPDetectionEnabled</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>00761                    :
00762 
00763     This routine first checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> loadable.  If its a
00764     PnP driver, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will always be loaded (we trust it to <span class="keywordflow">do</span> the right
00765     things.)  If it is a legacy driver, we need to check <span class="keywordflow">if</span> its device
00766     has been disabled.  Once we decide to load the driver, the Enum
00767     subkey of the service node will be checked <span class="keywordflow">for</span> duplicates, <span class="keywordflow">if</span> any.
00768 
00769 Parameters:
00770 
00771     KeyName - Supplies a pointer to the driver's service key unicode string
00772 
00773     KeyHandle - Supplies a handle to the driver service node in the registry
00774         that describes the driver to be loaded.
00775 
00776 Return Value:
00777 
00778     The function value is the <span class="keyword">final</span> status of the load operation.
00779 
00780 --*/
00781 
00782 {
00783     NTSTATUS status;
00784     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00785     ULONG tmp, count;
00786     HANDLE serviceEnumHandle = NULL, sysEnumXxxHandle, controlHandle;
00787     UNICODE_STRING unicodeKeyName, unicodeValueName;
00788     BOOLEAN IsPlugPlayDriver;
00789 
00790     status = STATUS_SUCCESS;
00791     IsPlugPlayDriver = (Header &amp;&amp;
00792                         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;OptionalHeader.DllCharacteristics &amp; IMAGE_DLLCHARACTERISTICS_WDM_DRIVER))? TRUE : FALSE;
00793 
00794     if (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">IopIsAnyDeviceInstanceEnabled</a>(KeyName, KeyHandle, (BOOLEAN)(IsPlugPlayDriver ? FALSE : TRUE))) {
00795 
00796         <span class="keywordflow">if</span> (IsPlugPlayDriver) {
00797 
00798             <span class="keywordflow">if</span> (!PnPDetectionEnabled) {
00799 
00800                 status = STATUS_PLUGPLAY_NO_DEVICE;
00801 
00802             }
00803 
00804         } <span class="keywordflow">else</span> {
00805 
00806             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00807             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
00808 
00809             <span class="comment">//</span>
00810             <span class="comment">// First open registry ServiceKeyName\Enum branch</span>
00811             <span class="comment">//</span>
00812 
00813             PiWstrToUnicodeString(&amp;unicodeKeyName, REGSTR_KEY_ENUM);
00814             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;serviceEnumHandle,
00815                                              KeyHandle,
00816                                              &amp;unicodeKeyName,
00817                                              KEY_ALL_ACCESS,
00818                                              REG_OPTION_VOLATILE,
00819                                              NULL
00820                                              );
00821             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00822 
00823                 <span class="comment">//</span>
00824                 <span class="comment">// Find out how many device instances listed in the ServiceName's</span>
00825                 <span class="comment">// Enum key.</span>
00826                 <span class="comment">//</span>
00827 
00828                 count = 0;
00829                 status = IopGetRegistryValue ( serviceEnumHandle,
00830                                                REGSTR_VALUE_COUNT,
00831                                                &amp;keyValueInformation);
00832                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00833 
00834                     <span class="keywordflow">if</span> (    keyValueInformation-&gt;Type == REG_DWORD &amp;&amp;
00835                             keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG)) {
00836 
00837                         count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
00838 
00839                     }
00840 
00841                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00842 
00843                 }
00844                 <span class="keywordflow">if</span> (    <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ||
00845                         status == STATUS_OBJECT_PATH_NOT_FOUND ||
00846                         status == STATUS_OBJECT_NAME_NOT_FOUND) {
00847 
00848                     <span class="keywordflow">if</span> (count) {
00849 
00850                         status = STATUS_PLUGPLAY_NO_DEVICE;
00851 
00852                     } <span class="keywordflow">else</span> {
00853 
00854                         <span class="comment">//</span>
00855                         <span class="comment">// If there is no Enum key or instance under Enum for the</span>
00856                         <span class="comment">// legacy driver we will create a madeup node for it.</span>
00857                         <span class="comment">//</span>
00858 
00859                         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a1">IopCreateMadeupNode</a>(   KeyName,
00860                                                         &amp;sysEnumXxxHandle,
00861                                                         &amp;unicodeKeyName,
00862                                                         &amp;tmp,
00863                                                         TRUE);
00864                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00865 
00866                             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00867 
00868                             <span class="comment">//</span>
00869                             <span class="comment">// Create and set Control\ActiveService value</span>
00870                             <span class="comment">//</span>
00871 
00872                             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
00873                             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;controlHandle,
00874                                                              sysEnumXxxHandle,
00875                                                              &amp;unicodeValueName,
00876                                                              KEY_ALL_ACCESS,
00877                                                              REG_OPTION_VOLATILE,
00878                                                              NULL
00879                                                              );
00880                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00881 
00882                                 PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VAL_ACTIVESERVICE);
00883                                 ZwSetValueKey(  controlHandle,
00884                                                 &amp;unicodeValueName,
00885                                                 TITLE_INDEX_VALUE,
00886                                                 REG_SZ,
00887                                                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Buffer,
00888                                                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
00889                                 ZwClose(controlHandle);
00890 
00891                             }
00892                             count++;
00893                             <span class="comment">//</span>
00894                             <span class="comment">// Don't forget to update the "Count=" and "NextInstance=" value entries</span>
00895                             <span class="comment">//</span>
00896 
00897                             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_COUNT);
00898                             ZwSetValueKey(  serviceEnumHandle,
00899                                             &amp;unicodeValueName,
00900                                             TITLE_INDEX_VALUE,
00901                                             REG_DWORD,
00902                                             &amp;count,
00903                                             <span class="keyword">sizeof</span>(count));
00904 
00905                             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_NEXT_INSTANCE);
00906                             ZwSetValueKey(  serviceEnumHandle,
00907                                             &amp;unicodeValueName,
00908                                             TITLE_INDEX_VALUE,
00909                                             REG_DWORD,
00910                                             &amp;count,
00911                                             <span class="keyword">sizeof</span>(count));
00912 
00913                             ZwClose(sysEnumXxxHandle);
00914                             status = STATUS_SUCCESS;
00915                         }
00916                     }
00917                 }
00918 
00919                 ZwClose(serviceEnumHandle);
00920             }
00921 
00922             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
00923             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00924         }
00925     }
00926 
00927     <span class="keywordflow">return</span> status;
00928 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a261" doxytag="pnpiop.h::IopProcessAddDevices" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> IopProcessAddDevices           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StartOrder</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverStartType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01053">1053</a> of file <a class="el" href="../../d3/d9/pnpdd_8c-source.html">pnpdd.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00678">_ADD_CONTEXT::DriverStartType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00676">_ADD_CONTEXT::GroupsToStart</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00677">_ADD_CONTEXT::GroupToStartNext</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01266">IopAcquireEnumerationLock</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01117">IopProcessAddDevicesWorker()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01276">IopReleaseEnumerationLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00671">NO_MORE_GROUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>.
<p>
<pre class="fragment"><div>01061                    :
01062 
01063     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by Pnp manager to load driver and perform AddDevice <span class="keywordflow">for</span>
01064     all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices under DeviceNode subtree.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used at boot time
01065     to process devices which were not processed during boot driver initialization.
01066 
01067     Note, caller must acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration mutex of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceNode before calling
01068     <span class="keyword">this</span> routine.
01069 
01070 Parameters:
01071 
01072     DeviceNode - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node whose subtree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be checked <span class="keywordflow">for</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a224">StartDevice</a>.
01073 
01074     StartOrder - The group orders to start.
01075 
01076 Return Value:
01077 
01078     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <span class="keywordflow">if</span> any <span class="keyword">new</span> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successfully added to its driver.
01079 
01080 --*/
01081 {
01082     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode, nextDeviceNode;
01083     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> returnValue = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
01084     <a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html">ADD_CONTEXT</a> context;
01085 
01086     context.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o0">GroupsToStart</a> = StartOrder;
01087     context.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
01088     context.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o2">DriverStartType</a> = DriverStartType;
01089 
01090     <span class="comment">//</span>
01091     <span class="comment">// Traverse the device node subtree to perform AddDevice call.</span>
01092     <span class="comment">//</span>
01093 
01094     <span class="keywordflow">if</span> (DeviceNode != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
01095         <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(DeviceNode);
01096     }
01097 
01098     deviceNode = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
01099     <span class="keywordflow">while</span> (deviceNode) {
01100 
01101         <span class="comment">//</span>
01102         <span class="comment">// We need to remember the 'next' device node.  If the deviceNode is a madeup device</span>
01103         <span class="comment">// it may be deleted while processing the IopProcessAddDeviceWorker.</span>
01104         <span class="comment">//</span>
01105 
01106         nextDeviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
01107         <a class="code" href="../../d2/d0/pnpdd_8c.html#a3">IopProcessAddDevicesWorker</a>(deviceNode, &amp;context);
01108         deviceNode = nextDeviceNode;
01109     }
01110     <span class="keywordflow">if</span> (DeviceNode != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
01111         <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(DeviceNode);
01112     }
01113     <span class="keywordflow">return</span> context.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a>;
01114 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a262" doxytag="pnpiop.h::IopProcessAssignResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopProcessAssignResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Reallocation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>BootConfigsOK</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">1185</a> of file <a class="el" href="../../d3/d9/pnpdd_8c-source.html">pnpdd.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00039">_DEVICE_LIST_CONTEXT::DeviceCount</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00041">_DEVICE_LIST_CONTEXT::DeviceList</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00447">DNF_ASSIGNING_RESOURCES</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00433">DNF_NO_RESOURCE_REQUIRED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00453">DNF_RESOURCE_ASSIGNED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00459">DNF_RESOURCE_REPORTED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a131">IOP_RESOURCE_REQUEST</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01266">IopAcquireEnumerationLock</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01824">IopAssignResourcesToDevices()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00074">IopDeviceTreeLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00098">IopNumberDeviceNodes</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01328">IopProcessAssignResourcesWorker()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01276">IopReleaseEnumerationLock</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d0/pnpdd_8c.html#a1">PDEVICE_LIST_CONTEXT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00765">_IOP_RESOURCE_REQUEST::PhysicalDevice</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00768">_IOP_RESOURCE_REQUEST::Priority</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00040">_DEVICE_LIST_CONTEXT::Reallocation</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00771">_IOP_RESOURCE_REQUEST::ResourceAssignment</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00161">_DEVICE_NODE::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00163">_DEVICE_NODE::ResourceListTranslated</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00773">_IOP_RESOURCE_REQUEST::Status</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00772">_IOP_RESOURCE_REQUEST::TranslatedResourceAssignment</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00728">IopBusCheck()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, and <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>.
<p>
<pre class="fragment"><div>01193                    :
01194 
01195     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by Pnp manager to allocate resources <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices
01196     which have been successfully added to their drivers and waiting to be started.
01197 
01198     Note, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller must acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration mutex before calling <span class="keyword">this</span> routine.
01199 
01200 Parameters:
01201 
01202     DeviceNode - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node whose subtree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be checked <span class="keywordflow">for</span> AssignRes.
01203 
01204     Reallocation - specifies <span class="keywordflow">if</span> we are assigning resources <span class="keywordflow">for</span> DNF_INSUFFICIENT_RESOURCES
01205                    devices.
01206 
01207     BootConfigsOK  - Indicates that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> OK to assign BOOT configs.
01208 
01209 Return Value:
01210 
01211     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <span class="keywordflow">if</span> more devices need resources.  This means we did not assign resources <span class="keywordflow">for</span> all
01212     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices.  caller must call <span class="keyword">this</span> routine again.
01213 
01214 --*/
01215 {
01216     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
01217     <a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html">PDEVICE_LIST_CONTEXT</a> context;
01218     BOOLEAN again = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01219     ULONG count, i;
01220     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> requestTable;
01221 
01222     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01223 
01224     <span class="comment">//</span>
01225     <span class="comment">// Allocate and init memory for resource context</span>
01226     <span class="comment">//</span>
01227 
01228     context = (<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html">PDEVICE_LIST_CONTEXT</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
01229                                     PagedPool,
01230                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html">DEVICE_LIST_CONTEXT</a>) +
01231                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) * IopNumberDeviceNodes
01232                                     );
01233     <span class="keywordflow">if</span> (!context) {
01234         <span class="keywordflow">return</span> again;
01235     }
01236     context-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o0">DeviceCount</a> = 0;
01237     context-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o1">Reallocation</a> = Reallocation;
01238 
01239     <span class="comment">//</span>
01240     <span class="comment">// Parse the device node subtree to determine which devices need resources</span>
01241     <span class="comment">//</span>
01242 
01243     <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(DeviceNode);
01244     deviceNode = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
01245 
01246     <span class="keywordflow">while</span> (deviceNode) {
01247         <a class="code" href="../../d2/d0/pnpdd_8c.html#a4">IopProcessAssignResourcesWorker</a>(deviceNode, context);
01248         deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
01249     }
01250     <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(DeviceNode);
01251     count = context-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o0">DeviceCount</a>;
01252     <span class="keywordflow">if</span> (count == 0) {
01253         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(context);
01254         <span class="keywordflow">return</span> again;
01255     }
01256 
01257     <span class="comment">//</span>
01258     <span class="comment">// Need to assign resources to devices.  Build the resource request table and call</span>
01259     <span class="comment">// resource assignment routine.</span>
01260     <span class="comment">//</span>
01261 
01262     requestTable = (<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
01263                                     PagedPool,
01264                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>) * count
01265                                     );
01266     <span class="keywordflow">if</span> (requestTable) {
01267 
01268         <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
01269             requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a> = 0;
01270             requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> = context-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o2">DeviceList</a>[i];
01271         }
01272 
01273         <span class="comment">//</span>
01274         <span class="comment">// Assign resources</span>
01275         <span class="comment">//</span>
01276 
01277         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;IopDeviceTreeLock, TRUE);
01278         <a class="code" href="../../d2/d0/pnpdd_8c.html#a22">IopAssignResourcesToDevices</a>(count, requestTable, BootConfigsOK);
01279 
01280         <span class="comment">//</span>
01281         <span class="comment">// Check the results</span>
01282         <span class="comment">//</span>
01283 
01284         <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
01285 
01286             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)
01287                           requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01288             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(requestTable[i].Status)) {
01289                 <span class="keywordflow">if</span> (requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>) {
01290                     <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>)) {
01291                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>;
01292                     }
01293                     <span class="comment">//deviceNode-&gt;Flags &amp;= ~DNF_INSUFFICIENT_RESOURCES;</span>
01294                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>;
01295                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a> = requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>;
01296                 } <span class="keywordflow">else</span> {
01297                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>;
01298                 }
01299             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_RETRY) {
01300                 again = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01301             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_DEVICE_CONFIGURATION_ERROR) {
01302                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_NO_SOFTCONFIG);
01303             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_PNP_BAD_MPS_TABLE) {
01304                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_BIOS_TABLE);
01305             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_PNP_TRANSLATION_FAILED) {
01306                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_TRANSLATION_FAILED);
01307             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_PNP_IRQ_TRANSLATION_FAILED) {
01308                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_IRQ_TRANSLATION_FAILED);
01309             } <span class="keywordflow">else</span> {
01310                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_NORMAL_CONFLICT);
01311             }
01312 
01313             <span class="comment">//</span>
01314             <span class="comment">// IopProcessAssignReourcesWork marks the device nodes as DNF_ASSIGNING_RESOURCES</span>
01315             <span class="comment">// We need to clear it to indicate the assigment is done.</span>
01316             <span class="comment">//</span>
01317 
01318             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
01319         }
01320         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;IopDeviceTreeLock);
01321         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(requestTable);
01322     }
01323     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(context);
01324     <span class="keywordflow">return</span> again;
01325 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a318" doxytag="pnpiop.h::IopProcessCompletedEject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopProcessCompletedEject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01417">1417</a> of file <a class="el" href="../../d4/d9/pnpdel_8c-source.html">pnpdel.c</a>.
<p>
References <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00087">_PENDING_RELATIONS_LIST_ENTRY::DeviceEvent</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00088">_PENDING_RELATIONS_LIST_ENTRY::DeviceObject</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00093">_PENDING_RELATIONS_LIST_ENTRY::DisplaySafeRemovalDialog</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00095">_PENDING_RELATIONS_LIST_ENTRY::DockInterface</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01293">IopAcquireDeviceTreeLock</a>, <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00709">IopFreeRelationList()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00739">IopHardwareProfileSetMarkedDocksEjected()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">IopInvalidateRelationsInList()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01294">IopReleaseDeviceTreeLock</a>, <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00422">IopWarmEjectDevice()</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00094">_PENDING_RELATIONS_LIST_ENTRY::LightestSleepState</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00085">_PENDING_RELATIONS_LIST_ENTRY::Link</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a159">PpSetDeviceRemovalSafe()</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00092">_PENDING_RELATIONS_LIST_ENTRY::ProfileChangingEject</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00089">_PENDING_RELATIONS_LIST_ENTRY::RelationsList</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00896">IopDeviceEjectComplete()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00730">IopEjectDevice()</a>.
<p>
<pre class="fragment"><div>01422                    :
01423 
01424     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called at passive level from a worker thread that was queued
01425     either when an eject <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> completed (see io\pnpirp.c - IopDeviceEjectComplete
01426     or io\pnpirp.c - IopEjectDevice), or when a warm eject needs to be performed.
01427     We also may need to fire off any enumerations of parents of ejected devices
01428     to verify they have indeed left.
01429 
01430 Arguments:
01431 
01432     Context - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pending relations list which contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
01433               to eject (warm) and the list of parents to reenumerate.
01434 
01435 Return Value:
01436 
01437     None.
01438 
01439 --*/
01440 {
01441     <a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a> entry = (<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a>)Context;
01442     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01443 
01444     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01445 
01446     <span class="keywordflow">if</span> ((entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o9">LightestSleepState</a> != PowerSystemWorking) &amp;&amp;
01447         (entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o9">LightestSleepState</a> != PowerSystemUnspecified)) {
01448 
01449         <span class="comment">//</span>
01450         <span class="comment">// For docks, WinLogon gets to do the honors. For other devices, the</span>
01451         <span class="comment">// user must infer when it's safe to remove the device (if we've powered</span>
01452         <span class="comment">// up, it may not be safe now!)</span>
01453         <span class="comment">//</span>
01454         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o8">DisplaySafeRemovalDialog</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01455 
01456         <span class="comment">//</span>
01457         <span class="comment">// This is a warm eject request, initiate it here.</span>
01458         <span class="comment">//</span>
01459         status = <a class="code" href="../../d4/d1/pnppower_8c.html#a4">IopWarmEjectDevice</a>(entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o3">DeviceObject</a>, entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o9">LightestSleepState</a>);
01460 
01461         <span class="comment">//</span>
01462         <span class="comment">// We're back and we either succeeded or failed. Either way...</span>
01463         <span class="comment">//</span>
01464     }
01465 
01466     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o10">DockInterface</a>) {
01467 
01468         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o10">DockInterface</a>-&gt;ProfileDepartureSetMode(
01469             entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o10">DockInterface</a>-&gt;Context,
01470             PDS_UPDATE_DEFAULT
01471             );
01472 
01473         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o10">DockInterface</a>-&gt;InterfaceDereference(
01474             entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o10">DockInterface</a>-&gt;Context
01475             );
01476     }
01477 
01478     <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
01479 
01480     RemoveEntryList( &amp;entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o0">Link</a> );
01481 
01482     <span class="comment">//</span>
01483     <span class="comment">// Check if the RelationsList pointer in the context structure is NULL.  If</span>
01484     <span class="comment">// so, this means we were cancelled because this eject is part of a new</span>
01485     <span class="comment">// larger eject.  In that case all we want to do is unlink and free the</span>
01486     <span class="comment">// context structure.</span>
01487     <span class="comment">//</span>
01488 
01489     <span class="comment">//</span>
01490     <span class="comment">// Two interesting points about such code.</span>
01491     <span class="comment">//</span>
01492     <span class="comment">// 1) If you wait forever to complete an eject of a dock, we *wait* forever</span>
01493     <span class="comment">//    in the Query profile change state. No sneaky adding another dock. You</span>
01494     <span class="comment">//    must finish what you started...</span>
01495     <span class="comment">// 2) Let's say you are ejecting a dock, and it is taking a long time. If</span>
01496     <span class="comment">//    you try to eject the parent, that eject will *not* grab this lower</span>
01497     <span class="comment">//    eject as we will block on the profile change semaphore. Again, finish</span>
01498     <span class="comment">//    what you started...</span>
01499     <span class="comment">//</span>
01500 
01501     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
01502 
01503         <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o7">ProfileChangingEject</a>) {
01504 
01505             <a class="code" href="../../d9/d0/pnpiop_8h.html#a384">IopHardwareProfileSetMarkedDocksEjected</a>();
01506         }
01507 
01508         <a class="code" href="../../d9/d0/pnpiop_8h.html#a315">IopInvalidateRelationsInList</a>( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a>, FALSE, FALSE, TRUE );
01509 
01510         <span class="comment">//</span>
01511         <span class="comment">// Free the relations list</span>
01512         <span class="comment">//</span>
01513 
01514         <a class="code" href="../../d7/d1/pnprlist_8h.html#a10">IopFreeRelationList</a>( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a> );
01515 
01516     } <span class="keywordflow">else</span> {
01517 
01518         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o8">DisplaySafeRemovalDialog</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01519     }
01520 
01521     <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
01522 
01523     <span class="comment">//</span>
01524     <span class="comment">// Complete the event</span>
01525     <span class="comment">//</span>
01526     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o2">DeviceEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01527 
01528         PpCompleteDeviceEvent( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o2">DeviceEvent</a>, status );
01529     }
01530 
01531     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o8">DisplaySafeRemovalDialog</a>) {
01532 
01533         <a class="code" href="../../d6/d9/pnp_8h.html#a159">PpSetDeviceRemovalSafe</a>(entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o3">DeviceObject</a>, NULL, NULL);
01534     }
01535 
01536     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( entry );
01537 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a281" doxytag="pnpiop.h::IopProcessCriticalDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopProcessCriticalDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a364" doxytag="pnpiop.h::IopProcessDeferredRegistrations" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopProcessDeferredRegistrations           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05954">5954</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02053">IopAcquireNotifyLock</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00199">IopDeferredRegistrationList</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00200">IopDeferredRegistrationLock</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06600">IopDereferenceNotify()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02061">IopReleaseNotifyLock</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02249">_NOTIFY_ENTRY_HEADER::Lock</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00197">_DEFERRED_REGISTRATION_ENTRY::NotifyEntry</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/pnpioapi_8c.html#a46">PDEFERRED_REGISTRATION_ENTRY</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02240">_NOTIFY_ENTRY_HEADER::Unregistered</a>.
<p>
<pre class="fragment"><div>05959                    :
05960 
05961     This routine removes notification entries from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> deferred registration
05962     list, marking them as <span class="stringliteral">"registered"</span> so that they can receive notifications.
05963 
05964 Parameters:
05965 
05966     None.
05967 
05968 Return Value:
05969 
05970     None.
05971 
05972   --*/
05973 {
05974     <a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html">PDEFERRED_REGISTRATION_ENTRY</a> deferredNode;
05975     <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> lock;
05976 
05977     <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;IopDeferredRegistrationLock);
05978 
05979     <span class="keywordflow">while</span> (!IsListEmpty(&amp;IopDeferredRegistrationList)) {
05980 
05981         deferredNode = (<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html">PDEFERRED_REGISTRATION_ENTRY</a>)RemoveHeadList(&amp;IopDeferredRegistrationList);
05982 
05983         <span class="comment">//</span>
05984         <span class="comment">// Acquire this entry's list lock.</span>
05985         <span class="comment">//</span>
05986         lock = deferredNode-&gt;<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o1">NotifyEntry</a>-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o7">Lock</a>;
05987         <span class="keywordflow">if</span> (lock) {
05988             <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(lock);
05989         }
05990 
05991         <span class="comment">//</span>
05992         <span class="comment">// Mark this entry as registered.</span>
05993         <span class="comment">//</span>
05994         deferredNode-&gt;<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o1">NotifyEntry</a>-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o6">Unregistered</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05995 
05996         <span class="comment">//</span>
05997         <span class="comment">// Dereference the notification entry when removing it from the deferred</span>
05998         <span class="comment">// list, and free the node.</span>
05999         <span class="comment">//</span>
06000         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)deferredNode-&gt;<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o1">NotifyEntry</a>);
06001         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deferredNode);
06002 
06003         <span class="comment">//</span>
06004         <span class="comment">// Release this entry's list lock.</span>
06005         <span class="comment">//</span>
06006         <span class="keywordflow">if</span> (lock) {
06007             <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(lock);
06008             lock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06009         }
06010     }
06011 
06012     <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;IopDeferredRegistrationLock);
06013 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a290" doxytag="pnpiop.h::IopProcessNewDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopProcessNewDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">1538</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a422">BusQueryHardwareIDs</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00052">DebugPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d5/io_8h.html#a605a426">DeviceTextDescription</a>, <a class="el" href="../../d0/d5/io_8h.html#a605a427">DeviceTextLocationInformation</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00390">DNF_PROCESSED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00440">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00595">DNUF_DONT_SHOW_IN_UI</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01959">_DEVICE_CAPABILITIES::DockDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01224">DOE_START_PENDING</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01968">_DEVICE_CAPABILITIES::HardwareDisabled</a>, <a class="el" href="../../d0/d5/io_8h.html#a373">IO_STACK_LOCATION</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00831">IopClearDevNodeProblem</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00695">IopConcatenateUnicodeStrings()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05524">IopDeviceCapabilitiesToRegistry()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a376">IopFixupDeviceId()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04559">IopFixupIds()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04425">IopGetBusTypeGuidIndex()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03332">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">IopIsDevNodeProblem</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l01903">IopIsRemoteBootCard()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00719">IopLoaderBlock</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01891">IopMakeGloballyUniqueId()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08162">IopNotifySetupDeviceArrival()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a281">IopProcessCriticalDevice()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02173">IopQueryCompatibleIds()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03694">IopQueryDeviceCapabilities()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01762">IopQueryDeviceId()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02885">IopQueryPnpBusInformation()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01820">IopQueryUniqueId()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l01982">IopSetupRemoteBootCard()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04577">IoRemoteBootClient</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00173">IRP_MN_QUERY_DEVICE_TEXT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00172">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01971">_DEVICE_CAPABILITIES::NoDisplayInUI</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00633">PNP_ERR_BOGUS_ID</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00631">PNP_ERR_DUPLICATE_PDO</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration()</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a162">PpSetPlugPlayEvent()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00584">PsDefaultSystemLocaleId</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00740">QUERY_RESOURCE_LIST</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01962">_DEVICE_CAPABILITIES::RawDeviceOK</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01960">_DEVICE_CAPABILITIES::UniqueID</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01488">IopProcessNewChildren()</a>.
<p>
<pre class="fragment"><div>01544                    :
01545 
01546     This function creates a device instance key <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.
01547     If LoadDriver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">true</span> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device driver <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> installed,
01548     <span class="keyword">this</span> routine will load <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to start enumerating its children.
01549 
01550 Arguments:
01551 
01552     DeviceNode - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node to be processed.
01553 
01554 Return Value:
01555 
01556     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01557 
01558 --*/
01559 
01560 {
01561     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01562     PWCHAR deviceId, busId, uniqueId, compatibleIds, <span class="keywordtype">id</span>, hwIds, deviceText, globallyUniqueId;
01563     HANDLE handle, enumHandle, busIdHandle, deviceIdHandle;
01564     HANDLE uniqueIdHandle, logConfHandle;
01565     UNICODE_STRING unicodeName, unicodeString, unicodeDeviceInstance;
01566     ULONG disposition, tmpValue, length, cmLength, ioLength, hwIdLength, compatibleIdLength;
01567     PCM_RESOURCE_LIST cmResource;
01568     PIO_RESOURCE_REQUIREMENTS_LIST ioResource;
01569     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01570     PWCHAR buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01571     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
01572     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
01573     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
01574     <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a> capabilities;
01575     PVOID <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01576     BOOLEAN globallyUnique = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01577     PWCHAR location = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, description = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01578     PKEY_VALUE_PARTIAL_INFORMATION keyValue;
01579     UCHAR CLSIDBuffer[FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + 128];
01580 
01581     BOOLEAN processCriticalDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01582     BOOLEAN isRemoteBootCard = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01583     BOOLEAN configuredBySetup;
01584     PWCHAR wp;
01585     GUID busTypeGuid;
01586 
01587     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01588 
01589     deviceObject = DeviceNode-&gt;PhysicalDeviceObject;
01590 
01591     <span class="comment">//</span>
01592     <span class="comment">// First open HKLM\System\CCS\Enum key.</span>
01593     <span class="comment">//</span>
01594 
01595     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumHandle,
01596                                    NULL,
01597                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
01598                                    KEY_ALL_ACCESS
01599                                    );
01600     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01601         KdPrint((<span class="stringliteral">"IopProcessNewDeviceNode: Unable to open HKLM\\SYSTEM\\CCS\\ENUM\n"</span>));
01602         <span class="keywordflow">return</span> status;
01603     }
01604 
01605     <span class="comment">//</span>
01606     <span class="comment">// First, get the device id and this will be the device key name</span>
01607     <span class="comment">//</span>
01608 
01609     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a23">IopQueryDeviceId</a>(deviceObject, &amp;<span class="keywordtype">id</span>);
01610 
01611     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || <span class="keywordtype">id</span> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01612         ZwClose(enumHandle);
01613         <span class="keywordflow">return</span> status;
01614     }
01615 
01616     <span class="comment">//</span>
01617     <span class="comment">// Fix up the id if necessary</span>
01618     <span class="comment">//</span>
01619     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a376">IopFixupDeviceId</a>(<span class="keywordtype">id</span>)) {
01620         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
01621                       PNP_ERR_BOGUS_ID,
01622                       (ULONG_PTR)deviceObject,
01623                       (ULONG_PTR)<span class="keywordtype">id</span>,
01624                       1);
01625 
01626 
01627     }
01628 
01629     <span class="comment">//</span>
01630     <span class="comment">// Extract  bus id out of the returned id</span>
01631     <span class="comment">//</span>
01632 
01633     <span class="keywordflow">for</span> (wp = <span class="keywordtype">id</span>; *wp != UNICODE_NULL; wp++) {
01634         <span class="keywordflow">if</span> (*wp == OBJ_NAME_PATH_SEPARATOR) {
01635             deviceId = wp + 1;
01636             busId = <span class="keywordtype">id</span>;
01637             <span class="keywordflow">break</span>;
01638         }
01639     }
01640 
01641     <span class="keywordflow">if</span> (*wp != OBJ_NAME_PATH_SEPARATOR) {
01642         ZwClose(enumHandle);
01643         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<span class="keywordtype">id</span>);
01644         KdPrint((<span class="stringliteral">"IopProcessNewDevice: Invalid device id return by driver (not in bus\\device format)\n"</span>));
01645         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01646     }
01647 
01648     *wp = UNICODE_NULL;
01649 
01650     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01651     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
01652 
01653     <span class="comment">//</span>
01654     <span class="comment">// Open/Create enumerator key under HKLM\CCS\System\Enum</span>
01655     <span class="comment">//</span>
01656 
01657     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, busId);
01658 
01659     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;busIdHandle,
01660                                      enumHandle,
01661                                      &amp;unicodeName,
01662                                      KEY_ALL_ACCESS,
01663                                      REG_OPTION_NON_VOLATILE,
01664                                      NULL
01665                                      );
01666 
01667     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01668         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<span class="keywordtype">id</span>);
01669         ZwClose(enumHandle);
01670         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01671     }
01672 
01673     <span class="comment">//</span>
01674     <span class="comment">// Open/create this registry path under HKLM\CCS\System\Enum&lt;Enumerator&gt;</span>
01675     <span class="comment">//</span>
01676 
01677     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, deviceId);
01678     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;deviceIdHandle,
01679                                      busIdHandle,
01680                                      &amp;unicodeName,
01681                                      KEY_ALL_ACCESS,
01682                                      REG_OPTION_NON_VOLATILE,
01683                                      NULL
01684                                      );
01685 
01686     ZwClose(busIdHandle);
01687     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01688         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<span class="keywordtype">id</span>);
01689         ZwClose(enumHandle);
01690         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01691     }
01692 
01693     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
01694     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01695 
01696     <span class="comment">//</span>
01697     <span class="comment">// Query the device's capabilities</span>
01698     <span class="comment">// we will add this stuff to registry once we've processed it a bit</span>
01699     <span class="comment">//</span>
01700 
01701     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a330">IopQueryDeviceCapabilities</a>(DeviceNode, &amp;capabilities);
01702 
01703     <span class="keywordflow">if</span> (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o19">NoDisplayInUI</a>) {
01704 
01705         DeviceNode-&gt;UserFlags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a38">DNUF_DONT_SHOW_IN_UI</a>;
01706     }
01707 
01708     <span class="comment">//</span>
01709     <span class="comment">// From the query capabilities call, determine if this a globally unique ID?</span>
01710     <span class="comment">//</span>
01711 
01712     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o8">UniqueID</a>)) {
01713         globallyUnique = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01714     }
01715 
01716     <span class="comment">//</span>
01717     <span class="comment">// Record, is this a dock?</span>
01718     <span class="comment">//</span>
01719     DeviceNode-&gt;DockInfo.DockStatus =
01720         capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o7">DockDevice</a> ? <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a> : <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>;
01721 
01722     <span class="comment">//</span>
01723     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
01724     <span class="comment">//</span>
01725 
01726     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
01727 
01728     <span class="comment">//</span>
01729     <span class="comment">// Query the device's description.</span>
01730     <span class="comment">//</span>
01731 
01732     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
01733     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a77">IRP_MN_QUERY_DEVICE_TEXT</a>;
01734     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceText.DeviceTextType = <a class="code" href="../../d0/d5/io_8h.html#a605a426">DeviceTextDescription</a>;
01735     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceText.LocaleId = <a class="code" href="../../d1/d9/ps_8h.html#a58">PsDefaultSystemLocaleId</a>;
01736     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(deviceObject, &amp;irpSp, &amp;description);
01737 
01738     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01739         description = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01740     }
01741 
01742     <span class="comment">//</span>
01743     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
01744     <span class="comment">//</span>
01745 
01746     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
01747 
01748     <span class="comment">//</span>
01749     <span class="comment">// Query the device's location information.</span>
01750     <span class="comment">//</span>
01751 
01752     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
01753     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a77">IRP_MN_QUERY_DEVICE_TEXT</a>;
01754     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceText.DeviceTextType = <a class="code" href="../../d0/d5/io_8h.html#a605a427">DeviceTextLocationInformation</a>;
01755     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceText.LocaleId = <a class="code" href="../../d1/d9/ps_8h.html#a58">PsDefaultSystemLocaleId</a>;
01756     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(deviceObject, &amp;irpSp, &amp;location);
01757 
01758     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01759         location = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01760     }
01761 
01762     <span class="comment">//</span>
01763     <span class="comment">// Query the unique id for the device</span>
01764     <span class="comment">//</span>
01765 
01766     <a class="code" href="../../d0/d1/pnpirp_8c.html#a24">IopQueryUniqueId</a>(deviceObject, &amp;uniqueId);
01767 
01768     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01769 
01770     <span class="keywordflow">if</span> (!globallyUnique &amp;&amp; deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a> != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
01771         globallyUniqueId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01772 
01773         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a25">IopMakeGloballyUniqueId</a>(deviceObject, uniqueId, &amp;globallyUniqueId);
01774 
01775         <span class="keywordflow">if</span> (uniqueId != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01776             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(uniqueId);
01777         }
01778 
01779         uniqueId = globallyUniqueId;
01780 
01781     } <span class="keywordflow">else</span> {
01782 
01783         status = STATUS_SUCCESS;
01784     }
01785 
01786     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || uniqueId == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01787         <span class="keywordflow">if</span> (description) {
01788             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(description);
01789         }
01790         <span class="keywordflow">if</span> (location) {
01791             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(location);
01792         }
01793         ZwClose(deviceIdHandle);
01794         ZwClose(enumHandle);
01795         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<span class="keywordtype">id</span>);
01796         <span class="keywordflow">return</span> status;
01797     }
01798 
01799     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01800     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
01801 
01802 RetryDuplicateId:
01803 
01804     <span class="comment">//</span>
01805     <span class="comment">// Fixup the unique instance id if necessary</span>
01806     <span class="comment">//</span>
01807     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a376">IopFixupDeviceId</a>(uniqueId)) {
01808         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
01809                       PNP_ERR_BOGUS_ID,
01810                       (ULONG_PTR)deviceObject,
01811                       (ULONG_PTR)uniqueId,
01812                       2);
01813     }
01814 
01815     length = (wcslen(busId) + wcslen(deviceId) + wcslen(uniqueId) + 5) * <span class="keyword">sizeof</span>(WCHAR);
01816     buffer = (PWCHAR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, length);
01817     <span class="keywordflow">if</span> (!buffer) {
01818 
01819         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
01820         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01821 
01822         <span class="keywordflow">if</span> (description) {
01823             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(description);
01824         }
01825         <span class="keywordflow">if</span> (location) {
01826             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(location);
01827         }
01828         ZwClose(deviceIdHandle);
01829         ZwClose(enumHandle);
01830         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<span class="keywordtype">id</span>);
01831         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01832     }
01833     swprintf(buffer, L<span class="stringliteral">"%s\\%s\\%s"</span>, busId, deviceId, uniqueId);
01834     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeDeviceInstance, buffer);
01835 
01836     <span class="keywordflow">if</span> (DeviceNode-&gt;InstancePath.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01837 
01838         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;InstancePath.Buffer);
01839         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;DeviceNode-&gt;InstancePath, NULL);
01840     }
01841 
01842     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;DeviceNode-&gt;InstancePath, &amp;unicodeDeviceInstance, NULL);
01843 
01844     <span class="comment">//</span>
01845     <span class="comment">// Open/create this registry device instance path under</span>
01846     <span class="comment">// HKLM\System\Enum&lt;Enumerator&gt;\deviceId</span>
01847     <span class="comment">//</span>
01848 
01849     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, uniqueId);
01850     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;uniqueIdHandle,
01851                                      deviceIdHandle,
01852                                      &amp;unicodeName,
01853                                      KEY_ALL_ACCESS,
01854                                      REG_OPTION_NON_VOLATILE,
01855                                      &amp;disposition
01856                                      );
01857 
01858     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01859         ZwClose(enumHandle);
01860         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<span class="keywordtype">id</span>);
01861         ZwClose(deviceIdHandle);
01862         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(uniqueId);
01863         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01864     }
01865 
01866     deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a142">DOE_START_PENDING</a>;
01867 
01868     DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a>;
01869 
01870     <span class="comment">//</span>
01871     <span class="comment">// Check if the device instance is already reported.  If yes fail this request.</span>
01872     <span class="comment">//</span>
01873 
01874     <span class="keywordflow">if</span> (disposition != REG_CREATED_NEW_KEY) {
01875 
01876         <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> dupCheckDeviceObject;
01877 
01878         <span class="comment">//</span>
01879         <span class="comment">// Retrieve the device node associated with this device instance name (if</span>
01880         <span class="comment">// there is one).  If it's different from the device node we're currently</span>
01881         <span class="comment">// working with, then we have a duplicate, and we want to remove it.</span>
01882         <span class="comment">//</span>
01883 
01884         dupCheckDeviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(uniqueIdHandle, NULL);
01885 
01886         <span class="keywordflow">if</span> (dupCheckDeviceObject) {
01887 
01888             <span class="comment">//</span>
01889             <span class="comment">// Go ahead and dereference the device object now--we only need the</span>
01890             <span class="comment">// value for comparison.</span>
01891             <span class="comment">//</span>
01892 
01893             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(dupCheckDeviceObject);
01894 
01895             <span class="keywordflow">if</span> (dupCheckDeviceObject != deviceObject) {
01896 
01897                 <span class="keywordflow">if</span> (globallyUnique) {
01898                     globallyUnique = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01899 
01900                     <a class="code" href="../../d0/d1/pnpirp_8c.html#a25">IopMakeGloballyUniqueId</a>(deviceObject, uniqueId, &amp;globallyUniqueId);
01901 
01902                     <span class="keywordflow">if</span> (uniqueId != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01903                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(uniqueId);
01904                     }
01905 
01906                     uniqueId = globallyUniqueId;
01907 
01908                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
01909                     buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01910                     ZwClose(uniqueIdHandle);
01911                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART);
01912                     <span class="keywordflow">goto</span> RetryDuplicateId;
01913                 }
01914 
01915                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
01916                               PNP_ERR_DUPLICATE_PDO,
01917                               (ULONG_PTR)deviceObject,
01918                               (ULONG_PTR)dupCheckDeviceObject,
01919                               0);
01920 
01921 <span class="preprocessor">#if 0</span>
01922 <span class="preprocessor"></span>                ZwClose(enumHandle);
01923                 ZwClose(uniqueIdHandle);
01924 
01925                 <span class="keywordflow">if</span> (DeviceNode-&gt;InstancePath.Length != 0) {
01926                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;InstancePath.Buffer);
01927                     DeviceNode-&gt;InstancePath.Length = 0;
01928                     DeviceNode-&gt;InstancePath.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01929                 }
01930 
01931                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(deviceObject, CM_PROB_DEVICE_NOT_THERE);
01932                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01933 <span class="preprocessor">#endif</span>
01934 <span class="preprocessor"></span>            }
01935         }
01936     } <span class="keywordflow">else</span> {
01937 
01938         <span class="keywordflow">if</span> (description) {
01939             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_DEVDESC);
01940             ZwSetValueKey(uniqueIdHandle,
01941                             &amp;unicodeName,
01942                             TITLE_INDEX_VALUE,
01943                             REG_SZ,
01944                             description,
01945                             (wcslen(description)+1) * <span class="keyword">sizeof</span>(WCHAR)
01946                             );
01947             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(description);
01948             description = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01949         }
01950     }
01951 
01952     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<span class="keywordtype">id</span>);
01953     ZwClose(deviceIdHandle);
01954     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(uniqueId);
01955 
01956     <span class="keywordflow">if</span> (location) {
01957         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_LOCATION_INFORMATION);
01958         ZwSetValueKey(uniqueIdHandle,
01959                       &amp;unicodeName,
01960                       TITLE_INDEX_VALUE,
01961                       REG_SZ,
01962                       location,
01963                       (wcslen(location)+1) * <span class="keyword">sizeof</span>(WCHAR)
01964                       );
01965         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(location);
01966         location = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01967     }
01968 
01969     <span class="comment">//</span>
01970     <span class="comment">// now add the capabilities and UI_NUMBER into registry</span>
01971     <span class="comment">//</span>
01972     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a35">IopDeviceCapabilitiesToRegistry</a>(DeviceNode, &amp;capabilities);
01973 
01974 <span class="preprocessor">#if DBG</span>
01975 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
01976 <span class="preprocessor">#endif</span>
01977 <span class="preprocessor"></span>
01978     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
01979     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;logConfHandle,
01980                                      uniqueIdHandle,
01981                                      &amp;unicodeName,
01982                                      KEY_ALL_ACCESS,
01983                                      REG_OPTION_NON_VOLATILE,
01984                                      NULL
01985                                      );
01986     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01987         logConfHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;          <span class="comment">// just to make sure</span>
01988     }
01989 
01990     <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {    <span class="comment">// disposition from uniqueId</span>
01991 
01992         <span class="comment">//</span>
01993         <span class="comment">// "new registry key" device installation case</span>
01994         <span class="comment">//</span>
01995         <span class="comment">// Set flags to control whether device installation needs to</span>
01996         <span class="comment">// happen later. This means setting the devnode flag to</span>
01997         <span class="comment">// DNF_NOT_CONFIGURED and setting the ConfigFlag ONLY if it's</span>
01998         <span class="comment">// raw.</span>
01999         <span class="comment">//</span>
02000 
02001         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART)) {
02002             <span class="keywordflow">if</span> (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o10">RawDeviceOK</a>) {
02003                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_CONFIG_FLAGS);
02004                 tmpValue = CONFIGFLAG_FINISH_INSTALL;
02005                 ZwSetValueKey(uniqueIdHandle,
02006                                 &amp;unicodeName,
02007                                 TITLE_INDEX_VALUE,
02008                                 REG_DWORD,
02009                                 &amp;tmpValue,
02010                                 <span class="keyword">sizeof</span>(tmpValue)
02011                                 );
02012             } <span class="keywordflow">else</span> {
02013                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED);
02014             }
02015 
02016             <span class="comment">//</span>
02017             <span class="comment">// Process this as a critical device node.  This will setup</span>
02018             <span class="comment">// the service, if necessary, so that the system can boot far</span>
02019             <span class="comment">// enough to get to the config manager</span>
02020             <span class="comment">//</span>
02021 
02022             processCriticalDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02023         }
02024 
02025     } <span class="keywordflow">else</span> {
02026 
02027         UCHAR buffer[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION)+<span class="keyword">sizeof</span>(ULONG)];
02028         PKEY_VALUE_PARTIAL_INFORMATION keyInfo =
02029             (PKEY_VALUE_PARTIAL_INFORMATION) buffer;
02030 
02031         ULONG length;
02032 
02033         UNICODE_STRING valueName;
02034 
02035         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> tmpStatus;
02036 
02037         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART)) {
02038 
02039             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, REGSTR_VALUE_CONFIG_FLAGS);
02040             tmpStatus = ZwQueryValueKey(uniqueIdHandle,
02041                                         &amp;valueName,
02042                                         KeyValuePartialInformation,
02043                                         keyInfo,
02044                                         <span class="keyword">sizeof</span>(buffer),
02045                                         &amp;length);
02046 
02047             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(tmpStatus)) {
02048 
02049                 ULONG configFlags = *(PULONG)keyInfo-&gt;Data;
02050 
02051                 <span class="comment">//</span>
02052                 <span class="comment">// The ConfigFlags value exists in the registry</span>
02053                 <span class="comment">// If DNF_REINSTALL is set.  We mark it as DNF_DELETED such that we will not</span>
02054                 <span class="comment">// start the device.  Later when the reinstallation completes, the</span>
02055                 <span class="comment">// DNF_RESTART_OK bit will be set and DNF_DELETED will be deleted.</span>
02056                 <span class="comment">//</span>
02057 
02058                 <span class="keywordflow">if</span> (configFlags &amp; CONFIGFLAG_REINSTALL) {
02059                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_REINSTALL);
02060                     processCriticalDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  <span class="comment">// to install critical driver</span>
02061                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (configFlags &amp; CONFIGFLAG_FAILEDINSTALL) {
02062                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_FAILED_INSTALL);
02063                     processCriticalDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  <span class="comment">// to install critical driver</span>
02064                 }
02065             } <span class="keywordflow">else</span> {
02066                 <span class="comment">//</span>
02067                 <span class="comment">// The ConfigFlag value does not exist in the registry</span>
02068                 <span class="comment">//</span>
02069                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED);
02070             }
02071         }
02072 
02073         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, REGSTR_VALUE_SERVICE);
02074 
02075         tmpStatus = ZwQueryValueKey(uniqueIdHandle,
02076                                     &amp;valueName,
02077                                     KeyValuePartialInformation,
02078                                     keyInfo,
02079                                     <span class="keyword">sizeof</span>(buffer),
02080                                     &amp;length);
02081 
02082         <span class="comment">//</span>
02083         <span class="comment">// if there's no service setup then check to see if this should</span>
02084         <span class="comment">// be processed as a critical device.</span>
02085         <span class="comment">//</span>
02086 
02087         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(tmpStatus) &amp;&amp; (keyInfo-&gt;DataLength &lt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>))) {
02088             processCriticalDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02089         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmpStatus == STATUS_OBJECT_NAME_NOT_FOUND) {
02090             processCriticalDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02091         }
02092     }
02093 
02094     <span class="keywordflow">if</span> (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o16">HardwareDisabled</a> &amp;&amp;
02095         !<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED) &amp;&amp;
02096         !<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART)) {
02097         <span class="comment">//</span>
02098         <span class="comment">// mark the node as hardware disabled, if no configuration problems</span>
02099         <span class="comment">//</span>
02100         <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(DeviceNode);
02101         <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_HARDWARE_DISABLED);
02102         <span class="comment">//</span>
02103         <span class="comment">// Issue a PNP REMOVE_DEVICE Irp so when we query resources</span>
02104         <span class="comment">// we have those required after boot</span>
02105         <span class="comment">//</span>
02106         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a>(deviceObject, IRP_MN_REMOVE_DEVICE);
02107         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
02108 
02109     } <span class="keywordflow">else</span> {
02110         <span class="comment">//</span>
02111         <span class="comment">// these are the only problems I expect at this point</span>
02112         <span class="comment">//</span>
02113         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode) ||
02114                <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED) ||
02115                <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_REINSTALL) ||
02116                <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_FAILED_INSTALL) ||
02117                <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART));
02118     }
02119 
02120     <span class="comment">//</span>
02121     <span class="comment">// Create all the default value entry for the newly created key.</span>
02122     <span class="comment">// Configuration = REG_RESOURCE_LIST</span>
02123     <span class="comment">// ConfigurationVector = REG_RESOUCE_REQUIREMENTS_LIST</span>
02124     <span class="comment">// HardwareID = MULTI_SZ</span>
02125     <span class="comment">// CompatibleIDs = MULTI_SZ</span>
02126     <span class="comment">// Create "Control" volatile subkey.</span>
02127     <span class="comment">//</span>
02128 
02129     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
02130     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
02131                                      uniqueIdHandle,
02132                                      &amp;unicodeName,
02133                                      KEY_ALL_ACCESS,
02134                                      REG_OPTION_VOLATILE,
02135                                      NULL
02136                                      );
02137     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02138 
02139         <span class="comment">//</span>
02140         <span class="comment">// Write DeviceObject reference ...</span>
02141         <span class="comment">//</span>
02142 
02143         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_DEVICE_REFERENCE);
02144         status = ZwSetValueKey( handle,
02145                                 &amp;unicodeName,
02146                                 TITLE_INDEX_VALUE,
02147                                 REG_DWORD,
02148                                 (PULONG_PTR)&amp;deviceObject,
02149                                 <span class="keyword">sizeof</span>(ULONG_PTR)
02150                                 );
02151         ZwClose(handle);
02152     }
02153 
02154     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02155         ZwClose(enumHandle);
02156         ZwClose(uniqueIdHandle);
02157         <span class="keywordflow">if</span> (logConfHandle) {
02158             ZwClose(logConfHandle);
02159         }
02160         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02161     }
02162 
02163     ZwClose(enumHandle);
02164 
02165     <span class="comment">//</span>
02166     <span class="comment">// Release registry lock before calling device driver</span>
02167     <span class="comment">//</span>
02168 
02169     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
02170     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02171 
02172     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a26">IopQueryCompatibleIds</a>( deviceObject,
02173                                     BusQueryHardwareIDs,
02174                                     &amp;hwIds,
02175                                     &amp;hwIdLength);
02176 
02177     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02178         hwIds = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02179     }
02180 
02181     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a26">IopQueryCompatibleIds</a>( deviceObject,
02182                                     BusQueryCompatibleIDs,
02183                                     &amp;compatibleIds,
02184                                     &amp;compatibleIdLength);
02185     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02186         compatibleIds = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02187     }
02188 
02189     <span class="comment">//</span>
02190     <span class="comment">// Query the device's basic config vector. This needs to be done before we check if</span>
02191     <span class="comment">// this is a remote BOOT card.</span>
02192     <span class="comment">//</span>
02193 
02194     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
02195     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
02196     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a76">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>;
02197     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(deviceObject, &amp;irpSp, &amp;ioResource);
02198 
02199     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02200         ioResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02201     }
02202     <span class="keywordflow">if</span> (ioResource) {
02203         ioLength = ioResource-&gt;ListSize;
02204     }
02205 
02206     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02207     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
02208 
02209     <span class="comment">//</span>
02210     <span class="comment">// Write resource requirements to registry</span>
02211     <span class="comment">//</span>
02212 
02213     <span class="keywordflow">if</span> (logConfHandle) {
02214         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_BASIC_CONFIG_VECTOR);
02215         <span class="keywordflow">if</span> (ioResource) {
02216             ZwSetValueKey(logConfHandle,
02217                             &amp;unicodeName,
02218                             TITLE_INDEX_VALUE,
02219                             REG_RESOURCE_REQUIREMENTS_LIST,
02220                             ioResource,
02221                             ioLength
02222                             );
02223             DeviceNode-&gt;ResourceRequirements = ioResource;
02224             DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a16">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>;
02225         } <span class="keywordflow">else</span> {
02226             ZwDeleteValueKey(logConfHandle, &amp;unicodeName);
02227         }
02228     }
02229 
02230     <span class="comment">//</span>
02231     <span class="comment">// While we have the hwIds, check if this is the device node</span>
02232     <span class="comment">// for the remote boot net card. If IopLoaderBlock is NULL</span>
02233     <span class="comment">// then we are not initilizing boot drivers so we don't have</span>
02234     <span class="comment">// to check for this.</span>
02235     <span class="comment">//</span>
02236 
02237     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a399">IoRemoteBootClient</a> &amp;&amp; (<a class="code" href="../../d3/d5/iodata_8c.html#a73">IopLoaderBlock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02238 
02239         <span class="keywordflow">if</span> (hwIds) {
02240             isRemoteBootCard = <a class="code" href="../../d4/d6/netboot_8c.html#a14">IopIsRemoteBootCard</a>(
02241                                     DeviceNode,
02242                                     (<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>)IopLoaderBlock,
02243                                     hwIds);
02244         }
02245         <span class="keywordflow">if</span> (!isRemoteBootCard &amp;&amp; compatibleIds) {
02246             isRemoteBootCard = <a class="code" href="../../d4/d6/netboot_8c.html#a14">IopIsRemoteBootCard</a>(
02247                                     DeviceNode,
02248                                     (<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>)IopLoaderBlock,
02249                                     compatibleIds);
02250         }
02251     }
02252 
02253     <span class="comment">//</span>
02254     <span class="comment">// create HardwareId value name.  It is a MULTI_SZ,</span>
02255     <span class="comment">//</span>
02256 
02257     <span class="keywordflow">if</span> (hwIds) {
02258 
02259         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/pnpenum_8c.html#a28">IopFixupIds</a>(hwIds, hwIdLength)) {
02260             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
02261                           PNP_ERR_BOGUS_ID,
02262                           (ULONG_PTR)deviceObject,
02263                           (ULONG_PTR)hwIds,
02264                           3);
02265         }
02266         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_HARDWAREID);
02267         ZwSetValueKey(uniqueIdHandle,
02268                         &amp;unicodeName,
02269                         TITLE_INDEX_VALUE,
02270                         REG_MULTI_SZ,
02271                         hwIds,
02272                         hwIdLength
02273                         );
02274         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(hwIds);
02275     }
02276 
02277     <span class="comment">//</span>
02278     <span class="comment">// create CompatibleId value name.  It is a MULTI_SZ,</span>
02279     <span class="comment">//</span>
02280 
02281     <span class="keywordflow">if</span> (compatibleIds) {
02282 
02283         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/pnpenum_8c.html#a28">IopFixupIds</a>(compatibleIds, compatibleIdLength)) {
02284             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
02285                             PNP_ERR_BOGUS_ID,
02286                             (ULONG_PTR)deviceObject,
02287                             (ULONG_PTR)compatibleIds,
02288                             4);
02289         }
02290         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_COMPATIBLEIDS);
02291         ZwSetValueKey(uniqueIdHandle,
02292                         &amp;unicodeName,
02293                         TITLE_INDEX_VALUE,
02294                         REG_MULTI_SZ,
02295                         compatibleIds,
02296                         compatibleIdLength
02297                         );
02298         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(compatibleIds);
02299     }
02300 
02301     <span class="comment">//</span>
02302     <span class="comment">// If this is the devnode for the remote boot card, do</span>
02303     <span class="comment">// special setup for it.</span>
02304     <span class="comment">//</span>
02305 
02306     <span class="keywordflow">if</span> (isRemoteBootCard) {
02307 
02308         status = <a class="code" href="../../d4/d6/netboot_8c.html#a15">IopSetupRemoteBootCard</a>(
02309                         (<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>)IopLoaderBlock,
02310                         uniqueIdHandle,
02311                         &amp;unicodeDeviceInstance);
02312 
02313         <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
02314             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02315         }
02316 
02317         <span class="comment">//</span>
02318         <span class="comment">// HACK BUGBUG: Need to turn this off, or else the device won't</span>
02319         <span class="comment">// be allowed to be opened until the PNP start IRP is done. Unfortunately</span>
02320         <span class="comment">// that is exactly what NDIS does in the start IRP handler - adamba 3/31/99</span>
02321         <span class="comment">//</span>
02322 
02323         deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a142">DOE_START_PENDING</a>;
02324 
02325     }
02326 
02327     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
02328     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02329 
02330     <span class="comment">//</span>
02331     <span class="comment">// we've pretty much got the PDO information ready, apart from Child bus information</span>
02332     <span class="comment">// get that now, because class-installer may want it</span>
02333     <span class="comment">//</span>
02334     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a31">IopQueryPnpBusInformation</a>(
02335                  deviceObject,
02336                  &amp;busTypeGuid,
02337                  &amp;DeviceNode-&gt;ChildInterfaceType,
02338                  &amp;DeviceNode-&gt;ChildBusNumber
02339              );
02340 
02341     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02342 
02343         DeviceNode-&gt;ChildBusTypeIndex = <a class="code" href="../../d6/d0/pnpenum_8c.html#a26">IopGetBusTypeGuidIndex</a>(&amp;busTypeGuid);
02344 
02345     } <span class="keywordflow">else</span> {
02346 
02347         DeviceNode-&gt;ChildBusTypeIndex = 0xffff;
02348         DeviceNode-&gt;ChildInterfaceType = InterfaceTypeUndefined;
02349         DeviceNode-&gt;ChildBusNumber = 0xfffffff0;
02350 
02351     }
02352 
02353     <span class="comment">//</span>
02354     <span class="comment">// we check HardwareDisabled directly in case it's a new device</span>
02355     <span class="comment">//</span>
02356     <span class="keywordflow">if</span> (processCriticalDevice &amp;&amp; !capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o16">HardwareDisabled</a> &amp;&amp;
02357         !<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART)) {
02358 
02359         <a class="code" href="../../d9/d0/pnpiop_8h.html#a281">IopProcessCriticalDevice</a>(DeviceNode);
02360     }
02361 
02362     <span class="comment">//</span>
02363     <span class="comment">// Set DNF_DISABLED flag if the device instance is disabled.</span>
02364     <span class="comment">//</span>
02365 
02366     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode) ||
02367            <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED) ||
02368            <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_REINSTALL) ||
02369            <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_FAILED_INSTALL) ||
02370            <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_PARTIAL_LOG_CONF) ||
02371            <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_HARDWARE_DISABLED) ||
02372            <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART));
02373     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_DISABLED) &amp;&amp;
02374         !<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_HARDWARE_DISABLED) &amp;&amp;
02375         !<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NEED_RESTART)) {
02376 
02377         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a20">IopIsDeviceInstanceEnabled</a>(uniqueIdHandle, &amp;unicodeDeviceInstance, TRUE);
02378     }
02379 
02380     <span class="comment">//</span>
02381     <span class="comment">// This code HAS to be after we have checked for DISABLED device.</span>
02382     <span class="comment">// We could end up here from an ENABLE following a DISABLE.</span>
02383     <span class="comment">// Query for BOOT config if there is none already present.</span>
02384     <span class="comment">//</span>
02385 
02386     cmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02387     <span class="keywordflow">if</span> (DeviceNode-&gt;BootResources == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02388         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a27">IopQueryDeviceResources</a>( deviceObject,
02389                                           QUERY_RESOURCE_LIST,
02390                                           &amp;cmResource,
02391                                           &amp;cmLength );
02392         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02393             cmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02394         }
02395     } <span class="keywordflow">else</span> {
02396 
02397         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(1,
02398                    (<span class="stringliteral">"PNPENUM: %ws already has BOOT config in IopProcessNewDeviceNode!\n"</span>,
02399                    DeviceNode-&gt;InstancePath.Buffer));
02400     }
02401 
02402     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02403     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
02404 
02405     <span class="comment">//</span>
02406     <span class="comment">// Write boot resources to registry</span>
02407     <span class="comment">//</span>
02408     <span class="keywordflow">if</span> (logConfHandle &amp;&amp; DeviceNode-&gt;BootResources == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02409         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_BOOTCONFIG);
02410         <span class="keywordflow">if</span> (cmResource) {
02411             ZwSetValueKey(
02412                         logConfHandle,
02413                         &amp;unicodeName,
02414                         TITLE_INDEX_VALUE,
02415                         REG_RESOURCE_LIST,
02416                         cmResource,
02417                         cmLength
02418                         );
02419 
02420             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
02421 
02422             <span class="comment">//</span>
02423             <span class="comment">// This device consumes BOOT resources.  Reserve its boot resources</span>
02424             <span class="comment">//</span>
02425 
02426             status = (*IopReserveResourcesRoutine)(<a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>,
02427                                                     deviceObject,
02428                                                     cmResource);
02429 
02430             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
02431 
02432             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02433                 DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>;
02434             }
02435             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResource);
02436         } <span class="keywordflow">else</span> {
02437             ZwDeleteValueKey(logConfHandle, &amp;unicodeName);
02438         }
02439     }
02440 
02441     <span class="comment">//</span>
02442     <span class="comment">// SurpriseRemovalOK bits may have changed due to DNF_HAS_BOOT_CONFIG.</span>
02443     <span class="comment">//</span>
02444     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a35">IopDeviceCapabilitiesToRegistry</a>(DeviceNode,&amp;capabilities);
02445 
02446 <span class="preprocessor">#if DBG</span>
02447 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
02448 <span class="preprocessor">#endif</span>
02449 <span class="preprocessor"></span>
02450     <span class="comment">//</span>
02451     <span class="comment">// Clean up</span>
02452     <span class="comment">//</span>
02453 
02454     <span class="keywordflow">if</span> (logConfHandle) {
02455         ZwClose(logConfHandle);
02456     }
02457 
02458     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
02459     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02460 
02461     <span class="comment">//</span>
02462     <span class="comment">// Create new value entry under ServiceKeyName\Enum to reflect the newly</span>
02463     <span class="comment">// added made-up device instance node.</span>
02464     <span class="comment">//</span>
02465 
02466     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a347">IopNotifySetupDeviceArrival</a>( deviceObject,
02467                                           uniqueIdHandle,
02468                                           TRUE);
02469 
02470     configuredBySetup = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status);
02471 
02472     status = <a class="code" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration</a>(
02473                  &amp;unicodeDeviceInstance,
02474                  TRUE,
02475                  &amp;DeviceNode-&gt;ServiceName
02476                  );
02477 
02478     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (configuredBySetup || isRemoteBootCard) &amp;&amp;
02479         <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED)) {
02480 
02481         <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(DeviceNode);
02482     }
02483 
02484     <span class="comment">//</span>
02485     <span class="comment">// Add an event so user-mode will attempt to install this device later.</span>
02486     <span class="comment">//</span>
02487     <a class="code" href="../../d6/d9/pnp_8h.html#a162">PpSetPlugPlayEvent</a>( &amp;GUID_DEVICE_ENUMERATED,
02488                         deviceObject);
02489 
02490     ZwClose(uniqueIdHandle);
02491 
02492     <span class="keywordflow">if</span> (buffer) {
02493         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
02494     }
02495     <span class="keywordflow">if</span> (description) {
02496         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(description);
02497     }
02498     <span class="keywordflow">if</span> (location) {
02499         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(location);
02500     }
02501     <span class="keywordflow">return</span> STATUS_SUCCESS;
02502 
02503 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
02504 
02505     <span class="comment">//</span>
02506     <span class="comment">// In case of failure, we don't set the DNF_PROCESSED flags.  So the device</span>
02507     <span class="comment">// will be processed again later.</span>
02508     <span class="comment">//</span>
02509 
02510     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
02511     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02512     <span class="keywordflow">if</span> (buffer) {
02513         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
02514     }
02515     <span class="keywordflow">if</span> (description) {
02516         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(description);
02517     }
02518     <span class="keywordflow">if</span> (location) {
02519         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(location);
02520     }
02521     <span class="keywordflow">return</span> status;
02522 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a361" doxytag="pnpiop.h::IopProcessNewProfile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopProcessNewProfile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05034">5034</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a332a205">CriticalWorkQueue</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05109">IopProcessNewProfileWorker()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00572">IopHardwareProfileCancelRemovedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00465">IopHardwareProfileCommitRemovedDock()</a>, and <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00370">IopHardwareProfileCommitStartedDock()</a>.
<p>
<pre class="fragment"><div>05040                    :
05041 
05042     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has transitioned into a <span class="keyword">new</span>
05043     hardware profile. The thread from which <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called may be holding an
05044     enumeration lock. Calling <span class="keyword">this</span> function does two tasks:
05045 
05046     1) If a disabled devnode in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree should be enabled in <span class="keyword">this</span> <span class="keyword">new</span> hardware
05047        profile state, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be started.
05048 
05049     2) If an enabled devnode in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree should be disabled in <span class="keyword">this</span> <span class="keyword">new</span> hardware
05050        profile state, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be (surprise) removed.
05051 
05052     ADRIAO N.B. 02/19/1999 -
05053         Why surprise remove? There are four cases to be handled:
05054         a) Dock disappearing, need to enable device in new profile
05055         b) Dock appearing, need to enable device in new profile
05056         c) Dock disappearing, need to disable device in new profile
05057         d) Dock appearing, need to disable device in new profile
05058 
05059         a) and b) are trivial. c) involves treating the appropriate devices as
05060         if they were in the removal relation lists for the dock. d) is another
05061         matter altogether as we need to query-remove/remove devices before
05062         starting another. NT5's PnP state machine cannot handle this, so for
05063         this release we cleanup rather hastily after the profile change.
05064 
05065 Parameters:
05066 
05067     NONE.
05068 
05069 Return Value:
05070 
05071     NTSTATUS.
05072 
05073 --*/
05074 {
05075     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a> workQueueItem;
05076 
05077     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05078 
05079     workQueueItem = (<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
05080         NonPagedPool,
05081         <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a>)
05082         );
05083 
05084     <span class="keywordflow">if</span> (workQueueItem) {
05085 
05086         <span class="comment">//</span>
05087         <span class="comment">// Queue this up so we can walk the tree outside of the enumeration lock.</span>
05088         <span class="comment">//</span>
05089         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(
05090             workQueueItem,
05091             IopProcessNewProfileWorker,
05092             workQueueItem
05093             );
05094 
05095         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(
05096             workQueueItem,
05097             CriticalWorkQueue
05098             );
05099 
05100         <span class="keywordflow">return</span> STATUS_SUCCESS;
05101 
05102     } <span class="keywordflow">else</span> {
05103 
05104         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05105     }
05106 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a363" doxytag="pnpiop.h::IopProcessNewProfileStateCallback" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopProcessNewProfileStateCallback           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05138">5138</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01395">IoInvalidateDeviceRelations()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00831">IopClearDevNodeProblem</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03332">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">IopIsDevNodeProblem</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05109">IopProcessNewProfileWorker()</a>.
<p>
<pre class="fragment"><div>05145                    :
05146 
05147     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> each devnode after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has transitioned
05148     hardware profile states.
05149 
05150 Parameters:
05151 
05152     NONE.
05153 
05154 Return Value:
05155 
05156     NONE.
05157 
05158 --*/
05159 {
05160     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> parentDevNode;
05161 
05162     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05163 
05164     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
05165 
05166         <span class="comment">//</span>
05167         <span class="comment">// Calling this function will disable the device if it is appropriate</span>
05168         <span class="comment">// to do so.</span>
05169         <span class="comment">//</span>
05170         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a20">IopIsDeviceInstanceEnabled</a>(NULL, &amp;DeviceNode-&gt;InstancePath, FALSE)) {
05171 
05172             <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(
05173                 DeviceNode-&gt;PhysicalDeviceObject,
05174                 CM_PROB_DISABLED
05175                 );
05176         }
05177 
05178     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_DISABLED)) {
05179 
05180         <span class="comment">//</span>
05181         <span class="comment">// We might be turning on the device. So we will clear the problem</span>
05182         <span class="comment">// flags iff the device problem was CM_PROB_DISABLED.</span>
05183         <span class="comment">//</span>
05184         <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(DeviceNode);
05185 
05186         <span class="comment">//</span>
05187         <span class="comment">// Make sure the device stays down iff appropriate.</span>
05188         <span class="comment">//</span>
05189         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a20">IopIsDeviceInstanceEnabled</a>(NULL, &amp;DeviceNode-&gt;InstancePath, FALSE)) {
05190 
05191             <span class="comment">//</span>
05192             <span class="comment">// This device should come back online. Queue up an enumeration</span>
05193             <span class="comment">// at the parent level for him.</span>
05194             <span class="comment">//</span>
05195             parentDevNode = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
05196 
05197             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a79">IoInvalidateDeviceRelations</a>(
05198                 parentDevNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
05199                 BusRelations
05200                 );
05201         }
05202     }
05203 
05204     <span class="keywordflow">return</span> STATUS_SUCCESS;
05205 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a362" doxytag="pnpiop.h::IopProcessNewProfileWorker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopProcessNewProfileWorker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05109">5109</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00127">IopForAllDeviceNodes()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05138">IopProcessNewProfileStateCallback()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05034">IopProcessNewProfile()</a>.
<p>
<pre class="fragment"><div>05115                    :
05116 
05117     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> each devnode after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has transitioned
05118     to a <span class="keyword">new</span> hardware profile.
05119 
05120 Parameters:
05121 
05122     NONE.
05123 
05124 Return Value:
05125 
05126     NONE.
05127 
05128 --*/
05129 {
05130     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05131 
05132     <a class="code" href="../../d9/d0/pnpiop_8h.html#a253">IopForAllDeviceNodes</a>(IopProcessNewProfileStateCallback, NULL);
05133 
05134     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Context);
05135 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a357" doxytag="pnpiop.h::IopProcessSetInterfaceState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopProcessSetInterfaceState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SymbolicLinkName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Enable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DeferNotStarted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09922">9922</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a170a94">DevicePropertyPhysicalDeviceObjectName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01224">DOE_START_PENDING</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05675">IoCreateSymbolicLink()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06227">IoDeleteSymbolicLink()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00373">IoGetDeviceProperty()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03708">IopDeviceInterfaceKeysFromSymbolicLink()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05353">IopDropReferenceString()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05424">IopParseSymbolicLinkName()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d8/d0/pnpioapi_8c.html#a55">IopSetupDeviceObjectFromDeviceClass()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00076">_PENDING_SET_INTERFACE_STATE::LinkName</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00075">_PENDING_SET_INTERFACE_STATE::List</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00341">_DEVICE_NODE::PendedSetInterfaceState</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a112">PENDING_SET_INTERFACE_STATE</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a161">PpSetDeviceClassChange()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09866">IopDoDeferredSetInterfaceState()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03563">IoSetDeviceInterfaceState()</a>.
<p>
<pre class="fragment"><div>09929                    :
09930 
09931     This DDI allows a device <span class="keyword">class </span>to activate and deactivate an association
09932     previously registered using <a class="code" href="../../d6/d9/pnp_8h.html#a146">IoRegisterDeviceInterface</a>
09933 
09934 Parameters:
09935 
09936     SymbolicLinkName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic link name which was
09937         returned by <a class="code" href="../../d6/d9/pnp_8h.html#a146">IoRegisterDeviceInterface</a> when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface was registered,
09938         or as returned by <a class="code" href="../../d6/d9/pnp_8h.html#a149">IoGetDeviceInterfaces</a>.
09939 
09940     Enable - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> (non-zero), <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface will be enabled.  If <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
09941         will be disabled.
09942 
09943     DeferNotStarted - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> then enables will be queued if <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO isn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>
09944         started.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> when we've started <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO and are processing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09945         queued enables.
09946 
09947 Return Value:
09948 
09949     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
09950 
09951 --*/
09952 
09953 {
09954     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
09955     HANDLE hInterfaceClassKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09956     HANDLE hInterfaceParentKey= <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hInterfaceInstanceKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09957     HANDLE hInterfaceParentControl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hInterfaceInstanceControl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09958     UNICODE_STRING tempString, actualSymbolicLinkName, deviceNameString;
09959     PKEY_VALUE_FULL_INFORMATION pKeyValueInfo;
09960     ULONG linked, refcount;
09961     GUID guid;
09962     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDeviceObject;
09963     PWCHAR deviceNameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09964     ULONG deviceNameBufferLength;
09965 
09966     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
09967 
09968     <span class="comment">//</span>
09969     <span class="comment">// Get the symbolic link name without the ref string</span>
09970     <span class="comment">//</span>
09971 
09972     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a65">IopDropReferenceString</a>(&amp;actualSymbolicLinkName, SymbolicLinkName);
09973     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
09974         <span class="keywordflow">goto</span> clean0;
09975     }
09976 
09977     <span class="comment">//</span>
09978     <span class="comment">// Extract the device class guid</span>
09979     <span class="comment">//</span>
09980 
09981     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a66">IopParseSymbolicLinkName</a>(SymbolicLinkName, NULL, NULL, NULL, NULL, NULL, &amp;guid);
09982 
09983     <span class="comment">//</span>
09984     <span class="comment">// Get function class instance handle</span>
09985     <span class="comment">//</span>
09986 
09987     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a62">IopDeviceInterfaceKeysFromSymbolicLink</a>(SymbolicLinkName,
09988                                                     KEY_READ | KEY_WRITE,
09989                                                     &amp;hInterfaceClassKey,
09990                                                     &amp;hInterfaceParentKey,
09991                                                     &amp;hInterfaceInstanceKey
09992                                                     );
09993 
09994     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
09995         <span class="keywordflow">goto</span> clean1;
09996     }
09997 
09998     <span class="comment">//</span>
09999     <span class="comment">// Open the parent interface control subkey</span>
10000     <span class="comment">//</span>
10001     PiWstrToUnicodeString(&amp;tempString, REGSTR_KEY_CONTROL);
10002     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;hInterfaceParentControl,
10003                                      hInterfaceParentKey,
10004                                      &amp;tempString,
10005                                      KEY_READ,
10006                                      REG_OPTION_VOLATILE,
10007                                      NULL
10008                                      );
10009     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10010         <span class="keywordflow">goto</span> clean1;
10011     }
10012 
10013 
10014     <span class="comment">//</span>
10015     <span class="comment">// Find out the name of the device instance that 'owns' this interface.</span>
10016     <span class="comment">//</span>
10017     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hInterfaceParentKey,
10018                                  REGSTR_VAL_DEVICE_INSTANCE,
10019                                  &amp;pKeyValueInfo
10020                                  );
10021 
10022     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10023         <span class="comment">//</span>
10024         <span class="comment">// Open the device instance control subkey</span>
10025         <span class="comment">//</span>
10026         PiWstrToUnicodeString(&amp;tempString, REGSTR_KEY_CONTROL);
10027         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;hInterfaceInstanceControl,
10028                                          hInterfaceInstanceKey,
10029                                          &amp;tempString,
10030                                          KEY_READ,
10031                                          REG_OPTION_VOLATILE,
10032                                          NULL
10033                                          );
10034         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10035             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pKeyValueInfo);
10036             hInterfaceInstanceControl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10037         }
10038     }
10039 
10040     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10041         <span class="keywordflow">goto</span> clean2;
10042     }
10043 
10044     <span class="comment">//</span>
10045     <span class="comment">// Find the PDO corresponding to this device instance name.</span>
10046     <span class="comment">//</span>
10047     <span class="keywordflow">if</span> (pKeyValueInfo-&gt;Type == REG_SZ) {
10048 
10049         <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;tempString,
10050                                         (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(pKeyValueInfo),
10051                                         pKeyValueInfo-&gt;DataLength
10052                                         );
10053 
10054         physicalDeviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(NULL, &amp;tempString);
10055 
10056         <span class="keywordflow">if</span> (physicalDeviceObject) {
10057 
10058             <span class="comment">//</span>
10059             <span class="comment">// DeferNotStarted is set TRUE if we are being called from</span>
10060             <span class="comment">// IoSetDeviceInterfaceState.  It will be set FALSE if we are</span>
10061             <span class="comment">// processing previously queued operations as we are starting the</span>
10062             <span class="comment">// device.</span>
10063             <span class="comment">//</span>
10064 
10065             <span class="keywordflow">if</span> (DeferNotStarted) {
10066 
10067                 <span class="keywordflow">if</span> (physicalDeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags &amp; <a class="code" href="../../d0/d5/io_8h.html#a142">DOE_START_PENDING</a>) {
10068 
10069                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
10070                     <a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">PPENDING_SET_INTERFACE_STATE</a> pendingSetState;
10071 
10072                     <span class="comment">//</span>
10073                     <span class="comment">// The device hasn't been started yet.  We need to queue</span>
10074                     <span class="comment">// any enables and remove items from the queue on a disable.</span>
10075                     <span class="comment">//</span>
10076                     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)physicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
10077 
10078                     <span class="keywordflow">if</span> (Enable) {
10079 
10080                         pendingSetState = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool,
10081                                                           <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">PENDING_SET_INTERFACE_STATE</a>));
10082 
10083                         <span class="keywordflow">if</span> (pendingSetState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10084 
10085                             pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool,
10086                                                                                SymbolicLinkName-&gt;Length);
10087 
10088                             <span class="keywordflow">if</span> (pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10089 
10090                                 <span class="comment">//</span>
10091                                 <span class="comment">// Capture the callers info and queue it to the</span>
10092                                 <span class="comment">// devnode.  Once the device stack is started</span>
10093                                 <span class="comment">// we will dequeue and process it.</span>
10094                                 <span class="comment">//</span>
10095                                 pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.MaximumLength = SymbolicLinkName-&gt;Length;
10096                                 pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.Length = SymbolicLinkName-&gt;Length;
10097                                 RtlCopyMemory( pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.Buffer,
10098                                                SymbolicLinkName-&gt;Buffer,
10099                                                SymbolicLinkName-&gt;Length);
10100                                 InsertTailList( &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o44">PendedSetInterfaceState</a>,
10101                                                 &amp;pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o0">List</a>);
10102 
10103                                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pKeyValueInfo);
10104 
10105                                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
10106 
10107                                 status = STATUS_SUCCESS;
10108                                 <span class="keywordflow">goto</span> clean2;
10109 
10110                             } <span class="keywordflow">else</span> {
10111                                 <span class="comment">//</span>
10112                                 <span class="comment">// Couldn't allocate a buffer to hold the</span>
10113                                 <span class="comment">// symbolic link name.</span>
10114                                 <span class="comment">//</span>
10115 
10116                                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pendingSetState);
10117                                 status = STATUS_INSUFFICIENT_RESOURCES;
10118                             }
10119 
10120                         } <span class="keywordflow">else</span> {
10121                             <span class="comment">//</span>
10122                             <span class="comment">// Couldn't allocate the PENDING_SET_INTERFACE_STATE</span>
10123                             <span class="comment">// structure.</span>
10124                             <span class="comment">//</span>
10125 
10126 
10127                             status = STATUS_INSUFFICIENT_RESOURCES;
10128                         }
10129 
10130                     } <span class="keywordflow">else</span> {
10131 
10132                         PLIST_ENTRY entry;
10133 
10134                         <span class="comment">//</span>
10135                         <span class="comment">// We are disabling an interface.  Since we aren't</span>
10136                         <span class="comment">// started yet we should have queued the enable.  Now</span>
10137                         <span class="comment">// we go back and find the matching enable and remove</span>
10138                         <span class="comment">// it from the queue.</span>
10139                         <span class="comment">//</span>
10140 
10141                         <span class="keywordflow">for</span> (entry = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o44">PendedSetInterfaceState</a>.Flink;
10142                              entry != &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o44">PendedSetInterfaceState</a>;
10143                              entry = entry-&gt;Flink)  {
10144 
10145                             pendingSetState = CONTAINING_RECORD( entry,
10146                                                                  <a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">PENDING_SET_INTERFACE_STATE</a>,
10147                                                                  List );
10148 
10149                             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>( &amp;pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>,
10150                                                        SymbolicLinkName,
10151                                                        TRUE)) {
10152 
10153                                 <span class="comment">//</span>
10154                                 <span class="comment">// We found it, remove it from the list and</span>
10155                                 <span class="comment">// free it.</span>
10156                                 <span class="comment">//</span>
10157                                 RemoveEntryList(&amp;pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o0">List</a>);
10158 
10159                                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.Buffer);
10160                                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pendingSetState);
10161 
10162                                 <span class="keywordflow">break</span>;
10163                             }
10164                         }
10165 
10166 <span class="preprocessor">#if 0</span>
10167 <span class="preprocessor"></span>                        <span class="comment">//</span>
10168                         <span class="comment">// Debug code to catch the case where we couldn't find</span>
10169                         <span class="comment">// the entry to remove.  This could happen if we messed</span>
10170                         <span class="comment">// up adding the entry to the list or the driver disabled</span>
10171                         <span class="comment">// an interface without first enabling it.  Either way</span>
10172                         <span class="comment">// it probably merits some investigation.</span>
10173                         <span class="comment">//</span>
10174                         <span class="keywordflow">if</span> (entry == &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o44">PendedSetInterfaceState</a>) {
10175                             PIDBGMSG(PIDBG_ERROR,
10176                                      (<span class="stringliteral">"IopProcessSetInterfaceState: Disable couldn't find deferred enable, DeviceNode = 0x%p, SymbolicLink = \"%Z\"\n"</span>,
10177                                      deviceNode,
10178                                      SymbolicLinkName));
10179                         }
10180 
10181                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(entry != &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o44">PendedSetInterfaceState</a>);
10182 <span class="preprocessor">#endif</span>
10183 <span class="preprocessor"></span>                        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pKeyValueInfo);
10184 
10185                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
10186 
10187                         status = STATUS_SUCCESS;
10188                         <span class="keywordflow">goto</span> clean2;
10189                     }
10190                 }
10191             }
10192 
10193             <span class="keywordflow">if</span> (!Enable || !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10194                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
10195             }
10196         } <span class="keywordflow">else</span> {
10197 
10198             status = STATUS_INVALID_DEVICE_REQUEST;
10199         }
10200 
10201     } <span class="keywordflow">else</span> {
10202         <span class="comment">//</span>
10203         <span class="comment">// This will only happen if the registry information is screwed up.</span>
10204         <span class="comment">//</span>
10205         physicalDeviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10206         status = STATUS_INVALID_DEVICE_REQUEST;
10207     }
10208 
10209     <span class="keywordflow">if</span> (!Enable) {
10210         <span class="comment">//</span>
10211         <span class="comment">// In the case of Disable we want to continue even if there was an error</span>
10212         <span class="comment">// finding the PDO.  Prior to adding support for deferring the</span>
10213         <span class="comment">// IoSetDeviceInterfaceState calls, we never looked up the PDO for</span>
10214         <span class="comment">// disables.  This will make sure that we continue to behave the same as</span>
10215         <span class="comment">// we used to in the case where we can't find the PDO.</span>
10216         <span class="comment">//</span>
10217         status = STATUS_SUCCESS;
10218     }
10219 
10220     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pKeyValueInfo);
10221 
10222     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10223         <span class="keywordflow">goto</span> clean2;
10224     }
10225 
10226     <span class="keywordflow">if</span> (Enable) {
10227         <span class="comment">//</span>
10228         <span class="comment">// Retrieve the PDO's device object name.  (Start out with a reasonably-sized</span>
10229         <span class="comment">// buffer so we hopefully only have to retrieve this once.</span>
10230         <span class="comment">//</span>
10231         deviceNameBufferLength = 256 * <span class="keyword">sizeof</span>(WCHAR);
10232 
10233         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
10234 
10235             deviceNameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, deviceNameBufferLength);
10236             <span class="keywordflow">if</span> (!deviceNameBuffer) {
10237                 status = STATUS_INSUFFICIENT_RESOURCES;
10238                 <span class="keywordflow">break</span>;
10239             }
10240 
10241             status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a74">IoGetDeviceProperty</a>( physicalDeviceObject,
10242                                           DevicePropertyPhysicalDeviceObjectName,
10243                                           deviceNameBufferLength,
10244                                           deviceNameBuffer,
10245                                           &amp;deviceNameBufferLength
10246                                          );
10247 
10248             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10249                 <span class="keywordflow">break</span>;
10250             } <span class="keywordflow">else</span> {
10251                 <span class="comment">//</span>
10252                 <span class="comment">// Free the current buffer before we figure out what went wrong.</span>
10253                 <span class="comment">//</span>
10254                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNameBuffer);
10255 
10256                 <span class="keywordflow">if</span> (status != STATUS_BUFFER_TOO_SMALL) {
10257                     <span class="comment">//</span>
10258                     <span class="comment">// Our failure wasn't because the buffer was too small--bail now.</span>
10259                     <span class="comment">//</span>
10260                     <span class="keywordflow">break</span>;
10261                 }
10262 
10263                 <span class="comment">//</span>
10264                 <span class="comment">// Otherwise, loop back and try again with our new buffer size.</span>
10265                 <span class="comment">//</span>
10266             }
10267         }
10268 
10269         <span class="comment">//</span>
10270         <span class="comment">// OK, we don't need the PDO anymore.</span>
10271         <span class="comment">//</span>
10272         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
10273 
10274         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10275             <span class="keywordflow">goto</span> clean2;
10276         }
10277 
10278         <span class="comment">//</span>
10279         <span class="comment">// Now create a unicode string based on the device object name we just retrieved.</span>
10280         <span class="comment">//</span>
10281 
10282         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;deviceNameString, deviceNameBuffer);
10283     }
10284 
10285     <span class="comment">//</span>
10286     <span class="comment">// Retrieve the linked value from the control subkey.</span>
10287     <span class="comment">//</span>
10288     pKeyValueInfo=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10289     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hInterfaceInstanceControl, REGSTR_VAL_LINKED, &amp;pKeyValueInfo);
10290 
10291     <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
10292 
10293         <span class="comment">//</span>
10294         <span class="comment">// The absence of a linked value is taken to mean not linked</span>
10295         <span class="comment">//</span>
10296 
10297         linked = 0;
10298 
10299     } <span class="keywordflow">else</span> {
10300         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10301             <span class="comment">//</span>
10302             <span class="comment">// If the call failed, pKeyValueInfo was never allocated</span>
10303             <span class="comment">//</span>
10304             <span class="keywordflow">goto</span> clean3;
10305         }
10306 
10307         <span class="comment">//</span>
10308         <span class="comment">// Check linked is a DWORD</span>
10309         <span class="comment">//</span>
10310 
10311         <span class="keywordflow">if</span>(pKeyValueInfo-&gt;Type == REG_DWORD &amp;&amp; pKeyValueInfo-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)) {
10312 
10313             linked = *((PULONG) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(pKeyValueInfo));
10314 
10315         } <span class="keywordflow">else</span> {
10316 
10317             <span class="comment">//</span>
10318             <span class="comment">// The registry is screwed up - assume linked is 0 and the registry will be fixed when</span>
10319             <span class="comment">// we update linked in a few moments</span>
10320             <span class="comment">//</span>
10321 
10322             linked = 0;
10323 
10324         }
10325 
10326     }
10327     <span class="keywordflow">if</span> (pKeyValueInfo) {
10328         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (pKeyValueInfo);
10329     }
10330 
10331     <span class="comment">//</span>
10332     <span class="comment">// Retrieve the refcount value from the control subkey.</span>
10333     <span class="comment">//</span>
10334 
10335     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;tempString, REGSTR_VAL_REFERENCECOUNT);
10336     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hInterfaceParentControl,
10337                                  tempString.Buffer,
10338                                  &amp;pKeyValueInfo
10339                                  );
10340 
10341     <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
10342 
10343         <span class="comment">//</span>
10344         <span class="comment">// The absence of a refcount value is taken to mean refcount == 0</span>
10345         <span class="comment">//</span>
10346 
10347         refcount = 0;
10348 
10349     } <span class="keywordflow">else</span> {
10350         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10351             <span class="keywordflow">goto</span> clean3;
10352         }
10353 
10354         <span class="comment">//</span>
10355         <span class="comment">// Check refcount is a DWORD</span>
10356         <span class="comment">//</span>
10357 
10358         <span class="keywordflow">if</span>(pKeyValueInfo-&gt;Type == REG_DWORD &amp;&amp; pKeyValueInfo-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)) {
10359 
10360             refcount = *((PULONG) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(pKeyValueInfo));
10361 
10362         } <span class="keywordflow">else</span> {
10363 
10364             <span class="comment">//</span>
10365             <span class="comment">// The registry is screwed up - assume refcount is 0 and the registry will be fixed when</span>
10366             <span class="comment">// we update refcount in a few moments</span>
10367             <span class="comment">//</span>
10368 
10369             refcount = 0;
10370 
10371         }
10372 
10373         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pKeyValueInfo);
10374     }
10375 
10376 
10377     <span class="keywordflow">if</span> (Enable) {
10378 
10379         <span class="keywordflow">if</span> (!linked) {
10380             <span class="comment">//</span>
10381             <span class="comment">// check and update the reference count</span>
10382             <span class="comment">//</span>
10383 
10384             <span class="keywordflow">if</span> (refcount &gt; 0) {
10385                 <span class="comment">//</span>
10386                 <span class="comment">// Another device instance has already referenced this interface;</span>
10387                 <span class="comment">// just increment the reference count; don't try create a symbolic link.</span>
10388                 <span class="comment">//</span>
10389                 refcount += 1;
10390             } <span class="keywordflow">else</span> {
10391                 <span class="comment">//</span>
10392                 <span class="comment">// According to the reference count, no other device instances currently</span>
10393                 <span class="comment">// reference this interface, and therefore no symbolic links should exist,</span>
10394                 <span class="comment">// so we should create one.</span>
10395                 <span class="comment">//</span>
10396                 refcount = 1;
10397                 status = <a class="code" href="../../d4/d6/iosubs_8c.html#a50">IoCreateSymbolicLink</a>(&amp;actualSymbolicLinkName, &amp;deviceNameString);
10398 
10399                 <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_COLLISION) {
10400                     <span class="comment">//</span>
10401                     <span class="comment">// The reference count is screwed up.</span>
10402                     <span class="comment">//</span>
10403                     KdPrint((<span class="stringliteral">"IoSetDeviceInterfaceState: symbolic link for %ws already exists! status = %8.8X\n"</span>,
10404                              actualSymbolicLinkName.Buffer, status));
10405                     status = STATUS_SUCCESS;
10406                 }
10407 
10408             }
10409 
10410             linked = 1;
10411 
10412 <span class="preprocessor">#if 0</span>
10413 <span class="preprocessor"></span>            <a class="code" href="../../d8/d0/pnpioapi_8c.html#a55">IopSetupDeviceObjectFromDeviceClass</a>(physicalDeviceObject,
10414                                                 hInterfaceClassKey);
10415 <span class="preprocessor">#endif</span>
10416 <span class="preprocessor"></span>
10417         } <span class="keywordflow">else</span> {
10418 
10419             <span class="comment">//</span>
10420             <span class="comment">// The association already exists - don't perform the notification</span>
10421             <span class="comment">//</span>
10422 
10423             status = STATUS_OBJECT_NAME_EXISTS; <span class="comment">// Informational message not error</span>
10424             <span class="keywordflow">goto</span> clean3;
10425 
10426         }
10427     } <span class="keywordflow">else</span> {
10428 
10429         <span class="keywordflow">if</span> (linked) {
10430 
10431             <span class="comment">//</span>
10432             <span class="comment">// check and update the reference count</span>
10433             <span class="comment">//</span>
10434 
10435             <span class="keywordflow">if</span> (refcount &gt; 1) {
10436                 <span class="comment">//</span>
10437                 <span class="comment">// Another device instance already references this interface;</span>
10438                 <span class="comment">// just decrement the reference count; don't try to remove the symbolic link.</span>
10439                 <span class="comment">//</span>
10440                 refcount -= 1;
10441             } <span class="keywordflow">else</span> {
10442                 <span class="comment">//</span>
10443                 <span class="comment">// According to the reference count, only this device instance currently</span>
10444                 <span class="comment">// references this interface, so it is ok to delete this symbolic link</span>
10445                 <span class="comment">//</span>
10446                 refcount = 0;
10447                 status = <a class="code" href="../../d4/d6/iosubs_8c.html#a57">IoDeleteSymbolicLink</a>(&amp;actualSymbolicLinkName);
10448 
10449                 <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
10450                     <span class="comment">//</span>
10451                     <span class="comment">// The reference count is screwed up.</span>
10452                     <span class="comment">//</span>
10453                     KdPrint((<span class="stringliteral">"IoSetDeviceInterfaceState: no symbolic link for %ws to delete! status = %8.8X\n"</span>,
10454                              actualSymbolicLinkName.Buffer, status));
10455                     status = STATUS_SUCCESS;
10456                 }
10457 
10458             }
10459 
10460             linked = 0;
10461 
10462         } <span class="keywordflow">else</span> {
10463 
10464             <span class="comment">//</span>
10465             <span class="comment">// The association does not exists - fail and do not perform notification</span>
10466             <span class="comment">//</span>
10467 
10468             status = STATUS_OBJECT_NAME_NOT_FOUND;
10469         }
10470     }
10471 
10472     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10473         <span class="keywordflow">goto</span> clean3;
10474     }
10475 
10476     <span class="comment">//</span>
10477     <span class="comment">// Update the value of linked</span>
10478     <span class="comment">//</span>
10479 
10480     PiWstrToUnicodeString(&amp;tempString, REGSTR_VAL_LINKED);
10481     status = ZwSetValueKey(hInterfaceInstanceControl,
10482                            &amp;tempString,
10483                            0,
10484                            REG_DWORD,
10485                            &amp;linked,
10486                            <span class="keyword">sizeof</span>(linked)
10487                           );
10488 
10489     <span class="comment">//</span>
10490     <span class="comment">// Update the value of refcount</span>
10491     <span class="comment">//</span>
10492 
10493     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;tempString, REGSTR_VAL_REFERENCECOUNT);
10494     status = ZwSetValueKey(hInterfaceParentControl,
10495                            &amp;tempString,
10496                            0,
10497                            REG_DWORD,
10498                            &amp;refcount,
10499                            <span class="keyword">sizeof</span>(refcount)
10500                           );
10501 
10502 
10503     <span class="comment">//</span>
10504     <span class="comment">// Notify anyone that is interested</span>
10505     <span class="comment">//</span>
10506 
10507     <span class="keywordflow">if</span> (linked) {
10508 
10509         <a class="code" href="../../d6/d9/pnp_8h.html#a161">PpSetDeviceClassChange</a>( (LPGUID) &amp;GUID_DEVICE_INTERFACE_ARRIVAL, &amp;guid, SymbolicLinkName);
10510 
10511     } <span class="keywordflow">else</span> {
10512 
10513         <a class="code" href="../../d6/d9/pnp_8h.html#a161">PpSetDeviceClassChange</a>( (LPGUID) &amp;GUID_DEVICE_INTERFACE_REMOVAL, &amp;guid, SymbolicLinkName);
10514 
10515     }
10516 
10517 clean3:
10518     <span class="keywordflow">if</span> (deviceNameBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10519         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNameBuffer);
10520     }
10521 
10522 clean2:
10523     <span class="keywordflow">if</span> (hInterfaceParentControl) {
10524         ZwClose(hInterfaceParentControl);
10525     }
10526     <span class="keywordflow">if</span> (hInterfaceInstanceControl) {
10527         ZwClose(hInterfaceInstanceControl);
10528     }
10529 
10530 clean1:
10531     <span class="keywordflow">if</span> (hInterfaceParentKey) {
10532         ZwClose(hInterfaceParentKey);
10533     }
10534     <span class="keywordflow">if</span> (hInterfaceInstanceKey) {
10535         ZwClose(hInterfaceInstanceKey);
10536     }
10537     <span class="keywordflow">if</span>(hInterfaceClassKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10538         ZwClose(hInterfaceClassKey);
10539     }
10540 
10541 clean0:
10542     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; !Enable) {
10543         <span class="comment">//</span>
10544         <span class="comment">// If we failed to disable an interface (most likely because the</span>
10545         <span class="comment">// interface keys have already been deleted) report success.</span>
10546         <span class="comment">//</span>
10547         status = STATUS_SUCCESS;
10548     }
10549 
10550     <span class="keywordflow">return</span> status;
10551 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a263" doxytag="pnpiop.h::IopProcessStartDevices" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopProcessStartDevices           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">PSTART_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StartContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00821">821</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00074">IopDeviceTreeLock</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">IopProcessStartDevicesWorker()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01276">IopReleaseEnumerationLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a167">PpSynchronizeDeviceEventQueue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00728">IopBusCheck()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, and <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>.
<p>
<pre class="fragment"><div>00828                    :
00829 
00830     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by Pnp manager to start <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices which have been
00831     allocated resources and waiting to be started.
00832 
00833 Parameters:
00834 
00835     DeviceNode - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node whose subtree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be checked <span class="keywordflow">for</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a224">StartDevice</a>.
00836 
00837     StartContext - specifies <span class="keywordflow">if</span> <span class="keyword">new</span> driver should be loaded to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration.
00838 
00839 Return Value:
00840 
00841     NONE.
00842 
00843 --*/
00844 {
00845     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00846     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode, nextDeviceNode;
00847 
00848     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00849 
00850     <span class="comment">//</span>
00851     <span class="comment">// Parse the device node subtree to determine which devices need to be started</span>
00852     <span class="comment">//</span>
00853 
00854     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;IopDeviceTreeLock, TRUE);
00855     <span class="keywordflow">if</span> (DeviceNode-&gt;LockCount == 0) {
00856 
00857         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;DeviceNode-&gt;EnumerationMutex,
00858                                Executive,
00859                                KernelMode,
00860                                FALSE,
00861                                NULL );
00862 
00863         deviceNode = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00864         <span class="keywordflow">while</span> (deviceNode) {
00865             nextDeviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00866             status = <a class="code" href="../../d6/d0/pnpenum_8c.html#a25">IopProcessStartDevicesWorker</a>(deviceNode, StartContext);
00867 
00868             <span class="keywordflow">if</span> (status == STATUS_PNP_RESTART_ENUMERATION) {
00869 
00870                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(DeviceNode);
00871 
00872                 <a class="code" href="../../d6/d9/pnp_8h.html#a167">PpSynchronizeDeviceEventQueue</a>();
00873 
00874                 <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;IopDeviceTreeLock, TRUE);
00875                 <span class="keywordflow">if</span> (DeviceNode-&gt;LockCount == 0) {
00876 
00877                     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;DeviceNode-&gt;EnumerationMutex,
00878                                            Executive,
00879                                            KernelMode,
00880                                            FALSE,
00881                                            NULL );
00882 
00883 
00884                     <span class="keywordflow">if</span> (!(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>)) {
00885                         <span class="keywordflow">break</span>;
00886                     }
00887 
00888                     deviceNode = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00889 
00890                     <span class="keywordflow">continue</span>;
00891 
00892                 } <span class="keywordflow">else</span> {
00893 
00894                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;IopDeviceTreeLock);
00895                     <span class="keywordflow">return</span>;
00896 
00897                 }
00898             }
00899 
00900             deviceNode = nextDeviceNode;
00901         }
00902 
00903         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;DeviceNode-&gt;EnumerationMutex,
00904                     0,
00905                     FALSE );
00906     }
00907 
00908     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;IopDeviceTreeLock);
00909 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a275" doxytag="pnpiop.h::IopQueryCompatibleIds" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryCompatibleIds           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a604">BUS_QUERY_ID_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IdType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PWCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>CompatibleIds</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02173">2173</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a422">BusQueryHardwareIDs</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00180">IRP_MN_QUERY_ID</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>.
<p>
<pre class="fragment"><div>02182                    :
02183 
02184     This routine sends irp to query HardwareIds or CompatibleIds.  This rotine
02185     queries MULTISZ Ids.
02186 
02187 Parameters:
02188 
02189     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being queried/
02190 
02191     IdType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Id <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> interested.  Only HardwareIDs and CompatibleIDs
02192              are supported by <span class="keyword">this</span> routine.
02193 
02194     CompatibleId - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned Ids.
02195                    This must be freed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
02196 
02197     Length - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IDs.
02198 
02199 Return Value:
02200 
02201     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
02202 
02203 --*/
02204 {
02205     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
02206     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02207 
02208     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02209 
02210     *Length = 0;
02211     <span class="keywordflow">if</span> ((IdType != <a class="code" href="../../d0/d5/io_8h.html#a604a422">BusQueryHardwareIDs</a>) &amp;&amp; (IdType != <a class="code" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>)) {
02212         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
02213     }
02214 
02215     <span class="comment">//</span>
02216     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
02217     <span class="comment">//</span>
02218 
02219     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
02220 
02221     <span class="comment">//</span>
02222     <span class="comment">// Set the function codes.</span>
02223     <span class="comment">//</span>
02224 
02225     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
02226     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a83">IRP_MN_QUERY_ID</a>;
02227 
02228     <span class="comment">//</span>
02229     <span class="comment">// Set the pointer to the resource list</span>
02230     <span class="comment">//</span>
02231 
02232     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryId.IdType = IdType;
02233 
02234     <span class="comment">//</span>
02235     <span class="comment">// Make the call and return.</span>
02236     <span class="comment">//</span>
02237 
02238     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, CompatibleIds);
02239 
02240     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; *CompatibleIds) {
02241 
02242         <span class="comment">//</span>
02243         <span class="comment">// The Compatible IDs and Hardware IDs are multi_sz,</span>
02244         <span class="comment">// try to determine its size.</span>
02245         <span class="comment">//</span>
02246 
02247         PWCHAR wp;
02248 
02249         <span class="keywordflow">for</span> (wp = *CompatibleIds;
02250              (*wp != UNICODE_NULL) || (*(wp + 1) != UNICODE_NULL);
02251              wp++) {
02252 
02253             *Length += 2;
02254         }
02255         *Length += 4;
02256     }
02257 
02258     <span class="keywordflow">return</span> status;
02259 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a337" doxytag="pnpiop.h::IopQueryConflictList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryConflictList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalDeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceListSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPLUGPLAY_CONTROL_CONFLICT_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ConflictList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ConflictListSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07717">7717</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00337">IopRegistrySemaphore</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>07727                    :
07728 
07729     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> querying of device conflicts
07730     returning data in ConflictList
07731 
07732 Arguments:
07733 
07734     PhysicalDeviceObject PDO of device to Query
07735     ResourceList      CM resource list containing single resource to query
07736     ResourceListSize  <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of ResourceList
07737     ConflictList      Conflict list to fill query details in
07738     ConflictListSize  <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of buffer that we can fill with Conflict information
07739     Flags             Currently unused (zero) for future passing of flags
07740 
07741 Return Value:
07742 
07743     Should be success in most cases
07744 
07745 --*/
07746 {
07747     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
07748 
07749     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07750 
07751     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>( );
07752 
07753     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;IopRegistrySemaphore,
07754                                     DelayExecution,
07755                                     KernelMode,
07756                                     FALSE,
07757                                     NULL );
07758 
07759     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07760         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"IopQueryConflictList: Get RegustrySemaphore failed. Status %x\n"</span>, status));
07761         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>( );
07762         <span class="keywordflow">return</span> status;
07763     } <span class="keywordflow">else</span> {
07764         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a101">IopQueryConflictListInternal</a>(PhysicalDeviceObject, ResourceList, ResourceListSize, ConflictList, ConflictListSize, Flags);
07765         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( &amp;IopRegistrySemaphore, 0, 1, FALSE );
07766         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>( );
07767     }
07768 
07769     <span class="keywordflow">return</span> status;
07770 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a330" doxytag="pnpiop.h::IopQueryDeviceCapabilities" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDeviceCapabilities           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Capabilities</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03694">3694</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/io_8h.html#a365">DEVICE_CAPABILITIES</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00170">IRP_MN_QUERY_CAPABILITIES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00373">IoGetDeviceProperty()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05524">IopDeviceCapabilitiesToRegistry()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05633">IopDeviceNodeCapabilitiesToRegistry()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>03701                    :
03702 
03703     This routine will issue an irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceObject to retrieve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03704     pnp device capabilities.
03705     Should <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be called twice - first from <a class="code" href="../../d6/d0/pnpenum_8c.html#a35">IopProcessNewDeviceNode</a>,
03706     and second from <a class="code" href="../../d9/d0/pnpiop_8h.html#a328">IopDeviceNodeCapabilitiesToRegistry</a>, called after
03707     device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> started. If you consider calling <span class="keyword">this</span> device, see <span class="keywordflow">if</span>
03708     DeviceNode-&gt;CapabilityFlags does what you need instead (accessed
03709     via <a class="code" href="../../d9/d0/pnpiop_8h.html#a101">IopDeviceNodeFlagsToCapabilities</a>(...).
03710 
03711 Arguments:
03712 
03713     DeviceNode - the device object the request should be sent to.
03714 
03715     Capabilities - a capabilities structure to be filled in by the driver.
03716 
03717 Return Value:
03718 
03719     status
03720 
03721 --*/
03722 
03723 {
03724     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpStack;
03725     PVOID dummy;
03726 
03727     NTSTATUS status;
03728 
03729     <span class="comment">//</span>
03730     <span class="comment">// Initialize the capabilities structure.</span>
03731     <span class="comment">//</span>
03732 
03733     RtlZeroMemory(Capabilities, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>));
03734     Capabilities-&gt;Size = <span class="keyword">sizeof</span>(DEVICE_CAPABILITIES);
03735     Capabilities-&gt;Version = 1;
03736     Capabilities-&gt;Address = Capabilities-&gt;UINumber = (ULONG)-1;
03737 
03738     <span class="comment">//</span>
03739     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
03740     <span class="comment">//</span>
03741 
03742     RtlZeroMemory(&amp;irpStack, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
03743 
03744     <span class="comment">//</span>
03745     <span class="comment">// Query the device's capabilities</span>
03746     <span class="comment">//</span>
03747 
03748     irpStack.MajorFunction = IRP_MJ_PNP;
03749     irpStack.MinorFunction = IRP_MN_QUERY_CAPABILITIES;
03750     irpStack.Parameters.DeviceCapabilities.Capabilities = Capabilities;
03751 
03752     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a291">IopSynchronousCall</a>(DeviceNode-&gt;PhysicalDeviceObject,
03753                                 &amp;irpStack,
03754                                 &amp;dummy);
03755 
03756     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status != STATUS_PENDING);
03757 
03758     <span class="keywordflow">return</span> status;
03759 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a255" doxytag="pnpiop.h::IopQueryDeviceConfigurationVector" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDeviceConfigurationVector           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>InstanceOrdinal</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceInstanceFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ConfigurationVector</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ActualBufferSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a272" doxytag="pnpiop.h::IopQueryDeviceId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDeviceId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PWCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01762">1762</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00180">IRP_MN_QUERY_ID</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>01769                    :
01770 
01771     This routine sends a query device <span class="keywordtype">id</span> irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device object.
01772 
01773 Parameters:
01774 
01775     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being queried/
01776 
01777     DeviceId - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned Id.
01778                This must be freed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
01779 
01780 Return Value:
01781 
01782     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01783 
01784 --*/
01785 {
01786     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
01787     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01788 
01789     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01790 
01791     <span class="comment">//</span>
01792     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
01793     <span class="comment">//</span>
01794 
01795     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
01796 
01797     <span class="comment">//</span>
01798     <span class="comment">// Set the function codes.</span>
01799     <span class="comment">//</span>
01800 
01801     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
01802     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a83">IRP_MN_QUERY_ID</a>;
01803 
01804     <span class="comment">//</span>
01805     <span class="comment">// Set the pointer to the resource list</span>
01806     <span class="comment">//</span>
01807 
01808     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryId.IdType = <a class="code" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>;
01809 
01810     <span class="comment">//</span>
01811     <span class="comment">// Make the call and return.</span>
01812     <span class="comment">//</span>
01813 
01814     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, DeviceId);
01815 
01816     <span class="keywordflow">return</span> status;
01817 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a267" doxytag="pnpiop.h::IopQueryDeviceRelations" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDeviceRelations           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d5/io_8h.html#a358">DEVICE_RELATION_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Relations</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AsyncOk</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceRelations</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">1604</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00092">_DEVICE_COMPLETION_CONTEXT::DeviceNode</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00515">DNF_BEING_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00529">DNF_ENUMERATION_REQUEST_PENDING</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00522">DNF_ENUMERATION_REQUEST_QUEUED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00508">DNF_IO_INVALIDATE_DEVICE_RELATIONS_PENDING</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02455">ExGetCurrentResourceThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01266">IopAcquireEnumerationLock</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00262">IopAsynchronousCall()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01496">IopDeviceRelationsComplete()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00068">IopPnPSpinLock</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00168">IRP_MN_QUERY_DEVICE_RELATIONS</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00094">_DEVICE_COMPLETION_CONTEXT::IrpMinorCode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o32">_DEVICE_NODE::OverUsed1</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d1/pnpirp_8c.html#a6">PDEVICE_COMPLETION_CONTEXT</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a218">ReenumerateDeviceTree</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00093">_DEVICE_COMPLETION_CONTEXT::Thread</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00917">IopProcessRelation()</a>.
<p>
<pre class="fragment"><div>01613                    :
01614 
01615     This routine sends query device relation irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device object.
01616 
01617 Parameters:
01618 
01619     Relations - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of relation interested.
01620 
01621     DeviceObjet - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being queried.
01622 
01623     AsyncOk - Specifies <span class="keywordflow">if</span> we can perform Async QueryDeviceRelations
01624 
01625     DeviceRelations - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned
01626                       relation information. This must be freed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
01627 
01628 Return Value:
01629 
01630     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01631 
01632 --*/
01633 
01634 {
01635     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
01636     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01637     <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> deviceRelations;
01638     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
01639     <a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a> completionContext;
01640     BOOLEAN requestEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01641     KIRQL oldIrql;
01642 
01643     <span class="comment">//</span>
01644     <span class="comment">// Do not allow two bus relations at the same time</span>
01645     <span class="comment">//</span>
01646 
01647     <span class="keywordflow">if</span> (Relations == <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>) {
01648         ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
01649         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a27">DNF_BEING_ENUMERATED</a>) {
01650             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
01651             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01652         }
01653         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a28">DNF_ENUMERATION_REQUEST_QUEUED</a>;
01654         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a>  |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a27">DNF_BEING_ENUMERATED</a>;
01655         ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
01656     }
01657 
01658     <span class="comment">//</span>
01659     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
01660     <span class="comment">//</span>
01661 
01662     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
01663 
01664     <span class="comment">//</span>
01665     <span class="comment">// Set the function codes.</span>
01666     <span class="comment">//</span>
01667 
01668     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
01669     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a>;
01670 
01671     <span class="comment">//</span>
01672     <span class="comment">// Set the pointer to the resource list</span>
01673     <span class="comment">//</span>
01674 
01675     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceRelations.Type = Relations;
01676 
01677     <span class="comment">//</span>
01678     <span class="comment">// Make the call and return.</span>
01679     <span class="comment">//</span>
01680 
01681     <span class="keywordflow">if</span> (AsyncOk &amp;&amp; Relations == <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>) {
01682         completionContext = (<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
01683                               NonPagedPool,
01684                               <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">DEVICE_COMPLETION_CONTEXT</a>));
01685         <span class="keywordflow">if</span> (completionContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01686             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;   <span class="comment">// BUGBUG - Should try it again.</span>
01687         }
01688 
01689         completionContext-&gt;<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html#o0">DeviceNode</a> = deviceNode;
01690         completionContext-&gt;<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html#o2">IrpMinorCode</a> = <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a>;
01691         completionContext-&gt;<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html#o1">Thread</a> = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
01692 
01693         <span class="comment">//</span>
01694         <span class="comment">// Make the call and return.</span>
01695         <span class="comment">//</span>
01696 
01697         <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(NULL);  <span class="comment">// To block IopAcquireTreeLock();</span>
01698         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a9">IopAsynchronousCall</a>(DeviceObject, &amp;irpSp, completionContext, IopDeviceRelationsComplete);
01699         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01700             KIRQL oldIrql;
01701 
01702             ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
01703 
01704             <span class="comment">//</span>
01705             <span class="comment">// Check if the completion routine completes before we setting</span>
01706             <span class="comment">// the DNF_ENUMERATION_REQUEST_PENDING flags.</span>
01707             <span class="comment">//</span>
01708 
01709             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a29">DNF_ENUMERATION_REQUEST_PENDING</a>) {
01710                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a29">DNF_ENUMERATION_REQUEST_PENDING</a>;
01711                 *DeviceRelations = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.PendingDeviceRelations;
01712                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.PendingDeviceRelations = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01713                 status = STATUS_SUCCESS;
01714             } <span class="keywordflow">else</span> {
01715 
01716                 <span class="comment">//</span>
01717                 <span class="comment">// Set DNF_ENUMERATION_REQUEST_PENDING such that the completion routine knows it</span>
01718                 <span class="comment">// needs to request enumeration when the Q_bus_relations completed successfully.</span>
01719                 <span class="comment">//</span>
01720 
01721                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a29">DNF_ENUMERATION_REQUEST_PENDING</a>;
01722             }
01723 
01724             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
01725         } <span class="keywordflow">else</span> {
01726             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a29">DNF_ENUMERATION_REQUEST_PENDING</a>;
01727             *DeviceRelations = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.PendingDeviceRelations;
01728             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.PendingDeviceRelations = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01729         }
01730         <span class="keywordflow">return</span> status;
01731     } <span class="keywordflow">else</span> {
01732         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, DeviceRelations);
01733 
01734         <span class="comment">//</span>
01735         <span class="comment">// To prevent the scenario that a driver calls IoInvalidateDeviceRelations while servicing</span>
01736         <span class="comment">// an Async Q-D-R irp, and receives another q-d-r irp before first one completed, we will</span>
01737         <span class="comment">// set a flag when it calls IoInvalidateDeviceRelations and delay queuing the request till</span>
01738         <span class="comment">// the original one is completed.</span>
01739         <span class="comment">//</span>
01740 
01741         <span class="keywordflow">if</span> (Relations == <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>) {
01742             ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
01743             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a>  &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a27">DNF_BEING_ENUMERATED</a>;
01744             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a26">DNF_IO_INVALIDATE_DEVICE_RELATIONS_PENDING</a>) {
01745                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a26">DNF_IO_INVALIDATE_DEVICE_RELATIONS_PENDING</a>;
01746                 requestEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01747             }
01748             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
01749             <span class="keywordflow">if</span> (requestEnumeration) {
01750                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>( DeviceObject,
01751                                         ReenumerateDeviceTree,
01752                                         NULL,
01753                                         NULL );
01754             }
01755         }
01756     }
01757 
01758     <span class="keywordflow">return</span> status;
01759 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a276" doxytag="pnpiop.h::IopQueryDeviceResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDeviceResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">2262</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00440">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04279">IopCmResourcesToIoResources()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03523">IopDetermineResourceListSize()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03255">IopFilterResourceRequirementsCall()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04479">IopFilterResourceRequirementsList()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03967">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04996">IopMergeFilteredResourceRequirementsList()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00172">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00171">IRP_MN_QUERY_RESOURCES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00740">QUERY_RESOURCE_LIST</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00741">QUERY_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00743">REGISTRY_ALLOC_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00747">REGISTRY_BASIC_CONFIGVECTOR</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00745">REGISTRY_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00744">REGISTRY_FORCED_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00746">REGISTRY_OVERRIDE_CONFIGVECTOR</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00201">_DEVICE_NODE::ResourceRequirements</a>, and <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, and <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>.
<p>
<pre class="fragment"><div>02271                    :
02272 
02273     This routine sends irp to queries resources or resource requirements list
02274     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device object.
02275 
02276     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a detected device, its resources will be read from
02277     registry.  Otherwise, an irp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> sent to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bus driver to query its resources.
02278 
02279 Parameters:
02280 
02281     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being queries.
02282 
02283     ResourceType - 0 <span class="keywordflow">for</span> device resources and 1 <span class="keywordflow">for</span> resource requirements list.
02284 
02285     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned resources
02286 
02287     Length - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned
02288              resources or resource requirements list.
02289 
02290 Return Value:
02291 
02292     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
02293 
02294 --*/
02295 {
02296     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
02297     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
02298     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02299     PIO_RESOURCE_REQUIREMENTS_LIST resReqList, newResources;
02300     ULONG junk;
02301     PCM_RESOURCE_LIST cmList;
02302     PIO_RESOURCE_REQUIREMENTS_LIST filteredList, mergedList;
02303     BOOLEAN exactMatch;
02304 
02305     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02306 
02307 <span class="preprocessor">#if DBG</span>
02308 <span class="preprocessor"></span>
02309     <span class="keywordflow">if</span> ((ResourceType != <a class="code" href="../../d9/d0/pnpiop_8h.html#a60">QUERY_RESOURCE_LIST</a>) &amp;&amp;
02310         (ResourceType != <a class="code" href="../../d9/d0/pnpiop_8h.html#a61">QUERY_RESOURCE_REQUIREMENTS</a>)) {
02311         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
02312     }
02313 <span class="preprocessor">#endif</span>
02314 <span class="preprocessor"></span>
02315     *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02316     *Length = 0;
02317 
02318     <span class="comment">//</span>
02319     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
02320     <span class="comment">//</span>
02321 
02322     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
02323 
02324     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
02325 
02326     <span class="keywordflow">if</span> (ResourceType == <a class="code" href="../../d9/d0/pnpiop_8h.html#a60">QUERY_RESOURCE_LIST</a>) {
02327 
02328         <span class="comment">//</span>
02329         <span class="comment">// caller is asked for RESOURCE_LIST.  If this is a madeup device, we will</span>
02330         <span class="comment">// read it from registry.  Otherwise, we ask drivers.</span>
02331         <span class="comment">//</span>
02332 
02333         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) {
02334 
02335             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a>(
02336                              DeviceObject,
02337                              ResourceType,
02338                              REGISTRY_ALLOC_CONFIG + REGISTRY_FORCED_CONFIG + REGISTRY_BOOT_CONFIG,
02339                              Resource,
02340                              Length);
02341             <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
02342                 status = STATUS_SUCCESS;
02343             }
02344             <span class="keywordflow">return</span> status;
02345         } <span class="keywordflow">else</span> {
02346             irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a75">IRP_MN_QUERY_RESOURCES</a>;
02347             irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
02348             status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, Resource);
02349             <span class="keywordflow">if</span> (status == STATUS_NOT_SUPPORTED) {
02350 
02351                 <span class="comment">//</span>
02352                 <span class="comment">// If driver doesn't implement this request, it</span>
02353                 <span class="comment">// doesn't consume any resources.</span>
02354                 <span class="comment">//</span>
02355 
02356                 *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02357                 status = STATUS_SUCCESS;
02358             }
02359             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02360                 *Length = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>((PCM_RESOURCE_LIST)*Resource);
02361             }
02362             <span class="keywordflow">return</span> status;
02363         }
02364     } <span class="keywordflow">else</span> {
02365 
02366         <span class="comment">//</span>
02367         <span class="comment">// Caller is asked for resource requirements list.  We will check:</span>
02368         <span class="comment">// if there is a ForcedConfig, it will be converted to resource requirements</span>
02369         <span class="comment">//     list and return.  Otherwise,</span>
02370         <span class="comment">// If there is an OVerrideConfigVector, we will use it as our</span>
02371         <span class="comment">//     FilterConfigVector.  Otherwise we ask driver for the config vector and</span>
02372         <span class="comment">//     use it as our FilterConfigVector.</span>
02373         <span class="comment">//     Finaly, we pass the FilterConfigVector to driver stack to let drivers</span>
02374         <span class="comment">//     filter the requirements.</span>
02375         <span class="comment">//</span>
02376 
02377         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a>(
02378                          DeviceObject,
02379                          QUERY_RESOURCE_LIST,
02380                          REGISTRY_FORCED_CONFIG,
02381                          Resource,
02382                          &amp;junk);
02383         <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
02384             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a>(
02385                              DeviceObject,
02386                              QUERY_RESOURCE_REQUIREMENTS,
02387                              REGISTRY_OVERRIDE_CONFIGVECTOR,
02388                              &amp;resReqList,
02389                              &amp;junk);
02390             <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
02391                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) {
02392                     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a>(
02393                                      DeviceObject,
02394                                      QUERY_RESOURCE_REQUIREMENTS,
02395                                      REGISTRY_BASIC_CONFIGVECTOR,
02396                                      &amp;resReqList,
02397                                      &amp;junk);
02398                     <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
02399                         status = STATUS_SUCCESS;
02400                         resReqList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02401                     }
02402                 } <span class="keywordflow">else</span> {
02403 
02404                     <span class="comment">//</span>
02405                     <span class="comment">// We are going to ask the bus driver ...</span>
02406                     <span class="comment">//</span>
02407 
02408                     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>) {
02409                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED);
02410                         resReqList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>-&gt;ListSize);
02411                         <span class="keywordflow">if</span> (resReqList) {
02412                             RtlMoveMemory(resReqList,
02413                                          deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>,
02414                                          deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>-&gt;ListSize
02415                                          );
02416                             status = STATUS_SUCCESS;
02417                         } <span class="keywordflow">else</span> {
02418                             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02419                         }
02420                     } <span class="keywordflow">else</span> {
02421                         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a76">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>;
02422                         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
02423                         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, &amp;resReqList);
02424                         <span class="keywordflow">if</span> (status == STATUS_NOT_SUPPORTED) {
02425 
02426                             <span class="comment">//</span>
02427                             <span class="comment">// If driver doesn't implement this request, it</span>
02428                             <span class="comment">// doesn't require any resources.</span>
02429                             <span class="comment">//</span>
02430 
02431                             status = STATUS_SUCCESS;
02432                             resReqList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02433 
02434                         }
02435                     }
02436                 }
02437                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02438                     <span class="keywordflow">return</span> status;
02439                 }
02440             }
02441 
02442             <span class="comment">//</span>
02443             <span class="comment">// For devices with boot config, we need to filter the resource requirements</span>
02444             <span class="comment">// list against boot config.</span>
02445             <span class="comment">//</span>
02446 
02447             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a>(
02448                              DeviceObject,
02449                              QUERY_RESOURCE_LIST,
02450                              REGISTRY_BOOT_CONFIG,
02451                              &amp;cmList,
02452                              &amp;junk);
02453             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp;
02454                 (!cmList || cmList-&gt;Count == 0 || cmList-&gt;List[0].InterfaceType != PCIBus)) {
02455                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a29">IopFilterResourceRequirementsList</a> (
02456                              resReqList,
02457                              cmList,
02458                              &amp;filteredList,
02459                              &amp;exactMatch);
02460                 <span class="keywordflow">if</span> (cmList) {
02461                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmList);
02462                 }
02463                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02464                     <span class="keywordflow">if</span> (resReqList) {
02465                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resReqList);
02466                     }
02467                     <span class="keywordflow">return</span> status;
02468                 } <span class="keywordflow">else</span> {
02469 
02470                     <span class="comment">//</span>
02471                     <span class="comment">// For non-root-enumerated devices, we merge filtered config with basic config</span>
02472                     <span class="comment">// vectors to form a new res req list.  For root-enumerated devices, we don't</span>
02473                     <span class="comment">// consider Basic config vector.</span>
02474                     <span class="comment">//</span>
02475 
02476                     <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) &amp;&amp;
02477                         (exactMatch == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || resReqList-&gt;AlternativeLists &gt; 1)) {
02478                         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a30">IopMergeFilteredResourceRequirementsList</a> (
02479                                  filteredList,
02480                                  resReqList,
02481                                  &amp;mergedList
02482                                  );
02483                         <span class="keywordflow">if</span> (resReqList) {
02484                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resReqList);
02485                         }
02486                         <span class="keywordflow">if</span> (filteredList) {
02487                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(filteredList);
02488                         }
02489                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02490                             resReqList = mergedList;
02491                         } <span class="keywordflow">else</span> {
02492                             <span class="keywordflow">return</span> status;
02493                         }
02494                     } <span class="keywordflow">else</span> {
02495                         <span class="keywordflow">if</span> (resReqList) {
02496                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resReqList);
02497                         }
02498                         resReqList = filteredList;
02499                     }
02500                 }
02501             }
02502 
02503         } <span class="keywordflow">else</span> {
02504             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
02505 
02506             <span class="comment">//</span>
02507             <span class="comment">// We have Forced Config.  Convert it to resource requirements and return it.</span>
02508             <span class="comment">//</span>
02509 
02510             <span class="keywordflow">if</span> (*Resource) {
02511                 resReqList = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, (PCM_RESOURCE_LIST)*Resource, LCPRI_FORCECONFIG);
02512                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(*Resource);
02513                 <span class="keywordflow">if</span> (resReqList) {
02514                     *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = (PVOID)resReqList;
02515                     *Length = resReqList-&gt;ListSize;
02516                 } <span class="keywordflow">else</span> {
02517                     *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02518                     *Length = 0;
02519                     status = STATUS_INSUFFICIENT_RESOURCES;
02520                     <span class="keywordflow">return</span> status;
02521                 }
02522             } <span class="keywordflow">else</span> {
02523                 resReqList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02524             }
02525         }
02526 
02527         <span class="comment">//</span>
02528         <span class="comment">// If we are here, we have a resource requirements list for drivers to examine ...</span>
02529         <span class="comment">// NOTE: Per Lonny's request, we let drivers filter ForcedConfig</span>
02530         <span class="comment">//</span>
02531 
02532         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a16">IopFilterResourceRequirementsCall</a>(
02533             DeviceObject,
02534             resReqList,
02535             &amp;newResources
02536             );
02537 
02538         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02539             UNICODE_STRING unicodeName;
02540             HANDLE handle, handlex;
02541 
02542 <span class="preprocessor">#if DBG</span>
02543 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (newResources == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; resReqList) {
02544                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PnpMgr: Non-NULL resource requirements list filtered to NULL\n"</span>);
02545             }
02546 <span class="preprocessor">#endif</span>
02547 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (newResources) {
02548 
02549                 *Length = newResources-&gt;ListSize;
02550                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*Length);
02551 
02552                 <span class="comment">//</span>
02553                 <span class="comment">// Make our own copy of the allocation. We do this so that the</span>
02554                 <span class="comment">// verifier doesn't believe the driver has leaked memory if</span>
02555                 <span class="comment">// unloaded.</span>
02556                 <span class="comment">//</span>
02557 
02558                 *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = (PVOID) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, *Length);
02559                 <span class="keywordflow">if</span> (*<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02560 
02561                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(newResources);
02562                     <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02563                 }
02564 
02565                 RtlCopyMemory(*Resource, newResources, *Length);
02566                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(newResources);
02567 
02568             } <span class="keywordflow">else</span> {
02569                 *Length = 0;
02570                 *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02571             }
02572 
02573             <span class="comment">//</span>
02574             <span class="comment">// Write filtered res req to registry</span>
02575             <span class="comment">//</span>
02576 
02577             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceObject, &amp;handlex, KEY_ALL_ACCESS);
02578             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02579                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
02580                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
02581                                                handlex,
02582                                                &amp;unicodeName,
02583                                                KEY_READ
02584                                                );
02585                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02586                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_FILTERED_CONFIG_VECTOR);
02587                     ZwSetValueKey(handle,
02588                                   &amp;unicodeName,
02589                                   TITLE_INDEX_VALUE,
02590                                   REG_RESOURCE_REQUIREMENTS_LIST,
02591                                   *Resource,
02592                                   *Length
02593                                   );
02594                     ZwClose(handle);
02595                     ZwClose(handlex);
02596                 }
02597             }
02598         } <span class="keywordflow">else</span> {
02599 
02600             <span class="comment">//</span>
02601             <span class="comment">// ADRIAO BUGBUG 05/26/1999 -</span>
02602             <span class="comment">//     Why do we not bubble up non-STATUS_NOT_SUPPORTED failure</span>
02603             <span class="comment">// codes?</span>
02604             <span class="comment">//</span>
02605             *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = resReqList;
02606             <span class="keywordflow">if</span> (resReqList) {
02607                 *Length = resReqList-&gt;ListSize;
02608             } <span class="keywordflow">else</span> {
02609                 *Length = 0;
02610             }
02611         }
02612         <span class="keywordflow">return</span> STATUS_SUCCESS;
02613     }
02614 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a269" doxytag="pnpiop.h::IopQueryDeviceSerialNumber" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDeviceSerialNumber           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PWCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>SerialNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03195">3195</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a425">BusQueryDeviceSerialNumber</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00180">IRP_MN_QUERY_ID</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00370">IopHardwareProfileCommitStartedDock()</a>, and <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00160">IopHardwareProfileMarkDock()</a>.
<p>
<pre class="fragment"><div>03202                    :
03203 
03204     This routine retrieves a hardware serial number <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device object.
03205     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine fails, SerialNumber <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> guarenteed to be to <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
03206 
03207 Parameters:
03208 
03209     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being queried
03210 
03211     SerialNumber - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned Id.
03212                    This must be freed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
03213 
03214 Return Value:
03215 
03216     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
03217 
03218 --*/
03219 {
03220     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
03221     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03222 
03223     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03224 
03225     *SerialNumber = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03226 
03227     <span class="comment">//</span>
03228     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
03229     <span class="comment">//</span>
03230 
03231     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
03232 
03233     <span class="comment">//</span>
03234     <span class="comment">// Set the function codes.</span>
03235     <span class="comment">//</span>
03236 
03237     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
03238     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a83">IRP_MN_QUERY_ID</a>;
03239     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryId.IdType = <a class="code" href="../../d0/d5/io_8h.html#a604a425">BusQueryDeviceSerialNumber</a>;
03240 
03241     <span class="comment">//</span>
03242     <span class="comment">// Make the call and return.</span>
03243     <span class="comment">//</span>
03244 
03245     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, SerialNumber);
03246 
03247     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || (*SerialNumber == NULL));
03248     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03249         *SerialNumber = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03250     }
03251     <span class="keywordflow">return</span> status;
03252 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a268" doxytag="pnpiop.h::IopQueryDeviceState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDeviceState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">2976</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00544">DNF_HAS_PRIVATE_PROBLEM</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00595">DNUF_DONT_SHOW_IN_UI</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00610">DNUF_NOT_DISABLEABLE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03152">IopDecDisableableDepends()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03109">IopIncDisableableDepends()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06439">IopResourceRequirementsChanged()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00181">IRP_MN_QUERY_PNP_DEVICE_STATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02001">PNP_DEVICE_DISABLED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02002">PNP_DEVICE_DONT_DISPLAY_IN_UI</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02003">PNP_DEVICE_FAILED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02006">PNP_DEVICE_NOT_DISABLEABLE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02004">PNP_DEVICE_REMOVED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02005">PNP_DEVICE_RESOURCE_REQUIREMENTS_CHANGED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01999">PNP_DEVICE_STATE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00136">_DEVICE_NODE::UserFlags</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06387">IopInvalidateDeviceStateWorker()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>.
<p>
<pre class="fragment"><div>02982                    :
02983 
02984     This routine sends query device state irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device object.
02985 
02986 Parameters:
02987 
02988     DeviceObjet - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being queried.
02989 
02990 Return Value:
02991 
02992     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
02993 
02994 --*/
02995 
02996 {
02997     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
02998     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
02999     <a class="code" href="../../d0/d5/io_8h.html#a370">PNP_DEVICE_STATE</a> deviceState;
03000     <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> deviceRelations;
03001     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> userEvent;
03002     ULONG eventResult;
03003     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03004 
03005     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03006 
03007     <span class="comment">//</span>
03008     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
03009     <span class="comment">//</span>
03010 
03011     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
03012 
03013     <span class="comment">//</span>
03014     <span class="comment">// Set the function codes.</span>
03015     <span class="comment">//</span>
03016 
03017     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
03018     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a84">IRP_MN_QUERY_PNP_DEVICE_STATE</a>;
03019 
03020     <span class="comment">//</span>
03021     <span class="comment">// Make the call.</span>
03022     <span class="comment">//</span>
03023 
03024     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, (PVOID *)&amp;deviceState);
03025 
03026     <span class="comment">//</span>
03027     <span class="comment">// Now perform the appropriate action based on the returned state</span>
03028     <span class="comment">//</span>
03029 
03030     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03031 
03032         deviceNode = DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
03033 
03034         <span class="keywordflow">if</span> (deviceState != 0) {
03035 
03036             <span class="comment">//</span>
03037             <span class="comment">// everything here can only be turned on (state set)</span>
03038             <span class="comment">//</span>
03039 
03040             <span class="keywordflow">if</span> (deviceState &amp; <a class="code" href="../../d0/d5/io_8h.html#a214">PNP_DEVICE_DONT_DISPLAY_IN_UI</a>) {
03041 
03042                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o7">UserFlags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a38">DNUF_DONT_SHOW_IN_UI</a>;
03043             }
03044 
03045             <span class="keywordflow">if</span> (deviceState &amp; <a class="code" href="../../d0/d5/io_8h.html#a218">PNP_DEVICE_NOT_DISABLEABLE</a>) {
03046 
03047                 <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o7">UserFlags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a40">DNUF_NOT_DISABLEABLE</a>)==0) {
03048                     <span class="comment">//</span>
03049                     <span class="comment">// this node itself is not disableable</span>
03050                     <span class="comment">//</span>
03051                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o7">UserFlags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a40">DNUF_NOT_DISABLEABLE</a>;
03052                     <span class="comment">//</span>
03053                     <span class="comment">// propagate up tree</span>
03054                     <span class="comment">//</span>
03055                     <a class="code" href="../../d0/d1/pnpirp_8c.html#a33">IopIncDisableableDepends</a>(deviceNode);
03056 
03057                 }
03058             }
03059 
03060             <span class="keywordflow">if</span> (deviceState &amp; (<a class="code" href="../../d0/d5/io_8h.html#a213">PNP_DEVICE_DISABLED</a> | <a class="code" href="../../d0/d5/io_8h.html#a216">PNP_DEVICE_REMOVED</a>)) {
03061 
03062                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>( DeviceObject,
03063                                          (deviceState &amp; PNP_DEVICE_DISABLED) ?
03064                                             CM_PROB_HARDWARE_DISABLED : CM_PROB_DEVICE_NOT_THERE
03065                                          );
03066 
03067             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceState &amp; <a class="code" href="../../d0/d5/io_8h.html#a217">PNP_DEVICE_RESOURCE_REQUIREMENTS_CHANGED</a>) {
03068 
03069                 <span class="keywordflow">if</span> (deviceState &amp; <a class="code" href="../../d0/d5/io_8h.html#a215">PNP_DEVICE_FAILED</a>) {
03070 
03071                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a278">IopResourceRequirementsChanged</a>(DeviceObject, TRUE);
03072 
03073                 } <span class="keywordflow">else</span> {
03074 
03075                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a278">IopResourceRequirementsChanged</a>(DeviceObject, FALSE);
03076 
03077                 }
03078             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceState &amp; <a class="code" href="../../d0/d5/io_8h.html#a215">PNP_DEVICE_FAILED</a>) {
03079 
03080                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a31">DNF_HAS_PRIVATE_PROBLEM</a>;
03081 
03082                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(DeviceObject, 0);
03083             }
03084         } <span class="keywordflow">else</span> {
03085 
03086             <span class="comment">//</span>
03087             <span class="comment">// handle things that can be turned off (state cleared)</span>
03088             <span class="comment">//</span>
03089 
03090             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o7">UserFlags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a40">DNUF_NOT_DISABLEABLE</a>) {
03091                 <span class="comment">//</span>
03092                 <span class="comment">// this node itself is now disableable</span>
03093                 <span class="comment">//</span>
03094                 <span class="comment">//</span>
03095                 <span class="comment">// check tree</span>
03096                 <span class="comment">//</span>
03097                 <a class="code" href="../../d0/d1/pnpirp_8c.html#a34">IopDecDisableableDepends</a>(deviceNode);
03098             }
03099 
03100             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o7">UserFlags</a> &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a38">DNUF_DONT_SHOW_IN_UI</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a40">DNUF_NOT_DISABLEABLE</a>);
03101         }
03102     }
03103 
03104     <span class="keywordflow">return</span> status;
03105 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a333" doxytag="pnpiop.h::IopQueryDockRemovalInterface" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryDockRemovalInterface           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PDOCK_INTERFACE *&nbsp;</td>
          <td class="mdname" nowrap> <em>DockInterface</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03395">3395</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00169">IRP_MN_QUERY_INTERFACE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01941">_INTERFACE::Size</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01942">_INTERFACE::Version</a>.
<p>
<pre class="fragment"><div>03402                    :
03403 
03404     This routine queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified DeviceObject <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dock removal
03405     interface. We use <span class="keyword">this</span> interface to send pseudo-remove's. We use <span class="keyword">this</span>
03406     to solve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> removal orderings problem.
03407 
03408 Parameters:
03409 
03410     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Device object to be queried.
03411 
03412     Interface - supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired interface.
03413 
03414 Return Value:
03415 
03416     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
03417 
03418 --*/
03419 {
03420     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
03421     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03422     PVOID <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
03423     <a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a> interface;
03424     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> size;
03425     GUID interfaceType;
03426 
03427     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03428 
03429     size = <span class="keyword">sizeof</span>(DOCK_INTERFACE);
03430     interfaceType = GUID_DOCK_INTERFACE;
03431     interface = (<a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
03432     <span class="keywordflow">if</span> (interface == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03433         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03434     }
03435 
03436     RtlZeroMemory(interface, size);
03437     interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o0">Size</a> = size;
03438 
03439     <span class="comment">//</span>
03440     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
03441     <span class="comment">//</span>
03442 
03443     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
03444 
03445     <span class="comment">//</span>
03446     <span class="comment">// Set the function codes.</span>
03447     <span class="comment">//</span>
03448 
03449     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
03450     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a73">IRP_MN_QUERY_INTERFACE</a>;
03451 
03452     <span class="comment">//</span>
03453     <span class="comment">// Set the pointer to the resource list</span>
03454     <span class="comment">//</span>
03455 
03456     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceType = &amp;interfaceType;
03457     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Size = interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o0">Size</a>;
03458     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Version = interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o1">Version</a> = 0;
03459     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Interface = interface;
03460     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceSpecificData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03461 
03462     <span class="comment">//</span>
03463     <span class="comment">// Make the call and return.</span>
03464     <span class="comment">//</span>
03465 
03466     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, &amp;dummy);
03467     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03468         *DockInterface = (PDOCK_INTERFACE) interface;
03469     } <span class="keywordflow">else</span> {
03470         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(interface);
03471     }
03472     <span class="keywordflow">return</span> status;
03473 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a310" doxytag="pnpiop.h::IopQueryLegacyBusInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryLegacyBusInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT LPGUID InterfaceGuid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT INTERFACE_TYPE *<a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG *<a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a309" doxytag="pnpiop.h::IopQueryPnpBusInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryPnpBusInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT LPGUID InterfaceGuid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT INTERFACE_TYPE *<a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG *<a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a322" doxytag="pnpiop.h::IopQueryReconfiguration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryReconfiguration           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Request</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02733">2733</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00166">IRP_MN_CANCEL_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00165">IRP_MN_QUERY_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00164">IRP_MN_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l01221">Request()</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>.
<p>
<pre class="fragment"><div>02740                    :
02741 
02742     This routine queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified DeviceObject <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified ResourceType
02743     resource translator.
02744 
02745 Parameters:
02746 
02747     HandlerType - specifies Arbiter or Translator
02748 
02749     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Device object to be queried.
02750 
02751     ResourceType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of translator.
02752 
02753     Interface - supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired interface.
02754 
02755 Return Value:
02756 
02757     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
02758 
02759 --*/
02760 {
02761     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
02762     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02763     PVOID <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
02764 
02765     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02766 
02767     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Request == IRP_MN_QUERY_STOP_DEVICE ||
02768             Request == IRP_MN_STOP_DEVICE ||
02769             Request == IRP_MN_CANCEL_STOP_DEVICE);
02770 
02771     <span class="comment">//</span>
02772     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
02773     <span class="comment">//</span>
02774 
02775     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
02776 
02777     <span class="comment">//</span>
02778     <span class="comment">// Set the function codes.</span>
02779     <span class="comment">//</span>
02780 
02781     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
02782     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a>;
02783 
02784     <span class="comment">//</span>
02785     <span class="comment">// Make the call and return.</span>
02786     <span class="comment">//</span>
02787 
02788     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, &amp;dummy);
02789     <span class="keywordflow">return</span> status;
02790 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a321" doxytag="pnpiop.h::IopQueryResourceHandlerInterface" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryResourceHandlerInterface           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a126">RESOURCE_HANDLER_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandlerType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Interface</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02617">2617</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01164">DO_BUS_ENUMERATED_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00195">_DEVICE_NODE::DuplicatePDO</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00169">IRP_MN_QUERY_INTERFACE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a390a216">ResourceArbiter</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a390a217">ResourceLegacyDeviceDetection</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a390a215">ResourceTranslator</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01941">_INTERFACE::Size</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01942">_INTERFACE::Version</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06528">IopDuplicateDetection()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>.
<p>
<pre class="fragment"><div>02626                    :
02627 
02628     This routine queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified DeviceObject <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified ResourceType
02629     resource translator.
02630 
02631 Parameters:
02632 
02633     HandlerType - specifies Arbiter or Translator
02634 
02635     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Device object to be queried.
02636 
02637     ResourceType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of translator.
02638 
02639     Interface - supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired interface.
02640 
02641 Return Value:
02642 
02643     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
02644 
02645 --*/
02646 {
02647     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
02648     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02649     PVOID <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
02650     <a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a> interface;
02651     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> size;
02652     GUID interfaceType;
02653     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
02654 
02655     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02656 
02657     <span class="comment">//</span>
02658     <span class="comment">// If this device object is created by pnp mgr for legacy resource allocation,</span>
02659     <span class="comment">// skip it.</span>
02660     <span class="comment">//</span>
02661 
02662     <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o15">DuplicatePDO</a> == (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>) ||
02663         !(DeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>)) {
02664         <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
02665     }
02666 
02667     <span class="keywordflow">switch</span> (HandlerType) {
02668     <span class="keywordflow">case</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a215">ResourceTranslator</a>:
02669         size = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">TRANSLATOR_INTERFACE</a>) + 4;  <span class="comment">// Pnptest</span>
02670         <span class="comment">//size = sizeof(TRANSLATOR_INTERFACE);</span>
02671         interfaceType = GUID_TRANSLATOR_INTERFACE_STANDARD;
02672         <span class="keywordflow">break</span>;
02673 
02674     <span class="keywordflow">case</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a216">ResourceArbiter</a>:
02675         size = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html">ARBITER_INTERFACE</a>);
02676         interfaceType = GUID_ARBITER_INTERFACE_STANDARD;
02677         <span class="keywordflow">break</span>;
02678 
02679     <span class="keywordflow">case</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a217">ResourceLegacyDeviceDetection</a>:
02680         size = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/struct__LEGACY__DEVICE__DETECTION__INTERFACE.html">LEGACY_DEVICE_DETECTION_INTERFACE</a>);
02681         interfaceType = GUID_LEGACY_DEVICE_DETECTION_STANDARD;
02682         <span class="keywordflow">break</span>;
02683 
02684     <span class="keywordflow">default</span>:
02685         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02686     }
02687 
02688     interface = (<a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
02689     <span class="keywordflow">if</span> (interface == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02690         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02691     }
02692 
02693     RtlZeroMemory(interface, size);
02694     interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o0">Size</a> = size;
02695 
02696     <span class="comment">//</span>
02697     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
02698     <span class="comment">//</span>
02699 
02700     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
02701 
02702     <span class="comment">//</span>
02703     <span class="comment">// Set the function codes.</span>
02704     <span class="comment">//</span>
02705 
02706     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
02707     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a73">IRP_MN_QUERY_INTERFACE</a>;
02708 
02709     <span class="comment">//</span>
02710     <span class="comment">// Set the pointer to the resource list</span>
02711     <span class="comment">//</span>
02712 
02713     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceType = &amp;interfaceType;
02714     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Size = interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o0">Size</a>;
02715     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Version = interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o1">Version</a> = 0;
02716     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Interface = interface;
02717     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceSpecificData = (PVOID) ResourceType;
02718 
02719     <span class="comment">//</span>
02720     <span class="comment">// Make the call and return.</span>
02721     <span class="comment">//</span>
02722 
02723     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, &amp;dummy);
02724     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02725         *Interface = interface;
02726     } <span class="keywordflow">else</span> {
02727         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(interface);
02728     }
02729     <span class="keywordflow">return</span> status;
02730 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a273" doxytag="pnpiop.h::IopQueryUniqueId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryUniqueId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PWCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>UniqueId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01820">1820</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d0/d5/io_8h.html#a604a424">BusQueryInstanceID</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00180">IRP_MN_QUERY_ID</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>01827                    :
01828 
01829 
01830     This routine generates a unique <span class="keywordtype">id</span> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device object.
01831 
01832 Parameters:
01833 
01834     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being queried
01835 
01836     UniqueId - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned Id.
01837                This must be freed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
01838 
01839     GloballyUnique - Indicates (from a previous call to query capabilities
01840                      whether the <span class="keywordtype">id</span> is globally unique.
01841 Return Value:
01842 
01843     NTSTATUS code.
01844 
01845 --*/
01846 {
01847     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
01848     NTSTATUS status;
01849 
01850     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01851 
01852     *UniqueId = NULL;
01853 
01854     <span class="comment">//</span>
01855     <span class="comment">// First ask for for InstanceId.</span>
01856     <span class="comment">//</span>
01857 
01858     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
01859     <span class="comment">//</span>
01860 
01861     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
01862 
01863     <span class="comment">//</span>
01864     <span class="comment">// Set the function codes.</span>
01865     <span class="comment">//</span>
01866 
01867     irpSp.MajorFunction = IRP_MJ_PNP;
01868     irpSp.MinorFunction = IRP_MN_QUERY_ID;
01869 
01870     <span class="comment">//</span>
01871     <span class="comment">// Set the pointer to the resource list</span>
01872     <span class="comment">//</span>
01873 
01874     irpSp.Parameters.QueryId.IdType = BusQueryInstanceID;
01875 
01876     <span class="comment">//</span>
01877     <span class="comment">// Make the call and return.</span>
01878     <span class="comment">//</span>
01879 
01880     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a291">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, UniqueId);
01881 
01882     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01883         *UniqueId = NULL;
01884     }
01885 
01886     <span class="keywordflow">return</span> status;
01887 
01888 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a317" doxytag="pnpiop.h::IopQueuePendingEject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopQueuePendingEject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Entry</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01234">1234</a> of file <a class="el" href="../../d4/d9/pnpdel_8c-source.html">pnpdel.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01293">IopAcquireDeviceTreeLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00183">IopPendingEjects</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01294">IopReleaseDeviceTreeLock</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00085">_PENDING_RELATIONS_LIST_ENTRY::Link</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00730">IopEjectDevice()</a>.
<p>
<pre class="fragment"><div>01237 {
01238     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01239 
01240     <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
01241 
01242     InsertTailList(&amp;IopPendingEjects, &amp;Entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o0">Link</a>);
01243 
01244     <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
01245 
01246     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01247 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a319" doxytag="pnpiop.h::IopQueuePendingSurpriseRemoval" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopQueuePendingSurpriseRemoval           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>List</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Problem</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01540">1540</a> of file <a class="el" href="../../d4/d9/pnpdel_8c-source.html">pnpdel.c</a>.
<p>
References <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00088">_PENDING_RELATIONS_LIST_ENTRY::DeviceObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01293">IopAcquireDeviceTreeLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00188">IopPendingSurpriseRemovals</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01294">IopReleaseDeviceTreeLock</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00085">_PENDING_RELATIONS_LIST_ENTRY::Link</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00091">_PENDING_RELATIONS_LIST_ENTRY::Problem</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00092">_PENDING_RELATIONS_LIST_ENTRY::ProfileChangingEject</a>, <a class="el" href="../../d8/d0/pnprlist_8h-source.html#l00089">_PENDING_RELATIONS_LIST_ENTRY::RelationsList</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01545 {
01546     <a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a>   entry;
01547 
01548     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01549 
01550     entry = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PENDING_RELATIONS_LIST_ENTRY</a>) );
01551 
01552     <span class="keywordflow">if</span> (entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01553 
01554         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o3">DeviceObject</a> = DeviceObject;
01555         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
01556         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o6">Problem</a> = Problem;
01557         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o7">ProfileChangingEject</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01558 
01559         <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
01560 
01561         InsertTailList(&amp;IopPendingSurpriseRemovals, &amp;entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o0">Link</a>);
01562 
01563         <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
01564 
01565         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01566     }
01567 
01568     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01569 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a248" doxytag="pnpiop.h::IopReadDeviceConfiguration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopReadDeviceConfiguration           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCM_RESOURCE_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>CmResource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04283">4283</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00743">REGISTRY_ALLOC_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00745">REGISTRY_BOOT_CONFIG</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00744">REGISTRY_FORCED_CONFIG</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>.
<p>
<pre class="fragment"><div>04292                    :
04293 
04294     This routine read <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d3/d5/perfutil_8h.html#a9">ALLOC</a> config or ForcedConfig or Boot config.
04295 
04296 Arguments:
04297 
04298     Hanle - supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry key to read resources.
04299 
04300 Return Value:
04301 
04302     status
04303 
04304 --*/
04305 
04306 {
04307     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04308     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04309     PWCHAR valueName;
04310 
04311     *CmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04312     *Length = 0;
04313 
04314     <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a62">REGISTRY_ALLOC_CONFIG</a>) {
04315         valueName = REGSTR_VALUE_ALLOC_CONFIG;
04316     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a63">REGISTRY_FORCED_CONFIG</a>) {
04317         valueName = REGSTR_VALUE_FORCED_CONFIG;
04318     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a64">REGISTRY_BOOT_CONFIG</a>) {
04319         valueName = REGSTR_VALUE_BOOT_CONFIG;
04320     } <span class="keywordflow">else</span> {
04321         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
04322     }
04323 
04324     <span class="comment">//</span>
04325     <span class="comment">// Read the registry value of the desired value name</span>
04326     <span class="comment">//</span>
04327 
04328     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (Handle,
04329                                   valueName,
04330                                   &amp;keyValueInformation);
04331     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04332 
04333         <span class="comment">//</span>
04334         <span class="comment">// Try to read what caller wants.</span>
04335         <span class="comment">//</span>
04336 
04337         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_RESOURCE_LIST) &amp;&amp;
04338             (keyValueInformation-&gt;DataLength != 0)) {
04339             *CmResource = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
04340                                          keyValueInformation-&gt;DataLength);
04341             <span class="keywordflow">if</span> (*CmResource) {
04342                 <span class="keywordflow">if</span> (*CmResource) {
04343                     *Length = keyValueInformation-&gt;DataLength;
04344                     RtlMoveMemory(*CmResource,
04345                                   <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
04346                                   keyValueInformation-&gt;DataLength);
04347                 } <span class="keywordflow">else</span> {
04348                     status = STATUS_INSUFFICIENT_RESOURCES;
04349                 }
04350             }
04351             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04352             <span class="keywordflow">if</span> (*CmResource) {
04353                 PCM_RESOURCE_LIST resourceList;
04354                 PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04355                 PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
04356                 ULONG j, k, size, count;
04357 
04358                 <span class="comment">//</span>
04359                 <span class="comment">// Process the resource list read from Registry to change undefined</span>
04360                 <span class="comment">// interface type to our default interface type.</span>
04361                 <span class="comment">//</span>
04362 
04363                 resourceList = *CmResource;
04364                 cmFullDesc = &amp;resourceList-&gt;List[0];
04365                 <span class="keywordflow">for</span> (j = 0; j &lt; resourceList-&gt;Count; j++) {
04366                     <span class="keywordflow">if</span> (cmFullDesc-&gt;InterfaceType == InterfaceTypeUndefined) {
04367                         cmFullDesc-&gt;BusNumber = 0;
04368                         cmFullDesc-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04369                     }
04370                     cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04371                     <span class="keywordflow">for</span> (k = 0; k &lt; cmFullDesc-&gt;PartialResourceList.Count; k++) {
04372                         size = 0;
04373                         <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04374                         <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04375                              size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04376                              <span class="keywordflow">break</span>;
04377                         }
04378                         cmPartDesc++;
04379                         cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04380                     }
04381                     cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04382                 }
04383             }
04384         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (keyValueInformation-&gt;Type != REG_RESOURCE_LIST) {
04385             status = STATUS_UNSUCCESSFUL;
04386         }
04387     }
04388     <span class="keywordflow">return</span> status;
04389 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a298" doxytag="pnpiop.h::IopReallocateResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopReallocateResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">7470</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00447">DNF_ASSIGNING_RESOURCES</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00625">DNF_HAS_RESOURCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00473">DNF_NON_STOPPED_REBALANCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00453">DNF_RESOURCE_ASSIGNED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00459">DNF_RESOURCE_REPORTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00466">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00759">IOP_ASSIGN_KEEP_CURRENT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00757">IOP_ASSIGN_NO_REBALANCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01266">IopAcquireEnumerationLock</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00074">IopDeviceTreeLock</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01988">IopFreeResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00337">IopRegistrySemaphore</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01276">IopReleaseEnumerationLock</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05757">IopReleaseResourcesInternal()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00765">_IOP_RESOURCE_REQUEST::PhysicalDevice</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00771">_IOP_RESOURCE_REQUEST::ResourceAssignment</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00161">_DEVICE_NODE::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00163">_DEVICE_NODE::ResourceListTranslated</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00772">_IOP_RESOURCE_REQUEST::TranslatedResourceAssignment</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>.
<p>
<pre class="fragment"><div>07476                    :
07477 
07478     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real work <span class="keywordflow">for</span> <a class="code" href="../../d6/d9/pnp_8h.html#a154">IoInvalidateDeviceState</a> - <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a223">ResourceRequirementsChanged</a>.
07479 
07480 Arguments:
07481 
07482     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object.
07483 
07484 Return Value:
07485 
07486     None.
07487 
07488 --*/
07489 {
07490     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
07491     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> requestTable, *requestTablep;
07492     ULONG deviceCount, oldFlags;
07493     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
07494 
07495     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07496 
07497     <span class="comment">//</span>
07498     <span class="comment">// Grab the IO registry semaphore to make sure no other device is</span>
07499     <span class="comment">// reporting it's resource usage while we are searching for conflicts.</span>
07500     <span class="comment">//</span>
07501 
07502     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
07503     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;IopRegistrySemaphore,
07504                                     DelayExecution,
07505                                     KernelMode,
07506                                     FALSE,
07507                                     NULL);
07508     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07509 
07510         <span class="comment">//</span>
07511         <span class="comment">// Acquire the tree lock so we block remove for this device node.</span>
07512         <span class="comment">//</span>
07513 
07514         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;IopDeviceTreeLock, TRUE);
07515 
07516         <span class="comment">//</span>
07517         <span class="comment">// Check the flags after acquiring the semaphore.</span>
07518         <span class="comment">//</span>
07519 
07520         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>) {
07521             <span class="comment">//</span>
07522             <span class="comment">// Save the flags which we may have to restore in case of failure.</span>
07523             <span class="comment">//</span>
07524 
07525             oldFlags = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a46">DNF_HAS_RESOURCE</a>;
07526             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a46">DNF_HAS_RESOURCE</a>);
07527 
07528             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>) {
07529 
07530                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(deviceNode);
07531 
07532                 <span class="comment">//</span>
07533                 <span class="comment">// Set up parameters to call real routine</span>
07534                 <span class="comment">//</span>
07535 
07536                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
07537 
07538                 RtlZeroMemory(&amp;requestTable, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>));
07539                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> = DeviceObject;
07540                 requestTablep = &amp;requestTable;
07541                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a70">IOP_ASSIGN_NO_REBALANCE</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a72">IOP_ASSIGN_KEEP_CURRENT_CONFIG</a>;
07542 
07543                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a56">IopGetResourceRequirementsForAssignTable</a>(  requestTablep,
07544                                                                     requestTablep + 1,
07545                                                                     &amp;deviceCount);
07546                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; deviceCount) {
07547 
07548                     <span class="comment">//</span>
07549                     <span class="comment">// Release the current resources to the arbiters.</span>
07550                     <span class="comment">// Memory for ResourceList is not released.</span>
07551                     <span class="comment">//</span>
07552 
07553                     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
07554 
07555                         <a class="code" href="../../d5/d1/pnpres_8c.html#a87">IopReleaseResourcesInternal</a>(deviceNode);
07556                     }
07557 
07558                     <span class="comment">//</span>
07559                     <span class="comment">// Try to do the assignment.</span>
07560                     <span class="comment">//</span>
07561 
07562                     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a67">IopAssignInner</a>(deviceCount, requestTablep, FALSE);
07563                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07564 
07565                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>);
07566 
07567                         <a class="code" href="../../d5/d1/pnpres_8c.html#a65">IopBuildCmResourceLists</a>(requestTablep, requestTablep + 1);
07568 
07569                         <span class="comment">//</span>
07570                         <span class="comment">// We need to release the pool space for ResourceList and ResourceListTranslated.</span>
07571                         <span class="comment">// Because the earlier IopReleaseResourcesInternal does not release the pool.</span>
07572                         <span class="comment">//</span>
07573 
07574                         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
07575 
07576                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>);
07577 
07578                         }
07579                         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a>) {
07580 
07581                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a>);
07582 
07583                         }
07584 
07585                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = requestTablep-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>;
07586                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a> = requestTablep-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>;
07587                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>;
07588                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>;
07589 
07590                         <a class="code" href="../../d0/d1/pnpirp_8c.html#a19">IopStartDevice</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
07591 
07592                     } <span class="keywordflow">else</span> {
07593 
07594                         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> restoreResourcesStatus;
07595 
07596                         restoreResourcesStatus = <a class="code" href="../../d5/d1/pnpres_8c.html#a89">IopRestoreResourcesInternal</a>(deviceNode);
07597                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(restoreResourcesStatus)) {
07598 
07599                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(restoreResourcesStatus));
07600                             <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(DeviceObject, CM_PROB_NORMAL_CONFLICT);
07601 
07602                         }
07603 
07604                         <span class="comment">//</span>
07605                         <span class="comment">// BUGBUG - once we failed, what will trigger us to try again?</span>
07606                         <span class="comment">//</span>
07607                     }
07608 
07609                     <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(requestTablep, requestTablep + 1);
07610 
07611 
07612                 } <span class="keywordflow">else</span> {
07613 
07614                     status = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)? STATUS_UNSUCCESSFUL : status;
07615 
07616                 }
07617 
07618                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
07619                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(deviceNode);
07620 
07621             } <span class="keywordflow">else</span> {
07622 
07623                 <span class="comment">//</span>
07624                 <span class="comment">// The device needs to be stopped to change resources.</span>
07625                 <span class="comment">//</span>
07626 
07627                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a85">IopRebalance</a>(0, NULL);
07628 
07629             }
07630 
07631             <span class="comment">//</span>
07632             <span class="comment">// Restore the flags in case of failure.</span>
07633             <span class="comment">//</span>
07634 
07635             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07636 
07637                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a46">DNF_HAS_RESOURCE</a>;
07638                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= oldFlags;
07639 
07640             }
07641 
07642         } <span class="keywordflow">else</span> {
07643 
07644             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PNPRES: Resource requirements not changed in IopReallocateResources, returning error!\n"</span>));
07645         }
07646 
07647         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;IopDeviceTreeLock);
07648         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
07649 
07650     } <span class="keywordflow">else</span> {
07651 
07652         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PNPRES: IopReallocateResources failed to acquire Registry semaphore, status %08X\n"</span>, status));
07653 
07654     }
07655 
07656     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
07657 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a256" doxytag="pnpiop.h::IopReferenceDriverObjectByName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> IopReferenceDriverObjectByName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03686">3686</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d4/d4/iodata_8c-source.html#l00236">IoDriverObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>.
<p>
<pre class="fragment"><div>03692                    :
03693 
03694     This routine references a driver object by a given driver name.
03695 
03696 Arguments:
03697 
03698     DriverName - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver whose driver object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
03699         to be referenced.
03700 
03701 Returns:
03702 
03703     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> <span class="keywordflow">if</span> succeeds.  Otherwise, a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> value.
03704 
03705 --*/
03706 
03707 {
03708     OBJECT_ATTRIBUTES objectAttributes;
03709     HANDLE driverHandle;
03710     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03711     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
03712 
03713     <span class="comment">//</span>
03714     <span class="comment">// Make sure the driver name is valid.</span>
03715     <span class="comment">//</span>
03716 
03717     <span class="keywordflow">if</span> (DriverName-&gt;Length == 0) {
03718         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03719     }
03720 
03721     InitializeObjectAttributes(&amp;objectAttributes,
03722                                DriverName,
03723                                OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
03724                                NULL,
03725                                NULL
03726                                );
03727     status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(&amp;objectAttributes,
03728                                 IoDriverObjectType,
03729                                 KernelMode,
03730                                 NULL,
03731                                 FILE_READ_ATTRIBUTES,
03732                                 NULL,
03733                                 &amp;driverHandle
03734                                 );
03735     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03736 
03737         <span class="comment">//</span>
03738         <span class="comment">// Now reference the driver object.</span>
03739         <span class="comment">//</span>
03740 
03741         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(driverHandle,
03742                                            0,
03743                                            IoDriverObjectType,
03744                                            KernelMode,
03745                                            &amp;driverObject,
03746                                            NULL
03747                                            );
03748         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(driverHandle);
03749     }
03750 
03751     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03752         <span class="keywordflow">return</span> driverObject;
03753     } <span class="keywordflow">else</span> {
03754         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03755     }
03756 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a352" doxytag="pnpiop.h::IopRegisterDeviceInterface" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRegisterDeviceInterface           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceInstanceName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CONST GUID *&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceClassGuid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING ReferenceString&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UserModeFormat</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SymbolicLinkName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03929">3929</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05137">IopBuildSymbolicLinkStrings()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05668">IopFreeAllocatedUnicodeString()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04741">IopOpenOrCreateDeviceInterfaceSubKeys()</a>, <a class="el" href="../../d8/d0/pnpioapi_8c.html#a67">IopSetRegistryStringValue()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d2/d6/guid_8c-source.html#l00051">RtlStringFromGUID()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03835">IoRegisterDeviceInterface()</a>.
<p>
<pre class="fragment"><div>03939                    :
03940 
03941     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker routine <span class="keywordflow">for</span> PnpRegisterDeviceInterface.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also
03942     called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user-mode ConfigMgr (via an NtPlugPlayControl), which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> why <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
03943     must take a device instance name instead of a PDO (since the device instance
03944     may not currently be 'live'), and also why <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must optionally <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user-
03945     mode form of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface device name (i.e., <span class="stringliteral">"\\?\" instead of "</span>\??\<span class="stringliteral">").</span>
03946 <span class="stringliteral"></span>
03947 <span class="stringliteral">Parameters:</span>
03948 <span class="stringliteral"></span>
03949 <span class="stringliteral">    DeviceInstanceName - Supplies the name of the device instance for which a</span>
03950 <span class="stringliteral">        device interface is being registered.</span>
03951 <span class="stringliteral"></span>
03952 <span class="stringliteral">    InterfaceClassGuid - Supplies a pointer to the GUID representring the class</span>
03953 <span class="stringliteral">        of the device interface being registered.</span>
03954 <span class="stringliteral"></span>
03955 <span class="stringliteral">    ReferenceString - Optionally, supplies an additional context string which is</span>
03956 <span class="stringliteral">        appended to the enumeration path of the device</span>
03957 <span class="stringliteral"></span>
03958 <span class="stringliteral">    UserModeFormat - If non-zero, then the symbolic link name returned for the</span>
03959 <span class="stringliteral">        interface device is in user-mode form (i.e., "</span>\\?\<span class="stringliteral">").  If zero (FALSE),</span>
03960 <span class="stringliteral">        it is in kernel-mode form (i.e., "</span>\??\<span class="stringliteral">").</span>
03961 <span class="stringliteral"></span>
03962 <span class="stringliteral">    SymbolicLinkName - Supplies a pointer to a string which on success will contain</span>
03963 <span class="stringliteral">        either the kernel-mode or user-mode path of the symbolic link used to open</span>
03964 <span class="stringliteral">        this device.</span>
03965 <span class="stringliteral"></span>
03966 <span class="stringliteral">Return Value:</span>
03967 <span class="stringliteral"></span>
03968 <span class="stringliteral">    Status code that indicates whether or not the function was successful.</span>
03969 <span class="stringliteral"></span>
03970 <span class="stringliteral">--*/</span>
03971 <span class="stringliteral"></span>
03972 <span class="stringliteral">{</span>
03973 <span class="stringliteral">    NTSTATUS status;</span>
03974 <span class="stringliteral">    UNICODE_STRING tempString, guidString, otherString;</span>
03975 <span class="stringliteral">    PUNICODE_STRING pUserString, pKernelString;</span>
03976 <span class="stringliteral">    HANDLE hTemp1, hTemp2, hInterfaceInstanceKey;</span>
03977 <span class="stringliteral">    ULONG InterfaceDisposition, InterfaceInstanceDisposition;</span>
03978 <span class="stringliteral"></span>
03979 <span class="stringliteral">    PAGED_CODE();</span>
03980 <span class="stringliteral"></span>
03981 <span class="stringliteral">    //</span>
03982 <span class="stringliteral">    // Convert the class guid into string form</span>
03983 <span class="stringliteral">    //</span>
03984 <span class="stringliteral"></span>
03985 <span class="stringliteral">    status = RtlStringFromGUID(InterfaceClassGuid, &amp;guidString);</span>
03986 <span class="stringliteral">    if( !NT_SUCCESS(status) ){</span>
03987 <span class="stringliteral">        goto clean0;</span>
03988 <span class="stringliteral">    }</span>
03989 <span class="stringliteral"></span>
03990 <span class="stringliteral">    //</span>
03991 <span class="stringliteral">    // Construct both flavors of symbolic link name (go ahead and store the form</span>
03992 <span class="stringliteral">    // that the user wants in the SymbolicLinkName parameter they supplied--this</span>
03993 <span class="stringliteral">    // saves us from having to copy the appropriate string over to their string</span>
03994 <span class="stringliteral">    // later).</span>
03995 <span class="stringliteral">    //</span>
03996 <span class="stringliteral">    if(UserModeFormat) {</span>
03997 <span class="stringliteral">        pUserString = SymbolicLinkName;</span>
03998 <span class="stringliteral">        pKernelString = &amp;otherString;</span>
03999 <span class="stringliteral">    } else {</span>
04000 <span class="stringliteral">        pKernelString = SymbolicLinkName;</span>
04001 <span class="stringliteral">        pUserString = &amp;otherString;</span>
04002 <span class="stringliteral">    }</span>
04003 <span class="stringliteral"></span>
04004 <span class="stringliteral">    status = IopBuildSymbolicLinkStrings(DeviceInstanceName,</span>
04005 <span class="stringliteral">                                         &amp;guidString,</span>
04006 <span class="stringliteral">                                         ReferenceString,</span>
04007 <span class="stringliteral">                                         pUserString,</span>
04008 <span class="stringliteral">                                         pKernelString</span>
04009 <span class="stringliteral">                                         );</span>
04010 <span class="stringliteral">    if (!NT_SUCCESS(status)) {</span>
04011 <span class="stringliteral">        goto clean1;</span>
04012 <span class="stringliteral">    }</span>
04013 <span class="stringliteral"></span>
04014 <span class="stringliteral">    //</span>
04015 <span class="stringliteral">    // Enter critical section and acquire a lock on the registry.  Both these</span>
04016 <span class="stringliteral">    // mechanisms are required to prevent deadlock in the case where an APC</span>
04017 <span class="stringliteral">    // routine calls this routine after the registry resource has been claimed</span>
04018 <span class="stringliteral">    // in this case it would wait blocking this thread so the registry would</span>
04019 <span class="stringliteral">    // never be released -&gt; deadlock.  Critical sectioning the registry manipulation</span>
04020 <span class="stringliteral">    // portion solves this problem</span>
04021 <span class="stringliteral">    //</span>
04022 <span class="stringliteral"></span>
04023 <span class="stringliteral">    KeEnterCriticalRegion();</span>
04024 <span class="stringliteral">    ExAcquireResourceExclusive(&amp;PpRegistryDeviceResource, TRUE);</span>
04025 <span class="stringliteral"></span>
04026 <span class="stringliteral">    //</span>
04027 <span class="stringliteral">    // Open HKLM\System\CurrentControlSet\Control\DeviceClasses key into hTemp1</span>
04028 <span class="stringliteral">    //</span>
04029 <span class="stringliteral"></span>
04030 <span class="stringliteral">    PiWstrToUnicodeString(&amp;tempString, REGSTR_FULL_PATH_DEVICE_CLASSES);</span>
04031 <span class="stringliteral">    status = IopCreateRegistryKeyEx( &amp;hTemp1,</span>
04032 <span class="stringliteral">                                     NULL,</span>
04033 <span class="stringliteral">                                     &amp;tempString,</span>
04034 <span class="stringliteral">                                     KEY_CREATE_SUB_KEY,</span>
04035 <span class="stringliteral">                                     REG_OPTION_NON_VOLATILE,</span>
04036 <span class="stringliteral">                                     NULL</span>
04037 <span class="stringliteral">                                     );</span>
04038 <span class="stringliteral"></span>
04039 <span class="stringliteral">    if( !NT_SUCCESS(status) ){</span>
04040 <span class="stringliteral">        goto clean2;</span>
04041 <span class="stringliteral">    }</span>
04042 <span class="stringliteral"></span>
04043 <span class="stringliteral">    //</span>
04044 <span class="stringliteral">    // Open/create function class GUID key into hTemp2</span>
04045 <span class="stringliteral">    //</span>
04046 <span class="stringliteral"></span>
04047 <span class="stringliteral">    status = IopCreateRegistryKeyEx( &amp;hTemp2,</span>
04048 <span class="stringliteral">                                     hTemp1,</span>
04049 <span class="stringliteral">                                     &amp;guidString,</span>
04050 <span class="stringliteral">                                     KEY_CREATE_SUB_KEY,</span>
04051 <span class="stringliteral">                                     REG_OPTION_NON_VOLATILE,</span>
04052 <span class="stringliteral">                                     NULL</span>
04053 <span class="stringliteral">                                     );</span>
04054 <span class="stringliteral">    ZwClose(hTemp1);</span>
04055 <span class="stringliteral"></span>
04056 <span class="stringliteral">    if( !NT_SUCCESS(status) ){</span>
04057 <span class="stringliteral">        goto clean2;</span>
04058 <span class="stringliteral">    }</span>
04059 <span class="stringliteral"></span>
04060 <span class="stringliteral">    //</span>
04061 <span class="stringliteral">    // Now open/create the two-level device interface hierarchy underneath this</span>
04062 <span class="stringliteral">    // interface class key.</span>
04063 <span class="stringliteral">    //</span>
04064 <span class="stringliteral">    status = IopOpenOrCreateDeviceInterfaceSubKeys(&amp;hTemp1,</span>
04065 <span class="stringliteral">                                                   &amp;InterfaceDisposition,</span>
04066 <span class="stringliteral">                                                   &amp;hInterfaceInstanceKey,</span>
04067 <span class="stringliteral">                                                   &amp;InterfaceInstanceDisposition,</span>
04068 <span class="stringliteral">                                                   hTemp2,</span>
04069 <span class="stringliteral">                                                   pUserString,</span>
04070 <span class="stringliteral">                                                   KEY_WRITE | DELETE,</span>
04071 <span class="stringliteral">                                                   TRUE</span>
04072 <span class="stringliteral">                                                  );</span>
04073 <span class="stringliteral"></span>
04074 <span class="stringliteral">    ZwClose(hTemp2);</span>
04075 <span class="stringliteral"></span>
04076 <span class="stringliteral">    if(!NT_SUCCESS(status)) {</span>
04077 <span class="stringliteral">        goto clean2;</span>
04078 <span class="stringliteral">    }</span>
04079 <span class="stringliteral"></span>
04080 <span class="stringliteral">    //</span>
04081 <span class="stringliteral">    // Create the device instance value under the device interface key</span>
04082 <span class="stringliteral">    //</span>
04083 <span class="stringliteral"></span>
04084 <span class="stringliteral">    PiWstrToUnicodeString(&amp;tempString, REGSTR_VAL_DEVICE_INSTANCE);</span>
04085 <span class="stringliteral">    status = IopSetRegistryStringValue(hTemp1,</span>
04086 <span class="stringliteral">                                       &amp;tempString,</span>
04087 <span class="stringliteral">                                       DeviceInstanceName</span>
04088 <span class="stringliteral">                                       );</span>
04089 <span class="stringliteral">    if(!NT_SUCCESS(status)) {</span>
04090 <span class="stringliteral">        goto clean3;</span>
04091 <span class="stringliteral">    }</span>
04092 <span class="stringliteral"></span>
04093 <span class="stringliteral">    //</span>
04094 <span class="stringliteral">    // Create symbolic link value under interface instance subkey</span>
04095 <span class="stringliteral">    //</span>
04096 <span class="stringliteral"></span>
04097 <span class="stringliteral">    PiWstrToUnicodeString(&amp;tempString, REGSTR_VAL_SYMBOLIC_LINK);</span>
04098 <span class="stringliteral">    status = IopSetRegistryStringValue(hInterfaceInstanceKey,</span>
04099 <span class="stringliteral">                                       &amp;tempString,</span>
04100 <span class="stringliteral">                                       pUserString</span>
04101 <span class="stringliteral">                                       );</span>
04102 <span class="stringliteral"></span>
04103 <span class="stringliteral">clean3:</span>
04104 <span class="stringliteral">    if (!NT_SUCCESS(status)) {</span>
04105 <span class="stringliteral">        //</span>
04106 <span class="stringliteral">        // Since we failed to register the device interface, delete any keys</span>
04107 <span class="stringliteral">        // that were newly created in the attempt.</span>
04108 <span class="stringliteral">        //</span>
04109 <span class="stringliteral">        if(InterfaceInstanceDisposition == REG_CREATED_NEW_KEY) {</span>
04110 <span class="stringliteral">            ZwDeleteKey(hInterfaceInstanceKey);</span>
04111 <span class="stringliteral">        } else {</span>
04112 <span class="stringliteral">            ZwClose(hInterfaceInstanceKey);</span>
04113 <span class="stringliteral">        }</span>
04114 <span class="stringliteral"></span>
04115 <span class="stringliteral">        if(InterfaceDisposition == REG_CREATED_NEW_KEY) {</span>
04116 <span class="stringliteral">            ZwDeleteKey(hTemp1);</span>
04117 <span class="stringliteral">        } else {</span>
04118 <span class="stringliteral">            ZwClose(hTemp1);</span>
04119 <span class="stringliteral">        }</span>
04120 <span class="stringliteral">    } else {</span>
04121 <span class="stringliteral">        ZwClose(hInterfaceInstanceKey);</span>
04122 <span class="stringliteral">        ZwClose(hTemp1);</span>
04123 <span class="stringliteral">    }</span>
04124 <span class="stringliteral"></span>
04125 <span class="stringliteral">clean2:</span>
04126 <span class="stringliteral">    ExReleaseResource(&amp;PpRegistryDeviceResource);</span>
04127 <span class="stringliteral">    KeLeaveCriticalRegion();</span>
04128 <span class="stringliteral">    IopFreeAllocatedUnicodeString(&amp;otherString);</span>
04129 <span class="stringliteral">    if (!NT_SUCCESS(status)) {</span>
04130 <span class="stringliteral">        IopFreeAllocatedUnicodeString(SymbolicLinkName);</span>
04131 <span class="stringliteral">    }</span>
04132 <span class="stringliteral"></span>
04133 <span class="stringliteral">clean1:</span>
04134 <span class="stringliteral">    RtlFreeUnicodeString(&amp;guidString);</span>
04135 <span class="stringliteral">clean0:</span>
04136 <span class="stringliteral">    return status;</span>
04137 <span class="stringliteral">}</span>
</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a244" doxytag="pnpiop.h::IopRegMultiSzToUnicodeStrings" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRegMultiSzToUnicodeStrings           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKEY_VALUE_FULL_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING *&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeStringList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeStringCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a279" doxytag="pnpiop.h::IopReleaseDeviceResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopReleaseDeviceResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReserveResources</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">263</a> of file <a class="el" href="../../d3/d9/pnpdd_8c-source.html">pnpdd.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a125">ArbiterRequestUndefined</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00421">DNF_BOOT_CONFIG_RESERVED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00037">IoPnpDriverObject</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00142">IopResourcesReleased</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00740">QUERY_RESOURCE_LIST</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">IopDeleteLegacyKey()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03125">IopDisableDevice()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>00270                    :
00271 
00272     This routine releases <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources assigned to a device.
00273 
00274 Arguments:
00275 
00276     DeviceObject - supplies a pointer to a device whose resources are to be released.
00277 
00278     ReserveResources - indicates whether we need to re-query and reserve BOOT config <span class="keywordflow">for</span> DeviceObject.
00279 
00280 Return Value:
00281 
00282     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00283 
00284 
00285 --*/
00286 {
00287     BOOLEAN             conflict;
00288     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status= STATUS_SUCCESS;
00289     PCM_RESOURCE_LIST   cmResource;
00290     ULONG               cmLength;
00291 
00292     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00293 
00294     <span class="keywordflow">if</span> (DeviceNode-&gt;ResourceList || (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a13">DNF_BOOT_CONFIG_RESERVED</a>)) {
00295 
00296         cmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00297         cmLength = 0;
00298 
00299         <span class="comment">//</span>
00300         <span class="comment">// If needed, re-query for BOOT configs. We need to do this BEFORE we</span>
00301         <span class="comment">// release the BOOT config (otherwise ROOT devices cannot report BOOT</span>
00302         <span class="comment">// config).</span>
00303         <span class="comment">//</span>
00304 
00305         <span class="keywordflow">if</span> (ReserveResources &amp;&amp; !(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>)) {
00306 
00307             <span class="comment">//</span>
00308             <span class="comment">// First query for new BOOT config (order important for ROOT devices).</span>
00309             <span class="comment">//</span>
00310 
00311             status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a27">IopQueryDeviceResources</a> (  DeviceNode-&gt;PhysicalDeviceObject,
00312                                                 QUERY_RESOURCE_LIST,
00313                                                 &amp;cmResource,
00314                                                 &amp;cmLength);
00315 
00316             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00317 
00318                 cmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00319                 cmLength = 0;
00320 
00321             }
00322         }
00323 
00324         <span class="comment">//</span>
00325         <span class="comment">// Release resources for this device.</span>
00326         <span class="comment">//</span>
00327 
00328         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a107">IopLegacyResourceAllocation</a>(   ArbiterRequestUndefined,
00329                                                 IoPnpDriverObject,
00330                                                 DeviceNode-&gt;PhysicalDeviceObject,
00331                                                 NULL,
00332                                                 NULL);
00333         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00334 
00335             <a class="code" href="../../d1/d0/pnpdata_8c.html#a19">IopResourcesReleased</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;        <span class="comment">// Signal there are resources available.</span>
00336 
00337             <span class="comment">//</span>
00338             <span class="comment">// If needed, re-query and reserve current BOOT config for this device.</span>
00339             <span class="comment">// We always rereserve the boot config (ie DNF_MADEUP root enumerated</span>
00340             <span class="comment">// and IoReportDetected) devices in IopLegacyResourceAllocation.</span>
00341             <span class="comment">//</span>
00342 
00343             <span class="keywordflow">if</span> (ReserveResources &amp;&amp; !(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>)) {
00344 
00345                 UNICODE_STRING      unicodeName;
00346                 HANDLE              logConfHandle;
00347                 HANDLE              handle;
00348 
00349                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;BootResources == NULL);
00350 
00351                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceNode-&gt;PhysicalDeviceObject, &amp;handle, KEY_ALL_ACCESS);
00352                 logConfHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00353                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00354 
00355 
00356                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
00357                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;logConfHandle,
00358                                                      handle,
00359                                                      &amp;unicodeName,
00360                                                      KEY_ALL_ACCESS,
00361                                                      REG_OPTION_NON_VOLATILE,
00362                                                      NULL);
00363                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00364 
00365                         logConfHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00366 
00367                     }
00368                 }
00369 
00370                 <span class="keywordflow">if</span> (logConfHandle) {
00371 
00372                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_BOOTCONFIG);
00373                     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00374                     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
00375                     <span class="keywordflow">if</span> (cmResource) {
00376 
00377                         ZwSetValueKey(  logConfHandle,
00378                                         &amp;unicodeName,
00379                                         TITLE_INDEX_VALUE,
00380                                         REG_RESOURCE_LIST,
00381                                         cmResource,
00382                                         cmLength);
00383                     } <span class="keywordflow">else</span> {
00384 
00385                         ZwDeleteValueKey(logConfHandle, &amp;unicodeName);
00386 
00387                     }
00388                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
00389                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00390 
00391                     ZwClose(logConfHandle);
00392                 }
00393 
00394                 <span class="comment">//</span>
00395                 <span class="comment">// Reserve any remaining BOOT config.</span>
00396                 <span class="comment">//</span>
00397 
00398                 <span class="keywordflow">if</span> (cmResource) {
00399 
00400                     DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>;
00401                     DeviceNode-&gt;BootResources = cmResource;
00402 
00403                     <span class="comment">//</span>
00404                     <span class="comment">// This device consumes BOOT resources.  Reserve its boot resources</span>
00405                     <span class="comment">//</span>
00406 
00407                     (*IopReserveResourcesRoutine)(  <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>,
00408                                                     DeviceNode-&gt;PhysicalDeviceObject,
00409                                                     cmResource);
00410                 }
00411             }
00412         }
00413     }
00414 
00415     <span class="keywordflow">return</span> status;
00416 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a266" doxytag="pnpiop.h::IopRemoveDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRemoveDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetDevice</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpMinorCode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">927</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00147">ASSERTMSG</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00493">DNF_LEGACY_DRIVER</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00500">DNF_NEED_ENUMERATION_ONLY</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00402">DNF_NEED_QUERY_IDS</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00610">DNUF_NOT_DISABLEABLE</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03152">IopDecDisableableDepends()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01316">IopFindMountableDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04710">IopInvalidateVolumesForDevice()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01080">IopLockMountedDeviceForRemove()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00191">IopUncacheInterfaceInformation()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01233">IopUnlockMountedDeviceForRemove()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00163">IRP_MN_CANCEL_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00178">IRP_MN_EJECT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00161">IRP_MN_QUERY_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00184">IRP_MN_SURPRISE_REMOVAL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00136">_DEVICE_NODE::UserFlags</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03125">IopDisableDevice()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>00934                    :
00935 
00936     This function sends a requested DeviceRemoval related irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top level device
00937     object which roots on TargetDevice.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a> associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00938     TargetDevice, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding filesystem's VDO will be used.  Otherwise
00939     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp will be sent directly to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target device/ or its assocated device
00940     object.
00941 
00942 Parameters:
00943 
00944     TargetDevice - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being removed.
00945 
00946     Operation - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation requested.
00947         The following <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> codes are used with <a class="code" href="../../d0/d5/io_8h.html#a37">IRP_MJ_DEVICE_CHANGE</a> <span class="keywordflow">for</span> removing
00948         devices:
00949             <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>
00950             <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>
00951             <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>
00952             <a class="code" href="../../d0/d5/io_8h.html#a81">IRP_MN_EJECT</a>
00953 Return Value:
00954 
00955     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00956 
00957 --*/
00958 {
00959     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00960     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00961     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
00962     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00963 
00964     BOOLEAN isMountable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00965     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> mountedDevice;
00966 
00967     PVOID <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
00968     <a class="code" href="../../d7/d2/struct__LOCK__MOUNTABLE__DEVICE__CONTEXT.html">LOCK_MOUNTABLE_DEVICE_CONTEXT</a> lockContext;
00969 
00970     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00971 
00972     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IrpMinorCode == IRP_MN_QUERY_REMOVE_DEVICE ||
00973            IrpMinorCode == IRP_MN_CANCEL_REMOVE_DEVICE ||
00974            IrpMinorCode == IRP_MN_REMOVE_DEVICE ||
00975            IrpMinorCode == IRP_MN_SURPRISE_REMOVAL ||
00976            IrpMinorCode == IRP_MN_EJECT);
00977 
00978     <span class="keywordflow">if</span> (IrpMinorCode == <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a> ||
00979         IrpMinorCode == <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>) {
00980         <a class="code" href="../../d0/d1/pnpirp_8c.html#a17">IopUncacheInterfaceInformation</a>(TargetDevice);
00981     }
00982 
00983     <span class="comment">//</span>
00984     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
00985     <span class="comment">//</span>
00986 
00987     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
00988 
00989     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
00990     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = (UCHAR)IrpMinorCode;
00991 
00992     <span class="comment">//</span>
00993     <span class="comment">// BUGBUG - this should probably go at a higher level but then it goes</span>
00994     <span class="comment">// in way too many places.  The only thing we do to the VPB is make sure</span>
00995     <span class="comment">// that it won't go away while the operation is in the file system and</span>
00996     <span class="comment">// that no one new can mount on the device if the FS decides to bail out.</span>
00997     <span class="comment">//</span>
00998 
00999     <span class="comment">//</span>
01000     <span class="comment">// Check to see if there's a VPB anywhere in the device stack.  If there</span>
01001     <span class="comment">// is then we'll have to lock the stack.</span>
01002     <span class="comment">//</span>
01003 
01004     mountedDevice = <a class="code" href="../../d0/d1/pnpirp_8c.html#a13">IopFindMountableDevice</a>(TargetDevice);
01005 
01006     <span class="keywordflow">if</span> (mountedDevice != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01007 
01008         <span class="comment">//</span>
01009         <span class="comment">// This routine will cause any mount operations on the VPB to fail.</span>
01010         <span class="comment">// It will also release the VPB spinlock.</span>
01011         <span class="comment">//</span>
01012 
01013         mountedDevice = <a class="code" href="../../d0/d1/pnpirp_8c.html#a14">IopLockMountedDeviceForRemove</a>(TargetDevice,
01014                                                       IrpMinorCode,
01015                                                       &amp;lockContext);
01016 
01017         isMountable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01018 
01019     } <span class="keywordflow">else</span> {
01020         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"Mass storage device does not have VPB - this is odd"</span>,
01021                   !((TargetDevice-&gt;Type == FILE_DEVICE_DISK) ||
01022                     (TargetDevice-&gt;Type == FILE_DEVICE_CD_ROM) ||
01023                     (TargetDevice-&gt;Type == FILE_DEVICE_TAPE) ||
01024                     (TargetDevice-&gt;Type == FILE_DEVICE_VIRTUAL_DISK)));
01025 
01026         mountedDevice = TargetDevice;
01027     }
01028 
01029     <span class="comment">//</span>
01030     <span class="comment">// Make the call and return.</span>
01031     <span class="comment">//</span>
01032 
01033     <span class="keywordflow">if</span> (IrpMinorCode == <a class="code" href="../../d0/d5/io_8h.html#a87">IRP_MN_SURPRISE_REMOVAL</a> || IrpMinorCode == <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>) {
01034         <span class="comment">//</span>
01035         <span class="comment">// if device was not disableable, we cleanup the tree</span>
01036         <span class="comment">// and debug-trace that we surprise-removed a non-disableable device</span>
01037         <span class="comment">//</span>
01038         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = TargetDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01039 
01040         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o7">UserFlags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a40">DNUF_NOT_DISABLEABLE</a>) {
01041             <span class="comment">//</span>
01042             <span class="comment">// this device was marked as disableable, update the depends</span>
01043             <span class="comment">// before this device disappears</span>
01044             <span class="comment">// (by momentarily marking this node as disableable)</span>
01045             <span class="comment">//</span>
01046             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o7">UserFlags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a40">DNUF_NOT_DISABLEABLE</a>;
01047             <a class="code" href="../../d0/d1/pnpirp_8c.html#a34">IopDecDisableableDepends</a>(deviceNode);
01048         }
01049     }
01050 
01051     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(mountedDevice, &amp;irpSp, &amp;dummy);
01052 
01053     <span class="keywordflow">if</span> (isMountable) {
01054 
01055         <a class="code" href="../../d0/d1/pnpirp_8c.html#a15">IopUnlockMountedDeviceForRemove</a>(TargetDevice,
01056                                         IrpMinorCode,
01057                                         &amp;lockContext);
01058 
01059         <span class="comment">//</span>
01060         <span class="comment">// Succesful query should follow up with invalidation of all volumes</span>
01061         <span class="comment">// which have been on this device but which are not currently mounted.</span>
01062         <span class="comment">//</span>
01063 
01064         <span class="keywordflow">if</span> (IrpMinorCode == <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a> &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01065 
01066             status = <a class="code" href="../../d0/d6/iop_8h.html#a189">IopInvalidateVolumesForDevice</a>( TargetDevice );
01067         }
01068     }
01069 
01070     <span class="keywordflow">if</span> (IrpMinorCode == <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>) {
01071         ((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)TargetDevice-&gt;DeviceObjectExtension-&gt;DeviceNode)-&gt;Flags &amp;=
01072             ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a25">DNF_NEED_ENUMERATION_ONLY</a>);
01073     }
01074 
01075     <span class="keywordflow">return</span> status;
01076 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a354" doxytag="pnpiop.h::IopRemoveDeviceInterfaces" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRemoveDeviceInterfaces           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceInstancePath</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">4414</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02394">_BUFFER_INFO::Buffer</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00444">DEVICE_INTERFACE_INCLUDE_NONACTIVE</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00129">INITIAL_INFO_BUFFER_SIZE</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02427">IopAllocateBuffer()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05619">IopAllocateUnicodeString()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05902">IopDeleteKeyRecursive()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05668">IopFreeAllocatedUnicodeString()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02536">IopFreeBuffer()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02707">IopGetDeviceInterfaces()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02467">IopResizeBuffer()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04140">IopUnregisterDeviceInterface()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02406">_BUFFER_INFO::MaxSize</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d2/d6/guid_8c-source.html#l00191">RtlGUIDFromString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>04420                    :
04421 
04422     This routine checks all device <span class="keyword">class </span>keys under
04423     HKLM\SYSTEM\CCS\Control\DeviceClasses for interfaces for which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04424     DeviceInstance value matches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied DeviceInstancePath.  Instances of
04425     such device interfaces are unregistered, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device interface subkey
04426     itself <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed.
04427 
04428     Note that a lock on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry must have already been acquired,
04429     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller of this routine.
04430 
04431 Parameters:
04432 
04433     DeviceInterfacePath - Supplies a pointer to a unicode string which
04434         contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceInterface name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device for which
04435         interfaces to are to be removed.
04436 
04437 Return Value:
04438 
04439     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was
04440     successful.
04441 
04442 --*/
04443 
04444 {
04445     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>       status, context;
04446     HANDLE         hDeviceClasses=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hClassGUID=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hInterface=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04447     UNICODE_STRING tempString, guidString, interfaceString, deviceInstanceString;
04448     ULONG          resultSize, classIndex, interfaceIndex;
04449     ULONG          symbolicLinkListSize;
04450     PWCHAR         symbolicLinkList, symLink;
04451     <a class="code" href="../../d4/d5/struct__BUFFER__INFO.html">BUFFER_INFO</a>    classInfoBuffer, interfaceInfoBuffer;
04452     PKEY_VALUE_FULL_INFORMATION deviceInstanceInfo;
04453     BOOLEAN        deletedInterface;
04454     GUID           classGUID;
04455 
04456     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04457 
04458     <span class="comment">//</span>
04459     <span class="comment">// Allocate initial buffers</span>
04460     <span class="comment">//</span>
04461     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a>(&amp;classInfoBuffer,
04462                                INITIAL_INFO_BUFFER_SIZE);
04463     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04464         <span class="keywordflow">goto</span> clean0;
04465     }
04466 
04467     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a>(&amp;interfaceInfoBuffer,
04468                                INITIAL_INFO_BUFFER_SIZE);
04469     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04470         <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;classInfoBuffer);
04471         <span class="keywordflow">goto</span> clean0;
04472     }
04473 
04474     <span class="comment">//</span>
04475     <span class="comment">// Open HKLM\System\CurrentControlSet\Control\DeviceClasses</span>
04476     <span class="comment">//</span>
04477     PiWstrToUnicodeString(&amp;tempString, REGSTR_FULL_PATH_DEVICE_CLASSES);
04478     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hDeviceClasses,
04479                                    NULL,
04480                                    &amp;tempString,
04481                                    KEY_READ
04482                                    );
04483     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)){
04484         <span class="keywordflow">goto</span> clean1;
04485     }
04486 
04487     <span class="comment">//</span>
04488     <span class="comment">// Enumerate all device classes</span>
04489     <span class="comment">//</span>
04490     classIndex = 0;
04491 
04492     <span class="keywordflow">while</span>((status = ZwEnumerateKey(hDeviceClasses,
04493                                    classIndex,
04494                                    KeyBasicInformation,
04495                                    (PVOID) classInfoBuffer.Buffer,
04496                                    classInfoBuffer.MaxSize,
04497                                    &amp;resultSize)) != STATUS_NO_MORE_ENTRIES) {
04498 
04499         <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL) {
04500             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(&amp;classInfoBuffer, resultSize, FALSE);
04501             <span class="keywordflow">continue</span>;
04502         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04503             <span class="keywordflow">goto</span> clean1;
04504         }
04505 
04506         <span class="comment">//</span>
04507         <span class="comment">// Get the key name for this device class</span>
04508         <span class="comment">//</span>
04509         guidString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((PKEY_BASIC_INFORMATION)(classInfoBuffer.Buffer))-&gt;NameLength;
04510         guidString.MaximumLength = guidString.Length;
04511         guidString.Buffer = ((PKEY_BASIC_INFORMATION)(classInfoBuffer.Buffer))-&gt;Name;
04512 
04513         <span class="comment">//</span>
04514         <span class="comment">// Open the key for this device class</span>
04515         <span class="comment">//</span>
04516         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hClassGUID,
04517                                        hDeviceClasses,
04518                                        &amp;guidString,
04519                                        KEY_ALL_ACCESS
04520                                        );
04521         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04522             <span class="comment">//</span>
04523             <span class="comment">// Couldn't open key for this device class -- skip it and move on.</span>
04524             <span class="comment">//</span>
04525             <span class="keywordflow">goto</span> CloseClassKeyAndContinue;
04526         }
04527 
04528         <span class="comment">//</span>
04529         <span class="comment">// Enumerate all device interfaces for this device class</span>
04530         <span class="comment">//</span>
04531         interfaceIndex = 0;
04532 
04533         <span class="keywordflow">while</span>((status = ZwEnumerateKey(hClassGUID,
04534                                        interfaceIndex,
04535                                        KeyBasicInformation,
04536                                        (PVOID) interfaceInfoBuffer.Buffer,
04537                                        interfaceInfoBuffer.MaxSize,
04538                                        &amp;resultSize)) != STATUS_NO_MORE_ENTRIES) {
04539 
04540             <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL) {
04541                 status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(&amp;interfaceInfoBuffer, resultSize, FALSE);
04542                 <span class="keywordflow">continue</span>;
04543             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04544                 <span class="keywordflow">goto</span> clean1;
04545             }
04546 
04547             <span class="comment">//</span>
04548             <span class="comment">// This interface key has not yet been deleted</span>
04549             <span class="comment">//</span>
04550             deletedInterface = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04551 
04552             <span class="comment">//</span>
04553             <span class="comment">// Create a NULL-terminated unicode string for the interface key name</span>
04554             <span class="comment">//</span>
04555             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a373">IopAllocateUnicodeString</a>(&amp;interfaceString,
04556                                               (USHORT)((PKEY_BASIC_INFORMATION)(interfaceInfoBuffer.Buffer))-&gt;NameLength);
04557 
04558             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04559                 <span class="keywordflow">goto</span> clean1;
04560             }
04561 
04562             interfaceString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((PKEY_BASIC_INFORMATION)(interfaceInfoBuffer.Buffer))-&gt;NameLength;
04563             interfaceString.MaximumLength = interfaceString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
04564             RtlCopyMemory(interfaceString.Buffer,
04565                           ((PKEY_BASIC_INFORMATION)(interfaceInfoBuffer.Buffer))-&gt;Name,
04566                           interfaceString.Length);
04567             interfaceString.Buffer[interfaceString.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
04568 
04569             <span class="comment">//</span>
04570             <span class="comment">// Open the device interface key</span>
04571             <span class="comment">//</span>
04572             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hInterface,
04573                                            hClassGUID,
04574                                            &amp;interfaceString,
04575                                            KEY_ALL_ACCESS
04576                                            );
04577             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04578                 <span class="comment">//</span>
04579                 <span class="comment">// Couldn't open the device interface key -- skip it and move on.</span>
04580                 <span class="comment">//</span>
04581                 hInterface = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04582                 <span class="keywordflow">goto</span> CloseInterfaceKeyAndContinue;
04583             }
04584 
04585             <span class="comment">//</span>
04586             <span class="comment">// Get the DeviceInstance value for this interface key</span>
04587             <span class="comment">//</span>
04588             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hInterface,
04589                                          REGSTR_VAL_DEVICE_INSTANCE,
04590                                          &amp;deviceInstanceInfo);
04591 
04592             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04593                 <span class="comment">//</span>
04594                 <span class="comment">//  Couldn't get the DeviceInstance for this interface --</span>
04595                 <span class="comment">//  skip it and move on.</span>
04596                 <span class="comment">//</span>
04597                 <span class="keywordflow">goto</span> CloseInterfaceKeyAndContinue;
04598             }
04599 
04600             <span class="keywordflow">if</span>((deviceInstanceInfo-&gt;Type == REG_SZ) &amp;&amp;
04601                (deviceInstanceInfo-&gt;DataLength != 0)) {
04602 
04603                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;deviceInstanceString,
04604                                                (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(deviceInstanceInfo),
04605                                                deviceInstanceInfo-&gt;DataLength);
04606 
04607             } <span class="keywordflow">else</span> {
04608                 <span class="comment">//</span>
04609                 <span class="comment">// DeviceInstance value is invalid -- skip it and move on.</span>
04610                 <span class="comment">//</span>
04611                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceInstanceInfo);
04612                 <span class="keywordflow">goto</span> CloseInterfaceKeyAndContinue;
04613 
04614             }
04615 
04616             <span class="comment">//</span>
04617             <span class="comment">// Compare the DeviceInstance of this interface to DeviceInstancePath</span>
04618             <span class="comment">//</span>
04619             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;deviceInstanceString, DeviceInstancePath, TRUE)) {
04620 
04621                 ZwClose(hInterface);
04622                 hInterface = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04623 
04624                 <span class="comment">//</span>
04625                 <span class="comment">// Retrieve all instances of this device interface</span>
04626                 <span class="comment">// (active and non-active)</span>
04627                 <span class="comment">//</span>
04628                 <a class="code" href="../../d1/d7/guid_8c.html#a4">RtlGUIDFromString</a>(&amp;guidString, &amp;classGUID);
04629 
04630                 status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a355">IopGetDeviceInterfaces</a>(&amp;classGUID,
04631                                                 DeviceInstancePath,
04632                                                 DEVICE_INTERFACE_INCLUDE_NONACTIVE,
04633                                                 FALSE,       <span class="comment">// kernel-mode format</span>
04634                                                 &amp;symbolicLinkList,
04635                                                 &amp;symbolicLinkListSize);
04636 
04637                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04638 
04639                     <span class="comment">//</span>
04640                     <span class="comment">// Iterate through all instances of the interface</span>
04641                     <span class="comment">//</span>
04642                     symLink = symbolicLinkList;
04643                     <span class="keywordflow">while</span>(*symLink != UNICODE_NULL) {
04644 
04645                         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;tempString, symLink);
04646 
04647                         <span class="comment">//</span>
04648                         <span class="comment">// Unregister this instance of the interface.  Since we are</span>
04649                         <span class="comment">// removing the device, ignore any returned status, since</span>
04650                         <span class="comment">// there isn't anything we can do about interfaces which</span>
04651                         <span class="comment">// fail unregistration.</span>
04652                         <span class="comment">//</span>
04653                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a353">IopUnregisterDeviceInterface</a>(&amp;tempString);
04654 
04655                         symLink += ((tempString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL)) / <span class="keyword">sizeof</span>(WCHAR));
04656                     }
04657                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(symbolicLinkList);
04658                 }
04659 
04660                 <span class="comment">//</span>
04661                 <span class="comment">// Recursively delete the interface key, if it still exists.</span>
04662                 <span class="comment">// While IopUnregisterDeviceInterface will itself delete the</span>
04663                 <span class="comment">// interface key if no interface instance subkeys remain, if any</span>
04664                 <span class="comment">// of the above calls to IopUnregisterDeviceInterface failed to</span>
04665                 <span class="comment">// delete an interface instance key, subkeys will remain, and</span>
04666                 <span class="comment">// the interface key will not have been deleted.  We'll catch</span>
04667                 <span class="comment">// that here.</span>
04668                 <span class="comment">//</span>
04669                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hInterface,
04670                                                hClassGUID,
04671                                                &amp;interfaceString,
04672                                                KEY_READ
04673                                                );
04674                 <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)){
04675                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d1/pnpsubs_8c.html#a41">IopDeleteKeyRecursive</a>(hClassGUID,
04676                                                          interfaceString.Buffer))) {
04677                         deletedInterface = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04678                     }
04679                     ZwDeleteKey(hInterface);
04680                     ZwClose(hInterface);
04681                     hInterface = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04682                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
04683                     <span class="comment">//</span>
04684                     <span class="comment">// Interface was already deleted by IopUnregisterDeviceInterface</span>
04685                     <span class="comment">//</span>
04686                     deletedInterface = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04687                 }
04688             }
04689 
04690             <span class="comment">//</span>
04691             <span class="comment">// Free allocated key info structure</span>
04692             <span class="comment">//</span>
04693             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceInstanceInfo);
04694 
04695 CloseInterfaceKeyAndContinue:
04696 
04697             <span class="keywordflow">if</span> (hInterface != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04698                 ZwClose(hInterface);
04699                 hInterface = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04700             }
04701 
04702             <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;interfaceString);
04703 
04704             <span class="comment">//</span>
04705             <span class="comment">// Only increment the enumeration index for non-deleted keys</span>
04706             <span class="comment">//</span>
04707             <span class="keywordflow">if</span> (!deletedInterface) {
04708                 interfaceIndex++;
04709             }
04710 
04711         }
04712 
04713 CloseClassKeyAndContinue:
04714 
04715         <span class="keywordflow">if</span> (hClassGUID != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04716             ZwClose(hClassGUID);
04717             hClassGUID = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04718         }
04719         classIndex++;
04720     }
04721 
04722 clean1:
04723     <span class="keywordflow">if</span> (hInterface) {
04724         ZwClose(hInterface);
04725     }
04726     <span class="keywordflow">if</span> (hClassGUID) {
04727         ZwClose(hClassGUID);
04728     }
04729     <span class="keywordflow">if</span> (hDeviceClasses) {
04730         ZwClose(hDeviceClasses);
04731     }
04732 
04733     <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;interfaceInfoBuffer);
04734     <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;classInfoBuffer);
04735 
04736 clean0:
04737     <span class="keywordflow">return</span> status;
04738 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a300" doxytag="pnpiop.h::IopRemoveResourceListFromPnp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopRemoveResourceListFromPnp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ResourceList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a229" doxytag="pnpiop.h::IopRemoveStringFromValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRemoveStringFromValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>String</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00449">449</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
<pre class="fragment"><div>00457                    :
00458 
00459     This routine remove a string from a value entry specified by <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>
00460     under an already opened registry handle.  Note, <span class="keyword">this</span> routine will not
00461     <span class="keyword">delete</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> entry even <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> becomes empty after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> removal.
00462 
00463 Parameters:
00464 
00465     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to a registry key whose value entry will
00466         be modified.
00467 
00468     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> - Supplies a unicode string to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
00469 
00470     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - Supplies a unicode string to remove from value entry.
00471 
00472 Return Value:
00473 
00474     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
00475 
00476 --*/
00477 
00478 {
00479     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00480     UNICODE_STRING unicodeString;
00481     PWSTR nextString, currentString;
00482     ULONG length, leftLength;
00483     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00484     BOOLEAN found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00485 
00486     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR) == 0) {
00487         <span class="keywordflow">return</span> STATUS_SUCCESS;
00488     }
00489 
00490     <span class="comment">//</span>
00491     <span class="comment">// Read registry value entry data</span>
00492     <span class="comment">//</span>
00493 
00494     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(Handle, ValueName, &amp;keyValueInformation);
00495 
00496     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00497         <span class="keywordflow">return</span> status;
00498     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type != REG_MULTI_SZ) ||
00499                (keyValueInformation-&gt;DataLength == 0)) {
00500 
00501         status = (keyValueInformation-&gt;Type == REG_MULTI_SZ) ? STATUS_SUCCESS
00502                                                              : STATUS_INVALID_PARAMETER;
00503         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00504         <span class="keywordflow">return</span> status;
00505     }
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Scan through the multi_sz string to find the matching string</span>
00509     <span class="comment">// and remove it.</span>
00510     <span class="comment">//</span>
00511 
00512     status = STATUS_SUCCESS;
00513     currentString = (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
00514     leftLength = keyValueInformation-&gt;DataLength;
00515     <span class="keywordflow">while</span> (!found &amp;&amp; leftLength &gt;= <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + <span class="keyword">sizeof</span>(WCHAR)) {
00516         unicodeString.Buffer = currentString;
00517         length = wcslen( currentString ) * <span class="keyword">sizeof</span>( WCHAR );
00518         unicodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00519         length += <span class="keyword">sizeof</span>(UNICODE_NULL);
00520         unicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00521         nextString = currentString + length / <span class="keyword">sizeof</span>(WCHAR);
00522         leftLength -= length;
00523 
00524         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;unicodeString, String, TRUE)) {
00525             found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00526             RtlMoveMemory(currentString, nextString, leftLength);
00527             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeString, ValueName);
00528             status = ZwSetValueKey(
00529                         Handle,
00530                         &amp;unicodeString,
00531                         TITLE_INDEX_VALUE,
00532                         REG_MULTI_SZ,
00533                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00534                         keyValueInformation-&gt;DataLength - length
00535                         );
00536             <span class="keywordflow">break</span>;
00537         } <span class="keywordflow">else</span> {
00538             currentString = nextString;
00539         }
00540     }
00541     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00542     <span class="keywordflow">return</span> status;
00543 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a251" doxytag="pnpiop.h::IopRemoveTreeDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopRemoveTreeDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/devnode_8c-source.html#l00494">494</a> of file <a class="el" href="../../d5/d6/devnode_8c-source.html">devnode.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a385">IopOrphanNotification()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00111">_DEVICE_NODE::LastChild</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00232">IopDeleteLockedDeviceNode()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01572">IopUnlockDeviceRemovalRelations()</a>.
<p>
<pre class="fragment"><div>00499                    :
00500 
00501     This function removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node tree
00502 
00503     N.B. The caller must own <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device tree lock of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent's enumeration lock
00504 
00505 Arguments:
00506 
00507     DeviceNode      - Device node to remove
00508 
00509 Return Value:
00510 
00511 
00512 --*/
00513 {
00514     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>        *Node;
00515 
00516     <span class="comment">//</span>
00517     <span class="comment">// Ulink the pointer to this device node.  (If this is the</span>
00518     <span class="comment">// first entry, unlink it from the parents child pointer, else</span>
00519     <span class="comment">// remove it from the sibling list)</span>
00520     <span class="comment">//</span>
00521 
00522     Node = &amp;DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00523     <span class="keywordflow">while</span> (*Node != DeviceNode) {
00524         Node = &amp;(*Node)-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00525     }
00526     *Node = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00527 
00528     <span class="keywordflow">if</span> (DeviceNode-&gt;Parent-&gt;Child == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00529         DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o3">LastChild</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00530     } <span class="keywordflow">else</span> {
00531         <span class="keywordflow">while</span> (*Node) {
00532             Node = &amp;(*Node)-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00533         }
00534         DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o3">LastChild</a> = CONTAINING_RECORD(Node, <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a>, Sibling);
00535     }
00536 
00537 
00538     <span class="comment">//</span>
00539     <span class="comment">// Orphan any outstanding device change notifications on these nodes.</span>
00540     <span class="comment">//</span>
00541     <a class="code" href="../../d9/d0/pnpiop_8h.html#a385">IopOrphanNotification</a>(DeviceNode);
00542 
00543     <span class="comment">//</span>
00544     <span class="comment">// No longer linked</span>
00545     <span class="comment">//</span>
00546 
00547     DeviceNode-&gt;Parent    = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00548     DeviceNode-&gt;Child     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00549     DeviceNode-&gt;Sibling   = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00550     DeviceNode-&gt;LastChild = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00551 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a358" doxytag="pnpiop.h::IopReplaceSeperatorWithPound" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopReplaceSeperatorWithPound           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>OutString</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>InString</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05137">IopBuildSymbolicLinkStrings()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04741">IopOpenOrCreateDeviceInterfaceSubKeys()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04000">IopProcessCriticalDeviceRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a296" doxytag="pnpiop.h::IopReportResourceListToPnp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopReportResourceListToPnp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ListSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Translated</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a305" doxytag="pnpiop.h::IopRequestDeviceAction" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRequestDeviceAction           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a133">DEVICE_REQUEST_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> CompletionEvent&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PNTSTATUS CompletionStatus&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">207</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00799">_PI_DEVICE_REQUEST::CompletionEvent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00800">_PI_DEVICE_REQUEST::CompletionStatus</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a133">DEVICE_REQUEST_TYPE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00797">_PI_DEVICE_REQUEST::DeviceObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00196">IopDeviceEnumerationWorkItem</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00195">IopEnumerationInProgress</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00104">IopPnpEnumerationRequestList</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00068">IopPnPSpinLock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00796">_PI_DEVICE_REQUEST::ListEntry</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a134">PI_DEVICE_REQUEST</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00086">PiEnumerationLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00128">PnPBootDriversLoaded</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a135">PPI_DEVICE_REQUEST</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a220">ReenumerateBootDevices</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a225">ReenumerateRootDevices</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00798">_PI_DEVICE_REQUEST::RequestType</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01395">IoInvalidateDeviceRelations()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00557">IopDeleteLockedDeviceNodes()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01496">IopDeviceRelationsComplete()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">IopInvalidateRelationsInList()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06439">IopResourceRequirementsChanged()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01740">IopStartDriverDevices()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01291">IoSynchronousInvalidateDeviceRelations()</a>.
<p>
<pre class="fragment"><div>00216                    :
00217 
00218     This routine queues a work item to enumerate a device. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> IO
00219     internal use <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
00220 
00221 Arguments:
00222 
00223     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object to be enumerated.
00224                    <span class="keywordflow">if</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a request to retry resources allocation
00225                    failed devices.
00226 
00227     <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration.
00228 
00229 Return Value:
00230 
00231     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00232 
00233 --*/
00234 
00235 {
00236     <a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html">PPI_DEVICE_REQUEST</a>  request;
00237     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>        deviceNode;
00238     KIRQL               oldIrql;
00239 
00240     <span class="comment">//</span>
00241     <span class="comment">// If this node is ready for enumeration, enqueue it</span>
00242     <span class="comment">//</span>
00243 
00244     request = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html">PI_DEVICE_REQUEST</a>));
00245 
00246     <span class="keywordflow">if</span> (request) {
00247         <span class="comment">//</span>
00248         <span class="comment">// Put this request onto the pending list</span>
00249         <span class="comment">//</span>
00250 
00251         <span class="keywordflow">if</span> (DeviceObject) {
00252             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(DeviceObject);
00253         }
00254 
00255         request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o1">DeviceObject</a> = DeviceObject;
00256         request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o2">RequestType</a> = RequestType;
00257         request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o3">CompletionEvent</a> = CompletionEvent;
00258         request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o4">CompletionStatus</a> = (RequestType == <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a220">ReenumerateBootDevices</a>)? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : CompletionStatus;
00259 
00260         InitializeListHead(&amp;request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o0">ListEntry</a>);
00261 
00262         <span class="comment">//</span>
00263         <span class="comment">// Insert the  request to the request queue.  If the request queue is</span>
00264         <span class="comment">// not currently being worked on, request a worker thread to start it.</span>
00265         <span class="comment">//</span>
00266 
00267         ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
00268 
00269         InsertTailList(&amp;IopPnpEnumerationRequestList, &amp;request-&gt;<a class="code" href="../../d6/d5/struct__PI__DEVICE__REQUEST.html#o0">ListEntry</a>);
00270 
00271         <span class="keywordflow">if</span> (    RequestType == <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a220">ReenumerateBootDevices</a> ||
00272                 RequestType == <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a225">ReenumerateRootDevices</a>) {
00273             <span class="comment">//</span>
00274             <span class="comment">// This is a special request used when booting the system.  Instead</span>
00275             <span class="comment">// of queuing a work item it synchronously calls the work routine.</span>
00276             <span class="comment">//</span>
00277 
00278             <a class="code" href="../../d6/d0/pnpenum_8c.html#a10">IopEnumerationInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00279             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(&amp;PiEnumerationLock);
00280             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
00281 
00282             <a class="code" href="../../d6/d0/pnpenum_8c.html#a19">IopDeviceActionWorker</a>((PVOID)CompletionStatus);
00283 
00284         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a17">PnPBootDriversLoaded</a> &amp;&amp; !<a class="code" href="../../d6/d0/pnpenum_8c.html#a10">IopEnumerationInProgress</a>) {
00285             <a class="code" href="../../d6/d0/pnpenum_8c.html#a10">IopEnumerationInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00286             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(&amp;PiEnumerationLock);
00287             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
00288 
00289             <span class="comment">//</span>
00290             <span class="comment">// Queue a work item to do the enumeration</span>
00291             <span class="comment">//</span>
00292 
00293             <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(&amp;IopDeviceEnumerationWorkItem, IopDeviceActionWorker, NULL);
00294             <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(&amp;IopDeviceEnumerationWorkItem, DelayedWorkQueue);
00295         } <span class="keywordflow">else</span> {
00296             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
00297         }
00298     } <span class="keywordflow">else</span> {
00299         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00300     }
00301 
00302     <span class="keywordflow">return</span> STATUS_SUCCESS;
00303 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a306" doxytag="pnpiop.h::IopRequestDeviceRemoval" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRequestDeviceRemoval           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Problem</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">1708</a> of file <a class="el" href="../../d4/d9/pnpdel_8c-source.html">pnpdel.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a158">PpSetTargetDeviceRemove()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l05138">IopProcessNewProfileStateCallback()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">IopQueryDeviceState()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.
<p>
<pre class="fragment"><div>01715                    :
01716 
01717     This routine queues a work item to <span class="keyword">delete</span> a device.  (This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> because
01718     to <span class="keyword">delete</span> a device we need to lock device tree.  Most of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> places where
01719     we want to <span class="keyword">delete</span> a device have DeviceNode Enumeration lock acquired.)
01720     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> IO internal use <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
01721 
01722 Arguments:
01723 
01724     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object to be eject.
01725 
01726 Return Value:
01727 
01728     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01729 
01730 --*/
01731 
01732 {
01733     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01734 
01735     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode != NULL);
01736 
01737     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode)-&gt;InstancePath.Length != 0);
01738 
01739     <span class="comment">//</span>
01740     <span class="comment">// Queue the event, we'll return immediately after it's queued.</span>
01741     <span class="comment">//</span>
01742 
01743     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/pnp_8h.html#a158">PpSetTargetDeviceRemove</a>( DeviceObject,
01744                                     TRUE,
01745                                     TRUE,
01746                                     FALSE,
01747                                     Problem,
01748                                     NULL,
01749                                     NULL,
01750                                     NULL,
01751                                     NULL);
01752 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a348" doxytag="pnpiop.h::IopRequestHwProfileChangeNotification" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRequestHwProfileChangeNotification           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN LPGUID&nbsp;</td>
          <td class="mdname" nowrap> <em>EventGuid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a388">PROFILE_NOTIFICATION_TIME</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotificationTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPNP_VETO_TYPE VetoType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING VetoName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06672">6672</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02070">IopCompareGuid</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06858">IopNotifyHwProfileChange()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00189">PiNotificationInProgress</a>, <a class="el" href="../../d8/d0/pnpioapi_8c.html#a58">PiNotifyUserMode()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00042">PNP_DEVICE_EVENT_ENTRY_TAG</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a166">PpSetHwProfileChangeEvent()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a388a209">PROFILE_NOT_IN_PNPEVENT</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a388a210">PROFILE_PERHAPS_IN_PNPEVENT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00251">IopHardwareProfileQueryChange()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00827">IopHardwareProfileSendCancel()</a>, and <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00795">IopHardwareProfileSendCommit()</a>.
<p>
<pre class="fragment"><div>06681                    :
06682 
06683     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to notify all registered drivers of a hardware profile
06684     change.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a> provile change query then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
06685     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> synchronous and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> veto information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> propagated.  All other operations
06686     are asynchronous and veto information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not returned.
06687 
06688 Parameters:
06689 
06690     EventTypeGuid       - The event that has occured
06691 
06692     NotificationTime    - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to tell <span class="keywordflow">if</span> we are already in an event
06693                           when delivering a synchronous notification (ie,
06694                           querying profile change to eject). It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one of
06695                           three values:
06696                               <a class="code" href="../../d9/d0/pnpiop_8h.html#a388a208">PROFILE_IN_PNPEVENT</a>
06697                               <a class="code" href="../../d9/d0/pnpiop_8h.html#a388a209">PROFILE_NOT_IN_PNPEVENT</a>
06698                               <a class="code" href="../../d9/d0/pnpiop_8h.html#a388a210">PROFILE_PERHAPS_IN_PNPEVENT</a>
06699 
06700     VetoType            - Type of vetoer.
06701 
06702     VetoName            - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of vetoer.
06703 
06704 Return Value:
06705 
06706     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
06707 
06708 Note:
06709 
06710     The contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notification structure *including* all pointers <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
06711     valid during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine to which <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was passed.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
06712     required after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duration of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be physically copied
06713     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine.
06714 
06715 --*/
06716 
06717 {
06718     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status=STATUS_SUCCESS,completionStatus;
06719     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> completionEvent;
06720     ULONG dataSize,totalSize;
06721     PPNP_DEVICE_EVENT_ENTRY deviceEvent;
06722 
06723     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06724 
06725     <span class="keywordflow">if</span> (
06726          (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid,
06727                        (LPGUID)&amp;GUID_HWPROFILE_QUERY_CHANGE)) &amp;&amp;
06728          (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid,
06729                        (LPGUID)&amp;GUID_HWPROFILE_CHANGE_CANCELLED)) &amp;&amp;
06730          (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid,
06731                        (LPGUID)&amp;GUID_HWPROFILE_CHANGE_COMPLETE)) ) {
06732 
06733          <span class="comment">//</span>
06734          <span class="comment">//  Passed in an illegal value</span>
06735          <span class="comment">//</span>
06736 
06737 <span class="preprocessor"> #if DBG</span>
06738 <span class="preprocessor"></span>         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Illegal Event type passed as profile notification\n"</span>);
06739 <span class="preprocessor"> #endif</span>
06740 <span class="preprocessor"></span>         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
06741      }
06742 
06743 
06744      <span class="comment">//</span>
06745      <span class="comment">// Only the query changes are synchronous, and in that case we must</span>
06746      <span class="comment">// know definitely whether we are nested within a Pnp event or not.</span>
06747      <span class="comment">//</span>
06748      <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((!<a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid, (LPGUID)&amp;GUID_HWPROFILE_QUERY_CHANGE))||
06749             (NotificationTime != PROFILE_PERHAPS_IN_PNPEVENT)) ;
06750 
06751      <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid, (LPGUID)&amp;GUID_HWPROFILE_QUERY_CHANGE) ) {
06752 
06753          <span class="comment">//</span>
06754          <span class="comment">// Asynchronous case. Very easy.</span>
06755          <span class="comment">//</span>
06756          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!ARGUMENT_PRESENT(VetoName));
06757          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!ARGUMENT_PRESENT(VetoType));
06758 
06759          <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/pnp_8h.html#a166">PpSetHwProfileChangeEvent</a>( EventGuid,
06760                                            NULL,
06761                                            NULL,
06762                                            NULL,
06763                                            NULL
06764                                            );
06765      }
06766 
06767      <span class="comment">//</span>
06768      <span class="comment">// Query notifications are synchronous. Determine if we are currently</span>
06769      <span class="comment">// within an event, in which case we must do the notify here instead</span>
06770      <span class="comment">// of queueing it up.</span>
06771      <span class="comment">//</span>
06772      <span class="keywordflow">if</span> (NotificationTime == <a class="code" href="../../d9/d0/pnpiop_8h.html#a388a209">PROFILE_NOT_IN_PNPEVENT</a>) {
06773 
06774          <span class="comment">//</span>
06775          <span class="comment">// Queue up and block on the notification.</span>
06776          <span class="comment">//</span>
06777          <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;completionEvent, NotificationEvent, FALSE);
06778 
06779          status = <a class="code" href="../../d6/d9/pnp_8h.html#a166">PpSetHwProfileChangeEvent</a>( EventGuid,
06780                                              &amp;completionEvent,
06781                                              &amp;completionStatus,
06782                                              VetoType,
06783                                              VetoName
06784                                              );
06785 
06786          <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))  {
06787 
06788              <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;completionEvent, Executive, KernelMode, FALSE, NULL );
06789 
06790              status = completionStatus;
06791          }
06792 
06793          <span class="keywordflow">return</span> status ;
06794      }
06795 
06796      <span class="comment">//</span>
06797      <span class="comment">// Synchronous notify inside our Pnp event.</span>
06798      <span class="comment">//</span>
06799      <span class="comment">// ADRIAO BUGBUG 11/12/98 -</span>
06800      <span class="comment">//     GROSS, UGLY, SINFUL HACK - We are MANUALLY sending the profile</span>
06801      <span class="comment">// query change notification because we are blocking inside a PnPEvent and</span>
06802      <span class="comment">// thus can't queue/wait on another!</span>
06803      <span class="comment">//</span>
06804      <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PiNotificationInProgress == TRUE);
06805 
06806      dataSize =  <span class="keyword">sizeof</span>(PLUGPLAY_EVENT_BLOCK);
06807 
06808      totalSize = dataSize + FIELD_OFFSET (PNP_DEVICE_EVENT_ENTRY,Data);
06809 
06810      deviceEvent = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
06811                                           totalSize,
06812                                           PNP_DEVICE_EVENT_ENTRY_TAG);
06813 
06814      <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == deviceEvent) {
06815          <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06816      }
06817 
06818      <span class="comment">//</span>
06819      <span class="comment">//Setup the PLUGPLAY_EVENT_BLOCK</span>
06820      <span class="comment">//</span>
06821      RtlZeroMemory ((PVOID)deviceEvent,totalSize);
06822      deviceEvent-&gt;Data.EventCategory = HardwareProfileChangeEvent;
06823      RtlCopyMemory(&amp;deviceEvent-&gt;Data.EventGuid, EventGuid, <span class="keyword">sizeof</span>(GUID));
06824      deviceEvent-&gt;Data.TotalSize = dataSize;
06825      deviceEvent-&gt;CallerEvent = &amp;completionEvent;
06826      deviceEvent-&gt;Data.Result = &amp;completionStatus;
06827      deviceEvent-&gt;VetoType = VetoType;
06828      deviceEvent-&gt;VetoName = VetoName;
06829 
06830      <span class="comment">//</span>
06831      <span class="comment">// Notify K-Mode</span>
06832      <span class="comment">//</span>
06833      status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a359">IopNotifyHwProfileChange</a>(&amp;deviceEvent-&gt;Data.EventGuid,
06834                                        VetoType,
06835                                        VetoName);
06836 
06837      <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06838          <span class="keywordflow">return</span> status;
06839      }
06840 
06841      <span class="comment">//</span>
06842      <span class="comment">// Notify user-mode (synchronously).</span>
06843      <span class="comment">//</span>
06844      status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a58">PiNotifyUserMode</a>(deviceEvent);
06845 
06846      <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06847          <span class="comment">//</span>
06848          <span class="comment">// Notify K-mode that the query has been cancelled.</span>
06849          <span class="comment">//</span>
06850          <a class="code" href="../../d9/d0/pnpiop_8h.html#a359">IopNotifyHwProfileChange</a>((LPGUID)&amp;GUID_HWPROFILE_CHANGE_CANCELLED,
06851                                   NULL,
06852                                   NULL);
06853      }
06854      <span class="keywordflow">return</span> status;
06855 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a334" doxytag="pnpiop.h::IopReserveBootResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopReserveBootResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ArbiterRequestSource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>BootResources</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07291">7291</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00296">_DEVICE_NODE::BootResources</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00071">ExAllocatePoolIORL</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00072">ExAllocatePoolIORRR</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07141">IopAllocateBootResources()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03523">IopDetermineResourceListSize()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00042">IopInitReservedResourceList</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00937">PIOP_RESERVED_RESOURCES_RECORD</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.
<p>
<pre class="fragment"><div>07299                    :
07300 
07301     This routine reports boot resources <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device to
07302     arbiters.  Since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real resource pre-alloc routine can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be called after
07303     all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arbiters and translators are present, all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calls to pre-alloc resources
07304     before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> preallocation routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available will be routed to <span class="keyword">this</span> routine.
07305 
07306 Arguments:
07307 
07308     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object.  If present, caller wants to
07309         preallocate BOOT resources <span class="keywordflow">for</span> a device object.  If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, caller wants to reserved
07310         resources <span class="keywordflow">for</span> some unknown devices.
07311 
07312     BootResources - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Boot resources.
07313 
07314 Return Value:
07315 
07316     None.
07317 
07318 --*/
07319 {
07320     <a class="code" href="../../d9/d0/pnpiop_8h.html#a138">PIOP_RESERVED_RESOURCES_RECORD</a>  resourceRecord;
07321     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>                    deviceNode;
07322     ULONG                           size;
07323     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
07324 
07325     status = STATUS_SUCCESS;;
07326     size = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(BootResources);
07327     <span class="keywordflow">if</span> (size != 0) {
07328 
07329         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)((DeviceObject)?  DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
07330 
07331         <span class="comment">//</span>
07332         <span class="comment">// Pre-allocate BOOT configs right away for non-madeup devices.</span>
07333         <span class="comment">//</span>
07334 
07335         <span class="keywordflow">if</span> (DeviceObject &amp;&amp; !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>)) {
07336 
07337             <span class="keywordflow">return</span> <a class="code" href="../../d5/d1/pnpres_8c.html#a111">IopAllocateBootResources</a>(ArbiterRequestSource, DeviceObject, BootResources);
07338 
07339         }
07340 
07341 
07342         <span class="keywordflow">if</span> (DeviceObject) {
07343 
07344             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode);
07345             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a12">ExAllocatePoolIORL</a>(PagedPool, size);
07346             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>) {
07347 
07348                 RtlMoveMemory(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>, BootResources, size);
07349 
07350             } <span class="keywordflow">else</span> {
07351 
07352                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
07353 
07354             }
07355         }
07356 
07357         resourceRecord = (<a class="code" href="../../d9/d0/pnpiop_8h.html#a138">PIOP_RESERVED_RESOURCES_RECORD</a>) <a class="code" href="../../d5/d1/pnpres_8c.html#a13">ExAllocatePoolIORRR</a>(  PagedPool,
07358                                                                                 <span class="keyword">sizeof</span>(IOP_RESERVED_RESOURCES_RECORD));
07359         <span class="keywordflow">if</span> (resourceRecord) {
07360 
07361             resourceRecord-&gt;ReservedResources = (DeviceObject)? deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a> : BootResources;
07362             resourceRecord-&gt;DeviceObject = DeviceObject;
07363             resourceRecord-&gt;Next = <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a>;
07364             <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a> = resourceRecord;
07365 
07366         } <span class="keywordflow">else</span> {
07367 
07368             <span class="keywordflow">if</span> (deviceNode &amp;&amp; deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>) {
07369 
07370                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>);
07371 
07372             }
07373 
07374             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
07375 
07376         }
07377     }
07378 
07379     <span class="keywordflow">return</span> status;
07380 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a336" doxytag="pnpiop.h::IopReserveLegacyBootResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopReserveLegacyBootResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN INTERFACE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BusNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">6996</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a174a127">ArbiterRequestHalReported</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00296">_DEVICE_NODE::BootResources</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00268">DUMP_INFO</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00050">InterfaceType</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07141">IopAllocateBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06955">IopCombineCmResourceList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06801">IopCreateCmResourceList()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00929">IopDumpCmResourceList()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00041">IopInitHalDeviceNode</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00040">IopInitHalResources</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00042">IopInitReservedResourceList</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00937">PIOP_RESERVED_RESOURCES_RECORD</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00273">PnpResDebugLevel</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>07003                    :
07004 
07005     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to reserve legacy BOOT resources <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>
07006     and <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done everytime a <span class="keyword">new</span> bus with a legacy <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> gets enumerated.
07007 
07008 Arguments:
07009 
07010     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> - Legacy <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>.
07011 
07012     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> - Legacy <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>
07013 
07014 Return Value:
07015 
07016     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
07017 
07018 --*/
07019 
07020 {
07021     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
07022     <a class="code" href="../../d9/d0/pnpiop_8h.html#a138">PIOP_RESERVED_RESOURCES_RECORD</a>  resourceRecord, prevRecord;
07023     PCM_RESOURCE_LIST   newList, remainingList;
07024 
07025     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a> &amp;&amp; <a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a>) {
07026 
07027         remainingList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07028         newList = <a class="code" href="../../d5/d1/pnpres_8c.html#a51">IopCreateCmResourceList</a>(IopInitHalResources, InterfaceType, BusNumber, &amp;remainingList);
07029         <span class="keywordflow">if</span> (newList) {
07030 
07031             <span class="keywordflow">if</span> (remainingList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07032 
07033                 <span class="comment">//</span>
07034                 <span class="comment">// Full match. Check for error.</span>
07035                 <span class="comment">//</span>
07036 
07037                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(newList == IopInitHalResources);
07038 
07039             } <span class="keywordflow">else</span> {
07040 
07041                 <span class="comment">//</span>
07042                 <span class="comment">// Partial match. Check for error.</span>
07043                 <span class="comment">//</span>
07044 
07045                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IopInitHalResources != newList);
07046                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IopInitHalResources != remainingList);
07047 
07048             }
07049 
07050             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"IopReserveLegacyBootResources: Allocating HAL BOOT config for interface %08X and bus %08X...\n"</span>, InterfaceType, BusNumber));
07051             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>) {
07052 
07053                 <a class="code" href="../../d1/d8/report_8c.html#a17">IopDumpCmResourceList</a>(newList);
07054 
07055             }
07056             <span class="keywordflow">if</span> (remainingList) {
07057                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopInitHalResources);
07058             }
07059             <a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a> = remainingList;
07060             remainingList = <a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>;
07061             <a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>;
07062             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a111">IopAllocateBootResources</a>(  ArbiterRequestHalReported,
07063                                                 <a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
07064                                                 newList);
07065             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
07066             <a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a52">IopCombineCmResourceList</a>(remainingList, newList);
07067             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>);
07068 
07069             <span class="comment">//</span>
07070             <span class="comment">// Free previous BOOT config if any.</span>
07071             <span class="comment">//</span>
07072 
07073             <span class="keywordflow">if</span> (remainingList) {
07074 
07075                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(remainingList);
07076 
07077             }
07078         } <span class="keywordflow">else</span> {
07079 
07080             <span class="comment">//</span>
07081             <span class="comment">// No match. Check that there was no error.</span>
07082             <span class="comment">//</span>
07083 
07084             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(remainingList &amp;&amp; remainingList == IopInitHalResources);
07085         }
07086     }
07087 
07088     <span class="keywordflow">for</span> (prevRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, resourceRecord = <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a>; resourceRecord;) {
07089 
07090         <span class="keywordflow">if</span> (    resourceRecord-&gt;ReservedResources &amp;&amp;
07091                 resourceRecord-&gt;ReservedResources-&gt;List[0].InterfaceType == <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> &amp;&amp;
07092                 resourceRecord-&gt;ReservedResources-&gt;List[0].BusNumber == <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>) {
07093 
07094             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"IopReserveLegacyBootResources: Allocating BOOT config...\n"</span>));
07095             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>) {
07096 
07097                 <a class="code" href="../../d1/d8/report_8c.html#a17">IopDumpCmResourceList</a>(resourceRecord-&gt;ReservedResources);
07098 
07099             }
07100 
07101             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a111">IopAllocateBootResources</a>(  ArbiterRequestPnpEnumerated,
07102                                                 resourceRecord-&gt;DeviceObject,
07103                                                 resourceRecord-&gt;ReservedResources);
07104             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07105 
07106                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopReserveLegacyBootResources: IopAllocateBootResources failed with status = %08X\n"</span>, status);
07107                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
07108 
07109             }
07110 
07111             <span class="keywordflow">if</span> (resourceRecord-&gt;DeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07112 
07113                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resourceRecord-&gt;ReservedResources);
07114 
07115             }
07116 
07117             <span class="keywordflow">if</span> (prevRecord) {
07118 
07119                 prevRecord-&gt;Next = resourceRecord-&gt;Next;
07120 
07121             } <span class="keywordflow">else</span> {
07122 
07123                 <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a> = resourceRecord-&gt;Next;
07124 
07125             }
07126             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resourceRecord);
07127             resourceRecord = (prevRecord)? prevRecord-&gt;Next : <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a>;
07128 
07129         } <span class="keywordflow">else</span> {
07130 
07131             prevRecord = resourceRecord;
07132             resourceRecord = resourceRecord-&gt;Next;
07133 
07134         }
07135     }
07136 
07137     <span class="keywordflow">return</span> STATUS_SUCCESS;
07138 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a371" doxytag="pnpiop.h::IopResizeBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopResizeBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d5/struct__BUFFER__INFO.html">PBUFFER_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Info</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CopyContents</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02467">2467</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02575">IopAppendBuffer()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02707">IopGetDeviceInterfaces()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02640">IopOverwriteBuffer()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04000">IopProcessCriticalDeviceRoutine()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">IopRemoveDeviceInterfaces()</a>.
<p>
<pre class="fragment"><div>02475                    :
02476 
02477     Allocates a <span class="keyword">new</span> buffer of NewSize bytes and associates <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> with Info, freeing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02478     old buffer.  It will optionally copy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old buffer into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02479     <span class="keyword">new</span> buffer and update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current position.
02480 
02481 Parameters:
02482 
02483     Info - Pointer to a buffer info structure to be used to manage <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer
02484 
02485     NewSize - The <span class="keyword">new</span> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer in bytes
02486 
02487     CopyContents - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old buffer should be
02488                    copied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> buffer
02489 
02490 Return Value:
02491 
02492     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
02493 
02494 --*/
02495 
02496 {
02497     ULONG used;
02498     PCHAR newBuffer;
02499 
02500     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Info);
02501 
02502     used = (ULONG)(Info-&gt;Current - Info-&gt;Buffer);
02503 
02504     <span class="keywordflow">if</span> (!(newBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, NewSize))) {
02505         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02506     }
02507 
02508     <span class="keywordflow">if</span> (CopyContents) {
02509 
02510         <span class="comment">//</span>
02511         <span class="comment">// Assert there is room in the buffer</span>
02512         <span class="comment">//</span>
02513 
02514         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(used &lt; NewSize);
02515 
02516         RtlCopyMemory(newBuffer,
02517                       Info-&gt;Buffer,
02518                       used);
02519 
02520         Info-&gt;Current = newBuffer + used;
02521 
02522     } <span class="keywordflow">else</span> {
02523 
02524         Info-&gt;Current = newBuffer;
02525     }
02526 
02527     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Info-&gt;Buffer);
02528 
02529     Info-&gt;Buffer = newBuffer;
02530     Info-&gt;MaxSize = NewSize;
02531 
02532     <span class="keywordflow">return</span> STATUS_SUCCESS;
02533 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a278" doxytag="pnpiop.h::IopResourceRequirementsChanged" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopResourceRequirementsChanged           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalDeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>StopRequired</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06439">6439</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00433">DNF_NO_RESOURCE_REQUIRED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00473">DNF_NON_STOPPED_REBALANCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00466">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00831">IopClearDevNodeProblem</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a223">ResourceRequirementsChanged</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">IopQueryDeviceState()</a>.
<p>
<pre class="fragment"><div>06446                    :
06447 
06448     This routine handles request of device resource requirements list change.
06449 
06450 Parameters:
06451 
06452     PhysicalDeviceObject - Provides a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO who's state <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be invalidated.
06453 
06454     StopRequired - Supplies a BOOLEAN value to indicate <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources reallocation needs
06455                    to be done after device stopped.
06456 
06457 Return Value:
06458 
06459     none.
06460 
06461 --*/
06462 
06463 {
06464     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
06465     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> device = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06466 
06467     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06468 
06469     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
06470 
06471     <span class="comment">//</span>
06472     <span class="comment">// Clear the NO_RESOURCE_REQUIRED flags.</span>
06473     <span class="comment">//</span>
06474 
06475     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>;
06476 
06477     <span class="comment">//</span>
06478     <span class="comment">// If for some reason this device did not start, we need to clear some flags</span>
06479     <span class="comment">// such that it can be started later.  In this case, we call IopRequestDeviceEnumeration</span>
06480     <span class="comment">// with NULL device object, so the devices will be handled in non-started case.  They will</span>
06481     <span class="comment">// be assigned resources, started and enumerated.</span>
06482     <span class="comment">//</span>
06483 
06484     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>;
06485 
06486     <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(deviceNode);
06487 
06488     <span class="comment">//</span>
06489     <span class="comment">// If the device is already started, we call IopRequestDeviceEnumeration with</span>
06490     <span class="comment">// the device object.</span>
06491     <span class="comment">//</span>
06492 
06493     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
06494         device = PhysicalDeviceObject;
06495         <span class="keywordflow">if</span> (StopRequired == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
06496             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>;
06497         } <span class="keywordflow">else</span> {
06498 
06499             <span class="comment">//</span>
06500             <span class="comment">// Explicitly clear it.</span>
06501             <span class="comment">//</span>
06502 
06503             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>;
06504         }
06505     }
06506 
06507     <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>( device, ResourceRequirementsChanged, NULL, NULL );
06508 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a307" doxytag="pnpiop.h::IopRestartDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRestartDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">5777</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00421">DNF_BOOT_CONFIG_RESERVED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00396">DNF_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00522">DNF_ENUMERATION_REQUEST_QUEUED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00433">DNF_NO_RESOURCE_REQUIRED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00390">DNF_PROCESSED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00453">DNF_RESOURCE_ASSIGNED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00459">DNF_RESOURCE_REPORTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00466">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00440">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00602">DNUF_NEED_RESTART</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00589">DNUF_WILL_BE_REMOVED</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01250">IopInvalidateRelationsInList()</a>.
<p>
<pre class="fragment"><div>05780 {
05781     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05782 
05783     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode) ||
05784             (DeviceNode-&gt;Flags &amp; (DNF_STARTED |
05785                                  DNF_ADDED |
05786                                  DNF_RESOURCE_ASSIGNED |
05787                                  DNF_RESOURCE_REPORTED)) ||
05788             (DeviceNode-&gt;UserFlags &amp; DNUF_WILL_BE_REMOVED)));
05789 
05790     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;Flags &amp; DNF_ENUMERATED);
05791 
05792     <span class="keywordflow">if</span> (!(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>)) {
05793         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
05794     }
05795 
05796     DeviceNode-&gt;UserFlags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a39">DNUF_NEED_RESTART</a>;
05797 
05798 <span class="preprocessor">#if DBG_SCOPE</span>
05799 <span class="preprocessor"></span>    DeviceNode-&gt;FailureStatus = 0;
05800     <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceList) {
05801         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceList);
05802         DeviceNode-&gt;PreviousResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05803     }
05804     <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceRequirements) {
05805         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceRequirements);
05806         DeviceNode-&gt;PreviousResourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05807     }
05808 <span class="preprocessor">#endif</span>
05809 <span class="preprocessor"></span>
05810     <span class="comment">//</span>
05811     <span class="comment">// Free any existing devnode strings so we can recreate them</span>
05812     <span class="comment">// during enumeration.</span>
05813     <span class="comment">//</span>
05814 
05815     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a>) {
05816 
05817         DeviceNode-&gt;Flags &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a> |
05818                                <a class="code" href="../../d9/d0/pnpiop_8h.html#a28">DNF_ENUMERATION_REQUEST_QUEUED</a> |
05819                                <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a> |
05820                                <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>);
05821 
05822         <span class="keywordflow">if</span> (DeviceNode-&gt;ServiceName.Length != 0) {
05823             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ServiceName.Buffer);
05824             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;DeviceNode-&gt;ServiceName, NULL);
05825         }
05826 
05827         <span class="keywordflow">if</span> (DeviceNode-&gt;ResourceRequirements != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05828             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ResourceRequirements);
05829             DeviceNode-&gt;ResourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05830             DeviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a16">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>;
05831         }
05832     }
05833 
05834     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;ServiceName.Length == 0 &amp;&amp;
05835            DeviceNode-&gt;ServiceName.MaximumLength == 0 &amp;&amp;
05836            DeviceNode-&gt;ServiceName.Buffer == NULL);
05837 
05838     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(DeviceNode-&gt;Flags &amp;
05839            ~(DNF_MADEUP | DNF_ENUMERATED | DNF_HAS_BOOT_CONFIG |
05840              DNF_BOOT_CONFIG_RESERVED | DNF_NO_RESOURCE_REQUIRED)));
05841 
05842     <span class="keywordflow">return</span> STATUS_SUCCESS;
05843 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a233" doxytag="pnpiop.h::IopServiceInstanceToDeviceInstance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopServiceInstanceToDeviceInstance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE ServiceKeyHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING ServiceKeyName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceInstanceOrdinal</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING DeviceInstanceRegistryPath&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE DeviceInstanceHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00931">931</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00695">IopConcatenateUnicodeStrings()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02467">IopMarkDuplicateDevice()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01712">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06660">IopSetLegacyDeviceInstance()</a>.
<p>
<pre class="fragment"><div>00942                    :
00943 
00944     This routine reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service node <span class="keyword">enum</span> entry to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired device instance
00945     under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> System\Enum tree.  It then optionally returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00946     specified device instance (relative to HKLM\System\Enum) and an open handle
00947     to that registry key.
00948 
00949     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's responsibility to close <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle returned <span class="keywordflow">if</span>
00950     DeviceInstanceHandle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied, and also to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> (PagedPool) memory
00951     allocated for the unicode string buffer of DeviceInstanceRegistryPath, if
00952     supplied.
00953 
00954 Parameters:
00955 
00956     ServiceKeyHandle - Optionally, supplies a handle to the driver service node in the
00957         registry that controls this device instance.  If this argument is not specified,
00958         then ServiceKeyName is used to specify the service entry.
00959 
00960     ServiceKeyName - Optionally supplies the name of the service entry that controls
00961         the device instance. This must be specified if ServiceKeyHandle isn't given.
00962 
00963     ServiceInstanceOrdinal - Supplies the instance value under the service entry's
00964         volatile Enum subkey that references the desired device instance.
00965 
00966     DeviceInstanceRegistryPath - Optionally, supplies a pointer to a unicode string
00967         that will be initialized with the registry path (relative to HKLM\System\Enum)
00968         to the device instance key.
00969 
00970     DeviceInstanceHandle - Optionally, supplies a pointer to a variable that will
00971         receive a handle to the opened device instance registry key.
00972 
00973     DesiredAccess - If DeviceInstanceHandle is specified (i.e., the device instance
00974         key is to be opened), then this variable specifies the access that is needed
00975         to this key.
00976 
00977 Return Value:
00978 
00979     NT status code indicating whether the function was successful.
00980 
00981 --*/
00982 
00983 {
00984     WCHAR unicodeBuffer[20];
00985     UNICODE_STRING unicodeKeyName;
00986     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00987     HANDLE handle;
00988     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00989 
00990     <span class="comment">//</span>
00991     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
00992     <span class="comment">//</span>
00993     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceKeyHandle)) {
00994 
00995         PiWstrToUnicodeString(&amp;unicodeKeyName, REGSTR_KEY_ENUM);
00996         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
00997                                        ServiceKeyHandle,
00998                                        &amp;unicodeKeyName,
00999                                        KEY_READ
01000                                        );
01001     } <span class="keywordflow">else</span> {
01002 
01003         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
01004                                         KEY_READ,
01005                                         NULL,
01006                                         &amp;handle,
01007                                         FALSE
01008                                        );
01009     }
01010 
01011     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01012 
01013         <span class="comment">//</span>
01014         <span class="comment">// There is no registry key for the ServiceKeyName\Enum information.</span>
01015         <span class="comment">//</span>
01016 
01017         <span class="keywordflow">return</span> status;
01018     }
01019 
01020     <span class="comment">//</span>
01021     <span class="comment">// Read a path to System\Enum hardware tree branch specified by the service</span>
01022     <span class="comment">// instance ordinal</span>
01023     <span class="comment">//</span>
01024 
01025     swprintf(unicodeBuffer, REGSTR_VALUE_STANDARD_ULONG_FORMAT, ServiceInstanceOrdinal);
01026     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( handle,
01027                                    unicodeBuffer,
01028                                    &amp;keyValueInformation
01029                                    );
01030 
01031     ZwClose(handle);
01032     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01033         <span class="keywordflow">return</span> status;
01034     } <span class="keywordflow">else</span> {
01035         <span class="keywordflow">if</span>(keyValueInformation-&gt;Type == REG_SZ) {
01036             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;unicodeKeyName,
01037                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
01038                                            keyValueInformation-&gt;DataLength
01039                                           );
01040             <span class="keywordflow">if</span>(!unicodeKeyName.Length) {
01041                 status = STATUS_OBJECT_PATH_NOT_FOUND;
01042             }
01043         } <span class="keywordflow">else</span> {
01044             status = STATUS_INVALID_PLUGPLAY_DEVICE_PATH;
01045         }
01046 
01047         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01048             <span class="keywordflow">goto</span> PrepareForReturn;
01049         }
01050     }
01051 
01052     <span class="comment">//</span>
01053     <span class="comment">// If the DeviceInstanceHandle argument was specified, open the device instance</span>
01054     <span class="comment">// key under HKLM\System\CurrentControlSet\Enum</span>
01055     <span class="comment">//</span>
01056 
01057     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DeviceInstanceHandle)) {
01058 
01059         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
01060                                        NULL,
01061                                        &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
01062                                        KEY_READ
01063                                        );
01064 
01065         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01066 
01067             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( DeviceInstanceHandle,
01068                                            handle,
01069                                            &amp;unicodeKeyName,
01070                                            DesiredAccess
01071                                            );
01072             ZwClose(handle);
01073         }
01074 
01075         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01076             <span class="keywordflow">goto</span> PrepareForReturn;
01077         }
01078     }
01079 
01080     <span class="comment">//</span>
01081     <span class="comment">// If the DeviceInstanceRegistryPath argument was specified, then store a</span>
01082     <span class="comment">// copy of the device instance path in the supplied unicode string variable.</span>
01083     <span class="comment">//</span>
01084     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DeviceInstanceRegistryPath)) {
01085 
01086         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(DeviceInstanceRegistryPath,
01087                                           &amp;unicodeKeyName,
01088                                           NULL)) {
01089 
01090             <span class="keywordflow">if</span>(ARGUMENT_PRESENT(DeviceInstanceHandle)) {
01091                 ZwClose(*DeviceInstanceHandle);
01092             }
01093             status = STATUS_INSUFFICIENT_RESOURCES;
01094         }
01095     }
01096 
01097 PrepareForReturn:
01098 
01099     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01100     <span class="keywordflow">return</span> status;
01101 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a242" doxytag="pnpiop.h::IopSetServiceInstanceCsConfigFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSetServiceInstanceCsConfigFlags           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Instance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CsConfigFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01653">1653</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01588">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01661                    :
01662 
01663     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> csconfig flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device
01664     which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number under ServiceKeyName\Enum.
01665 
01666 Arguments:
01667 
01668     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01669         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
01670         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryPath parameter
01671         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> routine.
01672 
01673     Instance - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance value under ServiceKeyName\Enum key
01674 
01675     CsConfigFlags - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance's <span class="keyword">new</span> CsConfigFlags
01676 
01677 Return Value:
01678 
01679     status
01680 
01681 --*/
01682 
01683 {
01684     HANDLE handle;
01685     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01686     UNICODE_STRING tempUnicodeString;
01687 
01688     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01689 
01690     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a11">IopOpenCurrentHwProfileDeviceInstanceKey</a>(&amp;handle,
01691                                                       ServiceKeyName,
01692                                                       Instance,
01693                                                       KEY_READ | KEY_WRITE,
01694                                                       TRUE
01695                                                      );
01696     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01697 
01698         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_VALUE_CSCONFIG_FLAGS);
01699         status = ZwSetValueKey(handle,
01700                                &amp;tempUnicodeString,
01701                                TITLE_INDEX_VALUE,
01702                                REG_DWORD,
01703                                &amp;CsConfigFlags,
01704                                <span class="keyword">sizeof</span>(CsConfigFlags)
01705                               );
01706         ZwClose(handle);
01707     }
01708     <span class="keywordflow">return</span> status;
01709 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a285" doxytag="pnpiop.h::IopStartAndEnumerateDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopStartAndEnumerateDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/struct__START__CONTEXT.html">PSTART_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StartContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">994</a> of file <a class="el" href="../../d7/d9/pnpenum_8c-source.html">pnpenum.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a422">BusQueryHardwareIDs</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00625">DNF_HAS_RESOURCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00500">DNF_NEED_ENUMERATION_ONLY</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00402">DNF_NEED_QUERY_IDS</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00433">DNF_NO_RESOURCE_REQUIRED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00619">DNF_START_PHASE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05633">IopDeviceNodeCapabilitiesToRegistry()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04559">IopFixupIds()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02173">IopQueryCompatibleIds()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">IopQueryDeviceState()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00633">PNP_ERR_BOGUS_ID</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00173">PnpAsyncOk</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01596">IopNewDevice()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">IopProcessStartDevicesWorker()</a>.
<p>
<pre class="fragment"><div>01001                    :
01002 
01003     This routine starts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device and enumerates <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01004 
01005     NOTE: The resources <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device should already been allocated.
01006 
01007 Arguments:
01008 
01009     DeviceNode - Supplies a pointer to a device node which will be started and
01010                  enumerated.
01011 
01012     StartContext - Supplies a pointer to <a class="code" href="../../d0/d6/struct__START__CONTEXT.html">START_CONTEXT</a> structure to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>
01013                  how <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start should be handled.
01014 
01015 Return Value:
01016 
01017     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01018 
01019 --*/
01020 
01021 {
01022     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01023     UNICODE_STRING unicodeName;
01024     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
01025     HANDLE         handle;
01026 
01027     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01028 
01029     <span class="comment">//</span>
01030     <span class="comment">// If no driver is loaded or add device failed, don't start it.</span>
01031     <span class="comment">//</span>
01032 
01033     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((DeviceNode-&gt;Flags &amp; DNF_ADDED) &amp;&amp;
01034            (DeviceNode-&gt;Flags &amp; (DNF_HAS_RESOURCE | DNF_NO_RESOURCE_REQUIRED)) &amp;&amp;
01035            (!(DeviceNode-&gt;Flags &amp; DNF_START_PHASE) || (DeviceNode-&gt;Flags &amp; DNF_NEED_QUERY_IDS))
01036            );
01037 
01038     deviceObject = DeviceNode-&gt;PhysicalDeviceObject;
01039 
01040     <span class="comment">//</span>
01041     <span class="comment">// First start the device, if it hasn't</span>
01042     <span class="comment">//</span>
01043 
01044     <span class="keywordflow">if</span> (!(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>)) {
01045 
01046         <a class="code" href="../../d0/d1/pnpirp_8c.html#a19">IopStartDevice</a>(deviceObject);
01047 
01048         <span class="comment">//</span>
01049         <span class="comment">// ADRIAO BUGBUG 11/11/98 -</span>
01050         <span class="comment">//     Everything in this if clause expects the start call to</span>
01051         <span class="comment">// returns synchronously. When AsyncOk == TRUE functionality is fixed,</span>
01052         <span class="comment">// code in here should be moved into IopStartDevice.</span>
01053         <span class="comment">//</span>
01054         <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
01055 
01056             <a class="code" href="../../d9/d1/pnpsubs_8c.html#a37">IopDeviceNodeCapabilitiesToRegistry</a>(DeviceNode);
01057             <a class="code" href="../../d0/d1/pnpirp_8c.html#a32">IopQueryDeviceState</a>(deviceObject);
01058         }
01059     }
01060 
01061     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a>) {
01062 
01063         PWCHAR compatibleIds, hwIds;
01064         ULONG hwIdLength, compatibleIdLength;
01065 
01066         <span class="comment">//</span>
01067         <span class="comment">// If the DNF_NEED_QUERY_IDS is set, the device is a reported device.</span>
01068         <span class="comment">// It should already be started.  We need to enumerate its children and ask</span>
01069         <span class="comment">// the HardwareId and the Compatible ids of the detected device.</span>
01070         <span class="comment">//</span>
01071 
01072         DeviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a>;
01073         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a> (deviceObject,
01074                                                   &amp;handle,
01075                                                   KEY_READ
01076                                                   );
01077         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01078             status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a26">IopQueryCompatibleIds</a>(deviceObject,
01079                                            BusQueryHardwareIDs,
01080                                            &amp;hwIds,
01081                                            &amp;hwIdLength);
01082 
01083             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01084                 hwIds = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01085             }
01086 
01087             status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a26">IopQueryCompatibleIds</a>(deviceObject,
01088                                            BusQueryCompatibleIDs,
01089                                            &amp;compatibleIds,
01090                                            &amp;compatibleIdLength);
01091             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01092                 compatibleIds = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01093             }
01094 
01095             <span class="keywordflow">if</span> (hwIds || compatibleIds) {
01096                 <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01097                 <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
01098 
01099                 <span class="keywordflow">if</span> (hwIds) {
01100 
01101                     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/pnpenum_8c.html#a28">IopFixupIds</a>(hwIds, hwIdLength)) {
01102                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
01103                                       PNP_ERR_BOGUS_ID,
01104                                       (ULONG_PTR)deviceObject,
01105                                       (ULONG_PTR)hwIds,
01106                                       3);
01107                     }
01108                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_HARDWAREID);
01109                     ZwSetValueKey(handle,
01110                                   &amp;unicodeName,
01111                                   TITLE_INDEX_VALUE,
01112                                   REG_MULTI_SZ,
01113                                   hwIds,
01114                                   hwIdLength
01115                                   );
01116                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(hwIds);
01117                 }
01118 
01119                 <span class="comment">//</span>
01120                 <span class="comment">// create CompatibleId value name.  It is a MULTI_SZ,</span>
01121                 <span class="comment">//</span>
01122 
01123                 <span class="keywordflow">if</span> (compatibleIds) {
01124 
01125                     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/pnpenum_8c.html#a28">IopFixupIds</a>(compatibleIds, compatibleIdLength)) {
01126                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
01127                                       PNP_ERR_BOGUS_ID,
01128                                       (ULONG_PTR)deviceObject,
01129                                       (ULONG_PTR)compatibleIds,
01130                                       4);
01131                     }
01132 
01133                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_COMPATIBLEIDS);
01134                     ZwSetValueKey(handle,
01135                                   &amp;unicodeName,
01136                                   TITLE_INDEX_VALUE,
01137                                   REG_MULTI_SZ,
01138                                   compatibleIds,
01139                                   compatibleIdLength
01140                                   );
01141                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(compatibleIds);
01142                 }
01143 
01144                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
01145                 <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01146             }
01147             ZwClose(handle);
01148         }
01149     }
01150 
01151     <span class="keywordflow">if</span> ((DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) &amp;&amp;
01152         (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a25">DNF_NEED_ENUMERATION_ONLY</a>)) {
01153 
01154         status = <a class="code" href="../../d6/d0/pnpenum_8c.html#a20">IopEnumerateDevice</a>(deviceObject, StartContext, PnpAsyncOk);
01155     } <span class="keywordflow">else</span> {
01156         status = STATUS_SUCCESS;
01157     }
01158 
01159     <span class="keywordflow">return</span> status;
01160 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a264" doxytag="pnpiop.h::IopStartDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopStartDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TargetDevice</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">510</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00092">_DEVICE_COMPLETION_CONTEXT::DeviceNode</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00500">DNF_NEED_ENUMERATION_ONLY</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00459">DNF_RESOURCE_REPORTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00427">DNF_START_REQUEST_PENDING</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00480">DNF_STOPPED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a387a204">DOCK_QUIESCENT</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o42">_DEVICE_NODE::DockInfo</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02455">ExGetCurrentResourceThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01266">IopAcquireEnumerationLock</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00262">IopAsynchronousCall()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09866">IopDoDeferredSetInterfaceState()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00103">IopHardwareProfileBeginTransition()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00666">IopHardwareProfileCancelTransition()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00370">IopHardwareProfileCommitStartedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00160">IopHardwareProfileMarkDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00251">IopHardwareProfileQueryChange()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00068">IopPnPSpinLock</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00191">IopUncacheInterfaceInformation()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00160">IRP_MN_START_DEVICE</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00094">_DEVICE_COMPLETION_CONTEXT::IrpMinorCode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d1/pnpirp_8c.html#a6">PDEVICE_COMPLETION_CONTEXT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00173">PnpAsyncOk</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a158">PpSetTargetDeviceRemove()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a388a210">PROFILE_PERHAPS_IN_PNPEVENT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00161">_DEVICE_NODE::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00163">_DEVICE_NODE::ResourceListTranslated</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00820">SAVE_FAILURE_INFO</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00093">_DEVICE_COMPLETION_CONTEXT::Thread</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>.
<p>
<pre class="fragment"><div>00516                    :
00517 
00518     This function sends a start device irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top level device
00519     object which roots on DeviceObject.
00520 
00521 Parameters:
00522 
00523     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
00524                    being removed.
00525 
00526 Return Value:
00527 
00528     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00529 
00530 --*/
00531 
00532 {
00533     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
00534     PVOID <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
00535     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00536     <a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a> completionContext;
00537     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00538     PNP_VETO_TYPE  vetoType;
00539 
00540 <span class="comment">//    PAGED_CODE();</span>
00541 
00542     <span class="comment">//</span>
00543     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
00544     <span class="comment">//</span>
00545 
00546     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
00547 
00548     <span class="comment">//</span>
00549     <span class="comment">// Set the function codes.</span>
00550     <span class="comment">//</span>
00551 
00552     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
00553     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a65">IRP_MN_START_DEVICE</a>;
00554 
00555     <span class="comment">//</span>
00556     <span class="comment">// Set the pointers for the raw and translated resource lists</span>
00557     <span class="comment">//</span>
00558 
00559     <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>)) {
00560         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.StartDevice.AllocatedResources = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>;
00561         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.StartDevice.AllocatedResourcesTranslated = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a>;
00562     }
00563 
00564     <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>)) {
00565         <a class="code" href="../../d0/d1/pnpirp_8c.html#a17">IopUncacheInterfaceInformation</a>(DeviceObject);
00566     }
00567 
00568     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a24">PnpAsyncOk</a>) {
00569 
00570         <span class="comment">//</span>
00571         <span class="comment">// ADRIAO BUGBUG 11/18/98 -</span>
00572         <span class="comment">//     The dock code has not been duplicated in the async case, but as</span>
00573         <span class="comment">// PnpAsync support is totally broken and disabled anyway, this should</span>
00574         <span class="comment">// not matter right now.</span>
00575         <span class="comment">//</span>
00576         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
00577         completionContext = (<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">PDEVICE_COMPLETION_CONTEXT</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00578                               NonPagedPool,
00579                               <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html">DEVICE_COMPLETION_CONTEXT</a>));
00580         <span class="keywordflow">if</span> (completionContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00581             <span class="keywordflow">return</span>;   <span class="comment">// BUGBUG - Should try it again *explicitly*</span>
00582         }
00583 
00584         completionContext-&gt;<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html#o0">DeviceNode</a> = deviceNode;
00585         completionContext-&gt;<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html#o2">IrpMinorCode</a> = <a class="code" href="../../d0/d5/io_8h.html#a65">IRP_MN_START_DEVICE</a>;
00586         completionContext-&gt;<a class="code" href="../../d5/d3/struct__DEVICE__COMPLETION__CONTEXT.html#o1">Thread</a> = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
00587 
00588         <span class="comment">//</span>
00589         <span class="comment">// Make the call and return.</span>
00590         <span class="comment">//</span>
00591 
00592         <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(NULL);  <span class="comment">// To block IopAcquireTreeLock();</span>
00593         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a9">IopAsynchronousCall</a>(DeviceObject, &amp;irpSp, completionContext, IopDeviceStartComplete);
00594         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00595 
00596             KIRQL oldIrql;
00597 
00598             <span class="comment">//</span>
00599             <span class="comment">// Set DNF_START_REQUEST_PENDING flag such that the completion routine knows it</span>
00600             <span class="comment">// needs to request enumeration when the start completed successfully.</span>
00601             <span class="comment">//</span>
00602 
00603             ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
00604 
00605             <span class="keywordflow">if</span> (!(<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(deviceNode) || (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>))) {
00606                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a14">DNF_START_REQUEST_PENDING</a>;
00607             }
00608             ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
00609         }
00610     } <span class="keywordflow">else</span> {
00611 
00612         <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>)||
00613             (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>)) {
00614 
00615 
00616             <span class="comment">//</span>
00617             <span class="comment">// This is either the rebalance case in which we are restarting a</span>
00618             <span class="comment">// temporarily stopped device, or we are starting a non-dock device,</span>
00619             <span class="comment">// and it was previously off.</span>
00620             <span class="comment">//</span>
00621             status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, &amp;dummy);
00622 
00623         } <span class="keywordflow">else</span> {
00624 
00625             <span class="comment">//</span>
00626             <span class="comment">// This is a dock so we a little bit of work before starting it.</span>
00627             <span class="comment">// Take the profile change semaphore. We do this whenever a dock</span>
00628             <span class="comment">// is in our list, even if no query is going to occur.</span>
00629             <span class="comment">//</span>
00630             <a class="code" href="../../d9/d0/pnpiop_8h.html#a377">IopHardwareProfileBeginTransition</a>(FALSE);
00631 
00632             <span class="comment">//</span>
00633             <span class="comment">// Tell the profile code what dock device object may be bringing the</span>
00634             <span class="comment">// new hardware profile online.</span>
00635             <span class="comment">//</span>
00636             <a class="code" href="../../d9/d0/pnpiop_8h.html#a378">IopHardwareProfileMarkDock</a>(deviceNode, DOCK_ARRIVING);
00637 
00638             <span class="comment">//</span>
00639             <span class="comment">// Ask everyone if this is really a good idea right now. Note that</span>
00640             <span class="comment">// PiProcessStart calls IopNewDevice calls IopStartAndEnumerateDevice</span>
00641             <span class="comment">// who calls this function on that thread. Therefore we may indded be</span>
00642             <span class="comment">// in an event, although this would probably be a fairly rare event</span>
00643             <span class="comment">// for a dock.</span>
00644             <span class="comment">//</span>
00645             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a379">IopHardwareProfileQueryChange</a>(
00646                 FALSE,
00647                 PROFILE_PERHAPS_IN_PNPEVENT,
00648                 &amp;vetoType,
00649                 NULL
00650                 );
00651 
00652             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00653 
00654                 status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(DeviceObject, &amp;irpSp, &amp;dummy);
00655             }
00656 
00657             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00658 
00659                 <span class="comment">//</span>
00660                 <span class="comment">// Commit the current Hardware Profile as necessary.</span>
00661                 <span class="comment">//</span>
00662                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a380">IopHardwareProfileCommitStartedDock</a>(deviceNode);
00663 
00664             } <span class="keywordflow">else</span> {
00665 
00666                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a383">IopHardwareProfileCancelTransition</a>();
00667             }
00668         }
00669 
00670         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00671             ULONG Problem = CM_PROB_FAILED_START;
00672 
00673             <a class="code" href="../../d9/d0/pnpiop_8h.html#a76">SAVE_FAILURE_INFO</a>(deviceNode, status);
00674 
00675             <span class="comment">//</span>
00676             <span class="comment">// Handle certain problems determined by the status code</span>
00677             <span class="comment">//</span>
00678             <span class="keywordflow">switch</span> (status) {
00679                 <span class="keywordflow">case</span> STATUS_PNP_REBOOT_REQUIRED:
00680                     Problem = CM_PROB_NEED_RESTART;
00681                     <span class="keywordflow">break</span>;
00682 
00683                 <span class="keywordflow">default</span>:
00684                     Problem = CM_PROB_FAILED_START;
00685             }
00686             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, Problem);
00687 
00688             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a203">DOCK_NOTDOCKDEVICE</a>) {
00689 
00690                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>, CM_PROB_FAILED_START);
00691             } <span class="keywordflow">else</span> {
00692 
00693                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.DockStatus == DOCK_QUIESCENT);
00694 
00695                 <a class="code" href="../../d6/d9/pnp_8h.html#a158">PpSetTargetDeviceRemove</a>( deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
00696                                          FALSE,
00697                                          TRUE,
00698                                          TRUE,
00699                                          CM_PROB_DEVICE_NOT_THERE,
00700                                          NULL,
00701                                          NULL,
00702                                          NULL,
00703                                          NULL);
00704             }
00705 
00706         } <span class="keywordflow">else</span> {
00707 
00708             <a class="code" href="../../d9/d0/pnpiop_8h.html#a356">IopDoDeferredSetInterfaceState</a>(deviceNode);
00709 
00710             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>;
00711 
00712             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>) {
00713 
00714                 <span class="comment">//</span>
00715                 <span class="comment">// If the start is initiated by rebalancing, do NOT do enumeration</span>
00716                 <span class="comment">//</span>
00717 
00718                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>;
00719 
00720             } <span class="keywordflow">else</span> {
00721 
00722                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a25">DNF_NEED_ENUMERATION_ONLY</a>;
00723 
00724             }
00725         }
00726     }
00727 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a287" doxytag="pnpiop.h::IopStartDriverDevices" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopStartDriverDevices           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01740">1740</a> of file <a class="el" href="../../d3/d9/pnpdd_8c-source.html">pnpdd.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00039">_DEVICE_LIST_CONTEXT::DeviceCount</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00041">_DEVICE_LIST_CONTEXT::DeviceList</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00402">DNF_NEED_QUERY_IDS</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01411">IopGetDriverDeviceList()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d0/pnpdd_8c.html#a1">PDEVICE_LIST_CONTEXT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00590">PDRIVER_ADD_DEVICE</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00110">PnPInitialized</a>, and <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a224">StartDevice</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>01746                    :
01747 
01748     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by <a class="code" href="../../d2/d4/internal_8c.html#a47">IopLoadDriver</a> to add/start <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices controlled by
01749     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly loaded driver.
01750 
01751 Arguments:
01752 
01753     DriverObject - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being started thru
01754                    <a class="code" href="../../d2/d4/internal_8c.html#a47">IopLoadDriver</a> after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot drivers and system drivers init
01755                    phase.
01756 
01757 Return Value:
01758 
01759     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01760 
01761 --*/
01762 
01763 {
01764     ULONG count, i;
01765     <a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html">PDEVICE_LIST_CONTEXT</a> deviceList;
01766     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
01767     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01768     <a class="code" href="../../d0/d5/io_8h.html#a290">PDRIVER_ADD_DEVICE</a> addDeviceRoutine;
01769 
01770     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01771 
01772     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/pnpdata_8c.html#a14">PnPInitialized</a>) {
01773 
01774         <span class="comment">//</span>
01775         <span class="comment">// If this function is called at PnP Init time, we don't start the devices</span>
01776         <span class="comment">// for the specified driver.  The device add/start is handled by pnp based</span>
01777         <span class="comment">// on the device enumeration.</span>
01778         <span class="comment">//</span>
01779 
01780         <span class="keywordflow">return</span> status;
01781     }
01782 
01783     addDeviceRoutine = DriverObject-&gt;DriverExtension-&gt;AddDevice;
01784     <span class="keywordflow">if</span> (addDeviceRoutine == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01785         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(addDeviceRoutine);
01786         <span class="keywordflow">return</span> status;
01787     }
01788 
01789     <a class="code" href="../../d2/d0/pnpdd_8c.html#a6">IopGetDriverDeviceList</a>(DriverObject, &amp;deviceList);
01790     count = deviceList ? deviceList-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o0">DeviceCount</a> : 0;
01791     <span class="keywordflow">if</span> (count == 0) {
01792 
01793         <span class="keywordflow">if</span> (deviceList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01794             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceList);
01795         }
01796 
01797         <span class="keywordflow">return</span> STATUS_PLUGPLAY_NO_DEVICE;
01798     }
01799 
01800     <span class="comment">//</span>
01801     <span class="comment">// For each device int the list queue an IopNewDeviceEvent if the device is reported by driver</span>
01802     <span class="comment">//</span>
01803 
01804     <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
01805 
01806         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceList-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o2">DeviceList</a>[i]-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01807         <span class="keywordflow">if</span> (!deviceNode || !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a>) ) {
01808             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceList-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o2">DeviceList</a>[i]);
01809             <span class="keywordflow">continue</span>;
01810         }
01811         <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>(deviceList-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o2">DeviceList</a>[i], StartDevice, NULL, NULL);
01812     }
01813 
01814     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceList);
01815     <span class="keywordflow">return</span> status;
01816 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a291" doxytag="pnpiop.h::IopSynchronousCall" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSynchronousCall           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TopStackLocation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Information</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">381</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00110">IRP_SYSTEM_RESTRICTED</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00026">PnpIrpStatusTracking</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00690">SPECIALIRP_WATERMARK_IRP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01300">IoFreeDumpStack()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08036">IopGetRelatedTargetDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02173">IopQueryCompatibleIds()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03694">IopQueryDeviceCapabilities()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01762">IopQueryDeviceId()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03195">IopQueryDeviceSerialNumber()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02976">IopQueryDeviceState()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03395">IopQueryDockRemovalInterface()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02793">IopQueryLegacyBusInformation()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02885">IopQueryPnpBusInformation()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02733">IopQueryReconfiguration()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02617">IopQueryResourceHandlerInterface()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01820">IopQueryUniqueId()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.
<p>
<pre class="fragment"><div>00389                    :
00390 
00391     This function sends a synchronous irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top level device
00392     object which roots on DeviceObject.
00393 
00394 Parameters:
00395 
00396     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being removed.
00397 
00398     TopStackLocation - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameter block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp.
00399 
00400     Information - Supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned
00401                   information of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp.
00402 
00403 Return Value:
00404 
00405     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00406 
00407 --*/
00408 
00409 {
00410     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00411     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00412     IO_STATUS_BLOCK statusBlock;
00413     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
00414     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00415     PULONG_PTR returnInfo = (PULONG_PTR)Information;
00416     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00417 
00418     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00419 
00420     <span class="comment">//</span>
00421     <span class="comment">// Get a pointer to the topmost device object in the stack of devices,</span>
00422     <span class="comment">// beginning with the deviceObject.</span>
00423     <span class="comment">//</span>
00424 
00425     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(DeviceObject);
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">// Begin by allocating the IRP for this request.  Do not charge quota to</span>
00429     <span class="comment">// the current process for this IRP.</span>
00430     <span class="comment">//</span>
00431 
00432     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>(deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, FALSE);
00433     <span class="keywordflow">if</span> (irp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
00434 
00435         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00436     }
00437 
00438     <a class="code" href="../../d9/d4/trackirp_8h.html#a86">SPECIALIRP_WATERMARK_IRP</a>(irp, IRP_SYSTEM_RESTRICTED);
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// Initialize it to failure.</span>
00442     <span class="comment">//</span>
00443 
00444     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = statusBlock.Status = STATUS_NOT_SUPPORTED;
00445     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = statusBlock.Information = 0;
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">// Set the pointer to the status block and initialized event.</span>
00449     <span class="comment">//</span>
00450 
00451     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
00452                        SynchronizationEvent,
00453                        FALSE );
00454 
00455     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;statusBlock;
00456     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
00457 
00458     <span class="comment">//</span>
00459     <span class="comment">// Set the address of the current thread</span>
00460     <span class="comment">//</span>
00461 
00462     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00463 
00464     <span class="comment">//</span>
00465     <span class="comment">// Queue this irp onto the current thread</span>
00466     <span class="comment">//</span>
00467 
00468     <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>(irp);
00469 
00470     <span class="comment">//</span>
00471     <span class="comment">// Get a pointer to the stack location of the first driver which will be</span>
00472     <span class="comment">// invoked.  This is where the function codes and parameters are set.</span>
00473     <span class="comment">//</span>
00474 
00475     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>(irp);
00476 
00477     <span class="comment">//</span>
00478     <span class="comment">// Copy in the caller-supplied stack location contents</span>
00479     <span class="comment">//</span>
00480 
00481     *irpSp = *TopStackLocation;
00482 
00483     <span class="comment">//</span>
00484     <span class="comment">// Call the driver</span>
00485     <span class="comment">//</span>
00486 
00487     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(deviceObject, irp);
00488 
00489     <a class="code" href="../../d0/d1/pnpirp_8c.html#a0">PnpIrpStatusTracking</a>(status, TopStackLocation-&gt;MinorFunction, deviceObject);
00490 
00491     <span class="comment">//</span>
00492     <span class="comment">// If a driver returns STATUS_PENDING, we will wait for it to complete</span>
00493     <span class="comment">//</span>
00494 
00495     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00496         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
00497                                       Executive,
00498                                       KernelMode,
00499                                       FALSE,
00500                                       (PLARGE_INTEGER) NULL );
00501         status = statusBlock.Status;
00502     }
00503 
00504     *returnInfo = (ULONG_PTR) statusBlock.Information;
00505 
00506     <span class="keywordflow">return</span> status;
00507 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a360" doxytag="pnpiop.h::IopUncacheInterfaceInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopUncacheInterfaceInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00191">191</a> of file <a class="el" href="../../d1/d0/pnpirp_8c-source.html">pnpirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01943">_INTERFACE::Context</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00239">_DEVICE_NODE::DeviceArbiterList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00246">_DEVICE_NODE::DeviceTranslatorList</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01945">_INTERFACE::InterfaceDereference</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00267">_DEVICE_NODE::NoArbiterMask</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00253">_DEVICE_NODE::NoTranslatorMask</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00274">_DEVICE_NODE::QueryArbiterMask</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00260">_DEVICE_NODE::QueryTranslatorMask</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00732">_PI_RESOURCE_TRANSLATOR_ENTRY::TranslatorInterface</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/devnode_8c-source.html#l00297">IopDestroyDeviceNode()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06387">IopInvalidateDeviceStateWorker()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>, and <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>.
<p>
<pre class="fragment"><div>00197                    :
00198 
00199     This function removes all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cached translators and arbiters information
00200     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object.
00201 
00202 Parameters:
00203 
00204     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being removed.
00205 
00206 Return Value:
00207 
00208     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00209 
00210 --*/
00211 
00212 {
00213     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00214     PLIST_ENTRY listHead, nextEntry, entry;
00215     <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a> handlerEntry;
00216     <a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a> interface;
00217 
00218     <span class="comment">//</span>
00219     <span class="comment">// Dereference all the arbiters on this PDO.</span>
00220     <span class="comment">//</span>
00221 
00222     listHead = &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o24">DeviceArbiterList</a>;
00223     nextEntry = listHead-&gt;Flink;
00224     <span class="keywordflow">while</span> (nextEntry != listHead) {
00225         entry = nextEntry;
00226         nextEntry = nextEntry-&gt;Flink;
00227         handlerEntry = CONTAINING_RECORD(entry, <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PI_RESOURCE_TRANSLATOR_ENTRY</a>, DeviceTranslatorList);
00228         <span class="keywordflow">if</span> (interface = (<a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a>)handlerEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o2">TranslatorInterface</a>) {
00229             (interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o4">InterfaceDereference</a>)(interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o2">Context</a>);
00230             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(interface);
00231         }
00232         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry);
00233     }
00234     InitializeListHead(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o24">DeviceArbiterList</a>);
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">// Dereference all the translators on this PDO.</span>
00238     <span class="comment">//</span>
00239 
00240     listHead = &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o25">DeviceTranslatorList</a>;
00241     nextEntry = listHead-&gt;Flink;
00242     <span class="keywordflow">while</span> (nextEntry != listHead) {
00243         entry = nextEntry;
00244         nextEntry = nextEntry-&gt;Flink;
00245         handlerEntry = CONTAINING_RECORD(entry, <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PI_RESOURCE_TRANSLATOR_ENTRY</a>, DeviceTranslatorList);
00246         <span class="keywordflow">if</span> (interface = (<a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a>)handlerEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o2">TranslatorInterface</a>) {
00247             (interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o4">InterfaceDereference</a>)(interface-&gt;<a class="code" href="../../d8/d3/struct__INTERFACE.html#o2">Context</a>);
00248             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(interface);
00249         }
00250         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry);
00251     }
00252 
00253     InitializeListHead(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o25">DeviceTranslatorList</a>);
00254 
00255     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o28">NoArbiterMask</a> = 0;
00256     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o29">QueryArbiterMask</a> = 0;
00257     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o26">NoTranslatorMask</a> = 0;
00258     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o27">QueryTranslatorMask</a> = 0;
00259 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a314" doxytag="pnpiop.h::IopUnlockDeviceRemovalRelations" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopUnlockDeviceRemovalRelations           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RelationsList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a114">UNLOCK_UNLINK_ACTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>UnlinkAction</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01572">1572</a> of file <a class="el" href="../../d4/d9/pnpdel_8c-source.html">pnpdel.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00396">DNF_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00553">DNF_REMOVE_PENDING_CLOSES</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00453">DNF_RESOURCE_ASSIGNED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00170">_DEVICE_NODE::EnumerationMutex</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03841">IopCleanupDeviceRegistryValues()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations()</a>, <a class="el" href="../../d7/d1/pnprlist_8h.html#a16">IopRemoveRelationFromList()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00494">IopRemoveTreeDeviceNode()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00301">_DEVICE_NODE::LockCount</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a389a212">UnlinkAllDeviceNodesPendingClose</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a389a211">UnlinkRemovedDeviceNodes</a>, and <a class="el" href="../../d9/d0/pnpiop_8h.html#a114">UNLOCK_UNLINK_ACTION</a>.
<p>
<pre class="fragment"><div>01580                    :
01581 
01582     This routine unlocks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device tree deletion operation.
01583     If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> any pending kernel deletion, <span class="keyword">this</span> routine initiates
01584     a worker thread to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work.
01585 
01586 Arguments:
01587 
01588     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object to which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remove
01589         was originally targetted (as opposed to one of the relations).
01590 
01591     DeviceRelations - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's removal relations.
01592 
01593     UnlinkAction - Specifies which devnodes will be unlinked from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devnode
01594         tree.
01595 
01596         UnLinkRemovedDeviceNodes - Devnodes which are no longer enumerated and
01597             have been sent a REMOVE_DEVICE <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> are unlinked.
01598 
01599         <a class="code" href="../../d9/d0/pnpiop_8h.html#a389a212">UnlinkAllDeviceNodesPendingClose</a> - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used when a device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01600             surprise removed.  Devnodes in RelationsList are unlinked from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01601             tree <span class="keywordflow">if</span> they don'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> have children and aren'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> consuming any resources.
01602 
01603         <a class="code" href="../../d9/d0/pnpiop_8h.html#a389a213">UnlinkOnlyChildDeviceNodesPendingClose</a> - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used when a device fails
01604             <span class="keywordflow">while</span> started.  We unlink any child devnodes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device which
01605             failed but not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> failed device's devnode.
01606 
01607 Return Value:
01608 
01609     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01610 
01611 --*/
01612 
01613 {
01614     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01615     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode, parent;
01616     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject, relatedDeviceObject;
01617     ULONG i;
01618     ULONG marker;
01619 
01620     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01621 
01622     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01623     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;PpRegistryDeviceResource, TRUE);
01624 
01625     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RelationsList)) {
01626         marker = 0;
01627         <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations</a>( RelationsList,
01628                                       &amp;marker,
01629                                       &amp;deviceObject,
01630                                       NULL,
01631                                       NULL,
01632                                       TRUE)) {
01633 
01634             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01635             parent = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
01636 
01637             <span class="comment">//</span>
01638             <span class="comment">// There are three different scenarios in which we want to unlink a</span>
01639             <span class="comment">// devnode from the tree.  The first case is tested in the first</span>
01640             <span class="comment">// part of the condition.  The other two in the second part.</span>
01641             <span class="comment">//</span>
01642             <span class="comment">// 1) A devnode is no longer enumerated and has been sent a</span>
01643             <span class="comment">//    remove IRP.</span>
01644             <span class="comment">//</span>
01645             <span class="comment">// 2) A devnode has been surprise removed, has no children, has</span>
01646             <span class="comment">//    no resources or they've been freed.  UnlinkAction will be</span>
01647             <span class="comment">//    UnlinkAllDeviceNodesPendingClose.</span>
01648             <span class="comment">//</span>
01649             <span class="comment">// 3) A devnode has failed and a surprise remove IRP has been sent.</span>
01650             <span class="comment">//    Then we want to remove children without resources but not the</span>
01651             <span class="comment">//    failed devnode itself.  UnlinkAction will be</span>
01652             <span class="comment">//    UnlinkOnlyChildDeviceNodesPendingClose.</span>
01653             <span class="comment">//</span>
01654 
01655             <span class="keywordflow">if</span> ((!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>)) &amp;&amp;
01656                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(deviceNode)) ||
01657                 (UnlinkAction != <a class="code" href="../../d9/d0/pnpiop_8h.html#a389a211">UnlinkRemovedDeviceNodes</a> &amp;&amp;
01658                     (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>) &amp;&amp;
01659                     !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>) &amp;&amp;
01660                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01661                     (UnlinkAction == <a class="code" href="../../d9/d0/pnpiop_8h.html#a389a212">UnlinkAllDeviceNodesPendingClose</a> ||
01662                      deviceObject != DeviceObject))) {
01663 
01664                 PIDBGMSG( PIDBG_REMOVAL,
01665                           (<span class="stringliteral">"IopUnlockDeviceRemovalRelations: Cleaning up registry values, instance = %wZ\n"</span>,
01666                           &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>));
01667 
01668                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a25">IopCleanupDeviceRegistryValues</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>, FALSE);
01669 
01670                 PIDBGMSG( PIDBG_REMOVAL,
01671                           (<span class="stringliteral">"IopUnlockDeviceRemovalRelations: Removing DevNode tree, DevNode = 0x%p\n"</span>,
01672                           deviceNode));
01673 
01674                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a251">IopRemoveTreeDeviceNode</a>(deviceNode);
01675 
01676                 <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>)) {
01677                     <a class="code" href="../../d7/d1/pnprlist_8h.html#a16">IopRemoveRelationFromList</a>(RelationsList, deviceObject);
01678                 }
01679                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject); <span class="comment">// Added during enum</span>
01680             }
01681 
01682             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> &gt; 0);
01683 
01684             <span class="keywordflow">if</span> (--deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
01685                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, FALSE);
01686                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);
01687             }
01688 
01689             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> &gt; 0);
01690 
01691             <span class="keywordflow">if</span> (--parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
01692                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, FALSE);
01693                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
01694             }
01695         }
01696     }
01697 
01698     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
01699     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01700 
01701     <span class="keywordflow">return</span> STATUS_SUCCESS;
01702 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a353" doxytag="pnpiop.h::IopUnregisterDeviceInterface" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopUnregisterDeviceInterface           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SymbolicLinkName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04140">4140</a> of file <a class="el" href="../../d9/d9/pnpioapi_8c-source.html">pnpioapi.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05619">IopAllocateUnicodeString()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01983">IopConstStringSize</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05902">IopDeleteKeyRecursive()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03708">IopDeviceInterfaceKeysFromSymbolicLink()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05668">IopFreeAllocatedUnicodeString()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02462">IopGetRegistryKeyInformation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l05424">IopParseSymbolicLinkName()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03563">IoSetDeviceInterfaceState()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00145">KEY_STRING_PREFIX</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00164">REFSTRING_PREFIX_CHAR</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">IopRemoveDeviceInterfaces()</a>.
<p>
<pre class="fragment"><div>04146                    :
04147 
04148     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface instance subkey of
04149     ReferenceString from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface <span class="keywordflow">for</span> DeviceInstanceName to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04150     given InterfaceClassGuid.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface instance specified by
04151     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Reference <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> portion of SymbolicLinkName <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
04152     instance of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface subkey <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed from
04153     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <span class="keyword">class </span>key as well.
04154 
04155 Parameters:
04156 
04157     SymbolicLinkName - Supplies a pointer to a unicode string which
04158         contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic link name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device to unregister.
04159 
04160 Return Value:
04161 
04162     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
04163 
04164 --*/
04165 
04166 {
04167     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status = STATUS_SUCCESS, context;
04168     HANDLE          hInterfaceClassKey=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hInterfaceKey=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04169                     hInterfaceInstanceKey=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hControl=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04170     UNICODE_STRING  tempString, mungedPathString, guidString, refString;
04171     BOOLEAN         refStringPresent;
04172     GUID            guid;
04173     UNICODE_STRING  interfaceKeyName, instanceKeyName;
04174     ULONG           linked, remainingSubKeys;
04175     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>          length;
04176     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04177     PKEY_FULL_INFORMATION keyInformation;
04178 
04179 
04180     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04181 
04182     <span class="comment">//</span>
04183     <span class="comment">// Check that the supplied symbolic link is present, and can be parsed</span>
04184     <span class="comment">//</span>
04185     <span class="keywordflow">if</span> ( (!ARGUMENT_PRESENT(SymbolicLinkName)) ||
04186          (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a66">IopParseSymbolicLinkName</a>(SymbolicLinkName,
04187                                               NULL,
04188                                               &amp;mungedPathString,
04189                                               &amp;guidString,
04190                                               &amp;refString,
04191                                               &amp;refStringPresent,
04192                                               &amp;guid))) ) {
04193         status = STATUS_INVALID_PARAMETER;
04194         <span class="keywordflow">goto</span> clean0;
04195     }
04196 
04197     <span class="comment">//</span>
04198     <span class="comment">// Allocate a unicode string for the interface instance key name.</span>
04199     <span class="comment">// (includes the REFSTRING_PREFIX_CHAR, and ReferenceString, if present)</span>
04200     <span class="comment">//</span>
04201     length = <span class="keyword">sizeof</span>(WCHAR) + refString.Length;
04202     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a373">IopAllocateUnicodeString</a>(&amp;instanceKeyName,
04203                                       length);
04204     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04205         <span class="keywordflow">goto</span> clean0;
04206     }
04207 
04208     <span class="comment">//</span>
04209     <span class="comment">// Set the MaximumLength of the Buffer, and append the</span>
04210     <span class="comment">// REFSTRING_PREFIX_CHAR to it.</span>
04211     <span class="comment">//</span>
04212     *instanceKeyName.Buffer = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a25">REFSTRING_PREFIX_CHAR</a>;
04213     instanceKeyName.Length = <span class="keyword">sizeof</span>(WCHAR);
04214     instanceKeyName.MaximumLength = length + <span class="keyword">sizeof</span>(UNICODE_NULL);
04215 
04216     <span class="comment">//</span>
04217     <span class="comment">// Append the ReferenceString to the prefix char, if necessary.</span>
04218     <span class="comment">//</span>
04219     <span class="keywordflow">if</span> (refStringPresent) {
04220         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;instanceKeyName, &amp;refString);
04221     }
04222 
04223     instanceKeyName.Buffer[instanceKeyName.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
04224 
04225     <span class="comment">//</span>
04226     <span class="comment">// Allocate a unicode string for the interface key name.</span>
04227     <span class="comment">// (includes KEY_STRING_PREFIX, mungedPathString, separating '#'</span>
04228     <span class="comment">//  char, and the guidString)</span>
04229     <span class="comment">//</span>
04230     length = <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(KEY_STRING_PREFIX) + mungedPathString.Length +
04231              <span class="keyword">sizeof</span>(WCHAR) + guidString.Length;
04232 
04233     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a373">IopAllocateUnicodeString</a>(&amp;interfaceKeyName,
04234                                       length);
04235     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04236         <span class="keywordflow">goto</span> clean1;
04237     }
04238 
04239     interfaceKeyName.MaximumLength = length + <span class="keyword">sizeof</span>(UNICODE_NULL);
04240 
04241     <span class="comment">//</span>
04242     <span class="comment">// Copy the symbolic link name (without refString) to the interfaceKeyNam</span>
04243     <span class="comment">//</span>
04244     RtlCopyMemory(interfaceKeyName.Buffer, SymbolicLinkName-&gt;Buffer, length);
04245     interfaceKeyName.Length = length;
04246     interfaceKeyName.Buffer[interfaceKeyName.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
04247 
04248     <span class="comment">//</span>
04249     <span class="comment">// Replace the "\??\" or "\\?\" symbolic link name prefix with "##?#"</span>
04250     <span class="comment">//</span>
04251     RtlCopyMemory(interfaceKeyName.Buffer,
04252                   KEY_STRING_PREFIX,
04253                   <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(KEY_STRING_PREFIX));
04254 
04255     <span class="comment">//</span>
04256     <span class="comment">// Enter critical section and acquire a lock on the registry.  Both these</span>
04257     <span class="comment">// mechanisms are required to prevent deadlock in the case where an APC</span>
04258     <span class="comment">// routine calls this routine after the registry resource has been claimed</span>
04259     <span class="comment">// in this case it would wait blocking this thread so the registry would</span>
04260     <span class="comment">// never be released -&gt; deadlock.  Critical sectioning the registry manipulation</span>
04261     <span class="comment">// portion solves this problem</span>
04262     <span class="comment">//</span>
04263 
04264     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
04265     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;PpRegistryDeviceResource, TRUE);
04266 
04267     <span class="comment">//</span>
04268     <span class="comment">// Get class, interface, and instance handles</span>
04269     <span class="comment">//</span>
04270     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a62">IopDeviceInterfaceKeysFromSymbolicLink</a>(SymbolicLinkName,
04271                                                     KEY_ALL_ACCESS,
04272                                                     &amp;hInterfaceClassKey,
04273                                                     &amp;hInterfaceKey,
04274                                                     &amp;hInterfaceInstanceKey
04275                                                     );
04276     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04277         <span class="keywordflow">goto</span> clean2;
04278     }
04279 
04280     <span class="comment">//</span>
04281     <span class="comment">// Determine whether this interface is currently "enabled"</span>
04282     <span class="comment">//</span>
04283     linked = 0;
04284     PiWstrToUnicodeString(&amp;tempString, REGSTR_KEY_CONTROL);
04285     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hControl,
04286                                    hInterfaceInstanceKey,
04287                                    &amp;tempString,
04288                                    KEY_ALL_ACCESS
04289                                    );
04290     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04291         <span class="comment">//</span>
04292         <span class="comment">// Check the "linked" value under the "Control" subkey of this</span>
04293         <span class="comment">// interface instance</span>
04294         <span class="comment">//</span>
04295         keyValueInformation=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04296         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hControl,
04297                                      REGSTR_VAL_LINKED,
04298                                      &amp;keyValueInformation);
04299 
04300         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04301             <span class="keywordflow">if</span> (keyValueInformation-&gt;Type == REG_DWORD &amp;&amp;
04302                 keyValueInformation-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)) {
04303 
04304                 linked = *((PULONG) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation));
04305                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04306             }
04307         }
04308 
04309         ZwClose(hControl);
04310         hControl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04311     }
04312 
04313     <span class="comment">//</span>
04314     <span class="comment">// Ignore any status code returned while attempting to retieve the</span>
04315     <span class="comment">// state of the device.  The value of linked will tell us if we</span>
04316     <span class="comment">// need to disable the interface instance first.</span>
04317     <span class="comment">//</span>
04318     <span class="comment">// If no instance "Control" subkey or "linked" value was present</span>
04319     <span class="comment">//     (status == STATUS_OBJECT_NAME_NOT_FOUND), this interface instance</span>
04320     <span class="comment">//     is not currently enabled -- ok to delete.</span>
04321     <span class="comment">//</span>
04322     <span class="comment">// If the attempt to retrieve these values failed with some other error,</span>
04323     <span class="comment">//     any attempt to disable the interface will also likely fail,</span>
04324     <span class="comment">//     so we'll just have to delete this instance anyways.</span>
04325     <span class="comment">//</span>
04326     status = STATUS_SUCCESS;
04327 
04328     <span class="keywordflow">if</span> (linked) {
04329         <span class="comment">//</span>
04330         <span class="comment">// Disabled the active interface before unregistering it, ignore any</span>
04331         <span class="comment">// status returned, we'll delete this interface instance key anyways.</span>
04332         <span class="comment">//</span>
04333         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a87">IoSetDeviceInterfaceState</a>(SymbolicLinkName, FALSE);
04334     }
04335 
04336     <span class="comment">//</span>
04337     <span class="comment">// Recursively delete the interface instance key, if it exists.</span>
04338     <span class="comment">//</span>
04339     ZwClose(hInterfaceInstanceKey);
04340     hInterfaceInstanceKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04341     <a class="code" href="../../d9/d1/pnpsubs_8c.html#a41">IopDeleteKeyRecursive</a> (hInterfaceKey, instanceKeyName.Buffer);
04342 
04343     <span class="comment">//</span>
04344     <span class="comment">// Find out how many subkeys to the interface key remain.</span>
04345     <span class="comment">//</span>
04346     status = <a class="code" href="../../d0/d6/iop_8h.html#a179">IopGetRegistryKeyInformation</a>(hInterfaceKey,
04347                                           &amp;keyInformation);
04348     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04349         <span class="keywordflow">goto</span> clean3;
04350     }
04351 
04352     remainingSubKeys = keyInformation-&gt;SubKeys;
04353 
04354     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyInformation);
04355 
04356     <span class="comment">//</span>
04357     <span class="comment">// See if a volatile "Control" subkey exists under this interface key</span>
04358     <span class="comment">//</span>
04359     PiWstrToUnicodeString(&amp;tempString, REGSTR_KEY_CONTROL);
04360     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hControl,
04361                                    hInterfaceKey,
04362                                    &amp;tempString,
04363                                    KEY_READ
04364                                    );
04365     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04366         ZwClose(hControl);
04367         hControl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04368     }
04369     <span class="keywordflow">if</span> ((remainingSubKeys==0) ||
04370         ((remainingSubKeys==1) &amp;&amp; (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)))) {
04371         <span class="comment">//</span>
04372         <span class="comment">// If the interface key has no subkeys, or the only the remaining subkey</span>
04373         <span class="comment">// is the volatile interface "Control" subkey, then there are no more</span>
04374         <span class="comment">// instances to this interface.  We should delete the interface key</span>
04375         <span class="comment">// itself also.</span>
04376         <span class="comment">//</span>
04377         ZwClose(hInterfaceKey);
04378         hInterfaceKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04379 
04380         <a class="code" href="../../d9/d1/pnpsubs_8c.html#a41">IopDeleteKeyRecursive</a> (hInterfaceClassKey, interfaceKeyName.Buffer);
04381     }
04382 
04383     status = STATUS_SUCCESS;
04384 
04385 
04386 clean3:
04387     <span class="keywordflow">if</span> (hControl) {
04388         ZwClose(hControl);
04389     }
04390     <span class="keywordflow">if</span> (hInterfaceInstanceKey) {
04391         ZwClose(hInterfaceInstanceKey);
04392     }
04393     <span class="keywordflow">if</span> (hInterfaceKey) {
04394         ZwClose(hInterfaceKey);
04395     }
04396     <span class="keywordflow">if</span> (hInterfaceClassKey) {
04397         ZwClose(hInterfaceClassKey);
04398     }
04399 
04400 clean2:
04401     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
04402     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
04403 
04404     <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;interfaceKeyName);
04405 
04406 clean1:
04407     <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;instanceKeyName);
04408 
04409 clean0:
04410     <span class="keywordflow">return</span> status;
04411 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a386" doxytag="pnpiop.h::IopWarmEjectDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopWarmEjectDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceToEject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SYSTEM_POWER_STATE&nbsp;</td>
          <td class="mdname" nowrap> <em>LightestSleepState</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00422">422</a> of file <a class="el" href="../../d5/d0/pnppower_8c-source.html">pnppower.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00155">IoDeviceNodeTreeSequence</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01293">IopAcquireDeviceTreeLock</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01294">IopReleaseDeviceTreeLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00193">IopWarmEjectLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00198">IopWarmEjectPdo</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01417">IopProcessCompletedEject()</a>.
<p>
<pre class="fragment"><div>00428                    :
00429 
00430     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to initiate a warm eject. The eject progresses
00431     from S1 to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed in lightest sleep state.
00432 
00433 Arguments:
00434 
00435     DeviceToEject       - The device to eject
00436 
00437     LightestSleepState  - The lightest S state (at least S1) that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
00438                           may be ejected in. This might be S4 <span class="keywordflow">if</span> we are truely
00439                           <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> on power.
00440 
00441 Return Value:
00442 
00443     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value.
00444 
00445 --*/
00446 {
00447     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>       status;
00448 
00449     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">// Acquire the warm eject device lock. A warm eject requires we enter a </span>
00453     <span class="comment">// specific S-state, and two different devices may have conflicting options.</span>
00454     <span class="comment">// Therefore only one is allowed to occur at once.</span>
00455     <span class="comment">//</span>
00456     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
00457         &amp;IopWarmEjectLock,
00458         Executive,
00459         KernelMode,
00460         FALSE,
00461         NULL
00462         );
00463   
00464     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS) ;
00465 
00466     <span class="comment">//</span>
00467     <span class="comment">// Acquire device node lock. We are not allowed to set or clear this field</span>
00468     <span class="comment">// unless we are under this lock.</span>
00469     <span class="comment">//</span>
00470     <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
00471 
00472     <span class="comment">//</span>
00473     <span class="comment">// Set the current Pdo to eject. </span>
00474     <span class="comment">//</span>
00475     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IopWarmEjectPdo == NULL);
00476     <a class="code" href="../../d1/d0/pnpdata_8c.html#a29">IopWarmEjectPdo</a> = DeviceToEject;
00477 
00478     <span class="comment">//</span>
00479     <span class="comment">// Release the tree lock.</span>
00480     <span class="comment">//</span>
00481     <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00482 
00483     <span class="comment">//</span>
00484     <span class="comment">// Attempt to invalidate Po's cached notification list. This should cause</span>
00485     <span class="comment">// IoBuildPoDeviceNotifyList to be called at which time it will in theory </span>
00486     <span class="comment">// pickup the above placed warm eject Pdo. </span>
00487     <span class="comment">//</span>
00488     <span class="comment">// ADRIAO NOTE 01/07/1999 -</span>
00489     <span class="comment">//     Actually, this whole IoDeviceNodeTreeSequence stuff isn't neccessary. </span>
00490     <span class="comment">// PnP will make no changes to the tree while the device tree lock is owned,</span>
00491     <span class="comment">// and it's owned for the duration of a power notification.</span>
00492     <span class="comment">//</span>
00493     <a class="code" href="../../d1/d0/pnpdata_8c.html#a21">IoDeviceNodeTreeSequence</a>++;
00494 
00495     <span class="comment">//</span>
00496     <span class="comment">// Sleep...</span>
00497     <span class="comment">//</span>
00498     status = NtInitiatePowerAction(
00499         PowerActionWarmEject,
00500         LightestSleepState,
00501         POWER_ACTION_QUERY_ALLOWED |
00502         POWER_ACTION_UI_ALLOWED,
00503         FALSE <span class="comment">// Asynchronous == FALSE</span>
00504         );   
00505 
00506     <span class="comment">//</span>
00507     <span class="comment">// Acquire device node lock. We are not allowed to set or clear this field</span>
00508     <span class="comment">// unless we are under this lock.</span>
00509     <span class="comment">//</span>
00510     <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
00511 
00512     <span class="comment">//</span>
00513     <span class="comment">// Clear the current PDO to eject, and see if the Pdo was actually picked</span>
00514     <span class="comment">// up.</span>
00515     <span class="comment">//</span>
00516     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a29">IopWarmEjectPdo</a>) {
00517 
00518         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00519 
00520             <span class="comment">//</span>
00521             <span class="comment">// If our device wasn't picked up, the return of </span>
00522             <span class="comment">// NtInitiatePowerAction should *not* be successful!</span>
00523             <span class="comment">//</span>
00524             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
00525             status = STATUS_UNSUCCESSFUL;
00526         }
00527 
00528         <a class="code" href="../../d1/d0/pnpdata_8c.html#a29">IopWarmEjectPdo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00529     } 
00530 
00531     <span class="comment">//</span>
00532     <span class="comment">// Release the tree lock.</span>
00533     <span class="comment">//</span>
00534     <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00535     
00536     <span class="comment">//</span>
00537     <span class="comment">// Release the warm eject device lock</span>
00538     <span class="comment">//</span>
00539     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(                                        
00540         &amp;IopWarmEjectLock,
00541         IO_NO_INCREMENT,
00542         FALSE
00543         );        
00544    
00545     <span class="keywordflow">return</span> status;
00546 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a301" doxytag="pnpiop.h::IopWriteAllocatedResourcesToRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopWriteAllocatedResourcesToRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05757">IopReleaseResourcesInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a299" doxytag="pnpiop.h::IopWriteResourceList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopWriteResourceList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceMapKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ClassName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceListSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a325" doxytag="pnpiop.h::IoReportResourceUsageInternal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IoReportResourceUsageInternal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING DriverClassName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST DriverList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG DriverListSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST DeviceList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG DeviceListSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>OverrideConflict</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ConflictDetected</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/report_8c-source.html#l00469">469</a> of file <a class="el" href="../../d2/d7/report_8c-source.html">report.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00629">IopChangeInterfaceType()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04279">IopCmResourcesToIoResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00297">IoReportResourceForDetection()</a>, and <a class="el" href="../../d2/d7/report_8c-source.html#l00379">IoReportResourceUsage()</a>.
<p>
<pre class="fragment"><div>00484                    :
00485 
00486     This internal routine will <span class="keywordflow">do</span> all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work <span class="keywordflow">for</span> <a class="code" href="../../d0/d5/io_8h.html#a542">IoReportResourceUsage</a>.
00487 
00488 Arguments:
00489 
00490     AllocationType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
00491 
00492     DriverClassName - Optional pointer to a UNICODE_STRING which describes
00493         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>of driver under which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver information should be
00494         stored. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> default <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used if none <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> given.
00495 
00496     DriverObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's driver object.
00497 
00498     DriverList - Optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's resource list.
00499 
00500     DriverListSize - Optional value determining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's
00501         resource list.
00502 
00503     DeviceObject - Optional pointer to driver's device object.
00504 
00505     DeviceList - Optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's resource list.
00506 
00507     DriverListSize - Optional value determining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's
00508         resource list.
00509 
00510     OverrideConflict - Determines if <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information should be reported
00511         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> configuration registry eventhough a conflict was found with
00512         another driver or device.
00513 
00514     ConflictDetected - Supplies a pointer to a boolean that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00515         if <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource list conflicts with an already existing resource
00516         list in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> configuration registry.
00517 
00518 Return Value:
00519 
00520     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> final completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00521 
00522 --*/
00523 
00524 {
00525     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status = STATUS_UNSUCCESSFUL;
00526     PCM_RESOURCE_LIST               resourceList;
00527     PCM_RESOURCE_LIST               allocatedResources;
00528     PIO_RESOURCE_REQUIREMENTS_LIST  resourceRequirements;
00529     ULONG                           attempt;
00530     BOOLEAN                         freeAllocatedResources;
00531 
00532     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DriverObject &amp;&amp; ConflictDetected);
00533 
00534     <span class="keywordflow">if</span> (DeviceList) {
00535 
00536         resourceList = DeviceList;
00537 
00538     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DriverList) {
00539 
00540         resourceList = DriverList;
00541 
00542     } <span class="keywordflow">else</span> {
00543 
00544         resourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00545 
00546     }
00547 
00548     resourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00549 
00550     <span class="keywordflow">if</span> (resourceList) {
00551 
00552         <span class="keywordflow">if</span> (resourceList-&gt;Count &amp;&amp; resourceList-&gt;List[0].PartialResourceList.Count) {
00553 
00554             resourceRequirements = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, resourceList, LCPRI_NORMAL);
00555 
00556             <span class="keywordflow">if</span> (resourceRequirements == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00557 
00558                 <span class="keywordflow">return</span> status;
00559 
00560             }
00561 
00562         } <span class="keywordflow">else</span> {
00563 
00564             resourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00565 
00566         }
00567 
00568     }
00569 
00570     *ConflictDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00571     attempt = 0;
00572     allocatedResources = resourceList;
00573     freeAllocatedResources = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00574     <span class="keywordflow">do</span> {
00575 
00576         <span class="comment">//</span>
00577         <span class="comment">// Do the legacy resource allocation.</span>
00578         <span class="comment">//</span>
00579 
00580         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a107">IopLegacyResourceAllocation</a> (  AllocationType,
00581                                                 DriverObject,
00582                                                 DeviceObject,
00583                                                 resourceRequirements,
00584                                                 &amp;allocatedResources);
00585 
00586         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00587 
00588             *ConflictDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00589             <span class="keywordflow">break</span>;
00590         }
00591 
00592         <span class="comment">//</span>
00593         <span class="comment">// Change the interface type and try again.</span>
00594         <span class="comment">//</span>
00595 
00596         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/report_8c.html#a9">IopChangeInterfaceType</a>(resourceRequirements, &amp;allocatedResources)) {
00597 
00598             <span class="keywordflow">break</span>;
00599         }
00600         freeAllocatedResources = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00601 
00602     } <span class="keywordflow">while</span> (++attempt &lt; 2);
00603 
00604     <span class="keywordflow">if</span> (resourceRequirements) {
00605 
00606         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resourceRequirements);
00607 
00608     }
00609 
00610     <span class="keywordflow">if</span> (freeAllocatedResources) {
00611 
00612         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(allocatedResources);
00613     }
00614 
00615     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00616 
00617         status = STATUS_SUCCESS;
00618 
00619     } <span class="keywordflow">else</span> {
00620 
00621         status = STATUS_INSUFFICIENT_RESOURCES;
00622 
00623     }
00624 
00625     <span class="keywordflow">return</span> status;
00626 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a339" doxytag="pnpiop.h::MapperConstructRootEnumTree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MapperConstructRootEnumTree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CreatePhantomDevices</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d4/mapper_8c-source.html#l01600">1600</a> of file <a class="el" href="../../d3/d4/mapper_8c-source.html">mapper.c</a>.
<p>
References <a class="el" href="../../d3/d4/mapper_8c-source.html#l00049">_FIRMWARE_CONFIGURATION::BusNumber</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00048">_FIRMWARE_CONFIGURATION::BusType</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00051">_FIRMWARE_CONFIGURATION::ControllerNumber</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00050">_FIRMWARE_CONFIGURATION::ControllerType</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00052">DebugPrint</a>, <a class="el" href="../../d2/d5/mapper_8c.html#a12">ENUM_KEY_BUFFER_SIZE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00073">_DEVICE_EXTENSION::FirmwareList</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00059">_FIRMWARE_CONFIGURATION::Identifier</a>, <a class="el" href="../../d2/d5/mapper_8c.html#a13">INSTANCE_BUFFER_SIZE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00122">MapperDeviceExtension</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01549">MapperFreeList()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01091">MapperMarkKey()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01298">MapperSeedKey()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00061">_FIRMWARE_CONFIGURATION::NewlyCreated</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00047">_FIRMWARE_CONFIGURATION::Next</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d7/fs__rec_8h.html#a14">PDEVICE_EXTENSION</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00053">_FIRMWARE_CONFIGURATION::PeripheralNumber</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00052">_FIRMWARE_CONFIGURATION::PeripheralType</a>, <a class="el" href="../../d2/d5/mapper_8c.html#a16">PFIRMWARE_CONFIGURATION</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00060">_FIRMWARE_CONFIGURATION::PnPId</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00056">_FIRMWARE_CONFIGURATION::ResourceDescriptor</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.
<p>
<pre class="fragment"><div>01606                    :
01607 
01608     This routine walks through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of firmware entries
01609     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> and migrates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information into
01610     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root enumerator's tree in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
01611 
01612 Arguments:
01613 
01614     CreatePhantomDevices - If non-zero, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instances are created
01615         as <span class="stringliteral">"phantoms"</span> (i.e., they are marked with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"Phantom"</span> value entry so
01616         that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root enumerator will ignore them).  The <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> time these device
01617         instance registry keys will ever turn into real live devnodes <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01618         <span class="keyword">class </span>installer (in response to DIF_FIRSTTIMESETUP or DIF_DETECT)
01619         decides that these devices aren'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> duplicates of any PnP-enumerated
01620         devnodes, and subsequently registers and installs them.
01621 
01622 Return Value:
01623 
01624     None
01625 
01626 --*/
01627 
01628 {
01629 <span class="preprocessor">#define ENUM_KEY_BUFFER_SIZE (1024 * sizeof(WCHAR))</span>
01630 <span class="preprocessor"></span><span class="preprocessor">#define INSTANCE_BUFFER_SIZE (256 * sizeof(WCHAR))</span>
01631 <span class="preprocessor"></span>    UNICODE_STRING          enumKey;
01632     <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html">PFIRMWARE_CONFIGURATION</a> firmwareEntry;
01633     OBJECT_ATTRIBUTES       objectAttributes;
01634     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                status;
01635     BOOLEAN                 keyPresent;
01636     PWCHAR                  registryBase;
01637     PWCHAR                  instanceBuffer;
01638     HANDLE                  handle;
01639     ULONG                   disposition;
01640     PVOID                   buffer;
01641     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>       DeviceExtension = &amp;<a class="code" href="../../d2/d5/mapper_8c.html#a25">MapperDeviceExtension</a>;
01642 
01643     <span class="comment">//</span>
01644     <span class="comment">// allocate space needed for the registry path into the root</span>
01645     <span class="comment">// enumerator tree.  Note, limited size on path length.</span>
01646     <span class="comment">//</span>
01647 
01648     buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool, ENUM_KEY_BUFFER_SIZE);
01649 
01650     <span class="keywordflow">if</span> (!buffer) {
01651         <a class="code" href="../../d9/d0/pnpiop_8h.html#a340">MapperFreeList</a>();
01652         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
01653                     <span class="stringliteral">"Mapper: could not allocate memory for registry update\n"</span>));
01654         <span class="keywordflow">return</span>;
01655     }
01656 
01657     instanceBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool, INSTANCE_BUFFER_SIZE);
01658     <span class="keywordflow">if</span> (!instanceBuffer) {
01659         <a class="code" href="../../d9/d0/pnpiop_8h.html#a340">MapperFreeList</a>();
01660         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
01661         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
01662                     <span class="stringliteral">"Mapper: could not allocate memory for instance buffer\n"</span>));
01663         <span class="keywordflow">return</span>;
01664     }
01665 
01666     InitializeObjectAttributes(&amp;objectAttributes,
01667                                &amp;enumKey,
01668                                OBJ_CASE_INSENSITIVE,
01669                                NULL,
01670                                NULL);
01671 
01672 <span class="preprocessor">#if UMODETEST</span>
01673 <span class="preprocessor"></span>    registryBase = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\TestControlSet\\Enum\\Root\\"</span>;
01674 <span class="preprocessor">#else</span>
01675 <span class="preprocessor"></span>    registryBase = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Enum\\Root\\"</span>;
01676 <span class="preprocessor">#endif</span>
01677 <span class="preprocessor"></span>
01678     firmwareEntry = DeviceExtension-&gt;FirmwareList;
01679     <span class="keywordflow">while</span> (firmwareEntry) {
01680 
01681         <span class="comment">//</span>
01682         <span class="comment">// Construct the base for the path for this entry.</span>
01683         <span class="comment">//</span>
01684 
01685 
01686         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;enumKey, NULL);
01687         enumKey.MaximumLength = <a class="code" href="../../d2/d5/mapper_8c.html#a12">ENUM_KEY_BUFFER_SIZE</a>;
01688         enumKey.Buffer = buffer;
01689         RtlZeroMemory(buffer, ENUM_KEY_BUFFER_SIZE);
01690         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;enumKey, registryBase);
01691         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;enumKey, firmwareEntry-&gt;PnPId);
01692 
01693         <span class="comment">//</span>
01694         <span class="comment">// Build the pnp Key.</span>
01695         <span class="comment">//</span>
01696 
01697         status = ZwCreateKey(&amp;handle,
01698                              KEY_READ | KEY_WRITE,
01699                              &amp;objectAttributes,
01700                              0,
01701                              NULL,
01702                              REG_OPTION_NON_VOLATILE,
01703                              &amp;disposition);
01704 
01705         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01706 
01707             <span class="comment">//</span>
01708             <span class="comment">// Do not need the handle, so close it</span>
01709             <span class="comment">// Remember if the key was present prior to call</span>
01710             <span class="comment">//</span>
01711 
01712             ZwClose(handle);
01713             keyPresent = (disposition == REG_OPENED_EXISTING_KEY) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01714             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_INFORMATION,
01715                         <span class="stringliteral">"Mapper: Key was %s\n"</span>,
01716                         keyPresent ? <span class="stringliteral">"Present"</span> : <span class="stringliteral">"Created"</span>));
01717 
01718             <span class="comment">//</span>
01719             <span class="comment">// Construct the instance name.</span>
01720             <span class="comment">//</span>
01721 
01722             RtlZeroMemory(instanceBuffer, INSTANCE_BUFFER_SIZE);
01723             swprintf(instanceBuffer,
01724                      L<span class="stringliteral">"\\%d_%d_%d_%d_%d_%d"</span>,
01725                      firmwareEntry-&gt;BusType,
01726                      firmwareEntry-&gt;BusNumber,
01727                      firmwareEntry-&gt;ControllerType,
01728                      firmwareEntry-&gt;ControllerNumber,
01729                      firmwareEntry-&gt;PeripheralType,
01730                      firmwareEntry-&gt;PeripheralNumber);
01731             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;enumKey, instanceBuffer);
01732 
01733             status = ZwCreateKey(&amp;handle,
01734                                  KEY_READ | KEY_WRITE,
01735                                  &amp;objectAttributes,
01736                                  0,
01737                                  NULL,
01738                                  REG_OPTION_NON_VOLATILE,
01739                                  &amp;disposition);
01740 
01741             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01742 
01743                 <span class="keywordflow">if</span> (firmwareEntry-&gt;ResourceDescriptor) {
01744                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_INFORMATION,
01745                                 <span class="stringliteral">"Mapper: firmware entry has resources %x\n"</span>,
01746                                 firmwareEntry-&gt;ResourceDescriptor));
01747                 }
01748 
01749                 <span class="keywordflow">if</span> (firmwareEntry-&gt;Identifier) {
01750                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_INFORMATION,
01751                                 <span class="stringliteral">"Mapper: firmware entry has identifier %x\n"</span>,
01752                                 firmwareEntry-&gt;Identifier));
01753                 }
01754 
01755                 <span class="comment">//</span>
01756                 <span class="comment">// Only if this is a new entry do we see the key.</span>
01757                 <span class="comment">//</span>
01758 
01759                 <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {
01760 
01761                     <span class="comment">//</span>
01762                     <span class="comment">// Remember the fact that the key was newly-created for the</span>
01763                     <span class="comment">// PnP BIOS case where we need to come along and "phantomize"</span>
01764                     <span class="comment">// all newly-created ntdetect COM ports.</span>
01765                     <span class="comment">//</span>
01766 
01767                     firmwareEntry-&gt;NewlyCreated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01768 
01769                     <span class="comment">//</span>
01770                     <span class="comment">// Create enough information to get pnp to</span>
01771                     <span class="comment">// install drivers</span>
01772                     <span class="comment">//</span>
01773 
01774                     <a class="code" href="../../d2/d5/mapper_8c.html#a41">MapperSeedKey</a>(handle,
01775                                   &amp;enumKey,
01776                                   firmwareEntry,
01777                                   CreatePhantomDevices
01778                                  );
01779                 }
01780                 <a class="code" href="../../d2/d5/mapper_8c.html#a40">MapperMarkKey</a>(handle,
01781                               &amp;enumKey,
01782                               firmwareEntry);
01783                 ZwClose(handle);
01784 
01785             } <span class="keywordflow">else</span> {
01786                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
01787                             <span class="stringliteral">"Mapper: create of instance key failed %x\n"</span>,
01788                             status));
01789             }
01790 
01791         } <span class="keywordflow">else</span> {
01792             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
01793                         <span class="stringliteral">"Mapper: create pnp key failed %x\n"</span>,
01794                         status));
01795         }
01796 
01797         firmwareEntry = firmwareEntry-&gt;Next;
01798     }
01799     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(instanceBuffer);
01800 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a340" doxytag="pnpiop.h::MapperFreeList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MapperFreeList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d4/mapper_8c-source.html#l01549">1549</a> of file <a class="el" href="../../d3/d4/mapper_8c-source.html">mapper.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00073">_DEVICE_EXTENSION::FirmwareList</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00059">_FIRMWARE_CONFIGURATION::Identifier</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00122">MapperDeviceExtension</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00047">_FIRMWARE_CONFIGURATION::Next</a>, <a class="el" href="../../d7/d7/fs__rec_8h.html#a14">PDEVICE_EXTENSION</a>, <a class="el" href="../../d2/d5/mapper_8c.html#a16">PFIRMWARE_CONFIGURATION</a>, and <a class="el" href="../../d3/d4/mapper_8c-source.html#l00056">_FIRMWARE_CONFIGURATION::ResourceDescriptor</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, and <a class="el" href="../../d3/d4/mapper_8c-source.html#l01600">MapperConstructRootEnumTree()</a>.
<p>
<pre class="fragment"><div>01555                    :
01556 
01557     This routine walks through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of firmware entries
01558     and frees all allocated memory.
01559 
01560 Arguments:
01561 
01562     None
01563 
01564 Return Value:
01565 
01566     None
01567 
01568 --*/
01569 
01570 {
01571     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>       deviceExtension = &amp;<a class="code" href="../../d2/d5/mapper_8c.html#a25">MapperDeviceExtension</a>;
01572     <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html">PFIRMWARE_CONFIGURATION</a> tempEntry;
01573     <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html">PFIRMWARE_CONFIGURATION</a> firmwareEntry;
01574 
01575     firmwareEntry = deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o46">FirmwareList</a>;
01576     <span class="keywordflow">while</span> (firmwareEntry) {
01577 
01578         <span class="comment">//</span>
01579         <span class="comment">// free allocated structures associated with the firmware entry</span>
01580         <span class="comment">//</span>
01581 
01582         <span class="keywordflow">if</span> (firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o9">ResourceDescriptor</a>) {
01583             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o9">ResourceDescriptor</a>);
01584         }
01585         <span class="keywordflow">if</span> (firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>) {
01586             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>);
01587         }
01588 
01589         <span class="comment">//</span>
01590         <span class="comment">// free this entry and move to the next</span>
01591         <span class="comment">//</span>
01592 
01593         tempEntry = firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o0">Next</a>;
01594         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(firmwareEntry);
01595         firmwareEntry = tempEntry;
01596     }
01597 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a342" doxytag="pnpiop.h::MapperPhantomizeDetectedComPorts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MapperPhantomizeDetectedComPorts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d4/mapper_8c-source.html#l02060">2060</a> of file <a class="el" href="../../d3/d4/mapper_8c-source.html">mapper.c</a>.
<p>
References <a class="el" href="../../d3/d4/mapper_8c-source.html#l00049">_FIRMWARE_CONFIGURATION::BusNumber</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00048">_FIRMWARE_CONFIGURATION::BusType</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00051">_FIRMWARE_CONFIGURATION::ControllerNumber</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00050">_FIRMWARE_CONFIGURATION::ControllerType</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00052">DebugPrint</a>, <a class="el" href="../../d2/d5/mapper_8c.html#a12">ENUM_KEY_BUFFER_SIZE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00073">_DEVICE_EXTENSION::FirmwareList</a>, <a class="el" href="../../d2/d5/mapper_8c.html#a13">INSTANCE_BUFFER_SIZE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00122">MapperDeviceExtension</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00061">_FIRMWARE_CONFIGURATION::NewlyCreated</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00047">_FIRMWARE_CONFIGURATION::Next</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d7/fs__rec_8h.html#a14">PDEVICE_EXTENSION</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00053">_FIRMWARE_CONFIGURATION::PeripheralNumber</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00052">_FIRMWARE_CONFIGURATION::PeripheralType</a>, <a class="el" href="../../d2/d5/mapper_8c.html#a16">PFIRMWARE_CONFIGURATION</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00060">_FIRMWARE_CONFIGURATION::PnPId</a>, <a class="el" href="../../d3/d4/i386_2kdcpuapi_8c-source.html#l00297">regValue()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d1/d9/arc_8h.html#a315a204">SerialController</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.
<p>
<pre class="fragment"><div>02065                    :
02066 
02067     This routine turns all newly-created firmware/ntdetect COM ports into
02068     phantoms.
02069 
02070 Arguments:
02071 
02072     None
02073 
02074 Return Value:
02075 
02076     None
02077 
02078 --*/
02079 {
02080     <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html">PFIRMWARE_CONFIGURATION</a> firmwareEntry;
02081     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                status;
02082     PWCHAR                  registryBase;
02083     PWCHAR                  instanceBuffer;
02084     HANDLE                  handle;
02085     PWCHAR                  buffer;
02086     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>       DeviceExtension = &amp;<a class="code" href="../../d2/d5/mapper_8c.html#a25">MapperDeviceExtension</a>;
02087     UNICODE_STRING          enumKey;
02088     OBJECT_ATTRIBUTES       objectAttributes;
02089     UNICODE_STRING          unicodeName;
02090     ULONG                   <a class="code" href="../../d2/d5/i386_2kdcpuapi_8c.html#a6">regValue</a>;
02091 
02092     <span class="comment">//</span>
02093     <span class="comment">// allocate space needed for the registry path into the root</span>
02094     <span class="comment">// enumerator tree.  Note, limited size on path length.</span>
02095     <span class="comment">//</span>
02096 
02097     buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool, ENUM_KEY_BUFFER_SIZE);
02098 
02099     <span class="keywordflow">if</span> (!buffer) {
02100         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
02101                     <span class="stringliteral">"Mapper: could not allocate memory for registry update\n"</span>));
02102         <span class="keywordflow">return</span>;
02103     }
02104 
02105     instanceBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool, INSTANCE_BUFFER_SIZE);
02106     <span class="keywordflow">if</span> (!instanceBuffer) {
02107         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
02108         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
02109                     <span class="stringliteral">"Mapper: could not allocate memory for instance buffer\n"</span>));
02110         <span class="keywordflow">return</span>;
02111     }
02112 
02113     InitializeObjectAttributes(&amp;objectAttributes,
02114                                &amp;enumKey,
02115                                OBJ_CASE_INSENSITIVE,
02116                                NULL,
02117                                NULL);
02118 
02119 <span class="preprocessor">#if UMODETEST</span>
02120 <span class="preprocessor"></span>    registryBase = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\TestControlSet\\Enum\\Root\\"</span>;
02121 <span class="preprocessor">#else</span>
02122 <span class="preprocessor"></span>    registryBase = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Enum\\Root\\"</span>;
02123 <span class="preprocessor">#endif</span>
02124 <span class="preprocessor"></span>
02125     firmwareEntry = DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o46">FirmwareList</a>;
02126     <span class="keywordflow">while</span> (firmwareEntry) {
02127 
02128         <span class="comment">//</span>
02129         <span class="comment">// Construct the base for the path for this entry.</span>
02130         <span class="comment">//</span>
02131 
02132 
02133         <span class="keywordflow">if</span> ((firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o3">ControllerType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a315a204">SerialController</a>) &amp;&amp;
02134             firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o14">NewlyCreated</a>) {
02135 
02136             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;enumKey, NULL);
02137             enumKey.MaximumLength = <a class="code" href="../../d2/d5/mapper_8c.html#a12">ENUM_KEY_BUFFER_SIZE</a>;
02138             enumKey.Buffer = buffer;
02139             RtlZeroMemory(buffer, ENUM_KEY_BUFFER_SIZE);
02140             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;enumKey, registryBase);
02141             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;enumKey, firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o13">PnPId</a>);
02142 
02143             <span class="comment">//</span>
02144             <span class="comment">// Construct the instance name.</span>
02145             <span class="comment">//</span>
02146 
02147             RtlZeroMemory(instanceBuffer, INSTANCE_BUFFER_SIZE);
02148             swprintf(instanceBuffer,
02149                      L<span class="stringliteral">"\\%d_%d_%d_%d_%d_%d"</span>,
02150                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o1">BusType</a>,
02151                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o2">BusNumber</a>,
02152                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o3">ControllerType</a>,
02153                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o4">ControllerNumber</a>,
02154                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o5">PeripheralType</a>,
02155                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o6">PeripheralNumber</a>);
02156             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;enumKey, instanceBuffer);
02157 
02158             status = ZwOpenKey(&amp;handle,
02159                                KEY_READ | KEY_WRITE,
02160                                &amp;objectAttributes
02161                               );
02162 
02163             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02164 
02165                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VAL_PHANTOM);
02166                 <a class="code" href="../../d2/d5/i386_2kdcpuapi_8c.html#a6">regValue</a> = 1;
02167                 ZwSetValueKey(handle,
02168                               &amp;unicodeName,
02169                               0,
02170                               REG_DWORD,
02171                               &amp;regValue,
02172                               <span class="keyword">sizeof</span>(regValue)
02173                              );
02174 
02175                 ZwClose(handle);
02176             }
02177         }
02178 
02179         firmwareEntry = firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o0">Next</a>;
02180     }
02181 
02182     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (buffer);
02183     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (instanceBuffer);
02184 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a338" doxytag="pnpiop.h::MapperProcessFirmwareTree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MapperProcessFirmwareTree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>OnlyProcessSerialPorts</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d4/mapper_8c-source.html#l01009">1009</a> of file <a class="el" href="../../d3/d4/mapper_8c-source.html">mapper.c</a>.
<p>
References <a class="el" href="../../d1/d9/arc_8h.html#a56">CONFIGURATION_TYPE</a>, <a class="el" href="../../d2/d5/mapper_8c.html#a10">CONTROLLER_TYPES_COUNT</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00052">DebugPrint</a>, <a class="el" href="../../d1/d9/arc_8h.html#a315a200">DiskController</a>, <a class="el" href="../../d1/d9/arc_8h.html#a315a213">FloppyDiskPeripheral</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00070">IoQueryDeviceDescription()</a>, <a class="el" href="../../d1/d9/arc_8h.html#a315a209">KeyboardController</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00658">MapperCallback()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00122">MapperDeviceExtension</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/arc_8h.html#a315a207">ParallelController</a>, <a class="el" href="../../d1/d9/arc_8h.html#a315a208">PointerController</a>, and <a class="el" href="../../d1/d9/arc_8h.html#a315a204">SerialController</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.
<p>
<pre class="fragment"><div>01015                    :
01016 
01017     Query <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> firmware tree to know what
01018     system board devices were located.  This will cause a FirmwareList
01019     to be created on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device extention passed.
01020 
01021 Arguments:
01022 
01023     OnlyProcessSerialPorts - <span class="keywordflow">if</span> non-zero, then we'll <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> look at serial ports.
01024         This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done on ACPI machines where, in general, we don'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> want to pay
01025         attention to ntdetect/firmware information (but we have to <span class="keywordflow">for</span> serial
01026         ports so that legacy add-in ISA serial ports and modems are detected
01027         automatically as in previous versions of NT as well as Win9x).
01028 
01029 Return Value:
01030 
01031     None
01032 
01033 --*/
01034 
01035 {
01036     INTERFACE_TYPE     interfaceType;
01037     ULONG              index;
01038     <a class="code" href="../../d1/d9/arc_8h.html#a56">CONFIGURATION_TYPE</a> sc;
01039     <a class="code" href="../../d1/d9/arc_8h.html#a56">CONFIGURATION_TYPE</a> controllerTypes[] = { <a class="code" href="../../d1/d9/arc_8h.html#a315a208">PointerController</a>,
01040                                              <a class="code" href="../../d1/d9/arc_8h.html#a315a209">KeyboardController</a>,
01041                                              <a class="code" href="../../d1/d9/arc_8h.html#a315a207">ParallelController</a>,
01042                                              <a class="code" href="../../d1/d9/arc_8h.html#a315a200">DiskController</a>,
01043                                              <a class="code" href="../../d1/d9/arc_8h.html#a315a213">FloppyDiskPeripheral</a>,
01044                                              <a class="code" href="../../d1/d9/arc_8h.html#a315a204">SerialController</a>   <span class="comment">// must be last</span>
01045                                            };
01046 <span class="preprocessor">#define CONTROLLER_TYPES_COUNT (sizeof(controllerTypes) / sizeof(controllerTypes[0]))</span>
01047 <span class="preprocessor"></span>
01048     <span class="comment">//</span>
01049     <span class="comment">// Locate all firmware controller information and save its resource usage.</span>
01050     <span class="comment">//</span>
01051     <span class="comment">// BUGBUG (lonnym)--it's pretty inefficient to be going through all</span>
01052     <span class="comment">// interface types, when we really only care about a very small subset of</span>
01053     <span class="comment">// non-PnP buses (e.g., ISA, EISA, maybe Internal).</span>
01054     <span class="comment">//</span>
01055 
01056     <span class="keywordflow">for</span> (interfaceType = 0; interfaceType &lt; MaximumInterfaceType; interfaceType++) {
01057 
01058         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_VERBOSE,
01059                     <span class="stringliteral">"Mapper: searching on interface ===&gt; %d\n"</span>,
01060                     interfaceType));
01061 
01062         <span class="keywordflow">if</span>(OnlyProcessSerialPorts) {
01063 
01064             <span class="comment">//</span>
01065             <span class="comment">// Start out at the last element of the array, so we only process</span>
01066             <span class="comment">// SerialControllers.</span>
01067             <span class="comment">//</span>
01068 
01069             index = <a class="code" href="../../d2/d5/mapper_8c.html#a10">CONTROLLER_TYPES_COUNT</a> - 1;
01070         } <span class="keywordflow">else</span> {
01071             index = 0;
01072         }
01073 
01074         <span class="keywordflow">for</span> ( ; index &lt; <a class="code" href="../../d2/d5/mapper_8c.html#a10">CONTROLLER_TYPES_COUNT</a>; index++) {
01075             sc = controllerTypes[index];
01076 
01077             <a class="code" href="../../d2/d3/io_2query_8c.html#a6">IoQueryDeviceDescription</a>(&amp;interfaceType,
01078                                      NULL,
01079                                      &amp;sc,
01080                                      NULL,
01081                                      NULL,
01082                                      NULL,
01083                                      MapperCallback,
01084                                      &amp;MapperDeviceExtension);
01085         }
01086     }
01087 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a375" doxytag="pnpiop.h::PnPBiosGetBiosInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PnPBiosGetBiosInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>BiosInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>BiosInfoLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00399">399</a> of file <a class="el" href="../../d3/d0/pnpmap_8c-source.html">pnpmap.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00052">DebugPrint</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00092">DEFAULT_STRING_SIZE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00082">MULTIFUNCTION_KEY_NAME</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l03008">PnPBiosMapper()</a>.
<p>
<pre class="fragment"><div>00405                    :
00406 
00407     This function retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PnP BIOS info accumulated by NTDETECT.COM and
00408     placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
00409 
00410 Arguments:
00411 
00412     BiosInfo - Set to a dynamically allocated block of information retrieved
00413         from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PnP BIOS by NTDETECT.  This block should be freed <span class="keyword">using</span>
00414         <a class="code" href="../../d6/d3/cmwraper_8c.html#a26">ExFreePool</a>.  The contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block are <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PnP BIOS
00415         Installation Check Structure followed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DevNode Structures reported
00416         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BIOS.  The detailed <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> documented in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PnP BIOS spec.
00417 
00418     BiosInfoLength - Length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block whose address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored in BiosInfo.
00419 
00420 
00421 Return Value:
00422 
00423     STATUS_SUCCESS <span class="keywordflow">if</span> no errors, otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate error.
00424 
00425 --*/
00426 {
00427     UNICODE_STRING                  multifunctionKeyName, biosKeyName, valueName;
00428     HANDLE                          multifunctionKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, biosKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00429     PKEY_BASIC_INFORMATION          keyBasicInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00430     ULONG                           keyBasicInfoLength;
00431     PKEY_VALUE_PARTIAL_INFORMATION  valueInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00432     ULONG                           valueInfoLength;
00433     ULONG                           returnedLength;
00434 
00435     PCM_FULL_RESOURCE_DESCRIPTOR    biosValue;
00436 
00437     ULONG                           index;
00438     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status = STATUS_UNSUCCESSFUL;
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// The PnP BIOS info is written to one of the subkeys under</span>
00442     <span class="comment">// MULTIFUNCTION_KEY_NAME.  The appropriate key is determined by</span>
00443     <span class="comment">// enumerating the subkeys and using the first one which has a value named</span>
00444     <span class="comment">// "Identifier" that is "PNP BIOS".</span>
00445     <span class="comment">//</span>
00446 
00447     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;multifunctionKeyName, MULTIFUNCTION_KEY_NAME);
00448 
00449     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;multifunctionKey,
00450                                    NULL,
00451                                    &amp;multifunctionKeyName,
00452                                    KEY_READ
00453                                    );
00454 
00455     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00456 
00457         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
00458                     <span class="stringliteral">"Could not open %S, status = %8.8X\n"</span>,
00459                     MULTIFUNCTION_KEY_NAME,
00460                     status) );
00461 
00462         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00463     }
00464 
00465     <span class="comment">//</span>
00466     <span class="comment">// Allocate memory for key names returned from ZwEnumerateKey and values</span>
00467     <span class="comment">// returned from ZwQueryValueKey.</span>
00468     <span class="comment">//</span>
00469     keyBasicInfoLength = <span class="keyword">sizeof</span>(KEY_BASIC_INFORMATION) + <a class="code" href="../../d2/d1/pnpmap_8c.html#a7">DEFAULT_STRING_SIZE</a>;
00470     keyBasicInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, keyBasicInfoLength + <span class="keyword">sizeof</span>(UNICODE_NULL));
00471 
00472     <span class="keywordflow">if</span> (keyBasicInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
00473 
00474         ZwClose( multifunctionKey );
00475 
00476         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00477     }
00478 
00479     valueInfoLength = <span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <a class="code" href="../../d2/d1/pnpmap_8c.html#a7">DEFAULT_STRING_SIZE</a>;
00480     valueInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, valueInfoLength);
00481 
00482     <span class="keywordflow">if</span> (valueInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
00483 
00484         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInfo );
00485 
00486         ZwClose( multifunctionKey );
00487 
00488         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00489     }
00490 
00491     <span class="comment">//</span>
00492     <span class="comment">// Enumerate each key under HKLM\HARDWARE\\DESCRIPTION\\System\\MultifunctionAdapter</span>
00493     <span class="comment">// to locate the one representing the PnP BIOS information.</span>
00494     <span class="comment">//</span>
00495     <span class="keywordflow">for</span> (index = 0; ; index++) {
00496 
00497         status = ZwEnumerateKey( multifunctionKey,   <span class="comment">// handle of key to enumerate</span>
00498                                  index,              <span class="comment">// index of subkey to enumerate</span>
00499                                  KeyBasicInformation,
00500                                  keyBasicInfo,
00501                                  keyBasicInfoLength,
00502                                  &amp;returnedLength);
00503 
00504         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00505 
00506             <span class="keywordflow">if</span> (status != STATUS_NO_MORE_ENTRIES)  {
00507 
00508                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
00509                             <span class="stringliteral">"Could not enumerate under key %S, status = %8.8X\n"</span>,
00510                             MULTIFUNCTION_KEY_NAME,
00511                             status) );
00512             }
00513 
00514             <span class="keywordflow">break</span>;
00515         }
00516 
00517         <span class="comment">//</span>
00518         <span class="comment">// We found a subkey, NUL terminate the name and open the subkey.</span>
00519         <span class="comment">//</span>
00520         keyBasicInfo-&gt;Name[ keyBasicInfo-&gt;NameLength / 2 ] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00521 
00522         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;biosKeyName, keyBasicInfo-&gt;Name);
00523 
00524         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;biosKey,
00525                                        multifunctionKey,
00526                                        &amp;biosKeyName,
00527                                        KEY_READ
00528                                        );
00529 
00530         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00531 
00532             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
00533                         <span class="stringliteral">"Could not open registry key %S\\%S, status = %8.8X\n"</span>,
00534                         MULTIFUNCTION_KEY_NAME,
00535                         keyBasicInfo-&gt;Name,
00536                         status) );
00537             <span class="keywordflow">break</span>;
00538         }
00539 
00540         <span class="comment">//</span>
00541         <span class="comment">// Now we need to check the Identifier value in the subkey to see if</span>
00542         <span class="comment">// it is PNP BIOS.</span>
00543         <span class="comment">//</span>
00544         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, L<span class="stringliteral">"Identifier"</span>);
00545 
00546         status = ZwQueryValueKey( biosKey,
00547                                   &amp;valueName,
00548                                   KeyValuePartialInformation,
00549                                   valueInfo,
00550                                   valueInfoLength,
00551                                   &amp;returnedLength);
00552 
00553 
00554         <span class="comment">// lets see if its the PNP BIOS identifier</span>
00555         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00556 
00557             <span class="keywordflow">if</span> (wcscmp((PWSTR)valueInfo-&gt;Data, L<span class="stringliteral">"PNP BIOS"</span>) == 0) {
00558 
00559                 <span class="comment">//</span>
00560                 <span class="comment">// We found the PnP BIOS subkey, retrieve the BIOS info which</span>
00561                 <span class="comment">// is stored in the "Configuration Data" value.</span>
00562                 <span class="comment">//</span>
00563                 <span class="comment">// We'll start off with our default value buffer and increase</span>
00564                 <span class="comment">// its size if necessary.</span>
00565                 <span class="comment">//</span>
00566 
00567                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, L<span class="stringliteral">"Configuration Data"</span>);
00568 
00569                 status = ZwQueryValueKey( biosKey,
00570                                           &amp;valueName,
00571                                           KeyValuePartialInformation,
00572                                           valueInfo,
00573                                           valueInfoLength,
00574                                           &amp;returnedLength);
00575 
00576                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00577 
00578                     <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL || status == STATUS_BUFFER_OVERFLOW) {
00579 
00580                         <span class="comment">//</span>
00581                         <span class="comment">// The default buffer was too small, free it and reallocate</span>
00582                         <span class="comment">// it to the required size.</span>
00583                         <span class="comment">//</span>
00584                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( valueInfo );
00585 
00586                         valueInfoLength = returnedLength;
00587                         valueInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, valueInfoLength );
00588 
00589                         <span class="keywordflow">if</span> (valueInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
00590 
00591                             status = ZwQueryValueKey( biosKey,
00592                                                       &amp;valueName,
00593                                                       KeyValuePartialInformation,
00594                                                       valueInfo,
00595                                                       valueInfoLength,
00596                                                       &amp;returnedLength );
00597                         } <span class="keywordflow">else</span> {
00598 
00599                             status = STATUS_NO_MEMORY;
00600                         }
00601                     }
00602                 }
00603 
00604                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00605 
00606                     <span class="comment">//</span>
00607                     <span class="comment">// We now have the PnP BIOS data but it is buried inside</span>
00608                     <span class="comment">// the resource structures.  Do some consistency checks and</span>
00609                     <span class="comment">// then extract it into its own buffer.</span>
00610                     <span class="comment">//</span>
00611 
00612                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(valueInfo-&gt;Type == REG_FULL_RESOURCE_DESCRIPTOR);
00613 
00614                     biosValue = (PCM_FULL_RESOURCE_DESCRIPTOR)valueInfo-&gt;Data;
00615 
00616                     <span class="comment">//</span>
00617                     <span class="comment">// BUGBUG - The WMI folks added another list so we should</span>
00618                     <span class="comment">// search for the PnPBIOS one, but for now the BIOS one is</span>
00619                     <span class="comment">// always first.</span>
00620                     <span class="comment">//</span>
00621                     <span class="comment">//ASSERT(biosValue-&gt;PartialResourceList.Count == 1);</span>
00622 
00623                     *BiosInfoLength = biosValue-&gt;PartialResourceList.PartialDescriptors[0].u.DeviceSpecificData.DataSize;
00624                     *BiosInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, *BiosInfoLength);
00625 
00626                     <span class="keywordflow">if</span> (*BiosInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00627 
00628                         RtlCopyMemory( *BiosInfo,
00629                                        &amp;biosValue-&gt;PartialResourceList.PartialDescriptors[1],
00630                                        *BiosInfoLength );
00631 
00632                         status = STATUS_SUCCESS;
00633 
00634                     } <span class="keywordflow">else</span> {
00635 
00636                         *BiosInfoLength = 0;
00637 
00638                         status = STATUS_NO_MEMORY;
00639                     }
00640 
00641                 } <span class="keywordflow">else</span> {
00642 
00643                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
00644                                 <span class="stringliteral">"Error retrieving %S\\%S\\Configuration Data, status = %8.8X\n"</span>,
00645                                 MULTIFUNCTION_KEY_NAME,
00646                                 keyBasicInfo-&gt;Name,
00647                                 status) );
00648                 }
00649 
00650                 <span class="comment">//</span>
00651                 <span class="comment">// We found the PnP BIOS entry, so close the key handle and</span>
00652                 <span class="comment">// return.</span>
00653                 <span class="comment">//</span>
00654 
00655                 ZwClose(biosKey);
00656 
00657                 <span class="keywordflow">break</span>;
00658             }
00659         }
00660 
00661         <span class="comment">//</span>
00662         <span class="comment">// That wasn't it so close this handle and try the next subkey.</span>
00663         <span class="comment">//</span>
00664         ZwClose(biosKey);
00665     }
00666 
00667     <span class="comment">//</span>
00668     <span class="comment">// Cleanup the dynamically allocated temporary buffers.</span>
00669     <span class="comment">//</span>
00670 
00671     <span class="keywordflow">if</span> (valueInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00672 
00673         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(valueInfo);
00674     }
00675 
00676     <span class="keywordflow">if</span> (keyBasicInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00677 
00678         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyBasicInfo);
00679     }
00680 
00681     ZwClose(multifunctionKey);
00682 
00683     <span class="keywordflow">return</span> status;
00684 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a177" doxytag="pnpiop.h::IoDeviceNodeTreeSequence" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d0/pnpiop_8h.html#a177">IoDeviceNodeTreeSequence</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02366">2366</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00048">IoBuildPoDeviceNotifyList()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00447">IopInsertTreeDeviceNode()</a>, and <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00422">IopWarmEjectDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a157" doxytag="pnpiop.h::IopBootConfigsReserved" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d0/pnpiop_8h.html#a157">IopBootConfigsReserved</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01047">1047</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a188" doxytag="pnpiop.h::IopBusTypeGuidList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">PBUS_TYPE_GUID_LIST</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a188">IopBusTypeGuidList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02432">2432</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00373">IoGetDeviceProperty()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04425">IopGetBusTypeGuidIndex()</a>, and <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a179" doxytag="pnpiop.h::IopDeviceClassNotifyList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d0/pnpiop_8h.html#a179">IopDeviceClassNotifyList</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02373">2373</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06511">IopInitializePlugPlayNotification()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07330">IopNotifyDeviceClassChange()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a178" doxytag="pnpiop.h::IopDeviceClassNotifyLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a178">IopDeviceClassNotifyLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02372">2372</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06511">IopInitializePlugPlayNotification()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07330">IopNotifyDeviceClassChange()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a149" doxytag="pnpiop.h::IopDeviceTreeLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a149">IopDeviceTreeLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00999">999</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">IopProcessAssignResources()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00821">IopProcessStartDevices()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">IopProcessStartDevicesWorker()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a198" doxytag="pnpiop.h::IopDockDeviceCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d0/pnpiop_8h.html#a198">IopDockDeviceCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02536">2536</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00465">IopHardwareProfileCommitRemovedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00160">IopHardwareProfileMarkDock()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, and <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00862">IopUpdateHardwareProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a196" doxytag="pnpiop.h::IopDockDeviceListHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d0/pnpiop_8h.html#a196">IopDockDeviceListHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02534">2534</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00666">IopHardwareProfileCancelTransition()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00160">IopHardwareProfileMarkDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00251">IopHardwareProfileQueryChange()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00739">IopHardwareProfileSetMarkedDocksEjected()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, and <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00862">IopUpdateHardwareProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a197" doxytag="pnpiop.h::IopDockDeviceListLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a197">IopDockDeviceListLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02535">2535</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00572">IopHardwareProfileCancelRemovedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00666">IopHardwareProfileCancelTransition()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00465">IopHardwareProfileCommitRemovedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00160">IopHardwareProfileMarkDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00251">IopHardwareProfileQueryChange()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00739">IopHardwareProfileSetMarkedDocksEjected()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, and <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00862">IopUpdateHardwareProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a200" doxytag="pnpiop.h::IopDocksInTransition" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG <a class="el" href="../../d9/d0/pnpiop_8h.html#a200">IopDocksInTransition</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02538">2538</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00103">IopHardwareProfileBeginTransition()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00572">IopHardwareProfileCancelRemovedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00666">IopHardwareProfileCancelTransition()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00465">IopHardwareProfileCommitRemovedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00370">IopHardwareProfileCommitStartedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00160">IopHardwareProfileMarkDock()</a>, and <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00251">IopHardwareProfileQueryChange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a152" doxytag="pnpiop.h::IopEnumerationCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG <a class="el" href="../../d9/d0/pnpiop_8h.html#a152">IopEnumerationCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01017">1017</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a183" doxytag="pnpiop.h::IopHwProfileNotifyLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a183">IopHwProfileNotifyLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02377">2377</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06511">IopInitializePlugPlayNotification()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06858">IopNotifyHwProfileChange()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a142" doxytag="pnpiop.h::IopInitHalDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a142">IopInitHalDeviceNode</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00955">955</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a141" doxytag="pnpiop.h::IopInitHalResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PCM_RESOURCE_LIST <a class="el" href="../../d9/d0/pnpiop_8h.html#a141">IopInitHalResources</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00954">954</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>, and <a class="el" href="../../d2/d7/report_8c-source.html#l00193">IoReportHalResourceUsage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a143" doxytag="pnpiop.h::IopInitReservedResourceList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d0/pnpiop_8h.html#a138">PIOP_RESERVED_RESOURCES_RECORD</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a143">IopInitReservedResourceList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00956">956</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07291">IopReserveBootResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a176" doxytag="pnpiop.h::IopMaxDeviceNodeLevel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d0/pnpiop_8h.html#a176">IopMaxDeviceNodeLevel</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02365">2365</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00239">IopAllocateRelationList()</a>, and <a class="el" href="../../d5/d6/devnode_8c-source.html#l00447">IopInsertTreeDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a153" doxytag="pnpiop.h::IopNumberDeviceNodes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d0/pnpiop_8h.html#a153">IopNumberDeviceNodes</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01023">1023</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/pnprlist_8c-source.html#l00055">IopAddRelationToList()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00056">IopAllocateDeviceNode()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00297">IopDestroyDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">IopFindLegacyDeviceNode()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">IopProcessAssignResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a162" doxytag="pnpiop.h::IopPendingEjects" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d0/pnpiop_8h.html#a162">IopPendingEjects</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01078">1078</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00917">IopProcessRelation()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01234">IopQueuePendingEject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a163" doxytag="pnpiop.h::IopPendingSurpriseRemovals" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d0/pnpiop_8h.html#a163">IopPendingSurpriseRemovals</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01083">1083</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00084">IopChainDereferenceComplete()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, and <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01540">IopQueuePendingSurpriseRemoval()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a147" doxytag="pnpiop.h::IopPnpDeleteRequestList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d0/pnpiop_8h.html#a147">IopPnpDeleteRequestList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00984">984</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a145" doxytag="pnpiop.h::IopPnPDriverObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a145">IopPnPDriverObject</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00972">972</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a148" doxytag="pnpiop.h::IopPnpEnumerationRequestList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d0/pnpiop_8h.html#a148">IopPnpEnumerationRequestList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00990">990</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a139" doxytag="pnpiop.h::IopPnpScratchBuffer1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d9/d0/pnpiop_8h.html#a139">IopPnpScratchBuffer1</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00952">952</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01510">IopDetermineDefaultInterfaceType()</a>, and <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a140" doxytag="pnpiop.h::IopPnpScratchBuffer2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d9/d0/pnpiop_8h.html#a140">IopPnpScratchBuffer2</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00953">953</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a146" doxytag="pnpiop.h::IopPnPSpinLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d9/d0/pnpiop_8h.html#a146">IopPnPSpinLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00978">978</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01395">IoInvalidateDeviceRelations()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01496">IopDeviceRelationsComplete()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01370">IopDeviceStartComplete()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01604">IopQueryDeviceRelations()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04508">IopWaitForBootDevicesStarted()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a199" doxytag="pnpiop.h::IopProfileChangeSemaphore" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a199">IopProfileChangeSemaphore</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02537">2537</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00103">IopHardwareProfileBeginTransition()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00572">IopHardwareProfileCancelRemovedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00666">IopHardwareProfileCancelTransition()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00465">IopHardwareProfileCommitRemovedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00370">IopHardwareProfileCommitStartedDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00160">IopHardwareProfileMarkDock()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00251">IopHardwareProfileQueryChange()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00827">IopHardwareProfileSendCancel()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00795">IopHardwareProfileSendCommit()</a>, and <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00739">IopHardwareProfileSetMarkedDocksEjected()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a182" doxytag="pnpiop.h::IopProfileNotifyList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d0/pnpiop_8h.html#a182">IopProfileNotifyList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02376">2376</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06511">IopInitializePlugPlayNotification()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06858">IopNotifyHwProfileChange()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a165" doxytag="pnpiop.h::IopReserveResourcesRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d0/pnpiop_8h.html#a164">PIO_RESERVE_RESOURCES_ROUTINE</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a165">IopReserveResourcesRoutine</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01903">1903</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, and <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a158" doxytag="pnpiop.h::IopResourcesReleased" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d0/pnpiop_8h.html#a158">IopResourcesReleased</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01055">1055</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, and <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a193" doxytag="pnpiop.h::IopRootBusNumberArbiter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d7/struct__ARBITER__INSTANCE.html">ARBITER_INSTANCE</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a193">IopRootBusNumberArbiter</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02471">2471</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/pnpbusno_8c-source.html#l00089">IopBusNumberInitialize()</a>, and <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a144" doxytag="pnpiop.h::IopRootDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a144">IopRootDeviceNode</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00966">966</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00048">IoBuildPoDeviceNotifyList()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09712">IoGetLegacyVetoList()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09171">IoNotifyPowerOperationVetoed()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03933">IopChildToRootTranslation()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03759">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06528">IopDuplicateDetection()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06408">IopFindBusDeviceNode()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00127">IopForAllDeviceNodes()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00447">IopInsertTreeDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00725">IopLockDeviceRemovalRelations()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02554">IopPlacement()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01053">IopProcessAddDevices()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07876">IopQueryConflictFillString()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05757">IopReleaseResourcesInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03376">IopReserve()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04508">IopWaitForBootDevicesStarted()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a192" doxytag="pnpiop.h::IopRootDmaArbiter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d7/struct__ARBITER__INSTANCE.html">ARBITER_INSTANCE</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a192">IopRootDmaArbiter</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02470">2470</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/pnpdma_8c-source.html#l00095">IopDmaInitialize()</a>, and <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a191" doxytag="pnpiop.h::IopRootIrqArbiter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d7/struct__ARBITER__INSTANCE.html">ARBITER_INSTANCE</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a191">IopRootIrqArbiter</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02469">2469</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/pnpirq_8c-source.html#l00196">IopIrqInitialize()</a>, and <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a190" doxytag="pnpiop.h::IopRootMemArbiter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d7/struct__ARBITER__INSTANCE.html">ARBITER_INSTANCE</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a190">IopRootMemArbiter</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02468">2468</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00396">IopMemInitialize()</a>, and <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a189" doxytag="pnpiop.h::IopRootPortArbiter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d7/struct__ARBITER__INSTANCE.html">ARBITER_INSTANCE</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a189">IopRootPortArbiter</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02467">2467</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>, and <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00349">IopPortInitialize()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a180" doxytag="pnpiop.h::IopSetupNotifyData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html">PSETUP_NOTIFY_DATA</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a180">IopSetupNotifyData</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02374">2374</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08162">IopNotifySetupDeviceArrival()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a181" doxytag="pnpiop.h::IopTargetDeviceNotifyLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a181">IopTargetDeviceNotifyLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02375">2375</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06511">IopInitializePlugPlayNotification()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07055">IopNotifyTargetDeviceChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09301">IopOrphanNotification()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a201" doxytag="pnpiop.h::IopWarmEjectLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a201">IopWarmEjectLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02597">2597</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, and <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00422">IopWarmEjectDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a202" doxytag="pnpiop.h::IopWarmEjectPdo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a202">IopWarmEjectPdo</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02598">2598</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00048">IoBuildPoDeviceNotifyList()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, and <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00422">IopWarmEjectDevice()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a151" doxytag="pnpiop.h::PiEnumerationLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a151">PiEnumerationLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01011">1011</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04508">IopWaitForBootDevicesStarted()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a150" doxytag="pnpiop.h::PiEventQueueEmpty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="el" href="../../d9/d0/pnpiop_8h.html#a150">PiEventQueueEmpty</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01005">1005</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04617">IopWaitForBootDevicesDeleted()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a161" doxytag="pnpiop.h::PnpAsyncOk" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d0/pnpiop_8h.html#a161">PnpAsyncOk</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01073">1073</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04508">IopWaitForBootDevicesStarted()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a155" doxytag="pnpiop.h::PnPBootDriversInitialized" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d0/pnpiop_8h.html#a155">PnPBootDriversInitialized</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01035">1035</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a156" doxytag="pnpiop.h::PnPBootDriversLoaded" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d0/pnpiop_8h.html#a156">PnPBootDriversLoaded</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01041">1041</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a160" doxytag="pnpiop.h::PnpDefaultInterfaceType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INTERFACE_TYPE <a class="el" href="../../d9/d0/pnpiop_8h.html#a160">PnpDefaultInterfaceType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01067">1067</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08307">IoGetDmaAdapter()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00629">IopChangeInterfaceType()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04392">IopCmResourcesToIoResources()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04283">IopReadDeviceConfiguration()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05757">IopReleaseResourcesInternal()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a159" doxytag="pnpiop.h::PnPDetectionEnabled" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d0/pnpiop_8h.html#a159">PnPDetectionEnabled</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01061">1061</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a154" doxytag="pnpiop.h::PnPInitialized" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d0/pnpiop_8h.html#a154">PnPInitialized</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01029">1029</a> of file <a class="el" href="../../d0/d0/pnpiop_8h-source.html">pnpiop.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09712">IoGetLegacyVetoList()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01740">IopStartDriverDevices()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01291">IoSynchronousInvalidateDeviceRelations()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:13 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
