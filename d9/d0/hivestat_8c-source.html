<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hivestat.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hivestat.c</h1><a href="../../d8/d1/hivestat_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    hivestat.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Dumps various statistics on hv (low) level structures in a hive.  (See</span>
00012 <span class="comment">    regstat for higher level stuff.)</span>
00013 <span class="comment"></span>
00014 <span class="comment">    Statistics:</span>
00015 <span class="comment"></span>
00016 <span class="comment">        Short:  # of bins</span>
00017 <span class="comment">                average bin size</span>
00018 <span class="comment">                max bin size</span>
00019 <span class="comment">                # of cells</span>
00020 <span class="comment">                # of free cells</span>
00021 <span class="comment">                # of allocated cells</span>
00022 <span class="comment">                average free cell size</span>
00023 <span class="comment">                total free size</span>
00024 <span class="comment">                max free cell size</span>
00025 <span class="comment">                average allocated size</span>
00026 <span class="comment">                total allocated size</span>
00027 <span class="comment">                max allocated cell size</span>
00028 <span class="comment">                overhead summary (header, bin headers, cell headers)</span>
00029 <span class="comment"></span>
00030 <span class="comment">        Long: bin#, offset, size</span>
00031 <span class="comment">              cell offset, size, allocated</span>
00032 <span class="comment">              cell offset, size, free</span>
00033 <span class="comment"></span>
00034 <span class="comment"></span>
00035 <span class="comment">    Usage: {[+|-][&lt;option&gt;]} &lt;filename&gt;</span>
00036 <span class="comment">           (+ = on by default, - = off by default)</span>
00037 <span class="comment">           +s = summary - all of the short statistics</span>
00038 <span class="comment">           -t[bafc] = trace, line per entry, bin, allocated, free, all cells</span>
00039 <span class="comment">                (+tbc == +tbaf)</span>
00040 <span class="comment">           -c = cell type summary</span>
00041 <span class="comment">           -a[kvs] = Access Export (key nodes, values, SDs)</span>
00042 <span class="comment"></span>
00043 <span class="comment">Author:</span>
00044 <span class="comment"></span>
00045 <span class="comment">    Bryan M. Willman (bryanwi) 2-Sep-1992</span>
00046 <span class="comment"></span>
00047 <span class="comment">Revision History:</span>
00048 <span class="comment"></span>
00049 <span class="comment">--*/</span>
00050 
00051 <span class="comment">/*</span>
00052 <span class="comment"></span>
00053 <span class="comment">    NOTE:   Unlike other hive/registry tools, this one will not read the</span>
00054 <span class="comment">            entire hive into memory, but will instead read it in via</span>
00055 <span class="comment">            file I/O.  This makes it faster/easier to apply to very large</span>
00056 <span class="comment">            hives.</span>
00057 <span class="comment"></span>
00058 <span class="comment">*/</span>
00059 <span class="preprocessor">#include "<a class="code" href="../../d5/d7/regutil_8h.html">regutil.h</a>"</span>
00060 <span class="preprocessor">#include "<a class="code" href="../../d0/d5/edithive_8h.html">edithive.h</a>"</span>
00061 
00062 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00063 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00064 <span class="preprocessor">#include &lt;string.h&gt;</span>
00065 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00066 
<a name="l00067"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a0">00067</a> UCHAR *<a class="code" href="../../d8/d1/hivestat_8c.html#a0">helptext</a>[] = {
00068  <span class="stringliteral">"hivestat:                                                               "</span>,
00069  <span class="stringliteral">"Statistics:                                                             "</span>,
00070  <span class="stringliteral">"    Short:  # of bins                                                   "</span>,
00071  <span class="stringliteral">"            average bin size                                            "</span>,
00072  <span class="stringliteral">"            max bin size                                                "</span>,
00073  <span class="stringliteral">"            # of cells                                                  "</span>,
00074  <span class="stringliteral">"            # of free cells                                             "</span>,
00075  <span class="stringliteral">"            # of allocated cells                                        "</span>,
00076  <span class="stringliteral">"            average free cell size                                      "</span>,
00077  <span class="stringliteral">"            total free size                                             "</span>,
00078  <span class="stringliteral">"            max free cell size                                          "</span>,
00079  <span class="stringliteral">"            average allocated size                                      "</span>,
00080  <span class="stringliteral">"            total allocated size                                        "</span>,
00081  <span class="stringliteral">"            max allocated cell size                                     "</span>,
00082  <span class="stringliteral">"            overhead summary (header, bin headers, cell headers)        "</span>,
00083  <span class="stringliteral">"    Long: bin#, offset, size                                            "</span>,
00084  <span class="stringliteral">"          cell offset, size, allocated                                  "</span>,
00085  <span class="stringliteral">"          cell offset, size, free                                       "</span>,
00086  <span class="stringliteral">"Usage: {[+|-][&lt;option&gt;]} &lt;filename&gt;                                     "</span>,
00087  <span class="stringliteral">"       (+ = on by default, - = off by default)                          "</span>,
00088  <span class="stringliteral">"       +s = summary - all of the short statistics                       "</span>,
00089  <span class="stringliteral">"       -t[bafc] = trace, line per entry, bin, allocated, free, all cells"</span>,
00090  <span class="stringliteral">"            (+tbc == +tbaf)                                             "</span>,
00091  <span class="stringliteral">"       -c = cell type summary                                           "</span>,
00092  <span class="stringliteral">"       -a[kvs] = Access Export (key nodes, values, SDs)                 "</span>,
00093  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00094 };
00095 
00096 
00097 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00098 <a class="code" href="../../d8/d1/hivestat_8c.html#a21">ParseArgs</a>(
00099     <span class="keywordtype">int</span>     argc,
00100     <span class="keywordtype">char</span>    *argv[]
00101     );
00102 
00103 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00104 <a class="code" href="../../d8/d1/hivestat_8c.html#a30">ScanHive</a>(
00105     VOID
00106     );
00107 
00108 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00109 <a class="code" href="../../d8/d1/hivestat_8c.html#a31">ScanCell</a>(
00110     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a> Cell,
00111     ULONG CellSize
00112     );
00113 
00114 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00115 <a class="code" href="../../d8/d1/hivestat_8c.html#a24">ScanKeyNode</a>(
00116     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node,
00117     IN ULONG CellSize
00118     );
00119 
00120 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00121 <a class="code" href="../../d8/d1/hivestat_8c.html#a25">ScanKeyValue</a>(
00122     IN <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> Value,
00123     IN ULONG CellSize
00124     );
00125 
00126 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00127 <a class="code" href="../../d8/d1/hivestat_8c.html#a26">ScanKeySD</a>(
00128     IN <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security,
00129     IN ULONG CellSize
00130     );
00131 
00132 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00133 <a class="code" href="../../d8/d1/hivestat_8c.html#a27">ScanKeyIndex</a>(
00134     IN <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a> Index,
00135     IN ULONG CellSize
00136     );
00137 
00138 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00139 <a class="code" href="../../d8/d1/hivestat_8c.html#a28">ScanUnknown</a>(
00140     IN <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Data,
00141     IN ULONG CellSize
00142     );
00143 
00144 
00145 <span class="comment">//</span>
00146 <span class="comment">//  CONTROL ARGUMENTS</span>
00147 <span class="comment">//</span>
<a name="l00148"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a1">00148</a> BOOLEAN <a class="code" href="../../d8/d1/hivestat_8c.html#a1">DoCellType</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00149"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a2">00149</a> BOOLEAN <a class="code" href="../../d8/d1/hivestat_8c.html#a2">DoSummary</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
<a name="l00150"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a3">00150</a> BOOLEAN <a class="code" href="../../d8/d1/hivestat_8c.html#a3">DoTraceBin</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00151"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a4">00151</a> BOOLEAN <a class="code" href="../../d8/d1/hivestat_8c.html#a4">DoTraceFree</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00152"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a5">00152</a> BOOLEAN <a class="code" href="../../d8/d1/hivestat_8c.html#a5">DoTraceAlloc</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00153 
<a name="l00154"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a6">00154</a> BOOLEAN <a class="code" href="../../d8/d1/hivestat_8c.html#a6">AccessKeys</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00155"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a7">00155</a> BOOLEAN <a class="code" href="../../d8/d1/hivestat_8c.html#a7">AccessValues</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00156"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a8">00156</a> BOOLEAN <a class="code" href="../../d8/d1/hivestat_8c.html#a8">AccessSD</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00157"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a9">00157</a> LPCTSTR <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00158 
<a name="l00159"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a10">00159</a> ULONG <a class="code" href="../../d8/d1/hivestat_8c.html#a10">HiveVersion</a>;
00160 
00161 <span class="comment">//</span>
00162 <span class="comment">//  SUMMARY TOTALS</span>
00163 <span class="comment">//</span>
<a name="l00164"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a11">00164</a> ULONG <a class="code" href="../../d8/d1/hivestat_8c.html#a11">SizeKeyData</a>=0;
<a name="l00165"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a12">00165</a> ULONG <a class="code" href="../../d8/d1/hivestat_8c.html#a12">SizeValueData</a>=0;
<a name="l00166"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a13">00166</a> ULONG <a class="code" href="../../d8/d1/hivestat_8c.html#a13">SizeSDData</a>=0;
<a name="l00167"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a14">00167</a> ULONG <a class="code" href="../../d8/d1/hivestat_8c.html#a14">SizeIndexData</a>=0;
<a name="l00168"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a15">00168</a> ULONG <a class="code" href="../../d8/d1/hivestat_8c.html#a15">SizeUnknownData</a>=0;
00169 
<a name="l00170"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a16">00170</a> ULONG <a class="code" href="../../d8/d1/hivestat_8c.html#a16">NumKeyData</a>=0;
<a name="l00171"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a17">00171</a> ULONG <a class="code" href="../../d8/d1/hivestat_8c.html#a17">NumValueData</a>=0;
<a name="l00172"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a18">00172</a> ULONG <a class="code" href="../../d8/d1/hivestat_8c.html#a18">NumSDData</a>=0;
<a name="l00173"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a19">00173</a> ULONG <a class="code" href="../../d8/d1/hivestat_8c.html#a19">NumIndexData</a>=0;
<a name="l00174"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a20">00174</a> ULONG <a class="code" href="../../d8/d1/hivestat_8c.html#a20">NumUnknownData</a>=0;
00175 
00176 <span class="keywordtype">void</span>
<a name="l00177"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a29">00177</a> <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a>(
00178     <span class="keywordtype">int</span> argc,
00179     <span class="keywordtype">char</span> *argv[]
00180     )
00181 {
00182     <a class="code" href="../../d8/d1/hivestat_8c.html#a21">ParseArgs</a>(argc, argv);
00183     <a class="code" href="../../d8/d1/hivestat_8c.html#a30">ScanHive</a>();
00184     <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(0);
00185 }
00186 
00187 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00188"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a21">00188</a> <a class="code" href="../../d8/d1/hivestat_8c.html#a21">ParseArgs</a>(
00189     <span class="keywordtype">int</span>     argc,
00190     <span class="keywordtype">char</span>    *argv[]
00191     )
00192 <span class="comment">/*++</span>
00193 <span class="comment"></span>
00194 <span class="comment">Routine Description:</span>
00195 <span class="comment"></span>
00196 <span class="comment">    Read arguments and set control arguments and file name from them.</span>
00197 <span class="comment"></span>
00198 <span class="comment">Arguments:</span>
00199 <span class="comment"></span>
00200 <span class="comment">    argc, argv, standard meaning</span>
00201 <span class="comment"></span>
00202 <span class="comment">Return Value:</span>
00203 <span class="comment"></span>
00204 <span class="comment">    None.</span>
00205 <span class="comment"></span>
00206 <span class="comment">--*/</span>
00207 {
00208     <span class="keywordtype">char</span> *p;
00209     <span class="keywordtype">int</span> i;
00210     BOOLEAN command;
00211 
00212     <span class="keywordflow">if</span> (argc == 1) {
00213         <span class="keywordflow">for</span> (i = 0; <a class="code" href="../../d8/d1/hivestat_8c.html#a0">helptext</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; i++) {
00214             fprintf(stderr, <span class="stringliteral">"%s\n"</span>, <a class="code" href="../../d8/d1/hivestat_8c.html#a0">helptext</a>[i]);
00215         }
00216         <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00217     }
00218 
00219     <span class="keywordflow">for</span> (i = 1; i &lt; argc; i++) {
00220         p = argv[i];
00221 
00222         <span class="keywordflow">if</span> (*p == <span class="charliteral">'+'</span>) {
00223             <span class="comment">// switch something on</span>
00224             command = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00225 
00226         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*p == <span class="charliteral">'-'</span>) {
00227             <span class="comment">// switch something off</span>
00228             command = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00229 
00230         } <span class="keywordflow">else</span> {
00231             <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = p;
00232             <span class="keywordflow">continue</span>;
00233         }
00234 
00235         p++;
00236         <span class="keywordflow">if</span> (*p == <span class="charliteral">'\0'</span>)
00237             <span class="keywordflow">continue</span>;
00238 
00239         <span class="keywordflow">switch</span> (*p) {
00240         <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00241         <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
00242             <a class="code" href="../../d8/d1/hivestat_8c.html#a2">DoSummary</a> = command;
00243             <span class="keywordflow">break</span>;
00244 
00245         <span class="keywordflow">case</span> <span class="charliteral">'c'</span>:
00246         <span class="keywordflow">case</span> <span class="charliteral">'C'</span>:
00247             <a class="code" href="../../d8/d1/hivestat_8c.html#a1">DoCellType</a> = command;
00248             <span class="keywordflow">break</span>;
00249 
00250         <span class="keywordflow">case</span> <span class="charliteral">'a'</span>:
00251         <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
00252             p++;
00253             <span class="keywordflow">while</span> (*p != <span class="charliteral">'\0'</span>) {
00254                 <span class="keywordflow">switch</span> (*p) {
00255                     <span class="keywordflow">case</span> <span class="charliteral">'k'</span>:
00256                     <span class="keywordflow">case</span> <span class="charliteral">'K'</span>:
00257                         <a class="code" href="../../d8/d1/hivestat_8c.html#a6">AccessKeys</a> = command;
00258                         <span class="keywordflow">break</span>;
00259 
00260                     <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00261                     <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
00262                         <a class="code" href="../../d8/d1/hivestat_8c.html#a8">AccessSD</a> = command;
00263                         <span class="keywordflow">break</span>;
00264 
00265                     <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
00266                     <span class="keywordflow">case</span> <span class="charliteral">'V'</span>:
00267                         <a class="code" href="../../d8/d1/hivestat_8c.html#a7">AccessValues</a> = command;
00268                         <span class="keywordflow">break</span>;
00269 
00270                     <span class="keywordflow">default</span>:
00271                         <span class="keywordflow">break</span>;
00272                 }
00273                 p++;
00274             }
00275             <span class="keywordflow">break</span>;
00276 
00277         <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:
00278         <span class="keywordflow">case</span> <span class="charliteral">'T'</span>:
00279             p++;
00280             <span class="keywordflow">while</span> (*p != <span class="charliteral">'\0'</span>) {
00281 
00282                 <span class="keywordflow">switch</span> (*p) {
00283                 <span class="keywordflow">case</span> <span class="charliteral">'b'</span>:
00284                 <span class="keywordflow">case</span> <span class="charliteral">'B'</span>:
00285                     <a class="code" href="../../d8/d1/hivestat_8c.html#a3">DoTraceBin</a> = command;
00286                     <span class="keywordflow">break</span>;
00287 
00288                 <span class="keywordflow">case</span> <span class="charliteral">'a'</span>:
00289                 <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
00290                     <a class="code" href="../../d8/d1/hivestat_8c.html#a5">DoTraceAlloc</a> = command;
00291                     <span class="keywordflow">break</span>;
00292 
00293                 <span class="keywordflow">case</span> <span class="charliteral">'f'</span>:
00294                 <span class="keywordflow">case</span> <span class="charliteral">'F'</span>:
00295                     <a class="code" href="../../d8/d1/hivestat_8c.html#a4">DoTraceFree</a> = command;
00296                     <span class="keywordflow">break</span>;
00297 
00298                 <span class="keywordflow">case</span> <span class="charliteral">'c'</span>:
00299                 <span class="keywordflow">case</span> <span class="charliteral">'C'</span>:
00300                     <a class="code" href="../../d8/d1/hivestat_8c.html#a5">DoTraceAlloc</a> = command;
00301                     <a class="code" href="../../d8/d1/hivestat_8c.html#a4">DoTraceFree</a> = command;
00302                     <span class="keywordflow">break</span>;
00303 
00304                 <span class="keywordflow">default</span>:
00305                     <span class="keywordflow">break</span>;
00306                 }
00307 
00308                 p++;
00309             }
00310             <span class="keywordflow">break</span>;
00311 
00312         <span class="keywordflow">default</span>:
00313             <span class="keywordflow">break</span>;
00314         }
00315     }
00316     <span class="keywordflow">return</span>;
00317 }
00318 
00319 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00320"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a30">00320</a> <a class="code" href="../../d8/d1/hivestat_8c.html#a30">ScanHive</a>(
00321     )
00322 <span class="comment">/*++</span>
00323 <span class="comment"></span>
00324 <span class="comment">Routine Description:</span>
00325 <span class="comment"></span>
00326 <span class="comment">    Scan the hive, report what we see, based on control arguments.</span>
00327 <span class="comment"></span>
00328 <span class="comment">--*/</span>
00329 {
00330     <span class="keyword">static</span> <span class="keywordtype">char</span> buffer[<a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>];
00331     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a> bbp;
00332     HANDLE filehandle;
00333     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> rf;
00334     ULONG readcount;
00335     ULONG hivelength;
00336     ULONG hiveposition;
00337     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a> cp;
00338     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a> guard;
00339     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a> hbp;
00340     ULONG hoff;
00341     ULONG StatBinCount = 0;
00342     ULONG StatBinTotal = 0;
00343     ULONG StatBinMax = 0;
00344     ULONG StatFreeCount = 0;
00345     ULONG StatFreeTotal = 0;
00346     ULONG StatFreeMax = 0;
00347     ULONG StatAllocCount = 0;
00348     ULONG StatAllocTotal = 0;
00349     ULONG StatAllocMax = 0;
00350     ULONG binread;
00351     ULONG binsize;
00352     ULONG cellsize;
00353     ULONG boff;
00354     ULONG lboff;
00355     ULONG SizeTotal;
00356 
00357     <span class="comment">//</span>
00358     <span class="comment">// open the file</span>
00359     <span class="comment">//</span>
00360     filehandle = CreateFile(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>, GENERIC_READ, FILE_SHARE_READ, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00361                             <a class="code" href="../../d4/d8/ntfsexp_8h.html#a141a69">OPEN_EXISTING</a>, FILE_FLAG_SEQUENTIAL_SCAN, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00362 
00363     <span class="keywordflow">if</span> (filehandle == <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>) {
00364         fprintf(stderr,
00365                 <span class="stringliteral">"hivestat: Could not open file '%s' error = %08lx\n"</span>,
00366                 <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>, GetLastError()
00367                 );
00368         <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00369     }
00370 
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// read the header</span>
00374     <span class="comment">//</span>
00375     rf = ReadFile(filehandle, buffer, <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>, &amp;readcount, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00376     <span class="keywordflow">if</span> ( ( ! rf ) || (readcount != <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) ) {
00377         fprintf(stderr, <span class="stringliteral">"hivestat: '%s' - cannot read base block!\n"</span>, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>);
00378         <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00379     }
00380 
00381     bbp = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)(&amp;(buffer[0]));
00382 
00383     <span class="keywordflow">if</span> ((bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>) ||
00384         (bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a> &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>))
00385     {
00386         fprintf(stderr,
00387                 <span class="stringliteral">"hivestat: major/minor != %d/%d get newer hivestat\n"</span>,
00388                 <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>
00389                 );
00390         <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00391     }
00392 
00393     <a class="code" href="../../d8/d1/hivestat_8c.html#a10">HiveVersion</a> = bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a>;
00394 
00395     hivelength = bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00396     hiveposition = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00397     hoff = 0;
00398 
00399     printf(<span class="stringliteral">"hivestat: '%s'\n"</span>, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>);
00400     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/hivestat_8c.html#a3">DoTraceBin</a> || <a class="code" href="../../d8/d1/hivestat_8c.html#a4">DoTraceFree</a> || <a class="code" href="../../d8/d1/hivestat_8c.html#a5">DoTraceAlloc</a>) {
00401         printf(<span class="stringliteral">"\nTrace\n"</span>);
00402         printf(<span class="stringliteral">"bi=bin, fr=free, al=allocated\n"</span>);
00403         printf(<span class="stringliteral">"offset is file offset, sub HBLOCK to get HCELL\n"</span>);
00404         printf(<span class="stringliteral">"type,offset,size\n"</span>);
00405         printf(<span class="stringliteral">"\n"</span>);
00406     }
00407 
00408     <span class="comment">//</span>
00409     <span class="comment">// scan the hive</span>
00410     <span class="comment">//</span>
00411     guard = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(&amp;(buffer[0]) + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>);
00412 
00413     <span class="comment">//</span>
00414     <span class="comment">// hiveposition is file relative offset of next block we will read</span>
00415     <span class="comment">//</span>
00416     <span class="comment">// hoff is the file relative offset of the last block we read</span>
00417     <span class="comment">//</span>
00418     <span class="comment">// hivelength is actual length of file (header's recorded length plus</span>
00419     <span class="comment">// the size of the header.</span>
00420     <span class="comment">//</span>
00421     <span class="comment">// cp is pointer into memory, within range of buffer, it's a cell pointer</span>
00422     <span class="comment">//</span>
00423     <span class="keywordflow">while</span> (hiveposition &lt; hivelength) {
00424 
00425         <span class="comment">//</span>
00426         <span class="comment">// read in first block of bin, check signature, get bin stats</span>
00427         <span class="comment">//</span>
00428         rf = ReadFile(filehandle, buffer, <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>, &amp;readcount, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00429         <span class="keywordflow">if</span> ( ( ! rf ) || (readcount != <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) ) {
00430             fprintf(stderr, <span class="stringliteral">"hivestat: '%s' read error @%08lx\n"</span>, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>, hiveposition);
00431             <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00432         }
00433         hbp = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(&amp;(buffer[0]));
00434 
00435         <span class="keywordflow">if</span> (hbp-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>) {
00436             fprintf(stderr,
00437                     <span class="stringliteral">"hivestat: '%s' bad bin sign. @%08lx\n"</span>, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>, hiveposition);
00438             <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00439         }
00440         hiveposition += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00441         hoff += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00442         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(hoff+<a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a> == hiveposition);
00443 
00444         StatBinCount++;
00445         binsize = hbp-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00446         StatBinTotal += binsize;
00447         <span class="keywordflow">if</span> (binsize &gt; StatBinMax) {
00448             StatBinMax = binsize;
00449         }
00450 
00451         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/hivestat_8c.html#a3">DoTraceBin</a>) {
00452             printf(<span class="stringliteral">"bi,x%08lx,%ld\n"</span>, hoff, binsize);
00453         }
00454 
00455         <span class="comment">//</span>
00456         <span class="comment">// scan the bin</span>
00457         <span class="comment">//</span>
00458         <span class="comment">// cp = pointer to cell we are looking at</span>
00459         <span class="comment">// boff = offset within bin</span>
00460         <span class="comment">// lboff = last offset within bin, used only for consistency checks</span>
00461         <span class="comment">// binread = number of bytes of bin we've read so far</span>
00462         <span class="comment">//</span>
00463         cp = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)hbp + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));
00464         boff = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>);
00465         lboff = -1;
00466         binread = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00467 
00468         <span class="keywordflow">while</span> (binread &lt;= binsize) {
00469 
00470             <span class="comment">//</span>
00471             <span class="comment">// if free, do free stuff</span>
00472             <span class="comment">// else do alloc stuff</span>
00473             <span class="comment">// do full stuff</span>
00474             <span class="comment">//</span>
00475             <span class="keywordflow">if</span> (cp-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt; 0) {
00476                 <span class="comment">//</span>
00477                 <span class="comment">// free</span>
00478                 <span class="comment">//</span>
00479                 cellsize = cp-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00480                 StatFreeCount++;
00481                 StatFreeTotal += cellsize;
00482                 <span class="keywordflow">if</span> (cellsize &gt; StatFreeMax) {
00483                     StatFreeMax = cellsize;
00484                 }
00485 
00486                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/hivestat_8c.html#a4">DoTraceFree</a>) {
00487                     printf(<span class="stringliteral">"fr,x%08lx,%ld\n"</span>,
00488                            hoff+((PUCHAR)cp - &amp;(buffer[0])), cellsize);
00489                 }
00490 
00491 
00492             } <span class="keywordflow">else</span> {
00493                 <span class="comment">//</span>
00494                 <span class="comment">// alloc</span>
00495                 <span class="comment">//</span>
00496                 cellsize = -1 * cp-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00497                 StatAllocCount++;
00498                 StatAllocTotal += cellsize;
00499                 <span class="keywordflow">if</span> (cellsize &gt; StatAllocMax) {
00500                     StatAllocMax = cellsize;
00501                 }
00502 
00503                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/hivestat_8c.html#a5">DoTraceAlloc</a>) {
00504                     printf(<span class="stringliteral">"al,x%08lx,%ld\n"</span>,
00505                            hoff+((PUCHAR)cp - &amp;(buffer[0])), cellsize);
00506                 }
00507 
00508                 <a class="code" href="../../d8/d1/hivestat_8c.html#a31">ScanCell</a>(cp,cellsize);
00509 
00510             }
00511 
00512             <span class="comment">//</span>
00513             <span class="comment">// do basic consistency check</span>
00514             <span class="comment">//</span>
00515 <span class="preprocessor">#if 0</span>
00516 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (cp-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o1">Last</a> != lboff) {
00517                 printf(<span class="stringliteral">"e!,x%08lx  bad LAST pointer %08lx\n"</span>,
00518                         hoff+((PUCHAR)cp - &amp;(buffer[0])), cp-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o1">Last</a>);
00519             }
00520 <span class="preprocessor">#endif</span>
00521 <span class="preprocessor"></span>
00522             <span class="comment">//</span>
00523             <span class="comment">// advance to next cell</span>
00524             <span class="comment">//</span>
00525             lboff = boff;
00526             cp = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)cp + cellsize);
00527             boff += cellsize;
00528 
00529             <span class="comment">//</span>
00530             <span class="comment">// scan ahead in bin, if cp has reached off end of block,</span>
00531             <span class="comment">// AND there's bin left to read.</span>
00532             <span class="comment">// do this BEFORE breaking out for boff at end.</span>
00533             <span class="comment">//</span>
00534             <span class="keywordflow">while</span> ( (cp &gt;= guard) &amp;&amp; (binread &lt; binsize) ) {
00535 
00536                 rf = ReadFile(filehandle, buffer, <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>, &amp;readcount, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00537                 <span class="keywordflow">if</span> ( ( ! rf ) || (readcount != <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) ) {
00538                     fprintf(stderr, <span class="stringliteral">"hivestat: '%s' read error @%08lx\n"</span>, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>, hiveposition);
00539                     <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00540                 }
00541                 cp = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)cp - <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>);
00542                 hiveposition += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00543                 hoff += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00544                 binread += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00545                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(hoff+<a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a> == hiveposition);
00546             }
00547 
00548             <span class="keywordflow">if</span> (boff &gt;= binsize) {
00549                 <span class="keywordflow">break</span>;              <span class="comment">// we are done with this bin</span>
00550             }
00551         }
00552     }
00553 
00554     <span class="comment">//</span>
00555     <span class="comment">// Traces are done, stats gathered, print summary</span>
00556     <span class="comment">//</span>
00557     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/hivestat_8c.html#a2">DoSummary</a>) {
00558 
00559         printf(<span class="stringliteral">"\nSummary:\n"</span>);
00560         printf(<span class="stringliteral">"type\tcount/max single/total space\n"</span>);
00561         printf(<span class="stringliteral">"%s\t%7ld\t%7ld\t%7ld\n"</span>,
00562                 <span class="stringliteral">"bin"</span>, StatBinCount, StatBinMax, StatBinTotal);
00563         printf(<span class="stringliteral">"%s\t%7ld\t%7ld\t%7ld\n"</span>,
00564                 <span class="stringliteral">"free"</span>, StatFreeCount, StatFreeMax, StatFreeTotal);
00565         printf(<span class="stringliteral">"%s\t%7ld\t%7ld\t%7ld\n"</span>,
00566                 <span class="stringliteral">"alloc"</span>, StatAllocCount, StatAllocMax, StatAllocTotal);
00567 
00568     }
00569 
00570     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/hivestat_8c.html#a2">DoSummary</a> &amp;&amp; <a class="code" href="../../d8/d1/hivestat_8c.html#a1">DoCellType</a>) {
00571 
00572         printf(<span class="stringliteral">"\n"</span>);
00573 
00574         SizeTotal = <a class="code" href="../../d8/d1/hivestat_8c.html#a11">SizeKeyData</a> +
00575                     <a class="code" href="../../d8/d1/hivestat_8c.html#a12">SizeValueData</a> +
00576                     <a class="code" href="../../d8/d1/hivestat_8c.html#a13">SizeSDData</a> +
00577                     <a class="code" href="../../d8/d1/hivestat_8c.html#a14">SizeIndexData</a> +
00578                     <a class="code" href="../../d8/d1/hivestat_8c.html#a15">SizeUnknownData</a>;
00579 
00580         printf(<span class="stringliteral">"Total Key Data     %7d (%5.2f %%)\n"</span>, <a class="code" href="../../d8/d1/hivestat_8c.html#a11">SizeKeyData</a>,
00581             (<span class="keywordtype">float</span>)<a class="code" href="../../d8/d1/hivestat_8c.html#a11">SizeKeyData</a>*100/SizeTotal);
00582         printf(<span class="stringliteral">"Total Value Data   %7d (%5.2f %%)\n"</span>, <a class="code" href="../../d8/d1/hivestat_8c.html#a12">SizeValueData</a>,
00583             (<span class="keywordtype">float</span>)<a class="code" href="../../d8/d1/hivestat_8c.html#a12">SizeValueData</a>*100/SizeTotal);
00584         printf(<span class="stringliteral">"Total SD Data      %7d (%5.2f %%)\n"</span>, <a class="code" href="../../d8/d1/hivestat_8c.html#a13">SizeSDData</a>,
00585             (<span class="keywordtype">float</span>)<a class="code" href="../../d8/d1/hivestat_8c.html#a13">SizeSDData</a>*100/SizeTotal);
00586         printf(<span class="stringliteral">"Total Index Data   %7d (%5.2f %%)\n"</span>, <a class="code" href="../../d8/d1/hivestat_8c.html#a14">SizeIndexData</a>,
00587             (<span class="keywordtype">float</span>)<a class="code" href="../../d8/d1/hivestat_8c.html#a14">SizeIndexData</a>*100/SizeTotal);
00588         printf(<span class="stringliteral">"Total Unknown Data %7d (%5.2f %%)\n"</span>, <a class="code" href="../../d8/d1/hivestat_8c.html#a15">SizeUnknownData</a>,
00589             (<span class="keywordtype">float</span>)<a class="code" href="../../d8/d1/hivestat_8c.html#a15">SizeUnknownData</a>*100/SizeTotal);
00590 
00591         printf(<span class="stringliteral">"\n"</span>);
00592         printf(<span class="stringliteral">"Average Key Data     %8.2f (%d cells)\n"</span>,
00593             (<span class="keywordtype">float</span>)<a class="code" href="../../d8/d1/hivestat_8c.html#a11">SizeKeyData</a>/<a class="code" href="../../d8/d1/hivestat_8c.html#a16">NumKeyData</a>,
00594             <a class="code" href="../../d8/d1/hivestat_8c.html#a16">NumKeyData</a>);
00595         printf(<span class="stringliteral">"Average Value Data   %8.2f (%d cells)\n"</span>,
00596             (<span class="keywordtype">float</span>)<a class="code" href="../../d8/d1/hivestat_8c.html#a12">SizeValueData</a>/<a class="code" href="../../d8/d1/hivestat_8c.html#a17">NumValueData</a>,
00597             <a class="code" href="../../d8/d1/hivestat_8c.html#a17">NumValueData</a>);
00598         printf(<span class="stringliteral">"Average SD Data      %8.2f (%d cells)\n"</span>,
00599             (<span class="keywordtype">float</span>)<a class="code" href="../../d8/d1/hivestat_8c.html#a13">SizeSDData</a>/<a class="code" href="../../d8/d1/hivestat_8c.html#a18">NumSDData</a>,
00600             <a class="code" href="../../d8/d1/hivestat_8c.html#a18">NumSDData</a>);
00601         printf(<span class="stringliteral">"Average Index Data   %8.2f (%d cells)\n"</span>,
00602             (<span class="keywordtype">float</span>)<a class="code" href="../../d8/d1/hivestat_8c.html#a14">SizeIndexData</a>/<a class="code" href="../../d8/d1/hivestat_8c.html#a19">NumIndexData</a>,
00603             <a class="code" href="../../d8/d1/hivestat_8c.html#a19">NumIndexData</a>);
00604         printf(<span class="stringliteral">"Average Unknown Data %8.2f (%d cells)\n"</span>,
00605             (<span class="keywordtype">float</span>)<a class="code" href="../../d8/d1/hivestat_8c.html#a15">SizeUnknownData</a>/<a class="code" href="../../d8/d1/hivestat_8c.html#a20">NumUnknownData</a>,
00606             <a class="code" href="../../d8/d1/hivestat_8c.html#a20">NumUnknownData</a>);
00607     }
00608     <span class="keywordflow">return</span>;
00609 }
00610 
00611 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00612"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a31">00612</a> <a class="code" href="../../d8/d1/hivestat_8c.html#a31">ScanCell</a>(
00613     IN <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a> Cell,
00614     IN ULONG CellSize
00615     )
00616 
00617 <span class="comment">/*++</span>
00618 <span class="comment"></span>
00619 <span class="comment">Routine Description:</span>
00620 <span class="comment"></span>
00621 <span class="comment">    Given a pointer to an HCELL, this tries to figure out what type</span>
00622 <span class="comment">    of data is in it (key, value, SD, etc.) and gather interesting</span>
00623 <span class="comment">    statistics about it.</span>
00624 <span class="comment"></span>
00625 <span class="comment">Arguments:</span>
00626 <span class="comment"></span>
00627 <span class="comment">    Cell - Supplies a pointer to the HCELL</span>
00628 <span class="comment"></span>
00629 <span class="comment">    CellSize - Supplies the size of the HCELL</span>
00630 <span class="comment"></span>
00631 <span class="comment">Return Value:</span>
00632 <span class="comment"></span>
00633 <span class="comment">    None, sets some global statistics depending on content of the cell.</span>
00634 <span class="comment"></span>
00635 <span class="comment">--*/</span>
00636 
00637 {
00638     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Data;
00639 
00640     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d1/hivestat_8c.html#a1">DoCellType</a>) {
00641         <span class="keywordflow">return</span>;
00642     }
00643 
00644     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/hivestat_8c.html#a10">HiveVersion</a>==1) {
00645         Data = (<a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>)&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;u.OldCell.u.UserData;
00646     } <span class="keywordflow">else</span> {
00647         Data = (<a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>)&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;u.NewCell.u.UserData;
00648     }
00649 
00650     <span class="comment">//</span>
00651     <span class="comment">// grovel through the data, see if we can figure out what it looks like</span>
00652     <span class="comment">//</span>
00653     <span class="keywordflow">if</span> ((Data-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a25">CM_KEY_NODE_SIGNATURE</a>) &amp;&amp;
00654         (CellSize &gt; <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">CM_KEY_NODE</a>))) {
00655 
00656         <span class="comment">//</span>
00657         <span class="comment">// probably a key node</span>
00658         <span class="comment">//</span>
00659         <a class="code" href="../../d8/d1/hivestat_8c.html#a24">ScanKeyNode</a>(&amp;Data-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>, CellSize);
00660 
00661     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Data-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a34">CM_KEY_VALUE_SIGNATURE</a>) &amp;&amp;
00662                (CellSize &gt; <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">CM_KEY_VALUE</a>))) {
00663 
00664         <span class="comment">//</span>
00665         <span class="comment">// probably a key value</span>
00666         <span class="comment">//</span>
00667         <a class="code" href="../../d8/d1/hivestat_8c.html#a25">ScanKeyValue</a>(&amp;Data-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>, CellSize);
00668 
00669     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Data-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a39">CM_KEY_SECURITY_SIGNATURE</a>) &amp;&amp;
00670                (CellSize &gt; <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">CM_KEY_SECURITY</a>))) {
00671 
00672         <span class="comment">//</span>
00673         <span class="comment">// probably a security descriptor</span>
00674         <span class="comment">//</span>
00675         <a class="code" href="../../d8/d1/hivestat_8c.html#a26">ScanKeySD</a>(&amp;Data-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>, CellSize);
00676 
00677     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Data-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o3">KeyIndex</a>.<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) ||
00678                (Data-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o3">KeyIndex</a>.<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>)) {
00679         <span class="comment">//</span>
00680         <span class="comment">// probably a key index</span>
00681         <span class="comment">//</span>
00682         <a class="code" href="../../d8/d1/hivestat_8c.html#a27">ScanKeyIndex</a>(&amp;Data-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o3">KeyIndex</a>, CellSize);
00683 
00684     } <span class="keywordflow">else</span> {
00685         <span class="comment">//</span>
00686         <span class="comment">// Nothing with a signature, could be either</span>
00687         <span class="comment">//  name</span>
00688         <span class="comment">//  key list</span>
00689         <span class="comment">//  value data</span>
00690         <span class="comment">//</span>
00691         <a class="code" href="../../d8/d1/hivestat_8c.html#a28">ScanUnknown</a>(Data, CellSize);
00692 
00693     }
00694 }
00695 
00696 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00697"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a24">00697</a> <a class="code" href="../../d8/d1/hivestat_8c.html#a24">ScanKeyNode</a>(
00698     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node,
00699     IN ULONG CellSize
00700     )
00701 {
00702     <span class="keywordtype">int</span> i;
00703 
00704     <a class="code" href="../../d8/d1/hivestat_8c.html#a11">SizeKeyData</a> += CellSize;
00705     <a class="code" href="../../d8/d1/hivestat_8c.html#a16">NumKeyData</a>++;
00706 
00707     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/hivestat_8c.html#a6">AccessKeys</a>) {
00708         printf(<span class="stringliteral">"%d, %d, %d, %d, \""</span>,
00709                Node-&gt;SubKeyCounts[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>],
00710                Node-&gt;ValueList.Count,
00711                Node-&gt;NameLength,
00712                Node-&gt;ClassLength);
00713 
00714         <span class="keywordflow">for</span> (i=0; i &lt; Node-&gt;NameLength/<span class="keyword">sizeof</span>(WCHAR); i++) {
00715             printf(<span class="stringliteral">"%c"</span>,(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)Node-&gt;Name[i]);
00716         }
00717         printf(<span class="stringliteral">"\"\n"</span>);
00718     }
00719 
00720 }
00721 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00722"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a25">00722</a> <a class="code" href="../../d8/d1/hivestat_8c.html#a25">ScanKeyValue</a>(
00723     IN <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> Value,
00724     IN ULONG CellSize
00725     )
00726 {
00727     <span class="keywordtype">int</span> i;
00728     <span class="keywordtype">int</span> DataLength;
00729 
00730     <a class="code" href="../../d8/d1/hivestat_8c.html#a12">SizeValueData</a> += CellSize;
00731     <a class="code" href="../../d8/d1/hivestat_8c.html#a17">NumValueData</a>++;
00732     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/hivestat_8c.html#a7">AccessValues</a>) {
00733         DataLength = Value-&gt;DataLength;
00734         <span class="keywordflow">if</span> (DataLength &gt;= <a class="code" href="../../d9/d0/cmdata_8h.html#a35">CM_KEY_VALUE_SPECIAL_SIZE</a>) {
00735             DataLength -= <a class="code" href="../../d9/d0/cmdata_8h.html#a35">CM_KEY_VALUE_SPECIAL_SIZE</a>;
00736         }
00737         printf(<span class="stringliteral">"%d, %d, \""</span>,
00738                DataLength,
00739                Value-&gt;NameLength);
00740 
00741         <span class="keywordflow">for</span> (i=0; i &lt; Value-&gt;NameLength/<span class="keyword">sizeof</span>(WCHAR); i++) {
00742             printf(<span class="stringliteral">"%c"</span>,(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)Value-&gt;Name[i]);
00743         }
00744         printf(<span class="stringliteral">"\"\n"</span>);
00745     }
00746 
00747 }
00748 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00749"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a26">00749</a> <a class="code" href="../../d8/d1/hivestat_8c.html#a26">ScanKeySD</a>(
00750     IN <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security,
00751     IN ULONG CellSize
00752     )
00753 {
00754     <a class="code" href="../../d8/d1/hivestat_8c.html#a13">SizeSDData</a> += CellSize;
00755     <a class="code" href="../../d8/d1/hivestat_8c.html#a18">NumSDData</a>++;
00756 
00757     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/hivestat_8c.html#a8">AccessSD</a>) {
00758         printf(<span class="stringliteral">"%d,%d\n"</span>,
00759                Security-&gt;ReferenceCount,
00760                Security-&gt;DescriptorLength);
00761     }
00762 
00763 }
00764 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00765"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a27">00765</a> <a class="code" href="../../d8/d1/hivestat_8c.html#a27">ScanKeyIndex</a>(
00766     IN <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a> Index,
00767     IN ULONG CellSize
00768     )
00769 {
00770     <a class="code" href="../../d8/d1/hivestat_8c.html#a14">SizeIndexData</a> += CellSize;
00771     <a class="code" href="../../d8/d1/hivestat_8c.html#a19">NumIndexData</a>++;
00772 
00773 }
00774 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00775"></a><a class="code" href="../../d8/d1/hivestat_8c.html#a28">00775</a> <a class="code" href="../../d8/d1/hivestat_8c.html#a28">ScanUnknown</a>(
00776     IN <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Data,
00777     IN ULONG CellSize
00778     )
00779 {
00780     <a class="code" href="../../d8/d1/hivestat_8c.html#a15">SizeUnknownData</a> += CellSize;
00781     <a class="code" href="../../d8/d1/hivestat_8c.html#a20">NumUnknownData</a>++;
00782 
00783 }
00784 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:17 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
