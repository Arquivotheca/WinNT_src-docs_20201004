<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cminit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cminit.c</h1><a href="../../d8/d1/cminit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cminit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains init support for the CM level of the</span>
00012 <span class="comment">    config manager/hive.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Bryan M. Willman (bryanwi) 2-Apr-1992</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">// Prototypes local to this module</span>
00026 <span class="comment">//</span>
00027 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00028 <a class="code" href="../../d8/d1/cminit_8c.html#a2">CmpOpenFileWithExtremePrejudice</a>(
00029     OUT PHANDLE Primary,
00030     IN POBJECT_ATTRIBUTES Obja,
00031     IN ULONG IoFlags,
00032     IN ULONG AttributeFlags
00033     );
00034 
00035 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpOpenHiveFiles)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpInitializeHive)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDestroyHive)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpOpenFileWithExtremePrejudice)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span>
<a name="l00042"></a><a class="code" href="../../d8/d1/cminit_8c.html#a0">00042</a> <span class="keyword">extern</span> <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>;
<a name="l00043"></a><a class="code" href="../../d8/d1/cminit_8c.html#a1">00043</a> <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>;
00044 
00045 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00046"></a><a class="code" href="../../d8/d1/cminit_8c.html#a3">00046</a> <a class="code" href="../../d1/d2/cmp_8h.html#a290">CmpOpenHiveFiles</a>(
00047     PUNICODE_STRING     BaseName,
00048     PWSTR               Extension OPTIONAL,
00049     PHANDLE             Primary,
00050     PHANDLE             Secondary,
00051     PULONG              PrimaryDisposition,
00052     PULONG              SecondaryDisposition,
00053     BOOLEAN             CreateAllowed,
00054     BOOLEAN             MarkAsSystemHive,
00055     OUT OPTIONAL PULONG ClusterSize
00056     )
00057 <span class="comment">/*++</span>
00058 <span class="comment"></span>
00059 <span class="comment">Routine Description:</span>
00060 <span class="comment"></span>
00061 <span class="comment">    Open/Create Primary, Alternate, and Log files for Hives.</span>
00062 <span class="comment"></span>
00063 <span class="comment">    BaseName is some name like "\winnt\system32\config\system".</span>
00064 <span class="comment">    Extension is ".alt" or ".log" or NULL.</span>
00065 <span class="comment"></span>
00066 <span class="comment">    If extension is NULL skip secondary work.</span>
00067 <span class="comment"></span>
00068 <span class="comment">    If extension is .alt or .log, open/create a secondary file</span>
00069 <span class="comment">    (e.g. "\winnt\system32\config\system.alt")</span>
00070 <span class="comment"></span>
00071 <span class="comment">    If extension is .log, open secondary for buffered I/O, else,</span>
00072 <span class="comment">    open for non-buffered I/O.  Primary always uses non-buffered I/O.</span>
00073 <span class="comment"></span>
00074 <span class="comment">    If primary is newly created, supersede secondary.  If secondary</span>
00075 <span class="comment">    does not exist, simply create (other code will complain if Log</span>
00076 <span class="comment">    is needed but does not exist.)</span>
00077 <span class="comment"></span>
00078 <span class="comment">    WARNING:    If Secondary handle is NULL, you have no log</span>
00079 <span class="comment">                or alternate!</span>
00080 <span class="comment"></span>
00081 <span class="comment">Arguments:</span>
00082 <span class="comment"></span>
00083 <span class="comment">    BaseName - unicode string of base hive file, must have space for</span>
00084 <span class="comment">                extension if that is used.</span>
00085 <span class="comment"></span>
00086 <span class="comment">    Extension - unicode type extension of secondary file, including</span>
00087 <span class="comment">                the leading "."</span>
00088 <span class="comment"></span>
00089 <span class="comment">    Primary - will get handle to primary file</span>
00090 <span class="comment"></span>
00091 <span class="comment">    Secondary - will get handle to secondary, or NULL</span>
00092 <span class="comment"></span>
00093 <span class="comment">    PrimaryDisposition - STATUS_SUCCESS or STATUS_CREATED, of primary file.</span>
00094 <span class="comment"></span>
00095 <span class="comment">    SecondaryDisposition - STATUS_SUCCESS or STATUS_CREATED, of secondary file.</span>
00096 <span class="comment"></span>
00097 <span class="comment">    CreateAllowed - if TRUE will create nonexistent primary, if FALSE will</span>
00098 <span class="comment">                    fail if primary does not exist.  no effect on log</span>
00099 <span class="comment"></span>
00100 <span class="comment">    MarkAsSystemHive - if TRUE will call into file system to mark this</span>
00101 <span class="comment">                       as a critical system hive.</span>
00102 <span class="comment"></span>
00103 <span class="comment">    ClusterSize - if not NULL, will compute and return the appropriate</span>
00104 <span class="comment">        cluster size for the primary file.</span>
00105 <span class="comment"></span>
00106 <span class="comment">Return Value:</span>
00107 <span class="comment"></span>
00108 <span class="comment">    status - if status is success, Primay succeeded, check Secondary</span>
00109 <span class="comment">             value to see if it succeeded.</span>
00110 <span class="comment"></span>
00111 <span class="comment">--*/</span>
00112 {
00113     IO_STATUS_BLOCK     IoStatus;
00114     IO_STATUS_BLOCK     FsctlIoStatus;
00115     FILE_FS_SIZE_INFORMATION FsSizeInformation;
00116     ULONG Cluster;
00117     ULONG               CreateDisposition;
00118     OBJECT_ATTRIBUTES   <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00119     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
00120     UNICODE_STRING      ExtName;
00121     UNICODE_STRING      <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>;
00122     PVOID               WorkBuffer;
00123     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>              NameSize;
00124     ULONG               IoFlags;
00125     ULONG               AttributeFlags;
00126     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>              CompressionState;
00127     HANDLE              hEvent;
00128     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>             pEvent;
00129 
00130     <span class="comment">//</span>
00131     <span class="comment">// Allocate an event to use for our overlapped I/O</span>
00132     <span class="comment">//</span>
00133     status = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a14">CmpCreateEvent</a>(NotificationEvent, &amp;hEvent, &amp;pEvent);
00134     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00135         <span class="keywordflow">return</span>(status);
00136     }
00137     
00138     <span class="comment">//</span>
00139     <span class="comment">// Allocate a buffer big enough to hold the full name</span>
00140     <span class="comment">//</span>
00141     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Length = 0;
00142     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.MaximumLength = 0;
00143     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00144     WorkBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00145 
00146     NameSize = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>-&gt;Length;
00147     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Extension)) {
00148         NameSize += (wcslen(Extension)+1) * <span class="keyword">sizeof</span>(WCHAR);
00149         WorkBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, NameSize);
00150         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Buffer = WorkBuffer;
00151         <span class="keywordflow">if</span> (WorkBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00152             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEvent);
00153             ZwClose(hEvent);
00154             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00155         }
00156         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.MaximumLength = NameSize;
00157         <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>, (PSTRING)<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>);
00158     } <span class="keywordflow">else</span> {
00159         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a> = *<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>;
00160     }
00161 
00162 
00163     <span class="comment">//</span>
00164     <span class="comment">// Open/Create the primary</span>
00165     <span class="comment">//</span>
00166     InitializeObjectAttributes(
00167         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00168         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>,
00169         OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
00170         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00171         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00172         );
00173 
00174     <span class="keywordflow">if</span> (CreateAllowed) {
00175         CreateDisposition = FILE_OPEN_IF;
00176     } <span class="keywordflow">else</span> {
00177         CreateDisposition = FILE_OPEN;
00178     }
00179 
00180     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00181 
00182     status = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>(
00183                 Primary,
00184                 FILE_READ_DATA | FILE_WRITE_DATA,
00185                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00186                 &amp;IoStatus,
00187                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                               <span class="comment">// alloc size = none</span>
00188                 FILE_ATTRIBUTE_NORMAL,
00189                 0,                                  <span class="comment">// share nothing</span>
00190                 CreateDisposition,
00191                 FILE_NO_INTERMEDIATE_BUFFERING | 
00192                 FILE_OPEN_FOR_BACKUP_INTENT |
00193                 FILE_NO_COMPRESSION,
00194                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                               <span class="comment">// eabuffer</span>
00195                 0                                   <span class="comment">// ealength</span>
00196                 );
00197     <span class="keywordflow">if</span> (status == STATUS_ACCESS_DENIED) {
00198 
00199         <span class="comment">//</span>
00200         <span class="comment">// This means some foolish person has put a read-only attribute</span>
00201         <span class="comment">// on one of the critical system hive files. Remove it so they</span>
00202         <span class="comment">// don't hurt themselves.</span>
00203         <span class="comment">//</span>
00204 
00205         status = <a class="code" href="../../d8/d1/cminit_8c.html#a2">CmpOpenFileWithExtremePrejudice</a>(Primary,
00206                                                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00207                                                  FILE_NO_INTERMEDIATE_BUFFERING |
00208                                                  FILE_OPEN_FOR_BACKUP_INTENT |
00209                                                  FILE_NO_COMPRESSION,
00210                                                  FILE_ATTRIBUTE_NORMAL);
00211     }
00212 
00213     <span class="keywordflow">if</span> ((MarkAsSystemHive) &amp;&amp;
00214         (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))) {
00215 
00216         <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00217         status = ZwFsControlFile(*Primary,
00218                                  hEvent,
00219                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00220                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00221                                  &amp;FsctlIoStatus,
00222                                  FSCTL_MARK_AS_SYSTEM_HIVE,
00223                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00224                                  0,
00225                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00226                                  0);
00227         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00228             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(pEvent,
00229                                   <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00230                                   <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00231                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00232                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00233             status = FsctlIoStatus.Status;
00234         }
00235 
00236         <span class="comment">//</span>
00237         <span class="comment">//  STATUS_INVALID_DEVICE_REQUEST is OK.</span>
00238         <span class="comment">//</span>
00239 
00240         <span class="keywordflow">if</span> (status == STATUS_INVALID_DEVICE_REQUEST) {
00241             status = STATUS_SUCCESS;
00242 
00243         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00244             ZwClose(*Primary);
00245         }
00246     }
00247 
00248     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00249         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00250             KdPrint((<span class="stringliteral">"CMINIT: CmpOpenHiveFile: "</span>));
00251             KdPrint((<span class="stringliteral">"\tPrimary Open/Create failed for:\n"</span>));
00252             KdPrint((<span class="stringliteral">"\t%wZ\n"</span>, &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>));
00253             KdPrint((<span class="stringliteral">"\tstatus = %08lx\n"</span>, status));
00254         }
00255         <span class="keywordflow">if</span> (WorkBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00256             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WorkBuffer);
00257         }
00258         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEvent);
00259         ZwClose(hEvent);
00260         <span class="keywordflow">return</span> status;
00261     }
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">// Make sure the file is uncompressed in order to prevent the filesystem</span>
00265     <span class="comment">// from failing our updates due to disk full conditions.</span>
00266     <span class="comment">//</span>
00267     <span class="comment">// Do not fail to open the file if this fails, we don't want to prevent</span>
00268     <span class="comment">// people from booting just because their disk is full. Although they</span>
00269     <span class="comment">// will not be able to update their registry, they will at lease be</span>
00270     <span class="comment">// able to delete some files.</span>
00271     <span class="comment">//</span>
00272     CompressionState = 0;
00273     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00274     status = ZwFsControlFile(*Primary,
00275                              hEvent,
00276                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00277                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00278                              &amp;FsctlIoStatus,
00279                              FSCTL_SET_COMPRESSION,
00280                              &amp;CompressionState,
00281                              <span class="keyword">sizeof</span>(CompressionState),
00282                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00283                              0);
00284     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00285         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(pEvent,
00286                               <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00287                               <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00288                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00289                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00290     }
00291 
00292     *PrimaryDisposition = (ULONG) IoStatus.Information;
00293 
00294     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ClusterSize)) {
00295 
00296         <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00297         status = ZwQueryVolumeInformationFile(*Primary,
00298                                               &amp;IoStatus,
00299                                               &amp;FsSizeInformation,
00300                                               <span class="keyword">sizeof</span>(FILE_FS_SIZE_INFORMATION),
00301                                               FileFsSizeInformation);
00302         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00303             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEvent);
00304             ZwClose(hEvent);
00305             <span class="keywordflow">return</span>(status);
00306         }
00307         <span class="keywordflow">if</span> (FsSizeInformation.BytesPerSector &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
00308             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00309                 KdPrint((<span class="stringliteral">"CmpOpenHiveFiles: sectorsize %lx &gt; HBLOCK_SIZE\n"</span>));
00310             }
00311             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEvent);
00312             ZwClose(hEvent);
00313             <span class="keywordflow">return</span>(STATUS_CANNOT_LOAD_REGISTRY_FILE);
00314         }
00315 
00316         Cluster = FsSizeInformation.BytesPerSector / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00317         *ClusterSize = (Cluster &lt; 1) ? 1 : Cluster;
00318 
00319     }
00320 
00321     <span class="keywordflow">if</span> ( ! ARGUMENT_PRESENT(Extension)) {
00322         <span class="keywordflow">if</span> (WorkBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00323             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WorkBuffer);
00324         }
00325         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEvent);
00326         ZwClose(hEvent);
00327         <span class="keywordflow">return</span> STATUS_SUCCESS;
00328     }
00329 
00330     <span class="comment">//</span>
00331     <span class="comment">// Open/Create the secondary</span>
00332     <span class="comment">//</span>
00333     CreateDisposition = FILE_OPEN_IF;
00334     <span class="keywordflow">if</span> (*PrimaryDisposition == FILE_CREATED) {
00335         CreateDisposition = FILE_SUPERSEDE;
00336     }
00337 
00338     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ExtName,Extension);
00339     status = <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>, (PSTRING)&amp;ExtName);
00340 
00341     InitializeObjectAttributes(&amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00342                                &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>,
00343                                OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
00344                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00345                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00346 
00347     IoFlags = FILE_NO_COMPRESSION;
00348     <span class="keywordflow">if</span> (_wcsnicmp(Extension, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">".log"</span>, 4) != 0) {
00349         IoFlags |= FILE_NO_INTERMEDIATE_BUFFERING;
00350         AttributeFlags = FILE_ATTRIBUTE_NORMAL;
00351     } <span class="keywordflow">else</span> {
00352         AttributeFlags = FILE_ATTRIBUTE_NORMAL | FILE_ATTRIBUTE_HIDDEN;
00353     }
00354 
00355     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00356     status = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>(
00357                 Secondary,
00358                 FILE_READ_DATA | FILE_WRITE_DATA,
00359                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00360                 &amp;IoStatus,
00361                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                               <span class="comment">// alloc size = none</span>
00362                 AttributeFlags,
00363                 0,                                  <span class="comment">// share nothing</span>
00364                 CreateDisposition,
00365                 IoFlags,
00366                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                               <span class="comment">// eabuffer</span>
00367                 0                                   <span class="comment">// ealength</span>
00368                 );
00369 
00370     <span class="keywordflow">if</span> (status == STATUS_ACCESS_DENIED) {
00371 
00372         <span class="comment">//</span>
00373         <span class="comment">// This means some foolish person has put a read-only attribute</span>
00374         <span class="comment">// on one of the critical system hive files. Remove it so they</span>
00375         <span class="comment">// don't hurt themselves.</span>
00376         <span class="comment">//</span>
00377 
00378         status = <a class="code" href="../../d8/d1/cminit_8c.html#a2">CmpOpenFileWithExtremePrejudice</a>(Secondary,
00379                                                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00380                                                  IoFlags,
00381                                                  AttributeFlags);
00382     }
00383 
00384     <span class="keywordflow">if</span> ((MarkAsSystemHive) &amp;&amp;
00385         (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))) {
00386 
00387         <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00388         status = ZwFsControlFile(*Secondary,
00389                                  hEvent,
00390                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00391                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00392                                  &amp;FsctlIoStatus,
00393                                  FSCTL_MARK_AS_SYSTEM_HIVE,
00394                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00395                                  0,
00396                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00397                                  0);
00398         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00399             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(pEvent,
00400                                   <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00401                                   <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00402                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00403                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00404             status = FsctlIoStatus.Status;
00405         }
00406         <span class="comment">//</span>
00407         <span class="comment">//  STATUS_INVALID_DEVICE_REQUEST is OK.</span>
00408         <span class="comment">//</span>
00409 
00410         <span class="keywordflow">if</span> (status == STATUS_INVALID_DEVICE_REQUEST) {
00411             status = STATUS_SUCCESS;
00412 
00413         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00414 
00415             ZwClose(*Secondary);
00416         }
00417     }
00418 
00419     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00420         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00421             KdPrint((<span class="stringliteral">"CMINIT: CmpOpenHiveFile: "</span>));
00422             KdPrint((<span class="stringliteral">"\tSecondary Open/Create failed for:\n"</span>));
00423             KdPrint((<span class="stringliteral">"\t%wZ\n"</span>, &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>));
00424             KdPrint((<span class="stringliteral">"\tstatus = %08lx\n"</span>, status));
00425         }
00426         *Secondary = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00427     }
00428 
00429     *SecondaryDisposition = (ULONG) IoStatus.Information;
00430 
00431     <span class="comment">//</span>
00432     <span class="comment">// Make sure the file is uncompressed in order to prevent the filesystem</span>
00433     <span class="comment">// from failing our updates due to disk full conditions.</span>
00434     <span class="comment">//</span>
00435     <span class="comment">// Do not fail to open the file if this fails, we don't want to prevent</span>
00436     <span class="comment">// people from booting just because their disk is full. Although they</span>
00437     <span class="comment">// will not be able to update their registry, they will at lease be</span>
00438     <span class="comment">// able to delete some files.</span>
00439     <span class="comment">//</span>
00440     CompressionState = 0;
00441 
00442     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00443     status = ZwFsControlFile(*Secondary,
00444                              hEvent,
00445                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00446                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00447                              &amp;FsctlIoStatus,
00448                              FSCTL_SET_COMPRESSION,
00449                              &amp;CompressionState,
00450                              <span class="keyword">sizeof</span>(CompressionState),
00451                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00452                              0);
00453     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00454         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(pEvent,
00455                               <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00456                               <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00457                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00458                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00459     }
00460 
00461     <span class="keywordflow">if</span> (WorkBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00462         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WorkBuffer);
00463     }
00464     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEvent);
00465     ZwClose(hEvent);
00466     <span class="keywordflow">return</span> STATUS_SUCCESS;
00467 }
00468 
00469 
00470 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00471"></a><a class="code" href="../../d1/d2/cmp_8h.html#a275">00471</a> <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(
00472     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>         *CmHive,
00473     ULONG           OperationType,
00474     ULONG           HiveFlags,
00475     ULONG           FileType,
00476     PVOID           HiveData OPTIONAL,
00477     HANDLE          Primary,
00478     HANDLE          Alternate,
00479     HANDLE          Log,
00480     HANDLE          External,
00481     PUNICODE_STRING FileName OPTIONAL
00482     )
00483 <span class="comment">/*++</span>
00484 <span class="comment"></span>
00485 <span class="comment">Routine Description:</span>
00486 <span class="comment"></span>
00487 <span class="comment">    Initialize a hive.</span>
00488 <span class="comment"></span>
00489 <span class="comment">Arguments:</span>
00490 <span class="comment"></span>
00491 <span class="comment">    CmHive - pointer to a variable to receive a pointer to the CmHive structure</span>
00492 <span class="comment"></span>
00493 <span class="comment">    OperationType - specifies whether to create a new hive from scratch,</span>
00494 <span class="comment">            from a memory image, or by reading a file from disk.</span>
00495 <span class="comment">            [HINIT_CREATE | HINIT_MEMORY | HINIT_FILE ]</span>
00496 <span class="comment"></span>
00497 <span class="comment">    HiveFlags - HIVE_VOLATILE - Entire hive is to be volatile, regardless</span>
00498 <span class="comment">                                   of the types of cells allocated</span>
00499 <span class="comment">                HIVE_NO_LAZY_FLUSH - Data in this hive is never written</span>
00500 <span class="comment">                                   to disk except by an explicit FlushKey</span>
00501 <span class="comment"></span>
00502 <span class="comment">    FileType - HFILE_TYPE_*, HFILE_TYPE_LOG or HFILE_TYPE_ALTERNATE set</span>
00503 <span class="comment">            up for logging or alternate support respectively.</span>
00504 <span class="comment"></span>
00505 <span class="comment">    HiveData - if present, supplies a pointer to an in memory image of</span>
00506 <span class="comment">            from which to init the hive.  Only useful when OperationType</span>
00507 <span class="comment">            is set to HINIT_MEMORY.</span>
00508 <span class="comment"></span>
00509 <span class="comment">    Primary - File handle for primary hive file (e.g. SYSTEM)</span>
00510 <span class="comment"></span>
00511 <span class="comment">    Alternate - File handle for alternate hive file (e.g. SYSTEM.ALT)</span>
00512 <span class="comment"></span>
00513 <span class="comment">    Log - File handle for log hive file (e.g. SOFTWARE.LOG)</span>
00514 <span class="comment"></span>
00515 <span class="comment">    External - File handle for primary hive file  (e.g.  BACKUP.REG)</span>
00516 <span class="comment"></span>
00517 <span class="comment">    FileName - some path like "...\system32\config\system", which will</span>
00518 <span class="comment">                be written into the base block as an aid to debugging.</span>
00519 <span class="comment">                may be NULL.</span>
00520 <span class="comment"></span>
00521 <span class="comment">Return Value:</span>
00522 <span class="comment"></span>
00523 <span class="comment">    NTSTATUS</span>
00524 <span class="comment"></span>
00525 <span class="comment">--*/</span>
00526 {
00527     FILE_FS_SIZE_INFORMATION    FsSizeInformation;
00528     IO_STATUS_BLOCK             IoStatusBlock;
00529     ULONG                       Cluster;
00530     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00531     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>                     cmhive2;
00532     ULONG                       rc;
00533 
00534     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
00535         KdPrint((<span class="stringliteral">"CmpInitializeHive:\t\n"</span>));
00536     }
00537 
00538     <span class="comment">//</span>
00539     <span class="comment">// Reject illegal parms</span>
00540     <span class="comment">//</span>
00541     <span class="keywordflow">if</span> ( (Alternate &amp;&amp; Log)  ||
00542          (External &amp;&amp; (Primary || Alternate || Log)) ||
00543          (Alternate &amp;&amp; !Primary) ||
00544          (Log &amp;&amp; !Primary) ||
00545          ((HiveFlags &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) &amp;&amp; (Alternate || Primary || External || Log)) ||
00546          ((OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) &amp;&amp; (!ARGUMENT_PRESENT(HiveData))) ||
00547          (Log &amp;&amp; (FileType != <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>)) ||
00548          (Alternate &amp;&amp; (FileType != <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>))
00549        )
00550     {
00551         <span class="keywordflow">return</span> (STATUS_INVALID_PARAMETER);
00552     }
00553 
00554     <span class="comment">//</span>
00555     <span class="comment">// compute control</span>
00556     <span class="comment">//</span>
00557     <span class="keywordflow">if</span> (Primary) {
00558 
00559         <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00560         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryVolumeInformationFile(
00561                     Primary,
00562                     &amp;IoStatusBlock,
00563                     &amp;FsSizeInformation,
00564                     <span class="keyword">sizeof</span>(FILE_FS_SIZE_INFORMATION),
00565                     FileFsSizeInformation
00566                     );
00567         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00568             <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00569         }
00570         <span class="keywordflow">if</span> (FsSizeInformation.BytesPerSector &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
00571             <span class="keywordflow">return</span> (STATUS_REGISTRY_IO_FAILED);
00572         }
00573         Cluster = FsSizeInformation.BytesPerSector / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00574         Cluster = (Cluster &lt; 1) ? 1 : Cluster;
00575     } <span class="keywordflow">else</span> {
00576         Cluster = 1;
00577     }
00578 
00579     cmhive2 = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a11">CmpAllocate</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00580     <span class="keywordflow">if</span> (cmhive2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00581         <span class="keywordflow">return</span> (STATUS_INSUFFICIENT_RESOURCES);
00582     }
00583 
00584     <span class="comment">//</span>
00585     <span class="comment">// Allocate the mutex from NonPagedPool so it will not be swapped to the disk</span>
00586     <span class="comment">//</span>
00587     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> = (<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>), CM_POOL_TAG );
00588     <span class="keywordflow">if</span>( cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00589         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(cmhive2, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a178">CMHIVE</a>));
00590         <span class="keywordflow">return</span> (STATUS_INSUFFICIENT_RESOURCES);
00591     }
00592 
00593     <span class="comment">//</span>
00594     <span class="comment">// Initialize the Cm hive control block</span>
00595     <span class="comment">//</span>
00596     <span class="comment">//</span>
00597     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>+1) == <a class="code" href="../../d0/d1/hivedata_8h.html#a42">HFILE_TYPE_MAX</a>);
00598     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>] = Primary;
00599     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>] = Alternate;
00600     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>] = Log;
00601     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = External;
00602 
00603     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o2">NotifyList</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00604     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o2">NotifyList</a>.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00605 
00606     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
00607 
00608     <span class="comment">//</span>
00609     <span class="comment">// Initialize the Hv hive control block</span>
00610     <span class="comment">//</span>
00611     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/hiveinit_8c.html#a3">HvInitializeHive</a>(
00612                 &amp;(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00613                 OperationType,
00614                 HiveFlags,
00615                 FileType,
00616                 HiveData,
00617                 <a class="code" href="../../d1/d2/cmp_8h.html#a216">CmpAllocate</a>,
00618                 <a class="code" href="../../d1/d2/cmp_8h.html#a217">CmpFree</a>,
00619                 <a class="code" href="../../d1/d2/cmp_8h.html#a218">CmpFileSetSize</a>,
00620                 <a class="code" href="../../d1/d2/cmp_8h.html#a220">CmpFileWrite</a>,
00621                 <a class="code" href="../../d1/d2/cmp_8h.html#a221">CmpFileRead</a>,
00622                 <a class="code" href="../../d1/d2/cmp_8h.html#a222">CmpFileFlush</a>,
00623                 Cluster,
00624                 <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>
00625                 );
00626     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00627         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00628             KdPrint((<span class="stringliteral">"CmpInitializeHive: "</span>));
00629             KdPrint((<span class="stringliteral">"HvInitializeHive failed, Status = %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00630         }
00631         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
00632         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
00633         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(cmhive2, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a178">CMHIVE</a>));
00634         <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00635     }
00636     <span class="keywordflow">if</span> ( (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>) ||
00637          (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) ||
00638          (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>))
00639     {
00640         rc = <a class="code" href="../../d1/d2/cmp_8h.html#a294">CmCheckRegistry</a>(cmhive2, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00641         <span class="keywordflow">if</span> (rc != 0) {
00642             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00643                 KdPrint((<span class="stringliteral">"CmpInitializeHive: "</span>));
00644                 KdPrint((<span class="stringliteral">"CmCheckRegistry failed, rc = %08lx\n"</span>,rc));
00645             }
00646             <span class="comment">//</span>
00647             <span class="comment">// in theory we should do this for MEMORY and MEMORY_INPLACE</span>
00648             <span class="comment">// as well, but they're only used at init time.</span>
00649             <span class="comment">//</span>
00650             <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>) {
00651                 <a class="code" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)cmhive2);
00652             }
00653             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
00654             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
00655             <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(cmhive2, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a178">CMHIVE</a>));
00656             <span class="keywordflow">return</span>(STATUS_REGISTRY_CORRUPT);
00657         }
00658     }
00659 
00660     InsertHeadList(&amp;<a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>, &amp;(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o3">HiveList</a>));
00661     *CmHive = cmhive2;
00662     <span class="keywordflow">return</span> (STATUS_SUCCESS);
00663 }
00664 
00665 
00666 BOOLEAN
<a name="l00667"></a><a class="code" href="../../d1/d2/cmp_8h.html#a276">00667</a> <a class="code" href="../../d1/d2/cmp_8h.html#a276">CmpDestroyHive</a>(
00668     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00669     IN HCELL_INDEX Cell
00670     )
00671 
00672 <span class="comment">/*++</span>
00673 <span class="comment"></span>
00674 <span class="comment">Routine Description:</span>
00675 <span class="comment"></span>
00676 <span class="comment">    This routine tears down a cmhive.</span>
00677 <span class="comment"></span>
00678 <span class="comment">Arguments:</span>
00679 <span class="comment"></span>
00680 <span class="comment">    Hive - Supplies a pointer to the hive to be freed.</span>
00681 <span class="comment"></span>
00682 <span class="comment">    Cell - Supplies index of the hive's root cell.</span>
00683 <span class="comment"></span>
00684 <span class="comment">Return Value:</span>
00685 <span class="comment"></span>
00686 <span class="comment">    TRUE if successful</span>
00687 <span class="comment">    FALSE if some failure occurred</span>
00688 <span class="comment"></span>
00689 <span class="comment">--*/</span>
00690 
00691 {
00692     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> CellData;
00693     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LinkCell;
00694     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00695 
00696     <span class="comment">//</span>
00697     <span class="comment">// First find the link cell.</span>
00698     <span class="comment">//</span>
00699     CellData = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00700     LinkCell = CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00701 
00702     <span class="comment">//</span>
00703     <span class="comment">// Now delete the link cell.</span>
00704     <span class="comment">//</span>
00705     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>) == 0);
00706     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>, LinkCell, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00707 
00708     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00709         <span class="comment">//</span>
00710         <span class="comment">// Take the hive out of the hive list</span>
00711         <span class="comment">//</span>
00712         RemoveEntryList(&amp;( ((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>)-&gt;<a class="code" href="../../d4/d6/regext_8c.html#a0">HiveList</a>));
00713         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00714     } <span class="keywordflow">else</span> {
00715         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00716     }
00717 }
00718 
00719 
00720 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00721"></a><a class="code" href="../../d8/d1/cminit_8c.html#a2">00721</a> <a class="code" href="../../d8/d1/cminit_8c.html#a2">CmpOpenFileWithExtremePrejudice</a>(
00722     OUT PHANDLE Primary,
00723     IN POBJECT_ATTRIBUTES Obja,
00724     IN ULONG IoFlags,
00725     IN ULONG AttributeFlags
00726     )
00727 
00728 <span class="comment">/*++</span>
00729 <span class="comment"></span>
00730 <span class="comment">Routine Description:</span>
00731 <span class="comment"></span>
00732 <span class="comment">    This routine opens a hive file that some foolish person has put a</span>
00733 <span class="comment">    read-only attribute on. It is used to prevent people from hurting</span>
00734 <span class="comment">    themselves by making the critical system hive files read-only.</span>
00735 <span class="comment"></span>
00736 <span class="comment">Arguments:</span>
00737 <span class="comment"></span>
00738 <span class="comment">    Primary - Returns handle to file</span>
00739 <span class="comment"></span>
00740 <span class="comment">    Obja - Supplies Object Attributes of file.</span>
00741 <span class="comment"></span>
00742 <span class="comment">    IoFlags - Supplies flags to pass to ZwCreateFile</span>
00743 <span class="comment"></span>
00744 <span class="comment">Return Value:</span>
00745 <span class="comment"></span>
00746 <span class="comment">    NTSTATUS</span>
00747 <span class="comment"></span>
00748 <span class="comment">--*/</span>
00749 
00750 {
00751     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00752     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00753     IO_STATUS_BLOCK IoStatusBlock;
00754     FILE_BASIC_INFORMATION FileInfo;
00755 
00756     <span class="comment">//</span>
00757     <span class="comment">// Get the current file attributes</span>
00758     <span class="comment">//</span>
00759     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00760     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a37">ZwQueryAttributesFile</a>(Obja, &amp;FileInfo);
00761     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00762         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00763     }
00764 
00765     <span class="comment">//</span>
00766     <span class="comment">// Clear the readonly bit.</span>
00767     <span class="comment">//</span>
00768     FileInfo.FileAttributes &amp;= ~FILE_ATTRIBUTE_READONLY;
00769 
00770     <span class="comment">//</span>
00771     <span class="comment">// Open the file</span>
00772     <span class="comment">//</span>
00773     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(&amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00774                         FILE_WRITE_ATTRIBUTES,
00775                         Obja,
00776                         &amp;IoStatusBlock,
00777                         FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
00778                         FILE_OPEN_FOR_BACKUP_INTENT);
00779     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00780         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00781     }
00782 
00783     <span class="comment">//</span>
00784     <span class="comment">// Set the new attributes</span>
00785     <span class="comment">//</span>
00786     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a39">ZwSetInformationFile</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00787                                   &amp;IoStatusBlock,
00788                                   &amp;FileInfo,
00789                                   <span class="keyword">sizeof</span>(FileInfo),
00790                                   FileBasicInformation);
00791     ZwClose(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00792     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00793         <span class="comment">//</span>
00794         <span class="comment">// Reopen the file with the access that we really need.</span>
00795         <span class="comment">//</span>
00796         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>(Primary,
00797                               FILE_READ_DATA | FILE_WRITE_DATA,
00798                               Obja,
00799                               &amp;IoStatusBlock,
00800                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00801                               AttributeFlags,
00802                               0,
00803                               FILE_OPEN,
00804                               IoFlags,
00805                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00806                               0);
00807     }
00808 
00809     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00810 
00811 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
