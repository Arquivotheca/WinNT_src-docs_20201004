<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obhandle.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obhandle.c File Reference</h1><code>#include "<a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>"</code><br>

<p>
<a href="../../d0/d0/obhandle_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a0">GENERIC_ACCESS</a>&nbsp;&nbsp;&nbsp;(GENERIC_READ | GENERIC_WRITE | GENERIC_EXECUTE | GENERIC_ALL)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a2">ObpIncrementHandleDataBase</a> (IN <a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, OUT PULONG NewProcessHandleCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a3">ObpCaptureHandleInformation</a> (IN OUT PSYSTEM_HANDLE_TABLE_ENTRY_INFO *HandleEntryInfo, IN HANDLE UniqueProcessId, IN PVOID HandleTableEntry, IN HANDLE HandleIndex, IN ULONG Length, IN OUT PULONG RequiredLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a> (IN HANDLE SourceProcessHandle, IN HANDLE SourceHandle, IN HANDLE TargetProcessHandle OPTIONAL, OUT PHANDLE TargetHandle OPTIONAL, IN ACCESS_MASK DesiredAccess, IN ULONG HandleAttributes, IN ULONG Options)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a5">ObGetHandleInformation</a> (OUT PSYSTEM_HANDLE_INFORMATION HandleInformation, IN ULONG Length, OUT PULONG ReturnLength OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a6">ObpCaptureHandleInformation</a> (IN OUT PSYSTEM_HANDLE_TABLE_ENTRY_INFO *HandleEntryInfo, IN HANDLE UniqueProcessId, IN <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ObjectTableEntry, IN HANDLE HandleIndex, IN ULONG Length, IN OUT PULONG RequiredLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a7">ObpInsertHandleCount</a> (<a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a8">ObpIncrementHandleCount</a> (<a class="el" href="../../d4/d0/ob_8h.html#a21">OB_OPEN_REASON</a> OpenReason, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, PVOID Object, <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType, <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState OPTIONAL, <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, ULONG Attributes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a9">ObpIncrementUnnamedHandleCount</a> (PACCESS_MASK DesiredAccess, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, PVOID Object, <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType, <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, ULONG Attributes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a10">ObpChargeQuotaForObject</a> (IN <a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader, IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType, OUT PBOOLEAN NewObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a11">ObpDecrementHandleCount</a> (<a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, <a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader, <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType, ACCESS_MASK GrantedAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a12">ObpCreateHandle</a> (IN <a class="el" href="../../d4/d0/ob_8h.html#a21">OB_OPEN_REASON</a> OpenReason, IN PVOID Object, IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ExpectedObjectType OPTIONAL, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN ULONG ObjectPointerBias OPTIONAL, IN ULONG Attributes, IN BOOLEAN DirectoryLocked, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, OUT PVOID *ReferencedNewObject OPTIONAL, OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a13">ObpCreateUnnamedHandle</a> (IN PVOID Object, IN ACCESS_MASK DesiredAccess, IN ULONG ObjectPointerBias OPTIONAL, IN ULONG Attributes, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, OUT PVOID *ReferencedNewObject OPTIONAL, OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a14">ObpValidateDesiredAccess</a> (IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d7/struct__KMUTANT.html">KMUTANT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="obhandle.c::GENERIC_ACCESS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GENERIC_ACCESS&nbsp;&nbsp;&nbsp;(GENERIC_READ | GENERIC_WRITE | GENERIC_EXECUTE | GENERIC_ALL)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00027">27</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>, and <a class="el" href="../../d3/d4/seastate_8c-source.html#l00180">SeCreateAccessState()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a4" doxytag="obhandle.c::NtDuplicateObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtDuplicateObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE TargetProcessHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE TargetHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Options</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">163</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/se_8h.html#a27">AUX_ACCESS_DATA</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02695">_HANDLE_TABLE_ENTRY::CreatorBackTraceIndex</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01144">ExCreateHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00167">_ACCESS_STATE::GenerateOnClose</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00027">GENERIC_ACCESS</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02690">_HANDLE_TABLE_ENTRY::GrantedAccess</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00057">_OBJECT_HANDLE_INFORMATION::GrantedAccess</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02694">_HANDLE_TABLE_ENTRY::GrantedAccessIndex</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00056">_OBJECT_HANDLE_INFORMATION::HandleAttributes</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00178">KeReleaseMutant()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02674">_HANDLE_TABLE_ENTRY::ObAttributes</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a60">ObDuplicateHandle</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00408">OBJ_AUDIT_OBJECT_CLOSE</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00289">OBJ_HANDLE_ATTRIBUTES</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">ObpDecrementHandleCount()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00213">ObpGetObjectTable</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00034">ObpInitKillMutant</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02752">ObpValidateDesiredAccess()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03381">RtlMapGenericMask()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03736">SeAuditHandleCreation()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02573">SeAuditHandleDuplication()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00180">SeCreateAccessState()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00181">_OBJECT_TYPE_INITIALIZER::SecurityProcedure</a>, <a class="el" href="../../d1/d5/semethod_8c-source.html#l00195">SeDefaultObjectMethod()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00348">SeDeleteAccessState()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01709">SeDetailedAuditing</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00169">_OBJECT_TYPE_INITIALIZER::ValidAccessMask</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01912">ConsoleClientShutdown()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00626">InitWindowsStuff()</a>, <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00287">PropertiesDlgShow()</a>, <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00459">PropertiesUpdate()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00099">RtlpChangeQueryDebugBufferTarget()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02370">RtlpIOWorkerThread()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02824">RtlpWaitThread()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02137">RtlpWorkerThread()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00588">SepServerWaitForNextConnect()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01346">SrvConsoleNotifyLastClose()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01094">SrvRegisterConsoleVDM()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01229">SrvSetConsoleCP()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00853">SrvSetConsoleDisplayMode()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00421">TestTokenCreate()</a>.
<p>
<pre class="fragment"><div>00175                    :
00176 
00177     This function creates a handle that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a duplicate of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00178     source handle.  The source handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> evaluated in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00179     specified source process.  The calling process must have
00180     PROCESS_DUP_HANDLE access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source process.  The duplicate
00181     handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified attributes and desired access.
00182     The duplicate handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00183     target process.  The calling process must have PROCESS_DUP_HANDLE
00184     access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process.
00185 
00186 Arguments:
00187 
00188     SourceProcessHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source process <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00189         handle being duplicated
00190 
00191     SourceHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle being duplicated
00192 
00193     TargetProcessHandle - Optionally supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process
00194         that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle
00195 
00196     TargetHandle - Optionally returns a <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> duplicated handle
00197 
00198     DesiredAccess - Desired access <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle
00199 
00200     HandleAttributes - Desired attributes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle
00201 
00202     Options - Duplication options that <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> things like close source,
00203         same access, and same attributes.
00204 
00205 Return Value:
00206 
00207     TBS
00208 
00209 --*/
00210 
00211 {
00212     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00213     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00214     PVOID SourceObject;
00215     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00216     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00217     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> SourceProcess;
00218     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess;
00219     BOOLEAN Attached;
00220     PVOID ObjectTable;
00221     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a> ObjectTableEntry;
00222     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInformation;
00223     HANDLE NewHandle;
00224     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> AccessState;
00225     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">AUX_ACCESS_DATA</a> AuxData;
00226     ACCESS_MASK SourceAccess;
00227     ACCESS_MASK TargetAccess;
00228     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> PassedAccessState = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">//  Get previous processor mode and probe output arguments if necessary.</span>
00232     <span class="comment">//</span>
00233 
00234     PreviousMode = KeGetPreviousMode();
00235 
00236     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( TargetHandle ) &amp;&amp; (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
00237 
00238         <span class="keywordflow">try</span> {
00239 
00240             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>( TargetHandle );
00241 
00242         } except( EXCEPTION_EXECUTE_HANDLER ) {
00243 
00244             <span class="keywordflow">return</span>( GetExceptionCode() );
00245         }
00246     }
00247 
00248     <span class="comment">//</span>
00249     <span class="comment">//  If the caller is not asking for the same access then</span>
00250     <span class="comment">//  validate the access they are requesting doesn't contain</span>
00251     <span class="comment">//  any bad bits</span>
00252     <span class="comment">//</span>
00253 
00254     <span class="keywordflow">if</span> (!(Options &amp; DUPLICATE_SAME_ACCESS)) {
00255 
00256         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a83">ObpValidateDesiredAccess</a>( DesiredAccess );
00257 
00258         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00259 
00260             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00261         }
00262     }
00263 
00264     <span class="comment">//</span>
00265     <span class="comment">//  The Attached variable indicates if we needed to</span>
00266     <span class="comment">//  attach to the source process because it was not the</span>
00267     <span class="comment">//  current process.</span>
00268     <span class="comment">//</span>
00269 
00270     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">//  Given the input source process handle get a pointer</span>
00274     <span class="comment">//  to the source process object</span>
00275     <span class="comment">//</span>
00276 
00277     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( SourceProcessHandle,
00278                                         PROCESS_DUP_HANDLE,
00279                                         PsProcessType,
00280                                         PreviousMode,
00281                                         (PVOID *)&amp;SourceProcess,
00282                                         NULL );
00283 
00284     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00285 
00286         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00287     }
00288 
00289     <span class="comment">//</span>
00290     <span class="comment">//  Lock down access to the process object tables</span>
00291     <span class="comment">//</span>
00292 
00293     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00294 
00295     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;ObpInitKillMutant,
00296                            Executive,
00297                            KernelMode,
00298                            FALSE,
00299                            NULL );
00300 
00301     <span class="comment">//</span>
00302     <span class="comment">//  Make sure the source process has an object table still</span>
00303     <span class="comment">//</span>
00304 
00305     <span class="keywordflow">if</span> ( SourceProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00306 
00307         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;ObpInitKillMutant, 0, FALSE, FALSE );
00308 
00309         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00310 
00311         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceProcess );
00312 
00313         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00314     }
00315 
00316     <span class="comment">//</span>
00317     <span class="comment">//  If the specified source process is not the current process, attach</span>
00318     <span class="comment">//  to the specified source process.  Then after we reference the object</span>
00319     <span class="comment">//  we can detach from the process.</span>
00320     <span class="comment">//</span>
00321 
00322     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != SourceProcess) {
00323 
00324         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( &amp;SourceProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a> );
00325 
00326         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00327     }
00328 
00329     <span class="comment">//</span>
00330     <span class="comment">//  The the input source handle get a pointer to the</span>
00331     <span class="comment">//  source object itself, then detach from the process</span>
00332     <span class="comment">//  if necessary and check if we were given a good</span>
00333     <span class="comment">//  source handle.</span>
00334     <span class="comment">//</span>
00335 
00336     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( SourceHandle,
00337                                         0,
00338                                         (<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>)NULL,
00339                                         PreviousMode,
00340                                         &amp;SourceObject,
00341                                         &amp;HandleInformation );
00342 
00343     <span class="keywordflow">if</span> (Attached) {
00344 
00345         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00346 
00347         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00348     }
00349 
00350     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00351 
00352         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;ObpInitKillMutant, 0, FALSE, FALSE );
00353 
00354         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00355 
00356         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceProcess );
00357 
00358         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00359     }
00360 
00361     <span class="comment">//</span>
00362     <span class="comment">//  We are all done if no target process handle was specified.</span>
00363     <span class="comment">//  This is practially a noop because the only really end result</span>
00364     <span class="comment">//  could be that we've closed the source handle.</span>
00365     <span class="comment">//</span>
00366 
00367     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( TargetProcessHandle )) {
00368 
00369         <span class="comment">//</span>
00370         <span class="comment">//  If no TargetProcessHandle, then only possible option is to close</span>
00371         <span class="comment">//  the source handle in the context of the source process.</span>
00372         <span class="comment">//</span>
00373 
00374         <span class="keywordflow">if</span> (!(Options &amp; DUPLICATE_CLOSE_SOURCE)) {
00375 
00376             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00377         }
00378 
00379         <span class="keywordflow">if</span> (Options &amp; DUPLICATE_CLOSE_SOURCE) {
00380 
00381             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( &amp;SourceProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a> );
00382 
00383             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( SourceHandle );
00384 
00385             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00386         }
00387 
00388         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;ObpInitKillMutant, 0, FALSE, FALSE );
00389 
00390         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00391 
00392         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceObject );
00393         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceProcess );
00394 
00395         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00396     }
00397 
00398     SourceAccess = HandleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>;
00399 
00400     <span class="comment">//</span>
00401     <span class="comment">//  At this point the caller did specify for a target process</span>
00402     <span class="comment">//  So from the target process handle get a pointer to the</span>
00403     <span class="comment">//  target process object.</span>
00404     <span class="comment">//</span>
00405 
00406     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( TargetProcessHandle,
00407                                         PROCESS_DUP_HANDLE,
00408                                         PsProcessType,
00409                                         PreviousMode,
00410                                         (PVOID *)&amp;TargetProcess,
00411                                         NULL );
00412 
00413     <span class="comment">//</span>
00414     <span class="comment">//  If we cannot get the traget process object then close the</span>
00415     <span class="comment">//  source down if requsted, cleanup and return to our caller</span>
00416     <span class="comment">//</span>
00417 
00418     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00419 
00420         <span class="keywordflow">if</span> (Options &amp; DUPLICATE_CLOSE_SOURCE) {
00421 
00422             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( &amp;SourceProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a> );
00423 
00424             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( SourceHandle );
00425 
00426             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00427         }
00428 
00429         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;ObpInitKillMutant, 0, FALSE, FALSE );
00430 
00431         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00432 
00433         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceObject );
00434         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceProcess );
00435 
00436         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00437     }
00438 
00439     <span class="comment">//</span>
00440     <span class="comment">//  Make sure the target process has not exited</span>
00441     <span class="comment">//</span>
00442 
00443     <span class="keywordflow">if</span> ( TargetProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00444 
00445         <span class="keywordflow">if</span> (Options &amp; DUPLICATE_CLOSE_SOURCE) {
00446 
00447             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( &amp;SourceProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a> );
00448 
00449             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( SourceHandle );
00450 
00451             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00452         }
00453 
00454         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;ObpInitKillMutant, 0, FALSE, FALSE );
00455 
00456         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00457 
00458         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceObject );
00459         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceProcess );
00460         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( TargetProcess );
00461 
00462         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00463     }
00464 
00465     <span class="comment">//</span>
00466     <span class="comment">//  If the specified target process is not the current process, attach</span>
00467     <span class="comment">//  to the specified target process.</span>
00468     <span class="comment">//</span>
00469 
00470     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != TargetProcess) {
00471 
00472         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( &amp;TargetProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a> );
00473 
00474         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00475     }
00476 
00477     <span class="comment">//</span>
00478     <span class="comment">//  Construct the proper desired access and attributes for the new handle</span>
00479     <span class="comment">//</span>
00480 
00481     <span class="keywordflow">if</span> (Options &amp; DUPLICATE_SAME_ACCESS) {
00482 
00483         DesiredAccess = SourceAccess;
00484     }
00485 
00486     <span class="keywordflow">if</span> (Options &amp; DUPLICATE_SAME_ATTRIBUTES) {
00487 
00488         HandleAttributes = HandleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o0">HandleAttributes</a>;
00489 
00490     } <span class="keywordflow">else</span> {
00491 
00492         <span class="comment">//</span>
00493         <span class="comment">//  Always propogate auditing information.</span>
00494         <span class="comment">//</span>
00495 
00496         HandleAttributes |= HandleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o0">HandleAttributes</a> &amp; <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>;
00497     }
00498 
00499     <span class="comment">//</span>
00500     <span class="comment">//  Get the object header for the source object</span>
00501     <span class="comment">//</span>
00502 
00503     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( SourceObject );
00504     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00505 
00506     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = ObjectHeader;
00507     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> |= (HandleAttributes &amp; <a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
00508 
00509     <span class="comment">//</span>
00510     <span class="comment">//  If any of the generic access bits are specified then map those to more</span>
00511     <span class="comment">//  specific access bits</span>
00512     <span class="comment">//</span>
00513 
00514     <span class="keywordflow">if</span> ((DesiredAccess &amp; <a class="code" href="../../d9/d0/obhandle_8c.html#a0">GENERIC_ACCESS</a>) != 0) {
00515 
00516         <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>( &amp;DesiredAccess,
00517                            &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
00518     }
00519 
00520     <span class="comment">//</span>
00521     <span class="comment">//  Make sure to preserve ACCESS_SYSTEM_SECURITY, which most likely is not</span>
00522     <span class="comment">//  found in the ValidAccessMask</span>
00523     <span class="comment">//</span>
00524 
00525     TargetAccess = DesiredAccess &amp;
00526                    (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> | ACCESS_SYSTEM_SECURITY);
00527 
00528     <span class="comment">//</span>
00529     <span class="comment">//  If the access requested for the target is a superset of the</span>
00530     <span class="comment">//  access allowed in the source, perform full AVR.  If it is a</span>
00531     <span class="comment">//  subset or equal, do not perform any access validation.</span>
00532     <span class="comment">//</span>
00533     <span class="comment">//  Do not allow superset access if object type has a private security</span>
00534     <span class="comment">//  method, as there is no means to call them in this case to do the</span>
00535     <span class="comment">//  access check.</span>
00536     <span class="comment">//</span>
00537     <span class="comment">//  If the AccessState is not passed to ObpIncrementHandleCount</span>
00538     <span class="comment">//  there will be no AVR.</span>
00539     <span class="comment">//</span>
00540 
00541     <span class="keywordflow">if</span> (TargetAccess &amp; ~SourceAccess) {
00542 
00543         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a> == <a class="code" href="../../d0/d5/se_8h.html#a115">SeDefaultObjectMethod</a>) {
00544 
00545             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a2">SeCreateAccessState</a>( &amp;AccessState,
00546                                           &amp;AuxData,
00547                                           TargetAccess,       <span class="comment">// DesiredAccess</span>
00548                                           &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
00549 
00550             PassedAccessState = &amp;AccessState;
00551 
00552         } <span class="keywordflow">else</span> {
00553 
00554             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00555         }
00556 
00557     } <span class="keywordflow">else</span> {
00558 
00559         <span class="comment">//</span>
00560         <span class="comment">//  Do not perform AVR</span>
00561         <span class="comment">//</span>
00562 
00563         PassedAccessState = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00564 
00565         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00566     }
00567 
00568     <span class="comment">//</span>
00569     <span class="comment">//  Increment the new handle count and get a pointer to</span>
00570     <span class="comment">//  the target processes object table</span>
00571     <span class="comment">//</span>
00572 
00573     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00574 
00575         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a77">ObpIncrementHandleCount</a>( ObDuplicateHandle,
00576                                           <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(), <span class="comment">// this is already the target process</span>
00577                                           SourceObject,
00578                                           ObjectType,
00579                                           PassedAccessState,
00580                                           PreviousMode,
00581                                           HandleAttributes );
00582 
00583         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
00584 
00585         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ObjectTable);
00586     }
00587 
00588     <span class="keywordflow">if</span> (Attached) {
00589 
00590         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00591 
00592         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00593     }
00594 
00595     <span class="keywordflow">if</span> (Options &amp; DUPLICATE_CLOSE_SOURCE) {
00596 
00597         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( &amp;SourceProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a> );
00598 
00599         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( SourceHandle );
00600 
00601         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00602     }
00603 
00604     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00605 
00606         <span class="keywordflow">if</span> (PassedAccessState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00607 
00608             <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>( PassedAccessState );
00609         }
00610 
00611         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;ObpInitKillMutant, 0, FALSE, FALSE );
00612 
00613         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00614 
00615         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceObject );
00616         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceProcess );
00617         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( TargetProcess );
00618 
00619         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00620     }
00621 
00622     <span class="keywordflow">if</span> ((PassedAccessState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (PassedAccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o3">GenerateOnClose</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00623 
00624         <span class="comment">//</span>
00625         <span class="comment">//  If we performed AVR opening the handle, then mark the handle as needing</span>
00626         <span class="comment">//  auditing when it's closed.</span>
00627         <span class="comment">//</span>
00628 
00629         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> |= <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>;
00630     }
00631 
00632 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
00633 <span class="preprocessor"></span>
00634     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
00635 
00636         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> = ObpComputeGrantedAccessIndex( TargetAccess );
00637         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o4">CreatorBackTraceIndex</a> = RtlLogStackBackTrace();
00638 
00639     } <span class="keywordflow">else</span> {
00640 
00641         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = TargetAccess;
00642     }
00643 
00644 <span class="preprocessor">#else</span>
00645 <span class="preprocessor"></span>
00646     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = TargetAccess;
00647 
00648 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
00649 <span class="preprocessor"></span>
00650     <span class="comment">//</span>
00651     <span class="comment">//  Now that we've constructed a new object table entry for the duplicated handle</span>
00652     <span class="comment">//  we need to add it to the object table of the target process</span>
00653 
00654 
00655     NewHandle = <a class="code" href="../../d5/d8/ex_8h.html#a296">ExCreateHandle</a>( ObjectTable, &amp;ObjectTableEntry );
00656 
00657     <span class="keywordflow">if</span> (NewHandle) {
00658 
00659         <span class="comment">//</span>
00660         <span class="comment">//  We have a new handle to audit the creation of the new handle if</span>
00661         <span class="comment">//  AVR was done.  And set the optional output handle variable.  Note</span>
00662         <span class="comment">//  that if we reach here the status variable is already a success</span>
00663         <span class="comment">//</span>
00664 
00665         <span class="keywordflow">if</span> (PassedAccessState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00666 
00667             <a class="code" href="../../d3/d5/seaudit_8c.html#a28">SeAuditHandleCreation</a>( PassedAccessState, NewHandle );
00668         }
00669 
00670         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/se_8h.html#a106">SeDetailedAuditing</a> &amp;&amp; (ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> &amp; <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>)) {
00671 
00672             <a class="code" href="../../d7/d6/sepaudit_8c.html#a20">SeAuditHandleDuplication</a>( SourceHandle,
00673                                       NewHandle,
00674                                       SourceProcess,
00675                                       TargetProcess );
00676         }
00677 
00678         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( TargetHandle )) {
00679 
00680             <span class="keywordflow">try</span> {
00681 
00682                 *TargetHandle = NewHandle;
00683 
00684             } except( EXCEPTION_EXECUTE_HANDLER ) {
00685 
00686                 <span class="comment">//</span>
00687                 <span class="comment">//  Fall through, since we cannot undo what we have done.</span>
00688                 <span class="comment">//</span>
00689             }
00690         }
00691 
00692     } <span class="keywordflow">else</span> {
00693 
00694         <span class="comment">//</span>
00695         <span class="comment">//  We didn't get a new handle to decrement the handle count dereference</span>
00696         <span class="comment">//  the necessary objects, set the optional output variable and indicate</span>
00697         <span class="comment">//  why we're failing</span>
00698         <span class="comment">//</span>
00699 
00700         <a class="code" href="../../d5/d1/obp_8h.html#a78">ObpDecrementHandleCount</a>( TargetProcess,
00701                                  ObjectHeader,
00702                                  ObjectType,
00703                                  TargetAccess );
00704 
00705         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceObject );
00706 
00707         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( TargetHandle )) {
00708 
00709             <span class="keywordflow">try</span> {
00710 
00711                 *TargetHandle = (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00712 
00713             } except( EXCEPTION_EXECUTE_HANDLER ) {
00714 
00715                 <span class="comment">//</span>
00716                 <span class="comment">//  Fall through so we can return the correct status.</span>
00717                 <span class="comment">//</span>
00718             }
00719         }
00720 
00721         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00722     }
00723 
00724     <span class="comment">//</span>
00725     <span class="comment">//  Cleanup from our selfs and then return to our caller</span>
00726     <span class="comment">//</span>
00727 
00728     <span class="keywordflow">if</span> (PassedAccessState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00729 
00730         <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>( PassedAccessState );
00731     }
00732 
00733     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;ObpInitKillMutant, 0, FALSE, FALSE );
00734 
00735     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00736 
00737     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SourceProcess );
00738     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( TargetProcess );
00739 
00740     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00741 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="obhandle.c::ObGetHandleInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObGetHandleInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PSYSTEM_HANDLE_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ReturnLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00745">745</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00984">ExSnapShotHandleTables()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d0/obhandle_8c.html#a3">ObpCaptureHandleInformation()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03939">ExpGetHandleInformation()</a>.
<p>
<pre class="fragment"><div>00753                    :
00754 
00755     This routine returns information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle.
00756 
00757 Arguments:
00758 
00759     HandleInformation - Supplies an array of handle information
00760         structures to fill in
00761 
00762     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle information array in bytes
00763 
00764     ReturnLength - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes used by <span class="keyword">this</span> call
00765 
00766 Return Value:
00767 
00768     An appropriate status value
00769 
00770 --*/
00771 
00772 {
00773     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00774     ULONG RequiredLength;
00775 
00776     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00777 
00778     RequiredLength = FIELD_OFFSET( SYSTEM_HANDLE_INFORMATION, Handles );
00779 
00780     <span class="keywordflow">if</span> (Length &lt; RequiredLength) {
00781 
00782         <span class="keywordflow">return</span>( STATUS_INFO_LENGTH_MISMATCH );
00783     }
00784 
00785     HandleInformation-&gt;NumberOfHandles = 0;
00786 
00787     <span class="comment">//</span>
00788     <span class="comment">//  For every handle in every handle table we'll be calling</span>
00789     <span class="comment">//  our callback routine</span>
00790     <span class="comment">//</span>
00791 
00792     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d8/ex_8h.html#a295">ExSnapShotHandleTables</a>( ObpCaptureHandleInformation,
00793                                      HandleInformation,
00794                                      Length,
00795                                      &amp;RequiredLength );
00796 
00797     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
00798 
00799         *ReturnLength = RequiredLength;
00800     }
00801 
00802     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00803 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="obhandle.c::ObpCaptureHandleInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpCaptureHandleInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PSYSTEM_HANDLE_TABLE_ENTRY_INFO *&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleEntryInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>UniqueProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTableEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RequiredLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00807">807</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00313">_OBJECT_HEADER::Body</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00191">_OBJECT_TYPE::Index</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00289">OBJ_HANDLE_ATTRIBUTES</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00818                    :
00819 
00820     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine of <a class="code" href="../../d9/d0/obhandle_8c.html#a5">ObGetHandleInformation</a>
00821 
00822 Arguments:
00823 
00824     HandleEntryInfo - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output buffer to receive
00825         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle information
00826 
00827     UniqueProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <span class="keywordtype">id</span> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00828 
00829     ObjectTableEntry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table entry that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00830         captured
00831 
00832     HandleIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> preceding handle table entry
00833 
00834     Length - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original user buffer
00835 
00836     RequiredLength - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, that has already been
00837         used in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to store information.  On <span class="keywordflow">return</span> <span class="keyword">this</span> receives
00838         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> updated number of bytes being used.
00839 
00840         Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> HandleEntryInfo does not necessarily point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00841         start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original user buffer.  It will have been offset by
00842         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> feed-in RequiredLength value.
00843 
00844 Return Value:
00845 
00846     An appropriate status value
00847 
00848 --*/
00849 
00850 {
00851     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00852     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00853 
00854     <span class="comment">//</span>
00855     <span class="comment">//  Figure out who much size we really need to contain this extra record</span>
00856     <span class="comment">//  and then check that it fits.</span>
00857     <span class="comment">//</span>
00858 
00859     *RequiredLength += <span class="keyword">sizeof</span>( SYSTEM_HANDLE_TABLE_ENTRY_INFO );
00860 
00861     <span class="keywordflow">if</span> (Length &lt; *RequiredLength) {
00862 
00863         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
00864 
00865     } <span class="keywordflow">else</span> {
00866 
00867         <span class="comment">//</span>
00868         <span class="comment">//  Get the object header from the table entry and then copy over the information</span>
00869         <span class="comment">//</span>
00870 
00871         ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(((ULONG_PTR)(ObjectTableEntry-&gt;Object)) &amp; ~<a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
00872 
00873         (*HandleEntryInfo)-&gt;UniqueProcessId       = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)UniqueProcessId);
00874         (*HandleEntryInfo)-&gt;HandleAttributes      = (UCHAR)(ObjectTableEntry-&gt;ObAttributes &amp; <a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
00875         (*HandleEntryInfo)-&gt;ObjectTypeIndex       = (UCHAR)(ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o4">Index</a>);
00876         (*HandleEntryInfo)-&gt;HandleValue           = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)(HandleIndex));
00877         (*HandleEntryInfo)-&gt;Object                = &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a>;
00878         (*HandleEntryInfo)-&gt;CreatorBackTraceIndex = 0;
00879 
00880 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
00881 <span class="preprocessor"></span>
00882         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
00883 
00884             (*HandleEntryInfo)-&gt;CreatorBackTraceIndex = ObjectTableEntry-&gt;CreatorBackTraceIndex;
00885             (*HandleEntryInfo)-&gt;GrantedAccess = ObpTranslateGrantedAccessIndex( ObjectTableEntry-&gt;GrantedAccessIndex );
00886 
00887         } <span class="keywordflow">else</span> {
00888 
00889             (*HandleEntryInfo)-&gt;GrantedAccess = ObjectTableEntry-&gt;GrantedAccess;
00890         }
00891 
00892 <span class="preprocessor">#else</span>
00893 <span class="preprocessor"></span>
00894         (*HandleEntryInfo)-&gt;GrantedAccess = ObjectTableEntry-&gt;GrantedAccess;
00895 
00896 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
00897 <span class="preprocessor"></span>
00898         (*HandleEntryInfo)++;
00899 
00900         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00901     }
00902 
00903     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00904 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="obhandle.c::ObpCaptureHandleInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpCaptureHandleInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PSYSTEM_HANDLE_TABLE_ENTRY_INFO *&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleEntryInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>UniqueProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleTableEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RequiredLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00745">ObGetHandleInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="obhandle.c::ObpChargeQuotaForObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpChargeQuotaForObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>NewObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01861">1861</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00318">_OBJECT_HEADER_QUOTA_INFO::NonPagedPoolCharge</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00352">OB_FLAG_DEFAULT_SECURITY_QUOTA</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00347">OB_FLAG_NEW_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00362">OBJECT_HEADER_TO_QUOTA_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00317">_OBJECT_HEADER_QUOTA_INFO::PagedPoolCharge</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00024">PsChargeSharedPoolQuota()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00062">SE_DEFAULT_SECURITY_QUOTA</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00319">_OBJECT_HEADER_QUOTA_INFO::SecurityDescriptorCharge</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>.
<p>
<pre class="fragment"><div>01869                    :
01870 
01871     This routine charges quota against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
01872     object
01873 
01874 Arguments:
01875 
01876     ObjectHeader - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object being charged <span class="keywordflow">for</span>
01877 
01878     ObjectType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object
01879 
01880     NewObject - Returns <span class="keyword">true</span> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> really <span class="keyword">new</span> and <span class="keyword">false</span> otherwise
01881 
01882 Return Value:
01883 
01884     An appropriate status value
01885 
01886 --*/
01887 
01888 {
01889     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
01890     ULONG NonPagedPoolCharge;
01891     ULONG PagedPoolCharge;
01892 
01893     <span class="comment">//</span>
01894     <span class="comment">//  Get a pointer to the quota block for this object</span>
01895     <span class="comment">//</span>
01896 
01897     QuotaInfo = <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>( ObjectHeader );
01898 
01899     *NewObject = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01900 
01901     <span class="comment">//</span>
01902     <span class="comment">//  If the object is new then we have work to do otherwise</span>
01903     <span class="comment">//  we'll return with NewObject set to false</span>
01904     <span class="comment">//</span>
01905 
01906     <span class="keywordflow">if</span> (ObjectHeader-&gt;Flags &amp; <a class="code" href="../../d4/d0/ob_8h.html#a1">OB_FLAG_NEW_OBJECT</a>) {
01907 
01908         <span class="comment">//</span>
01909         <span class="comment">//  Say the object now isn't new</span>
01910         <span class="comment">//</span>
01911 
01912         ObjectHeader-&gt;Flags &amp;= ~<a class="code" href="../../d4/d0/ob_8h.html#a1">OB_FLAG_NEW_OBJECT</a>;
01913 
01914         <span class="comment">//</span>
01915         <span class="comment">//  If there does exist a quota info structure for this</span>
01916         <span class="comment">//  object then calculate what our charge should be from</span>
01917         <span class="comment">//  the information stored in that structure</span>
01918         <span class="comment">//</span>
01919 
01920         <span class="keywordflow">if</span> (QuotaInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01921 
01922             PagedPoolCharge = QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o0">PagedPoolCharge</a> +
01923                               QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o2">SecurityDescriptorCharge</a>;
01924             NonPagedPoolCharge = QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o1">NonPagedPoolCharge</a>;
01925 
01926         } <span class="keywordflow">else</span> {
01927 
01928             <span class="comment">//</span>
01929             <span class="comment">//  There isn't any quota information so we're on our own</span>
01930             <span class="comment">//  Paged pool charge is the default for the object plus</span>
01931             <span class="comment">//  the security descriptor if present.  Nonpaged pool charge</span>
01932             <span class="comment">//  is the default for the object.</span>
01933             <span class="comment">//</span>
01934 
01935             PagedPoolCharge = ObjectType-&gt;TypeInfo.DefaultPagedPoolCharge;
01936 
01937             <span class="keywordflow">if</span> (ObjectHeader-&gt;SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01938 
01939                 ObjectHeader-&gt;Flags |= <a class="code" href="../../d4/d0/ob_8h.html#a6">OB_FLAG_DEFAULT_SECURITY_QUOTA</a>;
01940                 PagedPoolCharge += <a class="code" href="../../d0/d5/se_8h.html#a0">SE_DEFAULT_SECURITY_QUOTA</a>;
01941             }
01942 
01943             NonPagedPoolCharge = ObjectType-&gt;TypeInfo.DefaultNonPagedPoolCharge;
01944         }
01945 
01946         <span class="comment">//</span>
01947         <span class="comment">//  Now charge for the quota and make sure it succeeds</span>
01948         <span class="comment">//</span>
01949 
01950         ObjectHeader-&gt;QuotaBlockCharged = (PVOID)<a class="code" href="../../d0/d2/psquota_8c.html#a0">PsChargeSharedPoolQuota</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
01951                                                                           PagedPoolCharge,
01952                                                                           NonPagedPoolCharge );
01953 
01954         <span class="keywordflow">if</span> (ObjectHeader-&gt;QuotaBlockCharged == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01955 
01956             <span class="keywordflow">return</span> STATUS_QUOTA_EXCEEDED;
01957         }
01958 
01959         *NewObject = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01960     }
01961 
01962     <span class="keywordflow">return</span> STATUS_SUCCESS;
01963 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="obhandle.c::ObpCreateHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpCreateHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d0/ob_8h.html#a21">OB_OPEN_REASON</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenReason</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ExpectedObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG ObjectPointerBias&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryLocked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *ReferencedNewObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">2160</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02695">_HANDLE_TABLE_ENTRY::CreatorBackTraceIndex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00416">EncodeKernelHandle</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01144">ExCreateHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02690">_HANDLE_TABLE_ENTRY::GrantedAccess</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02694">_HANDLE_TABLE_ENTRY::GrantedAccessIndex</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00324">KeStackAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00512">KeUnstackDetachProcess()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02674">_HANDLE_TABLE_ENTRY::ObAttributes</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00408">OBJ_AUDIT_OBJECT_CLOSE</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00289">OBJ_HANDLE_ATTRIBUTES</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">ObpDecrementHandleCount()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00144">ObpDecrPointerCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00213">ObpGetObjectTable</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00143">ObpIncrPointerCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00399">ObpKernelHandleTable</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00202">ObpLeaveRootDirectoryMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d5/se_8h.html#a28">PAUX_ACCESS_DATA</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00258">_AUX_ACCESS_DATA::PrivilegesUsed</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03736">SeAuditHandleCreation()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00650">SePrivilegeObjectAuditAlarm()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00169">_OBJECT_TYPE_INITIALIZER::ValidAccessMask</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00367">ObOpenObjectByPointer()</a>.
<p>
<pre class="fragment"><div>02175                    :
02176 
02177     This function creates a <span class="keyword">new</span> handle to an existing object
02178 
02179 Arguments:
02180 
02181     OpenReason - The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> why we are doing <span class="keyword">this</span> work
02182 
02183     Object - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object
02184 
02185     ExpectedObjectType - Optionally Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> that
02186         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expecting
02187 
02188     AccessState - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access state <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle requested
02189         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
02190 
02191     ObjectPointerBias - Optionally supplies a count of addition
02192         increments we <span class="keywordflow">do</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
02193 
02194     Attributes -  Desired attributes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle
02195 
02196     DirectoryLocked - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root directory mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already held
02197 
02198     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requestor.
02199 
02200     ReferencedNewObject - Optionally receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body
02201         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object
02202 
02203     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle value
02204 
02205 Return Value:
02206 
02207     An appropriate status value
02208 
02209 --*/
02210 
02211 {
02212     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02213     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
02214     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
02215     PVOID ObjectTable;
02216     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a> ObjectTableEntry;
02217     HANDLE NewHandle;
02218     ACCESS_MASK DesiredAccess;
02219     ACCESS_MASK GrantedAccess;
02220     ULONG BiasCount;
02221     BOOLEAN AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02222     BOOLEAN KernelHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02223     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">KAPC_STATE</a> ApcState;
02224 
02225     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02226 
02227     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpCreateHandle"</span> );
02228 
02229     <span class="comment">//</span>
02230     <span class="comment">//  Merge both the remaining desired access and the currently</span>
02231     <span class="comment">//  granted access states into one mask</span>
02232     <span class="comment">//</span>
02233     <span class="comment">//  **** why is this being done here and then later in the this</span>
02234     <span class="comment">//  same routine.</span>
02235     <span class="comment">//</span>
02236 
02237     DesiredAccess = AccessState-&gt;RemainingDesiredAccess |
02238                     AccessState-&gt;PreviouslyGrantedAccess;
02239 
02240     <span class="comment">//</span>
02241     <span class="comment">//  Get a pointer to the object header and object type</span>
02242     <span class="comment">//</span>
02243 
02244     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
02245     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
02246 
02247     <span class="comment">//</span>
02248     <span class="comment">//  If the object type isn't what was expected then</span>
02249     <span class="comment">//  return an error to our caller, but first see if</span>
02250     <span class="comment">//  we should release the directory mutex</span>
02251     <span class="comment">//</span>
02252 
02253     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT( ExpectedObjectType )) &amp;&amp;
02254         (ObjectType != ExpectedObjectType )) {
02255 
02256         <span class="keywordflow">if</span> (DirectoryLocked) {
02257 
02258             <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
02259         }
02260 
02261         <span class="keywordflow">return</span>( STATUS_OBJECT_TYPE_MISMATCH );
02262     }
02263 
02264     <span class="comment">//</span>
02265     <span class="comment">//  Set the first ulong of the object table entry to point</span>
02266     <span class="comment">//  back to the object header</span>
02267     <span class="comment">//</span>
02268 
02269     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = ObjectHeader;
02270 
02271     <span class="comment">//</span>
02272     <span class="comment">//  Now get a pointer to the object table for either the current process</span>
02273     <span class="comment">//  of the kernel handle table</span>
02274     <span class="comment">//</span>
02275 
02276     <span class="keywordflow">if</span> ((Attributes &amp; OBJ_KERNEL_HANDLE) &amp;&amp; (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
02277 
02278         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a>;
02279         KernelHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02280 
02281         <span class="comment">//</span>
02282         <span class="comment">//  Go to the system process if we have to</span>
02283         <span class="comment">//</span>
02284 
02285         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>) {
02286             <a class="code" href="../../d3/d5/procobj_8c.html#a6">KeStackAttachProcess</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>, &amp;ApcState);
02287             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02288         }
02289 
02290 
02291     } <span class="keywordflow">else</span> {
02292 
02293         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
02294     }
02295 
02296     <span class="comment">//</span>
02297     <span class="comment">//  ObpIncrementHandleCount will perform access checking on the</span>
02298     <span class="comment">//  object being opened as appropriate.</span>
02299     <span class="comment">//</span>
02300 
02301     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a77">ObpIncrementHandleCount</a>( OpenReason,
02302                                       <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
02303                                       Object,
02304                                       ObjectType,
02305                                       AccessState,
02306                                       AccessMode,
02307                                       Attributes );
02308 
02309     <span class="keywordflow">if</span> (AccessState-&gt;GenerateOnClose) {
02310 
02311         Attributes |= <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>;
02312     }
02313 
02314     <span class="comment">//</span>
02315     <span class="comment">//  Or in some low order bits into the first ulong of the object</span>
02316     <span class="comment">//  table entry</span>
02317     <span class="comment">//</span>
02318 
02319     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> |= (Attributes &amp; <a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
02320 
02321     <span class="comment">//</span>
02322     <span class="comment">//  Merge both the remaining desired access and the currently</span>
02323     <span class="comment">//  granted access states into one mask and then compute</span>
02324     <span class="comment">//  the granted access</span>
02325     <span class="comment">//</span>
02326 
02327     DesiredAccess = AccessState-&gt;RemainingDesiredAccess |
02328                     AccessState-&gt;PreviouslyGrantedAccess;
02329 
02330     GrantedAccess = DesiredAccess &amp;
02331                     (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> | ACCESS_SYSTEM_SECURITY );
02332 
02333     <span class="comment">//</span>
02334     <span class="comment">//  Unlock the directory if it is locked and make sure</span>
02335     <span class="comment">//  we've been successful so far</span>
02336     <span class="comment">//</span>
02337 
02338     <span class="keywordflow">if</span> (DirectoryLocked) {
02339 
02340         <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
02341     }
02342 
02343     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02344 
02345         <span class="comment">//</span>
02346         <span class="comment">//  If we are attached to the system process then return</span>
02347         <span class="comment">//  back to our caller</span>
02348         <span class="comment">//</span>
02349 
02350         <span class="keywordflow">if</span> (AttachedToProcess) {
02351             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02352             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02353         }
02354 
02355         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02356     }
02357 
02358     <span class="comment">//</span>
02359     <span class="comment">//  Bias the pointer count if that is what the caller wanted</span>
02360     <span class="comment">//</span>
02361 
02362     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) {
02363 
02364         BiasCount = ObjectPointerBias;
02365 
02366         <span class="keywordflow">while</span> (BiasCount--) {
02367 
02368             <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>( ObjectHeader );
02369         }
02370     }
02371 
02372     <span class="comment">//</span>
02373     <span class="comment">//  Set the granted access mask in the object table entry (second ulong)</span>
02374     <span class="comment">//</span>
02375 
02376 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
02377 <span class="preprocessor"></span>
02378     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
02379 
02380         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> = ObpComputeGrantedAccessIndex( GrantedAccess );
02381         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o4">CreatorBackTraceIndex</a> = RtlLogStackBackTrace();
02382 
02383     } <span class="keywordflow">else</span> {
02384 
02385         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = GrantedAccess;
02386     }
02387 
02388 <span class="preprocessor">#else</span>
02389 <span class="preprocessor"></span>
02390     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = GrantedAccess;
02391 
02392 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
02393 <span class="preprocessor"></span>
02394     <span class="comment">//</span>
02395     <span class="comment">//  Add this new object table entry to the object table for the process</span>
02396     <span class="comment">//</span>
02397 
02398     NewHandle = <a class="code" href="../../d5/d8/ex_8h.html#a296">ExCreateHandle</a>( ObjectTable, &amp;ObjectTableEntry );
02399 
02400     <span class="comment">//</span>
02401     <span class="comment">//  If we didn't get a handle then cleanup after ourselves and return</span>
02402     <span class="comment">//  the error to our caller</span>
02403     <span class="comment">//</span>
02404 
02405     <span class="keywordflow">if</span> (NewHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02406 
02407         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) {
02408 
02409             BiasCount = ObjectPointerBias;
02410 
02411             <span class="keywordflow">while</span> (BiasCount--) {
02412 
02413                 <a class="code" href="../../d5/d1/obp_8h.html#a4">ObpDecrPointerCount</a>( ObjectHeader );
02414             }
02415         }
02416 
02417         <a class="code" href="../../d5/d1/obp_8h.html#a78">ObpDecrementHandleCount</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
02418                                  ObjectHeader,
02419                                  ObjectType,
02420                                  GrantedAccess );
02421 
02422         <span class="comment">//</span>
02423         <span class="comment">//  If we are attached to the system process then return</span>
02424         <span class="comment">//  back to our caller</span>
02425         <span class="comment">//</span>
02426 
02427         <span class="keywordflow">if</span> (AttachedToProcess) {
02428             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02429             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02430         }
02431 
02432         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
02433     }
02434 
02435     <span class="comment">//</span>
02436     <span class="comment">//  We have a new Ex style handle now make it an ob style handle and also</span>
02437     <span class="comment">//  adjust for the kernel handle by setting the sign bit in the handle</span>
02438     <span class="comment">//  value</span>
02439     <span class="comment">//</span>
02440 
02441     <span class="keywordflow">if</span> (KernelHandle) {
02442 
02443         NewHandle = <a class="code" href="../../d5/d1/obp_8h.html#a26">EncodeKernelHandle</a>( NewHandle );
02444     }
02445 
02446     *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = NewHandle;
02447 
02448     <span class="comment">//</span>
02449     <span class="comment">//  If requested, generate audit messages to indicate that a new handle</span>
02450     <span class="comment">//  has been allocated.</span>
02451     <span class="comment">//</span>
02452     <span class="comment">//  This is the final security operation in the creation/opening of the</span>
02453     <span class="comment">//  object.</span>
02454     <span class="comment">//</span>
02455 
02456     <span class="keywordflow">if</span> ( AccessState-&gt;GenerateAudit ) {
02457 
02458         <a class="code" href="../../d3/d5/seaudit_8c.html#a28">SeAuditHandleCreation</a>( AccessState,
02459                                *Handle );
02460     }
02461 
02462     <span class="keywordflow">if</span> (OpenReason == <a class="code" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>) {
02463 
02464         <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a> AuxData = AccessState-&gt;AuxData;
02465 
02466         <span class="keywordflow">if</span> ( ( AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>-&gt;PrivilegeCount &gt; 0) ) {
02467 
02468             <a class="code" href="../../d3/d5/seaudit_8c.html#a13">SePrivilegeObjectAuditAlarm</a>( *Handle,
02469                                          &amp;AccessState-&gt;SubjectSecurityContext,
02470                                          GrantedAccess,
02471                                          AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>,
02472                                          TRUE,
02473                                          KeGetPreviousMode() );
02474         }
02475     }
02476 
02477     <span class="comment">//</span>
02478     <span class="comment">//  If the caller had a pointer bias and wanted the new reference object</span>
02479     <span class="comment">//  then return that value</span>
02480     <span class="comment">//</span>
02481 
02482     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) &amp;&amp;
02483         (ARGUMENT_PRESENT( ReferencedNewObject ))) {
02484 
02485         *ReferencedNewObject = Object;
02486     }
02487 
02488     <span class="comment">//</span>
02489     <span class="comment">//  If we are attached to the system process then return</span>
02490     <span class="comment">//  back to our caller</span>
02491     <span class="comment">//</span>
02492 
02493     <span class="keywordflow">if</span> (AttachedToProcess) {
02494         <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02495         AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02496     }
02497 
02498     <span class="comment">//</span>
02499     <span class="comment">//  And return to our caller</span>
02500     <span class="comment">//</span>
02501 
02502     <span class="keywordflow">return</span>( STATUS_SUCCESS );
02503 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="obhandle.c::ObpCreateUnnamedHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpCreateUnnamedHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG ObjectPointerBias&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *ReferencedNewObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">2507</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02695">_HANDLE_TABLE_ENTRY::CreatorBackTraceIndex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00416">EncodeKernelHandle</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01144">ExCreateHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02690">_HANDLE_TABLE_ENTRY::GrantedAccess</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02694">_HANDLE_TABLE_ENTRY::GrantedAccessIndex</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00324">KeStackAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00512">KeUnstackDetachProcess()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02674">_HANDLE_TABLE_ENTRY::ObAttributes</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00289">OBJ_HANDLE_ATTRIBUTES</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">ObpDecrementHandleCount()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00144">ObpDecrPointerCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00213">ObpGetObjectTable</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00143">ObpIncrPointerCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00399">ObpKernelHandleTable</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00169">_OBJECT_TYPE_INITIALIZER::ValidAccessMask</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>.
<p>
<pre class="fragment"><div>02519                    :
02520 
02521     This function creates a <span class="keyword">new</span> unnamed handle <span class="keywordflow">for</span> an existing object
02522 
02523 Arguments:
02524 
02525     Object - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object
02526 
02527     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mask being requsted
02528 
02529     ObjectPointerBias - Optionally supplies a count of addition
02530         increments we <span class="keywordflow">do</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
02531 
02532     Attributes -  Desired attributes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle
02533 
02534     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requestor.
02535 
02536     ReferencedNewObject - Optionally receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body
02537         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object
02538 
02539     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle value
02540 
02541 Return Value:
02542 
02543     An appropriate status value
02544 
02545 --*/
02546 
02547 {
02548     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02549     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
02550     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
02551     PVOID ObjectTable;
02552     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a> ObjectTableEntry;
02553     HANDLE NewHandle;
02554     ULONG BiasCount;
02555     ACCESS_MASK GrantedAccess;
02556     BOOLEAN AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02557     BOOLEAN KernelHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02558     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">KAPC_STATE</a> ApcState;
02559 
02560     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02561 
02562     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpCreateUnnamedHandle"</span> );
02563 
02564     <span class="comment">//</span>
02565     <span class="comment">//  Get the object header and type for the new object</span>
02566     <span class="comment">//</span>
02567 
02568     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
02569     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
02570 
02571     <span class="comment">//</span>
02572     <span class="comment">//  Set the first ulong of the object table entry to point</span>
02573     <span class="comment">//  to the object header and then or in the low order attribute</span>
02574     <span class="comment">//  bits</span>
02575     <span class="comment">//</span>
02576 
02577     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = ObjectHeader;
02578 
02579     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> |= (Attributes &amp; <a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
02580 
02581     <span class="comment">//</span>
02582     <span class="comment">//  Now get a pointer to the object table for either the current process</span>
02583     <span class="comment">//  of the kernel handle table</span>
02584     <span class="comment">//</span>
02585 
02586     <span class="keywordflow">if</span> ((Attributes &amp; OBJ_KERNEL_HANDLE) &amp;&amp; (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
02587 
02588         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a>;
02589         KernelHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02590 
02591         <span class="comment">//</span>
02592         <span class="comment">//  Go to the system process if we have to</span>
02593         <span class="comment">//</span>
02594 
02595         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>) {
02596             <a class="code" href="../../d3/d5/procobj_8c.html#a6">KeStackAttachProcess</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>, &amp;ApcState);
02597             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02598         }
02599 
02600     } <span class="keywordflow">else</span> {
02601 
02602         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
02603     }
02604 
02605     <span class="comment">//</span>
02606     <span class="comment">//  Increment the handle count, this routine also does the access</span>
02607     <span class="comment">//  check if necessary</span>
02608     <span class="comment">//</span>
02609 
02610     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a80">ObpIncrementUnnamedHandleCount</a>( &amp;DesiredAccess,
02611                                              <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
02612                                              Object,
02613                                              ObjectType,
02614                                              AccessMode,
02615                                              Attributes );
02616 
02617 
02618     GrantedAccess = DesiredAccess &amp;
02619                     (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> | ACCESS_SYSTEM_SECURITY );
02620 
02621     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02622 
02623         <span class="comment">//</span>
02624         <span class="comment">//  If we are attached to the system process then return</span>
02625         <span class="comment">//  back to our caller</span>
02626         <span class="comment">//</span>
02627 
02628         <span class="keywordflow">if</span> (AttachedToProcess) {
02629             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02630             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02631         }
02632 
02633         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02634     }
02635 
02636     <span class="comment">//</span>
02637     <span class="comment">//  Bias the pointer count if that is what the caller wanted</span>
02638     <span class="comment">//</span>
02639 
02640     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) {
02641 
02642         BiasCount = ObjectPointerBias;
02643 
02644         <span class="keywordflow">while</span> (BiasCount--) {
02645 
02646             <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>( ObjectHeader );
02647         }
02648     }
02649 
02650     <span class="comment">//</span>
02651     <span class="comment">//  Set the granted access mask in the object table entry (second ulong)</span>
02652     <span class="comment">//</span>
02653 
02654 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
02655 <span class="preprocessor"></span>
02656     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
02657 
02658         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> = ObpComputeGrantedAccessIndex( GrantedAccess );
02659         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o4">CreatorBackTraceIndex</a> = RtlLogStackBackTrace();
02660 
02661     } <span class="keywordflow">else</span> {
02662 
02663         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = GrantedAccess;
02664     }
02665 
02666 <span class="preprocessor">#else</span>
02667 <span class="preprocessor"></span>
02668     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = GrantedAccess;
02669 
02670 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
02671 <span class="preprocessor"></span>
02672     <span class="comment">//</span>
02673     <span class="comment">//  Add this new object table entry to the object table for the process</span>
02674     <span class="comment">//</span>
02675 
02676     NewHandle = <a class="code" href="../../d5/d8/ex_8h.html#a296">ExCreateHandle</a>( ObjectTable, &amp;ObjectTableEntry );
02677 
02678     <span class="comment">//</span>
02679     <span class="comment">//  If we didn't get a handle then cleanup after ourselves and return</span>
02680     <span class="comment">//  the error to our caller</span>
02681     <span class="comment">//</span>
02682 
02683     <span class="keywordflow">if</span> (NewHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02684 
02685         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) {
02686 
02687             BiasCount = ObjectPointerBias;
02688 
02689             <span class="keywordflow">while</span> (BiasCount--) {
02690 
02691                 <a class="code" href="../../d5/d1/obp_8h.html#a4">ObpDecrPointerCount</a>( ObjectHeader );
02692             }
02693         }
02694 
02695         <a class="code" href="../../d5/d1/obp_8h.html#a78">ObpDecrementHandleCount</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
02696                                  ObjectHeader,
02697                                  ObjectType,
02698                                  GrantedAccess );
02699 
02700         <span class="comment">//</span>
02701         <span class="comment">//  If we are attached to the system process then return</span>
02702         <span class="comment">//  back to our caller</span>
02703         <span class="comment">//</span>
02704 
02705         <span class="keywordflow">if</span> (AttachedToProcess) {
02706             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02707             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02708         }
02709 
02710         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
02711     }
02712 
02713     <span class="comment">//</span>
02714     <span class="comment">//  We have a new Ex style handle now make it an ob style handle and also</span>
02715     <span class="comment">//  adjust for the kernel handle by setting the sign bit in the handle</span>
02716     <span class="comment">//  value</span>
02717     <span class="comment">//</span>
02718 
02719     <span class="keywordflow">if</span> (KernelHandle) {
02720 
02721         NewHandle = <a class="code" href="../../d5/d1/obp_8h.html#a26">EncodeKernelHandle</a>( NewHandle );
02722     }
02723 
02724     *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = NewHandle;
02725 
02726     <span class="comment">//</span>
02727     <span class="comment">//  If the caller had a pointer bias and wanted the new reference object</span>
02728     <span class="comment">//  then return that value</span>
02729     <span class="comment">//</span>
02730 
02731     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) &amp;&amp;
02732         (ARGUMENT_PRESENT( ReferencedNewObject ))) {
02733 
02734         *ReferencedNewObject = Object;
02735     }
02736 
02737     <span class="comment">//</span>
02738     <span class="comment">//  If we are attached to the system process then return</span>
02739     <span class="comment">//  back to our caller</span>
02740     <span class="comment">//</span>
02741 
02742     <span class="keywordflow">if</span> (AttachedToProcess) {
02743         <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02744         AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02745     }
02746 
02747     <span class="keywordflow">return</span>( STATUS_SUCCESS );
02748 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="obhandle.c::ObpDecrementHandleCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpDecrementHandleCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">1967</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00313">_OBJECT_HEADER::Body</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00178">_OBJECT_TYPE_INITIALIZER::CloseProcedure</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00261">_OBJECT_HANDLE_COUNT_DATABASE::CountEntries</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00299">_OBJECT_HEADER::HandleCount</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00257">_OBJECT_HANDLE_COUNT_ENTRY::HandleCount</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00325">_OBJECT_HEADER_HANDLE_INFO::HandleCountDataBase</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00262">_OBJECT_HANDLE_COUNT_DATABASE::HandleCountEntries</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00171">_OBJECT_TYPE_INITIALIZER::MaintainHandleCount</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00350">OB_FLAG_EXCLUSIVE_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00353">OB_FLAG_SINGLE_HANDLE_ENTRY</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00371">OBJECT_HEADER_TO_CREATOR_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00365">OBJECT_HEADER_TO_HANDLE_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00362">OBJECT_HEADER_TO_QUOTA_INFO</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00148">ObpDecrHandleCount</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00256">_OBJECT_HANDLE_COUNT_ENTRY::Process</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00326">_OBJECT_HEADER_HANDLE_INFO::SingleEntry</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00193">_OBJECT_TYPE::TotalNumberOfHandles</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00341">_OBJECT_HEADER_CREATOR_INFO::TypeList</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>.
<p>
<pre class="fragment"><div>01976                    :
01977 
01978     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified object
01979 
01980 Arguments:
01981 
01982     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle existed
01983 
01984     ObjectHeader - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object header <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
01985 
01986     ObjectType - Supplies a <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
01987 
01988     GrantedAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current access mask to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
01989 
01990 Return Value:
01991 
01992     None.
01993 
01994 --*/
01995 
01996 {
01997     <a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">POBJECT_HEADER_HANDLE_INFO</a> HandleInfo;
01998     <a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">POBJECT_HANDLE_COUNT_DATABASE</a> HandleCountDataBase;
01999     <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a> HandleCountEntry;
02000     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
02001     PVOID Object;
02002     ULONG CountEntries;
02003     ULONG ProcessHandleCount;
02004     ULONG SystemHandleCount;
02005     BOOLEAN HandleCountIsZero;
02006 
02007     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02008 
02009     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
02010 
02011     Object = (PVOID)&amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a>;
02012 
02013     SystemHandleCount = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a>;
02014     ProcessHandleCount = 0;
02015 
02016     <span class="comment">//</span>
02017     <span class="comment">//  Decrement the handle count and it was one and it</span>
02018     <span class="comment">//  was an exclusive object then zero out the exclusive</span>
02019     <span class="comment">//  process</span>
02020     <span class="comment">//</span>
02021 
02022     HandleCountIsZero = <a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
02023             
02024     <span class="keywordflow">if</span> ( HandleCountIsZero &amp;&amp;
02025         (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>)) {
02026 
02027         <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>( ObjectHeader )-&gt;ExclusiveProcess = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02028     }
02029     
02030     <span class="keywordflow">if</span> ( HandleCountIsZero ) {
02031     
02032         CreatorInfo = <a class="code" href="../../d4/d0/ob_8h.html#a13">OBJECT_HEADER_TO_CREATOR_INFO</a>( ObjectHeader );
02033     
02034         <span class="comment">//</span>
02035         <span class="comment">//  If there is a creator info record and we are on the list</span>
02036         <span class="comment">//  for the object type then remove this object from the list</span>
02037         <span class="comment">//</span>
02038 
02039         <span class="keywordflow">if</span> (CreatorInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !IsListEmpty( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> )) {
02040                         
02041             RemoveEntryList( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
02042             
02043             InitializeListHead( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
02044         }
02045     }
02046 
02047     <span class="comment">//</span>
02048     <span class="comment">//  If the object maintains a handle count database then</span>
02049     <span class="comment">//  search through the handle database and decrement</span>
02050     <span class="comment">//  the necessary information</span>
02051     <span class="comment">//</span>
02052 
02053     <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) {
02054 
02055         HandleInfo = <a class="code" href="../../d4/d0/ob_8h.html#a11">OBJECT_HEADER_TO_HANDLE_INFO</a>( ObjectHeader );
02056 
02057         <span class="comment">//</span>
02058         <span class="comment">//  Check if there is a single handle entry, then it better</span>
02059         <span class="comment">//  be ours</span>
02060         <span class="comment">//</span>
02061 
02062         <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>) {
02063 
02064             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> == Process);
02065             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> &gt; 0);
02066 
02067             ProcessHandleCount = HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a>--;
02068             HandleCountEntry = &amp;HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>;
02069 
02070         } <span class="keywordflow">else</span> {
02071 
02072             <span class="comment">//</span>
02073             <span class="comment">//  Otherwise search the database for a process match</span>
02074             <span class="comment">//</span>
02075 
02076             HandleCountDataBase = HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a>;
02077 
02078             <span class="keywordflow">if</span> (HandleCountDataBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02079 
02080                 CountEntries = HandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o0">CountEntries</a>;
02081                 HandleCountEntry = &amp;HandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o1">HandleCountEntries</a>[ 0 ];
02082 
02083                 <span class="keywordflow">while</span> (CountEntries) {
02084 
02085                     <span class="keywordflow">if</span> ((HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> != 0) &amp;&amp;
02086                         (HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> == Process)) {
02087 
02088                         ProcessHandleCount = HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a>--;
02089 
02090                         <span class="keywordflow">break</span>;
02091                     }
02092 
02093                     HandleCountEntry++;
02094                     CountEntries--;
02095                 }
02096             }
02097         }
02098 
02099         <span class="comment">//</span>
02100         <span class="comment">//  Now if the process is giving up all handles to the object</span>
02101         <span class="comment">//  then zero out the handle count entry.  For a single handle</span>
02102         <span class="comment">//  entry this is just the single entry in the header handle info</span>
02103         <span class="comment">//  structure</span>
02104         <span class="comment">//</span>
02105 
02106         <span class="keywordflow">if</span> (ProcessHandleCount == 1) {
02107 
02108             HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02109             HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> = 0;
02110         }
02111     }
02112 
02113     <span class="comment">//</span>
02114     <span class="comment">//  If the Object Type has a Close Procedure, then release the type</span>
02115     <span class="comment">//  mutex before calling it, and then call ObpDeleteNameCheck without</span>
02116     <span class="comment">//  the mutex held.</span>
02117     <span class="comment">//</span>
02118 
02119     <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a>) {
02120 
02121         KIRQL SaveIrql;
02122 
02123         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
02124 
02125         <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
02126 
02127         (*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a>)( Process,
02128                                                 Object,
02129                                                 GrantedAccess,
02130                                                 ProcessHandleCount,
02131                                                 SystemHandleCount );
02132 
02133         <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Close"</span>, ObjectType, Object );
02134 
02135         <a class="code" href="../../d7/d1/obref_8c.html#a11">ObpDeleteNameCheck</a>( Object, FALSE );
02136 
02137     } <span class="keywordflow">else</span> {
02138 
02139         <span class="comment">//</span>
02140         <span class="comment">//  If there is no Close Procedure, then just call ObpDeleteNameCheck</span>
02141         <span class="comment">//  with the mutex held.</span>
02142         <span class="comment">//</span>
02143         <span class="comment">//  The following call will release the type mutex</span>
02144         <span class="comment">//</span>
02145 
02146         <a class="code" href="../../d7/d1/obref_8c.html#a11">ObpDeleteNameCheck</a>( Object, TRUE );
02147     }
02148 
02149     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
02150     
02151     ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> -= 1;
02152         
02153     <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
02154 
02155     <span class="keywordflow">return</span>;
02156 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="obhandle.c::ObpIncrementHandleCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpIncrementHandleCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d0/ob_8h.html#a21">OB_OPEN_REASON</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenReason</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">1232</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00178">_OBJECT_TYPE_INITIALIZER::CloseProcedure</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00027">GENERIC_ACCESS</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00299">_OBJECT_HEADER::HandleCount</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00195">_OBJECT_TYPE::HighWaterNumberOfHandles</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00171">_OBJECT_TYPE_INITIALIZER::MaintainHandleCount</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00350">OB_FLAG_EXCLUSIVE_OBJECT</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00392">ObCheckObjectAccess()</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a60">ObDuplicateHandle</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00371">OBJECT_HEADER_TO_CREATOR_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00358">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00362">OBJECT_HEADER_TO_QUOTA_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01861">ObpChargeQuotaForObject()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00148">ObpDecrHandleCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01058">ObpIncrementHandleDataBase()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00147">ObpIncrHandleCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00177">_OBJECT_TYPE_INITIALIZER::OpenProcedure</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03381">RtlMapGenericMask()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00434">SeAppendPrivileges()</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00158">SePrivilegeCheck()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00989">SePrivilegedServiceAuditAlarm()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01676">SeSecurityPrivilege</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00193">_OBJECT_TYPE::TotalNumberOfHandles</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00188">_OBJECT_TYPE::TypeList</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00341">_OBJECT_HEADER_CREATOR_INFO::TypeList</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00658">ObDupHandleProcedure()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>.
<p>
<pre class="fragment"><div>01244                    :
01245 
01246     Increments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count of number of handles to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given object.
01247 
01248     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being opened or created, access validation and
01249     auditing will be performed as appropriate.
01250 
01251 Arguments:
01252 
01253     OpenReason - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being incremented.
01254 
01255     Process - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle will reside.
01256 
01257     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01258 
01259     ObjectType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01260 
01261     AccessState - Optional parameter supplying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current accumulated
01262         security information describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attempt to access <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01263 
01264     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requestor.
01265 
01266     Attributes - Desired attributes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle
01267 
01268 Return Value:
01269 
01270     An appropriate status value
01271 
01272 --*/
01273 
01274 {
01275     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01276     ULONG ProcessHandleCount;
01277     BOOLEAN ExclusiveHandle;
01278     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
01279     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
01280     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01281     BOOLEAN HasPrivilege = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01282     PRIVILEGE_SET Privileges;
01283     BOOLEAN NewObject;
01284     BOOLEAN HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01285 
01286     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01287 
01288     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpIncrementHandleCount"</span> );
01289 
01290     <span class="comment">//</span>
01291     <span class="comment">//  Get a pointer to the object header</span>
01292     <span class="comment">//</span>
01293 
01294     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01295 
01296     <span class="comment">//</span>
01297     <span class="comment">//  Charge the user quota for the object</span>
01298     <span class="comment">//</span>
01299 
01300     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a82">ObpChargeQuotaForObject</a>( ObjectHeader, ObjectType, &amp;NewObject );
01301 
01302     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01303 
01304         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01305     }
01306 
01307     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01308     HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01309 
01310     <span class="keywordflow">try</span> {
01311 
01312         ExclusiveHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01313 
01314         <span class="comment">//</span>
01315         <span class="comment">//  Check if the caller wants exlusive access and if so then</span>
01316         <span class="comment">//  make sure the attributes and header flags match up correctly</span>
01317         <span class="comment">//</span>
01318 
01319         <span class="keywordflow">if</span> (Attributes &amp; OBJ_EXCLUSIVE) {
01320 
01321             <span class="keywordflow">if</span> ((Attributes &amp; OBJ_INHERIT) ||
01322                 ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>) == 0)) {
01323 
01324                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01325                 leave;
01326             }
01327 
01328             <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01329                  (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> != 0))
01330 
01331                     ||
01332 
01333                 ((<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01334                  (<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()))) {
01335 
01336                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01337                 leave;
01338             }
01339 
01340             ExclusiveHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01341 
01342         <span class="comment">//</span>
01343         <span class="comment">//  The user doesn't want exclusive access so now check to make sure</span>
01344         <span class="comment">//  the attriutes and header flags match up correctly</span>
01345         <span class="comment">//</span>
01346 
01347         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>) &amp;&amp;
01348                    (<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01349 
01350             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01351             leave;
01352         }
01353 
01354         <span class="comment">//</span>
01355         <span class="comment">//  If handle count going from zero to one for an existing object that</span>
01356         <span class="comment">//  maintains a handle count database, but does not have an open procedure</span>
01357         <span class="comment">//  just a close procedure, then fail the call as they are trying to</span>
01358         <span class="comment">//  reopen an object by pointer and the close procedure will not know</span>
01359         <span class="comment">//  that the object has been 'recreated'</span>
01360         <span class="comment">//</span>
01361 
01362         <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> == 0) &amp;&amp;
01363             (!NewObject) &amp;&amp;
01364             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) &amp;&amp;
01365             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01366             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01367 
01368             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01369             leave;
01370         }
01371 
01372         <span class="keywordflow">if</span> ((OpenReason == <a class="code" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>) ||
01373             ((OpenReason == <a class="code" href="../../d4/d0/ob_8h.html#a100a60">ObDuplicateHandle</a>) &amp;&amp; ARGUMENT_PRESENT(AccessState))) {
01374 
01375             <span class="comment">//</span>
01376             <span class="comment">//  Perform Access Validation to see if we can open this</span>
01377             <span class="comment">//  (already existing) object.</span>
01378             <span class="comment">//</span>
01379             
01380             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d1/obse_8c.html#a3">ObCheckObjectAccess</a>( Object,
01381                                       AccessState,
01382                                       TRUE,
01383                                       AccessMode,
01384                                       &amp;Status )) {
01385 
01386                 leave;
01387             }
01388             
01389         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((OpenReason == <a class="code" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>)) {
01390 
01391             <span class="comment">//</span>
01392             <span class="comment">//  We are creating a new instance of this object type.</span>
01393             <span class="comment">//  A total of three audit messages may be generated:</span>
01394             <span class="comment">//</span>
01395             <span class="comment">//  1 - Audit the attempt to create an instance of this</span>
01396             <span class="comment">//      object type.</span>
01397             <span class="comment">//</span>
01398             <span class="comment">//  2 - Audit the successful creation.</span>
01399             <span class="comment">//</span>
01400             <span class="comment">//  3 - Audit the allocation of the handle.</span>
01401             <span class="comment">//</span>
01402 
01403             <span class="comment">//</span>
01404             <span class="comment">//  At this point, the RemainingDesiredAccess field in</span>
01405             <span class="comment">//  the AccessState may still contain either Generic access</span>
01406             <span class="comment">//  types, or MAXIMUM_ALLOWED.  We will map the generics</span>
01407             <span class="comment">//  and substitute GenericAll for MAXIMUM_ALLOWED.</span>
01408             <span class="comment">//</span>
01409 
01410             <span class="keywordflow">if</span> ( AccessState-&gt;RemainingDesiredAccess &amp; MAXIMUM_ALLOWED ) {
01411 
01412                 AccessState-&gt;RemainingDesiredAccess &amp;= ~MAXIMUM_ALLOWED;
01413                 AccessState-&gt;RemainingDesiredAccess |= GENERIC_ALL;
01414             }
01415 
01416             <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d0/obhandle_8c.html#a0">GENERIC_ACCESS</a> &amp; AccessState-&gt;RemainingDesiredAccess) != 0) {
01417 
01418                 <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>( &amp;AccessState-&gt;RemainingDesiredAccess,
01419                                    &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
01420             }
01421 
01422             <span class="comment">//</span>
01423             <span class="comment">//  Since we are creating the object, we can give any access the caller</span>
01424             <span class="comment">//  wants.  The only exception is ACCESS_SYSTEM_SECURITY, which requires</span>
01425             <span class="comment">//  a privilege.</span>
01426             <span class="comment">//</span>
01427 
01428             <span class="keywordflow">if</span> ( AccessState-&gt;RemainingDesiredAccess &amp; ACCESS_SYSTEM_SECURITY ) {
01429 
01430                 <span class="comment">//</span>
01431                 <span class="comment">//  We could use SeSinglePrivilegeCheck here, but it</span>
01432                 <span class="comment">//  captures the subject context again, and we don't</span>
01433                 <span class="comment">//  want to do that in this path for performance reasons.</span>
01434                 <span class="comment">//</span>
01435 
01436                 Privileges.PrivilegeCount = 1;
01437                 Privileges.Control = PRIVILEGE_SET_ALL_NECESSARY;
01438                 Privileges.Privilege[0].Luid = <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a>;
01439                 Privileges.Privilege[0].Attributes = 0;
01440 
01441                 HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a1">SePrivilegeCheck</a>( &amp;Privileges,
01442                                                  &amp;AccessState-&gt;SubjectSecurityContext,
01443                                                  KeGetPreviousMode() );
01444 
01445                 <span class="keywordflow">if</span> (!HasPrivilege) {
01446 
01447                     <a class="code" href="../../d3/d5/seaudit_8c.html#a15">SePrivilegedServiceAuditAlarm</a> ( NULL,
01448                                                     &amp;AccessState-&gt;SubjectSecurityContext,
01449                                                     &amp;Privileges,
01450                                                     FALSE );
01451 
01452                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
01453                     leave;
01454                 }
01455 
01456                 AccessState-&gt;RemainingDesiredAccess &amp;= ~ACCESS_SYSTEM_SECURITY;
01457                 AccessState-&gt;PreviouslyGrantedAccess |= ACCESS_SYSTEM_SECURITY;
01458 
01459                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState,
01460                                            &amp;Privileges );
01461             }
01462 
01463             <span class="comment">//</span>
01464             <span class="comment">//  Get the objects creator info block and insert it on the</span>
01465             <span class="comment">//  global list of objects for that type</span>
01466             <span class="comment">//</span>
01467 
01468             CreatorInfo = <a class="code" href="../../d4/d0/ob_8h.html#a13">OBJECT_HEADER_TO_CREATOR_INFO</a>( ObjectHeader );
01469 
01470             <span class="keywordflow">if</span> (CreatorInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01471 
01472                 InsertTailList( &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o1">TypeList</a>, &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
01473             }
01474         }
01475 
01476         <span class="keywordflow">if</span> (ExclusiveHandle) {
01477 
01478             <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>(ObjectHeader)-&gt;ExclusiveProcess = Process;
01479         }
01480 
01481         <a class="code" href="../../d5/d1/obp_8h.html#a6">ObpIncrHandleCount</a>( ObjectHeader );
01482         ProcessHandleCount = 0;
01483 
01484         <span class="comment">//</span>
01485         <span class="comment">//  If the object type wants us to keep try of the handle counts</span>
01486         <span class="comment">//  then call our routine to do the work</span>
01487         <span class="comment">//</span>
01488 
01489         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) {
01490 
01491             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a2">ObpIncrementHandleDataBase</a>( ObjectHeader,
01492                                                  Process,
01493                                                  &amp;ProcessHandleCount );
01494 
01495             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01496                 <span class="comment">// BUG BUG, We probably need more backout than this, NeillC</span>
01497                 <a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
01498 
01499                 leave;
01500             }
01501         }
01502 
01503         <span class="comment">//</span>
01504         <span class="comment">//  Set our preliminary status now to success because</span>
01505         <span class="comment">//  the call to the open procedure might change this</span>
01506         <span class="comment">//</span>
01507 
01508         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01509 
01510         <span class="comment">//</span>
01511         <span class="comment">//  If the object type has an open procedure</span>
01512         <span class="comment">//  then invoke that procedure</span>
01513         <span class="comment">//</span>
01514 
01515         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01516 
01517             KIRQL SaveIrql;
01518 
01519             <span class="comment">//</span>
01520             <span class="comment">//  Leave the object type mutex when call the OpenProcedure. If an exception</span>
01521             <span class="comment">//  while OpenProcedure the HoldObjectTypeMutex disable leaving the mutex</span>
01522             <span class="comment">//  on finally block</span>
01523             <span class="comment">//</span>
01524 
01525             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01526             HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01527 
01528             <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01529 
01530             <span class="keywordflow">try</span> {
01531 
01532                 (*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a>)( OpenReason,
01533                                                        Process,
01534                                                        Object,
01535                                                        AccessState ?
01536                                                            AccessState-&gt;PreviouslyGrantedAccess :
01537                                                            0,
01538                                                        ProcessHandleCount );
01539 
01540             } except( EXCEPTION_EXECUTE_HANDLER ) {
01541 
01542                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01543             }
01544 
01545             <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Open"</span>, ObjectType, Object );
01546 
01547             <span class="comment">//</span>
01548             <span class="comment">//  Hold back the object type mutex and set the HoldObjectTypeMutex variable</span>
01549             <span class="comment">//  to allow releasing the mutex while leaving this procedure</span>
01550             <span class="comment">//</span>
01551 
01552             <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01553             HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01554 
01555             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01556 
01557                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
01558                 leave;
01559             }
01560         }
01561 
01562         <span class="comment">//</span>
01563         <span class="comment">//  Do some simple bookkeeping for the handle counts</span>
01564         <span class="comment">//  and then return to our caller</span>
01565         <span class="comment">//</span>
01566 
01567         ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> += 1;
01568 
01569         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> &gt; ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o8">HighWaterNumberOfHandles</a>) {
01570 
01571             ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o8">HighWaterNumberOfHandles</a> = ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a>;
01572         }
01573 
01574     } finally {
01575 
01576         <span class="keywordflow">if</span> ( HoldObjectTypeMutex ) {
01577 
01578             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01579         }
01580     }
01581 
01582     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01583 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="obhandle.c::ObpIncrementHandleDataBase" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpIncrementHandleDataBase           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProcessHandleCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01058">1058</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00261">_OBJECT_HANDLE_COUNT_DATABASE::CountEntries</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00257">_OBJECT_HANDLE_COUNT_ENTRY::HandleCount</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00325">_OBJECT_HEADER_HANDLE_INFO::HandleCountDataBase</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00262">_OBJECT_HANDLE_COUNT_DATABASE::HandleCountEntries</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00353">OB_FLAG_SINGLE_HANDLE_ENTRY</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00365">OBJECT_HEADER_TO_HANDLE_INFO</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00908">ObpInsertHandleCount()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00256">_OBJECT_HANDLE_COUNT_ENTRY::Process</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00326">_OBJECT_HEADER_HANDLE_INFO::SingleEntry</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>.
<p>
<pre class="fragment"><div>01066                    :
01067 
01068     This function increments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle count database associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01069     specified object <span class="keywordflow">for</span> a specified process.
01070 
01071 Arguments:
01072 
01073     ObjectHeader - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01074 
01075     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose handle count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
01076         updated.
01077 
01078     NewProcessHandleCount - Supplies a pointer to a variable that receives
01079         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.
01080 
01081 Return Value:
01082 
01083     An appropriate status value
01084 
01085 --*/
01086 
01087 {
01088     <a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">POBJECT_HEADER_HANDLE_INFO</a> HandleInfo;
01089     <a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">POBJECT_HANDLE_COUNT_DATABASE</a> HandleCountDataBase;
01090     <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a> HandleCountEntry;
01091     <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a> FreeHandleCountEntry;
01092     ULONG CountEntries;
01093     ULONG ProcessHandleCount;
01094 
01095     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01096 
01097     <span class="comment">//</span>
01098     <span class="comment">//  Translate the object header to the handle information.</span>
01099     <span class="comment">//</span>
01100 
01101     HandleInfo = <a class="code" href="../../d4/d0/ob_8h.html#a11">OBJECT_HEADER_TO_HANDLE_INFO</a>(ObjectHeader);
01102 
01103     <span class="comment">//</span>
01104     <span class="comment">//  Check if the object has space for only a single handle</span>
01105     <span class="comment">//</span>
01106 
01107     <span class="keywordflow">if</span> (ObjectHeader-&gt;Flags &amp; <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>) {
01108 
01109         <span class="comment">//</span>
01110         <span class="comment">//  If the single handle isn't in use then set the entry</span>
01111         <span class="comment">//  and tell the caller there is only one handle</span>
01112         <span class="comment">//</span>
01113 
01114         <span class="keywordflow">if</span> (HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> == 0) {
01115 
01116             *NewProcessHandleCount = 1;
01117             HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> = 1;
01118             HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> = Process;
01119 
01120             <span class="keywordflow">return</span> STATUS_SUCCESS;
01121 
01122         <span class="comment">//</span>
01123         <span class="comment">//  If the single entry is for the same process as specified</span>
01124         <span class="comment">//  then increment the count and we're done</span>
01125         <span class="comment">//</span>
01126 
01127         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> == Process) {
01128 
01129             *NewProcessHandleCount = ++HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a>;
01130 
01131             <span class="keywordflow">return</span> STATUS_SUCCESS;
01132 
01133         <span class="comment">//</span>
01134         <span class="comment">//  Finally we have a object with a single handle entry already</span>
01135         <span class="comment">//  in use, so we need to grow the handle database before</span>
01136         <span class="comment">//  we can set this new value</span>
01137         <span class="comment">//</span>
01138 
01139         } <span class="keywordflow">else</span> {
01140 
01141             FreeHandleCountEntry = <a class="code" href="../../d5/d1/obp_8h.html#a76">ObpInsertHandleCount</a>( ObjectHeader );
01142 
01143             <span class="keywordflow">if</span> (FreeHandleCountEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01144 
01145                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01146             }
01147 
01148             FreeHandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> = Process;
01149             FreeHandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> = 1;
01150             *NewProcessHandleCount = 1;
01151 
01152             <span class="keywordflow">return</span> STATUS_SUCCESS;
01153         }
01154     }
01155 
01156     <span class="comment">//</span>
01157     <span class="comment">//  The object does not contain a single entry, therefore we're</span>
01158     <span class="comment">//  assuming it already has a handle count database</span>
01159     <span class="comment">//</span>
01160 
01161     <span class="comment">//</span>
01162     <span class="comment">//  **** HandleInfo should first be checked for null</span>
01163     <span class="comment">//</span>
01164 
01165     HandleCountDataBase = HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a>;
01166 
01167     FreeHandleCountEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01168 
01169     <span class="comment">//</span>
01170     <span class="comment">//  **** can we with success if the database is null</span>
01171     <span class="comment">//</span>
01172 
01173     <span class="keywordflow">if</span> (HandleCountDataBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01174 
01175         <span class="comment">//</span>
01176         <span class="comment">//  Get the number of entries and a pointer to the first one</span>
01177         <span class="comment">//  in the handle database</span>
01178         <span class="comment">//</span>
01179 
01180         CountEntries = HandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o0">CountEntries</a>;
01181         HandleCountEntry = &amp;HandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o1">HandleCountEntries</a>[ 0 ];
01182 
01183         <span class="comment">//</span>
01184         <span class="comment">//  For each entry in the handle database check for a process</span>
01185         <span class="comment">//  match and if so then increment the handle count and return</span>
01186         <span class="comment">//  to our caller.  Otherwise if the entry is free then remember</span>
01187         <span class="comment">//  it so we can store to it later</span>
01188         <span class="comment">//</span>
01189 
01190         <span class="keywordflow">while</span> (CountEntries) {
01191 
01192             <span class="keywordflow">if</span> (HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> == Process) {
01193 
01194                 *NewProcessHandleCount = ++HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a>;
01195 
01196                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01197 
01198             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> == 0) {
01199 
01200                 FreeHandleCountEntry = HandleCountEntry;
01201             }
01202 
01203             ++HandleCountEntry;
01204             --CountEntries;
01205         }
01206 
01207         <span class="comment">//</span>
01208         <span class="comment">//  If we did not find a free handle entry then we have to grow the</span>
01209         <span class="comment">//  handle database before we can set this new value</span>
01210         <span class="comment">//</span>
01211 
01212         <span class="keywordflow">if</span> (FreeHandleCountEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01213 
01214             FreeHandleCountEntry = <a class="code" href="../../d5/d1/obp_8h.html#a76">ObpInsertHandleCount</a>( ObjectHeader );
01215 
01216             <span class="keywordflow">if</span> (FreeHandleCountEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01217 
01218                 <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
01219             }
01220         }
01221 
01222         FreeHandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> = Process;
01223         FreeHandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> = 1;
01224         *NewProcessHandleCount = 1;
01225     }
01226 
01227     <span class="keywordflow">return</span> STATUS_SUCCESS;
01228 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="obhandle.c::ObpIncrementUnnamedHandleCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpIncrementUnnamedHandleCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">1587</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00178">_OBJECT_TYPE_INITIALIZER::CloseProcedure</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00027">GENERIC_ACCESS</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00299">_OBJECT_HEADER::HandleCount</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00195">_OBJECT_TYPE::HighWaterNumberOfHandles</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00171">_OBJECT_TYPE_INITIALIZER::MaintainHandleCount</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00350">OB_FLAG_EXCLUSIVE_OBJECT</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00371">OBJECT_HEADER_TO_CREATOR_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00358">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00362">OBJECT_HEADER_TO_QUOTA_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01861">ObpChargeQuotaForObject()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00148">ObpDecrHandleCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01058">ObpIncrementHandleDataBase()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00147">ObpIncrHandleCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00177">_OBJECT_TYPE_INITIALIZER::OpenProcedure</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03381">RtlMapGenericMask()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00193">_OBJECT_TYPE::TotalNumberOfHandles</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00188">_OBJECT_TYPE::TypeList</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00341">_OBJECT_HEADER_CREATOR_INFO::TypeList</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>.
<p>
<pre class="fragment"><div>01598                    :
01599 
01600     Increments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count of number of handles to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given object.
01601 
01602 Arguments:
01603 
01604     Desired Access - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object and receives
01605         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> assign access mask
01606 
01607     Process - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle will reside.
01608 
01609     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01610 
01611     ObjectType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01612 
01613     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requestor.
01614 
01615     Attributes - Desired attributes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle
01616 
01617 Return Value:
01618 
01619     An appropriate status value
01620 
01621 --*/
01622 
01623 {
01624     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01625     BOOLEAN ExclusiveHandle;
01626     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
01627     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
01628     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01629     BOOLEAN NewObject;
01630     ULONG ProcessHandleCount;
01631     BOOLEAN HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01632 
01633     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01634 
01635     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpIncrementUnnamedHandleCount"</span> );
01636 
01637     <span class="comment">//</span>
01638     <span class="comment">//  Get a pointer to the object header</span>
01639     <span class="comment">//</span>
01640 
01641     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01642 
01643     <span class="comment">//</span>
01644     <span class="comment">//  Charge the user quota for the object</span>
01645     <span class="comment">//</span>
01646 
01647     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a82">ObpChargeQuotaForObject</a>( ObjectHeader, ObjectType, &amp;NewObject );
01648 
01649     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01650 
01651         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01652     }
01653 
01654     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01655     HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01656 
01657     <span class="keywordflow">try</span> {
01658 
01659         ExclusiveHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01660 
01661         <span class="comment">//</span>
01662         <span class="comment">//  Check if the caller wants exlusive access and if so then</span>
01663         <span class="comment">//  make sure the attributes and header flags match up correctly</span>
01664         <span class="comment">//</span>
01665 
01666         <span class="keywordflow">if</span> (Attributes &amp; OBJ_EXCLUSIVE) {
01667 
01668             <span class="keywordflow">if</span> ((Attributes &amp; OBJ_INHERIT) ||
01669                 ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>) == 0)) {
01670 
01671                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01672                 leave;
01673             }
01674 
01675             <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01676                  (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> != 0))
01677 
01678                         ||
01679 
01680                 ((<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01681                  (<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()))) {
01682 
01683                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01684                 leave;
01685             }
01686 
01687             ExclusiveHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01688 
01689         <span class="comment">//</span>
01690         <span class="comment">//  The user doesn't want exclusive access so now check to make sure</span>
01691         <span class="comment">//  the attriutes and header flags match up correctly</span>
01692         <span class="comment">//</span>
01693 
01694         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>) &amp;&amp;
01695                    (<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01696 
01697             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01698             leave;
01699         }
01700 
01701         <span class="comment">//</span>
01702         <span class="comment">//  If handle count going from zero to one for an existing object that</span>
01703         <span class="comment">//  maintains a handle count database, but does not have an open procedure</span>
01704         <span class="comment">//  just a close procedure, then fail the call as they are trying to</span>
01705         <span class="comment">//  reopen an object by pointer and the close procedure will not know</span>
01706         <span class="comment">//  that the object has been 'recreated'</span>
01707         <span class="comment">//</span>
01708 
01709         <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> == 0) &amp;&amp;
01710             (!NewObject) &amp;&amp;
01711             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) &amp;&amp;
01712             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01713             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01714 
01715             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01716 
01717             leave;
01718         }
01719 
01720         <span class="comment">//</span>
01721         <span class="comment">//  If the user asked for the maximum allowed then remove the bit and</span>
01722         <span class="comment">//  or in generic all access</span>
01723         <span class="comment">//</span>
01724 
01725         <span class="keywordflow">if</span> ( *DesiredAccess &amp; MAXIMUM_ALLOWED ) {
01726 
01727             *DesiredAccess &amp;= ~MAXIMUM_ALLOWED;
01728             *DesiredAccess |= GENERIC_ALL;
01729         }
01730 
01731         <span class="comment">//  If the user asked for any generic bit then translate it to</span>
01732         <span class="comment">//  someone more appropriate for the object type</span>
01733         <span class="comment">//</span>
01734 
01735         <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d0/obhandle_8c.html#a0">GENERIC_ACCESS</a> &amp; *DesiredAccess) != 0) {
01736 
01737             <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>( DesiredAccess,
01738                                &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
01739         }
01740 
01741         <span class="comment">//</span>
01742         <span class="comment">//  Get a pointer to the creator info block for the object and insert</span>
01743         <span class="comment">//  it on the global list of object for that type</span>
01744         <span class="comment">//</span>
01745 
01746         CreatorInfo = <a class="code" href="../../d4/d0/ob_8h.html#a13">OBJECT_HEADER_TO_CREATOR_INFO</a>( ObjectHeader );
01747 
01748         <span class="keywordflow">if</span> (CreatorInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01749 
01750             InsertTailList( &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o1">TypeList</a>, &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
01751         }
01752 
01753         <span class="keywordflow">if</span> (ExclusiveHandle) {
01754 
01755             <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>(ObjectHeader)-&gt;ExclusiveProcess = Process;
01756         }
01757 
01758         <a class="code" href="../../d5/d1/obp_8h.html#a6">ObpIncrHandleCount</a>( ObjectHeader );
01759         ProcessHandleCount = 0;
01760 
01761         <span class="comment">//</span>
01762         <span class="comment">//  If the object type wants us to keep try of the handle counts</span>
01763         <span class="comment">//  then call our routine to do the work</span>
01764         <span class="comment">//</span>
01765 
01766         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) {
01767 
01768             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a2">ObpIncrementHandleDataBase</a>( ObjectHeader,
01769                                                  Process,
01770                                                  &amp;ProcessHandleCount );
01771 
01772             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01773                 <span class="comment">// BUG BUG, We probably need more backout than this, NeillC</span>
01774                 <a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
01775                 leave;
01776             }
01777         }
01778 
01779         <span class="comment">//</span>
01780         <span class="comment">//  Set our preliminary status now to success because</span>
01781         <span class="comment">//  the call to the open procedure might change this</span>
01782         <span class="comment">//</span>
01783 
01784         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01785 
01786         <span class="comment">//</span>
01787         <span class="comment">//  If the object type has an open procedure</span>
01788         <span class="comment">//  then invoke that procedure</span>
01789         <span class="comment">//</span>
01790 
01791         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01792 
01793             KIRQL SaveIrql;
01794 
01795             <span class="comment">//</span>
01796             <span class="comment">//  Leave the object type mutex when call the OpenProcedure. If an exception</span>
01797             <span class="comment">//  while OpenProcedure the HoldObjectTypeMutex disable leaving the mutex</span>
01798             <span class="comment">//  on finally block</span>
01799             <span class="comment">//</span>
01800 
01801             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01802             HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01803 
01804             <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01805 
01806             <span class="keywordflow">try</span> {
01807 
01808                 (*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a>)( <a class="code" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>,
01809                                                        Process,
01810                                                        Object,
01811                                                        *DesiredAccess,
01812                                                        ProcessHandleCount );
01813 
01814             } except( EXCEPTION_EXECUTE_HANDLER ) {
01815 
01816                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01817             }
01818 
01819             <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Open"</span>, ObjectType, Object );
01820 
01821             <span class="comment">//</span>
01822             <span class="comment">//  Hold back the object type mutex and set the HoldObjectTypeMutex variable</span>
01823             <span class="comment">//  to allow releasing the mutex while leaving this procedure</span>
01824             <span class="comment">//</span>
01825 
01826             <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01827             HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01828 
01829             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01830 
01831                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
01832                 leave;
01833             }
01834         }
01835 
01836         <span class="comment">//</span>
01837         <span class="comment">//  Do some simple bookkeeping for the handle counts</span>
01838         <span class="comment">//  and then return to our caller</span>
01839         <span class="comment">//</span>
01840 
01841         ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> += 1;
01842 
01843         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> &gt; ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o8">HighWaterNumberOfHandles</a>) {
01844 
01845             ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o8">HighWaterNumberOfHandles</a> = ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a>;
01846         }
01847 
01848     } finally {
01849 
01850         <span class="keywordflow">if</span> ( HoldObjectTypeMutex ) {
01851 
01852             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01853         }
01854     }
01855 
01856     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01857 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="obhandle.c::ObpInsertHandleCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a> ObpInsertHandleCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ObjectHeader</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00908">908</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00261">_OBJECT_HANDLE_COUNT_DATABASE::CountEntries</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00325">_OBJECT_HEADER_HANDLE_INFO::HandleCountDataBase</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00262">_OBJECT_HANDLE_COUNT_DATABASE::HandleCountEntries</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00353">OB_FLAG_SINGLE_HANDLE_ENTRY</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00365">OBJECT_HEADER_TO_HANDLE_INFO</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00326">_OBJECT_HEADER_HANDLE_INFO::SingleEntry</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01058">ObpIncrementHandleDataBase()</a>.
<p>
<pre class="fragment"><div>00914                    :
00915 
00916     This function will increase <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle database
00917     stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle information of an object header.  If
00918     necessary <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will allocate <span class="keyword">new</span> and free old handle databases.
00919 
00920     This routine should not be called <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already free
00921     space in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table.
00922 
00923 Arguments:
00924 
00925     ObjectHeader - The object whose handle count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being incremented
00926 
00927 Return Value:
00928 
00929     The pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next free handle count entry within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00930     handle database.
00931 
00932 --*/
00933 
00934 {
00935     <a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">POBJECT_HEADER_HANDLE_INFO</a> HandleInfo;
00936     <a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">POBJECT_HANDLE_COUNT_DATABASE</a> OldHandleCountDataBase;
00937     <a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">POBJECT_HANDLE_COUNT_DATABASE</a> NewHandleCountDataBase;
00938     <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a> FreeHandleCountEntry;
00939     ULONG CountEntries;
00940     ULONG OldSize;
00941     ULONG NewSize;
00942     <a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">OBJECT_HANDLE_COUNT_DATABASE</a> SingleEntryDataBase;
00943 
00944     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00945 
00946     <span class="comment">//</span>
00947     <span class="comment">//  Check if the object has any handle information</span>
00948     <span class="comment">//</span>
00949 
00950     HandleInfo = <a class="code" href="../../d4/d0/ob_8h.html#a11">OBJECT_HEADER_TO_HANDLE_INFO</a>(ObjectHeader);
00951 
00952     <span class="keywordflow">if</span> (HandleInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00953 
00954         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00955     }
00956 
00957     <span class="comment">//</span>
00958     <span class="comment">//  The object does have some handle information.  If it has</span>
00959     <span class="comment">//  a single handle entry then we'll construct a local dummy</span>
00960     <span class="comment">//  handle count database and come up with a new data base for</span>
00961     <span class="comment">//  storing two entries.</span>
00962     <span class="comment">//</span>
00963 
00964     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>) {
00965 
00966         SingleEntryDataBase.<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o0">CountEntries</a> = 1;
00967         SingleEntryDataBase.<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o1">HandleCountEntries</a>[0] = HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>;
00968 
00969         OldHandleCountDataBase = &amp;SingleEntryDataBase;
00970 
00971         OldSize = <span class="keyword">sizeof</span>( SingleEntryDataBase );
00972 
00973         CountEntries = 2;
00974 
00975         NewSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">OBJECT_HANDLE_COUNT_DATABASE</a>) +
00976                ((CountEntries - 1) * <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">OBJECT_HANDLE_COUNT_ENTRY</a> ));
00977 
00978     } <span class="keywordflow">else</span> {
00979 
00980         <span class="comment">//</span>
00981         <span class="comment">//  The object already has multiple handles so we reference the</span>
00982         <span class="comment">//  current handle database, and compute a new size bumped by four</span>
00983         <span class="comment">//</span>
00984 
00985         OldHandleCountDataBase = HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a>;
00986 
00987         CountEntries = OldHandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o0">CountEntries</a>;
00988 
00989         OldSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">OBJECT_HANDLE_COUNT_DATABASE</a>) +
00990                ((CountEntries - 1) * <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">OBJECT_HANDLE_COUNT_ENTRY</a>));
00991 
00992         CountEntries += 4;
00993 
00994         NewSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">OBJECT_HANDLE_COUNT_DATABASE</a>) +
00995                ((CountEntries - 1) * <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">OBJECT_HANDLE_COUNT_ENTRY</a>));
00996     }
00997 
00998     <span class="comment">//</span>
00999     <span class="comment">//  Now allocate pool for the new handle database.</span>
01000     <span class="comment">//</span>
01001 
01002     NewHandleCountDataBase = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool, NewSize,'dHbO');
01003 
01004     <span class="keywordflow">if</span> (NewHandleCountDataBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01005 
01006         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01007     }
01008 
01009     <span class="comment">//</span>
01010     <span class="comment">//  Copy over the old database.  Note that this might just copy our</span>
01011     <span class="comment">//  local dummy entry for the single entry case</span>
01012     <span class="comment">//</span>
01013 
01014     RtlMoveMemory(NewHandleCountDataBase, OldHandleCountDataBase, OldSize);
01015 
01016     <span class="comment">//</span>
01017     <span class="comment">//  If the previous mode was a single entry then remove that</span>
01018     <span class="comment">//  indication otherwise free up with previous handle database</span>
01019     <span class="comment">//</span>
01020 
01021     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>) {
01022 
01023         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp;= ~<a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>;
01024 
01025     } <span class="keywordflow">else</span> {
01026 
01027         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( OldHandleCountDataBase );
01028     }
01029 
01030     <span class="comment">//</span>
01031     <span class="comment">//  Find the end of the new database that is used and zero out</span>
01032     <span class="comment">//  the memory</span>
01033     <span class="comment">//</span>
01034 
01035     FreeHandleCountEntry =
01036         (<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a>)((PCHAR)NewHandleCountDataBase + OldSize);
01037 
01038     RtlZeroMemory(FreeHandleCountEntry, NewSize - OldSize);
01039 
01040     <span class="comment">//</span>
01041     <span class="comment">//  Set the new database to the proper entry count and put it</span>
01042     <span class="comment">//  all in the object</span>
01043     <span class="comment">//</span>
01044 
01045     NewHandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o0">CountEntries</a> = CountEntries;
01046 
01047     HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a> = NewHandleCountDataBase;
01048 
01049     <span class="comment">//</span>
01050     <span class="comment">//  And return to our caller</span>
01051     <span class="comment">//</span>
01052 
01053     <span class="keywordflow">return</span> FreeHandleCountEntry;
01054 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="obhandle.c::ObpValidateDesiredAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpValidateDesiredAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ACCESS_MASK&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DesiredAccess</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02752">2752</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>.
<p>
<pre class="fragment"><div>02758                    :
02759 
02760     This routine checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input desired access mask to see that
02761     some invalid bits are not set.  The invalid bits are <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top
02762     two reserved bits and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top three standard rights bits.
02763     See \nt\<span class="keyword">public</span>\sdk\inc\ntseapi.h <span class="keywordflow">for</span> more details.
02764 
02765 Arguments:
02766 
02767     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mask being checked
02768 
02769 Return Value:
02770 
02771     STATUS_ACCESS_DENIED <span class="keywordflow">if</span> one or more of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wrongs bits are set and
02772     STATUS_SUCCESS otherwise
02773 
02774 --*/
02775 
02776 {
02777     <span class="keywordflow">if</span> (DesiredAccess &amp; 0x0CE00000) {
02778 
02779         <span class="keywordflow">return</span>( STATUS_ACCESS_DENIED );
02780 
02781     } <span class="keywordflow">else</span> {
02782 
02783         <span class="keywordflow">return</span>( STATUS_SUCCESS );
02784     }
02785 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="obhandle.c::ObpInitKillMutant" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d7/struct__KMUTANT.html">KMUTANT</a> <a class="el" href="../../d9/d1/psquery_8c.html#a3">ObpInitKillMutant</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00034">34</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00531">NtQueryInformationProcess()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01234">ObFindHandleForObject()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00815">ObInitProcess()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, and <a class="el" href="../../d1/d0/obinit_8c-source.html#l01022">ObKillProcess()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:58 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
