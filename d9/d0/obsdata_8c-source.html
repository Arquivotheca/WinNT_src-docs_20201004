<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obsdata.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obsdata.c</h1><a href="../../d8/d1/obsdata_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    obsdata.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Object Manager Security Descriptor Caching</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Robert Reichel  (robertre)  12-Oct-1993</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d5/d1/obp_8h.html">obp.h</a>"</span>
00022 
00023 
00024 <span class="preprocessor">#if DBG</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#define OB_DIAGNOSTICS_ENABLED 1</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#endif // DBG</span>
00027 <span class="preprocessor"></span>
00028 <span class="comment">//</span>
00029 <span class="comment">//  These definitions are useful diagnostics aids</span>
00030 <span class="comment">//</span>
00031 
00032 <span class="preprocessor">#if OB_DIAGNOSTICS_ENABLED</span>
00033 <span class="preprocessor"></span>
00034 ULONG ObsDebugFlags = 0;
00035 
00036 <span class="comment">//</span>
00037 <span class="comment">//  Test for enabled diagnostic</span>
00038 <span class="comment">//</span>
00039 
00040 <span class="preprocessor">#define IF_OB_GLOBAL( FlagName ) if (ObsDebugFlags &amp; (OBS_DEBUG_##FlagName))</span>
00041 <span class="preprocessor"></span>
00042 <span class="comment">//</span>
00043 <span class="comment">//  Diagnostics print statement</span>
00044 <span class="comment">//</span>
00045 
00046 <span class="preprocessor">#define ObPrint( FlagName, _Text_ ) IF_OB_GLOBAL( FlagName ) DbgPrint _Text_</span>
00047 <span class="preprocessor"></span>
00048 <span class="preprocessor">#else</span>
00049 <span class="preprocessor"></span>
00050 <span class="comment">//</span>
00051 <span class="comment">//  diagnostics not enabled - No diagnostics included in build</span>
00052 <span class="comment">//</span>
00053 
00054 <span class="comment">//</span>
00055 <span class="comment">//  Test for diagnostics enabled</span>
00056 <span class="comment">//</span>
00057 
<a name="l00058"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a0">00058</a> <span class="preprocessor">#define IF_OB_GLOBAL( FlagName ) if (FALSE)</span>
00059 <span class="preprocessor"></span>
00060 <span class="comment">//</span>
00061 <span class="comment">//  Diagnostics print statement (expands to no-op)</span>
00062 <span class="comment">//</span>
00063 
<a name="l00064"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a1">00064</a> <span class="preprocessor">#define ObPrint( FlagName, _Text_ )     ;</span>
00065 <span class="preprocessor"></span>
00066 <span class="preprocessor">#endif // OB_DIAGNOSTICS_ENABLED</span>
00067 <span class="preprocessor"></span>
00068 
00069 <span class="preprocessor">#if OB_DIAGNOSTICS_ENABLED</span>
00070 <span class="preprocessor"></span>
00071 ULONG ObsTotalCacheEntries = 0;
00072 
00073 <span class="preprocessor">#endif</span>
00074 <span class="preprocessor"></span>
00075 <span class="comment">//</span>
00076 <span class="comment">//  The following flags enable or disable various diagnostic</span>
00077 <span class="comment">//  capabilities within OB code.  These flags are set in</span>
00078 <span class="comment">//  ObGlobalFlag (only available within a DBG system).</span>
00079 <span class="comment">//</span>
00080 <span class="comment">//</span>
00081 
<a name="l00082"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a2">00082</a> <span class="preprocessor">#define OBS_DEBUG_ALLOC_TRACKING          ((ULONG) 0x00000001L)</span>
<a name="l00083"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a3">00083</a> <span class="preprocessor"></span><span class="preprocessor">#define OBS_DEBUG_CACHE_FREES             ((ULONG) 0x00000002L)</span>
<a name="l00084"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a4">00084</a> <span class="preprocessor"></span><span class="preprocessor">#define OBS_DEBUG_BREAK_ON_INIT           ((ULONG) 0x00000004L)</span>
<a name="l00085"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a5">00085</a> <span class="preprocessor"></span><span class="preprocessor">#define OBS_DEBUG_SHOW_COLLISIONS         ((ULONG) 0x00000008L)</span>
<a name="l00086"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a6">00086</a> <span class="preprocessor"></span><span class="preprocessor">#define OBS_DEBUG_SHOW_STATISTICS         ((ULONG) 0x00000010L)</span>
<a name="l00087"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a7">00087</a> <span class="preprocessor"></span><span class="preprocessor">#define OBS_DEBUG_SHOW_REFERENCES         ((ULONG) 0x00000020L)</span>
<a name="l00088"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a8">00088</a> <span class="preprocessor"></span><span class="preprocessor">#define OBS_DEBUG_SHOW_DEASSIGN           ((ULONG) 0x00000040L)</span>
<a name="l00089"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a9">00089</a> <span class="preprocessor"></span><span class="preprocessor">#define OBS_DEBUG_STOP_INVALID_DESCRIPTOR ((ULONG) 0x00000080L)</span>
<a name="l00090"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a10">00090</a> <span class="preprocessor"></span><span class="preprocessor">#define OBS_DEBUG_SHOW_HEADER_FREE        ((ULONG) 0x00000100L)</span>
00091 <span class="preprocessor"></span>
00092 <span class="comment">//</span>
00093 <span class="comment">//  Array of pointers to security descriptor entries</span>
00094 <span class="comment">//</span>
00095 
<a name="l00096"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a11">00096</a> PLIST_ENTRY *<a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00097 
00098 
00099 <span class="comment">//</span>
00100 <span class="comment">//  Resource used to protect the security descriptor cache</span>
00101 <span class="comment">//</span>
00102 
<a name="l00103"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a12">00103</a> <a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="code" href="../../d8/d1/obsdata_8c.html#a12">ObsSecurityDescriptorCacheLock</a>;
00104 
00105 <span class="preprocessor">#if defined (ALLOC_PRAGMA)</span>
00106 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpDereferenceSecurityDescriptor)</span>
00107 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpDestroySecurityDescriptorHeader)</span>
00108 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpHashBuffer)</span>
00109 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpHashSecurityDescriptor)</span>
00110 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpInitSecurityDescriptorCache)</span>
00111 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpLogSecurityDescriptor)</span>
00112 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpReferenceSecurityDescriptor)</span>
00113 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpCreateCacheEntry)</span>
00114 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00115 <span class="preprocessor"></span>
00116 
00117 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00118"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a13">00118</a> <a class="code" href="../../d8/d1/obsdata_8c.html#a13">ObpInitSecurityDescriptorCache</a> (
00119     VOID
00120     )
00121 
00122 <span class="comment">/*++</span>
00123 <span class="comment"></span>
00124 <span class="comment">Routine Description:</span>
00125 <span class="comment"></span>
00126 <span class="comment">    Allocates and initializes the globalSecurity Descriptor Cache</span>
00127 <span class="comment"></span>
00128 <span class="comment">Arguments:</span>
00129 <span class="comment"></span>
00130 <span class="comment">    None</span>
00131 <span class="comment"></span>
00132 <span class="comment">Return Value:</span>
00133 <span class="comment"></span>
00134 <span class="comment">    STATUS_SUCCESS on success, NTSTATUS on failure.</span>
00135 <span class="comment"></span>
00136 <span class="comment">--*/</span>
00137 
00138 {
00139     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00140     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00141 
00142     <a class="code" href="../../d8/d1/obsdata_8c.html#a0">IF_OB_GLOBAL</a>( BREAK_ON_INIT ) {
00143 
00144         DbgBreakPoint();
00145     }
00146 
00147     <span class="comment">//</span>
00148     <span class="comment">//  Allocate the cache of pointers and zero it out</span>
00149     <span class="comment">//</span>
00150 
00151     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d5/d1/obp_8h.html#a22">SECURITY_DESCRIPTOR_CACHE_ENTRIES</a> * <span class="keyword">sizeof</span>(PLIST_ENTRY);
00152     <a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, 'cCdS' );
00153 
00154     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00155 
00156         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00157     }
00158 
00159     RtlZeroMemory( <a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
00160 
00161     <span class="comment">//</span>
00162     <span class="comment">//  Initialize the resource used to protect the security cache</span>
00163     <span class="comment">//</span>
00164 
00165     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a> ( &amp;<a class="code" href="../../d8/d1/obsdata_8c.html#a12">ObsSecurityDescriptorCacheLock</a> );
00166 
00167     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00168 
00169         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a> );
00170         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00171     }
00172 
00173     <span class="comment">//</span>
00174     <span class="comment">//  And return to our caller</span>
00175     <span class="comment">//</span>
00176 
00177     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00178 }
00179 
00180 
00181 ULONG
<a name="l00182"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a14">00182</a> <a class="code" href="../../d8/d1/obsdata_8c.html#a14">ObpHashSecurityDescriptor</a> (
00183     PSECURITY_DESCRIPTOR SecurityDescriptor
00184     )
00185 
00186 <span class="comment">/*++</span>
00187 <span class="comment"></span>
00188 <span class="comment">Routine Description:</span>
00189 <span class="comment"></span>
00190 <span class="comment">    Hashes a security descriptor to a 32 bit value</span>
00191 <span class="comment"></span>
00192 <span class="comment">Arguments:</span>
00193 <span class="comment"></span>
00194 <span class="comment">    SecurityDescriptor - Provides the security descriptor to be hashed</span>
00195 <span class="comment"></span>
00196 <span class="comment">Return Value:</span>
00197 <span class="comment"></span>
00198 <span class="comment">    ULONG - a 32 bit hash value.</span>
00199 <span class="comment"></span>
00200 <span class="comment">--*/</span>
00201 
00202 {
00203     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00204     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00205 
00206     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
00207     PACL Sacl;
00208 
00209     ULONG Hash = 0;
00210     BOOLEAN Junk;
00211     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00212     BOOLEAN DaclPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00213     BOOLEAN SaclPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00214     PISECURITY_DESCRIPTOR sd;
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">//  Cast the actually opaque security descriptor into something</span>
00218     <span class="comment">//  that we can decipher</span>
00219     <span class="comment">//</span>
00220 
00221     sd = (PISECURITY_DESCRIPTOR)SecurityDescriptor;
00222 
00223     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a65">RtlGetOwnerSecurityDescriptor</a>( sd, &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>, &amp;Junk );
00224     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a67">RtlGetGroupSecurityDescriptor</a>( sd, &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a>, &amp;Junk );
00225     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a61">RtlGetDaclSecurityDescriptor</a>( sd, &amp;DaclPresent, &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>, &amp;Junk );
00226     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a63">RtlGetSaclSecurityDescriptor</a>( sd, &amp;SaclPresent, &amp;Sacl, &amp;Junk );
00227 
00228     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00229 
00230         Hash = <a class="code" href="../../d8/d1/obsdata_8c.html#a15">ObpHashBuffer</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>, <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> ));
00231     }
00232 
00233     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00234 
00235         Hash += <a class="code" href="../../d8/d1/obsdata_8c.html#a15">ObpHashBuffer</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a>, <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a>));
00236     }
00237 
00238     <span class="keywordflow">if</span> ( DaclPresent &amp;&amp; (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00239 
00240         Hash += <a class="code" href="../../d8/d1/obsdata_8c.html#a15">ObpHashBuffer</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>, <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AclSize);
00241     }
00242 
00243     <span class="keywordflow">if</span> ( SaclPresent &amp;&amp; (Sacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00244 
00245         Hash += <a class="code" href="../../d8/d1/obsdata_8c.html#a15">ObpHashBuffer</a>( Sacl, Sacl-&gt;AclSize);
00246     }
00247 
00248     <span class="keywordflow">return</span>( Hash );
00249 }
00250 
00251 
00252 ULONG
<a name="l00253"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a15">00253</a> <a class="code" href="../../d8/d1/obsdata_8c.html#a15">ObpHashBuffer</a> (
00254     PVOID Data,
00255     ULONG Length
00256     )
00257 
00258 <span class="comment">/*++</span>
00259 <span class="comment"></span>
00260 <span class="comment">Routine Description:</span>
00261 <span class="comment"></span>
00262 <span class="comment">    Hashes a buffer into a 32 bit value</span>
00263 <span class="comment"></span>
00264 <span class="comment">Arguments:</span>
00265 <span class="comment"></span>
00266 <span class="comment">    Data - Buffer containing the data to be hashed.</span>
00267 <span class="comment"></span>
00268 <span class="comment">    Length - The length in bytes of the buffer</span>
00269 <span class="comment"></span>
00270 <span class="comment"></span>
00271 <span class="comment">Return Value:</span>
00272 <span class="comment"></span>
00273 <span class="comment">    ULONG - a 32 bit hash value.</span>
00274 <span class="comment"></span>
00275 <span class="comment">--*/</span>
00276 
00277 {
00278     PCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00279     ULONG Result = 0;
00280     LONG i;
00281 
00282     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PCHAR)Data;
00283 
00284     <span class="keywordflow">for</span> (i = 0; i &lt;= (LONG)((Length-3)-<span class="keyword">sizeof</span>(ULONG)); i++) {
00285 
00286         ULONG Tmp;
00287 
00288         Tmp = *((ULONG UNALIGNED *)(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + i));
00289         Result += Tmp;
00290     }
00291 
00292     <span class="keywordflow">return</span>( Result );
00293 }
00294 
00295 
00296 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00297"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a16">00297</a> <a class="code" href="../../d8/d1/obsdata_8c.html#a16">ObpLogSecurityDescriptor</a> (
00298     IN PSECURITY_DESCRIPTOR InputSecurityDescriptor,
00299     OUT PSECURITY_DESCRIPTOR *OutputSecurityDescriptor
00300     )
00301 
00302 <span class="comment">/*++</span>
00303 <span class="comment"></span>
00304 <span class="comment">Routine Description:</span>
00305 <span class="comment"></span>
00306 <span class="comment">    Takes a passed security descriptor and registers it into the</span>
00307 <span class="comment">    security descriptor database.</span>
00308 <span class="comment"></span>
00309 <span class="comment">Arguments:</span>
00310 <span class="comment"></span>
00311 <span class="comment">    InputSecurityDescriptor - The new security descriptor to be logged into</span>
00312 <span class="comment">        the database. On a successful return this memory will have been</span>
00313 <span class="comment">        freed back to pool.</span>
00314 <span class="comment"></span>
00315 <span class="comment">    OutputSecurityDescriptor - Output security descriptor to be used by the</span>
00316 <span class="comment">        caller.</span>
00317 <span class="comment"></span>
00318 <span class="comment">Return Value:</span>
00319 <span class="comment"></span>
00320 <span class="comment">    An appropriate status value</span>
00321 <span class="comment"></span>
00322 <span class="comment">--*/</span>
00323 
00324 {
00325     ULONG FullHash;
00326     UCHAR  SmallHash;
00327     <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a> NewDescriptor;
00328     PLIST_ENTRY Front;
00329     PLIST_ENTRY Back;
00330     <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00331     BOOLEAN Match;
00332 
00333     FullHash = <a class="code" href="../../d8/d1/obsdata_8c.html#a14">ObpHashSecurityDescriptor</a>( InputSecurityDescriptor );
00334     SmallHash = (UCHAR)FullHash;
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">//  See if the entry matching SmallHash is in use.</span>
00338     <span class="comment">//  Lock the table first, unlock if if we don't need it.</span>
00339     <span class="comment">//</span>
00340 
00341     <a class="code" href="../../d8/d1/obsdata_8c.html#a23">ObpAcquireDescriptorCacheWriteLock</a>();
00342 
00343     Front = <a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a>[SmallHash];
00344     Back  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00345     Match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00346 
00347     <span class="comment">//</span>
00348     <span class="comment">//  Zoom down the hash bucket looking for a full hash match</span>
00349     <span class="comment">//</span>
00350 
00351     <span class="keywordflow">while</span> ( Front != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00352 
00353         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = <a class="code" href="../../d5/d1/obp_8h.html#a19">LINK_TO_SD_HEADER</a>( Front );
00354 
00355         <span class="comment">//</span>
00356         <span class="comment">//  **** is this test really right?  Is the full hash value really</span>
00357         <span class="comment">//  ordered like this?</span>
00358         <span class="comment">//</span>
00359 
00360         <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FullHash &gt; FullHash ) {
00361 
00362             <span class="keywordflow">break</span>;
00363         }
00364 
00365         <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FullHash == FullHash ) {
00366 
00367             Match = <a class="code" href="../../d8/d1/obsdata_8c.html#a22">ObpCompareSecurityDescriptors</a>( InputSecurityDescriptor,
00368                                                    &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;SecurityDescriptor );
00369 
00370             <span class="keywordflow">if</span> ( Match ) {
00371 
00372                 <span class="keywordflow">break</span>;
00373             }
00374 
00375             <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_COLLISIONS,(<span class="stringliteral">"Got a collision on %d, no match\n"</span>,SmallHash));
00376         }
00377 
00378         Back = Front;
00379         Front = Front-&gt;Flink;
00380     }
00381 
00382     <span class="comment">//</span>
00383     <span class="comment">//  If we have a match then we'll get the caller to use the old</span>
00384     <span class="comment">//  cached descriptor, but bumping its ref count, freeing what</span>
00385     <span class="comment">//  the caller supplied and returning the old one to our caller</span>
00386     <span class="comment">//</span>
00387 
00388     <span class="keywordflow">if</span> ( Match ) {
00389 
00390         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;RefCount++;
00391 
00392         <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_REFERENCES, (<span class="stringliteral">"Reference Hash = 0x%lX, New RefCount = %d\n"</span>,<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FullHash,<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;RefCount));
00393 
00394         *OutputSecurityDescriptor = &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;SecurityDescriptor;
00395 
00396         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( InputSecurityDescriptor );
00397 
00398         <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
00399 
00400         <span class="keywordflow">return</span>( STATUS_SUCCESS );
00401     }
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">//  Can't use an existing one, create a new entry</span>
00405     <span class="comment">//  and insert it into the list.</span>
00406     <span class="comment">//</span>
00407 
00408     NewDescriptor = <a class="code" href="../../d8/d1/obsdata_8c.html#a17">ObpCreateCacheEntry</a>( InputSecurityDescriptor,
00409                                          FullHash );
00410 
00411     <span class="keywordflow">if</span> ( NewDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00412 
00413         <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
00414 
00415         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00416     }
00417 
00418 <span class="preprocessor">#if OB_DIAGNOSTICS_ENABLED</span>
00419 <span class="preprocessor"></span>
00420     ObsTotalCacheEntries++;
00421 
00422 <span class="preprocessor">#endif</span>
00423 <span class="preprocessor"></span>
00424     <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_STATISTICS, (<span class="stringliteral">"ObsTotalCacheEntries = %d \n"</span>,ObsTotalCacheEntries));
00425     <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_COLLISIONS, (<span class="stringliteral">"Adding new entry for index #%d \n"</span>,SmallHash));
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">//  We don't need the old security descriptor any more.</span>
00429     <span class="comment">//</span>
00430 
00431     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( InputSecurityDescriptor );
00432 
00433     <span class="comment">//</span>
00434     <span class="comment">//  The following logic inserts the new security descriptor into the</span>
00435     <span class="comment">//  small hash list.  We need to first decide if the we're adding</span>
00436     <span class="comment">//  the entry to the beginning of the list (back is null) or if we're</span>
00437     <span class="comment">//  further in the list.</span>
00438     <span class="comment">//</span>
00439     <span class="comment">//  **** This logic is plain bizzare because (1) the small hash</span>
00440     <span class="comment">//  should probably just be an array of list heads and not single</span>
00441     <span class="comment">//  pointer value and (2) the doubly linked list of security descriptors</span>
00442     <span class="comment">//  is not circular!  This should be fixed to use the regular set</span>
00443     <span class="comment">//  of link list macros</span>
00444     <span class="comment">//</span>
00445 
00446     <span class="keywordflow">if</span> ( Back == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00447 
00448         <span class="comment">//</span>
00449         <span class="comment">//  We're inserting at the beginning of the list for this</span>
00450         <span class="comment">//  minor index</span>
00451         <span class="comment">//</span>
00452 
00453         NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>.Flink = <a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a>[SmallHash];
00454         <a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a>[SmallHash] = &amp;NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>;
00455 
00456         <span class="keywordflow">if</span> ( NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00457 
00458             NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>.Flink-&gt;Blink = &amp;NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>;
00459         }
00460 
00461     } <span class="keywordflow">else</span> {
00462 
00463         <span class="comment">//</span>
00464         <span class="comment">//  Hook new descriptor entry into list.</span>
00465         <span class="comment">//</span>
00466 
00467         NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>.Flink = Front;
00468 
00469         NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>.Blink = Back;
00470 
00471         Back-&gt;Flink = &amp;NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>;
00472 
00473         <span class="keywordflow">if</span> (Front != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00474 
00475             Front-&gt;Blink = &amp;NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>;
00476         }
00477     }
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">//  Set the output security descriptor and return to our caller</span>
00481     <span class="comment">//</span>
00482 
00483     *OutputSecurityDescriptor = &amp;NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o3">SecurityDescriptor</a>;
00484     <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
00485 
00486     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00487 }
00488 
00489 
00490 <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a>
<a name="l00491"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a17">00491</a> <a class="code" href="../../d8/d1/obsdata_8c.html#a17">ObpCreateCacheEntry</a> (
00492     PSECURITY_DESCRIPTOR InputSecurityDescriptor,
00493     ULONG FullHash
00494     )
00495 
00496 <span class="comment">/*++</span>
00497 <span class="comment"></span>
00498 <span class="comment">Routine Description:</span>
00499 <span class="comment"></span>
00500 <span class="comment">    Allocates and initializes a new cache entry.</span>
00501 <span class="comment"></span>
00502 <span class="comment">Arguments:</span>
00503 <span class="comment"></span>
00504 <span class="comment">    InputSecurityDescriptor - The security descriptor to be cached.</span>
00505 <span class="comment"></span>
00506 <span class="comment">    FullHash - Full 32 bit hash of the security descriptor.</span>
00507 <span class="comment"></span>
00508 <span class="comment">Return Value:</span>
00509 <span class="comment"></span>
00510 <span class="comment">    A pointer to the newly allocated cache entry, or NULL</span>
00511 <span class="comment"></span>
00512 <span class="comment">--*/</span>
00513 
00514 {
00515 
00516     ULONG SecurityDescriptorLength;
00517     ULONG CacheEntrySize;
00518     <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a> NewDescriptor;
00519 
00520     <span class="comment">//</span>
00521     <span class="comment">//  Compute the size that we'll need to allocate.  We need space for</span>
00522     <span class="comment">//  the security descriptor cache minus the funny quad at the end and the</span>
00523     <span class="comment">//  security descriptor itself.</span>
00524     <span class="comment">//</span>
00525 
00526     SecurityDescriptorLength = <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a> ( InputSecurityDescriptor );
00527     CacheEntrySize = SecurityDescriptorLength + (<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">SECURITY_DESCRIPTOR_HEADER</a>) - <span class="keyword">sizeof</span>( QUAD ));
00528 
00529     <span class="comment">//</span>
00530     <span class="comment">//  Now allocate space for the cached entry</span>
00531     <span class="comment">//</span>
00532 
00533     NewDescriptor = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, CacheEntrySize, 'dSeS');
00534 
00535     <span class="keywordflow">if</span> ( NewDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00536 
00537         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00538     }
00539 
00540     <span class="comment">//</span>
00541     <span class="comment">//  Fill the header, copy over the descriptor data, and return to our</span>
00542     <span class="comment">//  caller</span>
00543     <span class="comment">//</span>
00544 
00545     NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o1">RefCount</a>   = 1;
00546     NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o2">FullHash</a>   = FullHash;
00547     NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00548     NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00549 
00550     RtlCopyMemory( &amp;NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o3">SecurityDescriptor</a>,
00551                    InputSecurityDescriptor,
00552                    SecurityDescriptorLength );
00553 
00554     <span class="keywordflow">return</span>( NewDescriptor );
00555 }
00556 
00557 
00558 PSECURITY_DESCRIPTOR
<a name="l00559"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a18">00559</a> <a class="code" href="../../d8/d1/obsdata_8c.html#a18">ObpReferenceSecurityDescriptor</a> (
00560     PVOID  Object
00561     )
00562 
00563 <span class="comment">/*++</span>
00564 <span class="comment"></span>
00565 <span class="comment">Routine Description:</span>
00566 <span class="comment"></span>
00567 <span class="comment">    References the security descriptor of the passed object.</span>
00568 <span class="comment"></span>
00569 <span class="comment">Arguments:</span>
00570 <span class="comment"></span>
00571 <span class="comment">    Object - Object being access validated.</span>
00572 <span class="comment"></span>
00573 <span class="comment">Return Value:</span>
00574 <span class="comment"></span>
00575 <span class="comment">    The security descriptor of the object.</span>
00576 <span class="comment"></span>
00577 <span class="comment">--*/</span>
00578 
00579 {
00580     <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a> SecurityDescriptorHeader;
00581     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00582     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00583     PSECURITY_DESCRIPTOR SecurityDescriptor;
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">//  Make sure the sure that the object in question is being</span>
00587     <span class="comment">//  maintained by the system and doesn't have it own security</span>
00588     <span class="comment">//  management routines.</span>
00589     <span class="comment">//</span>
00590     <span class="comment">//  **** the first two lines should probably be only done on</span>
00591     <span class="comment">//  a checked build</span>
00592     <span class="comment">//</span>
00593 
00594     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00595     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00596     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d1/obp_8h.html#a13">ObpCentralizedSecurity</a>(ObjectType) );
00597 
00598     <span class="comment">//</span>
00599     <span class="comment">//  Lock the security descriptor cache and get the objects</span>
00600     <span class="comment">//  security descriptor</span>
00601     <span class="comment">//</span>
00602 
00603     <a class="code" href="../../d8/d1/obsdata_8c.html#a23">ObpAcquireDescriptorCacheWriteLock</a>();
00604 
00605     SecurityDescriptor = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object )-&gt;SecurityDescriptor;
00606 
00607     <a class="code" href="../../d8/d1/obsdata_8c.html#a0">IF_OB_GLOBAL</a>( STOP_INVALID_DESCRIPTOR ) {
00608 
00609         <span class="keywordflow">if</span>((SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00610            (!<a class="code" href="../../d8/d6/sertl_8c.html#a55">RtlValidSecurityDescriptor</a> ( SecurityDescriptor ))) {
00611 
00612             DbgBreakPoint();
00613         }
00614     }
00615 
00616     <span class="comment">//</span>
00617     <span class="comment">//  If the object has a security descriptor then we need to</span>
00618     <span class="comment">//  get the security descriptor header and increment its</span>
00619     <span class="comment">//  ref count before releasing the lock and returning to</span>
00620     <span class="comment">//  our caller</span>
00621     <span class="comment">//</span>
00622 
00623     <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00624 
00625         SecurityDescriptorHeader = <a class="code" href="../../d5/d1/obp_8h.html#a18">SD_TO_SD_HEADER</a>( SecurityDescriptor );
00626         <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_REFERENCES, (<span class="stringliteral">"Referencing Hash %lX, Refcount = %d \n"</span>,SecurityDescriptorHeader-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o2">FullHash</a>,SecurityDescriptorHeader-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o1">RefCount</a>));
00627         SecurityDescriptorHeader-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o1">RefCount</a>++;
00628     }
00629 
00630     <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
00631 
00632     <span class="keywordflow">return</span>( SecurityDescriptor );
00633 }
00634 
00635 
00636 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00637"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a19">00637</a> <a class="code" href="../../d8/d1/obsdata_8c.html#a19">ObDeassignSecurity</a> (
00638     IN OUT PSECURITY_DESCRIPTOR *SecurityDescriptor
00639     )
00640 
00641 <span class="comment">/*++</span>
00642 <span class="comment"></span>
00643 <span class="comment">Routine Description:</span>
00644 <span class="comment"></span>
00645 <span class="comment">    This routine dereferences the input security descriptor</span>
00646 <span class="comment"></span>
00647 <span class="comment">Arguments:</span>
00648 <span class="comment"></span>
00649 <span class="comment">    SecurityDescriptor - Supplies the security descriptor</span>
00650 <span class="comment">        being modified</span>
00651 <span class="comment"></span>
00652 <span class="comment">Return Value:</span>
00653 <span class="comment"></span>
00654 <span class="comment">    Only returns STATUS_SUCCESS</span>
00655 <span class="comment"></span>
00656 <span class="comment">--*/</span>
00657 
00658 {
00659     <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">//  Lock the security descriptor cache and get a pointer</span>
00663     <span class="comment">//  to the security descriptor header</span>
00664     <span class="comment">//</span>
00665 
00666     <a class="code" href="../../d8/d1/obsdata_8c.html#a23">ObpAcquireDescriptorCacheWriteLock</a>();
00667 
00668     <span class="comment">//</span>
00669     <span class="comment">//  **** the following diagnostic code should really be done only on</span>
00670     <span class="comment">//  a checked build</span>
00671     <span class="comment">//</span>
00672 
00673     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = <a class="code" href="../../d5/d1/obp_8h.html#a18">SD_TO_SD_HEADER</a>( *SecurityDescriptor );
00674     <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_DEASSIGN,(<span class="stringliteral">"Deassigning security descriptor %x, hash = %lX\n"</span>,*SecurityDescriptor, <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FullHash));
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">//  Call the actual routine to dereference the security descriptor</span>
00678     <span class="comment">//</span>
00679 
00680     <a class="code" href="../../d8/d1/obsdata_8c.html#a20">ObpDereferenceSecurityDescriptor</a>( *SecurityDescriptor );
00681 
00682     <span class="comment">//</span>
00683     <span class="comment">//  NULL out the SecurityDescriptor in the object's</span>
00684     <span class="comment">//  header so we don't try to free it again.</span>
00685     <span class="comment">//</span>
00686 
00687     *SecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00688 
00689     <span class="comment">//</span>
00690     <span class="comment">//  Unlock the security descriptor cache and return to our caller</span>
00691     <span class="comment">//</span>
00692 
00693     <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
00694     
00695     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00696 }
00697 
00698 
00699 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00700"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a20">00700</a> <a class="code" href="../../d8/d1/obsdata_8c.html#a20">ObpDereferenceSecurityDescriptor</a> (
00701     PSECURITY_DESCRIPTOR SecurityDescriptor
00702     )
00703 
00704 <span class="comment">/*++</span>
00705 <span class="comment"></span>
00706 <span class="comment">Routine Description:</span>
00707 <span class="comment"></span>
00708 <span class="comment">    Decrements the refcount of a cached security descriptor</span>
00709 <span class="comment"></span>
00710 <span class="comment">Arguments:</span>
00711 <span class="comment"></span>
00712 <span class="comment">    SecurityDescriptor - Points to a cached security descriptor</span>
00713 <span class="comment"></span>
00714 <span class="comment">Return Value:</span>
00715 <span class="comment"></span>
00716 <span class="comment">    None.</span>
00717 <span class="comment"></span>
00718 <span class="comment">--*/</span>
00719 
00720 {
00721     <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a>  SecurityDescriptorHeader;
00722 
00723     <span class="comment">//</span>
00724     <span class="comment">//  Lock the security descriptor cache and get a pointer</span>
00725     <span class="comment">//  to the security descriptor header</span>
00726     <span class="comment">//</span>
00727 
00728     <a class="code" href="../../d8/d1/obsdata_8c.html#a23">ObpAcquireDescriptorCacheWriteLock</a>();
00729 
00730     SecurityDescriptorHeader = <a class="code" href="../../d5/d1/obp_8h.html#a18">SD_TO_SD_HEADER</a>( SecurityDescriptor );
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">//  Do some debug work</span>
00734     <span class="comment">//</span>
00735 
00736     <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_REFERENCES, (<span class="stringliteral">"Dereferencing SecurityDescriptor %x, hash %lx, refcount = %d \n"</span>, SecurityDescriptor, SecurityDescriptorHeader-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o2">FullHash</a>,SecurityDescriptorHeader-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o1">RefCount</a>));
00737 
00738     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(SecurityDescriptorHeader-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o1">RefCount</a> != 0);
00739 
00740     <span class="comment">//</span>
00741     <span class="comment">//  Decrement the ref count and if it is now zero then</span>
00742     <span class="comment">//  we can completely remove this entry from the cache</span>
00743     <span class="comment">//</span>
00744 
00745     <span class="keywordflow">if</span> (--SecurityDescriptorHeader-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o1">RefCount</a> == 0) {
00746 
00747         <a class="code" href="../../d8/d1/obsdata_8c.html#a21">ObpDestroySecurityDescriptorHeader</a>( SecurityDescriptorHeader );
00748     }
00749 
00750     <span class="comment">//</span>
00751     <span class="comment">//  Unlock the security descriptor cache and return to our caller</span>
00752     <span class="comment">//</span>
00753 
00754     <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
00755 }
00756 
00757 
00758 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00759"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a21">00759</a> <a class="code" href="../../d8/d1/obsdata_8c.html#a21">ObpDestroySecurityDescriptorHeader</a> (
00760     IN <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a> Header
00761     )
00762 
00763 <span class="comment">/*++</span>
00764 <span class="comment"></span>
00765 <span class="comment">Routine Description:</span>
00766 <span class="comment"></span>
00767 <span class="comment">    Frees a cached security descriptor and unlinks it from the chain.</span>
00768 <span class="comment"></span>
00769 <span class="comment">Arguments:</span>
00770 <span class="comment"></span>
00771 <span class="comment">    Header - Pointer to a security descriptor header (cached security</span>
00772 <span class="comment">        descriptor)</span>
00773 <span class="comment"></span>
00774 <span class="comment">Return Value:</span>
00775 <span class="comment"></span>
00776 <span class="comment">    None.</span>
00777 <span class="comment"></span>
00778 <span class="comment">--*/</span>
00779 
00780 {
00781     PLIST_ENTRY Forward;
00782     PLIST_ENTRY Rear;
00783     UCHAR SmallHash;
00784 
00785     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;RefCount == 0 );
00786 
00787 <span class="preprocessor">#if OB_DIAGNOSTICS_ENABLED</span>
00788 <span class="preprocessor"></span>
00789     ObsTotalCacheEntries--;
00790 
00791 <span class="preprocessor">#endif</span>
00792 <span class="preprocessor"></span>
00793     <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_STATISTICS, (<span class="stringliteral">"ObsTotalCacheEntries = %d \n"</span>,ObsTotalCacheEntries));
00794 
00795     <span class="comment">//</span>
00796     <span class="comment">//  Unlink the cached security descriptor from its linked list and</span>
00797     <span class="comment">//  from the small hash table if it was at the head of the list</span>
00798     <span class="comment">//</span>
00799     <span class="comment">//  **** this should all be rewritten to use the regular set of</span>
00800     <span class="comment">//  link list macros</span>
00801     <span class="comment">//</span>
00802 
00803     SmallHash = (UCHAR)<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FullHash;
00804 
00805     Forward = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Link.Flink;
00806     Rear = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Link.Blink;
00807 
00808     <span class="keywordflow">if</span> ( Forward != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00809 
00810         Forward-&gt;Blink = Rear;
00811     }
00812 
00813     <span class="keywordflow">if</span> ( Rear != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00814 
00815         Rear-&gt;Flink = Forward;
00816 
00817     } <span class="keywordflow">else</span> {
00818 
00819         <span class="comment">//</span>
00820         <span class="comment">//  if Rear is NULL, we're deleting the head of the list</span>
00821         <span class="comment">//</span>
00822 
00823         <a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a>[SmallHash] = Forward;
00824     }
00825 
00826     <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_HEADER_FREE, (<span class="stringliteral">"Freeing memory at %x \n"</span>,<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>));
00827 
00828     <span class="comment">//</span>
00829     <span class="comment">//  Now return the cached descriptor to pool and return to our caller</span>
00830     <span class="comment">//</span>
00831 
00832     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> );
00833 
00834     <span class="keywordflow">return</span>;
00835 }
00836 
00837 
00838 BOOLEAN
<a name="l00839"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a22">00839</a> <a class="code" href="../../d8/d1/obsdata_8c.html#a22">ObpCompareSecurityDescriptors</a> (
00840     IN PSECURITY_DESCRIPTOR SD1,
00841     IN PSECURITY_DESCRIPTOR SD2
00842     )
00843 
00844 <span class="comment">/*++</span>
00845 <span class="comment"></span>
00846 <span class="comment">Routine Description:</span>
00847 <span class="comment"></span>
00848 <span class="comment">    Performs a byte by byte comparison of two self relative security</span>
00849 <span class="comment">    descriptors to determine if they are identical.</span>
00850 <span class="comment"></span>
00851 <span class="comment">Arguments:</span>
00852 <span class="comment"></span>
00853 <span class="comment">    SD1, SD2 - Security descriptors to be compared.</span>
00854 <span class="comment"></span>
00855 <span class="comment">Return Value:</span>
00856 <span class="comment"></span>
00857 <span class="comment">    TRUE - They are the same.</span>
00858 <span class="comment"></span>
00859 <span class="comment">    FALSE - They are different.</span>
00860 <span class="comment"></span>
00861 <span class="comment">--*/</span>
00862 
00863 {
00864     ULONG Length1;
00865     ULONG Length2;
00866     ULONG <a class="code" href="../../d9/d1/lboxctl2_8c.html#a38">Compare</a>;
00867 
00868     <span class="comment">//</span>
00869     <span class="comment">//  Calculating the length is pretty fast, see if we</span>
00870     <span class="comment">//  can get away with doing only that.</span>
00871     <span class="comment">//</span>
00872 
00873     Length1 =  <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a> ( SD1 );
00874     Length2 =  <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a> ( SD2 );
00875 
00876     <span class="keywordflow">if</span> (Length1 != Length2) {
00877 
00878         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00879     }
00880 
00881     <span class="keywordflow">return</span> (BOOLEAN)RtlEqualMemory ( SD1, SD2, Length1 );
00882 }
00883 
00884 
00885 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00886"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a23">00886</a> <a class="code" href="../../d8/d1/obsdata_8c.html#a23">ObpAcquireDescriptorCacheWriteLock</a> (
00887     VOID
00888     )
00889 
00890 <span class="comment">/*++</span>
00891 <span class="comment"></span>
00892 <span class="comment">Routine Description:</span>
00893 <span class="comment"></span>
00894 <span class="comment">    Takes a write lock on the security descriptor cache.</span>
00895 <span class="comment"></span>
00896 <span class="comment">Arguments:</span>
00897 <span class="comment"></span>
00898 <span class="comment">    none</span>
00899 <span class="comment"></span>
00900 <span class="comment">Return Value:</span>
00901 <span class="comment"></span>
00902 <span class="comment">    None.</span>
00903 <span class="comment"></span>
00904 <span class="comment">--*/</span>
00905 
00906 {
00907     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00908     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( &amp;<a class="code" href="../../d8/d1/obsdata_8c.html#a12">ObsSecurityDescriptorCacheLock</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00909 
00910     <span class="keywordflow">return</span>;
00911 }
00912 
00913 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00914"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a24">00914</a> <a class="code" href="../../d8/d1/obsdata_8c.html#a24">ObpAcquireDescriptorCacheReadLock</a> (
00915     VOID
00916     )
00917 
00918 <span class="comment">/*++</span>
00919 <span class="comment"></span>
00920 <span class="comment">Routine Description:</span>
00921 <span class="comment"></span>
00922 <span class="comment">    Takes a read lock on the security descriptor cache.</span>
00923 <span class="comment"></span>
00924 <span class="comment">Arguments:</span>
00925 <span class="comment"></span>
00926 <span class="comment">    none</span>
00927 <span class="comment"></span>
00928 <span class="comment">Return Value:</span>
00929 <span class="comment"></span>
00930 <span class="comment">    None.</span>
00931 <span class="comment"></span>
00932 <span class="comment">--*/</span>
00933 
00934 {
00935     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00936     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;<a class="code" href="../../d8/d1/obsdata_8c.html#a12">ObsSecurityDescriptorCacheLock</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00937 
00938     <span class="keywordflow">return</span>;
00939 }
00940 
00941 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00942"></a><a class="code" href="../../d8/d1/obsdata_8c.html#a25">00942</a> <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a> (
00943     VOID
00944     )
00945 
00946 <span class="comment">/*++</span>
00947 <span class="comment"></span>
00948 <span class="comment">Routine Description:</span>
00949 <span class="comment"></span>
00950 <span class="comment">    Releases a lock on the security descriptor cache.</span>
00951 <span class="comment"></span>
00952 <span class="comment">Arguments:</span>
00953 <span class="comment"></span>
00954 <span class="comment">    none</span>
00955 <span class="comment"></span>
00956 <span class="comment">Return Value:</span>
00957 <span class="comment"></span>
00958 <span class="comment">    None.</span>
00959 <span class="comment"></span>
00960 <span class="comment">--*/</span>
00961 
00962 {
00963     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;<a class="code" href="../../d8/d1/obsdata_8c.html#a12">ObsSecurityDescriptorCacheLock</a> );
00964     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a> ();
00965 
00966     <span class="keywordflow">return</span>;
00967 }
00968 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:06 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
