<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hivechek.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hivechek.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d0/d0/hivechek_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/hivechek_8c.html#a9">HvCheckHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, PULONG Storage OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/hivechek_8c.html#a10">HvCheckBin</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="el" href="../../d9/d0/hivechek_8c.html#a6">Bin</a>, PULONG Storage)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap>struct {</td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d9/d0/hivechek_8c.html#a0">Hive</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;<a class="el" href="../../d9/d0/hivechek_8c.html#a1">Status</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;<a class="el" href="../../d9/d0/hivechek_8c.html#a2">Space</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d9/d0/hivechek_8c.html#a3">MapPoint</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d9/d0/hivechek_8c.html#a4">BinPoint</a></td></tr>

<tr><td class="memItemLeft" nowrap valign=top>}&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/hivechek_8c.html#a5">HvCheckHiveDebug</a></td></tr>

<tr><td class="memItemLeft" nowrap>struct {</td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d9/d0/hivechek_8c.html#a6">Bin</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;<a class="el" href="../../d9/d0/hivechek_8c.html#a1">Status</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d8/d4/struct__HCELL.html">PHCELL</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d9/d0/hivechek_8c.html#a7">CellPoint</a></td></tr>

<tr><td class="memItemLeft" nowrap valign=top>}&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/hivechek_8c.html#a8">HvCheckBinDebug</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a10" doxytag="hivechek.c::HvCheckBin" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG HvCheckBin           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Bin</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Storage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00175">175</a> of file <a class="el" href="../../d0/d0/hivechek_8c-source.html">hivechek.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00188">HBIN_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, and <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00161">USE_OLD_CELL</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00054">HvCheckHive()</a>.
<p>
<pre class="fragment"><div>00182                    :
00183 
00184     Step through all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cells in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bin.  Make sure that
00185     they are consistent with each other, and with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bin header.
00186 
00187 Arguments:
00188 
00189     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure
00190 
00191     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> - pointer to bin to check
00192 
00193     Storage - pointer to a ulong to get allocated user data size
00194 
00195 Return Value:
00196 
00197     0 <span class="keywordflow">if</span> <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> OK.  Number of test in <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> that failed <span class="keywordflow">if</span> not.
00198 
00199     RANGE:  1 - 1999
00200 
00201 --*/
00202 {
00203     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  p;
00204     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  np;
00205     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  lp;
00206     ULONG   freespace = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00207     ULONG   allocated = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00208     ULONG   userallocated = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00209 
00210     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Bin = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00211     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 0;
00212     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = 0;
00213 
00214     <span class="comment">//</span>
00215     <span class="comment">// Scan all the cells in the bin, total free and allocated, check</span>
00216     <span class="comment">// for impossible pointers.</span>
00217     <span class="comment">//</span>
00218     p = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));
00219     lp = p;
00220 
00221     <span class="comment">// DRAGOS:</span>
00222     <span class="comment">// The way allocated and freespace are computed implies the following invariants:</span>
00223     <span class="comment">// 1. allocated + freespace = p + p-&gt;Size - (Bin + sizeof(HBIN)). This is because p-&gt;Size is added either to allocated or to freespace.</span>
00224     <span class="comment">//    So, assuming that allocated &gt; Bin-&gt;Size , then</span>
00225     <span class="comment">//              ==&gt; p + p-&gt;Size - (Bin + sizeof(HBIN)) &gt; Bin-&gt;Size.</span>
00226     <span class="comment">//              ==&gt; p + p-&gt;Size &gt; Bin + Bin-&gt;Size + sizeof(HBIN)</span>
00227     <span class="comment">//              ==&gt; p + p-&gt;Size &gt; Bin + Bin-&gt;Size</span>
00228     <span class="comment">//      This proves that the test "NeverFail 1" (see bellow) will never fail, because when something is wrong, the test above it (namely "Fail 1") will fail </span>
00229     <span class="comment">//      and the function will exit.</span>
00230     <span class="comment">//</span>
00231     <span class="comment">//    The same logic applies to the test "NeverFail 2", so it can be removed also.</span>
00232     <span class="comment">//</span>
00233     <span class="comment">// 2. The new value of p is always calculated as p = p + p-&gt;Size. By the time this is done, the new value of p (ie. p + p-&gt;Size) is already checked against </span>
00234     <span class="comment">//      Bin + Bin-&gt;Size (see tests "Fail 1" and "Fail 2"). So, if p &gt; Bin + Bin-&gt;Size, either "Fail 1" or "Fail 2" will fail before asigning the new bogus value </span>
00235     <span class="comment">//      to p. Therefore, the only possible path to exit the while loop (except a return 20 or return 40), is when p == Bin + Bin-&gt;Size.</span>
00236     <span class="comment">//      ==&gt; test "NeverFail 3" can be removed as it will never fail !</span>
00237     <span class="comment">//</span>
00238     <span class="comment">// 3. Considering 1 (where p + p-&gt;Size became p) </span>
00239     <span class="comment">//              ==&gt; allocated + freespace =  p - (Bin + sizeof(HBIN))</span>
00240     <span class="comment">//    But, Considering 2 (above), when the while loop exits, p = Bin + Bin-&gt;Size</span>
00241     <span class="comment">//              ==&gt; allocated + freespace = Bin + Bin-&gt;Size - (Bin + sizeof(HBIN))</span>
00242     <span class="comment">//              ==&gt; allocated + freespace + sizeof(HBIN) = Bin-&gt;Size</span>
00243     <span class="comment">//       This proves that test "NeverFail 4" (see bellow) will never fail as the expresion tested is always true (if the flow of execution reaches the test point).</span>
00244     <span class="comment">//</span>
00245 
00246     <span class="keywordflow">while</span> (p &lt; (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)) {
00247 
00248         <span class="comment">//</span>
00249         <span class="comment">// Check last pointer</span>
00250         <span class="comment">//</span>
00251         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00252             <span class="keywordflow">if</span> (lp == p) {
00253                 <span class="keywordflow">if</span> (p-&gt;u.OldCell.Last != <a class="code" href="../../d0/d1/hivedata_8h.html#a25">HBIN_NIL</a>) {
00254                     KdPrint((<span class="stringliteral">"HvCheckBin 20: First cell has wrong last pointer\n"</span>));
00255                     KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00256                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 20;
00257                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00258                     <span class="keywordflow">return</span> 20;
00259                 }
00260             } <span class="keywordflow">else</span> {
00261                 <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(p-&gt;u.OldCell.Last + (PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>) != lp) {
00262                     KdPrint((<span class="stringliteral">"HvCheckBin 30: incorrect last pointer\n"</span>));
00263                     KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00264                     KdPrint((<span class="stringliteral">"p = %08lx\n"</span>, (ULONG_PTR)p));
00265                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 30;
00266                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00267                     <span class="keywordflow">return</span> 30;
00268                 }
00269             }
00270         }
00271 
00272         
00273         <span class="comment">//</span>
00274         <span class="comment">// Check size</span>
00275         <span class="comment">//</span>
00276         <span class="keywordflow">if</span> (p-&gt;Size &lt; 0) {
00277 
00278             <span class="comment">//</span>
00279             <span class="comment">// allocated cell</span>
00280             <span class="comment">//</span>
00281 
00282             <span class="comment">// DRAGOS:    Fail 1</span>
00283             <span class="comment">// This test will alway fail prior to the failure of the bellow test</span>
00284             <span class="comment">//</span>
00285             <span class="keywordflow">if</span> ( ((ULONG)(p-&gt;Size * -1) &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)        ||
00286                  ( (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((p-&gt;Size * -1) + (PUCHAR)p) &gt;
00287                    (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) )
00288                )
00289             {
00290                 KdPrint((<span class="stringliteral">"HvCheckBin 40: impossible allocation\n"</span>));
00291                 KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00292                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 40;
00293                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00294                 <span class="keywordflow">return</span> 40;
00295             }
00296 
00297             allocated += (p-&gt;Size * -1);
00298             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00299                 userallocated += (p-&gt;Size * -1) - FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.UserData);
00300             } <span class="keywordflow">else</span> {
00301                 userallocated += (p-&gt;Size * -1) - FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.NewCell.u.UserData);
00302             }
00303 
00304             <span class="comment">//</span>
00305             <span class="comment">// DRAGOS:   NeverFail 1</span>
00306             <span class="comment">// This test will never fail. If a size is wrong the above test (Fail 1)will fail. We can remove this test (it's useless).</span>
00307             <span class="comment">//</span>
00308             <span class="keywordflow">if</span> (allocated &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {
00309                 KdPrint((<span class="stringliteral">"HvCheckBin 50: allocated exceeds available\n"</span>));
00310                 KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00311                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 50;
00312                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00313                 <span class="keywordflow">return</span> 50;
00314             }
00315 
00316             np = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)p + (p-&gt;Size * -1));
00317 
00318 
00319 
00320         } <span class="keywordflow">else</span> {
00321 
00322             <span class="comment">//</span>
00323             <span class="comment">// free cell</span>
00324             <span class="comment">//</span>
00325 
00326             <span class="comment">// DRAGOS:    Fail 2</span>
00327             <span class="comment">// This test will alway fail prior to the failure of the bellow test</span>
00328             <span class="comment">//</span>
00329             <span class="keywordflow">if</span> ( ((ULONG)p-&gt;Size &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)               ||
00330                  ( (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(p-&gt;Size + (PUCHAR)p) &gt;
00331                    (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) ) ||
00332                  (p-&gt;Size == 0) )
00333             {
00334                 KdPrint((<span class="stringliteral">"HvCheckBin 60: impossible free block\n"</span>));
00335                 KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00336                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 60;
00337                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00338                 <span class="keywordflow">return</span> 60;
00339             }
00340 
00341             freespace = freespace + p-&gt;Size;
00342 
00343             <span class="comment">//</span>
00344             <span class="comment">// DRAGOS:   NeverFail 2</span>
00345             <span class="comment">// This test will never fail. If a size is wrong the above test (Fail 2) will fail. We can remove this test (it's useless).</span>
00346             <span class="comment">//</span>
00347             <span class="keywordflow">if</span> (freespace &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {
00348                 KdPrint((<span class="stringliteral">"HvCheckBin 70: free exceeds available\n"</span>));
00349                 KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00350                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 70;
00351                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.CellPoint = p;
00352                 <span class="keywordflow">return</span> 70;
00353             }
00354 
00355             np = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)p + p-&gt;Size);
00356 
00357         }
00358 
00359         lp = p;
00360         p = np;
00361     }
00362 
00363     <span class="comment">// DRAGOS:  NeverFail 4</span>
00364     <span class="comment">// This test never fails. If the while loop exits, the condition tested here is always true!!!</span>
00365     <span class="comment">// We can remove this test (it's useless)</span>
00366     <span class="comment">//</span>
00367     <span class="keywordflow">if</span> ((freespace + allocated + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>)) != <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {
00368         KdPrint((<span class="stringliteral">"HvCheckBin 995: sizes do not add up\n"</span>));
00369         KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00370         KdPrint((<span class="stringliteral">"freespace = %08lx  "</span>, freespace));
00371         KdPrint((<span class="stringliteral">"allocated = %08lx  "</span>, allocated));
00372         KdPrint((<span class="stringliteral">"size = %08lx\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>));
00373         <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 995;
00374         <span class="keywordflow">return</span> 995;
00375     }
00376 
00377     <span class="comment">// DRAGOS:  NeverFail 3</span>
00378     <span class="comment">// This test never fails. The only way out of the while loop is when p == Bin + Bin-&gt;Size !!!!!!!</span>
00379     <span class="comment">// We can remove this test (it's useless)</span>
00380     <span class="comment">//</span>
00381     <span class="keywordflow">if</span> (p != (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)) {
00382         KdPrint((<span class="stringliteral">"HvCheckBin 1000: last cell points off the end\n"</span>));
00383         KdPrint((<span class="stringliteral">"Bin = %08lx\n"</span>, Bin));
00384         <a class="code" href="../../d7/d0/cmdat2_8c.html#a37">HvCheckBinDebug</a>.Status = 1000;
00385         <span class="keywordflow">return</span> 1000;
00386     }
00387 
00388     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Storage)) {
00389         *Storage += userallocated;
00390     }
00391     <span class="keywordflow">return</span> 0;
00392 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="hivechek.c::HvCheckHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG HvCheckHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG Storage&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00054">54</a> of file <a class="el" href="../../d0/d0/hivechek_8c-source.html">hivechek.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00187">HBIN_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00414">HMAP_DISCARDABLE</a>, <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00175">HvCheckBin()</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00192">_HBIN::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00587">_FREE_HBIN::Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d5/d0/genmips_8c-source.html#l00109">t()</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00108">CmCheckRegistry()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01584">HvRefreshHive()</a>.
<p>
<pre class="fragment"><div>00060                    :
00061 
00062     Check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> consistency of a hive.  Apply CheckBin to bins, make sure
00063     all pointers in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell map point to correct places.
00064 
00065 Arguments:
00066 
00067     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00068             hive of interest.
00069 
00070     Storage - supplies adddress of ULONG to receive size of allocated user data
00071 
00072 Return Value:
00073 
00074     0 <span class="keywordflow">if</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> OK.  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> <span class="keywordflow">return</span> indicator <span class="keywordflow">if</span> not.  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> value
00075     comes from one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check procedures.
00076 
00077     RANGE:  2000 - 2999
00078 
00079 --*/
00080 {
00081     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> p;
00082     ULONG       Length;
00083     ULONG       localstorage = 0;
00084     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00085     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00086     ULONG   i;
00087     ULONG   rc;
00088     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>  FreeBin;
00089 
00090     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Hive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00091     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 0;
00092     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = (ULONG)-1;
00093     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00094     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = 0;
00095 
00096     p = 0;
00097 
00098 
00099     <span class="comment">//</span>
00100     <span class="comment">// one pass for Stable space, one pass for Volatile</span>
00101     <span class="comment">//</span>
00102     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>; i++) {
00103         Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[i].Length;
00104 
00105         <span class="comment">//</span>
00106         <span class="comment">// for each bin in the space</span>
00107         <span class="comment">//</span>
00108         <span class="keywordflow">while</span> (p &lt; Length) {
00109             <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, p);
00110             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00111                 KdPrint((<span class="stringliteral">"HvCheckHive:"</span>));
00112                 KdPrint((<span class="stringliteral">"\tBin@:%08lx invalid\n"</span>, Bin));
00113                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 2005;
00114                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = i;
00115                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = p;
00116                 <span class="keywordflow">return</span> 2005;
00117             }
00118 
00119 
00120             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) == 0) {
00121 
00122                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress) &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00123 
00124                 <span class="comment">//</span>
00125                 <span class="comment">// bin header valid?</span>
00126                 <span class="comment">//</span>
00127                 <span class="keywordflow">if</span> ( (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> &gt; Length)                           ||
00128                      (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>)             ||
00129                      (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> != p)
00130                    )
00131                 {
00132                     KdPrint((<span class="stringliteral">"HvCheckHive:"</span>));
00133                     KdPrint((<span class="stringliteral">"\tBin@:%08lx invalid\n"</span>, Bin));
00134                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 2010;
00135                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = i;
00136                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = p;
00137                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00138                     <span class="keywordflow">return</span> 2010;
00139                 }
00140 
00141                 <span class="comment">//</span>
00142                 <span class="comment">// structure inside the bin valid?</span>
00143                 <span class="comment">//</span>
00144                 rc = <a class="code" href="../../d9/d0/hivechek_8c.html#a10">HvCheckBin</a>(Hive, Bin, &amp;localstorage);
00145                 <span class="keywordflow">if</span> (rc != 0) {
00146                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = rc;
00147                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = i;
00148                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = p;
00149                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00150                     <span class="keywordflow">return</span> rc;
00151                 }
00152 
00153                 p = (ULONG)p + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00154 
00155             } <span class="keywordflow">else</span> {
00156                 <span class="comment">//</span>
00157                 <span class="comment">// Bin is not present, skip it and advance to the next one.</span>
00158                 <span class="comment">//</span>
00159                 FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BlockAddress;
00160                 p+=FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
00161             }
00162         }
00163 
00164         p = 0x80000000;     <span class="comment">// Beginning of Volatile space</span>
00165     }
00166 
00167     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Storage)) {
00168         *Storage = localstorage;
00169     }
00170     <span class="keywordflow">return</span> 0;
00171 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a6" doxytag="hivechek.c::Bin" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="el" href="../../d9/d0/hivechek_8c.html#a6">Bin</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00043">43</a> of file <a class="el" href="../../d0/d0/hivechek_8c-source.html">hivechek.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="hivechek.c::BinPoint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a4">BinPoint</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00039">39</a> of file <a class="el" href="../../d0/d0/hivechek_8c-source.html">hivechek.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="hivechek.c::CellPoint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__HCELL.html">PHCELL</a> <a class="el" href="../../d9/d0/hivechek_8c.html#a7">CellPoint</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00045">45</a> of file <a class="el" href="../../d0/d0/hivechek_8c-source.html">hivechek.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="hivechek.c::Hive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00035">35</a> of file <a class="el" href="../../d0/d0/hivechek_8c-source.html">hivechek.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="hivechek.c::HvCheckBinDebug" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> struct { ... }   <a class="el" href="../../d9/d0/hivechek_8c.html#a8">HvCheckBinDebug</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="hivechek.c::HvCheckHiveDebug" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> struct { ... }   <a class="el" href="../../d7/d1/hivemap_8c.html#a5">HvCheckHiveDebug</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="hivechek.c::MapPoint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a3">MapPoint</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00038">38</a> of file <a class="el" href="../../d0/d0/hivechek_8c-source.html">hivechek.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="hivechek.c::Space" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d9/ps2_8c.html#a136">Space</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00037">37</a> of file <a class="el" href="../../d0/d0/hivechek_8c-source.html">hivechek.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="hivechek.c::Status" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00044">44</a> of file <a class="el" href="../../d0/d0/hivechek_8c-source.html">hivechek.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
