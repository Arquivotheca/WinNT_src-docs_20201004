<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fdengine.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fdengine.c</h1><a href="../../d8/d1/fdengine_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    fdengine.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the disk partitioning engine.  The code</span>
00012 <span class="comment">    in this module can be compiled for either the NT platform</span>
00013 <span class="comment">    or the ARC platform (-DARC).</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Ted Miller        (tedm)    Nov-1991</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d3/d3/arcinst_2precomp_8h.html">precomp.h</a>"</span>
00024 <span class="preprocessor">#pragma hdrstop</span>
00025 <span class="preprocessor"></span>
<a name="l00026"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a0">00026</a> <span class="preprocessor">#define ARCDBG</span>
00027 <span class="preprocessor"></span>
00028 <span class="comment">// Attached disk devices.</span>
00029 
<a name="l00030"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a2">00030</a> ULONG              <a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a>;
<a name="l00031"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a3">00031</a> PCHAR             *<a class="code" href="../../d8/d1/fdengine_8c.html#a3">DiskNames</a>;
00032 
00033 <span class="comment">// Information about attached disks.</span>
00034 
<a name="l00035"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a4">00035</a> <a class="code" href="../../d6/d8/struct__tagDISKGEOM.html">DISKGEOM</a>          *<a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>;
00036 
<a name="l00037"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a5">00037</a> <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>        *<a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>,
00038                   *<a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>;
00039 
00040 <span class="comment">//</span>
00041 <span class="comment">// Array keeping track of whether each disk is off line.</span>
00042 <span class="comment">//</span>
<a name="l00043"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a7">00043</a> PBOOLEAN           <a class="code" href="../../d8/d1/fdengine_8c.html#a7">OffLine</a>;
00044 
00045 <span class="comment">// Keeps track of whether changes have been made</span>
00046 <span class="comment">// to each disk's partition structure.</span>
00047 
<a name="l00048"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a8">00048</a> BOOLEAN           *<a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>;
00049 
00050 
00051 <span class="comment">//</span>
00052 <span class="comment">// Value used to indicate that the partition entry has changed but in a non-</span>
00053 <span class="comment">// destructive way (ie, made active/inactive).</span>
00054 <span class="comment">//</span>
<a name="l00055"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a1">00055</a> <span class="preprocessor">#define CHANGED_DONT_ZAP ((BOOLEAN)(5))</span>
00056 <span class="preprocessor"></span>
00057 <span class="comment">// forward declarations</span>
00058 
00059 
00060 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
00061 <a class="code" href="../../d8/d1/fdengine_8c.html#a11">OpenDisks</a>(
00062     VOID
00063     );
00064 
00065 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00066 <a class="code" href="../../d8/d1/fdengine_8c.html#a12">CloseDisks</a>(
00067     VOID
00068     );
00069 
00070 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
00071 <a class="code" href="../../d8/d1/fdengine_8c.html#a13">GetGeometry</a>(
00072     VOID
00073     );
00074 
00075 BOOLEAN
00076 <a class="code" href="../../d8/d1/fdengine_8c.html#a14">CheckIfDiskIsOffLine</a>(
00077     IN ULONG Disk
00078     );
00079 
00080 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
00081 <a class="code" href="../../d8/d1/fdengine_8c.html#a15">InitializePartitionLists</a>(
00082     VOID
00083     );
00084 
00085 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
00086 <a class="code" href="../../d8/d1/fdengine_8c.html#a16">GetRegions</a>(
00087     IN  ULONG               Disk,
00088     IN  <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>          p,
00089     IN  BOOLEAN             WantUsedRegions,
00090     IN  BOOLEAN             WantFreeRegions,
00091     IN  BOOLEAN             WantLogicalRegions,
00092     OUT <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> *Region,
00093     OUT ULONG              *RegionCount,
00094     IN  REGION_TYPE         RegionType
00095     );
00096 
00097 BOOLEAN
00098 <a class="code" href="../../d8/d1/fdengine_8c.html#a37">AddRegionEntry</a>(
00099     IN OUT <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> *Regions,
00100     IN OUT ULONG              *RegionCount,
00101     IN     ULONG               SizeMB,
00102     IN     REGION_TYPE         RegionType,
00103     IN     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>          Partition,
00104     IN     LARGE_INTEGER       AlignedRegionOffset,
00105     IN     LARGE_INTEGER       AlignedRegionSize
00106     );
00107 
00108 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00109 <a class="code" href="../../d8/d1/fdengine_8c.html#a39">AddPartitionToLinkedList</a>(
00110     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PARTITION</a> **Head,
00111     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PARTITION</a> *p
00112     );
00113 
00114 BOOLEAN
00115 <a class="code" href="../../d8/d1/fdengine_8c.html#a19">IsInLinkedList</a>(
00116     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p,
00117     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> List
00118     );
00119 
00120 BOOLEAN
00121 <a class="code" href="../../d8/d1/fdengine_8c.html#a20">IsInLogicalList</a>(
00122     IN ULONG      Disk,
00123     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p
00124     );
00125 
00126 BOOLEAN
00127 <a class="code" href="../../d8/d1/fdengine_8c.html#a21">IsInPartitionList</a>(
00128     IN ULONG      Disk,
00129     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p
00130     );
00131 
00132 LARGE_INTEGER
00133 <a class="code" href="../../d8/d1/fdengine_8c.html#a22">AlignTowardsDiskStart</a>(
00134     IN ULONG         Disk,
00135     IN LARGE_INTEGER Offset
00136     );
00137 
00138 LARGE_INTEGER
00139 <a class="code" href="../../d8/d1/fdengine_8c.html#a23">AlignTowardsDiskEnd</a>(
00140     IN ULONG         Disk,
00141     IN LARGE_INTEGER Offset
00142     );
00143 
00144 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00145 <a class="code" href="../../d8/d1/fdengine_8c.html#a45">FreeLinkedPartitionList</a>(
00146     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PARTITION</a> **q
00147     );
00148 
00149 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00150 <a class="code" href="../../d8/d1/fdengine_8c.html#a25">MergeFreePartitions</a>(
00151     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p
00152     );
00153 
00154 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00155 <a class="code" href="../../d8/d1/fdengine_8c.html#a40">RenumberPartitions</a>(
00156     ULONG Disk
00157     );
00158 
00159 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00160 <a class="code" href="../../d8/d1/fdengine_8c.html#a46">FreePartitionInfoLinkedLists</a>(
00161     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PARTITION</a> **ListHeadArray
00162     );
00163 
00164 LARGE_INTEGER
00165 <a class="code" href="../../d8/d1/fdengine_8c.html#a28">DiskLengthBytes</a>(
00166     IN ULONG Disk
00167     );
00168 
00169 <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>
00170 <a class="code" href="../../d8/d1/fdengine_8c.html#a29">AllocatePartitionStructure</a>(
00171     IN ULONG         Disk,
00172     IN LARGE_INTEGER Offset,
00173     IN LARGE_INTEGER Length,
00174     IN UCHAR         SysID,
00175     IN BOOLEAN       Update,
00176     IN BOOLEAN       Active,
00177     IN BOOLEAN       Recognized
00178     );
00179 
00180 
00181 
00182 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00183"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a30">00183</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a30">FdiskInitialize</a>(
00184     VOID
00185     )
00186 
00187 <span class="comment">/*++</span>
00188 <span class="comment"></span>
00189 <span class="comment">Routine Description:</span>
00190 <span class="comment"></span>
00191 <span class="comment">    This routine initializes the partitioning engine, including allocating</span>
00192 <span class="comment">    arrays, determining attached disk devices, and reading their</span>
00193 <span class="comment">    partition tables.</span>
00194 <span class="comment"></span>
00195 <span class="comment">Arguments:</span>
00196 <span class="comment"></span>
00197 <span class="comment">    None.</span>
00198 <span class="comment"></span>
00199 <span class="comment">Return Value:</span>
00200 <span class="comment"></span>
00201 <span class="comment">    OK_STATUS or error code.</span>
00202 <span class="comment"></span>
00203 <span class="comment">--*/</span>
00204 
00205 {
00206     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> status;
00207     ULONG        i;
00208 
00209 
00210     <span class="keywordflow">if</span>((status = <a class="code" href="../../d1/d6/low_8c.html#a21">LowQueryFdiskPathList</a>(&amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a3">DiskNames</a>,&amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a>)) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
00211         <span class="keywordflow">return</span>(status);
00212     }
00213 
00214 <span class="preprocessor">#if 0</span>
00215 <span class="preprocessor"></span><span class="preprocessor">#ifdef ARCDBG</span>
00216 <span class="preprocessor"></span>    <a class="code" href="../../d4/d9/arcinst_8h.html#a114">AlPrint</a>(<span class="stringliteral">"Disk count = %u\r\n"</span>,<a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a>);
00217     <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a>; i++) {
00218         <a class="code" href="../../d4/d9/arcinst_8h.html#a114">AlPrint</a>(<span class="stringliteral">"Disk %u: %s\r\n"</span>,i,<a class="code" href="../../d8/d1/fdengine_8c.html#a3">DiskNames</a>[i]);
00219     }
00220     WaitKey();
00221 <span class="preprocessor">#endif</span>
00222 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00223 <span class="preprocessor"></span>
00224     <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00225     <a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00226     <a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00227 
00228     <span class="keywordflow">if</span>(((<a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>      = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html">DISKGEOM</a>  ))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00229     || ((<a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>            = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a> * <span class="keyword">sizeof</span>(BOOLEAN   ))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00230     || ((<a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>      = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00231     || ((<a class="code" href="../../d8/d1/fdengine_8c.html#a7">OffLine</a>                = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a> * <span class="keyword">sizeof</span>(BOOLEAN   ))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00232     || ((<a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>         = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a47">PPARTITION</a>))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
00233     {
00234         <a class="code" href="../../d4/d9/arcinst_8h.html#a24">RETURN_OUT_OF_MEMORY</a>;
00235     }
00236 
00237     <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a>; i++) {
00238         <a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00239         <a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00240         <a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>[i] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00241         <a class="code" href="../../d8/d1/fdengine_8c.html#a7">OffLine</a>[i] = <a class="code" href="../../d8/d1/fdengine_8c.html#a14">CheckIfDiskIsOffLine</a>(i);
00242         <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a7">OffLine</a>[i]) {
00243             <span class="keywordflow">return</span>(<a class="code" href="../../d2/d9/arccodes_8h.html#a24a14">ENODEV</a>);
00244         }
00245     }
00246 
00247     <span class="keywordflow">if</span>(((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a13">GetGeometry</a>()             ) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>)
00248     || ((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a15">InitializePartitionLists</a>()) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>))
00249     {
00250         <span class="keywordflow">return</span>(status);
00251     }
00252 
00253     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
00254 }
00255 
00256 
00257 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00258"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a31">00258</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a31">FdiskCleanUp</a>(
00259     VOID
00260     )
00261 
00262 <span class="comment">/*++</span>
00263 <span class="comment"></span>
00264 <span class="comment">Routine Description:</span>
00265 <span class="comment"></span>
00266 <span class="comment">    This routine deallocates storage used by the partitioning engine.</span>
00267 <span class="comment"></span>
00268 <span class="comment">Arguments:</span>
00269 <span class="comment"></span>
00270 <span class="comment">    None.</span>
00271 <span class="comment"></span>
00272 <span class="comment">Return Value:</span>
00273 <span class="comment"></span>
00274 <span class="comment">    None.</span>
00275 <span class="comment"></span>
00276 <span class="comment">--*/</span>
00277 
00278 {
00279     <a class="code" href="../../d1/d6/low_8c.html#a22">LowFreeFdiskPathList</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a3">DiskNames</a>,<a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a>);
00280 
00281     <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00282         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>);
00283     }
00284     <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00285         <a class="code" href="../../d8/d1/fdengine_8c.html#a46">FreePartitionInfoLinkedLists</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>);
00286         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>);
00287     }
00288     <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00289         <a class="code" href="../../d8/d1/fdengine_8c.html#a46">FreePartitionInfoLinkedLists</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>);
00290         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>);
00291     }
00292     <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00293         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>);
00294     }
00295     <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a7">OffLine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00296         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a7">OffLine</a>);
00297     }
00298 }
00299 
00300 
00301 BOOLEAN
<a name="l00302"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a14">00302</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a14">CheckIfDiskIsOffLine</a>(
00303     IN ULONG Disk
00304     )
00305 
00306 <span class="comment">/*++</span>
00307 <span class="comment"></span>
00308 <span class="comment">Routine Description:</span>
00309 <span class="comment"></span>
00310 <span class="comment">    Determine whether a disk is off-line by attempting to open it.</span>
00311 <span class="comment">    If this is diskman, also attempt to read from it.</span>
00312 <span class="comment"></span>
00313 <span class="comment">Arguments:</span>
00314 <span class="comment"></span>
00315 <span class="comment">    Disk - supplies number of the disk to check</span>
00316 <span class="comment"></span>
00317 <span class="comment">Return Value:</span>
00318 <span class="comment"></span>
00319 <span class="comment">    TRUE if disk is off-line, FALSE is disk is on-line.</span>
00320 <span class="comment"></span>
00321 <span class="comment">--*/</span>
00322 
00323 {
00324     ULONG <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00325     BOOLEAN IsOffLine;
00326 
00327     <span class="keywordflow">if</span>(<a class="code" href="../../d1/d6/low_8c.html#a9">LowOpenDisk</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a62">GetDiskName</a>(Disk),&amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>) == <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
00328 
00329         IsOffLine = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00330         <a class="code" href="../../d1/d6/low_8c.html#a10">LowCloseDisk</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00331 
00332     } <span class="keywordflow">else</span> {
00333 
00334         IsOffLine = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00335     }
00336 
00337     <span class="keywordflow">return</span>(IsOffLine);
00338 }
00339 
00340 
00341 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00342"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a13">00342</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a13">GetGeometry</a>(
00343     VOID
00344     )
00345 
00346 <span class="comment">/*++</span>
00347 <span class="comment"></span>
00348 <span class="comment">Routine Description:</span>
00349 <span class="comment"></span>
00350 <span class="comment">    This routine determines disk geometry for each disk device.</span>
00351 <span class="comment">    Disk geometry includes heads, sectors per track, cylinder count,</span>
00352 <span class="comment">    and bytes per sector.  It also includes bytes per track and</span>
00353 <span class="comment">    bytes per cylinder, which are calculated from the other values</span>
00354 <span class="comment">    for the convenience of the rest of this module.</span>
00355 <span class="comment"></span>
00356 <span class="comment">    Geometry information is placed in the DiskGeometryArray global variable.</span>
00357 <span class="comment"></span>
00358 <span class="comment">    Geometry information is undefined for an off-line disk.</span>
00359 <span class="comment"></span>
00360 <span class="comment">Arguments:</span>
00361 <span class="comment"></span>
00362 <span class="comment">    None.</span>
00363 <span class="comment"></span>
00364 <span class="comment">Return Value:</span>
00365 <span class="comment"></span>
00366 <span class="comment">    OK_STATUS or error code.</span>
00367 <span class="comment"></span>
00368 <span class="comment">--*/</span>
00369 
00370 {
00371     ULONG       i;
00372     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> status;
00373     ULONG       TotalSectorCount,
00374                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>,
00375                 SectorsPerTrack,
00376                 Heads;
00377 
00378     <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a>; i++) {
00379 
00380         <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a7">OffLine</a>[i]) {
00381             <span class="keywordflow">continue</span>;
00382         }
00383 
00384         <span class="keywordflow">if</span>((status = <a class="code" href="../../d1/d6/low_8c.html#a11">LowGetDriveGeometry</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a3">DiskNames</a>[i],&amp;TotalSectorCount,&amp;<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>,&amp;SectorsPerTrack,&amp;Heads)) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
00385             <span class="keywordflow">return</span>(status);
00386         }
00387 
00388         <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[i].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o3">BytesPerSector</a>   = <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>;
00389         <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[i].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o2">SectorsPerTrack</a>  = SectorsPerTrack;
00390         <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[i].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o1">Heads</a>            = Heads;
00391         <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[i].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o0">Cylinders</a>.QuadPart = TotalSectorCount / (SectorsPerTrack * Heads);
00392         <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[i].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o5">BytesPerTrack</a>    = SectorsPerTrack * <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>;
00393         <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[i].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o4">BytesPerCylinder</a> = SectorsPerTrack * <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> * Heads;
00394     }
00395     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
00396 }
00397 
00398 
00399 <span class="preprocessor">#if i386</span>
00400 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00401 <a class="code" href="../../d4/d9/arcinst_8h.html#a150">SetPartitionActiveFlag</a>(
00402     IN <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Region,
00403     IN UCHAR              value
00404     )
00405 {
00406     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p = ((<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html">PREGION_DATA</a>)Region-&gt;Reserved)-&gt;Partition;
00407 
00408     <span class="keywordflow">if</span>((UCHAR)p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o9">Active</a> != value) {
00409 
00410         <span class="comment">//</span>
00411         <span class="comment">// Unfortuneately, the Update flag becomes the RewritePartition flag</span>
00412         <span class="comment">// at commit time.  This causes us to zap the boot sector.  To avoid</span>
00413         <span class="comment">// this, we use a spacial non-boolean value that can be checked for</span>
00414         <span class="comment">// at commit time and that will cause us NOT to zap the bootsector</span>
00415         <span class="comment">// even though RewritePartition will be TRUE.</span>
00416         <span class="comment">//</span>
00417 
00418         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o9">Active</a> = value;
00419         <span class="keywordflow">if</span>(!p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a>) {
00420             p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a> = <a class="code" href="../../d8/d1/fdengine_8c.html#a1">CHANGED_DONT_ZAP</a>;
00421         }
00422         <a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>[p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o4">Disk</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00423     }
00424 }
00425 <span class="preprocessor">#endif</span>
00426 <span class="preprocessor"></span>
00427 
00428 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00429"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a32">00429</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a32">DetermineCreateSizeAndOffset</a>(
00430     IN  <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Region,
00431     IN  LARGE_INTEGER      MinimumSize,
00432     IN  ULONG              CreationSizeMB,
00433     IN  REGION_TYPE        Type,
00434     OUT PLARGE_INTEGER     CreationStart,
00435     OUT PLARGE_INTEGER     CreationSize
00436     )
00437 
00438 <span class="comment">/*++</span>
00439 <span class="comment"></span>
00440 <span class="comment">Routine Description:</span>
00441 <span class="comment"></span>
00442 <span class="comment">    Determine the actual offset and size of the partition, given the</span>
00443 <span class="comment">    size in megabytes.</span>
00444 <span class="comment"></span>
00445 <span class="comment">Arguments:</span>
00446 <span class="comment"></span>
00447 <span class="comment">    Region  - a region descriptor returned by GetDiskRegions().  Must</span>
00448 <span class="comment">              be an unused region.</span>
00449 <span class="comment"></span>
00450 <span class="comment">    MinimumSize - if non-0, this is the minimum size that the partition</span>
00451 <span class="comment">        or logical drive can be.</span>
00452 <span class="comment"></span>
00453 <span class="comment">    CreationSizeMB - If MinimumSize is 0, size of partition to create, in MB.</span>
00454 <span class="comment"></span>
00455 <span class="comment">    Type    - REGION_PRIMARY, REGION_EXTENDED, or REGION_LOGICAL, for</span>
00456 <span class="comment">              creating a primary partition, extended partition, or</span>
00457 <span class="comment">              logical volume, respectively.</span>
00458 <span class="comment"></span>
00459 <span class="comment">    CreationStart - receives the offset where the partition should be placed.</span>
00460 <span class="comment"></span>
00461 <span class="comment">    CreationSize - receives the exact size for the partition.</span>
00462 <span class="comment"></span>
00463 <span class="comment">Return Value:</span>
00464 <span class="comment"></span>
00465 <span class="comment">    None.</span>
00466 <span class="comment"></span>
00467 <span class="comment">--*/</span>
00468 
00469 {
00470     <a class="code" href="../../d3/d9/struct__tagREGION__DATA.html">PREGION_DATA</a> CreateData = Region-&gt;Reserved;
00471     LARGE_INTEGER CSize,CStart;
00472     LARGE_INTEGER Mod;
00473     ULONG  bpc = <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Region-&gt;Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o4">BytesPerCylinder</a>;
00474     ULONG  bpt = <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Region-&gt;Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o5">BytesPerTrack</a>;
00475 
00476     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(Region-&gt;SysID == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>);
00477 
00478     <span class="comment">//</span>
00479     <span class="comment">// If we are creating a partition at offset 0, adjust the aligned region</span>
00480     <span class="comment">// offset and the aligned region size, because no partition can actually</span>
00481     <span class="comment">// start at offset 0.</span>
00482     <span class="comment">//</span>
00483 
00484     <span class="keywordflow">if</span>(CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o1">AlignedRegionOffset</a>.QuadPart == 0) {
00485 
00486         LARGE_INTEGER Delta;
00487 
00488         <span class="keywordflow">if</span>(Type == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a68">REGION_EXTENDED</a>) {
00489 
00490             Delta.QuadPart = bpc;
00491 
00492         } <span class="keywordflow">else</span> {
00493 
00494             <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(Type == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a67">REGION_PRIMARY</a>);
00495             Delta.QuadPart = bpt;
00496         }
00497 
00498         CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o1">AlignedRegionOffset</a> = Delta;
00499         CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o2">AlignedRegionSize</a>.QuadPart = (CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o2">AlignedRegionSize</a>.QuadPart - Delta.QuadPart);
00500     }
00501 
00502     CStart = CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o1">AlignedRegionOffset</a>;
00503     <span class="keywordflow">if</span>(MinimumSize.QuadPart == 0) {
00504         CSize.QuadPart = UInt32x32To64(CreationSizeMB,<a class="code" href="../../d4/d9/arcinst_8h.html#a26">ONE_MEG</a>);
00505     } <span class="keywordflow">else</span> {
00506         CSize = MinimumSize;
00507         <span class="keywordflow">if</span>(Type == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>) {
00508             CSize.QuadPart = CSize.QuadPart + bpt;
00509         }
00510     }
00511 
00512     <span class="comment">//</span>
00513     <span class="comment">// Decide whether to align the ending cylinder up or down.</span>
00514     <span class="comment">// If the offset of end of the partition is more than half way into the</span>
00515     <span class="comment">// final cylinder, align towrds the disk end.  Otherwise align toward</span>
00516     <span class="comment">// the disk start.</span>
00517     <span class="comment">//</span>
00518 
00519     Mod.QuadPart = (CStart.QuadPart + CSize.QuadPart) % bpc;
00520 
00521     <span class="keywordflow">if</span>(Mod.QuadPart != 0) {
00522 
00523         <span class="keywordflow">if</span>((MinimumSize.QuadPart != 0) || (Mod.QuadPart &gt; bpc/2)) {
00524             CSize.QuadPart = (CSize.QuadPart + (bpc - Mod.QuadPart));
00525         } <span class="keywordflow">else</span> {
00526             CSize.QuadPart = (CSize.QuadPart - Mod.QuadPart);        <span class="comment">// snap downwards tp cyl boundary</span>
00527         }
00528     }
00529 
00530     <span class="keywordflow">if</span>(CSize.QuadPart &gt; CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o2">AlignedRegionSize</a>.QuadPart) {
00531 
00532         <span class="comment">//</span>
00533         <span class="comment">// Space available in the free space isn't large enough to accomodate</span>
00534         <span class="comment">// the request in its entirety;  just use the entire free space.</span>
00535         <span class="comment">//</span>
00536 
00537         CSize  = CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o2">AlignedRegionSize</a>;
00538     }
00539 
00540     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(CStart.QuadPart != 0);
00541     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(CSize.QuadPart != 0);
00542 
00543     *CreationStart = CStart;
00544     *CreationSize  = CSize;
00545 }
00546 
00547 
00548 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00549"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a33">00549</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a33">CreatePartitionEx</a>(
00550     IN <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Region,
00551     IN LARGE_INTEGER      MinimumSize,
00552     IN ULONG              CreationSizeMB,
00553     IN REGION_TYPE        Type,
00554     IN UCHAR              SysId
00555     )
00556 
00557 <span class="comment">/*++</span>
00558 <span class="comment"></span>
00559 <span class="comment">Routine Description:</span>
00560 <span class="comment"></span>
00561 <span class="comment">    This routine creates a partition from a free region on the disk.  The</span>
00562 <span class="comment">    partition is always created at the beginning of the free space, and any</span>
00563 <span class="comment">    left over space at the end is kept on the free space list.</span>
00564 <span class="comment"></span>
00565 <span class="comment">Arguments:</span>
00566 <span class="comment"></span>
00567 <span class="comment">    Region  - a region descriptor returned by GetDiskRegions().  Must</span>
00568 <span class="comment">              be an unused region.</span>
00569 <span class="comment"></span>
00570 <span class="comment">    CreationSizeMB - size of partition to create, in MB.</span>
00571 <span class="comment"></span>
00572 <span class="comment">    Type    - REGION_PRIMARY, REGION_EXTENDED, or REGION_LOGICAL, for</span>
00573 <span class="comment">              creating a primary partition, extended pasrtition, or</span>
00574 <span class="comment">              logical volume, respectively.</span>
00575 <span class="comment"></span>
00576 <span class="comment">    SysId - system ID byte to be assigned to the partition</span>
00577 <span class="comment"></span>
00578 <span class="comment">Return Value:</span>
00579 <span class="comment"></span>
00580 <span class="comment">    OK_STATUS or error code.</span>
00581 <span class="comment"></span>
00582 <span class="comment">--*/</span>
00583 
00584 {
00585     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>    p1,p2,p3;
00586     <a class="code" href="../../d3/d9/struct__tagREGION__DATA.html">PREGION_DATA</a>  CreateData = Region-&gt;Reserved;
00587     LARGE_INTEGER CreationStart,CreationSize,LeftOver;
00588     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>   *PartitionList;
00589 
00590     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(Region-&gt;SysID == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>);
00591 
00592     <a class="code" href="../../d8/d1/fdengine_8c.html#a32">DetermineCreateSizeAndOffset</a>( Region,
00593                                   MinimumSize,
00594                                   CreationSizeMB,
00595                                   Type,
00596                                   &amp;CreationStart,
00597                                   &amp;CreationSize
00598                                 );
00599 
00600     <span class="comment">//</span>
00601     <span class="comment">// now we've got the start and size of the partition to be created.</span>
00602     <span class="comment">// If there's left-over at the beginning of the free space (after</span>
00603     <span class="comment">// alignment), make a new PARTITION structure.</span>
00604 
00605     p1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00606     LeftOver.QuadPart = (CreationStart.QuadPart - CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>.QuadPart);
00607 
00608     <span class="keywordflow">if</span>(LeftOver.QuadPart &gt; 0) {
00609 
00610         p1 = <a class="code" href="../../d8/d1/fdengine_8c.html#a29">AllocatePartitionStructure</a>(Region-&gt;Disk,
00611                                         CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>,
00612                                         LeftOver,
00613                                         <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>,
00614                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00615                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00616                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00617                                        );
00618         <span class="keywordflow">if</span>(p1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00619             <a class="code" href="../../d4/d9/arcinst_8h.html#a24">RETURN_OUT_OF_MEMORY</a>;
00620         }
00621     }
00622 
00623     <span class="comment">// make a new partition structure for space being left free as</span>
00624     <span class="comment">// a result of this creation.</span>
00625 
00626     p2 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00627     LeftOver.QuadPart = (CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>.QuadPart + CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o3">Length</a>.QuadPart) -
00628                         (CreationStart.QuadPart + CreationSize.QuadPart);
00629 
00630     <span class="keywordflow">if</span>(LeftOver.QuadPart != 0) {
00631 
00632         LARGE_INTEGER   TmpResult;
00633 
00634         TmpResult.QuadPart = CreationStart.QuadPart + CreationSize.QuadPart;
00635         p2 = <a class="code" href="../../d8/d1/fdengine_8c.html#a29">AllocatePartitionStructure</a>(Region-&gt;Disk,
00636                                         TmpResult,
00637                                         LeftOver,
00638                                         <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>,
00639                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00640                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00641                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00642                                        );
00643         <span class="keywordflow">if</span>(p2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00644             <a class="code" href="../../d4/d9/arcinst_8h.html#a24">RETURN_OUT_OF_MEMORY</a>;
00645         }
00646     }
00647 
00648     <span class="comment">// adjust the free partition's fields.</span>
00649 
00650     CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a> = CreationStart;
00651     CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o3">Length</a> = CreationSize;
00652     CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a>  = SysId;
00653     CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00654     CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o10">Recognized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00655 
00656     <span class="comment">// if we just created an extended partition, show the whole thing</span>
00657     <span class="comment">// as one free logical region.</span>
00658 
00659     <span class="keywordflow">if</span>(Type == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a68">REGION_EXTENDED</a>) {
00660 
00661         <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Region-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o4">Disk</a>] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00662 
00663         p3 = <a class="code" href="../../d8/d1/fdengine_8c.html#a29">AllocatePartitionStructure</a>(Region-&gt;Disk,
00664                                         CreationStart,
00665                                         CreationSize,
00666                                         <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>,
00667                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00668                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00669                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00670                                        );
00671         <span class="keywordflow">if</span>(p3 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00672             <a class="code" href="../../d4/d9/arcinst_8h.html#a24">RETURN_OUT_OF_MEMORY</a>;
00673         }
00674         <a class="code" href="../../d8/d1/fdengine_8c.html#a39">AddPartitionToLinkedList</a>(&amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Region-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o4">Disk</a>],p3);
00675     }
00676 
00677     PartitionList = (Type == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>)
00678                   ? &amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Region-&gt;Disk]
00679                   : &amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>[Region-&gt;Disk];
00680 
00681     <span class="keywordflow">if</span>(p1) {
00682         <a class="code" href="../../d8/d1/fdengine_8c.html#a39">AddPartitionToLinkedList</a>(PartitionList,p1);
00683     }
00684     <span class="keywordflow">if</span>(p2) {
00685         <a class="code" href="../../d8/d1/fdengine_8c.html#a39">AddPartitionToLinkedList</a>(PartitionList,p2);
00686     }
00687 
00688     <a class="code" href="../../d8/d1/fdengine_8c.html#a25">MergeFreePartitions</a>(*PartitionList);
00689     <a class="code" href="../../d8/d1/fdengine_8c.html#a40">RenumberPartitions</a>(Region-&gt;Disk);
00690 
00691     <a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>[Region-&gt;Disk] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00692 
00693     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
00694 }
00695 
00696 
00697 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00698"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a34">00698</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a34">CreatePartition</a>(
00699     IN <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Region,
00700     IN ULONG              CreationSizeMB,
00701     IN REGION_TYPE        Type
00702     )
00703 {
00704     LARGE_INTEGER   LargeZero;
00705 
00706     LargeZero.QuadPart = 0;
00707     <span class="keywordflow">return</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a33">CreatePartitionEx</a>(Region,
00708                              LargeZero,
00709                              CreationSizeMB,
00710                              Type,
00711                              (UCHAR)((Type == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a68">REGION_EXTENDED</a>) ? <a class="code" href="../../d4/d9/arcinst_8h.html#a176a71">SYSID_EXTENDED</a>
00712                                                                : <a class="code" href="../../d4/d9/arcinst_8h.html#a176a72">SYSID_BIGFAT</a>
00713                                     )
00714                             )
00715           );
00716 }
00717 
00718 
00719 
00720 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00721"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a35">00721</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a35">DeletePartition</a>(
00722     IN <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Region
00723     )
00724 
00725 <span class="comment">/*++</span>
00726 <span class="comment"></span>
00727 <span class="comment">Routine Description:</span>
00728 <span class="comment"></span>
00729 <span class="comment">    This routine deletes a partition, returning its space to the</span>
00730 <span class="comment">    free space on the disk.  If deleting the extended partition,</span>
00731 <span class="comment">    all logical volumes within it are also deleted.</span>
00732 <span class="comment"></span>
00733 <span class="comment">Arguments:</span>
00734 <span class="comment"></span>
00735 <span class="comment">    Region  - a region descriptor returned by GetDiskRegions().  Must</span>
00736 <span class="comment">              be a used region.</span>
00737 <span class="comment"></span>
00738 <span class="comment">Return Value:</span>
00739 <span class="comment"></span>
00740 <span class="comment">    OK_STATUS or error code.</span>
00741 <span class="comment"></span>
00742 <span class="comment">--*/</span>
00743 
00744 {
00745     <a class="code" href="../../d3/d9/struct__tagREGION__DATA.html">PREGION_DATA</a>  RegionData = Region-&gt;Reserved;
00746     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>   *PartitionList;
00747 
00748     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(    <a class="code" href="../../d8/d1/fdengine_8c.html#a21">IsInPartitionList</a>(Region-&gt;Disk,RegionData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>)
00749           || <a class="code" href="../../d8/d1/fdengine_8c.html#a20">IsInLogicalList</a>  (Region-&gt;Disk,RegionData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>)
00750         );
00751 
00752     <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(Region-&gt;SysID)) {
00753 
00754         <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a21">IsInPartitionList</a>(Region-&gt;Disk,RegionData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>));
00755 
00756         <span class="comment">// Deleting extended partition.  Also delete all logical volumes.</span>
00757 
00758         <a class="code" href="../../d8/d1/fdengine_8c.html#a45">FreeLinkedPartitionList</a>(&amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Region-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o4">Disk</a>]);
00759     }
00760 
00761     RegionData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a>  = <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>;
00762     RegionData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00763     RegionData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o9">Active</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00764     RegionData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o5">OriginalPartitionNumber</a> = 0;
00765 
00766     PartitionList = (Region-&gt;RegionType == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>)
00767                   ? &amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Region-&gt;Disk]
00768                   : &amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>[Region-&gt;Disk];
00769 
00770     <a class="code" href="../../d8/d1/fdengine_8c.html#a25">MergeFreePartitions</a>(*PartitionList);
00771     <a class="code" href="../../d8/d1/fdengine_8c.html#a40">RenumberPartitions</a>(Region-&gt;Disk);
00772 
00773     <a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>[Region-&gt;Disk] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00774 
00775     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
00776 }
00777 
00778 
00779 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00780"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a36">00780</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a36">GetDiskRegions</a>(
00781     IN  ULONG               Disk,
00782     IN  BOOLEAN             WantUsedRegions,
00783     IN  BOOLEAN             WantFreeRegions,
00784     IN  BOOLEAN             WantPrimaryRegions,
00785     IN  BOOLEAN             WantLogicalRegions,
00786     OUT <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> *Region,
00787     OUT ULONG              *RegionCount
00788     )
00789 
00790 <span class="comment">/*++</span>
00791 <span class="comment"></span>
00792 <span class="comment">Routine Description:</span>
00793 <span class="comment"></span>
00794 <span class="comment">    This routine returns an array of region descriptors to the caller.</span>
00795 <span class="comment">    A region desscriptor describes a space on the disk, either used</span>
00796 <span class="comment">    or free.  The caller can control which type of regions are returned.</span>
00797 <span class="comment"></span>
00798 <span class="comment">    The caller must free the returned array via FreeRegionArray().</span>
00799 <span class="comment"></span>
00800 <span class="comment">Arguments:</span>
00801 <span class="comment"></span>
00802 <span class="comment">    Disk            - index of disk whose regions are to be returned</span>
00803 <span class="comment"></span>
00804 <span class="comment">    WantUsedRegions - whether to return used disk regions</span>
00805 <span class="comment"></span>
00806 <span class="comment">    WantFreeRegions - whether to return free disk regions</span>
00807 <span class="comment"></span>
00808 <span class="comment">    WantPrimaryRegions - whether to return regions not in the</span>
00809 <span class="comment">                         extended partition</span>
00810 <span class="comment"></span>
00811 <span class="comment">    WantLogicalRegions - whether to return regions within the</span>
00812 <span class="comment">                         extended partition</span>
00813 <span class="comment"></span>
00814 <span class="comment">    Region          - where to put a pointer to the array of regions</span>
00815 <span class="comment"></span>
00816 <span class="comment">    RegionCount     - where to put the number of items in the returned</span>
00817 <span class="comment">                      Region array</span>
00818 <span class="comment"></span>
00819 <span class="comment">Return Value:</span>
00820 <span class="comment"></span>
00821 <span class="comment">    OK_STATUS or error code.</span>
00822 <span class="comment"></span>
00823 <span class="comment">--*/</span>
00824 
00825 {
00826     *Region = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(0);
00827     *RegionCount = 0;
00828 
00829     <span class="keywordflow">if</span>(WantPrimaryRegions) {
00830         <span class="keywordflow">return</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a16">GetRegions</a>(Disk,
00831                           <a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>[Disk],
00832                           WantUsedRegions,
00833                           WantFreeRegions,
00834                           WantLogicalRegions,
00835                           Region,
00836                           RegionCount,
00837                           <a class="code" href="../../d4/d9/arcinst_8h.html#a175a67">REGION_PRIMARY</a>
00838                          )
00839               );
00840     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(WantLogicalRegions) {
00841         <span class="keywordflow">return</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a16">GetRegions</a>(Disk,
00842                           <a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Disk],
00843                           WantUsedRegions,
00844                           WantFreeRegions,
00845                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00846                           Region,
00847                           RegionCount,
00848                           <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>
00849                          )
00850               );
00851     }
00852     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
00853 }
00854 
00855 
00856 <span class="comment">// workers for GetDiskRegions</span>
00857 
00858 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00859"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a16">00859</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a16">GetRegions</a>(
00860     IN  ULONG               Disk,
00861     IN  <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>          p,
00862     IN  BOOLEAN             WantUsedRegions,
00863     IN  BOOLEAN             WantFreeRegions,
00864     IN  BOOLEAN             WantLogicalRegions,
00865     OUT <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> *Region,
00866     OUT ULONG              *RegionCount,
00867     IN  REGION_TYPE         RegionType
00868     )
00869 {
00870     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>   status;
00871     LARGE_INTEGER AlignedOffset,AlignedSize;
00872     ULONG         SizeMB;
00873 
00874     <span class="keywordflow">while</span>(p) {
00875 
00876         <span class="keywordflow">if</span>(p-&gt;SysID == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) {
00877 
00878             <span class="keywordflow">if</span>(WantFreeRegions) {
00879 
00880                 LARGE_INTEGER   Result1, Result2;
00881 
00882                 AlignedOffset = <a class="code" href="../../d8/d1/fdengine_8c.html#a23">AlignTowardsDiskEnd</a>(p-&gt;Disk,p-&gt;Offset);
00883 
00884                 Result2.QuadPart = p-&gt;Offset.QuadPart + p-&gt;Length.QuadPart;
00885                 Result1 = <a class="code" href="../../d8/d1/fdengine_8c.html#a22">AlignTowardsDiskStart</a>(p-&gt;Disk,Result2);
00886                 AlignedSize.QuadPart   = Result1.QuadPart - AlignedOffset.QuadPart;
00887 
00888                 SizeMB        = <a class="code" href="../../d8/d1/fdengine_8c.html#a50">SIZEMB</a>(AlignedSize);
00889 
00890 
00891                 <span class="comment">//</span>
00892                 <span class="comment">// Show the space free if it is greater than 1 meg, AND</span>
00893                 <span class="comment">// it is not a space starting at the beginning of the disk</span>
00894                 <span class="comment">// and of length &lt;= 1 cylinder.</span>
00895                 <span class="comment">// This prevents the user from seeing the first cylinder</span>
00896                 <span class="comment">// of the disk as free (could otherwise happen with an</span>
00897                 <span class="comment">// extended partition starting on cylinder 1 and cylinders</span>
00898                 <span class="comment">// of 1 megabyte or larger).</span>
00899                 <span class="comment">//</span>
00900 
00901                 <span class="keywordflow">if</span>(    (AlignedSize.QuadPart &gt; 0)
00902                     &amp;&amp; SizeMB
00903                     &amp;&amp; (    (p-&gt;Offset.QuadPart != 0)
00904                          || ( p-&gt;Length.QuadPart &gt;
00905                               <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[p-&gt;Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o4">BytesPerCylinder</a> )
00906                        )
00907                   )
00908                 {
00909                     <span class="keywordflow">if</span>(!<a class="code" href="../../d8/d1/fdengine_8c.html#a37">AddRegionEntry</a>(Region,
00910                                        RegionCount,
00911                                        SizeMB,
00912                                        RegionType,
00913                                        p,
00914                                        AlignedOffset,
00915                                        AlignedSize
00916                                       ))
00917                     {
00918                         <a class="code" href="../../d4/d9/arcinst_8h.html#a24">RETURN_OUT_OF_MEMORY</a>;
00919                     }
00920                 }
00921             }
00922         } <span class="keywordflow">else</span> {
00923 
00924             <span class="keywordflow">if</span>(WantUsedRegions) {
00925 
00926                 AlignedOffset = p-&gt;Offset;
00927                 AlignedSize   = p-&gt;Length;
00928                 SizeMB        = <a class="code" href="../../d8/d1/fdengine_8c.html#a50">SIZEMB</a>(AlignedSize);
00929 
00930                 <span class="keywordflow">if</span>(!<a class="code" href="../../d8/d1/fdengine_8c.html#a37">AddRegionEntry</a>(Region,
00931                                    RegionCount,
00932                                    SizeMB,
00933                                    RegionType,
00934                                    p,
00935                                    AlignedOffset,
00936                                    AlignedSize
00937                                   ))
00938                 {
00939                     <a class="code" href="../../d4/d9/arcinst_8h.html#a24">RETURN_OUT_OF_MEMORY</a>;
00940                 }
00941             }
00942 
00943             <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(p-&gt;SysID) &amp;&amp; WantLogicalRegions) {
00944                 status = <a class="code" href="../../d8/d1/fdengine_8c.html#a16">GetRegions</a>(Disk,
00945                                     <a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Disk],
00946                                     WantUsedRegions,
00947                                     WantFreeRegions,
00948                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00949                                     Region,
00950                                     RegionCount,
00951                                     <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>
00952                                    );
00953                 <span class="keywordflow">if</span>(status != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
00954                     <span class="keywordflow">return</span>(status);
00955                 }
00956             }
00957         }
00958         p = p-&gt;Next;
00959     }
00960     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
00961 }
00962 
00963 
00964 BOOLEAN
<a name="l00965"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a37">00965</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a37">AddRegionEntry</a>(
00966     OUT <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> *Regions,
00967     OUT ULONG              *RegionCount,
00968     IN  ULONG               SizeMB,
00969     IN  REGION_TYPE         RegionType,
00970     IN  <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>          Partition,
00971     IN  LARGE_INTEGER       AlignedRegionOffset,
00972     IN  LARGE_INTEGER       AlignedRegionSize
00973     )
00974 {
00975     <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> p;
00976     <a class="code" href="../../d3/d9/struct__tagREGION__DATA.html">PREGION_DATA</a>       data;
00977 
00978     p = <a class="code" href="../../d4/d9/arcinst_8h.html#a21">ReallocateMemory</a>(*Regions,((*RegionCount) + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">REGION_DESCRIPTOR</a>));
00979     <span class="keywordflow">if</span>(p == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00980         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00981     } <span class="keywordflow">else</span> {
00982         *Regions = p;
00983         (*RegionCount)++;
00984     }
00985 
00986     p = &amp;(*Regions)[(*RegionCount)-1];
00987 
00988     <span class="keywordflow">if</span>(!(p-&gt;<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o9">Reserved</a> = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html">REGION_DATA</a>)))) {
00989         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00990     }
00991 
00992     p-&gt;<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o1">Disk</a>                    = Partition-&gt;Disk;
00993     p-&gt;<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o8">SysID</a>                   = Partition-&gt;SysID;
00994     p-&gt;<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o2">SizeMB</a>                  = SizeMB;
00995     p-&gt;<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o6">Active</a>                  = Partition-&gt;Active;
00996     p-&gt;<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o7">Recognized</a>              = Partition-&gt;Recognized;
00997     p-&gt;<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o3">PartitionNumber</a>         = Partition-&gt;PartitionNumber;
00998     p-&gt;<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o4">OriginalPartitionNumber</a> = Partition-&gt;OriginalPartitionNumber;
00999     p-&gt;<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o5">RegionType</a>              = RegionType;
01000     p-&gt;<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o0">PersistentData</a>          = Partition-&gt;PersistentData;
01001 
01002     data = p-&gt;<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o9">Reserved</a>;
01003 
01004     data-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o0">Partition</a>             = Partition;
01005     data-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o1">AlignedRegionOffset</a>   = AlignedRegionOffset;
01006     data-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o2">AlignedRegionSize</a>     = AlignedRegionSize;
01007 
01008     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01009 }
01010 
01011 
01012 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01013"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a38">01013</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(
01014     IN <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Region,
01015     IN ULONG              RegionCount
01016     )
01017 
01018 <span class="comment">/*++</span>
01019 <span class="comment"></span>
01020 <span class="comment">Routine Description:</span>
01021 <span class="comment"></span>
01022 <span class="comment">    This routine frees a region array returned by GetDiskRegions().</span>
01023 <span class="comment"></span>
01024 <span class="comment">Arguments:</span>
01025 <span class="comment"></span>
01026 <span class="comment">    Region          - pointer to the array of regions to be freed</span>
01027 <span class="comment"></span>
01028 <span class="comment">    RegionCount     - number of items in the Region array</span>
01029 <span class="comment"></span>
01030 <span class="comment">Return Value:</span>
01031 <span class="comment"></span>
01032 <span class="comment">    None.</span>
01033 <span class="comment"></span>
01034 <span class="comment">--*/</span>
01035 
01036 {
01037     ULONG i;
01038 
01039     <span class="keywordflow">for</span>(i=0; i&lt;RegionCount; i++) {
01040 
01041         <span class="keywordflow">if</span>(Region[i].Reserved) {
01042             <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(Region[i].Reserved);
01043         }
01044     }
01045     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(Region);
01046 }
01047 
01048 
01049 
01050 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01051"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a39">01051</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a39">AddPartitionToLinkedList</a>(
01052     IN OUT <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PARTITION</a> **Head,
01053     IN     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PARTITION</a> *p
01054     )
01055 
01056 <span class="comment">/*++</span>
01057 <span class="comment"></span>
01058 <span class="comment">Routine Description:</span>
01059 <span class="comment"></span>
01060 <span class="comment">    This routine adds a PARTITION structure to a doubly-linked</span>
01061 <span class="comment">    list, sorted by the Offset field in ascending order.</span>
01062 <span class="comment"></span>
01063 <span class="comment">Arguments:</span>
01064 <span class="comment"></span>
01065 <span class="comment">    Head    - pointer to pointer to first element in list</span>
01066 <span class="comment"></span>
01067 <span class="comment">    p       - pointer to item to be added to list</span>
01068 <span class="comment"></span>
01069 <span class="comment">Return Value:</span>
01070 <span class="comment"></span>
01071 <span class="comment">    None.</span>
01072 <span class="comment"></span>
01073 <span class="comment">--*/</span>
01074 
01075 {
01076     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PARTITION</a> *cur,*prev;
01077 
01078     <span class="keywordflow">if</span>((cur = *Head) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01079         *Head = p;
01080         <span class="keywordflow">return</span>;
01081     }
01082 
01083     <span class="keywordflow">if</span>(p-&gt;Offset.QuadPart &lt; cur-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>.QuadPart) {
01084         p-&gt;Next = cur;
01085         cur-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o1">Prev</a> = p;
01086         *Head = p;
01087         <span class="keywordflow">return</span>;
01088     }
01089 
01090     prev = *Head;
01091     cur = cur-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
01092 
01093     <span class="keywordflow">while</span>(cur) {
01094         <span class="keywordflow">if</span>(p-&gt;Offset.QuadPart &lt; cur-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>.QuadPart) {
01095 
01096             p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a> = cur;
01097             p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o1">Prev</a> = prev;
01098             prev-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a> = p;
01099             cur-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o1">Prev</a> = p;
01100             <span class="keywordflow">return</span>;
01101         }
01102         prev = cur;
01103         cur = cur-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
01104     }
01105 
01106     prev-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a> = p;
01107     p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o1">Prev</a> = prev;
01108     <span class="keywordflow">return</span>;
01109 }
01110 
01111 
01112 BOOLEAN
<a name="l01113"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a19">01113</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a19">IsInLinkedList</a>(
01114     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p,
01115     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> List
01116     )
01117 
01118 <span class="comment">/*++</span>
01119 <span class="comment"></span>
01120 <span class="comment">Routine Description:</span>
01121 <span class="comment"></span>
01122 <span class="comment">    This routine determines whether a PARTITION element is in</span>
01123 <span class="comment">    a given linked list of PARTITION elements.</span>
01124 <span class="comment"></span>
01125 <span class="comment">Arguments:</span>
01126 <span class="comment"></span>
01127 <span class="comment">    p       - pointer to element to be checked for</span>
01128 <span class="comment"></span>
01129 <span class="comment">    List    - first element in list to be scanned</span>
01130 <span class="comment"></span>
01131 <span class="comment">Return Value:</span>
01132 <span class="comment"></span>
01133 <span class="comment">    true if p found in List, false otherwise</span>
01134 <span class="comment"></span>
01135 <span class="comment">--*/</span>
01136 
01137 {
01138     <span class="keywordflow">while</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) {
01139         <span class="keywordflow">if</span>(p == <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) {
01140             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01141         }
01142         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Next;
01143     }
01144     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01145 }
01146 
01147 
01148 BOOLEAN
<a name="l01149"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a20">01149</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a20">IsInLogicalList</a>(
01150     IN ULONG      Disk,
01151     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p
01152     )
01153 
01154 <span class="comment">/*++</span>
01155 <span class="comment"></span>
01156 <span class="comment">Routine Description:</span>
01157 <span class="comment"></span>
01158 <span class="comment">    This routine determines whether a PARTITION element is in</span>
01159 <span class="comment">    the logical volume list for a given disk.</span>
01160 <span class="comment"></span>
01161 <span class="comment">Arguments:</span>
01162 <span class="comment"></span>
01163 <span class="comment">    Disk    - index of disk to be checked</span>
01164 <span class="comment"></span>
01165 <span class="comment">    p       - pointer to element to be checked for</span>
01166 <span class="comment"></span>
01167 <span class="comment">Return Value:</span>
01168 <span class="comment"></span>
01169 <span class="comment">    true if p found in Disk's logical volume list, false otherwise</span>
01170 <span class="comment"></span>
01171 <span class="comment">--*/</span>
01172 
01173 {
01174     <span class="keywordflow">return</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a19">IsInLinkedList</a>(p,<a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Disk]));
01175 }
01176 
01177 
01178 BOOLEAN
<a name="l01179"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a21">01179</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a21">IsInPartitionList</a>(
01180     IN ULONG      Disk,
01181     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p
01182     )
01183 
01184 <span class="comment">/*++</span>
01185 <span class="comment"></span>
01186 <span class="comment">Routine Description:</span>
01187 <span class="comment"></span>
01188 <span class="comment">    This routine determines whether a PARTITION element is in</span>
01189 <span class="comment">    the primary partition list for a given disk.</span>
01190 <span class="comment"></span>
01191 <span class="comment">Arguments:</span>
01192 <span class="comment"></span>
01193 <span class="comment">    Disk    - index of disk to be checked</span>
01194 <span class="comment"></span>
01195 <span class="comment">    p       - pointer to element to be checked for</span>
01196 <span class="comment"></span>
01197 <span class="comment">Return Value:</span>
01198 <span class="comment"></span>
01199 <span class="comment">    true if p found in Disk's primary partition list, false otherwise</span>
01200 <span class="comment"></span>
01201 <span class="comment">--*/</span>
01202 
01203 {
01204     <span class="keywordflow">return</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a19">IsInLinkedList</a>(p,<a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>[Disk]));
01205 }
01206 
01207 
01208 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01209"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a25">01209</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a25">MergeFreePartitions</a>(
01210     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p
01211     )
01212 
01213 <span class="comment">/*++</span>
01214 <span class="comment"></span>
01215 <span class="comment">Routine Description:</span>
01216 <span class="comment"></span>
01217 <span class="comment">    This routine merges adjacent free space elements in the</span>
01218 <span class="comment">    given linked list of PARTITION elements.  It is designed</span>
01219 <span class="comment">    to be called after adding or deleting a partition.</span>
01220 <span class="comment"></span>
01221 <span class="comment">Arguments:</span>
01222 <span class="comment"></span>
01223 <span class="comment">    p - pointer to first item in list whose free elements are to</span>
01224 <span class="comment">        be merged.</span>
01225 <span class="comment"></span>
01226 <span class="comment">Return Value:</span>
01227 <span class="comment"></span>
01228 <span class="comment">    None.</span>
01229 <span class="comment"></span>
01230 <span class="comment">--*/</span>
01231 
01232 {
01233     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> next;
01234 
01235     <span class="keywordflow">while</span>(p &amp;&amp; p-&gt;Next) {
01236 
01237         <span class="keywordflow">if</span>((p-&gt;SysID == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) &amp;&amp; (p-&gt;Next-&gt;SysID == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>)) {
01238 
01239             next = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
01240 
01241             p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o3">Length</a>.QuadPart = (next-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>.QuadPart + next-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o3">Length</a>.QuadPart) - p-&gt;Offset.QuadPart;
01242 
01243             <span class="keywordflow">if</span>(p-&gt;Next = next-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>) {
01244                 next-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o1">Prev</a> = p;
01245             }
01246 
01247             <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(next);
01248 
01249         } <span class="keywordflow">else</span> {
01250             p = p-&gt;Next;
01251         }
01252     }
01253 }
01254 
01255 
01256 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01257"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a40">01257</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a40">RenumberPartitions</a>(
01258     IN ULONG Disk
01259     )
01260 
01261 <span class="comment">/*++</span>
01262 <span class="comment"></span>
01263 <span class="comment">Routine Description:</span>
01264 <span class="comment"></span>
01265 <span class="comment">    This routine determines the partition number for each region</span>
01266 <span class="comment">    on a disk.  For a used region, the partition number is the number</span>
01267 <span class="comment">    that the system will assign to the partition.  All partitions</span>
01268 <span class="comment">    (except the extended partition) are numbered first starting at 1,</span>
01269 <span class="comment">    and then all logical volumes in the extended partition.</span>
01270 <span class="comment">    For a free region, the partition number is the number that the</span>
01271 <span class="comment">    system WOULD assign to the partition if the space were to be</span>
01272 <span class="comment">    converted to a partition and all other regions on the disk were</span>
01273 <span class="comment">    left as is.</span>
01274 <span class="comment"></span>
01275 <span class="comment">    The partition numbers are stored in the PARTITION elements.</span>
01276 <span class="comment"></span>
01277 <span class="comment">Arguments:</span>
01278 <span class="comment"></span>
01279 <span class="comment">    Disk - index of disk whose partitions are to be renumbered.</span>
01280 <span class="comment"></span>
01281 <span class="comment">Return Value:</span>
01282 <span class="comment"></span>
01283 <span class="comment">    None.</span>
01284 <span class="comment"></span>
01285 <span class="comment">--*/</span>
01286 
01287 {
01288     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p = <a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>[Disk];
01289     ULONG      <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = 1;
01290 
01291     <span class="keywordflow">while</span>(p) {
01292         <span class="keywordflow">if</span>(!<a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a>)) {
01293             p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o6">PartitionNumber</a> = <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
01294             <span class="keywordflow">if</span>(p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a> != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) {
01295                 <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>++;
01296             }
01297         }
01298         p = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
01299     }
01300     p = <a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Disk];
01301     <span class="keywordflow">while</span>(p) {
01302         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o6">PartitionNumber</a> = <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
01303         <span class="keywordflow">if</span>(p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a> != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) {
01304             <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>++;
01305         }
01306         p = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
01307     }
01308 }
01309 
01310 
01311 <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>
<a name="l01312"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a41">01312</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a41">FindPartitionElement</a>(
01313     IN ULONG Disk,
01314     IN ULONG Partition
01315     )
01316 
01317 <span class="comment">/*++</span>
01318 <span class="comment"></span>
01319 <span class="comment">Routine Description:</span>
01320 <span class="comment"></span>
01321 <span class="comment">    This routine locates a PARTITION element for a disk/partition</span>
01322 <span class="comment">    number pair.  The partition number is the number that the</span>
01323 <span class="comment">    system assigns to the partition.</span>
01324 <span class="comment"></span>
01325 <span class="comment">Arguments:</span>
01326 <span class="comment"></span>
01327 <span class="comment">    Disk - index of relevent disk</span>
01328 <span class="comment"></span>
01329 <span class="comment">    Partition - partition number of partition to find</span>
01330 <span class="comment"></span>
01331 <span class="comment">Return Value:</span>
01332 <span class="comment"></span>
01333 <span class="comment">    pointer to PARTITION element, or NULL if not found.</span>
01334 <span class="comment"></span>
01335 <span class="comment">--*/</span>
01336 
01337 {
01338     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p;
01339 
01340     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(Partition);
01341 
01342     p = <a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>[Disk];
01343     <span class="keywordflow">while</span>(p) {
01344         <span class="keywordflow">if</span>((p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a> != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>)
01345         &amp;&amp; !<a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a>)
01346         &amp;&amp; (p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o6">PartitionNumber</a> == Partition))
01347         {
01348             <span class="keywordflow">return</span>(p);
01349         }
01350         p = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
01351     }
01352     p = <a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Disk];
01353     <span class="keywordflow">while</span>(p) {
01354         <span class="keywordflow">if</span>((p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a> != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>)
01355         &amp;&amp; (p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o6">PartitionNumber</a> == Partition))
01356         {
01357             <span class="keywordflow">return</span>(p);
01358         }
01359         p = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
01360     }
01361     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01362 }
01363 
01364 
01365 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01366"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a42">01366</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a42">SetSysID</a>(
01367     IN ULONG Disk,
01368     IN ULONG Partition,
01369     IN UCHAR SysID
01370     )
01371 
01372 <span class="comment">/*++</span>
01373 <span class="comment"></span>
01374 <span class="comment">Routine Description:</span>
01375 <span class="comment"></span>
01376 <span class="comment">    This routine sets the system id of the given partition</span>
01377 <span class="comment">    on the given disk.</span>
01378 <span class="comment"></span>
01379 <span class="comment">Arguments:</span>
01380 <span class="comment"></span>
01381 <span class="comment">    Disk - index of relevent disk</span>
01382 <span class="comment"></span>
01383 <span class="comment">    Partition - partition number of relevent partition</span>
01384 <span class="comment"></span>
01385 <span class="comment">    SysID - new system ID for Partition on Disk</span>
01386 <span class="comment"></span>
01387 <span class="comment">Return Value:</span>
01388 <span class="comment"></span>
01389 <span class="comment">    None.</span>
01390 <span class="comment"></span>
01391 <span class="comment">--*/</span>
01392 
01393 {
01394     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p = <a class="code" href="../../d8/d1/fdengine_8c.html#a41">FindPartitionElement</a>(Disk,Partition);
01395 
01396     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(p);
01397 
01398     <span class="keywordflow">if</span>(p) {
01399         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a> = SysID;
01400         <span class="keywordflow">if</span>(!p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a>) {
01401             p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a> = <a class="code" href="../../d8/d1/fdengine_8c.html#a1">CHANGED_DONT_ZAP</a>;
01402         }
01403         <a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>[p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o4">Disk</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01404     }
01405 }
01406 
01407 
01408 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01409"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a43">01409</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a43">SetSysID2</a>(
01410     IN <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Region,
01411     IN UCHAR              SysID
01412     )
01413 {
01414     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p = ((<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html">PREGION_DATA</a>)(Region-&gt;Reserved))-&gt;Partition;
01415 
01416     p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a> = SysID;
01417     <span class="keywordflow">if</span>(!p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a>) {
01418         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a> = <a class="code" href="../../d8/d1/fdengine_8c.html#a1">CHANGED_DONT_ZAP</a>;
01419     }
01420     <a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>[p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o4">Disk</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01421 }
01422 
01423 
01424 ULONG
<a name="l01425"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a44">01425</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a44">GetHiddenSectorCount</a>(
01426     IN ULONG Disk,
01427     IN ULONG Partition
01428     )
01429 
01430 <span class="comment">/*++</span>
01431 <span class="comment"></span>
01432 <span class="comment">Routine Description:</span>
01433 <span class="comment"></span>
01434 <span class="comment">    This routine determines the hidden sector count for a</span>
01435 <span class="comment">    partition.  This value is used by format and is placed in</span>
01436 <span class="comment">    the BPB of a FAT partition when the partition is formatted.</span>
01437 <span class="comment"></span>
01438 <span class="comment">Arguments:</span>
01439 <span class="comment"></span>
01440 <span class="comment">    Disk - index of relevent disk</span>
01441 <span class="comment"></span>
01442 <span class="comment">    Partition - partition number of relevent partition</span>
01443 <span class="comment"></span>
01444 <span class="comment">Return Value:</span>
01445 <span class="comment"></span>
01446 <span class="comment">    The number of hidden sectors (will be 0 if the partition</span>
01447 <span class="comment">    does not exist).</span>
01448 <span class="comment"></span>
01449 <span class="comment">--*/</span>
01450 
01451 {
01452     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p = <a class="code" href="../../d8/d1/fdengine_8c.html#a41">FindPartitionElement</a>(Disk,Partition);
01453     ULONG      HiddenSectorCount = 0;
01454     LARGE_INTEGER   Result;
01455 
01456     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(p);
01457 
01458     <span class="keywordflow">if</span>(p) {
01459 
01460         <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a20">IsInLogicalList</a>(Disk,p)) {
01461             HiddenSectorCount = <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o2">SectorsPerTrack</a>;
01462         } <span class="keywordflow">else</span> {
01463             <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a21">IsInPartitionList</a>(Disk,p));
01464             Result.QuadPart = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>.QuadPart / <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o3">BytesPerSector</a>;
01465             HiddenSectorCount = <a class="code" href="../../d4/d9/arcinst_8h.html#a25">LOWPART</a>(Result);
01466         }
01467     }
01468     <span class="keywordflow">return</span>(HiddenSectorCount);
01469 }
01470 
01471 
01472 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01473"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a45">01473</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a45">FreeLinkedPartitionList</a>(
01474     IN OUT <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> *q
01475     )
01476 
01477 <span class="comment">/*++</span>
01478 <span class="comment"></span>
01479 <span class="comment">Routine Description:</span>
01480 <span class="comment"></span>
01481 <span class="comment">    This routine frees a linked list of PARTITION elements. The head</span>
01482 <span class="comment">    pointer is set to NULL.</span>
01483 <span class="comment"></span>
01484 <span class="comment">Arguments:</span>
01485 <span class="comment"></span>
01486 <span class="comment">    p - pointer to pointer to first element of list to free.</span>
01487 <span class="comment"></span>
01488 <span class="comment">Return Value:</span>
01489 <span class="comment"></span>
01490 <span class="comment">    None.</span>
01491 <span class="comment"></span>
01492 <span class="comment">--*/</span>
01493 
01494 {
01495     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PARTITION</a> *<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
01496     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PARTITION</a> *p = *q;
01497 
01498     <span class="keywordflow">while</span>(p) {
01499         <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
01500         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(p);
01501         p = <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
01502     }
01503     *q = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01504 }
01505 
01506 
01507 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01508"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a46">01508</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a46">FreePartitionInfoLinkedLists</a>(
01509     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> *ListHeadArray
01510     )
01511 
01512 <span class="comment">/*++</span>
01513 <span class="comment"></span>
01514 <span class="comment">Routine Description:</span>
01515 <span class="comment"></span>
01516 <span class="comment">    This routine frees the linked lists of PARTITION elements</span>
01517 <span class="comment">    for each disk.</span>
01518 <span class="comment"></span>
01519 <span class="comment">Arguments:</span>
01520 <span class="comment"></span>
01521 <span class="comment">    ListHeadArray - pointer to array of pointers to first elements of</span>
01522 <span class="comment">                    PARTITION element lists.</span>
01523 <span class="comment"></span>
01524 <span class="comment">Return Value:</span>
01525 <span class="comment"></span>
01526 <span class="comment">    None.</span>
01527 <span class="comment"></span>
01528 <span class="comment">--*/</span>
01529 
01530 {
01531     ULONG i;
01532 
01533     <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a>; i++) {
01534 
01535         <a class="code" href="../../d8/d1/fdengine_8c.html#a45">FreeLinkedPartitionList</a>(&amp;ListHeadArray[i]);
01536     }
01537 }
01538 
01539 
01540 <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>
<a name="l01541"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a29">01541</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a29">AllocatePartitionStructure</a>(
01542     IN ULONG         Disk,
01543     IN LARGE_INTEGER Offset,
01544     IN LARGE_INTEGER Length,
01545     IN UCHAR         SysID,
01546     IN BOOLEAN       Update,
01547     IN BOOLEAN       Active,
01548     IN BOOLEAN       Recognized
01549     )
01550 
01551 <span class="comment">/*++</span>
01552 <span class="comment"></span>
01553 <span class="comment">Routine Description:</span>
01554 <span class="comment"></span>
01555 <span class="comment">    This routine allocates space for, and initializes a PARTITION</span>
01556 <span class="comment">    structure.</span>
01557 <span class="comment"></span>
01558 <span class="comment">Arguments:</span>
01559 <span class="comment"></span>
01560 <span class="comment">    Disk    - index of disk, one of whose regions the new PARTITION</span>
01561 <span class="comment">              strucure describes.</span>
01562 <span class="comment"></span>
01563 <span class="comment">    Offset  - byte offset of region on the disk</span>
01564 <span class="comment"></span>
01565 <span class="comment">    Length  - length in bytes of the region</span>
01566 <span class="comment"></span>
01567 <span class="comment">    SysID   - system id of region, of SYSID_UNUSED of this PARTITION</span>
01568 <span class="comment">              is actually a free space.</span>
01569 <span class="comment"></span>
01570 <span class="comment">    Update  - whether this PARTITION is dirty, ie, has changed and needs</span>
01571 <span class="comment">              to be written to disk.</span>
01572 <span class="comment"></span>
01573 <span class="comment">    Active  - flag for the BootIndicator field in a partition table entry,</span>
01574 <span class="comment">              indicates to the x86 master boot program which partition</span>
01575 <span class="comment">              is active.</span>
01576 <span class="comment"></span>
01577 <span class="comment">    Recognized - whether the partition is a type recognized by NT</span>
01578 <span class="comment"></span>
01579 <span class="comment">Return Value:</span>
01580 <span class="comment"></span>
01581 <span class="comment">    NULL if allocation failed, or new initialized PARTITION strucure.</span>
01582 <span class="comment"></span>
01583 <span class="comment">--*/</span>
01584 
01585 {
01586     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> p = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__tagPARTITION.html">PARTITION</a>));
01587 
01588     <span class="keywordflow">if</span>(p) {
01589         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>                    = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01590         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o1">Prev</a>                    = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01591         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>                  = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01592         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o3">Length</a>                  = Length;
01593         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o4">Disk</a>                    = Disk;
01594         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a>                  = Update;
01595         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o9">Active</a>                  = <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a20">Active</a>;
01596         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o10">Recognized</a>              = Recognized;
01597         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a>                   = SysID;
01598         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o5">OriginalPartitionNumber</a> = 0;
01599         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o6">PartitionNumber</a>         = 0;
01600         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o7">PersistentData</a>          = 0;
01601     }
01602     <span class="keywordflow">return</span>(p);
01603 }
01604 
01605 
01606 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l01607"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a47">01607</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a47">InitializeFreeSpace</a>(
01608     IN ULONG             Disk,
01609     IN <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>       *PartitionList,      <span class="comment">// list the free space goes in</span>
01610     IN LARGE_INTEGER     StartOffset,
01611     IN LARGE_INTEGER     Length
01612     )
01613 
01614 <span class="comment">/*++</span>
01615 <span class="comment"></span>
01616 <span class="comment">Routine Description:</span>
01617 <span class="comment"></span>
01618 <span class="comment">    This routine determines all the free spaces within a given area</span>
01619 <span class="comment">    on a disk, allocates PARTITION structures to describe them,</span>
01620 <span class="comment">    and adds these structures to the relevent partition list</span>
01621 <span class="comment">    (primary partitions or logical volumes).</span>
01622 <span class="comment"></span>
01623 <span class="comment">    No rounding or alignment is performed here.  Spaces of even one</span>
01624 <span class="comment">    byte will be counted and inserted in the partition list.</span>
01625 <span class="comment"></span>
01626 <span class="comment">Arguments:</span>
01627 <span class="comment"></span>
01628 <span class="comment">    Disk    - index of disk whose free spaces are being sought.</span>
01629 <span class="comment"></span>
01630 <span class="comment">    PartitionList - pointer to first element on PARTITION list that</span>
01631 <span class="comment">                    the free spaces will go in.</span>
01632 <span class="comment"></span>
01633 <span class="comment">    StartOffset - start offset of area on disk to consider (ie, 0 for</span>
01634 <span class="comment">                  primary spaces or the first byte of the extended</span>
01635 <span class="comment">                  partition for logical spaces).</span>
01636 <span class="comment"></span>
01637 <span class="comment">    Length - length of area on disk to consider (ie, size of disk</span>
01638 <span class="comment">             for primary spaces or size of extended partition for</span>
01639 <span class="comment">             logical spaces).</span>
01640 <span class="comment"></span>
01641 <span class="comment">Return Value:</span>
01642 <span class="comment"></span>
01643 <span class="comment">    OK_STATUS or error code.</span>
01644 <span class="comment"></span>
01645 <span class="comment">--*/</span>
01646 
01647 {
01648     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>              p = *PartitionList,q;
01649     LARGE_INTEGER           <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01650 
01651     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = StartOffset;
01652 
01653     <span class="keywordflow">while</span>(p) {
01654 
01655         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.QuadPart = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>.QuadPart - <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>.QuadPart;
01656 
01657         <span class="keywordflow">if</span>(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.QuadPart &gt; 0) {
01658 
01659             <span class="keywordflow">if</span>(!(q = <a class="code" href="../../d8/d1/fdengine_8c.html#a29">AllocatePartitionStructure</a>(Disk,
01660                                                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,
01661                                                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
01662                                                 <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>,
01663                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01664                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01665                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01666                                                )
01667                 )
01668               )
01669             {
01670                 <a class="code" href="../../d4/d9/arcinst_8h.html#a24">RETURN_OUT_OF_MEMORY</a>;
01671             }
01672 
01673             <a class="code" href="../../d8/d1/fdengine_8c.html#a39">AddPartitionToLinkedList</a>(PartitionList,q);
01674         }
01675 
01676         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>.QuadPart = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>.QuadPart + p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o3">Length</a>.QuadPart;
01677 
01678         p = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
01679 
01680     }
01681 
01682     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.QuadPart = (StartOffset.QuadPart + Length.QuadPart) - <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>.QuadPart;
01683 
01684     <span class="keywordflow">if</span>(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.QuadPart &gt; 0) {
01685 
01686         <span class="keywordflow">if</span>(!(q = <a class="code" href="../../d8/d1/fdengine_8c.html#a29">AllocatePartitionStructure</a>(Disk,
01687                                             <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,
01688                                             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
01689                                             <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>,
01690                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01691                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01692                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01693                                            )
01694             )
01695           )
01696         {
01697             <a class="code" href="../../d4/d9/arcinst_8h.html#a24">RETURN_OUT_OF_MEMORY</a>;
01698         }
01699 
01700         <a class="code" href="../../d8/d1/fdengine_8c.html#a39">AddPartitionToLinkedList</a>(PartitionList,q);
01701     }
01702 
01703     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
01704 }
01705 
01706 
01707 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l01708"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a48">01708</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a48">InitializeLogicalVolumeList</a>(
01709     IN ULONG                      Disk,
01710     IN PDRIVE_LAYOUT_INFORMATION  DriveLayout,
01711     IN ULONG                      PartitionNumber
01712     )
01713 
01714 <span class="comment">/*++</span>
01715 <span class="comment"></span>
01716 <span class="comment">Routine Description:</span>
01717 <span class="comment"></span>
01718 <span class="comment">    This routine creates the logical volume linked list of</span>
01719 <span class="comment">    PARTITION structures for the given disk.</span>
01720 <span class="comment"></span>
01721 <span class="comment">Arguments:</span>
01722 <span class="comment"></span>
01723 <span class="comment">    Disk    - index of disk</span>
01724 <span class="comment"></span>
01725 <span class="comment">    DriveLayout - pointer to structure describing the raw partition</span>
01726 <span class="comment">                  layout of the disk.</span>
01727 <span class="comment"></span>
01728 <span class="comment">    PartitionNumber - number to assign to the first logical volume</span>
01729 <span class="comment">                      on the disk.</span>
01730 <span class="comment"></span>
01731 <span class="comment">Return Value:</span>
01732 <span class="comment"></span>
01733 <span class="comment">    OK_STATUS or error code.</span>
01734 <span class="comment"></span>
01735 <span class="comment">--*/</span>
01736 
01737 {
01738     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>             p,q;
01739     ULONG                   i,j;
01740     PPARTITION_INFORMATION d;
01741     LARGE_INTEGER          HiddenBytes;
01742     ULONG                  BytesPerSector = <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o3">BytesPerSector</a>;
01743     LARGE_INTEGER          Result1, Result2;
01744 
01745     <a class="code" href="../../d8/d1/fdengine_8c.html#a45">FreeLinkedPartitionList</a>(&amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Disk]);
01746 
01747     p = <a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>[Disk];
01748     <span class="keywordflow">while</span>(p) {
01749         <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a>)) {
01750             <span class="keywordflow">break</span>;
01751         }
01752         p = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
01753     }
01754 
01755     <span class="keywordflow">if</span>(p) {
01756         <span class="keywordflow">for</span>(i=<a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>; i&lt;DriveLayout-&gt;PartitionCount; i+=<a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>) {
01757 
01758             <span class="keywordflow">for</span>(j=i; j&lt;i+<a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>; j++) {
01759 
01760                 d = &amp;DriveLayout-&gt;PartitionEntry[j];
01761 
01762                 <span class="keywordflow">if</span>((d-&gt;PartitionType != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) &amp;&amp; (d-&gt;PartitionType != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a71">SYSID_EXTENDED</a>)) {
01763 
01764                     HiddenBytes.QuadPart = UInt32x32To64(d-&gt;HiddenSectors,BytesPerSector);
01765 
01766                     Result1.QuadPart = d-&gt;StartingOffset.QuadPart - HiddenBytes.QuadPart;
01767                     Result2.QuadPart = d-&gt;PartitionLength.QuadPart + HiddenBytes.QuadPart;
01768                     <span class="keywordflow">if</span>(!(q = <a class="code" href="../../d8/d1/fdengine_8c.html#a29">AllocatePartitionStructure</a>(Disk,
01769                                                         Result1,
01770                                                         Result2,
01771                                                         d-&gt;PartitionType,
01772                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01773                                                         d-&gt;BootIndicator,
01774                                                         d-&gt;RecognizedPartition
01775                                                        )
01776                         )
01777                       )
01778                     {
01779                         <a class="code" href="../../d4/d9/arcinst_8h.html#a24">RETURN_OUT_OF_MEMORY</a>;
01780                     }
01781 
01782                     q-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o5">OriginalPartitionNumber</a> = PartitionNumber++;
01783                     <a class="code" href="../../d8/d1/fdengine_8c.html#a39">AddPartitionToLinkedList</a>(&amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Disk],q);
01784 
01785                     <span class="keywordflow">break</span>;
01786                 }
01787             }
01788         }
01789         <span class="keywordflow">return</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a47">InitializeFreeSpace</a>(Disk,
01790                                    &amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Disk],
01791                                    p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>,
01792                                    p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o3">Length</a>
01793                                   )
01794               );
01795     }
01796     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
01797 }
01798 
01799 
01800 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l01801"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a49">01801</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a49">InitializePrimaryPartitionList</a>(
01802     IN  ULONG                     Disk,
01803     IN  PDRIVE_LAYOUT_INFORMATION DriveLayout,
01804     OUT PULONG                    NextPartitionNumber
01805     )
01806 
01807 <span class="comment">/*++</span>
01808 <span class="comment"></span>
01809 <span class="comment">Routine Description:</span>
01810 <span class="comment"></span>
01811 <span class="comment">    This routine creates the primary partition linked list of</span>
01812 <span class="comment">    PARTITION structures for the given disk.</span>
01813 <span class="comment"></span>
01814 <span class="comment">Arguments:</span>
01815 <span class="comment"></span>
01816 <span class="comment">    Disk    - index of disk</span>
01817 <span class="comment"></span>
01818 <span class="comment">    DriveLayout - pointer to structure describing the raw partition</span>
01819 <span class="comment">                  layout of the disk.</span>
01820 <span class="comment"></span>
01821 <span class="comment">    NextPartitionNumber - where to put partition number that should be</span>
01822 <span class="comment">                          assigned to the first logical volume on the</span>
01823 <span class="comment">                          disk.</span>
01824 <span class="comment"></span>
01825 <span class="comment">Return Value:</span>
01826 <span class="comment"></span>
01827 <span class="comment">    OK_STATUS or error code.</span>
01828 <span class="comment"></span>
01829 <span class="comment">--*/</span>
01830 
01831 {
01832     ULONG                  i;
01833     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>             p;
01834     PPARTITION_INFORMATION d;
01835     ULONG                  PartitionNumber = 1;
01836     LARGE_INTEGER          LargeZero;
01837 
01838     <a class="code" href="../../d8/d1/fdengine_8c.html#a45">FreeLinkedPartitionList</a>(&amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>[Disk]);
01839 
01840     <span class="keywordflow">if</span>(DriveLayout-&gt;PartitionCount &gt;= <a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>) {
01841 
01842         <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>; i++) {
01843 
01844             d = &amp;DriveLayout-&gt;PartitionEntry[i];
01845 
01846             <span class="keywordflow">if</span>(d-&gt;PartitionType != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) {
01847 
01848                 <span class="keywordflow">if</span>(!(p = <a class="code" href="../../d8/d1/fdengine_8c.html#a29">AllocatePartitionStructure</a>(Disk,
01849                                                     d-&gt;StartingOffset,
01850                                                     d-&gt;PartitionLength,
01851                                                     d-&gt;PartitionType,
01852                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01853                                                     d-&gt;BootIndicator,
01854                                                     d-&gt;RecognizedPartition
01855                                                    )
01856                     )
01857                   )
01858                 {
01859                     <a class="code" href="../../d4/d9/arcinst_8h.html#a24">RETURN_OUT_OF_MEMORY</a>;
01860                 }
01861 
01862                 p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o5">OriginalPartitionNumber</a> = <a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a>)
01863                                            ? 0
01864                                            : PartitionNumber++;
01865 
01866                 <a class="code" href="../../d8/d1/fdengine_8c.html#a39">AddPartitionToLinkedList</a>(&amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>[Disk],p);
01867             }
01868         }
01869     }
01870     *NextPartitionNumber = PartitionNumber;
01871     LargeZero.QuadPart = 0;
01872     <span class="keywordflow">return</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a47">InitializeFreeSpace</a>(Disk,
01873                                &amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>[Disk],
01874                                LargeZero,
01875                                <a class="code" href="../../d8/d1/fdengine_8c.html#a28">DiskLengthBytes</a>(Disk)
01876                               )
01877           );
01878 }
01879 
01880 
01881 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l01882"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a15">01882</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a15">InitializePartitionLists</a>(
01883     VOID
01884     )
01885 
01886 <span class="comment">/*++</span>
01887 <span class="comment"></span>
01888 <span class="comment">Routine Description:</span>
01889 <span class="comment"></span>
01890 <span class="comment">    This routine scans the PARTITION_INFO array returned for each disk</span>
01891 <span class="comment">    by the OS.  A linked list of PARTITION structures is layered on top</span>
01892 <span class="comment">    of each array;  the net result is a sorted list that covers an entire</span>
01893 <span class="comment">    disk, because free spaces are also factored in as 'dummy' partitions.</span>
01894 <span class="comment"></span>
01895 <span class="comment">Arguments:</span>
01896 <span class="comment"></span>
01897 <span class="comment">    None.</span>
01898 <span class="comment"></span>
01899 <span class="comment">Return Value:</span>
01900 <span class="comment"></span>
01901 <span class="comment">    OK_STATUS or error code.</span>
01902 <span class="comment"></span>
01903 <span class="comment">--*/</span>
01904 
01905 {
01906     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>               status;
01907     ULONG                     Disk;
01908     PDRIVE_LAYOUT_INFORMATION DriveLayout;
01909     ULONG                     PNum;
01910 
01911 
01912     <span class="keywordflow">for</span>(Disk=0; Disk&lt;<a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a>; Disk++) {
01913 
01914         <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a7">OffLine</a>[Disk]) {
01915             <span class="keywordflow">continue</span>;
01916         }
01917 
01918         <span class="keywordflow">if</span>((status = <a class="code" href="../../d1/d6/low_8c.html#a23">LowGetDiskLayout</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a3">DiskNames</a>[Disk],&amp;DriveLayout)) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
01919             <span class="keywordflow">return</span>(status);
01920         }
01921 
01922         <span class="keywordflow">if</span>((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a49">InitializePrimaryPartitionList</a>(Disk,DriveLayout,&amp;PNum)) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
01923             <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(DriveLayout);
01924             <span class="keywordflow">return</span>(status);
01925         }
01926         <span class="keywordflow">if</span>((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a48">InitializeLogicalVolumeList</a>(Disk,DriveLayout,PNum)) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
01927             <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(DriveLayout);
01928             <span class="keywordflow">return</span>(status);
01929         }
01930 
01931         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(DriveLayout);
01932         <a class="code" href="../../d8/d1/fdengine_8c.html#a40">RenumberPartitions</a>(Disk);
01933     }
01934     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
01935 }
01936 
01937 
01938 
01939 LARGE_INTEGER
<a name="l01940"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a28">01940</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a28">DiskLengthBytes</a>(
01941     IN ULONG Disk
01942     )
01943 
01944 <span class="comment">/*++</span>
01945 <span class="comment"></span>
01946 <span class="comment">Routine Description:</span>
01947 <span class="comment"></span>
01948 <span class="comment">    This routine determines the disk length in bytes.  This value</span>
01949 <span class="comment">    is calculated from the disk geometry information.</span>
01950 <span class="comment"></span>
01951 <span class="comment">Arguments:</span>
01952 <span class="comment"></span>
01953 <span class="comment">    Disk - index of disk whose size is desired</span>
01954 <span class="comment"></span>
01955 <span class="comment">Return Value:</span>
01956 <span class="comment"></span>
01957 <span class="comment">    Size of Disk.</span>
01958 <span class="comment"></span>
01959 <span class="comment">--*/</span>
01960 
01961 {
01962     LARGE_INTEGER l;
01963 
01964     l.QuadPart = (ULONGLONG)<a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o0">Cylinders</a>.QuadPart
01965                * (ULONGLONG)<a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o4">BytesPerCylinder</a>;
01966 
01967     <span class="keywordflow">return</span>(l);
01968 }
01969 
01970 
01971 ULONG
<a name="l01972"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a50">01972</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a50">SIZEMB</a>(
01973     IN LARGE_INTEGER ByteCount
01974     )
01975 
01976 <span class="comment">/*++</span>
01977 <span class="comment"></span>
01978 <span class="comment">Routine Description:</span>
01979 <span class="comment"></span>
01980 <span class="comment">    Calculate the size in megabytes of a given byte count. The value is</span>
01981 <span class="comment">    properly rounded (ie, not merely truncated).</span>
01982 <span class="comment"></span>
01983 <span class="comment">    This function replaces a macro of the same name that was truncating</span>
01984 <span class="comment">    instead of rounding.</span>
01985 <span class="comment"></span>
01986 <span class="comment">Arguments:</span>
01987 <span class="comment"></span>
01988 <span class="comment">    ByteCount - supplies number of bytes</span>
01989 <span class="comment"></span>
01990 <span class="comment">Return Value:</span>
01991 <span class="comment"></span>
01992 <span class="comment">    Size in MB equivalent to ByteCount.</span>
01993 <span class="comment"></span>
01994 <span class="comment">--*/</span>
01995 
01996 {
01997     ULONG Remainder;
01998     ULONG SizeMB;
01999 
02000     SizeMB = (ULONG)((ULONGLONG)ByteCount.QuadPart / (ULONGLONG)<a class="code" href="../../d4/d9/arcinst_8h.html#a26">ONE_MEG</a>);
02001     Remainder = (ULONG)((ULONGLONG)ByteCount.QuadPart % (ULONGLONG)<a class="code" href="../../d4/d9/arcinst_8h.html#a26">ONE_MEG</a>);
02002 
02003     <span class="keywordflow">if</span>(Remainder &gt;= <a class="code" href="../../d4/d9/arcinst_8h.html#a26">ONE_MEG</a>/2) {
02004         SizeMB++;
02005     }
02006 
02007     <span class="keywordflow">return</span>(SizeMB);
02008 }
02009 
02010 ULONG
<a name="l02011"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a51">02011</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a51">DiskSizeMB</a>(
02012     IN ULONG Disk
02013     )
02014 
02015 <span class="comment">/*++</span>
02016 <span class="comment"></span>
02017 <span class="comment">Routine Description:</span>
02018 <span class="comment"></span>
02019 <span class="comment">    This routine determines the disk length in megabytes.  The returned</span>
02020 <span class="comment">    value is rounded down after division by 1024*1024.</span>
02021 <span class="comment"></span>
02022 <span class="comment">Arguments:</span>
02023 <span class="comment"></span>
02024 <span class="comment">    Disk - index of disk whose size is desired</span>
02025 <span class="comment"></span>
02026 <span class="comment">Return Value:</span>
02027 <span class="comment"></span>
02028 <span class="comment">    Size of Disk.</span>
02029 <span class="comment"></span>
02030 <span class="comment">--*/</span>
02031 
02032 {
02033     <span class="keywordflow">return</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a50">SIZEMB</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a28">DiskLengthBytes</a>(Disk)));
02034 }
02035 
02036 
02037 LARGE_INTEGER
<a name="l02038"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a22">02038</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a22">AlignTowardsDiskStart</a>(
02039     IN ULONG         Disk,
02040     IN LARGE_INTEGER Offset
02041     )
02042 
02043 <span class="comment">/*++</span>
02044 <span class="comment"></span>
02045 <span class="comment">Routine Description:</span>
02046 <span class="comment"></span>
02047 <span class="comment">    This routine snaps a byte offset to a cylinder boundary, towards</span>
02048 <span class="comment">    the start of the disk.</span>
02049 <span class="comment"></span>
02050 <span class="comment">Arguments:</span>
02051 <span class="comment"></span>
02052 <span class="comment">    Disk - index of disk whose offset is to be snapped</span>
02053 <span class="comment"></span>
02054 <span class="comment">    Offset - byte offset to be aligned (snapped to cylinder boundary)</span>
02055 <span class="comment"></span>
02056 <span class="comment">Return Value:</span>
02057 <span class="comment"></span>
02058 <span class="comment">    Aligned offset.</span>
02059 <span class="comment"></span>
02060 <span class="comment">--*/</span>
02061 
02062 {
02063     LARGE_INTEGER mod;
02064     LARGE_INTEGER Result;
02065 
02066     mod.QuadPart = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart % <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o4">BytesPerCylinder</a>;
02067     Result.QuadPart = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart - mod.QuadPart;
02068     <span class="keywordflow">return</span>(Result);
02069 }
02070 
02071 
02072 LARGE_INTEGER
<a name="l02073"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a23">02073</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a23">AlignTowardsDiskEnd</a>(
02074     IN ULONG         Disk,
02075     IN LARGE_INTEGER Offset
02076     )
02077 
02078 <span class="comment">/*++</span>
02079 <span class="comment"></span>
02080 <span class="comment">Routine Description:</span>
02081 <span class="comment"></span>
02082 <span class="comment">    This routine snaps a byte offset to a cylinder boundary, towards</span>
02083 <span class="comment">    the end of the disk.</span>
02084 <span class="comment"></span>
02085 <span class="comment">Arguments:</span>
02086 <span class="comment"></span>
02087 <span class="comment">    Disk - index of disk whose offset is to be snapped</span>
02088 <span class="comment"></span>
02089 <span class="comment">    Offset - byte offset to be aligned (snapped to cylinder boundary)</span>
02090 <span class="comment"></span>
02091 <span class="comment">Return Value:</span>
02092 <span class="comment"></span>
02093 <span class="comment">    Aligned offset.</span>
02094 <span class="comment"></span>
02095 <span class="comment">--*/</span>
02096 
02097 {
02098     LARGE_INTEGER mod;
02099     LARGE_INTEGER LargeInteger;
02100 
02101     mod.QuadPart = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart % <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o4">BytesPerCylinder</a>;
02102     <span class="keywordflow">if</span>(mod.QuadPart != 0) {
02103 
02104         LargeInteger.QuadPart = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart + <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o4">BytesPerCylinder</a>;
02105         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d8/d1/fdengine_8c.html#a22">AlignTowardsDiskStart</a>(Disk,
02106                                        LargeInteger
02107                                       );
02108     }
02109     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>);
02110 }
02111 
02112 
02113 BOOLEAN
<a name="l02114"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a52">02114</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(
02115     IN UCHAR SysID
02116     )
02117 
02118 <span class="comment">/*++</span>
02119 <span class="comment"></span>
02120 <span class="comment">Routine Description:</span>
02121 <span class="comment"></span>
02122 <span class="comment">    This routine determines whether a given system id is for an</span>
02123 <span class="comment">    extended type (ie, link) entry.</span>
02124 <span class="comment"></span>
02125 <span class="comment">Arguments:</span>
02126 <span class="comment"></span>
02127 <span class="comment">    SysID - system id to be tested.</span>
02128 <span class="comment"></span>
02129 <span class="comment">Return Value:</span>
02130 <span class="comment"></span>
02131 <span class="comment">    true/false based on whether SysID is for an extended type.</span>
02132 <span class="comment"></span>
02133 <span class="comment">--*/</span>
02134 
02135 {
02136     <span class="keywordflow">return</span>((BOOLEAN)(SysID == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a71">SYSID_EXTENDED</a>));
02137 }
02138 
02139 
02140 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l02141"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a53">02141</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a53">IsAnyCreationAllowed</a>(
02142     IN  ULONG    Disk,
02143     IN  BOOLEAN  AllowMultiplePrimaries,
02144     OUT PBOOLEAN AnyAllowed,
02145     OUT PBOOLEAN PrimaryAllowed,
02146     OUT PBOOLEAN ExtendedAllowed,
02147     OUT PBOOLEAN LogicalAllowed
02148     )
02149 
02150 <span class="comment">/*++</span>
02151 <span class="comment"></span>
02152 <span class="comment">Routine Description:</span>
02153 <span class="comment"></span>
02154 <span class="comment">    This routine determines whether any partition may be created on a</span>
02155 <span class="comment">    given disk, based on three sub-queries -- whether creation is allowed</span>
02156 <span class="comment">    of a primary partition, an extended partition, or a logical volume.</span>
02157 <span class="comment"></span>
02158 <span class="comment">Arguments:</span>
02159 <span class="comment"></span>
02160 <span class="comment">    Disk            - index of disk to check</span>
02161 <span class="comment"></span>
02162 <span class="comment">    AllowMultiplePrimaries - whether to allow multiple primary partitions</span>
02163 <span class="comment"></span>
02164 <span class="comment">    AnyAllowed - returns whether any creation is allowed</span>
02165 <span class="comment"></span>
02166 <span class="comment">    PrimaryAllowed - returns whether creation of a primary partition</span>
02167 <span class="comment">                     is allowed</span>
02168 <span class="comment"></span>
02169 <span class="comment">    ExtendedAllowed - returns whether creation of an extended partition</span>
02170 <span class="comment">                      is allowed</span>
02171 <span class="comment"></span>
02172 <span class="comment">    Logical Allowed - returns whether creation of a logical volume is allowed.</span>
02173 <span class="comment"></span>
02174 <span class="comment">Return Value:</span>
02175 <span class="comment"></span>
02176 <span class="comment">    OK_STATUS or error code</span>
02177 <span class="comment"></span>
02178 <span class="comment">--*/</span>
02179 
02180 {
02181     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> status;
02182 
02183     <span class="keywordflow">if</span>((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a54">IsCreationOfPrimaryAllowed</a>(Disk,AllowMultiplePrimaries,PrimaryAllowed)) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02184         <span class="keywordflow">return</span>(status);
02185     }
02186     <span class="keywordflow">if</span>((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a55">IsCreationOfExtendedAllowed</a>(Disk,ExtendedAllowed)) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02187         <span class="keywordflow">return</span>(status);
02188     }
02189     <span class="keywordflow">if</span>((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a56">IsCreationOfLogicalAllowed</a>(Disk,LogicalAllowed)) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02190         <span class="keywordflow">return</span>(status);
02191     }
02192     *AnyAllowed = (BOOLEAN)(*PrimaryAllowed || *ExtendedAllowed || *LogicalAllowed);
02193     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
02194 }
02195 
02196 
02197 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l02198"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a54">02198</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a54">IsCreationOfPrimaryAllowed</a>(
02199     IN  ULONG    Disk,
02200     IN  BOOLEAN  AllowMultiplePrimaries,
02201     OUT BOOLEAN *Allowed
02202     )
02203 
02204 <span class="comment">/*++</span>
02205 <span class="comment"></span>
02206 <span class="comment">Routine Description:</span>
02207 <span class="comment"></span>
02208 <span class="comment">    This routine determines whether creation of a primary partition is</span>
02209 <span class="comment">    allowed.  This is true when there is a free entry in the MBR and</span>
02210 <span class="comment">    there is free primary space on the disk.  If multiple primaries</span>
02211 <span class="comment">    are not allowed, then there must also not exist any primary partitions</span>
02212 <span class="comment">    in order for a primary creation to be allowed.</span>
02213 <span class="comment"></span>
02214 <span class="comment">Arguments:</span>
02215 <span class="comment"></span>
02216 <span class="comment">    Disk            - index of disk to check</span>
02217 <span class="comment"></span>
02218 <span class="comment">    AllowMultiplePrimaries - whether existnace of primary partition</span>
02219 <span class="comment">                             disallows creation of a primary partition</span>
02220 <span class="comment"></span>
02221 <span class="comment">    Allowed - returns whether creation of a primary partition</span>
02222 <span class="comment">              is allowed</span>
02223 <span class="comment"></span>
02224 <span class="comment">Return Value:</span>
02225 <span class="comment"></span>
02226 <span class="comment">    OK_STATUS or error code</span>
02227 <span class="comment"></span>
02228 <span class="comment">--*/</span>
02229 
02230 {
02231     <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Regions;
02232     ULONG              RegionCount;
02233     ULONG              UsedCount,RecogCount,i;
02234     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>        status;
02235     BOOLEAN            FreeSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02236 
02237     status = <a class="code" href="../../d4/d9/arcinst_8h.html#a32">GetPrimaryDiskRegions</a>(Disk,&amp;Regions,&amp;RegionCount);
02238     <span class="keywordflow">if</span>(status != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02239         <span class="keywordflow">return</span>(status);
02240     }
02241 
02242     <span class="keywordflow">for</span>(UsedCount = RecogCount = i = 0; i&lt;RegionCount; i++) {
02243         <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(Regions[i].RegionType != <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>);
02244         <span class="keywordflow">if</span>(Regions[i].<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o8">SysID</a> == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) {
02245             FreeSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02246         } <span class="keywordflow">else</span> {
02247             UsedCount++;
02248             <span class="keywordflow">if</span>(!<a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(Regions[i].SysID) &amp;&amp; Regions[i].<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o7">Recognized</a>) {
02249                 RecogCount++;
02250             }
02251         }
02252     }
02253     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(UsedCount &lt;= <a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>);
02254     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(RecogCount &lt;= <a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>);
02255     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(RecogCount &lt;= UsedCount);
02256 
02257     <span class="keywordflow">if</span>((UsedCount &lt; <a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>)
02258     &amp;&amp; FreeSpace
02259     &amp;&amp; (!RecogCount || AllowMultiplePrimaries))
02260     {
02261         *Allowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02262     } <span class="keywordflow">else</span> {
02263         *Allowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02264     }
02265 
02266     <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
02267     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
02268 }
02269 
02270 
02271 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l02272"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a55">02272</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a55">IsCreationOfExtendedAllowed</a>(
02273     IN  ULONG    Disk,
02274     OUT BOOLEAN *Allowed
02275     )
02276 
02277 <span class="comment">/*++</span>
02278 <span class="comment"></span>
02279 <span class="comment">Routine Description:</span>
02280 <span class="comment"></span>
02281 <span class="comment">    This routine determines whether creation of an extended partition is</span>
02282 <span class="comment">    allowed.  This is true when there is a free entry in the MBR,</span>
02283 <span class="comment">    there is free primary space on the disk, and there is no existing</span>
02284 <span class="comment">    extended partition.</span>
02285 <span class="comment"></span>
02286 <span class="comment">Arguments:</span>
02287 <span class="comment"></span>
02288 <span class="comment">    Disk            - index of disk to check</span>
02289 <span class="comment"></span>
02290 <span class="comment">    Allowed - returns whether creation of an extended partition</span>
02291 <span class="comment">              is allowed</span>
02292 <span class="comment"></span>
02293 <span class="comment">Return Value:</span>
02294 <span class="comment"></span>
02295 <span class="comment">    OK_STATUS or error code</span>
02296 <span class="comment"></span>
02297 <span class="comment">--*/</span>
02298 
02299 {
02300     <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Regions;
02301     ULONG              RegionCount;
02302     ULONG              UsedCount,FreeCount,i;
02303     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>        status;
02304 
02305     status = <a class="code" href="../../d4/d9/arcinst_8h.html#a32">GetPrimaryDiskRegions</a>(Disk,&amp;Regions,&amp;RegionCount);
02306     <span class="keywordflow">if</span>(status != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02307         <span class="keywordflow">return</span>(status);
02308     }
02309 
02310     <span class="keywordflow">for</span>(UsedCount = FreeCount = i = 0; i&lt;RegionCount; i++) {
02311         <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(Regions[i].RegionType != <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>);
02312         <span class="keywordflow">if</span>(Regions[i].<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o8">SysID</a> == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) {
02313             <span class="comment">// BUGBUG should adjust the size here and see if it's non0 first</span>
02314             <span class="comment">// (ie, take into account that the extended partition can't</span>
02315             <span class="comment">// start on cyl 0).</span>
02316             FreeCount++;
02317         } <span class="keywordflow">else</span> {
02318             UsedCount++;
02319             <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(Regions[i].SysID)) {
02320                 <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
02321                 *Allowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02322                 <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
02323             }
02324         }
02325     }
02326     *Allowed = (BOOLEAN)((UsedCount &lt; <a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>) &amp;&amp; FreeCount);
02327     <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
02328     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
02329 }
02330 
02331 
02332 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l02333"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a56">02333</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a56">IsCreationOfLogicalAllowed</a>(
02334     IN  ULONG    Disk,
02335     OUT BOOLEAN *Allowed
02336     )
02337 
02338 <span class="comment">/*++</span>
02339 <span class="comment"></span>
02340 <span class="comment">Routine Description:</span>
02341 <span class="comment"></span>
02342 <span class="comment">    This routine determines whether creation of a logical volume is</span>
02343 <span class="comment">    allowed.  This is true when there is an extended partition and</span>
02344 <span class="comment">    free space within it.</span>
02345 <span class="comment"></span>
02346 <span class="comment">Arguments:</span>
02347 <span class="comment"></span>
02348 <span class="comment">    Disk            - index of disk to check</span>
02349 <span class="comment"></span>
02350 <span class="comment">    Allowed - returns whether creation of a logical volume is allowed</span>
02351 <span class="comment"></span>
02352 <span class="comment">Return Value:</span>
02353 <span class="comment"></span>
02354 <span class="comment">    OK_STATUS or error code</span>
02355 <span class="comment"></span>
02356 <span class="comment">--*/</span>
02357 
02358 {
02359     <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Regions;
02360     ULONG              RegionCount;
02361     ULONG              i;
02362     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>        status;
02363     BOOLEAN            ExtendedExists;
02364 
02365     *Allowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02366 
02367     status = <a class="code" href="../../d8/d1/fdengine_8c.html#a59">DoesExtendedExist</a>(Disk,&amp;ExtendedExists);
02368     <span class="keywordflow">if</span>(status != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02369         <span class="keywordflow">return</span>(status);
02370     }
02371     <span class="keywordflow">if</span>(!ExtendedExists) {
02372         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
02373     }
02374 
02375     status = <a class="code" href="../../d4/d9/arcinst_8h.html#a33">GetLogicalDiskRegions</a>(Disk,&amp;Regions,&amp;RegionCount);
02376     <span class="keywordflow">if</span>(status != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02377         <span class="keywordflow">return</span>(status);
02378     }
02379 
02380     <span class="keywordflow">for</span>(i = 0; i&lt;RegionCount; i++) {
02381         <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(Regions[i].RegionType == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>);
02382         <span class="keywordflow">if</span>(Regions[i].<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o8">SysID</a> == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) {
02383             *Allowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02384             <span class="keywordflow">break</span>;
02385         }
02386     }
02387     <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
02388     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
02389 }
02390 
02391 
02392 
02393 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l02394"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a57">02394</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a57">DoesAnyPartitionExist</a>(
02395     IN  ULONG    Disk,
02396     OUT PBOOLEAN AnyExists,
02397     OUT PBOOLEAN PrimaryExists,
02398     OUT PBOOLEAN ExtendedExists,
02399     OUT PBOOLEAN LogicalExists
02400     )
02401 
02402 <span class="comment">/*++</span>
02403 <span class="comment"></span>
02404 <span class="comment">Routine Description:</span>
02405 <span class="comment"></span>
02406 <span class="comment">    This routine determines whether any partition exists on a given disk.</span>
02407 <span class="comment">    This is based on three sub queries: whether there are any primary or</span>
02408 <span class="comment">    extended partitions, or logical volumes on the disk.</span>
02409 <span class="comment"></span>
02410 <span class="comment">Arguments:</span>
02411 <span class="comment"></span>
02412 <span class="comment">    Disk            - index of disk to check</span>
02413 <span class="comment"></span>
02414 <span class="comment">    AnyExists - returns whether any partitions exist on Disk</span>
02415 <span class="comment"></span>
02416 <span class="comment">    PrimaryExists - returns whether any primary partitions exist on Disk</span>
02417 <span class="comment"></span>
02418 <span class="comment">    ExtendedExists - returns whether there is an extended partition on Disk</span>
02419 <span class="comment"></span>
02420 <span class="comment">    LogicalExists - returns whether any logical volumes exist on Disk</span>
02421 <span class="comment"></span>
02422 <span class="comment">Return Value:</span>
02423 <span class="comment"></span>
02424 <span class="comment">    OK_STATUS or error code</span>
02425 <span class="comment"></span>
02426 <span class="comment">--*/</span>
02427 
02428 {
02429     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> status;
02430 
02431     <span class="keywordflow">if</span>((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a58">DoesAnyPrimaryExist</a>(Disk,PrimaryExists )) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02432         <span class="keywordflow">return</span>(status);
02433     }
02434     <span class="keywordflow">if</span>((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a59">DoesExtendedExist</a>  (Disk,ExtendedExists)) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02435         <span class="keywordflow">return</span>(status);
02436     }
02437     <span class="keywordflow">if</span>((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a60">DoesAnyLogicalExist</a>(Disk,LogicalExists )) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02438         <span class="keywordflow">return</span>(status);
02439     }
02440     *AnyExists = (BOOLEAN)(*PrimaryExists || *ExtendedExists || *LogicalExists);
02441     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
02442 }
02443 
02444 
02445 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l02446"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a58">02446</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a58">DoesAnyPrimaryExist</a>(
02447     IN  ULONG    Disk,
02448     OUT BOOLEAN *Exists
02449     )
02450 
02451 <span class="comment">/*++</span>
02452 <span class="comment"></span>
02453 <span class="comment">Routine Description:</span>
02454 <span class="comment"></span>
02455 <span class="comment">    This routine determines whether any non-extended primary partition exists</span>
02456 <span class="comment">    on a given disk.</span>
02457 <span class="comment"></span>
02458 <span class="comment">Arguments:</span>
02459 <span class="comment"></span>
02460 <span class="comment">    Disk   - index of disk to check</span>
02461 <span class="comment"></span>
02462 <span class="comment">    Exists - returns whether any primary partitions exist on Disk</span>
02463 <span class="comment"></span>
02464 <span class="comment">Return Value:</span>
02465 <span class="comment"></span>
02466 <span class="comment">    OK_STATUS or error code</span>
02467 <span class="comment"></span>
02468 <span class="comment">--*/</span>
02469 
02470 {
02471     <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Regions;
02472     ULONG               RegionCount,i;
02473     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>        status;
02474 
02475     status = <a class="code" href="../../d4/d9/arcinst_8h.html#a34">GetUsedPrimaryDiskRegions</a>(Disk,&amp;Regions,&amp;RegionCount);
02476     <span class="keywordflow">if</span>(status != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02477         <span class="keywordflow">return</span>(status);
02478     }
02479 
02480     *Exists = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02481 
02482     <span class="keywordflow">for</span>(i=0; i&lt;RegionCount; i++) {
02483         <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(Regions[i].RegionType != <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>);
02484         <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(Regions[i].SysID != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>);
02485         <span class="keywordflow">if</span>(!<a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(Regions[i].SysID)) {
02486             *Exists = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02487             <span class="keywordflow">break</span>;
02488         }
02489     }
02490     <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
02491     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
02492 }
02493 
02494 
02495 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l02496"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a59">02496</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a59">DoesExtendedExist</a>(
02497     IN  ULONG    Disk,
02498     OUT BOOLEAN *Exists
02499     )
02500 
02501 <span class="comment">/*++</span>
02502 <span class="comment"></span>
02503 <span class="comment">Routine Description:</span>
02504 <span class="comment"></span>
02505 <span class="comment">    This routine determines whether an extended partition exists</span>
02506 <span class="comment">    on a given disk.</span>
02507 <span class="comment"></span>
02508 <span class="comment">Arguments:</span>
02509 <span class="comment"></span>
02510 <span class="comment">    Disk   - index of disk to check</span>
02511 <span class="comment"></span>
02512 <span class="comment">    Exists - returns whether an extended partition exists on Disk</span>
02513 <span class="comment"></span>
02514 <span class="comment">Return Value:</span>
02515 <span class="comment"></span>
02516 <span class="comment">    OK_STATUS or error code</span>
02517 <span class="comment"></span>
02518 <span class="comment">--*/</span>
02519 
02520 {
02521     <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Regions;
02522     ULONG               RegionCount,i;
02523     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>        status;
02524 
02525     status = <a class="code" href="../../d4/d9/arcinst_8h.html#a34">GetUsedPrimaryDiskRegions</a>(Disk,&amp;Regions,&amp;RegionCount);
02526     <span class="keywordflow">if</span>(status != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02527         <span class="keywordflow">return</span>(status);
02528     }
02529 
02530     *Exists = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02531 
02532     <span class="keywordflow">for</span>(i=0; i&lt;RegionCount; i++) {
02533         <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(Regions[i].RegionType != <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>);
02534         <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(Regions[i].SysID != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>);
02535         <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(Regions[i].SysID)) {
02536             *Exists = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02537             <span class="keywordflow">break</span>;
02538         }
02539     }
02540     <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
02541     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
02542 }
02543 
02544 
02545 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l02546"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a60">02546</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a60">DoesAnyLogicalExist</a>(
02547     IN  ULONG    Disk,
02548     OUT BOOLEAN *Exists
02549     )
02550 
02551 <span class="comment">/*++</span>
02552 <span class="comment"></span>
02553 <span class="comment">Routine Description:</span>
02554 <span class="comment"></span>
02555 <span class="comment">    This routine determines whether any logical volumes exist</span>
02556 <span class="comment">    on a given disk.</span>
02557 <span class="comment"></span>
02558 <span class="comment">Arguments:</span>
02559 <span class="comment"></span>
02560 <span class="comment">    Disk   - index of disk to check</span>
02561 <span class="comment"></span>
02562 <span class="comment">    Exists - returns whether any logical volumes exist on Disk</span>
02563 <span class="comment"></span>
02564 <span class="comment">Return Value:</span>
02565 <span class="comment"></span>
02566 <span class="comment">    OK_STATUS or error code</span>
02567 <span class="comment"></span>
02568 <span class="comment">--*/</span>
02569 
02570 {
02571     <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Regions;
02572     ULONG               RegionCount;
02573     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>        status;
02574 
02575     status = <a class="code" href="../../d4/d9/arcinst_8h.html#a35">GetUsedLogicalDiskRegions</a>(Disk,&amp;Regions,&amp;RegionCount);
02576     <span class="keywordflow">if</span>(status != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02577         <span class="keywordflow">return</span>(status);
02578     }
02579 
02580     *Exists = (BOOLEAN)(RegionCount != 0);
02581     <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
02582     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
02583 }
02584 
02585 
02586 ULONG
<a name="l02587"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a61">02587</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a61">GetDiskCount</a>(
02588     VOID
02589     )
02590 
02591 <span class="comment">/*++</span>
02592 <span class="comment"></span>
02593 <span class="comment">Routine Description:</span>
02594 <span class="comment"></span>
02595 <span class="comment">    This routine returns the number of attached partitionable disk</span>
02596 <span class="comment">    devices.  The returned value is one greater than the maximum index</span>
02597 <span class="comment">    allowed for Disk parameters to partitioning engine routines.</span>
02598 <span class="comment"></span>
02599 <span class="comment">Arguments:</span>
02600 <span class="comment"></span>
02601 <span class="comment">    None.</span>
02602 <span class="comment"></span>
02603 <span class="comment">Return Value:</span>
02604 <span class="comment"></span>
02605 <span class="comment">    Count of disks.</span>
02606 <span class="comment"></span>
02607 <span class="comment">--*/</span>
02608 
02609 {
02610     <span class="keywordflow">return</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a2">CountOfDisks</a>);
02611 }
02612 
02613 
02614 PCHAR
<a name="l02615"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a62">02615</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a62">GetDiskName</a>(
02616     ULONG Disk
02617     )
02618 
02619 <span class="comment">/*++</span>
02620 <span class="comment"></span>
02621 <span class="comment">Routine Description:</span>
02622 <span class="comment"></span>
02623 <span class="comment">    This routine returns the system name for the disk device whose</span>
02624 <span class="comment">    index is given.</span>
02625 <span class="comment"></span>
02626 <span class="comment">Arguments:</span>
02627 <span class="comment"></span>
02628 <span class="comment">    Disk - index of disk whose name is desired.</span>
02629 <span class="comment"></span>
02630 <span class="comment">Return Value:</span>
02631 <span class="comment"></span>
02632 <span class="comment">    System name for the disk device.  The caller must not attempt to</span>
02633 <span class="comment">    free this buffer or modify it.</span>
02634 <span class="comment"></span>
02635 <span class="comment">--*/</span>
02636 
02637 {
02638     <span class="keywordflow">return</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a3">DiskNames</a>[Disk]);
02639 }
02640 
02641 
02642 <span class="comment">// sys ID type names</span>
02643 
<a name="l02644"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a9">02644</a> <span class="keywordtype">char</span>    <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>[] = <span class="stringliteral">"Unknown type"</span>;
02645 
<a name="l02646"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a10">02646</a> PCHAR   <a class="code" href="../../d8/d1/fdengine_8c.html#a10">SysIDStrings</a>[256] = { <span class="stringliteral">"Free Space"</span>,<span class="stringliteral">"FAT"</span>,<span class="stringliteral">"XENIX1"</span>,<span class="stringliteral">"XENIX2"</span>, <span class="comment">// 00-03</span>
02647                               <span class="stringliteral">"FAT"</span>, <span class="stringliteral">"Extended"</span>, <span class="stringliteral">"FAT"</span>, <span class="stringliteral">"HPFS/NTFS"</span>,<span class="comment">// 04-07</span>
02648                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,                     <span class="comment">// 08-09</span>
02649                               <span class="stringliteral">"OS/2 Boot Manager"</span>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,         <span class="comment">// 0a-0b</span>
02650                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 0c-0f</span>
02651                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,                     <span class="comment">// 10-11</span>
02652                               <span class="stringliteral">"EISA Utilities"</span>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,            <span class="comment">// 12-13</span>
02653                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 14-17</span>
02654                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 18-1b</span>
02655                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 1c-1f</span>
02656                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 20-23</span>
02657                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 24-27</span>
02658                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 28-2b</span>
02659                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 2c-2f</span>
02660                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 30-33</span>
02661                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 34-37</span>
02662                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 38-3b</span>
02663                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 3c-3f</span>
02664                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 40-43</span>
02665                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 44-47</span>
02666                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 48-4b</span>
02667                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 4c-4f</span>
02668                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 50-53</span>
02669                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 54-57</span>
02670                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 58-5b</span>
02671                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 5c-5f</span>
02672                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <span class="stringliteral">"Unix"</span>,    <span class="comment">// 60-63</span>
02673                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 64-67</span>
02674                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 68-6b</span>
02675                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 6c-6f</span>
02676                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 70-73</span>
02677                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 74-77</span>
02678                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 78-7b</span>
02679                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <span class="stringliteral">"Unused"</span>,  <span class="comment">// 7c-7f</span>
02680                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <span class="stringliteral">"Windows NT Fault Tolerance"</span>,<span class="comment">// 80-81</span>
02681                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,                     <span class="comment">// 82-83</span>
02682                               <span class="stringliteral">"Windows NT Fault Tolerance"</span>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,<span class="comment">// 84-85</span>
02683                               <span class="stringliteral">"Windows NT Fault Tolerance"</span>,         <span class="comment">// 86-86</span>
02684                               <span class="stringliteral">"Windows NT Fault Tolerance"</span>,         <span class="comment">// 87-87</span>
02685                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 88-8b</span>
02686                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 8c-8f</span>
02687                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 90-93</span>
02688                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 94-97</span>
02689                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 98-9b</span>
02690                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// 9c-9f</span>
02691                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// a0-a3</span>
02692                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// a4-a7</span>
02693                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// a8-ab</span>
02694                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// ac-af</span>
02695                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// b0-b3</span>
02696                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// b4-b7</span>
02697                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// b8-bb</span>
02698                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// bc-bf</span>
02699                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// c0-c3</span>
02700                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// c4-c7</span>
02701                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// c8-cb</span>
02702                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// cc-cf</span>
02703                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// d0-d3</span>
02704                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// d4-d7</span>
02705                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// d8-db</span>
02706                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// dc-df</span>
02707                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// e0-e3</span>
02708                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// e4-e7</span>
02709                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// e8-eb</span>
02710                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// ec-ef</span>
02711                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// f0-f3</span>
02712                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// f4-f7</span>
02713                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>,   <span class="comment">// f8-fb</span>
02714                               <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a9">UNKNOWN</a>, <span class="stringliteral">"Table"</span>,   <span class="comment">// fc-ff</span>
02715                             };
02716 
02717 
02718 PCHAR
<a name="l02719"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a63">02719</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a63">GetSysIDName</a>(
02720     UCHAR SysID
02721     )
02722 
02723 <span class="comment">/*++</span>
02724 <span class="comment"></span>
02725 <span class="comment">Routine Description:</span>
02726 <span class="comment"></span>
02727 <span class="comment">    This routine returns the name for a given system ID.</span>
02728 <span class="comment"></span>
02729 <span class="comment">Arguments:</span>
02730 <span class="comment"></span>
02731 <span class="comment">    SysID - system id in question</span>
02732 <span class="comment"></span>
02733 <span class="comment">Return Value:</span>
02734 <span class="comment"></span>
02735 <span class="comment">    Name of system id.  The caller must not attempt to free or</span>
02736 <span class="comment">    modify this buffer.</span>
02737 <span class="comment"></span>
02738 <span class="comment">--*/</span>
02739 
02740 {
02741     <span class="keywordflow">return</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a10">SysIDStrings</a>[SysID]);
02742 }
02743 
02744 
02745 <span class="comment">// worker routines for WriteDriveLayout</span>
02746 
02747 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02748"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a64">02748</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a64">UnusedEntryFill</a>(
02749     IN PPARTITION_INFORMATION pinfo,
02750     IN ULONG                  EntryCount
02751     )
02752 {
02753     ULONG         i;
02754     LARGE_INTEGER <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a>;
02755 
02756     <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a>.QuadPart = 0;
02757 
02758     <span class="keywordflow">for</span>(i=0; i&lt;EntryCount; i++) {
02759 
02760         pinfo[i].StartingOffset   = <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a>;
02761         pinfo[i].PartitionLength  = <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a>;
02762         pinfo[i].HiddenSectors    = 0;
02763         pinfo[i].PartitionType    = <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>;
02764         pinfo[i].BootIndicator    = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02765         pinfo[i].RewritePartition = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02766     }
02767 }
02768 
02769 
02770 LARGE_INTEGER
<a name="l02771"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a65">02771</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a65">MakeBootRec</a>(
02772     ULONG                  Disk,
02773     PPARTITION_INFORMATION pinfo,
02774     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>             pLogical,
02775     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>             pNextLogical
02776     )
02777 {
02778     ULONG         Entry = 0;
02779     LARGE_INTEGER BytesPerTrack;
02780     LARGE_INTEGER SectorsPerTrack;
02781     LARGE_INTEGER StartingOffset;
02782 
02783     BytesPerTrack.QuadPart = (<a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o5">BytesPerTrack</a>);
02784     SectorsPerTrack.QuadPart = (<a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o2">SectorsPerTrack</a>);
02785     StartingOffset.QuadPart = 0;
02786 
02787 <span class="comment">//  ASRT(pLogical || pNextLogical);</span>
02788 
02789     <span class="keywordflow">if</span>(pLogical) {
02790 
02791         pinfo[Entry].StartingOffset.QuadPart   = pLogical-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>.QuadPart + BytesPerTrack.QuadPart;
02792         pinfo[Entry].PartitionLength.QuadPart  = pLogical-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o3">Length</a>.QuadPart - BytesPerTrack.QuadPart;
02793         pinfo[Entry].HiddenSectors    = SectorsPerTrack.LowPart;
02794         pinfo[Entry].RewritePartition = pLogical-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a>;
02795         pinfo[Entry].BootIndicator    = pLogical-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o9">Active</a>;
02796         pinfo[Entry].PartitionType    = pLogical-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a>;
02797 
02798         <span class="keywordflow">if</span>(pinfo[Entry].RewritePartition) {
02799             StartingOffset = pinfo[Entry].StartingOffset;
02800         }
02801 
02802         Entry++;
02803     }
02804 
02805     <span class="keywordflow">if</span>(pNextLogical) {
02806 
02807         pinfo[Entry].StartingOffset   = pNextLogical-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>;
02808         pinfo[Entry].PartitionLength  = pNextLogical-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o3">Length</a>;
02809         pinfo[Entry].HiddenSectors    = 0;
02810         pinfo[Entry].RewritePartition = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02811         pinfo[Entry].BootIndicator    = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02812         pinfo[Entry].PartitionType    = <a class="code" href="../../d4/d9/arcinst_8h.html#a176a71">SYSID_EXTENDED</a>;
02813 
02814         Entry++;
02815     }
02816 
02817     <a class="code" href="../../d8/d1/fdengine_8c.html#a64">UnusedEntryFill</a>(pinfo+Entry,<a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>-Entry);
02818     <span class="keywordflow">return</span>(StartingOffset);
02819 }
02820 
02821 
02822 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l02823"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a66">02823</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a66">ZapSector</a>(
02824     ULONG         Disk,
02825     LARGE_INTEGER Offset
02826     )
02827 
02828 <span class="comment">/*++</span>
02829 <span class="comment"></span>
02830 <span class="comment">Routine Description:</span>
02831 <span class="comment"></span>
02832 <span class="comment">    This routine writes zeros into a sector at a given offset.  This is</span>
02833 <span class="comment">    used to clear out a new partition's filesystem boot record, so that</span>
02834 <span class="comment">    no previous filesystem appears in a new partition; or to clear out the</span>
02835 <span class="comment">    first EBR in the extended partition if there are to be no logical vols.</span>
02836 <span class="comment"></span>
02837 <span class="comment">Arguments:</span>
02838 <span class="comment"></span>
02839 <span class="comment">    Disk - disk to write to</span>
02840 <span class="comment"></span>
02841 <span class="comment">    Offset - byte offset to a newly created partition on Disk</span>
02842 <span class="comment"></span>
02843 <span class="comment">Return Value:</span>
02844 <span class="comment"></span>
02845 <span class="comment">    OK_STATUS or error code.</span>
02846 <span class="comment"></span>
02847 <span class="comment">--*/</span>
02848 
02849 {
02850     ULONG       <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> = <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o3">BytesPerSector</a>;
02851     ULONG       i;
02852     PCHAR       SectorBuffer,AlignedSectorBuffer;
02853     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> status;
02854     ULONG    <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
02855     LARGE_INTEGER   LargeInteger;
02856 
02857     <span class="keywordflow">if</span>((SectorBuffer = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(2*<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02858         <a class="code" href="../../d4/d9/arcinst_8h.html#a24">RETURN_OUT_OF_MEMORY</a>;
02859     }
02860 
02861     AlignedSectorBuffer = (PCHAR)(((ULONG)SectorBuffer+<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>) &amp; ~(<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>-1));
02862 
02863     <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>; AlignedSectorBuffer[i++] = 0);
02864 
02865     <span class="keywordflow">if</span>((status = <a class="code" href="../../d1/d6/low_8c.html#a9">LowOpenDisk</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a62">GetDiskName</a>(Disk),&amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>)) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02866         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(SectorBuffer);
02867         <span class="keywordflow">return</span>(status);
02868     }
02869 
02870     LargeInteger.QuadPart = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart / <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>;
02871     status = <a class="code" href="../../d1/d6/low_8c.html#a14">LowWriteSectors</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
02872                              <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>,
02873                              <a class="code" href="../../d4/d9/arcinst_8h.html#a25">LOWPART</a>(LargeInteger),
02874                              1,
02875                              AlignedSectorBuffer
02876                             );
02877 
02878     <a class="code" href="../../d1/d6/low_8c.html#a10">LowCloseDisk</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
02879     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(SectorBuffer);
02880 
02881     <span class="keywordflow">return</span>(status);
02882 }
02883 
02884 
02885 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l02886"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a67">02886</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a67">WriteDriveLayout</a>(
02887     IN ULONG Disk
02888     )
02889 
02890 <span class="comment">/*++</span>
02891 <span class="comment"></span>
02892 <span class="comment">Routine Description:</span>
02893 <span class="comment"></span>
02894 <span class="comment">    This routine writes the current partition layout for a given disk</span>
02895 <span class="comment">    out to disk.  The high-level PARTITION lists are transformed into</span>
02896 <span class="comment">    a DRIVE_LAYOUT_INFORMATION structure before being passed down</span>
02897 <span class="comment">    to the low-level partition table writing routine.</span>
02898 <span class="comment"></span>
02899 <span class="comment">Arguments:</span>
02900 <span class="comment"></span>
02901 <span class="comment">    Disk - index of disk whose on-disk partition structure is to be updated.</span>
02902 <span class="comment"></span>
02903 <span class="comment">Return Value:</span>
02904 <span class="comment"></span>
02905 <span class="comment">    OK_STATUS or error code.</span>
02906 <span class="comment"></span>
02907 <span class="comment">--*/</span>
02908 
02909 {
02910     PDRIVE_LAYOUT_INFORMATION DriveLayout;
02911     PPARTITION_INFORMATION    pinfo;
02912     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>                <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>,p;
02913     ULONG                     EntryCount;
02914     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>               status;
02915     LARGE_INTEGER             StartingOffset;
02916     LARGE_INTEGER             ExtendedStartingOffset;
02917 
02918     ExtendedStartingOffset.QuadPart = 0;
02919 
02920     <span class="comment">// allocate a huge buffer now to avoid complicated dynamic</span>
02921     <span class="comment">// reallocation schemes later.</span>
02922 
02923     <span class="keywordflow">if</span>(!(DriveLayout = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(250 * <span class="keyword">sizeof</span>(PARTITION_INFORMATION)))) {
02924         <a class="code" href="../../d4/d9/arcinst_8h.html#a24">RETURN_OUT_OF_MEMORY</a>;
02925     }
02926 
02927     pinfo = &amp;DriveLayout-&gt;PartitionEntry[0];
02928 
02929     <span class="comment">// first do the mbr.</span>
02930 
02931     EntryCount=0;
02932     p = <a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>[Disk];
02933 
02934     <span class="keywordflow">while</span>(p) {
02935 
02936         <span class="keywordflow">if</span>(p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a> != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) {
02937 
02938             <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(EntryCount &lt; <a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>);
02939 
02940             <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a>)) {
02941                 ExtendedStartingOffset = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>;
02942             }
02943 
02944             pinfo[EntryCount].StartingOffset   = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o2">Offset</a>;
02945             pinfo[EntryCount].PartitionLength  = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o3">Length</a>;
02946             pinfo[EntryCount].PartitionType    = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a>;
02947             pinfo[EntryCount].BootIndicator    = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o9">Active</a>;
02948             pinfo[EntryCount].RewritePartition = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a>;
02949 
02950             <span class="comment">// BUGBUG we know that this field is not used by the</span>
02951             <span class="comment">//        set drive layout IOCTL or the ARC stub.</span>
02952 
02953             pinfo[EntryCount].HiddenSectors    = 0;
02954 
02955             <span class="comment">// if we're creating this partition, clear out the</span>
02956             <span class="comment">// filesystem boot sector.</span>
02957 
02958             <span class="keywordflow">if</span>(pinfo[EntryCount].RewritePartition
02959             &amp;&amp; (p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a> != <a class="code" href="../../d8/d1/fdengine_8c.html#a1">CHANGED_DONT_ZAP</a>)
02960             &amp;&amp; !<a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(pinfo[EntryCount].PartitionType))
02961             {
02962                 status = <a class="code" href="../../d8/d1/fdengine_8c.html#a66">ZapSector</a>(Disk,pinfo[EntryCount].StartingOffset);
02963                 <span class="keywordflow">if</span>(status != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
02964                     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(DriveLayout);
02965                     <span class="keywordflow">return</span>(status);
02966                 }
02967             }
02968 
02969             EntryCount++;
02970         }
02971         p = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
02972     }
02973 
02974     <span class="comment">// fill the remainder of the MBR with unused entries.</span>
02975     <span class="comment">// NOTE that there will thus always be an MBR even if there</span>
02976     <span class="comment">// are no partitions defined.</span>
02977 
02978     <a class="code" href="../../d8/d1/fdengine_8c.html#a64">UnusedEntryFill</a>(pinfo+EntryCount,<a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a> - EntryCount);
02979     EntryCount = <a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>;
02980 
02981     <span class="comment">//</span>
02982     <span class="comment">// now handle the logical volumes.</span>
02983     <span class="comment">// first check to see whether we need a dummy EBR at the beginning</span>
02984     <span class="comment">// of the extended partition.  This is the case when there is</span>
02985     <span class="comment">// free space at the beginning of the extended partition.</span>
02986 <span class="preprocessor">#if 0</span>
02987 <span class="preprocessor"></span>    <span class="comment">// Also handle the case where we are creating an empty extended</span>
02988     <span class="comment">// partition -- need to zap the first sector to eliminate any residue</span>
02989     <span class="comment">// that might start an EBR chain.</span>
02990 <span class="preprocessor">#else</span>
02991 <span class="preprocessor"></span>    <span class="comment">// BUGBUG 4/24/92 tedm:  Currently the io subsystem returns an error</span>
02992     <span class="comment">// status (status_bad_master_boot_record) if any mbr or ebr is bad.</span>
02993     <span class="comment">// Zeroing the first sector of the extended partition therefore causes</span>
02994     <span class="comment">// the whole disk to be seen as empty.  So create a blank, but valid,</span>
02995     <span class="comment">// EBR in the 'empty extended partition' case.  Code is in the 'else'</span>
02996     <span class="comment">// part of the #if 0, below.</span>
02997 <span class="preprocessor">#endif</span>
02998 <span class="preprocessor"></span>    <span class="comment">//</span>
02999 
03000     <span class="keywordflow">if</span>((p = <a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Disk]) &amp;&amp; (p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a> == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>)) {
03001         <span class="keywordflow">if</span>(p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>) {
03002             <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a> != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>);
03003 
03004             <a class="code" href="../../d8/d1/fdengine_8c.html#a65">MakeBootRec</a>(Disk,pinfo+EntryCount,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>);
03005             EntryCount += <a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>;
03006             p = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
03007         } <span class="keywordflow">else</span> {
03008             <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(ExtendedStartingOffset.QuadPart != 0);
03009 <span class="preprocessor">#if 0</span>
03010 <span class="preprocessor"></span>            status = <a class="code" href="../../d8/d1/fdengine_8c.html#a66">ZapSector</a>(Disk,ExtendedStartingOffset);
03011             <span class="keywordflow">if</span>(status != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
03012                 <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(DriveLayout);
03013                 <span class="keywordflow">return</span>(status);
03014             }
03015 <span class="preprocessor">#else</span>
03016 <span class="preprocessor"></span>            <a class="code" href="../../d8/d1/fdengine_8c.html#a65">MakeBootRec</a>(Disk,pinfo+EntryCount,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03017             EntryCount += <a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>;
03018 <span class="preprocessor">#endif</span>
03019 <span class="preprocessor"></span>        }
03020     }
03021 
03022     <span class="keywordflow">while</span>(p) {
03023         <span class="keywordflow">if</span>(p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o11">SysID</a> != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) {
03024 
03025             <span class="comment">// find the next logical volume.</span>
03026 
03027             <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
03028             <span class="keywordflow">while</span>(<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>) {
03029                 <span class="keywordflow">if</span>(<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>-&gt;SysID != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) {
03030                     <span class="keywordflow">break</span>;
03031                 }
03032                 <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>-&gt;Next;
03033             }
03034 
03035             StartingOffset = <a class="code" href="../../d8/d1/fdengine_8c.html#a65">MakeBootRec</a>(Disk,pinfo+EntryCount,p,<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>);
03036 
03037             <span class="comment">// if we're creating a volume, clear out its filesystem</span>
03038             <span class="comment">// boot sector so it starts out fresh.</span>
03039 
03040             <span class="keywordflow">if</span>((StartingOffset.QuadPart != 0) &amp;&amp; (p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a> != <a class="code" href="../../d8/d1/fdengine_8c.html#a1">CHANGED_DONT_ZAP</a>)) {
03041                 status = <a class="code" href="../../d8/d1/fdengine_8c.html#a66">ZapSector</a>(Disk,StartingOffset);
03042                 <span class="keywordflow">if</span>(status != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
03043                     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(DriveLayout);
03044                     <span class="keywordflow">return</span>(status);
03045                 }
03046             }
03047 
03048             EntryCount += <a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>;
03049         }
03050         p = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
03051     }
03052 
03053     DriveLayout-&gt;PartitionCount = EntryCount;
03054     status = <a class="code" href="../../d1/d6/low_8c.html#a27">LowSetDiskLayout</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a3">DiskNames</a>[Disk],DriveLayout);
03055 
03056     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(DriveLayout);
03057 
03058     <span class="keywordflow">return</span>(status);
03059 }
03060 
03061 
03062 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l03063"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a68">03063</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a68">CommitPartitionChanges</a>(
03064     IN ULONG Disk
03065     )
03066 
03067 <span class="comment">/*++</span>
03068 <span class="comment"></span>
03069 <span class="comment">Routine Description:</span>
03070 <span class="comment"></span>
03071 <span class="comment">    This routine is the entry point for updating the on-disk partition</span>
03072 <span class="comment">    structures of a disk.  The disk is only written to if the partition</span>
03073 <span class="comment">    structure has been changed by adding or deleting partitions.</span>
03074 <span class="comment"></span>
03075 <span class="comment">Arguments:</span>
03076 <span class="comment"></span>
03077 <span class="comment">    Disk - index of disk whose on-disk partition structure is to be updated.</span>
03078 <span class="comment"></span>
03079 <span class="comment">Return Value:</span>
03080 <span class="comment"></span>
03081 <span class="comment">    OK_STATUS or error code.</span>
03082 <span class="comment"></span>
03083 <span class="comment">--*/</span>
03084 
03085 {
03086     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a>  p;
03087     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> status;
03088 
03089     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(!<a class="code" href="../../d8/d1/fdengine_8c.html#a7">OffLine</a>[Disk]);
03090 
03091     <span class="keywordflow">if</span>(!<a class="code" href="../../d8/d1/fdengine_8c.html#a69">HavePartitionsBeenChanged</a>(Disk)) {
03092         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
03093     }
03094 
03095     <span class="keywordflow">if</span>((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a67">WriteDriveLayout</a>(Disk)) != <a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>) {
03096         <span class="keywordflow">return</span>(status);
03097     }
03098 
03099     <span class="comment">// BUGBUG for ARC and NT MIPS, update NVRAM vars so partitions are right.</span>
03100     <span class="comment">//        Do that here, before partition numbers are reassigned.</span>
03101 
03102     p = <a class="code" href="../../d8/d1/fdengine_8c.html#a5">PrimaryPartitions</a>[Disk];
03103     <span class="keywordflow">while</span>(p) {
03104         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03105         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o5">OriginalPartitionNumber</a> = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o6">PartitionNumber</a>;
03106         p = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
03107     }
03108     p = <a class="code" href="../../d8/d1/fdengine_8c.html#a6">LogicalVolumes</a>[Disk];
03109     <span class="keywordflow">while</span>(p) {
03110         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o8">Update</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03111         p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o5">OriginalPartitionNumber</a> = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o6">PartitionNumber</a>;
03112         p = p-&gt;<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o0">Next</a>;
03113     }
03114 
03115     <a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>[Disk] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03116     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a23">OK_STATUS</a>);
03117 }
03118 
03119 
03120 BOOLEAN
<a name="l03121"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a69">03121</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a69">HavePartitionsBeenChanged</a>(
03122     IN ULONG Disk
03123     )
03124 
03125 <span class="comment">/*++</span>
03126 <span class="comment"></span>
03127 <span class="comment">Routine Description:</span>
03128 <span class="comment"></span>
03129 <span class="comment">    This routine returns TRUE if the given disk's partition structures</span>
03130 <span class="comment">    have been modified by adding or deleting partitions, since the</span>
03131 <span class="comment">    on-disk structures were last written by a call to CommitPartitionChanges</span>
03132 <span class="comment">    (or first read).</span>
03133 <span class="comment"></span>
03134 <span class="comment">Arguments:</span>
03135 <span class="comment"></span>
03136 <span class="comment">    Disk - index of disk to check</span>
03137 <span class="comment"></span>
03138 <span class="comment">Return Value:</span>
03139 <span class="comment"></span>
03140 <span class="comment">    true if Disk's partition structure has changed.</span>
03141 <span class="comment"></span>
03142 <span class="comment">--*/</span>
03143 
03144 {
03145     <span class="keywordflow">if</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a7">OffLine</a>[Disk]) {
03146         <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(!<a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>[Disk]);
03147     }
03148     <span class="keywordflow">return</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>[Disk]);
03149 }
03150 
03151 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03152"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a70">03152</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a70">FdMarkDiskDirty</a>(
03153     IN ULONG Disk
03154     )
03155 {
03156     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(!<a class="code" href="../../d8/d1/fdengine_8c.html#a7">OffLine</a>[Disk]);
03157 
03158     <a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>[Disk] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03159 }
03160 
03161 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03162"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a71">03162</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a71">FdSetPersistentData</a>(
03163     IN <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Region,
03164     IN ULONG              Data
03165     )
03166 {
03167     ((<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html">PREGION_DATA</a>)(Region-&gt;Reserved))-&gt;Partition-&gt;PersistentData = Data;
03168 }
03169 
03170 
03171 ULONG
<a name="l03172"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a72">03172</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a72">FdGetMinimumSizeMB</a>(
03173     IN ULONG Disk
03174     )
03175 
03176 <span class="comment">/*++</span>
03177 <span class="comment"></span>
03178 <span class="comment">Routine Description:</span>
03179 <span class="comment"></span>
03180 <span class="comment">    Return the minimum size for a partition on a given disk.</span>
03181 <span class="comment"></span>
03182 <span class="comment">    This is the rounded size of one cylinder or 1, whichever is greater.</span>
03183 <span class="comment"></span>
03184 <span class="comment">Arguments:</span>
03185 <span class="comment"></span>
03186 <span class="comment">    Region - region describing the partition to check.</span>
03187 <span class="comment"></span>
03188 <span class="comment">Return Value:</span>
03189 <span class="comment"></span>
03190 <span class="comment">    Actual offset</span>
03191 <span class="comment"></span>
03192 <span class="comment">--*/</span>
03193 
03194 {
03195     LARGE_INTEGER   LargeInteger;
03196 
03197     LargeInteger.QuadPart = <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o4">BytesPerCylinder</a>;
03198     <span class="keywordflow">return</span>(<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d8/d1/fdengine_8c.html#a50">SIZEMB</a>(LargeInteger),1));
03199 }
03200 
03201 
03202 ULONG
<a name="l03203"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a73">03203</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a73">FdGetMaximumSizeMB</a>(
03204     IN <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Region,
03205     IN REGION_TYPE        CreationType
03206     )
03207 {
03208     <a class="code" href="../../d3/d9/struct__tagREGION__DATA.html">PREGION_DATA</a> CreateData = Region-&gt;Reserved;
03209     LARGE_INTEGER MaxSize = CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o2">AlignedRegionSize</a>;
03210 
03211     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(Region-&gt;SysID == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>);
03212 
03213     <span class="keywordflow">if</span>(CreateData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o1">AlignedRegionOffset</a>.QuadPart == 0) {
03214 
03215         ULONG Delta;
03216 
03217         <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>((CreationType == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a68">REGION_EXTENDED</a>) || (CreationType == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a67">REGION_PRIMARY</a>))
03218 
03219         Delta = (CreationType == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a68">REGION_EXTENDED</a>)
03220               ? <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Region-&gt;Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o4">BytesPerCylinder</a>
03221               : <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Region-&gt;Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o5">BytesPerTrack</a>;
03222 
03223         MaxSize.QuadPart = MaxSize.QuadPart - Delta;
03224     }
03225 
03226     <span class="keywordflow">return</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a50">SIZEMB</a>(MaxSize));
03227 }
03228 
03229 
03230 LARGE_INTEGER
<a name="l03231"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a74">03231</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a74">FdGetExactSize</a>(
03232     IN <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Region,
03233     IN BOOLEAN            ForExtended
03234     )
03235 {
03236     <a class="code" href="../../d3/d9/struct__tagREGION__DATA.html">PREGION_DATA</a>  RegionData = Region-&gt;Reserved;
03237     LARGE_INTEGER LargeSize = RegionData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o2">AlignedRegionSize</a>;
03238     LARGE_INTEGER BytesPerTrack;
03239     LARGE_INTEGER BytesPerCylinder;
03240 
03241     BytesPerTrack.QuadPart = (<a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Region-&gt;Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o5">BytesPerTrack</a>);
03242     BytesPerCylinder.QuadPart = (<a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Region-&gt;Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o4">BytesPerCylinder</a>);
03243 
03244     <span class="keywordflow">if</span>(Region-&gt;RegionType == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>) {
03245 
03246         <span class="comment">//</span>
03247         <span class="comment">// The region is within the extended partition.  It doesn't matter</span>
03248         <span class="comment">// whether it's free space or used -- in either case, we need to</span>
03249         <span class="comment">// account for the reserved EBR track.</span>
03250         <span class="comment">//</span>
03251 
03252         LargeSize.QuadPart = LargeSize.QuadPart - BytesPerTrack.QuadPart;
03253 
03254     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(Region-&gt;SysID == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) {
03255 
03256         <span class="comment">//</span>
03257         <span class="comment">// The region is unused space not inside the extended partition.</span>
03258         <span class="comment">// We must know whether the caller will put a primary or extended</span>
03259         <span class="comment">// partition there -- a primary partition can use all the space, but</span>
03260         <span class="comment">// a logical volume in the extended partition won't include the first</span>
03261         <span class="comment">// track.  If the free space starts at offset 0 on the disk, a special</span>
03262         <span class="comment">// calculation must be used to move the start of the partition to</span>
03263         <span class="comment">// skip a track for a primary or a cylinder and a track for an</span>
03264         <span class="comment">// extended+logical.</span>
03265         <span class="comment">//</span>
03266 
03267         <span class="keywordflow">if</span>((RegionData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o1">AlignedRegionOffset</a>.QuadPart == 0) || ForExtended) {
03268             LargeSize.QuadPart = LargeSize.QuadPart - BytesPerTrack.QuadPart;
03269         }
03270 
03271         <span class="keywordflow">if</span>((RegionData-&gt;<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html#o1">AlignedRegionOffset</a>.QuadPart == 0) &amp;&amp; ForExtended) {
03272             LargeSize.QuadPart = LargeSize.QuadPart - BytesPerCylinder.QuadPart;
03273         }
03274     }
03275 
03276     <span class="keywordflow">return</span>(LargeSize);
03277 }
03278 
03279 
03280 LARGE_INTEGER
<a name="l03281"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a75">03281</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a75">FdGetExactOffset</a>(
03282     IN <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Region
03283     )
03284 
03285 <span class="comment">/*++</span>
03286 <span class="comment"></span>
03287 <span class="comment">Routine Description:</span>
03288 <span class="comment"></span>
03289 <span class="comment">    Determine where a given partition _actually_ starts, which may be</span>
03290 <span class="comment">    different than where is appears because of EBR reserved tracks, etc.</span>
03291 <span class="comment"></span>
03292 <span class="comment">    NOTE: This routine is not meant to operate on unused regions or</span>
03293 <span class="comment">    extended partitions.  In these cases, it just returns the apparant offset.</span>
03294 <span class="comment"></span>
03295 <span class="comment">Arguments:</span>
03296 <span class="comment"></span>
03297 <span class="comment">    Region - region describing the partition to check.</span>
03298 <span class="comment"></span>
03299 <span class="comment">Return Value:</span>
03300 <span class="comment"></span>
03301 <span class="comment">    Actual offset</span>
03302 <span class="comment"></span>
03303 <span class="comment">--*/</span>
03304 
03305 {
03306     LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = ((<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html">PREGION_DATA</a>)(Region-&gt;Reserved))-&gt;Partition-&gt;Offset;
03307 
03308     <span class="keywordflow">if</span>((Region-&gt;SysID != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) &amp;&amp; (Region-&gt;RegionType == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>)) {
03309 
03310         <span class="comment">//</span>
03311         <span class="comment">// The region is a logical volume.</span>
03312         <span class="comment">// Account for the reserved EBR track.</span>
03313         <span class="comment">//</span>
03314 
03315         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart +
03316                                  <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Region-&gt;Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o5">BytesPerTrack</a>;
03317     }
03318 
03319     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>);
03320 }
03321 
03322 
03323 BOOLEAN
<a name="l03324"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a76">03324</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a76">FdCrosses1024Cylinder</a>(
03325     IN <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Region,
03326     IN ULONG              CreationSizeMB,
03327     IN REGION_TYPE        RegionType
03328     )
03329 
03330 <span class="comment">/*++</span>
03331 <span class="comment"></span>
03332 <span class="comment">Routine Description:</span>
03333 <span class="comment"></span>
03334 <span class="comment">    Determine whether a used region corsses the 1024th cylinder, or whether</span>
03335 <span class="comment">    a partition created within a free space will cross the 1024th cylinder.</span>
03336 <span class="comment"></span>
03337 <span class="comment">Arguments:</span>
03338 <span class="comment"></span>
03339 <span class="comment">    Region - region describing the partition to check.</span>
03340 <span class="comment"></span>
03341 <span class="comment">    CreationSizeMB - if the Region is for a free space, this is the size of</span>
03342 <span class="comment">        the partition to be checked.</span>
03343 <span class="comment"></span>
03344 <span class="comment">    RegionType - one of REGION_PRIMARY, REGION_EXTENDED, or REGION_LOGICAL</span>
03345 <span class="comment"></span>
03346 <span class="comment">Return Value:</span>
03347 <span class="comment"></span>
03348 <span class="comment">    TRUE if the end cylinder &gt;= 1024.</span>
03349 <span class="comment"></span>
03350 <span class="comment">--*/</span>
03351 
03352 {
03353     LARGE_INTEGER <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>, LargeZero;
03354 
03355     <span class="keywordflow">if</span>(Region-&gt;SysID == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) {
03356 
03357         <span class="comment">//</span>
03358         <span class="comment">// Determine the exact size and offset of the partition, according</span>
03359         <span class="comment">// to how CreatePartitionEx() will do it.</span>
03360         <span class="comment">//</span>
03361 
03362         LargeZero.QuadPart = 0;
03363         <a class="code" href="../../d8/d1/fdengine_8c.html#a32">DetermineCreateSizeAndOffset</a>( Region,
03364                                       LargeZero,
03365                                       CreationSizeMB,
03366                                       RegionType,
03367                                       &amp;<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,
03368                                       &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
03369                                     );
03370 
03371     } <span class="keywordflow">else</span> {
03372 
03373         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = ((<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html">PREGION_DATA</a>)(Region-&gt;Reserved))-&gt;Partition-&gt;Offset;
03374         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>  = ((<a class="code" href="../../d3/d9/struct__tagREGION__DATA.html">PREGION_DATA</a>)(Region-&gt;Reserved))-&gt;Partition-&gt;Length;
03375     }
03376 
03377     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>.QuadPart = (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>.QuadPart + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.QuadPart) - 1;
03378 
03379     <span class="comment">//</span>
03380     <span class="comment">// End is the last byte in the partition.  Divide by the number of</span>
03381     <span class="comment">// bytes in a cylinder and see whether the result is &gt; 1023.</span>
03382     <span class="comment">//</span>
03383 
03384     <span class="keywordflow">return</span>( (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>.QuadPart / <a class="code" href="../../d8/d1/fdengine_8c.html#a4">DiskGeometryArray</a>[Region-&gt;Disk].<a class="code" href="../../d6/d8/struct__tagDISKGEOM.html#o4">BytesPerCylinder</a>) &gt; 1023 );
03385 }
03386 
03387 
03388 BOOLEAN
<a name="l03389"></a><a class="code" href="../../d8/d1/fdengine_8c.html#a77">03389</a> <a class="code" href="../../d8/d1/fdengine_8c.html#a77">IsDiskOffLine</a>(
03390     IN ULONG Disk
03391     )
03392 {
03393     <span class="keywordflow">return</span>(<a class="code" href="../../d8/d1/fdengine_8c.html#a7">OffLine</a>[Disk]);
03394 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:59 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
