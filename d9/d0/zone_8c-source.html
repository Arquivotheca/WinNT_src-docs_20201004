<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: zone.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>zone.c</h1><a href="../../d8/d1/zone_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    zone.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements a simple zone buffer manager.  The primary</span>
00012 <span class="comment">    consumer of this module is local LPC.</span>
00013 <span class="comment"></span>
00014 <span class="comment">    The zone package provides a fast and efficient memory allocator for</span>
00015 <span class="comment">    fixed-size 64-bit aligned blocks of storage.  The zone package does</span>
00016 <span class="comment">    not provide any serialization over access to the zone header and</span>
00017 <span class="comment">    associated free list and segment list.  It is the responsibility of</span>
00018 <span class="comment">    the caller to provide any necessary serialization.</span>
00019 <span class="comment"></span>
00020 <span class="comment">    The zone package views a zone as a set of fixed-size blocks of</span>
00021 <span class="comment">    storage.  The block size of a zone is specified during zone</span>
00022 <span class="comment">    initialization.  Storage is assigned to a zone during zone</span>
00023 <span class="comment">    initialization and when a zone is extended.  In both of these cases,</span>
00024 <span class="comment">    a segment and length are specified.</span>
00025 <span class="comment"></span>
00026 <span class="comment">    The zone package uses the first ZONE_SEGMENT_HEADER portion of the</span>
00027 <span class="comment">    segment for zone overhead.  The remainder of the segment is carved</span>
00028 <span class="comment">    up into fixed-size blocks and each block is added to the free list</span>
00029 <span class="comment">    maintained in the zone header.</span>
00030 <span class="comment"></span>
00031 <span class="comment">    As long as a block is on the free list, the first SINGLE_LIST_ENTRY</span>
00032 <span class="comment">    (32 bit) sized piece of the block is used as zone overhead.  The</span>
00033 <span class="comment">    rest of the block is not used by the zone package and may be used by</span>
00034 <span class="comment">    applications to cache information.  When a block is not on the free</span>
00035 <span class="comment">    list, its entire contents are available to the application.</span>
00036 <span class="comment"></span>
00037 <span class="comment">Author:</span>
00038 <span class="comment"></span>
00039 <span class="comment">    Mark Lucovsky (markl) 13-May-1989</span>
00040 <span class="comment"></span>
00041 <span class="comment">Revision History:</span>
00042 <span class="comment"></span>
00043 <span class="comment">--*/</span>
00044 
00045 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00046 
00047 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00048"></a><a class="code" href="../../d5/d8/ex_8h.html#a263">00048</a> <a class="code" href="../../d5/d8/ex_8h.html#a263">ExInitializeZone</a>(
00049     IN <a class="code" href="../../d0/d0/struct__ZONE__HEADER.html">PZONE_HEADER</a> Zone,
00050     IN ULONG BlockSize,
00051     IN PVOID InitialSegment,
00052     IN ULONG InitialSegmentSize
00053     )
00054 
00055 <span class="comment">/*++</span>
00056 <span class="comment"></span>
00057 <span class="comment">Routine Description:</span>
00058 <span class="comment"></span>
00059 <span class="comment">    This function initializes a zone header.  Once successfully</span>
00060 <span class="comment">    initialized, blocks can be allocated and freed from the zone, and</span>
00061 <span class="comment">    the zone can be extended.</span>
00062 <span class="comment"></span>
00063 <span class="comment">Arguments:</span>
00064 <span class="comment"></span>
00065 <span class="comment">    Zone - Supplies the address of a zone header to be initialized.</span>
00066 <span class="comment"></span>
00067 <span class="comment">    BlockSize - Supplies the block size of the allocatable unit within</span>
00068 <span class="comment">                the zone.  The size must be larger that the size of the</span>
00069 <span class="comment">                initial segment, and must be 64-bit aligned.</span>
00070 <span class="comment"></span>
00071 <span class="comment">    InitialSegment - Supplies the address of a segment of storage.  The</span>
00072 <span class="comment">                     first ZONE_SEGMENT_HEADER-sized portion of the segment</span>
00073 <span class="comment">                     is used by the zone allocator.  The remainder of</span>
00074 <span class="comment">                     the segment is carved up into fixed size</span>
00075 <span class="comment">                     (BlockSize) blocks and is made available for</span>
00076 <span class="comment">                     allocation and deallocation from the zone.  The</span>
00077 <span class="comment">                     address of the segment must be aligned on a 64-bit</span>
00078 <span class="comment">                     boundary.</span>
00079 <span class="comment"></span>
00080 <span class="comment">    InitialSegmentSize - Supplies the size in bytes of the InitialSegment.</span>
00081 <span class="comment"></span>
00082 <span class="comment">Return Value:</span>
00083 <span class="comment"></span>
00084 <span class="comment">    STATUS_UNSUCCESSFUL - BlockSize or InitialSegment was not aligned on</span>
00085 <span class="comment">                          64-bit boundaries, or BlockSize was larger than</span>
00086 <span class="comment">                          the initial segment size.</span>
00087 <span class="comment"></span>
00088 <span class="comment">    STATUS_SUCCESS - The zone was successfully initialized.</span>
00089 <span class="comment"></span>
00090 <span class="comment">--*/</span>
00091 
00092 {
00093     ULONG i;
00094     PCH p;
00095 
00096     <span class="keywordflow">if</span> ( (<a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a> &amp; 7) || ((ULONG_PTR)InitialSegment &amp; 7) ||
00097          (<a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a> &gt; InitialSegmentSize) ) {
00098 <span class="preprocessor">#if DBG</span>
00099 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"EX: ExInitializeZone( %x, %x, %x, %x ) - Invalid parameters.\n"</span>,
00100                   Zone, <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>, InitialSegment, InitialSegmentSize
00101                 );
00102         DbgBreakPoint();
00103 <span class="preprocessor">#endif</span>
00104 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00105     }
00106 
00107     Zone-&gt;BlockSize = <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00108 
00109     Zone-&gt;SegmentList.Next = &amp;((<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">PZONE_SEGMENT_HEADER</a>) InitialSegment)-&gt;SegmentList;
00110     ((<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">PZONE_SEGMENT_HEADER</a>) InitialSegment)-&gt;SegmentList.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00111     ((<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">PZONE_SEGMENT_HEADER</a>) InitialSegment)-&gt;Reserved = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00112 
00113     Zone-&gt;FreeList.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00114 
00115     p = (PCH)InitialSegment + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">ZONE_SEGMENT_HEADER</a>);
00116 
00117     <span class="keywordflow">for</span> (i = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">ZONE_SEGMENT_HEADER</a>);
00118          i &lt;= InitialSegmentSize - <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00119          i += <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>
00120         ) {
00121         ((PSINGLE_LIST_ENTRY)p)-&gt;Next = Zone-&gt;FreeList.Next;
00122         Zone-&gt;FreeList.Next = (PSINGLE_LIST_ENTRY)p;
00123         p += <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00124     }
00125     Zone-&gt;TotalSegmentSize = i;
00126 
00127 <span class="preprocessor">#if 0</span>
00128 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"EX: ExInitializeZone( %lx, %lx, %lu, %lu, %lx )\n"</span>,
00129               Zone, InitialSegment, InitialSegmentSize,
00130               <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>, p
00131             );
00132 <span class="preprocessor">#endif</span>
00133 <span class="preprocessor"></span>
00134     <span class="keywordflow">return</span> STATUS_SUCCESS;
00135 }
00136 
00137 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00138"></a><a class="code" href="../../d5/d8/ex_8h.html#a264">00138</a> <a class="code" href="../../d5/d8/ex_8h.html#a264">ExExtendZone</a>(
00139     IN <a class="code" href="../../d0/d0/struct__ZONE__HEADER.html">PZONE_HEADER</a> Zone,
00140     IN PVOID Segment,
00141     IN ULONG SegmentSize
00142     )
00143 
00144 <span class="comment">/*++</span>
00145 <span class="comment"></span>
00146 <span class="comment">Routine Description:</span>
00147 <span class="comment"></span>
00148 <span class="comment">    This function extends a zone by adding another segment's worth of</span>
00149 <span class="comment">    blocks to the zone.</span>
00150 <span class="comment"></span>
00151 <span class="comment">Arguments:</span>
00152 <span class="comment"></span>
00153 <span class="comment">    Zone - Supplies the address of a zone header to be extended.</span>
00154 <span class="comment"></span>
00155 <span class="comment">    Segment - Supplies the address of a segment of storage.  The first</span>
00156 <span class="comment">              ZONE_SEGMENT_HEADER-sized portion of the segment is used by the</span>
00157 <span class="comment">              zone allocator.  The remainder of the segment is carved up</span>
00158 <span class="comment">              into fixed-size (BlockSize) blocks and is added to the</span>
00159 <span class="comment">              zone.  The address of the segment must be aligned on a 64-</span>
00160 <span class="comment">              bit boundary.</span>
00161 <span class="comment"></span>
00162 <span class="comment">    SegmentSize - Supplies the size in bytes of Segment.</span>
00163 <span class="comment"></span>
00164 <span class="comment">Return Value:</span>
00165 <span class="comment"></span>
00166 <span class="comment">    STATUS_UNSUCCESSFUL - BlockSize or Segment was not aligned on</span>
00167 <span class="comment">                          64-bit boundaries, or BlockSize was larger than</span>
00168 <span class="comment">                          the segment size.</span>
00169 <span class="comment"></span>
00170 <span class="comment">    STATUS_SUCCESS - The zone was successfully extended.</span>
00171 <span class="comment"></span>
00172 <span class="comment">--*/</span>
00173 
00174 {
00175     ULONG i;
00176     PCH p;
00177 
00178     <span class="keywordflow">if</span> ( ((ULONG_PTR)Segment &amp; 7) ||
00179          (SegmentSize &amp; 7) ||
00180          (Zone-&gt;BlockSize &gt; SegmentSize) ) {
00181         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00182     }
00183 
00184     ((<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">PZONE_SEGMENT_HEADER</a>) Segment)-&gt;SegmentList.Next = Zone-&gt;SegmentList.Next;
00185     Zone-&gt;SegmentList.Next = &amp;((<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">PZONE_SEGMENT_HEADER</a>) Segment)-&gt;SegmentList;
00186 
00187     p = (PCH)Segment + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">ZONE_SEGMENT_HEADER</a>);
00188 
00189     <span class="keywordflow">for</span> (i = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">ZONE_SEGMENT_HEADER</a>);
00190          i &lt;= SegmentSize - Zone-&gt;BlockSize;
00191          i += Zone-&gt;BlockSize
00192         ) {
00193 
00194         ((PSINGLE_LIST_ENTRY)p)-&gt;Next = Zone-&gt;FreeList.Next;
00195         Zone-&gt;FreeList.Next = (PSINGLE_LIST_ENTRY)p;
00196         p += Zone-&gt;BlockSize;
00197     }
00198     Zone-&gt;TotalSegmentSize += i;
00199 
00200 <span class="preprocessor">#if 0</span>
00201 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"EX: ExExtendZone( %lx, %lx, %lu, %lu, %lx )\n"</span>,
00202               Zone, Segment, SegmentSize, Zone-&gt;BlockSize, p
00203             );
00204 <span class="preprocessor">#endif</span>
00205 <span class="preprocessor"></span>
00206     <span class="keywordflow">return</span> STATUS_SUCCESS;
00207 }
00208 
00209 
00210 
00211 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00212"></a><a class="code" href="../../d5/d8/ex_8h.html#a265">00212</a> <a class="code" href="../../d5/d8/ex_8h.html#a265">ExInterlockedExtendZone</a>(
00213     IN <a class="code" href="../../d0/d0/struct__ZONE__HEADER.html">PZONE_HEADER</a> Zone,
00214     IN PVOID Segment,
00215     IN ULONG SegmentSize,
00216     IN PKSPIN_LOCK Lock
00217     )
00218 
00219 <span class="comment">/*++</span>
00220 <span class="comment"></span>
00221 <span class="comment">Routine Description:</span>
00222 <span class="comment"></span>
00223 <span class="comment">    This function extends a zone by adding another segment's worth of</span>
00224 <span class="comment">    blocks to the zone.</span>
00225 <span class="comment"></span>
00226 <span class="comment">Arguments:</span>
00227 <span class="comment"></span>
00228 <span class="comment">    Zone - Supplies the address of a zone header to be extended.</span>
00229 <span class="comment"></span>
00230 <span class="comment">    Segment - Supplies the address of a segment of storage.  The first</span>
00231 <span class="comment">              ZONE_SEGMENT_HEADER-sized portion of the segment is used by the</span>
00232 <span class="comment">              zone allocator.  The remainder of the segment is carved up</span>
00233 <span class="comment">              into fixed-size (BlockSize) blocks and is added to the</span>
00234 <span class="comment">              zone.  The address of the segment must be aligned on a 64-</span>
00235 <span class="comment">              bit boundary.</span>
00236 <span class="comment"></span>
00237 <span class="comment">    SegmentSize - Supplies the size in bytes of Segment.</span>
00238 <span class="comment"></span>
00239 <span class="comment">    Lock - pointer to spinlock to use</span>
00240 <span class="comment"></span>
00241 <span class="comment">Return Value:</span>
00242 <span class="comment"></span>
00243 <span class="comment">    STATUS_UNSUCCESSFUL - BlockSize or Segment was not aligned on</span>
00244 <span class="comment">                          64-bit boundaries, or BlockSize was larger than</span>
00245 <span class="comment">                          the segment size.</span>
00246 <span class="comment"></span>
00247 <span class="comment">    STATUS_SUCCESS - The zone was successfully extended.</span>
00248 <span class="comment"></span>
00249 <span class="comment">--*/</span>
00250 
00251 {
00252     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00253     KIRQL OldIrql;
00254 
00255     ExAcquireSpinLock( <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>, &amp;OldIrql );
00256 
00257     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d8/ex_8h.html#a264">ExExtendZone</a>( Zone, Segment, SegmentSize );
00258 
00259     ExReleaseSpinLock( <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>, OldIrql );
00260 
00261     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00262 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
