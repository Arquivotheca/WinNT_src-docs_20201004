<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lboxctl1.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lboxctl1.c</h1><a href="../../d8/d1/lboxctl1_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: lboxctl1.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* List Box Handling Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* ??-???-???? ianja    Ported from Win 3.0 sources</span>
00010 <span class="comment">* 14-Feb-1991 mikeke   Added Revalidation code</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d8/d1/lboxctl1_8c.html#a0">xxxLBBinarySearchString</a>(<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,LPWSTR lpstr);
00017 
00018 <span class="comment">/***************************************************************************\</span>
00019 <span class="comment">*</span>
00020 <span class="comment">*  SetLBScrollParms()</span>
00021 <span class="comment">*</span>
00022 <span class="comment">*  Sets the scroll range, page, and position</span>
00023 <span class="comment">*</span>
00024 <span class="comment">\***************************************************************************/</span>
00025 
<a name="l00026"></a><a class="code" href="../../d6/d0/usercli_8h.html#a739">00026</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d0/usercli_8h.html#a739">xxxSetLBScrollParms</a>(<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb, <span class="keywordtype">int</span> nCtl)
00027 {
00028     <span class="keywordtype">int</span>         iPos;
00029     <span class="keywordtype">int</span>         cItems;
00030     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        iPage;
00031     SCROLLINFO  si;
00032     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fNoScroll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00033     <a class="code" href="../../d0/d9/struct__SCROLLPOS.html">PSCROLLPOS</a>  psp;
00034     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fCacheInitialized;
00035     <span class="keywordtype">int</span>         iReturn;
00036 
00037     <span class="keywordflow">if</span> (nCtl == SB_VERT) {
00038         iPos = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>;
00039         cItems = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>;
00040         iPage = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o5">cItemFullMax</a>;
00041         <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o39">fVertBar</a>)
00042             fNoScroll = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00043         psp = &amp;plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o64">VPos</a>;
00044         fCacheInitialized = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o43">fVertInitialized</a>;
00045     } <span class="keywordflow">else</span> {
00046         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>) {
00047             iPos   = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>;
00048             cItems = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> ? ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1) / plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o15">itemsPerColumn</a>) + 1 : 0;
00049             iPage = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o16">numberOfColumns</a>;
00050             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a> &amp;&amp; cItems)
00051                 iPos = cItems - iPos - 1;
00052         } <span class="keywordflow">else</span> {
00053             iPos = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a>;
00054             cItems = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o57">maxWidth</a>;
00055             iPage = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
00056         }
00057 
00058         <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o38">fHorzBar</a>)
00059             fNoScroll = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00060         psp = &amp;plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o63">HPos</a>;
00061         fCacheInitialized = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o42">fHorzInitialized</a>;
00062     }
00063 
00064     <span class="keywordflow">if</span> (cItems)
00065         cItems--;
00066 
00067     <span class="keywordflow">if</span> (fNoScroll) {
00068         <span class="comment">// Limit page to 0, posMax + 1</span>
00069         iPage = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((<span class="keywordtype">int</span>)iPage, cItems + 1), 0);
00070 
00071         <span class="comment">// Limit pos to 0, posMax - (page - 1).</span>
00072         <span class="keywordflow">return</span>(<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(iPos, cItems - ((iPage) ? (<span class="keywordtype">int</span>)(iPage - 1) : 0)), 0));
00073     } <span class="keywordflow">else</span> {
00074         si.fMask    = SIF_ALL;
00075         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o37">fDisableNoScroll</a>)
00076             si.fMask |= SIF_DISABLENOSCROLL;
00077 
00078         <span class="comment">/*</span>
00079 <span class="comment">         * If the scrollbar is already where we want it, do nothing.</span>
00080 <span class="comment">         */</span>
00081         <span class="keywordflow">if</span> (fCacheInitialized) {
00082             <span class="keywordflow">if</span> (psp-&gt;<a class="code" href="../../d0/d9/struct__SCROLLPOS.html#o3">fMask</a> == si.fMask &amp;&amp;
00083                     psp-&gt;<a class="code" href="../../d0/d9/struct__SCROLLPOS.html#o0">cItems</a> == cItems &amp;&amp; psp-&gt;<a class="code" href="../../d0/d9/struct__SCROLLPOS.html#o1">iPage</a> == iPage &amp;&amp;
00084                     psp-&gt;<a class="code" href="../../d0/d9/struct__SCROLLPOS.html#o2">iPos</a> == iPos)
00085                 <span class="keywordflow">return</span> psp-&gt;<a class="code" href="../../d0/d9/struct__SCROLLPOS.html#o4">iReturn</a>;
00086         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nCtl == SB_VERT) {
00087             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o43">fVertInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00088         } <span class="keywordflow">else</span> {
00089             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o42">fHorzInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00090         }
00091 
00092         si.cbSize   = <span class="keyword">sizeof</span>(SCROLLINFO);
00093         si.nMin     = 0;
00094         si.nMax     = cItems;
00095         si.nPage    = iPage;
00096 
00097         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a> &amp;&amp; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a>)
00098             si.nPos =  (iPos+1) &gt; (<span class="keywordtype">int</span>)iPage ? iPos - iPage + 1 : 0;
00099         <span class="keywordflow">else</span>
00100             si.nPos = iPos;
00101 
00102         iReturn = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a228">NtUserSetScrollInfo</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), nCtl, &amp;si, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o19">fRedraw</a>);
00103         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a> &amp;&amp; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a>)
00104             iReturn = cItems - (iReturn + iPage - 1);
00105 
00106         <span class="comment">/*</span>
00107 <span class="comment">         * Update the position cache</span>
00108 <span class="comment">         */</span>
00109         psp-&gt;<a class="code" href="../../d0/d9/struct__SCROLLPOS.html#o3">fMask</a> = si.fMask;
00110         psp-&gt;<a class="code" href="../../d0/d9/struct__SCROLLPOS.html#o0">cItems</a> = cItems;
00111         psp-&gt;<a class="code" href="../../d0/d9/struct__SCROLLPOS.html#o1">iPage</a> = iPage;
00112         psp-&gt;<a class="code" href="../../d0/d9/struct__SCROLLPOS.html#o2">iPos</a> = iPos;
00113         psp-&gt;<a class="code" href="../../d0/d9/struct__SCROLLPOS.html#o4">iReturn</a> = iReturn;
00114 
00115         <span class="keywordflow">return</span> iReturn;
00116     }
00117 }
00118 
00119 <span class="comment">/***************************************************************************\</span>
00120 <span class="comment">* xxxLBShowHideScrollBars</span>
00121 <span class="comment">*</span>
00122 <span class="comment">* History:</span>
00123 <span class="comment">\***************************************************************************/</span>
00124 
<a name="l00125"></a><a class="code" href="../../d6/d0/usercli_8h.html#a706">00125</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a706">xxxLBShowHideScrollBars</a>(
00126     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb)
00127 {
00128     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fVertDone = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00129     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fHorzDone = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00130 
00131     <span class="comment">// Don't do anything if there are no scrollbars or if parents</span>
00132     <span class="comment">// are invisible.</span>
00133     <span class="keywordflow">if</span> ((!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o38">fHorzBar</a> &amp;&amp; !plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o39">fVertBar</a>) || !plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o19">fRedraw</a>)
00134         <span class="keywordflow">return</span>;
00135 
00136     <span class="comment">//</span>
00137     <span class="comment">// Adjust iTop if necessary but DO NOT REDRAW PERIOD.  We never did</span>
00138     <span class="comment">// in 3.1.  There's a potential bug:</span>
00139     <span class="comment">//      If someone doesn't have redraw off and inserts an item in the</span>
00140     <span class="comment">// same position as the caret, we'll tell them to draw before they may</span>
00141     <span class="comment">// have called LB_SETITEMDATA for their item.  This is because we turn</span>
00142     <span class="comment">// the caret off &amp; on inside of NewITop(), even if the item isn't</span>
00143     <span class="comment">// changing.</span>
00144     <span class="comment">//      So we just want to reflect the position/scroll changes.</span>
00145     <span class="comment">// CheckRedraw() will _really_ redraw the visual changes later if</span>
00146     <span class="comment">// redraw isn't off.</span>
00147     <span class="comment">//</span>
00148 
00149     <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o40">fFromInsert</a>) {
00150         <a class="code" href="../../d6/d0/usercli_8h.html#a730">xxxNewITop</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>);
00151         fVertDone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00152     }
00153 
00154     <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a>) {
00155         <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o40">fFromInsert</a>) {
00156             fHorzDone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00157             <a class="code" href="../../d6/d0/usercli_8h.html#a703">xxxLBoxCtlHScroll</a>(plb, SB_THUMBPOSITION, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a>);
00158         }
00159 
00160         <span class="keywordflow">if</span> (!fVertDone)
00161             <a class="code" href="../../d6/d0/usercli_8h.html#a739">xxxSetLBScrollParms</a>(plb, SB_VERT);
00162     }
00163     <span class="keywordflow">if</span> (!fHorzDone)
00164         <a class="code" href="../../d6/d0/usercli_8h.html#a739">xxxSetLBScrollParms</a>(plb, SB_HORZ);
00165 }
00166 
00167 <span class="comment">/***************************************************************************\</span>
00168 <span class="comment">* LBGetItemData</span>
00169 <span class="comment">*</span>
00170 <span class="comment">* returns the long value associated with listbox items. -1 if error</span>
00171 <span class="comment">*</span>
00172 <span class="comment">* History:</span>
00173 <span class="comment">* 16-Apr-1992 beng      The NODATA listbox case</span>
00174 <span class="comment">\***************************************************************************/</span>
00175 
<a name="l00176"></a><a class="code" href="../../d6/d0/usercli_8h.html#a721">00176</a> LONG_PTR <a class="code" href="../../d6/d0/usercli_8h.html#a721">LBGetItemData</a>(
00177     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00178     INT sItem)
00179 {
00180     LONG_PTR buffer;
00181     LPBYTE lpItem;
00182 
00183     <span class="keywordflow">if</span> (sItem &lt; 0 || sItem &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>) {
00184         RIPERR0(ERROR_INVALID_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00185         <span class="keywordflow">return</span> LB_ERR;
00186     }
00187 
00188     <span class="comment">// No-data listboxes always return 0L</span>
00189     <span class="comment">//</span>
00190     <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o31">fHasData</a>) {
00191         <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00192     }
00193 
00194     lpItem = (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a> +
00195             (sItem * (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagLBItem.html">LBItem</a>) : <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/structtagLBODItem.html">LBODItem</a>))));
00196     buffer = (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a> ? ((<a class="code" href="../../d6/d9/structtagLBItem.html">lpLBItem</a>)lpItem)-&gt;itemData : ((<a class="code" href="../../d8/d9/structtagLBODItem.html">lpLBODItem</a>)lpItem)-&gt;itemData);
00197     <span class="keywordflow">return</span> buffer;
00198 }
00199 
00200 
00201 <span class="comment">/***************************************************************************\</span>
00202 <span class="comment">* LBGetText</span>
00203 <span class="comment">*</span>
00204 <span class="comment">* Copies the text associated with index to lpbuffer and returns its length.</span>
00205 <span class="comment">* If fLengthOnly, just return the length of the text without doing a copy.</span>
00206 <span class="comment">*</span>
00207 <span class="comment">* Waring: for size only querries lpbuffer is the count of ANSI characters</span>
00208 <span class="comment">*</span>
00209 <span class="comment">* Returns count of chars</span>
00210 <span class="comment">*</span>
00211 <span class="comment">* History:</span>
00212 <span class="comment">\***************************************************************************/</span>
00213 
<a name="l00214"></a><a class="code" href="../../d6/d0/usercli_8h.html#a722">00214</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d6/d0/usercli_8h.html#a722">LBGetText</a>(
00215     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00216     BOOL fLengthOnly,
00217     BOOL fAnsi,
00218     INT index,
00219     LPWSTR lpbuffer)
00220 {
00221     LPWSTR lpItemText;
00222     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> cchText;
00223 
00224     <span class="keywordflow">if</span> (index &lt; 0 || index &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>) {
00225         RIPERR0(ERROR_INVALID_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00226         <span class="keywordflow">return</span> LB_ERR;
00227     }
00228 
00229     <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a> &amp;&amp; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a>) {
00230 
00231         <span class="comment">/*</span>
00232 <span class="comment">         * Owner draw without strings so we must copy the app supplied DWORD</span>
00233 <span class="comment">         * value.</span>
00234 <span class="comment">         */</span>
00235         cchText = <span class="keyword">sizeof</span>(ULONG_PTR);
00236 
00237         <span class="keywordflow">if</span> (!fLengthOnly) {
00238             LONG_PTR UNALIGNED *p = (LONG_PTR UNALIGNED *)lpbuffer;
00239             *p = <a class="code" href="../../d6/d0/usercli_8h.html#a721">LBGetItemData</a>(plb, index);
00240         }
00241     } <span class="keywordflow">else</span> {
00242         lpItemText = <a class="code" href="../../d6/d0/usercli_8h.html#a715">GetLpszItem</a>(plb, index);
00243         <span class="keywordflow">if</span> (!lpItemText)
00244             <span class="keywordflow">return</span> LB_ERR;
00245 
00246         <span class="comment">/*</span>
00247 <span class="comment">         * These are strings so we are copying the text and we must include</span>
00248 <span class="comment">         * the terminating 0 when doing the RtlMoveMemory.</span>
00249 <span class="comment">         */</span>
00250         cchText = wcslen(lpItemText);
00251 
00252         <span class="keywordflow">if</span> (fLengthOnly) {
00253             <span class="keywordflow">if</span> (fAnsi)
00254                 <a class="code" href="../../d9/d6/nlsxlat_8c.html#a36">RtlUnicodeToMultiByteSize</a>(&amp;cchText, lpItemText, cchText*<span class="keyword">sizeof</span>(WCHAR));
00255         } <span class="keywordflow">else</span> {
00256             <span class="keywordflow">if</span> (fAnsi) {
00257 <span class="preprocessor">#ifdef FE_SB // LBGetText()</span>
00258 <span class="preprocessor"></span>                cchText = WCSToMB(lpItemText, cchText+1, &amp;((LPSTR)lpbuffer), (cchText+1)*<span class="keyword">sizeof</span>(WORD), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00259                 <span class="comment">/*</span>
00260 <span class="comment">                 * Here.. cchText contains null-terminate char, subtract it... Because, we pass cchText+1 to</span>
00261 <span class="comment">                 * above Unicode-&gt;Ansi convertsion to make sure the string is terminated with null.</span>
00262 <span class="comment">                 */</span>
00263                 cchText--;
00264 <span class="preprocessor">#else</span>
00265 <span class="preprocessor"></span>                WCSToMB(lpItemText, cchText+1, &amp;((LPSTR)lpbuffer), cchText+1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00266 <span class="preprocessor">#endif // FE_SB</span>
00267 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> {
00268                 RtlCopyMemory(lpbuffer, lpItemText, (cchText+1)*<span class="keyword">sizeof</span>(WCHAR));
00269             }
00270         }
00271 
00272     }
00273 
00274     <span class="keywordflow">return</span> cchText;
00275 }
00276 
00277 <span class="comment">/***************************************************************************\</span>
00278 <span class="comment">* GrowMem</span>
00279 <span class="comment">*</span>
00280 <span class="comment">* History:</span>
00281 <span class="comment">* 16-Apr-1992 beng      NODATA listboxes</span>
00282 <span class="comment">* 23-Jul-1996 jparsons  Added numItems parameter for LB_INITSTORAGE support</span>
00283 <span class="comment">\***************************************************************************/</span>
00284 
<a name="l00285"></a><a class="code" href="../../d8/d1/lboxctl1_8c.html#a5">00285</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d1/lboxctl1_8c.html#a5">GrowMem</a>(
00286     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00287     INT   numItems)
00288 
00289 {
00290     LONG cb;
00291     HANDLE hMem;
00292 
00293     <span class="comment">/*</span>
00294 <span class="comment">     * Allocate memory for pointers to the strings.</span>
00295 <span class="comment">     */</span>
00296     cb = (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o7">cMax</a> + numItems) *
00297             (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagLBItem.html">LBItem</a>)
00298                               : (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o31">fHasData</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/structtagLBODItem.html">LBODItem</a>)
00299                                               : 0));
00300 
00301     <span class="comment">/*</span>
00302 <span class="comment">     * If multiple selection list box (MULTIPLESEL or EXTENDEDSEL), then</span>
00303 <span class="comment">     * allocate an extra byte per item to keep track of it's selection state.</span>
00304 <span class="comment">     */</span>
00305     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> != <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>) {
00306         cb += (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o7">cMax</a> + numItems);
00307     }
00308 
00309     <span class="comment">/*</span>
00310 <span class="comment">     * Extra bytes for each item so that we can store its height.</span>
00311 <span class="comment">     */</span>
00312     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
00313         cb += (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o7">cMax</a> + numItems);
00314     }
00315 
00316     <span class="comment">/*</span>
00317 <span class="comment">     * Don't allocate more than 2G of memory</span>
00318 <span class="comment">     */</span>
00319     <span class="keywordflow">if</span> (cb &gt; MAXLONG)
00320         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00321 
00322     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00323         <span class="keywordflow">if</span> ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, (LONG)cb)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00324             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00325     } <span class="keywordflow">else</span> {
00326         <span class="keywordflow">if</span> ((hMem = <a class="code" href="../../d6/d0/usercli_8h.html#a137">UserLocalReAlloc</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a>, (LONG)cb, HEAP_ZERO_MEMORY)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00327             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00328         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a> = hMem;
00329     }
00330 
00331     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o7">cMax</a> += numItems;
00332 
00333     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00334 }
00335 
00336 <span class="comment">/***************************************************************************\</span>
00337 <span class="comment">* xxxLBInitStorage</span>
00338 <span class="comment">*</span>
00339 <span class="comment">* History:</span>
00340 <span class="comment">* 23-Jul-1996 jparsons  Added support for pre-allocation</span>
00341 <span class="comment">\***************************************************************************/</span>
<a name="l00342"></a><a class="code" href="../../d6/d0/usercli_8h.html#a749">00342</a> LONG <a class="code" href="../../d6/d0/usercli_8h.html#a749">xxxLBInitStorage</a>(<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb, BOOL fAnsi, INT cItems, INT cb)
00343 {
00344     HANDLE hMem;
00345     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>    cbChunk;
00346 
00347     <span class="comment">/*</span>
00348 <span class="comment">     * if the app is talking ANSI, then adjust for the worst case in unicode</span>
00349 <span class="comment">     * where each single ansi byte translates to one 16 bit unicode value</span>
00350 <span class="comment">     */</span>
00351     <span class="keywordflow">if</span> (fAnsi) {
00352         cb *= <span class="keyword">sizeof</span>(WCHAR) ;
00353     } <span class="comment">/* if */</span>
00354 
00355     <span class="comment">/*</span>
00356 <span class="comment">     * Fail if either of the parameters look bad.</span>
00357 <span class="comment">     */</span>
00358     <span class="keywordflow">if</span> ((cItems &lt; 0) || (cb &lt; 0)) {
00359         <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, LBN_ERRSPACE);
00360         <span class="keywordflow">return</span> LB_ERRSPACE;
00361     } <span class="comment">/* if */</span>
00362 
00363     <span class="comment">/*</span>
00364 <span class="comment">     * try to grow the pointer array (if necessary) accounting for the free space</span>
00365 <span class="comment">     * already available.</span>
00366 <span class="comment">     */</span>
00367     cItems -= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o7">cMax</a> - plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> ;
00368     <span class="keywordflow">if</span> ((cItems &gt; 0) &amp;&amp; !<a class="code" href="../../d8/d1/lboxctl1_8c.html#a5">GrowMem</a>(plb, cItems)) {
00369         <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, LBN_ERRSPACE);
00370         <span class="keywordflow">return</span> LB_ERRSPACE;
00371     } <span class="comment">/* if */</span>
00372 
00373     <span class="comment">/*</span>
00374 <span class="comment">     * now grow the string space if necessary</span>
00375 <span class="comment">     */</span>
00376     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a>) {
00377         <span class="keywordflow">if</span> ((cbChunk = (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o11">ichAlloc</a> + cb)) &gt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o10">cchStrings</a>) {
00378 
00379             <span class="comment">/*</span>
00380 <span class="comment">             * Round up to the nearest 256 byte chunk.</span>
00381 <span class="comment">             */</span>
00382             cbChunk = (cbChunk &amp; ~0xff) + 0x100;
00383             <span class="keywordflow">if</span> (!(hMem = <a class="code" href="../../d6/d0/usercli_8h.html#a137">UserLocalReAlloc</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o9">hStrings</a>, (LONG)cbChunk, 0))) {
00384                 <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, LBN_ERRSPACE);
00385                 <span class="keywordflow">return</span> LB_ERRSPACE;
00386             }
00387             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o9">hStrings</a> = hMem;
00388             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o10">cchStrings</a> = cbChunk;
00389         } <span class="comment">/* if */</span>
00390     } <span class="comment">/* if */</span>
00391 
00392     <span class="comment">/*</span>
00393 <span class="comment">     * return the number of items that can be stored</span>
00394 <span class="comment">     */</span>
00395     <span class="keywordflow">return</span> plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o7">cMax</a> ;
00396 }
00397 
00398 <span class="comment">/***************************************************************************\</span>
00399 <span class="comment">* xxxInsertString</span>
00400 <span class="comment">*</span>
00401 <span class="comment">* Insert an item at a specified position.</span>
00402 <span class="comment">*</span>
00403 <span class="comment">* History:</span>
00404 <span class="comment">* 16-Apr-1992 beng      NODATA listboxes</span>
00405 <span class="comment">\***************************************************************************/</span>
00406 
<a name="l00407"></a><a class="code" href="../../d8/d1/lboxctl1_8c.html#a7">00407</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d6/d0/usercli_8h.html#a685">xxxLBInsertItem</a>(
00408     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00409 
00410     <span class="comment">/*</span>
00411 <span class="comment">     * For owner draw listboxes without LBS_HASSTRINGS style, this is not a</span>
00412 <span class="comment">     * string but rather a 4 byte value we will store for the app.</span>
00413 <span class="comment">     */</span>
00414     LPWSTR lpsz,
00415     INT index,
00416     UINT wFlags)
00417 {
00418     MEASUREITEMSTRUCT measureItemStruct;
00419     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> cbString;
00420     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> cbChunk;
00421     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> lp;
00422     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> lpT;
00423     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> lpHeightStart;
00424     LONG cbItem;     <span class="comment">/* sizeof the Item in rgpch */</span>
00425     HANDLE hMem;
00426     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
00427 
00428     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
00429 
00430     <span class="keywordflow">if</span> (wFlags &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a117">LBI_ADD</a>)
00431         index = (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o22">fSort</a>) ? <a class="code" href="../../d8/d1/lboxctl1_8c.html#a0">xxxLBBinarySearchString</a>(plb, lpsz) : -1;
00432 
00433     <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a>) {
00434         <span class="keywordflow">if</span> (index != 0 &amp;&amp; index != -1) {
00435             RIPERR0(ERROR_INVALID_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00436             <span class="keywordflow">return</span> LB_ERR;
00437         }
00438 
00439         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = -1;
00440         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> = 0;
00441         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o7">cMax</a> = 0;
00442         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> = 0;
00443         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> = 0;
00444         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00445         <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a>)
00446             <span class="keywordflow">return</span> LB_ERR;
00447     }
00448 
00449     <span class="keywordflow">if</span> (index == -1) {
00450         index = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>;
00451     }
00452 
00453     <span class="keywordflow">if</span> (index &gt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> || plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> &gt;= MAXLONG) {
00454         RIPERR0(ERROR_INVALID_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00455         <span class="keywordflow">return</span> LB_ERR;
00456     }
00457 
00458     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a>) {
00459 
00460         <span class="comment">/*</span>
00461 <span class="comment">         * we must store the string in the hStrings memory block.</span>
00462 <span class="comment">         */</span>
00463         cbString = (wcslen(lpsz) + 1)*<span class="keyword">sizeof</span>(WCHAR);  <span class="comment">/* include 0 terminator */</span>
00464 
00465         <span class="keywordflow">if</span> ((cbChunk = (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o11">ichAlloc</a> + cbString)) &gt; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o10">cchStrings</a>) {
00466 
00467             <span class="comment">/*</span>
00468 <span class="comment">             * Round up to the nearest 256 byte chunk.</span>
00469 <span class="comment">             */</span>
00470             cbChunk = (cbChunk &amp; ~0xff) + 0x100;
00471             <span class="keywordflow">if</span> (!(hMem = <a class="code" href="../../d6/d0/usercli_8h.html#a137">UserLocalReAlloc</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o9">hStrings</a>, (LONG)cbChunk,
00472                     0))) {
00473                 <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, LBN_ERRSPACE);
00474                 <span class="keywordflow">return</span> LB_ERRSPACE;
00475             }
00476             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o9">hStrings</a> = hMem;
00477 
00478             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o10">cchStrings</a> = cbChunk;
00479         }
00480 
00481         <span class="comment">/*</span>
00482 <span class="comment">         * Note difference between Win 95 code with placement of new string</span>
00483 <span class="comment">         */</span>
00484         <span class="keywordflow">if</span> (wFlags &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a64">UPPERCASE</a>)
00485             <a class="code" href="../../d8/d0/wstrings_8c.html#a13">CharUpperBuffW</a>((LPWSTR)lpsz, cbString / <span class="keyword">sizeof</span>(WCHAR));
00486         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wFlags &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a65">LOWERCASE</a>)
00487             <a class="code" href="../../d8/d0/wstrings_8c.html#a12">CharLowerBuffW</a>((LPWSTR)lpsz, cbString / <span class="keyword">sizeof</span>(WCHAR));
00488 
00489         lp = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o9">hStrings</a>);
00490         RtlMoveMemory(lp + plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o11">ichAlloc</a>, lpsz, cbString);
00491     }
00492 
00493     <span class="comment">/*</span>
00494 <span class="comment">     * Now expand the pointer array.</span>
00495 <span class="comment">     */</span>
00496     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o7">cMax</a>) {
00497         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d1/lboxctl1_8c.html#a5">GrowMem</a>(plb, <a class="code" href="../../d6/d0/usercli_8h.html#a109">CITEMSALLOC</a>)) {
00498             <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, LBN_ERRSPACE);
00499             <span class="keywordflow">return</span> LB_ERRSPACE;
00500         }
00501     }
00502 
00503     lpHeightStart = lpT = lp = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a>;
00504 
00505     <span class="comment">/*</span>
00506 <span class="comment">     * Now calculate how much room we must make for the string pointer (lpsz).</span>
00507 <span class="comment">     * If we are ownerdraw without LBS_HASSTRINGS, then a single DWORD</span>
00508 <span class="comment">     * (LBODItem.itemData) stored for each item, but if we have strings with</span>
00509 <span class="comment">     * each item then a LONG string offset (LBItem.offsz) is also stored.</span>
00510 <span class="comment">     */</span>
00511     cbItem = (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagLBItem.html">LBItem</a>)
00512                                : (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o31">fHasData</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/structtagLBODItem.html">LBODItem</a>):0));
00513     cbChunk = (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - index) * cbItem;
00514 
00515     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> != <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>) {
00516 
00517         <span class="comment">/*</span>
00518 <span class="comment">         * Extra bytes were allocated for selection flag for each item</span>
00519 <span class="comment">         */</span>
00520         cbChunk += plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>;
00521     }
00522 
00523     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
00524 
00525         <span class="comment">/*</span>
00526 <span class="comment">         * Extra bytes were allocated for each item's height</span>
00527 <span class="comment">         */</span>
00528         cbChunk += plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>;
00529     }
00530 
00531     <span class="comment">/*</span>
00532 <span class="comment">     * First, make room for the 2 byte pointer to the string or the 4 byte app</span>
00533 <span class="comment">     * supplied value.</span>
00534 <span class="comment">     */</span>
00535     lpT += (index * cbItem);
00536     RtlMoveMemory(lpT + cbItem, lpT, cbChunk);
00537     <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a> &amp;&amp; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a>) {
00538         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o31">fHasData</a>) {
00539             <span class="comment">/*</span>
00540 <span class="comment">             * Ownerdraw so just save the DWORD value</span>
00541 <span class="comment">             */</span>
00542             <a class="code" href="../../d8/d9/structtagLBODItem.html">lpLBODItem</a> p = (<a class="code" href="../../d8/d9/structtagLBODItem.html">lpLBODItem</a>)lpT;
00543             p-&gt;<a class="code" href="../../d8/d9/structtagLBODItem.html#o0">itemData</a> = (ULONG_PTR)lpsz;
00544         }
00545     } <span class="keywordflow">else</span> {
00546         <a class="code" href="../../d6/d9/structtagLBItem.html">lpLBItem</a> p = ((<a class="code" href="../../d6/d9/structtagLBItem.html">lpLBItem</a>)lpT);
00547 
00548         <span class="comment">/*</span>
00549 <span class="comment">         * Save the start of the string.  Let the item data field be 0</span>
00550 <span class="comment">         */</span>
00551         p-&gt;<a class="code" href="../../d6/d9/structtagLBItem.html#o0">offsz</a> = (LONG)(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o11">ichAlloc</a>);
00552         p-&gt;<a class="code" href="../../d6/d9/structtagLBItem.html#o1">itemData</a> = 0;
00553         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o11">ichAlloc</a> += cbString;
00554     }
00555 
00556     <span class="comment">/*</span>
00557 <span class="comment">     * Now if Multiple Selection lbox, we have to insert a selection status</span>
00558 <span class="comment">     * byte.  If var height ownerdraw, then we also have to move up the height</span>
00559 <span class="comment">     * bytes.</span>
00560 <span class="comment">     */</span>
00561     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> != <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>) {
00562         lpT = lp + ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> + 1) * cbItem) + index;
00563         RtlMoveMemory(lpT + 1, lpT, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - index +
00564                 (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a> ? plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> : 0));
00565         *lpT = 0;  <span class="comment">/* fSelected = FALSE */</span>
00566     }
00567 
00568     <span class="comment">/*</span>
00569 <span class="comment">     * Increment count of items in the listbox now before we send a message to</span>
00570 <span class="comment">     * the app.</span>
00571 <span class="comment">     */</span>
00572     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>++;
00573 
00574     <span class="comment">/*</span>
00575 <span class="comment">     * If varheight ownerdraw, we much insert an extra byte for the item's</span>
00576 <span class="comment">     * height.</span>
00577 <span class="comment">     */</span>
00578     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
00579 
00580         <span class="comment">/*</span>
00581 <span class="comment">         * Variable height owner draw so we need to get the height of each item.</span>
00582 <span class="comment">         */</span>
00583         lpHeightStart += (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> * cbItem) + index +
00584                 (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> ? plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> : 0);
00585 
00586         RtlMoveMemory(lpHeightStart + 1, lpHeightStart, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1 - index);
00587 
00588         <span class="comment">/*</span>
00589 <span class="comment">         * Query for item height only if we are var height owner draw.</span>
00590 <span class="comment">         */</span>
00591         measureItemStruct.CtlType = ODT_LISTBOX;
00592         measureItemStruct.CtlID = PtrToUlong(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>);
00593         measureItemStruct.itemID = index;
00594 
00595         <span class="comment">/*</span>
00596 <span class="comment">         * System font height is default height</span>
00597 <span class="comment">         */</span>
00598         measureItemStruct.itemHeight = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cySysFontChar;
00599         measureItemStruct.itemData = (ULONG_PTR)lpsz;
00600 
00601         <span class="comment">/*</span>
00602 <span class="comment">         * If "has strings" then add the special thunk bit so the client data</span>
00603 <span class="comment">         * will be thunked to a client side address.  LB_DIR sends a string</span>
00604 <span class="comment">         * even if the listbox is not HASSTRINGS so we need to special</span>
00605 <span class="comment">         * thunk this case.  HP Dashboard for windows send LB_DIR to a non</span>
00606 <span class="comment">         * HASSTRINGS listbox needs the server string converted to client.</span>
00607 <span class="comment">         * WOW needs to know about this situation as well so we mark the</span>
00608 <span class="comment">         * previously uninitialized itemWidth as FLAT.</span>
00609 <span class="comment">         */</span>
00610         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a> || (wFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a547">MSGFLAG_SPECIAL_THUNK</a>)) {
00611             measureItemStruct.itemWidth = MIFLAG_FLAT;
00612         }
00613 
00614         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>, &amp;tlpwndParent);
00615         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>),
00616                 WM_MEASUREITEM,
00617                 measureItemStruct.CtlID,
00618                 (LPARAM)&amp;measureItemStruct);
00619         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
00620         *lpHeightStart = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)measureItemStruct.itemHeight;
00621     }
00622 
00623 
00624     <span class="comment">/*</span>
00625 <span class="comment">     * If the item was inserted above the current selection then move</span>
00626 <span class="comment">     * the selection down one as well.</span>
00627 <span class="comment">     */</span>
00628     <span class="keywordflow">if</span> ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>) &amp;&amp; (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> &gt;= index))
00629         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>++;
00630 
00631     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>)
00632         <a class="code" href="../../d6/d0/usercli_8h.html#a688">LBSetCItemFullMax</a>(plb);
00633 
00634     <span class="comment">/*</span>
00635 <span class="comment">     * Check if scroll bars need to be shown/hidden</span>
00636 <span class="comment">     */</span>
00637     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o40">fFromInsert</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00638     <a class="code" href="../../d6/d0/usercli_8h.html#a706">xxxLBShowHideScrollBars</a>(plb);
00639     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o38">fHorzBar</a> &amp;&amp; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o47">fRightAlign</a> &amp;&amp; !(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o34">fMultiColumn</a> || plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a>)) {
00640         <span class="comment">/*</span>
00641 <span class="comment">         * origin to right</span>
00642 <span class="comment">         */</span>
00643         <a class="code" href="../../d6/d0/usercli_8h.html#a703">xxxLBoxCtlHScroll</a>(plb, SB_BOTTOM, 0);
00644     }
00645     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o40">fFromInsert</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00646 
00647     <a class="code" href="../../d6/d0/usercli_8h.html#a714">xxxCheckRedraw</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, index);
00648 
00649     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00650         <a class="code" href="../../d6/d0/usercli_8h.html#a409">LBEvent</a>(plb, EVENT_OBJECT_CREATE, index);
00651     }
00652 
00653     <span class="keywordflow">return</span> index;
00654 }
00655 
00656 
00657 <span class="comment">/***************************************************************************\</span>
00658 <span class="comment">* LBlstrcmpi</span>
00659 <span class="comment">*</span>
00660 <span class="comment">* This is a version of lstrcmpi() specifically used for listboxes</span>
00661 <span class="comment">* This gives more weight to '[' characters than alpha-numerics;</span>
00662 <span class="comment">* The US version of lstrcmpi() and lstrcmp() are similar as far as</span>
00663 <span class="comment">* non-alphanumerals are concerned; All non-alphanumerals get sorted</span>
00664 <span class="comment">* before alphanumerals; This means that subdirectory strings that start</span>
00665 <span class="comment">* with '[' will get sorted before; But we don't want that; So, this</span>
00666 <span class="comment">* function takes care of it;</span>
00667 <span class="comment">*</span>
00668 <span class="comment">* History:</span>
00669 <span class="comment">\***************************************************************************/</span>
00670 
<a name="l00671"></a><a class="code" href="../../d8/d1/lboxctl1_8c.html#a8">00671</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d8/d1/lboxctl1_8c.html#a8">LBlstrcmpi</a>(
00672     LPWSTR lpStr1,
00673     LPWSTR lpStr2,
00674     DWORD dwLocaleId)
00675 {
00676 
00677     <span class="comment">/*</span>
00678 <span class="comment">     * NOTE: This function is written so as to reduce the number of calls</span>
00679 <span class="comment">     * made to the costly IsCharAlphaNumeric() function because that might</span>
00680 <span class="comment">     * load a language module; It 'traps' the most frequently occurring cases</span>
00681 <span class="comment">     * like both strings starting with '[' or both strings NOT starting with '['</span>
00682 <span class="comment">     * first and only in abosolutely necessary cases calls IsCharAlphaNumeric();</span>
00683 <span class="comment">     */</span>
00684     <span class="keywordflow">if</span> (*lpStr1 == TEXT(<span class="charliteral">'['</span>)) {
00685         <span class="keywordflow">if</span> (*lpStr2 == TEXT(<span class="charliteral">'['</span>)) {
00686             <span class="keywordflow">goto</span> LBL_End;
00687         }
00688         <span class="keywordflow">if</span> (IsCharAlphaNumeric(*lpStr2)) {
00689             <span class="keywordflow">return</span> 1;
00690         }
00691     }
00692 
00693     <span class="keywordflow">if</span> ((*lpStr2 == TEXT(<span class="charliteral">'['</span>)) &amp;&amp; IsCharAlphaNumeric(*lpStr1)) {
00694         <span class="keywordflow">return</span> -1;
00695     }
00696 
00697 LBL_End:
00698     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwTIFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) &amp;&amp;
00699         dwLocaleId == MAKELANGID(LANG_ENGLISH, SUBLANG_ENGLISH_US)) {
00700         <span class="comment">/*</span>
00701 <span class="comment">         * This is how Windows95 does, bug #4199</span>
00702 <span class="comment">         */</span>
00703         <span class="keywordflow">return</span> (*pfnWowIlstrcmp)(lpStr1, lpStr2);
00704     }
00705     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)CompareStringW((LCID)dwLocaleId, NORM_IGNORECASE,
00706             lpStr1, -1, lpStr2, -1 ) - 2;
00707 }
00708 
00709 
00710 <span class="comment">/***************************************************************************\</span>
00711 <span class="comment">* xxxLBBinarySearchString</span>
00712 <span class="comment">*</span>
00713 <span class="comment">* Does a binary search of the items in the SORTED listbox to find</span>
00714 <span class="comment">* out where this item should be inserted.  Handles both HasStrings and item</span>
00715 <span class="comment">* long WM_COMPAREITEM cases.</span>
00716 <span class="comment">*</span>
00717 <span class="comment">* History:</span>
00718 <span class="comment">*    27 April 1992  GregoryW</span>
00719 <span class="comment">*          Modified to support sorting based on current list box locale.</span>
00720 <span class="comment">\***************************************************************************/</span>
00721 
<a name="l00722"></a><a class="code" href="../../d8/d1/lboxctl1_8c.html#a0">00722</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d8/d1/lboxctl1_8c.html#a0">xxxLBBinarySearchString</a>(
00723     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00724     LPWSTR lpstr)
00725 {
00726     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *lprgpch;
00727     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sortResult;
00728     COMPAREITEMSTRUCT cis;
00729     LPWSTR pszLBBase;
00730     LPWSTR pszLB;
00731     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> itemhigh;
00732     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> itemnew = 0;
00733     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> itemlow = 0;
00734     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
00735 
00736     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
00737 
00738     <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>)
00739         <span class="keywordflow">return</span> 0;
00740 
00741     lprgpch = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a>);
00742     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a>) {
00743         pszLBBase = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o9">hStrings</a>;
00744     }
00745 
00746     itemhigh = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1;
00747     <span class="keywordflow">while</span> (itemlow &lt;= itemhigh) {
00748         itemnew = (itemhigh + itemlow) / 2;
00749 
00750         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a>) {
00751 
00752             <span class="comment">/*</span>
00753 <span class="comment">             * Searching for string matches.</span>
00754 <span class="comment">             */</span>
00755             pszLB = (LPWSTR)((LPSTR)pszLBBase + ((<a class="code" href="../../d6/d9/structtagLBItem.html">lpLBItem</a>)lprgpch)[itemnew].offsz);
00756             sortResult = <a class="code" href="../../d8/d1/lboxctl1_8c.html#a8">LBlstrcmpi</a>(pszLB, lpstr, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o60">dwLocaleId</a>);
00757         } <span class="keywordflow">else</span> {
00758 
00759             <span class="comment">/*</span>
00760 <span class="comment">             * Send compare item messages to the parent for sorting</span>
00761 <span class="comment">             */</span>
00762             cis.CtlType = ODT_LISTBOX;
00763             cis.CtlID = PtrToUlong(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>);
00764             cis.hwndItem = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
00765             cis.itemID1 = itemnew;
00766             cis.itemData1 = ((<a class="code" href="../../d8/d9/structtagLBODItem.html">lpLBODItem</a>)lprgpch)[itemnew].itemData;
00767             cis.itemID2 = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1;
00768             cis.itemData2 = (ULONG_PTR)lpstr;
00769             cis.dwLocaleId = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o60">dwLocaleId</a>;
00770             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>, &amp;tlpwndParent);
00771             sortResult = (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>), WM_COMPAREITEM,
00772                     cis.CtlID, (LPARAM)&amp;cis);
00773             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
00774         }
00775 
00776         <span class="keywordflow">if</span> (sortResult &lt; 0) {
00777             itemlow = itemnew + 1;
00778         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sortResult &gt; 0) {
00779             itemhigh = itemnew - 1;
00780         } <span class="keywordflow">else</span> {
00781             itemlow = itemnew;
00782             <span class="keywordflow">goto</span> FoundIt;
00783         }
00784     }
00785 
00786 FoundIt:
00787 
00788     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(0, itemlow);
00789 }
00790 
00791 <span class="comment">/***************************************************************************\</span>
00792 <span class="comment">* xxxLBResetContent</span>
00793 <span class="comment">*</span>
00794 <span class="comment">* History:</span>
00795 <span class="comment">\***************************************************************************/</span>
00796 
<a name="l00797"></a><a class="code" href="../../d6/d0/usercli_8h.html#a737">00797</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a737">xxxLBResetContent</a>(
00798     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb)
00799 {
00800     <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>)
00801         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00802 
00803     <a class="code" href="../../d6/d0/usercli_8h.html#a700">xxxLBoxDoDeleteItems</a>(plb);
00804 
00805     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00806         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a>);
00807         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00808     }
00809 
00810     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o9">hStrings</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00811         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o9">hStrings</a>);
00812         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o9">hStrings</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00813     }
00814 
00815     <a class="code" href="../../d6/d0/usercli_8h.html#a684">InitHStrings</a>(plb);
00816 
00817     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>))
00818         <a class="code" href="../../d6/d0/usercli_8h.html#a714">xxxCheckRedraw</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0);
00819     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a6">IsVisible</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>))
00820         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00821 
00822     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> =  0;
00823     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> =  0;
00824     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> =  0;
00825     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o7">cMax</a> =  0;
00826     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a> =  0;
00827     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o51">iLastSelection</a> =  0;
00828     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = -1;
00829 
00830     <a class="code" href="../../d6/d0/usercli_8h.html#a706">xxxLBShowHideScrollBars</a>(plb);
00831     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00832 }
00833 
00834 
00835 <span class="comment">/***************************************************************************\</span>
00836 <span class="comment">* xxxLBoxCtlDelete</span>
00837 <span class="comment">*</span>
00838 <span class="comment">* History:</span>
00839 <span class="comment">* 16-Apr-1992 beng      NODATA listboxes</span>
00840 <span class="comment">\***************************************************************************/</span>
00841 
<a name="l00842"></a><a class="code" href="../../d6/d0/usercli_8h.html#a707">00842</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d6/d0/usercli_8h.html#a707">xxxLBoxCtlDelete</a>(
00843     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00844     INT sItem)  <span class="comment">/* Item number to delete */</span>
00845 {
00846     LONG cb;
00847     LPBYTE lp;
00848     LPBYTE lpT;
00849     RECT rc;
00850     <span class="keywordtype">int</span> cbItem;    <span class="comment">/* size of Item in rgpch */</span>
00851     LPWSTR lpString;
00852     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pbStrings;
00853     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> cbStringLen;
00854     LPBYTE itemNumbers;
00855     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sTmp;
00856     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00857 
00858     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
00859 
00860     <span class="keywordflow">if</span> (sItem &lt; 0 || sItem &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>) {
00861         RIPERR0(ERROR_INVALID_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00862         <span class="keywordflow">return</span> LB_ERR;
00863     }
00864 
00865     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00866         <a class="code" href="../../d6/d0/usercli_8h.html#a409">LBEvent</a>(plb, EVENT_OBJECT_DESTROY, sItem);
00867     }
00868 
00869     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> == 1) {
00870 
00871         <span class="comment">/*</span>
00872 <span class="comment">         * When the item count is 0, we send a resetcontent message so that we</span>
00873 <span class="comment">         * can reclaim our string space this way.</span>
00874 <span class="comment">         */</span>
00875         <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, LB_RESETCONTENT, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00876         <span class="keywordflow">goto</span> FinishUpDelete;
00877     }
00878 
00879     <span class="comment">/*</span>
00880 <span class="comment">     * Get the rectangle associated with the last item in the listbox.  If it is</span>
00881 <span class="comment">     * visible, we need to invalidate it.  When we delete an item, everything</span>
00882 <span class="comment">     * scrolls up to replace the item deleted so we must make sure we erase the</span>
00883 <span class="comment">     * old image of the last item in the listbox.</span>
00884 <span class="comment">     */</span>
00885     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a744">LBGetItemRect</a>(plb, (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1), &amp;rc)) {
00886         <a class="code" href="../../d6/d0/usercli_8h.html#a711">xxxLBInvalidateRect</a>(plb, &amp;rc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00887     }
00888 
00889     <span class="comment">// 3.1 and earlier used to only send WM_DELETEITEMs if it was an ownerdraw</span>
00890     <span class="comment">// listbox.  4.0 and above will send WM_DELETEITEMs for every item that has</span>
00891     <span class="comment">// nonzero item data.</span>
00892     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>) || (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> &amp;&amp; plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o31">fHasData</a>)) {
00893         <a class="code" href="../../d6/d0/usercli_8h.html#a699">xxxLBoxDeleteItem</a>(plb, sItem);
00894     }
00895 
00896     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>--;
00897 
00898     cbItem = (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagLBItem.html">LBItem</a>)
00899                                : (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o31">fHasData</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/structtagLBODItem.html">LBODItem</a>): 0));
00900     cb = ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - sItem) * cbItem);
00901 
00902     <span class="comment">/*</span>
00903 <span class="comment">     * Byte for the selection status of the item.</span>
00904 <span class="comment">     */</span>
00905     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> != <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>) {
00906         cb += (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> + 1);
00907     }
00908 
00909     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
00910 
00911         <span class="comment">/*</span>
00912 <span class="comment">         * One byte for the height of the item.</span>
00913 <span class="comment">         */</span>
00914         cb += (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> + 1);
00915     }
00916 
00917     <span class="comment">/*</span>
00918 <span class="comment">     * Might be nodata and singlesel, for instance.</span>
00919 <span class="comment">     * but what out for the case where cItem == cMac (and cb == 0).</span>
00920 <span class="comment">     */</span>
00921     <span class="keywordflow">if</span> ((cb != 0) || plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a>) {
00922         lp = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a>;
00923 
00924         lpT = (lp + (sItem * cbItem));
00925 
00926         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a>) {
00927             <span class="comment">/*</span>
00928 <span class="comment">             * If we has strings with each item, then we want to compact the string</span>
00929 <span class="comment">             * heap so that we can recover the space occupied by the string of the</span>
00930 <span class="comment">             * deleted item.</span>
00931 <span class="comment">             */</span>
00932             <span class="comment">/*</span>
00933 <span class="comment">             * Get the string which we will be deleting</span>
00934 <span class="comment">             */</span>
00935             pbStrings = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o9">hStrings</a>);
00936             lpString = (LPTSTR)(pbStrings + ((<a class="code" href="../../d6/d9/structtagLBItem.html">lpLBItem</a>)lpT)-&gt;offsz);
00937             cbStringLen = (wcslen(lpString) + 1) * <span class="keyword">sizeof</span>(WCHAR);  <span class="comment">/* include null terminator */</span>
00938 
00939             <span class="comment">/*</span>
00940 <span class="comment">             * Now compact the string array</span>
00941 <span class="comment">             */</span>
00942             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o11">ichAlloc</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o11">ichAlloc</a> - cbStringLen;
00943 
00944             RtlMoveMemory(lpString, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)lpString + cbStringLen,
00945                     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o11">ichAlloc</a> + (pbStrings - (LPBYTE)lpString));
00946 
00947             <span class="comment">/*</span>
00948 <span class="comment">             * We have to update the string pointers in plb-&gt;rgpch since all the</span>
00949 <span class="comment">             * string after the deleted string have been moved down stringLength</span>
00950 <span class="comment">             * bytes.  Note that we have to explicitly check all items in the list</span>
00951 <span class="comment">             * box if the string was allocated after the deleted item since the</span>
00952 <span class="comment">             * LB_SORT style allows a lower item number to have a string allocated</span>
00953 <span class="comment">             * at the end of the string heap for example.</span>
00954 <span class="comment">             */</span>
00955             itemNumbers = lp;
00956             <span class="keywordflow">for</span> (sTmp = 0; sTmp &lt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>; sTmp++) {
00957                 <a class="code" href="../../d6/d9/structtagLBItem.html">lpLBItem</a> p =(<a class="code" href="../../d6/d9/structtagLBItem.html">lpLBItem</a>)itemNumbers;
00958                 <span class="keywordflow">if</span> ( (LPTSTR)(p-&gt;<a class="code" href="../../d6/d9/structtagLBItem.html#o0">offsz</a> + pbStrings) &gt; lpString ) {
00959                     p-&gt;<a class="code" href="../../d6/d9/structtagLBItem.html#o0">offsz</a> -= cbStringLen;
00960                 }
00961                 p++;
00962                 itemNumbers=(LPBYTE)p;
00963             }
00964         }
00965 
00966         <span class="comment">/*</span>
00967 <span class="comment">         * Now compact the pointers to the strings (or the long app supplied values</span>
00968 <span class="comment">         * if ownerdraw without strings).</span>
00969 <span class="comment">         */</span>
00970         RtlMoveMemory(lpT, lpT + cbItem, cb);
00971 
00972         <span class="comment">/*</span>
00973 <span class="comment">         * Compress the multiselection bytes</span>
00974 <span class="comment">         */</span>
00975         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> != <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>) {
00976             lpT = (lp + (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> * cbItem) + sItem);
00977             RtlMoveMemory(lpT, lpT + 1, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - sItem +
00978                     (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a> ? plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> + 1 : 0));
00979         }
00980 
00981         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
00982             <span class="comment">/*</span>
00983 <span class="comment">             * Compress the height bytes</span>
00984 <span class="comment">             */</span>
00985             lpT = (lp + (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> * cbItem) + (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> ? plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> : 0)
00986                     + sItem);
00987             RtlMoveMemory(lpT, lpT + 1, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - sItem);
00988         }
00989 
00990     }
00991 
00992     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>) {
00993         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> == sItem) {
00994             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = -1;
00995 
00996             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o58">pcbox</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00997                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o58">pcbox</a>-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, &amp;tlpwnd);
00998                 <a class="code" href="../../d6/d0/usercli_8h.html#a676">xxxCBInternalUpdateEditWindow</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o58">pcbox</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00999                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01000             }
01001         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> &gt; sItem)
01002             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a>--;
01003     }
01004 
01005     <span class="keywordflow">if</span> ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> != -1) &amp;&amp; (sItem &lt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a>))
01006         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o52">iMouseDown</a> = -1;
01007 
01008     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> &amp;&amp; sItem == plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>)
01009         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>--;
01010 
01011     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>) {
01012         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1);
01013     } <span class="keywordflow">else</span> {
01014         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> = 0;
01015     }
01016 
01017     <span class="keywordflow">if</span> ((plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a116">EXTENDEDSEL</a>) &amp;&amp; (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> == -1))
01018         plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>;
01019 
01020     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>)
01021         <a class="code" href="../../d6/d0/usercli_8h.html#a688">LBSetCItemFullMax</a>(plb);
01022 
01023     <span class="comment">/*</span>
01024 <span class="comment">     * We always set a new iTop.  The iTop won't change if it doesn't need to</span>
01025 <span class="comment">     * but it will change if:  1.  The iTop was deleted or 2.  We need to change</span>
01026 <span class="comment">     * the iTop so that we fill the listbox.</span>
01027 <span class="comment">     */</span>
01028     <a class="code" href="../../d6/d0/usercli_8h.html#a716">xxxInsureVisible</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01029 
01030 FinishUpDelete:
01031 
01032     <span class="comment">/*</span>
01033 <span class="comment">     * Check if scroll bars need to be shown/hidden</span>
01034 <span class="comment">     */</span>
01035     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o40">fFromInsert</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01036     <a class="code" href="../../d6/d0/usercli_8h.html#a706">xxxLBShowHideScrollBars</a>(plb);
01037     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o40">fFromInsert</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01038 
01039     <a class="code" href="../../d6/d0/usercli_8h.html#a714">xxxCheckRedraw</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, sItem);
01040     <a class="code" href="../../d6/d0/usercli_8h.html#a716">xxxInsureVisible</a>(plb, plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01041 
01042     <span class="keywordflow">return</span> plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a>;
01043 }
01044 
01045 <span class="comment">/***************************************************************************\</span>
01046 <span class="comment">* xxxLBoxDeleteItem</span>
01047 <span class="comment">*</span>
01048 <span class="comment">* Sends a WM_DELETEITEM message to the owner of an ownerdraw listbox</span>
01049 <span class="comment">*</span>
01050 <span class="comment">* History:</span>
01051 <span class="comment">\***************************************************************************/</span>
01052 
<a name="l01053"></a><a class="code" href="../../d6/d0/usercli_8h.html#a699">01053</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a699">xxxLBoxDeleteItem</a>(
01054     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
01055     INT sItem)
01056 {
01057     DELETEITEMSTRUCT dis;
01058     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
01059 
01060     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
01061     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01062         <span class="keywordflow">return</span>;
01063 
01064     <span class="comment">/*</span>
01065 <span class="comment">     * Bug 262122 - joejo</span>
01066 <span class="comment">     * No need to send message if no data!</span>
01067 <span class="comment">     */</span>
01068     <span class="keywordflow">if</span> (!plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o31">fHasData</a>) {
01069         <span class="keywordflow">return</span>;
01070     }
01071 
01072     <span class="comment">/*</span>
01073 <span class="comment">     * Fill the DELETEITEMSTRUCT</span>
01074 <span class="comment">     */</span>
01075     dis.CtlType = ODT_LISTBOX;
01076     dis.CtlID = PtrToUlong(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>);
01077     dis.itemID = sItem;
01078     dis.hwndItem = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
01079 
01080     <span class="comment">/*</span>
01081 <span class="comment">     * Bug 262122 - joejo</span>
01082 <span class="comment">     * Fixed in 93 so that ItemData was passed. For some reason, not</span>
01083 <span class="comment">     * merged in.</span>
01084 <span class="comment">     */</span>
01085     dis.itemData = <a class="code" href="../../d6/d0/usercli_8h.html#a721">LBGetItemData</a>(plb, sItem);
01086 
01087     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01088         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>, &amp;tlpwndParent);
01089         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o0">spwndParent</a>), WM_DELETEITEM, dis.CtlID,
01090                 (LPARAM)&amp;dis);
01091         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
01092     }
01093 }
01094 
01095 <span class="comment">/**************************************************************************\</span>
01096 <span class="comment">* xxxLBSetCount</span>
01097 <span class="comment">*</span>
01098 <span class="comment">* Sets the number of items in a lazy-eval (fNoData) listbox.</span>
01099 <span class="comment">*</span>
01100 <span class="comment">* Calling SetCount scorches any existing selection state.  To preserve</span>
01101 <span class="comment">* selection state, call Insert/DeleteItem instead.</span>
01102 <span class="comment">*</span>
01103 <span class="comment">* History</span>
01104 <span class="comment">* 16-Apr-1992 beng      Created</span>
01105 <span class="comment">\**************************************************************************/</span>
01106 
<a name="l01107"></a><a class="code" href="../../d6/d0/usercli_8h.html#a747">01107</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d6/d0/usercli_8h.html#a747">xxxLBSetCount</a>(
01108     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
01109     INT cItems)
01110 {
01111     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  cbRequired;
01112     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fRedraw;
01113 
01114     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
01115 
01116     <span class="comment">/*</span>
01117 <span class="comment">     * SetCount is only valid on lazy-eval ("nodata") listboxes.</span>
01118 <span class="comment">     * All other lboxen must add their items one at a time, although</span>
01119 <span class="comment">     * they may SetCount(0) via RESETCONTENT.</span>
01120 <span class="comment">     */</span>
01121     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a> || plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o31">fHasData</a>) {
01122         RIPERR0(ERROR_SETCOUNT_ON_BAD_LB, RIP_VERBOSE, <span class="stringliteral">""</span>);
01123         <span class="keywordflow">return</span> LB_ERR;
01124     }
01125 
01126     <span class="keywordflow">if</span> (cItems == 0) {
01127         <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>, LB_RESETCONTENT, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01128         <span class="keywordflow">return</span> 0;
01129     }
01130 
01131     <span class="comment">// If redraw isn't turned off, turn it off now</span>
01132     <span class="keywordflow">if</span> (fRedraw = plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o19">fRedraw</a>)
01133         <a class="code" href="../../d6/d0/usercli_8h.html#a738">xxxLBSetRedraw</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01134 
01135     cbRequired = <a class="code" href="../../d6/d0/usercli_8h.html#a748">LBCalcAllocNeeded</a>(plb, cItems);
01136 
01137     <span class="comment">/*</span>
01138 <span class="comment">     * Reset selection and position</span>
01139 <span class="comment">     */</span>
01140     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o4">iSelBase</a> = 0;
01141     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o2">iTop</a> = 0;
01142     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o7">cMax</a> = 0;
01143     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o56">xOrigin</a> = 0;
01144     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o51">iLastSelection</a> = 0;
01145     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o3">iSel</a> = -1;
01146 
01147     <span class="keywordflow">if</span> (cbRequired != 0) { <span class="comment">// Only if record instance data required</span>
01148 
01149         <span class="comment">/*</span>
01150 <span class="comment">         * If listbox was previously empty, prepare for the</span>
01151 <span class="comment">         * realloc-based alloc strategy ahead.</span>
01152 <span class="comment">         */</span>
01153         <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01154             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01155             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o7">cMax</a> = 0;
01156 
01157             <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01158                 <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, LBN_ERRSPACE);
01159                 <span class="keywordflow">return</span> LB_ERRSPACE;
01160             }
01161         }
01162 
01163         <span class="comment">/*</span>
01164 <span class="comment">         * rgpch might not have enough room for the new record instance</span>
01165 <span class="comment">         * data, so check and realloc as necessary.</span>
01166 <span class="comment">         */</span>
01167         <span class="keywordflow">if</span> (cItems &gt;= plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o7">cMax</a>) {
01168             <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>    cMaxNew;
01169             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   cbNew;
01170             HANDLE hmemNew;
01171 
01172             <span class="comment">/*</span>
01173 <span class="comment">             * Since GrowMem presumes a one-item-at-a-time add schema,</span>
01174 <span class="comment">             * SetCount can't use it.  Too bad.</span>
01175 <span class="comment">             */</span>
01176             cMaxNew = cItems+<a class="code" href="../../d6/d0/usercli_8h.html#a109">CITEMSALLOC</a>;
01177             cbNew = <a class="code" href="../../d6/d0/usercli_8h.html#a748">LBCalcAllocNeeded</a>(plb, cMaxNew);
01178             hmemNew = <a class="code" href="../../d6/d0/usercli_8h.html#a137">UserLocalReAlloc</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a>, cbNew, HEAP_ZERO_MEMORY);
01179 
01180             <span class="keywordflow">if</span> (hmemNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01181                 <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, LBN_ERRSPACE);
01182                 <span class="keywordflow">return</span> LB_ERRSPACE;
01183             }
01184 
01185             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a> = hmemNew;
01186             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o7">cMax</a> = cMaxNew;
01187         }
01188 
01189         <span class="comment">/*</span>
01190 <span class="comment">         * Reset the item instance data (multisel annotations)</span>
01191 <span class="comment">         */</span>
01192         RtlZeroMemory(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o8">rgpch</a>, cbRequired);
01193     }
01194 
01195     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> = cItems;
01196 
01197     <span class="comment">// Turn redraw back on</span>
01198     <span class="keywordflow">if</span> (fRedraw)
01199         <a class="code" href="../../d6/d0/usercli_8h.html#a738">xxxLBSetRedraw</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01200 
01201     <a class="code" href="../../d6/d0/usercli_8h.html#a711">xxxLBInvalidateRect</a>(plb, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01202 <span class="comment">// Not In Chicago -- FritzS</span>
01203 <span class="comment">//    NtUserSetScrollPos(plb-&gt;spwnd, SB_HORZ, 0, plb-&gt;fRedraw);</span>
01204 <span class="comment">//    NtUserSetScrollPos(plb-&gt;spwnd, SB_VERT, 0, plb-&gt;fRedraw);</span>
01205     <a class="code" href="../../d6/d0/usercli_8h.html#a706">xxxLBShowHideScrollBars</a>(plb); <span class="comment">// takes care of fRedraw</span>
01206 
01207     <span class="keywordflow">return</span> 0;
01208 }
01209 
01210 <span class="comment">/**************************************************************************\</span>
01211 <span class="comment">* LBCalcAllocNeeded</span>
01212 <span class="comment">*</span>
01213 <span class="comment">* Calculate the number of bytes needed in rgpch to accommodate a given</span>
01214 <span class="comment">* number of items.</span>
01215 <span class="comment">*</span>
01216 <span class="comment">* History</span>
01217 <span class="comment">* 16-Apr-1992 beng      Created</span>
01218 <span class="comment">\**************************************************************************/</span>
01219 
<a name="l01220"></a><a class="code" href="../../d6/d0/usercli_8h.html#a748">01220</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d0/usercli_8h.html#a748">LBCalcAllocNeeded</a>(
01221     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
01222     INT cItems)
01223 {
01224     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cb;
01225 
01226     <span class="comment">/*</span>
01227 <span class="comment">     * Allocate memory for pointers to the strings.</span>
01228 <span class="comment">     */</span>
01229     cb = cItems * (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o30">fHasStrings</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagLBItem.html">LBItem</a>)
01230                                     : (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o31">fHasData</a> ? <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/structtagLBODItem.html">LBODItem</a>)
01231                                                     : 0));
01232 
01233     <span class="comment">/*</span>
01234 <span class="comment">     * If multiple selection list box (MULTIPLESEL or EXTENDEDSEL), then</span>
01235 <span class="comment">     * allocate an extra byte per item to keep track of it's selection state.</span>
01236 <span class="comment">     */</span>
01237     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o21">wMultiple</a> != <a class="code" href="../../d6/d0/usercli_8h.html#a114">SINGLESEL</a>) {
01238         cb += cItems;
01239     }
01240 
01241     <span class="comment">/*</span>
01242 <span class="comment">     * Extra bytes for each item so that we can store its height.</span>
01243 <span class="comment">     */</span>
01244     <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o18">OwnerDraw</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a63">OWNERDRAWVAR</a>) {
01245         cb += cItems;
01246     }
01247 
01248     <span class="keywordflow">return</span> cb;
01249 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
