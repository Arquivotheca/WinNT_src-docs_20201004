<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: balmgr.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>balmgr.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d0/d0/balmgr_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a0">MAXIMUM_THREAD_STACKS</a>&nbsp;&nbsp;&nbsp;20</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a1">PERIODIC_INTERVAL</a>&nbsp;&nbsp;&nbsp;(1 * 1000 * 1000 * 10)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a2">READY_WITHOUT_RUNNING</a>&nbsp;&nbsp;&nbsp;(4 * 75)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a3">SMALL_SYSTEM_STACK_PROTECT_TIME</a>&nbsp;&nbsp;&nbsp;(3 * 75)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a4">STACK_PROTECT_TIME</a>&nbsp;&nbsp;&nbsp;(7 * 75)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a5">STACK_SCAN_PERIOD</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a6">THREAD_BOOST_BIAS</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a7">THREAD_BOOST_PRIORITY</a>&nbsp;&nbsp;&nbsp;(LOW_REALTIME_PRIORITY - THREAD_BOOST_BIAS)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a8">THREAD_SCAN_PRIORITY</a>&nbsp;&nbsp;&nbsp;(THREAD_BOOST_PRIORITY - 1)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a9">THREAD_READY_COUNT</a>&nbsp;&nbsp;&nbsp;10</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a10">THREAD_SCAN_COUNT</a>&nbsp;&nbsp;&nbsp;16</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a11">EXECUTION_TIME_LIMITS_PERIOD</a>&nbsp;&nbsp;&nbsp;7</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d9/d0/balmgr_8c.html#a26">_BALANCE_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a12">BALANCE_OBJECT</a></td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a26">_BALANCE_OBJECT</a> { <a class="el" href="../../d9/d0/balmgr_8c.html#a26a16">TimerExpiration</a>, 
<a class="el" href="../../d9/d0/balmgr_8c.html#a26a17">WorkingSetManagerEvent</a>, 
<a class="el" href="../../d9/d0/balmgr_8c.html#a26a18">MaximumObject</a>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a19">KiInSwapKernelStacks</a> (IN KIRQL PreviousIrql)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a20">KiInSwapProcesses</a> (IN KIRQL PreviousIrql)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a21">KiOutSwapKernelStacks</a> (IN KIRQL PreviousIrql)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a22">KiOutSwapProcesses</a> (IN KIRQL PreviousIrql)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a23">KiScanReadyQueues</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a24">KeBalanceSetManager</a> (IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a25">KeSwapProcessOrStack</a> (IN PVOID Context)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a13">KiStackProtectTime</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a14">KiReadyQueueIndex</a> = 1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/balmgr_8c.html#a15">KiStackOutSwapRequest</a> = FALSE</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a11" doxytag="balmgr.c::EXECUTION_TIME_LIMITS_PERIOD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define EXECUTION_TIME_LIMITS_PERIOD&nbsp;&nbsp;&nbsp;7          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00098">98</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="balmgr.c::MAXIMUM_THREAD_STACKS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAXIMUM_THREAD_STACKS&nbsp;&nbsp;&nbsp;20          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00063">63</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00544">KiOutSwapKernelStacks()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="balmgr.c::PERIODIC_INTERVAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERIODIC_INTERVAL&nbsp;&nbsp;&nbsp;(1 * 1000 * 1000 * 10)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00069">69</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="balmgr.c::READY_WITHOUT_RUNNING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define READY_WITHOUT_RUNNING&nbsp;&nbsp;&nbsp;(4 * 75)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00076">76</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00732">KiScanReadyQueues()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="balmgr.c::SMALL_SYSTEM_STACK_PROTECT_TIME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SMALL_SYSTEM_STACK_PROTECT_TIME&nbsp;&nbsp;&nbsp;(3 * 75)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00083">83</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="balmgr.c::STACK_PROTECT_TIME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define STACK_PROTECT_TIME&nbsp;&nbsp;&nbsp;(7 * 75)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00084">84</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="balmgr.c::STACK_SCAN_PERIOD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define STACK_SCAN_PERIOD&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00085">85</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="balmgr.c::THREAD_BOOST_BIAS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define THREAD_BOOST_BIAS&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00092">92</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="balmgr.c::THREAD_BOOST_PRIORITY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define THREAD_BOOST_PRIORITY&nbsp;&nbsp;&nbsp;(LOW_REALTIME_PRIORITY - THREAD_BOOST_BIAS)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00093">93</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00732">KiScanReadyQueues()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="balmgr.c::THREAD_READY_COUNT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define THREAD_READY_COUNT&nbsp;&nbsp;&nbsp;10          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00095">95</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00732">KiScanReadyQueues()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="balmgr.c::THREAD_SCAN_COUNT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define THREAD_SCAN_COUNT&nbsp;&nbsp;&nbsp;16          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00096">96</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00732">KiScanReadyQueues()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="balmgr.c::THREAD_SCAN_PRIORITY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define THREAD_SCAN_PRIORITY&nbsp;&nbsp;&nbsp;(THREAD_BOOST_PRIORITY - 1)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00094">94</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00732">KiScanReadyQueues()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a12" doxytag="balmgr.c::BALANCE_OBJECT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d9/d0/balmgr_8c.html#a26">_BALANCE_OBJECT</a>  <a class="el" href="../../d5/d5/sectsup_8c.html#a5">BALANCE_OBJECT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a26" doxytag="balmgr.c::_BALANCE_OBJECT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d9/d0/balmgr_8c.html#a26">_BALANCE_OBJECT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a26a16" doxytag="TimerExpiration" ></a>TimerExpiration</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a26a17" doxytag="WorkingSetManagerEvent" ></a>WorkingSetManagerEvent</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a26a18" doxytag="MaximumObject" ></a>MaximumObject</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00052">52</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
<pre class="fragment"><div>00052                              {
00053     <a class="code" href="../../d1/d9/worker_8c.html#a31a18">TimerExpiration</a>,
00054     <a class="code" href="../../d9/d0/balmgr_8c.html#a26a17">WorkingSetManagerEvent</a>,
00055     <a class="code" href="../../d9/d0/balmgr_8c.html#a26a18">MaximumObject</a>
00056     } <a class="code" href="../../d1/d9/worker_8c.html#a11">BALANCE_OBJECT</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a24" doxytag="balmgr.c::KeBalanceSetManager" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeBalanceSetManager           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">142</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
References <a class="el" href="../../d0/d5/ex_2lookasid_8c-source.html#l00089">ExAdjustLookasideDepth()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00098">EXECUTION_TIME_LIMITS_PERIOD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00043">KeInitializeTimer()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01838">KeSetPriorityThread()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00243">KeSetTimer()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00395">KeWaitForMultipleObjects()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00732">KiScanReadyQueues()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00139">KiStackOutSwapRequest</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02783">KiStackProtectTime</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00421">KiSwapEvent</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a59">KWAIT_BLOCK</a>, <a class="el" href="../../d9/d0/balmgr_8c.html#a26a18">MaximumObject</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l03073">MmQuerySystemSize()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00418">MmWorkingSetManagerEvent</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00069">PERIODIC_INTERVAL</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02396">PsEnforceExecutionTimeLimits()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00083">SMALL_SYSTEM_STACK_PROTECT_TIME</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00084">STACK_PROTECT_TIME</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00085">STACK_SCAN_PERIOD</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d9/worker_8c.html#a31a18">TimerExpiration</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d9/d0/balmgr_8c.html#a26a17">WorkingSetManagerEvent</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.
<p>
<pre class="fragment"><div>00148                    :
00149 
00150     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> startup code <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> balance set manager. The
00151     balance set manager thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created during system initialization
00152     and begins execution in <span class="keyword">this</span> function.
00153 
00154 Arguments:
00155 
00156     Context - Supplies a pointer to an arbitrary data structure (NULL).
00157 
00158 Return Value:
00159 
00160     None.
00161 
00162 --*/
00163 
00164 {
00165 
00166     LARGE_INTEGER DueTime;
00167     <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a> PeriodTimer;
00168     KIRQL OldIrql;
00169     ULONG StackScanPeriod;
00170     ULONG ExecutionTimeLimitPeriod;
00171     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00172     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a> WaitBlockArray[<a class="code" href="../../d9/d0/balmgr_8c.html#a26a18">MaximumObject</a>];
00173     PVOID WaitObjects[<a class="code" href="../../d9/d0/balmgr_8c.html#a26a18">MaximumObject</a>];
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">// Raise the thread priority to the lowest realtime level.</span>
00177     <span class="comment">//</span>
00178 
00179     <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>(), LOW_REALTIME_PRIORITY);
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// Initialize the periodic timer, set it to expire one period from</span>
00183     <span class="comment">// now, and set the stack scan period.</span>
00184     <span class="comment">//</span>
00185 
00186     <a class="code" href="../../d3/d2/timerobj_8c.html#a1">KeInitializeTimer</a>(&amp;PeriodTimer);
00187     DueTime.QuadPart = - <a class="code" href="../../d9/d0/balmgr_8c.html#a1">PERIODIC_INTERVAL</a>;
00188     <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a>(&amp;PeriodTimer, DueTime, NULL);
00189     StackScanPeriod = <a class="code" href="../../d9/d0/balmgr_8c.html#a5">STACK_SCAN_PERIOD</a>;
00190     ExecutionTimeLimitPeriod = <a class="code" href="../../d9/d0/balmgr_8c.html#a11">EXECUTION_TIME_LIMITS_PERIOD</a>;
00191     <span class="comment">//</span>
00192     <span class="comment">// Compute the stack protect time based on the system size.</span>
00193     <span class="comment">//</span>
00194 
00195     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/mminit_8c.html#a57">MmQuerySystemSize</a>() == <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>) {
00196         <a class="code" href="../../d4/d9/ke_8h.html#a140">KiStackProtectTime</a> = <a class="code" href="../../d9/d0/balmgr_8c.html#a3">SMALL_SYSTEM_STACK_PROTECT_TIME</a>;
00197 
00198     } <span class="keywordflow">else</span> {
00199         <a class="code" href="../../d4/d9/ke_8h.html#a140">KiStackProtectTime</a> = <a class="code" href="../../d9/d0/balmgr_8c.html#a4">STACK_PROTECT_TIME</a>;
00200     }
00201 
00202     <span class="comment">//</span>
00203     <span class="comment">// Initialize the wait objects array.</span>
00204     <span class="comment">//</span>
00205 
00206     WaitObjects[<a class="code" href="../../d1/d9/worker_8c.html#a31a18">TimerExpiration</a>] = (PVOID)&amp;PeriodTimer;
00207     WaitObjects[<a class="code" href="../../d9/d0/balmgr_8c.html#a26a17">WorkingSetManagerEvent</a>] = (PVOID)&amp;<a class="code" href="../../d2/d1/mm_8h.html#a139">MmWorkingSetManagerEvent</a>;
00208 
00209     <span class="comment">//</span>
00210     <span class="comment">// Loop forever processing balance set manager events.</span>
00211     <span class="comment">//</span>
00212 
00213     <span class="keywordflow">do</span> {
00214 
00215         <span class="comment">//</span>
00216         <span class="comment">// Wait for a memory management memory low event, a swap event,</span>
00217         <span class="comment">// or the expiration of the period timout rate that the balance</span>
00218         <span class="comment">// set manager runs at.</span>
00219         <span class="comment">//</span>
00220 
00221         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(MaximumObject,
00222                                           &amp;WaitObjects[0],
00223                                           WaitAny,
00224                                           Executive,
00225                                           KernelMode,
00226                                           FALSE,
00227                                           NULL,
00228                                           &amp;WaitBlockArray[0]);
00229 
00230         <span class="comment">//</span>
00231         <span class="comment">// Switch on the wait status.</span>
00232         <span class="comment">//</span>
00233 
00234         <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00235 
00236             <span class="comment">//</span>
00237             <span class="comment">// Periodic timer expiration.</span>
00238             <span class="comment">//</span>
00239 
00240         <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/worker_8c.html#a31a18">TimerExpiration</a>:
00241 
00242             <span class="comment">//</span>
00243             <span class="comment">// Attempt to initiate outswaping of kernel stacks.</span>
00244             <span class="comment">//</span>
00245 
00246             StackScanPeriod -= 1;
00247             <span class="keywordflow">if</span> (StackScanPeriod == 0) {
00248                 StackScanPeriod = <a class="code" href="../../d9/d0/balmgr_8c.html#a5">STACK_SCAN_PERIOD</a>;
00249                 <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00250                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/balmgr_8c.html#a15">KiStackOutSwapRequest</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00251                     <a class="code" href="../../d9/d0/balmgr_8c.html#a15">KiStackOutSwapRequest</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00252                     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00253                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;KiSwapEvent, 0, FALSE);
00254 
00255                 } <span class="keywordflow">else</span> {
00256                     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00257                 }
00258             }
00259 
00260             <span class="comment">//</span>
00261             <span class="comment">// Adjust the depth of lookaside lists.</span>
00262             <span class="comment">//</span>
00263 
00264             <a class="code" href="../../d5/d8/ex_8h.html#a245">ExAdjustLookasideDepth</a>();
00265 
00266             <span class="comment">//</span>
00267             <span class="comment">// Scan ready queues and boost thread priorities as appropriate.</span>
00268             <span class="comment">//</span>
00269 
00270             <a class="code" href="../../d9/d0/balmgr_8c.html#a23">KiScanReadyQueues</a>();
00271 
00272             <span class="comment">//</span>
00273             <span class="comment">// Execute the virtual memory working set manager.</span>
00274             <span class="comment">//</span>
00275 
00276             <a class="code" href="../../d5/d0/wsmanage_8c.html#a41">MmWorkingSetManager</a>();
00277 
00278             <span class="comment">//</span>
00279             <span class="comment">// Enforce execution time limits</span>
00280             <span class="comment">//</span>
00281 
00282             ExecutionTimeLimitPeriod -= 1;
00283             <span class="keywordflow">if</span> (ExecutionTimeLimitPeriod == 0) {
00284                 ExecutionTimeLimitPeriod = <a class="code" href="../../d9/d0/balmgr_8c.html#a11">EXECUTION_TIME_LIMITS_PERIOD</a>;
00285                 <a class="code" href="../../d1/d1/psjob_8c.html#a16">PsEnforceExecutionTimeLimits</a>();
00286                 }
00287 
00288             <span class="comment">//</span>
00289             <span class="comment">// Set the timer to expire at the next periodic interval.</span>
00290             <span class="comment">//</span>
00291 
00292             <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a>(&amp;PeriodTimer, DueTime, NULL);
00293             <span class="keywordflow">break</span>;
00294 
00295             <span class="comment">//</span>
00296             <span class="comment">// Working set manager event.</span>
00297             <span class="comment">//</span>
00298 
00299         <span class="keywordflow">case</span> <a class="code" href="../../d9/d0/balmgr_8c.html#a26a17">WorkingSetManagerEvent</a>:
00300 
00301             <span class="comment">//</span>
00302             <span class="comment">// Call the working set manager to trim working sets.</span>
00303             <span class="comment">//</span>
00304 
00305             <a class="code" href="../../d5/d0/wsmanage_8c.html#a41">MmWorkingSetManager</a>();
00306             <span class="keywordflow">break</span>;
00307 
00308             <span class="comment">//</span>
00309             <span class="comment">// Illegal return status.</span>
00310             <span class="comment">//</span>
00311 
00312         <span class="keywordflow">default</span>:
00313             KdPrint((<span class="stringliteral">"BALMGR: Illegal wait status, %lx =\n"</span>, Status));
00314             <span class="keywordflow">break</span>;
00315         }
00316 
00317     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00318     <span class="keywordflow">return</span>;
00319 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="balmgr.c::KeSwapProcessOrStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeSwapProcessOrStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00322">322</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01838">KeSetPriorityThread()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00431">KiInSwapKernelStacks()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00483">KiInSwapProcesses()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00544">KiOutSwapKernelStacks()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00644">KiOutSwapProcesses()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00428">KiProcessInSwapListHead</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00435">KiProcessOutSwapListHead</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00444">KiStackInSwapListHead</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00139">KiStackOutSwapRequest</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00421">KiSwapEvent</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.
<p>
<pre class="fragment"><div>00328                    :
00329 
00330     This thread controls <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> swapping of processes and kernel stacks. The
00331     order of evaluation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>:
00332 
00333         Outswap kernel stacks
00334         Outswap processes
00335         Inswap processes
00336         Inswap kernel stacks
00337 
00338 Arguments:
00339 
00340     Context - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine context - not used.
00341 
00342 Return Value:
00343 
00344     None.
00345 
00346 --*/
00347 
00348 {
00349 
00350     KIRQL OldIrql;
00351     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00352 
00353     <span class="comment">//</span>
00354     <span class="comment">// Raise the thread priority to the lowest realtime level + 7 (i.e.,</span>
00355     <span class="comment">// priority 23).</span>
00356     <span class="comment">//</span>
00357 
00358     <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>(), LOW_REALTIME_PRIORITY + 7);
00359 
00360     <span class="comment">//</span>
00361     <span class="comment">// Loop for ever processing swap events.</span>
00362     <span class="comment">//</span>
00363 
00364     <span class="keywordflow">do</span> {
00365 
00366         <span class="comment">//</span>
00367         <span class="comment">// Wait for a swap event to occur.</span>
00368         <span class="comment">//</span>
00369 
00370         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;KiSwapEvent,
00371                                        Executive,
00372                                        KernelMode,
00373                                        FALSE,
00374                                        NULL);
00375 
00376         <span class="comment">//</span>
00377         <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00378         <span class="comment">//</span>
00379 
00380         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00381 
00382         <span class="comment">//</span>
00383         <span class="comment">// Loop until all of the four possible actions cannot be initiated.</span>
00384         <span class="comment">//</span>
00385 
00386         <span class="keywordflow">do</span> {
00387 
00388             <span class="comment">//</span>
00389             <span class="comment">// If a request has been made to out swap kernel stacks, then</span>
00390             <span class="comment">// attempt to outswap kernel stacks. Otherwise, if the process</span>
00391             <span class="comment">// out swap list is not empty, then initiate process outswapping.</span>
00392             <span class="comment">// Otherwise, if the process inswap list is not empty, then start</span>
00393             <span class="comment">// process inswapping. Otherwise, if the kernal stack inswap list</span>
00394             <span class="comment">// is not active, then initiate kernel stack inswapping. Otherwise,</span>
00395             <span class="comment">// no work is available.</span>
00396             <span class="comment">//</span>
00397 
00398             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/balmgr_8c.html#a15">KiStackOutSwapRequest</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00399                 <a class="code" href="../../d9/d0/balmgr_8c.html#a15">KiStackOutSwapRequest</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00400                 <a class="code" href="../../d9/d0/balmgr_8c.html#a21">KiOutSwapKernelStacks</a>(OldIrql);
00401                 <span class="keywordflow">continue</span>;
00402 
00403             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsListEmpty(&amp;KiProcessOutSwapListHead) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00404                 <a class="code" href="../../d9/d0/balmgr_8c.html#a22">KiOutSwapProcesses</a>(OldIrql);
00405                 <span class="keywordflow">continue</span>;
00406 
00407             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsListEmpty(&amp;KiProcessInSwapListHead) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00408                 <a class="code" href="../../d9/d0/balmgr_8c.html#a20">KiInSwapProcesses</a>(OldIrql);
00409                 <span class="keywordflow">continue</span>;
00410 
00411             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsListEmpty(&amp;KiStackInSwapListHead) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00412                 <a class="code" href="../../d9/d0/balmgr_8c.html#a19">KiInSwapKernelStacks</a>(OldIrql);
00413                 <span class="keywordflow">continue</span>;
00414 
00415             } <span class="keywordflow">else</span> {
00416                 <span class="keywordflow">break</span>;
00417             }
00418         } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00419 
00420         <span class="comment">//</span>
00421         <span class="comment">// Unlock the dispatcher database and lower IRQL to its previous</span>
00422         <span class="comment">// value.</span>
00423         <span class="comment">//</span>
00424 
00425         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00426     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00427     <span class="keywordflow">return</span>;
00428 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="balmgr.c::KiInSwapKernelStacks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInSwapKernelStacks           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN KIRQL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PreviousIrql</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00431">431</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00625">_KTHREAD::KernelStackResident</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00270">KiReadyThread()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00444">KiStackInSwapListHead</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l03445">MmInPageKernelStack()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00322">KeSwapProcessOrStack()</a>.
<p>
<pre class="fragment"><div>00437                    :
00438 
00439     This function in swaps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel stack <span class="keywordflow">for</span> threads whose wait has been
00440     completed and whose kernel stack <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> nonresident.
00441 
00442     N.B. The dispatcher data lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held on entry to <span class="keyword">this</span> routine and must
00443          be <a class="code" href="../../d7/d4/conexts_8c.html#a23">help</a> on <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> to <span class="keyword">this</span> routine.
00444 
00445 Arguments:
00446 
00447     PreviousIrql - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous IRQL.
00448 
00449 Return Value:
00450 
00451     None.
00452 
00453 --*/
00454 
00455 {
00456 
00457     PLIST_ENTRY NextEntry;
00458     KIRQL OldIrql;
00459     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00460 
00461     <span class="comment">//</span>
00462     <span class="comment">// Process the stack in swap list and for each thread removed from the</span>
00463     <span class="comment">// list, make its kernel stack resident, and ready it for execution.</span>
00464     <span class="comment">//</span>
00465 
00466     OldIrql = PreviousIrql;
00467     NextEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a50">KiStackInSwapListHead</a>.Flink;
00468     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a50">KiStackInSwapListHead</a>) {
00469         Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, WaitListEntry);
00470         RemoveEntryList(NextEntry);
00471         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00472         <a class="code" href="../../d4/d5/procsup_8c.html#a37">MmInPageKernelStack</a>(Thread);
00473         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00474         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o44">KernelStackResident</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00475         <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(Thread);
00476         NextEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a50">KiStackInSwapListHead</a>.Flink;
00477     }
00478 
00479     <span class="keywordflow">return</span>;
00480 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="balmgr.c::KiInSwapProcesses" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInSwapProcesses           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN KIRQL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PreviousIrql</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00483">483</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00428">KiProcessInSwapListHead</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00270">KiReadyThread()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l03910">MmInSwapProcess()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a189">ProcessInSwap</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00624">_KTHREAD::ProcessReadyQueue</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00762">_KPROCESS::ReadyListHead</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00771">_KPROCESS::State</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00322">KeSwapProcessOrStack()</a>.
<p>
<pre class="fragment"><div>00489                    :
00490 
00491     This function in swaps processes.
00492 
00493     N.B. The dispatcher data lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held on entry to <span class="keyword">this</span> routine and must
00494          be <a class="code" href="../../d7/d4/conexts_8c.html#a23">help</a> on <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> to <span class="keyword">this</span> routine.
00495 
00496 Arguments:
00497 
00498     PreviousIrql - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous IRQL.
00499 
00500 Return Value:
00501 
00502     None.
00503 
00504 --*/
00505 
00506 {
00507 
00508     PLIST_ENTRY NextEntry;
00509     KIRQL OldIrql;
00510     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00511     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00512 
00513     <span class="comment">//</span>
00514     <span class="comment">// Process the process in swap list and for each process removed from</span>
00515     <span class="comment">// the list, make the process resident, and process its ready list.</span>
00516     <span class="comment">//</span>
00517 
00518     OldIrql = PreviousIrql;
00519     NextEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a48">KiProcessInSwapListHead</a>.Flink;
00520     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a48">KiProcessInSwapListHead</a>) {
00521         Process = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d5/d7/struct__KPROCESS.html">KPROCESS</a>, SwapListEntry);
00522         RemoveEntryList(NextEntry);
00523         Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a189">ProcessInSwap</a>;
00524         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00525         <a class="code" href="../../d4/d5/procsup_8c.html#a39">MmInSwapProcess</a>(Process);
00526         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00527         Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>;
00528         NextEntry = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>.Flink;
00529         <span class="keywordflow">while</span> (NextEntry != &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>) {
00530             Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, WaitListEntry);
00531             RemoveEntryList(NextEntry);
00532             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o43">ProcessReadyQueue</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00533             <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(Thread);
00534             NextEntry = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>.Flink;
00535         }
00536 
00537         NextEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a48">KiProcessInSwapListHead</a>.Flink;
00538     }
00539 
00540     <span class="keywordflow">return</span>;
00541 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="balmgr.c::KiOutSwapKernelStacks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiOutSwapKernelStacks           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN KIRQL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PreviousIrql</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00544">544</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00625">_KTHREAD::KernelStackResident</a>, <a class="el" href="../../d0/d9/mips_8h-source.html#l01565">KiIsThreadNumericStateSaved</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00435">KiProcessOutSwapListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02783">KiStackProtectTime</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00519">KiWaitInListHead</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00527">KiWaitOutListHead</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00063">MAXIMUM_THREAD_STACKS</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l03180">MmOutPageKernelStack()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00767">_KPROCESS::StackCount</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00771">_KPROCESS::State</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00763">_KPROCESS::SwapListEntry</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00584">_KTHREAD::WaitMode</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00589">_KTHREAD::WaitTime</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00322">KeSwapProcessOrStack()</a>.
<p>
<pre class="fragment"><div>00550                    :
00551 
00552     This function attempts to <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> swap <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel stack <span class="keywordflow">for</span> threads whose
00553     wait mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> user and which have been waiting longer than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack
00554     protect time.
00555 
00556     N.B. The dispatcher data lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held on entry to <span class="keyword">this</span> routine and must
00557          be <a class="code" href="../../d7/d4/conexts_8c.html#a23">help</a> on <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> to <span class="keyword">this</span> routine.
00558 
00559 Arguments:
00560 
00561     PreviousIrql - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous IRQL.
00562 
00563 Return Value:
00564 
00565     None.
00566 
00567 --*/
00568 
00569 {
00570 
00571     ULONG CurrentTick;
00572     PLIST_ENTRY NextEntry;
00573     ULONG NumberOfThreads;
00574     KIRQL OldIrql;
00575     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00576     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00577     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> ThreadObjects[<a class="code" href="../../d9/d0/balmgr_8c.html#a0">MAXIMUM_THREAD_STACKS</a>];
00578     ULONG WaitTime;
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">// Scan the waiting in list and check if the wait time exceeds the</span>
00582     <span class="comment">// stack protect time. If the protect time is exceeded, then make</span>
00583     <span class="comment">// the kernel stack of the waiting thread nonresident. If the count</span>
00584     <span class="comment">// of the number of stacks that are resident for the process reaches</span>
00585     <span class="comment">// zero, then insert the process in the outswap list and set its state</span>
00586     <span class="comment">// to transition.</span>
00587     <span class="comment">//</span>
00588 
00589     CurrentTick = KiQueryLowTickCount();
00590     OldIrql = PreviousIrql;
00591     NextEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a61">KiWaitInListHead</a>.Flink;
00592     NumberOfThreads = 0;
00593     <span class="keywordflow">while</span> ((NextEntry != &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a61">KiWaitInListHead</a>) &amp;&amp;
00594            (NumberOfThreads &lt; <a class="code" href="../../d9/d0/balmgr_8c.html#a0">MAXIMUM_THREAD_STACKS</a>)) {
00595         Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, WaitListEntry);
00596 
00597         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o18">WaitMode</a> == UserMode);
00598 
00599         NextEntry = NextEntry-&gt;Flink;
00600         WaitTime = CurrentTick - Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o23">WaitTime</a>;
00601         <span class="keywordflow">if</span> ((WaitTime &gt;= <a class="code" href="../../d4/d9/ke_8h.html#a140">KiStackProtectTime</a>) &amp;&amp;
00602              <a class="code" href="../../d9/d9/mips_8h.html#a1">KiIsThreadNumericStateSaved</a>(Thread)) {
00603             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o44">KernelStackResident</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00604             ThreadObjects[NumberOfThreads] = Thread;
00605             NumberOfThreads += 1;
00606             RemoveEntryList(&amp;Thread-&gt;WaitListEntry);
00607             InsertTailList(&amp;KiWaitOutListHead, &amp;Thread-&gt;WaitListEntry);
00608             Process = Thread-&gt;ApcState.Process;
00609             Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o11">StackCount</a> -= 1;
00610             <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o11">StackCount</a> == 0) {
00611                 Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>;
00612                 InsertTailList(&amp;KiProcessOutSwapListHead,
00613                                &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o7">SwapListEntry</a>);
00614             }
00615         }
00616     }
00617 
00618     <span class="comment">//</span>
00619     <span class="comment">// Unlock the dispatcher database and lower IRQL to its previous</span>
00620     <span class="comment">// value.</span>
00621     <span class="comment">//</span>
00622 
00623     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">// Out swap the kernels stack for the selected set of threads.</span>
00627     <span class="comment">//</span>
00628 
00629     <span class="keywordflow">while</span> (NumberOfThreads &gt; 0) {
00630         NumberOfThreads -= 1;
00631         Thread = ThreadObjects[NumberOfThreads];
00632         <a class="code" href="../../d4/d5/procsup_8c.html#a36">MmOutPageKernelStack</a>(Thread);
00633     }
00634 
00635     <span class="comment">//</span>
00636     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00637     <span class="comment">//</span>
00638 
00639     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00640     <span class="keywordflow">return</span>;
00641 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="balmgr.c::KiOutSwapProcesses" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiOutSwapProcesses           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN KIRQL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PreviousIrql</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00644">644</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00428">KiProcessInSwapListHead</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00435">KiProcessOutSwapListHead</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00270">KiReadyThread()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l03590">MmOutSwapProcess()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a187">ProcessOutOfMemory</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a190">ProcessOutSwap</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00624">_KTHREAD::ProcessReadyQueue</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00762">_KPROCESS::ReadyListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00771">_KPROCESS::State</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00763">_KPROCESS::SwapListEntry</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00322">KeSwapProcessOrStack()</a>.
<p>
<pre class="fragment"><div>00650                    :
00651 
00652     This function <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> swaps processes.
00653 
00654     N.B. The dispatcher data lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held on entry to <span class="keyword">this</span> routine and must
00655          be <a class="code" href="../../d7/d4/conexts_8c.html#a23">help</a> on <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> to <span class="keyword">this</span> routine.
00656 
00657 Arguments:
00658 
00659     PreviousIrql - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous IRQL.
00660 
00661 Return Value:
00662 
00663     None.
00664 
00665 --*/
00666 
00667 {
00668 
00669     PLIST_ENTRY NextEntry;
00670     KIRQL OldIrql;
00671     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00672     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00673 
00674     <span class="comment">//</span>
00675     <span class="comment">// Process the process out swap list and for each process removed from</span>
00676     <span class="comment">// the list, make the process nonresident, and process its ready list.</span>
00677     <span class="comment">//</span>
00678 
00679     OldIrql = PreviousIrql;
00680     NextEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a49">KiProcessOutSwapListHead</a>.Flink;
00681     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a49">KiProcessOutSwapListHead</a>) {
00682         Process = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d5/d7/struct__KPROCESS.html">KPROCESS</a>, SwapListEntry);
00683         RemoveEntryList(NextEntry);
00684 
00685         <span class="comment">//</span>
00686         <span class="comment">// If there are any threads in the process ready list, then don't</span>
00687         <span class="comment">// out swap the process and ready all threads in the process ready</span>
00688         <span class="comment">// list. Otherwsie, out swap the process.</span>
00689         <span class="comment">//</span>
00690 
00691         NextEntry = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>.Flink;
00692         <span class="keywordflow">if</span> (NextEntry != &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>) {
00693             Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>;
00694             <span class="keywordflow">while</span> (NextEntry != &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>) {
00695                 Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, WaitListEntry);
00696                 RemoveEntryList(NextEntry);
00697                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o43">ProcessReadyQueue</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00698                 <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(Thread);
00699                 NextEntry = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>.Flink;
00700             }
00701 
00702         } <span class="keywordflow">else</span> {
00703             Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a190">ProcessOutSwap</a>;
00704             <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00705             <a class="code" href="../../d4/d5/procsup_8c.html#a38">MmOutSwapProcess</a>(Process);
00706             <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00707 
00708             <span class="comment">//</span>
00709             <span class="comment">// While the process was being outswapped there may have been one</span>
00710             <span class="comment">// or more threads that attached to the process. If the process</span>
00711             <span class="comment">// ready list is not empty, then in swap the process. Otherwise,</span>
00712             <span class="comment">// mark the process as out of memory.</span>
00713             <span class="comment">//</span>
00714 
00715             NextEntry = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>.Flink;
00716             <span class="keywordflow">if</span> (NextEntry != &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o6">ReadyListHead</a>) {
00717                 Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>;
00718                 InsertTailList(&amp;KiProcessInSwapListHead, &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o7">SwapListEntry</a>);
00719 
00720             } <span class="keywordflow">else</span> {
00721                 Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a187">ProcessOutOfMemory</a>;
00722             }
00723         }
00724 
00725         NextEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a49">KiProcessOutSwapListHead</a>.Flink;
00726     }
00727 
00728     <span class="keywordflow">return</span>;
00729 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="balmgr.c::KiScanReadyQueues" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiScanReadyQueues           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00732">732</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00058">ClearMember</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00591">_KTHREAD::DecrementCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00036">KiDispatcherReadyListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00133">KiReadyQueueIndex</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00052">KiReadySummary</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00270">KiReadyThread()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00574">_KTHREAD::Priority</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00592">_KTHREAD::PriorityDecrement</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00593">_KTHREAD::Quantum</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00076">READY_WITHOUT_RUNNING</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00042">ROUND_TRIP_DECREMENT_COUNT</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00093">THREAD_BOOST_PRIORITY</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00095">THREAD_READY_COUNT</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00096">THREAD_SCAN_COUNT</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00094">THREAD_SCAN_PRIORITY</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00769">_KPROCESS::ThreadQuantum</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00589">_KTHREAD::WaitTime</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>.
<p>
<pre class="fragment"><div>00738                    :
00739 
00740     This function scans a section of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ready queues and attempts to
00741     boost <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority of threads that run at variable priority levels.
00742 
00743 Arguments:
00744 
00745     None.
00746 
00747 Return Value:
00748 
00749     None.
00750 
00751 --*/
00752 
00753 {
00754 
00755     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00756     ULONG CurrentTick;
00757     PLIST_ENTRY Entry;
00758     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00759     PLIST_ENTRY ListHead;
00760     ULONG Number = 0;
00761     KIRQL OldIrql;
00762     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00763     ULONG Summary;
00764     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00765     ULONG WaitTime;
00766 
00767     <span class="comment">//</span>
00768     <span class="comment">// Lock the dispatcher database and check if there are any ready threads</span>
00769     <span class="comment">// queued at the scannable priority levels.</span>
00770     <span class="comment">//</span>
00771 
00772     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00773     Summary = <a class="code" href="../../d5/d9/kernldat_8c.html#a2">KiReadySummary</a> &amp; ((1 &lt;&lt; <a class="code" href="../../d9/d0/balmgr_8c.html#a7">THREAD_BOOST_PRIORITY</a>) - 2);
00774     <span class="keywordflow">if</span> (Summary != 0) {
00775         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = <a class="code" href="../../d9/d0/balmgr_8c.html#a9">THREAD_READY_COUNT</a>;
00776         CurrentTick = KiQueryLowTickCount();
00777         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d9/d0/balmgr_8c.html#a14">KiReadyQueueIndex</a>;
00778         Number = <a class="code" href="../../d9/d0/balmgr_8c.html#a10">THREAD_SCAN_COUNT</a>;
00779         <span class="keywordflow">do</span> {
00780 
00781             <span class="comment">//</span>
00782             <span class="comment">// If the current ready queue index is beyond the end of the range</span>
00783             <span class="comment">// of priorities that are scanned, then wrap back to the beginning</span>
00784             <span class="comment">// priority.</span>
00785             <span class="comment">//</span>
00786 
00787             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt; <a class="code" href="../../d9/d0/balmgr_8c.html#a8">THREAD_SCAN_PRIORITY</a>) {
00788                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;
00789             }
00790 
00791             <span class="comment">//</span>
00792             <span class="comment">// If there are any ready threads queued at the current priority</span>
00793             <span class="comment">// level, then attempt to boost the thread priority.</span>
00794             <span class="comment">//</span>
00795 
00796             <span class="keywordflow">if</span> (((Summary &gt;&gt; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) &amp; 1) != 0) {
00797                 Summary ^= (1 &lt;&lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
00798                 ListHead = &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a0">KiDispatcherReadyListHead</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00799                 Entry = ListHead-&gt;Flink;
00800 
00801                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Entry != ListHead);
00802 
00803                 <span class="keywordflow">do</span> {
00804                     Thread = CONTAINING_RECORD(Entry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, WaitListEntry);
00805 
00806                     <span class="comment">//</span>
00807                     <span class="comment">// If the thread has been waiting for an extended period,</span>
00808                     <span class="comment">// then boost the priority of the selected.</span>
00809                     <span class="comment">//</span>
00810 
00811                     WaitTime = CurrentTick - Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o23">WaitTime</a>;
00812                     <span class="keywordflow">if</span> (WaitTime &gt;= <a class="code" href="../../d9/d0/balmgr_8c.html#a2">READY_WITHOUT_RUNNING</a>) {
00813 
00814                         <span class="comment">//</span>
00815                         <span class="comment">// Remove the thread from the respective ready queue.</span>
00816                         <span class="comment">//</span>
00817 
00818                         Entry = Entry-&gt;Blink;
00819                         RemoveEntryList(Entry-&gt;Flink);
00820                         <span class="keywordflow">if</span> (IsListEmpty(ListHead) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00821                             <a class="code" href="../../d0/d0/ki_8h.html#a6">ClearMember</a>(Index, KiReadySummary);
00822                         }
00823 
00824                         <span class="comment">//</span>
00825                         <span class="comment">// Compute the priority decrement value, set the new</span>
00826                         <span class="comment">// thread priority, set the decrement count, set the</span>
00827                         <span class="comment">// thread quantum, and ready the thread for execution.</span>
00828                         <span class="comment">//</span>
00829 
00830                         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o26">PriorityDecrement</a> +=
00831                                         <a class="code" href="../../d9/d0/balmgr_8c.html#a7">THREAD_BOOST_PRIORITY</a> - Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o13">Priority</a>;
00832 
00833                         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o25">DecrementCount</a> = <a class="code" href="../../d4/d9/ke_8h.html#a4">ROUND_TRIP_DECREMENT_COUNT</a>;
00834                         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o13">Priority</a> = <a class="code" href="../../d9/d0/balmgr_8c.html#a7">THREAD_BOOST_PRIORITY</a>;
00835                         Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00836                         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a> * 2;
00837                         <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(Thread);
00838                         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> -= 1;
00839                     }
00840 
00841                     Entry = Entry-&gt;Flink;
00842                     Number -= 1;
00843                 } <span class="keywordflow">while</span> ((Entry != ListHead) &amp; (Number != 0) &amp; (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != 0));
00844             }
00845 
00846             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00847         } <span class="keywordflow">while</span> ((Summary != 0) &amp; (Number != 0) &amp; (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != 0));
00848     }
00849 
00850     <span class="comment">//</span>
00851     <span class="comment">// Unlock the dispatcher database and save the last read queue index</span>
00852     <span class="comment">// for the next scan.</span>
00853     <span class="comment">//</span>
00854 
00855     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00856     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != 0) &amp;&amp; (Number != 0)) {
00857         <a class="code" href="../../d9/d0/balmgr_8c.html#a14">KiReadyQueueIndex</a> = 1;
00858 
00859     } <span class="keywordflow">else</span> {
00860         <a class="code" href="../../d9/d0/balmgr_8c.html#a14">KiReadyQueueIndex</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00861     }
00862 
00863     <span class="keywordflow">return</span>;
00864 }
}
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a14" doxytag="balmgr.c::KiReadyQueueIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d0/balmgr_8c.html#a14">KiReadyQueueIndex</a> = 1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00133">133</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00732">KiScanReadyQueues()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="balmgr.c::KiStackOutSwapRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d0/balmgr_8c.html#a15">KiStackOutSwapRequest</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00139">139</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>, and <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00322">KeSwapProcessOrStack()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="balmgr.c::KiStackProtectTime" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d0/balmgr_8c.html#a13">KiStackProtectTime</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00086">86</a> of file <a class="el" href="../../d0/d0/balmgr_8c-source.html">balmgr.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00544">KiOutSwapKernelStacks()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l03448">MiApplyDriverVerifier()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l03625">MiVerifyingDriverUnloading()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
