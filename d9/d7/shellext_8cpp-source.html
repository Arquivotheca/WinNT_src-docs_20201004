<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: shellext.cpp Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>shellext.cpp</h1><a href="../../d8/d8/shellext_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/******************************************************************************</span>
00002 <span class="comment"></span>
00003 <span class="comment">  Source File:  Shell Extension Classes.CPP</span>
00004 <span class="comment"></span>
00005 <span class="comment">  This file implements the Shell Extension classes.</span>
00006 <span class="comment"></span>
00007 <span class="comment">  Copyright (c) 1996, 1997 by Microsoft Corporation.  All Rights Reserved.</span>
00008 <span class="comment"></span>
00009 <span class="comment">  A Pretty Penny Enterprises Production</span>
00010 <span class="comment"></span>
00011 <span class="comment">  Change History:</span>
00012 <span class="comment"></span>
00013 <span class="comment">  10-28-96  A-RobKj (Pretty Penny Enterprises) began coding</span>
00014 <span class="comment">  12-04-96  A-RobKj Added the printer tab support</span>
00015 <span class="comment">  12-13-96  A-RobKj Modified for faster Icon extraction</span>
00016 <span class="comment">  01-07-97  KjelgaardR@ACM.Org  Removed IContextMenu functions in favor of</span>
00017 <span class="comment">            an exported ManageColorProfile procedure.  This supplies a</span>
00018 <span class="comment">            language-independent "Open" item that works with either mouse</span>
00019 <span class="comment">            button.</span>
00020 <span class="comment">  01-08-97  KjelgaardR@acm.org  Added utility routine to determine if a printer</span>
00021 <span class="comment">            is a color model.  Modified printer UI to only add pages for color</span>
00022 <span class="comment">            printers.</span>
00023 <span class="comment"></span>
00024 <span class="comment">******************************************************************************/</span>
00025 
00026 <span class="preprocessor">#include    "ICMUI.H"</span>
00027 
00028 <span class="preprocessor">#include    &lt;shlobj.h&gt;</span>
00029 <span class="preprocessor">#include    &lt;string.h&gt;</span>
00030 
00031 <span class="preprocessor">#include    &lt;initguid.h&gt;</span>
00032 <span class="preprocessor">#include    "ShellExt.H"</span>
00033 <span class="preprocessor">#include    "Resource.H"</span>
00034 
00035 <span class="comment">//  Declare some storage space for the global statics</span>
00036 
<a name="l00037"></a><a class="code" href="../../d0/d3/classCGlobals.html#v0">00037</a> <span class="keywordtype">int</span>     <a class="code" href="../../d0/d3/classCGlobals.html#v0">CGlobals::m_icDLLReferences</a> = 0;
<a name="l00038"></a><a class="code" href="../../d0/d3/classCGlobals.html#v1">00038</a> HMODULE <a class="code" href="../../d0/d3/classCGlobals.html#v1">CGlobals::m_hmThisDll</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00039"></a><a class="code" href="../../d0/d3/classCGlobals.html#v2">00039</a> <a class="code" href="../../d2/d7/classCStringArray.html">CStringArray</a>    <a class="code" href="../../d0/d3/classCGlobals.html#v2">CGlobals::m_csaProfiles</a>;
<a name="l00040"></a><a class="code" href="../../d0/d3/classCGlobals.html#v3">00040</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            <a class="code" href="../../d0/d3/classCGlobals.html#v3">CGlobals::m_bIsValid</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00041 
00042 <span class="comment">//  Some global useful procs- an error reporter</span>
00043 
<a name="l00044"></a><a class="code" href="../../d0/d3/classCGlobals.html#e6">00044</a> <span class="keywordtype">void</span>    <a class="code" href="../../d0/d3/classCGlobals.html#e6">CGlobals::Report</a>(<span class="keywordtype">int</span> idError, HWND m_hwndParent) {
00045     <a class="code" href="../../d1/d7/classCString.html">CString</a> csMessage, csTitle;
00046 
00047     csMessage.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(idError);
00048     csTitle.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a8">MessageBoxTitle</a>);
00049 
00050     MessageBox(m_hwndParent, csMessage, csTitle, MB_OK|MB_ICONEXCLAMATION);
00051 }
00052 
<a name="l00053"></a><a class="code" href="../../d0/d3/classCGlobals.html#e7">00053</a> <span class="keywordtype">int</span>    <a class="code" href="../../d0/d3/classCGlobals.html#e7">CGlobals::ReportEx</a>(<span class="keywordtype">int</span> idError, HWND m_hwndParent,
00054                           BOOL bSystemMessage, <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uType, DWORD dwNumMsg, ...) {
00055     <a class="code" href="../../d1/d7/classCString.html">CString</a> csMessage, csTitle;
00056     va_list argList;
00057 
00058     va_start(argList,dwNumMsg);
00059     csMessage.<a class="code" href="../../d1/d7/classCString.html#a18">LoadAndFormat</a>(idError,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,bSystemMessage,dwNumMsg,&amp;argList);
00060     csTitle.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a8">MessageBoxTitle</a>);
00061     va_end(argList);
00062 
00063     <span class="keywordflow">return</span> (MessageBox(m_hwndParent, csMessage, csTitle, uType));
00064 }
00065 
00066 <span class="comment">//  A profile status checker</span>
00067 
<a name="l00068"></a><a class="code" href="../../d0/d3/classCGlobals.html#e8">00068</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d0/d3/classCGlobals.html#e8">CGlobals::IsInstalled</a>(<a class="code" href="../../d1/d7/classCString.html">CString</a>&amp; csProfile) {
00069 <span class="comment">//    if  (!m_bIsValid) {</span>
00070         ENUMTYPE    et = {<span class="keyword">sizeof</span> et, ENUM_TYPE_VERSION, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>};
00071 
00072         CProfile::Enumerate(et, <a class="code" href="../../d0/d3/classCGlobals.html#v2">m_csaProfiles</a>);
00073         <a class="code" href="../../d0/d3/classCGlobals.html#v3">m_bIsValid</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00074 <span class="comment">//    }</span>
00075 
00076     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; <a class="code" href="../../d0/d3/classCGlobals.html#v2">m_csaProfiles</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a2">Count</a>(); u++)
00077         <span class="keywordflow">if</span>  (!lstrcmpi(csProfile.<a class="code" href="../../d1/d7/classCString.html#a14">NameOnly</a>(), <a class="code" href="../../d0/d3/classCGlobals.html#v2">m_csaProfiles</a>[u].NameOnly()))
00078             <span class="keywordflow">break</span>;
00079 
00080     <span class="keywordflow">return</span>  u &lt; <a class="code" href="../../d0/d3/classCGlobals.html#v2">m_csaProfiles</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a2">Count</a>();
00081 }
00082 
00083 <span class="comment">//  Utility routine to report if a printer is color or monochrome</span>
<a name="l00084"></a><a class="code" href="../../d0/d3/classCGlobals.html#e11">00084</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d3/classCGlobals.html#e11">CGlobals::ThisIsAColorPrinter</a>(LPCTSTR lpstrName) {
00085   HDC hdcThis = <a class="code" href="../../d0/d3/classCGlobals.html#e10">CGlobals::GetPrinterHDC</a>(lpstrName);
00086   <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bReturn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00087   <span class="keywordflow">if</span>  (hdcThis) {
00088     bReturn =  2 &lt; (<span class="keywordtype">unsigned</span>) GetDeviceCaps(hdcThis, NUMCOLORS);
00089     DeleteDC(hdcThis);
00090   }
00091   <span class="keywordflow">return</span> bReturn;
00092 }
00093 
00094 <span class="comment">// Utility to determine the hdc for a printer</span>
00095 <span class="comment">// The caller is responsible for calling</span>
00096 <span class="comment">// DeleteDC() on the result</span>
<a name="l00097"></a><a class="code" href="../../d0/d3/classCGlobals.html#e10">00097</a> HDC <a class="code" href="../../d0/d3/classCGlobals.html#e10">CGlobals::GetPrinterHDC</a>(LPCTSTR lpstrName) {
00098 
00099     HANDLE  hPrinter;   <span class="comment">//  Get a handle on it...</span>
00100     LPTSTR  lpstrMe = const_cast &lt;LPTSTR&gt; (lpstrName);
00101 
00102     <span class="keywordflow">if</span>  (!OpenPrinter(lpstrMe, &amp;hPrinter, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00103         _RPTF2(_CRT_WARN, <span class="stringliteral">"Unable to open printer '%s'- error %d\n"</span>, lpstrName,
00104             GetLastError());
00105         <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00106     }
00107 
00108     <span class="comment">//  First, use DocumentProperties to find the correct DEVMODE size- we</span>
00109     <span class="comment">//  must use the DEVMODE to force color on, in case the user's defaults</span>
00110     <span class="comment">//  have turned it off...</span>
00111 
00112     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> lcbNeeded = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>) DocumentProperties(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hPrinter, lpstrMe, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00113         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00114 
00115     <span class="keywordflow">if</span>  (lcbNeeded &lt;= 0) {
00116         _RPTF2(_CRT_WARN,
00117             <span class="stringliteral">"Document Properties (get size) for '%s' returned %d\n"</span>, lpstrName,
00118             lcbNeeded);
00119         ClosePrinter(hPrinter);
00120         <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00121     }
00122 
00123     HDC hdcThis = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00124 
00125     <span class="keyword">union </span>{
00126         LPBYTE      lpb;
00127         LPDEVMODE   lpdm;
00128     };
00129 
00130     lpb = <span class="keyword">new</span> <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>[lcbNeeded];
00131 
00132     <span class="keywordflow">if</span>  (lpb) {
00133 
00134         ZeroMemory(lpb,lcbNeeded);
00135         lpdm -&gt; dmSize = lcbNeeded;
00136         lpdm -&gt; dmFields = DM_COLOR;
00137         lpdm -&gt; dmColor = DMCOLOR_COLOR;
00138         <span class="keywordflow">if</span>  (IDOK == DocumentProperties(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hPrinter, lpstrMe, lpdm, lpdm,
00139             DM_IN_BUFFER | DM_OUT_BUFFER)) {
00140 
00141             <span class="comment">//  Turn off ICM, since not nessesary here.</span>
00142             <span class="comment">//</span>
00143             lpdm -&gt; dmICMMethod = DMICMMETHOD_NONE;
00144 
00145             <span class="comment">//  Finally, we can create the DC!</span>
00146             <span class="comment">//  Note: we're not actually creating a DC, just an IC</span>
00147             hdcThis = CreateIC(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, lpstrName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, lpdm);
00148         } <span class="keywordflow">else</span> {
00149             _RPTF2(_CRT_WARN,
00150                 <span class="stringliteral">"DocumentProperties (retrieve) on '%s' failed- error %d\n"</span>,
00151                 lpstrName, GetLastError());
00152         }
00153         <span class="keyword">delete</span> lpb;
00154     }
00155     <span class="keywordflow">else</span>
00156         _RPTF2(_CRT_WARN, <span class="stringliteral">"ThisIsAColorPrinter(%s) failed to get %d bytes\n"</span>,
00157             lpstrName, lcbNeeded);
00158 
00159     ClosePrinter(hPrinter);
00160 
00161     <span class="keywordflow">return</span> hdcThis;
00162 }
00163 
00164 <span class="comment">//  Required Shell Extension DLL interfaces</span>
00165 
<a name="l00166"></a><a class="code" href="../../d8/d8/shellext_8cpp.html#a0">00166</a> STDAPI  <a class="code" href="../../d8/d8/shellext_8cpp.html#a0">DllCanUnloadNow</a>() {
00167     <span class="keywordflow">return</span>  <a class="code" href="../../d0/d3/classCGlobals.html#e5">CGlobals::CanUnload</a>();
00168 }
00169 
<a name="l00170"></a><a class="code" href="../../d8/d8/shellext_8cpp.html#a1">00170</a> STDAPI  <a class="code" href="../../d8/d8/shellext_8cpp.html#a1">DllGetClassObject</a>(REFCLSID rclsid, REFIID riid, <span class="keywordtype">void</span> **ppvOut) {
00171     <span class="keywordflow">return</span>  CIcmUiFactory::KeyToTheFactory(rclsid, riid, ppvOut);
00172 }
00173 
<a name="l00174"></a><a class="code" href="../../d8/d8/shellext_8cpp.html#a2">00174</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d9/d6/w98_2mscmm_2icm32_8c.html#a15">DllMain</a>(HMODULE hmThis, DWORD dwReason,
00175                                 LPVOID lpvReserved) {
00176 <span class="preprocessor">#if defined(DEBUG) || defined(_DEBUG)</span>
00177 <span class="preprocessor"></span>    <span class="keyword">static</span>  HANDLE  hfWarnings; <span class="comment">//  Log file</span>
00178 <span class="preprocessor">#endif</span>
00179 <span class="preprocessor"></span>    <span class="keywordflow">switch</span>  (dwReason) {
00180 
00181         <span class="keywordflow">case</span>    DLL_PROCESS_ATTACH:
00182 
00183             <span class="comment">//  Save the handle</span>
00184             CGlobals::SetHandle(hmThis);
00185 <span class="preprocessor">#if defined(DEBUG) || defined(_DEBUG)</span>
00186 <span class="preprocessor"></span>            _CrtSetReportMode(_CRT_ASSERT, _CRTDBG_MODE_WNDW);
00187             _CrtSetReportMode(_CRT_WARN, _CRTDBG_MODE_FILE);
00188             hfWarnings = CreateFileA(<span class="stringliteral">"C:\\ICMUIWarn.Txt"</span>, GENERIC_WRITE, 0,
00189                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OPEN_ALWAYS, FILE_ATTRIBUTE_NORMAL, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00190 
00191             <span class="keywordflow">if</span>  (hfWarnings!= <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>) {
00192                 SetFilePointer(hfWarnings, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, FILE_END);
00193                 _CrtSetReportFile(_CRT_WARN, hfWarnings);
00194             }
00195             _RPTF1(_CRT_WARN, <span class="stringliteral">"ICMUI DLL being loaded- handle %X\n"</span>, hmThis);
00196             <span class="keywordflow">break</span>;
00197 
00198         <span class="keywordflow">case</span>    DLL_PROCESS_DETACH:
00199             _RPTF0(_CRT_WARN, <span class="stringliteral">"ICMUI DLL being unloaded\n"</span>);
00200 
00201             <span class="keywordflow">if</span>  (hfWarnings != <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>)
00202                 CloseHandle(hfWarnings);
00203 <span class="preprocessor">#endif</span>
00204 <span class="preprocessor"></span>    }
00205 
00206     <span class="keywordflow">return</span>  1;
00207 }
00208 
00209 <span class="comment">//  CIcmUiFactory member functions- these are used to provide external access</span>
00210 <span class="comment">//  to the class factory.  The shell uses these to initialize extensions for</span>
00211 <span class="comment">//  both context menus and property sheets, both of which we provide,</span>
00212 <span class="comment">//  fortunately in the same object...</span>
00213 
<a name="l00214"></a><a class="code" href="../../d3/d3/classCIcmUiFactory.html#a0">00214</a> <a class="code" href="../../d3/d3/classCIcmUiFactory.html#a0">CIcmUiFactory::CIcmUiFactory</a>(REFCLSID rclsid) {
00215     <a class="code" href="../../d3/d3/classCIcmUiFactory.html#r0">m_ulcReferences</a> = 0;
00216     <a class="code" href="../../d0/d3/classCGlobals.html#e0">CGlobals::Attach</a>();
00217     <span class="keywordflow">if</span>  (IsEqualIID(rclsid, CLSID_ICM))
00218         <a class="code" href="../../d3/d3/classCIcmUiFactory.html#r1">m_utThis</a> = <a class="code" href="../../d9/d8/shellext_8h.html#a8a0">IsProfile</a>;
00219     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsEqualIID(rclsid, CLSID_PRINTERUI))
00220         <a class="code" href="../../d3/d3/classCIcmUiFactory.html#r1">m_utThis</a> = <a class="code" href="../../d9/d8/shellext_8h.html#a8a1">IsPrinter</a>;
00221     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsEqualIID(rclsid, CLSID_SCANNERUI))
00222         <a class="code" href="../../d3/d3/classCIcmUiFactory.html#r1">m_utThis</a> = <a class="code" href="../../d9/d8/shellext_8h.html#a8a2">IsScanner</a>;
00223     <span class="keywordflow">else</span>
00224         <a class="code" href="../../d3/d3/classCIcmUiFactory.html#r1">m_utThis</a> = <a class="code" href="../../d9/d8/shellext_8h.html#a8a3">IsMonitor</a>;
00225 }
00226 
<a name="l00227"></a><a class="code" href="../../d3/d3/classCIcmUiFactory.html#a2">00227</a> STDMETHODIMP    <a class="code" href="../../d3/d3/classCIcmUiFactory.html#a2">CIcmUiFactory::QueryInterface</a>(REFIID riid, <span class="keywordtype">void</span> **ppvObject) {
00228 
00229     <span class="keywordflow">if</span>  (IsEqualIID(riid, IID_IUnknown) ||
00230             IsEqualIID(riid, IID_IClassFactory)) {
00231         *ppvObject = <span class="keyword">this</span>;
00232         AddRef();
00233         <span class="keywordflow">return</span>  NOERROR;
00234     }
00235     <span class="comment">//  Asked for an interface we ain't got!</span>
00236     *ppvObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00237     <span class="keywordflow">return</span>  E_NOINTERFACE;
00238 }
00239 
00240 <span class="comment">//  IClassFactory interface functions</span>
00241 
<a name="l00242"></a><a class="code" href="../../d3/d3/classCIcmUiFactory.html#a5">00242</a> STDMETHODIMP    <a class="code" href="../../d3/d3/classCIcmUiFactory.html#a5">CIcmUiFactory::CreateInstance</a>(LPUNKNOWN punk, REFIID riid,
00243                                               <span class="keywordtype">void</span> **ppvInstance) {
00244 
00245     *ppvInstance = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00246 
00247     <span class="keywordflow">if</span>  (punk)  <span class="comment">//  We don't allow aggregation</span>
00248         <span class="keywordflow">return</span>  CLASS_E_NOAGGREGATION;
00249 
00250     <span class="comment">//  We simply create a new ICM UI object, and return an interface to it.</span>
00251     <span class="comment">//  This will get queried by the shell for IExtShellInit, and the init job</span>
00252     <span class="comment">//  will be done.</span>
00253 
00254     <a class="code" href="../../d4/d3/classCICMUserInterface.html">CICMUserInterface</a>   *pcicmui = <span class="keyword">new</span> <a class="code" href="../../d4/d3/classCICMUserInterface.html">CICMUserInterface</a>(<a class="code" href="../../d3/d3/classCIcmUiFactory.html#r1">m_utThis</a>);
00255 
00256     <span class="keywordflow">if</span>  (!pcicmui)
00257         <span class="keywordflow">return</span>  E_OUTOFMEMORY;
00258 
00259     <span class="comment">//  Let's be paranoid- if the QueryInterface failes, kill the ICMUI object,</span>
00260     <span class="comment">//  so we can still be unloaded!</span>
00261 
00262     HRESULT hrReturn = pcicmui -&gt; <a class="code" href="../../d3/d3/classCIcmUiFactory.html#a2">QueryInterface</a>(riid, ppvInstance);
00263 
00264     <span class="keywordflow">if</span>  (!*ppvInstance)
00265         <span class="keyword">delete</span>  pcicmui;
00266 
00267     <span class="keywordflow">return</span>  hrReturn;
00268 }
00269 
00270 
00271 <span class="comment">//  Key to the factory is a static function that allows outsiders to instance</span>
00272 <span class="comment">//  the class factory.  So, the caller will first instance the factory, then</span>
00273 <span class="comment">//  instance implementations of the interfaces it needs using the factory</span>
00274 <span class="comment">//  instance it receives from here.</span>
00275 
<a name="l00276"></a><a class="code" href="../../d3/d3/classCIcmUiFactory.html#e0">00276</a> HRESULT <a class="code" href="../../d3/d3/classCIcmUiFactory.html#e0">CIcmUiFactory::KeyToTheFactory</a>(REFCLSID rclsid, REFIID riid,
00277                                        <span class="keywordtype">void</span> **ppvObject) {
00278   
00279     *ppvObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00280 
00281     <span class="keywordflow">if</span>  (!IsEqualIID(rclsid, CLSID_ICM) &amp;&amp;
00282          !IsEqualIID(rclsid, CLSID_MONITORUI) &amp;&amp;
00283          !IsEqualIID(rclsid, CLSID_SCANNERUI) &amp;&amp;
00284          !IsEqualIID(rclsid, CLSID_PRINTERUI))
00285         <span class="keywordflow">return</span>  CLASS_E_CLASSNOTAVAILABLE;
00286 
00287     <a class="code" href="../../d3/d3/classCIcmUiFactory.html">CIcmUiFactory</a>   *pciuf = <span class="keyword">new</span> <a class="code" href="../../d3/d3/classCIcmUiFactory.html">CIcmUiFactory</a>(rclsid);
00288 
00289     <span class="keywordflow">if</span>  (!pciuf)
00290         <span class="keywordflow">return</span>  E_OUTOFMEMORY;
00291 
00292     HRESULT hrReturn = pciuf -&gt; <a class="code" href="../../d3/d3/classCIcmUiFactory.html#a2">QueryInterface</a>(riid, ppvObject);
00293 
00294     <span class="keywordflow">if</span>  (!*ppvObject)
00295         <span class="keyword">delete</span>  pciuf;
00296 
00297     <span class="keywordflow">return</span>  hrReturn;
00298 }
00299 
00300 <span class="comment">/******************************************************************************</span>
00301 <span class="comment"></span>
00302 <span class="comment">  ICM UI class methods- these do the true interface work of the DLL.</span>
00303 <span class="comment"></span>
00304 <span class="comment">******************************************************************************/</span>
00305 
00306 
<a name="l00307"></a><a class="code" href="../../d4/d3/classCICMUserInterface.html#a0">00307</a> <a class="code" href="../../d4/d3/classCICMUserInterface.html#a0">CICMUserInterface::CICMUserInterface</a>(UITYPE utThis) {
00308     <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00309     <a class="code" href="../../d4/d3/classCICMUserInterface.html#r0">m_ulcReferences</a> = 0;
00310     <a class="code" href="../../d4/d3/classCICMUserInterface.html#r4">m_utThis</a> = utThis;
00311     <a class="code" href="../../d0/d3/classCGlobals.html#e0">CGlobals::Attach</a>();
00312     _RPTF2(_CRT_WARN, <span class="stringliteral">"CICMUserInterface(%d) constructed @ %lX\n"</span>, utThis, <span class="keyword">this</span>);
00313 }
00314 <span class="comment">//  QueryInterface gets a bit long, but not too badly.  The casts are needed</span>
00315 <span class="comment">//  because we use multiple inheritance- casting the this pointer to a base</span>
00316 <span class="comment">//  class actually returns a this pointer for that base class' part of the</span>
00317 <span class="comment">//  instance.  Unlike single inheritance, the this pointer for the</span>
00318 <span class="comment">//  CICMUserInterface class does not directly reference ANY of the base</span>
00319 <span class="comment">//  classes.</span>
00320 
00321 STDMETHODIMP    CICMUserInterface::QueryInterface(REFIID riid,
00322                                                   <span class="keywordtype">void</span> **ppvObject) {
00323     *ppvObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;  <span class="comment">//  Assume the worst</span>
00324     <span class="comment">//  Since the device UI support a different set of functions, let's be</span>
00325     <span class="comment">//  particular about which interfaces we claim to support when...</span>
00326     <span class="keywordflow">if</span>  (m_utThis &gt; <a class="code" href="../../d9/d8/shellext_8h.html#a8a0">IsProfile</a>) {
00327         <span class="keywordflow">if</span>  (IsEqualIID(riid, IID_IUnknown) ||
00328                 IsEqualIID(riid, IID_IShellExtInit))
00329             *ppvObject = (IShellExtInit *) <span class="keyword">this</span>;
00330         <span class="keywordflow">if</span>  (IsEqualIID(riid, IID_IShellPropSheetExt))
00331                            *ppvObject = (IShellPropSheetExt *) <span class="keyword">this</span>;
00332     }
00333     <span class="keywordflow">else</span> {
00334         <span class="keywordflow">if</span>  (IsEqualIID(riid, IID_IUnknown) ||
00335                 IsEqualIID(riid, IID_IContextMenu))
00336             *ppvObject = (IContextMenu *) <span class="keyword">this</span>;
00337 
00338         <span class="keywordflow">if</span>  (IsEqualIID(riid, IID_IShellExtInit))
00339             *ppvObject = (IShellExtInit *) <span class="keyword">this</span>;
00340 
00341         <span class="keywordflow">if</span>  (IsEqualIID(riid, IID_IExtractIcon))
00342             *ppvObject = (IExtractIcon *) <span class="keyword">this</span>;
00343 
00344         <span class="keywordflow">if</span>  (IsEqualIID(riid, IID_IPersistFile) ||
00345                 IsEqualIID(riid, IID_IPersist))
00346             *ppvObject = (IPersistFile *) <span class="keyword">this</span>;
00347 
00348         <span class="keywordflow">if</span>  (IsEqualIID(riid, IID_IShellPropSheetExt))
00349             *ppvObject = (IShellPropSheetExt *) <span class="keyword">this</span>;
00350     }
00351 
00352     <span class="keywordflow">if</span>  (*ppvObject)
00353         ((IUnknown *) *ppvObject) -&gt; AddRef();
00354 
00355     _RPTF2(_CRT_WARN, <span class="stringliteral">"CICMUserInterace::QueryInterface(%lX) returns %lX\n"</span>,
00356         <span class="keyword">this</span>, ppvObject);
00357 
00358     <span class="keywordflow">return</span>  *ppvObject ? NOERROR : E_NOINTERFACE;
00359 }
00360 
00361 <span class="comment">//  IShellExtInit member function- this interface needs only one</span>
00362 
<a name="l00363"></a><a class="code" href="../../d4/d3/classCICMUserInterface.html#a8">00363</a> STDMETHODIMP    <a class="code" href="../../d4/d3/classCICMUserInterface.html#a8">CICMUserInterface::Initialize</a>(LPCITEMIDLIST pcidlFolder,
00364                                               LPDATAOBJECT pdoTarget,
00365                                               HKEY hKeyID) {
00366 
00367     _RPTF0(_CRT_WARN, <span class="stringliteral">"CICMUserInterface::Initialize\n"</span>);
00368 
00369     <span class="comment">//  The target data object is an HDROP, or list of files from the shell.</span>
00370 
00371     <span class="keywordflow">if</span>  (<a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a>) {
00372         <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> -&gt; Release();
00373         <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00374     }
00375 
00376     <span class="keywordflow">if</span>  (pdoTarget) {
00377         <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> = pdoTarget;
00378         <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> -&gt; AddRef();
00379     }
00380 
00381     <span class="keywordflow">return</span>  NOERROR;
00382 }
00383 
00384 <span class="comment">//  IExtractIcon interface functions- for now, we'll default to providing a</span>
00385 <span class="comment">//  default icon from our DLL.  We provide one icon for installed profiles,</span>
00386 <span class="comment">//  and a second for uninstalled ones.</span>
00387 
<a name="l00388"></a><a class="code" href="../../d4/d3/classCICMUserInterface.html#a9">00388</a> STDMETHODIMP    <a class="code" href="../../d4/d3/classCICMUserInterface.html#a9">CICMUserInterface::GetIconLocation</a>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uFlags,
00389                                                    LPTSTR lpstrTarget,
00390                                                    UINT uccTarget,
00391                                                    <span class="keywordtype">int</span> *piIndex,
00392                                                    UINT *puFlags) {
00393 
00394     *puFlags = (GIL_NOTFILENAME|GIL_DONTCACHE); <span class="comment">// Make shell call our Extract function</span>
00395                                                 <span class="comment">// And don't cache in the callee.</span>
00396 
00397     <span class="keywordflow">return</span> S_FALSE;
00398 }
00399 
<a name="l00400"></a><a class="code" href="../../d4/d3/classCICMUserInterface.html#a10">00400</a> STDMETHODIMP    <a class="code" href="../../d4/d3/classCICMUserInterface.html#a10">CICMUserInterface::Extract</a>(LPCTSTR lpstrFile, UINT nIconIndex,
00401                             HICON *phiconLarge, HICON *phiconSmall,
00402                             UINT nIconSize) {
00403 
00404     *phiconSmall = *phiconLarge = LoadIcon(CGlobals::Instance(),
00405         MAKEINTRESOURCE(CGlobals::IsInstalled(<a class="code" href="../../d4/d3/classCICMUserInterface.html#r2">m_csFile</a>) ? <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a44">DefaultIcon</a> : <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a45">UninstalledIcon</a>));
00406 
00407     <span class="keywordflow">return</span> NOERROR;
00408 }
00409 
00410 <span class="comment">//  IPersistFile functions- there's only one worth implementing</span>
00411 
<a name="l00412"></a><a class="code" href="../../d4/d3/classCICMUserInterface.html#a13">00412</a> STDMETHODIMP    <a class="code" href="../../d4/d3/classCICMUserInterface.html#a13">CICMUserInterface::Load</a>(LPCOLESTR lpwstrFileName,
00413                                         DWORD dwMode) {
00414     <span class="comment">//  This interface is used to initialize the icon handler- it will</span>
00415     <span class="comment">//  receive the profile name, which we will save for later use.</span>
00416     <span class="comment">//  The CString assigment operator handles any encoding converions needed</span>
00417     <span class="comment">//  encoding conversions for us.</span>
00418 
00419     <a class="code" href="../../d4/d3/classCICMUserInterface.html#r2">m_csFile</a> = lpwstrFileName;
00420 
00421     <span class="keywordflow">return</span>  <a class="code" href="../../d4/d3/classCICMUserInterface.html#r2">m_csFile</a>.<a class="code" href="../../d1/d7/classCString.html#a5">IsEmpty</a>() ? E_OUTOFMEMORY : NO_ERROR;
00422 }
00423 
00424 <span class="comment">//  IContextMenu functions-</span>
00425 
<a name="l00426"></a><a class="code" href="../../d4/d3/classCICMUserInterface.html#a5">00426</a> STDMETHODIMP    <a class="code" href="../../d4/d3/classCICMUserInterface.html#a5">CICMUserInterface::QueryContextMenu</a>(HMENU hMenu, UINT indexMenu,
00427                                                     UINT idCmdFirst, UINT idCmdLast,
00428                                                     UINT uFlags) {
00429 
00430     <span class="comment">//  Only CMF_NORMAL and CMF_EXPLORE case will be handled.</span>
00431     <span class="comment">//</span>
00432     <span class="comment">//  CMF_CANRENAME     -  This flag is set if the calling application supports</span>
00433     <span class="comment">//                      renaming of items. A context menu extension or drag-and-drop</span>
00434     <span class="comment">//                      handler should ignore this flag. A namespace extension should</span>
00435     <span class="comment">//                      add a rename item to the menu if applicable.</span>
00436     <span class="comment">//  CMF_DEFAULTONLY   -  This flag is set when the user is activating the default action,</span>
00437     <span class="comment">//                      typically by double-clicking. This flag provides a hint for the</span>
00438     <span class="comment">//                      context menu extension to add nothing if it does not modify the</span>
00439     <span class="comment">//                      default item in the menu. A context menu extension or drag-and-drop</span>
00440     <span class="comment">//                      handler should not add any menu items if this value is specified.</span>
00441     <span class="comment">//                      A namespace extension should add only the default item (if any).</span>
00442     <span class="comment">//  CMF_EXPLORE       -  This flag is set when Windows Explorer's tree window is present.</span>
00443     <span class="comment">//                      Context menu handlers should ignore this value.</span>
00444     <span class="comment">//  CMF_INCLUDESTATIC -  This flag is set when a static menu is being constructed.</span>
00445     <span class="comment">//                      Only the browser should use this flag. All other context menu</span>
00446     <span class="comment">//                      extensions should ignore this flag.</span>
00447     <span class="comment">//  CMF_NODEFAULT     -  This flag is set if no item in the menu should be the default item.</span>
00448     <span class="comment">//                      A context menu extension or drag-and-drop handler should ignore this</span>
00449     <span class="comment">//                      flag. A namespace extension should not set any of the menu items to</span>
00450     <span class="comment">//                      the default.</span>
00451     <span class="comment">//  CMF_NORMAL        -  Indicates normal operation. A context menu extension, namespace extension,</span>
00452     <span class="comment">//                      or drag-and-drop handler can add all menu items.</span>
00453     <span class="comment">//  CMF_NOVERBS       -  This flag is set for items displayed in the "Send To:" menu.</span>
00454     <span class="comment">//                      Context menu handlers should ignore this value.</span>
00455     <span class="comment">//  CMF_VERBSONLY     -  This flag is set if the context menu is for a shortcut object.</span>
00456     <span class="comment">//                      Context menu handlers should ignore this value.</span>
00457 
00458     <span class="keywordflow">if</span> (((uFlags &amp; 0x000F) == CMF_NORMAL) || (uFlags &amp; CMF_EXPLORE))
00459     {
00460         <span class="comment">//</span>
00461         <span class="comment">//  Load the profile(s) in the list.</span>
00462         <span class="comment">//</span>
00463         FORMATETC       fmte = {CF_HDROP, (DVTARGETDEVICE <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00464                                 DVASPECT_CONTENT, -1, TYMED_HGLOBAL };
00465         STGMEDIUM       stgm;
00466         HRESULT         hres = <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> ?
00467                                <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> -&gt; GetData(&amp;fmte, &amp;stgm) : 0;
00468 
00469         <span class="keywordflow">if</span>  (!SUCCEEDED(hres))
00470             <span class="keywordflow">return</span>  NOERROR;    <span class="comment">//  Why bother reporting a failure, here?</span>
00471 
00472         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    ucFiles = stgm.hGlobal ?
00473             DragQueryFile((HDROP) stgm.hGlobal, 0xFFFFFFFFL , 0, 0) : 0;
00474 
00475         <span class="keywordflow">if</span>  (!ucFiles)
00476             <span class="keywordflow">return</span>  NOERROR;    <span class="comment">//  Shouldn't happen, but it's not important</span>
00477         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ucFiles == 1)
00478             <a class="code" href="../../d4/d3/classCICMUserInterface.html#r6">m_bMultiSelection</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00479         <span class="keywordflow">else</span>
00480             <a class="code" href="../../d4/d3/classCICMUserInterface.html#r6">m_bMultiSelection</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00481 
00482         <span class="comment">// Assume in installed context, but we will scan the selected item</span>
00483         <span class="comment">// is really installed everything.</span>
00484 
00485         <a class="code" href="../../d4/d3/classCICMUserInterface.html#r5">m_bInstalledContext</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00486 
00487         TCHAR   acFile[_MAX_PATH];
00488 
00489         <span class="keywordflow">for</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> u = 0; u &lt; ucFiles; u++) {
00490 
00491             DragQueryFile((HDROP) stgm.hGlobal, u, acFile,
00492                 <span class="keyword">sizeof</span> acFile/ <span class="keyword">sizeof</span> acFile[0]);
00493 
00494             <a class="code" href="../../d1/d7/classCString.html">CString</a> csFile = acFile;
00495 
00496             <a class="code" href="../../d4/d3/classCICMUserInterface.html#r5">m_bInstalledContext</a> = (<a class="code" href="../../d4/d3/classCICMUserInterface.html#r5">m_bInstalledContext</a> &amp;&amp; CGlobals::IsInstalled(csFile));
00497         }
00498 
00499         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> idCmd = idCmdFirst;
00500 
00501         <a class="code" href="../../d1/d7/classCString.html">CString</a> csInstallMenu, csAssociateMenu;
00502 
00503         <span class="comment">//  If every profile(s) are already installed on this system,</span>
00504         <span class="comment">//  display "Uninstall Profile", otherwise display "Install Profile"</span>
00505 
00506         csInstallMenu.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<a class="code" href="../../d4/d3/classCICMUserInterface.html#r5">m_bInstalledContext</a> ? <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a4">UninstallProfileMenuString</a> : <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a3">InstallProfileMenuString</a>);
00507         ::InsertMenu(hMenu,indexMenu,MF_STRING|MF_BYPOSITION,idCmd,csInstallMenu);
00508 
00509         <span class="comment">//  Set "Install Profile" or "Uninstall Profile" as default.</span>
00510 
00511         SetMenuDefaultItem(hMenu,indexMenu,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00512 
00513         <span class="comment">//  Increment Menu pos. and item id.</span>
00514 
00515         indexMenu++; idCmd++;
00516 
00517         <span class="comment">//  Add "Associate..." menu item</span>
00518 
00519         csAssociateMenu.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a5">AssociateMenuString</a>);
00520         ::InsertMenu(hMenu,indexMenu++,MF_STRING|MF_BYPOSITION,idCmd++,csAssociateMenu);
00521 
00522         <span class="comment">//  But if we have multi selection, disable "Associate..."</span>
00523 
00524         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/classCICMUserInterface.html#r6">m_bMultiSelection</a>)
00525             ::EnableMenuItem(hMenu,(idCmd-1),MF_GRAYED);
00526         <span class="keywordflow">return</span> (idCmd - idCmdFirst); <span class="comment">// return number of menu inserted.</span>
00527     }
00528 
00529     <span class="keywordflow">return</span> NOERROR;
00530 }
00531 
<a name="l00532"></a><a class="code" href="../../d4/d3/classCICMUserInterface.html#a6">00532</a> STDMETHODIMP    <a class="code" href="../../d4/d3/classCICMUserInterface.html#a6">CICMUserInterface::InvokeCommand</a>(LPCMINVOKECOMMANDINFO lpcmi) {
00533 
00534     <span class="comment">//  If HIWORD(lpcmi-&gt;lpVerb) then we have been called programmatically and</span>
00535     <span class="comment">//  lpVerb us a command that should be invoked. Otherwise, the shell has</span>
00536     <span class="comment">//  called us, abd LOWORD(lpcmi-&gt;lpVerb) is the menu ID the user has selected.</span>
00537     <span class="comment">//  Actually, it's (menu ID - icmdFirst) from QueryContextMenu().</span>
00538 
00539     <span class="keywordflow">if</span> (!HIWORD((ULONG)(ULONG_PTR)lpcmi-&gt;lpVerb))  {
00540 
00541         FORMATETC       fmte = {CF_HDROP, (DVTARGETDEVICE <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00542                             DVASPECT_CONTENT, -1, TYMED_HGLOBAL };
00543         STGMEDIUM       stgm;
00544         HRESULT         hres = <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> ?
00545             <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> -&gt; GetData(&amp;fmte, &amp;stgm) : 0;
00546 
00547         <span class="keywordflow">if</span>  (!SUCCEEDED(hres))
00548             <span class="keywordflow">return</span>  NOERROR;    <span class="comment">//  Why bother reporting a failure, here?</span>
00549 
00550         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    ucFiles = stgm.hGlobal ?
00551             DragQueryFile((HDROP) stgm.hGlobal, 0xFFFFFFFFL , 0, 0) : 0;
00552 
00553         <span class="keywordflow">if</span>  (!ucFiles)
00554             <span class="keywordflow">return</span>  NOERROR;    <span class="comment">//  Shouldn't happen, but it's not important</span>
00555 
00556         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> idCmd = LOWORD(lpcmi-&gt;lpVerb);
00557 
00558         <span class="comment">// Walk through every selected item to install/uninstall.</span>
00559 
00560         <span class="keywordflow">for</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> u = 0; u &lt; ucFiles; u++) {
00561 
00562             TCHAR   acFile[_MAX_PATH];
00563 
00564             DragQueryFile((HDROP) stgm.hGlobal, u, acFile,
00565                 <span class="keyword">sizeof</span> acFile/ <span class="keyword">sizeof</span> acFile[0]);
00566 
00567             <span class="keywordflow">switch</span> (idCmd) {
00568 
00569                 <span class="keywordflow">case</span>    0: {   <span class="comment">// Install/Uninstall was selected.</span>
00570 
00571                     <span class="comment">// during the installation or un-installation,</span>
00572                     <span class="comment">// change the cursor icon to IDC_APPSTARTING.</span>
00573 
00574                     HCURSOR hCursorOld = <a class="code" href="../../d3/d0/user32_8def.html#a65">SetCursor</a>(LoadCursor(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,IDC_APPSTARTING));
00575 
00576                     <a class="code" href="../../d7/d5/classCProfile.html">CProfile</a> csProfile(acFile);
00577 
00578                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/classCICMUserInterface.html#r5">m_bInstalledContext</a>) {
00579 
00580                         <span class="comment">// All selected profile is already installed, then</span>
00581                         <span class="comment">// Uninstall every profile(s) are selected if installed.</span>
00582 
00583                         <span class="keywordflow">if</span> (csProfile.<a class="code" href="../../d7/d5/classCProfile.html#a6">IsInstalled</a>()) {
00584                             csProfile.<a class="code" href="../../d7/d5/classCProfile.html#a15">Uninstall</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>); <span class="comment">// never delete file from disk.</span>
00585                         }
00586                     }
00587                     <span class="keywordflow">else</span> {
00588 
00589                         <span class="comment">// Some of selected profile is not installed, then</span>
00590                         <span class="comment">// Install every profile(s) are selected if not installed, yet.</span>
00591 
00592                         <span class="keywordflow">if</span> (!csProfile.<a class="code" href="../../d7/d5/classCProfile.html#a6">IsInstalled</a>()) {
00593                             csProfile.<a class="code" href="../../d7/d5/classCProfile.html#a14">Install</a>();
00594                         }
00595                     }
00596 
00597                     <a class="code" href="../../d3/d0/user32_8def.html#a65">SetCursor</a>(hCursorOld);
00598 
00599                     <span class="keywordflow">break</span>;
00600                 }
00601 
00602                 <span class="keywordflow">case</span>    1: {   <span class="comment">// "Associate..." was selected.</span>
00603 
00604                     <a class="code" href="../../d1/d7/classCString.html">CString</a> csProfileName;
00605 
00606                     <span class="comment">// Get profile "friendly" name.</span>
00607                     {
00608                         <a class="code" href="../../d7/d5/classCProfile.html">CProfile</a> csProfile(acFile);
00609                         csProfileName = csProfile.<a class="code" href="../../d7/d5/classCProfile.html#a2">GetName</a>();
00610                     } <span class="comment">// de-constructer for csProfile should be here.</span>
00611 
00612                     <span class="comment">// Create PropertySheet with "Profile Information" and</span>
00613                     <span class="comment">// "Associate Device" pages</span>
00614 
00615                     PROPSHEETHEADER psh;
00616                     HPROPSHEETPAGE  hpsp[2];
00617 
00618                     <a class="code" href="../../d0/d6/classCProfileInformationPage.html">CProfileInformationPage</a> *pcpip =                       
00619                         <span class="keyword">new</span> <a class="code" href="../../d0/d6/classCProfileInformationPage.html">CProfileInformationPage</a>(CGlobals::Instance(), acFile);
00620                     <a class="code" href="../../d9/d5/classCProfileAssociationPage.html">CProfileAssociationPage</a> *pcpap =
00621                         <span class="keyword">new</span> <a class="code" href="../../d9/d5/classCProfileAssociationPage.html">CProfileAssociationPage</a>(CGlobals::Instance(), acFile);
00622                     <span class="keywordflow">if</span>( (pcpip!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)&amp;&amp;(pcpap!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {    
00623                         hpsp[0] = pcpip-&gt;<a class="code" href="../../d2/d6/classCPropertyPage.html#a2">Handle</a>();
00624                         hpsp[1] = pcpap-&gt;<a class="code" href="../../d2/d6/classCPropertyPage.html#a2">Handle</a>();
00625     
00626                         ZeroMemory(&amp;psh, <span class="keyword">sizeof</span>(PROPSHEETHEADER));
00627     
00628                         <span class="comment">// fill the property sheet structure.</span>
00629     
00630                         psh.dwSize = <span class="keyword">sizeof</span>(PROPSHEETHEADER);
00631                         psh.hInstance = <a class="code" href="../../d0/d3/classCGlobals.html#e4">CGlobals::Instance</a>();
00632                         psh.hwndParent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00633                         psh.nStartPage = 1; <span class="comment">// Active "Associate Device" page.</span>
00634                         psh.nPages = 2;
00635                         psh.phpage = hpsp;
00636                         psh.pszCaption = csProfileName;
00637     
00638                         PropertySheet(&amp;psh);
00639     
00640                         <span class="keyword">delete</span> pcpip; <span class="keyword">delete</span> pcpap;
00641                         <span class="keywordflow">break</span>;
00642                     } <span class="keywordflow">else</span> {
00643                       <span class="keywordflow">if</span>(pcpip) <span class="keyword">delete</span> pcpip;
00644                       <span class="keywordflow">if</span>(pcpap) <span class="keyword">delete</span> pcpap;
00645                       <span class="keywordflow">return</span> E_OUTOFMEMORY;
00646                     }
00647                 }
00648             } <span class="comment">// switch (idCmd)</span>
00649         } <span class="comment">// for (UINT u = 0; u &lt; ucFiles; u++)</span>
00650     } <span class="comment">// if (!HIWORD(lpcmi-&gt;lpVerb))</span>
00651 
00652     <span class="keywordflow">return</span> NOERROR;
00653 }
00654 
00655 <span class="comment">/* Supprisingly the code casts the unicode string to an</span>
00656 <span class="comment"> * asciiz string and passes it. One assumes that nobody</span>
00657 <span class="comment"> * actually interprets the string pointer as ascii on the</span>
00658 <span class="comment"> * way to its destination where it is reinterpreted</span>
00659 <span class="comment"> * as a pointer to a unicode string.</span>
00660 <span class="comment"> */</span>
<a name="l00661"></a><a class="code" href="../../d4/d3/classCICMUserInterface.html#a7">00661</a> STDMETHODIMP    <a class="code" href="../../d4/d3/classCICMUserInterface.html#a7">CICMUserInterface::GetCommandString</a>(UINT_PTR idCmd, UINT uFlags,
00662                                                     UINT FAR *reserved, LPSTR pszName,
00663                                                     UINT cchMax) {
00664     <a class="code" href="../../d1/d7/classCString.html">CString</a> csReturnString;
00665 
00666     <span class="keywordflow">switch</span> (idCmd) {
00667         <span class="keywordflow">case</span>    0: {   <span class="comment">// Install/Uninstall was selected.</span>
00668           <span class="keywordflow">if</span>(<a class="code" href="../../d4/d3/classCICMUserInterface.html#r6">m_bMultiSelection</a>) {
00669             csReturnString.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<a class="code" href="../../d4/d3/classCICMUserInterface.html#r5">m_bInstalledContext</a> ? <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a39">UninstallMultiProfileContextMenuString</a> : <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a41">InstallMultiProfileContextMenuString</a>);
00670           } <span class="keywordflow">else</span> {
00671             csReturnString.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<a class="code" href="../../d4/d3/classCICMUserInterface.html#r5">m_bInstalledContext</a> ? <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a38">UninstallProfileContextMenuString</a> : <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a40">InstallProfileContextMenuString</a>);
00672           }
00673           lstrcpyn((LPTSTR)pszName, csReturnString, cchMax);
00674           <span class="keywordflow">break</span>;
00675         }
00676 
00677         <span class="keywordflow">case</span>    1: {   <span class="comment">// Associate... was seleted.</span>
00678           <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d3/classCICMUserInterface.html#r6">m_bMultiSelection</a>) {
00679             csReturnString.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a42">AssociateContextMenuString</a>);
00680             lstrcpyn((LPTSTR)pszName, csReturnString, cchMax);
00681           }
00682           <span class="keywordflow">break</span>;
00683         }
00684     }
00685 
00686     <span class="keywordflow">return</span> NOERROR;
00687 }
00688 
00689 <span class="comment">//  IPropSheetExt functions- again, we only need to implement one of these</span>
00690 <span class="comment">//  Since we now support two different interfaces, the actual implementation</span>
00691 <span class="comment">//  is done in a private method germane to the desired interface.</span>
00692 
<a name="l00693"></a><a class="code" href="../../d4/d3/classCICMUserInterface.html#a17">00693</a> STDMETHODIMP    <a class="code" href="../../d4/d3/classCICMUserInterface.html#a17">CICMUserInterface::AddPages</a>(LPFNADDPROPSHEETPAGE lpfnAddPage,
00694                                             LPARAM lParam) {
00695     _RPTF0(_CRT_WARN, <span class="stringliteral">"CICMUserInterface::AddPages\n"</span>);
00696 
00697     HRESULT hResult = NOERROR;
00698     
00699     <span class="keywordflow">switch</span>  (<a class="code" href="../../d4/d3/classCICMUserInterface.html#r4">m_utThis</a>) {
00700         <span class="keywordflow">case</span>    <a class="code" href="../../d9/d8/shellext_8h.html#a8a0">IsProfile</a>: {
00701             hResult = <a class="code" href="../../d4/d3/classCICMUserInterface.html#d2">AddProfileTab</a>(lpfnAddPage, lParam);
00702             <span class="keywordflow">if</span> (hResult == NOERROR) {
00703                 hResult = <a class="code" href="../../d4/d3/classCICMUserInterface.html#d1">AddAssociateTab</a>(lpfnAddPage, lParam);
00704             }
00705             <span class="keywordflow">break</span>;
00706         }
00707 
00708         <span class="keywordflow">case</span>    <a class="code" href="../../d9/d8/shellext_8h.html#a8a3">IsMonitor</a>: {
00709             hResult = <a class="code" href="../../d4/d3/classCICMUserInterface.html#d4">AddMonitorTab</a>(lpfnAddPage, lParam);
00710             <span class="keywordflow">break</span>;
00711         }
00712 
00713         <span class="keywordflow">case</span>    <a class="code" href="../../d9/d8/shellext_8h.html#a8a1">IsPrinter</a>: {
00714             hResult = <a class="code" href="../../d4/d3/classCICMUserInterface.html#d0">AddPrinterTab</a>(lpfnAddPage, lParam);
00715             <span class="keywordflow">break</span>;
00716         }
00717 
00718         <span class="keywordflow">case</span>    <a class="code" href="../../d9/d8/shellext_8h.html#a8a2">IsScanner</a>: {
00719             hResult = <a class="code" href="../../d4/d3/classCICMUserInterface.html#d3">AddScannerTab</a>(lpfnAddPage, lParam);
00720             <span class="keywordflow">break</span>;
00721         }
00722     }
00723 
00724     <span class="keywordflow">return</span>  hResult;
00725 }
00726 
00727 <span class="comment">//  This member function handles the ICC profile information sheet.</span>
00728 <span class="comment">//  In this case, the data object given via IShellExtInit::Initialize is</span>
00729 <span class="comment">//  an HDROP (list of fully qualified file names).</span>
00730 
<a name="l00731"></a><a class="code" href="../../d4/d3/classCICMUserInterface.html#d2">00731</a> HRESULT <a class="code" href="../../d4/d3/classCICMUserInterface.html#d2">CICMUserInterface::AddProfileTab</a>(LPFNADDPROPSHEETPAGE lpfnAddPage,
00732                                         LPARAM lParam) {
00733     _RPTF0(_CRT_WARN, <span class="stringliteral">"CICMUserInterface::AddProfileTab\n"</span>);
00734 
00735     <span class="comment">//  Load the profile(s) in the list.</span>
00736 
00737     FORMATETC       fmte = {CF_HDROP, (DVTARGETDEVICE <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00738                             DVASPECT_CONTENT, -1, TYMED_HGLOBAL };
00739     STGMEDIUM       stgm;
00740     HRESULT         hres = <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> ?
00741         <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> -&gt; GetData(&amp;fmte, &amp;stgm) : 0;
00742 
00743 
00744     <span class="keywordflow">if</span>  (!SUCCEEDED(hres))
00745         <span class="keywordflow">return</span>  NOERROR;    <span class="comment">//  Why bother reporting a failure, here?</span>
00746 
00747     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    ucFiles = stgm.hGlobal ?
00748         DragQueryFile((HDROP) stgm.hGlobal, 0xFFFFFFFFL , 0, 0) : 0;
00749 
00750     <span class="keywordflow">if</span>  (ucFiles != 1)
00751         <span class="keywordflow">return</span>  NOERROR;
00752 
00753     TCHAR   acFile[_MAX_PATH];
00754 
00755     DragQueryFile((HDROP) stgm.hGlobal, 0, acFile,
00756         <span class="keyword">sizeof</span> acFile/ <span class="keyword">sizeof</span> acFile[0]);
00757 
00758     <span class="comment">//  Create the property sheet- it will get deleted if it is not in</span>
00759     <span class="comment">//  use when the shell tries to unload the extension</span>
00760 
00761     <a class="code" href="../../d0/d6/classCProfileInformationPage.html">CProfileInformationPage</a> *pcpip =
00762         <span class="keyword">new</span> <a class="code" href="../../d0/d6/classCProfileInformationPage.html">CProfileInformationPage</a>(CGlobals::Instance(), acFile);
00763 
00764     <span class="keywordflow">if</span>  (!(*lpfnAddPage)(pcpip -&gt; <a class="code" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>(), lParam))
00765         DestroyPropertySheetPage(pcpip -&gt; <a class="code" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>());
00766 
00767     <span class="keywordflow">return</span>  NOERROR;
00768 }
00769 
00770 <span class="comment">//  This member function handles the associate device tab</span>
00771 
<a name="l00772"></a><a class="code" href="../../d4/d3/classCICMUserInterface.html#d1">00772</a> HRESULT <a class="code" href="../../d4/d3/classCICMUserInterface.html#d1">CICMUserInterface::AddAssociateTab</a>(LPFNADDPROPSHEETPAGE lpfnAddPage,
00773                                            LPARAM lParam) {
00774 
00775     _RPTF0(_CRT_WARN, <span class="stringliteral">"CICMUserInterface::AddAssociateTab\n"</span>);
00776 
00777     <span class="comment">//  Load the profile(s) in the list.</span>
00778 
00779     FORMATETC       fmte = {CF_HDROP, (DVTARGETDEVICE <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00780                             DVASPECT_CONTENT, -1, TYMED_HGLOBAL };
00781     STGMEDIUM       stgm;
00782     HRESULT         hres = <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> ?
00783         <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> -&gt; GetData(&amp;fmte, &amp;stgm) : 0;
00784 
00785     <span class="keywordflow">if</span>  (!SUCCEEDED(hres))
00786         <span class="keywordflow">return</span>  NOERROR;    <span class="comment">//  Why bother reporting a failure, here?</span>
00787 
00788     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    ucFiles = stgm.hGlobal ?
00789         DragQueryFile((HDROP) stgm.hGlobal, 0xFFFFFFFFL , 0, 0) : 0;
00790 
00791     <span class="keywordflow">if</span>  (ucFiles != 1)
00792         <span class="keywordflow">return</span>  NOERROR;
00793 
00794     TCHAR   acFile[_MAX_PATH];
00795 
00796     DragQueryFile((HDROP) stgm.hGlobal, 0, acFile,
00797         <span class="keyword">sizeof</span> acFile/ <span class="keyword">sizeof</span> acFile[0]);
00798 
00799     <span class="comment">//  Create the property sheet- it will get deleted if it is not in</span>
00800     <span class="comment">//  use when the shell tries to unload the extension</span>
00801 
00802     <a class="code" href="../../d9/d5/classCProfileAssociationPage.html">CProfileAssociationPage</a> *pcpap =
00803         <span class="keyword">new</span> <a class="code" href="../../d9/d5/classCProfileAssociationPage.html">CProfileAssociationPage</a>(CGlobals::Instance(), acFile);
00804 
00805     <span class="keywordflow">if</span>  (!(*lpfnAddPage)(pcpap -&gt; <a class="code" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>(), lParam))
00806         DestroyPropertySheetPage(pcpap -&gt; <a class="code" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>());
00807 
00808     <span class="keywordflow">return</span>  NOERROR;
00809 }
00810 
00811 <span class="comment">//  This member function handles the monitor color management tab</span>
00812 <span class="comment">//  In this case, no data object is given.</span>
00813 
00814 <span class="comment">//  Private monitor enumeration function</span>
00815 
<a name="l00816"></a><a class="code" href="../../d4/d3/classCICMUserInterface.html#d4">00816</a> HRESULT <a class="code" href="../../d4/d3/classCICMUserInterface.html#d4">CICMUserInterface::AddMonitorTab</a>(LPFNADDPROPSHEETPAGE lpfnAddPage,
00817                                          LPARAM lParam) {
00818 
00819     <span class="comment">//  Create the property sheet- it will get deleted if it is not in</span>
00820     <span class="comment">//  use when the shell tries to unload the extension</span>
00821 
00822     <a class="code" href="../../d1/d7/classCString.html">CString</a> csMonitorDevice;
00823     <a class="code" href="../../d1/d7/classCString.html">CString</a> csMonitorFriendlyName;
00824 
00825     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a>) {
00826 
00827         FORMATETC fmte = { (CLIPFORMAT)RegisterClipboardFormat(_TEXT(<span class="stringliteral">"Display Device"</span>)),
00828                            (DVTARGETDEVICE <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00829                            DVASPECT_CONTENT, -1, TYMED_HGLOBAL };
00830         STGMEDIUM stgm;
00831 
00832         <span class="comment">// Get device name from IDataObject.</span>
00833 
00834         HRESULT   hres = <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> -&gt; GetData(&amp;fmte, &amp;stgm);
00835 
00836         <span class="keywordflow">if</span>  (!SUCCEEDED(hres) || !stgm.hGlobal) {
00837             <span class="keywordflow">return</span>  NOERROR;    <span class="comment">//  Why bother reporting a failure, here?</span>
00838         }
00839 
00840         <span class="comment">// The storage contains Display device path (\\.\DisplayX) in UNICODE.</span>
00841 
00842         LPCWSTR lpDeviceName = (LPCWSTR) GlobalLock(stgm.hGlobal);
00843         <a class="code" href="../../d1/d7/classCString.html">CString</a> csMonitorDevicePath = lpDeviceName;
00844         GlobalUnlock(stgm.hGlobal);
00845 
00846         <span class="comment">// Query the device id, friendly name and other on the display device.</span>
00847 
00848         DISPLAY_DEVICE ddPriv;
00849 
00850         ddPriv.cb = <span class="keyword">sizeof</span>(ddPriv);
00851 
00852         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d8/ntcftxt_8h.html#a33">EnumDisplayDevices</a>((LPCTSTR)csMonitorDevicePath, 0, &amp;ddPriv, 0))
00853         {
00854             <span class="keywordflow">return</span>  NOERROR;    <span class="comment">//  Why bother reporting a failure, here?</span>
00855         }
00856 
00857 <span class="preprocessor">        #if HIDEYUKN_DBG</span>
00858 <span class="preprocessor"></span>            MessageBox(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,csMonitorDevicePath,TEXT(<span class="stringliteral">""</span>),MB_OK);
00859             MessageBox(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,(LPCTSTR)ddPriv.DeviceID,TEXT(<span class="stringliteral">""</span>),MB_OK);
00860             MessageBox(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,(LPCTSTR)ddPriv.DeviceString,TEXT(<span class="stringliteral">""</span>),MB_OK);
00861 <span class="preprocessor">        #endif</span>
00862 <span class="preprocessor"></span>
00863         <span class="comment">// Use deviceId (PnP Id) as device name, and set friendly name</span>
00864 
00865         csMonitorDevice       = (LPTSTR)(ddPriv.DeviceID);
00866         csMonitorFriendlyName = (LPTSTR)(ddPriv.DeviceString);
00867     }
00868     <span class="keywordflow">else</span>
00869     {
00870         <span class="comment">// if we don't have IDataObject, enumerate monitor,</span>
00871         <span class="comment">// then use 1st entry.</span>
00872 
00873         <a class="code" href="../../d2/d4/classCMonitorList.html">CMonitorList</a>    cml;
00874         cml.<a class="code" href="../../d2/d4/classCMonitorList.html#a6">Enumerate</a>();
00875         _ASSERTE(cml.<a class="code" href="../../d2/d4/classCMonitorList.html#a2">Count</a>());  <span class="comment">// At least, we should have one Monitor.</span>
00876         csMonitorDevice = csMonitorFriendlyName = cml.<a class="code" href="../../d2/d4/classCMonitorList.html#a3">DeviceName</a>(0);
00877     }
00878 
00879     <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html">CMonitorProfileManagement</a> *pcmpm =
00880         <span class="keyword">new</span> <a class="code" href="../../d3/d4/classCMonitorProfileManagement.html">CMonitorProfileManagement</a>(csMonitorDevice,
00881                                       csMonitorFriendlyName,
00882                                       CGlobals::Instance());
00883 
00884 
00885     <span class="keywordflow">if</span>  (!(*lpfnAddPage)(pcmpm -&gt; <a class="code" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>(), lParam))
00886         DestroyPropertySheetPage(pcmpm -&gt; <a class="code" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>());
00887 
00888     <span class="keywordflow">return</span>  NOERROR;
00889 }
00890 
00891 <span class="comment">//  Private scanner enumeration function</span>
00892 
<a name="l00893"></a><a class="code" href="../../d4/d3/classCICMUserInterface.html#d3">00893</a> HRESULT <a class="code" href="../../d4/d3/classCICMUserInterface.html#d3">CICMUserInterface::AddScannerTab</a>(LPFNADDPROPSHEETPAGE lpfnAddPage,
00894                                          LPARAM lParam) {
00895 
00896     <span class="comment">//  Create the property sheet- it will get deleted if it is not in</span>
00897     <span class="comment">//  use when the shell tries to unload the extension</span>
00898 
00899     <a class="code" href="../../d1/d7/classCString.html">CString</a> csScannerDevice;
00900 
00901     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a>) {
00902         FORMATETC fmte = { (CLIPFORMAT)RegisterClipboardFormat(_TEXT(<span class="stringliteral">"STIDeviceName"</span>)),
00903                            (DVTARGETDEVICE <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00904                            DVASPECT_CONTENT, -1, TYMED_HGLOBAL };
00905         STGMEDIUM stgm;
00906 
00907         <span class="comment">// Get device name from IDataObject.</span>
00908 
00909         HRESULT   hres = <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> -&gt; GetData(&amp;fmte, &amp;stgm);
00910 
00911         <span class="keywordflow">if</span>  (!SUCCEEDED(hres) || !stgm.hGlobal) {
00912             <span class="keywordflow">return</span>  NOERROR;    <span class="comment">//  Why bother reporting a failure, here?</span>
00913         }
00914 
00915         <span class="comment">// The storage contains Scanner in UNICODE string.</span>
00916 
00917         LPCWSTR lpDeviceName = (LPCWSTR) GlobalLock(stgm.hGlobal);
00918         csScannerDevice = lpDeviceName;
00919         GlobalUnlock(stgm.hGlobal);
00920 
00921 <span class="preprocessor">        #if HIDEYUKN_DBG</span>
00922 <span class="preprocessor"></span>            MessageBox(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,csScannerDevice,TEXT(<span class="stringliteral">""</span>),MB_OK);
00923 <span class="preprocessor">        #endif</span>
00924 <span class="preprocessor"></span>
00925     } <span class="keywordflow">else</span> {
00926 
00927         <span class="comment">// if we don't have IDataObject, enumerate monitor,</span>
00928         <span class="comment">// then use 1st entry.</span>
00929 
00930         <a class="code" href="../../d7/d6/classCScannerList.html">CScannerList</a> csl;
00931         csl.<a class="code" href="../../d7/d6/classCScannerList.html#a5">Enumerate</a>();
00932         _ASSERTE(csl.<a class="code" href="../../d7/d6/classCScannerList.html#a2">Count</a>());
00933         csScannerDevice = csl.<a class="code" href="../../d7/d6/classCScannerList.html#a3">DeviceName</a>(0);
00934     }
00935 
00936     <a class="code" href="../../d8/d6/classCScannerProfileManagement.html">CScannerProfileManagement</a> *pcspm =
00937         <span class="keyword">new</span> <a class="code" href="../../d8/d6/classCScannerProfileManagement.html">CScannerProfileManagement</a>(csScannerDevice, CGlobals::Instance());
00938 
00939     <span class="keywordflow">if</span>  (!(*lpfnAddPage)(pcspm -&gt; <a class="code" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>(), lParam))
00940         DestroyPropertySheetPage(pcspm -&gt; <a class="code" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>());
00941 
00942     <span class="keywordflow">return</span>  NOERROR;
00943 }
00944 
00945 <span class="comment">//  The following is a helper function- it takes a Shell ID List array,</span>
00946 <span class="comment">//  representing a printer in a printers folder, and a CString.  It</span>
00947 <span class="comment">//  initializes the CString with the correct name of the printer.</span>
00948 
<a name="l00949"></a><a class="code" href="../../d8/d8/shellext_8cpp.html#a3">00949</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8/shellext_8cpp.html#a3">RetrievePrinterName</a>(LPIDA lpida, <a class="code" href="../../d1/d7/classCString.html">CString</a>&amp; csTarget) {
00950 
00951     <span class="comment">//  Extract the container (Printers Folder) and target (Printer)</span>
00952     <span class="comment">//  IDs from the array.</span>
00953 
00954     LPCITEMIDLIST pciilContainer =
00955         (LPCITEMIDLIST)((LPBYTE) lpida + lpida -&gt; aoffset[0]);
00956 
00957     LPCITEMIDLIST pciilTarget =
00958         (LPCITEMIDLIST)((LPBYTE) lpida + lpida -&gt; aoffset[1]);
00959 
00960     <span class="keywordflow">if</span>  (!pciilContainer || !pciilTarget)
00961         <span class="keywordflow">return</span>;
00962 
00963     <span class="comment">//  Get a pointer to the printers folder.</span>
00964 
00965     LPSHELLFOLDER   psfDesktop, psfPrinterFolder;
00966 
00967     <span class="keywordflow">if</span>  (FAILED(SHGetDesktopFolder(&amp;psfDesktop)))
00968         <span class="keywordflow">return</span>;
00969 
00970     <span class="keywordflow">if</span>  (FAILED(psfDesktop -&gt; BindToObject(pciilContainer, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00971             IID_IShellFolder, (<span class="keywordtype">void</span> **) &amp;psfPrinterFolder))) {
00972         psfDesktop -&gt; Release();
00973         <span class="keywordflow">return</span>;
00974     }
00975 
00976     <span class="comment">//  Retrieve the printer's display name</span>
00977 
00978     STRRET  strret;
00979 
00980     <span class="keywordflow">if</span>  (FAILED(psfPrinterFolder -&gt;
00981             GetDisplayNameOf(pciilTarget, SHGDN_FORPARSING, &amp;strret))) {
00982         psfPrinterFolder -&gt; Release();
00983         psfDesktop -&gt; Release();
00984         <span class="keywordflow">return</span>;
00985     }
00986 
00987     <span class="comment">//  Copy the display name- the CString class now handles any encoding</span>
00988     <span class="comment">//  issues</span>
00989 
00990     <span class="keywordflow">switch</span>  (strret.uType) {
00991 
00992         <span class="keywordflow">case</span>    STRRET_WSTR:
00993 
00994             <span class="comment">//  This is a Unicode string which was IMalloc'd</span>
00995 
00996             csTarget = strret.pOleStr;
00997 
00998             IMalloc *pim;
00999 
01000             <span class="keywordflow">if</span>  (SUCCEEDED(CoGetMalloc(1, &amp;pim))) {
01001                 pim -&gt; Free(strret.pOleStr);
01002                 pim -&gt; Release();
01003             }
01004 
01005             <span class="keywordflow">break</span>;
01006 
01007         <span class="keywordflow">case</span>    STRRET_CSTR:
01008 
01009             <span class="comment">//  This is an ANSI string in the buffer</span>
01010 
01011             csTarget = strret.cStr;
01012             <span class="keywordflow">break</span>;
01013 
01014         <span class="keywordflow">case</span>    STRRET_OFFSET:
01015 
01016             <span class="comment">//  This is an ANSI string at the given offset into the SHITEMID</span>
01017             <span class="comment">//  which pciilTarget points to.</span>
01018 
01019             csTarget = (LPCSTR) pciilTarget + strret.uOffset;
01020 
01021     }
01022     psfPrinterFolder -&gt; Release();
01023     psfDesktop -&gt; Release();
01024 }
01025 
01026 <span class="comment">//  Private member function for handling the printer profile manamgment tab.</span>
01027 
<a name="l01028"></a><a class="code" href="../../d4/d3/classCICMUserInterface.html#d0">01028</a> HRESULT <a class="code" href="../../d4/d3/classCICMUserInterface.html#d0">CICMUserInterface::AddPrinterTab</a>(LPFNADDPROPSHEETPAGE lpfnAddPage,
01029                                          LPARAM lParam) {
01030 
01031     <span class="comment">//  The list is formatted as a Shell IDList Array</span>
01032 
01033     FORMATETC       fmte = { (CLIPFORMAT)RegisterClipboardFormat(_TEXT(<span class="stringliteral">"Shell IDList Array"</span>)),
01034                              (DVTARGETDEVICE <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01035                              DVASPECT_CONTENT, -1, TYMED_HGLOBAL };
01036     STGMEDIUM       stgm;
01037     HRESULT         hres = <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> ?
01038         <a class="code" href="../../d4/d3/classCICMUserInterface.html#r1">m_lpdoTarget</a> -&gt; GetData(&amp;fmte, &amp;stgm) : 0;
01039 
01040     <span class="keywordflow">if</span>  (!SUCCEEDED(hres) || !stgm.hGlobal)
01041         <span class="keywordflow">return</span>  NOERROR;    <span class="comment">//  Why bother reporting a failure, here?</span>
01042 
01043     <a class="code" href="../../d1/d7/classCString.html">CString</a> csPrinter;
01044 
01045     <a class="code" href="../../d8/d8/shellext_8cpp.html#a3">RetrievePrinterName</a>((LPIDA) stgm.hGlobal, csPrinter);
01046 
01047 <span class="preprocessor">    #if HIDEYUKN_DBG</span>
01048 <span class="preprocessor"></span>        MessageBox(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,csPrinter,TEXT(<span class="stringliteral">""</span>),MB_OK);
01049 <span class="preprocessor">    #endif</span>
01050 <span class="preprocessor"></span>
01051     <span class="comment">//  If this is not a color printer, forget it...</span>
01052 
01053 
01054     <span class="keywordflow">if</span>  (!CGlobals::ThisIsAColorPrinter(csPrinter))
01055         <span class="keywordflow">return</span>  NOERROR;
01056 
01057     <span class="comment">//  Create the property sheet- it will get deleted if it is not in use when</span>
01058     <span class="comment">//  the shell tries to unload the extension</span>
01059 
01060 
01061     <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html">CPrinterProfileManagement</a> *pcppm =
01062             <span class="keyword">new</span> <a class="code" href="../../d6/d5/classCPrinterProfileManagement.html">CPrinterProfileManagement</a>(csPrinter, CGlobals::Instance());
01063 
01064     <span class="keywordflow">if</span>  (!pcppm)
01065         <span class="keywordflow">return</span>  E_OUTOFMEMORY;
01066 
01067     <span class="keywordflow">if</span>  (!(*lpfnAddPage)(pcppm -&gt; <a class="code" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>(), lParam))
01068         DestroyPropertySheetPage(pcppm -&gt; <a class="code" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>());
01069 
01070     <span class="keywordflow">return</span>  NOERROR;
01071 }
01072 
01073 PSTR
<a name="l01074"></a><a class="code" href="../../d8/d8/shellext_8cpp.html#a4">01074</a> <a class="code" href="../../d9/d7/profman_8c.html#a96">GetFilenameFromPath</a>(
01075     PSTR pPathName
01076     )
01077 {
01078     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLen;                    <span class="comment">// length of pathname</span>
01079 
01080     dwLen = lstrlenA(pPathName);
01081 
01082     <span class="comment">//</span>
01083     <span class="comment">// Go to the end of the pathname, and start going backwards till</span>
01084     <span class="comment">// you reach the beginning or a backslash</span>
01085     <span class="comment">//</span>
01086 
01087     pPathName += dwLen;
01088 
01089     <span class="keywordflow">while</span> (dwLen-- &amp;&amp; --pPathName)
01090     {
01091         <span class="keywordflow">if</span> (*pPathName == <span class="charliteral">'\\'</span>)
01092         {
01093             pPathName++;
01094             <span class="keywordflow">break</span>;
01095         }
01096     }
01097 
01098     <span class="comment">//</span>
01099     <span class="comment">// if *pPathName is zero, then we had a string that ends in a backslash</span>
01100     <span class="comment">//</span>
01101 
01102     <span class="keywordflow">return</span> *pPathName ? pPathName : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01103 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:49 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
