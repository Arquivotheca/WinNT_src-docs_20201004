<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kdtrap.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdtrap.c</h1><a href="../../d8/d8/i386_2kdtrap_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    kdtrap.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains code to implement the target side of the portable</span>
00012 <span class="comment">    kernel debugger.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Bryan M. Willman (bryanwi) 25-Sep-90</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d1/d7/4_2kdp_8h.html">kdp.h</a>"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">// externs</span>
00026 <span class="comment">//</span>
00027 <span class="keyword">extern</span> PUCHAR  <a class="code" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a0">KdpCopyDataToStack</a>(PUCHAR, ULONG);
00028 
00029 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpTrap)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdIsThisAKdTrap)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span>
00034 
00035 
00036 
00037 BOOLEAN
<a name="l00038"></a><a class="code" href="../../d8/d8/i386_2kdtrap_8c.html#a1">00038</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a118">KdpTrap</a> (
00039     IN PKTRAP_FRAME TrapFrame,
00040     IN PKEXCEPTION_FRAME ExceptionFrame,
00041     IN PEXCEPTION_RECORD ExceptionRecord,
00042     IN PCONTEXT ContextRecord,
00043     IN KPROCESSOR_MODE PreviousMode,
00044     IN BOOLEAN SecondChance
00045     )
00046 
00047 <span class="comment">/*++</span>
00048 <span class="comment"></span>
00049 <span class="comment">Routine Description:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    This routine is called whenever a exception is dispatched and the kernel</span>
00052 <span class="comment">    debugger is active.</span>
00053 <span class="comment"></span>
00054 <span class="comment">Arguments:</span>
00055 <span class="comment"></span>
00056 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame that describes the</span>
00057 <span class="comment">        trap.</span>
00058 <span class="comment"></span>
00059 <span class="comment">    ExceptionFrame - Supplies a pointer to a exception frame that describes</span>
00060 <span class="comment">        the trap.</span>
00061 <span class="comment"></span>
00062 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record that</span>
00063 <span class="comment">        describes the exception.</span>
00064 <span class="comment"></span>
00065 <span class="comment">    ContextRecord - Supplies the context at the time of the exception.</span>
00066 <span class="comment"></span>
00067 <span class="comment">    PreviousMode - Supplies the previous processor mode.</span>
00068 <span class="comment"></span>
00069 <span class="comment">    SecondChance - Supplies a boolean value that determines whether this is</span>
00070 <span class="comment">        the second chance (TRUE) that the exception has been raised.</span>
00071 <span class="comment"></span>
00072 <span class="comment">Return Value:</span>
00073 <span class="comment"></span>
00074 <span class="comment">    A value of TRUE is returned if the exception is handled. Otherwise a</span>
00075 <span class="comment">    value of FALSE is returned.</span>
00076 <span class="comment"></span>
00077 <span class="comment">--*/</span>
00078 
00079 {
00080 
00081     BOOLEAN Completion = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00082     BOOLEAN Enable;
00083     BOOLEAN UnloadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00084     ULONG   RetValue;
00085     STRING  <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>, ReplyString;
00086     PUCHAR  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00087     <a class="code" href="../../d6/d5/struct__KD__SYMBOLS__INFO.html">PKD_SYMBOLS_INFO</a> SymbolInfo;
00088     PVOID   SavedEsp;
00089     PKPRCB  Prcb;
00090     ULONG   OldEip;
00091 
00092     _asm {
00093         <span class="comment">//</span>
00094         <span class="comment">// Save esp on ebp frame so c-runtime registers are restored correctly</span>
00095         <span class="comment">//</span>
00096 
00097         mov     SavedEsp, esp
00098     }
00099 
00100     <span class="comment">//</span>
00101     <span class="comment">// Print, Prompt, Load symbols, Unload symbols, are all special</span>
00102     <span class="comment">// cases of STATUS_BREAKPOINT</span>
00103     <span class="comment">//</span>
00104 
00105     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00106         (ExceptionRecord-&gt;ExceptionInformation[0] != <a class="code" href="../../d8/d3/ia32def_8h.html#a17">BREAKPOINT_BREAK</a>)) {
00107 
00108         <span class="comment">//</span>
00109         <span class="comment">// We have one of the support functions.</span>
00110         <span class="comment">//</span>
00111 
00112         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a>  &amp;&amp;
00113             ExceptionRecord-&gt;ExceptionInformation[0] != BREAKPOINT_PROMPT) {
00114             ContextRecord-&gt;Eip++;
00115             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00116         }
00117 
00118 
00119         <span class="comment">//</span>
00120         <span class="comment">// Since some of these functions can be entered from user mode,</span>
00121         <span class="comment">// we hold off entering the debugger until the user mode buffers</span>
00122         <span class="comment">// are copied.  (Because they may not be present in memory, and</span>
00123         <span class="comment">// they must be paged in before we raise Irql to the</span>
00124         <span class="comment">// Highest level.)</span>
00125         <span class="comment">//</span>
00126         <span class="comment">//</span>
00127 
00128         OldEip = ContextRecord-&gt;Eip;
00129 
00130         <span class="keywordflow">switch</span> (ExceptionRecord-&gt;ExceptionInformation[0]) {
00131 
00132             <span class="comment">//</span>
00133             <span class="comment">//  ExceptionInformation[1] is PSTRING to print</span>
00134             <span class="comment">//</span>
00135 
00136             <span class="keywordflow">case</span> BREAKPOINT_PRINT:
00137 
00138                 <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00139 
00140                     EXCEPTION_RECORD exr;
00141                     <span class="comment">//</span>
00142                     <span class="comment">// Move user mode parameters to kernel stack</span>
00143                     <span class="comment">//</span>
00144 
00145                     <span class="keywordflow">try</span> {
00146                         <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = *((PSTRING)ExceptionRecord-&gt;ExceptionInformation[1]);
00147                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length &gt; 512) {
00148                             <span class="keywordflow">break</span>;
00149                         }
00150                         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length, <span class="keyword">sizeof</span>(UCHAR));
00151                         <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer =
00152                             <a class="code" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a0">KdpCopyDataToStack</a>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length);
00153 
00154                     } except ((exr = *((GetExceptionInformation())-&gt;ExceptionRecord), <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>)) {
00155 
00156                         <span class="comment">//</span>
00157                         <span class="comment">// If an exception occurs then don't handle</span>
00158                         <span class="comment">// this DebugService request.</span>
00159                         <span class="comment">//</span>
00160 
00161                         <span class="keywordflow">break</span>;
00162                     }
00163 
00164                 } <span class="keywordflow">else</span> {
00165                     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = *((PSTRING)ExceptionRecord-&gt;ExceptionInformation[1]);
00166                 }
00167 
00168                 <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a7">KdLogDbgPrint</a>(&amp;<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>);
00169 
00170                 <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_DISABLE_DBGPRINT) == 0) {
00171                     Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00172                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a102">KdpPrintString</a>(&amp;<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>)) {
00173                         ContextRecord-&gt;Eax = (ULONG)(STATUS_BREAKPOINT);
00174                     } <span class="keywordflow">else</span> {
00175                         ContextRecord-&gt;Eax = STATUS_SUCCESS;
00176                     }
00177                     <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00178                 }
00179 
00180                 Completion = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00181                 <span class="keywordflow">break</span>;
00182 
00183             <span class="comment">//</span>
00184             <span class="comment">//  ExceptionInformation[1] is prompt string,</span>
00185             <span class="comment">//  ExceptionInformation[2] is return string</span>
00186             <span class="comment">//</span>
00187 
00188             <span class="keywordflow">case</span> BREAKPOINT_PROMPT:
00189                 <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00190 
00191                     <span class="comment">//</span>
00192                     <span class="comment">// Move user mode parameters to kernel stack</span>
00193                     <span class="comment">//</span>
00194 
00195 
00196                     <span class="keywordflow">try</span> {
00197                         <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = *((PSTRING)ExceptionRecord-&gt;ExceptionInformation[1]);
00198                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length &gt; 512) {
00199                             <span class="keywordflow">break</span>;
00200                         }
00201                         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
00202                         <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer =
00203                             <a class="code" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a0">KdpCopyDataToStack</a>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length);
00204 
00205                         ReplyString = *((PSTRING)ExceptionRecord-&gt;ExceptionInformation[2]);
00206                         <span class="keywordflow">if</span> (ReplyString.MaximumLength &gt; 512) {
00207                             <span class="keywordflow">break</span>;
00208                         }
00209                         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(ReplyString.Buffer,
00210                                       ReplyString.MaximumLength,
00211                                       <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
00212                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = ReplyString.Buffer;
00213                         ReplyString.Buffer =
00214                             <a class="code" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a0">KdpCopyDataToStack</a>(
00215                                 ReplyString.Buffer,
00216                                 ReplyString.MaximumLength
00217                             );
00218 
00219                     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00220 
00221                         <span class="comment">//</span>
00222                         <span class="comment">// If an exception occurs then don't handle</span>
00223                         <span class="comment">// this DebugService request.</span>
00224                         <span class="comment">//</span>
00225 
00226                         <span class="keywordflow">break</span>;
00227                     }
00228                 } <span class="keywordflow">else</span> {
00229                     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = *((PSTRING)ExceptionRecord-&gt;ExceptionInformation[1]);
00230                     ReplyString = *((PSTRING)ExceptionRecord-&gt;ExceptionInformation[2]);
00231                 }
00232 
00233                 <span class="comment">//</span>
00234                 <span class="comment">// Prompt, keep prompting until no breakin seen.</span>
00235                 <span class="comment">//</span>
00236 
00237                 <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a7">KdLogDbgPrint</a>(&amp;<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>);
00238 
00239                 Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00240                 <span class="keywordflow">do</span> {
00241                     RetValue = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a103">KdpPromptString</a>(&amp;<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>, &amp;ReplyString);
00242                 } <span class="keywordflow">while</span> (RetValue == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00243 
00244                 ContextRecord-&gt;Eax = ReplyString.Length;
00245                 <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00246 
00247                 <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00248 
00249                     <span class="comment">//</span>
00250                     <span class="comment">// Restore user mode return parameters</span>
00251                     <span class="comment">//</span>
00252 
00253                     <span class="keywordflow">try</span> {
00254                         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a111">KdpQuickMoveMemory</a>(
00255                             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00256                             ReplyString.Buffer,
00257                             ReplyString.Length
00258                         );
00259                     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00260 
00261                         <span class="comment">//</span>
00262                         <span class="comment">// If an exception occurs then don't handle</span>
00263                         <span class="comment">// this DebugService request.</span>
00264                         <span class="comment">//</span>
00265 
00266                         <span class="keywordflow">break</span>;
00267                     }
00268                 }
00269 
00270                 Completion = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00271                 <span class="keywordflow">break</span>;
00272 
00273             <span class="comment">//</span>
00274             <span class="comment">//  ExceptionInformation[1] is file name of new module</span>
00275             <span class="comment">//  ExceptionInformaiton[2] is the base of the dll</span>
00276             <span class="comment">//</span>
00277 
00278             <span class="keywordflow">case</span> BREAKPOINT_UNLOAD_SYMBOLS:
00279                 UnloadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00280 
00281                 <span class="comment">//</span>
00282                 <span class="comment">// Fall through</span>
00283                 <span class="comment">//</span>
00284 
00285             <span class="keywordflow">case</span> BREAKPOINT_LOAD_SYMBOLS:
00286 
00287                 <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00288                     <span class="keywordflow">break</span>;
00289                 }
00290 
00291                 Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00292 
00293                 <span class="comment">//</span>
00294                 <span class="comment">// Save and restore the processor context in case the</span>
00295                 <span class="comment">// kernel debugger has been configured to stop on dll</span>
00296                 <span class="comment">// loads.</span>
00297                 <span class="comment">//</span>
00298 
00299                 Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00300                 <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a1">KiSaveProcessorControlState</a>(&amp;Prcb-&gt;ProcessorState);
00301                 RtlCopyMemory(&amp;Prcb-&gt;ProcessorState.ContextFrame,
00302                               ContextRecord,
00303                               <span class="keyword">sizeof</span>(CONTEXT));
00304 
00305                 SymbolInfo = (<a class="code" href="../../d6/d5/struct__KD__SYMBOLS__INFO.html">PKD_SYMBOLS_INFO</a>)ExceptionRecord-&gt;ExceptionInformation[2];
00306                 Completion =
00307                     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a121">KdpReportLoadSymbolsStateChange</a>((PSTRING)ExceptionRecord-&gt;ExceptionInformation[1],
00308                                                     SymbolInfo,
00309                                                     UnloadSymbols,
00310                                                     &amp;Prcb-&gt;ProcessorState.ContextFrame);
00311 
00312                 RtlCopyMemory(ContextRecord,
00313                               &amp;Prcb-&gt;ProcessorState.ContextFrame,
00314                               sizeof (CONTEXT) );
00315 
00316                 <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a0">KiRestoreProcessorControlState</a>(&amp;Prcb-&gt;ProcessorState);
00317 
00318                 <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00319                 <span class="keywordflow">break</span>;
00320 
00321             <span class="comment">//</span>
00322             <span class="comment">//  Unknown command</span>
00323             <span class="comment">//</span>
00324 
00325             <span class="keywordflow">default</span>:
00326                 <span class="comment">// return FALSE</span>
00327                 <span class="keywordflow">break</span>;
00328         }
00329         <span class="comment">//</span>
00330         <span class="comment">// If the kernel debugger did not update the EIP, then increment</span>
00331         <span class="comment">// past the breakpoint instruction.</span>
00332         <span class="comment">//</span>
00333 
00334         <span class="keywordflow">if</span> (ContextRecord-&gt;Eip == OldEip) {
00335             ContextRecord-&gt;Eip++;
00336         }
00337 
00338 
00339     } <span class="keywordflow">else</span> {
00340 
00341         <span class="keywordflow">if</span>  ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) ||
00342              (ExceptionRecord-&gt;ExceptionCode == STATUS_SINGLE_STEP)  ||
00343              (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_STOP_ON_EXCEPTION) ||
00344              SecondChance) {
00345 
00346             <span class="keywordflow">if</span> (!SecondChance &amp;&amp;
00347                 (ExceptionRecord-&gt;ExceptionCode == STATUS_PORT_DISCONNECTED ||
00348                  <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( ExceptionRecord-&gt;ExceptionCode )
00349                 )
00350                ) {
00351                 <span class="comment">//</span>
00352                 <span class="comment">// User does not really want to see these either.</span>
00353                 <span class="comment">// so do NOT report it to debugger.</span>
00354                 <span class="comment">//</span>
00355 
00356                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00357                 }
00358 
00359             <span class="comment">//</span>
00360             <span class="comment">// Report state change to kernel debugger on host</span>
00361             <span class="comment">//</span>
00362 
00363 
00364             Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00365             Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00366             <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a1">KiSaveProcessorControlState</a>(&amp;Prcb-&gt;ProcessorState);
00367             RtlCopyMemory(&amp;Prcb-&gt;ProcessorState.ContextFrame,
00368                           ContextRecord,
00369                           sizeof (CONTEXT));
00370 
00371             Completion =
00372                 <a class="code" href="../../d1/d7/4_2kdp_8h.html#a120">KdpReportExceptionStateChange</a>(ExceptionRecord,
00373                                               &amp;Prcb-&gt;ProcessorState.ContextFrame,
00374                                               SecondChance);
00375 
00376             RtlCopyMemory(ContextRecord,
00377                           &amp;Prcb-&gt;ProcessorState.ContextFrame,
00378                           <span class="keyword">sizeof</span>(CONTEXT));
00379 
00380             <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a0">KiRestoreProcessorControlState</a>(&amp;Prcb-&gt;ProcessorState);
00381             <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00382 
00383             <a class="code" href="../../d8/d5/kddata_8c.html#a90">KdpControlCPressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00384 
00385         } <span class="keywordflow">else</span> {
00386 
00387             <span class="comment">//</span>
00388             <span class="comment">// This is real exception that user doesn't want to see,</span>
00389             <span class="comment">// so do NOT report it to debugger.</span>
00390             <span class="comment">//</span>
00391 
00392             <span class="comment">// return FALSE;</span>
00393         }
00394     }
00395 
00396     _asm {
00397         mov     esp, SavedEsp
00398     }
00399     <span class="keywordflow">return</span> Completion;
00400 
00401     UNREFERENCED_PARAMETER(PreviousMode);
00402 }
00403 
00404 
00405 BOOLEAN
<a name="l00406"></a><a class="code" href="../../d8/d8/i386_2kdtrap_8c.html#a2">00406</a> <a class="code" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a> (
00407     IN PEXCEPTION_RECORD ExceptionRecord,
00408     IN PCONTEXT ContextRecord,
00409     IN KPROCESSOR_MODE PreviousMode
00410     )
00411 
00412 <span class="comment">/*++</span>
00413 <span class="comment"></span>
00414 <span class="comment">Routine Description:</span>
00415 <span class="comment"></span>
00416 <span class="comment">    This routine is called whenever a user-mode exception occurs and</span>
00417 <span class="comment">    it might be a kernel debugger exception (Like DbgPrint/DbgPrompt ).</span>
00418 <span class="comment"></span>
00419 <span class="comment">Arguments:</span>
00420 <span class="comment"></span>
00421 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record that</span>
00422 <span class="comment">        describes the exception.</span>
00423 <span class="comment"></span>
00424 <span class="comment">    ContextRecord - Supplies the context at the time of the exception.</span>
00425 <span class="comment"></span>
00426 <span class="comment">    PreviousMode - Supplies the previous processor mode.</span>
00427 <span class="comment"></span>
00428 <span class="comment">Return Value:</span>
00429 <span class="comment"></span>
00430 <span class="comment">    A value of TRUE is returned if this is for the kernel debugger.</span>
00431 <span class="comment">    Otherwise, a value of FALSE is returned.</span>
00432 <span class="comment"></span>
00433 <span class="comment">--*/</span>
00434 
00435 {
00436     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00437         (ExceptionRecord-&gt;NumberParameters &gt; 0) &amp;&amp;
00438         (ExceptionRecord-&gt;ExceptionInformation[0] != <a class="code" href="../../d8/d3/ia32def_8h.html#a17">BREAKPOINT_BREAK</a>)) {
00439 
00440         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00441     } <span class="keywordflow">else</span> {
00442         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00443     }
00444     UNREFERENCED_PARAMETER(ContextRecord);
00445 }
00446 
00447 BOOLEAN
00448 <a class="code" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a3">KdpCheckTracePoint</a>(
00449     IN PEXCEPTION_RECORD ExceptionRecord,
00450     IN OUT PCONTEXT ContextRecord
00451     );
00452 
00453 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00454 <a class="code" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a4">SaveSymLoad</a>(
00455     IN PSTRING PathName,
00456     IN PVOID BaseOfDll,
00457     IN LONG ProcessId,
00458     IN BOOLEAN UnloadSymbols
00459     );
00460 
00461 BOOLEAN
<a name="l00462"></a><a class="code" href="../../d8/d8/i386_2kdtrap_8c.html#a5">00462</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a117">KdpStub</a> (
00463     IN PKTRAP_FRAME TrapFrame,
00464     IN PKEXCEPTION_FRAME ExceptionFrame,
00465     IN PEXCEPTION_RECORD ExceptionRecord,
00466     IN PCONTEXT ContextRecord,
00467     IN KPROCESSOR_MODE PreviousMode,
00468     IN BOOLEAN SecondChance
00469     )
00470 
00471 <span class="comment">/*++</span>
00472 <span class="comment"></span>
00473 <span class="comment">Routine Description:</span>
00474 <span class="comment"></span>
00475 <span class="comment">    This routine provides a kernel debugger stub routine to catch debug</span>
00476 <span class="comment">    prints in a checked system when the kernel debugger is not active.</span>
00477 <span class="comment"></span>
00478 <span class="comment">Arguments:</span>
00479 <span class="comment"></span>
00480 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame that describes the</span>
00481 <span class="comment">        trap.</span>
00482 <span class="comment"></span>
00483 <span class="comment">    ExceptionFrame - Supplies a pointer to a exception frame that describes</span>
00484 <span class="comment">        the trap.</span>
00485 <span class="comment"></span>
00486 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record that</span>
00487 <span class="comment">        describes the exception.</span>
00488 <span class="comment"></span>
00489 <span class="comment">    ContextRecord - Supplies the context at the time of the exception.</span>
00490 <span class="comment"></span>
00491 <span class="comment">    PreviousMode - Supplies the previous processor mode.</span>
00492 <span class="comment"></span>
00493 <span class="comment">    SecondChance - Supplies a boolean value that determines whether this is</span>
00494 <span class="comment">        the second chance (TRUE) that the exception has been raised.</span>
00495 <span class="comment"></span>
00496 <span class="comment">Return Value:</span>
00497 <span class="comment"></span>
00498 <span class="comment">    A value of TRUE is returned if the exception is handled. Otherwise a</span>
00499 <span class="comment">    value of FALSE is returned.</span>
00500 <span class="comment"></span>
00501 <span class="comment">--*/</span>
00502 
00503 {
00504     PULONG  SymbolArgs;
00505     <span class="comment">//</span>
00506     <span class="comment">// If the breakpoint is a debug print, then return TRUE. Otherwise,</span>
00507     <span class="comment">// return FALSE.</span>
00508     <span class="comment">//</span>
00509 
00510     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00511         (ExceptionRecord-&gt;NumberParameters &gt; 0) &amp;&amp;
00512         ((ExceptionRecord-&gt;ExceptionInformation[0] == BREAKPOINT_LOAD_SYMBOLS)||
00513          (ExceptionRecord-&gt;ExceptionInformation[0] == BREAKPOINT_UNLOAD_SYMBOLS)||
00514          (ExceptionRecord-&gt;ExceptionInformation[0] == BREAKPOINT_PRINT))) {
00515 
00516         ContextRecord-&gt;Eip++;
00517         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00518     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00519         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00520     } <span class="keywordflow">else</span> {
00521         <span class="keywordflow">return</span>(<a class="code" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a3">KdpCheckTracePoint</a>(ExceptionRecord,ContextRecord));
00522     }
00523 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
