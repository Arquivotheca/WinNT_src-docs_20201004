<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: resource.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>resource.c</h1><a href="../../d8/d8/ex_2resource_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1994 Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    resource.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the executive functions to acquire and release</span>
00012 <span class="comment">    a shared resource.</span>
00013 <span class="comment"></span>
00014 <span class="comment">    N.B. These routines, in some cases, use "fast locks" to guarantee</span>
00015 <span class="comment">         mutual exclusion. On MP and debug systems, fast locks are</span>
00016 <span class="comment">         implemented as spinlocks (in UP debug systems raise/lower IRQL</span>
00017 <span class="comment">         used). For UP non-debug systems, fast locks are implemented by</span>
00018 <span class="comment">         DISABLING INTERRUPTS.</span>
00019 <span class="comment"></span>
00020 <span class="comment">Author:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    Gary D. Kimura [GaryKi] 25-Jun-1989</span>
00023 <span class="comment"></span>
00024 <span class="comment">    David N. Cutler (davec) 20-Mar-1994</span>
00025 <span class="comment">        Substantially rewritten to make fastlock optimizations portable</span>
00026 <span class="comment">        across all platforms and to improve the algorithms used to be</span>
00027 <span class="comment">        perfectly synchronized.</span>
00028 <span class="comment"></span>
00029 <span class="comment">Environment:</span>
00030 <span class="comment"></span>
00031 <span class="comment">    Kernel mode only.</span>
00032 <span class="comment"></span>
00033 <span class="comment">Revision History:</span>
00034 <span class="comment"></span>
00035 <span class="comment">--*/</span>
00036 
00037 <span class="comment">//#define DBG 1</span>
00038 <span class="comment">//#define _COLLECT_RESOURCE_DATA_ 1</span>
00039 
00040 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00041 <span class="preprocessor">#pragma hdrstop</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#include "nturtl.h"</span>
00043 
00044 <span class="comment">//</span>
00045 <span class="comment">// Define local macros to test resource state.</span>
00046 <span class="comment">//</span>
00047 
<a name="l00048"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a0">00048</a> <span class="preprocessor">#define IsExclusiveWaiting(a) ((a)-&gt;NumberOfExclusiveWaiters != 0)</span>
<a name="l00049"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a1">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define IsSharedWaiting(a) ((a)-&gt;NumberOfSharedWaiters != 0)</span>
<a name="l00050"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a2">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define IsOwnedExclusive(a) (((a)-&gt;Flag &amp; ResourceOwnedExclusive) != 0)</span>
<a name="l00051"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a3">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define IsBoostAllowed(a) (((a)-&gt;Flag &amp; DisablePriorityBoost) == 0)</span>
00052 <span class="preprocessor"></span>
00053 <span class="comment">//</span>
00054 <span class="comment">// Define priority boost flags.</span>
00055 <span class="comment">//</span>
00056 
<a name="l00057"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a4">00057</a> <span class="preprocessor">#define DisablePriorityBoost 0x08</span>
00058 <span class="preprocessor"></span>
00059 <span class="comment">//</span>
00060 <span class="comment">// Define resource assertion macro.</span>
00061 <span class="comment">//</span>
00062 
00063 <span class="preprocessor">#if DBG</span>
00064 <span class="preprocessor"></span>
00065 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00066 ExpAssertResource(
00067     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
00068     );
00069 
00070 <span class="preprocessor">#define ASSERT_RESOURCE(_Resource) ExpAssertResource(_Resource)</span>
00071 <span class="preprocessor"></span>
00072 <span class="preprocessor">#else</span>
00073 <span class="preprocessor"></span>
<a name="l00074"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a5">00074</a> <span class="preprocessor">#define ASSERT_RESOURCE(_Resource)</span>
00075 <span class="preprocessor"></span>
00076 <span class="preprocessor">#endif</span>
00077 <span class="preprocessor"></span>
00078 
00079 
00080 <span class="comment">//</span>
00081 <span class="comment">// Define private function prototypes.</span>
00082 <span class="comment">//</span>
00083 
00084 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00085 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00086 <a class="code" href="../../d8/d8/ex_2resource_8c.html#a11">ExpWaitForResource</a> (
00087     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
00088     IN PVOID Object
00089     );
00090 
00091 <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a>
00092 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00093 <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(
00094     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
00095     IN ERESOURCE_THREAD CurrentThread
00096     );
00097 
00098 <span class="comment">//</span>
00099 <span class="comment">// Resource wait time out value.</span>
00100 <span class="comment">//</span>
00101 
<a name="l00102"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a7">00102</a> LARGE_INTEGER <a class="code" href="../../d7/d4/ddkresrc_8c.html#a14">ExpTimeout</a>;
00103 
00104 <span class="comment">//</span>
00105 <span class="comment">// Consecutive time outs before message.</span>
00106 <span class="comment">//</span>
00107 
<a name="l00108"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a8">00108</a> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a44">ExpResourceTimeoutCount</a> = 648000;
00109 
00110 <span class="comment">//</span>
00111 <span class="comment">// Global spinlock to guard access to resource lists.</span>
00112 <span class="comment">//</span>
00113 
<a name="l00114"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a9">00114</a> KSPIN_LOCK <a class="code" href="../../d8/d8/ex_2resource_8c.html#a9">ExpResourceSpinLock</a>;
00115 
00116 <span class="comment">//</span>
00117 <span class="comment">// Resource list used to record all resource in the system.</span>
00118 <span class="comment">//</span>
00119 
<a name="l00120"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a10">00120</a> LIST_ENTRY <a class="code" href="../../d7/d4/ddkresrc_8c.html#a17">ExpSystemResourcesList</a>;
00121 
00122 <span class="comment">//</span>
00123 <span class="comment">// Define executive resource performance data.</span>
00124 <span class="comment">//</span>
00125 
00126 <span class="preprocessor">#if defined(_COLLECT_RESOURCE_DATA_)</span>
00127 <span class="preprocessor"></span>
00128 <span class="preprocessor">#define ExpIncrementCounter(Member) ExpResourcePerformanceData.Member += 1</span>
00129 <span class="preprocessor"></span>
00130 <a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html">RESOURCE_PERFORMANCE_DATA</a> ExpResourcePerformanceData;
00131 
00132 <span class="preprocessor">#else</span>
00133 <span class="preprocessor"></span>
<a name="l00134"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">00134</a> <span class="preprocessor">#define ExpIncrementCounter(Member)</span>
00135 <span class="preprocessor"></span>
00136 <span class="preprocessor">#endif</span>
00137 <span class="preprocessor"></span>
00138 <span class="comment">//</span>
00139 <span class="comment">// Put code in the appropriate sections.</span>
00140 <span class="comment">//</span>
00141 
00142 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00143 <span class="preprocessor"></span>
00144 <span class="preprocessor">#pragma alloc_text(INIT, ExpResourceInitialization)</span>
00145 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, ExQuerySystemLockInformation)</span>
00146 <span class="preprocessor"></span>
00147 <span class="preprocessor">#endif</span>
00148 <span class="preprocessor"></span>
00149 BOOLEAN
<a name="l00150"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a13">00150</a> <a class="code" href="../../d8/d8/ex_2resource_8c.html#a13">ExpResourceInitialization</a>(
00151     VOID
00152     )
00153 
00154 <span class="comment">/*++</span>
00155 <span class="comment"></span>
00156 <span class="comment">Routine Description:</span>
00157 <span class="comment"></span>
00158 <span class="comment">    This function initializes global data during system initialization.</span>
00159 <span class="comment"></span>
00160 <span class="comment">Arguments:</span>
00161 <span class="comment"></span>
00162 <span class="comment">    None.</span>
00163 <span class="comment"></span>
00164 <span class="comment">Return Value:</span>
00165 <span class="comment"></span>
00166 <span class="comment">    BOOLEAN - TRUE</span>
00167 <span class="comment"></span>
00168 <span class="comment">--*/</span>
00169 
00170 {
00171 
00172     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00173 
00174     <span class="comment">//</span>
00175     <span class="comment">// Initialize resource timeout value, the system resource listhead,</span>
00176     <span class="comment">// and the resource spinlock.</span>
00177     <span class="comment">//</span>
00178 
00179     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a14">ExpTimeout</a>.QuadPart = Int32x32To64(4 * 1000, -10000);
00180     InitializeListHead(&amp;<a class="code" href="../../d7/d4/ddkresrc_8c.html#a17">ExpSystemResourcesList</a>);
00181     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;<a class="code" href="../../d8/d8/ex_2resource_8c.html#a9">ExpResourceSpinLock</a>);
00182 
00183     <span class="comment">//</span>
00184     <span class="comment">// Initialize resource performance data.</span>
00185     <span class="comment">//</span>
00186 
00187 <span class="preprocessor">#if defined(_COLLECT_RESOURCE_DATA_)</span>
00188 <span class="preprocessor"></span>
00189     ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o0">ActiveResourceCount</a> = 0;
00190     ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o1">TotalResourceCount</a> = 0;
00191     ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o2">ExclusiveAcquire</a> = 0;
00192     ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o3">SharedFirstLevel</a> = 0;
00193     ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o4">SharedSecondLevel</a> = 0;
00194     ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o5">StarveFirstLevel</a> = 0;
00195     ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o6">StarveSecondLevel</a> = 0;
00196     ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o7">WaitForExclusive</a> = 0;
00197     ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o8">OwnerTableExpands</a> = 0;
00198     ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o9">MaximumTableExpand</a> = 0;
00199     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d5/d8/ex_8h.html#a65">RESOURCE_HASH_TABLE_SIZE</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00200         InitializeListHead(&amp;ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o10">HashTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
00201     }
00202 
00203 <span class="preprocessor">#endif</span>
00204 <span class="preprocessor"></span>
00205     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00206 }
00207 
00208 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00209"></a><a class="code" href="../../d5/d8/ex_8h.html#a266">00209</a> <a class="code" href="../../d5/d8/ex_8h.html#a266">ExInitializeResourceLite</a>(
00210     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
00211     )
00212 
00213 <span class="comment">/*++</span>
00214 <span class="comment"></span>
00215 <span class="comment">Routine Description:</span>
00216 <span class="comment"></span>
00217 <span class="comment">    This routine initializes the specified resource.</span>
00218 <span class="comment"></span>
00219 <span class="comment">Arguments:</span>
00220 <span class="comment"></span>
00221 <span class="comment">    Resource - Supplies a pointer to the resource to initialize.</span>
00222 <span class="comment"></span>
00223 <span class="comment">Return Value:</span>
00224 <span class="comment"></span>
00225 <span class="comment">    STATUS_SUCCESS.</span>
00226 <span class="comment"></span>
00227 <span class="comment">--*/</span>
00228 
00229 {
00230 
00231     PVOID CallersCaller;
00232 
00233     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d6/allocpag_8c.html#a48">MmDeterminePoolType</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
00234 
00235     <span class="comment">//</span>
00236     <span class="comment">// Initialize the specified resource.</span>
00237     <span class="comment">//</span>
00238     <span class="comment">// N.B. All fields are initialized to zero (NULL pointers) except</span>
00239     <span class="comment">//      the list entry and spinlock.</span>
00240     <span class="comment">//</span>
00241 
00242     RtlZeroMemory(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>));
00243     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>);
00244 
00245 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
00246 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
00247         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o11">CreatorBackTraceIndex</a> = RtlLogStackBackTrace();
00248         }
00249     <span class="keywordflow">else</span> {
00250         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o11">CreatorBackTraceIndex</a> = 0;
00251         }
00252 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
00253 <span class="preprocessor"></span>    <a class="code" href="../../d5/d8/ex_8h.html#a238">ExInterlockedInsertTailList</a>(&amp;<a class="code" href="../../d7/d4/ddkresrc_8c.html#a17">ExpSystemResourcesList</a>,
00254                                 &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o0">SystemResourcesList</a>,
00255                                 &amp;<a class="code" href="../../d8/d8/ex_2resource_8c.html#a9">ExpResourceSpinLock</a>);
00256 
00257     <span class="comment">//</span>
00258     <span class="comment">// Initialize performance data entry for the resource.</span>
00259     <span class="comment">//</span>
00260 
00261 <span class="preprocessor">#if defined(_COLLECT_RESOURCE_DATA_)</span>
00262 <span class="preprocessor"></span>
00263     <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o10">Address</a>, &amp;CallersCaller);
00264     ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o1">TotalResourceCount</a> += 1;
00265     ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o0">ActiveResourceCount</a> += 1;
00266 
00267 <span class="preprocessor">#endif</span>
00268 <span class="preprocessor"></span>
00269     <span class="keywordflow">return</span> STATUS_SUCCESS;
00270 }
00271 
00272 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00273"></a><a class="code" href="../../d5/d8/ex_8h.html#a267">00273</a> <a class="code" href="../../d5/d8/ex_8h.html#a267">ExReinitializeResourceLite</a>(
00274     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
00275     )
00276 
00277 <span class="comment">/*++</span>
00278 <span class="comment"></span>
00279 <span class="comment">Routine Description:</span>
00280 <span class="comment"></span>
00281 <span class="comment">    This routine reinitializes the specified resource.</span>
00282 <span class="comment"></span>
00283 <span class="comment">Arguments:</span>
00284 <span class="comment"></span>
00285 <span class="comment">    Resource - Supplies a pointer to the resource to initialize.</span>
00286 <span class="comment"></span>
00287 <span class="comment">Return Value:</span>
00288 <span class="comment"></span>
00289 <span class="comment">    STATUS_SUCCESS.</span>
00290 <span class="comment"></span>
00291 <span class="comment">--*/</span>
00292 
00293 {
00294 
00295     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00296     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00297     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerTable;
00298     <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">PKSEMAPHORE</a> Semaphore;
00299     ULONG TableSize;
00300 
00301     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d6/allocpag_8c.html#a48">MmDeterminePoolType</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
00302 
00303     <span class="comment">//</span>
00304     <span class="comment">// If the resource has an owner table, then zero the owner table.</span>
00305     <span class="comment">//</span>
00306 
00307     OwnerTable = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
00308     <span class="keywordflow">if</span> (OwnerTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00309         TableSize = OwnerTable-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>;
00310         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; TableSize; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00311             OwnerTable[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 0;
00312             OwnerTable[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 0;
00313         }
00314     }
00315 
00316     <span class="comment">//</span>
00317     <span class="comment">// Set the active count and flags to zero.</span>
00318     <span class="comment">//</span>
00319 
00320     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 0;
00321     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> = 0;
00322 
00323     <span class="comment">//</span>
00324     <span class="comment">// If the resource has a shared waiter semaphore, then reinitialize</span>
00325     <span class="comment">// it.</span>
00326     <span class="comment">//</span>
00327 
00328     Semaphore = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>;
00329     <span class="keywordflow">if</span> (Semaphore != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00330         <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(Semaphore, 0, MAXLONG);
00331     }
00332 
00333     <span class="comment">//</span>
00334     <span class="comment">// If the resource has a exclusive waiter event, then reinitialize</span>
00335     <span class="comment">// it.</span>
00336     <span class="comment">//</span>
00337 
00338     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>;
00339     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00340         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00341     }
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">// Initialize the builtin owner table.</span>
00345     <span class="comment">//</span>
00346 
00347     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 0;
00348     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 0;
00349     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 0;
00350     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 0;
00351 
00352     <span class="comment">//</span>
00353     <span class="comment">// Set the contention count, number of shared waiters, and number</span>
00354     <span class="comment">// of exclusive waiters to zero.</span>
00355     <span class="comment">//</span>
00356 
00357     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a> = 0;
00358     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> = 0;
00359     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a> = 0;
00360 
00361     <span class="comment">//</span>
00362     <span class="comment">// Reinitialize the resource spinlock.</span>
00363     <span class="comment">//</span>
00364 
00365     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>);
00366     <span class="keywordflow">return</span> STATUS_SUCCESS;
00367 }
00368 
00369 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00370"></a><a class="code" href="../../d5/d8/ex_8h.html#a280">00370</a> <a class="code" href="../../d5/d8/ex_8h.html#a280">ExDisableResourceBoostLite</a>(
00371     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
00372     )
00373 
00374 <span class="comment">/*++</span>
00375 <span class="comment"></span>
00376 <span class="comment">Routine Description:</span>
00377 <span class="comment"></span>
00378 <span class="comment">    This routine disables priority inversion boosting for the specified</span>
00379 <span class="comment">    resource.</span>
00380 <span class="comment"></span>
00381 <span class="comment">Arguments:</span>
00382 <span class="comment"></span>
00383 <span class="comment">    Resource - Supplies a pointer to the resource for which priority</span>
00384 <span class="comment">        boosting is disabled.</span>
00385 <span class="comment"></span>
00386 <span class="comment">Return Value:</span>
00387 <span class="comment"></span>
00388 <span class="comment">    None.</span>
00389 <span class="comment"></span>
00390 <span class="comment">--*/</span>
00391 
00392 {
00393 
00394     KIRQL OldIrql;
00395 
00396     <span class="comment">//</span>
00397     <span class="comment">// Disable priority boosts for the specified resource.</span>
00398     <span class="comment">//</span>
00399 
00400     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
00401 
00402     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
00403 
00404     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> |= <a class="code" href="../../d7/d4/ddkresrc_8c.html#a3">DisablePriorityBoost</a>;
00405     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00406 }
00407 
00408 BOOLEAN
00409 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00410"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a17">00410</a> <a class="code" href="../../d8/d8/ex_2resource_8c.html#a17">ExpAcquireResourceExclusiveLite</a>(
00411     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
00412     IN KIRQL OldIrql
00413     )
00414 
00415 <span class="comment">/*++</span>
00416 <span class="comment"></span>
00417 <span class="comment">Routine Description:</span>
00418 <span class="comment"></span>
00419 <span class="comment">    This routine acquires the specified resource for exclusive access.</span>
00420 <span class="comment"></span>
00421 <span class="comment">    N.B. This routine uses fast locking.</span>
00422 <span class="comment"></span>
00423 <span class="comment">    N.B. This routine is called with the fast lock for the resource</span>
00424 <span class="comment">        held.</span>
00425 <span class="comment"></span>
00426 <span class="comment">Arguments:</span>
00427 <span class="comment"></span>
00428 <span class="comment">    Resource - Supplies a pointer to the resource that is acquired</span>
00429 <span class="comment">        for exclusive access.</span>
00430 <span class="comment"></span>
00431 <span class="comment">    OldIrql - Supplies the previous IRQL.</span>
00432 <span class="comment"></span>
00433 <span class="comment">Return Value:</span>
00434 <span class="comment"></span>
00435 <span class="comment">    BOOLEAN - TRUE if the resource is acquired and FALSE otherwise.</span>
00436 <span class="comment"></span>
00437 <span class="comment">--*/</span>
00438 
00439 {
00440 
00441     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00442 
00443     <span class="comment">//</span>
00444     <span class="comment">// If the exclusive wait event has not yet been allocated, then the</span>
00445     <span class="comment">// long path code must be taken.</span>
00446     <span class="comment">//</span>
00447 
00448     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00449 
00450         <span class="comment">//</span>
00451         <span class="comment">// Allocate an exclusive wait event.</span>
00452         <span class="comment">//</span>
00453         <span class="comment">// N.B. This path is not optimal, but is only ever executed once</span>
00454         <span class="comment">//      per resource.</span>
00455         <span class="comment">//</span>
00456 
00457         ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00458         ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
00459         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00460             <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
00461                                           <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>),
00462                                           'vEeR');
00463 
00464             <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00465             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a> = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00466         }
00467 
00468         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00469         <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a269">ExAcquireResourceExclusiveLite</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00470     }
00471 
00472     <span class="comment">//</span>
00473     <span class="comment">// Wait for exclusive access to the resource to be granted and set the</span>
00474     <span class="comment">// owner thread.</span>
00475     <span class="comment">//</span>
00476 
00477     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a> += 1;
00478     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00479     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a11">ExpWaitForResource</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>);
00480 
00481     <span class="comment">//</span>
00482     <span class="comment">// N.B. It is "safe" to store the owner thread without obtaining any</span>
00483     <span class="comment">//      locks since the thread has already been granted exclusive</span>
00484     <span class="comment">//      ownership.</span>
00485     <span class="comment">//</span>
00486 
00487     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00488     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00489 }
00490 
00491 BOOLEAN
<a name="l00492"></a><a class="code" href="../../d5/d8/ex_8h.html#a269">00492</a> <a class="code" href="../../d5/d8/ex_8h.html#a269">ExAcquireResourceExclusiveLite</a>(
00493     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
00494     IN BOOLEAN Wait
00495     )
00496 
00497 <span class="comment">/*++</span>
00498 <span class="comment"></span>
00499 <span class="comment">Routine Description:</span>
00500 <span class="comment"></span>
00501 <span class="comment">    The routine acquires the specified resource for exclusive access.</span>
00502 <span class="comment"></span>
00503 <span class="comment">    N.B. This routine uses fast locking.</span>
00504 <span class="comment"></span>
00505 <span class="comment">Arguments:</span>
00506 <span class="comment"></span>
00507 <span class="comment">    Resource - Supplies a pointer to the resource that is acquired</span>
00508 <span class="comment">        for exclusive access.</span>
00509 <span class="comment"></span>
00510 <span class="comment">    Wait - A boolean value that specifies whether to wait for the</span>
00511 <span class="comment">        resource to become available if access cannot be granted</span>
00512 <span class="comment">        immediately.</span>
00513 <span class="comment"></span>
00514 <span class="comment">Return Value:</span>
00515 <span class="comment"></span>
00516 <span class="comment">    BOOLEAN - TRUE if the resource is acquired and FALSE otherwise.</span>
00517 <span class="comment"></span>
00518 <span class="comment">--*/</span>
00519 
00520 {
00521 
00522     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
00523     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00524     KIRQL OldIrql = 0;
00525     BOOLEAN Result;
00526 
00527     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp; <a class="code" href="../../d5/d8/ex_8h.html#a62">ResourceNeverExclusive</a>) == 0);
00528 
00529     <span class="comment">//</span>
00530     <span class="comment">// Acquire exclusive access to the specified resource.</span>
00531     <span class="comment">//</span>
00532 
00533     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00534     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
00535 
00536     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00537     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
00538 
00539     <span class="comment">//</span>
00540     <span class="comment">// If the active count of the resource is zero, then there is neither</span>
00541     <span class="comment">// an exclusive owner nor a shared owner and access to the resource can</span>
00542     <span class="comment">// be immediately granted. Otherwise, there is either a shared owner or</span>
00543     <span class="comment">// an exclusive owner.</span>
00544     <span class="comment">//</span>
00545 
00546     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(ExclusiveAcquire);
00547     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> != 0) {
00548 
00549         <span class="comment">//</span>
00550         <span class="comment">// The resource is either owned exclusive or shared.</span>
00551         <span class="comment">//</span>
00552         <span class="comment">// If the resource is owned exclusive and the current thread is the</span>
00553         <span class="comment">// owner, then increment the recursion count.</span>
00554         <span class="comment">//</span>
00555 
00556         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) &amp;&amp;
00557             (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread)) {
00558             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
00559             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00560 
00561         } <span class="keywordflow">else</span> {
00562 
00563             <span class="comment">//</span>
00564             <span class="comment">// The resource is either owned exclusive by some other thread,</span>
00565             <span class="comment">// or owned shared.</span>
00566             <span class="comment">//</span>
00567             <span class="comment">// If wait is not specified, then return that the resource was</span>
00568             <span class="comment">// not acquired. Otherwise, wait for exclusive access to the</span>
00569             <span class="comment">// resource to be granted.</span>
00570             <span class="comment">//</span>
00571 
00572             <span class="keywordflow">if</span> (Wait == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00573                 Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00574 
00575             } <span class="keywordflow">else</span> {
00576                 <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/ex_2resource_8c.html#a17">ExpAcquireResourceExclusiveLite</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, OldIrql);
00577             }
00578         }
00579 
00580     } <span class="keywordflow">else</span> {
00581 
00582         <span class="comment">//</span>
00583         <span class="comment">// The resource is not owned.</span>
00584         <span class="comment">//</span>
00585 
00586         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> |= <a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
00587         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
00588         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
00589         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
00590         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00591     }
00592 
00593     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00594     <span class="keywordflow">return</span> Result;
00595 }
00596 
00597 BOOLEAN
<a name="l00598"></a><a class="code" href="../../d5/d8/ex_8h.html#a272">00598</a> <a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a>(
00599     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
00600     )
00601 
00602 <span class="comment">/*++</span>
00603 <span class="comment"></span>
00604 <span class="comment">Routine Description:</span>
00605 <span class="comment"></span>
00606 <span class="comment">    The routine attempts to acquire the specified resource for exclusive</span>
00607 <span class="comment">    access.</span>
00608 <span class="comment"></span>
00609 <span class="comment">    N.B. This routine uses fast locking.</span>
00610 <span class="comment"></span>
00611 <span class="comment">Arguments:</span>
00612 <span class="comment"></span>
00613 <span class="comment">    Resource - Supplies a pointer to the resource that is acquired</span>
00614 <span class="comment">        for exclusive access.</span>
00615 <span class="comment"></span>
00616 <span class="comment">Return Value:</span>
00617 <span class="comment"></span>
00618 <span class="comment">    BOOLEAN - TRUE if the resource is acquired and FALSE otherwise.</span>
00619 <span class="comment"></span>
00620 <span class="comment">--*/</span>
00621 
00622 {
00623 
00624     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
00625     KIRQL OldIrql;
00626     BOOLEAN Result;
00627 
00628     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp; <a class="code" href="../../d5/d8/ex_8h.html#a62">ResourceNeverExclusive</a>) == 0);
00629 
00630     <span class="comment">//</span>
00631     <span class="comment">// Attempt to acquire exclusive access to the specified resource.</span>
00632     <span class="comment">//</span>
00633 
00634     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00635     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
00636 
00637     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00638     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
00639 
00640     <span class="comment">//</span>
00641     <span class="comment">// If the active count of the resource is zero, then there is neither</span>
00642     <span class="comment">// an exclusive owner nor a shared owner and access to the resource can</span>
00643     <span class="comment">// be immediately granted. Otherwise, if the resource is owned exclusive</span>
00644     <span class="comment">// and the current thread is the owner, then access to the resource can</span>
00645     <span class="comment">// be immediately granted. Otherwise, access cannot be granted.</span>
00646     <span class="comment">//</span>
00647 
00648     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00649     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
00650         <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(ExclusiveAcquire);
00651         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> |= <a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
00652         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
00653         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
00654         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
00655         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00656 
00657     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) &amp;&amp;
00658         (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread)) {
00659         <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(ExclusiveAcquire);
00660         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
00661         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00662     }
00663 
00664     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00665     <span class="keywordflow">return</span> Result;
00666 }
00667 
00668 <span class="preprocessor">#if defined(NT_UP) &amp;&amp; !DBG</span>
00669 <span class="preprocessor"></span>
00670 BOOLEAN
00671 ExpAcquireResourceSharedLite(
00672     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
00673     IN BOOLEAN Wait
00674     );
00675 
00676 BOOLEAN
00677 <a class="code" href="../../d5/d8/ex_8h.html#a268">ExAcquireResourceSharedLite</a>(
00678     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
00679     IN BOOLEAN Wait
00680     )
00681 
00682 <span class="comment">/*++</span>
00683 <span class="comment"></span>
00684 <span class="comment">Routine Description:</span>
00685 <span class="comment"></span>
00686 <span class="comment">    The routine acquires the specified resource for shared access.</span>
00687 <span class="comment"></span>
00688 <span class="comment">    N.B. This routine uses fast locking.</span>
00689 <span class="comment"></span>
00690 <span class="comment">Arguments:</span>
00691 <span class="comment"></span>
00692 <span class="comment">    Resource - Supplies a pointer to the resource that is acquired</span>
00693 <span class="comment">        for shared access.</span>
00694 <span class="comment"></span>
00695 <span class="comment">    Wait - A boolean value that specifies whether to wait for the</span>
00696 <span class="comment">        resource to become available if access cannot be granted</span>
00697 <span class="comment">        immediately.</span>
00698 <span class="comment"></span>
00699 <span class="comment">Return Value:</span>
00700 <span class="comment"></span>
00701 <span class="comment">    BOOLEAN - TRUE if the resource is acquired and FALSE otherwise</span>
00702 <span class="comment"></span>
00703 <span class="comment">--*/</span>
00704 
00705 {
00706 
00707     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
00708     KIRQL OldIrql;
00709 
00710     <span class="comment">//</span>
00711     <span class="comment">// Acquire exclusive access to the specified resource.</span>
00712     <span class="comment">//</span>
00713 
00714     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00715     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
00716 
00717     <span class="comment">//</span>
00718     <span class="comment">// If the active count of the resource is zero, then there is neither</span>
00719     <span class="comment">// an exclusive owner nor a shared owner and access to the resource can</span>
00720     <span class="comment">// be immediately granted.</span>
00721     <span class="comment">//</span>
00722 
00723     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
00724         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
00725         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
00726         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
00727         <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(SharedFirstLevel);
00728         ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00729         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00730     }
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">// The resource is either owned exclusive or shared.</span>
00734     <span class="comment">//</span>
00735     <span class="comment">// If the resource is owned exclusive and the current thread is the</span>
00736     <span class="comment">// owner, then treat the shared request as an exclusive request and</span>
00737     <span class="comment">// increment the recursion count. Otherwise, it is owned shared.</span>
00738     <span class="comment">//</span>
00739 
00740     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource) &amp;&amp;
00741         (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread)) {
00742         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
00743         <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(SharedFirstLevel);
00744         ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00745         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00746      }
00747 
00748      <span class="comment">//</span>
00749      <span class="comment">// The fast path could not be used - release the fast lock and take</span>
00750      <span class="comment">// the long way.</span>
00751      <span class="comment">//</span>
00752 
00753      ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00754      <span class="keywordflow">return</span> ExpAcquireResourceSharedLite(Resource, Wait);
00755 }
00756 
00757 <span class="preprocessor">#define ExAcquireResourceSharedLite ExpAcquireResourceSharedLite</span>
00758 <span class="preprocessor"></span>
00759 <span class="preprocessor">#endif</span>
00760 <span class="preprocessor"></span>
00761 BOOLEAN
<a name="l00762"></a><a class="code" href="../../d5/d8/ex_8h.html#a268">00762</a> <a class="code" href="../../d5/d8/ex_8h.html#a268">ExAcquireResourceSharedLite</a>(
00763     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
00764     IN BOOLEAN Wait
00765     )
00766 
00767 <span class="comment">/*++</span>
00768 <span class="comment"></span>
00769 <span class="comment">Routine Description:</span>
00770 <span class="comment"></span>
00771 <span class="comment">    The routine acquires the specified resource for shared access.</span>
00772 <span class="comment"></span>
00773 <span class="comment">Arguments:</span>
00774 <span class="comment"></span>
00775 <span class="comment">    Resource - Supplies a pointer to the resource that is acquired</span>
00776 <span class="comment">        for shared access.</span>
00777 <span class="comment"></span>
00778 <span class="comment">    Wait - A boolean value that specifies whether to wait for the</span>
00779 <span class="comment">        resource to become available if access cannot be granted</span>
00780 <span class="comment">        immediately.</span>
00781 <span class="comment"></span>
00782 <span class="comment">Return Value:</span>
00783 <span class="comment"></span>
00784 <span class="comment">    BOOLEAN - TRUE if the resource is acquired and FALSE otherwise</span>
00785 <span class="comment"></span>
00786 <span class="comment">--*/</span>
00787 
00788 {
00789 
00790     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
00791     KIRQL OldIrql;
00792     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
00793     <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">PKSEMAPHORE</a> Semaphore;
00794 
00795     <span class="comment">//</span>
00796     <span class="comment">// Acquire exclusive access to the specified resource.</span>
00797     <span class="comment">//</span>
00798 
00799     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00800     ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
00801 
00802     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00803     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
00804 
00805     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(SharedSecondLevel);
00806 
00807     <span class="comment">//</span>
00808     <span class="comment">// If the active count of the resource is zero, then there is neither</span>
00809     <span class="comment">// an exclusive owner nor a shared owner and access to the resource can</span>
00810     <span class="comment">// be immediately granted.</span>
00811     <span class="comment">//</span>
00812 
00813     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
00814         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
00815         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
00816         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
00817         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00818         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00819     }
00820 
00821     <span class="comment">//</span>
00822     <span class="comment">// The resource is either owned exclusive or shared.</span>
00823     <span class="comment">//</span>
00824     <span class="comment">// If the resource is owned exclusive and the current thread is the</span>
00825     <span class="comment">// owner, then treat the shared request as an exclusive request and</span>
00826     <span class="comment">// increment the recursion count. Otherwise, it is owned shared.</span>
00827     <span class="comment">//</span>
00828 
00829     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
00830         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
00831             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
00832             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00833             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00834         }
00835 
00836         <span class="comment">//</span>
00837         <span class="comment">// Find an empty entry in the thread array.</span>
00838         <span class="comment">//</span>
00839 
00840         OwnerEntry = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, 0);
00841 
00842     } <span class="keywordflow">else</span> {
00843 
00844         <span class="comment">//</span>
00845         <span class="comment">// The resource is owned shared.</span>
00846         <span class="comment">//</span>
00847         <span class="comment">// If the current thread already has acquired the resource for</span>
00848         <span class="comment">// shared access, then increment the recursion count. Otherwise</span>
00849         <span class="comment">// grant shared access if there are no exclusive waiters.</span>
00850         <span class="comment">//</span>
00851 
00852         OwnerEntry = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, CurrentThread);
00853         <span class="keywordflow">if</span> (OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
00854             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
00855 
00856             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> != 0);
00857 
00858             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00859             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00860         }
00861 
00862         <span class="comment">//</span>
00863         <span class="comment">// If there are no exclusive waiters, then grant shared access</span>
00864         <span class="comment">// to the resource. Otherwise, wait for the resource to become</span>
00865         <span class="comment">// available.</span>
00866         <span class="comment">//</span>
00867 
00868         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00869             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
00870             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
00871             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> += 1;
00872             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00873             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00874         }
00875     }
00876 
00877     <span class="comment">//</span>
00878     <span class="comment">// The resource is either owned exclusive by some other thread, or</span>
00879     <span class="comment">// owned shared by some other threads, but there is an exclusive</span>
00880     <span class="comment">// waiter and the current thread does not already have shared access</span>
00881     <span class="comment">// to the resource.</span>
00882     <span class="comment">//</span>
00883     <span class="comment">// If wait is not specified, then return that the resource was</span>
00884     <span class="comment">// not acquired.</span>
00885     <span class="comment">//</span>
00886 
00887     <span class="keywordflow">if</span> (Wait == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00888         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00889         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00890     }
00891 
00892     <span class="comment">//</span>
00893     <span class="comment">// If the shared wait semaphore has not yet been allocated, then allocate</span>
00894     <span class="comment">// and initialize it.</span>
00895     <span class="comment">//</span>
00896 
00897     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00898         Semaphore = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
00899                                           <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a>),
00900                                           'eSeR');
00901 
00902         <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(Semaphore, 0, MAXLONG);
00903         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> = Semaphore;
00904     }
00905 
00906     <span class="comment">//</span>
00907     <span class="comment">// Wait for shared access to the resource to be granted and increment</span>
00908     <span class="comment">// the recursion count.</span>
00909     <span class="comment">//</span>
00910 
00911     OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
00912     OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
00913     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> += 1;
00914     ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00915     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a11">ExpWaitForResource</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>);
00916     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00917 }
00918 
00919 <span class="preprocessor">#if defined(NT_UP) &amp;&amp; !DBG</span>
00920 <span class="preprocessor"></span>
00921 BOOLEAN
00922 ExpAcquireSharedStarveExclusive(
00923     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
00924     IN BOOLEAN Wait
00925     );
00926 
00927 BOOLEAN
00928 <a class="code" href="../../d5/d8/ex_8h.html#a270">ExAcquireSharedStarveExclusive</a>(
00929     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
00930     IN BOOLEAN Wait
00931     )
00932 
00933 <span class="comment">/*++</span>
00934 <span class="comment"></span>
00935 <span class="comment">Routine Description:</span>
00936 <span class="comment"></span>
00937 <span class="comment">    This routine acquires the specified resource for shared access and</span>
00938 <span class="comment">    does not wait for any pending exclusive owners.</span>
00939 <span class="comment"></span>
00940 <span class="comment">    N.B. This routine uses fast locking.</span>
00941 <span class="comment"></span>
00942 <span class="comment">Arguments:</span>
00943 <span class="comment"></span>
00944 <span class="comment">    Resource - Supplies a pointer to the resource that is acquired</span>
00945 <span class="comment">        for shared access.</span>
00946 <span class="comment"></span>
00947 <span class="comment">    Wait - A boolean value that specifies whether to wait for the</span>
00948 <span class="comment">        resource to become available if access cannot be granted</span>
00949 <span class="comment">        immediately.</span>
00950 <span class="comment"></span>
00951 <span class="comment">Return Value:</span>
00952 <span class="comment"></span>
00953 <span class="comment">    BOOLEAN - TRUE if the resource is acquired and FALSE otherwise</span>
00954 <span class="comment"></span>
00955 <span class="comment">--*/</span>
00956 
00957 {
00958 
00959     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
00960     KIRQL OldIrql;
00961 
00962     <span class="comment">//</span>
00963     <span class="comment">// Acquire exclusive access to the specified resource.</span>
00964     <span class="comment">//</span>
00965 
00966     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00967     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
00968 
00969     <span class="comment">//</span>
00970     <span class="comment">// If the active count of the resource is zero, then there is neither</span>
00971     <span class="comment">// an exclusive owner nor a shared owner and access to the resource can</span>
00972     <span class="comment">// be immediately granted.</span>
00973     <span class="comment">//</span>
00974 
00975     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
00976         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
00977         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
00978         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
00979         <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(StarveFirstLevel);
00980         ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00981         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00982     }
00983 
00984     <span class="comment">//</span>
00985     <span class="comment">// The resource is either owned exclusive or shared.</span>
00986     <span class="comment">//</span>
00987     <span class="comment">// If the resource is owned exclusive and the current thread is the</span>
00988     <span class="comment">// owner, then treat the shared request as an exclusive request and</span>
00989     <span class="comment">// increment the recursion count. Otherwise, it is owned shared.</span>
00990     <span class="comment">//</span>
00991 
00992     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource) &amp;&amp;
00993         (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread)) {
00994         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
00995         <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(StarveFirstLevel);
00996         ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00997         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00998     }
00999 
01000     <span class="comment">//</span>
01001     <span class="comment">// The fast path could not be taken - release the fast lock and take</span>
01002     <span class="comment">// the long way.</span>
01003     <span class="comment">//</span>
01004 
01005     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01006     <span class="keywordflow">return</span> ExpAcquireSharedStarveExclusive(Resource, Wait);
01007 }
01008 
01009 <span class="preprocessor">#define ExAcquireSharedStarveExclusive ExpAcquireSharedStarveExclusive</span>
01010 <span class="preprocessor"></span>
01011 <span class="preprocessor">#endif</span>
01012 <span class="preprocessor"></span>
01013 BOOLEAN
<a name="l01014"></a><a class="code" href="../../d5/d8/ex_8h.html#a270">01014</a> <a class="code" href="../../d5/d8/ex_8h.html#a270">ExAcquireSharedStarveExclusive</a>(
01015     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
01016     IN BOOLEAN Wait
01017     )
01018 <span class="comment">/*++</span>
01019 <span class="comment"></span>
01020 <span class="comment">Routine Description:</span>
01021 <span class="comment"></span>
01022 <span class="comment">    This routine acquires the specified resource for shared access and</span>
01023 <span class="comment">    does not wait for any pending exclusive owners.</span>
01024 <span class="comment"></span>
01025 <span class="comment">Arguments:</span>
01026 <span class="comment"></span>
01027 <span class="comment">    Resource - Supplies a pointer to the resource that is acquired</span>
01028 <span class="comment">        for shared access.</span>
01029 <span class="comment"></span>
01030 <span class="comment">    Wait - A boolean value that specifies whether to wait for the</span>
01031 <span class="comment">        resource to become available if access cannot be granted</span>
01032 <span class="comment">        immediately.</span>
01033 <span class="comment"></span>
01034 <span class="comment">Return Value:</span>
01035 <span class="comment"></span>
01036 <span class="comment">    BOOLEAN - TRUE if the resource is acquired and FALSE otherwise</span>
01037 <span class="comment"></span>
01038 <span class="comment">--*/</span>
01039 
01040 {
01041 
01042     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
01043     KIRQL OldIrql;
01044     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
01045     <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">PKSEMAPHORE</a> Semaphore;
01046 
01047     <span class="comment">//</span>
01048     <span class="comment">// Acquire exclusive access to the specified resource.</span>
01049     <span class="comment">//</span>
01050 
01051     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01052     ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
01053 
01054     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01055     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
01056 
01057     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(StarveSecondLevel);
01058 
01059     <span class="comment">//</span>
01060     <span class="comment">// If the active count of the resource is zero, then there is neither</span>
01061     <span class="comment">// an exclusive owner nor a shared owner and access to the resource can</span>
01062     <span class="comment">// be immediately granted.</span>
01063     <span class="comment">//</span>
01064 
01065     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
01066         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
01067         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01068         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
01069         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01070         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01071     }
01072 
01073     <span class="comment">//</span>
01074     <span class="comment">// The resource is either owned exclusive or shared.</span>
01075     <span class="comment">//</span>
01076     <span class="comment">// If the resource is owned exclusive and the current thread is the</span>
01077     <span class="comment">// owner, then treat the shared request as an exclusive request and</span>
01078     <span class="comment">// increment the recursion count. Otherwise, it is owned shared.</span>
01079     <span class="comment">//</span>
01080 
01081     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
01082         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01083             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
01084             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01085             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01086         }
01087 
01088         <span class="comment">//</span>
01089         <span class="comment">// Find an empty entry in the thread array.</span>
01090         <span class="comment">//</span>
01091 
01092         OwnerEntry = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, 0);
01093 
01094     } <span class="keywordflow">else</span> {
01095 
01096         <span class="comment">//</span>
01097         <span class="comment">// The resource is owned shared.</span>
01098         <span class="comment">//</span>
01099         <span class="comment">// If the current thread already has acquired the resource for</span>
01100         <span class="comment">// shared access, then increment the recursion count. Otherwise</span>
01101         <span class="comment">// grant shared access to the current thread</span>
01102         <span class="comment">//</span>
01103 
01104         OwnerEntry = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, CurrentThread);
01105         <span class="keywordflow">if</span> (OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01106             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
01107 
01108             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> != 0);
01109 
01110             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01111             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01112         }
01113 
01114         <span class="comment">//</span>
01115         <span class="comment">// Grant the current thread shared access to the resource.</span>
01116         <span class="comment">//</span>
01117 
01118         OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
01119         OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01120         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> += 1;
01121         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01122         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01123     }
01124 
01125     <span class="comment">//</span>
01126     <span class="comment">// The resource is owned exclusive by some other thread.</span>
01127     <span class="comment">//</span>
01128     <span class="comment">// If wait is not specified, then return that the resource was</span>
01129     <span class="comment">// not acquired.</span>
01130     <span class="comment">//</span>
01131 
01132     <span class="keywordflow">if</span> (Wait == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01133         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01134         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01135     }
01136 
01137     <span class="comment">//</span>
01138     <span class="comment">// If the shared wait semaphore has not yet been allocated, then allocate</span>
01139     <span class="comment">// and initialize it.</span>
01140     <span class="comment">//</span>
01141 
01142     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01143         Semaphore = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
01144                                           <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a>),
01145                                           'eSeR');
01146 
01147         <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(Semaphore, 0, MAXLONG);
01148         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> = Semaphore;
01149     }
01150 
01151     <span class="comment">//</span>
01152     <span class="comment">// Wait for shared access to the resource to be granted and increment</span>
01153     <span class="comment">// the recursion count.</span>
01154     <span class="comment">//</span>
01155 
01156     OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
01157     OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01158     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> += 1;
01159     ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01160     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a11">ExpWaitForResource</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>);
01161     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01162 }
01163 
01164 BOOLEAN
<a name="l01165"></a><a class="code" href="../../d5/d8/ex_8h.html#a271">01165</a> <a class="code" href="../../d5/d8/ex_8h.html#a271">ExAcquireSharedWaitForExclusive</a>(
01166     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
01167     IN BOOLEAN Wait
01168     )
01169 <span class="comment">/*++</span>
01170 <span class="comment"></span>
01171 <span class="comment">Routine Description:</span>
01172 <span class="comment"></span>
01173 <span class="comment">    This routine acquires the specified resource for shared access, but</span>
01174 <span class="comment">    waits for any pending exclusive owners.</span>
01175 <span class="comment"></span>
01176 <span class="comment">Arguments:</span>
01177 <span class="comment"></span>
01178 <span class="comment">    Resource - Supplies a pointer to the resource that is acquired</span>
01179 <span class="comment">        for shared access.</span>
01180 <span class="comment"></span>
01181 <span class="comment">    Wait - A boolean value that specifies whether to wait for the</span>
01182 <span class="comment">        resource to become available if access cannot be granted</span>
01183 <span class="comment">        immediately.</span>
01184 <span class="comment"></span>
01185 <span class="comment">Return Value:</span>
01186 <span class="comment"></span>
01187 <span class="comment">    BOOLEAN - TRUE if the resource is acquired and FALSE otherwise</span>
01188 <span class="comment"></span>
01189 <span class="comment">--*/</span>
01190 
01191 {
01192 
01193     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
01194     KIRQL OldIrql;
01195     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
01196     <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">PKSEMAPHORE</a> Semaphore;
01197 
01198     <span class="comment">//</span>
01199     <span class="comment">// Acquire exclusive access to the specified resource.</span>
01200     <span class="comment">//</span>
01201 
01202     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01203     ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
01204 
01205     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01206     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
01207 
01208     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(WaitForExclusive);
01209 
01210     <span class="comment">//</span>
01211     <span class="comment">// If the active count of the resource is zero, then there is neither</span>
01212     <span class="comment">// an exclusive owner nor a shared owner and access to the resource can</span>
01213     <span class="comment">// be immediately granted.</span>
01214     <span class="comment">//</span>
01215 
01216     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
01217         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
01218         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01219         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
01220         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01221         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01222     }
01223 
01224     <span class="comment">//</span>
01225     <span class="comment">// The resource is either owned exclusive or shared.</span>
01226     <span class="comment">//</span>
01227     <span class="comment">// If the resource is owned exclusive and the current thread is the</span>
01228     <span class="comment">// owner, then treat the shared request as an exclusive request and</span>
01229     <span class="comment">// increment the recursion count. Otherwise, it is owned shared.</span>
01230     <span class="comment">//</span>
01231 
01232     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
01233         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01234             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
01235             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01236             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01237         }
01238 
01239         <span class="comment">//</span>
01240         <span class="comment">// Find an empty entry in the thread array.</span>
01241         <span class="comment">//</span>
01242 
01243         OwnerEntry = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, 0);
01244 
01245     } <span class="keywordflow">else</span> {
01246 
01247         <span class="comment">//</span>
01248         <span class="comment">// The resource is owned shared.</span>
01249         <span class="comment">//</span>
01250         <span class="comment">// If there is an exclusive waiter, then wait for the exclusive</span>
01251         <span class="comment">// waiter to gain access to the resource, then acquire the resource</span>
01252         <span class="comment">// shared without regard to exclusive waiters. Otherwise, if the</span>
01253         <span class="comment">// current thread already has acquired the resource for shared access,</span>
01254         <span class="comment">// then increment the recursion count. Otherwise grant shared access</span>
01255         <span class="comment">// to the current thread</span>
01256         <span class="comment">//</span>
01257 
01258         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
01259 
01260             <span class="comment">//</span>
01261             <span class="comment">// The resource is shared, but there is an exclusive waiter.</span>
01262             <span class="comment">//</span>
01263             <span class="comment">// If wait is not specified, then return that the resource was</span>
01264             <span class="comment">// not acquired.</span>
01265             <span class="comment">//</span>
01266 
01267             <span class="keywordflow">if</span> (Wait == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01268                 ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01269                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01270             }
01271 
01272             <span class="comment">//</span>
01273             <span class="comment">// If the shared wait semaphore has not yet been allocated, then</span>
01274             <span class="comment">// allocate and initialize it.</span>
01275             <span class="comment">//</span>
01276 
01277             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01278                 Semaphore = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
01279                                                   <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a>),
01280                                                   'eSeR');
01281 
01282                 <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(Semaphore, 0, MAXLONG);
01283                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> = Semaphore;
01284             }
01285 
01286             <span class="comment">//</span>
01287             <span class="comment">// Increment the number of shared waiters and wait for shared</span>
01288             <span class="comment">// access to the resource to be granted to some other set of</span>
01289             <span class="comment">// threads, and then acquire the resource shared without regard</span>
01290             <span class="comment">// to exclusive access.</span>
01291             <span class="comment">//</span>
01292             <span class="comment">// N.B. The resource is left in a state such that the calling</span>
01293             <span class="comment">//      thread does not have a reference in the owner table</span>
01294             <span class="comment">//      for the requested access even though the active count</span>
01295             <span class="comment">//      is incremented when control is returned. However, the</span>
01296             <span class="comment">//      resource is owned shared at this point, so an owner</span>
01297             <span class="comment">//      entry can simply be allocated and the owner count set</span>
01298             <span class="comment">//      to one.</span>
01299             <span class="comment">//</span>
01300 
01301             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> += 1;
01302             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01303             <a class="code" href="../../d8/d8/ex_2resource_8c.html#a11">ExpWaitForResource</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>);
01304 
01305             <span class="comment">//</span>
01306             <span class="comment">// Reacquire the resource spin lock, allocate an owner entry,</span>
01307             <span class="comment">// and initialize the owner count to one. The active count</span>
01308             <span class="comment">// was already incremented when shared access was granted.</span>
01309             <span class="comment">//</span>
01310 
01311             ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
01312 
01313             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01314             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> &gt; 0);
01315 
01316             OwnerEntry = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, CurrentThread);
01317 
01318             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> != CurrentThread);
01319 
01320             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
01321             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01322             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01323             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01324 
01325         } <span class="keywordflow">else</span> {
01326             OwnerEntry = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, CurrentThread);
01327             <span class="keywordflow">if</span> (OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01328                 OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
01329 
01330                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> != 0);
01331 
01332                 ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01333                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01334             }
01335 
01336             <span class="comment">//</span>
01337             <span class="comment">// Grant the current thread shared access to the resource.</span>
01338             <span class="comment">//</span>
01339 
01340             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
01341             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01342             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> += 1;
01343             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01344             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01345         }
01346     }
01347 
01348     <span class="comment">//</span>
01349     <span class="comment">// The resource is owned exclusive by some other thread.</span>
01350     <span class="comment">//</span>
01351     <span class="comment">// If wait is not specified, then return that the resource was</span>
01352     <span class="comment">// not acquired.</span>
01353     <span class="comment">//</span>
01354 
01355     <span class="keywordflow">if</span> (Wait == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01356         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01357         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01358     }
01359 
01360     <span class="comment">//</span>
01361     <span class="comment">// If the shared wait semaphore has not yet been allocated, then allocate</span>
01362     <span class="comment">// and initialize it.</span>
01363     <span class="comment">//</span>
01364 
01365     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01366         Semaphore = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
01367                                           <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a>),
01368                                           'eSeR');
01369 
01370         <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(Semaphore, 0, MAXLONG);
01371         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> = Semaphore;
01372     }
01373 
01374     <span class="comment">//</span>
01375     <span class="comment">// Wait for shared access to the resource to be granted and increment</span>
01376     <span class="comment">// the recursion count.</span>
01377     <span class="comment">//</span>
01378 
01379     OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
01380     OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01381     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> += 1;
01382     ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01383     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a11">ExpWaitForResource</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>);
01384     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01385 }
01386 
01387 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01388 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l01389"></a><a class="code" href="../../d5/d8/ex_8h.html#a273">01389</a> <a class="code" href="../../d5/d8/ex_8h.html#a273">ExReleaseResourceLite</a>(
01390     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
01391     )
01392 
01393 <span class="comment">/*++</span>
01394 <span class="comment"></span>
01395 <span class="comment">Routine Description:</span>
01396 <span class="comment"></span>
01397 <span class="comment">    This routine releases the specified resource for the current thread</span>
01398 <span class="comment">    and decrements the recursion count. If the count reaches zero, then</span>
01399 <span class="comment">    the resource may also be released.</span>
01400 <span class="comment"></span>
01401 <span class="comment">    N.B. This routine uses fast locking.</span>
01402 <span class="comment"></span>
01403 <span class="comment">Arguments:</span>
01404 <span class="comment"></span>
01405 <span class="comment">    Resource - Supplies a pointer to the resource to release.</span>
01406 <span class="comment"></span>
01407 <span class="comment">Return Value:</span>
01408 <span class="comment"></span>
01409 <span class="comment">    None.</span>
01410 <span class="comment"></span>
01411 <span class="comment">--*/</span>
01412 
01413 {
01414 
01415     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
01416     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01417     ULONG Number;
01418     KIRQL OldIrql;
01419     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry, OwnerEnd;
01420 
01421     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01422 
01423     <span class="comment">//</span>
01424     <span class="comment">// Acquire exclusive access to the specified resource.</span>
01425     <span class="comment">//</span>
01426 
01427     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
01428 
01429     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
01430 
01431     <span class="comment">//</span>
01432     <span class="comment">// If the resource is exclusively owned, then release exclusive</span>
01433     <span class="comment">// ownership. Otherwise, release shared ownership.</span>
01434     <span class="comment">//</span>
01435     <span class="comment">// N.B. The two release paths are split since this is such a high</span>
01436     <span class="comment">//      frequency function.</span>
01437     <span class="comment">//</span>
01438 
01439     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
01440 
01441 <span class="comment">//        if (Resource-&gt;OwnerThreads[0].OwnerThread != CurrentThread) {</span>
01442 <span class="comment">//            KeBugCheckEx(RESOURCE_NOT_OWNED,</span>
01443 <span class="comment">//                         (ULONG_PTR)Resource,</span>
01444 <span class="comment">//                         (ULONG_PTR)CurrentThread,</span>
01445 <span class="comment">//                         (ULONG_PTR)Resource-&gt;OwnerTable,</span>
01446 <span class="comment">//                         0x1);</span>
01447 <span class="comment">//        }</span>
01448 
01449         <span class="comment">//</span>
01450         <span class="comment">// Decrement the recursion count and check if ownership can be</span>
01451         <span class="comment">// released.</span>
01452         <span class="comment">//</span>
01453 
01454         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> &gt; 0);
01455 
01456         <span class="keywordflow">if</span> (--<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> != 0) {
01457             ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01458             <span class="keywordflow">return</span>;
01459         }
01460 
01461         <span class="comment">//</span>
01462         <span class="comment">// Clear the owner thread.</span>
01463         <span class="comment">//</span>
01464 
01465         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 0;
01466 
01467         <span class="comment">//</span>
01468         <span class="comment">// The thread recursion count reached zero so decrement the resource</span>
01469         <span class="comment">// active count. If the active count reaches zero, then the resource</span>
01470         <span class="comment">// is no longer owned and an attempt should be made to grant access to</span>
01471         <span class="comment">// another thread.</span>
01472         <span class="comment">//</span>
01473 
01474         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> &gt; 0);
01475 
01476         <span class="keywordflow">if</span> (--<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
01477 
01478             <span class="comment">//</span>
01479             <span class="comment">// If there are shared waiters, then grant shared access to the</span>
01480             <span class="comment">// resource. Otherwise, grant exclusive ownership if there are</span>
01481             <span class="comment">// exclusive waiters.</span>
01482             <span class="comment">//</span>
01483 
01484             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/ex_2resource_8c.html#a1">IsSharedWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
01485                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
01486                 Number = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a>;
01487                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> =  (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)Number;
01488                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> = 0;
01489                 ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01490                 <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>, 0, Number, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01491                 <span class="keywordflow">return</span>;
01492 
01493             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
01494                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 1;
01495                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01496                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
01497                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a> -= 1;
01498                 ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01499                 <a class="code" href="../../d2/d8/eventobj_8c.html#a9">KeSetEventBoostPriority</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>,
01500                                         (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> *)&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>);
01501                 <span class="keywordflow">return</span>;
01502             }
01503 
01504             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
01505         }
01506 
01507     } <span class="keywordflow">else</span> {
01508         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01509             OwnerEntry = &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1];
01510 
01511         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01512             OwnerEntry = &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0];
01513 
01514         } <span class="keywordflow">else</span> {
01515             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = ((<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)(CurrentThread))-&gt;ResourceIndex;
01516             OwnerEntry = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
01517 
01518             <span class="keywordflow">if</span> (OwnerEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01519                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(RESOURCE_NOT_OWNED,
01520                              (ULONG_PTR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>,
01521                              (ULONG_PTR)CurrentThread,
01522                              (ULONG_PTR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>,
01523                              0x2);
01524             }
01525 
01526             <span class="comment">//</span>
01527             <span class="comment">// If the resource hint is not within range or the resource</span>
01528             <span class="comment">// table entry does match the current thread, then search</span>
01529             <span class="comment">// the owner table for a match.</span>
01530             <span class="comment">//</span>
01531 
01532             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>) ||
01533                 (OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> != CurrentThread)) {
01534                 OwnerEnd = &amp;OwnerEntry[OwnerEntry-&gt;TableSize];
01535                 <span class="keywordflow">while</span> (1) {
01536                     OwnerEntry += 1;
01537                     <span class="keywordflow">if</span> (OwnerEntry &gt;= OwnerEnd) {
01538                        <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(RESOURCE_NOT_OWNED,
01539                              (ULONG_PTR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>,
01540                              (ULONG_PTR)CurrentThread,
01541                              (ULONG_PTR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>,
01542                              0x3);
01543                     }
01544                     <span class="keywordflow">if</span> (OwnerEntry-&gt;OwnerThread == CurrentThread) {
01545                         <span class="keywordflow">break</span>;
01546                     }
01547                 };
01548             } <span class="keywordflow">else</span> {
01549                 OwnerEntry = &amp;OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01550             }
01551         }
01552 
01553         <span class="comment">//</span>
01554         <span class="comment">// Decrement the recursion count and check if ownership can be</span>
01555         <span class="comment">// released.</span>
01556         <span class="comment">//</span>
01557 
01558         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread);
01559         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> &gt; 0);
01560 
01561         <span class="keywordflow">if</span> (--OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> != 0) {
01562             ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01563             <span class="keywordflow">return</span>;
01564         }
01565 
01566         <span class="comment">//</span>
01567         <span class="comment">// Clear the owner thread.</span>
01568         <span class="comment">//</span>
01569 
01570         OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 0;
01571 
01572         <span class="comment">//</span>
01573         <span class="comment">// The thread recursion count reached zero so decrement the resource</span>
01574         <span class="comment">// active count. If the active count reaches zero, then the resource</span>
01575         <span class="comment">// is no longer owned and an attempt should be made to grant access to</span>
01576         <span class="comment">// another thread.</span>
01577         <span class="comment">//</span>
01578 
01579         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> &gt; 0);
01580 
01581         <span class="keywordflow">if</span> (--<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
01582 
01583             <span class="comment">//</span>
01584             <span class="comment">// If there are exclusive waiters, then grant exclusive access</span>
01585             <span class="comment">// to the resource.</span>
01586             <span class="comment">//</span>
01587 
01588             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
01589                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> |= <a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
01590                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 1;
01591                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01592                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
01593                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a> -= 1;
01594                 ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01595                 <a class="code" href="../../d2/d8/eventobj_8c.html#a9">KeSetEventBoostPriority</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>,
01596                                         (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> *)&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>);
01597                 <span class="keywordflow">return</span>;
01598             }
01599         }
01600     }
01601 
01602     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01603     <span class="keywordflow">return</span>;
01604 }
01605 
01606 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01607"></a><a class="code" href="../../d5/d8/ex_8h.html#a274">01607</a> <a class="code" href="../../d5/d8/ex_8h.html#a274">ExReleaseResourceForThreadLite</a>(
01608     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
01609     IN ERESOURCE_THREAD CurrentThread
01610     )
01611 
01612 <span class="comment">/*++</span>
01613 <span class="comment"></span>
01614 <span class="comment">Routine Description:</span>
01615 <span class="comment"></span>
01616 <span class="comment">    This routine release the specified resource for the specified thread</span>
01617 <span class="comment">    and decrements the recursion count. If the count reaches zero, then</span>
01618 <span class="comment">    the resource may also be released.</span>
01619 <span class="comment"></span>
01620 <span class="comment">    N.B. This routine uses fast locking.</span>
01621 <span class="comment"></span>
01622 <span class="comment">Arguments:</span>
01623 <span class="comment"></span>
01624 <span class="comment">    Resource - Supplies a pointer to the resource to release.</span>
01625 <span class="comment"></span>
01626 <span class="comment">    Thread - Supplies the thread that originally acquired the resource.</span>
01627 <span class="comment"></span>
01628 <span class="comment">Return Value:</span>
01629 <span class="comment"></span>
01630 <span class="comment">    None.</span>
01631 <span class="comment"></span>
01632 <span class="comment">--*/</span>
01633 
01634 {
01635 
01636     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01637     ULONG Number;
01638     KIRQL OldIrql;
01639     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
01640 
01641     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CurrentThread != 0);
01642 
01643     <span class="comment">//</span>
01644     <span class="comment">// Acquire exclusive access to the specified resource.</span>
01645     <span class="comment">//</span>
01646 
01647     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
01648 
01649     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
01650 
01651     <span class="comment">//</span>
01652     <span class="comment">// If the resource is exclusively owned, then release exclusive</span>
01653     <span class="comment">// ownership. Otherwise, release shared ownership.</span>
01654     <span class="comment">//</span>
01655     <span class="comment">// N.B. The two release paths are split since this is such a high</span>
01656     <span class="comment">//      frequency function.</span>
01657     <span class="comment">//</span>
01658 
01659     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
01660 
01661         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread);
01662 
01663         <span class="comment">//</span>
01664         <span class="comment">// Decrement the recursion count and check if ownership can be</span>
01665         <span class="comment">// released.</span>
01666         <span class="comment">//</span>
01667 
01668         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> &gt; 0);
01669 
01670         <span class="keywordflow">if</span> (--<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> != 0) {
01671             ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01672             <span class="keywordflow">return</span>;
01673         }
01674 
01675         <span class="comment">//</span>
01676         <span class="comment">// Clear the owner thread.</span>
01677         <span class="comment">//</span>
01678 
01679         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 0;
01680 
01681         <span class="comment">//</span>
01682         <span class="comment">// The thread recursion count reached zero so decrement the resource</span>
01683         <span class="comment">// active count. If the active count reaches zero, then the resource</span>
01684         <span class="comment">// is no longer owned and an attempt should be made to grant access to</span>
01685         <span class="comment">// another thread.</span>
01686         <span class="comment">//</span>
01687 
01688         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> &gt; 0);
01689 
01690         <span class="keywordflow">if</span> (--<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
01691 
01692             <span class="comment">//</span>
01693             <span class="comment">// If there are shared waiters, then grant shared access to the</span>
01694             <span class="comment">// resource. Otherwise, grant exclusive ownership if there are</span>
01695             <span class="comment">// exclusive waiters.</span>
01696             <span class="comment">//</span>
01697 
01698             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/ex_2resource_8c.html#a1">IsSharedWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
01699                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
01700                 Number = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a>;
01701                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> =  (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)Number;
01702                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> = 0;
01703                 ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01704                 <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>, 0, Number, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01705                 <span class="keywordflow">return</span>;
01706 
01707             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
01708                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 1;
01709                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01710                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
01711                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a> -= 1;
01712                 ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01713                 <a class="code" href="../../d2/d8/eventobj_8c.html#a9">KeSetEventBoostPriority</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>,
01714                                         (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> *)&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>);
01715                 <span class="keywordflow">return</span>;
01716             }
01717 
01718             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
01719         }
01720 
01721     } <span class="keywordflow">else</span> {
01722         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01723             OwnerEntry = &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1];
01724 
01725         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01726             OwnerEntry = &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0];
01727 
01728         } <span class="keywordflow">else</span> {
01729 
01730             <span class="comment">//</span>
01731             <span class="comment">// If the specified current thread is an owner address (low</span>
01732             <span class="comment">// bits are nonzero), then set the hint index to the first</span>
01733             <span class="comment">// entry. Otherwise, set the hint index from the owner thread.</span>
01734             <span class="comment">//</span>
01735 
01736             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;
01737             <span class="keywordflow">if</span> (((ULONG)CurrentThread &amp; 3) == 0) {
01738                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = ((<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)(CurrentThread))-&gt;ResourceIndex;
01739             }
01740 
01741             OwnerEntry = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
01742 
01743             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01744 
01745             <span class="comment">//</span>
01746             <span class="comment">// If the resource hint is not within range or the resource</span>
01747             <span class="comment">// table entry does match the current thread, then search</span>
01748             <span class="comment">// the owner table for a match.</span>
01749             <span class="comment">//</span>
01750 
01751             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>) ||
01752                 (OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> != CurrentThread)) {
01753                 <span class="keywordflow">do</span> {
01754                     OwnerEntry += 1;
01755                     <span class="keywordflow">if</span> (OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01756                         <span class="keywordflow">break</span>;
01757                     }
01758 
01759                 } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01760 
01761             } <span class="keywordflow">else</span> {
01762                 OwnerEntry = &amp;OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01763             }
01764         }
01765 
01766         <span class="comment">//</span>
01767         <span class="comment">// Decrement the recursion count and check if ownership can be</span>
01768         <span class="comment">// released.</span>
01769         <span class="comment">//</span>
01770 
01771         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread);
01772         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> &gt; 0);
01773 
01774         <span class="keywordflow">if</span> (--OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> != 0) {
01775             ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01776             <span class="keywordflow">return</span>;
01777         }
01778 
01779         <span class="comment">//</span>
01780         <span class="comment">// Clear the owner thread.</span>
01781         <span class="comment">//</span>
01782 
01783         OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 0;
01784 
01785         <span class="comment">//</span>
01786         <span class="comment">// The thread recursion count reached zero so decrement the resource</span>
01787         <span class="comment">// active count. If the active count reaches zero, then the resource</span>
01788         <span class="comment">// is no longer owned and an attempt should be made to grant access to</span>
01789         <span class="comment">// another thread.</span>
01790         <span class="comment">//</span>
01791 
01792         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> &gt; 0);
01793 
01794         <span class="keywordflow">if</span> (--<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
01795 
01796             <span class="comment">//</span>
01797             <span class="comment">// If there are exclusive waiters, then grant exclusive access</span>
01798             <span class="comment">// to the resource.</span>
01799             <span class="comment">//</span>
01800 
01801             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
01802                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> |= <a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
01803                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 1;
01804                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01805                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
01806                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a> -= 1;
01807                 ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01808                 <a class="code" href="../../d2/d8/eventobj_8c.html#a9">KeSetEventBoostPriority</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>,
01809                                         (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> *)&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>);
01810                 <span class="keywordflow">return</span>;
01811             }
01812         }
01813     }
01814 
01815     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01816     <span class="keywordflow">return</span>;
01817 }
01818 
01819 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01820"></a><a class="code" href="../../d5/d8/ex_8h.html#a275">01820</a> <a class="code" href="../../d5/d8/ex_8h.html#a275">ExSetResourceOwnerPointer</a>(
01821     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
01822     IN PVOID OwnerPointer
01823     )
01824 
01825 <span class="comment">/*++</span>
01826 <span class="comment"></span>
01827 <span class="comment">Routine Description:</span>
01828 <span class="comment"></span>
01829 <span class="comment">    This routine locates the owner entry for the current thread and stores</span>
01830 <span class="comment">    the specified owner address as the owner thread. Subsequent to calling</span>
01831 <span class="comment">    this routine, the only routine which may be called for this resource is</span>
01832 <span class="comment">    ExReleaseResourceForThread, supplying the owner address as the "thread".</span>
01833 <span class="comment"></span>
01834 <span class="comment">    Owner addresses must obey the following rules:</span>
01835 <span class="comment"></span>
01836 <span class="comment">        They must be a unique pointer to a structure allocated in system space,</span>
01837 <span class="comment">        and they must point to a structure which remains allocated until after</span>
01838 <span class="comment">        the call to ExReleaseResourceForThread. This is to eliminate aliasing</span>
01839 <span class="comment">        with a thread or other owner address.</span>
01840 <span class="comment"></span>
01841 <span class="comment">        The low order two bits of the owner address must be set by the caller,</span>
01842 <span class="comment">        so that other routines in the resource package can distinguish owner</span>
01843 <span class="comment">        address from thread addresses.</span>
01844 <span class="comment"></span>
01845 <span class="comment">    N.B. This routine uses fast locking.</span>
01846 <span class="comment"></span>
01847 <span class="comment">Arguments:</span>
01848 <span class="comment"></span>
01849 <span class="comment">    Resource - Supplies a pointer to the resource to release.</span>
01850 <span class="comment"></span>
01851 <span class="comment">    OwnerPointer - Supplies a pointer to an allocated structure with the low</span>
01852 <span class="comment">        order two bits set.</span>
01853 <span class="comment"></span>
01854 <span class="comment">Return Value:</span>
01855 <span class="comment"></span>
01856 <span class="comment">    None.</span>
01857 <span class="comment"></span>
01858 <span class="comment">--*/</span>
01859 
01860 {
01861 
01862     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
01863     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01864     KIRQL OldIrql;
01865     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
01866 
01867     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((OwnerPointer != 0) &amp;&amp; (((ULONG_PTR)OwnerPointer &amp; 3) == 3));
01868 
01869     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01870 
01871     <span class="comment">//</span>
01872     <span class="comment">// Acquire exclusive access to the specified resource.</span>
01873     <span class="comment">//</span>
01874 
01875     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
01876 
01877     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
01878 
01879     <span class="comment">//</span>
01880     <span class="comment">// If the resource is exclusively owned, then it is the first owner entry.</span>
01881     <span class="comment">//</span>
01882 
01883     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
01884 
01885         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread);
01886 
01887         <span class="comment">//</span>
01888         <span class="comment">// Set the owner address.</span>
01889         <span class="comment">//</span>
01890 
01891         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> &gt; 0);
01892 
01893         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = (ULONG_PTR)OwnerPointer;
01894 
01895     <span class="comment">//</span>
01896     <span class="comment">//  For shared access we have to search for the current thread to set</span>
01897     <span class="comment">//  the owner address.</span>
01898     <span class="comment">//</span>
01899 
01900     } <span class="keywordflow">else</span> {
01901         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01902             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = (ULONG_PTR)OwnerPointer;
01903 
01904         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01905             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = (ULONG_PTR)OwnerPointer;
01906 
01907         } <span class="keywordflow">else</span> {
01908             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = ((<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)(CurrentThread))-&gt;ResourceIndex;
01909             OwnerEntry = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
01910 
01911             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01912 
01913             <span class="comment">//</span>
01914             <span class="comment">// If the resource hint is not within range or the resource</span>
01915             <span class="comment">// table entry does match the current thread, then search</span>
01916             <span class="comment">// the owner table for a match.</span>
01917             <span class="comment">//</span>
01918 
01919             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>) ||
01920                 (OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> != CurrentThread)) {
01921                 <span class="keywordflow">do</span> {
01922                     OwnerEntry += 1;
01923                     <span class="keywordflow">if</span> (OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01924                         <span class="keywordflow">break</span>;
01925                     }
01926 
01927                 } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01928 
01929             } <span class="keywordflow">else</span> {
01930                 OwnerEntry = &amp;OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01931             }
01932 
01933             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = (ULONG_PTR)OwnerPointer;
01934         }
01935     }
01936 
01937     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01938     <span class="keywordflow">return</span>;
01939 }
01940 
01941 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01942"></a><a class="code" href="../../d5/d8/ex_8h.html#a276">01942</a> <a class="code" href="../../d5/d8/ex_8h.html#a276">ExConvertExclusiveToSharedLite</a>(
01943     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
01944     )
01945 
01946 <span class="comment">/*++</span>
01947 <span class="comment"></span>
01948 <span class="comment">Routine Description:</span>
01949 <span class="comment"></span>
01950 <span class="comment">    This routine converts the specified resource from acquired for exclusive</span>
01951 <span class="comment">    access to acquired for shared access.</span>
01952 <span class="comment"></span>
01953 <span class="comment">    N.B. This routine uses fast locking.</span>
01954 <span class="comment"></span>
01955 <span class="comment">Arguments:</span>
01956 <span class="comment"></span>
01957 <span class="comment">    Resource - Supplies a pointer to the resource to acquire for shared access. it</span>
01958 <span class="comment"></span>
01959 <span class="comment">Return Value:</span>
01960 <span class="comment"></span>
01961 <span class="comment">    None.</span>
01962 <span class="comment"></span>
01963 <span class="comment">--*/</span>
01964 
01965 {
01966 
01967     ULONG Number;
01968     KIRQL OldIrql;
01969 
01970     <span class="comment">//</span>
01971     <span class="comment">// Acquire exclusive access to the specified resource.</span>
01972     <span class="comment">//</span>
01973 
01974     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
01975 
01976     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01977     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
01978     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>));
01979     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>());
01980 
01981     <span class="comment">//</span>
01982     <span class="comment">// Convert the granted access from exclusive to shared.</span>
01983     <span class="comment">//</span>
01984 
01985     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
01986 
01987     <span class="comment">//</span>
01988     <span class="comment">// If there are any shared waiters, then grant them shared access.</span>
01989     <span class="comment">//</span>
01990 
01991     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/ex_2resource_8c.html#a1">IsSharedWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
01992         Number = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a>;
01993         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> +=  (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)Number;
01994         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> = 0;
01995         ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01996         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>, 0, Number, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01997         <span class="keywordflow">return</span>;
01998     }
01999 
02000     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
02001     <span class="keywordflow">return</span>;
02002 }
02003 
02004 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02005"></a><a class="code" href="../../d5/d8/ex_8h.html#a277">02005</a> <a class="code" href="../../d5/d8/ex_8h.html#a277">ExDeleteResourceLite</a>(
02006     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
02007     )
02008 
02009 <span class="comment">/*++</span>
02010 <span class="comment"></span>
02011 <span class="comment">Routine Description:</span>
02012 <span class="comment"></span>
02013 <span class="comment">    This routine deallocates any pool allocated to support the specified</span>
02014 <span class="comment">    resource.</span>
02015 <span class="comment"></span>
02016 <span class="comment"></span>
02017 <span class="comment">Arguments:</span>
02018 <span class="comment"></span>
02019 <span class="comment">    Resource - Supplies a pointer to the resource whose allocated pool</span>
02020 <span class="comment">        is freed.</span>
02021 <span class="comment"></span>
02022 <span class="comment">Return Value:</span>
02023 <span class="comment"></span>
02024 <span class="comment">    STATUS_SUCCESS.</span>
02025 <span class="comment"></span>
02026 <span class="comment">--*/</span>
02027 
02028 {
02029 
02030     <a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html">PRESOURCE_HASH_ENTRY</a> HashEntry;
02031     ULONG Hash;
02032     <a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html">PRESOURCE_HASH_ENTRY</a> MatchEntry;
02033     PLIST_ENTRY NextEntry;
02034     KIRQL OldIrql;
02035 
02036     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d8/ex_2resource_8c.html#a1">IsSharedWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02037     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02038 
02039     <span class="comment">//</span>
02040     <span class="comment">// Acquire the executive resource spinlock and remove the resource from</span>
02041     <span class="comment">// the system resource list.</span>
02042     <span class="comment">//</span>
02043 
02044     ExAcquireSpinLock(&amp;<a class="code" href="../../d8/d8/ex_2resource_8c.html#a9">ExpResourceSpinLock</a>, &amp;OldIrql);
02045 
02046     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02047     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
02048 
02049     RemoveEntryList(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o0">SystemResourcesList</a>);
02050 
02051 <span class="preprocessor">#if defined(_COLLECT_RESOURCE_DATA_)</span>
02052 <span class="preprocessor"></span>
02053     <span class="comment">//</span>
02054     <span class="comment">// Lookup resource initialization address in resource hash table. If</span>
02055     <span class="comment">// the address does not exist in the table, then create a new entry.</span>
02056     <span class="comment">//</span>
02057 
02058     Hash = (ULONG)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o10">Address</a>;
02059     Hash = ((Hash &gt; 24) ^ (Hash &gt; 16) ^ (Hash &gt; 8) ^ (Hash)) &amp; (<a class="code" href="../../d5/d8/ex_8h.html#a65">RESOURCE_HASH_TABLE_SIZE</a> - 1);
02060     MatchEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02061     NextEntry = ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o10">HashTable</a>[Hash].Flink;
02062     <span class="keywordflow">while</span> (NextEntry != &amp;ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o10">HashTable</a>[Hash]) {
02063         HashEntry = CONTAINING_RECORD(NextEntry,
02064                                       <a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html">RESOURCE_HASH_ENTRY</a>,
02065                                       ListEntry);
02066 
02067         <span class="keywordflow">if</span> (HashEntry-&gt;<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html#o1">Address</a> == <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o10">Address</a>) {
02068             MatchEntry = HashEntry;
02069             <span class="keywordflow">break</span>;
02070         }
02071 
02072         NextEntry = NextEntry-&gt;Flink;
02073     }
02074 
02075     <span class="comment">//</span>
02076     <span class="comment">// If a matching initialization address was found, then update the call</span>
02077     <span class="comment">// site statistics. Otherwise, allocate a new hash entry and initialize</span>
02078     <span class="comment">// call site statistics.</span>
02079     <span class="comment">//</span>
02080 
02081     <span class="keywordflow">if</span> (MatchEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02082         MatchEntry-&gt;<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html#o2">ContentionCount</a> += <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a>;
02083         MatchEntry-&gt;<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html#o3">Number</a> += 1;
02084 
02085     } <span class="keywordflow">else</span> {
02086         MatchEntry = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02087                                           <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html">RESOURCE_HASH_ENTRY</a>),
02088                                           'vEpR');
02089 
02090         <span class="keywordflow">if</span> (MatchEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02091             MatchEntry-&gt;<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html#o1">Address</a> = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o10">Address</a>;
02092             MatchEntry-&gt;<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html#o2">ContentionCount</a> = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a>;
02093             MatchEntry-&gt;<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html#o3">Number</a> = 1;
02094             InsertTailList(&amp;ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o10">HashTable</a>[Hash],
02095                            &amp;MatchEntry-&gt;<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html#o0">ListEntry</a>);
02096         }
02097     }
02098 
02099     ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o0">ActiveResourceCount</a> -= 1;
02100 
02101 <span class="preprocessor">#endif</span>
02102 <span class="preprocessor"></span>
02103     ExReleaseSpinLock(&amp;<a class="code" href="../../d8/d8/ex_2resource_8c.html#a9">ExpResourceSpinLock</a>, OldIrql);
02104 
02105     <span class="comment">//</span>
02106     <span class="comment">// If an owner table was allocated, then free it to pool.</span>
02107     <span class="comment">//</span>
02108 
02109     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02110         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>);
02111     }
02112 
02113     <span class="comment">//</span>
02114     <span class="comment">// If a semaphore was allocated, then free it to pool.</span>
02115     <span class="comment">//</span>
02116 
02117     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>) {
02118         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>);
02119     }
02120 
02121     <span class="comment">//</span>
02122     <span class="comment">// If an event was allocated, then free it to pool.</span>
02123     <span class="comment">//</span>
02124 
02125     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>) {
02126         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>);
02127     }
02128 
02129     <span class="keywordflow">return</span> STATUS_SUCCESS;
02130 }
02131 
02132 ULONG
<a name="l02133"></a><a class="code" href="../../d5/d8/ex_8h.html#a278">02133</a> <a class="code" href="../../d5/d8/ex_8h.html#a278">ExGetExclusiveWaiterCount</a>(
02134     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
02135     )
02136 
02137 <span class="comment">/*++</span>
02138 <span class="comment"></span>
02139 <span class="comment">Routine Description:</span>
02140 <span class="comment"></span>
02141 <span class="comment">    This routine returns the exclusive waiter count.</span>
02142 <span class="comment"></span>
02143 <span class="comment"></span>
02144 <span class="comment">Arguments:</span>
02145 <span class="comment"></span>
02146 <span class="comment">    Resource - Supplies a pointer to and executive resource.</span>
02147 <span class="comment"></span>
02148 <span class="comment">Return Value:</span>
02149 <span class="comment"></span>
02150 <span class="comment">    The current number of exclusive waiters is returned as the function</span>
02151 <span class="comment">    value.</span>
02152 <span class="comment"></span>
02153 <span class="comment">--*/</span>
02154 
02155 {
02156     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a>;
02157 }
02158 
02159 ULONG
<a name="l02160"></a><a class="code" href="../../d5/d8/ex_8h.html#a279">02160</a> <a class="code" href="../../d5/d8/ex_8h.html#a279">ExGetSharedWaiterCount</a>(
02161     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
02162     )
02163 
02164 <span class="comment">/*++</span>
02165 <span class="comment"></span>
02166 <span class="comment">Routine Description:</span>
02167 <span class="comment"></span>
02168 <span class="comment">    This routine returns the shared waiter count.</span>
02169 <span class="comment"></span>
02170 <span class="comment"></span>
02171 <span class="comment">Arguments:</span>
02172 <span class="comment"></span>
02173 <span class="comment">    Resource - Supplies a pointer to and executive resource.</span>
02174 <span class="comment"></span>
02175 <span class="comment">Return Value:</span>
02176 <span class="comment"></span>
02177 <span class="comment">    The current number of shared waiters is returned as the function</span>
02178 <span class="comment">    value.</span>
02179 <span class="comment"></span>
02180 <span class="comment">--*/</span>
02181 
02182 {
02183     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a>;
02184 }
02185 
02186 BOOLEAN
<a name="l02187"></a><a class="code" href="../../d5/d8/ex_8h.html#a281">02187</a> <a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(
02188     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
02189     )
02190 
02191 <span class="comment">/*++</span>
02192 <span class="comment"></span>
02193 <span class="comment">Routine Description:</span>
02194 <span class="comment"></span>
02195 <span class="comment">    This routine determines if a resource is acquired exclusive by the</span>
02196 <span class="comment">    calling thread.</span>
02197 <span class="comment"></span>
02198 <span class="comment">Arguments:</span>
02199 <span class="comment"></span>
02200 <span class="comment">    Resource - Supplies a pointer the resource to query.</span>
02201 <span class="comment"></span>
02202 <span class="comment">Return Value:</span>
02203 <span class="comment"></span>
02204 <span class="comment">    If the current thread has acquired the resource exclusive, a value of</span>
02205 <span class="comment">    TRUE is returned. Otherwise, a value of FALSE is returned.</span>
02206 <span class="comment"></span>
02207 <span class="comment">--*/</span>
02208 
02209 {
02210 
02211     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
02212     KIRQL OldIrql;
02213     BOOLEAN Result;
02214 
02215     <span class="comment">//</span>
02216     <span class="comment">// Acquire exclusive access to the specified resource.</span>
02217     <span class="comment">//</span>
02218 
02219     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
02220     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
02221 
02222     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
02223 
02224     <span class="comment">//</span>
02225     <span class="comment">// If the resource is owned exclusive and the current thread is the</span>
02226     <span class="comment">// owner, then set the return value of TRUE. Otherwise, set the return</span>
02227     <span class="comment">// value to FALSE.</span>
02228     <span class="comment">//</span>
02229 
02230     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02231     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) &amp;&amp;
02232         (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread)) {
02233         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02234     }
02235 
02236     <span class="comment">//</span>
02237     <span class="comment">// Release exclusive access to the specified resource.</span>
02238     <span class="comment">//</span>
02239 
02240     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
02241     <span class="keywordflow">return</span> Result;
02242 }
02243 
02244 ULONG
<a name="l02245"></a><a class="code" href="../../d5/d8/ex_8h.html#a282">02245</a> <a class="code" href="../../d5/d8/ex_8h.html#a282">ExIsResourceAcquiredSharedLite</a>(
02246     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
02247     )
02248 
02249 <span class="comment">/*++</span>
02250 <span class="comment"></span>
02251 <span class="comment">Routine Description:</span>
02252 <span class="comment"></span>
02253 <span class="comment">    This routine determines if a resource is acquired either shared or</span>
02254 <span class="comment">    exclusive by the calling thread.</span>
02255 <span class="comment"></span>
02256 <span class="comment">Arguments:</span>
02257 <span class="comment"></span>
02258 <span class="comment">    Resource - Supplies a pointer to the resource to query.</span>
02259 <span class="comment"></span>
02260 <span class="comment">Return Value:</span>
02261 <span class="comment"></span>
02262 <span class="comment">    If the current thread has not acquired the resource a value of zero</span>
02263 <span class="comment">    is returned. Otherwise, the thread's acquire count is returned.</span>
02264 <span class="comment"></span>
02265 <span class="comment">--*/</span>
02266 
02267 {
02268 
02269     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
02270     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02271     ULONG Number;
02272     KIRQL OldIrql;
02273     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
02274     ULONG Result;
02275 
02276     <span class="comment">//</span>
02277     <span class="comment">// Acquire exclusive access to the specified resource.</span>
02278     <span class="comment">//</span>
02279 
02280     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
02281     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
02282 
02283     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
02284 
02285     <span class="comment">//</span>
02286     <span class="comment">// Find the current thread in the thread array and return the count.</span>
02287     <span class="comment">//</span>
02288     <span class="comment">// N.B. If the thread is not found a value of zero will be returned.</span>
02289     <span class="comment">//</span>
02290 
02291     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
02292         Result = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a>;
02293 
02294     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
02295         Result = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a>;
02296 
02297     } <span class="keywordflow">else</span> {
02298 
02299         <span class="comment">//</span>
02300         <span class="comment">// If the resource hint is not within range or the resource table</span>
02301         <span class="comment">// entry does not match the current thread, then search the owner</span>
02302         <span class="comment">// table for a match.</span>
02303         <span class="comment">//</span>
02304 
02305         OwnerEntry = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
02306         Result = 0;
02307         <span class="keywordflow">if</span> (OwnerEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02308             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = ((<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)(CurrentThread))-&gt;ResourceIndex;
02309             Number = OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>;
02310             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= Number) ||
02311                 (OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> != CurrentThread)) {
02312                 <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Number; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
02313                     OwnerEntry += 1;
02314                     <span class="keywordflow">if</span> (OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
02315                         Result = OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a>;
02316                         <span class="keywordflow">break</span>;
02317                     }
02318                 }
02319 
02320             } <span class="keywordflow">else</span> {
02321                 Result = OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a>;
02322             }
02323         }
02324     }
02325 
02326     <span class="comment">//</span>
02327     <span class="comment">// Release exclusive access to the specified resource.</span>
02328     <span class="comment">//</span>
02329 
02330     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
02331     <span class="keywordflow">return</span> Result;
02332 }
02333 
02334 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02335"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a32">02335</a> <a class="code" href="../../d8/d8/ex_2resource_8c.html#a32">ExQuerySystemLockInformation</a>(
02336     OUT PRTL_PROCESS_LOCKS LockInformation,
02337     IN ULONG LockInformationLength,
02338     OUT PULONG ReturnLength OPTIONAL
02339     )
02340 
02341 {
02342 
02343     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02344     KIRQL OldIrql;
02345     ULONG RequiredLength;
02346     PLIST_ENTRY Head, Next;
02347     PRTL_PROCESS_LOCK_INFORMATION LockInfo;
02348     <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
02349     <a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a> NtDdkResource;
02350     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> OwningThread;
02351 
02352     RequiredLength = FIELD_OFFSET(RTL_PROCESS_LOCKS, Locks);
02353     <span class="keywordflow">if</span> (LockInformationLength &lt; RequiredLength) {
02354         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
02355 
02356     } <span class="keywordflow">else</span> {
02357         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02358         ExAcquireSpinLock(&amp;<a class="code" href="../../d8/d8/ex_2resource_8c.html#a9">ExpResourceSpinLock</a>, &amp;OldIrql);
02359         <span class="keywordflow">try</span> {
02360             LockInformation-&gt;NumberOfLocks = 0;
02361             LockInfo = &amp;LockInformation-&gt;Locks[0];
02362             Head = &amp;<a class="code" href="../../d7/d4/ddkresrc_8c.html#a17">ExpSystemResourcesList</a>;
02363             Next = Head-&gt;Flink;
02364             <span class="keywordflow">while</span> (Next != Head) {
02365                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = CONTAINING_RECORD(Next,
02366                                              <a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>,
02367                                              SystemResourcesList);
02368 
02369                 LockInformation-&gt;NumberOfLocks += 1;
02370                 RequiredLength += <span class="keyword">sizeof</span>(RTL_PROCESS_LOCK_INFORMATION);
02371 
02372                 <span class="comment">//</span>
02373                 <span class="comment">// Detect if this is an NtDdk resource. New lite resources</span>
02374                 <span class="comment">// never contain pointers to themselves.</span>
02375                 <span class="comment">//</span>
02376 
02377                 NtDdkResource = (<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a>)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
02378                 <span class="keywordflow">if</span> (NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o1">OwnerThreads</a> != &amp;NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o8">InitialOwnerThreads</a>[0]) {
02379                     NtDdkResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02380                 }
02381 
02382                 <span class="keywordflow">if</span> (LockInformationLength &lt; RequiredLength) {
02383                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
02384 
02385                 } <span class="keywordflow">else</span> {
02386                     LockInfo-&gt;Address = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
02387                     LockInfo-&gt;Type = RTL_RESOURCE_TYPE;
02388                     LockInfo-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o11">CreatorBackTraceIndex</a> = 0;
02389 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
02390 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (NtDdkResource) {
02391                         LockInfo-&gt;CreatorBackTraceIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o16">CreatorBackTraceIndex</a>;
02392                     } <span class="keywordflow">else</span> {
02393                         LockInfo-&gt;CreatorBackTraceIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o11">CreatorBackTraceIndex</a>;
02394                     }
02395 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
02396 <span class="preprocessor"></span>
02397                     <span class="keywordflow">if</span> (NtDdkResource) {
02398                         <span class="keywordflow">if</span> ((NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o1">OwnerThreads</a>[0] != 0) &amp;&amp;
02399                             ((NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o1">OwnerThreads</a>[0] &amp; 3) == 0)) {
02400                             OwningThread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o1">OwnerThreads</a>[0]);
02401                             LockInfo-&gt;OwningThread = OwningThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread;
02402 
02403                         } <span class="keywordflow">else</span> {
02404                             LockInfo-&gt;OwningThread = 0;
02405                         }
02406 
02407                         LockInfo-&gt;LockCount = NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o4">ActiveCount</a>;
02408                         LockInfo-&gt;ContentionCount = NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o10">ContentionCount</a>;
02409                         LockInfo-&gt;NumberOfWaitingShared = NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o12">NumberOfSharedWaiters</a>;
02410                         LockInfo-&gt;NumberOfWaitingExclusive = NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o11">NumberOfExclusiveWaiters</a>;
02411 
02412                     } <span class="keywordflow">else</span> {
02413                         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> != 0) &amp;&amp;
02414                             ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> &amp; 3) == 0)) {
02415                             OwningThread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>);
02416                             LockInfo-&gt;OwningThread = OwningThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread;
02417 
02418                         } <span class="keywordflow">else</span> {
02419                             LockInfo-&gt;OwningThread = 0;
02420                         }
02421 
02422                         LockInfo-&gt;LockCount = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a>;
02423                         LockInfo-&gt;ContentionCount = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a>;
02424                         LockInfo-&gt;NumberOfWaitingShared = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a>;
02425                         LockInfo-&gt;NumberOfWaitingExclusive = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a>;
02426                     }
02427 
02428                     LockInfo += 1;
02429                 }
02430 
02431                 <span class="keywordflow">if</span> (Next == Next-&gt;Flink) {
02432                     Next = Head;
02433 
02434                 } <span class="keywordflow">else</span> {
02435                     Next = Next-&gt;Flink;
02436                 }
02437             }
02438 
02439         } finally {
02440             ExReleaseSpinLock(&amp;<a class="code" href="../../d8/d8/ex_2resource_8c.html#a9">ExpResourceSpinLock</a>, OldIrql);
02441         }
02442     }
02443 
02444     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
02445         *ReturnLength = RequiredLength;
02446     }
02447 
02448     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02449 }
02450 
02451 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02452 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l02453"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a33">02453</a> <a class="code" href="../../d8/d8/ex_2resource_8c.html#a33">ExpBoostOwnerThread</a> (
02454     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> CurrentThread,
02455     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> OwnerThread
02456     )
02457 <span class="comment">/*++</span>
02458 <span class="comment"></span>
02459 <span class="comment">Routine Description:</span>
02460 <span class="comment"></span>
02461 <span class="comment">    This function boots the priority of the specified owner thread iff</span>
02462 <span class="comment">    its priority is less than that of the current thread and is also</span>
02463 <span class="comment">    less than fourteen.</span>
02464 <span class="comment"></span>
02465 <span class="comment">    N.B. this function is called with the dispatcher database lock held.</span>
02466 <span class="comment"></span>
02467 <span class="comment">Arguments:</span>
02468 <span class="comment"></span>
02469 <span class="comment">    CurrentThread - Supplies a pointer to the current thread object.</span>
02470 <span class="comment"></span>
02471 <span class="comment">    OwnerThread - Supplies a pointer to the owner thread object.</span>
02472 <span class="comment"></span>
02473 <span class="comment">Return Value:</span>
02474 <span class="comment"></span>
02475 <span class="comment">    None.</span>
02476 <span class="comment"></span>
02477 <span class="comment">--*/</span>
02478 
02479 {
02480 
02481     <span class="comment">//</span>
02482     <span class="comment">// If the owner thread is lower priority than the current thread, the</span>
02483     <span class="comment">// current thread is running at a priority less than 14, then boost the</span>
02484     <span class="comment">// priority of the owner thread for a quantum.</span>
02485     <span class="comment">//</span>
02486     <span class="comment">// N.B. A thread that has already been boosted may be reboosted to allow</span>
02487     <span class="comment">//      it to execute and release resources. When the boost is removed,</span>
02488     <span class="comment">//      the thread will return to its priority before any boosting.</span>
02489     <span class="comment">//</span>
02490 
02491     <span class="keywordflow">if</span> (((ULONG_PTR)OwnerThread &amp; 0x3) == 0) {
02492         <span class="keywordflow">if</span> ((OwnerThread-&gt;Priority &lt; CurrentThread-&gt;Priority) &amp;&amp;
02493             (OwnerThread-&gt;Priority &lt; 14)) {
02494             OwnerThread-&gt;PriorityDecrement += 14 - OwnerThread-&gt;Priority;
02495             OwnerThread-&gt;DecrementCount = <a class="code" href="../../d4/d9/ke_8h.html#a4">ROUND_TRIP_DECREMENT_COUNT</a>;
02496             <a class="code" href="../../d0/d2/thredsup_8c.html#a5">KiSetPriorityThread</a>(OwnerThread, 14);
02497             OwnerThread-&gt;Quantum = OwnerThread-&gt;ApcState.Process-&gt;ThreadQuantum;
02498         }
02499     }
02500 
02501     <span class="keywordflow">return</span>;
02502 }
02503 
02504 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02505 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l02506"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a11">02506</a> <a class="code" href="../../d8/d8/ex_2resource_8c.html#a11">ExpWaitForResource</a> (
02507     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
02508     IN PVOID Object
02509     )
02510 <span class="comment">/*++</span>
02511 <span class="comment"></span>
02512 <span class="comment">Routine Description:</span>
02513 <span class="comment"></span>
02514 <span class="comment">    The routine waits for the specified resource object to be set. If the</span>
02515 <span class="comment">    wait is too long the priority of the current owners of the resource</span>
02516 <span class="comment">    are boosted.</span>
02517 <span class="comment"></span>
02518 <span class="comment">Arguments:</span>
02519 <span class="comment"></span>
02520 <span class="comment">    Resource - Supplies a pointer to the resource to wait for.</span>
02521 <span class="comment"></span>
02522 <span class="comment">    Object - Supplies a pointer to an event (exclusive) or semaphore</span>
02523 <span class="comment">       (shared) to wait for.</span>
02524 <span class="comment"></span>
02525 <span class="comment">Return Value:</span>
02526 <span class="comment"></span>
02527 <span class="comment">    None.</span>
02528 <span class="comment"></span>
02529 <span class="comment">--*/</span>
02530 
02531 {
02532 
02533     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02534     ULONG Limit;
02535     ULONG Number;
02536     KIRQL OldIrql;
02537     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
02538     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> OwnerThread;
02539     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02540     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> CurrentThread;
02541     LARGE_INTEGER Timeout;
02542 
02543     <span class="comment">//</span>
02544     <span class="comment">// Increment the contention count for the resource, set the initial</span>
02545     <span class="comment">// timeout value, and wait for the specified object to be signalled</span>
02546     <span class="comment">// or a timeout to occur.</span>
02547     <span class="comment">//</span>
02548 
02549     Limit = 0;
02550     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a> += 1;
02551     Timeout.QuadPart = 500 * -10000;
02552     <span class="keywordflow">do</span> {
02553         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (
02554                         Object,
02555                         <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
02556                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02557                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02558                         &amp;Timeout );
02559 
02560         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_TIMEOUT) {
02561             <span class="keywordflow">break</span>;
02562         }
02563 
02564         <span class="comment">//</span>
02565         <span class="comment">// The limit has been exceeded, then output status information.</span>
02566         <span class="comment">//</span>
02567 
02568         Limit += 1;
02569         Timeout = <a class="code" href="../../d7/d4/ddkresrc_8c.html#a14">ExpTimeout</a>;
02570         <span class="keywordflow">if</span> (Limit &gt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a44">ExpResourceTimeoutCount</a>) {
02571             Limit = 0;
02572 
02573             <span class="comment">//</span>
02574             <span class="comment">// Output information for the specified resource.</span>
02575             <span class="comment">//</span>
02576 
02577             ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
02578             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Resource @ %lx\n"</span>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
02579             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" ActiveCount = %04lx  Flags = %s%s%s\n"</span>,
02580                      <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a>,
02581                      <a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) ? <span class="stringliteral">"IsOwnedExclusive "</span> : <span class="stringliteral">""</span>,
02582                      <a class="code" href="../../d8/d8/ex_2resource_8c.html#a1">IsSharedWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) ? <span class="stringliteral">"SharedWaiter "</span>     : <span class="stringliteral">""</span>,
02583                      <a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) ? <span class="stringliteral">"ExclusiveWaiter "</span>  : <span class="stringliteral">""</span>);
02584 
02585             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" NumberOfExclusiveWaiters = %04lx\n"</span>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a>);
02586 
02587             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"  Thread = %08lx, Count = %02x\n"</span>,
02588                      <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>,
02589                      <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a>);
02590 
02591             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"  Thread = %08lx, Count = %02x\n"</span>,
02592                      <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>,
02593                      <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a>);
02594 
02595             OwnerEntry = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
02596             <span class="keywordflow">if</span> (OwnerEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02597                 Number = OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>;
02598                 <span class="keywordflow">for</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Number; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
02599                     OwnerEntry += 1;
02600                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"  Thread = %08lx, Count = %02x\n"</span>,
02601                              OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>,
02602                              OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a>);
02603                 }
02604             }
02605 
02606             DbgBreakPoint();
02607             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"EX - Rewaiting\n"</span>);
02608             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
02609         }
02610 
02611         <span class="comment">//</span>
02612         <span class="comment">// If priority boosts are allowed, then attempt to boost the priority</span>
02613         <span class="comment">// of owner threads.</span>
02614         <span class="comment">//</span>
02615 
02616         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a8">IsBoostAllowed</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
02617 
02618             <span class="comment">//</span>
02619             <span class="comment">// Get the current thread address, lock the dispatcher database,</span>
02620             <span class="comment">// and set wait next in the current thread so the dispatcher</span>
02621             <span class="comment">// database lock does not need to be released before waiting</span>
02622             <span class="comment">// for the resource.</span>
02623             <span class="comment">//</span>
02624             <span class="comment">// N.B. Since the dispatcher database lock instead of the resource</span>
02625             <span class="comment">//      lock is being used to synchronize access to the resource,</span>
02626             <span class="comment">//      it is possible for the information being read from the</span>
02627             <span class="comment">//      resource to be stale. However, the important thing that</span>
02628             <span class="comment">//      cannot change is a valid thread address. Thus a thread</span>
02629             <span class="comment">//      could possibly get boosted that actually has dropped its</span>
02630             <span class="comment">//      access to the resource, but it guaranteed that the thread</span>
02631             <span class="comment">//      cannot be terminated or otherwise deleted.</span>
02632             <span class="comment">//</span>
02633             <span class="comment">// N.B. The dispatcher lock is released by the wait at the top of</span>
02634             <span class="comment">//      loop.</span>
02635             <span class="comment">//</span>
02636 
02637             CurrentThread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
02638 
02639             <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
02640             CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o19">WaitNext</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02641 
02642             <span class="comment">//</span>
02643             <span class="comment">// Attempt to boost the one owner that can be shared or exclusive.</span>
02644             <span class="comment">//</span>
02645 
02646             OwnerThread = (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>;
02647             <span class="keywordflow">if</span> (OwnerThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02648                 <a class="code" href="../../d8/d8/ex_2resource_8c.html#a33">ExpBoostOwnerThread</a>(CurrentThread, OwnerThread);
02649             }
02650 
02651             <span class="comment">//</span>
02652             <span class="comment">// If the specified resource is not owned exclusive, then attempt</span>
02653             <span class="comment">// to boost all the owning shared threads priority.</span>
02654             <span class="comment">//</span>
02655 
02656             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
02657                 OwnerThread = (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>;
02658                 <span class="keywordflow">if</span> (OwnerThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02659                     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a33">ExpBoostOwnerThread</a>(CurrentThread, OwnerThread);
02660                 }
02661 
02662                 OwnerEntry = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
02663                 <span class="keywordflow">if</span> (OwnerEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02664                     Number = OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>;
02665                     <span class="keywordflow">for</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Number; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
02666                         OwnerEntry += 1;
02667                         OwnerThread = (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>;
02668                         <span class="keywordflow">if</span> (OwnerThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02669                             <a class="code" href="../../d8/d8/ex_2resource_8c.html#a33">ExpBoostOwnerThread</a>(CurrentThread, OwnerThread);
02670                         }
02671                     }
02672                 }
02673             }
02674         }
02675 
02676     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02677 
02678     <span class="keywordflow">return</span>;
02679 }
02680 
02681 <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a>
02682 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l02683"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">02683</a> <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(
02684     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource,
02685     IN ERESOURCE_THREAD CurrentThread
02686     )
02687 
02688 <span class="comment">/*++</span>
02689 <span class="comment"></span>
02690 <span class="comment">Routine Description:</span>
02691 <span class="comment"></span>
02692 <span class="comment">    This function searches for the specified thread in the resource</span>
02693 <span class="comment">    thread array. If the thread is located, then a pointer to the</span>
02694 <span class="comment">    array entry is returned as the function value. Otherwise, a pointer</span>
02695 <span class="comment">    to a free entry is returned.</span>
02696 <span class="comment"></span>
02697 <span class="comment">Arguments:</span>
02698 <span class="comment"></span>
02699 <span class="comment">    Resource - Supplies a pointer to the resource for which the search</span>
02700 <span class="comment">        is performed.</span>
02701 <span class="comment"></span>
02702 <span class="comment">    CurrentThread - Supplies the identification of the thread to search</span>
02703 <span class="comment">        for.</span>
02704 <span class="comment"></span>
02705 <span class="comment">Return Value:</span>
02706 <span class="comment"></span>
02707 <span class="comment">    A pointer to an owner entry is returned.</span>
02708 <span class="comment"></span>
02709 <span class="comment">--*/</span>
02710 
02711 {
02712 
02713     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> FreeEntry;
02714     ULONG NewSize;
02715     ULONG OldSize;
02716     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
02717     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerBound;
02718     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerTable, OldTable;
02719     KIRQL OldIrql;
02720 
02721     <span class="comment">//</span>
02722     <span class="comment">// Search the owner threads for the specified thread and return either</span>
02723     <span class="comment">// a pointer to the found thread or a pointer to a free thread table</span>
02724     <span class="comment">// entry.</span>
02725     <span class="comment">//</span>
02726 
02727     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
02728         <span class="keywordflow">return</span> &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0];
02729 
02730     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
02731         <span class="keywordflow">return</span> &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1];
02732 
02733     } <span class="keywordflow">else</span> {
02734         FreeEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02735         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == 0) {
02736             FreeEntry = &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1];
02737         }
02738 
02739         OwnerEntry = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
02740         <span class="keywordflow">if</span> (OwnerEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02741             OldSize = 0;
02742 
02743         } <span class="keywordflow">else</span> {
02744             OldSize = OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>;
02745             OwnerBound = &amp;OwnerEntry[OldSize];
02746             OwnerEntry += 1;
02747             <span class="keywordflow">do</span> {
02748                 <span class="keywordflow">if</span> (OwnerEntry-&gt;OwnerThread == CurrentThread) {
02749                     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ResourceIndex = (UCHAR)(OwnerEntry - <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>);
02750                     <span class="keywordflow">return</span> OwnerEntry;
02751                 }
02752 
02753                 <span class="keywordflow">if</span> ((FreeEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02754                     (OwnerEntry-&gt;OwnerThread == 0)) {
02755                     FreeEntry = OwnerEntry;
02756                 }
02757 
02758                 OwnerEntry += 1;
02759             } <span class="keywordflow">while</span> (OwnerEntry != OwnerBound);
02760         }
02761     }
02762 
02763     <span class="comment">//</span>
02764     <span class="comment">// If a free entry was found in the table, then return the address of the</span>
02765     <span class="comment">// free entry. Otherwise, expand the size of the owner thread table.</span>
02766     <span class="comment">//</span>
02767 
02768     <span class="keywordflow">if</span> (FreeEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02769         <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ResourceIndex = (UCHAR)(FreeEntry - <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>);
02770         <span class="keywordflow">return</span> FreeEntry;
02771     }
02772 
02773     <span class="comment">//</span>
02774     <span class="comment">// Allocate an expanded owner table.</span>
02775     <span class="comment">//</span>
02776 
02777     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(OwnerTableExpands);
02778     <span class="keywordflow">if</span> (OldSize == 0 ) {
02779         NewSize = 3;
02780 
02781     } <span class="keywordflow">else</span> {
02782         NewSize = OldSize + 4;
02783     }
02784 
02785     <span class="keywordflow">if</span> (NewSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">OWNER_ENTRY</a>) &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
02786         
02787         OwnerTable = (<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
02788             <a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
02789             NewSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">OWNER_ENTRY</a>),
02790             'aTeR');
02791     }
02792     <span class="keywordflow">else</span> {
02793 
02794         <span class="comment">//</span>
02795         <span class="comment">// If allocation is bigger than one page we need to</span>
02796         <span class="comment">// allocate from normal pool. If we fail then we will</span>
02797         <span class="comment">// bugcheck with `must_succeed_pool_empty' because logically</span>
02798         <span class="comment">// this is what we do.</span>
02799         <span class="comment">//</span>
02800 
02801         OwnerTable = (<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
02802             <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02803             NewSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">OWNER_ENTRY</a>),
02804             'aTeR');
02805 
02806         <span class="keywordflow">if</span> (OwnerTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02807             
02808             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a> (MUST_SUCCEED_POOL_EMPTY); 
02809         }
02810 
02811     }
02812 
02813     <span class="comment">//</span>
02814     <span class="comment">// Zero the expanded owner table, compute the address of the owner</span>
02815     <span class="comment">// count and thread tables, and copy the old table to the new table.</span>
02816     <span class="comment">//</span>
02817 
02818     RtlZeroMemory((PVOID)(OwnerTable + OldSize),
02819                   (NewSize - OldSize) * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">OWNER_ENTRY</a>));
02820 
02821     RtlCopyMemory((PVOID)OwnerTable,
02822                    <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>,
02823                    OldSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/ex_8h.html#a123">OWNER_ENTRY</a>));
02824 
02825     <span class="comment">//</span>
02826     <span class="comment">// If an expanded table was previously allocated, then save it so it can be freed.</span>
02827     <span class="comment">//</span>
02828     OldTable = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
02829 
02830     <span class="comment">//</span>
02831     <span class="comment">// Set new owner table parameters and return the address of the first</span>
02832     <span class="comment">// free entry. We need the dispatcher lock here to prevent table expansion while we are boosting</span>
02833     <span class="comment">// thread priorities.</span>
02834     <span class="comment">//</span>
02835     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
02836     OwnerTable-&gt;TableSize = NewSize;
02837     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a> = OwnerTable;
02838     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
02839 
02840     <span class="keywordflow">if</span> (OldTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02841         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(OldTable);
02842     }
02843 
02844     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
02845 
02846 <span class="preprocessor">#if defined(_COLLECT_RESOURCE_DATA_)</span>
02847 <span class="preprocessor"></span>
02848     <span class="keywordflow">if</span> (NewSize &gt; ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o9">MaximumTableExpand</a>) {
02849         ExpResourcePerformanceData.<a class="code" href="../../d4/d4/struct__RESOURCE__PERFORMANCE__DATA.html#o9">MaximumTableExpand</a> = NewSize;
02850     }
02851 
02852 <span class="preprocessor">#endif</span>
02853 <span class="preprocessor"></span>
02854     <span class="keywordflow">if</span> (OldSize == 0) {
02855         OldSize = 1;
02856     }
02857 
02858     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ResourceIndex = (CCHAR)OldSize;
02859     <span class="keywordflow">return</span> &amp;OwnerTable[OldSize];
02860 }
02861 
02862 <span class="preprocessor">#if DBG</span>
02863 <span class="preprocessor"></span>
02864 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02865 ExpAssertResource (
02866     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> Resource
02867     )
02868 
02869 {
02870     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02871     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
02872 
02873     <span class="comment">//</span>
02874     <span class="comment">//  Assert that resource structure is correct.</span>
02875     <span class="comment">//</span>
02876     <span class="comment">// N.B. This routine is called with the resource lock held.</span>
02877     <span class="comment">//</span>
02878 
02879     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> ||
02880            <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>-&gt;<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o0">Type</a> == SemaphoreObject);
02881 
02882     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> ||
02883            <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>-&gt;<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o2">Size</a> == (<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a>) / <span class="keyword">sizeof</span>(ULONG)));
02884 
02885     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a> ||
02886            <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>-&gt;<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o0">Type</a> == SynchronizationEvent);
02887 
02888     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a> ||
02889            <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>-&gt;<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o2">Size</a> == (<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>) / <span class="keyword">sizeof</span>(ULONG)));
02890 }
02891 <span class="preprocessor">#endif  // dbg</span>
02892 <span class="preprocessor"></span>
02893 PVOID
<a name="l02894"></a><a class="code" href="../../d8/d8/ex_2resource_8c.html#a34">02894</a> <a class="code" href="../../d8/d8/ex_2resource_8c.html#a34">ExpCheckForResource</a>(
02895     IN PVOID p,
02896     IN ULONG Size
02897     )
02898 
02899 {
02900 
02901     KIRQL OldIrql;
02902     PLIST_ENTRY Head, Next;
02903     <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
02904     PCHAR BeginBlock;
02905     PCHAR EndBlock;
02906 
02907     <span class="comment">//</span>
02908     <span class="comment">// This can cause a deadlock on MP machines.</span>
02909     <span class="comment">//</span>
02910 
02911     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a> &gt; 1) {
02912         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02913     }
02914 
02915     BeginBlock = (PCHAR)p;
02916     EndBlock = (PCHAR)p + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02917 
02918     ExAcquireSpinLock( &amp;<a class="code" href="../../d8/d8/ex_2resource_8c.html#a9">ExpResourceSpinLock</a>, &amp;OldIrql );
02919     Head = &amp;<a class="code" href="../../d7/d4/ddkresrc_8c.html#a17">ExpSystemResourcesList</a>;
02920     Next = Head-&gt;Flink;
02921     <span class="keywordflow">while</span> (Next != Head) {
02922         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = CONTAINING_RECORD( Next,
02923                                       <a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>,
02924                                       SystemResourcesList
02925                                     );
02926 
02927         <span class="keywordflow">if</span> ((PCHAR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> &gt;= BeginBlock &amp;&amp; (PCHAR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> &lt; EndBlock) {
02928             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"EX: ExFreePool( %lx, %lx ) contains an ERESOURCE structure that has not been ExDeleteResourced\n"</span>,
02929                       p, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
02930                     );
02931             DbgBreakPoint();
02932             ExReleaseSpinLock( &amp;<a class="code" href="../../d8/d8/ex_2resource_8c.html#a9">ExpResourceSpinLock</a>, OldIrql );
02933             <span class="keywordflow">return</span> (PVOID)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
02934         }
02935 
02936         Next = Next-&gt;Flink;
02937     }
02938 
02939     ExReleaseSpinLock( &amp;<a class="code" href="../../d8/d8/ex_2resource_8c.html#a9">ExpResourceSpinLock</a>, OldIrql );
02940     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02941 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
