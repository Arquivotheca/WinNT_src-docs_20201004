<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: winsta.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>winsta.c</h1><a href="../../d8/d8/winsta_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: winsta.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Windowstation Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 01-14-91 JimA         Created.</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 
00016 <span class="comment">/***************************************************************************\</span>
00017 <span class="comment">* InitTerminal</span>
00018 <span class="comment">*</span>
00019 <span class="comment">* Creates the desktop thread for a terminal and also the RIT for the</span>
00020 <span class="comment">* IO terminal</span>
00021 <span class="comment">*</span>
00022 <span class="comment">* History:</span>
00023 <span class="comment">* 27-10-97 CLupu        Created.</span>
00024 <span class="comment">\***************************************************************************/</span>
00025 
<a name="l00026"></a><a class="code" href="../../d8/d8/winsta_8c.html#a1">00026</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d8/d8/winsta_8c.html#a1">xxxInitTerminal</a>(
00027     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm)
00028 {
00029     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00030     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>  pEventTermInit;
00031     HANDLE   hEventInputReady, hEventTermInit;
00032     HANDLE   hThreadDesktop;
00033 
00034     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00035 
00036     UserAssert(!(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a200">TERMF_INITIALIZED</a>));
00037 
00038     <span class="keywordflow">if</span> (pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00039 
00040         <span class="comment">/*</span>
00041 <span class="comment">         * if we make it here it means that another thread is</span>
00042 <span class="comment">         * executing xxxInitTerminal for the same terminal and it</span>
00043 <span class="comment">         * left the critical section.</span>
00044 <span class="comment">         */</span>
00045         UserAssert(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00046 
00047         <span class="comment">/*</span>
00048 <span class="comment">         * use a local variable so we can safely reset</span>
00049 <span class="comment">         * pTerm-&gt;pEventTermInit when we're done with it</span>
00050 <span class="comment">         */</span>
00051         pEventTermInit = pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a>;
00052 
00053         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(pEventTermInit);
00054 
00055         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00056 
00057         <span class="keywordflow">goto</span> Wait;
00058     }
00059 
00060     <span class="comment">/*</span>
00061 <span class="comment">     * Create the input ready event. RIT and desktop thread will wait for it.</span>
00062 <span class="comment">     * It will be set when the first desktop in this terminal will be created.</span>
00063 <span class="comment">     */</span>
00064     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateEvent(
00065                      &amp;hEventInputReady,
00066                      EVENT_ALL_ACCESS,
00067                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00068                      NotificationEvent,
00069                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00070 
00071     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00072         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00073 
00074     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00075                      hEventInputReady,
00076                      EVENT_ALL_ACCESS,
00077                      *<a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00078                      <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00079                      &amp;pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00080 
00081     ZwClose(hEventInputReady);
00082 
00083     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00084         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00085 
00086     <span class="comment">/*</span>
00087 <span class="comment">     * Device and RIT initialization. Don't do it for</span>
00088 <span class="comment">     * the system terminal.</span>
00089 <span class="comment">     */</span>
00090     <span class="keywordflow">if</span> (!(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a201">TERMF_NOIO</a>)) {
00091         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1835">CreateTerminalInput</a>(pTerm)) {
00092             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a>);
00093             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00094         }
00095     }
00096 
00097     <span class="comment">/*</span>
00098 <span class="comment">     * create an event to syncronize the terminal initialization</span>
00099 <span class="comment">     */</span>
00100     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateEvent(
00101                      &amp;hEventTermInit,
00102                      EVENT_ALL_ACCESS,
00103                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00104                      NotificationEvent,
00105                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00106 
00107     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00108         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a>);
00109         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00110     }
00111 
00112     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00113                      hEventTermInit,
00114                      EVENT_ALL_ACCESS,
00115                      *<a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00116                      <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00117                      &amp;pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00118 
00119     ZwClose(hEventTermInit);
00120 
00121     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00122         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a>);
00123         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00124     }
00125 
00126     <span class="comment">/*</span>
00127 <span class="comment">     * use a local variable so we can safely reset</span>
00128 <span class="comment">     * pTerm-&gt;pEventTermInit when we're done with it</span>
00129 <span class="comment">     */</span>
00130     pEventTermInit = pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a>;
00131 
00132     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00133 
00134     <span class="comment">/*</span>
00135 <span class="comment">     * Create the desktop thread.</span>
00136 <span class="comment">     */</span>
00137     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a963">CreateSystemThread</a>(
00138                      (<a class="code" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a>)<a class="code" href="../../d9/d6/desktop_8c.html#a8">xxxDesktopThread</a>,
00139                      pTerm,
00140                      &amp;hThreadDesktop);
00141 
00142     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00143         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00144         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a>);
00145         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEventTermInit);
00146         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00147     }
00148 
00149     ZwClose(hThreadDesktop);
00150 
00151 Wait:
00152     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(pEventTermInit,
00153                           <a class="code" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>,
00154                           <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00155                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00156                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00157 
00158     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00159 
00160     <span class="comment">/*</span>
00161 <span class="comment">     * dereference the terminal init event. It will eventually</span>
00162 <span class="comment">     * go away.</span>
00163 <span class="comment">     */</span>
00164     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEventTermInit);
00165 
00166     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00167 
00168     <span class="keywordflow">if</span> (pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a204">TERMF_DTINITFAILED</a>) {
00169         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00170     }
00171 
00172     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a200">TERMF_INITIALIZED</a>;
00173     <span class="keywordflow">return</span> STATUS_SUCCESS;
00174 }
00175 
00176 
00177 <span class="comment">/***************************************************************************\</span>
00178 <span class="comment">* xxxCreateWindowStation</span>
00179 <span class="comment">*</span>
00180 <span class="comment">* Creates the specified windowstation and starts a logon thread for the</span>
00181 <span class="comment">* station.</span>
00182 <span class="comment">*</span>
00183 <span class="comment">* History:</span>
00184 <span class="comment">* 01-15-91 JimA         Created.</span>
00185 <span class="comment">\***************************************************************************/</span>
00186 
<a name="l00187"></a><a class="code" href="../../d8/d8/winsta_8c.html#a0">00187</a> <span class="keyword">static</span> CONST LPCWSTR <a class="code" href="../../d8/d8/winsta_8c.html#a0">lpszStdFormats</a>[] = {
00188     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdExit"</span>,
00189     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdNewDocument"</span>,
00190     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdOpenDocument"</span>,
00191     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdEditDocument"</span>,
00192     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdNewfromTemplate"</span>,
00193     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdCloseDocument"</span>,
00194     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdShowItem"</span>,
00195     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdDoVerbItem"</span>,
00196     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"System"</span>,
00197     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OLEsystem"</span>,
00198     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdDocumentName"</span>,
00199     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Protocols"</span>,
00200     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Topics"</span>,
00201     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Formats"</span>,
00202     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Status"</span>,
00203     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"EditEnvItems"</span>,
00204     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"True"</span>,
00205     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"False"</span>,
00206     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Change"</span>,
00207     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Save"</span>,
00208     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Close"</span>,
00209     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MSDraw"</span>
00210 };
00211 
<a name="l00212"></a><a class="code" href="../../d8/d8/winsta_8c.html#a2">00212</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d8/d8/winsta_8c.html#a2">CreateGlobalAtomTable</a>(
00213     PVOID* ppAtomTable)
00214 {
00215     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00216     RTL_ATOM Atom;
00217     ULONG    i;
00218 
00219     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a13">RtlCreateAtomTable</a>(0, ppAtomTable);
00220 
00221     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00222         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Global atom table not created"</span>);
00223         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00224     }
00225 
00226     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(<a class="code" href="../../d8/d8/winsta_8c.html#a0">lpszStdFormats</a>); i++) {
00227         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a18">RtlAddAtomToAtomTable</a>(*ppAtomTable,
00228                                        (PWSTR)<a class="code" href="../../d8/d8/winsta_8c.html#a0">lpszStdFormats</a>[i],
00229                                        &amp;Atom);
00230         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00231             RIPMSG1(RIP_WARNING, <span class="stringliteral">"RtlAddAtomToAtomTable failed to add atom %ws"</span>,
00232                     <a class="code" href="../../d8/d8/winsta_8c.html#a0">lpszStdFormats</a>[i]);
00233 
00234             <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a14">RtlDestroyAtomTable</a>(*ppAtomTable);
00235             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00236         }
00237 
00238         <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a21">RtlPinAtomInAtomTable</a>(*ppAtomTable, Atom);
00239     }
00240     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00241 }
00242 
<a name="l00243"></a><a class="code" href="../../d8/d8/winsta_8c.html#a3">00243</a> HWINSTA <a class="code" href="../../d8/d8/winsta_8c.html#a3">xxxCreateWindowStation</a>(
00244     POBJECT_ATTRIBUTES  ObjectAttributes,
00245     KPROCESSOR_MODE     OwnershipMode,
00246     DWORD               dwDesiredAccess,
00247     HANDLE              hKbdLayoutFile,
00248     DWORD               offTable,
00249     PCWSTR              pwszKLID,
00250     UINT                uKbdInputLocale)
00251 {
00252     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>          pwinsta;
00253     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>             ptiCurrent;
00254     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>                pdeskTemp;
00255     HDESK                   hdeskTemp;
00256     PSECURITY_DESCRIPTOR    psd;
00257     PSECURITY_DESCRIPTOR    psdCapture;
00258     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>            ppiSave;
00259     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00260     PACCESS_ALLOWED_ACE     paceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pace;
00261     ULONG                   ulLength, ulLengthSid;
00262     HANDLE                  hEvent;
00263     HWINSTA                 hwinsta;
00264     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                   dwDisableHooks;
00265     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a>               pTerm = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00266     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>                    pwnd;
00267     WCHAR                   szBaseNamedObjectDirectory[<a class="code" href="../../d8/d9/dllinit_8c.html#a1">MAX_SESSION_PATH</a>];
00268 
00269     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00270 
00271     <span class="comment">/*</span>
00272 <span class="comment">     * Get the pointer to the security descriptor so we can</span>
00273 <span class="comment">     * assign it to the new object later.</span>
00274 <span class="comment">     */</span>
00275     psdCapture = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;SecurityDescriptor;
00276 
00277     <span class="comment">/*</span>
00278 <span class="comment">     * The first windowstation that gets created is Winsta0 and</span>
00279 <span class="comment">     * it's the only interactive one.</span>
00280 <span class="comment">     */</span>
00281     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00282 
00283         <span class="comment">/*</span>
00284 <span class="comment">         * Assert that winlogon is the first to call CreateWindowStation</span>
00285 <span class="comment">         */</span>
00286         UserAssert(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>);
00287 
00288         pTerm = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>;
00289     } <span class="keywordflow">else</span> {
00290         pTerm = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a240">gTermNOIO</a>;
00291 
00292         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00293                    pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a201">TERMF_NOIO</a>);
00294 
00295         pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a201">TERMF_NOIO</a>;
00296     }
00297 
00298     <span class="comment">/*</span>
00299 <span class="comment">     * Create the WindowStation object</span>
00300 <span class="comment">     */</span>
00301     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>,
00302             <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, OwnershipMode, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">WINDOWSTATION</a>),
00303             0, 0, &amp;pwinsta);
00304 
00305     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00306         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_WARNING, <span class="stringliteral">"Failed to create windowstation"</span>);
00307         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00308     }
00309 
00310     <span class="comment">/*</span>
00311 <span class="comment">     * Initialize everything</span>
00312 <span class="comment">     */</span>
00313     RtlZeroMemory(pwinsta, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/userk_8h.html#a838">WINDOWSTATION</a>));
00314 
00315     <span class="comment">/*</span>
00316 <span class="comment">     * Store the session id of the session who created the windowstation</span>
00317 <span class="comment">     */</span>
00318     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o21">dwSessionId</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>;
00319 
00320     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a> = pTerm;
00321 
00322     <span class="comment">/*</span>
00323 <span class="comment">     * All the windowstations in the system terminal are non-interactive.</span>
00324 <span class="comment">     */</span>
00325     <span class="keywordflow">if</span> (pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a201">TERMF_NOIO</a>) {
00326         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> = <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>;
00327     }
00328 
00329     <span class="comment">/*</span>
00330 <span class="comment">     * Create the global atom table and populate it with the default OLE atoms</span>
00331 <span class="comment">     * Pin each atom so they can't be deleted by bogus applications like Winword</span>
00332 <span class="comment">     */</span>
00333     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/winsta_8c.html#a2">CreateGlobalAtomTable</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o16">pGlobalAtomTable</a>);
00334 
00335     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o16">pGlobalAtomTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00336         UserAssert(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00337         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_WARNING, <span class="stringliteral">"CreateGlobalAtomTable failed"</span>);
00338         <span class="keywordflow">goto</span> create_error;
00339     }
00340 
00341     <span class="comment">/*</span>
00342 <span class="comment">     * create the desktop thread</span>
00343 <span class="comment">     * and the RIT (only for the IO terminal)</span>
00344 <span class="comment">     */</span>
00345     <span class="keywordflow">if</span> (!(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a200">TERMF_INITIALIZED</a>)) {
00346 
00347         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/winsta_8c.html#a1">xxxInitTerminal</a>(pTerm);
00348 
00349         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00350             RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_WARNING, <span class="stringliteral">"xxxInitTerminal failed"</span>);
00351             <span class="keywordflow">goto</span> create_error;
00352         }
00353     }
00354 
00355     <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>)) {
00356         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1178">xxxInitWindowStation</a>(pwinsta)) {
00357             RIPNTERR0(STATUS_NO_MEMORY, RIP_WARNING, <span class="stringliteral">"xxxInitWindowStation failed"</span>);
00358             <span class="keywordflow">goto</span> create_error;
00359         }
00360     }
00361 
00362     <span class="comment">/*</span>
00363 <span class="comment">     * Create only one desktop owner window per terminal.</span>
00364 <span class="comment">     */</span>
00365     <span class="keywordflow">if</span> (pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00366 
00367         <span class="comment">/*</span>
00368 <span class="comment">         * Switch ppi values so window will be created using the</span>
00369 <span class="comment">         * system's desktop window class.</span>
00370 <span class="comment">         */</span>
00371         ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00372         ppiSave = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
00373         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> = pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
00374 
00375         UserAssert(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp; W32PF_CLASSESREGISTERED);
00376 
00377         pdeskTemp = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;            <span class="comment">/* save current desktop */</span>
00378         hdeskTemp = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o18">hdesk</a>;
00379         <span class="keywordflow">if</span> (pdeskTemp) {
00380             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(pdeskTemp);
00381             <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdeskTemp, LD_REF_FN_CREATEWINDOWSTATION, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
00382         }
00383 
00384         <span class="comment">/*</span>
00385 <span class="comment">         * The following code is not supposed to leave the critical section because</span>
00386 <span class="comment">         * CreateWindowStation is an API so the current thread can be on any state</span>
00387 <span class="comment">         *  setting its pdesk to NULL it's kind of bogus</span>
00388 <span class="comment">         */</span>
00389         <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
00390         <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00391         <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(ptiCurrent, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00392 
00393 
00394         <span class="comment">/*</span>
00395 <span class="comment">         * HACK HACK HACK!!! (adams) In order to create the desktop window</span>
00396 <span class="comment">         * with the correct desktop, we set the desktop of the current thread</span>
00397 <span class="comment">         * to the new desktop. But in so doing we allow hooks on the current</span>
00398 <span class="comment">         * thread to also hook this new desktop. This is bad, because we don't</span>
00399 <span class="comment">         * want the desktop window to be hooked while it is created. So we</span>
00400 <span class="comment">         * temporarily disable hooks of the current thread and desktop, and</span>
00401 <span class="comment">         * reenable them after switching back to the original desktop.</span>
00402 <span class="comment">         */</span>
00403 
00404         dwDisableHooks = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>;
00405         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>;
00406 
00407         <span class="comment">/*</span>
00408 <span class="comment">         * Create the desktop owner window</span>
00409 <span class="comment">         *</span>
00410 <span class="comment">         * CONSIDER (adams): Do we want to limit the desktop size so that the</span>
00411 <span class="comment">         * width and height of a rect will fit in 16bit coordinates?</span>
00412 <span class="comment">         *</span>
00413 <span class="comment">         *         SHRT_MIN / 2, SHRT_MIN / 2, SHRT_MAX, SHRT_MAX,</span>
00414 <span class="comment">         *</span>
00415 <span class="comment">         * Or do we want to limit it so just any point has 16bit coordinates?</span>
00416 <span class="comment">         *</span>
00417 <span class="comment">         *         -SHRT_MIN, -SHRT_MIN, SHRT_MAX * 2, SHRT_MAX * 2</span>
00418 <span class="comment">         */</span>
00419 
00420         pwnd =  <a class="code" href="../../d4/d1/userk_8h.html#a1574">xxxCreateWindowEx</a>(
00421                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
00422                 (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a39">DESKTOPCLASS</a>,
00423                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00424                 (WS_POPUP | WS_CLIPCHILDREN),
00425                 SHRT_MIN / 2,
00426                 SHRT_MIN / 2,
00427                 SHRT_MAX,
00428                 SHRT_MAX,
00429                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00430                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00431                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>,
00432                 (LPWSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00433                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a102">VER31</a>
00434                 );
00435 
00436         <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00437             RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxCreateWindowStation: Failed to create mother desktop window"</span>);
00438             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00439             <a class="code" href="../../d4/d1/userk_8h.html#a167">EXITATOMICCHECK</a>();
00440             <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
00441             <span class="comment">/*</span>
00442 <span class="comment">             * Restore caller's ppi</span>
00443 <span class="comment">             */</span>
00444             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> = ppiSave;
00445 
00446             <span class="comment">/*</span>
00447 <span class="comment">             * Restore the previous desktop</span>
00448 <span class="comment">             */</span>
00449             <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(ptiCurrent, pdeskTemp, hdeskTemp);
00450 
00451             <span class="keywordflow">goto</span> create_error;
00452         }
00453 
00454         <span class="comment">/*</span>
00455 <span class="comment">         * Mark this handle entry that is allocated out of pool</span>
00456 <span class="comment">         */</span>
00457         {
00458             <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> phe;
00459 
00460             UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00461 
00462             phe = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a446">HMPheFromObject</a>(pwnd);
00463             phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> |= <a class="code" href="../../d1/d0/inc_2user_8h.html#a417">HANDLEF_POOL</a>;
00464         }
00465 
00466         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>), pwnd);
00467 
00468         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>);
00469         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> = (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>) | dwDisableHooks;
00470 
00471         <a class="code" href="../../d4/d1/userk_8h.html#a1626">SetVisible</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a751">SV_SET</a>);
00472         <a class="code" href="../../d4/d1/userk_8h.html#a980">HMChangeOwnerThread</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>, pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>);
00473 
00474         <span class="comment">/*</span>
00475 <span class="comment">         * Restore caller's ppi</span>
00476 <span class="comment">         */</span>
00477         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> = ppiSave;
00478 
00479         <span class="comment">/*</span>
00480 <span class="comment">         * Restore the previous desktop</span>
00481 <span class="comment">         */</span>
00482         <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(ptiCurrent, pdeskTemp, hdeskTemp);
00483 
00484         <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
00485         <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
00486 
00487         <span class="keywordflow">if</span> (pdeskTemp) {
00488             <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdeskTemp, LD_DEREF_FN_CREATEWINDOWSTATION, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
00489             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdeskTemp);
00490         }
00491     }
00492 
00493     <span class="comment">/*</span>
00494 <span class="comment">     * If this is the visible windowstation, assign it to</span>
00495 <span class="comment">     * the server and create the desktop switch notification</span>
00496 <span class="comment">     * event.</span>
00497 <span class="comment">     */</span>
00498     <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>)) {
00499         UNICODE_STRING strName;
00500         HANDLE hRootDir;
00501         OBJECT_ATTRIBUTES obja;
00502 
00503         <span class="comment">/*</span>
00504 <span class="comment">         * Create desktop switch notification event.</span>
00505 <span class="comment">         */</span>
00506         ulLengthSid = <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(<a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o24">SeWorldSid</a>);
00507         ulLength = ulLengthSid + <span class="keyword">sizeof</span>(ACE_HEADER) + <span class="keyword">sizeof</span>(ACCESS_MASK);
00508 
00509         <span class="comment">/*</span>
00510 <span class="comment">         * Allocate the ACE list</span>
00511 <span class="comment">         */</span>
00512         paceList = (PACCESS_ALLOWED_ACE)UserAllocPoolWithQuota(ulLength, TAG_SECURITY);
00513 
00514         <span class="keywordflow">if</span> (paceList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00515             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00516             <span class="keywordflow">goto</span> create_error;
00517         }
00518 
00519         <span class="comment">/*</span>
00520 <span class="comment">         * Initialize ACE 0</span>
00521 <span class="comment">         */</span>
00522         pace = paceList;
00523         pace-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
00524         pace-&gt;Header.AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ulLength;
00525         pace-&gt;Header.AceFlags = 0;
00526         pace-&gt;Mask = SYNCHRONIZE;
00527         <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(ulLengthSid, &amp;pace-&gt;SidStart, <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o24">SeWorldSid</a>);
00528 
00529         <span class="comment">/*</span>
00530 <span class="comment">         * Create the SD</span>
00531 <span class="comment">         */</span>
00532         psd = <a class="code" href="../../d4/d1/userk_8h.html#a1268">CreateSecurityDescriptor</a>(paceList, ulLength, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00533 
00534         UserFreePool(paceList);
00535 
00536         <span class="keywordflow">if</span> (psd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00537             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00538             <span class="keywordflow">goto</span> create_error;
00539         }
00540 
00541         <span class="comment">/*</span>
00542 <span class="comment">         * Create the named event.</span>
00543 <span class="comment">         */</span>
00544         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a20">ghEventSwitchDesktop</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00545 
00546         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
00547             swprintf(szBaseNamedObjectDirectory, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Sessions\\%ld\\BaseNamedObjects"</span>,
00548                      <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>);
00549             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strName, szBaseNamedObjectDirectory);
00550         } <span class="keywordflow">else</span> {
00551             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\BaseNamedObjects"</span>);
00552         }
00553 
00554         InitializeObjectAttributes( &amp;obja,
00555                                     &amp;strName,
00556                                     OBJ_CASE_INSENSITIVE,
00557                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00558                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00559                                     );
00560         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenDirectoryObject( &amp;hRootDir,
00561                                         DIRECTORY_ALL_ACCESS &amp;
00562                                             ~(DELETE | WRITE_DAC | WRITE_OWNER),
00563                                         &amp;obja
00564                                     );
00565         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00566             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"WinSta0_DesktopSwitch"</span>);
00567             InitializeObjectAttributes(&amp;obja, &amp;strName, OBJ_OPENIF, hRootDir, psd);
00568             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateEvent(&amp;hEvent, EVENT_ALL_ACCESS, &amp;obja,
00569                     NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00570             ZwClose(hRootDir);
00571 
00572             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00573                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hEvent, EVENT_ALL_ACCESS, *<a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00574                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a21">gpEventSwitchDesktop</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00575                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00576 
00577                     <span class="comment">/*</span>
00578 <span class="comment">                     * Attach to the system process and create a handle to the</span>
00579 <span class="comment">                     * object.  This will ensure that the object name is retained</span>
00580 <span class="comment">                     * when hEvent is closed.  This is simpler than creating a</span>
00581 <span class="comment">                     * permanent object, which takes the</span>
00582 <span class="comment">                     * SeCreatePermanentPrivilege.</span>
00583 <span class="comment">                     */</span>
00584                     <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
00585 
00586                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(
00587                             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a21">gpEventSwitchDesktop</a>,
00588                             0,
00589                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00590                             EVENT_ALL_ACCESS,
00591                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00592                             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00593                             &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a20">ghEventSwitchDesktop</a>);
00594                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00595                 }
00596                 ZwClose(hEvent);
00597             }
00598         }
00599         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00600             <span class="keywordflow">goto</span> create_error;
00601 
00602         UserFreePool(psd);
00603     }
00604 
00605     <span class="comment">/*</span>
00606 <span class="comment">     * Create a handle to the windowstation</span>
00607 <span class="comment">     */</span>
00608     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(pwinsta, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, dwDesiredAccess, 1,
00609             &amp;pwinsta, &amp;hwinsta);
00610 
00611     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_EXISTS) {
00612 
00613         <span class="comment">/*</span>
00614 <span class="comment">         * The windowstation already exists, so deref and leave.</span>
00615 <span class="comment">         */</span>
00616         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
00617 
00618     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00619         PSECURITY_DESCRIPTOR psdParent, psdNew;
00620         <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> Context;
00621         <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> pParentDirectory;
00622         SECURITY_INFORMATION siNew;
00623 
00624         <span class="comment">/*</span>
00625 <span class="comment">         * Create security descriptor for the windowstation.</span>
00626 <span class="comment">         * ObInsertObject only supports non-container</span>
00627 <span class="comment">         * objects, so we must assign our own security descriptor.</span>
00628 <span class="comment">         */</span>
00629         <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>(&amp;Context);
00630         <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>(&amp;Context);
00631 
00632         pParentDirectory = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>(
00633                 <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pwinsta))-&gt;Directory;
00634         <span class="keywordflow">if</span> (pParentDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00635             psdParent = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pParentDirectory)-&gt;SecurityDescriptor;
00636         <span class="keywordflow">else</span>
00637             psdParent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00638 
00639         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d5/seassign_8c.html#a1">SeAssignSecurity</a>(
00640                 psdParent,
00641                 psdCapture,
00642                 &amp;psdNew,
00643                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00644                 &amp;Context,
00645                 (PGENERIC_MAPPING)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a304">WinStaMapping</a>,
00646                 <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>);
00647 
00648         <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>(&amp;Context);
00649         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>(&amp;Context);
00650 
00651         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00652 <span class="preprocessor">#if DBG</span>
00653 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ACCESS_DENIED) {
00654                 RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_WARNING, <span class="stringliteral">"Access denied during object creation"</span>);
00655             } <span class="keywordflow">else</span> {
00656                 RIPNTERR1(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_ERROR,
00657                             <span class="stringliteral">"Can't create security descriptor! Status = %#lx"</span>,
00658                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00659             }
00660 <span class="preprocessor">#endif</span>
00661 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
00662 
00663             <span class="comment">/*</span>
00664 <span class="comment">             * Call the security method to copy the security descriptor</span>
00665 <span class="comment">             */</span>
00666             siNew = (OWNER_SECURITY_INFORMATION | GROUP_SECURITY_INFORMATION |
00667                     DACL_SECURITY_INFORMATION | SACL_SECURITY_INFORMATION);
00668             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a13">ObSetSecurityDescriptorInfo</a>(
00669                     pwinsta,
00670                     &amp;siNew,
00671                     psdNew,
00672                     &amp;<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pwinsta)-&gt;SecurityDescriptor,
00673                     <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00674                     (PGENERIC_MAPPING)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a304">WinStaMapping</a>);
00675             <a class="code" href="../../d1/d5/seassign_8c.html#a3">SeDeassignSecurity</a>(&amp;psdNew);
00676 
00677             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00678 
00679                 <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>* ppwinsta;
00680 
00681                 <span class="comment">/*</span>
00682 <span class="comment">                 * Put it on the tail of the global windowstation list</span>
00683 <span class="comment">                 */</span>
00684                 ppwinsta = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>;
00685                 <span class="keywordflow">while</span> (*ppwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00686                     ppwinsta = &amp;(*ppwinsta)-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>;
00687                 <a class="code" href="../../d4/d1/userk_8h.html#a125">LockWinSta</a>(ppwinsta, pwinsta);
00688 
00689                 <span class="comment">/*</span>
00690 <span class="comment">                 * For interactive window stations load the keyboard</span>
00691 <span class="comment">                 * layout. !!!</span>
00692 <span class="comment">                 */</span>
00693                 <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) &amp;&amp; pwszKLID != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00694                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1302">xxxLoadKeyboardLayoutEx</a>(
00695                                 pwinsta,
00696                                 hKbdLayoutFile,
00697                                 (HKL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00698                                 offTable,
00699                                 pwszKLID,
00700                                 uKbdInputLocale,
00701                                 KLF_ACTIVATE | KLF_INITTIME) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00702                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00703                     }
00704                 }
00705             }
00706         }
00707         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
00708     }
00709 
00710     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00711         RIPNTERR1(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,
00712                   RIP_WARNING,
00713                   <span class="stringliteral">"CreateWindowStation: Failed with Status 0x%x"</span>,
00714                   <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00715         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00716     }
00717 
00718     <span class="keywordflow">return</span> hwinsta;
00719 
00720     <span class="comment">/*</span>
00721 <span class="comment">     * Goto here if an error occurs so things can be cleaned up</span>
00722 <span class="comment">     */</span>
00723 create_error:
00724 
00725     RIPNTERR1(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,
00726               RIP_WARNING,
00727               <span class="stringliteral">"CreateWindowStation: Failed with Status 0x%x"</span>,
00728               <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00729 
00730     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
00731 
00732     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00733 }
00734 
00735 <span class="comment">/***************************************************************************\</span>
00736 <span class="comment">* FreeWindowStation</span>
00737 <span class="comment">*</span>
00738 <span class="comment">* Called when last lock to the windowstation is removed.  Frees all</span>
00739 <span class="comment">* resources owned by the windowstation.</span>
00740 <span class="comment">*</span>
00741 <span class="comment">* History:</span>
00742 <span class="comment">* 12-22-93 JimA         Created.</span>
00743 <span class="comment">\***************************************************************************/</span>
00744 
<a name="l00745"></a><a class="code" href="../../d8/d8/winsta_8c.html#a4">00745</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d8/winsta_8c.html#a4">FreeWindowStation</a>(
00746     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta)
00747 {
00748     UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pwinsta)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>);
00749 
00750     <span class="comment">/*</span>
00751 <span class="comment">     * Mark the windowstation as dying.  Make sure we're not recursing.</span>
00752 <span class="comment">     */</span>
00753     UserAssert(!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a318">WSF_DYING</a>));
00754     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a318">WSF_DYING</a>;
00755 
00756     UserAssert(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00757 
00758     <span class="comment">/*</span>
00759 <span class="comment">     * Free up the other resources</span>
00760 <span class="comment">     */</span>
00761 
00762     <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a21">gpEventSwitchDesktop</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00763         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a21">gpEventSwitchDesktop</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00764         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a21">gpEventSwitchDesktop</a>);
00765         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a21">gpEventSwitchDesktop</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00766     }
00767 
00768     BEGIN_REENTERCRIT();
00769 
00770     <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a14">RtlDestroyAtomTable</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o16">pGlobalAtomTable</a>);
00771 
00772     <a class="code" href="../../d4/d1/userk_8h.html#a1192">ForceEmptyClipboard</a>(pwinsta);
00773 
00774     <span class="comment">/*</span>
00775 <span class="comment">     * Free up keyboard layouts</span>
00776 <span class="comment">     */</span>
00777     <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) &amp;&amp; pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00778 
00779         <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>;
00780         <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklFirst = pkl;
00781 
00782         RIPMSG2(RIP_WARNING, <span class="stringliteral">"FreeWindowStation: pwinsta(%p)-&gt;spklList is not NULL, %p"</span>, pwinsta, pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>);
00783 
00784         <span class="keywordflow">do</span> {
00785             <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklNext = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
00786 
00787             <a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>(pkl);
00788             pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o3">dwKL_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a276">KL_UNLOADED</a>;
00789 
00790             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>, pklNext);
00791 
00792             pkl = pklNext;
00793 
00794         } <span class="keywordflow">while</span> (pkl != pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a> &amp;&amp; pkl != pklFirst);
00795 
00796         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>);
00797 
00798         <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a769">HH_KBDLYOUTFREEWINSTA</a>);
00799 
00800         <span class="comment">/*</span>
00801 <span class="comment">         * make sure the logon notify window went away</span>
00802 <span class="comment">         */</span>
00803         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00804     } <span class="keywordflow">else</span> {
00805         UserAssert(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00806     }
00807 
00808     <span class="comment">/*</span>
00809 <span class="comment">     * Free the USER sid</span>
00810 <span class="comment">     */</span>
00811     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00812         UserFreePool(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a>);
00813         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00814     }
00815 
00816     END_REENTERCRIT();
00817 }
00818 
00819 <span class="comment">/***************************************************************************\</span>
00820 <span class="comment">* DestroyWindowStation</span>
00821 <span class="comment">*</span>
00822 <span class="comment">* Removes the windowstation from the global list.  We can't release</span>
00823 <span class="comment">* any resources until all locks have been removed.</span>
00824 <span class="comment">* station.</span>
00825 <span class="comment">*</span>
00826 <span class="comment">* History:</span>
00827 <span class="comment">* 01-17-91 JimA         Created.</span>
00828 <span class="comment">\***************************************************************************/</span>
00829 
<a name="l00830"></a><a class="code" href="../../d8/d8/winsta_8c.html#a5">00830</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d8/winsta_8c.html#a5">DestroyWindowStation</a>(
00831     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00832     PVOID pobj,
00833     ACCESS_MASK amGranted,
00834     ULONG cProcessHandles,
00835     ULONG cSystemHandles)
00836 {
00837     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta = pobj;
00838     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> *ppwinsta;
00839     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
00840     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdeskLock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00841 
00842     UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pobj)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>);
00843 
00844     <span class="comment">/*</span>
00845 <span class="comment">     * If this is not the last handle, leave</span>
00846 <span class="comment">     */</span>
00847     <span class="keywordflow">if</span> (cSystemHandles != 1)
00848         <span class="keywordflow">return</span>;
00849 
00850     BEGIN_REENTERCRIT();
00851 
00852     <span class="comment">/*</span>
00853 <span class="comment">     * If the window station was linked into the terminal's list,</span>
00854 <span class="comment">     * go ahead and unlink it.</span>
00855 <span class="comment">     */</span>
00856     <span class="keywordflow">for</span> (ppwinsta = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>;
00857             *ppwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pwinsta != *ppwinsta;
00858             ppwinsta = &amp;(*ppwinsta)-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>)
00859         ;
00860     <span class="keywordflow">if</span> (*ppwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00861         <a class="code" href="../../d4/d1/userk_8h.html#a124">UnlockWinSta</a>(ppwinsta);
00862         <span class="comment">/*</span>
00863 <span class="comment">         * Assert that unlocking it didn't destroy it.</span>
00864 <span class="comment">         */</span>
00865         UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pobj)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>);
00866 
00867         *ppwinsta = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>;
00868         <span class="comment">/*</span>
00869 <span class="comment">         * The instruction above transfered rpwinstaNext lock ownership to the previous</span>
00870 <span class="comment">         *  element in the list. Hence the value in pwinsta can no longer be considered valid.</span>
00871 <span class="comment">         */</span>
00872         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00873     }
00874 
00875     <span class="comment">/*</span>
00876 <span class="comment">     * Notify all console threads and wait for them to</span>
00877 <span class="comment">     * terminate.</span>
00878 <span class="comment">     */</span>
00879     pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
00880     <span class="keywordflow">while</span> (pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00881         <span class="keywordflow">if</span> (pdesk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a> &amp;&amp; pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o17">dwConsoleThreadId</a>) {
00882             <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;pdeskLock, pdesk, LDL_FN_DESTROYWINDOWSTATION, 0);
00883             <a class="code" href="../../d4/d1/userk_8h.html#a1284">TerminateConsole</a>(pdesk);
00884 
00885             <span class="comment">/*</span>
00886 <span class="comment">             * Restart scan in case desktop list has changed</span>
00887 <span class="comment">             */</span>
00888             pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
00889             <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;pdeskLock, LDU_FN_DESTROYWINDOWSTATION, 0);
00890         } <span class="keywordflow">else</span>
00891             pdesk = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>;
00892     }
00893 
00894     END_REENTERCRIT();
00895 
00896     UNREFERENCED_PARAMETER(Process);
00897     UNREFERENCED_PARAMETER(cProcessHandles);
00898     UNREFERENCED_PARAMETER(amGranted);
00899 }
00900 
00901 
00902 <span class="comment">/***************************************************************************\</span>
00903 <span class="comment">* ParseWindowStation</span>
00904 <span class="comment">*</span>
00905 <span class="comment">* Parse a windowstation path.</span>
00906 <span class="comment">*</span>
00907 <span class="comment">* History:</span>
00908 <span class="comment">* 06-14-95 JimA         Created.</span>
00909 <span class="comment">\***************************************************************************/</span>
00910 
<a name="l00911"></a><a class="code" href="../../d8/d8/winsta_8c.html#a6">00911</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d8/d8/winsta_8c.html#a6">ParseWindowStation</a>(
00912     PVOID pContainerObject,
00913     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> pObjectType,
00914     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> pAccessState,
00915     KPROCESSOR_MODE AccessMode,
00916     ULONG Attributes,
00917     PUNICODE_STRING pstrCompleteName,
00918     PUNICODE_STRING pstrRemainingName,
00919     PVOID Context OPTIONAL,
00920     PSECURITY_QUALITY_OF_SERVICE pqos,
00921     PVOID *pObject)
00922 {
00923     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta = pContainerObject;
00924 
00925     UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pContainerObject)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>);
00926 
00927     <span class="comment">/*</span>
00928 <span class="comment">     * If nothing remains to be parsed, return the windowstation.</span>
00929 <span class="comment">     */</span>
00930     *pObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00931     <span class="keywordflow">if</span> (pstrRemainingName-&gt;Length == 0) {
00932         <span class="keywordflow">if</span> (pObjectType != *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>)
00933             <span class="keywordflow">return</span> STATUS_OBJECT_TYPE_MISMATCH;
00934 
00935         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(pwinsta);
00936         *pObject = pwinsta;
00937         <span class="keywordflow">return</span> STATUS_SUCCESS;
00938     }
00939 
00940     <span class="comment">/*</span>
00941 <span class="comment">     * Skip leading path separator, if present.</span>
00942 <span class="comment">     */</span>
00943     <span class="keywordflow">if</span> (*(pstrRemainingName-&gt;Buffer) == OBJ_NAME_PATH_SEPARATOR) {
00944         pstrRemainingName-&gt;Buffer++;
00945         pstrRemainingName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
00946         pstrRemainingName-&gt;MaximumLength -= <span class="keyword">sizeof</span>(WCHAR);
00947     }
00948 
00949     <span class="comment">/*</span>
00950 <span class="comment">     * Validate the desktop name.</span>
00951 <span class="comment">     */</span>
00952     <span class="keywordflow">if</span> (wcschr(pstrRemainingName-&gt;Buffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>))
00953         <span class="keywordflow">return</span> STATUS_OBJECT_PATH_INVALID;
00954     <span class="keywordflow">if</span> (pObjectType == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00955         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1292">ParseDesktop</a>(
00956                 pContainerObject,
00957                 pObjectType,
00958                 pAccessState,
00959                 AccessMode,
00960                 Attributes,
00961                 pstrCompleteName,
00962                 pstrRemainingName,
00963                 Context,
00964                 pqos,
00965                 pObject);
00966     }
00967 
00968     <span class="keywordflow">return</span> STATUS_OBJECT_TYPE_MISMATCH;
00969 }
00970 
00971 
00972 <span class="comment">/***************************************************************************\</span>
00973 <span class="comment">* OkayToCloseWindowStation</span>
00974 <span class="comment">*</span>
00975 <span class="comment">* We can only close windowstation handles if they're not in use.</span>
00976 <span class="comment">*</span>
00977 <span class="comment">* History:</span>
00978 <span class="comment">* 08-Feb-1999 JerrySh   Created.</span>
00979 <span class="comment">\***************************************************************************/</span>
00980 
<a name="l00981"></a><a class="code" href="../../d8/d8/winsta_8c.html#a7">00981</a> BOOLEAN <a class="code" href="../../d8/d8/winsta_8c.html#a7">OkayToCloseWindowStation</a>(
00982     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process OPTIONAL,
00983     PVOID Object,
00984     HANDLE Handle)
00985 {
00986     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta = (<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>)Object;
00987 
00988     UNREFERENCED_PARAMETER(Process);
00989 
00990     UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(Object)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>);
00991 
00992     <span class="comment">/*</span>
00993 <span class="comment">     * Kernel mode code can close anything.</span>
00994 <span class="comment">     */</span>
00995     <span class="keywordflow">if</span> (KeGetPreviousMode() == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00996         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00997     }
00998 
00999     <span class="comment">/*</span>
01000 <span class="comment">     * We can't close a windowstation that's being used.</span>
01001 <span class="comment">     */</span>
01002     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2072">CheckHandleInUse</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>) || <a class="code" href="../../d4/d1/userk_8h.html#a2070">CheckHandleFlag</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, <a class="code" href="../../d4/d1/userk_8h.html#a747">HF_PROTECTED</a>)) {
01003         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Trying to close windowstation %#p while still in use"</span>, pwinsta);
01004         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01005     }
01006 
01007     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01008 }
01009 
01010 <span class="comment">/***************************************************************************\</span>
01011 <span class="comment">* _OpenWindowStation</span>
01012 <span class="comment">*</span>
01013 <span class="comment">* Open a windowstation for the calling process</span>
01014 <span class="comment">*</span>
01015 <span class="comment">* History:</span>
01016 <span class="comment">* 03-19-91 JimA         Created.</span>
01017 <span class="comment">\***************************************************************************/</span>
01018 
<a name="l01019"></a><a class="code" href="../../d8/d8/winsta_8c.html#a8">01019</a> HWINSTA <a class="code" href="../../d8/d8/winsta_8c.html#a8">_OpenWindowStation</a>(
01020     POBJECT_ATTRIBUTES pObjA,
01021     DWORD dwDesiredAccess,
01022     KPROCESSOR_MODE AccessMode)
01023 {
01024     HWINSTA hwinsta;
01025     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01026 
01027     <span class="comment">/*</span>
01028 <span class="comment">     * Obja is client-side.  Ob interfaces protect and capture is</span>
01029 <span class="comment">     * appropriate.</span>
01030 <span class="comment">     */</span>
01031     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(
01032             pObjA,
01033             *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>,
01034             AccessMode,
01035             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01036             dwDesiredAccess,
01037             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01038             &amp;hwinsta);
01039     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01040         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">""</span>);
01041         hwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01042     }
01043     <span class="keywordflow">return</span> hwinsta;
01044 }
01045 
01046 <span class="comment">/***************************************************************************\</span>
01047 <span class="comment">* _CloseWindowStation</span>
01048 <span class="comment">*</span>
01049 <span class="comment">* Closes a windowstation for the calling process</span>
01050 <span class="comment">*</span>
01051 <span class="comment">* History:</span>
01052 <span class="comment">* 15-Jun-1999 JerrySh   Created.</span>
01053 <span class="comment">\***************************************************************************/</span>
01054 
<a name="l01055"></a><a class="code" href="../../d8/d8/winsta_8c.html#a9">01055</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d8/winsta_8c.html#a9">_CloseWindowStation</a>(
01056     HWINSTA hwinsta)
01057 {
01058     HWINSTA hwinstaCurrent;
01059 
01060     <a class="code" href="../../d8/d8/winsta_8c.html#a11">_GetProcessWindowStation</a>(&amp;hwinstaCurrent);
01061     <span class="keywordflow">if</span> (hwinsta != hwinstaCurrent) {
01062         <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ZwClose(hwinsta));
01063     }
01064     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01065 }
01066 
01067 <span class="comment">/***************************************************************************\</span>
01068 <span class="comment">* xxxSetProcessWindowStation (API)</span>
01069 <span class="comment">*</span>
01070 <span class="comment">* Sets the windowstation of the calling process to the windowstation</span>
01071 <span class="comment">* specified by pwinsta.</span>
01072 <span class="comment">*</span>
01073 <span class="comment">* History:</span>
01074 <span class="comment">* 01-14-91 JimA         Created.</span>
01075 <span class="comment">\***************************************************************************/</span>
01076 
<a name="l01077"></a><a class="code" href="../../d8/d8/winsta_8c.html#a10">01077</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d8/winsta_8c.html#a10">xxxSetProcessWindowStation</a>(
01078     HWINSTA         hwinsta,
01079     KPROCESSOR_MODE AccessMode)
01080 {
01081     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>                    Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01082     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>                   Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01083     HWINSTA                     hwinstaDup;
01084     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01085     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>                ppi;
01086     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>              pwinsta;
01087     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>              pwinstaOld;
01088     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a>   ohi;
01089     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a>   ohiOld;
01090 
01091     <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01092         UserAssert(Process);
01093         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01094     }
01095 
01096     <span class="keywordflow">if</span> (Thread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01097         UserAssert(Thread);
01098         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01099     }
01100 
01101     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(<a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread));
01102 
01103     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01104             hwinsta,
01105             0,
01106             *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>,
01107             AccessMode,
01108             &amp;pwinsta,
01109             &amp;ohi))) {
01110         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01111     }
01112 
01113    <span class="comment">/*</span>
01114 <span class="comment">    * Bug 38780. Lock the handle to window station so that an app cannot free the</span>
01115 <span class="comment">    * this handle by calling  GetProcessWindowStation() &amp; CloseHandle()</span>
01116 <span class="comment">    */</span>
01117 
01118     <span class="comment">/*</span>
01119 <span class="comment">     * Unprotect the old hwinsta</span>
01120 <span class="comment">     */</span>
01121     <span class="keywordflow">if</span> (ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o15">hwinsta</a>) {
01122         <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o15">hwinsta</a>, <a class="code" href="../../d4/d1/userk_8h.html#a747">HF_PROTECTED</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01123     }
01124 
01125     <span class="comment">/*</span>
01126 <span class="comment">     * Save the WindowStation information</span>
01127 <span class="comment">     */</span>
01128     <a class="code" href="../../d4/d1/userk_8h.html#a125">LockWinSta</a>(&amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a>, pwinsta);
01129     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
01130     ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o15">hwinsta</a> = hwinsta;
01131 
01132     <span class="comment">/*</span>
01133 <span class="comment">     * Protect the new Window Station Handle</span>
01134 <span class="comment">     */</span>
01135     <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o15">hwinsta</a>, <a class="code" href="../../d4/d1/userk_8h.html#a747">HF_PROTECTED</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01136 
01137     <span class="comment">/*</span>
01138 <span class="comment">     * Check the old Atom Manager WindowStation to see if we are</span>
01139 <span class="comment">     * changing this process' WindowStation.</span>
01140 <span class="comment">     */</span>
01141     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a>) {
01142         <span class="comment">/*</span>
01143 <span class="comment">         * Get a pointer to the old WindowStation object to see if it's</span>
01144 <span class="comment">         * the same WindowStation that we are setting.</span>
01145 <span class="comment">         */</span>
01146         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01147             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a>,
01148             0,
01149             *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>,
01150             AccessMode,
01151             &amp;pwinstaOld,
01152             &amp;ohiOld);
01153         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01154             <span class="comment">/*</span>
01155 <span class="comment">             * Are they different WindowStations?  If so, NULL out the</span>
01156 <span class="comment">             * atom manager cache so we will reset it below.</span>
01157 <span class="comment">             */</span>
01158             <span class="keywordflow">if</span> (pwinsta != pwinstaOld) {
01159                 ZwClose(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a>);
01160                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01161             }
01162             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinstaOld);
01163 
01164         } <span class="keywordflow">else</span> {
01165             <span class="comment">/*</span>
01166 <span class="comment">             * Their Atom Manager handle is bad?  Give them a new one.</span>
01167 <span class="comment">             */</span>
01168             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01169 <span class="preprocessor">#if DBG</span>
01170 <span class="preprocessor"></span>            RIPMSG2(RIP_WARNING,
01171                     <span class="stringliteral">"SetProcessWindowStation: Couldn't reference old WindowStation (0x%X) Status=0x%X"</span>,
01172                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a>,
01173                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01174 <span class="preprocessor">#endif</span>
01175 <span class="preprocessor"></span>        }
01176     }
01177 
01178     <span class="comment">/*</span>
01179 <span class="comment">     * Duplicate the WindowStation handle and stash it in the atom</span>
01180 <span class="comment">     * manager's cache (Process-&gt;Win32WindowStation).  We duplicate</span>
01181 <span class="comment">     * the handle in case</span>
01182 <span class="comment">     */</span>
01183     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01184         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1275">xxxUserDuplicateObject</a>(
01185                      NtCurrentProcess(),
01186                      hwinsta,
01187                      NtCurrentProcess(),
01188                      &amp;hwinstaDup,
01189                      0,
01190                      0,
01191                      DUPLICATE_SAME_ACCESS);
01192 
01193         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01194             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a> = hwinstaDup;
01195         }
01196 <span class="preprocessor">#if DBG</span>
01197 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
01198             RIPMSG2(RIP_WARNING,
01199                     <span class="stringliteral">"SetProcessWindowStation: Couldn't duplicate WindowStation handle (0x%X) Status=0x%X"</span>,
01200                     hwinsta,
01201                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01202         }
01203 <span class="preprocessor">#endif</span>
01204 <span class="preprocessor"></span>    }
01205 
01206     ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o16">amwinsta</a> = ohi.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>;
01207 
01208     <span class="comment">/*</span>
01209 <span class="comment">     * Cache WSF_NOIO flag in the W32PROCESS so that GDI can access it.</span>
01210 <span class="comment">     */</span>
01211     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) {
01212         ppi-&gt;W32PF_Flags &amp;= ~W32PF_IOWINSTA;
01213     } <span class="keywordflow">else</span> {
01214         ppi-&gt;W32PF_Flags |= W32PF_IOWINSTA;
01215     }
01216 
01217     <span class="comment">/*</span>
01218 <span class="comment">     * Do the access check now for readscreen so that</span>
01219 <span class="comment">     * blts off of the display will be as fast as possible.</span>
01220 <span class="comment">     */</span>
01221     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a68">RtlAreAllAccessesGranted</a>(ohi.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>, WINSTA_READSCREEN)) {
01222         ppi-&gt;W32PF_Flags |= W32PF_READSCREENACCESSGRANTED;
01223     } <span class="keywordflow">else</span> {
01224         ppi-&gt;W32PF_Flags &amp;= ~W32PF_READSCREENACCESSGRANTED;
01225     }
01226 
01227     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01228 }
01229 
01230 
01231 <span class="comment">/***************************************************************************\</span>
01232 <span class="comment">* _GetProcessWindowStation (API)</span>
01233 <span class="comment">*</span>
01234 <span class="comment">* Returns a pointer to the windowstation of the calling process.</span>
01235 <span class="comment">*</span>
01236 <span class="comment">* History:</span>
01237 <span class="comment">* 01-14-91 JimA         Created.</span>
01238 <span class="comment">\***************************************************************************/</span>
01239 
<a name="l01240"></a><a class="code" href="../../d8/d8/winsta_8c.html#a11">01240</a> <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> <a class="code" href="../../d8/d8/winsta_8c.html#a11">_GetProcessWindowStation</a>(
01241     HWINSTA *phwinsta)
01242 {
01243     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
01244 
01245     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
01246     UserAssert(ppi);
01247 
01248     <span class="keywordflow">if</span> (phwinsta)
01249         *phwinsta = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o15">hwinsta</a>;
01250     <span class="keywordflow">return</span> ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a>;
01251 }
01252 
01253 
01254 <span class="comment">/***************************************************************************\</span>
01255 <span class="comment">* _BuildNameList</span>
01256 <span class="comment">*</span>
01257 <span class="comment">* Builds a list of windowstation or desktop names.</span>
01258 <span class="comment">*</span>
01259 <span class="comment">* History:</span>
01260 <span class="comment">* 05-17-94 JimA         Created.</span>
01261 <span class="comment">* 10-21-96 CLupu        Added TERMINAL enumeration</span>
01262 <span class="comment">\***************************************************************************/</span>
01263 
<a name="l01264"></a><a class="code" href="../../d8/d8/winsta_8c.html#a12">01264</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d8/d8/winsta_8c.html#a12">_BuildNameList</a>(
01265     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta,
01266     <a class="code" href="../../d8/d2/structtagNAMELIST.html">PNAMELIST</a>      ccxpNameList,
01267     UINT           cbNameList,
01268     PUINT          pcbNeeded)
01269 {
01270     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>                    pobj;
01271     PWCHAR                   ccxpwchDest, ccxpwchMax;
01272     ACCESS_MASK              amDesired;
01273     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>           pHead;
01274     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> pNameInfo;
01275     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                    iNext;
01276     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01277     CONST GENERIC_MAPPING *pGenericMapping;
01278 
01279 <span class="comment">/*</span>
01280 <span class="comment"> * Note -- NameList is client-side, and so must be protected.</span>
01281 <span class="comment"> */</span>
01282 
01283     <span class="keywordflow">try</span> {
01284         ccxpNameList-&gt;<a class="code" href="../../d8/d2/structtagNAMELIST.html#o1">cNames</a> = 0;
01285     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
01286         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01287     }
01288 
01289     ccxpwchDest = ccxpNameList-&gt;<a class="code" href="../../d8/d2/structtagNAMELIST.html#o2">awchNames</a>;
01290     ccxpwchMax = (PWCHAR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpNameList + cbNameList - <span class="keyword">sizeof</span>(WCHAR));
01291 
01292     <span class="comment">/*</span>
01293 <span class="comment">     * If we're enumerating windowstations, pwinsta is NULL.  Otherwise,</span>
01294 <span class="comment">     * we're enumerating desktops.</span>
01295 <span class="comment">     */</span>
01296     <span class="keywordflow">if</span> (pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01297         pobj  = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>;
01298         amDesired = WINSTA_ENUMERATE;
01299         pGenericMapping = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a304">WinStaMapping</a>;
01300         iNext = FIELD_OFFSET(<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">WINDOWSTATION</a>, rpwinstaNext);
01301     } <span class="keywordflow">else</span> {
01302         pobj = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
01303         amDesired = DESKTOP_ENUMERATE;
01304         pGenericMapping = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a305">DesktopMapping</a>;
01305         iNext = FIELD_OFFSET(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>, rpdeskNext);
01306     }
01307 
01308     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01309     *pcbNeeded = 0;
01310     <span class="keywordflow">while</span> (pobj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01311 
01312         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1271">AccessCheckObject</a>(pobj, amDesired, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, pGenericMapping)) {
01313 
01314             <span class="comment">/*</span>
01315 <span class="comment">             * Find object name</span>
01316 <span class="comment">             */</span>
01317             pHead = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pobj);
01318             pNameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>(pHead);
01319 
01320             <span class="comment">/*</span>
01321 <span class="comment">             * If we run out of space, reset the buffer</span>
01322 <span class="comment">             * and continue so we can compute the needed</span>
01323 <span class="comment">             * space.</span>
01324 <span class="comment">             */</span>
01325             <span class="keywordflow">if</span> ((PWCHAR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpwchDest + pNameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length +
01326                     <span class="keyword">sizeof</span>(WCHAR)) &gt;= ccxpwchMax) {
01327                 *pcbNeeded += (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpwchDest - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpNameList);
01328                 ccxpwchDest = ccxpNameList-&gt;<a class="code" href="../../d8/d2/structtagNAMELIST.html#o2">awchNames</a>;
01329                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
01330             }
01331 
01332             <span class="keywordflow">try</span> {
01333                 ccxpNameList-&gt;<a class="code" href="../../d8/d2/structtagNAMELIST.html#o1">cNames</a>++;
01334 
01335                 <span class="comment">/*</span>
01336 <span class="comment">                 * Copy and terminate the string</span>
01337 <span class="comment">                 */</span>
01338                 RtlCopyMemory(ccxpwchDest, pNameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer,
01339                     pNameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length);
01340                 (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpwchDest += pNameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length;
01341                 *ccxpwchDest++ = 0;
01342             } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
01343                 <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01344             }
01345         }
01346 
01347         pobj = *(<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>*)(pobj + iNext);
01348     }
01349 
01350     <span class="comment">/*</span>
01351 <span class="comment">     * Put an empty string on the end.</span>
01352 <span class="comment">     */</span>
01353     <span class="keywordflow">try</span> {
01354         *ccxpwchDest++ = 0;
01355 
01356         ccxpNameList-&gt;<a class="code" href="../../d8/d2/structtagNAMELIST.html#o0">cb</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpwchDest - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpNameList);
01357     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
01358         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01359     }
01360 
01361     *pcbNeeded += (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpwchDest - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpNameList);
01362 
01363     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01364 }
01365 
<a name="l01366"></a><a class="code" href="../../d8/d8/winsta_8c.html#a13">01366</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d8/d8/winsta_8c.html#a13">ReferenceWindowStation</a>(
01367     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread,
01368     HWINSTA hwinsta,
01369     ACCESS_MASK amDesiredAccess,
01370     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> *ppwinsta,
01371     BOOL fUseDesktop)
01372 {
01373     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
01374     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
01375     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01376     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01377 
01378     <span class="comment">/*</span>
01379 <span class="comment">     * We prefer to use the thread's desktop to dictate which</span>
01380 <span class="comment">     * windowstation/Atom table to use rather than the process.</span>
01381 <span class="comment">     * This allows NetDDE, which has threads running under</span>
01382 <span class="comment">     * different desktops on different windowstations but whos</span>
01383 <span class="comment">     * process is set to only one of these windowstations, to</span>
01384 <span class="comment">     * get global atoms properly without having to change its</span>
01385 <span class="comment">     * process windowstation a billion times and synchronize.</span>
01386 <span class="comment">     */</span>
01387     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o28">ThreadsProcess</a>);
01388     pti = <a class="code" href="../../d4/d1/userk_8h.html#a17">PtiFromThread</a>(Thread);
01389 
01390     <span class="comment">/*</span>
01391 <span class="comment">     * First, try to get the windowstation from the pti, and then</span>
01392 <span class="comment">     * from the ppi.</span>
01393 <span class="comment">     */</span>
01394     <span class="keywordflow">if</span> (ppi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01395         <span class="keywordflow">if</span> (!fUseDesktop || pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01396                 ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a> == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>) {
01397 
01398             <span class="comment">/*</span>
01399 <span class="comment">             * Use the windowstation assigned to the process.</span>
01400 <span class="comment">             */</span>
01401             pwinsta = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a>;
01402             <span class="keywordflow">if</span> (pwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01403                 <a class="code" href="../../d4/d1/userk_8h.html#a263">RETURN_IF_ACCESS_DENIED</a>(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o16">amwinsta</a>, amDesiredAccess,
01404                         STATUS_ACCESS_DENIED);
01405             }
01406         }
01407 
01408         <span class="comment">/*</span>
01409 <span class="comment">         * If we aren't using the process' windowstation, try to</span>
01410 <span class="comment">         * go through the thread's desktop.</span>
01411 <span class="comment">         */</span>
01412         <span class="keywordflow">if</span> (pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01413 
01414             <span class="comment">/*</span>
01415 <span class="comment">             * Perform access check the parent windowstation.  This</span>
01416 <span class="comment">             * is an expensive operation.</span>
01417 <span class="comment">             */</span>
01418             pwinsta = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>;
01419             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1271">AccessCheckObject</a>(pwinsta, amDesiredAccess, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a304">WinStaMapping</a>))
01420                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01421         }
01422     }
01423 
01424     <span class="comment">/*</span>
01425 <span class="comment">     * If we still don't have a windowstation and a handle was</span>
01426 <span class="comment">     * passed in, use it.</span>
01427 <span class="comment">     */</span>
01428     <span class="keywordflow">if</span> (pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01429         <span class="keywordflow">if</span> (hwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01430             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01431                     hwinsta,
01432                     amDesiredAccess,
01433                     *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>,
01434                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01435                     &amp;pwinsta,
01436                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01437             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01438                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01439             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
01440         } <span class="keywordflow">else</span> {
01441             <span class="keywordflow">return</span> STATUS_NOT_FOUND;
01442         }
01443     }
01444 
01445     *ppwinsta = pwinsta;
01446 
01447     <span class="keywordflow">return</span> STATUS_SUCCESS;
01448 }
01449 
01450 <span class="comment">/***************************************************************************\</span>
01451 <span class="comment">* _SetWindowStationUser</span>
01452 <span class="comment">*</span>
01453 <span class="comment">* Private API for winlogon to associate a windowstation with a user.</span>
01454 <span class="comment">*</span>
01455 <span class="comment">* History:</span>
01456 <span class="comment">* 06-27-94 JimA         Created.</span>
01457 <span class="comment">\***************************************************************************/</span>
01458 
<a name="l01459"></a><a class="code" href="../../d8/d8/winsta_8c.html#a14">01459</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d8/d8/winsta_8c.html#a14">_SetWindowStationUser</a>(
01460     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta,
01461     PLUID pluidUser,
01462     PSID ccxpsidUser,
01463     DWORD cbsidUser)
01464 {
01465 
01466     <span class="comment">/*</span>
01467 <span class="comment">     * Make sure the caller is the logon process</span>
01468 <span class="comment">     */</span>
01469     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a19">GetCurrentProcessId</a>() != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
01470         RIPERR0(ERROR_ACCESS_DENIED,
01471                 RIP_WARNING,
01472                 <span class="stringliteral">"Access denied in _SetWindowStationUser: caller must be in the logon process"</span>);
01473 
01474         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01475     }
01476 
01477     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01478         UserFreePool(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a>);
01479 
01480     <span class="keywordflow">if</span> (ccxpsidUser != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01481         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> = UserAllocPoolWithQuota(cbsidUser, TAG_SECURITY);
01482         <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01483             RIPERR0(ERROR_OUTOFMEMORY,
01484                     RIP_WARNING,
01485                     <span class="stringliteral">"Memory allocation failed in _SetWindowStationUser"</span>);
01486 
01487             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01488         }
01489         <span class="keywordflow">try</span> {
01490             RtlCopyMemory(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a>, ccxpsidUser, cbsidUser);
01491         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, RIP_WARNING)) {
01492 
01493             UserFreePool(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a>);
01494             pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01495             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01496         }
01497     } <span class="keywordflow">else</span> {
01498         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01499     }
01500 
01501     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o18">luidUser</a> = *pluidUser;
01502 
01503     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01504 }
01505 
01506 
01507 <span class="comment">/***************************************************************************\</span>
01508 <span class="comment">* _LockWorkStation (API)</span>
01509 <span class="comment">*</span>
01510 <span class="comment">* locks the workstation. This API just posts a message to winlogon</span>
01511 <span class="comment">* and winlogon does all the work</span>
01512 <span class="comment">*</span>
01513 <span class="comment">* History:</span>
01514 <span class="comment">* 06-11-97 CLupu        Created.</span>
01515 <span class="comment">\***************************************************************************/</span>
01516 
<a name="l01517"></a><a class="code" href="../../d8/d8/winsta_8c.html#a15">01517</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d8/winsta_8c.html#a15">_LockWorkStation</a>(
01518     VOID)
01519 {
01520     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01521 
01522     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>,
01523                  WM_LOGONNOTIFY, LOGON_LOCKWORKSTATION, 0);
01524 
01525     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01526 }
01527 
01528 <span class="preprocessor">#ifdef LATER    // HY</span>
01529 <span class="preprocessor"></span><a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> _IsIoDesktop(
01530     HDESK hdesk)
01531 {
01532     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01533     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01534     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01535 
01536     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/validate_8c.html#a7">ValidateHdesk</a>(hdesk, UserMode, 0, &amp;pdesk);
01537     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01538         UserAssert(pdesk &amp;&amp; pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>);
01539         fRet = (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) == 0;
01540         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
01541     }
01542     <span class="keywordflow">return</span> fRet;
01543 }
01544 <span class="preprocessor">#endif</span>
01545 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
