<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: exceptn.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>exceptn.c</h1><a href="../../d8/d8/alpha_2exceptn_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment">Copyright (c) 1993, 1994  Digital Equipment Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    exceptn.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module implements the code necessary to dispatch exceptions to the</span>
00013 <span class="comment">    proper mode and invoke the exception dispatcher.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    David N. Cutler (davec) 3-Apr-1990</span>
00018 <span class="comment"></span>
00019 <span class="comment">Environment:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Kernel mode only.</span>
00022 <span class="comment"></span>
00023 <span class="comment">Revision History:</span>
00024 <span class="comment"></span>
00025 <span class="comment">    Thomas Van Baak (tvb) 12-May-1992</span>
00026 <span class="comment"></span>
00027 <span class="comment">        Adapted for Alpha AXP.</span>
00028 <span class="comment"></span>
00029 <span class="comment">--*/</span>
00030 
00031 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00032 
00033 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00034 <a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a2">KiMachineCheck</a> (
00035     IN PEXCEPTION_RECORD ExceptionRecord,
00036     IN PKEXCEPTION_FRAME ExceptionFrame,
00037     IN PKTRAP_FRAME TrapFrame
00038     );
00039 
00040 <span class="comment">//</span>
00041 <span class="comment">// Alpha data misalignment exception (auto alignment fixup) control.</span>
00042 <span class="comment">//</span>
00043 <span class="comment">// If KiEnableAlignmentFaultExceptions is 0, then no alignment</span>
00044 <span class="comment">// exceptions are raised and all misaligned user and kernel mode data</span>
00045 <span class="comment">// references are emulated. This is consistent with NT/Alpha version</span>
00046 <span class="comment">// 3.1 behavior.</span>
00047 <span class="comment">//</span>
00048 <span class="comment">// If KiEnableAlignmentFaultExceptions is 1, then the</span>
00049 <span class="comment">// current thread automatic alignment fixup enable determines whether</span>
00050 <span class="comment">// emulation is attempted in user mode. This is consistent with NT/Mips</span>
00051 <span class="comment">// behavior.</span>
00052 <span class="comment">//</span>
00053 <span class="comment">// If KiEnableAlignmentFaultExceptions is 2 and the process is being</span>
00054 <span class="comment">// debugged, the current thread automatic alignment fixup enable determines</span>
00055 <span class="comment">// whether emulation is attempted in user mode. This allows developers to</span>
00056 <span class="comment">// easily find and fix alignment problems.</span>
00057 <span class="comment">//</span>
00058 <span class="comment">// If KiEnableAlignmentFaultExceptions is 2 and the process is NOT being</span>
00059 <span class="comment">// debugged, then no alignment exceptions are raised and all misaligned</span>
00060 <span class="comment">// user and kernel mode data references are emulated.</span>
00061 <span class="comment">//</span>
00062 <span class="comment">// N.B. This default value may be reset from the Registry during init.</span>
00063 <span class="comment">//</span>
00064 
00065 <span class="preprocessor">#if defined(_AXP64_) &amp;&amp; defined(_AXP64_FIXFIX)</span>
00066 <span class="preprocessor"></span>
00067 <span class="comment">//</span>
00068 <span class="comment">// On AXP64, the default is to disable alignment fault fixups.</span>
00069 <span class="comment">//</span>
00070 <span class="comment">// FIXFIX: This code is currently disabled by _AXP64_FIXFIX.</span>
00071 
00072 <span class="preprocessor">#define DEFAULT_NO_ALIGNMENT_FIXUPS TRUE</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00074"></a><a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a0">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_NO_ALIGNMENT_FIXUPS FALSE</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00076 <span class="preprocessor"></span>
<a name="l00077"></a><a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a1">00077</a> ULONG <a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a1">KiEnableAlignmentFaultExceptions</a> = <a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a0">DEFAULT_NO_ALIGNMENT_FIXUPS</a> ? 1 : 0;
00078 
00079 <span class="preprocessor">#if DBG</span>
00080 <span class="preprocessor"></span>
00081 <span class="comment">//</span>
00082 <span class="comment">// Set KiBreakOnAlignmentFault to TRUE to stop the debugger on each alignment</span>
00083 <span class="comment">// fault.</span>
00084 <span class="comment">//</span>
00085 
00086 BOOLEAN KiBreakOnAlignmentFault = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00087 
00088 <span class="comment">//</span>
00089 <span class="comment">// Alignment fixups are counted by mode and reported at intervals.</span>
00090 <span class="comment">//</span>
00091 <span class="comment">// N.B. Set masks to 0 to see every exception (set to 0x7 to see every</span>
00092 <span class="comment">//      8th, etc.).</span>
00093 <span class="comment">//</span>
00094 
00095 ULONG KiKernelFixupCount = 0;
00096 ULONG KiKernelFixupMask = <a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a0">DEFAULT_NO_ALIGNMENT_FIXUPS</a> ? 0 : 0x7f;
00097 
00098 ULONG KiUserFixupCount = 0;
00099 ULONG KiUserFixupMask = <a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a0">DEFAULT_NO_ALIGNMENT_FIXUPS</a> ? 0 : 0x3ff;
00100 
00101 <span class="preprocessor">#endif</span>
00102 <span class="preprocessor"></span>
00103 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00104"></a><a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a3">00104</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a> (
00105     IN PKTRAP_FRAME TrapFrame,
00106     IN PKEXCEPTION_FRAME ExceptionFrame,
00107     IN OUT PCONTEXT ContextFrame
00108     )
00109 
00110 <span class="comment">/*++</span>
00111 <span class="comment"></span>
00112 <span class="comment">Routine Description:</span>
00113 <span class="comment"></span>
00114 <span class="comment">    This routine moves the selected contents of the specified trap and exception</span>
00115 <span class="comment">    frames into the specified context frame according to the specified context</span>
00116 <span class="comment">    flags.</span>
00117 <span class="comment"></span>
00118 <span class="comment">Arguments:</span>
00119 <span class="comment"></span>
00120 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame from which volatile context</span>
00121 <span class="comment">        should be copied into the context record.</span>
00122 <span class="comment"></span>
00123 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame from which context</span>
00124 <span class="comment">        should be copied into the context record.</span>
00125 <span class="comment"></span>
00126 <span class="comment">    ContextFrame - Supplies a pointer to the context frame that receives the</span>
00127 <span class="comment">        context copied from the trap and exception frames.</span>
00128 <span class="comment"></span>
00129 <span class="comment">Return Value:</span>
00130 <span class="comment"></span>
00131 <span class="comment">    None.</span>
00132 <span class="comment"></span>
00133 <span class="comment">--*/</span>
00134 
00135 {
00136 
00137     <span class="comment">//</span>
00138     <span class="comment">// Set control information if specified.</span>
00139     <span class="comment">//</span>
00140 
00141     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00142 
00143         <span class="comment">//</span>
00144         <span class="comment">// Set integer register gp, ra, sp, FIR, and PSR from trap frame.</span>
00145         <span class="comment">//</span>
00146 
00147         ContextFrame-&gt;IntGp = TrapFrame-&gt;IntGp;
00148         ContextFrame-&gt;IntSp = TrapFrame-&gt;IntSp;
00149         ContextFrame-&gt;IntRa = TrapFrame-&gt;IntRa;
00150         ContextFrame-&gt;Fir = TrapFrame-&gt;Fir;
00151         ContextFrame-&gt;Psr = TrapFrame-&gt;Psr;
00152     }
00153 
00154     <span class="comment">//</span>
00155     <span class="comment">// Set integer register contents if specified.</span>
00156     <span class="comment">//</span>
00157 
00158     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00159 
00160         <span class="comment">//</span>
00161         <span class="comment">// Set volatile integer registers v0 and t0 - t7 from trap frame.</span>
00162         <span class="comment">//</span>
00163 
00164         ContextFrame-&gt;IntV0 = TrapFrame-&gt;IntV0;
00165         ContextFrame-&gt;IntT0 = TrapFrame-&gt;IntT0;
00166         ContextFrame-&gt;IntT1 = TrapFrame-&gt;IntT1;
00167         ContextFrame-&gt;IntT2 = TrapFrame-&gt;IntT2;
00168         ContextFrame-&gt;IntT3 = TrapFrame-&gt;IntT3;
00169         ContextFrame-&gt;IntT4 = TrapFrame-&gt;IntT4;
00170         ContextFrame-&gt;IntT5 = TrapFrame-&gt;IntT5;
00171         ContextFrame-&gt;IntT6 = TrapFrame-&gt;IntT6;
00172         ContextFrame-&gt;IntT7 = TrapFrame-&gt;IntT7;
00173 
00174         <span class="comment">//</span>
00175         <span class="comment">// Set nonvolatile integer registers s0 - s5 from exception frame.</span>
00176         <span class="comment">//</span>
00177 
00178         ContextFrame-&gt;IntS0 = ExceptionFrame-&gt;IntS0;
00179         ContextFrame-&gt;IntS1 = ExceptionFrame-&gt;IntS1;
00180         ContextFrame-&gt;IntS2 = ExceptionFrame-&gt;IntS2;
00181         ContextFrame-&gt;IntS3 = ExceptionFrame-&gt;IntS3;
00182         ContextFrame-&gt;IntS4 = ExceptionFrame-&gt;IntS4;
00183         ContextFrame-&gt;IntS5 = ExceptionFrame-&gt;IntS5;
00184 
00185         <span class="comment">//</span>
00186         <span class="comment">// Set volatile integer registers a0 - a5, and t8 - t11 from trap</span>
00187         <span class="comment">// frame.</span>
00188         <span class="comment">//</span>
00189 
00190         ContextFrame-&gt;IntA0 = TrapFrame-&gt;IntA0;
00191         ContextFrame-&gt;IntA1 = TrapFrame-&gt;IntA1;
00192         ContextFrame-&gt;IntA2 = TrapFrame-&gt;IntA2;
00193         ContextFrame-&gt;IntA3 = TrapFrame-&gt;IntA3;
00194         ContextFrame-&gt;IntA4 = TrapFrame-&gt;IntA4;
00195         ContextFrame-&gt;IntA5 = TrapFrame-&gt;IntA5;
00196 
00197         ContextFrame-&gt;IntT8 = TrapFrame-&gt;IntT8;
00198         ContextFrame-&gt;IntT9 = TrapFrame-&gt;IntT9;
00199         ContextFrame-&gt;IntT10 = TrapFrame-&gt;IntT10;
00200         ContextFrame-&gt;IntT11 = TrapFrame-&gt;IntT11;
00201 
00202         <span class="comment">//</span>
00203         <span class="comment">// Set volatile integer registers fp, t12 and at from trap frame.</span>
00204         <span class="comment">// Set integer register zero.</span>
00205         <span class="comment">//</span>
00206 
00207         ContextFrame-&gt;IntFp = TrapFrame-&gt;IntFp;
00208         ContextFrame-&gt;IntT12 = TrapFrame-&gt;IntT12;
00209         ContextFrame-&gt;IntAt = TrapFrame-&gt;IntAt;
00210         ContextFrame-&gt;IntZero = 0;
00211     }
00212 
00213     <span class="comment">//</span>
00214     <span class="comment">// Set floating register contents if specified.</span>
00215     <span class="comment">//</span>
00216 
00217     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00218 
00219         <span class="comment">//</span>
00220         <span class="comment">// Set volatile floating registers f0 - f1 from trap frame.</span>
00221         <span class="comment">// Set volatile floating registers f10 - f30 from trap frame.</span>
00222         <span class="comment">// Set floating zero register f31 to 0.</span>
00223         <span class="comment">//</span>
00224 
00225         ContextFrame-&gt;FltF0 = TrapFrame-&gt;FltF0;
00226         ContextFrame-&gt;FltF1 = TrapFrame-&gt;FltF1;
00227         RtlMoveMemory(&amp;ContextFrame-&gt;FltF10, &amp;TrapFrame-&gt;FltF10,
00228                       <span class="keyword">sizeof</span>(ULONGLONG) * 21);
00229         ContextFrame-&gt;FltF31 = 0;
00230 
00231         <span class="comment">//</span>
00232         <span class="comment">// Set nonvolatile floating registers f2 - f9 from exception frame.</span>
00233         <span class="comment">//</span>
00234 
00235         ContextFrame-&gt;FltF2 = ExceptionFrame-&gt;FltF2;
00236         ContextFrame-&gt;FltF3 = ExceptionFrame-&gt;FltF3;
00237         ContextFrame-&gt;FltF4 = ExceptionFrame-&gt;FltF4;
00238         ContextFrame-&gt;FltF5 = ExceptionFrame-&gt;FltF5;
00239         ContextFrame-&gt;FltF6 = ExceptionFrame-&gt;FltF6;
00240         ContextFrame-&gt;FltF7 = ExceptionFrame-&gt;FltF7;
00241         ContextFrame-&gt;FltF8 = ExceptionFrame-&gt;FltF8;
00242         ContextFrame-&gt;FltF9 = ExceptionFrame-&gt;FltF9;
00243 
00244         <span class="comment">//</span>
00245         <span class="comment">// Set floating point control register from trap frame.</span>
00246         <span class="comment">// Clear software floating point control register in context frame</span>
00247         <span class="comment">// (if necessary, it can be set to the proper value by the caller).</span>
00248         <span class="comment">//</span>
00249 
00250         ContextFrame-&gt;Fpcr = TrapFrame-&gt;Fpcr;
00251         ContextFrame-&gt;SoftFpcr = 0;
00252     }
00253 
00254     <span class="keywordflow">return</span>;
00255 }
00256 
00257 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00258"></a><a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a4">00258</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a> (
00259     IN OUT PKTRAP_FRAME TrapFrame,
00260     IN OUT PKEXCEPTION_FRAME ExceptionFrame,
00261     IN PCONTEXT ContextFrame,
00262     IN ULONG ContextFlags,
00263     IN KPROCESSOR_MODE PreviousMode
00264     )
00265 
00266 <span class="comment">/*++</span>
00267 <span class="comment"></span>
00268 <span class="comment">Routine Description:</span>
00269 <span class="comment"></span>
00270 <span class="comment">    This routine moves the selected contents of the specified context frame into</span>
00271 <span class="comment">    the specified trap and exception frames according to the specified context</span>
00272 <span class="comment">    flags.</span>
00273 <span class="comment"></span>
00274 <span class="comment">Arguments:</span>
00275 <span class="comment"></span>
00276 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame that receives the volatile</span>
00277 <span class="comment">        context from the context record.</span>
00278 <span class="comment"></span>
00279 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame that receives</span>
00280 <span class="comment">        the nonvolatile context from the context record.</span>
00281 <span class="comment"></span>
00282 <span class="comment">    ContextFrame - Supplies a pointer to a context frame that contains the</span>
00283 <span class="comment">        context that is to be copied into the trap and exception frames.</span>
00284 <span class="comment"></span>
00285 <span class="comment">    ContextFlags - Supplies the set of flags that specify which parts of the</span>
00286 <span class="comment">        context frame are to be copied into the trap and exception frames.</span>
00287 <span class="comment"></span>
00288 <span class="comment">    PreviousMode - Supplies the processor mode for which the trap and exception</span>
00289 <span class="comment">        frames are being built.</span>
00290 <span class="comment"></span>
00291 <span class="comment">Return Value:</span>
00292 <span class="comment"></span>
00293 <span class="comment">    None.</span>
00294 <span class="comment"></span>
00295 <span class="comment">--*/</span>
00296 
00297 {
00298 
00299     <span class="comment">//</span>
00300     <span class="comment">// Set control information if specified.</span>
00301     <span class="comment">//</span>
00302 
00303     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00304 
00305         <span class="comment">//</span>
00306         <span class="comment">// Set integer register gp, sp, ra, FIR, and PSR in trap frame.</span>
00307         <span class="comment">//</span>
00308 
00309         TrapFrame-&gt;IntGp = ContextFrame-&gt;IntGp;
00310         TrapFrame-&gt;IntSp = ContextFrame-&gt;IntSp;
00311         TrapFrame-&gt;IntRa = ContextFrame-&gt;IntRa;
00312         TrapFrame-&gt;Fir = ContextFrame-&gt;Fir;
00313         TrapFrame-&gt;Psr = SANITIZE_PSR(ContextFrame-&gt;Psr, PreviousMode);
00314     }
00315 
00316     <span class="comment">//</span>
00317     <span class="comment">// Set integer register contents if specified.</span>
00318     <span class="comment">//</span>
00319 
00320     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00321 
00322         <span class="comment">//</span>
00323         <span class="comment">// Set volatile integer registers v0 and t0 - t7 in trap frame.</span>
00324         <span class="comment">//</span>
00325 
00326         TrapFrame-&gt;IntV0 = ContextFrame-&gt;IntV0;
00327         TrapFrame-&gt;IntT0 = ContextFrame-&gt;IntT0;
00328         TrapFrame-&gt;IntT1 = ContextFrame-&gt;IntT1;
00329         TrapFrame-&gt;IntT2 = ContextFrame-&gt;IntT2;
00330         TrapFrame-&gt;IntT3 = ContextFrame-&gt;IntT3;
00331         TrapFrame-&gt;IntT4 = ContextFrame-&gt;IntT4;
00332         TrapFrame-&gt;IntT5 = ContextFrame-&gt;IntT5;
00333         TrapFrame-&gt;IntT6 = ContextFrame-&gt;IntT6;
00334         TrapFrame-&gt;IntT7 = ContextFrame-&gt;IntT7;
00335 
00336         <span class="comment">//</span>
00337         <span class="comment">// Set nonvolatile integer registers s0 - s5 in exception frame.</span>
00338         <span class="comment">//</span>
00339 
00340         ExceptionFrame-&gt;IntS0 = ContextFrame-&gt;IntS0;
00341         ExceptionFrame-&gt;IntS1 = ContextFrame-&gt;IntS1;
00342         ExceptionFrame-&gt;IntS2 = ContextFrame-&gt;IntS2;
00343         ExceptionFrame-&gt;IntS3 = ContextFrame-&gt;IntS3;
00344         ExceptionFrame-&gt;IntS4 = ContextFrame-&gt;IntS4;
00345         ExceptionFrame-&gt;IntS5 = ContextFrame-&gt;IntS5;
00346 
00347         <span class="comment">//</span>
00348         <span class="comment">// Set volatile integer registers a0 - a5, and t8 - t11 in trap frame.</span>
00349         <span class="comment">//</span>
00350 
00351         TrapFrame-&gt;IntA0 = ContextFrame-&gt;IntA0;
00352         TrapFrame-&gt;IntA1 = ContextFrame-&gt;IntA1;
00353         TrapFrame-&gt;IntA2 = ContextFrame-&gt;IntA2;
00354         TrapFrame-&gt;IntA3 = ContextFrame-&gt;IntA3;
00355         TrapFrame-&gt;IntA4 = ContextFrame-&gt;IntA4;
00356         TrapFrame-&gt;IntA5 = ContextFrame-&gt;IntA5;
00357 
00358         TrapFrame-&gt;IntT8 = ContextFrame-&gt;IntT8;
00359         TrapFrame-&gt;IntT9 = ContextFrame-&gt;IntT9;
00360         TrapFrame-&gt;IntT10 = ContextFrame-&gt;IntT10;
00361         TrapFrame-&gt;IntT11 = ContextFrame-&gt;IntT11;
00362 
00363         <span class="comment">//</span>
00364         <span class="comment">// Set volatile integer registers fp, t12 and at in trap frame.</span>
00365         <span class="comment">//</span>
00366 
00367         TrapFrame-&gt;IntFp = ContextFrame-&gt;IntFp;
00368         TrapFrame-&gt;IntT12 = ContextFrame-&gt;IntT12;
00369         TrapFrame-&gt;IntAt = ContextFrame-&gt;IntAt;
00370     }
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// Set floating register contents if specified.</span>
00374     <span class="comment">//</span>
00375 
00376     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00377 
00378         <span class="comment">//</span>
00379         <span class="comment">// Set volatile floating registers f0 - f1 in trap frame.</span>
00380         <span class="comment">// Set volatile floating registers f10 - f30 in trap frame.</span>
00381         <span class="comment">//</span>
00382 
00383         TrapFrame-&gt;FltF0 = ContextFrame-&gt;FltF0;
00384         TrapFrame-&gt;FltF1 = ContextFrame-&gt;FltF1;
00385         RtlMoveMemory(&amp;TrapFrame-&gt;FltF10, &amp;ContextFrame-&gt;FltF10,
00386                       <span class="keyword">sizeof</span>(ULONGLONG) * 21);
00387 
00388         <span class="comment">//</span>
00389         <span class="comment">// Set nonvolatile floating registers f2 - f9 in exception frame.</span>
00390         <span class="comment">//</span>
00391 
00392         ExceptionFrame-&gt;FltF2 = ContextFrame-&gt;FltF2;
00393         ExceptionFrame-&gt;FltF3 = ContextFrame-&gt;FltF3;
00394         ExceptionFrame-&gt;FltF4 = ContextFrame-&gt;FltF4;
00395         ExceptionFrame-&gt;FltF5 = ContextFrame-&gt;FltF5;
00396         ExceptionFrame-&gt;FltF6 = ContextFrame-&gt;FltF6;
00397         ExceptionFrame-&gt;FltF7 = ContextFrame-&gt;FltF7;
00398         ExceptionFrame-&gt;FltF8 = ContextFrame-&gt;FltF8;
00399         ExceptionFrame-&gt;FltF9 = ContextFrame-&gt;FltF9;
00400 
00401         <span class="comment">//</span>
00402         <span class="comment">// Set floating point control register in trap frame.</span>
00403         <span class="comment">//</span>
00404 
00405         TrapFrame-&gt;Fpcr = ContextFrame-&gt;Fpcr;
00406     }
00407 
00408     <span class="keywordflow">return</span>;
00409 }
00410 
00411 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00412"></a><a class="code" href="../../d0/d0/ki_8h.html#a108">00412</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a11">KiDispatchException</a> (
00413     IN PEXCEPTION_RECORD ExceptionRecord,
00414     IN PKEXCEPTION_FRAME ExceptionFrame,
00415     IN PKTRAP_FRAME TrapFrame,
00416     IN KPROCESSOR_MODE PreviousMode,
00417     IN BOOLEAN FirstChance
00418     )
00419 
00420 <span class="comment">/*++</span>
00421 <span class="comment"></span>
00422 <span class="comment">Routine Description:</span>
00423 <span class="comment"></span>
00424 <span class="comment">    This function is called to dispatch an exception to the proper mode and</span>
00425 <span class="comment">    to cause the exception dispatcher to be called.</span>
00426 <span class="comment"></span>
00427 <span class="comment">    If the exception is a data misalignment, the previous mode is user, this</span>
00428 <span class="comment">    is the first chance for handling the exception, and the current thread</span>
00429 <span class="comment">    has enabled automatic alignment fixup, then an attempt is made to emulate</span>
00430 <span class="comment">    the unaligned reference. Data misalignment exceptions are never emulated</span>
00431 <span class="comment">    for kernel mode.</span>
00432 <span class="comment"></span>
00433 <span class="comment">    If the exception is a floating not implemented exception, then an attempt</span>
00434 <span class="comment">    is made to emulate the floating operation. If the exception is an</span>
00435 <span class="comment">    arithmetic exception, then an attempt is made to convert the imprecise</span>
00436 <span class="comment">    exception into a precise exception, and then emulate the floating</span>
00437 <span class="comment">    operation in order to obtain the proper IEEE results and exceptions.</span>
00438 <span class="comment">    Floating exceptions are never emulated for kernel mode.</span>
00439 <span class="comment"></span>
00440 <span class="comment">    If the exception is neither a data misalignment nor a floating point</span>
00441 <span class="comment">    exception and the previous mode is kernel, then the exception</span>
00442 <span class="comment">    dispatcher is called directly to process the exception. Otherwise the</span>
00443 <span class="comment">    exception record, exception frame, and trap frame contents are copied</span>
00444 <span class="comment">    to the user mode stack. The contents of the exception frame and trap</span>
00445 <span class="comment">    are then modified such that when control is returned, execution will</span>
00446 <span class="comment">    commence in user mode in a routine which will call the exception</span>
00447 <span class="comment">    dispatcher.</span>
00448 <span class="comment"></span>
00449 <span class="comment">Arguments:</span>
00450 <span class="comment"></span>
00451 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00452 <span class="comment"></span>
00453 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00454 <span class="comment"></span>
00455 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00456 <span class="comment"></span>
00457 <span class="comment">    PreviousMode - Supplies the previous processor mode.</span>
00458 <span class="comment"></span>
00459 <span class="comment">    FirstChance - Supplies a boolean variable that specifies whether this</span>
00460 <span class="comment">        is the first (TRUE) or second (FALSE) time that this exception has</span>
00461 <span class="comment">        been processed.</span>
00462 <span class="comment"></span>
00463 <span class="comment">Return Value:</span>
00464 <span class="comment"></span>
00465 <span class="comment">    None.</span>
00466 <span class="comment"></span>
00467 <span class="comment">--*/</span>
00468 
00469 {
00470 
00471     CONTEXT ContextFrame;
00472     EXCEPTION_RECORD ExceptionRecord1;
00473     PEXC_SUM ExceptionSummary;
00474     LONG Length;
00475     ULONG SoftFpcr;
00476     ULONGLONG UserStack1;
00477     ULONGLONG UserStack2;
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">// If the exception is an illegal instruction exception, then check for</span>
00481     <span class="comment">// a byte/word instruction that should be emulated.</span>
00482     <span class="comment">//</span>
00483     <span class="comment">// N.B. The exception code STATUS_ILLEGAL_INSTRUCTION may be converted</span>
00484     <span class="comment">//      into STATUS_DATATYPE_MISALIGNMENT in the case of unaligned word</span>
00485     <span class="comment">//      access.</span>
00486     <span class="comment">//</span>
00487 
00488     <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == STATUS_ILLEGAL_INSTRUCTION) {
00489         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/byteem_8c.html#a2">KiEmulateByteWord</a>(ExceptionRecord,
00490                               ExceptionFrame,
00491                               TrapFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00492             <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeByteWordEmulationCount += 1;
00493             <span class="keywordflow">goto</span> Handled2;
00494         }
00495     }
00496 
00497 <span class="preprocessor">#if DBG</span>
00498 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (KiBreakOnAlignmentFault != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00499 
00500         <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == STATUS_DATATYPE_MISALIGNMENT) {
00501 
00502             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KI: Alignment fault exr = %p Pc = %p Address = %p\n"</span>,
00503                      ExceptionRecord,
00504                      ExceptionRecord-&gt;ExceptionAddress,
00505                      ExceptionRecord-&gt;ExceptionInformation[2]);
00506     
00507             DbgBreakPoint();
00508         }
00509     }
00510 <span class="preprocessor">#endif</span>
00511 <span class="preprocessor"></span>
00512     <span class="comment">//</span>
00513     <span class="comment">// If the exception is a data misalignment, the previous mode was user,</span>
00514     <span class="comment">// this is the first chance for handling the exception, and the current</span>
00515     <span class="comment">// thread has enabled automatic alignment fixup, then attempt to emulate</span>
00516     <span class="comment">// the unaligned reference.</span>
00517     <span class="comment">//</span>
00518 
00519     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_DATATYPE_MISALIGNMENT) &amp;&amp;
00520         (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00521 
00522 <span class="preprocessor">#if DBG</span>
00523 <span class="preprocessor"></span>
00524         <span class="comment">//</span>
00525         <span class="comment">// Count alignment faults by mode and display them at intervals.</span>
00526         <span class="comment">//</span>
00527 
00528         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00529             KiKernelFixupCount += 1;
00530             <span class="keywordflow">if</span> ((KiKernelFixupCount &amp; KiKernelFixupMask) == 0) {
00531                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KI: Kernel Fixup: Pid=0x%.3lx, Pc=%.16p, Address=%.16p ... Total=%ld\n"</span>,
00532                          <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId,
00533                          ExceptionRecord-&gt;ExceptionAddress,
00534                          ExceptionRecord-&gt;ExceptionInformation[2],
00535                          KiKernelFixupCount);
00536             }
00537 
00538         } <span class="keywordflow">else</span> {
00539             KiUserFixupCount += 1;
00540             <span class="keywordflow">if</span> ((KiUserFixupCount &amp; KiUserFixupMask) == 0) {
00541                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KI: User  Fixup: Pid=0x%.3lx, Pc=%.16p, Address=%.16p ... Total=%ld\n"</span>,
00542                          <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId,
00543                          ExceptionRecord-&gt;ExceptionAddress,
00544                          ExceptionRecord-&gt;ExceptionInformation[2],
00545                          KiUserFixupCount);
00546             }
00547         }
00548 
00549 <span class="preprocessor">#endif</span>
00550 <span class="preprocessor"></span>
00551         <span class="comment">//</span>
00552         <span class="comment">// If alignment fault exceptions are not enabled, then no exception</span>
00553         <span class="comment">// should be raised and the data reference should be emulated.</span>
00554         <span class="comment">//</span>
00555         <span class="comment">// We will emulate the reference if</span>
00556         <span class="comment">//      KiEnableAlignmentFaultExceptions == 0 (always fix up all faults, the default)</span>
00557         <span class="comment">// OR   The thread has explicitly enabled alignment fixups</span>
00558         <span class="comment">// OR   KiEnableAlignmentFaultExceptions == 2 and the process is not being debugged</span>
00559         <span class="comment">//</span>
00560 
00561         <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a1">KiEnableAlignmentFaultExceptions</a> == 0) ||
00562 
00563              ((<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;AutoAlignment != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00564               (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;AutoAlignment != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) ||
00565 
00566              (((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) &amp;&amp;
00567               (<a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a1">KiEnableAlignmentFaultExceptions</a> == 2)) ) {
00568 
00569             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a18">KiEmulateReference</a>(ExceptionRecord,
00570                                    ExceptionFrame,
00571                                    TrapFrame,
00572                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00573                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeAlignmentFixupCount += 1;
00574                 <span class="keywordflow">goto</span> Handled2;
00575             }
00576         }
00577     }
00578 
00579     <span class="comment">//</span>
00580     <span class="comment">// If the exception is a data bus error then a machine check has</span>
00581     <span class="comment">// been trapped by the PALcode. The error will be forwarded to the</span>
00582     <span class="comment">// HAL eventually for logging or handling. If the handler returns</span>
00583     <span class="comment">// it is assumed that the HAL successfully handled the error and</span>
00584     <span class="comment">// execution may resume.</span>
00585     <span class="comment">//</span>
00586     <span class="comment">// N.B. A special exception code is used to signal a data bus error.</span>
00587     <span class="comment">//      This code is equivalent to the bug check code merged with a</span>
00588     <span class="comment">//      reserved facility code and the reserved bit set.</span>
00589     <span class="comment">//</span>
00590 
00591     <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == (<a class="code" href="../../d6/d7/halmips_8h.html#a2">DATA_BUS_ERROR</a> | 0xdfff0000)) {
00592         <a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a2">KiMachineCheck</a>(ExceptionRecord, ExceptionFrame, TrapFrame);
00593         <span class="keywordflow">goto</span> Handled2;
00594     }
00595 
00596     <span class="comment">//</span>
00597     <span class="comment">// Initialize the copy of the software FPCR. The proper value is set</span>
00598     <span class="comment">// if a floating emulation operation is performed. Case on arithmetic</span>
00599     <span class="comment">// exception codes that require special handling by the kernel.</span>
00600     <span class="comment">//</span>
00601 
00602     SoftFpcr = 0;
00603     <span class="keywordflow">switch</span> (ExceptionRecord-&gt;ExceptionCode) {
00604 
00605         <span class="comment">//</span>
00606         <span class="comment">// If the exception is a gentrap, then attempt to translate the</span>
00607         <span class="comment">// Alpha specific gentrap value to a status code value. This</span>
00608         <span class="comment">// exception is a precise trap.</span>
00609         <span class="comment">//</span>
00610         <span class="comment">// N.B. STATUS_ALPHA_GENTRAP is a pseudo status code generated by</span>
00611         <span class="comment">//      PALcode when a callpal gentrap is executed. The status is</span>
00612         <span class="comment">//      visible in user mode only when the gentrap code value is</span>
00613         <span class="comment">//      unrecognized.</span>
00614         <span class="comment">//</span>
00615 
00616     <span class="keywordflow">case</span> STATUS_ALPHA_GENTRAP :
00617         <span class="keywordflow">switch</span> (ExceptionRecord-&gt;ExceptionInformation[0]) {
00618         <span class="keywordflow">case</span> GENTRAP_INTEGER_OVERFLOW :
00619             ExceptionRecord-&gt;ExceptionCode = STATUS_INTEGER_OVERFLOW;
00620             <span class="keywordflow">break</span>;
00621 
00622         <span class="keywordflow">case</span> GENTRAP_INTEGER_DIVIDE_BY_ZERO :
00623             ExceptionRecord-&gt;ExceptionCode = STATUS_INTEGER_DIVIDE_BY_ZERO;
00624             <span class="keywordflow">break</span>;
00625 
00626         <span class="keywordflow">case</span> GENTRAP_FLOATING_OVERFLOW :
00627             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_OVERFLOW;
00628             <span class="keywordflow">break</span>;
00629 
00630         <span class="keywordflow">case</span> GENTRAP_FLOATING_DIVIDE_BY_ZERO :
00631             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_DIVIDE_BY_ZERO;
00632             <span class="keywordflow">break</span>;
00633 
00634         <span class="keywordflow">case</span> GENTRAP_FLOATING_UNDERFLOW :
00635             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_UNDERFLOW;
00636             <span class="keywordflow">break</span>;
00637 
00638         <span class="keywordflow">case</span> GENTRAP_FLOATING_INVALID_OPERAND :
00639             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INVALID_OPERATION;
00640             <span class="keywordflow">break</span>;
00641 
00642         <span class="keywordflow">case</span> GENTRAP_FLOATING_INEXACT_RESULT :
00643             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INEXACT_RESULT;
00644             <span class="keywordflow">break</span>;
00645         }
00646         <span class="keywordflow">break</span>;
00647 
00648         <span class="comment">//</span>
00649         <span class="comment">// If the exception is an unimplemented floating operation, then</span>
00650         <span class="comment">// PALcode has detected a subsetted floating point operation. These</span>
00651         <span class="comment">// include attempts to use round to plus or minus infinity rounding</span>
00652         <span class="comment">// modes on EV4. This exception is a fault.</span>
00653         <span class="comment">//</span>
00654         <span class="comment">// If the previous mode was user, an attempt is made to emulate the</span>
00655         <span class="comment">// operation. If the emulation is successful, the continuation</span>
00656         <span class="comment">// address is incremented to the next instruction.</span>
00657         <span class="comment">//</span>
00658         <span class="comment">// N.B. STATUS_ALPHA_FLOATING_NOT_IMPLEMENTED is a pseudo status code</span>
00659         <span class="comment">//      generated by PALcode. The status is never visible outside of</span>
00660         <span class="comment">//      this handler because the floating emulation routine converts</span>
00661         <span class="comment">//      the status code to the proper floating status value.</span>
00662         <span class="comment">//</span>
00663 
00664     <span class="keywordflow">case</span> STATUS_ALPHA_FLOATING_NOT_IMPLEMENTED :
00665         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00666             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/trigger_8c.html#a11">KiFloatingException</a>(ExceptionRecord,
00667                                     ExceptionFrame,
00668                                     TrapFrame,
00669                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00670                                     &amp;SoftFpcr) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00671                 TrapFrame-&gt;Fir += 4;
00672                 <span class="keywordflow">goto</span> Handled2;
00673             }
00674 
00675         } <span class="keywordflow">else</span> {
00676             ExceptionRecord-&gt;ExceptionCode = STATUS_ILLEGAL_INSTRUCTION;
00677         }
00678 
00679         <span class="keywordflow">break</span>;
00680 
00681         <span class="comment">//</span>
00682         <span class="comment">// If the exception is an arithmetic exception, then one or more</span>
00683         <span class="comment">// integer overflow or floating point traps has occurred. This</span>
00684         <span class="comment">// exception is an imprecise (asynchronous) trap. Attempt to locate </span>
00685         <span class="comment">// the original trapping instruction and emulate the instruction.</span>
00686         <span class="comment">//</span>
00687         <span class="comment">// N.B. STATUS_ALPHA_ARITHMETIC_EXCEPTION is a pseudo status code</span>
00688         <span class="comment">//      generated by PALcode. The status is never visible outside of</span>
00689         <span class="comment">//      this handler because the floating emulation routine converts</span>
00690         <span class="comment">//      the status code to the proper floating status value.</span>
00691         <span class="comment">//</span>
00692 
00693     <span class="keywordflow">case</span> STATUS_ALPHA_ARITHMETIC_EXCEPTION :
00694         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/trigger_8c.html#a11">KiFloatingException</a>(ExceptionRecord,
00695                                 ExceptionFrame,
00696                                 TrapFrame,
00697                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00698                                 &amp;SoftFpcr) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00699             <span class="keywordflow">goto</span> Handled2;
00700         }
00701         <span class="keywordflow">break</span>;
00702     }
00703 
00704     <span class="comment">//</span>
00705     <span class="comment">// Move machine state from trap and exception frames to a context frame,</span>
00706     <span class="comment">// and increment the number of exceptions dispatched.</span>
00707     <span class="comment">//</span>
00708     <span class="comment">// Explicitly set the value of the software FPCR in the context frame</span>
00709     <span class="comment">// (because it is not a hardware register and thus not present in the</span>
00710     <span class="comment">// trap or exception frames).</span>
00711     <span class="comment">//</span>
00712 
00713     ContextFrame.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00714     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a>(TrapFrame, ExceptionFrame, &amp;ContextFrame);
00715     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeExceptionDispatchCount += 1;
00716     ContextFrame.SoftFpcr = (ULONGLONG)SoftFpcr;
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">// Select the method of handling the exception based on the previous mode.</span>
00720     <span class="comment">//</span>
00721 
00722     <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00723 
00724         <span class="comment">//</span>
00725         <span class="comment">// If the kernel debugger is active, the exception is a breakpoint,</span>
00726         <span class="comment">// the breakpoint is handled by the kernel debugger, and this is the</span>
00727         <span class="comment">// first chance, then give the kernel debugger a chance to handle</span>
00728         <span class="comment">// the exception.</span>
00729         <span class="comment">//</span>
00730 
00731         <span class="keywordflow">if</span> ((FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00732            (ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00733            (<a class="code" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a>(ExceptionRecord,
00734                             &amp;ContextFrame,
00735                             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00736 
00737            (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00738                                ExceptionFrame,
00739                                ExceptionRecord,
00740                                &amp;ContextFrame,
00741                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00742                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00743 
00744             <span class="keywordflow">goto</span> Handled1;
00745         }
00746 
00747 
00748         <span class="comment">//</span>
00749         <span class="comment">// Previous mode was kernel.</span>
00750         <span class="comment">//</span>
00751         <span class="comment">// If this is the first chance, then attempt to dispatch the exception</span>
00752         <span class="comment">// to a frame based handler. If the exception is handled, then continue</span>
00753         <span class="comment">// execution.</span>
00754         <span class="comment">//</span>
00755         <span class="comment">// If this is the second chance or the exception is not handled,</span>
00756         <span class="comment">// then if the kernel debugger is active, then give the kernel</span>
00757         <span class="comment">// debugger a second chance to handle the exception. If the kernel</span>
00758         <span class="comment">// debugger handles the exception, then continue execution. Otherwise</span>
00759         <span class="comment">// bug check.</span>
00760         <span class="comment">//</span>
00761 
00762         <span class="keywordflow">if</span> (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00763 
00764             <span class="comment">//</span>
00765             <span class="comment">// This is the first chance to handle the exception.</span>
00766             <span class="comment">//</span>
00767 
00768             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a7">RtlDispatchException</a>(ExceptionRecord, &amp;ContextFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00769                 <span class="keywordflow">goto</span> Handled1;
00770             }
00771         }
00772 
00773         <span class="comment">//</span>
00774         <span class="comment">// This is the second chance to handle the exception.</span>
00775         <span class="comment">//</span>
00776 
00777         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00778            (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00779                                ExceptionFrame,
00780                                ExceptionRecord,
00781                                &amp;ContextFrame,
00782                                PreviousMode,
00783                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00784 
00785             <span class="keywordflow">goto</span> Handled1;
00786         }
00787 
00788         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a13">KMODE_EXCEPTION_NOT_HANDLED</a>,
00789                      ExceptionRecord-&gt;ExceptionCode,
00790                      (ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress,
00791                      ExceptionRecord-&gt;ExceptionInformation[0],
00792                      ExceptionRecord-&gt;ExceptionInformation[1]);
00793 
00794     } <span class="keywordflow">else</span> {
00795 
00796         <span class="comment">//</span>
00797         <span class="comment">// If the kernel debugger is active, the exception is a breakpoint,</span>
00798         <span class="comment">// the breakpoint is handled by the kernel debugger, and this is the</span>
00799         <span class="comment">// first chance, then give the kernel debugger a chance to handle</span>
00800         <span class="comment">// the exception.</span>
00801         <span class="comment">//</span>
00802 
00803         <span class="keywordflow">if</span> ((FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00804             (<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00805             (ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00806             (<a class="code" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a>(ExceptionRecord,
00807                              &amp;ContextFrame,
00808                              <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00809 
00810             ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00811              ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00812               (ExceptionRecord-&gt;ExceptionInformation[0] !=
00813                                             DEBUG_STOP_BREAKPOINT)))) {
00814 
00815               <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00816                                      ExceptionFrame,
00817                                      ExceptionRecord,
00818                                      &amp;ContextFrame,
00819                                      <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
00820                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00821 
00822                      <span class="keywordflow">goto</span> Handled1;
00823               }
00824         }
00825 
00826         <span class="comment">//</span>
00827         <span class="comment">// Previous mode was user.</span>
00828         <span class="comment">//</span>
00829         <span class="comment">// If this is the first chance and the current process has a debugger</span>
00830         <span class="comment">// port, then send a message to the debugger port and wait for a reply.</span>
00831         <span class="comment">// If the debugger handles the exception, then continue execution. Otherwise</span>
00832         <span class="comment">// transfer the exception information to the user stack, transition to</span>
00833         <span class="comment">// user mode, and attempt to dispatch the exception to a frame based</span>
00834         <span class="comment">// handler. If a frame based handler handles the exception, then continue</span>
00835         <span class="comment">// execution. Otherwise, execute the raise exception system service</span>
00836         <span class="comment">// which will call this routine a second time to process the exception.</span>
00837         <span class="comment">//</span>
00838         <span class="comment">// If this is the second chance and the current process has a debugger</span>
00839         <span class="comment">// port, then send a message to the debugger port and wait for a reply.</span>
00840         <span class="comment">// If the debugger handles the exception, then continue execution. Otherwise</span>
00841         <span class="comment">// if the current process has a subsystem port, then send a message to</span>
00842         <span class="comment">// the subsystem port and wait for a reply. If the subsystem handles the</span>
00843         <span class="comment">// exception, then continue execution. Otherwise terminate the thread.</span>
00844         <span class="comment">//</span>
00845 
00846         <span class="keywordflow">if</span> (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00847 
00848             <span class="comment">//</span>
00849             <span class="comment">// This is the first chance to handle the exception.</span>
00850             <span class="comment">//</span>
00851 
00852             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00853                 <span class="keywordflow">goto</span> Handled2;
00854             }
00855 
00856             <span class="comment">//</span>
00857             <span class="comment">// Transfer exception information to the user stack, transition</span>
00858             <span class="comment">// to user mode, and attempt to dispatch the exception to a frame</span>
00859             <span class="comment">// based handler.</span>
00860             <span class="comment">//</span>
00861 
00862         repeat:
00863             <span class="keywordflow">try</span> {
00864 
00865                 <span class="comment">//</span>
00866                 <span class="comment">// Compute length of exception record and new aligned stack</span>
00867                 <span class="comment">// address.</span>
00868                 <span class="comment">//</span>
00869 
00870                 Length = (<span class="keyword">sizeof</span>(EXCEPTION_RECORD) + 15) &amp; (~15);
00871                 UserStack1 = (ContextFrame.IntSp &amp; ~((ULONG_PTR)15)) - Length;
00872 
00873                 <span class="comment">//</span>
00874                 <span class="comment">// Probe user stack area for writability and then transfer the</span>
00875                 <span class="comment">// exception record to the user stack area.</span>
00876                 <span class="comment">//</span>
00877 
00878                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PCHAR)UserStack1, Length, <span class="keyword">sizeof</span>(QUAD));
00879                 RtlMoveMemory((PVOID)UserStack1, ExceptionRecord, Length);
00880 
00881                 <span class="comment">//</span>
00882                 <span class="comment">// Compute length of context record and new aligned user stack</span>
00883                 <span class="comment">// pointer.</span>
00884                 <span class="comment">//</span>
00885 
00886                 Length = (<span class="keyword">sizeof</span>(CONTEXT) + 15) &amp; (~15);
00887                 UserStack2 = UserStack1 - Length;
00888 
00889                 <span class="comment">//</span>
00890                 <span class="comment">// Probe user stack area for writability and then transfer the</span>
00891                 <span class="comment">// context record to the user stack.</span>
00892                 <span class="comment">//</span>
00893 
00894                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PCHAR)UserStack2, Length, <span class="keyword">sizeof</span>(QUAD));
00895                 RtlMoveMemory((PVOID)UserStack2, &amp;ContextFrame, <span class="keyword">sizeof</span>(CONTEXT));
00896 
00897                 <span class="comment">//</span>
00898                 <span class="comment">// Set address of exception record, context record, and the</span>
00899                 <span class="comment">// and the new stack pointer in the current trap frame.</span>
00900                 <span class="comment">//</span>
00901 
00902                 TrapFrame-&gt;IntSp = UserStack2;
00903                 TrapFrame-&gt;IntFp = UserStack2;
00904                 ExceptionFrame-&gt;IntS0 = UserStack1;
00905                 ExceptionFrame-&gt;IntS1 = UserStack2;
00906 
00907                 <span class="comment">//</span>
00908                 <span class="comment">// Set the address of the exception routine that will call the</span>
00909                 <span class="comment">// exception dispatcher and then return to the trap handler.</span>
00910                 <span class="comment">// The trap handler will restore the exception and trap frame</span>
00911                 <span class="comment">// context and continue execution in the routine that will</span>
00912                 <span class="comment">// call the exception dispatcher.</span>
00913                 <span class="comment">//</span>
00914 
00915                 TrapFrame-&gt;Fir = (ULONGLONG)(LONG_PTR)<a class="code" href="../../d4/d9/ke_8h.html#a150">KeUserExceptionDispatcher</a>;
00916                 <span class="keywordflow">return</span>;
00917 
00918             <span class="comment">//</span>
00919             <span class="comment">// If an exception occurs, then copy the new exception information</span>
00920             <span class="comment">// to an exception record and handle the exception.</span>
00921             <span class="comment">//</span>
00922 
00923             } except (<a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a>(&amp;ExceptionRecord1,
00924                                (GetExceptionInformation())-&gt;ExceptionRecord)) {
00925 
00926                 <span class="comment">//</span>
00927                 <span class="comment">// If the exception is a stack overflow, then attempt</span>
00928                 <span class="comment">// to raise the stack overflow exception. Otherwise,</span>
00929                 <span class="comment">// the user's stack is not accessible, or is misaligned,</span>
00930                 <span class="comment">// and second chance processing is performed.</span>
00931                 <span class="comment">//</span>
00932 
00933                 <span class="keywordflow">if</span> (ExceptionRecord1.ExceptionCode == STATUS_STACK_OVERFLOW) {
00934                     ExceptionRecord1.ExceptionAddress = ExceptionRecord-&gt;ExceptionAddress;
00935                     RtlMoveMemory((PVOID)ExceptionRecord,
00936                                   &amp;ExceptionRecord1, <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00937                     <span class="keywordflow">goto</span> repeat;
00938                 }
00939             }
00940         }
00941 
00942         <span class="comment">//</span>
00943         <span class="comment">// This is the second chance to handle the exception.</span>
00944         <span class="comment">//</span>
00945 
00946         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00947             <span class="keywordflow">goto</span> Handled2;
00948 
00949         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00950             <span class="keywordflow">goto</span> Handled2;
00951 
00952         } <span class="keywordflow">else</span> {
00953             ZwTerminateProcess(NtCurrentProcess(), ExceptionRecord-&gt;ExceptionCode);
00954             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a13">KMODE_EXCEPTION_NOT_HANDLED</a>,
00955                          ExceptionRecord-&gt;ExceptionCode,
00956                          (ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress,
00957                          ExceptionRecord-&gt;ExceptionInformation[0],
00958                          ExceptionRecord-&gt;ExceptionInformation[1]);
00959 
00960         }
00961     }
00962 
00963     <span class="comment">//</span>
00964     <span class="comment">// Move machine state from context frame to trap and exception frames and</span>
00965     <span class="comment">// then return to continue execution with the restored state.</span>
00966     <span class="comment">//</span>
00967 
00968 Handled1:
00969     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame, ExceptionFrame, &amp;ContextFrame,
00970                        ContextFrame.ContextFlags, PreviousMode);
00971 
00972     <span class="comment">//</span>
00973     <span class="comment">// Exception was handled by the debugger or the associated subsystem</span>
00974     <span class="comment">// and state was modified, if necessary, using the get state and set</span>
00975     <span class="comment">// state capabilities. Therefore the context frame does not need to</span>
00976     <span class="comment">// be transferred to the trap and exception frames.</span>
00977     <span class="comment">//</span>
00978 
00979 Handled2:
00980     <span class="keywordflow">return</span>;
00981 }
00982 
00983 ULONG
<a name="l00984"></a><a class="code" href="../../d0/d0/ki_8h.html#a110">00984</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a> (
00985     IN OUT PEXCEPTION_RECORD ExceptionRecord1,
00986     IN PEXCEPTION_RECORD ExceptionRecord2
00987     )
00988 
00989 <span class="comment">/*++</span>
00990 <span class="comment"></span>
00991 <span class="comment">Routine Description:</span>
00992 <span class="comment"></span>
00993 <span class="comment">    This function is called from an exception filter to copy the exception</span>
00994 <span class="comment">    information from one exception record to another when an exception occurs.</span>
00995 <span class="comment"></span>
00996 <span class="comment">Arguments:</span>
00997 <span class="comment"></span>
00998 <span class="comment">    ExceptionRecord1 - Supplies a pointer to the destination exception record.</span>
00999 <span class="comment"></span>
01000 <span class="comment">    ExceptionRecord2 - Supplies a pointer to the source exception record.</span>
01001 <span class="comment"></span>
01002 <span class="comment">Return Value:</span>
01003 <span class="comment"></span>
01004 <span class="comment">    A value of EXCEPTION_EXECUTE_HANDLER is returned as the function value.</span>
01005 <span class="comment"></span>
01006 <span class="comment">--*/</span>
01007 
01008 {
01009 
01010     <span class="comment">//</span>
01011     <span class="comment">// Copy one exception record to another and return value that causes</span>
01012     <span class="comment">// an exception handler to be executed.</span>
01013     <span class="comment">//</span>
01014 
01015     RtlMoveMemory((PVOID)ExceptionRecord1,
01016                   (PVOID)ExceptionRecord2,
01017                   <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
01018 
01019     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
01020 }
01021 
01022 
01023 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01024"></a><a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a7">01024</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a13">KeRaiseUserException</a>(
01025     IN NTSTATUS ExceptionCode
01026     )
01027 
01028 <span class="comment">/*++</span>
01029 <span class="comment"></span>
01030 <span class="comment">Routine Description:</span>
01031 <span class="comment"></span>
01032 <span class="comment">    This function causes an exception to be raised in the calling thread's user-mode</span>
01033 <span class="comment">    context. It does this by editing the trap frame the kernel was entered with to</span>
01034 <span class="comment">    point to trampoline code that raises the requested exception.</span>
01035 <span class="comment"></span>
01036 <span class="comment">Arguments:</span>
01037 <span class="comment"></span>
01038 <span class="comment">    ExceptionCode - Supplies the status value to be used as the exception</span>
01039 <span class="comment">        code for the exception that is to be raised.</span>
01040 <span class="comment"></span>
01041 <span class="comment">Return Value:</span>
01042 <span class="comment"></span>
01043 <span class="comment">    The status value that should be returned by the caller.</span>
01044 <span class="comment"></span>
01045 <span class="comment">--*/</span>
01046 
01047 {
01048 
01049     PKTRAP_FRAME TrapFrame;
01050 
01051     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetPreviousMode() == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
01052 
01053     TrapFrame = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;TrapFrame;
01054 
01055     TrapFrame-&gt;Fir = (ULONGLONG)(LONG_PTR)<a class="code" href="../../d4/d9/ke_8h.html#a151">KeRaiseUserExceptionDispatcher</a>;
01056     <span class="keywordflow">return</span>(ExceptionCode);
01057 }
01058 
01059 <span class="preprocessor">#if 0</span>
01060 <span class="preprocessor"></span>
01061 LOGICAL
01062 BdReportExceptionStateChange (
01063     IN PEXCEPTION_RECORD ExceptionRecord,
01064     IN OUT PCONTEXT ContextRecord
01065     );
01066 
01067 LOGICAL
01068 BdReportLoadSymbolsStateChange (
01069     IN PSTRING PathName,
01070     IN <a class="code" href="../../d6/d5/struct__KD__SYMBOLS__INFO.html">PKD_SYMBOLS_INFO</a> SymbolInfo,
01071     IN LOGICAL UnloadSymbols,
01072     IN OUT PCONTEXT ContextRecord
01073     );
01074 
01075 LOGICAL
01076 BdPrintString (
01077     IN PSTRING Output
01078     );
01079 
01080 LOGICAL
01081 BdPromptString (
01082     IN PSTRING Output,
01083     IN OUT PSTRING Input
01084     );
01085 
01086 LOGICAL
01087 BdTrap (
01088     IN PEXCEPTION_RECORD ExceptionRecord,
01089     IN PKEXCEPTION_FRAME ExceptionFrame,
01090     IN PKTRAP_FRAME TrapFrame,
01091     IN KPROCESSOR_MODE PreviousMode,
01092     IN BOOLEAN FirstChance
01093     )
01094 
01095 <span class="comment">/*++</span>
01096 <span class="comment"></span>
01097 <span class="comment">Routine Description:</span>
01098 <span class="comment"></span>
01099 <span class="comment">    This routine is called whenever a exception is dispatched and the kernel</span>
01100 <span class="comment">    debugger is active.</span>
01101 <span class="comment"></span>
01102 <span class="comment">Arguments:</span>
01103 <span class="comment"></span>
01104 <span class="comment">    FirmwareFrame - Supplies a pointer to a firmware frame that describes the</span>
01105 <span class="comment">        trap.</span>
01106 <span class="comment"></span>
01107 <span class="comment">Return Value:</span>
01108 <span class="comment"></span>
01109 <span class="comment">    A value of TRUE is returned if the exception is handled. Otherwise a</span>
01110 <span class="comment">    value of FALSE is returned.</span>
01111 <span class="comment"></span>
01112 <span class="comment">--*/</span>
01113 
01114 {
01115 
01116     CONTEXT ContextFrame;
01117     LOGICAL Completion;
01118     PCONTEXT ContextRecord;
01119     STRING Input;
01120     ULONGLONG OldFir;
01121     STRING Output;
01122     <a class="code" href="../../d6/d5/struct__KD__SYMBOLS__INFO.html">PKD_SYMBOLS_INFO</a> SymbolInfo;
01123     LOGICAL UnloadSymbols;
01124 
01125     <span class="comment">//</span>
01126     <span class="comment">// Set address of context record and set context flags.</span>
01127     <span class="comment">//</span>
01128 
01129     ContextRecord = &amp;ContextFrame;
01130     ContextRecord-&gt;ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
01131 
01132     <span class="comment">//</span>
01133     <span class="comment">// Print, prompt, load symbols, and unload symbols are all special cases</span>
01134     <span class="comment">// of breakpoint.</span>
01135     <span class="comment">//</span>
01136 
01137 <span class="comment">//    BlPrint("bd: debug code entered with type %lx, p1 %lx\r\n",</span>
01138 <span class="comment">//            (ULONG)FirmwareFrame-&gt;Type,</span>
01139 <span class="comment">//            (ULONG)FirmwareFrame-&gt;Param1);</span>
01140 
01141     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
01142         (ExceptionRecord-&gt;ExceptionInformation[0] &gt;= DEBUG_PRINT_BREAKPOINT)) {
01143 
01144         <span class="comment">//</span>
01145         <span class="comment">// Switch on the breakpoint code.</span>
01146         <span class="comment">//</span>
01147 
01148         UnloadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01149         <span class="keywordflow">switch</span> (ExceptionRecord-&gt;ExceptionInformation[0]) {
01150 
01151             <span class="comment">//</span>
01152             <span class="comment">// Print:</span>
01153             <span class="comment">//</span>
01154             <span class="comment">// Arguments:</span>
01155             <span class="comment">//</span>
01156             <span class="comment">//   a0 - Supplies a pointer to an output string buffer.</span>
01157             <span class="comment">//   a1 - Supplies the length of the output string buffer.</span>
01158             <span class="comment">//</span>
01159 
01160         <span class="keywordflow">case</span> DEBUG_PRINT_BREAKPOINT:
01161 <span class="comment">//            BlPrint("bd/debug: print\r\n");</span>
01162             Output.Buffer = (PCHAR)TrapFrame-&gt;IntA0;
01163             Output.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;IntA1;
01164             <span class="keywordflow">if</span> (BdPrintString(&amp;Output)) {
01165                 TrapFrame-&gt;IntV0 = STATUS_BREAKPOINT;
01166 
01167             } <span class="keywordflow">else</span> {
01168                 TrapFrame-&gt;IntV0 = STATUS_SUCCESS;
01169             }
01170 
01171             TrapFrame-&gt;Fir += 4;
01172 <span class="comment">//            BlPrint("bd/debug: exit - print\r\n");</span>
01173             KeSweepCurrentIcache();
01174             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01175 
01176             <span class="comment">//</span>
01177             <span class="comment">// Stop in debugger:</span>
01178             <span class="comment">//</span>
01179             <span class="comment">// As this is not a normal breakpoint we must increment the</span>
01180             <span class="comment">// context past the breakpoint instruction.</span>
01181             <span class="comment">//</span>
01182 
01183         <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a454">BREAKIN_BREAKPOINT</a>:
01184             TrapFrame-&gt;Fir += 4;
01185             <span class="keywordflow">break</span>;
01186 
01187             <span class="comment">//</span>
01188             <span class="comment">// Prompt:</span>
01189             <span class="comment">//</span>
01190             <span class="comment">//   a0 - Supplies a pointer to an output string buffer.</span>
01191             <span class="comment">//   a1 - Supplies the length of the output string buffer..</span>
01192             <span class="comment">//   a2 - supplies a pointer to an input string buffer.</span>
01193             <span class="comment">//   a3 - Supplies the length of the input string bufffer.</span>
01194             <span class="comment">//</span>
01195 
01196         <span class="keywordflow">case</span> DEBUG_PROMPT_BREAKPOINT:
01197 <span class="comment">//            BlPrint("bd/debug: prompt\r\n");</span>
01198             Output.Buffer = (PCHAR)TrapFrame-&gt;IntA0;
01199             Output.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;IntA1;
01200             Input.Buffer = (PCHAR)TrapFrame-&gt;IntA2;
01201             Input.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;IntA3;
01202 
01203             <span class="comment">//</span>
01204             <span class="comment">// Prompt and keep prompting until no breakin seen.</span>
01205             <span class="comment">//</span>
01206 
01207             <span class="keywordflow">do</span> {
01208             } <span class="keywordflow">while</span>(BdPromptString(&amp;Output, &amp;Input) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01209 
01210             TrapFrame-&gt;IntV0 = Input.Length;
01211             TrapFrame-&gt;Fir += 4;
01212 <span class="comment">//            BlPrint("bd/debug: exit - prompt\r\n");</span>
01213             KeSweepCurrentIcache();
01214             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01215 
01216             <span class="comment">//</span>
01217             <span class="comment">// Unload Symbols:</span>
01218             <span class="comment">//</span>
01219             <span class="comment">// Arguments:</span>
01220             <span class="comment">//</span>
01221             <span class="comment">//    a0 - Supplies a pointer to the image path string descriptor.</span>
01222             <span class="comment">//    a1 - Supplies a pointer to he symbol information.</span>
01223             <span class="comment">//</span>
01224 
01225         <span class="keywordflow">case</span> DEBUG_UNLOAD_SYMBOLS_BREAKPOINT:
01226 <span class="comment">//            BlPrint("bd/debug: unload\r\n");</span>
01227             UnloadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01228 
01229             <span class="comment">//</span>
01230             <span class="comment">// Fall through to load symbol case.</span>
01231             <span class="comment">//</span>
01232 
01233         <span class="keywordflow">case</span> DEBUG_LOAD_SYMBOLS_BREAKPOINT:
01234 <span class="comment">//            BlPrint("bd/debug: load\r\n");</span>
01235             <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a>(TrapFrame, ExceptionFrame, ContextRecord);
01236             OldFir = ContextRecord-&gt;Fir;
01237             SymbolInfo = (<a class="code" href="../../d6/d5/struct__KD__SYMBOLS__INFO.html">PKD_SYMBOLS_INFO</a>)ContextRecord-&gt;IntA1;
01238             BdReportLoadSymbolsStateChange((PSTRING)ContextRecord-&gt;IntA0,
01239                                            SymbolInfo,
01240                                            UnloadSymbols,
01241                                            ContextRecord);
01242 
01243 
01244             <span class="comment">//</span>
01245             <span class="comment">// If the kernel debugger did not update the FIR, then increment</span>
01246             <span class="comment">// past the breakpoint instruction.</span>
01247             <span class="comment">//</span>
01248 
01249             <span class="keywordflow">if</span> (ContextRecord-&gt;Fir == OldFir) {
01250                 ContextRecord-&gt;Fir += 4;
01251             }
01252 
01253             <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame,
01254                                ExceptionFrame,
01255                                ContextRecord,
01256                                ContextRecord-&gt;ContextFlags,
01257                                PreviousMode);
01258 
01259 <span class="comment">//            BlPrint("bd/debug: exit - load/unload\r\n");</span>
01260             KeSweepCurrentIcache();
01261             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01262 
01263             <span class="comment">//</span>
01264             <span class="comment">// Unknown internal command.</span>
01265             <span class="comment">//</span>
01266 
01267         <span class="keywordflow">default</span>:
01268             <span class="keywordflow">break</span>;
01269         }
01270     }
01271 
01272     <span class="comment">//</span>
01273     <span class="comment">// Report state change to kernel debugger on host machine.</span>
01274     <span class="comment">//</span>
01275 
01276 <span class="comment">//    BlPrint("bd/debug: report\r\n");</span>
01277     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a>(TrapFrame, ExceptionFrame, ContextRecord);
01278     Completion = BdReportExceptionStateChange(ExceptionRecord,
01279                                               ContextRecord);
01280 
01281     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame,
01282                        ExceptionFrame,
01283                        ContextRecord,
01284                        ContextRecord-&gt;ContextFlags,
01285                        PreviousMode);
01286 
01287 <span class="comment">//    BlPrint("bd/debug: exit - report\r\n");</span>
01288     KeSweepCurrentIcache();
01289     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01290 }
01291 
01292 LOGICAL
01293 BdStub (
01294     IN PEXCEPTION_RECORD ExceptionRecord,
01295     IN PKEXCEPTION_FRAME ExceptionFrame,
01296     IN PKTRAP_FRAME TrapFrame,
01297     IN KPROCESSOR_MODE PreviousMode,
01298     IN BOOLEAN FirstChance
01299     )
01300 
01301 <span class="comment">/*++</span>
01302 <span class="comment"></span>
01303 <span class="comment">Routine Description:</span>
01304 <span class="comment"></span>
01305 <span class="comment">    This routine provides a kernel debugger stub routine that catchs debug</span>
01306 <span class="comment">    prints in checked systems when the kernel debugger is not active.</span>
01307 <span class="comment"></span>
01308 <span class="comment">Arguments:</span>
01309 <span class="comment"></span>
01310 <span class="comment">    FirmwareFrame - Supplies a pointer to a firmware frame that describes</span>
01311 <span class="comment">        the trap.</span>
01312 <span class="comment"></span>
01313 <span class="comment">Return Value:</span>
01314 <span class="comment"></span>
01315 <span class="comment">    A value of TRUE is returned if the exception is handled. Otherwise a</span>
01316 <span class="comment">    value of FALSE is returned.</span>
01317 <span class="comment"></span>
01318 <span class="comment">--*/</span>
01319 
01320 {
01321 
01322     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01323 }
01324 
01325 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
