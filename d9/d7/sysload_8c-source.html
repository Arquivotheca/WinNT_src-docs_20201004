<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sysload.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sysload.c</h1><a href="../../d8/d8/sysload_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   sysload.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the code to load DLLs into the system portion of</span>
00012 <span class="comment">    the address space and calls the DLL at its initialization entry point.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli 21-May-1991</span>
00017 <span class="comment">    Landy Wang 02-June-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00024 
00025 <span class="comment">//</span>
00026 <span class="comment">// The LDR_DATA_TABLE_ENTRY-&gt;LoadedImports is used as a list of imported DLLs.</span>
00027 <span class="comment">//</span>
00028 <span class="comment">// This field is zero if the module was loaded at boot time and the</span>
00029 <span class="comment">// import information was never filled in.</span>
00030 <span class="comment">//</span>
00031 <span class="comment">// This field is -1 if no imports are defined by the module.</span>
00032 <span class="comment">//</span>
00033 <span class="comment">// This field contains a valid paged pool PLDR_DATA_TABLE_ENTRY pointer</span>
00034 <span class="comment">// with a low-order (bit 0) tag of 1 if there is only 1 usable import needed</span>
00035 <span class="comment">// by this driver.</span>
00036 <span class="comment">//</span>
00037 <span class="comment">// This field will contain a valid paged pool PLOAD_IMPORTS pointer in all</span>
00038 <span class="comment">// other cases (ie: where at least 2 imports exist).</span>
00039 <span class="comment">//</span>
00040 
<a name="l00041"></a><a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">00041</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">_LOAD_IMPORTS</a> {
<a name="l00042"></a><a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">00042</a>     SIZE_T                  <a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a>;
<a name="l00043"></a><a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">00043</a>     PLDR_DATA_TABLE_ENTRY   <a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[1];
00044 } <a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">LOAD_IMPORTS</a>, *<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>;
00045 
<a name="l00046"></a><a class="code" href="../../d8/d8/sysload_8c.html#a0">00046</a> <span class="preprocessor">#define LOADED_AT_BOOT  ((PLOAD_IMPORTS)0)</span>
<a name="l00047"></a><a class="code" href="../../d8/d8/sysload_8c.html#a1">00047</a> <span class="preprocessor"></span><span class="preprocessor">#define NO_IMPORTS_USED ((PLOAD_IMPORTS)-2)</span>
00048 <span class="preprocessor"></span>
<a name="l00049"></a><a class="code" href="../../d8/d8/sysload_8c.html#a2">00049</a> <span class="preprocessor">#define SINGLE_ENTRY(ImportVoid)    ((ULONG)((ULONG_PTR)(ImportVoid) &amp; 0x1))</span>
00050 <span class="preprocessor"></span>
<a name="l00051"></a><a class="code" href="../../d8/d8/sysload_8c.html#a3">00051</a> <span class="preprocessor">#define SINGLE_ENTRY_TO_POINTER(ImportVoid)    ((PLDR_DATA_TABLE_ENTRY)((ULONG_PTR)(ImportVoid) &amp; ~0x1))</span>
00052 <span class="preprocessor"></span>
<a name="l00053"></a><a class="code" href="../../d8/d8/sysload_8c.html#a4">00053</a> <span class="preprocessor">#define POINTER_TO_SINGLE_ENTRY(Pointer)    ((PLDR_DATA_TABLE_ENTRY)((ULONG_PTR)(Pointer) | 0x1))</span>
00054 <span class="preprocessor"></span>
<a name="l00055"></a><a class="code" href="../../d8/d8/sysload_8c.html#a7">00055</a> <a class="code" href="../../d3/d7/struct__KMUTANT.html">KMUTANT</a> <a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>;
00056 
<a name="l00057"></a><a class="code" href="../../d8/d8/sysload_8c.html#a8">00057</a> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a14">MmTotalSystemDriverPages</a>;
00058 
<a name="l00059"></a><a class="code" href="../../d8/d8/sysload_8c.html#a9">00059</a> ULONG <a class="code" href="../../d8/d5/kddata_8c.html#a32">MmDriverCommit</a>;
00060 
<a name="l00061"></a><a class="code" href="../../d8/d8/sysload_8c.html#a10">00061</a> BOOLEAN <a class="code" href="../../d8/d8/sysload_8c.html#a10">MiFirstDriverLoadEver</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00062 
00063 <span class="comment">//</span>
00064 <span class="comment">// This key is set to TRUE to make more memory below 16mb available for drivers.</span>
00065 <span class="comment">// It can be cleared via the registry.</span>
00066 <span class="comment">//</span>
00067 
<a name="l00068"></a><a class="code" href="../../d8/d8/sysload_8c.html#a11">00068</a> LOGICAL <a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00069 
00070 <span class="comment">//</span>
00071 <span class="comment">// Enabled via the registry to identify drivers which unload without releasing</span>
00072 <span class="comment">// resources or still have active timers, etc.</span>
00073 <span class="comment">//</span>
00074 
<a name="l00075"></a><a class="code" href="../../d8/d8/sysload_8c.html#a12">00075</a> <a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">PUNLOADED_DRIVERS</a> <a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a>;
00076 
<a name="l00077"></a><a class="code" href="../../d8/d8/sysload_8c.html#a13">00077</a> ULONG <a class="code" href="../../d9/d5/4_2kddata_8c.html#a47">MiLastUnloadedDriver</a>;
<a name="l00078"></a><a class="code" href="../../d8/d8/sysload_8c.html#a14">00078</a> ULONG <a class="code" href="../../d8/d8/sysload_8c.html#a14">MiTotalUnloads</a>;
<a name="l00079"></a><a class="code" href="../../d8/d8/sysload_8c.html#a15">00079</a> ULONG <a class="code" href="../../d8/d8/sysload_8c.html#a15">MiUnloadsSkipped</a>;
00080 
00081 <span class="comment">//</span>
00082 <span class="comment">// This can be set by the registry.</span>
00083 <span class="comment">//</span>
00084 
<a name="l00085"></a><a class="code" href="../../d8/d8/sysload_8c.html#a16">00085</a> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a30">MmEnforceWriteProtection</a> = 1;
00086 
00087 <span class="comment">//</span>
00088 <span class="comment">// Referenced by ke\bugcheck.c.</span>
00089 <span class="comment">//</span>
00090 
<a name="l00091"></a><a class="code" href="../../d8/d8/sysload_8c.html#a17">00091</a> PVOID <a class="code" href="../../d9/d1/bugcheck_8c.html#a3">ExPoolCodeStart</a>;
<a name="l00092"></a><a class="code" href="../../d8/d8/sysload_8c.html#a18">00092</a> PVOID <a class="code" href="../../d9/d1/bugcheck_8c.html#a4">ExPoolCodeEnd</a>;
<a name="l00093"></a><a class="code" href="../../d8/d8/sysload_8c.html#a19">00093</a> PVOID <a class="code" href="../../d9/d1/bugcheck_8c.html#a5">MmPoolCodeStart</a>;
<a name="l00094"></a><a class="code" href="../../d8/d8/sysload_8c.html#a20">00094</a> PVOID <a class="code" href="../../d9/d1/bugcheck_8c.html#a6">MmPoolCodeEnd</a>;
<a name="l00095"></a><a class="code" href="../../d8/d8/sysload_8c.html#a21">00095</a> PVOID <a class="code" href="../../d9/d1/bugcheck_8c.html#a7">MmPteCodeStart</a>;
<a name="l00096"></a><a class="code" href="../../d8/d8/sysload_8c.html#a22">00096</a> PVOID <a class="code" href="../../d9/d1/bugcheck_8c.html#a8">MmPteCodeEnd</a>;
00097 
00098 <span class="comment">//</span>
00099 <span class="comment">// ****** temporary ******</span>
00100 <span class="comment">//</span>
00101 <span class="comment">// Define reference to external spin lock.</span>
00102 <span class="comment">//</span>
00103 <span class="comment">// ****** temporary ******</span>
00104 <span class="comment">//</span>
00105 
<a name="l00106"></a><a class="code" href="../../d8/d8/sysload_8c.html#a23">00106</a> <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a18">PsLoadedModuleSpinLock</a>;
00107 
00108 ULONG
00109 <a class="code" href="../../d8/d8/sysload_8c.html#a29">LdrDoubleRelocateImage</a> (
00110     IN PVOID NewBase,
00111     IN PVOID CurrentBase,
00112     IN PUCHAR LoaderName,
00113     IN ULONG Success,
00114     IN ULONG Conflict,
00115     IN ULONG Invalid
00116     );
00117 
00118 <span class="preprocessor">#if DBG</span>
00119 <span class="preprocessor"></span>PFN_NUMBER MiPagesConsumed;
00120 <span class="preprocessor">#endif</span>
00121 <span class="preprocessor"></span>
00122 ULONG
00123 <a class="code" href="../../d8/d8/sysload_8c.html#a30">CacheImageSymbols</a>(
00124     IN PVOID ImageBase
00125     );
00126 
00127 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00128 <a class="code" href="../../d8/d8/sysload_8c.html#a31">MiResolveImageReferences</a>(
00129     PVOID ImageBase,
00130     IN PUNICODE_STRING ImageFileDirectory,
00131     IN PUNICODE_STRING NamePrefix OPTIONAL,
00132     IN BOOLEAN LoadInSessionSpace,
00133     OUT PCHAR *MissingProcedureName,
00134     OUT PWSTR *MissingDriverName,
00135     OUT PLOAD_IMPORTS *LoadedImports
00136     );
00137 
00138 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00139 <a class="code" href="../../d8/d8/sysload_8c.html#a32">MiSnapThunk</a>(
00140     IN PVOID DllBase,
00141     IN PVOID ImageBase,
00142     IN PIMAGE_THUNK_DATA NameThunk,
00143     OUT PIMAGE_THUNK_DATA AddrThunk,
00144     IN PIMAGE_EXPORT_DIRECTORY ExportDirectory,
00145     IN ULONG ExportSize,
00146     IN BOOLEAN SnapForwarder,
00147     OUT PCHAR *MissingProcedureName
00148     );
00149 
00150 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00151 <a class="code" href="../../d8/d8/sysload_8c.html#a33">MiLoadImageSection</a> (
00152     IN PSECTION SectionPointer,
00153     OUT PVOID *ImageBase,
00154     IN PUNICODE_STRING ImageFileName,
00155     IN BOOLEAN LoadInSessionSpace
00156     );
00157 
00158 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00159 <a class="code" href="../../d8/d8/sysload_8c.html#a34">MiEnablePagingOfDriver</a> (
00160     IN PVOID ImageHandle
00161     );
00162 
00163 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00164 <a class="code" href="../../d8/d8/sysload_8c.html#a35">MiSetPagingOfDriver</a> (
00165     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
00166     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte,
00167     IN BOOLEAN SessionSpace
00168     );
00169 
00170 PVOID
00171 <a class="code" href="../../d8/d8/sysload_8c.html#a36">MiLookupImageSectionByName</a> (
00172     IN PVOID Base,
00173     IN BOOLEAN MappedAsImage,
00174     IN PCHAR SectionName,
00175     OUT PULONG SectionSize
00176     );
00177 
00178 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00179 <a class="code" href="../../d8/d8/sysload_8c.html#a37">MiClearImports</a>(
00180     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
00181     );
00182 
00183 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00184 <a class="code" href="../../d8/d8/sysload_8c.html#a38">MiBuildImportsForBootDrivers</a>(
00185     VOID
00186     );
00187 
00188 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00189 <a class="code" href="../../d0/d1/psinit_8c.html#a39">MmCheckSystemImage</a>(
00190     IN HANDLE ImageFileHandle
00191     );
00192 
00193 LONG
00194 <a class="code" href="../../d8/d8/sysload_8c.html#a40">MiMapCacheExceptionFilter</a> (
00195     OUT PNTSTATUS Status,
00196     IN PEXCEPTION_POINTERS ExceptionPointer
00197     );
00198 
00199 ULONG
00200 <a class="code" href="../../d8/d8/sysload_8c.html#a41">MiSetProtectionOnTransitionPte</a> (
00201     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
00202     IN ULONG ProtectionMask
00203     );
00204 
00205 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00206 <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (
00207     IN PLOAD_IMPORTS ImportList
00208     );
00209 
00210 LOGICAL
00211 <a class="code" href="../../d8/d8/sysload_8c.html#a43">MiCallDllUnloadAndUnloadDll</a>(
00212     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
00213     );
00214 
00215 PVOID
00216 <a class="code" href="../../d8/d8/sysload_8c.html#a44">MiLocateExportName</a> (
00217     IN PVOID DllBase,
00218     IN PCHAR FunctionName
00219     );
00220 
00221 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00222 <a class="code" href="../../d8/d8/sysload_8c.html#a45">MiLoadSystemImage</a> (
00223     IN PUNICODE_STRING ImageFileName,
00224     IN PUNICODE_STRING NamePrefix OPTIONAL,
00225     IN PUNICODE_STRING LoadedBaseName OPTIONAL,
00226     IN BOOLEAN LoadInSessionSpace,
00227     OUT PVOID *ImageHandle,
00228     OUT PVOID *ImageBaseAddress,
00229     IN BOOLEAN LockDownPages
00230     );
00231 
00232 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00233 <a class="code" href="../../d8/d8/sysload_8c.html#a46">MiRememberUnloadedDriver</a> (
00234     IN PUNICODE_STRING DriverName,
00235     IN PVOID Address,
00236     IN ULONG Length
00237     );
00238 
00239 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00240 <a class="code" href="../../d8/d8/sysload_8c.html#a47">MiWriteProtectSystemImage</a> (
00241     IN PVOID DllBase
00242     );
00243 
00244 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00245 <a class="code" href="../../d8/d8/sysload_8c.html#a48">MiLocateKernelSections</a> (
00246     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
00247     );
00248 
00249 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00250 <a class="code" href="../../d8/d8/sysload_8c.html#a49">MiUpdateThunks</a> (
00251     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock,
00252     IN PVOID OldAddress,
00253     IN PVOID NewAddress,
00254     IN ULONG NumberOfBytes
00255     );
00256 
00257 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00258 <a class="code" href="../../d8/d8/sysload_8c.html#a50">MiCheckPageFilePath</a> (
00259     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject
00260     );
00261 
00262 PVOID
00263 <a class="code" href="../../d8/d8/sysload_8c.html#a51">MiFindExportedRoutineByName</a>(
00264     IN PLDR_DATA_TABLE_ENTRY DataTableEntry,
00265     IN PANSI_STRING AnsiImageRoutineName
00266     );
00267 
<a name="l00268"></a><a class="code" href="../../d8/d8/sysload_8c.html#a24">00268</a> <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a>;
00269 
00270 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00271 <a class="code" href="../../d8/d8/sysload_8c.html#a52">MiRemoveLowPages</a> (
00272     VOID
00273     );
00274 
00275 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00276 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmCheckSystemImage)</span>
00277 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmLoadSystemImage)</span>
00278 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmLoadAndLockSystemImage)</span>
00279 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiLoadSystemImage)</span>
00280 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiResolveImageReferences)</span>
00281 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiSnapThunk)</span>
00282 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiEnablePagingOfDriver)</span>
00283 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmPageEntireDriver)</span>
00284 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiSetImageProtect)</span>
00285 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiDereferenceImports)</span>
00286 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiCallDllUnloadAndUnloadDll)</span>
00287 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiLocateExportName)</span>
00288 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiClearImports)</span>
00289 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiWriteProtectSystemImage)</span>
00290 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmGetSystemRoutineAddress)</span>
00291 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiFindExportedRoutineByName)</span>
00292 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiBuildImportsForBootDrivers)</span>
00293 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiReloadBootLoadedDrivers)</span>
00294 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiUpdateThunks)</span>
00295 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiInitializeLoadedModuleList)</span>
00296 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiLocateKernelSections)</span>
00297 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MmCallDllInitialize)</span>
00298 <span class="preprocessor"></span>
00299 <span class="preprocessor">#if !defined(NT_UP)</span>
00300 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmVerifyImageIsOkForMpUse)</span>
00301 <span class="preprocessor"></span><span class="preprocessor">#endif // NT_UP</span>
00302 <span class="preprocessor"></span>
00303 <span class="preprocessor">#pragma alloc_text(PAGELK,MiLoadImageSection)</span>
00304 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MmFreeDriverInitialization)</span>
00305 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MmUnloadSystemImage)</span>
00306 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MiRememberUnloadedDriver)</span>
00307 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MiSetPagingOfDriver)</span>
00308 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MmResetDriverPaging)</span>
00309 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00310 <span class="preprocessor"></span>
<a name="l00311"></a><a class="code" href="../../d8/d8/sysload_8c.html#a25">00311</a> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d5/d1/mminit_8c.html#a32">MiPteStr</a>[] = <span class="stringliteral">"\0"</span>;
00312 
00313 
00314 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00315"></a><a class="code" href="../../d8/d8/sysload_8c.html#a53">00315</a> <a class="code" href="../../d8/d8/sysload_8c.html#a53">MmLoadSystemImage</a> (
00316     IN PUNICODE_STRING ImageFileName,
00317     IN PUNICODE_STRING NamePrefix OPTIONAL,
00318     IN PUNICODE_STRING LoadedBaseName OPTIONAL,
00319     IN BOOLEAN LoadInSessionSpace,
00320     OUT PVOID *ImageHandle,
00321     OUT PVOID *ImageBaseAddress
00322     )
00323 
00324 <span class="comment">/*++</span>
00325 <span class="comment"></span>
00326 <span class="comment">Routine Description:</span>
00327 <span class="comment"></span>
00328 <span class="comment">    This routine reads the image pages from the specified section into</span>
00329 <span class="comment">    the system and returns the address of the DLL's header.</span>
00330 <span class="comment"></span>
00331 <span class="comment">    At successful completion, the Section is referenced so it remains</span>
00332 <span class="comment">    until the system image is unloaded.</span>
00333 <span class="comment"></span>
00334 <span class="comment">Arguments:</span>
00335 <span class="comment"></span>
00336 <span class="comment">    ImageName - Supplies the Unicode name of the image to load.</span>
00337 <span class="comment"></span>
00338 <span class="comment">    ImageFileName - Supplies the full path name (including the image name)</span>
00339 <span class="comment">                    of the image to load.</span>
00340 <span class="comment"></span>
00341 <span class="comment">    NamePrefix - Supplies the prefix to use with the image name on load</span>
00342 <span class="comment">                 operations.  This is used to load the same image multiple</span>
00343 <span class="comment">                 times, by using different prefixes</span>
00344 <span class="comment"></span>
00345 <span class="comment">    LoadedBaseName - If present, supplies the base name to use on the</span>
00346 <span class="comment">                     loaded image instead of the base name found on the</span>
00347 <span class="comment">                     image name.</span>
00348 <span class="comment"></span>
00349 <span class="comment">    LoadInSessionSpace - Supplies whether to load this image in session space -</span>
00350 <span class="comment">                     ie: each session will have a different copy of this driver</span>
00351 <span class="comment">                     with pages shared as much as possible via copy on write.</span>
00352 <span class="comment"></span>
00353 <span class="comment">    ImageHandle - Returns an opaque pointer to the referenced section object</span>
00354 <span class="comment">                  of the image that was loaded.</span>
00355 <span class="comment"></span>
00356 <span class="comment">    ImageBaseAddress - Returns the image base within the system.</span>
00357 <span class="comment"></span>
00358 <span class="comment">Return Value:</span>
00359 <span class="comment"></span>
00360 <span class="comment">    Status of the load operation.</span>
00361 <span class="comment"></span>
00362 <span class="comment">--*/</span>
00363 
00364 {
00365     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00366 
00367     <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/sysload_8c.html#a45">MiLoadSystemImage</a> (
00368         ImageFileName,
00369         NamePrefix,
00370         LoadedBaseName,
00371         LoadInSessionSpace,
00372         ImageHandle,
00373         ImageBaseAddress,
00374         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00375         );
00376 }
00377 
00378 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00379"></a><a class="code" href="../../d8/d8/sysload_8c.html#a54">00379</a> <a class="code" href="../../d8/d8/sysload_8c.html#a54">MmLoadAndLockSystemImage</a> (
00380     IN PUNICODE_STRING ImageFileName,
00381     IN PUNICODE_STRING NamePrefix OPTIONAL,
00382     IN PUNICODE_STRING LoadedBaseName OPTIONAL,
00383     OUT PVOID *ImageHandle,
00384     OUT PVOID *ImageBaseAddress
00385     )
00386 
00387 <span class="comment">/*++</span>
00388 <span class="comment"></span>
00389 <span class="comment">Routine Description:</span>
00390 <span class="comment"></span>
00391 <span class="comment">    This routine reads the image pages from the specified section into</span>
00392 <span class="comment">    the system and returns the address of the DLL's header.  Very similar</span>
00393 <span class="comment">    to MmLoadSystemImage, except that it also locks down the driver pages.</span>
00394 <span class="comment">    This is needed for things like the dump driver because we cannot page it</span>
00395 <span class="comment">    back in after the system has crashed (when we want to write the system</span>
00396 <span class="comment">    dump to the pagefile).</span>
00397 <span class="comment"></span>
00398 <span class="comment">    At successful completion, the Section is referenced so it remains</span>
00399 <span class="comment">    until the system image is unloaded.</span>
00400 <span class="comment"></span>
00401 <span class="comment">Arguments:</span>
00402 <span class="comment"></span>
00403 <span class="comment">    ImageName - Supplies the Unicode name of the image to load.</span>
00404 <span class="comment"></span>
00405 <span class="comment">    ImageFileName - Supplies the full path name (including the image name)</span>
00406 <span class="comment">                    of the image to load.</span>
00407 <span class="comment"></span>
00408 <span class="comment">    NamePrefix - Supplies the prefix to use with the image name on load</span>
00409 <span class="comment">                 operations.  This is used to load the same image multiple</span>
00410 <span class="comment">                 times, by using different prefixes</span>
00411 <span class="comment"></span>
00412 <span class="comment">    LoadedBaseName - If present, supplies the base name to use on the</span>
00413 <span class="comment">                     loaded image instead of the base name found on the</span>
00414 <span class="comment">                     image name.</span>
00415 <span class="comment"></span>
00416 <span class="comment">    ImageHandle - Returns an opaque pointer to the referenced section object</span>
00417 <span class="comment">                  of the image that was loaded.</span>
00418 <span class="comment"></span>
00419 <span class="comment">    ImageBaseAddress - Returns the image base within the system.</span>
00420 <span class="comment"></span>
00421 <span class="comment">Return Value:</span>
00422 <span class="comment"></span>
00423 <span class="comment">    Status of the load operation.</span>
00424 <span class="comment"></span>
00425 <span class="comment">--*/</span>
00426 
00427 {
00428     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00429 
00430     <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/sysload_8c.html#a45">MiLoadSystemImage</a> (
00431         ImageFileName,
00432         NamePrefix,
00433         LoadedBaseName,
00434         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00435         ImageHandle,
00436         ImageBaseAddress,
00437         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00438         );
00439 }
00440 
00441 
00442 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00443"></a><a class="code" href="../../d8/d8/sysload_8c.html#a45">00443</a> <a class="code" href="../../d8/d8/sysload_8c.html#a45">MiLoadSystemImage</a> (
00444     IN PUNICODE_STRING ImageFileName,
00445     IN PUNICODE_STRING NamePrefix OPTIONAL,
00446     IN PUNICODE_STRING LoadedBaseName OPTIONAL,
00447     IN BOOLEAN LoadInSessionSpace,
00448     OUT PVOID *ImageHandle,
00449     OUT PVOID *ImageBaseAddress,
00450     IN BOOLEAN LockDownPages
00451     )
00452 
00453 <span class="comment">/*++</span>
00454 <span class="comment"></span>
00455 <span class="comment">Routine Description:</span>
00456 <span class="comment"></span>
00457 <span class="comment">    This routine reads the image pages from the specified section into</span>
00458 <span class="comment">    the system and returns the address of the DLL's header.</span>
00459 <span class="comment"></span>
00460 <span class="comment">    At successful completion, the Section is referenced so it remains</span>
00461 <span class="comment">    until the system image is unloaded.</span>
00462 <span class="comment"></span>
00463 <span class="comment">Arguments:</span>
00464 <span class="comment"></span>
00465 <span class="comment">    ImageFileName - Supplies the full path name (including the image name)</span>
00466 <span class="comment">                    of the image to load.</span>
00467 <span class="comment"></span>
00468 <span class="comment">    NamePrefix - If present, supplies the prefix to use with the image name on</span>
00469 <span class="comment">                 load operations.  This is used to load the same image multiple</span>
00470 <span class="comment">                 times, by using different prefixes.</span>
00471 <span class="comment"></span>
00472 <span class="comment">    LoadedBaseName - If present, supplies the base name to use on the</span>
00473 <span class="comment">                     loaded image instead of the base name found on the</span>
00474 <span class="comment">                     image name.</span>
00475 <span class="comment"></span>
00476 <span class="comment">    LoadInSessionSpace - Supplies whether to load this image in session space.</span>
00477 <span class="comment">                         Each session gets a different copy of this driver with</span>
00478 <span class="comment">                         pages shared as much as possible via copy on write.</span>
00479 <span class="comment"></span>
00480 <span class="comment">    ImageHandle - Returns an opaque pointer to the referenced section object</span>
00481 <span class="comment">                  of the image that was loaded.</span>
00482 <span class="comment"></span>
00483 <span class="comment">    ImageBaseAddress - Returns the image base within the system.</span>
00484 <span class="comment"></span>
00485 <span class="comment">    LockDownPages - Supplies TRUE if the image pages should be made nonpagable.</span>
00486 <span class="comment"></span>
00487 <span class="comment">Return Value:</span>
00488 <span class="comment"></span>
00489 <span class="comment">    Status of the load operation.</span>
00490 <span class="comment"></span>
00491 <span class="comment">--*/</span>
00492 
00493 {
00494     KIRQL OldIrql;
00495     PLDR_DATA_TABLE_ENTRY DataTableEntry;
00496     LDR_DATA_TABLE_ENTRY TempDataTableEntry;
00497     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00498     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> SectionPointer;
00499     PIMAGE_NT_HEADERS NtHeaders;
00500     UNICODE_STRING PrefixedImageName;
00501     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>;
00502     UNICODE_STRING BaseDirectory;
00503     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00504     HANDLE FileHandle;
00505     HANDLE SectionHandle;
00506     IO_STATUS_BLOCK IoStatus;
00507     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> NameBuffer[ MAXIMUM_FILENAME_LENGTH ];
00508     PLIST_ENTRY NextEntry;
00509     ULONG NumberOfPtes;
00510     ULONG_PTR ViewSize;
00511     PCHAR MissingProcedureName;
00512     PWSTR MissingDriverName;
00513     <a class="code" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a> LoadedImports;
00514     <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session;
00515     BOOLEAN AlreadyOpen;
00516     BOOLEAN IssueUnloadOnFailure;
00517     ULONG SectionAccess;
00518     <span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00519     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PpeContents;
00520 
00521     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00522 
00523     LoadedImports = (<a class="code" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a>)<a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>;
00524     SectionPointer = (PVOID)-1;
00525     FileHandle = (HANDLE)0;
00526     MissingProcedureName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00527     MissingDriverName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00528     IssueUnloadOnFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00529 
00530     <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00531 
00532         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NamePrefix == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00533         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LoadedBaseName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00534 
00535         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00536 
00537             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 0) {
00538 <span class="preprocessor">#if DBG</span>
00539 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiLoadSystemImage: no session space!\n"</span>);
00540 <span class="preprocessor">#endif</span>
00541 <span class="preprocessor"></span>                <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00542             }
00543 
00544             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a302">MmIsAddressValid</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00545 
00546             Session = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o34">Session</a>;
00547         }
00548         <span class="keywordflow">else</span> {
00549             Session = &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
00550             LoadInSessionSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00551         }
00552     }
00553     <span class="keywordflow">else</span> {
00554         Session = &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
00555     }
00556 
00557     <span class="comment">//</span>
00558     <span class="comment">// Get name roots</span>
00559     <span class="comment">//</span>
00560 
00561     <span class="keywordflow">if</span> (ImageFileName-&gt;Buffer[0] == OBJ_NAME_PATH_SEPARATOR) {
00562         PWCHAR p;
00563         ULONG l;
00564 
00565         p = &amp;ImageFileName-&gt;Buffer[ImageFileName-&gt;Length&gt;&gt;1];
00566         <span class="keywordflow">while</span> (*(p-1) != OBJ_NAME_PATH_SEPARATOR) {
00567             p--;
00568         }
00569         l = (ULONG)(&amp;ImageFileName-&gt;Buffer[ImageFileName-&gt;Length&gt;&gt;1] - p);
00570         l *= <span class="keyword">sizeof</span>(WCHAR);
00571         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)l;
00572         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Buffer = p;
00573     } <span class="keywordflow">else</span> {
00574         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length = ImageFileName-&gt;Length;
00575         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Buffer = ImageFileName-&gt;Buffer;
00576     }
00577 
00578     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.MaximumLength = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length;
00579     BaseDirectory = *ImageFileName;
00580     BaseDirectory.Length -= <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length;
00581     BaseDirectory.MaximumLength = BaseDirectory.Length;
00582     PrefixedImageName = *ImageFileName;
00583 
00584     <span class="comment">//</span>
00585     <span class="comment">// If there's a name prefix, add it to the PrefixedImageName.</span>
00586     <span class="comment">//</span>
00587 
00588     <span class="keywordflow">if</span> (NamePrefix) {
00589         PrefixedImageName.MaximumLength =
00590                 BaseDirectory.Length + NamePrefix-&gt;Length + <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length;
00591 
00592         PrefixedImageName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00593                                     <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00594                                     PrefixedImageName.MaximumLength,
00595                                     'dLmM'
00596                                     );
00597 
00598         <span class="keywordflow">if</span> (!PrefixedImageName.Buffer) {
00599             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00600         }
00601 
00602         PrefixedImageName.Length = 0;
00603         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;PrefixedImageName, &amp;BaseDirectory);
00604         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;PrefixedImageName, NamePrefix);
00605         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;PrefixedImageName, &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>);
00606 
00607         <span class="comment">//</span>
00608         <span class="comment">// Alter the basename to match</span>
00609         <span class="comment">//</span>
00610 
00611         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Buffer = PrefixedImageName.Buffer + BaseDirectory.Length / <span class="keyword">sizeof</span>(WCHAR);
00612         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length += NamePrefix-&gt;Length;
00613         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.MaximumLength += NamePrefix-&gt;Length;
00614     }
00615 
00616     <span class="comment">//</span>
00617     <span class="comment">// If there's a loaded base name, use it instead of the base name.</span>
00618     <span class="comment">//</span>
00619 
00620     <span class="keywordflow">if</span> (LoadedBaseName) {
00621         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a> = *LoadedBaseName;
00622     }
00623 
00624 <span class="preprocessor">#if DBG</span>
00625 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS ) {
00626         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM:SYSLDR Loading %wZ (%wZ) %s\n"</span>,
00627             &amp;PrefixedImageName,
00628             &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>,
00629             LoadInSessionSpace ? <span class="stringliteral">"in session space"</span> : <span class="stringliteral">" "</span>);
00630     }
00631 <span class="preprocessor">#endif</span>
00632 <span class="preprocessor"></span>
00633     AlreadyOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00634 
00635     <span class="comment">//</span>
00636     <span class="comment">// Arbitrary process context so prevent suspend APCs now.</span>
00637     <span class="comment">//</span>
00638 
00639     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00640 
00641     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>,
00642                            <a class="code" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>,
00643                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00644                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00645                            (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00646 
00647     <span class="comment">//</span>
00648     <span class="comment">// Check to see if this name already exists in the loader database.</span>
00649     <span class="comment">//</span>
00650 
00651     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
00652     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
00653 
00654         DataTableEntry = CONTAINING_RECORD(NextEntry,
00655                                            LDR_DATA_TABLE_ENTRY,
00656                                            InLoadOrderLinks);
00657 
00658         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;PrefixedImageName,
00659                                    &amp;DataTableEntry-&gt;FullDllName,
00660                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00661 
00662             <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00663 
00664                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (DataTableEntry-&gt;DllBase) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00665 
00666                     <span class="comment">//</span>
00667                     <span class="comment">// The caller is trying to load a driver in session space</span>
00668                     <span class="comment">// that has already been loaded in system space.  This is</span>
00669                     <span class="comment">// not allowed.</span>
00670                     <span class="comment">//</span>
00671 
00672                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00673                     <span class="keywordflow">goto</span> return2;
00674                 }
00675 
00676                 AlreadyOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00677 
00678                 <span class="comment">//</span>
00679                 <span class="comment">// The LoadCount should generally not be 0 here, but it is</span>
00680                 <span class="comment">// possible in the case where an attempt has been made to</span>
00681                 <span class="comment">// unload a DLL on last dereference, but the DLL refused to</span>
00682                 <span class="comment">// unload.</span>
00683                 <span class="comment">//</span>
00684 
00685                 DataTableEntry-&gt;LoadCount += 1;
00686                 SectionPointer = DataTableEntry-&gt;SectionPointer;
00687                 <span class="keywordflow">break</span>;
00688             }
00689             <span class="keywordflow">else</span> {
00690                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (DataTableEntry-&gt;DllBase) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00691 
00692                     <span class="comment">//</span>
00693                     <span class="comment">// The caller is trying to load a driver in systemwide space</span>
00694                     <span class="comment">// that has already been loaded in session space.  This is</span>
00695                     <span class="comment">// not allowed.</span>
00696                     <span class="comment">//</span>
00697 
00698                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00699                     <span class="keywordflow">goto</span> return2;
00700                 }
00701             }
00702 
00703             *ImageHandle = DataTableEntry;
00704             *ImageBaseAddress = DataTableEntry-&gt;DllBase;
00705             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_IMAGE_ALREADY_LOADED;
00706             <span class="keywordflow">goto</span> return2;
00707         }
00708 
00709         NextEntry = NextEntry-&gt;Flink;
00710     }
00711 
00712     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AlreadyOpen == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || NextEntry == &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>);
00713 
00714     <span class="keywordflow">if</span> (AlreadyOpen == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00715 
00716         DataTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00717 
00718         <span class="comment">//</span>
00719         <span class="comment">// Attempt to open the driver image itself.  If this fails, then the</span>
00720         <span class="comment">// driver image cannot be located, so nothing else matters.</span>
00721         <span class="comment">//</span>
00722 
00723         InitializeObjectAttributes (&amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00724                                     ImageFileName,
00725                                     OBJ_CASE_INSENSITIVE,
00726                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00727                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00728 
00729         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a> (&amp;FileHandle,
00730                              FILE_EXECUTE,
00731                              &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00732                              &amp;IoStatus,
00733                              FILE_SHARE_READ | FILE_SHARE_DELETE,
00734                              0 );
00735 
00736         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00737 
00738 <span class="preprocessor">#if DBG</span>
00739 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
00740                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiLoadImageSection: cannot open %wZ\n"</span>,
00741                     ImageFileName);
00742             }
00743 <span class="preprocessor">#endif</span>
00744 <span class="preprocessor"></span>            <span class="comment">//</span>
00745             <span class="comment">// Don't raise hard error status for file not found.</span>
00746             <span class="comment">//</span>
00747 
00748             <span class="keywordflow">goto</span> return2;
00749         }
00750 
00751         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d1/psinit_8c.html#a39">MmCheckSystemImage</a>(FileHandle);
00752         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_IMAGE_CHECKSUM_MISMATCH) ||
00753             (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_IMAGE_MP_UP_MISMATCH) ||
00754             (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_IMAGE_PROTECT)) {
00755             <span class="keywordflow">goto</span> return1;
00756         }
00757 
00758         <span class="comment">//</span>
00759         <span class="comment">// Now attempt to create an image section for the file.  If this fails,</span>
00760         <span class="comment">// then the driver file is not an image.  Session space drivers are</span>
00761         <span class="comment">// shared text with copy on write data, so don't allow writes here.</span>
00762         <span class="comment">//</span>
00763 
00764         <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00765             SectionAccess = SECTION_MAP_READ | SECTION_MAP_EXECUTE;
00766         }
00767         <span class="keywordflow">else</span> {
00768             SectionAccess = SECTION_ALL_ACCESS;
00769         }
00770 
00771         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateSection (&amp;SectionHandle,
00772                                   SectionAccess,
00773                                   (POBJECT_ATTRIBUTES) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00774                                   (PLARGE_INTEGER) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00775                                   PAGE_EXECUTE,
00776                                   SEC_IMAGE,
00777                                   FileHandle );
00778 
00779         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00780             <span class="keywordflow">goto</span> return1;
00781         }
00782 
00783         <span class="comment">//</span>
00784         <span class="comment">// Now reference the section handle.</span>
00785         <span class="comment">//</span>
00786 
00787         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (SectionHandle,
00788                                         SECTION_MAP_EXECUTE,
00789                                         <a class="code" href="../../d2/d1/mm_8h.html#a133">MmSectionObjectType</a>,
00790                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00791                                         (PVOID *) &amp;SectionPointer,
00792                                         (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00793 
00794         ZwClose (SectionHandle);
00795         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00796             <span class="keywordflow">goto</span> return1;
00797         }
00798 
00799         <span class="keywordflow">if</span> (SectionPointer-&gt;Segment-&gt;ControlArea-&gt;NumberOfSubsections == 1) {
00800             <span class="keywordflow">if</span> ((LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00801                 (SectionPointer-&gt;Segment-&gt;BasedAddress != (PVOID)Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o2">SystemSpaceViewStart</a>)) {
00802 
00803                 <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> SectionPointer2;
00804 
00805                 <span class="comment">//</span>
00806                 <span class="comment">// The driver was linked with subsection alignment such that</span>
00807                 <span class="comment">// it is mapped with one subsection.  Since the CreateSection</span>
00808                 <span class="comment">// above guarantees that the driver image is indeed a</span>
00809                 <span class="comment">// satisfactory executable, map it directly now to reuse the</span>
00810                 <span class="comment">// cache from the MmCheckSystemImage call above.</span>
00811                 <span class="comment">//</span>
00812 
00813                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateSection (&amp;SectionHandle,
00814                                           SectionAccess,
00815                                           (POBJECT_ATTRIBUTES) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00816                                           (PLARGE_INTEGER) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00817                                           PAGE_EXECUTE,
00818                                           SEC_COMMIT,
00819                                           FileHandle );
00820 
00821                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00822 
00823                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
00824                                             SectionHandle,
00825                                             SECTION_MAP_EXECUTE,
00826                                             <a class="code" href="../../d2/d1/mm_8h.html#a133">MmSectionObjectType</a>,
00827                                             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00828                                             (PVOID *) &amp;SectionPointer2,
00829                                             (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00830 
00831                     ZwClose (SectionHandle);
00832 
00833                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00834 
00835                         <span class="comment">//</span>
00836                         <span class="comment">// The number of PTEs won't match if the image is</span>
00837                         <span class="comment">// stripped and the debug directory crosses the last</span>
00838                         <span class="comment">// sector boundary of the file.  We could still use the</span>
00839                         <span class="comment">// new section, but these cases are under 2% of all the</span>
00840                         <span class="comment">// drivers loaded so don't bother.</span>
00841                         <span class="comment">//</span>
00842 
00843                         <span class="keywordflow">if</span> (SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes == SectionPointer2-&gt;Segment-&gt;TotalNumberOfPtes) {
00844                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SectionPointer);
00845                             SectionPointer = SectionPointer2;
00846                         }
00847                         <span class="keywordflow">else</span> {
00848                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SectionPointer2);
00849                         }
00850                     }
00851                 }
00852             }
00853         }
00854 
00855     }
00856 
00857     <span class="keywordflow">if</span> ((LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00858         (SectionPointer-&gt;Segment-&gt;BasedAddress == (PVOID)Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o2">SystemSpaceViewStart</a>) &amp;&amp;
00859         (SectionPointer-&gt;Segment-&gt;ControlArea-&gt;NumberOfMappedViews == 0)) {
00860         NumberOfPtes = 0;
00861         ViewSize = 0;
00862 
00863         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a27">MmMapViewInSystemSpace</a> (SectionPointer,
00864                                          ImageBaseAddress,
00865                                          &amp;ViewSize);
00866         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) &amp;&amp;
00867             (*ImageBaseAddress == SectionPointer-&gt;Segment-&gt;BasedAddress))) {
00868 
00869             SectionPointer-&gt;Segment-&gt;SystemImageBase = *ImageBaseAddress;
00870             SectionPointer-&gt;Segment-&gt;ControlArea-&gt;u.Flags.ImageMappedInSystemSpace = 1;
00871             NumberOfPtes = (ULONG)((ViewSize + 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00872             <a class="code" href="../../d8/d8/sysload_8c.html#a62">MiSetImageProtect</a>(SectionPointer-&gt;Segment, <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>);
00873 
00874 <span class="preprocessor">#if defined (_AXP64_)</span>
00875 <span class="preprocessor"></span>
00876             <span class="comment">//</span>
00877             <span class="comment">// This is needed because win32k calls are made from the system</span>
00878             <span class="comment">// process on non-Hydra systems.  On Hydra systems, these calls</span>
00879             <span class="comment">// are always made from the relevant session's csrss process.</span>
00880             <span class="comment">// If these were the same, this PPE duplication could be removed.</span>
00881             <span class="comment">//</span>
00882 
00883             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (*ImageBaseAddress);
00884             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0);
00885             PpeContents = *PointerPpe;
00886             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
00887             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;u.Long == 0);
00888             *PointerPpe = PpeContents;
00889             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00890 <span class="preprocessor">#endif</span>
00891 <span class="preprocessor"></span>            <span class="keywordflow">goto</span> BindImage;
00892         }
00893     }
00894 
00895     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
00896 
00897     <span class="comment">//</span>
00898     <span class="comment">// Load the driver from the filesystem and pick a virtual address for it.</span>
00899     <span class="comment">// For Hydra, this means also allocating session virtual space, and</span>
00900     <span class="comment">// after mapping a view of the image, either copying or sharing the</span>
00901     <span class="comment">// driver's code and data in the session virtual space.</span>
00902     <span class="comment">//</span>
00903     <span class="comment">// If it is a share map because the image was loaded at its based address,</span>
00904     <span class="comment">// the disk image will remain busy.</span>
00905     <span class="comment">//</span>
00906 
00907     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a33">MiLoadImageSection</a> (SectionPointer,
00908                                  ImageBaseAddress,
00909                                  ImageFileName,
00910                                  LoadInSessionSpace);
00911 
00912     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
00913 
00914     NumberOfPtes = SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes;
00915 
00916     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ALREADY_COMMITTED) {
00917 
00918         <span class="comment">//</span>
00919         <span class="comment">// This is a driver that was relocated that is being loaded into</span>
00920         <span class="comment">// the same session space twice.  Don't increment the overall load</span>
00921         <span class="comment">// count - just the image count in the session which has already been</span>
00922         <span class="comment">// done.</span>
00923         <span class="comment">//</span>
00924 
00925         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00926         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AlreadyOpen == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00927         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00928         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00929         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry-&gt;LoadCount &gt; 1);
00930 
00931         *ImageHandle = DataTableEntry;
00932         *ImageBaseAddress = DataTableEntry-&gt;DllBase;
00933 
00934         DataTableEntry-&gt;LoadCount -= 1;
00935         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00936         <span class="keywordflow">goto</span> return1;
00937     }
00938 
00939     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a10">MiFirstDriverLoadEver</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00940 
00941         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> PagingPathStatus;
00942 
00943         <span class="comment">//</span>
00944         <span class="comment">// Check with all of the drivers along the path to win32k.sys to</span>
00945         <span class="comment">// ensure that they are willing to follow the rules required</span>
00946         <span class="comment">// of them and to give them a chance to lock down code and data</span>
00947         <span class="comment">// that needs to be locked.  If any of the drivers along the path</span>
00948         <span class="comment">// refuses to participate, fail the win32k.sys load.</span>
00949         <span class="comment">//</span>
00950 
00951         <span class="comment">//</span>
00952         <span class="comment">// It is assumed that all drivers live on the same physical drive, so</span>
00953         <span class="comment">// when the very first driver is loaded, this check can be made.</span>
00954         <span class="comment">// This eliminates the need to check for things like relocated win32ks,</span>
00955         <span class="comment">// Terminal Server systems, etc.</span>
00956         <span class="comment">//</span>
00957 
00958         PagingPathStatus = <a class="code" href="../../d8/d8/sysload_8c.html#a50">MiCheckPageFilePath</a> (SectionPointer-&gt;Segment-&gt;ControlArea-&gt;FilePointer);
00959 
00960         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(PagingPathStatus)) {
00961 
00962             KdPrint(( <span class="stringliteral">"MiCheckPageFilePath FAILED for win32k.sys: %x\n"</span>,
00963                 PagingPathStatus ));
00964 
00965             <span class="comment">//</span>
00966             <span class="comment">// BUGBUG: Failing the insertion of win32k.sys' device in the</span>
00967             <span class="comment">// pagefile path is commented out until the storage drivers have</span>
00968             <span class="comment">// been modified to correctly handle this request.  Add code</span>
00969             <span class="comment">// here to release relevant resources for the error path.</span>
00970             <span class="comment">//</span>
00971         }
00972 
00973         <a class="code" href="../../d8/d8/sysload_8c.html#a10">MiFirstDriverLoadEver</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00974     }
00975 
00976     <span class="comment">//</span>
00977     <span class="comment">// Normal drivers are dereferenced here and their images can then be</span>
00978     <span class="comment">// overwritten.  This is ok because we've already read the whole thing</span>
00979     <span class="comment">// into memory and from here until reboot (or unload), we back them</span>
00980     <span class="comment">// with the pagefile.</span>
00981     <span class="comment">//</span>
00982     <span class="comment">// win32k.sys and session space drivers are the exception - these images</span>
00983     <span class="comment">// are inpaged from the filesystem and we need to keep our reference to</span>
00984     <span class="comment">// the file so that it doesn't get overwritten.</span>
00985     <span class="comment">//</span>
00986 
00987     <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00988         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SectionPointer);
00989         SectionPointer = (PVOID)-1;
00990     }
00991 
00992     <span class="comment">//</span>
00993     <span class="comment">// The module LoadCount will be 1 here if the module was just loaded.</span>
00994     <span class="comment">// The LoadCount will be &gt;1 if it was attached to by a session (as opposed</span>
00995     <span class="comment">// to just loaded).</span>
00996     <span class="comment">//</span>
00997 
00998     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00999         <span class="keywordflow">if</span> (AlreadyOpen == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01000 
01001             <span class="comment">//</span>
01002             <span class="comment">// We're failing and we were just attaching to an already loaded</span>
01003             <span class="comment">// driver.  We don't want to go through the forced unload path</span>
01004             <span class="comment">// because we've already deleted the address space.  Simply</span>
01005             <span class="comment">// decrement our reference and null the DataTableEntry</span>
01006             <span class="comment">// so we don't go through the forced unload path.</span>
01007             <span class="comment">//</span>
01008 
01009             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01010             DataTableEntry-&gt;LoadCount -= 1;
01011             DataTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01012         }
01013         <span class="keywordflow">goto</span> return1;
01014     }
01015 
01016     <span class="comment">//</span>
01017     <span class="comment">// Error recovery from this point out for sessions works as follows:</span>
01018     <span class="comment">//</span>
01019     <span class="comment">// For sessions, we may or may not have a DataTableEntry at this point.</span>
01020     <span class="comment">// If we do, it's because we're attaching to a driver that has already</span>
01021     <span class="comment">// been loaded - and the DataTableEntry-&gt;LoadCount has been bumped - so</span>
01022     <span class="comment">// the error recovery from here on out is to just call</span>
01023     <span class="comment">// MmUnloadSystemImage with the DataTableEntry.</span>
01024     <span class="comment">//</span>
01025     <span class="comment">// If this is the first load of a given driver into a session space, we</span>
01026     <span class="comment">// have no DataTableEntry at this point.  The view has already been mapped</span>
01027     <span class="comment">// and committed and the group/session addresses reserved for this DLL.</span>
01028     <span class="comment">// The error recovery path handles all this because</span>
01029     <span class="comment">// MmUnloadSystemImage will zero the relevant fields in the</span>
01030     <span class="comment">// LDR_DATA_TABLE_ENTRY so that MmUnloadSystemImage will work properly.</span>
01031     <span class="comment">//</span>
01032 
01033     IssueUnloadOnFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01034 
01035     <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || *ImageBaseAddress != SectionPointer-&gt;Segment-&gt;BasedAddress) {
01036 
01037 <span class="preprocessor">#if DBG</span>
01038 <span class="preprocessor"></span>
01039         <span class="comment">//</span>
01040         <span class="comment">// Warn users about session images that cannot be shared</span>
01041         <span class="comment">// because they were linked at a bad address.</span>
01042         <span class="comment">//</span>
01043 
01044         <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>) {
01045             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: Session %d image %wZ is linked at a nonsharable address (%p)\n"</span>,
01046                     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
01047                     ImageFileName,
01048                     SectionPointer-&gt;Segment-&gt;BasedAddress);
01049             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: Image %wZ has been moved to address (%p) by the system so it can run,\n"</span>,
01050                     ImageFileName,
01051                     *ImageBaseAddress);
01052             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">" but this needs to be fixed in the image for sharing to occur.\n"</span>);
01053         }
01054 <span class="preprocessor">#endif</span>
01055 <span class="preprocessor"></span>
01056         <span class="comment">//</span>
01057         <span class="comment">// Apply the fixups to the section and resolve its image references.</span>
01058         <span class="comment">//</span>
01059 
01060         <span class="keywordflow">try</span> {
01061             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d0/d3/ldrreloc_8c.html#a5">LdrRelocateImage</a>(*ImageBaseAddress,
01062                                                 <span class="stringliteral">"SYSLDR"</span>,
01063                                                 (ULONG)STATUS_SUCCESS,
01064                                                 (ULONG)STATUS_CONFLICTING_ADDRESSES,
01065                                                 (ULONG)STATUS_INVALID_IMAGE_FORMAT
01066                                                 );
01067         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01068             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01069             KdPrint((<span class="stringliteral">"MM:sysload - LdrRelocateImage failed status %lx\n"</span>,
01070                       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01071         }
01072 
01073         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01074 
01075             <span class="comment">//</span>
01076             <span class="comment">// Unload the system image and dereference the section.</span>
01077             <span class="comment">//</span>
01078 
01079             <span class="keywordflow">goto</span> return1;
01080         }
01081     }
01082 
01083 BindImage:
01084 
01085     <span class="keywordflow">try</span> {
01086         MissingProcedureName = NameBuffer;
01087 
01088         <span class="comment">//</span>
01089         <span class="comment">// Resolving the image references results in other DLLs being</span>
01090         <span class="comment">// loaded if they are referenced by the module that was just loaded.</span>
01091         <span class="comment">// An example is when an OEM printer or FAX driver links with</span>
01092         <span class="comment">// other general libraries.  This is not a problem for session space</span>
01093         <span class="comment">// because the general libraries do not have the global data issues</span>
01094         <span class="comment">// that win32k.sys and the video drivers do.  So we just call the</span>
01095         <span class="comment">// standard kernel reference resolver and any referenced libraries</span>
01096         <span class="comment">// get loaded into system global space.  Code in the routine</span>
01097         <span class="comment">// restricts which libraries can be referenced by a driver.</span>
01098         <span class="comment">//</span>
01099 
01100         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a31">MiResolveImageReferences</a>(*ImageBaseAddress,
01101                                           &amp;BaseDirectory,
01102                                           NamePrefix,
01103                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01104                                           &amp;MissingProcedureName,
01105                                           &amp;MissingDriverName,
01106                                           &amp;LoadedImports
01107                                          );
01108     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01109         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01110         KdPrint((<span class="stringliteral">"MM:sysload - ResolveImageReferences failed status %x\n"</span>,
01111                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01112     }
01113 
01114     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01115 <span class="preprocessor">#if DBG</span>
01116 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_DRIVER_ORDINAL_NOT_FOUND ||
01117             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_DRIVER_ENTRYPOINT_NOT_FOUND) {
01118 
01119             <span class="keywordflow">if</span> ((ULONG_PTR)MissingProcedureName &amp; ~((ULONG_PTR) (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>-1))) {
01120                 <span class="comment">//</span>
01121                 <span class="comment">// If not an ordinal, print string</span>
01122                 <span class="comment">//</span>
01123                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MissingProcedureName %s\n"</span>, MissingProcedureName);
01124             }
01125             <span class="keywordflow">else</span> {
01126                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MissingProcedureName 0x%p\n"</span>, MissingProcedureName);
01127             }
01128 
01129             <span class="keywordflow">if</span> (MissingDriverName) {
01130                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MissingDriverName %ws\n"</span>, MissingDriverName);
01131             }
01132         }
01133 <span class="preprocessor">#endif</span>
01134 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> return1;
01135     }
01136 
01137 <span class="preprocessor">#if DBG</span>
01138 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
01139         KdPrint ((<span class="stringliteral">"MM:loaded driver - consumed %ld. pages\n"</span>,MiPagesConsumed));
01140     }
01141 <span class="preprocessor">#endif</span>
01142 <span class="preprocessor"></span>
01143     <span class="keywordflow">if</span> (AlreadyOpen == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01144 
01145         <span class="comment">//</span>
01146         <span class="comment">// Since there was no loaded module list entry for this driver, create</span>
01147         <span class="comment">// one now.</span>
01148         <span class="comment">//</span>
01149 
01150 <span class="preprocessor">#if DBG</span>
01151 <span class="preprocessor"></span>        NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
01152         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
01153             DataTableEntry = CONTAINING_RECORD(NextEntry,
01154                                                LDR_DATA_TABLE_ENTRY,
01155                                                InLoadOrderLinks);
01156 
01157             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (ImageFileName,
01158                                        &amp;DataTableEntry-&gt;FullDllName,
01159                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01160 
01161                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM SYSLDR: Image already loaded! RefCount %x\n"</span>,
01162                     DataTableEntry-&gt;LoadCount);
01163                 DbgBreakPoint();
01164             }
01165 
01166             NextEntry = NextEntry-&gt;Flink;
01167         }
01168 <span class="preprocessor">#endif</span>
01169 <span class="preprocessor"></span>
01170         <span class="comment">//</span>
01171         <span class="comment">// Allocate a data table entry for structured exception handling.</span>
01172         <span class="comment">//</span>
01173 
01174         DataTableEntry = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01175                                                 <span class="keyword">sizeof</span>(LDR_DATA_TABLE_ENTRY),
01176                                                 'dLmM');
01177 
01178         <span class="keywordflow">if</span> (DataTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01179             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01180             <span class="keywordflow">goto</span> return1;
01181         }
01182 
01183         DataTableEntry-&gt;BaseDllName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
01184                                         <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01185                                         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length + <span class="keyword">sizeof</span>(UNICODE_NULL),
01186                                         'dLmM');
01187 
01188         <span class="keywordflow">if</span> (DataTableEntry-&gt;BaseDllName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01189             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DataTableEntry);
01190             DataTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01191             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01192             <span class="keywordflow">goto</span> return1;
01193         }
01194 
01195         <span class="comment">//</span>
01196         <span class="comment">// Initialize the address of the DLL image file header and the entry</span>
01197         <span class="comment">// point address.</span>
01198         <span class="comment">//</span>
01199 
01200         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(*ImageBaseAddress);
01201 
01202         DataTableEntry-&gt;DllBase = *ImageBaseAddress;
01203         DataTableEntry-&gt;EntryPoint =
01204             ((PCHAR)*ImageBaseAddress + NtHeaders-&gt;OptionalHeader.AddressOfEntryPoint);
01205         DataTableEntry-&gt;SizeOfImage = NumberOfPtes &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01206         DataTableEntry-&gt;CheckSum = NtHeaders-&gt;OptionalHeader.CheckSum;
01207         DataTableEntry-&gt;SectionPointer = (PVOID)SectionPointer;
01208 
01209         <span class="comment">//</span>
01210         <span class="comment">// Store the DLL name.</span>
01211         <span class="comment">//</span>
01212 
01213         DataTableEntry-&gt;BaseDllName.Length = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length;
01214         DataTableEntry-&gt;BaseDllName.MaximumLength = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length;
01215         RtlMoveMemory (DataTableEntry-&gt;BaseDllName.Buffer,
01216                        <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Buffer,
01217                        <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length );
01218         DataTableEntry-&gt;BaseDllName.Buffer[<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
01219 
01220         DataTableEntry-&gt;FullDllName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01221                                                          PrefixedImageName.Length + <span class="keyword">sizeof</span>(UNICODE_NULL),
01222                                                          'TDmM');
01223         <span class="keywordflow">if</span> (DataTableEntry-&gt;FullDllName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01224 
01225             <span class="comment">//</span>
01226             <span class="comment">// Pool could not be allocated, just set the length to 0.</span>
01227             <span class="comment">//</span>
01228 
01229             DataTableEntry-&gt;FullDllName.Length = 0;
01230             DataTableEntry-&gt;FullDllName.MaximumLength = 0;
01231         } <span class="keywordflow">else</span> {
01232             DataTableEntry-&gt;FullDllName.Length = PrefixedImageName.Length;
01233             DataTableEntry-&gt;FullDllName.MaximumLength = PrefixedImageName.Length;
01234             RtlMoveMemory (DataTableEntry-&gt;FullDllName.Buffer,
01235                            PrefixedImageName.Buffer,
01236                            PrefixedImageName.Length);
01237             DataTableEntry-&gt;FullDllName.Buffer[PrefixedImageName.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
01238         }
01239 
01240         <a class="code" href="../../d2/d1/mm_8h.html#a62">PERFINFO_IMAGE_LOAD</a>(DataTableEntry);
01241 
01242         <span class="comment">//</span>
01243         <span class="comment">// Initialize the flags, load count, and insert the data table entry</span>
01244         <span class="comment">// in the loaded module list.</span>
01245         <span class="comment">//</span>
01246 
01247         DataTableEntry-&gt;Flags = LDRP_ENTRY_PROCESSED | LDRP_SYSTEM_MAPPED;
01248         DataTableEntry-&gt;LoadCount = 1;
01249         DataTableEntry-&gt;LoadedImports = (PVOID)LoadedImports;
01250 
01251         <span class="keywordflow">if</span> ((NtHeaders-&gt;OptionalHeader.MajorOperatingSystemVersion &gt;= 5) &amp;&amp;
01252             (NtHeaders-&gt;OptionalHeader.MajorImageVersion &gt;= 5)) {
01253             DataTableEntry-&gt;Flags |= LDRP_ENTRY_NATIVE;
01254         }
01255 
01256         <a class="code" href="../../d9/d5/verifier_8c.html#a110">MiApplyDriverVerifier</a> (DataTableEntry, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01257 
01258         <a class="code" href="../../d8/d8/sysload_8c.html#a47">MiWriteProtectSystemImage</a> (DataTableEntry-&gt;DllBase);
01259 
01260         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a72">PsImageNotifyEnabled</a>) {
01261             <a class="code" href="../../d2/d1/struct__IMAGE__INFO.html">IMAGE_INFO</a> ImageInfo;
01262 
01263             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o0">Properties</a> = 0;
01264             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o1">ImageAddressingMode</a> = <a class="code" href="../../d1/d9/ps_8h.html#a23">IMAGE_ADDRESSING_MODE_32BIT</a>;
01265             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o2">SystemModeImage</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01266             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = DataTableEntry-&gt;SizeOfImage;
01267             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o5">ImageBase</a> = *ImageBaseAddress;
01268             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o6">ImageSelector</a> = 0;
01269             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o8">ImageSectionNumber</a> = 0;
01270 
01271             <a class="code" href="../../d2/d8/ps_2create_8c.html#a28">PsCallImageNotifyRoutines</a>(ImageFileName, (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;ImageInfo);
01272         }
01273 
01274         <span class="comment">//</span>
01275         <span class="comment">// Acquire the loaded module list resource and insert this entry</span>
01276         <span class="comment">// into the list.</span>
01277         <span class="comment">//</span>
01278 
01279         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01280         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01281 
01282         ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a18">PsLoadedModuleSpinLock</a>, &amp;OldIrql);
01283 
01284         InsertTailList(&amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>, &amp;DataTableEntry-&gt;InLoadOrderLinks);
01285 
01286         ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a18">PsLoadedModuleSpinLock</a>, OldIrql);
01287 
01288         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>);
01289         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01290 
01291         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a30">CacheImageSymbols</a> (*ImageBaseAddress)) {
01292 
01293             <span class="comment">//</span>
01294             <span class="comment">//  TEMP TEMP TEMP rip out when debugger converted</span>
01295             <span class="comment">//</span>
01296 
01297             ANSI_STRING AnsiName;
01298             UNICODE_STRING UnicodeName;
01299 
01300             <span class="comment">//</span>
01301             <span class="comment">//  \SystemRoot is 11 characters in length</span>
01302             <span class="comment">//</span>
01303             <span class="keywordflow">if</span> (PrefixedImageName.Length &gt; (11 * <span class="keyword">sizeof</span>( WCHAR )) &amp;&amp;
01304                 !_wcsnicmp( PrefixedImageName.Buffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\SystemRoot"</span>, 11 )
01305                ) {
01306                 UnicodeName = PrefixedImageName;
01307                 UnicodeName.Buffer += 11;
01308                 UnicodeName.Length -= (11 * <span class="keyword">sizeof</span>( WCHAR ));
01309                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a> (NameBuffer, <span class="stringliteral">"%ws%wZ"</span>, &amp;SharedUserData-&gt;NtSystemRoot[2], &amp;UnicodeName);
01310             } <span class="keywordflow">else</span> {
01311                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a> (NameBuffer, <span class="stringliteral">"%wZ"</span>, &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>);
01312             }
01313             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a> (&amp;AnsiName, NameBuffer);
01314             DbgLoadImageSymbols (&amp;AnsiName,
01315                                  *ImageBaseAddress,
01316                                  (ULONG_PTR) -1
01317                                );
01318             DataTableEntry-&gt;Flags |= LDRP_DEBUG_SYMBOLS_LOADED;
01319         }
01320     }
01321 
01322     <span class="comment">//</span>
01323     <span class="comment">// Flush the instruction cache on all systems in the configuration.</span>
01324     <span class="comment">//</span>
01325 
01326     <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a7">KeSweepIcache</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01327     *ImageHandle = DataTableEntry;
01328     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01329 
01330     <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01331         <a class="code" href="../../d8/d8/sysload_8c.html#a56">MmPageEntireDriver</a> (DataTableEntry-&gt;EntryPoint);
01332     }
01333     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SectionPointer == (PVOID)-1 &amp;&amp; LockDownPages == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01334         <a class="code" href="../../d8/d8/sysload_8c.html#a34">MiEnablePagingOfDriver</a> (DataTableEntry);
01335     }
01336 
01337 return1:
01338 
01339     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01340 
01341 <span class="preprocessor">#if DBG</span>
01342 <span class="preprocessor"></span>
01343         <span class="comment">//</span>
01344         <span class="comment">// Only way we should fail after we get a valid DataTableEntry is if</span>
01345         <span class="comment">// we're Hydra loading a 2nd instance of a driver.</span>
01346         <span class="comment">//</span>
01347 
01348         <span class="keywordflow">if</span> (DataTableEntry) {
01349             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; AlreadyOpen == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; DataTableEntry-&gt;LoadCount &gt; 1);
01350         }
01351 <span class="preprocessor">#endif</span>
01352 <span class="preprocessor"></span>
01353         <span class="keywordflow">if</span> (AlreadyOpen == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; SectionPointer != (PVOID)-1) {
01354 
01355             <span class="comment">//</span>
01356             <span class="comment">// This is needed for failed win32k.sys loads or any Hydra session's</span>
01357             <span class="comment">// load of the first instance of a driver.</span>
01358             <span class="comment">//</span>
01359 
01360             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SectionPointer);
01361         }
01362 
01363         <span class="keywordflow">if</span> (IssueUnloadOnFailure == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01364             
01365             <span class="keywordflow">if</span> (DataTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01366                 RtlZeroMemory (&amp;TempDataTableEntry, <span class="keyword">sizeof</span>(LDR_DATA_TABLE_ENTRY));
01367             
01368                 DataTableEntry = &amp;TempDataTableEntry;
01369         
01370                 DataTableEntry-&gt;DllBase = *ImageBaseAddress;
01371                 DataTableEntry-&gt;SizeOfImage = NumberOfPtes &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01372                 DataTableEntry-&gt;LoadCount = 1;
01373                 DataTableEntry-&gt;LoadedImports = LoadedImports;
01374             }
01375 <span class="preprocessor">#if DBG</span>
01376 <span class="preprocessor"></span>            <span class="keywordflow">else</span> {
01377         
01378                 <span class="comment">//</span>
01379                 <span class="comment">// If DataTableEntry is NULL, then we are unloading before one</span>
01380                 <span class="comment">// got created.  Once a LDR_DATA_TABLE_ENTRY is created, the</span>
01381                 <span class="comment">// load cannot fail, so if exists here, at least one other</span>
01382                 <span class="comment">// session contains this image as well.</span>
01383                 <span class="comment">//</span>
01384         
01385                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01386                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry-&gt;LoadCount &gt; 1);
01387             }
01388 <span class="preprocessor">#endif</span>
01389 <span class="preprocessor"></span>            
01390             <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a> ((PVOID)DataTableEntry);
01391         }
01392     }
01393 
01394     <span class="keywordflow">if</span> (FileHandle) {
01395         ZwClose (FileHandle);
01396     }
01397     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01398 
01399         ULONG_PTR ErrorParameters[ 3 ];
01400         ULONG NumberOfParameters;
01401         ULONG UnicodeStringParameterMask;
01402         ULONG ErrorResponse;
01403         ANSI_STRING AnsiString;
01404         UNICODE_STRING ProcedureName;
01405         UNICODE_STRING DriverName;
01406 
01407         <span class="comment">//</span>
01408         <span class="comment">// Hard error time.  A driver could not be loaded.</span>
01409         <span class="comment">//</span>
01410 
01411         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01412         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01413         ErrorParameters[ 0 ] = (ULONG_PTR)ImageFileName;
01414         NumberOfParameters = 1;
01415         UnicodeStringParameterMask = 1;
01416 
01417         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;ProcedureName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01418         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_DRIVER_ORDINAL_NOT_FOUND ||
01419             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_DRIVER_ENTRYPOINT_NOT_FOUND ||
01420             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PROCEDURE_NOT_FOUND
01421            ) {
01422             NumberOfParameters = 3;
01423             UnicodeStringParameterMask = 0x5;
01424             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;DriverName, MissingDriverName );
01425             ErrorParameters[ 2 ] = (ULONG_PTR)&amp;DriverName;
01426 
01427             <span class="keywordflow">if</span> ((ULONG_PTR)MissingProcedureName &amp; ~((ULONG_PTR) (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>-1))) {
01428                 <span class="comment">//</span>
01429                 <span class="comment">// If not an ordinal, pass as a Unicode string</span>
01430                 <span class="comment">//</span>
01431 
01432                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;AnsiString, MissingProcedureName );
01433                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;ProcedureName, &amp;AnsiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01434                 ErrorParameters[ 1 ] = (ULONG_PTR)&amp;ProcedureName;
01435                 UnicodeStringParameterMask |= 0x2;
01436             } <span class="keywordflow">else</span> {
01437                 <span class="comment">//</span>
01438                 <span class="comment">// Just pass ordinal values as is.</span>
01439                 <span class="comment">//</span>
01440 
01441                 ErrorParameters[ 1 ] = (ULONG_PTR)MissingProcedureName;
01442             }
01443         } <span class="keywordflow">else</span> {
01444             NumberOfParameters = 2;
01445             ErrorParameters[ 1 ] = (ULONG)<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01446             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_DRIVER_UNABLE_TO_LOAD;
01447             }
01448 
01449         ZwRaiseHardError (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,
01450                           NumberOfParameters,
01451                           UnicodeStringParameterMask,
01452                           ErrorParameters,
01453                           OptionOkNoWait,
01454                           &amp;ErrorResponse);
01455 
01456         <span class="keywordflow">if</span> (ProcedureName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01457             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;ProcedureName );
01458         }
01459         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01460     }
01461 
01462 return2:
01463     <span class="keywordflow">if</span> (NamePrefix) {
01464         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PrefixedImageName.Buffer);
01465     }
01466 
01467     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01468     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01469     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01470 }
01471 
01472 
01473 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01474"></a><a class="code" href="../../d8/d8/sysload_8c.html#a33">01474</a> <a class="code" href="../../d8/d8/sysload_8c.html#a33">MiLoadImageSection</a> (
01475     IN PSECTION SectionPointer,
01476     OUT PVOID *ImageBaseAddress,
01477     IN PUNICODE_STRING ImageFileName,
01478     IN BOOLEAN LoadInSessionSpace
01479     )
01480 
01481 <span class="comment">/*++</span>
01482 <span class="comment"></span>
01483 <span class="comment">Routine Description:</span>
01484 <span class="comment"></span>
01485 <span class="comment">    This routine loads the specified image into the kernel part of the</span>
01486 <span class="comment">    address space.</span>
01487 <span class="comment"></span>
01488 <span class="comment">Arguments:</span>
01489 <span class="comment"></span>
01490 <span class="comment">    SectionPointer - Supplies the section object for the image.</span>
01491 <span class="comment"></span>
01492 <span class="comment">    ImageBaseAddress - Returns the address that the image header is at.</span>
01493 <span class="comment"></span>
01494 <span class="comment">    ImageFileName - Supplies the full path name (including the image name)</span>
01495 <span class="comment">                    of the image to load.</span>
01496 <span class="comment"></span>
01497 <span class="comment">    LoadInSessionSpace - Supplies whether to load this image in session space.</span>
01498 <span class="comment">                         Each session gets a different copy of this driver with</span>
01499 <span class="comment">                         pages shared as much as possible via copy on write.</span>
01500 <span class="comment"></span>
01501 <span class="comment">Return Value:</span>
01502 <span class="comment"></span>
01503 <span class="comment">    Status of the operation.</span>
01504 <span class="comment"></span>
01505 <span class="comment">--*/</span>
01506 
01507 {
01508     PFN_NUMBER PagesRequired;
01509     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
01510     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte;
01511     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
01512     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01513     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01514     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess;
01515     ULONG NumberOfPtes;
01516     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
01517     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01518     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01519     PFN_NUMBER PageFrameIndex;
01520     KIRQL OldIrql;
01521     PVOID UserVa;
01522     PVOID SystemVa;
01523     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01524     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ExceptionStatus;
01525     PVOID Base;
01526     ULONG_PTR ViewSize;
01527     LARGE_INTEGER SectionOffset;
01528     BOOLEAN LoadSymbols;
01529     PVOID BaseAddress;
01530     PFN_NUMBER CommittedPages;
01531     SIZE_T SectionSize;
01532     BOOLEAN AlreadyLoaded;
01533     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
01534     LOGICAL ProcessReferenced;
01535     PLIST_ENTRY NextProcessEntry;
01536 
01537     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01538 
01539     PagesRequired = 0;
01540 
01541     <span class="comment">//</span>
01542     <span class="comment">// Calculate the number of pages required to load this image.</span>
01543     <span class="comment">//</span>
01544 
01545     ProtoPte = SectionPointer-&gt;Segment-&gt;PrototypePte;
01546     NumberOfPtes = SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes;
01547 
01548     <span class="keywordflow">while</span> (NumberOfPtes != 0) {
01549         PteContents = *ProtoPte;
01550 
01551         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) ||
01552             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection != <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>)) {
01553             PagesRequired += 1;
01554         }
01555         NumberOfPtes -= 1;
01556         ProtoPte += 1;
01557     }
01558 
01559     <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01560 
01561         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01562 
01563         SectionSize = (ULONG_PTR)SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01564 
01565         <span class="comment">//</span>
01566         <span class="comment">// Allocate a unique systemwide session space virtual address for</span>
01567         <span class="comment">// the driver.</span>
01568         <span class="comment">//</span>
01569 
01570         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a17">MiSessionWideReserveImageAddress</a> (ImageFileName,
01571                                                    SectionPointer,
01572                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
01573                                                    &amp;BaseAddress,
01574                                                    &amp;AlreadyLoaded);
01575 
01576         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01577 <span class="preprocessor">#if DBG</span>
01578 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
01579                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiLoadImageSection: Error 0x%x Allocating session space %p Bytes\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,SectionSize);
01580             }
01581 <span class="preprocessor">#endif</span>
01582 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01583         }
01584 
01585         <span class="comment">//</span>
01586         <span class="comment">// This is a request to load an existing driver.  This can</span>
01587         <span class="comment">// occur with printer drivers for example.</span>
01588         <span class="comment">//</span>
01589 
01590         <span class="keywordflow">if</span> (AlreadyLoaded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01591             *ImageBaseAddress = BaseAddress;
01592             <span class="keywordflow">return</span> STATUS_ALREADY_COMMITTED;
01593         }
01594 
01595 <span class="preprocessor">#if DBG</span>
01596 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
01597             <span class="keywordflow">if</span> (ImageFileName) {
01598                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiLoadImageSection: Image %wZ, BasedAddress 0x%p, SegmentBaseAddress 0x%p, Allocated Session BaseAddress 0x%p\n"</span>,
01599                     ImageFileName,
01600                     SectionPointer-&gt;Segment-&gt;BasedAddress,
01601                     SectionPointer-&gt;Segment-&gt;SegmentBaseAddress,
01602                     BaseAddress);
01603             }
01604             <span class="keywordflow">else</span> {
01605                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiLoadImageSection: Image &lt;NULL&gt; BasedAddress 0x%p, SegmentBaseAddress 0x%p, Allocated Session BaseAddress 0x%p\n"</span>,
01606                     SectionPointer-&gt;Segment-&gt;BasedAddress,
01607                     SectionPointer-&gt;Segment-&gt;SegmentBaseAddress,
01608                     BaseAddress);
01609             }
01610         }
01611 <span class="preprocessor">#endif</span>
01612 <span class="preprocessor"></span>
01613         <span class="keywordflow">if</span> (BaseAddress == SectionPointer-&gt;Segment-&gt;BasedAddress) {
01614 
01615             <span class="comment">//</span>
01616             <span class="comment">// We were able to load the image at its based address, so</span>
01617             <span class="comment">// map its image segments as backed directly by the file image.</span>
01618             <span class="comment">// All pristine pages of the image will be shared across all</span>
01619             <span class="comment">// sessions, with each page treated as copy-on-write on first write.</span>
01620             <span class="comment">//</span>
01621             <span class="comment">// NOTE: This makes the file image "busy", a different behavior</span>
01622             <span class="comment">// as normal kernel drivers are backed by the paging file only.</span>
01623             <span class="comment">//</span>
01624 
01625 <span class="preprocessor">#if DBG</span>
01626 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (SectionPointer-&gt;Segment-&gt;SystemImageBase != 0) {
01627                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (BaseAddress == SectionPointer-&gt;Segment-&gt;SystemImageBase);
01628             }
01629 <span class="preprocessor">#endif</span>
01630 <span class="preprocessor"></span>
01631             <span class="comment">//</span>
01632             <span class="comment">// Map the image into session space.</span>
01633             <span class="comment">//</span>
01634 
01635             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a11">MiShareSessionImage</a> (SectionPointer, &amp;SectionSize);
01636 
01637             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01638 <span class="preprocessor">#if DBG</span>
01639 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
01640                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiLoadImageSection: Error 0x%x Allocating session space %p Bytes\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, SectionSize);
01641                 }
01642 <span class="preprocessor">#endif</span>
01643 <span class="preprocessor"></span>                <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a> (BaseAddress);
01644                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01645             }
01646 
01647             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (BaseAddress == SectionPointer-&gt;Segment-&gt;BasedAddress);
01648 
01649             *ImageBaseAddress = BaseAddress;
01650 
01651             <span class="comment">//</span>
01652             <span class="comment">// Indicate that this section has been loaded into the system.</span>
01653             <span class="comment">//</span>
01654 
01655             SectionPointer-&gt;Segment-&gt;SystemImageBase = BaseAddress;
01656 
01657 <span class="preprocessor">#if DBG</span>
01658 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
01659                 <span class="keywordflow">if</span> (ImageFileName) {
01660                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiLoadImageSection: Mapped image %wZ at requested session address 0x%p\n"</span>,
01661                         ImageFileName,
01662                         BaseAddress);
01663                 }
01664                 <span class="keywordflow">else</span> {
01665                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiLoadImageSection: Mapped a session image at requested address 0x%p\n"</span>,
01666                         BaseAddress);
01667                 }
01668             }
01669 <span class="preprocessor">#endif</span>
01670 <span class="preprocessor"></span>
01671             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01672         }
01673 
01674         <span class="comment">//</span>
01675         <span class="comment">// The image could not be loaded at its based address.  It must be</span>
01676         <span class="comment">// copied to its new address using private page file backed pages.</span>
01677         <span class="comment">// Our caller will relocate the internal references and then bind the</span>
01678         <span class="comment">// image.  Allocate the pages and page tables for the image now.</span>
01679         <span class="comment">//</span>
01680 
01681         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/session_8c.html#a18">MiSessionCommitImagePages</a> (BaseAddress, SectionSize);
01682 
01683         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01684 <span class="preprocessor">#if DBG</span>
01685 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
01686                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiLoadImageSection: Error 0x%x Allocating session space %p Bytes\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, SectionSize);
01687             }
01688 <span class="preprocessor">#endif</span>
01689 <span class="preprocessor"></span>            <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a> (BaseAddress);
01690             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01691         }
01692         SystemVa = BaseAddress;
01693     }
01694     <span class="keywordflow">else</span> {
01695 
01696         <span class="comment">//</span>
01697         <span class="comment">// See if ample pages exist to load this image.</span>
01698         <span class="comment">//</span>
01699 
01700 <span class="preprocessor">#if DBG</span>
01701 <span class="preprocessor"></span>        MiPagesConsumed = PagesRequired;
01702 <span class="preprocessor">#endif</span>
01703 <span class="preprocessor"></span>
01704         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01705 
01706         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> &lt;= (SPFN_NUMBER)PagesRequired) {
01707             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01708             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01709         }
01710         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= PagesRequired;
01711         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(14, PagesRequired);
01712         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01713 
01714         <span class="comment">//</span>
01715         <span class="comment">// Reserve the necessary system address space.</span>
01716         <span class="comment">//</span>
01717 
01718         FirstPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes,
01719                                         <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>,
01720                                         0,
01721                                         0,
01722                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01723 
01724         <span class="keywordflow">if</span> (FirstPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01725             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01726             <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesRequired;
01727             <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(15, PagesRequired);
01728             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01729             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01730         }
01731         PointerPte = FirstPte;
01732         SystemVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01733     }
01734 
01735     <span class="comment">//</span>
01736     <span class="comment">// Map a view into the user portion of the address space.</span>
01737     <span class="comment">//</span>
01738 
01739     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01740 
01741     <span class="comment">//</span>
01742     <span class="comment">// Since callees are not always in the context of the system process,</span>
01743     <span class="comment">// attach here when necessary to guarantee the driver load occurs in a</span>
01744     <span class="comment">// known safe address space to prevent security holes.</span>
01745     <span class="comment">//</span>
01746 
01747     ProcessReferenced = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01748     TargetProcess = Process;
01749     <span class="keywordflow">if</span> (Process-&gt;Peb &amp;&amp; Process-&gt;Vm.u.Flags.SessionLeader == 0) {
01750         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01751             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a4">ExpDefaultErrorPortProcess</a> &amp;&amp; (Process != <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a4">ExpDefaultErrorPortProcess</a>)) {
01752                 TargetProcess = <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a4">ExpDefaultErrorPortProcess</a>;
01753                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;TargetProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
01754             }
01755         }
01756         <span class="keywordflow">else</span> {
01757 
01758             SessionGlobal = <a class="code" href="../../d4/d8/mi_8h.html#a356">SESSION_GLOBAL</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
01759             <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01760             NextProcessEntry = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>.Flink;
01761 
01762             <span class="keywordflow">if</span> ((SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.DeletePending == 0) &amp;&amp;
01763                 (NextProcessEntry != &amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>)) {
01764 
01765                 TargetProcess = CONTAINING_RECORD (NextProcessEntry,
01766                                                    <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,
01767                                                    SessionProcessLinks);
01768 
01769                 <span class="keywordflow">if</span> (Process != TargetProcess) {
01770                     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a> (TargetProcess);
01771                     ProcessReferenced = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01772                 }
01773             }
01774             <span class="keywordflow">else</span> {
01775                 <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01776 
01777                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01778                 <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesRequired;
01779                 <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(15, PagesRequired);
01780                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01781 
01782                 CommittedPages = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (
01783                                           <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress),
01784                                           <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (SectionSize),
01785                                           <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>,
01786                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01787                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01788     
01789                 <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
01790                 <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= CommittedPages;
01791     
01792                 <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(<a class="code" href="../../d4/d8/mi_8h.html#a381">MM_DBG_SESSION_COMMIT_IMAGELOAD_FAILED1</a>,
01793                     CommittedPages);
01794     
01795                 <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
01796     
01797                 <span class="comment">//</span>
01798                 <span class="comment">// Return the commitment we took out on the pagefile when</span>
01799                 <span class="comment">// the page was allocated.  This is needed for collided images</span>
01800                 <span class="comment">// since all the pages get committed regardless of writability.</span>
01801                 <span class="comment">//</span>
01802     
01803                 <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a> (BaseAddress);
01804 
01805                 <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
01806             }
01807 
01808             <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01809 
01810             <span class="keywordflow">if</span> (Process != TargetProcess) {
01811                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;TargetProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
01812             }
01813         }
01814     }
01815 
01816     <a class="code" href="../../d4/d8/mi_8h.html#a166">ZERO_LARGE</a> (SectionOffset);
01817     Base = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01818     ViewSize = 0;
01819 
01820     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_KDEBUG_SYMBOL_LOAD) {
01821         LoadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01822         <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp;= ~FLG_ENABLE_KDEBUG_SYMBOL_LOAD;
01823     }
01824     <span class="keywordflow">else</span> {
01825         LoadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01826     }
01827 
01828     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a> ( SectionPointer,
01829                                   TargetProcess,
01830                                   &amp;Base,
01831                                   0,
01832                                   0,
01833                                   &amp;SectionOffset,
01834                                   &amp;ViewSize,
01835                                   ViewUnmap,
01836                                   0,
01837                                   PAGE_EXECUTE);
01838 
01839     <span class="keywordflow">if</span> (LoadSymbols) {
01840         <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> |= FLG_ENABLE_KDEBUG_SYMBOL_LOAD;
01841     }
01842 
01843     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_IMAGE_MACHINE_TYPE_MISMATCH) {
01844         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_IMAGE_FORMAT;
01845     }
01846 
01847     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01848         <span class="keywordflow">if</span> (TargetProcess != Process) {
01849             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01850             <span class="keywordflow">if</span> (ProcessReferenced == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01851                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (TargetProcess);
01852             }
01853         }
01854 
01855         <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01856 
01857 <span class="preprocessor">#if DBG</span>
01858 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
01859                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiLoadImageSection: Error 0x%x in session space mapping via MmMapViewOfSection\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01860             }
01861 <span class="preprocessor">#endif</span>
01862 <span class="preprocessor"></span>
01863             CommittedPages = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (
01864                                       <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress),
01865                                       <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (SectionSize),
01866                                       <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>,
01867                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01868                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01869 
01870             <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
01871             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= CommittedPages;
01872 
01873             <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(<a class="code" href="../../d4/d8/mi_8h.html#a381">MM_DBG_SESSION_COMMIT_IMAGELOAD_FAILED1</a>,
01874                 CommittedPages);
01875 
01876             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
01877 
01878             <span class="comment">//</span>
01879             <span class="comment">// Return the commitment we took out on the pagefile when</span>
01880             <span class="comment">// the page was allocated.  This is needed for collided images</span>
01881             <span class="comment">// since all the pages get committed regardless of writability.</span>
01882             <span class="comment">//</span>
01883 
01884             <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a> (BaseAddress);
01885         }
01886         <span class="keywordflow">else</span> {
01887             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01888             <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesRequired;
01889             <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(16, PagesRequired);
01890             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01891             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (FirstPte,
01892                                  SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes,
01893                                  <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>);
01894         }
01895 
01896         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01897     }
01898 
01899     <span class="comment">//</span>
01900     <span class="comment">// Allocate a physical page(s) and copy the image data.</span>
01901     <span class="comment">// Note Hydra has already allocated the physical pages and just does</span>
01902     <span class="comment">// data copying here.</span>
01903     <span class="comment">//</span>
01904 
01905     ProtoPte = SectionPointer-&gt;Segment-&gt;PrototypePte;
01906     NumberOfPtes = SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes;
01907 
01908     *ImageBaseAddress = SystemVa;
01909 
01910     UserVa = Base;
01911     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
01912 <span class="preprocessor">#if defined(_IA64_)</span>
01913 <span class="preprocessor"></span>    TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long |= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a84">MM_PTE_EXECUTE</a>;
01914 <span class="preprocessor">#endif</span>
01915 <span class="preprocessor"></span>
01916     <span class="keywordflow">while</span> (NumberOfPtes != 0) {
01917         PteContents = *ProtoPte;
01918         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) ||
01919             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection != <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>)) {
01920 
01921             <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01922                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01923                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01924                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
01925                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (PointerPte));
01926                 PointerPte-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>;
01927 <span class="preprocessor">#if defined(_IA64_)</span>
01928 <span class="preprocessor"></span>
01929                 <span class="comment">//</span>
01930                 <span class="comment">// EM needs execute permission.</span>
01931                 <span class="comment">//</span>
01932 
01933                 PointerPte-&gt;u.Soft.Protection |= <a class="code" href="../../d4/d8/mi_8h.html#a37">MM_EXECUTE</a>;
01934 
01935 <span class="preprocessor">#endif</span>
01936 <span class="preprocessor"></span>                <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
01937 
01938                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01939                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
01940                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01941                 LastPte = PointerPte;
01942 
01943                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex)-&gt;u1.WsIndex == 0);
01944             }
01945 
01946             <span class="keywordflow">try</span> {
01947 
01948                 RtlMoveMemory (SystemVa, UserVa, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01949 
01950             } except (<a class="code" href="../../d1/d5/mapcache_8c.html#a8">MiMapCacheExceptionFilter</a> (&amp;ExceptionStatus,
01951                                                  GetExceptionInformation())) {
01952 
01953                 <span class="comment">//</span>
01954                 <span class="comment">// An exception occurred, unmap the view and</span>
01955                 <span class="comment">// return the error to the caller.</span>
01956                 <span class="comment">//</span>
01957 
01958 <span class="preprocessor">#if DBG</span>
01959 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiLoadImageSection: Exception 0x%x copying driver SystemVa 0x%p, UserVa 0x%p\n"</span>,ExceptionStatus,SystemVa,UserVa);
01960 <span class="preprocessor">#endif</span>
01961 <span class="preprocessor"></span>
01962                 <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01963                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01964                     CommittedPages = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (
01965                                               <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress),
01966                                               <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (SectionSize),
01967                                               <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>,
01968                                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01969                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01970 
01971                     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
01972                     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= CommittedPages;
01973 
01974                     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(<a class="code" href="../../d4/d8/mi_8h.html#a382">MM_DBG_SESSION_COMMIT_IMAGELOAD_FAILED2</a>,
01975                         CommittedPages);
01976 
01977                     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
01978 
01979                     <span class="comment">//</span>
01980                     <span class="comment">// Return the commitment we took out on the pagefile when</span>
01981                     <span class="comment">// the page was allocated.  This is needed for collided</span>
01982                     <span class="comment">// images since all the pages get committed regardless</span>
01983                     <span class="comment">// of writability.</span>
01984                     <span class="comment">//</span>
01985 
01986                     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (CommittedPages);
01987                     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a317">MM_DBG_COMMIT_RETURN_SESSION_DRIVER_LOAD_FAILURE1</a>, CommittedPages);
01988                 }
01989                 <span class="keywordflow">else</span> {
01990                     ProtoPte = FirstPte;
01991                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01992                     <span class="keywordflow">while</span> (ProtoPte &lt;= PointerPte) {
01993                         <span class="keywordflow">if</span> (ProtoPte-&gt;u.Hard.Valid == 1) {
01994 
01995                             <span class="comment">//</span>
01996                             <span class="comment">// Delete the page.</span>
01997                             <span class="comment">//</span>
01998 
01999                             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (ProtoPte);
02000 
02001                             <span class="comment">//</span>
02002                             <span class="comment">// Set the pointer to PTE as empty so the page</span>
02003                             <span class="comment">// is deleted when the reference count goes to zero.</span>
02004                             <span class="comment">//</span>
02005 
02006                             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02007                             <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
02008                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
02009                             <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
02010 
02011                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (ProtoPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
02012                         }
02013                         ProtoPte += 1;
02014                     }
02015 
02016                     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesRequired;
02017                     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(17, PagesRequired);
02018                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02019                     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (FirstPte,
02020                                          SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes,
02021                                          <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>);
02022                 }
02023 
02024                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a> (TargetProcess, Base);
02025 
02026                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02027 
02028                 <span class="keywordflow">if</span> (TargetProcess != Process) {
02029                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02030                     <span class="keywordflow">if</span> (ProcessReferenced == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02031                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (TargetProcess);
02032                     }
02033                 }
02034 
02035                 <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02036                     <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a> (BaseAddress);
02037                 }
02038 
02039                 <span class="keywordflow">return</span> ExceptionStatus;
02040             }
02041 
02042         }
02043         <span class="keywordflow">else</span> {
02044 
02045             <span class="comment">//</span>
02046             <span class="comment">// The PTE is no access - if this driver is being loaded in session</span>
02047             <span class="comment">// space we already preloaded the page so free it now.  The</span>
02048             <span class="comment">// commitment is returned when the whole image is unmapped.</span>
02049             <span class="comment">//</span>
02050 
02051             <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02052                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02053                 CommittedPages = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (
02054                                           <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (SystemVa),
02055                                           1,
02056                                           <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>,
02057                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02058                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02059 
02060                 <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(<a class="code" href="../../d4/d8/mi_8h.html#a383">MM_DBG_SESSION_COMMIT_IMAGELOAD_NOACCESS</a>,
02061                     1);
02062             }
02063             <span class="keywordflow">else</span> {
02064                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
02065             }
02066         }
02067 
02068         NumberOfPtes -= 1;
02069         ProtoPte += 1;
02070         PointerPte += 1;
02071         SystemVa = ((PCHAR)SystemVa + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02072         UserVa = ((PCHAR)UserVa + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02073     }
02074 
02075     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a> (TargetProcess, Base);
02076     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02077 
02078     <span class="keywordflow">if</span> (TargetProcess != Process) {
02079         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02080         <span class="keywordflow">if</span> (ProcessReferenced == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02081             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (TargetProcess);
02082         }
02083     }
02084 
02085     <span class="comment">//</span>
02086     <span class="comment">// Indicate that this section has been loaded into the system.</span>
02087     <span class="comment">//</span>
02088 
02089     SectionPointer-&gt;Segment-&gt;SystemImageBase = *ImageBaseAddress;
02090 
02091     <span class="comment">//</span>
02092     <span class="comment">// Charge commitment for the number of pages that were used by</span>
02093     <span class="comment">// the driver.</span>
02094     <span class="comment">//</span>
02095 
02096     <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02097         <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (PagesRequired, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02098         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a281">MM_DBG_COMMIT_DRIVER_PAGES</a>, PagesRequired);
02099         <a class="code" href="../../d8/d5/kddata_8c.html#a32">MmDriverCommit</a> += (ULONG)PagesRequired;
02100     }
02101 
02102     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02103 }
02104 
02105 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02106"></a><a class="code" href="../../d8/d8/sysload_8c.html#a55">02106</a> <a class="code" href="../../d8/d8/sysload_8c.html#a55">MmFreeDriverInitialization</a> (
02107     IN PVOID ImageHandle
02108     )
02109 
02110 <span class="comment">/*++</span>
02111 <span class="comment"></span>
02112 <span class="comment">Routine Description:</span>
02113 <span class="comment"></span>
02114 <span class="comment">    This routine removes the pages that relocate and debug information from</span>
02115 <span class="comment">    the address space of the driver.</span>
02116 <span class="comment"></span>
02117 <span class="comment">    NOTE:  This routine looks at the last sections defined in the image</span>
02118 <span class="comment">           header and if that section is marked as DISCARDABLE in the</span>
02119 <span class="comment">           characteristics, it is removed from the image.  This means</span>
02120 <span class="comment">           that all discardable sections at the end of the driver are</span>
02121 <span class="comment">           deleted.</span>
02122 <span class="comment"></span>
02123 <span class="comment">Arguments:</span>
02124 <span class="comment"></span>
02125 <span class="comment">    SectionObject - Supplies the section object for the image.</span>
02126 <span class="comment"></span>
02127 <span class="comment">Return Value:</span>
02128 <span class="comment"></span>
02129 <span class="comment">    None.</span>
02130 <span class="comment"></span>
02131 <span class="comment">--*/</span>
02132 
02133 {
02134     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02135     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02136     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02137     PFN_NUMBER NumberOfPtes;
02138     PVOID Base;
02139     ULONG i;
02140     PIMAGE_NT_HEADERS NtHeaders;
02141     PIMAGE_SECTION_HEADER NtSection;
02142     PIMAGE_SECTION_HEADER FoundSection;
02143     PFN_NUMBER PagesDeleted;
02144 
02145     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
02146     DataTableEntry = (PLDR_DATA_TABLE_ENTRY)ImageHandle;
02147     Base = DataTableEntry-&gt;DllBase;
02148 
02149     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (Base) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02150 
02151     NumberOfPtes = DataTableEntry-&gt;SizeOfImage &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
02152     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Base) + NumberOfPtes;
02153 
02154     NtHeaders = (PIMAGE_NT_HEADERS)<a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
02155 
02156     NtSection = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeaders +
02157                         <span class="keyword">sizeof</span>(ULONG) +
02158                         <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
02159                         NtHeaders-&gt;FileHeader.SizeOfOptionalHeader
02160                         );
02161 
02162     NtSection += NtHeaders-&gt;FileHeader.NumberOfSections;
02163 
02164     FoundSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02165     <span class="keywordflow">for</span> (i = 0; i &lt; NtHeaders-&gt;FileHeader.NumberOfSections; i += 1) {
02166         NtSection -= 1;
02167         <span class="keywordflow">if</span> ((NtSection-&gt;Characteristics &amp; IMAGE_SCN_MEM_DISCARDABLE) != 0) {
02168             FoundSection = NtSection;
02169         } <span class="keywordflow">else</span> {
02170 
02171             <span class="comment">//</span>
02172             <span class="comment">// There was a non discardable section between the this</span>
02173             <span class="comment">// section and the last non discardable section, don't</span>
02174             <span class="comment">// discard this section and don't look any more.</span>
02175             <span class="comment">//</span>
02176 
02177             <span class="keywordflow">break</span>;
02178         }
02179     }
02180 
02181     <span class="keywordflow">if</span> (FoundSection != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02182 
02183         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (
02184                                     (PCHAR)Base + FoundSection-&gt;VirtualAddress));
02185         NumberOfPtes = (PFN_NUMBER)(LastPte - PointerPte);
02186 
02187         PagesDeleted = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (PointerPte,
02188                                                 NumberOfPtes,
02189                                                 <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>,
02190                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02191                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02192 
02193         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesDeleted;
02194         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(18, PagesDeleted);
02195         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (PagesDeleted);
02196         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a318">MM_DBG_COMMIT_RETURN_DRIVER_INIT_CODE</a>, PagesDeleted);
02197         <a class="code" href="../../d8/d5/kddata_8c.html#a32">MmDriverCommit</a> -= (ULONG)PagesDeleted;
02198 <span class="preprocessor">#if DBG</span>
02199 <span class="preprocessor"></span>        MiPagesConsumed -= PagesDeleted;
02200 <span class="preprocessor">#endif</span>
02201 <span class="preprocessor"></span>    }
02202 
02203     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
02204     <span class="keywordflow">return</span>;
02205 }
02206 
02207 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02208"></a><a class="code" href="../../d8/d8/sysload_8c.html#a34">02208</a> <a class="code" href="../../d8/d8/sysload_8c.html#a34">MiEnablePagingOfDriver</a> (
02209     IN PVOID ImageHandle
02210     )
02211 
02212 {
02213     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02214     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02215     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02216     PVOID Base;
02217     ULONG i;
02218     PIMAGE_NT_HEADERS NtHeaders;
02219     PIMAGE_SECTION_HEADER FoundSection;
02220     PIMAGE_OPTIONAL_HEADER OptionalHeader;
02221 
02222     <span class="comment">//</span>
02223     <span class="comment">// Don't page kernel mode code if customer does not want it paged.</span>
02224     <span class="comment">//</span>
02225 
02226     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a26">MmDisablePagingExecutive</a>) {
02227         <span class="keywordflow">return</span>;
02228     }
02229 
02230     <span class="comment">//</span>
02231     <span class="comment">// If the driver has pagable code, make it paged.</span>
02232     <span class="comment">//</span>
02233 
02234     DataTableEntry = (PLDR_DATA_TABLE_ENTRY)ImageHandle;
02235     Base = DataTableEntry-&gt;DllBase;
02236 
02237     NtHeaders = (PIMAGE_NT_HEADERS)<a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
02238 
02239     OptionalHeader = (PIMAGE_OPTIONAL_HEADER)((PCHAR)NtHeaders +
02240 <span class="preprocessor">#if defined (_WIN64)</span>
02241 <span class="preprocessor"></span>                        FIELD_OFFSET (IMAGE_NT_HEADERS64, OptionalHeader));
02242 <span class="preprocessor">#else</span>
02243 <span class="preprocessor"></span>                        FIELD_OFFSET (IMAGE_NT_HEADERS32, OptionalHeader));
02244 <span class="preprocessor">#endif</span>
02245 <span class="preprocessor"></span>
02246     FoundSection = IMAGE_FIRST_SECTION (NtHeaders);
02247 
02248     i = NtHeaders-&gt;FileHeader.NumberOfSections;
02249 
02250     PointerPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02251 
02252     <span class="keywordflow">while</span> (i &gt; 0) {
02253 <span class="preprocessor">#if DBG</span>
02254 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((*(PULONG)FoundSection-&gt;Name == 'tini') ||
02255                 (*(PULONG)FoundSection-&gt;Name == 'egap')) {
02256                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"driver %wZ has lower case sections (init or pagexxx)\n"</span>,
02257                     &amp;DataTableEntry-&gt;FullDllName);
02258             }
02259 <span class="preprocessor">#endif //DBG</span>
02260 <span class="preprocessor"></span>
02261         <span class="comment">//</span>
02262         <span class="comment">// Mark as pagable any section which starts with the</span>
02263         <span class="comment">// first 4 characters PAGE or .eda (for the .edata section).</span>
02264         <span class="comment">//</span>
02265 
02266         <span class="keywordflow">if</span> ((*(PULONG)FoundSection-&gt;Name == 'EGAP') ||
02267            (*(PULONG)FoundSection-&gt;Name == 'ade.')) {
02268 
02269             <span class="comment">//</span>
02270             <span class="comment">// This section is pagable, save away the start and end.</span>
02271             <span class="comment">//</span>
02272 
02273             <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02274 
02275                 <span class="comment">//</span>
02276                 <span class="comment">// Previous section was NOT pagable, get the start address.</span>
02277                 <span class="comment">//</span>
02278 
02279                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (
02280                                    (PCHAR)Base + FoundSection-&gt;VirtualAddress));
02281             }
02282             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PCHAR)Base +
02283                                        FoundSection-&gt;VirtualAddress +
02284                                        (OptionalHeader-&gt;SectionAlignment - 1) +
02285                                        FoundSection-&gt;SizeOfRawData - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02286 
02287         } <span class="keywordflow">else</span> {
02288 
02289             <span class="comment">//</span>
02290             <span class="comment">// This section is not pagable, if the previous section was</span>
02291             <span class="comment">// pagable, enable it.</span>
02292             <span class="comment">//</span>
02293 
02294             <span class="keywordflow">if</span> (PointerPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02295                 <a class="code" href="../../d8/d8/sysload_8c.html#a35">MiSetPagingOfDriver</a> (PointerPte, LastPte, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02296                 PointerPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02297             }
02298         }
02299         i -= 1;
02300         FoundSection += 1;
02301     }
02302     <span class="keywordflow">if</span> (PointerPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02303         <a class="code" href="../../d8/d8/sysload_8c.html#a35">MiSetPagingOfDriver</a> (PointerPte, LastPte, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02304     }
02305 }
02306 
02307 
02308 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02309"></a><a class="code" href="../../d8/d8/sysload_8c.html#a35">02309</a> <a class="code" href="../../d8/d8/sysload_8c.html#a35">MiSetPagingOfDriver</a> (
02310     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
02311     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte,
02312     IN BOOLEAN SessionSpace
02313     )
02314 
02315 <span class="comment">/*++</span>
02316 <span class="comment"></span>
02317 <span class="comment">Routine Description:</span>
02318 <span class="comment"></span>
02319 <span class="comment">    This routine marks the specified range of PTEs as pagable.</span>
02320 <span class="comment"></span>
02321 <span class="comment">Arguments:</span>
02322 <span class="comment"></span>
02323 <span class="comment">    PointerPte - Supplies the starting PTE.</span>
02324 <span class="comment"></span>
02325 <span class="comment">    LastPte - Supplies the ending PTE.</span>
02326 <span class="comment"></span>
02327 <span class="comment">Return Value:</span>
02328 <span class="comment"></span>
02329 <span class="comment">    None.</span>
02330 <span class="comment"></span>
02331 <span class="comment">--*/</span>
02332 
02333 {
02334     PVOID Base;
02335     PFN_NUMBER PageCount;
02336     PFN_NUMBER PageFrameIndex;
02337     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn;
02338     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02339     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
02340     KIRQL OldIrql1;
02341     KIRQL OldIrql;
02342 
02343     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02344 
02345     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
02346             (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
02347 
02348     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte))) {
02349 
02350         <span class="comment">//</span>
02351         <span class="comment">// No need to lock physical addresses.</span>
02352         <span class="comment">//</span>
02353 
02354         <span class="keywordflow">return</span>;
02355     }
02356 
02357     PageCount = 0;
02358 
02359     <span class="comment">//</span>
02360     <span class="comment">// Lock this routine into memory.</span>
02361     <span class="comment">//</span>
02362 
02363     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
02364 
02365     <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02366         <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql1);
02367     }
02368     <span class="keywordflow">else</span> {
02369         <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql1);
02370     }
02371 
02372     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02373 
02374     Base = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02375 
02376     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
02377 
02378         <span class="comment">//</span>
02379         <span class="comment">// Check to make sure this PTE has not already been</span>
02380         <span class="comment">// made pagable (or deleted).  It is pagable if it</span>
02381         <span class="comment">// is not valid, or if the PFN database wsindex element</span>
02382         <span class="comment">// is non zero.</span>
02383         <span class="comment">//</span>
02384 
02385         <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 1) {
02386             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
02387             Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02388             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
02389 
02390             <span class="keywordflow">if</span> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0) {
02391 
02392                 <span class="comment">//</span>
02393                 <span class="comment">// Original PTE may need to be set for drivers loaded</span>
02394                 <span class="comment">// via ntldr.</span>
02395                 <span class="comment">//</span>
02396     
02397                 <span class="keywordflow">if</span> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
02398                     Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>;
02399 <span class="preprocessor">#if defined(_IA64_)</span>
02400 <span class="preprocessor"></span>                    Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection |= <a class="code" href="../../d4/d8/mi_8h.html#a37">MM_EXECUTE</a>;
02401 <span class="preprocessor">#endif</span>
02402 <span class="preprocessor"></span>                }
02403     
02404                 TempPte = *PointerPte;
02405 
02406                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
02407                                            Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
02408 
02409                 PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush = <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (Base,
02410                                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02411                                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02412                                                        (PHARDWARE_PTE)PointerPte,
02413                                                        TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
02414 
02415                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (&amp;PreviousPte, Pfn);
02416 
02417                 <span class="comment">//</span>
02418                 <span class="comment">// Flush the translation buffer and decrement the number of valid</span>
02419                 <span class="comment">// PTEs within the containing page table page.  Note that for a</span>
02420                 <span class="comment">// private page, the page table page is still needed because the</span>
02421                 <span class="comment">// page is in transition.</span>
02422                 <span class="comment">//</span>
02423 
02424                 <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageFrameIndex);
02425                 <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += 1;
02426                 <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(19, 1);
02427                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a14">MmTotalSystemDriverPages</a> += 1;
02428                 PageCount += 1;
02429             }
02430             <span class="keywordflow">else</span> {
02431                 <span class="comment">//</span>
02432                 <span class="comment">// This page is already pagable and has a WSLE entry.</span>
02433                 <span class="comment">// Ignore it here and let the trimmer take it if memory</span>
02434                 <span class="comment">// comes under pressure.</span>
02435                 <span class="comment">//</span>
02436             }
02437         }
02438         Base = (PVOID)((PCHAR)Base + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02439         PointerPte += 1;
02440     }
02441 
02442     <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02443 
02444         <span class="comment">//</span>
02445         <span class="comment">// Session space has no ASN - flush the entire TB.</span>
02446         <span class="comment">//</span>
02447     
02448         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a200">MI_FLUSH_ENTIRE_SESSION_TB</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02449     }
02450 
02451     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02452 
02453     <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02454 
02455         <span class="comment">//</span>
02456         <span class="comment">// These pages are no longer locked down.</span>
02457         <span class="comment">//</span>
02458 
02459         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> -= PageCount;
02460         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(<a class="code" href="../../d4/d8/mi_8h.html#a374">MM_DBG_SESSION_DRIVER_PAGES_UNLOCKED</a>, PageCount);
02461 
02462         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql1);
02463     }
02464     <span class="keywordflow">else</span> {
02465         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql1);
02466     }
02467     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
02468 }
02469 
02470 
02471 PVOID
<a name="l02472"></a><a class="code" href="../../d8/d8/sysload_8c.html#a56">02472</a> <a class="code" href="../../d8/d8/sysload_8c.html#a56">MmPageEntireDriver</a> (
02473     IN PVOID AddressWithinSection
02474     )
02475 
02476 <span class="comment">/*++</span>
02477 <span class="comment"></span>
02478 <span class="comment">Routine Description:</span>
02479 <span class="comment"></span>
02480 <span class="comment">    This routine allows a driver to page out all of its code and</span>
02481 <span class="comment">    data regardless of the attributes of the various image sections.</span>
02482 <span class="comment"></span>
02483 <span class="comment">    Note, this routine can be called multiple times with no</span>
02484 <span class="comment">    intervening calls to MmResetDriverPaging.</span>
02485 <span class="comment"></span>
02486 <span class="comment">Arguments:</span>
02487 <span class="comment"></span>
02488 <span class="comment">    AddressWithinSection - Supplies an address within the driver, e.g.</span>
02489 <span class="comment">                           DriverEntry.</span>
02490 <span class="comment"></span>
02491 <span class="comment">Return Value:</span>
02492 <span class="comment"></span>
02493 <span class="comment">    Base address of driver.</span>
02494 <span class="comment"></span>
02495 <span class="comment">Environment:</span>
02496 <span class="comment"></span>
02497 <span class="comment">    Kernel mode, APC_LEVEL or below.</span>
02498 <span class="comment"></span>
02499 <span class="comment">--*/</span>
02500 
02501 {
02502     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02503     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte;
02504     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02505     PVOID BaseAddress;
02506     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> SectionPointer;
02507     BOOLEAN SessionSpace;
02508 
02509     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02510 
02511     <span class="comment">//</span>
02512     <span class="comment">// Don't page kernel mode code if disabled via registry.</span>
02513     <span class="comment">//</span>
02514 
02515     DataTableEntry = <a class="code" href="../../d4/d8/mi_8h.html#a874">MiLookupDataTableEntry</a> (AddressWithinSection, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02516 
02517     <span class="keywordflow">if</span> (DataTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02518         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02519     }
02520 
02521     SectionPointer = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)DataTableEntry-&gt;SectionPointer;
02522 
02523     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a26">MmDisablePagingExecutive</a>) {
02524         <span class="keywordflow">return</span> DataTableEntry-&gt;DllBase;
02525     }
02526 
02527     SessionSpace = <a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (AddressWithinSection);
02528 
02529     <span class="keywordflow">if</span> ((SectionPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (SectionPointer != (PVOID)-1)) {
02530 
02531         <span class="comment">//</span>
02532         <span class="comment">// Driver is mapped as an image (ie: win32k), this is always pagable.</span>
02533         <span class="comment">// For session space, an image that has been loaded at its desired</span>
02534         <span class="comment">// address is also always pagable.  If there was an address collision,</span>
02535         <span class="comment">// then we fall through because we have to explicitly page it.</span>
02536         <span class="comment">//</span>
02537 
02538         <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02539             <span class="keywordflow">if</span> (SectionPointer-&gt;Segment &amp;&amp;
02540                 SectionPointer-&gt;Segment-&gt;BasedAddress == SectionPointer-&gt;Segment-&gt;SystemImageBase) {
02541                 <span class="keywordflow">return</span> DataTableEntry-&gt;DllBase;
02542             }
02543         }
02544         <span class="keywordflow">else</span> {
02545             <span class="keywordflow">return</span> DataTableEntry-&gt;DllBase;
02546         }
02547     }
02548 
02549     BaseAddress = DataTableEntry-&gt;DllBase;
02550     FirstPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
02551     LastPte = (FirstPte - 1) + (DataTableEntry-&gt;SizeOfImage &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02552 
02553     <a class="code" href="../../d8/d8/sysload_8c.html#a35">MiSetPagingOfDriver</a> (FirstPte, LastPte, SessionSpace);
02554 
02555     <span class="keywordflow">return</span> BaseAddress;
02556 }
02557 
02558 
02559 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02560"></a><a class="code" href="../../d8/d8/sysload_8c.html#a57">02560</a> <a class="code" href="../../d8/d8/sysload_8c.html#a57">MmResetDriverPaging</a> (
02561     IN PVOID AddressWithinSection
02562     )
02563 
02564 <span class="comment">/*++</span>
02565 <span class="comment"></span>
02566 <span class="comment">Routine Description:</span>
02567 <span class="comment"></span>
02568 <span class="comment">    This routines resets the driver paging to what the image specified.</span>
02569 <span class="comment">    Hence image sections such as the IAT, .text, .data will be locked</span>
02570 <span class="comment">    down in memory.</span>
02571 <span class="comment"></span>
02572 <span class="comment">    Note, there is no requirement that MmPageEntireDriver was called.</span>
02573 <span class="comment"></span>
02574 <span class="comment">Arguments:</span>
02575 <span class="comment"></span>
02576 <span class="comment">     AddressWithinSection - Supplies an address within the driver, e.g.</span>
02577 <span class="comment">                            DriverEntry.</span>
02578 <span class="comment"></span>
02579 <span class="comment">Return Value:</span>
02580 <span class="comment"></span>
02581 <span class="comment">    None.</span>
02582 <span class="comment"></span>
02583 <span class="comment">Environment:</span>
02584 <span class="comment"></span>
02585 <span class="comment">    Kernel mode, APC_LEVEL or below.</span>
02586 <span class="comment"></span>
02587 <span class="comment">--*/</span>
02588 
02589 {
02590     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02591     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02592     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02593     PVOID Base;
02594     ULONG i;
02595     PIMAGE_NT_HEADERS NtHeaders;
02596     PIMAGE_SECTION_HEADER FoundSection;
02597     KIRQL OldIrql;
02598     KIRQL OldIrqlWs;
02599 
02600     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02601 
02602     <span class="comment">//</span>
02603     <span class="comment">// Don't page kernel mode code if disabled via registry.</span>
02604     <span class="comment">//</span>
02605 
02606     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a26">MmDisablePagingExecutive</a>) {
02607         <span class="keywordflow">return</span>;
02608     }
02609 
02610     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(AddressWithinSection)) {
02611         <span class="keywordflow">return</span>;
02612     }
02613 
02614     <span class="comment">//</span>
02615     <span class="comment">// If the driver has pagable code, make it paged.</span>
02616     <span class="comment">//</span>
02617 
02618     DataTableEntry = <a class="code" href="../../d4/d8/mi_8h.html#a874">MiLookupDataTableEntry</a> (AddressWithinSection, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02619 
02620     <span class="keywordflow">if</span> ((DataTableEntry-&gt;SectionPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02621         (DataTableEntry-&gt;SectionPointer != (PVOID)-1)) {
02622 
02623         <span class="comment">//</span>
02624         <span class="comment">// Driver is mapped by image hence already paged.</span>
02625         <span class="comment">//</span>
02626 
02627         <span class="keywordflow">return</span>;
02628     }
02629 
02630     Base = DataTableEntry-&gt;DllBase;
02631 
02632     NtHeaders = (PIMAGE_NT_HEADERS)<a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
02633 
02634     FoundSection = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeaders +
02635                         <span class="keyword">sizeof</span>(ULONG) +
02636                         <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
02637                         NtHeaders-&gt;FileHeader.SizeOfOptionalHeader
02638                         );
02639 
02640     i = NtHeaders-&gt;FileHeader.NumberOfSections;
02641     PointerPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02642 
02643     <span class="keywordflow">while</span> (i &gt; 0) {
02644 <span class="preprocessor">#if DBG</span>
02645 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((*(PULONG)FoundSection-&gt;Name == 'tini') ||
02646                 (*(PULONG)FoundSection-&gt;Name == 'egap')) {
02647                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"driver %wZ has lower case sections (init or pagexxx)\n"</span>,
02648                     &amp;DataTableEntry-&gt;FullDllName);
02649             }
02650 <span class="preprocessor">#endif</span>
02651 <span class="preprocessor"></span>
02652         <span class="comment">//</span>
02653         <span class="comment">// Don't lock down code for sections marked as discardable or</span>
02654         <span class="comment">// sections marked with the first 4 characters PAGE or .eda</span>
02655         <span class="comment">// (for the .edata section) or INIT.</span>
02656         <span class="comment">//</span>
02657 
02658         <span class="keywordflow">if</span> (((FoundSection-&gt;Characteristics &amp; IMAGE_SCN_MEM_DISCARDABLE) != 0) ||
02659            (*(PULONG)FoundSection-&gt;Name == 'EGAP') ||
02660            (*(PULONG)FoundSection-&gt;Name == 'ade.') ||
02661            (*(PULONG)FoundSection-&gt;Name == 'TINI')) {
02662 
02663             NOTHING;
02664 
02665         } <span class="keywordflow">else</span> {
02666 
02667             <span class="comment">//</span>
02668             <span class="comment">// This section is nonpagable.</span>
02669             <span class="comment">//</span>
02670 
02671             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
02672                                    (PCHAR)Base + FoundSection-&gt;VirtualAddress);
02673             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PCHAR)Base +
02674                                        FoundSection-&gt;VirtualAddress +
02675                                       (FoundSection-&gt;SizeOfRawData - 1));
02676             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte &lt;= LastPte);
02677             <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
02678             <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrqlWs);
02679             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02680             <a class="code" href="../../d4/d8/mi_8h.html#a873">MiLockCode</a> (PointerPte, LastPte, <a class="code" href="../../d4/d8/mi_8h.html#a30">MM_LOCK_BY_NONPAGE</a>);
02681             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02682             <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrqlWs);
02683             <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
02684         }
02685         i -= 1;
02686         FoundSection += 1;
02687     }
02688     <span class="keywordflow">return</span>;
02689 }
02690 
02691 
02692 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02693"></a><a class="code" href="../../d8/d8/sysload_8c.html#a37">02693</a> <a class="code" href="../../d8/d8/sysload_8c.html#a37">MiClearImports</a>(
02694     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
02695     )
02696 <span class="comment">/*++</span>
02697 <span class="comment"></span>
02698 <span class="comment">Routine Description:</span>
02699 <span class="comment"></span>
02700 <span class="comment">    Free up the import list and clear the pointer.  This stops the</span>
02701 <span class="comment">    recursion performed in MiDereferenceImports().</span>
02702 <span class="comment"></span>
02703 <span class="comment">Arguments:</span>
02704 <span class="comment"></span>
02705 <span class="comment">    DataTableEntry - provided for the driver.</span>
02706 <span class="comment"></span>
02707 <span class="comment">Return Value:</span>
02708 <span class="comment"></span>
02709 <span class="comment">    Status of the import list construction operation.</span>
02710 <span class="comment"></span>
02711 <span class="comment">--*/</span>
02712 
02713 {
02714     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02715 
02716     <span class="keywordflow">if</span> (DataTableEntry-&gt;LoadedImports == (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>) {
02717         <span class="keywordflow">return</span>;
02718     }
02719 
02720     <span class="keywordflow">if</span> (DataTableEntry-&gt;LoadedImports == (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>) {
02721         NOTHING;
02722     }
02723     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a2">SINGLE_ENTRY</a>(DataTableEntry-&gt;LoadedImports)) {
02724         NOTHING;
02725     }
02726     <span class="keywordflow">else</span> {
02727         <span class="comment">//</span>
02728         <span class="comment">// free the memory</span>
02729         <span class="comment">//</span>
02730         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ((PVOID)DataTableEntry-&gt;LoadedImports);
02731     }
02732 
02733     <span class="comment">//</span>
02734     <span class="comment">// stop the recursion</span>
02735     <span class="comment">//</span>
02736     DataTableEntry-&gt;LoadedImports = (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>;
02737 }
02738 
02739 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02740"></a><a class="code" href="../../d8/d8/sysload_8c.html#a46">02740</a> <a class="code" href="../../d8/d8/sysload_8c.html#a46">MiRememberUnloadedDriver</a> (
02741     IN PUNICODE_STRING DriverName,
02742     IN PVOID Address,
02743     IN ULONG Length
02744     )
02745 
02746 <span class="comment">/*++</span>
02747 <span class="comment"></span>
02748 <span class="comment">Routine Description:</span>
02749 <span class="comment"></span>
02750 <span class="comment">    This routine saves information about unloaded drivers so that ones that</span>
02751 <span class="comment">    forget to delete lookaside lists or queues can be caught.</span>
02752 <span class="comment"></span>
02753 <span class="comment">Arguments:</span>
02754 <span class="comment"></span>
02755 <span class="comment">    DriverName - Supplies a Unicode string containing the driver's name.</span>
02756 <span class="comment"></span>
02757 <span class="comment">    Address - Supplies the address the driver was loaded at.</span>
02758 <span class="comment"></span>
02759 <span class="comment">    Length - Supplies the number of bytes the driver load spanned.</span>
02760 <span class="comment"></span>
02761 <span class="comment">Return Value:</span>
02762 <span class="comment"></span>
02763 <span class="comment">    None.</span>
02764 <span class="comment"></span>
02765 <span class="comment">--*/</span>
02766 
02767 {
02768     <a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">PUNLOADED_DRIVERS</a> Entry;
02769     ULONG NumberOfBytes;
02770 
02771     <span class="keywordflow">if</span> (DriverName-&gt;Length == 0) {
02772 
02773         <span class="comment">//</span>
02774         <span class="comment">// This is an aborted load and the driver name hasn't been filled</span>
02775         <span class="comment">// in yet.  No need to save it.</span>
02776         <span class="comment">//</span>
02777 
02778         <span class="keywordflow">return</span>;
02779     }
02780 
02781     <span class="comment">//</span>
02782     <span class="comment">// Serialization is provided by the caller, so just update the list now.</span>
02783     <span class="comment">// Note the allocations are nonpaged so they can be searched at bugcheck</span>
02784     <span class="comment">// time.</span>
02785     <span class="comment">//</span>
02786 
02787     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02788         NumberOfBytes = <a class="code" href="../../d4/d8/mi_8h.html#a240">MI_UNLOADED_DRIVERS</a> * <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">UNLOADED_DRIVERS</a>);
02789 
02790         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a> = (<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">PUNLOADED_DRIVERS</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02791                                                                       NumberOfBytes,
02792                                                                       'TDmM');
02793         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02794             <span class="keywordflow">return</span>;
02795         }
02796         RtlZeroMemory (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a>, NumberOfBytes);
02797         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a47">MiLastUnloadedDriver</a> = 0;
02798     }
02799     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a47">MiLastUnloadedDriver</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a240">MI_UNLOADED_DRIVERS</a>) {
02800         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a47">MiLastUnloadedDriver</a> = 0;
02801     }
02802 
02803     Entry = &amp;<a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a>[<a class="code" href="../../d9/d5/4_2kddata_8c.html#a47">MiLastUnloadedDriver</a>];
02804 
02805     <span class="comment">//</span>
02806     <span class="comment">// Free the old entry as we recycle into the new.</span>
02807     <span class="comment">//</span>
02808 
02809     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a> (&amp;Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>);
02810 
02811     Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02812                                                 DriverName-&gt;Length,
02813                                                 'TDmM');
02814 
02815     <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02816         Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.MaximumLength = 0;
02817         Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.Length = 0;
02818         <a class="code" href="../../d8/d8/sysload_8c.html#a15">MiUnloadsSkipped</a> += 1;
02819         <span class="keywordflow">return</span>;
02820     }
02821 
02822     RtlMoveMemory(Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.Buffer, DriverName-&gt;Buffer, DriverName-&gt;Length);
02823     Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.Length = DriverName-&gt;Length;
02824     Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.MaximumLength = DriverName-&gt;MaximumLength;
02825 
02826     Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o1">StartAddress</a> = Address;
02827     Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o2">EndAddress</a> = (PVOID)((PCHAR)Address + Length);
02828 
02829     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o3">CurrentTime</a>);
02830 
02831     <a class="code" href="../../d8/d8/sysload_8c.html#a14">MiTotalUnloads</a> += 1;
02832     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a47">MiLastUnloadedDriver</a> += 1;
02833 }
02834 
02835 PUNICODE_STRING
<a name="l02836"></a><a class="code" href="../../d8/d8/sysload_8c.html#a58">02836</a> <a class="code" href="../../d8/d8/sysload_8c.html#a58">MmLocateUnloadedDriver</a> (
02837     IN PVOID VirtualAddress
02838     )
02839 
02840 <span class="comment">/*++</span>
02841 <span class="comment"></span>
02842 <span class="comment">Routine Description:</span>
02843 <span class="comment"></span>
02844 <span class="comment">    This routine attempts to find the specified virtual address in the</span>
02845 <span class="comment">    unloaded driver list.</span>
02846 <span class="comment"></span>
02847 <span class="comment">Arguments:</span>
02848 <span class="comment"></span>
02849 <span class="comment">    VirtualAddress - Supplies a virtual address that might be within a driver</span>
02850 <span class="comment">                     that has already unloaded.</span>
02851 <span class="comment"></span>
02852 <span class="comment">Return Value:</span>
02853 <span class="comment"></span>
02854 <span class="comment">    A pointer to a Unicode string containing the unloaded driver's name.</span>
02855 <span class="comment"></span>
02856 <span class="comment">Environment:</span>
02857 <span class="comment"></span>
02858 <span class="comment">    Kernel mode, bugcheck time.</span>
02859 <span class="comment"></span>
02860 <span class="comment">--*/</span>
02861 
02862 {
02863     <a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">PUNLOADED_DRIVERS</a> Entry;
02864     ULONG i;
02865     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02866 
02867     <span class="comment">//</span>
02868     <span class="comment">// No serialization is needed because we've crashed.</span>
02869     <span class="comment">//</span>
02870 
02871     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02872         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02873     }
02874 
02875     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a47">MiLastUnloadedDriver</a> - 1;
02876 
02877     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d8/mi_8h.html#a240">MI_UNLOADED_DRIVERS</a>; i += 1) {
02878         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a240">MI_UNLOADED_DRIVERS</a>) {
02879             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a240">MI_UNLOADED_DRIVERS</a> - 1;
02880         }
02881         Entry = &amp;<a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
02882         <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02883             <span class="keywordflow">if</span> ((VirtualAddress &gt;= Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o1">StartAddress</a>) &amp;&amp;
02884                 (VirtualAddress &lt; Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o2">EndAddress</a>)) {
02885                     <span class="keywordflow">return</span> &amp;Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>;
02886             }
02887         }
02888         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> -= 1;
02889     }
02890 
02891     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02892 }
02893 
02894 
02895 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02896"></a><a class="code" href="../../d8/d8/sysload_8c.html#a59">02896</a> <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a> (
02897     IN PVOID ImageHandle
02898     )
02899 
02900 <span class="comment">/*++</span>
02901 <span class="comment"></span>
02902 <span class="comment">Routine Description:</span>
02903 <span class="comment"></span>
02904 <span class="comment">    This routine unloads a previously loaded system image and returns</span>
02905 <span class="comment">    the allocated resources.</span>
02906 <span class="comment"></span>
02907 <span class="comment">Arguments:</span>
02908 <span class="comment"></span>
02909 <span class="comment">    ImageHandle - Supplies a pointer to the section object of the</span>
02910 <span class="comment">                  image to unload.</span>
02911 <span class="comment"></span>
02912 <span class="comment">Return Value:</span>
02913 <span class="comment"></span>
02914 <span class="comment">    Various NTSTATUS codes.</span>
02915 <span class="comment"></span>
02916 <span class="comment">--*/</span>
02917 
02918 {
02919     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02920     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02921     PFN_NUMBER PagesRequired;
02922     PFN_NUMBER ResidentPages;
02923     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02924     PFN_NUMBER NumberOfPtes;
02925     KIRQL OldIrql;
02926     PVOID BasedAddress;
02927     SIZE_T NumberOfBytes;
02928     BOOLEAN MustFree;
02929     SIZE_T CommittedPages;
02930     BOOLEAN ViewDeleted;
02931     <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> DriverImage;
02932     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02933     PVOID StillQueued;
02934     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> SectionPointer;
02935 
02936     <span class="comment">//</span>
02937     <span class="comment">// Arbitrary process context so prevent suspend APCs now.</span>
02938     <span class="comment">//</span>
02939 
02940     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02941 
02942     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>,
02943                            <a class="code" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>,
02944                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02945                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02946                            (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02947 
02948     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
02949 
02950     ViewDeleted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02951     DataTableEntry = (PLDR_DATA_TABLE_ENTRY)ImageHandle;
02952     BasedAddress = DataTableEntry-&gt;DllBase;
02953 
02954 <span class="preprocessor">#if DBGXX</span>
02955 <span class="preprocessor"></span>    <span class="comment">//</span>
02956     <span class="comment">// MiUnloadSystemImageByForce violates this check so remove it for now.</span>
02957     <span class="comment">//</span>
02958 
02959     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink) {
02960         LOGICAL Found;
02961         PLIST_ENTRY NextEntry;
02962         PLDR_DATA_TABLE_ENTRY DataTableEntry2;
02963 
02964         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02965         NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
02966         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
02967     
02968             DataTableEntry2 = CONTAINING_RECORD(NextEntry,
02969                                                 LDR_DATA_TABLE_ENTRY,
02970                                                 InLoadOrderLinks);
02971             <span class="keywordflow">if</span> (DataTableEntry == DataTableEntry2) {
02972                 Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02973                 <span class="keywordflow">break</span>;
02974             }
02975             NextEntry = NextEntry-&gt;Flink;
02976         }
02977         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Found == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02978     }
02979 <span class="preprocessor">#endif</span>
02980 <span class="preprocessor"></span>
02981 <span class="preprocessor">#if DBG_SYSLOAD</span>
02982 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (DataTableEntry-&gt;SectionPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02983         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: Called to unload boot driver %wZ\n"</span>,
02984             &amp;DataTableEntry-&gt;FullDllName);
02985     }
02986     <span class="keywordflow">else</span> {
02987         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: Called to unload non-boot driver %wZ\n"</span>,
02988             &amp;DataTableEntry-&gt;FullDllName);
02989     }
02990 <span class="preprocessor">#endif</span>
02991 <span class="preprocessor"></span>
02992     <span class="comment">//</span>
02993     <span class="comment">// Any driver loaded at boot that did not have its import list</span>
02994     <span class="comment">// and LoadCount reconstructed cannot be unloaded because we don't</span>
02995     <span class="comment">// know how many other drivers may be linked to it.</span>
02996     <span class="comment">//</span>
02997 
02998     <span class="keywordflow">if</span> (DataTableEntry-&gt;LoadedImports == (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>) {
02999         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03000         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03001         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03002         <span class="keywordflow">return</span> STATUS_SUCCESS;
03003     }
03004 
03005     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry-&gt;LoadCount != 0);
03006 
03007     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (BasedAddress)) {
03008 
03009         <span class="comment">//</span>
03010         <span class="comment">// A printer driver may be referenced multiple times for the</span>
03011         <span class="comment">// same session space.  Only unload the last reference.</span>
03012         <span class="comment">//</span>
03013 
03014         DriverImage = <a class="code" href="../../d4/d7/sessload_8c.html#a13">MiSessionLookupImage</a> (BasedAddress);
03015 
03016         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DriverImage);
03017 
03018         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DriverImage-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o3">ImageCountInThisSession</a>);
03019 
03020         <span class="keywordflow">if</span> (DriverImage-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o3">ImageCountInThisSession</a> &gt; 1) {
03021 
03022             DriverImage-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o3">ImageCountInThisSession</a> -= 1;
03023             <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03024             <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03025             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03026 
03027             <span class="keywordflow">return</span> STATUS_SUCCESS;
03028         }
03029 
03030         <span class="comment">//</span>
03031         <span class="comment">// The reference count for this image has dropped to zero in this</span>
03032         <span class="comment">// session, so we can delete this session's view of the image.</span>
03033         <span class="comment">//</span>
03034 
03035         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a16">MiSessionWideGetImageSize</a> (BasedAddress,
03036                                             &amp;NumberOfBytes,
03037                                             &amp;CommittedPages);
03038 
03039         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03040 
03041             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
03042                           0x41286,
03043                           (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
03044                           (ULONG_PTR)BasedAddress,
03045                           0);
03046         }
03047 
03048         <span class="comment">//</span>
03049         <span class="comment">// Free the session space taken up by the image, unmapping it from</span>
03050         <span class="comment">// the current VA space - note this does not remove page table pages</span>
03051         <span class="comment">// from the session PageTables[].  Each data page is only freed</span>
03052         <span class="comment">// if there are no other references to it (ie: from any other</span>
03053         <span class="comment">// sessions).</span>
03054         <span class="comment">//</span>
03055 
03056         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BasedAddress);
03057         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((ULONG_PTR)BasedAddress + NumberOfBytes);
03058 
03059         PagesRequired = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (PointerPte,
03060                                                  (PFN_NUMBER)(LastPte - PointerPte),
03061                                                  <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>,
03062                                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03063                                                  &amp;ResidentPages);
03064 
03065         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a26">MmDisablePagingExecutive</a> == 0) {
03066 
03067             SectionPointer = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)DataTableEntry-&gt;SectionPointer;
03068         
03069             <span class="keywordflow">if</span> ((SectionPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
03070                 (SectionPointer == (PVOID)-1) ||
03071                 (SectionPointer-&gt;Segment == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
03072                 (SectionPointer-&gt;Segment-&gt;BasedAddress != SectionPointer-&gt;Segment-&gt;SystemImageBase)) {
03073 
03074                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a14">MmTotalSystemDriverPages</a> -= (ULONG)(PagesRequired - ResidentPages);
03075             }
03076         }
03077 
03078         <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
03079         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= CommittedPages;
03080 
03081         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(<a class="code" href="../../d4/d8/mi_8h.html#a380">MM_DBG_SESSION_COMMIT_IMAGE_UNLOAD</a>,
03082             CommittedPages);
03083 
03084         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
03085 
03086         ViewDeleted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03087 
03088         <span class="comment">//</span>
03089         <span class="comment">// Return the commitment we took out on the pagefile when the</span>
03090         <span class="comment">// image was allocated.</span>
03091         <span class="comment">//</span>
03092 
03093         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (CommittedPages);
03094         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a319">MM_DBG_COMMIT_RETURN_DRIVER_UNLOAD</a>, CommittedPages);
03095 
03096         <span class="comment">//</span>
03097         <span class="comment">// Tell the session space image handler that we are releasing</span>
03098         <span class="comment">// our claim to the image.</span>
03099         <span class="comment">//</span>
03100 
03101         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a> (BasedAddress);
03102 
03103         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03104     }
03105 
03106     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry-&gt;LoadCount != 0);
03107 
03108     DataTableEntry-&gt;LoadCount -= 1;
03109 
03110     <span class="keywordflow">if</span> (DataTableEntry-&gt;LoadCount != 0) {
03111         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03112         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03113         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03114         <span class="keywordflow">return</span> STATUS_SUCCESS;
03115     }
03116 
03117 <span class="preprocessor">#if DBG</span>
03118 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (BasedAddress)) {
03119         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a992">MiSessionLookupImage</a> (BasedAddress) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03120     }
03121 <span class="preprocessor">#endif</span>
03122 <span class="preprocessor"></span>
03123     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a32">MmSnapUnloads</a>) {
03124 <span class="preprocessor">#if 0</span>
03125 <span class="preprocessor"></span>        StillQueued = <a class="code" href="../../d3/d2/timerobj_8c.html#a9">KeCheckForTimer</a> (DataTableEntry-&gt;DllBase,
03126                                        DataTableEntry-&gt;SizeOfImage);
03127 
03128         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03129             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03130                           0x18,
03131                           (ULONG_PTR)StillQueued,
03132                           (ULONG_PTR)-1,
03133                           (ULONG_PTR)DataTableEntry-&gt;DllBase);
03134         }
03135 
03136         StillQueued = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a34">ExpCheckForResource</a> (DataTableEntry-&gt;DllBase,
03137                                            DataTableEntry-&gt;SizeOfImage);
03138 
03139         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03140             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03141                           0x19,
03142                           (ULONG_PTR)StillQueued,
03143                           (ULONG_PTR)-1,
03144                           (ULONG_PTR)DataTableEntry-&gt;DllBase);
03145         }
03146 <span class="preprocessor">#endif</span>
03147 <span class="preprocessor"></span>    }
03148 
03149     <span class="keywordflow">if</span> (DataTableEntry-&gt;Flags &amp; LDRP_IMAGE_VERIFYING) {
03150         <a class="code" href="../../d9/d5/verifier_8c.html#a111">MiVerifyingDriverUnloading</a> (DataTableEntry);
03151     }
03152 
03153     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a554">MiActiveVerifierThunks</a> != 0) {
03154         <a class="code" href="../../d9/d5/verifier_8c.html#a106">MiVerifierCheckThunks</a> (DataTableEntry);
03155     }
03156 
03157     <span class="comment">//</span>
03158     <span class="comment">// Unload symbols from debugger.</span>
03159     <span class="comment">//</span>
03160 
03161     <span class="keywordflow">if</span> (DataTableEntry-&gt;Flags &amp; LDRP_DEBUG_SYMBOLS_LOADED) {
03162 
03163         <span class="comment">//</span>
03164         <span class="comment">//  TEMP TEMP TEMP rip out when debugger converted</span>
03165         <span class="comment">//</span>
03166 
03167         ANSI_STRING AnsiName;
03168         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03169 
03170         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;AnsiName,
03171                                                &amp;DataTableEntry-&gt;BaseDllName,
03172                                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03173 
03174         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03175             DbgUnLoadImageSymbols( &amp;AnsiName,
03176                                    BasedAddress,
03177                                    (ULONG)-1);
03178             <a class="code" href="../../d6/d6/nls_8c.html#a35">RtlFreeAnsiString</a>( &amp;AnsiName );
03179         }
03180     }
03181 
03182     <span class="comment">//</span>
03183     <span class="comment">// No unload can happen till after Mm has finished Phase 1 initialization.</span>
03184     <span class="comment">// Therefore, large pages are already in effect (if this platform supports</span>
03185     <span class="comment">// it).</span>
03186     <span class="comment">//</span>
03187 
03188     <span class="keywordflow">if</span> (ViewDeleted == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03189 
03190         NumberOfPtes = DataTableEntry-&gt;SizeOfImage &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03191 
03192         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a32">MmSnapUnloads</a>) {
03193             <a class="code" href="../../d8/d8/sysload_8c.html#a46">MiRememberUnloadedDriver</a> (&amp;DataTableEntry-&gt;BaseDllName,
03194                                       BasedAddress,
03195                                       (ULONG)(NumberOfPtes &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
03196         }
03197 
03198         <span class="keywordflow">if</span> (DataTableEntry-&gt;Flags &amp; LDRP_SYSTEM_MAPPED) {
03199 
03200             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BasedAddress);
03201 
03202             PagesRequired = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (PointerPte,
03203                                                      NumberOfPtes,
03204                                                      <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>,
03205                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03206                                                      &amp;ResidentPages);
03207     
03208             <a class="code" href="../../d6/d8/sysinfo_8c.html#a14">MmTotalSystemDriverPages</a> -= (ULONG)(PagesRequired - ResidentPages);
03209 
03210             <span class="comment">//</span>
03211             <span class="comment">// Note that drivers loaded at boot that have not been relocated</span>
03212             <span class="comment">// have no system PTEs or commit charged.</span>
03213             <span class="comment">//</span>
03214     
03215             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
03216                                  (ULONG)NumberOfPtes,
03217                                  <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>);
03218 
03219             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03220             <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += ResidentPages;
03221             <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(21, ResidentPages);
03222             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03223 
03224             <span class="comment">//</span>
03225             <span class="comment">// Only return commitment for drivers that weren't loaded by the</span>
03226             <span class="comment">// boot loader.</span>
03227             <span class="comment">//</span>
03228     
03229             <span class="keywordflow">if</span> (DataTableEntry-&gt;SectionPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03230                 <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (PagesRequired);
03231                 <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a320">MM_DBG_COMMIT_RETURN_DRIVER_UNLOAD1</a>, PagesRequired);
03232                 <a class="code" href="../../d8/d5/kddata_8c.html#a32">MmDriverCommit</a> -= (ULONG)PagesRequired;
03233             }
03234         }
03235         <span class="keywordflow">else</span> {
03236 
03237             <span class="comment">//</span>
03238             <span class="comment">// This must be a boot driver that was not relocated into</span>
03239             <span class="comment">// system PTEs.  If large or super pages are enabled, the</span>
03240             <span class="comment">// image pages must be freed without referencing the</span>
03241             <span class="comment">// non-existent page table pages.  If large/super pages are</span>
03242             <span class="comment">// not enabled, note that system PTEs were not used to map the</span>
03243             <span class="comment">// image and thus, cannot be freed.</span>
03244 
03245             <span class="comment">//</span>
03246             <span class="comment">// This is further complicated by the fact that the INIT and/or</span>
03247             <span class="comment">// discardable portions of these images may have already been freed.</span>
03248             <span class="comment">//</span>
03249         }
03250     }
03251 
03252     <span class="comment">//</span>
03253     <span class="comment">// Search the loaded module list for the data table entry that describes</span>
03254     <span class="comment">// the DLL that was just unloaded. It is possible an entry is not in the</span>
03255     <span class="comment">// list if a failure occurred at a point in loading the DLL just before</span>
03256     <span class="comment">// the data table entry was generated.</span>
03257     <span class="comment">//</span>
03258 
03259     <span class="keywordflow">if</span> (DataTableEntry-&gt;InLoadOrderLinks.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03260         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
03261         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03262 
03263         ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a18">PsLoadedModuleSpinLock</a>, &amp;OldIrql);
03264 
03265         RemoveEntryList(&amp;DataTableEntry-&gt;InLoadOrderLinks);
03266         ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a18">PsLoadedModuleSpinLock</a>, OldIrql);
03267 
03268         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>);
03269         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03270 
03271         MustFree = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03272     }
03273     <span class="keywordflow">else</span> {
03274         MustFree = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03275     }
03276 
03277     <span class="comment">//</span>
03278     <span class="comment">// Handle unloading of any dependent DLLs that we loaded automatically</span>
03279     <span class="comment">// for this image.</span>
03280     <span class="comment">//</span>
03281 
03282     <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> ((<a class="code" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a>)DataTableEntry-&gt;LoadedImports);
03283 
03284     <a class="code" href="../../d8/d8/sysload_8c.html#a37">MiClearImports</a> (DataTableEntry);
03285 
03286     <span class="comment">//</span>
03287     <span class="comment">// Free this loader entry.</span>
03288     <span class="comment">//</span>
03289 
03290     <span class="keywordflow">if</span> (MustFree == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03291 
03292         <span class="keywordflow">if</span> (DataTableEntry-&gt;FullDllName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03293             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DataTableEntry-&gt;FullDllName.Buffer);
03294         }
03295 
03296         <span class="keywordflow">if</span> (DataTableEntry-&gt;BaseDllName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03297             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DataTableEntry-&gt;BaseDllName.Buffer);
03298         }
03299 
03300         <span class="comment">//</span>
03301         <span class="comment">// Dereference the section object if there is one.</span>
03302         <span class="comment">// There should only be one for win32k.sys and Hydra session images.</span>
03303         <span class="comment">//</span>
03304 
03305         <span class="keywordflow">if</span> ((DataTableEntry-&gt;SectionPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03306             (DataTableEntry-&gt;SectionPointer != (PVOID)-1)) {
03307 
03308             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (DataTableEntry-&gt;SectionPointer);
03309         }
03310 
03311         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)DataTableEntry);
03312     }
03313 
03314     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03315 
03316     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03317     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03318 
03319     <a class="code" href="../../d2/d1/mm_8h.html#a63">PERFINFO_IMAGE_UNLOAD</a>(BasedAddress);
03320 
03321     <span class="keywordflow">return</span> STATUS_SUCCESS;
03322 }
03323 
03324 
03325 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03326"></a><a class="code" href="../../d8/d8/sysload_8c.html#a38">03326</a> <a class="code" href="../../d8/d8/sysload_8c.html#a38">MiBuildImportsForBootDrivers</a>(
03327     VOID
03328     )
03329 
03330 <span class="comment">/*++</span>
03331 <span class="comment"></span>
03332 <span class="comment">Routine Description:</span>
03333 <span class="comment"></span>
03334 <span class="comment">    Construct an import list chain for boot-loaded drivers.</span>
03335 <span class="comment">    If this cannot be done for an entry, its chain is set to LOADED_AT_BOOT.</span>
03336 <span class="comment"></span>
03337 <span class="comment">    If a chain can be successfully built, then this driver's DLLs</span>
03338 <span class="comment">    will be automatically unloaded if this driver goes away (provided</span>
03339 <span class="comment">    no other driver is also using them).  Otherwise, on driver unload,</span>
03340 <span class="comment">    its dependent DLLs would have to be explicitly unloaded.</span>
03341 <span class="comment"></span>
03342 <span class="comment">    Note that the incoming LoadCount values are not correct and thus, they</span>
03343 <span class="comment">    are reinitialized here.</span>
03344 <span class="comment"></span>
03345 <span class="comment">Arguments:</span>
03346 <span class="comment"></span>
03347 <span class="comment">    None.</span>
03348 <span class="comment"></span>
03349 <span class="comment">Return Value:</span>
03350 <span class="comment"></span>
03351 <span class="comment">    Various NTSTATUS codes.</span>
03352 <span class="comment"></span>
03353 <span class="comment">--*/</span>
03354 
03355 {
03356     PLDR_DATA_TABLE_ENTRY DataTableEntry;
03357     PLIST_ENTRY NextEntry;
03358     PLDR_DATA_TABLE_ENTRY DataTableEntry2;
03359     PLIST_ENTRY NextEntry2;
03360     ULONG i;
03361     ULONG j;
03362     ULONG ImageCount;
03363     PVOID *ImageReferences;
03364     PVOID LastImageReference;
03365     PULONG_PTR ImportThunk;
03366     ULONG_PTR BaseAddress;
03367     ULONG_PTR LastAddress;
03368     ULONG ImportSize;
03369     ULONG ImportListSize;
03370     <a class="code" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a> ImportList;
03371     LOGICAL UndoEverything;
03372     PLDR_DATA_TABLE_ENTRY KernelDataTableEntry;
03373     PLDR_DATA_TABLE_ENTRY HalDataTableEntry;
03374     UNICODE_STRING KernelString;
03375     UNICODE_STRING HalString;
03376 
03377     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03378 
03379     ImageCount = 0;
03380 
03381     KernelDataTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03382     HalDataTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03383 
03384     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;KernelString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ntoskrnl.exe"</span>);
03385     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;HalString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"hal.dll"</span>);
03386 
03387     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
03388     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
03389 
03390         DataTableEntry = CONTAINING_RECORD(NextEntry,
03391                                            LDR_DATA_TABLE_ENTRY,
03392                                            InLoadOrderLinks);
03393 
03394         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;KernelString,
03395                                    &amp;DataTableEntry-&gt;BaseDllName,
03396                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03397 
03398             KernelDataTableEntry = CONTAINING_RECORD(NextEntry,
03399                                                      LDR_DATA_TABLE_ENTRY,
03400                                                      InLoadOrderLinks);
03401         }
03402         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;HalString,
03403                                         &amp;DataTableEntry-&gt;BaseDllName,
03404                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03405 
03406             HalDataTableEntry = CONTAINING_RECORD(NextEntry,
03407                                                   LDR_DATA_TABLE_ENTRY,
03408                                                   InLoadOrderLinks);
03409         }
03410 
03411         <span class="comment">//</span>
03412         <span class="comment">// Initialize these properly so error recovery is simplified.</span>
03413         <span class="comment">//</span>
03414 
03415         DataTableEntry-&gt;LoadCount = 1;
03416         DataTableEntry-&gt;LoadedImports = (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>;
03417 
03418         ImageCount += 1;
03419         NextEntry = NextEntry-&gt;Flink;
03420     }
03421 
03422     <span class="keywordflow">if</span> (KernelDataTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || HalDataTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03423         <span class="keywordflow">return</span> STATUS_NOT_FOUND;
03424     }
03425 
03426     ImageReferences = (PVOID *) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03427                                                        ImageCount * <span class="keyword">sizeof</span> (PVOID),
03428                                                        'TDmM');
03429 
03430     <span class="keywordflow">if</span> (ImageReferences == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03431         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03432     }
03433 
03434     UndoEverything = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03435 
03436     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
03437 
03438     <span class="keywordflow">for</span> ( ; NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>; NextEntry = NextEntry-&gt;Flink) {
03439 
03440         DataTableEntry = CONTAINING_RECORD(NextEntry,
03441                                            LDR_DATA_TABLE_ENTRY,
03442                                            InLoadOrderLinks);
03443 
03444         ImportThunk = (PULONG_PTR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
03445                                            DataTableEntry-&gt;DllBase,
03446                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03447                                            IMAGE_DIRECTORY_ENTRY_IAT,
03448                                            &amp;ImportSize);
03449     
03450         <span class="keywordflow">if</span> (ImportThunk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03451             DataTableEntry-&gt;LoadedImports = <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>;
03452             <span class="keywordflow">continue</span>;
03453         }
03454     
03455         RtlZeroMemory (ImageReferences, ImageCount * <span class="keyword">sizeof</span> (PVOID));
03456 
03457         ImportSize /= <span class="keyword">sizeof</span>(PULONG_PTR);
03458 
03459         BaseAddress = 0;
03460         <span class="keywordflow">for</span> (i = 0; i &lt; ImportSize; i += 1, ImportThunk += 1) {
03461 
03462             <span class="comment">//</span>
03463             <span class="comment">// Check the hint first.</span>
03464             <span class="comment">//</span>
03465 
03466             <span class="keywordflow">if</span> (BaseAddress) {
03467                 <span class="keywordflow">if</span> (*ImportThunk &gt;= BaseAddress &amp;&amp; *ImportThunk &lt; LastAddress) {
03468                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ImageReferences[j]);
03469                     <span class="keywordflow">continue</span>;
03470                 }
03471             }
03472 
03473             j = 0;
03474             NextEntry2 = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
03475 
03476             <span class="keywordflow">while</span> (NextEntry2 != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
03477 
03478                 DataTableEntry2 = CONTAINING_RECORD(NextEntry2,
03479                                                     LDR_DATA_TABLE_ENTRY,
03480                                                     InLoadOrderLinks);
03481     
03482                 BaseAddress = (ULONG_PTR) DataTableEntry2-&gt;DllBase;
03483                 LastAddress = BaseAddress + DataTableEntry2-&gt;SizeOfImage;
03484 
03485                 <span class="keywordflow">if</span> (*ImportThunk &gt;= BaseAddress &amp;&amp; *ImportThunk &lt; LastAddress) {
03486                     ImageReferences[j] = DataTableEntry2;
03487                     <span class="keywordflow">break</span>;
03488                 }
03489 
03490                 NextEntry2 = NextEntry2-&gt;Flink;
03491                 j += 1;
03492             }
03493 
03494             <span class="keywordflow">if</span> (*ImportThunk &lt; BaseAddress || *ImportThunk &gt;= LastAddress) {
03495                 <span class="keywordflow">if</span> (*ImportThunk) {
03496 <span class="preprocessor">#if DBG</span>
03497 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: broken import linkage %p %p %p\n"</span>,
03498                         DataTableEntry,
03499                         ImportThunk,
03500                         *ImportThunk);
03501                     DbgBreakPoint ();
03502 <span class="preprocessor">#endif</span>
03503 <span class="preprocessor"></span>                    UndoEverything = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03504                     <span class="keywordflow">goto</span> finished;
03505                 }
03506 
03507                 BaseAddress = 0;
03508             }
03509         }
03510 
03511         ImportSize = 0;
03512 
03513         <span class="keywordflow">for</span> (i = 0; i &lt; ImageCount; i += 1) {
03514 
03515             <span class="keywordflow">if</span> ((ImageReferences[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03516                 (ImageReferences[i] != KernelDataTableEntry) &amp;&amp;
03517                 (ImageReferences[i] != HalDataTableEntry)) {
03518 
03519                     LastImageReference = ImageReferences[i];
03520                     ImportSize += 1;
03521             }
03522         }
03523 
03524         <span class="keywordflow">if</span> (ImportSize == 0) {
03525             DataTableEntry-&gt;LoadedImports = <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>;
03526         }
03527         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ImportSize == 1) {
03528 <span class="preprocessor">#if DBG_SYSLOAD</span>
03529 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"driver %wZ imports %wZ\n"</span>,
03530                 &amp;DataTableEntry-&gt;FullDllName,
03531                 &amp;((PLDR_DATA_TABLE_ENTRY)LastImageReference)-&gt;FullDllName);
03532 <span class="preprocessor">#endif</span>
03533 <span class="preprocessor"></span>
03534             DataTableEntry-&gt;LoadedImports = <a class="code" href="../../d8/d8/sysload_8c.html#a4">POINTER_TO_SINGLE_ENTRY</a> (LastImageReference);
03535             ((PLDR_DATA_TABLE_ENTRY)LastImageReference)-&gt;LoadCount += 1;
03536         }
03537         <span class="keywordflow">else</span> {
03538 <span class="preprocessor">#if DBG_SYSLOAD</span>
03539 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"driver %wZ imports many\n"</span>, &amp;DataTableEntry-&gt;FullDllName);
03540 <span class="preprocessor">#endif</span>
03541 <span class="preprocessor"></span>
03542             ImportListSize = ImportSize * <span class="keyword">sizeof</span>(PVOID) + <span class="keyword">sizeof</span>(SIZE_T);
03543 
03544             ImportList = (<a class="code" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03545                                                                 ImportListSize,
03546                                                                 'TDmM');
03547 
03548             <span class="keywordflow">if</span> (ImportList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03549                 UndoEverything = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03550                 <span class="keywordflow">break</span>;
03551             }
03552 
03553             ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a> = ImportSize;
03554 
03555             j = 0;
03556             <span class="keywordflow">for</span> (i = 0; i &lt; ImageCount; i += 1) {
03557     
03558                 <span class="keywordflow">if</span> ((ImageReferences[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03559                     (ImageReferences[i] != KernelDataTableEntry) &amp;&amp;
03560                     (ImageReferences[i] != HalDataTableEntry)) {
03561     
03562 <span class="preprocessor">#if DBG_SYSLOAD</span>
03563 <span class="preprocessor"></span>                        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"driver %wZ imports %wZ\n"</span>,
03564                             &amp;DataTableEntry-&gt;FullDllName,
03565                             &amp;((PLDR_DATA_TABLE_ENTRY)ImageReferences[i])-&gt;FullDllName);
03566 <span class="preprocessor">#endif</span>
03567 <span class="preprocessor"></span>
03568                         ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[j] = ImageReferences[i];
03569                         ((PLDR_DATA_TABLE_ENTRY)ImageReferences[i])-&gt;LoadCount += 1;
03570                         j += 1;
03571                 }
03572             }
03573 
03574             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (j == ImportSize);
03575 
03576             DataTableEntry-&gt;LoadedImports = ImportList;
03577         }
03578 <span class="preprocessor">#if DBG_SYSLOAD</span>
03579 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
03580 <span class="preprocessor">#endif</span>
03581 <span class="preprocessor"></span>    }
03582 
03583 finished:
03584 
03585     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ((PVOID)ImageReferences);
03586 
03587     <span class="comment">//</span>
03588     <span class="comment">// The kernel and HAL are never unloaded.</span>
03589     <span class="comment">//</span>
03590 
03591     <span class="keywordflow">if</span> ((KernelDataTableEntry-&gt;LoadedImports != <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>) &amp;&amp;
03592         (!<a class="code" href="../../d8/d8/sysload_8c.html#a4">POINTER_TO_SINGLE_ENTRY</a>(KernelDataTableEntry-&gt;LoadedImports))) {
03593             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ((PVOID)KernelDataTableEntry-&gt;LoadedImports);
03594     }
03595 
03596     <span class="keywordflow">if</span> ((HalDataTableEntry-&gt;LoadedImports != <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>) &amp;&amp;
03597         (!<a class="code" href="../../d8/d8/sysload_8c.html#a4">POINTER_TO_SINGLE_ENTRY</a>(HalDataTableEntry-&gt;LoadedImports))) {
03598             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ((PVOID)HalDataTableEntry-&gt;LoadedImports);
03599     }
03600 
03601     KernelDataTableEntry-&gt;LoadedImports = (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>;
03602     HalDataTableEntry-&gt;LoadedImports = (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>;
03603 
03604     <span class="keywordflow">if</span> (UndoEverything == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03605 
03606 <span class="preprocessor">#if DBG_SYSLOAD</span>
03607 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"driver %wZ import rebuild failed\n"</span>,
03608             &amp;DataTableEntry-&gt;FullDllName);
03609         DbgBreakPoint();
03610 <span class="preprocessor">#endif</span>
03611 <span class="preprocessor"></span>
03612         <span class="comment">//</span>
03613         <span class="comment">// An error occurred and this is an all or nothing operation so</span>
03614         <span class="comment">// roll everything back.</span>
03615         <span class="comment">//</span>
03616     
03617         NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
03618         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
03619             DataTableEntry = CONTAINING_RECORD(NextEntry,
03620                                                LDR_DATA_TABLE_ENTRY,
03621                                                InLoadOrderLinks);
03622 
03623             ImportList = DataTableEntry-&gt;LoadedImports;
03624             <span class="keywordflow">if</span> (ImportList == <a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a> || ImportList == <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a> ||
03625                 <a class="code" href="../../d8/d8/sysload_8c.html#a2">SINGLE_ENTRY</a>(ImportList)) {
03626                     NOTHING;
03627             }
03628             <span class="keywordflow">else</span> {
03629                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
03630             }
03631 
03632             DataTableEntry-&gt;LoadedImports = (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>;
03633             DataTableEntry-&gt;LoadCount = 1;
03634             NextEntry = NextEntry-&gt;Flink;
03635         }
03636 
03637         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03638     }
03639 
03640     <span class="keywordflow">return</span> STATUS_SUCCESS;
03641 }
03642 
03643 
03644 LOGICAL
<a name="l03645"></a><a class="code" href="../../d8/d8/sysload_8c.html#a43">03645</a> <a class="code" href="../../d8/d8/sysload_8c.html#a43">MiCallDllUnloadAndUnloadDll</a>(
03646     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
03647     )
03648 
03649 <span class="comment">/*++</span>
03650 <span class="comment"></span>
03651 <span class="comment">Routine Description:</span>
03652 <span class="comment"></span>
03653 <span class="comment">    All the references from other drivers to this DLL have been cleared.</span>
03654 <span class="comment">    The only remaining issue is that this DLL must support being unloaded.</span>
03655 <span class="comment">    This means having no outstanding DPCs, allocated pool, etc.</span>
03656 <span class="comment"></span>
03657 <span class="comment">    If the DLL has an unload routine that returns SUCCESS, then we clean</span>
03658 <span class="comment">    it up and free up its memory now.</span>
03659 <span class="comment"></span>
03660 <span class="comment">    Note this routine is NEVER called for drivers - only for DLLs that were</span>
03661 <span class="comment">    loaded due to import references from various drivers.</span>
03662 <span class="comment"></span>
03663 <span class="comment">Arguments:</span>
03664 <span class="comment"></span>
03665 <span class="comment">    DataTableEntry - provided for the DLL.</span>
03666 <span class="comment"></span>
03667 <span class="comment">Return Value:</span>
03668 <span class="comment"></span>
03669 <span class="comment">    None.</span>
03670 <span class="comment"></span>
03671 <span class="comment">--*/</span>
03672 
03673 {
03674     <a class="code" href="../../d2/d1/mm_8h.html#a158">PMM_DLL_UNLOAD</a> Func;
03675     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03676     LOGICAL Unloaded;
03677 
03678     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03679 
03680     Unloaded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03681 
03682     Func = <a class="code" href="../../d8/d8/sysload_8c.html#a44">MiLocateExportName</a> (DataTableEntry-&gt;DllBase, <span class="stringliteral">"DllUnload"</span>);
03683 
03684     <span class="keywordflow">if</span> (Func) {
03685 
03686         <span class="comment">//</span>
03687         <span class="comment">// The unload function was found in the DLL so unload it now.</span>
03688         <span class="comment">//</span>
03689 
03690         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Func();
03691 
03692         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03693 
03694             <span class="comment">//</span>
03695             <span class="comment">// Set up the reference count so the import DLL looks like a regular</span>
03696             <span class="comment">// driver image is being unloaded.</span>
03697             <span class="comment">//</span>
03698 
03699             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry-&gt;LoadCount == 0);
03700             DataTableEntry-&gt;LoadCount = 1;
03701 
03702             <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a> ((PVOID)DataTableEntry);
03703             Unloaded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03704         }
03705     }
03706 
03707     <span class="keywordflow">return</span> Unloaded;
03708 }
03709 
03710 
03711 PVOID
<a name="l03712"></a><a class="code" href="../../d8/d8/sysload_8c.html#a44">03712</a> <a class="code" href="../../d8/d8/sysload_8c.html#a44">MiLocateExportName</a> (
03713     IN PVOID DllBase,
03714     IN PCHAR FunctionName
03715     )
03716 
03717 <span class="comment">/*++</span>
03718 <span class="comment"></span>
03719 <span class="comment">Routine Description:</span>
03720 <span class="comment"></span>
03721 <span class="comment">    This function is invoked to locate a function name in an export directory.</span>
03722 <span class="comment"></span>
03723 <span class="comment">Arguments:</span>
03724 <span class="comment"></span>
03725 <span class="comment">    DllBase - Supplies the image base.</span>
03726 <span class="comment"></span>
03727 <span class="comment">    FunctionName - Supplies the the name to be located.</span>
03728 <span class="comment"></span>
03729 <span class="comment">Return Value:</span>
03730 <span class="comment"></span>
03731 <span class="comment">    The address of the located function or NULL.</span>
03732 <span class="comment"></span>
03733 <span class="comment">--*/</span>
03734 
03735 {
03736     PVOID Func = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03737     PULONG NameTableBase;
03738     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> NameOrdinalTableBase;
03739     PIMAGE_EXPORT_DIRECTORY ExportDirectory;
03740     PULONG Addr;
03741     ULONG ExportSize;
03742     ULONG Low;
03743     ULONG Middle;
03744     ULONG High;
03745     LONG Result;
03746     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> OrdinalNumber;
03747 
03748     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03749 
03750     <span class="comment">//</span>
03751     <span class="comment">// Locate the DLL's export directory.</span>
03752     <span class="comment">//</span>
03753 
03754     ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
03755                                 DllBase,
03756                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03757                                 IMAGE_DIRECTORY_ENTRY_EXPORT,
03758                                 &amp;ExportSize
03759                                 );
03760     <span class="keywordflow">if</span> (ExportDirectory) {
03761 
03762         NameTableBase =  (PULONG)((PCHAR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfNames);
03763         NameOrdinalTableBase = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)((PCHAR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfNameOrdinals);
03764 
03765         <span class="comment">//</span>
03766         <span class="comment">// Look in the export name table for the specified function name.</span>
03767         <span class="comment">//</span>
03768 
03769         Low = 0;
03770         High = ExportDirectory-&gt;NumberOfNames - 1;
03771 
03772         <span class="keywordflow">while</span> (High &gt;= Low &amp;&amp; (LONG)High &gt;= 0) {
03773 
03774             <span class="comment">//</span>
03775             <span class="comment">// Compute the next probe index and compare the export name entry</span>
03776             <span class="comment">// with the specified function name.</span>
03777             <span class="comment">//</span>
03778 
03779             Middle = (Low + High) &gt;&gt; 1;
03780             Result = strcmp(FunctionName,
03781                             (PCHAR)((PCHAR)DllBase + NameTableBase[Middle]));
03782 
03783             <span class="keywordflow">if</span> (Result &lt; 0) {
03784                 High = Middle - 1;
03785             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Result &gt; 0) {
03786                 Low = Middle + 1;
03787             } <span class="keywordflow">else</span> {
03788                 <span class="keywordflow">break</span>;
03789             }
03790         }
03791 
03792         <span class="comment">//</span>
03793         <span class="comment">// If the high index is less than the low index, then a matching table</span>
03794         <span class="comment">// entry was not found.  Otherwise, get the ordinal number from the</span>
03795         <span class="comment">// ordinal table and location the function address.</span>
03796         <span class="comment">//</span>
03797 
03798         <span class="keywordflow">if</span> ((LONG)High &gt;= (LONG)Low) {
03799 
03800             OrdinalNumber = NameOrdinalTableBase[Middle];
03801             Addr = (PULONG)((PCHAR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfFunctions);
03802             Func = (PVOID)((PCHAR)DllBase + Addr[OrdinalNumber]);
03803 
03804             <span class="comment">//</span>
03805             <span class="comment">// If the function address is w/in range of the export directory,</span>
03806             <span class="comment">// then the function is forwarded, which is not allowed, so ignore</span>
03807             <span class="comment">// it.</span>
03808             <span class="comment">//</span>
03809 
03810             <span class="keywordflow">if</span> ((ULONG_PTR)Func &gt; (ULONG_PTR)ExportDirectory &amp;&amp;
03811                 (ULONG_PTR)Func &lt; ((ULONG_PTR)ExportDirectory + ExportSize)) {
03812                 Func = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03813             }
03814         }
03815     }
03816 
03817     <span class="keywordflow">return</span> Func;
03818 }
03819 
03820 
03821 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03822"></a><a class="code" href="../../d8/d8/sysload_8c.html#a42">03822</a> <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (
03823     IN PLOAD_IMPORTS ImportList
03824     )
03825 
03826 <span class="comment">/*++</span>
03827 <span class="comment"></span>
03828 <span class="comment">Routine Description:</span>
03829 <span class="comment"></span>
03830 <span class="comment">    Decrement the reference count on each DLL specified in the image import</span>
03831 <span class="comment">    list.  If any DLL's reference count reaches zero, then free the DLL.</span>
03832 <span class="comment"></span>
03833 <span class="comment">    No locks may be held on entry as MmUnloadSystemImage may be called.</span>
03834 <span class="comment"></span>
03835 <span class="comment">    The parameter list is freed here as well.</span>
03836 <span class="comment"></span>
03837 <span class="comment">Arguments:</span>
03838 <span class="comment"></span>
03839 <span class="comment">    ImportList - Supplies the list of DLLs to dereference.</span>
03840 <span class="comment"></span>
03841 <span class="comment">Return Value:</span>
03842 <span class="comment"></span>
03843 <span class="comment">    Status of the dereference operation.</span>
03844 <span class="comment"></span>
03845 <span class="comment">--*/</span>
03846 
03847 {
03848     ULONG i;
03849     LOGICAL Unloaded;
03850     PVOID SavedImports;
03851     <a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">LOAD_IMPORTS</a> SingleTableEntry;
03852     PLDR_DATA_TABLE_ENTRY ImportTableEntry;
03853 
03854     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03855 
03856     <span class="keywordflow">if</span> (ImportList == <a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a> || ImportList == <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>) {
03857         <span class="keywordflow">return</span> STATUS_SUCCESS;
03858     }
03859 
03860     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a2">SINGLE_ENTRY</a>(ImportList)) {
03861         SingleTableEntry.<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a> = 1;
03862         SingleTableEntry.<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[0] = <a class="code" href="../../d8/d8/sysload_8c.html#a3">SINGLE_ENTRY_TO_POINTER</a>(ImportList);
03863         ImportList = &amp;SingleTableEntry;
03864     }
03865 
03866     <span class="keywordflow">for</span> (i = 0; i &lt; ImportList-&gt;Count &amp;&amp; ImportList-&gt;Entry[i]; i += 1) {
03867         ImportTableEntry = ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[i];
03868 
03869         <span class="keywordflow">if</span> (ImportTableEntry-&gt;LoadedImports == (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>) {
03870 
03871             <span class="comment">//</span>
03872             <span class="comment">// Skip this one - it was loaded by ntldr.</span>
03873             <span class="comment">//</span>
03874 
03875             <span class="keywordflow">continue</span>;
03876         }
03877 
03878 <span class="preprocessor">#if DBG</span>
03879 <span class="preprocessor"></span>        {
03880             ULONG ImageCount;
03881             PLIST_ENTRY NextEntry;
03882             PLDR_DATA_TABLE_ENTRY DataTableEntry;
03883 
03884             <span class="comment">//</span>
03885             <span class="comment">// Assert that the first 2 entries are never dereferenced as</span>
03886             <span class="comment">// unloading the kernel or HAL would be fatal.</span>
03887             <span class="comment">//</span>
03888 
03889             NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
03890 
03891             ImageCount = 0;
03892             <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a> &amp;&amp; ImageCount &lt; 2) {
03893                 DataTableEntry = CONTAINING_RECORD(NextEntry,
03894                                                    LDR_DATA_TABLE_ENTRY,
03895                                                    InLoadOrderLinks);
03896                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ImportTableEntry != DataTableEntry);
03897                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry-&gt;LoadCount == 1);
03898                 NextEntry = NextEntry-&gt;Flink;
03899                 ImageCount += 1;
03900             }
03901         }
03902 <span class="preprocessor">#endif</span>
03903 <span class="preprocessor"></span>
03904         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ImportTableEntry-&gt;LoadCount &gt;= 1);
03905 
03906         ImportTableEntry-&gt;LoadCount -= 1;
03907 
03908         <span class="keywordflow">if</span> (ImportTableEntry-&gt;LoadCount == 0) {
03909 
03910             <span class="comment">//</span>
03911             <span class="comment">// Unload this dependent DLL - we only do this to non-referenced</span>
03912             <span class="comment">// non-boot-loaded drivers.  Stop the import list recursion prior</span>
03913             <span class="comment">// to unloading - we know we're done at this point.</span>
03914             <span class="comment">//</span>
03915             <span class="comment">// Note we can continue on afterwards without restarting</span>
03916             <span class="comment">// regardless of which locks get released and reacquired</span>
03917             <span class="comment">// because this chain is private.</span>
03918             <span class="comment">//</span>
03919 
03920             SavedImports = ImportTableEntry-&gt;LoadedImports;
03921 
03922             ImportTableEntry-&gt;LoadedImports = (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>;
03923 
03924             Unloaded = <a class="code" href="../../d8/d8/sysload_8c.html#a43">MiCallDllUnloadAndUnloadDll</a> ((PVOID)ImportTableEntry);
03925 
03926             <span class="keywordflow">if</span> (Unloaded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03927 
03928                 <span class="comment">//</span>
03929                 <span class="comment">// This DLL was unloaded so recurse through its imports and</span>
03930                 <span class="comment">// attempt to unload all of those too.</span>
03931                 <span class="comment">//</span>
03932 
03933                 <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> ((<a class="code" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a>)SavedImports);
03934 
03935                 <span class="keywordflow">if</span> ((SavedImports != (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>) &amp;&amp;
03936                     (SavedImports != (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>) &amp;&amp;
03937                     (!<a class="code" href="../../d8/d8/sysload_8c.html#a2">SINGLE_ENTRY</a>(SavedImports))) {
03938 
03939                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (SavedImports);
03940                 }
03941             }
03942             <span class="keywordflow">else</span> {
03943                 ImportTableEntry-&gt;LoadedImports = SavedImports;
03944             }
03945         }
03946     }
03947 
03948     <span class="keywordflow">return</span> STATUS_SUCCESS;
03949 }
03950 
03951 
03952 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03953"></a><a class="code" href="../../d8/d8/sysload_8c.html#a31">03953</a> <a class="code" href="../../d8/d8/sysload_8c.html#a31">MiResolveImageReferences</a> (
03954     PVOID ImageBase,
03955     IN PUNICODE_STRING ImageFileDirectory,
03956     IN PUNICODE_STRING NamePrefix OPTIONAL,
03957     IN BOOLEAN LoadInSessionSpace,
03958     OUT PCHAR *MissingProcedureName,
03959     OUT PWSTR *MissingDriverName,
03960     OUT PLOAD_IMPORTS *LoadedImports
03961     )
03962 
03963 <span class="comment">/*++</span>
03964 <span class="comment"></span>
03965 <span class="comment">Routine Description:</span>
03966 <span class="comment"></span>
03967 <span class="comment">    This routine resolves the references from the newly loaded driver</span>
03968 <span class="comment">    to the kernel, HAL and other drivers.</span>
03969 <span class="comment"></span>
03970 <span class="comment">Arguments:</span>
03971 <span class="comment"></span>
03972 <span class="comment">    ImageBase - Supplies the address of which the image header resides.</span>
03973 <span class="comment"></span>
03974 <span class="comment">    ImageFileDirectory - Supplies the directory to load referenced DLLs.</span>
03975 <span class="comment"></span>
03976 <span class="comment">Return Value:</span>
03977 <span class="comment"></span>
03978 <span class="comment">    Status of the image reference resolution.</span>
03979 <span class="comment"></span>
03980 <span class="comment">--*/</span>
03981 
03982 {
03983     PCHAR MissingProcedureStorageArea;
03984     PVOID ImportBase;
03985     ULONG ImportSize;
03986     ULONG ImportListSize;
03987     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
03988     ULONG i;
03989     PIMAGE_IMPORT_DESCRIPTOR ImportDescriptor;
03990     PIMAGE_IMPORT_DESCRIPTOR Imp;
03991     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
03992     ULONG ExportSize;
03993     PIMAGE_EXPORT_DIRECTORY ExportDirectory;
03994     PIMAGE_THUNK_DATA NameThunk;
03995     PIMAGE_THUNK_DATA AddrThunk;
03996     PSZ ImportName;
03997     PLIST_ENTRY NextEntry;
03998     PLDR_DATA_TABLE_ENTRY DataTableEntry;
03999     PLDR_DATA_TABLE_ENTRY SingleEntry;
04000     ANSI_STRING AnsiString;
04001     UNICODE_STRING ImportName_U;
04002     UNICODE_STRING ImportDescriptorName_U;
04003     UNICODE_STRING DllToLoad;
04004     PVOID Section;
04005     PVOID BaseAddress;
04006     BOOLEAN PrefixedNameAllocated;
04007     BOOLEAN ReferenceImport;
04008     ULONG LinkWin32k = 0;
04009     ULONG LinkNonWin32k = 0;
04010     <a class="code" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a> ImportList;
04011     <a class="code" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a> CompactedImportList;
04012     BOOLEAN Loaded;
04013 
04014     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04015 
04016     *LoadedImports = <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>;
04017 
04018     MissingProcedureStorageArea = *MissingProcedureName;
04019 
04020     ImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
04021                         ImageBase,
04022                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04023                         IMAGE_DIRECTORY_ENTRY_IMPORT,
04024                         &amp;ImportSize);
04025 
04026     <span class="keywordflow">if</span> (ImportDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04027         <span class="keywordflow">return</span> STATUS_SUCCESS;
04028     }
04029 
04030     <span class="comment">// Count the number of imports so we can allocate enough room to</span>
04031     <span class="comment">// store them all chained off this module's LDR_DATA_TABLE_ENTRY.</span>
04032     <span class="comment">//</span>
04033 
04034     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
04035     <span class="keywordflow">for</span> (Imp = ImportDescriptor; Imp-&gt;Name &amp;&amp; Imp-&gt;OriginalFirstThunk; Imp += 1) {
04036         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
04037     }
04038 
04039     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>) {
04040         ImportListSize = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> * <span class="keyword">sizeof</span>(PVOID) + <span class="keyword">sizeof</span>(SIZE_T);
04041 
04042         ImportList = (<a class="code" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04043                                              ImportListSize,
04044                                              'TDmM');
04045 
04046         <span class="comment">//</span>
04047         <span class="comment">// Zero it so we can recover gracefully if we fail in the middle.</span>
04048         <span class="comment">// If the allocation failed, just don't build the import list.</span>
04049         <span class="comment">//</span>
04050     
04051         <span class="keywordflow">if</span> (ImportList) {
04052             RtlZeroMemory (ImportList, ImportListSize);
04053             ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a> = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
04054         }
04055     }
04056     <span class="keywordflow">else</span> {
04057         ImportList = (<a class="code" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a>) 0;
04058     }
04059 
04060     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
04061     <span class="keywordflow">while</span> (ImportDescriptor-&gt;Name &amp;&amp; ImportDescriptor-&gt;OriginalFirstThunk) {
04062 
04063         ImportName = (PSZ)((PCHAR)ImageBase + ImportDescriptor-&gt;Name);
04064 
04065         <span class="comment">//</span>
04066         <span class="comment">// A driver can link with win32k.sys if and only if it is a GDI</span>
04067         <span class="comment">// driver.</span>
04068         <span class="comment">// Also display drivers can only link to win32k.sys (and lego ...).</span>
04069         <span class="comment">//</span>
04070         <span class="comment">// So if we get a driver that links to win32k.sys and has more</span>
04071         <span class="comment">// than one set of imports, we will fail to load it.</span>
04072         <span class="comment">//</span>
04073 
04074         LinkWin32k = LinkWin32k |
04075              (!_strnicmp(ImportName, <span class="stringliteral">"win32k"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"win32k"</span>) - 1));
04076 
04077         <span class="comment">//</span>
04078         <span class="comment">// We don't want to count coverage, win32k and irt (lego) since</span>
04079         <span class="comment">// display drivers CAN link against these.</span>
04080         <span class="comment">//</span>
04081 
04082         LinkNonWin32k = LinkNonWin32k |
04083             ((_strnicmp(ImportName, <span class="stringliteral">"win32k"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"win32k"</span>) - 1)) &amp;&amp;
04084              (_strnicmp(ImportName, <span class="stringliteral">"dxapi"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"dxapi"</span>) - 1)) &amp;&amp;
04085              (_strnicmp(ImportName, <span class="stringliteral">"coverage"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"coverage"</span>) - 1)) &amp;&amp;
04086              (_strnicmp(ImportName, <span class="stringliteral">"irt"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"irt"</span>) - 1)));
04087 
04088 
04089         <span class="keywordflow">if</span> (LinkNonWin32k &amp;&amp; LinkWin32k) {
04090             <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (ImportList);
04091             <span class="keywordflow">if</span> (ImportList) {
04092                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
04093             }
04094             <span class="keywordflow">return</span> (STATUS_PROCEDURE_NOT_FOUND);
04095         }
04096 
04097         <span class="keywordflow">if</span> ((!_strnicmp(ImportName, <span class="stringliteral">"ntdll"</span>,    <span class="keyword">sizeof</span>(<span class="stringliteral">"ntdll"</span>) - 1))    ||
04098             (!_strnicmp(ImportName, <span class="stringliteral">"winsrv"</span>,   <span class="keyword">sizeof</span>(<span class="stringliteral">"winsrv"</span>) - 1))   ||
04099             (!_strnicmp(ImportName, <span class="stringliteral">"advapi32"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"advapi32"</span>) - 1)) ||
04100             (!_strnicmp(ImportName, <span class="stringliteral">"kernel32"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"kernel32"</span>) - 1)) ||
04101             (!_strnicmp(ImportName, <span class="stringliteral">"user32"</span>,   <span class="keyword">sizeof</span>(<span class="stringliteral">"user32"</span>) - 1))   ||
04102             (!_strnicmp(ImportName, <span class="stringliteral">"gdi32"</span>,    <span class="keyword">sizeof</span>(<span class="stringliteral">"gdi32"</span>) - 1)) ) {
04103 
04104             <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (ImportList);
04105 
04106             <span class="keywordflow">if</span> (ImportList) {
04107                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
04108             }
04109             <span class="keywordflow">return</span> (STATUS_PROCEDURE_NOT_FOUND);
04110         }
04111 
04112         <span class="keywordflow">if</span> ((!_strnicmp(ImportName, <span class="stringliteral">"ntoskrnl"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"ntoskrnl"</span>) - 1)) ||
04113             (!_strnicmp(ImportName, <span class="stringliteral">"win32k"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"win32k"</span>) - 1))     ||
04114             (!_strnicmp(ImportName, <span class="stringliteral">"hal"</span>,   <span class="keyword">sizeof</span>(<span class="stringliteral">"hal"</span>) - 1))) {
04115 
04116                 <span class="comment">//</span>
04117                 <span class="comment">// These imports don't get refcounted because we don't</span>
04118                 <span class="comment">// ever want to unload them.</span>
04119                 <span class="comment">//</span>
04120 
04121                 ReferenceImport = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04122         }
04123         <span class="keywordflow">else</span> {
04124                 ReferenceImport = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04125         }
04126 
04127         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, ImportName);
04128         st = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;ImportName_U, &amp;AnsiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04129         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
04130             <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (ImportList);
04131             <span class="keywordflow">if</span> (ImportList) {
04132                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
04133             }
04134             <span class="keywordflow">return</span> st;
04135         }
04136 
04137         <span class="keywordflow">if</span> (NamePrefix  &amp;&amp;
04138             (_strnicmp(ImportName, <span class="stringliteral">"ntoskrnl"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"ntoskrnl"</span>) - 1) &amp;&amp;
04139              _strnicmp(ImportName, <span class="stringliteral">"hal"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"hal"</span>) - 1))) {
04140 
04141             ImportDescriptorName_U.MaximumLength = ImportName_U.Length + NamePrefix-&gt;Length;
04142             ImportDescriptorName_U.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
04143                                                 ImportDescriptorName_U.MaximumLength,
04144                                                 'TDmM');
04145             <span class="keywordflow">if</span> (!ImportDescriptorName_U.Buffer) {
04146                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ImportName_U);
04147                 <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (ImportList);
04148                 <span class="keywordflow">if</span> (ImportList) {
04149                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
04150                 }
04151                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04152             }
04153 
04154             ImportDescriptorName_U.Length = 0;
04155             <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;ImportDescriptorName_U, NamePrefix);
04156             <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;ImportDescriptorName_U, &amp;ImportName_U);
04157             PrefixedNameAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04158         } <span class="keywordflow">else</span> {
04159             ImportDescriptorName_U = ImportName_U;
04160             PrefixedNameAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04161         }
04162 
04163         Loaded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04164 
04165 ReCheck:
04166         NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
04167         ImportBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04168 
04169         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
04170 
04171             DataTableEntry = CONTAINING_RECORD(NextEntry,
04172                                                LDR_DATA_TABLE_ENTRY,
04173                                                InLoadOrderLinks);
04174 
04175             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;ImportDescriptorName_U,
04176                                        &amp;DataTableEntry-&gt;BaseDllName,
04177                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
04178                                        )) {
04179 
04180                 ImportBase = DataTableEntry-&gt;DllBase;
04181 
04182                 <span class="comment">//</span>
04183                 <span class="comment">// Only bump the LoadCount if this thread did not initiate</span>
04184                 <span class="comment">// the load below.  If this thread initiated the load, then</span>
04185                 <span class="comment">// the LoadCount has already been bumped as part of the</span>
04186                 <span class="comment">// load - we only want to increment it here if we are</span>
04187                 <span class="comment">// "attaching" to a previously loaded DLL.</span>
04188                 <span class="comment">//</span>
04189 
04190                 <span class="keywordflow">if</span> (Loaded == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; ReferenceImport == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04191                     DataTableEntry-&gt;LoadCount += 1;
04192                 }
04193 
04194                 <span class="keywordflow">break</span>;
04195             }
04196             NextEntry = NextEntry-&gt;Flink;
04197         }
04198 
04199         <span class="keywordflow">if</span> (!ImportBase) {
04200 
04201             <span class="comment">//</span>
04202             <span class="comment">// The DLL name was not located, attempt to load this dll.</span>
04203             <span class="comment">//</span>
04204 
04205             DllToLoad.MaximumLength = ImportName_U.Length +
04206                                         ImageFileDirectory-&gt;Length +
04207                                         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(WCHAR);
04208 
04209             DllToLoad.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
04210                                                DllToLoad.MaximumLength,
04211                                                'TDmM');
04212 
04213             <span class="keywordflow">if</span> (DllToLoad.Buffer) {
04214                 DllToLoad.Length = ImageFileDirectory-&gt;Length;
04215                 RtlMoveMemory (DllToLoad.Buffer,
04216                                ImageFileDirectory-&gt;Buffer,
04217                                ImageFileDirectory-&gt;Length);
04218 
04219                 <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a> ((PSTRING)&amp;DllToLoad,
04220                                          (PSTRING)&amp;ImportName_U);
04221 
04222                 st = <a class="code" href="../../d8/d8/sysload_8c.html#a53">MmLoadSystemImage</a> (&amp;DllToLoad,
04223                                         NamePrefix,
04224                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04225                                         LoadInSessionSpace,
04226                                         &amp;Section,
04227                                         &amp;BaseAddress);
04228 
04229                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DllToLoad.Buffer);
04230             } <span class="keywordflow">else</span> {
04231                 st = STATUS_INSUFFICIENT_RESOURCES;
04232             }
04233 
04234             <span class="comment">//</span>
04235             <span class="comment">// Call any needed DLL initialization now.</span>
04236             <span class="comment">//</span>
04237 
04238             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
04239 
04240                 <a class="code" href="../../d2/d1/mm_8h.html#a157">PMM_DLL_INITIALIZE</a> Func;
04241                 UNICODE_STRING RegistryPath;
04242 
04243                 Loaded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04244 
04245                 Func = <a class="code" href="../../d8/d8/sysload_8c.html#a44">MiLocateExportName</a> (BaseAddress, <span class="stringliteral">"DllInitialize"</span>);
04246                 <span class="keywordflow">if</span> (Func) {
04247 
04248                     <span class="comment">//</span>
04249                     <span class="comment">// This DLL has an initialization routine.  Manufacture</span>
04250                     <span class="comment">// the service name string and invoke the function with</span>
04251                     <span class="comment">// it.</span>
04252                     <span class="comment">//</span>
04253 
04254                     RegistryPath.MaximumLength = <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length +
04255                                                     ImportName_U.Length +
04256                                                     (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(2*<span class="keyword">sizeof</span>(WCHAR));
04257                     RegistryPath.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
04258                                                     RegistryPath.MaximumLength,
04259                                                     'TDmM');
04260                     <span class="keywordflow">if</span> (RegistryPath.Buffer) {
04261                         PWCHAR Dot;
04262 
04263                         RegistryPath.Length = <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length;
04264                         RtlMoveMemory (RegistryPath.Buffer,
04265                                        <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Buffer,
04266                                        <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length);
04267 
04268                         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a> (&amp;RegistryPath, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
04269                         Dot = wcschr (ImportName_U.Buffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span>);
04270                         <span class="keywordflow">if</span> (Dot) {
04271                             ImportName_U.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((Dot - ImportName_U.Buffer)*<span class="keyword">sizeof</span>(WCHAR));
04272                         }
04273                         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a> (&amp;RegistryPath,
04274                                                         &amp;ImportName_U);
04275 
04276                         <span class="comment">//</span>
04277                         <span class="comment">// Now invoke the DLL's initialization routine.</span>
04278                         <span class="comment">//</span>
04279 
04280                         st = Func (&amp;RegistryPath);
04281                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (RegistryPath.Buffer);
04282 
04283                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
04284 
04285                             <span class="comment">//</span>
04286                             <span class="comment">// Unload the DLL now as its initialization</span>
04287                             <span class="comment">// routine failed.</span>
04288                             <span class="comment">//</span>
04289 
04290                             BOOLEAN Found;
04291                             PLIST_ENTRY Entry;
04292                             PLDR_DATA_TABLE_ENTRY DataTableEntry2;
04293 
04294                             Entry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
04295 
04296                             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04297                             <span class="keywordflow">while</span> (Entry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
04298 
04299                                 DataTableEntry2 = CONTAINING_RECORD(
04300                                                        Entry,
04301                                                        LDR_DATA_TABLE_ENTRY,
04302                                                        InLoadOrderLinks);
04303 
04304                                 <span class="keywordflow">if</span> (BaseAddress == DataTableEntry2-&gt;DllBase) {
04305 
04306                                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04307                                     <span class="keywordflow">break</span>;
04308                                 }
04309 
04310                                 Entry = Entry-&gt;Flink;
04311                             }
04312 
04313                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Found == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04314                             <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a> ((PVOID)DataTableEntry2);
04315                         }
04316                     }
04317 
04318                 }
04319             }
04320 
04321             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
04322 
04323                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;ImportName_U );
04324                 <span class="keywordflow">if</span> (PrefixedNameAllocated) {
04325                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ImportDescriptorName_U.Buffer );
04326                 }
04327                 <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (ImportList);
04328                 <span class="keywordflow">if</span> (ImportList) {
04329                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
04330                 }
04331                 <span class="keywordflow">return</span> st;
04332             }
04333 
04334             <span class="keywordflow">goto</span> ReCheck;
04335         }
04336 
04337         <span class="keywordflow">if</span> (ReferenceImport == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; ImportList) {
04338             ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = DataTableEntry;
04339             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
04340         }
04341 
04342         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;ImportName_U );
04343         <span class="keywordflow">if</span> (PrefixedNameAllocated) {
04344             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ( ImportDescriptorName_U.Buffer );
04345         }
04346 
04347         *MissingDriverName = DataTableEntry-&gt;BaseDllName.Buffer;
04348 
04349         ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
04350                                     ImportBase,
04351                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04352                                     IMAGE_DIRECTORY_ENTRY_EXPORT,
04353                                     &amp;ExportSize
04354                                     );
04355 
04356         <span class="keywordflow">if</span> (!ExportDirectory) {
04357             <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (ImportList);
04358             <span class="keywordflow">if</span> (ImportList) {
04359                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
04360             }
04361             <span class="keywordflow">return</span> STATUS_DRIVER_ENTRYPOINT_NOT_FOUND;
04362         }
04363 
04364         <span class="comment">//</span>
04365         <span class="comment">// Walk through the IAT and snap all the thunks.</span>
04366         <span class="comment">//</span>
04367 
04368         <span class="keywordflow">if</span> (ImportDescriptor-&gt;OriginalFirstThunk) {
04369 
04370             NameThunk = (PIMAGE_THUNK_DATA)((PCHAR)ImageBase + (ULONG)ImportDescriptor-&gt;OriginalFirstThunk);
04371             AddrThunk = (PIMAGE_THUNK_DATA)((PCHAR)ImageBase + (ULONG)ImportDescriptor-&gt;FirstThunk);
04372 
04373             <span class="keywordflow">while</span> (NameThunk-&gt;u1.AddressOfData) {
04374                 st = <a class="code" href="../../d8/d8/sysload_8c.html#a32">MiSnapThunk</a>(ImportBase,
04375                        ImageBase,
04376                        NameThunk++,
04377                        AddrThunk++,
04378                        ExportDirectory,
04379                        ExportSize,
04380                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04381                        MissingProcedureName
04382                        );
04383                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
04384                     <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (ImportList);
04385                     <span class="keywordflow">if</span> (ImportList) {
04386                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
04387                     }
04388                     <span class="keywordflow">return</span> st;
04389                 }
04390                 *MissingProcedureName = MissingProcedureStorageArea;
04391             }
04392         }
04393 
04394         ImportDescriptor += 1;
04395     }
04396 
04397     <span class="comment">//</span>
04398     <span class="comment">// All the imports are successfully loaded so establish and compact</span>
04399     <span class="comment">// the import unload list.</span>
04400     <span class="comment">//</span>
04401 
04402     <span class="keywordflow">if</span> (ImportList) {
04403 
04404         <span class="comment">//</span>
04405         <span class="comment">// Blank entries occur for things like the kernel, HAL &amp; win32k.sys</span>
04406         <span class="comment">// that we never want to unload.  Especially for things like</span>
04407         <span class="comment">// win32k.sys where the reference count can really hit 0.</span>
04408         <span class="comment">//</span>
04409 
04410         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
04411         <span class="keywordflow">for</span> (i = 0; i &lt; ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a>; i += 1) {
04412             <span class="keywordflow">if</span> (ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[i]) {
04413                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
04414             }
04415         }
04416 
04417         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 0) {
04418 
04419             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ImportList);
04420             ImportList = <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>;
04421         }
04422         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 1) {
04423             <span class="keywordflow">for</span> (i = 0; i &lt; ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a>; i += 1) {
04424                 <span class="keywordflow">if</span> (ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[i]) {
04425                     SingleEntry = <a class="code" href="../../d8/d8/sysload_8c.html#a4">POINTER_TO_SINGLE_ENTRY</a>(ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[i]);
04426                     <span class="keywordflow">break</span>;
04427                 }
04428             }
04429 
04430             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ImportList);
04431             ImportList = (<a class="code" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a>)SingleEntry;
04432         }
04433         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a>) {
04434 
04435             ImportListSize = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> * <span class="keyword">sizeof</span>(PVOID) + <span class="keyword">sizeof</span>(SIZE_T);
04436 
04437             CompactedImportList = (<a class="code" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a>)
04438                                         <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04439                                         ImportListSize,
04440                                         'TDmM');
04441             <span class="keywordflow">if</span> (CompactedImportList) {
04442                 CompactedImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a> = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
04443 
04444                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
04445                 <span class="keywordflow">for</span> (i = 0; i &lt; ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a>; i += 1) {
04446                     <span class="keywordflow">if</span> (ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[i]) {
04447                         CompactedImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[i];
04448                         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
04449                     }
04450                 }
04451 
04452                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ImportList);
04453                 ImportList = CompactedImportList;
04454             }
04455         }
04456 
04457         *LoadedImports = ImportList;
04458     }
04459     <span class="keywordflow">return</span> STATUS_SUCCESS;
04460 }
04461 
04462 
04463 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04464"></a><a class="code" href="../../d8/d8/sysload_8c.html#a32">04464</a> <a class="code" href="../../d8/d8/sysload_8c.html#a32">MiSnapThunk</a>(
04465     IN PVOID DllBase,
04466     IN PVOID ImageBase,
04467     IN PIMAGE_THUNK_DATA NameThunk,
04468     OUT PIMAGE_THUNK_DATA AddrThunk,
04469     IN PIMAGE_EXPORT_DIRECTORY ExportDirectory,
04470     IN ULONG ExportSize,
04471     IN BOOLEAN SnapForwarder,
04472     OUT PCHAR *MissingProcedureName
04473     )
04474 
04475 <span class="comment">/*++</span>
04476 <span class="comment"></span>
04477 <span class="comment">Routine Description:</span>
04478 <span class="comment"></span>
04479 <span class="comment">    This function snaps a thunk using the specified Export Section data.</span>
04480 <span class="comment">    If the section data does not support the thunk, then the thunk is</span>
04481 <span class="comment">    partially snapped (Dll field is still non-null, but snap address is</span>
04482 <span class="comment">    set).</span>
04483 <span class="comment"></span>
04484 <span class="comment">Arguments:</span>
04485 <span class="comment"></span>
04486 <span class="comment">    DllBase - Base of DLL being snapped to.</span>
04487 <span class="comment"></span>
04488 <span class="comment">    ImageBase - Base of image that contains the thunks to snap.</span>
04489 <span class="comment"></span>
04490 <span class="comment">    Thunk - On input, supplies the thunk to snap.  When successfully</span>
04491 <span class="comment">        snapped, the function field is set to point to the address in</span>
04492 <span class="comment">        the DLL, and the DLL field is set to NULL.</span>
04493 <span class="comment"></span>
04494 <span class="comment">    ExportDirectory - Supplies the Export Section data from a DLL.</span>
04495 <span class="comment"></span>
04496 <span class="comment">    SnapForwarder - determine if the snap is for a forwarder, and therefore</span>
04497 <span class="comment">       Address of Data is already setup.</span>
04498 <span class="comment"></span>
04499 <span class="comment">Return Value:</span>
04500 <span class="comment"></span>
04501 <span class="comment"></span>
04502 <span class="comment">    STATUS_SUCCESS or STATUS_DRIVER_ENTRYPOINT_NOT_FOUND or</span>
04503 <span class="comment">        STATUS_DRIVER_ORDINAL_NOT_FOUND</span>
04504 <span class="comment"></span>
04505 <span class="comment">--*/</span>
04506 
04507 {
04508     BOOLEAN Ordinal;
04509     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> OrdinalNumber;
04510     PULONG NameTableBase;
04511     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> NameOrdinalTableBase;
04512     PULONG Addr;
04513     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> HintIndex;
04514     ULONG High;
04515     ULONG Low;
04516     ULONG Middle;
04517     LONG Result;
04518     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04519     PCHAR MissingProcedureName2;
04520     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> NameBuffer[ MAXIMUM_FILENAME_LENGTH ];
04521 
04522     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04523 
04524     <span class="comment">//</span>
04525     <span class="comment">// Determine if snap is by name, or by ordinal</span>
04526     <span class="comment">//</span>
04527 
04528     Ordinal = (BOOLEAN)IMAGE_SNAP_BY_ORDINAL(NameThunk-&gt;u1.Ordinal);
04529 
04530     <span class="keywordflow">if</span> (Ordinal &amp;&amp; !SnapForwarder) {
04531 
04532         OrdinalNumber = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(IMAGE_ORDINAL(NameThunk-&gt;u1.Ordinal) -
04533                          ExportDirectory-&gt;Base);
04534 
04535         *MissingProcedureName = (PCHAR)(ULONG_PTR)OrdinalNumber;
04536 
04537     } <span class="keywordflow">else</span> {
04538 
04539         <span class="comment">//</span>
04540         <span class="comment">// Change AddressOfData from an RVA to a VA.</span>
04541         <span class="comment">//</span>
04542 
04543         <span class="keywordflow">if</span> (!SnapForwarder) {
04544             NameThunk-&gt;u1.AddressOfData = (ULONG_PTR)ImageBase + NameThunk-&gt;u1.AddressOfData;
04545         }
04546 
04547         strncpy( *MissingProcedureName,
04548                  &amp;((PIMAGE_IMPORT_BY_NAME)NameThunk-&gt;u1.AddressOfData)-&gt;Name[0],
04549                  MAXIMUM_FILENAME_LENGTH - 1
04550                );
04551 
04552         <span class="comment">//</span>
04553         <span class="comment">// Lookup Name in NameTable</span>
04554         <span class="comment">//</span>
04555 
04556         NameTableBase = (PULONG)((PCHAR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfNames);
04557         NameOrdinalTableBase = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)((PCHAR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfNameOrdinals);
04558 
04559         <span class="comment">//</span>
04560         <span class="comment">// Before dropping into binary search, see if</span>
04561         <span class="comment">// the hint index results in a successful</span>
04562         <span class="comment">// match. If the hint index is zero, then</span>
04563         <span class="comment">// drop into binary search.</span>
04564         <span class="comment">//</span>
04565 
04566         HintIndex = ((PIMAGE_IMPORT_BY_NAME)NameThunk-&gt;u1.AddressOfData)-&gt;Hint;
04567         <span class="keywordflow">if</span> ((ULONG)HintIndex &lt; ExportDirectory-&gt;NumberOfNames &amp;&amp;
04568             !strcmp((PSZ)((PIMAGE_IMPORT_BY_NAME)NameThunk-&gt;u1.AddressOfData)-&gt;Name,
04569              (PSZ)((PCHAR)DllBase + NameTableBase[HintIndex]))) {
04570             OrdinalNumber = NameOrdinalTableBase[HintIndex];
04571 
04572         } <span class="keywordflow">else</span> {
04573 
04574             <span class="comment">//</span>
04575             <span class="comment">// Lookup the import name in the name table using a binary search.</span>
04576             <span class="comment">//</span>
04577 
04578             Low = 0;
04579             High = ExportDirectory-&gt;NumberOfNames - 1;
04580 
04581             <span class="keywordflow">while</span> (High &gt;= Low) {
04582 
04583                 <span class="comment">//</span>
04584                 <span class="comment">// Compute the next probe index and compare the import name</span>
04585                 <span class="comment">// with the export name entry.</span>
04586                 <span class="comment">//</span>
04587 
04588                 Middle = (Low + High) &gt;&gt; 1;
04589                 Result = strcmp(&amp;((PIMAGE_IMPORT_BY_NAME)NameThunk-&gt;u1.AddressOfData)-&gt;Name[0],
04590                                 (PCHAR)((PCHAR)DllBase + NameTableBase[Middle]));
04591 
04592                 <span class="keywordflow">if</span> (Result &lt; 0) {
04593                     High = Middle - 1;
04594 
04595                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Result &gt; 0) {
04596                     Low = Middle + 1;
04597 
04598                 } <span class="keywordflow">else</span> {
04599                     <span class="keywordflow">break</span>;
04600                 }
04601             }
04602 
04603             <span class="comment">//</span>
04604             <span class="comment">// If the high index is less than the low index, then a matching</span>
04605             <span class="comment">// table entry was not found. Otherwise, get the ordinal number</span>
04606             <span class="comment">// from the ordinal table.</span>
04607             <span class="comment">//</span>
04608 
04609             <span class="keywordflow">if</span> (High &lt; Low) {
04610                 <span class="keywordflow">return</span> STATUS_DRIVER_ENTRYPOINT_NOT_FOUND;
04611             } <span class="keywordflow">else</span> {
04612                 OrdinalNumber = NameOrdinalTableBase[Middle];
04613             }
04614         }
04615     }
04616 
04617     <span class="comment">//</span>
04618     <span class="comment">// If OrdinalNumber is not within the Export Address Table,</span>
04619     <span class="comment">// then DLL does not implement function. Snap to LDRP_BAD_DLL.</span>
04620     <span class="comment">//</span>
04621 
04622     <span class="keywordflow">if</span> ((ULONG)OrdinalNumber &gt;= ExportDirectory-&gt;NumberOfFunctions) {
04623         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_DRIVER_ORDINAL_NOT_FOUND;
04624 
04625     } <span class="keywordflow">else</span> {
04626 
04627         MissingProcedureName2 = NameBuffer;
04628 
04629         Addr = (PULONG)((PCHAR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfFunctions);
04630         (PULONG)(AddrThunk-&gt;u1.Function) = (PULONG)((PCHAR)DllBase + Addr[OrdinalNumber]);
04631 
04632         <span class="comment">// AddrThunk s/b used from here on.</span>
04633 
04634         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04635 
04636         <span class="keywordflow">if</span> ( ((ULONG_PTR)AddrThunk-&gt;u1.Function &gt; (ULONG_PTR)ExportDirectory) &amp;&amp;
04637              ((ULONG_PTR)AddrThunk-&gt;u1.Function &lt; ((ULONG_PTR)ExportDirectory + ExportSize)) ) {
04638 
04639             UNICODE_STRING UnicodeString;
04640             ANSI_STRING ForwardDllName;
04641 
04642             PLIST_ENTRY NextEntry;
04643             PLDR_DATA_TABLE_ENTRY DataTableEntry;
04644             ULONG ExportSize;
04645             PIMAGE_EXPORT_DIRECTORY ExportDirectory;
04646 
04647             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_DRIVER_ENTRYPOINT_NOT_FOUND;
04648 
04649             <span class="comment">//</span>
04650             <span class="comment">// Include the dot in the length so we can do prefix later on.</span>
04651             <span class="comment">//</span>
04652 
04653             ForwardDllName.Buffer = (PCHAR)AddrThunk-&gt;u1.Function;
04654             ForwardDllName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(strchr(ForwardDllName.Buffer, <span class="charliteral">'.'</span>) -
04655                                            ForwardDllName.Buffer + 1);
04656             ForwardDllName.MaximumLength = ForwardDllName.Length;
04657 
04658             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;UnicodeString,
04659                                                         &amp;ForwardDllName,
04660                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))) {
04661 
04662                 NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
04663 
04664                 <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
04665 
04666                     DataTableEntry = CONTAINING_RECORD(NextEntry,
04667                                                        LDR_DATA_TABLE_ENTRY,
04668                                                        InLoadOrderLinks);
04669 
04670                     <span class="comment">//</span>
04671                     <span class="comment">// We have to do a case INSENSITIVE comparison for</span>
04672                     <span class="comment">// forwarder because the linker just took what is in the</span>
04673                     <span class="comment">// def file, as opposed to looking in the exporting</span>
04674                     <span class="comment">// image for the name.</span>
04675                     <span class="comment">// we also use the prefix function to ignore the .exe or</span>
04676                     <span class="comment">// .sys or .dll at the end.</span>
04677                     <span class="comment">//</span>
04678 
04679                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a12">RtlPrefixString</a>((PSTRING)&amp;UnicodeString,
04680                                         (PSTRING)&amp;DataTableEntry-&gt;BaseDllName,
04681                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
04682 
04683                         ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)
04684                             <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(DataTableEntry-&gt;DllBase,
04685                                                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04686                                                          IMAGE_DIRECTORY_ENTRY_EXPORT,
04687                                                          &amp;ExportSize);
04688 
04689                         <span class="keywordflow">if</span> (ExportDirectory) {
04690 
04691                             IMAGE_THUNK_DATA thunkData;
04692                             PIMAGE_IMPORT_BY_NAME addressOfData;
04693                             ULONG length;
04694 
04695                             <span class="comment">// one extra byte for NULL,</span>
04696 
04697                             length = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(ForwardDllName.Buffer +
04698                                                 ForwardDllName.Length) + 1;
04699 
04700                             addressOfData = (PIMAGE_IMPORT_BY_NAME)
04701                                 <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04702                                                       length +
04703                                                    <span class="keyword">sizeof</span>(IMAGE_IMPORT_BY_NAME),
04704                                                    '  mM');
04705 
04706                             <span class="keywordflow">if</span> (addressOfData) {
04707 
04708                                 RtlCopyMemory(&amp;(addressOfData-&gt;Name[0]),
04709                                               ForwardDllName.Buffer +
04710                                                   ForwardDllName.Length,
04711                                               length);
04712 
04713                                 addressOfData-&gt;Hint = 0;
04714 
04715                                 (PIMAGE_IMPORT_BY_NAME)(thunkData.u1.AddressOfData) = addressOfData;
04716 
04717                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a32">MiSnapThunk</a>(DataTableEntry-&gt;DllBase,
04718                                                      ImageBase,
04719                                                      &amp;thunkData,
04720                                                      &amp;thunkData,
04721                                                      ExportDirectory,
04722                                                      ExportSize,
04723                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04724                                                      &amp;MissingProcedureName2
04725                                                     );
04726 
04727                                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(addressOfData);
04728 
04729                                 AddrThunk-&gt;u1 = thunkData.u1;
04730                             }
04731                         }
04732 
04733                         <span class="keywordflow">break</span>;
04734                     }
04735 
04736                     NextEntry = NextEntry-&gt;Flink;
04737                 }
04738 
04739                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;UnicodeString);
04740             }
04741 
04742         }
04743 
04744     }
04745     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04746 }
04747 <span class="preprocessor">#if 0</span>
04748 <span class="preprocessor"></span>PVOID
04749 <a class="code" href="../../d8/d8/sysload_8c.html#a36">MiLookupImageSectionByName</a> (
04750     IN PVOID Base,
04751     IN BOOLEAN MappedAsImage,
04752     IN PCHAR SectionName,
04753     OUT PULONG SectionSize
04754     )
04755 
04756 <span class="comment">/*++</span>
04757 <span class="comment"></span>
04758 <span class="comment">Routine Description:</span>
04759 <span class="comment"></span>
04760 <span class="comment">    This function locates a Directory Entry within the image header</span>
04761 <span class="comment">    and returns either the virtual address or seek address of the</span>
04762 <span class="comment">    data the Directory describes.</span>
04763 <span class="comment"></span>
04764 <span class="comment">Arguments:</span>
04765 <span class="comment"></span>
04766 <span class="comment">    Base - Supplies the base of the image or data file.</span>
04767 <span class="comment"></span>
04768 <span class="comment">    MappedAsImage - FALSE if the file is mapped as a data file.</span>
04769 <span class="comment">                  - TRUE if the file is mapped as an image.</span>
04770 <span class="comment"></span>
04771 <span class="comment">    SectionName - Supplies the name of the section to lookup.</span>
04772 <span class="comment"></span>
04773 <span class="comment">    SectionSize - Return the size of the section.</span>
04774 <span class="comment"></span>
04775 <span class="comment">Return Value:</span>
04776 <span class="comment"></span>
04777 <span class="comment">    NULL - The file does not contain data for the specified section.</span>
04778 <span class="comment"></span>
04779 <span class="comment">    NON-NULL - Returns the address where the section is mapped in memory.</span>
04780 <span class="comment"></span>
04781 <span class="comment">--*/</span>
04782 
04783 {
04784     ULONG i, j, Match;
04785     PIMAGE_NT_HEADERS NtHeaders;
04786     PIMAGE_SECTION_HEADER NtSection;
04787 
04788     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
04789     NtSection = IMAGE_FIRST_SECTION( NtHeaders );
04790     <span class="keywordflow">for</span> (i = 0; i &lt; NtHeaders-&gt;FileHeader.NumberOfSections; i++) {
04791         Match = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04792         <span class="keywordflow">for</span> (j = 0; j &lt; IMAGE_SIZEOF_SHORT_NAME; j++) {
04793             <span class="keywordflow">if</span> (SectionName[j] != NtSection-&gt;Name[j]) {
04794                 Match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04795                 <span class="keywordflow">break</span>;
04796             }
04797             <span class="keywordflow">if</span> (SectionName[j] == <span class="charliteral">'\0'</span>) {
04798                 <span class="keywordflow">break</span>;
04799             }
04800         }
04801         <span class="keywordflow">if</span> (Match) {
04802             <span class="keywordflow">break</span>;
04803         }
04804         NtSection += 1;
04805     }
04806     <span class="keywordflow">if</span> (Match) {
04807         *SectionSize = NtSection-&gt;SizeOfRawData;
04808         <span class="keywordflow">if</span> (MappedAsImage) {
04809             <span class="keywordflow">return</span>( ((PCHAR)Base + NtSection-&gt;VirtualAddress));
04810         } <span class="keywordflow">else</span> {
04811             <span class="keywordflow">return</span>( ((PCHAR)Base + NtSection-&gt;PointerToRawData));
04812         }
04813     }
04814     <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
04815 }
04816 <span class="preprocessor">#endif //0</span>
04817 <span class="preprocessor"></span>
04818 
04819 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04820"></a><a class="code" href="../../d8/d8/sysload_8c.html#a39">04820</a> <a class="code" href="../../d0/d1/psinit_8c.html#a39">MmCheckSystemImage</a>(
04821     IN HANDLE ImageFileHandle
04822     )
04823 
04824 <span class="comment">/*++</span>
04825 <span class="comment"></span>
04826 <span class="comment">Routine Description:</span>
04827 <span class="comment"></span>
04828 <span class="comment">    This function ensures the checksum for a system image is correct</span>
04829 <span class="comment">    and matches the data in the image.</span>
04830 <span class="comment"></span>
04831 <span class="comment">Arguments:</span>
04832 <span class="comment"></span>
04833 <span class="comment">    ImageFileHandle - Supplies the file handle of the image.</span>
04834 <span class="comment"></span>
04835 <span class="comment">Return Value:</span>
04836 <span class="comment"></span>
04837 <span class="comment">    Status value.</span>
04838 <span class="comment"></span>
04839 <span class="comment">--*/</span>
04840 
04841 {
04842 
04843     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04844     HANDLE Section;
04845     PVOID ViewBase;
04846     SIZE_T ViewSize;
04847     IO_STATUS_BLOCK IoStatusBlock;
04848     FILE_STANDARD_INFORMATION StandardInfo;
04849 
04850     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04851 
04852     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateSection(
04853                 &amp;Section,
04854                 SECTION_MAP_EXECUTE,
04855                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04856                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04857                 PAGE_EXECUTE,
04858                 SEC_COMMIT,
04859                 ImageFileHandle
04860                 );
04861 
04862     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
04863         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04864     }
04865 
04866     ViewBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04867     ViewSize = 0;
04868 
04869     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwMapViewOfSection(
04870                 Section,
04871                 NtCurrentProcess(),
04872                 (PVOID *)&amp;ViewBase,
04873                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
04874                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
04875                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04876                 &amp;ViewSize,
04877                 ViewShare,
04878                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
04879                 PAGE_EXECUTE
04880                 );
04881 
04882     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
04883         ZwClose(Section);
04884         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04885     }
04886 
04887     <span class="comment">//</span>
04888     <span class="comment">// Now the image is mapped as a data file... Calculate its size and then</span>
04889     <span class="comment">// check its checksum.</span>
04890     <span class="comment">//</span>
04891 
04892     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryInformationFile(
04893                 ImageFileHandle,
04894                 &amp;IoStatusBlock,
04895                 &amp;StandardInfo,
04896                 <span class="keyword">sizeof</span>(StandardInfo),
04897                 FileStandardInformation
04898                 );
04899 
04900     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
04901 
04902         <span class="keywordflow">try</span> {
04903             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d7/checksum_8c.html#a1">LdrVerifyMappedImageMatchesChecksum</a>(ViewBase,StandardInfo.EndOfFile.LowPart)) {
04904                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_IMAGE_CHECKSUM_MISMATCH;
04905             }
04906 <span class="preprocessor">#if !defined(NT_UP)</span>
04907 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d8/sysload_8c.html#a60">MmVerifyImageIsOkForMpUse</a>(ViewBase) ) {
04908                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_IMAGE_MP_UP_MISMATCH;
04909                 }
04910 <span class="preprocessor">#endif // NT_UP</span>
04911 <span class="preprocessor"></span>        } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
04912             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_IMAGE_CHECKSUM_MISMATCH;
04913         }
04914     }
04915 
04916     ZwUnmapViewOfSection(NtCurrentProcess(),ViewBase);
04917     ZwClose(Section);
04918     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04919 }
04920 
04921 <span class="preprocessor">#if !defined(NT_UP)</span>
04922 <span class="preprocessor"></span>BOOLEAN
<a name="l04923"></a><a class="code" href="../../d8/d8/sysload_8c.html#a60">04923</a> <a class="code" href="../../d8/d8/sysload_8c.html#a60">MmVerifyImageIsOkForMpUse</a>(
04924     IN PVOID BaseAddress
04925     )
04926 {
04927     PIMAGE_NT_HEADERS NtHeaders;
04928 
04929     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04930 
04931     <span class="comment">//</span>
04932     <span class="comment">// If the file is an image file, then subtract the two checksum words</span>
04933     <span class="comment">// in the optional header from the computed checksum before adding</span>
04934     <span class="comment">// the file length, and set the value of the header checksum.</span>
04935     <span class="comment">//</span>
04936 
04937     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(BaseAddress);
04938     <span class="keywordflow">if</span> (NtHeaders != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04939         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a> &gt; 1 &amp;&amp;
04940              (NtHeaders-&gt;FileHeader.Characteristics &amp; IMAGE_FILE_UP_SYSTEM_ONLY) ) {
04941             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04942         }
04943     }
04944     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04945 }
04946 <span class="preprocessor">#endif // NT_UP</span>
04947 <span class="preprocessor"></span>
04948 
04949 PFN_NUMBER
<a name="l04950"></a><a class="code" href="../../d8/d8/sysload_8c.html#a61">04950</a> <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (
04951     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
04952     IN PFN_NUMBER NumberOfPtes,
04953     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> NewPteValue,
04954     IN LOGICAL SessionAllocation,
04955     OUT PPFN_NUMBER ResidentPages
04956     )
04957 
04958 <span class="comment">/*++</span>
04959 <span class="comment"></span>
04960 <span class="comment">Routine Description:</span>
04961 <span class="comment"></span>
04962 <span class="comment">    This function deletes pagable system address space (paged pool</span>
04963 <span class="comment">    or driver pagable sections).</span>
04964 <span class="comment"></span>
04965 <span class="comment">Arguments:</span>
04966 <span class="comment"></span>
04967 <span class="comment">    PointerPte - Supplies the start of the PTE range to delete.</span>
04968 <span class="comment"></span>
04969 <span class="comment">    NumberOfPtes - Supplies the number of PTEs in the range.</span>
04970 <span class="comment"></span>
04971 <span class="comment">    NewPteValue - Supplies the new value for the PTE.</span>
04972 <span class="comment"></span>
04973 <span class="comment">    SessionAllocation - Supplies TRUE if this is a range in session space.  If</span>
04974 <span class="comment">                        TRUE is specified, it is assumed that the caller has</span>
04975 <span class="comment">                        already attached to the relevant session.</span>
04976 <span class="comment"></span>
04977 <span class="comment">                        If FALSE is supplied, then it is assumed that the range</span>
04978 <span class="comment">                        is in the systemwide global space instead.</span>
04979 <span class="comment"></span>
04980 <span class="comment">    ResidentPages - If not NULL, the number of resident pages freed is</span>
04981 <span class="comment">                    returned here.</span>
04982 <span class="comment"></span>
04983 <span class="comment">Return Value:</span>
04984 <span class="comment"></span>
04985 <span class="comment">    Returns the number of pages actually freed.</span>
04986 <span class="comment"></span>
04987 <span class="comment">--*/</span>
04988 
04989 {
04990     PFN_NUMBER PageFrameIndex;
04991     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
04992     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
04993     PFN_NUMBER ValidPages;
04994     PFN_NUMBER PagesRequired;
04995     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> NewContents;
04996     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WsIndex;
04997     KIRQL OldIrql;
04998     <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a> PteFlushList;
04999     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> JunkPte;
05000     <a class="code" href="../../d4/d8/struct__MMWSLENTRY.html">MMWSLENTRY</a> Locked;
05001 
05002     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
05003 
05004     ValidPages = 0;
05005     PagesRequired = 0;
05006     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = 0;
05007     NewContents = NewPteValue;
05008     <span class="keywordflow">while</span> (NumberOfPtes != 0) {
05009         PteContents = *PointerPte;
05010 
05011         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
05012 
05013             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
05014 
05015                 <span class="keywordflow">if</span> (SessionAllocation == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05016                     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
05017                 }
05018                 <span class="keywordflow">else</span> {
05019                     <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql);
05020                 }
05021 
05022                 PteContents = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
05023                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
05024                     <span class="keywordflow">if</span> (SessionAllocation == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05025                         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
05026                     }
05027                     <span class="keywordflow">else</span> {
05028                         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql);
05029                     }
05030 
05031                     <span class="keywordflow">continue</span>;
05032                 }
05033 
05034                 <span class="comment">//</span>
05035                 <span class="comment">// Delete the page.</span>
05036                 <span class="comment">//</span>
05037 
05038                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PteContents);
05039 
05040                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
05041 
05042                 <span class="comment">//</span>
05043                 <span class="comment">// Check to see if this is a pagable page in which</span>
05044                 <span class="comment">// case it needs to be removed from the working set list.</span>
05045                 <span class="comment">//</span>
05046 
05047                 WsIndex = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex;
05048                 <span class="keywordflow">if</span> (WsIndex == 0) {
05049                     ValidPages += 1;
05050                 } <span class="keywordflow">else</span> {
05051                     <span class="keywordflow">if</span> (SessionAllocation == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
05052                         <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (WsIndex,
05053                                       <a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a> );
05054                         <a class="code" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> (WsIndex, &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>);
05055                     }
05056                     <span class="keywordflow">else</span> {
05057                         WsIndex = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a>(
05058                                               <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte),
05059                                               <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>,
05060                                               WsIndex
05061                                               );
05062 
05063                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsIndex != <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>);
05064 
05065                         <span class="comment">//</span>
05066                         <span class="comment">// Check to see if this entry is locked in</span>
05067                         <span class="comment">// the working set or locked in memory.</span>
05068                         <span class="comment">//</span>
05069 
05070                         Locked = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>[WsIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1;
05071 
05072                         <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (WsIndex, <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>);
05073 
05074                         <a class="code" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> (WsIndex, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>);
05075 
05076                         <span class="keywordflow">if</span> (Locked.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o1">LockedInWs</a> == 1 || Locked.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o2">LockedInMemory</a> == 1) {
05077 
05078                             <span class="comment">//</span>
05079                             <span class="comment">// This entry is locked.</span>
05080                             <span class="comment">//</span>
05081 <span class="preprocessor">#if DBG</span>
05082 <span class="preprocessor"></span>                            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiDeleteSystemPagableVm: Session PointerPte 0x%p, Pfn 0x%p Locked in memory\n"</span>,
05083                                 PointerPte,
05084                                 Pfn1);
05085 
05086                             DbgBreakPoint();
05087 <span class="preprocessor">#endif</span>
05088 <span class="preprocessor"></span>                            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsIndex &lt; MmSessionSpace-&gt;Vm.VmWorkingSetList-&gt;FirstDynamic);
05089                             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> -= 1;
05090 
05091                             <span class="keywordflow">if</span> (WsIndex != <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
05092                                 ULONG Entry;
05093                                 PVOID SwapVa;
05094 
05095                                 Entry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
05096                                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid);
05097                                 SwapVa = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress;
05098                                 SwapVa = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (SwapVa);
05099 
05100                                 <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry,
05101                                                   WsIndex,
05102                                                   &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>);
05103                             }
05104                         }
05105                         <span class="keywordflow">else</span> {
05106                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsIndex &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
05107                         }
05108                     }
05109                 }
05110 
05111                 <span class="keywordflow">if</span> (SessionAllocation == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05112                     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
05113                 }
05114                 <span class="keywordflow">else</span> {
05115                     <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql);
05116                 }
05117 
05118                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05119 <span class="preprocessor">#if DBG</span>
05120 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1) &amp;&amp;
05121                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
05122                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM:SYSLOAD - deleting pool locked for I/O pte %p, pfn %p, share=%x, refcount=%x, wsindex=%x\n"</span>,
05123                              PointerPte,
05124                              PageFrameIndex,
05125                              Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount,
05126                              Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount,
05127                              Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
05128                     <span class="comment">//</span>
05129                     <span class="comment">// This case is valid only if the page being deleted</span>
05130                     <span class="comment">// contained a lookaside free list entry that wasn't mapped</span>
05131                     <span class="comment">// and multiple threads faulted on it and waited together.</span>
05132                     <span class="comment">// Some of the faulted threads are still on the ready</span>
05133                     <span class="comment">// list but haven't run yet, and so still have references</span>
05134                     <span class="comment">// to this page that they picked up during the fault.</span>
05135                     <span class="comment">// But this current thread has already allocated the</span>
05136                     <span class="comment">// lookaside entry and is now freeing the entire page.</span>
05137                     <span class="comment">//</span>
05138                     <span class="comment">// BUT - if it is NOT the above case, we really should</span>
05139                     <span class="comment">// trap here.  However, we don't have a good way to</span>
05140                     <span class="comment">// distinguish between the two cases.  Note</span>
05141                     <span class="comment">// that this complication was inserted when we went to</span>
05142                     <span class="comment">// cmpxchg8 because using locks would prevent anyone from</span>
05143                     <span class="comment">// accessing the lookaside freelist flinks like this.</span>
05144                     <span class="comment">//</span>
05145                     <span class="comment">// So, the ASSERT below comes out, but we leave the print</span>
05146                     <span class="comment">// above in (with more data added) for the case where it's</span>
05147                     <span class="comment">// not a lookaside contender with the reference count, but</span>
05148                     <span class="comment">// is instead a truly bad reference that needs to be</span>
05149                     <span class="comment">// debugged.  The system should crash shortly thereafter</span>
05150                     <span class="comment">// and we'll at least have the above print to help us out.</span>
05151                     <span class="comment">//</span>
05152                     <span class="comment">// ASSERT (Pfn1-&gt;u3.e2.ReferenceCount == 1);</span>
05153                 }
05154 <span class="preprocessor">#endif //DBG</span>
05155 <span class="preprocessor"></span>                <span class="comment">//</span>
05156                 <span class="comment">// Check if this is a prototype PTE</span>
05157                 <span class="comment">//</span>
05158                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1) {
05159 
05160                     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
05161 
05162                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SessionAllocation == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05163 
05164                     <span class="comment">//</span>
05165                     <span class="comment">// Capture the state of the modified bit for this</span>
05166                     <span class="comment">// PTE.</span>
05167                     <span class="comment">//</span>
05168 
05169                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (PointerPte, Pfn1);
05170 
05171                     <span class="comment">//</span>
05172                     <span class="comment">// Decrement the share and valid counts of the page table</span>
05173                     <span class="comment">// page which maps this PTE.</span>
05174                     <span class="comment">//</span>
05175 
05176                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
05177                     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
05178 <span class="preprocessor">#if !defined (_WIN64)</span>
05179 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d8/mi_8h.html#a836">MiCheckPdeForPagedPool</a> (PointerPte))) {
05180 <span class="preprocessor">#endif</span>
05181 <span class="preprocessor"></span>                            <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
05182                                           0x61940, 
05183                                           (ULONG_PTR)PointerPte,
05184                                           (ULONG_PTR)PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
05185                                           (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
05186 <span class="preprocessor">#if !defined (_WIN64)</span>
05187 <span class="preprocessor"></span>                        }
05188 <span class="preprocessor">#endif</span>
05189 <span class="preprocessor"></span>                    }
05190 
05191                     <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPde));
05192 
05193                     <span class="comment">//</span>
05194                     <span class="comment">// Decrement the share count for the physical page.</span>
05195                     <span class="comment">//</span>
05196 
05197                     <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageFrameIndex);
05198 
05199                     <span class="comment">//</span>
05200                     <span class="comment">// No need to worry about fork prototype PTEs</span>
05201                     <span class="comment">// for kernel addresses.</span>
05202                     <span class="comment">//</span>
05203 
05204                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte &gt; <a class="code" href="../../d4/d8/mi_8h.html#a755">MiHighestUserPte</a>);
05205 
05206                 } <span class="keywordflow">else</span> {
05207                     <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
05208                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
05209                     <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
05210                 }
05211 
05212                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, NewContents);
05213                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05214 
05215                 <span class="comment">//</span>
05216                 <span class="comment">// Flush the TB for this page.</span>
05217                 <span class="comment">//</span>
05218 
05219                 <span class="keywordflow">if</span> (PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
05220 
05221                     <span class="comment">//</span>
05222                     <span class="comment">// We cannot rewrite the PTE without creating a race</span>
05223                     <span class="comment">// condition.  So don't let the TB flush do it anymore.</span>
05224                     <span class="comment">//</span>
05225                     <span class="comment">// PteFlushList.FlushPte[PteFlushList.Count] = PointerPte;</span>
05226                     <span class="comment">//</span>
05227 
05228                     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o1">FlushPte</a>[PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a>] =
05229                         (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)&amp;JunkPte;
05230 
05231                     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o2">FlushVa</a>[PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a>] =
05232                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
05233                     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> += 1;
05234                 }
05235 
05236             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype) {
05237 
05238                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SessionAllocation == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05239 
05240                 <span class="comment">//</span>
05241                 <span class="comment">// No need to worry about fork prototype PTEs</span>
05242                 <span class="comment">// for kernel addresses.</span>
05243                 <span class="comment">//</span>
05244 
05245                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a755">MiHighestUserPte</a>);
05246 
05247                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, NewContents);
05248 
05249                 <span class="comment">//</span>
05250                 <span class="comment">// We currently commit for all prototype kernel mappings since</span>
05251                 <span class="comment">// we could copy-on-write.</span>
05252                 <span class="comment">//</span>
05253 
05254             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
05255 
05256                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05257 
05258                 PteContents = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
05259 
05260                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 0) {
05261                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05262                     <span class="keywordflow">continue</span>;
05263                 }
05264 
05265                 <span class="comment">//</span>
05266                 <span class="comment">// Transition, release page.</span>
05267                 <span class="comment">//</span>
05268 
05269                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents);
05270 
05271                 <span class="comment">//</span>
05272                 <span class="comment">// Set the pointer to PTE as empty so the page</span>
05273                 <span class="comment">// is deleted when the reference count goes to zero.</span>
05274                 <span class="comment">//</span>
05275 
05276                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
05277 
05278                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
05279 
05280                 <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
05281 
05282                 <span class="comment">//</span>
05283                 <span class="comment">// Check the reference count for the page, if the reference</span>
05284                 <span class="comment">// count is zero, move the page to the free list, if the</span>
05285                 <span class="comment">// reference count is not zero, ignore this page.  When the</span>
05286                 <span class="comment">// reference count goes to zero, it will be placed on the</span>
05287                 <span class="comment">// free list.</span>
05288                 <span class="comment">//</span>
05289 
05290                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
05291                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
05292                     <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
05293                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
05294                                         PageFrameIndex);
05295                 }
05296 <span class="preprocessor">#if DBG</span>
05297 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1) &amp;&amp;
05298                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
05299                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM:SYSLOAD - deleting pool locked for I/O %p\n"</span>,
05300                              PageFrameIndex);
05301                     DbgBreakPoint();
05302                 }
05303 <span class="preprocessor">#endif //DBG</span>
05304 <span class="preprocessor"></span>
05305                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, NewContents);
05306                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05307             } <span class="keywordflow">else</span> {
05308 
05309                 <span class="comment">//</span>
05310                 <span class="comment">// Demand zero, release page file space.</span>
05311                 <span class="comment">//</span>
05312                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh != 0) {
05313                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05314                     <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (PteContents);
05315                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05316                 }
05317 
05318                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, NewContents);
05319             }
05320 
05321             PagesRequired += 1;
05322         }
05323 
05324         NumberOfPtes -= 1;
05325         PointerPte += 1;
05326     }
05327 
05328     <span class="comment">//</span>
05329     <span class="comment">// There is the thorny case where one of the pages we just deleted could</span>
05330     <span class="comment">// get faulted back in when we released the PFN lock above within the loop.</span>
05331     <span class="comment">// The only time when this can happen is if a thread faulted during an</span>
05332     <span class="comment">// interlocked pool allocation for an address that we've just deleted.</span>
05333     <span class="comment">//</span>
05334     <span class="comment">// If this thread sees the NewContents in the PTE, it will treat it as</span>
05335     <span class="comment">// demand zero, and incorrectly allocate a page, PTE and WSL.  It will</span>
05336     <span class="comment">// reference it once and realize it needs to reread the lookaside listhead</span>
05337     <span class="comment">// and restart the operation.  But this page would live on in paged pool</span>
05338     <span class="comment">// as modified (but unused) until the paged pool allocator chose to give</span>
05339     <span class="comment">// out its virtual address again.</span>
05340     <span class="comment">//</span>
05341     <span class="comment">// The code below rewrites the PTEs which is really bad if another thread</span>
05342     <span class="comment">// gets a zero page between our first setting of the PTEs above and our</span>
05343     <span class="comment">// second setting below - because we'll reset the PTE to demand zero, but</span>
05344     <span class="comment">// we'll still have a WSL entry that's valid, and we spiral from there.</span>
05345     <span class="comment">//</span>
05346     <span class="comment">// We really should remove the writing of the PTE below since we've already</span>
05347     <span class="comment">// done it above.  But for now, we're leaving it in - it's harmless because</span>
05348     <span class="comment">// we've chosen to fix this problem by checking for this case when we</span>
05349     <span class="comment">// materialize demand zero pages.  Note that we have to fix this problem</span>
05350     <span class="comment">// by checking in the demand zero path because a thread could be coming into</span>
05351     <span class="comment">// that path any time before or after we flush the PTE list and any fixes</span>
05352     <span class="comment">// here could only address the before case, not the after.</span>
05353     <span class="comment">//</span>
05354 
05355     <span class="keywordflow">if</span> (SessionAllocation == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05356 
05357         <span class="comment">//</span>
05358         <span class="comment">// Session space has no ASN - flush the entire TB.</span>
05359         <span class="comment">//</span>
05360     
05361         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a200">MI_FLUSH_ENTIRE_SESSION_TB</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05362     }
05363 
05364     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05365     <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, NewContents);
05366     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05367 
05368     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ResidentPages)) {
05369         *ResidentPages = ValidPages;
05370     }
05371 
05372     <span class="keywordflow">return</span> PagesRequired;
05373 }
05374 
05375 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05376"></a><a class="code" href="../../d8/d8/sysload_8c.html#a62">05376</a> <a class="code" href="../../d8/d8/sysload_8c.html#a62">MiSetImageProtect</a> (
05377     IN <a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a> Segment,
05378     IN ULONG Protection
05379     )
05380 
05381 <span class="comment">/*++</span>
05382 <span class="comment"></span>
05383 <span class="comment">Routine Description:</span>
05384 <span class="comment"></span>
05385 <span class="comment">    This function sets the protection of all prototype PTEs to the specified</span>
05386 <span class="comment">    protection.</span>
05387 <span class="comment"></span>
05388 <span class="comment">Arguments:</span>
05389 <span class="comment"></span>
05390 <span class="comment">     Segment - Supplies a pointer to the segment to protect.</span>
05391 <span class="comment"></span>
05392 <span class="comment">     Protection - Supplies the protection value to set.</span>
05393 <span class="comment"></span>
05394 <span class="comment">Return Value:</span>
05395 <span class="comment"></span>
05396 <span class="comment">     None.</span>
05397 <span class="comment"></span>
05398 <span class="comment">--*/</span>
05399 
05400 {
05401     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05402     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
05403     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
05404     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> SubSection;
05405 
05406     <span class="comment">//</span>
05407     <span class="comment">// Set the subsection protections.</span>
05408     <span class="comment">//</span>
05409 
05410     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Segment-&gt;ControlArea-&gt;u.Flags.GlobalOnlyPerSession == 0);
05411 
05412     <span class="keywordflow">if</span> ((Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a51">MM_PROTECTION_WRITE_MASK</a>) == 0) {
05413         SubSection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(Segment-&gt;ControlArea + 1);
05414         SubSection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection = Protection;
05415         SubSection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.ReadOnly = 1;
05416     }
05417 
05418     PointerPte = Segment-&gt;PrototypePte;
05419     LastPte = PointerPte + Segment-&gt;NonExtendedPtes;
05420 
05421     <a class="code" href="../../d5/d6/iosup_8c.html#a87">MmLockPagedPool</a> (PointerPte, (LastPte - PointerPte) * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
05422 
05423     <span class="keywordflow">do</span> {
05424         PteContents = *PointerPte;
05425         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
05426         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
05427             <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
05428                 (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
05429                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a41">MiSetProtectionOnTransitionPte</a> (PointerPte, Protection)) {
05430                     <span class="keywordflow">continue</span>;
05431                 }
05432             }
05433             <span class="keywordflow">else</span> {
05434                 PointerPte-&gt;u.Soft.Protection = Protection;
05435             }
05436         }
05437         PointerPte += 1;
05438     } <span class="keywordflow">while</span> (PointerPte &lt; LastPte);
05439 
05440     PointerPte = Segment-&gt;PrototypePte;
05441     <a class="code" href="../../d5/d6/iosup_8c.html#a88">MmUnlockPagedPool</a> (PointerPte, (LastPte - PointerPte) * <span class="keyword">sizeof</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>));
05442 
05443     <span class="keywordflow">return</span>;
05444 }
05445 
05446 
05447 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05448"></a><a class="code" href="../../d8/d8/sysload_8c.html#a63">05448</a> <a class="code" href="../../d8/d8/sysload_8c.html#a63">MiSetSystemCodeProtection</a> (
05449     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte,
05450     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte
05451     )
05452 
05453 <span class="comment">/*++</span>
05454 <span class="comment"></span>
05455 <span class="comment">Routine Description:</span>
05456 <span class="comment"></span>
05457 <span class="comment">    This function sets the protection of system code to read only.</span>
05458 <span class="comment">    Note this is different from protecting section-backed code like win32k.</span>
05459 <span class="comment"></span>
05460 <span class="comment">Arguments:</span>
05461 <span class="comment"></span>
05462 <span class="comment">    FirstPte - Supplies the starting PTE.</span>
05463 <span class="comment"></span>
05464 <span class="comment">    LastPte - Supplies the ending PTE.</span>
05465 <span class="comment"></span>
05466 <span class="comment">Return Value:</span>
05467 <span class="comment"></span>
05468 <span class="comment">    None.</span>
05469 <span class="comment"></span>
05470 <span class="comment">--*/</span>
05471 
05472 {
05473     KIRQL OldIrql;
05474     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
05475     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
05476     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
05477     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05478     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
05479     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte;
05480     ULONG ProtectionMask;
05481     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
05482     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> ProtoPfn;
05483     LOGICAL SessionAddress;
05484 
05485 <span class="preprocessor">#if defined(_X86_)</span>
05486 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(FirstPte)) == 0);
05487 <span class="preprocessor">#endif</span>
05488 <span class="preprocessor"></span>
05489     SessionAddress = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05490 
05491     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(FirstPte))) {
05492         SessionAddress = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05493     }
05494     
05495     ProtectionMask = <a class="code" href="../../d4/d8/mi_8h.html#a38">MM_EXECUTE_READ</a>;
05496 
05497     <span class="comment">//</span>
05498     <span class="comment">// Make these PTEs read only.</span>
05499     <span class="comment">//</span>
05500     <span class="comment">// Note that the write bit may already be off (in the valid PTE) if the</span>
05501     <span class="comment">// page has already been inpaged from the paging file and has not since</span>
05502     <span class="comment">// been dirtied.</span>
05503     <span class="comment">//</span>
05504 
05505     PointerPte = FirstPte;
05506 
05507     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05508 
05509     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
05510 
05511         PteContents = *PointerPte;
05512 
05513         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) || (!*<a class="code" href="../../d5/d1/mminit_8c.html#a32">MiPteStr</a>)) {
05514             PointerPte += 1;
05515             <span class="keywordflow">continue</span>;
05516         }
05517 
05518         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
05519 
05520             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
05521             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
05522 
05523             <span class="comment">//</span>
05524             <span class="comment">// Note the dirty and write bits get turned off here.</span>
05525             <span class="comment">// Any existing pagefile addresses for clean pages are preserved.</span>
05526             <span class="comment">//</span>
05527 
05528             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a>(PteContents)) {
05529                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (&amp;PteContents, Pfn1);
05530             }
05531 
05532             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
05533                                PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber,
05534                                Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection,
05535                                PointerPte);
05536 
05537             <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05538         
05539                 <span class="comment">//</span>
05540                 <span class="comment">// Session space has no ASN - flush the entire TB.</span>
05541                 <span class="comment">//</span>
05542             
05543                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a199">MI_FLUSH_SINGLE_SESSION_TB</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte),
05544                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
05545                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
05546                              (PHARDWARE_PTE)PointerPte,
05547                              TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
05548                              PreviousPte);
05549             }
05550             <span class="keywordflow">else</span> {
05551                 <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte),
05552                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
05553                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
05554                                  (PHARDWARE_PTE)PointerPte,
05555                                  TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
05556             }
05557         }
05558         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
05559 
05560             <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05561                 PointerPte-&gt;u.Proto.ReadOnly = 1;
05562             }
05563             <span class="keywordflow">else</span> {
05564                 PointerProtoPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a>(PointerPte);
05565     
05566                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(PointerProtoPte)) {
05567                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerProtoPte);
05568                     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
05569                         <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerProtoPte);
05570     
05571                         <span class="comment">//</span>
05572                         <span class="comment">// The world may change if we had to wait.</span>
05573                         <span class="comment">//</span>
05574         
05575                         PteContents = *PointerPte;
05576                         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) ||
05577                             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0)) {
05578                                 <span class="keywordflow">continue</span>;
05579                         }
05580                     }
05581     
05582                     ProtoPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
05583                     <a class="code" href="../../d4/d8/mi_8h.html#a186">MI_ADD_LOCKED_PAGE_CHARGE</a>(ProtoPfn, 12);
05584                     ProtoPfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
05585                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProtoPfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
05586                 }
05587     
05588                 PteContents = *PointerProtoPte;
05589     
05590                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
05591     
05592                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
05593     
05594                     PointerProtoPte-&gt;u.Soft.Protection = ProtectionMask;
05595     
05596                     <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
05597                         (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
05598                         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
05599                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
05600                     }
05601                 }
05602 
05603                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(PointerProtoPte)) {
05604                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProtoPfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
05605                     <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a>(ProtoPfn, 13);
05606                     ProtoPfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount -= 1;
05607                 }
05608             }
05609         }
05610         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
05611 
05612             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
05613             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
05614             PointerPte-&gt;u.Soft.Protection = ProtectionMask;
05615 
05616         }
05617         <span class="keywordflow">else</span> {
05618 
05619             <span class="comment">//</span>
05620             <span class="comment">// Must be page file space or demand zero.</span>
05621             <span class="comment">//</span>
05622 
05623             PointerPte-&gt;u.Soft.Protection = ProtectionMask;
05624         }
05625         PointerPte += 1;
05626     }
05627 
05628     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05629 }
05630 
05631 
05632 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05633"></a><a class="code" href="../../d5/d1/mminit_8c.html#a49">05633</a> <a class="code" href="../../d8/d8/sysload_8c.html#a47">MiWriteProtectSystemImage</a> (
05634     IN PVOID DllBase
05635     )
05636 
05637 <span class="comment">/*++</span>
05638 <span class="comment"></span>
05639 <span class="comment">Routine Description:</span>
05640 <span class="comment"></span>
05641 <span class="comment">    This function sets the protection of a system component to read only.</span>
05642 <span class="comment"></span>
05643 <span class="comment">Arguments:</span>
05644 <span class="comment"></span>
05645 <span class="comment">    DllBase - Supplies the base address of the system component.</span>
05646 <span class="comment"></span>
05647 <span class="comment">Return Value:</span>
05648 <span class="comment"></span>
05649 <span class="comment">    None.</span>
05650 <span class="comment"></span>
05651 <span class="comment">--*/</span>
05652 
05653 {
05654     ULONG SectionProtection;
05655     ULONG NumberOfSubsections;
05656     ULONG SectionVirtualSize;
05657     ULONG ImageAlignment;
05658     ULONG OffsetToSectionTable;
05659     ULONG NumberOfPtes;
05660     ULONG_PTR VirtualAddress;
05661     ULONG_PTR LastVirtualAddress;
05662     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05663     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte;
05664     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
05665     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastImagePte;
05666     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> WritablePte;
05667     PIMAGE_NT_HEADERS NtHeader;
05668     PIMAGE_FILE_HEADER FileHeader;
05669     PIMAGE_SECTION_HEADER SectionTableEntry;
05670 
05671     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05672 
05673     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(DllBase)) {
05674         <span class="keywordflow">return</span>;
05675     }
05676 
05677     NtHeader = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a> (DllBase);
05678 
05679     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NtHeader);
05680 
05681     ImageAlignment = NtHeader-&gt;OptionalHeader.SectionAlignment;
05682 
05683     <span class="comment">//</span>
05684     <span class="comment">// All session drivers must be one way or the other - no mixing is allowed</span>
05685     <span class="comment">// within multiple copy-on-write drivers.</span>
05686     <span class="comment">//</span>
05687 
05688     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a>(DllBase) == 0) {
05689 
05690         <span class="comment">//</span>
05691         <span class="comment">// Images prior to NT5 were not protected from stepping all over</span>
05692         <span class="comment">// their (and others) code and readonly data.  Here we somewhat</span>
05693         <span class="comment">// preserve that behavior, but don't allow them to step on anyone else.</span>
05694         <span class="comment">//</span>
05695 
05696         <span class="comment">//</span>
05697         <span class="comment">// Note that drivers that are built for NT5 have presumably run on</span>
05698         <span class="comment">// NT5, and these get the benefits of full protection.</span>
05699         <span class="comment">//</span>
05700 
05701         <span class="keywordflow">if</span> ((NtHeader-&gt;OptionalHeader.MajorOperatingSystemVersion &lt; 5) ||
05702             (NtHeader-&gt;OptionalHeader.MajorOperatingSystemVersion &gt; 10)) {
05703             <span class="keywordflow">return</span>;
05704         }
05705     
05706         <span class="keywordflow">if</span> ((NtHeader-&gt;OptionalHeader.MajorImageVersion &lt; 5) ||
05707             (NtHeader-&gt;OptionalHeader.MajorImageVersion &gt; 10)) {
05708             <span class="keywordflow">return</span>;
05709         }
05710     }
05711 
05712     NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (NtHeader-&gt;OptionalHeader.SizeOfImage);
05713 
05714     FileHeader = &amp;NtHeader-&gt;FileHeader;
05715 
05716     NumberOfSubsections = FileHeader-&gt;NumberOfSections;
05717 
05718     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfSubsections != 0);
05719 
05720     OffsetToSectionTable = <span class="keyword">sizeof</span>(ULONG) +
05721                               <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
05722                               FileHeader-&gt;SizeOfOptionalHeader;
05723 
05724     SectionTableEntry = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeader +
05725                             OffsetToSectionTable);
05726 
05727     <span class="comment">//</span>
05728     <span class="comment">// Verify the image contains subsections ordered by increasing virtual</span>
05729     <span class="comment">// address and that there are no overlaps.</span>
05730     <span class="comment">//</span>
05731 
05732     FirstPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05733     LastVirtualAddress = (ULONG_PTR)DllBase;
05734 
05735     <span class="keywordflow">for</span> ( ; NumberOfSubsections &gt; 0; NumberOfSubsections -= 1, SectionTableEntry += 1) {
05736 
05737         <span class="keywordflow">if</span> (SectionTableEntry-&gt;Misc.VirtualSize == 0) {
05738             SectionVirtualSize = SectionTableEntry-&gt;SizeOfRawData;
05739         }
05740         <span class="keywordflow">else</span> {
05741             SectionVirtualSize = SectionTableEntry-&gt;Misc.VirtualSize;
05742         }
05743 
05744         VirtualAddress = (ULONG_PTR)DllBase + SectionTableEntry-&gt;VirtualAddress;
05745         <span class="keywordflow">if</span> (VirtualAddress &lt;= LastVirtualAddress) {
05746 
05747             <span class="comment">//</span>
05748             <span class="comment">// Subsections are not in an increasing virtual address ordering.</span>
05749             <span class="comment">// No protection is provided for such a poorly linked image.</span>
05750             <span class="comment">//</span>
05751 
05752             KdPrint ((<span class="stringliteral">"MM:sysload - Image at %p is badly linked\n"</span>, DllBase));
05753             <span class="keywordflow">return</span>;
05754         }
05755         LastVirtualAddress = VirtualAddress + SectionVirtualSize - 1;
05756     }
05757 
05758     NumberOfSubsections = FileHeader-&gt;NumberOfSections;
05759     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfSubsections != 0);
05760 
05761     SectionTableEntry = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeader +
05762                             OffsetToSectionTable);
05763 
05764     LastVirtualAddress = 0;
05765 
05766     <span class="comment">//</span>
05767     <span class="comment">// Set writable PTE here so the image headers are excluded.  This is</span>
05768     <span class="comment">// needed so that locking down of sections can continue to edit the</span>
05769     <span class="comment">// image headers for counts.</span>
05770     <span class="comment">//</span>
05771 
05772     WritablePte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((ULONG_PTR)(SectionTableEntry + NumberOfSubsections) - 1);
05773     LastImagePte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(DllBase) + NumberOfPtes;
05774 
05775     <span class="keywordflow">for</span> ( ; NumberOfSubsections &gt; 0; NumberOfSubsections -= 1, SectionTableEntry += 1) {
05776 
05777         <span class="keywordflow">if</span> (SectionTableEntry-&gt;Misc.VirtualSize == 0) {
05778             SectionVirtualSize = SectionTableEntry-&gt;SizeOfRawData;
05779         }
05780         <span class="keywordflow">else</span> {
05781             SectionVirtualSize = SectionTableEntry-&gt;Misc.VirtualSize;
05782         }
05783 
05784         VirtualAddress = (ULONG_PTR)DllBase + SectionTableEntry-&gt;VirtualAddress;
05785 
05786         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
05787 
05788         <span class="keywordflow">if</span> (PointerPte &gt;= LastImagePte) {
05789 
05790             <span class="comment">//</span>
05791             <span class="comment">// Skip relocation subsections (which aren't given VA space).</span>
05792             <span class="comment">//</span>
05793 
05794             <span class="keywordflow">break</span>;
05795         }
05796 
05797         SectionProtection = (SectionTableEntry-&gt;Characteristics &amp; (IMAGE_SCN_MEM_WRITE | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_EXECUTE));
05798 
05799         <span class="keywordflow">if</span> (SectionProtection &amp; IMAGE_SCN_MEM_WRITE) {
05800 
05801             <span class="comment">//</span>
05802             <span class="comment">// This is a writable subsection, skip it.  Make sure if it's</span>
05803             <span class="comment">// sharing a PTE (and update the linker so this doesn't happen</span>
05804             <span class="comment">// for the kernel at least) that the last PTE isn't made</span>
05805             <span class="comment">// read only.</span>
05806             <span class="comment">//</span>
05807 
05808             WritablePte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress + SectionVirtualSize - 1);
05809 
05810             <span class="keywordflow">if</span> (LastVirtualAddress) {
05811                 LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (LastVirtualAddress);
05812 
05813                 <span class="keywordflow">if</span> (LastPte == PointerPte) {
05814                     LastPte -= 1;
05815                 }
05816 
05817                 <span class="keywordflow">if</span> (FirstPte &lt;= LastPte) {
05818 
05819                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte &lt; LastImagePte);
05820 
05821                     <span class="keywordflow">if</span> (LastPte &gt;= LastImagePte) {
05822                         LastPte = LastImagePte - 1;
05823                     }
05824 
05825                     <a class="code" href="../../d8/d8/sysload_8c.html#a63">MiSetSystemCodeProtection</a> (FirstPte, LastPte);
05826                 }
05827 
05828                 LastVirtualAddress = 0;
05829             }
05830             <span class="keywordflow">continue</span>;
05831         }
05832 
05833         <span class="keywordflow">if</span> (LastVirtualAddress == 0) {
05834 
05835             <span class="comment">//</span>
05836             <span class="comment">// There is no previous subsection or the previous</span>
05837             <span class="comment">// subsection was writable.  Thus the current starting PTE</span>
05838             <span class="comment">// could be mapping both a readonly and a readwrite</span>
05839             <span class="comment">// subsection if the image alignment is less than PAGE_SIZE.</span>
05840             <span class="comment">// These cases (in either order) are handled here.</span>
05841             <span class="comment">//</span>
05842 
05843             <span class="keywordflow">if</span> (PointerPte == WritablePte) {
05844                 LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress + SectionVirtualSize - 1);
05845                 <span class="keywordflow">if</span> (PointerPte == LastPte) {
05846 
05847                     <span class="comment">//</span>
05848                     <span class="comment">// Nothing can be protected in this subsection</span>
05849                     <span class="comment">// due to the image alignment specified for the executable.</span>
05850                     <span class="comment">//</span>
05851 
05852                     <span class="keywordflow">continue</span>;
05853                 }
05854                 PointerPte += 1;
05855             }
05856             FirstPte = PointerPte;
05857         }
05858 
05859         LastVirtualAddress = VirtualAddress + SectionVirtualSize - 1;
05860     }
05861 
05862     <span class="keywordflow">if</span> (LastVirtualAddress) {
05863         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (LastVirtualAddress);
05864 
05865         <span class="keywordflow">if</span> ((FirstPte &lt;= LastPte) &amp;&amp; (FirstPte &lt; LastImagePte)) {
05866 
05867             <span class="keywordflow">if</span> (LastPte &gt;= LastImagePte) {
05868                 LastPte = LastImagePte - 1;
05869             }
05870 
05871             <a class="code" href="../../d8/d8/sysload_8c.html#a63">MiSetSystemCodeProtection</a> (FirstPte, LastPte);
05872         }
05873     }
05874 }
05875 
05876 
05877 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05878"></a><a class="code" href="../../d8/d8/sysload_8c.html#a49">05878</a> <a class="code" href="../../d8/d8/sysload_8c.html#a49">MiUpdateThunks</a> (
05879     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock,
05880     IN PVOID OldAddress,
05881     IN PVOID NewAddress,
05882     IN ULONG NumberOfBytes
05883     )
05884 
05885 <span class="comment">/*++</span>
05886 <span class="comment"></span>
05887 <span class="comment">Routine Description:</span>
05888 <span class="comment"></span>
05889 <span class="comment">    This function updates the IATs of all the loaded modules in the system</span>
05890 <span class="comment">    to handle a newly relocated image.</span>
05891 <span class="comment"></span>
05892 <span class="comment">Arguments:</span>
05893 <span class="comment"></span>
05894 <span class="comment">    LoaderBlock - Supplies a pointer to the system loader block.</span>
05895 <span class="comment"></span>
05896 <span class="comment">    OldAddress - Supplies the old address of the DLL which was just relocated.</span>
05897 <span class="comment"></span>
05898 <span class="comment">    NewAddress - Supplies the new address of the DLL which was just relocated.</span>
05899 <span class="comment"></span>
05900 <span class="comment">    NumberOfBytes - Supplies the number of bytes spanned by the DLL.</span>
05901 <span class="comment"></span>
05902 <span class="comment">Return Value:</span>
05903 <span class="comment"></span>
05904 <span class="comment">    None.</span>
05905 <span class="comment"></span>
05906 <span class="comment">--*/</span>
05907 
05908 {
05909     PULONG_PTR ImportThunk;
05910     ULONG_PTR OldAddressHigh;
05911     ULONG_PTR AddressDifference;
05912     PLDR_DATA_TABLE_ENTRY DataTableEntry;
05913     PLIST_ENTRY NextEntry;
05914     ULONG_PTR i;
05915     ULONG ImportSize;
05916 
05917     <span class="comment">//</span>
05918     <span class="comment">// Note this routine must not call any modules outside the kernel.</span>
05919     <span class="comment">// This is because that module may itself be the one being relocated right</span>
05920     <span class="comment">// now.</span>
05921     <span class="comment">//</span>
05922 
05923     OldAddressHigh = (ULONG_PTR)((PCHAR)OldAddress + NumberOfBytes - 1);
05924     AddressDifference = (ULONG_PTR)NewAddress - (ULONG_PTR)OldAddress;
05925 
05926     NextEntry = LoaderBlock-&gt;LoadOrderListHead.Flink;
05927 
05928     <span class="keywordflow">for</span> ( ; NextEntry != &amp;LoaderBlock-&gt;LoadOrderListHead; NextEntry = NextEntry-&gt;Flink) {
05929 
05930         DataTableEntry = CONTAINING_RECORD(NextEntry,
05931                                            LDR_DATA_TABLE_ENTRY,
05932                                            InLoadOrderLinks);
05933 
05934         ImportThunk = (PULONG_PTR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
05935                                            DataTableEntry-&gt;DllBase,
05936                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
05937                                            IMAGE_DIRECTORY_ENTRY_IAT,
05938                                            &amp;ImportSize);
05939     
05940         <span class="keywordflow">if</span> (ImportThunk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05941             <span class="keywordflow">continue</span>;
05942         }
05943 
05944         ImportSize /= <span class="keyword">sizeof</span>(PULONG_PTR);
05945 
05946         <span class="keywordflow">for</span> (i = 0; i &lt; ImportSize; i += 1, ImportThunk += 1) {
05947             <span class="keywordflow">if</span> (*ImportThunk &gt;= (ULONG_PTR)OldAddress &amp;&amp; *ImportThunk &lt;= OldAddressHigh) {
05948                 *ImportThunk += AddressDifference;
05949             }
05950         }
05951     }
05952 }
05953 
05954 
05955 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05956"></a><a class="code" href="../../d8/d8/sysload_8c.html#a64">05956</a> <a class="code" href="../../d8/d8/sysload_8c.html#a64">MiReloadBootLoadedDrivers</a> (
05957     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
05958     )
05959 
05960 <span class="comment">/*++</span>
05961 <span class="comment"></span>
05962 <span class="comment">Routine Description:</span>
05963 <span class="comment"></span>
05964 <span class="comment">    The kernel, HAL and boot drivers are relocated by the loader.</span>
05965 <span class="comment">    All the boot drivers are then relocated again here.</span>
05966 <span class="comment"></span>
05967 <span class="comment">    This function relocates osloader-loaded images into system PTEs.  This</span>
05968 <span class="comment">    gives these images the benefits that all other drivers already enjoy,</span>
05969 <span class="comment">    including :</span>
05970 <span class="comment"></span>
05971 <span class="comment">    1. Paging of the drivers (this is more than 500K today).</span>
05972 <span class="comment">    2. Write-protection of their text sections.</span>
05973 <span class="comment">    3. Automatic unload of drivers on last dereference.</span>
05974 <span class="comment"></span>
05975 <span class="comment">    Note care must be taken when processing HIGHADJ relocations more than once.</span>
05976 <span class="comment"></span>
05977 <span class="comment">Arguments:</span>
05978 <span class="comment"></span>
05979 <span class="comment">    LoaderBlock - Supplies a pointer to the system loader block.</span>
05980 <span class="comment"></span>
05981 <span class="comment">Return Value:</span>
05982 <span class="comment"></span>
05983 <span class="comment">    None.</span>
05984 <span class="comment"></span>
05985 <span class="comment">Environment:</span>
05986 <span class="comment"></span>
05987 <span class="comment">    Kernel mode, Phase 0 Initialization.</span>
05988 <span class="comment"></span>
05989 <span class="comment">--*/</span>
05990 
05991 {
05992     PLDR_DATA_TABLE_ENTRY DataTableEntry;
05993     PLIST_ENTRY NextEntry;
05994     PIMAGE_NT_HEADERS NtHeader;
05995     PIMAGE_DATA_DIRECTORY DataDirectory;
05996     ULONG_PTR i;
05997     ULONG NumberOfPtes;
05998     ULONG NumberOfLoaderPtes;
05999     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
06000     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
06001     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LoaderPte;
06002     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
06003     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
06004     PVOID LoaderImageAddress;
06005     PVOID NewImageAddress;
06006     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06007     PFN_NUMBER PageFrameIndex;
06008     PFN_NUMBER PteFramePage;
06009     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PteFramePointer;
06010     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
06011     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
06012     KIRQL OldIrql;
06013     PCHAR RelocatedVa;
06014     PCHAR NonRelocatedVa;
06015     LOGICAL StopMoving;
06016 
06017 <span class="preprocessor">#if !defined (_X86_)</span>
06018 <span class="preprocessor"></span>
06019     <span class="comment">//</span>
06020     <span class="comment">// Non-x86 platforms have map registers so no memory shuffling is needed.</span>
06021     <span class="comment">//</span>
06022 
06023     <a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06024 <span class="preprocessor">#endif</span>
06025 <span class="preprocessor"></span>    StopMoving = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06026 
06027     i = 0;
06028     NextEntry = LoaderBlock-&gt;LoadOrderListHead.Flink;
06029 
06030     <span class="keywordflow">for</span> ( ; NextEntry != &amp;LoaderBlock-&gt;LoadOrderListHead; NextEntry = NextEntry-&gt;Flink) {
06031 
06032         <span class="comment">//</span>
06033         <span class="comment">// Skip the kernel and the HAL.  Note their relocation sections will</span>
06034         <span class="comment">// be automatically reclaimed.</span>
06035         <span class="comment">//</span>
06036 
06037         i += 1;
06038         <span class="keywordflow">if</span> (i &lt;= 2) {
06039             <span class="keywordflow">continue</span>;
06040         }
06041 
06042         DataTableEntry = CONTAINING_RECORD(NextEntry,
06043                                            LDR_DATA_TABLE_ENTRY,
06044                                            InLoadOrderLinks);
06045 
06046         <span class="comment">//</span>
06047         <span class="comment">// Ensure that the relocation section exists and that the loader</span>
06048         <span class="comment">// hasn't freed it already.</span>
06049         <span class="comment">//</span>
06050 
06051         NtHeader = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DataTableEntry-&gt;DllBase);
06052 
06053         <span class="keywordflow">if</span> (NtHeader == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06054             <span class="keywordflow">continue</span>;
06055         }
06056 
06057         <span class="keywordflow">if</span> (IMAGE_DIRECTORY_ENTRY_BASERELOC &gt;= NtHeader-&gt;OptionalHeader.NumberOfRvaAndSizes) {
06058             <span class="keywordflow">continue</span>;
06059         }
06060     
06061         DataDirectory = &amp;NtHeader-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC];
06062 
06063         <span class="keywordflow">if</span> (DataDirectory-&gt;VirtualAddress == 0) {
06064             <span class="keywordflow">continue</span>;
06065         }
06066 
06067         <span class="keywordflow">if</span> (DataDirectory-&gt;VirtualAddress + DataDirectory-&gt;Size &gt; DataTableEntry-&gt;SizeOfImage) {
06068 
06069             <span class="comment">//</span>
06070             <span class="comment">// The relocation section has already been freed, the user must</span>
06071             <span class="comment">// be using an old loader that didn't save the relocations.</span>
06072             <span class="comment">//</span>
06073 
06074             <span class="keywordflow">continue</span>;
06075         }
06076 
06077         LoaderImageAddress = DataTableEntry-&gt;DllBase;
06078         LoaderPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(DataTableEntry-&gt;DllBase);
06079         NumberOfLoaderPtes = (ULONG)((<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(DataTableEntry-&gt;SizeOfImage)) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
06080 
06081         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
06082 
06083         PointerPte = LoaderPte;
06084         LastPte = PointerPte + NumberOfLoaderPtes;
06085 
06086         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
06087             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
06088             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
06089             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
06090 
06091             <span class="comment">//</span>
06092             <span class="comment">// Mark the page as modified so boot drivers that call</span>
06093             <span class="comment">// MmPageEntireDriver don't lose their unmodified data !</span>
06094             <span class="comment">//</span>
06095         
06096             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
06097             PointerPte += 1;
06098         }
06099 
06100         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
06101 
06102         <span class="comment">//</span>
06103         <span class="comment">// Extra PTEs are allocated here to map the relocation section at the</span>
06104         <span class="comment">// new address so the image can be relocated.</span>
06105         <span class="comment">//</span>
06106 
06107         NumberOfPtes = NumberOfLoaderPtes;
06108 
06109         PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (NumberOfPtes,
06110                                           <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>,
06111                                           0,
06112                                           0,
06113                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06114 
06115         <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06116             <span class="keywordflow">continue</span>;
06117         }
06118 
06119         LastPte = PointerPte + NumberOfPtes;
06120 
06121         NewImageAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
06122 
06123 <span class="preprocessor">#if DBG_SYSLOAD</span>
06124 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Relocating %wZ from %p to %p, %x bytes\n"</span>,
06125                         &amp;DataTableEntry-&gt;FullDllName,
06126                         DataTableEntry-&gt;DllBase,
06127                         NewImageAddress,
06128                         DataTableEntry-&gt;SizeOfImage
06129                         );
06130 <span class="preprocessor">#endif</span>
06131 <span class="preprocessor"></span>
06132         <span class="comment">//</span>
06133         <span class="comment">// This assert is important because the assumption is made that PTEs</span>
06134         <span class="comment">// (not superpages) are mapping these drivers.</span>
06135         <span class="comment">//</span>
06136 
06137         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d1/init_8h.html#a21">InitializationPhase</a> == 0);
06138 
06139         <span class="comment">//</span>
06140         <span class="comment">// If the system is configured to make low memory available for ISA</span>
06141         <span class="comment">// type drivers, then copy the boot loaded drivers now.  Otherwise</span>
06142         <span class="comment">// only PTE adjustment is done.  Presumably some day when ISA goes</span>
06143         <span class="comment">// away this code can be removed.</span>
06144         <span class="comment">//</span>
06145 
06146         RelocatedVa = NewImageAddress;
06147         NonRelocatedVa = (PCHAR) DataTableEntry-&gt;DllBase;
06148 
06149         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
06150 
06151             PteContents = *LoaderPte;
06152             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
06153 
06154             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06155 <span class="preprocessor">#if DBG</span>
06156 <span class="preprocessor"></span>                PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (LoaderPte);
06157                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
06158                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
06159 <span class="preprocessor">#endif</span>
06160 <span class="preprocessor"></span>                <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
06161                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06162                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
06163                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (PointerPte));
06164 
06165                 <span class="keywordflow">if</span> (PageFrameIndex &lt; (16*1024*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
06166 
06167                     <span class="comment">//</span>
06168                     <span class="comment">// If the frames cannot be replaced with high pages</span>
06169                     <span class="comment">// then stop copying.</span>
06170                     <span class="comment">//</span>
06171 
06172 <span class="preprocessor">#if defined (_X86PAE_)</span>
06173 <span class="preprocessor"></span>                  <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
06174 <span class="preprocessor">#endif</span>
06175 <span class="preprocessor"></span>                    StopMoving = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06176                 }
06177 
06178                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
06179                                    PageFrameIndex,
06180                                    <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>,
06181                                    PointerPte);
06182 
06183                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
06184                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a137">MI_SET_ACCESSED_IN_PTE</a> (&amp;TempPte, 1);
06185                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
06186 
06187                 <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
06188                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
06189                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
06190 
06191                 <span class="comment">//</span>
06192                 <span class="comment">// Initialize the WsIndex just like the original page had it.</span>
06193                 <span class="comment">//</span>
06194 
06195                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = 0;
06196 
06197                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
06198                 RtlMoveMemory (RelocatedVa, NonRelocatedVa, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
06199                 RelocatedVa += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
06200                 NonRelocatedVa += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
06201             }
06202             <span class="keywordflow">else</span> {
06203                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
06204                                    PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber,
06205                                    <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>,
06206                                    PointerPte);
06207     
06208                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
06209             }
06210 
06211             PointerPte += 1;
06212             LoaderPte += 1;
06213         }
06214         PointerPte -= NumberOfPtes;
06215 
06216         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (*(PULONG)NewImageAddress == *(PULONG)LoaderImageAddress);
06217 
06218         <span class="comment">//</span>
06219         <span class="comment">// Image is now mapped at the new address.  Relocate it (again).</span>
06220         <span class="comment">//</span>
06221 
06222 <span class="preprocessor">#if defined(_ALPHA_)</span>
06223 <span class="preprocessor"></span>
06224         <span class="comment">//</span>
06225         <span class="comment">// HIGHADJ relocations need special re-processing.  This needs to be</span>
06226         <span class="comment">// done before resetting ImageBase.</span>
06227         <span class="comment">//</span>
06228 
06229         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d8/d8/sysload_8c.html#a29">LdrDoubleRelocateImage</a>(NewImageAddress,
06230                                             LoaderImageAddress,
06231                                             <span class="stringliteral">"SYSLDR"</span>,
06232                                             (ULONG)STATUS_SUCCESS,
06233                                             (ULONG)STATUS_CONFLICTING_ADDRESSES,
06234                                             (ULONG)STATUS_INVALID_IMAGE_FORMAT
06235                                             );
06236 <span class="preprocessor">#endif</span>
06237 <span class="preprocessor"></span>
06238         NtHeader-&gt;OptionalHeader.ImageBase = (ULONG_PTR)LoaderImageAddress;
06239         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06240             PIMAGE_NT_HEADERS NtHeader2;
06241 
06242             NtHeader2 = (PIMAGE_NT_HEADERS)((PCHAR)NtHeader + (RelocatedVa - NonRelocatedVa));
06243             NtHeader2-&gt;OptionalHeader.ImageBase = (ULONG_PTR)LoaderImageAddress;
06244         }
06245 
06246         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d0/d3/ldrreloc_8c.html#a5">LdrRelocateImage</a>(NewImageAddress,
06247                                             <span class="stringliteral">"SYSLDR"</span>,
06248                                             (ULONG)STATUS_SUCCESS,
06249                                             (ULONG)STATUS_CONFLICTING_ADDRESSES,
06250                                             (ULONG)STATUS_INVALID_IMAGE_FORMAT
06251                                             );
06252 
06253         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
06254 
06255             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06256                 <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
06257                     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
06258                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
06259                     <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
06260                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
06261                     <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
06262                     PointerPte += 1;
06263                 }
06264             }
06265 
06266             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
06267                                  NumberOfPtes,
06268                                  <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>);
06269 
06270             <span class="keywordflow">if</span> (StopMoving == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06271                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06272             }
06273 
06274             <span class="keywordflow">continue</span>;
06275         }
06276 
06277         <span class="comment">//</span>
06278         <span class="comment">// Update the IATs for all other loaded modules that reference this one.</span>
06279         <span class="comment">//</span>
06280 
06281         NonRelocatedVa = (PCHAR) DataTableEntry-&gt;DllBase;
06282         DataTableEntry-&gt;DllBase = NewImageAddress;
06283 
06284         <a class="code" href="../../d8/d8/sysload_8c.html#a49">MiUpdateThunks</a> (LoaderBlock,
06285                         LoaderImageAddress,
06286                         NewImageAddress,
06287                         DataTableEntry-&gt;SizeOfImage);
06288 
06289 
06290         <span class="comment">//</span>
06291         <span class="comment">// Update the loaded module list entry.</span>
06292         <span class="comment">//</span>
06293 
06294         DataTableEntry-&gt;Flags |= LDRP_SYSTEM_MAPPED;
06295         DataTableEntry-&gt;DllBase = NewImageAddress;
06296         DataTableEntry-&gt;EntryPoint =
06297             (PVOID)((PCHAR)NewImageAddress + NtHeader-&gt;OptionalHeader.AddressOfEntryPoint);
06298         DataTableEntry-&gt;SizeOfImage = NumberOfPtes &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
06299 
06300         <span class="comment">//</span>
06301         <span class="comment">// Update the PFNs of the image to support trimming.</span>
06302         <span class="comment">// Note that the loader addresses are freed now so no references</span>
06303         <span class="comment">// to it are permitted after this point.</span>
06304         <span class="comment">//</span>
06305 
06306         LoaderPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (NonRelocatedVa);
06307 
06308         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
06309 
06310         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
06311             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
06312 
06313             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06314                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LoaderPte-&gt;u.Hard.Valid == 1);
06315                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (LoaderPte);
06316                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
06317 
06318 <span class="preprocessor">#if defined (_X86_) || defined (_IA64_)</span>
06319 <span class="preprocessor"></span>
06320                 <span class="comment">//</span>
06321                 <span class="comment">// Decrement the share count on the original page table</span>
06322                 <span class="comment">// page so it can be freed.</span>
06323                 <span class="comment">//</span>
06324 
06325                 <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
06326 <span class="preprocessor">#endif</span>
06327 <span class="preprocessor"></span>
06328                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
06329                 <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
06330                 LoaderPte += 1;
06331             }
06332             <span class="keywordflow">else</span> {
06333 
06334                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
06335                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
06336 
06337 <span class="preprocessor">#if defined (_X86_) || defined (_IA64_)</span>
06338 <span class="preprocessor"></span>
06339                 <span class="comment">//</span>
06340                 <span class="comment">// Decrement the share count on the original page table</span>
06341                 <span class="comment">// page so it can be freed.</span>
06342                 <span class="comment">//</span>
06343 
06344                 <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
06345                 *Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
06346 <span class="preprocessor">#endif</span>
06347 <span class="preprocessor"></span>
06348                 <span class="comment">//</span>
06349                 <span class="comment">// Chain the PFN entry to its new page table.</span>
06350                 <span class="comment">//</span>
06351     
06352                 PteFramePointer = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte);
06353                 PteFramePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PteFramePointer);
06354     
06355                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PteFramePage;
06356                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
06357     
06358                 <span class="comment">//</span>
06359                 <span class="comment">// Increment the share count for the page table page that now</span>
06360                 <span class="comment">// contains the PTE that was copied.</span>
06361                 <span class="comment">//</span>
06362             
06363                 Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteFramePage);
06364                 Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
06365             }
06366 
06367             PointerPte += 1;
06368         }
06369 
06370         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
06371 
06372         <span class="comment">//</span>
06373         <span class="comment">// The physical pages mapping the relocation section are freed</span>
06374         <span class="comment">// later with the rest of the initialization code spanned by the</span>
06375         <span class="comment">// DataTableEntry-&gt;SizeOfImage.</span>
06376         <span class="comment">//</span>
06377 
06378         <span class="keywordflow">if</span> (StopMoving == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06379             <a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06380         }
06381     }
06382 <span class="preprocessor">#if defined (_X86PAE_)</span>
06383 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06384         <a class="code" href="../../d8/d8/sysload_8c.html#a52">MiRemoveLowPages</a> ();
06385     }
06386 <span class="preprocessor">#endif</span>
06387 <span class="preprocessor"></span>}
06388 
06389 <span class="preprocessor">#if defined (_X86_)</span>
06390 <span class="preprocessor"></span><a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> MiKernelResourceStartPte;
06391 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> MiKernelResourceEndPte;
06392 <span class="preprocessor">#endif</span>
06393 <span class="preprocessor"></span>
06394 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l06395"></a><a class="code" href="../../d8/d8/sysload_8c.html#a48">06395</a> <a class="code" href="../../d8/d8/sysload_8c.html#a48">MiLocateKernelSections</a> (
06396     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
06397     )
06398 
06399 <span class="comment">/*++</span>
06400 <span class="comment"></span>
06401 <span class="comment">Routine Description:</span>
06402 <span class="comment"></span>
06403 <span class="comment">    This function locates the resource section in the kernel so it can be</span>
06404 <span class="comment">    made readwrite if we bugcheck later, as the bugcheck code will write</span>
06405 <span class="comment">    into it.</span>
06406 <span class="comment"></span>
06407 <span class="comment">Arguments:</span>
06408 <span class="comment"></span>
06409 <span class="comment">    DataTableEntry - Supplies the kernel's data table entry.</span>
06410 <span class="comment"></span>
06411 <span class="comment">Return Value:</span>
06412 <span class="comment"></span>
06413 <span class="comment">    None.</span>
06414 <span class="comment"></span>
06415 <span class="comment">Environment:</span>
06416 <span class="comment"></span>
06417 <span class="comment">    Kernel mode, Phase 0 Initialization.</span>
06418 <span class="comment"></span>
06419 <span class="comment">--*/</span>
06420 
06421 {
06422     PVOID CurrentBase;
06423     PIMAGE_NT_HEADERS NtHeader;
06424     PIMAGE_SECTION_HEADER SectionTableEntry;
06425     LONG i;
06426     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
06427     PVOID SectionBaseAddress;
06428 
06429     CurrentBase = (PVOID)DataTableEntry-&gt;DllBase;
06430 
06431     NtHeader = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(CurrentBase);
06432 
06433     SectionTableEntry = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeader +
06434                             <span class="keyword">sizeof</span>(ULONG) +
06435                             <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
06436                             NtHeader-&gt;FileHeader.SizeOfOptionalHeader);
06437 
06438     <span class="comment">//</span>
06439     <span class="comment">// From the image header, locate the section named '.rsrc'.</span>
06440     <span class="comment">//</span>
06441 
06442     i = NtHeader-&gt;FileHeader.NumberOfSections;
06443 
06444     PointerPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06445 
06446     <span class="keywordflow">while</span> (i &gt; 0) {
06447 
06448         SectionBaseAddress = <a class="code" href="../../d4/d8/mi_8h.html#a217">SECTION_BASE_ADDRESS</a>(SectionTableEntry);
06449 
06450 <span class="preprocessor">#if defined (_X86_)</span>
06451 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (*(PULONG)SectionTableEntry-&gt;Name == 'rsr.') {
06452 
06453             MiKernelResourceStartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((ULONG_PTR)CurrentBase +
06454                                              SectionTableEntry-&gt;VirtualAddress);
06455 
06456             MiKernelResourceEndPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>((ULONG_PTR)CurrentBase +
06457                          SectionTableEntry-&gt;VirtualAddress +
06458                          (NtHeader-&gt;OptionalHeader.SectionAlignment - 1) +
06459                          SectionTableEntry-&gt;SizeOfRawData -
06460                          <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>));
06461             <span class="keywordflow">break</span>;
06462         }
06463 <span class="preprocessor">#endif</span>
06464 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (*(PULONG)SectionTableEntry-&gt;Name == 'LOOP') {
06465             <span class="keywordflow">if</span> (*(PULONG)&amp;SectionTableEntry-&gt;Name[4] == 'EDOC') {
06466                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a3">ExPoolCodeStart</a> = (PVOID)((ULONG_PTR)CurrentBase +
06467                                              SectionTableEntry-&gt;VirtualAddress);
06468                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a4">ExPoolCodeEnd</a> = (PVOID)((ULONG_PTR)CurrentBase +
06469                                              SectionTableEntry-&gt;VirtualAddress +
06470                                              SectionTableEntry-&gt;SizeOfRawData);
06471             }
06472             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)&amp;SectionTableEntry-&gt;Name[4] == 'IM') {
06473                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a5">MmPoolCodeStart</a> = (PVOID)((ULONG_PTR)CurrentBase +
06474                                              SectionTableEntry-&gt;VirtualAddress);
06475                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a6">MmPoolCodeEnd</a> = (PVOID)((ULONG_PTR)CurrentBase +
06476                                              SectionTableEntry-&gt;VirtualAddress +
06477                                              SectionTableEntry-&gt;SizeOfRawData);
06478             }
06479         }
06480         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((*(PULONG)SectionTableEntry-&gt;Name == 'YSIM') &amp;&amp;
06481                  (*(PULONG)&amp;SectionTableEntry-&gt;Name[4] == 'ETPS')) {
06482                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a7">MmPteCodeStart</a> = (PVOID)((ULONG_PTR)CurrentBase +
06483                                              SectionTableEntry-&gt;VirtualAddress);
06484                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a8">MmPteCodeEnd</a> = (PVOID)((ULONG_PTR)CurrentBase +
06485                                              SectionTableEntry-&gt;VirtualAddress +
06486                                              SectionTableEntry-&gt;SizeOfRawData);
06487         }
06488 
06489         i -= 1;
06490         SectionTableEntry += 1;
06491     }
06492 }
06493 
06494 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l06495"></a><a class="code" href="../../d8/d8/sysload_8c.html#a65">06495</a> <a class="code" href="../../d8/d8/sysload_8c.html#a65">MmMakeKernelResourceSectionWritable</a> (
06496     VOID
06497     )
06498 
06499 <span class="comment">/*++</span>
06500 <span class="comment"></span>
06501 <span class="comment">Routine Description:</span>
06502 <span class="comment"></span>
06503 <span class="comment">    This function makes the kernel's resource section readwrite so the bugcheck</span>
06504 <span class="comment">    code can write into it.</span>
06505 <span class="comment"></span>
06506 <span class="comment">Arguments:</span>
06507 <span class="comment"></span>
06508 <span class="comment">    None.</span>
06509 <span class="comment"></span>
06510 <span class="comment">Return Value:</span>
06511 <span class="comment"></span>
06512 <span class="comment">    None.</span>
06513 <span class="comment"></span>
06514 <span class="comment">Environment:</span>
06515 <span class="comment"></span>
06516 <span class="comment">    Kernel mode.  Any IRQL.</span>
06517 <span class="comment"></span>
06518 <span class="comment">--*/</span>
06519 
06520 {
06521 <span class="preprocessor">#if defined (_X86_)</span>
06522 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
06523     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
06524     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
06525 
06526     <span class="keywordflow">if</span> (MiKernelResourceStartPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06527         <span class="keywordflow">return</span>;
06528     }
06529 
06530     PointerPte = MiKernelResourceStartPte;
06531 
06532     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte))) {
06533 
06534         <span class="comment">//</span>
06535         <span class="comment">// Mapped physically, doesn't need to be made readwrite.</span>
06536         <span class="comment">//</span>
06537 
06538         <span class="keywordflow">return</span>;
06539     }
06540 
06541     <span class="comment">//</span>
06542     <span class="comment">// Since the entry state and IRQL are unknown, just go through the</span>
06543     <span class="comment">// PTEs without a lock and make them all readwrite.</span>
06544     <span class="comment">//</span>
06545 
06546     <span class="keywordflow">do</span> {
06547         PteContents = *PointerPte;
06548 <span class="preprocessor">#if defined(NT_UP)</span>
06549 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 0)
06550 <span class="preprocessor">#else</span>
06551 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Writable == 0)
06552 <span class="preprocessor">#endif</span>
06553 <span class="preprocessor"></span>        {
06554             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
06555                                PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber,
06556                                <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>,
06557                                PointerPte);
06558 <span class="preprocessor">#if !defined(NT_UP)</span>
06559 <span class="preprocessor"></span>            TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Writable = 1;
06560 <span class="preprocessor">#endif</span>
06561 <span class="preprocessor"></span>            <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a188">MI_WRITE_VALID_PTE_NEW_PROTECTION</a> (PointerPte, TempPte);
06562         }
06563         PointerPte += 1;
06564     } <span class="keywordflow">while</span> (PointerPte &lt;= MiKernelResourceEndPte); 
06565 
06566     <span class="comment">//</span>
06567     <span class="comment">// Don't do this more than once.</span>
06568     <span class="comment">//</span>
06569 
06570     MiKernelResourceStartPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06571 
06572     <span class="comment">//</span>
06573     <span class="comment">// Only flush this processor as the state of the others is unknown.</span>
06574     <span class="comment">//</span>
06575 
06576     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a> ();
06577 <span class="preprocessor">#endif</span>
06578 <span class="preprocessor"></span>}
06579 
06580 <span class="preprocessor">#ifdef i386</span>
06581 <span class="preprocessor"></span>PVOID <a class="code" href="../../d1/d9/ps_8h.html#a54">PsNtosImageBase</a> = (PVOID)0x80100000;
06582 <span class="preprocessor">#else</span>
<a name="l06583"></a><a class="code" href="../../d8/d8/sysload_8c.html#a26">06583</a> <span class="preprocessor"></span>PVOID <a class="code" href="../../d1/d9/ps_8h.html#a54">PsNtosImageBase</a>;
06584 <span class="preprocessor">#endif</span>
06585 <span class="preprocessor"></span>
<a name="l06586"></a><a class="code" href="../../d8/d8/sysload_8c.html#a27">06586</a> LIST_ENTRY <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>;
<a name="l06587"></a><a class="code" href="../../d8/d8/sysload_8c.html#a28">06587</a> <a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>;
06588 <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a18">PsLoadedModuleSpinLock</a>;
06589 
06590 LOGICAL
<a name="l06591"></a><a class="code" href="../../d8/d8/sysload_8c.html#a66">06591</a> <a class="code" href="../../d8/d8/sysload_8c.html#a66">MiInitializeLoadedModuleList</a> (
06592     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
06593     )
06594 
06595 <span class="comment">/*++</span>
06596 <span class="comment"></span>
06597 <span class="comment">Routine Description:</span>
06598 <span class="comment"></span>
06599 <span class="comment">    This function initializes the loaded module list based on the LoaderBlock.</span>
06600 <span class="comment"></span>
06601 <span class="comment">Arguments:</span>
06602 <span class="comment"></span>
06603 <span class="comment">    LoaderBlock - Supplies a pointer to the system loader block.</span>
06604 <span class="comment"></span>
06605 <span class="comment">Return Value:</span>
06606 <span class="comment"></span>
06607 <span class="comment">    None.</span>
06608 <span class="comment"></span>
06609 <span class="comment">Environment:</span>
06610 <span class="comment"></span>
06611 <span class="comment">    Kernel mode, Phase 0 Initialization.</span>
06612 <span class="comment"></span>
06613 <span class="comment">--*/</span>
06614 
06615 {
06616     PLIST_ENTRY NextEntry;
06617     PLDR_DATA_TABLE_ENTRY DataTableEntry1;
06618     PLDR_DATA_TABLE_ENTRY DataTableEntry2;
06619 
06620     <span class="comment">//</span>
06621     <span class="comment">// Initialize the loaded module list executive resource and spin lock.</span>
06622     <span class="comment">//</span>
06623 
06624     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>);
06625     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a18">PsLoadedModuleSpinLock</a>);
06626 
06627     InitializeListHead (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>);
06628 
06629     <span class="comment">//</span>
06630     <span class="comment">// Scan the loaded module list and allocate and initialize a data table</span>
06631     <span class="comment">// entry for each module. The data table entry is inserted in the loaded</span>
06632     <span class="comment">// module list and the initialization order list in the order specified</span>
06633     <span class="comment">// in the loader parameter block. The data table entry is inserted in the</span>
06634     <span class="comment">// memory order list in memory order.</span>
06635     <span class="comment">//</span>
06636 
06637     NextEntry = LoaderBlock-&gt;LoadOrderListHead.Flink;
06638     DataTableEntry2 = CONTAINING_RECORD(NextEntry,
06639                                         LDR_DATA_TABLE_ENTRY,
06640                                         InLoadOrderLinks);
06641     <a class="code" href="../../d1/d9/ps_8h.html#a54">PsNtosImageBase</a> = DataTableEntry2-&gt;DllBase;
06642 
06643     <a class="code" href="../../d8/d8/sysload_8c.html#a48">MiLocateKernelSections</a> (DataTableEntry2);
06644 
06645     <span class="keywordflow">while</span> (NextEntry != &amp;LoaderBlock-&gt;LoadOrderListHead) {
06646 
06647         DataTableEntry2 = CONTAINING_RECORD(NextEntry,
06648                                             LDR_DATA_TABLE_ENTRY,
06649                                             InLoadOrderLinks);
06650 
06651         <span class="comment">//</span>
06652         <span class="comment">// Allocate a data table entry.</span>
06653         <span class="comment">//</span>
06654 
06655         DataTableEntry1 = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
06656                                                  <span class="keyword">sizeof</span>(LDR_DATA_TABLE_ENTRY),
06657                                                  'dLmM');
06658 
06659         <span class="keywordflow">if</span> (DataTableEntry1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06660             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06661         }
06662 
06663         <span class="comment">//</span>
06664         <span class="comment">// Copy the data table entry.</span>
06665         <span class="comment">//</span>
06666 
06667         *DataTableEntry1 = *DataTableEntry2;
06668 
06669         DataTableEntry1-&gt;FullDllName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
06670             DataTableEntry2-&gt;FullDllName.MaximumLength + <span class="keyword">sizeof</span>(UNICODE_NULL),
06671             'TDmM');
06672 
06673         <span class="keywordflow">if</span> (DataTableEntry1-&gt;FullDllName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06674             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DataTableEntry1);
06675             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06676         }
06677 
06678         DataTableEntry1-&gt;BaseDllName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
06679             DataTableEntry2-&gt;BaseDllName.MaximumLength + <span class="keyword">sizeof</span>(UNICODE_NULL),
06680             'dLmM');
06681 
06682         <span class="keywordflow">if</span> (DataTableEntry1-&gt;BaseDllName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06683             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DataTableEntry1-&gt;FullDllName.Buffer);
06684             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DataTableEntry1);
06685             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06686         }
06687 
06688         <span class="comment">//</span>
06689         <span class="comment">// Copy the strings.</span>
06690         <span class="comment">//</span>
06691 
06692         RtlMoveMemory (DataTableEntry1-&gt;FullDllName.Buffer,
06693                        DataTableEntry2-&gt;FullDllName.Buffer,
06694                        DataTableEntry1-&gt;FullDllName.MaximumLength);
06695 
06696         RtlMoveMemory (DataTableEntry1-&gt;BaseDllName.Buffer,
06697                        DataTableEntry2-&gt;BaseDllName.Buffer,
06698                        DataTableEntry1-&gt;BaseDllName.MaximumLength);
06699 
06700         <span class="comment">//</span>
06701         <span class="comment">// Insert the data table entry in the load order list in the order</span>
06702         <span class="comment">// they are specified.</span>
06703         <span class="comment">//</span>
06704 
06705         InsertTailList(&amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>,
06706                        &amp;DataTableEntry1-&gt;InLoadOrderLinks);
06707 
06708         NextEntry = NextEntry-&gt;Flink;
06709     }
06710 
06711     <a class="code" href="../../d8/d8/sysload_8c.html#a38">MiBuildImportsForBootDrivers</a> ();
06712 
06713     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06714 }
06715 
06716 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l06717"></a><a class="code" href="../../d8/d8/sysload_8c.html#a67">06717</a> <a class="code" href="../../d8/d8/sysload_8c.html#a67">MmCallDllInitialize</a>(
06718     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
06719 )
06720 
06721 <span class="comment">/*++</span>
06722 <span class="comment"></span>
06723 <span class="comment">Routine Description:</span>
06724 <span class="comment"></span>
06725 <span class="comment">    This function calls the DLL's initialize routine.</span>
06726 <span class="comment"></span>
06727 <span class="comment">Arguments:</span>
06728 <span class="comment"></span>
06729 <span class="comment">    DataTableEntry - Supplies the kernel's data table entry.</span>
06730 <span class="comment"></span>
06731 <span class="comment">Return Value:</span>
06732 <span class="comment"></span>
06733 <span class="comment">    Various NTSTATUS error codes.</span>
06734 <span class="comment"></span>
06735 <span class="comment">Environment:</span>
06736 <span class="comment"></span>
06737 <span class="comment">    Kernel mode.</span>
06738 <span class="comment"></span>
06739 <span class="comment">--*/</span>
06740 
06741 {
06742     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
06743     PWCHAR Dot;
06744     <a class="code" href="../../d2/d1/mm_8h.html#a157">PMM_DLL_INITIALIZE</a> Func;
06745     UNICODE_STRING RegistryPath;
06746     UNICODE_STRING ImportName;
06747 
06748     Func = <a class="code" href="../../d8/d8/sysload_8c.html#a44">MiLocateExportName</a> (DataTableEntry-&gt;DllBase, <span class="stringliteral">"DllInitialize"</span>);
06749 
06750     <span class="keywordflow">if</span> (!Func) {
06751         <span class="keywordflow">return</span> STATUS_SUCCESS;
06752     }
06753 
06754     ImportName.MaximumLength = DataTableEntry-&gt;BaseDllName.Length;
06755     ImportName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
06756                                                ImportName.MaximumLength,
06757                                                'TDmM');
06758 
06759     <span class="keywordflow">if</span> (ImportName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06760         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06761     }
06762 
06763     ImportName.Length = DataTableEntry-&gt;BaseDllName.Length;
06764     RtlMoveMemory (ImportName.Buffer,
06765                    DataTableEntry-&gt;BaseDllName.Buffer,
06766                    ImportName.Length);
06767 
06768     RegistryPath.MaximumLength = <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length +
06769                                     ImportName.Length +
06770                                     (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(2*<span class="keyword">sizeof</span>(WCHAR));
06771 
06772     RegistryPath.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
06773                                                  RegistryPath.MaximumLength,
06774                                                  'TDmM');
06775 
06776     <span class="keywordflow">if</span> (RegistryPath.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06777         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportName.Buffer);
06778         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06779     }
06780 
06781     RegistryPath.Length = <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length;
06782     RtlMoveMemory (RegistryPath.Buffer,
06783                    <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Buffer,
06784                    <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length);
06785 
06786     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a> (&amp;RegistryPath, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
06787     Dot = wcschr (ImportName.Buffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span>);
06788     <span class="keywordflow">if</span> (Dot) {
06789         ImportName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((Dot - ImportName.Buffer) * <span class="keyword">sizeof</span>(WCHAR));
06790     }
06791 
06792     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a> (&amp;RegistryPath, &amp;ImportName);
06793     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportName.Buffer);
06794 
06795     <span class="comment">//</span>
06796     <span class="comment">// Invoke the DLL's initialization routine.</span>
06797     <span class="comment">//</span>
06798 
06799     st = Func (&amp;RegistryPath);
06800 
06801     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (RegistryPath.Buffer);
06802 
06803     <span class="keywordflow">return</span> st;
06804 }
06805 
06806 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
06807 PVOID
<a name="l06808"></a><a class="code" href="../../d8/d8/sysload_8c.html#a68">06808</a> <a class="code" href="../../d8/d8/sysload_8c.html#a68">MmGetSystemRoutineAddress</a> (
06809     IN PUNICODE_STRING SystemRoutineName
06810 )
06811 
06812 <span class="comment">/*++</span>
06813 <span class="comment"></span>
06814 <span class="comment">Routine Description:</span>
06815 <span class="comment"></span>
06816 <span class="comment">    This function returns the address of the argument function pointer if</span>
06817 <span class="comment">    it is in the kernel or HAL, NULL if it is not.</span>
06818 <span class="comment"></span>
06819 <span class="comment">Arguments:</span>
06820 <span class="comment"></span>
06821 <span class="comment">    SystemRoutineName - Supplies the name of the desired routine.</span>
06822 <span class="comment"></span>
06823 <span class="comment">Return Value:</span>
06824 <span class="comment"></span>
06825 <span class="comment">    Non-NULL function pointer if successful.  NULL if not.</span>
06826 <span class="comment"></span>
06827 <span class="comment">Environment:</span>
06828 <span class="comment"></span>
06829 <span class="comment">    Kernel mode.</span>
06830 <span class="comment"></span>
06831 <span class="comment">--*/</span>
06832 
06833 {
06834     ULONG AnsiLength;
06835     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06836     PLDR_DATA_TABLE_ENTRY DataTableEntry;
06837     ANSI_STRING AnsiString;
06838     PLIST_ENTRY NextEntry;
06839     UNICODE_STRING KernelString;
06840     UNICODE_STRING HalString;
06841     PVOID FunctionAddress;
06842     LOGICAL Found;
06843     ULONG EntriesChecked;
06844 
06845     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == <a class="code" href="../../d1/d3/ppcdef_8h.html#a21">PASSIVE_LEVEL</a>);
06846 
06847     EntriesChecked = 0;
06848     FunctionAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06849 
06850     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;KernelString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ntoskrnl.exe"</span>);
06851     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;HalString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"hal.dll"</span>);
06852 
06853     <span class="keywordflow">do</span> {
06854         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;AnsiString,
06855                                                SystemRoutineName,
06856                                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
06857     
06858         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
06859             <span class="keywordflow">break</span>;
06860         }
06861 
06862         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
06863 
06864     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
06865     
06866     <span class="comment">//</span>
06867     <span class="comment">// Arbitrary process context so prevent suspend APCs now.</span>
06868     <span class="comment">//</span>
06869 
06870     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
06871     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
06872 
06873     <span class="comment">//</span>
06874     <span class="comment">// Check only the kernel and the HAL for exports.</span>
06875     <span class="comment">//</span>
06876 
06877     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
06878     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
06879 
06880         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06881 
06882         DataTableEntry = CONTAINING_RECORD(NextEntry,
06883                                            LDR_DATA_TABLE_ENTRY,
06884                                            InLoadOrderLinks);
06885 
06886         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;KernelString,
06887                                    &amp;DataTableEntry-&gt;BaseDllName,
06888                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06889 
06890             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06891             EntriesChecked += 1;
06892 
06893         }
06894         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;HalString,
06895                                         &amp;DataTableEntry-&gt;BaseDllName,
06896                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
06897 
06898             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06899             EntriesChecked += 1;
06900         }
06901 
06902         <span class="keywordflow">if</span> (Found == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06903 
06904             FunctionAddress = <a class="code" href="../../d8/d8/sysload_8c.html#a51">MiFindExportedRoutineByName</a> (DataTableEntry,
06905                                                            &amp;AnsiString);
06906 
06907             <span class="keywordflow">if</span> (FunctionAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06908                 <span class="keywordflow">break</span>;
06909             }
06910 
06911             <span class="keywordflow">if</span> (EntriesChecked == 2) {
06912                 <span class="keywordflow">break</span>;
06913             }
06914         }
06915 
06916         NextEntry = NextEntry-&gt;Flink;
06917     }
06918 
06919     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>);
06920     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
06921 
06922     <a class="code" href="../../d6/d6/nls_8c.html#a35">RtlFreeAnsiString</a> (&amp;AnsiString);
06923 
06924     <span class="keywordflow">return</span> FunctionAddress;
06925 }
06926 
06927 PVOID
<a name="l06928"></a><a class="code" href="../../d8/d8/sysload_8c.html#a51">06928</a> <a class="code" href="../../d8/d8/sysload_8c.html#a51">MiFindExportedRoutineByName</a>(
06929     IN PLDR_DATA_TABLE_ENTRY DataTableEntry,
06930     IN PANSI_STRING AnsiImageRoutineName
06931     )
06932 
06933 <span class="comment">/*++</span>
06934 <span class="comment"></span>
06935 <span class="comment">Routine Description:</span>
06936 <span class="comment"></span>
06937 <span class="comment">    This function snaps a thunk using the specified Export Section data.</span>
06938 <span class="comment">    If the section data does not support the thunk, then the thunk is</span>
06939 <span class="comment">    partially snapped (Dll field is still non-null, but snap address is</span>
06940 <span class="comment">    set).</span>
06941 <span class="comment"></span>
06942 <span class="comment">Arguments:</span>
06943 <span class="comment"></span>
06944 <span class="comment">    DllBase - Base of DLL being snapped to.</span>
06945 <span class="comment"></span>
06946 <span class="comment">    ImageBase - Base of image that contains the thunks to snap.</span>
06947 <span class="comment"></span>
06948 <span class="comment">    Thunk - On input, supplies the thunk to snap.  When successfully</span>
06949 <span class="comment">        snapped, the function field is set to point to the address in</span>
06950 <span class="comment">        the DLL, and the DLL field is set to NULL.</span>
06951 <span class="comment"></span>
06952 <span class="comment">    ExportDirectory - Supplies the Export Section data from a DLL.</span>
06953 <span class="comment"></span>
06954 <span class="comment">    SnapForwarder - determine if the snap is for a forwarder, and therefore</span>
06955 <span class="comment">       Address of Data is already setup.</span>
06956 <span class="comment"></span>
06957 <span class="comment">Return Value:</span>
06958 <span class="comment"></span>
06959 <span class="comment"></span>
06960 <span class="comment">    STATUS_SUCCESS or STATUS_DRIVER_ENTRYPOINT_NOT_FOUND or</span>
06961 <span class="comment">        STATUS_DRIVER_ORDINAL_NOT_FOUND</span>
06962 <span class="comment"></span>
06963 <span class="comment">--*/</span>
06964 
06965 {
06966     PCHAR DllBase;
06967     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> OrdinalNumber;
06968     PULONG NameTableBase;
06969     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> NameOrdinalTableBase;
06970     PULONG Addr;
06971     ULONG High;
06972     ULONG Low;
06973     ULONG Middle;
06974     LONG Result;
06975     ULONG ExportSize;
06976     PVOID FunctionAddress;
06977     PIMAGE_EXPORT_DIRECTORY ExportDirectory;
06978 
06979     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06980 
06981     DllBase = DataTableEntry-&gt;DllBase;
06982 
06983     ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
06984                                 DllBase,
06985                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
06986                                 IMAGE_DIRECTORY_ENTRY_EXPORT,
06987                                 &amp;ExportSize
06988                                 );
06989 
06990     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ExportDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06991 
06992     <span class="comment">//</span>
06993     <span class="comment">// Initialize the pointer to the array of RVA-based ansi export strings.</span>
06994     <span class="comment">//</span>
06995 
06996     NameTableBase = (PULONG)(DllBase + (ULONG)ExportDirectory-&gt;AddressOfNames);
06997 
06998     <span class="comment">//</span>
06999     <span class="comment">// Initialize the pointer to the array of USHORT ordinal numbers.</span>
07000     <span class="comment">//</span>
07001 
07002     NameOrdinalTableBase = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(DllBase + (ULONG)ExportDirectory-&gt;AddressOfNameOrdinals);
07003 
07004     <span class="comment">//</span>
07005     <span class="comment">// Lookup the desired name in the name table using a binary search.</span>
07006     <span class="comment">//</span>
07007 
07008     Low = 0;
07009     High = ExportDirectory-&gt;NumberOfNames - 1;
07010 
07011     <span class="keywordflow">while</span> (High &gt;= Low) {
07012 
07013         <span class="comment">//</span>
07014         <span class="comment">// Compute the next probe index and compare the import name</span>
07015         <span class="comment">// with the export name entry.</span>
07016         <span class="comment">//</span>
07017 
07018         Middle = (Low + High) &gt;&gt; 1;
07019 
07020         Result = strcmp(AnsiImageRoutineName-&gt;Buffer,
07021                         (PCHAR)(DllBase + NameTableBase[Middle]));
07022 
07023         <span class="keywordflow">if</span> (Result &lt; 0) {
07024             High = Middle - 1;
07025         }
07026         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Result &gt; 0) {
07027             Low = Middle + 1;
07028         }
07029         <span class="keywordflow">else</span> {
07030             <span class="keywordflow">break</span>;
07031         }
07032     }
07033 
07034     <span class="comment">//</span>
07035     <span class="comment">// If the high index is less than the low index, then a matching</span>
07036     <span class="comment">// table entry was not found. Otherwise, get the ordinal number</span>
07037     <span class="comment">// from the ordinal table.</span>
07038     <span class="comment">//</span>
07039 
07040     <span class="keywordflow">if</span> (High &lt; Low) {
07041         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07042     }
07043 
07044     OrdinalNumber = NameOrdinalTableBase[Middle];
07045 
07046     <span class="comment">//</span>
07047     <span class="comment">// If the OrdinalNumber is not within the Export Address Table,</span>
07048     <span class="comment">// then this image does not implement the function.  Return not found.</span>
07049     <span class="comment">//</span>
07050 
07051     <span class="keywordflow">if</span> ((ULONG)OrdinalNumber &gt;= ExportDirectory-&gt;NumberOfFunctions) {
07052         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07053     }
07054 
07055     <span class="comment">//</span>
07056     <span class="comment">// Index into the array of RVA export addresses by ordinal number.</span>
07057     <span class="comment">//</span>
07058 
07059     Addr = (PULONG)(DllBase + (ULONG)ExportDirectory-&gt;AddressOfFunctions);
07060 
07061     FunctionAddress = (PVOID)(DllBase + Addr[OrdinalNumber]);
07062 
07063     <span class="comment">//</span>
07064     <span class="comment">// Forwarders are not used by the kernel and HAL to each other.</span>
07065     <span class="comment">//</span>
07066 
07067     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((FunctionAddress &lt;= (PVOID)ExportDirectory) ||
07068             (FunctionAddress &gt;= (PVOID)((PCHAR)ExportDirectory + ExportSize)));
07069 
07070     <span class="keywordflow">return</span> FunctionAddress;
07071 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:56 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
