<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: arbiter.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>arbiter.c</h1><a href="../../d8/d8/arbiter_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1997  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    arbiter.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains support routines for the Pnp resource arbiters.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Andrew Thornton (andrewth) 1-April-1997</span>
00016 <span class="comment"></span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d9/arbp_8h.html">arbp.h</a>"</span>
00027 
00028 <span class="comment">//</span>
00029 <span class="comment">// Conditional compilation constants</span>
00030 <span class="comment">//</span>
00031 
<a name="l00032"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a0">00032</a> <span class="preprocessor">#define ALLOW_BOOT_ALLOC_CONFLICTS      1</span>
<a name="l00033"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a1">00033</a> <span class="preprocessor"></span><span class="preprocessor">#define PLUG_FEST_HACKS                 0</span>
00034 <span class="preprocessor"></span>
00035 <span class="comment">//</span>
00036 <span class="comment">// Pool Tags</span>
00037 <span class="comment">//</span>
00038 
<a name="l00039"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a2">00039</a> <span class="preprocessor">#define ARBITER_ALLOCATION_STATE_TAG    'AbrA'</span>
<a name="l00040"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a3">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define ARBITER_ORDERING_LIST_TAG       'LbrA'</span>
<a name="l00041"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a4">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define ARBITER_MISC_TAG                'MbrA'</span>
<a name="l00042"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a5">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define ARBITER_RANGE_LIST_TAG          'RbrA'</span>
<a name="l00043"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a6">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define ARBITER_CONFLICT_INFO_TAG       'CbrA'</span>
00044 <span class="preprocessor"></span>
00045 <span class="comment">//</span>
00046 <span class="comment">// Constants</span>
00047 <span class="comment">//</span>
00048 
<a name="l00049"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a7">00049</a> <span class="preprocessor">#define PATH_ARBITERS            L"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Arbiters"</span>
<a name="l00050"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a8">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define KEY_ALLOCATIONORDER      L"AllocationOrder"</span>
<a name="l00051"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a9">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define KEY_RESERVEDRESOURCES    L"ReservedResources"</span>
<a name="l00052"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a10">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define ARBITER_ORDERING_GROW_SIZE  8</span>
00053 <span class="preprocessor"></span>
00054 
00055 <span class="comment">//</span>
00056 <span class="comment">// Macros</span>
00057 <span class="comment">//</span>
00058 
00059 <span class="comment">//</span>
00060 <span class="comment">// PVOID</span>
00061 <span class="comment">// FULL_INFO_DATA(</span>
00062 <span class="comment">//    IN PKEY_VALUE_FULL_INFORMATION k</span>
00063 <span class="comment">// );</span>
00064 <span class="comment">//</span>
00065 <span class="comment">// This macro returns the pointer to the beginning of the data area of a</span>
00066 <span class="comment">// KEY_VALUE_FULL_INFORMATION structure.</span>
00067 <span class="comment">//</span>
00068 
<a name="l00069"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a11">00069</a> <span class="preprocessor">#define FULL_INFO_DATA(k) ((PCHAR)(k) + (k)-&gt;DataOffset)</span>
00070 <span class="preprocessor"></span>
00071 <span class="comment">//</span>
00072 <span class="comment">// BOOLEAN</span>
00073 <span class="comment">// DISJOINT(</span>
00074 <span class="comment">//      IN ULONGLONG s1,</span>
00075 <span class="comment">//      IN ULONGLONG e1,</span>
00076 <span class="comment">//      IN ULONGLONG s2,</span>
00077 <span class="comment">//      IN ULONGLONG e2</span>
00078 <span class="comment">//      );</span>
00079 <span class="comment">//</span>
<a name="l00080"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a12">00080</a> <span class="preprocessor">#define DISJOINT(s1,e1,s2,e2)                                           \</span>
00081 <span class="preprocessor">    ( ((s1) &lt; (s2) &amp;&amp; (e1) &lt; (s2))                                      \</span>
00082 <span class="preprocessor">    ||((s2) &lt; (s1) &amp;&amp; (e2) &lt; (s1)) )</span>
00083 <span class="preprocessor"></span>
00084 <span class="comment">//</span>
00085 <span class="comment">// VOID</span>
00086 <span class="comment">// ArbpWstrToUnicodeString(</span>
00087 <span class="comment">//      IN PUNICODE_STRING u,</span>
00088 <span class="comment">//      IN PWSTR p</span>
00089 <span class="comment">//      );</span>
00090 <span class="comment">//</span>
00091 
<a name="l00092"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a13">00092</a> <span class="preprocessor">#define ArbpWstrToUnicodeString(u, p)                                   \</span>
00093 <span class="preprocessor">    (u)-&gt;Length = ((u)-&gt;MaximumLength =                                 \</span>
00094 <span class="preprocessor">        (USHORT) (sizeof((p))) - sizeof(WCHAR));                        \</span>
00095 <span class="preprocessor">    (u)-&gt;Buffer = (p)</span>
00096 <span class="preprocessor"></span>
00097 <span class="comment">//</span>
00098 <span class="comment">// ULONG</span>
00099 <span class="comment">// INDEX_FROM_PRIORITY(</span>
00100 <span class="comment">//     LONG Priority</span>
00101 <span class="comment">// );</span>
00102 <span class="comment">//</span>
00103 
<a name="l00104"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a14">00104</a> <span class="preprocessor">#define ORDERING_INDEX_FROM_PRIORITY(P)                                 \</span>
00105 <span class="preprocessor">    ( (ULONG) ( (P) &gt; 0 ? (P) - 1 : ((P) * -1) - 1) )</span>
00106 <span class="preprocessor"></span>
00107 <span class="comment">//</span>
00108 <span class="comment">// Prototypes</span>
00109 <span class="comment">//</span>
00110 
00111 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00112 <a class="code" href="../../d8/d8/arbiter_8c.html#a16">ArbpBuildAllocationStack</a>(
00113     IN <a class="code" href="../../d9/d8/arbiter_8h.html#a39">PARBITER_INSTANCE</a> Arbiter,
00114     IN PLIST_ENTRY ArbitrationList,
00115     IN ULONG ArbitrationListCount
00116     );
00117 
00118 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00119 <a class="code" href="../../d8/d8/arbiter_8c.html#a17">ArbpGetRegistryValue</a>(
00120     IN HANDLE KeyHandle,
00121     IN PWSTR  ValueName,
00122     OUT PKEY_VALUE_FULL_INFORMATION *Information
00123     );
00124 
00125 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00126 <a class="code" href="../../d8/d8/arbiter_8c.html#a18">ArbpBuildAlternative</a>(
00127     IN PARBITER_INSTANCE Arbiter,
00128     IN PIO_RESOURCE_DESCRIPTOR Requirement,
00129     OUT <a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html">PARBITER_ALTERNATIVE</a> Alternative
00130     );
00131 
00132 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00133 <a class="code" href="../../d8/d8/arbiter_8c.html#a19">ArbpUpdatePriority</a>(
00134     PARBITER_INSTANCE Arbiter,
00135     <a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html">PARBITER_ALTERNATIVE</a> Alternative
00136     );
00137 
00138 BOOLEAN
00139 <a class="code" href="../../d8/d8/arbiter_8c.html#a20">ArbpQueryConflictCallback</a>(
00140     IN PVOID Context,
00141     IN PRTL_RANGE Range
00142     );
00143 
00144 <span class="comment">//</span>
00145 <span class="comment">// Make everything pageable</span>
00146 <span class="comment">//</span>
00147 
00148 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00149 <span class="preprocessor"></span>
00150 <span class="preprocessor">#if ARB_DBG</span>
00151 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbpDumpArbiterInstance)</span>
00152 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbpDumpArbiterRange)</span>
00153 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbpDumpArbitrationList)</span>
00154 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00155 <span class="preprocessor"></span>
00156 <span class="preprocessor">#pragma alloc_text(PAGE, ArbInitializeArbiterInstance)</span>
00157 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbDeleteArbiterInstance)</span>
00158 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbArbiterHandler)</span>
00159 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbStartArbiter)</span>
00160 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbTestAllocation)</span>
00161 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbRetestAllocation)</span>
00162 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbCommitAllocation)</span>
00163 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbRollbackAllocation)</span>
00164 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbAddReserved)</span>
00165 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbPreprocessEntry)</span>
00166 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbAllocateEntry)</span>
00167 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbSortArbitrationList)</span>
00168 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbBacktrackAllocation)</span>
00169 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbGetNextAllocationRange)</span>
00170 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbFindSuitableRange)</span>
00171 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbAddAllocation)</span>
00172 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbQueryConflict)</span>
00173 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbInitializeOrderingList)</span>
00174 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbCopyOrderingList)</span>
00175 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbPruneOrdering)</span>
00176 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbAddOrdering)</span>
00177 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbFreeOrderingList)</span>
00178 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbBuildAssignmentOrdering)</span>
00179 <span class="preprocessor"></span>
00180 <span class="preprocessor">#pragma alloc_text(PAGE, ArbpGetRegistryValue)</span>
00181 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbpBuildAllocationStack)</span>
00182 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbpBuildAlternative)</span>
00183 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ArbpQueryConflictCallback)</span>
00184 <span class="preprocessor"></span><span class="preprocessor">#endif // ALLOC_PRAGMA</span>
00185 <span class="preprocessor"></span>
00186 <span class="comment">//</span>
00187 <span class="comment">// Implementation</span>
00188 <span class="comment">//</span>
00189 
00190 
00191 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00192"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a67">00192</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a67">ArbInitializeArbiterInstance</a>(
00193     OUT PARBITER_INSTANCE Arbiter,
00194     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> BusDeviceObject,
00195     IN CM_RESOURCE_TYPE ResourceType,
00196     IN PWSTR Name,
00197     IN PWSTR OrderingName,
00198     IN <a class="code" href="../../d9/d8/arbiter_8h.html#a61">PARBITER_TRANSLATE_ALLOCATION_ORDER</a> TranslateOrdering OPTIONAL
00199     )
00200 
00201 <span class="comment">/*++</span>
00202 <span class="comment"></span>
00203 <span class="comment">Routine Description:</span>
00204 <span class="comment"></span>
00205 <span class="comment">    This routine initializes an arbiter instance and fills in any optional NULL</span>
00206 <span class="comment">    dispatch table entries with system default functions.</span>
00207 <span class="comment"></span>
00208 <span class="comment">Parameters:</span>
00209 <span class="comment"></span>
00210 <span class="comment">    Arbiter - A caller allocated arbiter instance structure.</span>
00211 <span class="comment">        The UnpackRequirement, PackResource, UnpackResource and ScoreRequirement</span>
00212 <span class="comment">        entries should be initialized with the appropriate routines as should</span>
00213 <span class="comment">        any other entries if the default system routines are not sufficient.</span>
00214 <span class="comment"></span>
00215 <span class="comment">    BusDeviceObject - The device object that exposes this arbiter - normally an</span>
00216 <span class="comment">        FDO.</span>
00217 <span class="comment"></span>
00218 <span class="comment">    ResourceType - The resource type this arbiter arbitrates.</span>
00219 <span class="comment"></span>
00220 <span class="comment">    Name - A string used to identify the arbiter, used in debug messages and</span>
00221 <span class="comment">        for registry storage</span>
00222 <span class="comment"></span>
00223 <span class="comment">    OrderingName - The name of the preferred assignment ordering list under</span>
00224 <span class="comment">        HKLM\System\CurrentControlSet\Control\SystemResources\AssignmentOrdering</span>
00225 <span class="comment"></span>
00226 <span class="comment"></span>
00227 <span class="comment">    TranslateOrdering - Function that, if present, will be called to translate</span>
00228 <span class="comment">        each descriptor from the ordering list</span>
00229 <span class="comment"></span>
00230 <span class="comment">Return Value:</span>
00231 <span class="comment"></span>
00232 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00233 <span class="comment"></span>
00234 <span class="comment">Notes:</span>
00235 <span class="comment"></span>
00236 <span class="comment"></span>
00237 <span class="comment">--*/</span>
00238 
00239 {
00240     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00241 
00242     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00243 
00244     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Arbiter-&gt;UnpackRequirement);
00245     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Arbiter-&gt;PackResource);
00246     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Arbiter-&gt;UnpackResource);
00247 
00248     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,(<span class="stringliteral">"Initializing %S Arbiter...\n"</span>, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>));
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">// Initialize all pool allocation pointers to NULL so we can cleanup</span>
00252     <span class="comment">//</span>
00253 
00254     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Arbiter-&gt;MutexEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00255            &amp;&amp; Arbiter-&gt;Allocation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00256            &amp;&amp; Arbiter-&gt;PossibleAllocation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00257            &amp;&amp; Arbiter-&gt;AllocationStack == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00258            );
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// We are an arbiter</span>
00262     <span class="comment">//</span>
00263 
00264     Arbiter-&gt;Signature = <a class="code" href="../../d9/d8/arbiter_8h.html#a17">ARBITER_INSTANCE_SIGNATURE</a>;
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">// Remember the bus that produced us</span>
00268     <span class="comment">//</span>
00269 
00270     Arbiter-&gt;BusDeviceObject = BusDeviceObject;
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">// Initialize state lock (KEVENT must be non-paged)</span>
00274     <span class="comment">//</span>
00275 
00276     Arbiter-&gt;MutexEvent = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00277                                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>),
00278                                                 <a class="code" href="../../d8/d8/arbiter_8c.html#a4">ARBITER_MISC_TAG</a>
00279                                                 );
00280 
00281     <span class="keywordflow">if</span> (!Arbiter-&gt;MutexEvent) {
00282         status = STATUS_INSUFFICIENT_RESOURCES;
00283         <span class="keywordflow">goto</span> cleanup;
00284     }
00285 
00286     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(Arbiter-&gt;MutexEvent, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00287 
00288     <span class="comment">//</span>
00289     <span class="comment">// Initialize the allocation stack to a reasonable size</span>
00290     <span class="comment">//</span>
00291 
00292     Arbiter-&gt;AllocationStack = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00293                                                      <a class="code" href="../../d9/d8/arbiter_8h.html#a16">INITIAL_ALLOCATION_STATE_SIZE</a>,
00294                                                      <a class="code" href="../../d8/d8/arbiter_8c.html#a2">ARBITER_ALLOCATION_STATE_TAG</a>
00295                                                      );
00296 
00297     <span class="keywordflow">if</span> (!Arbiter-&gt;AllocationStack) {
00298         status = STATUS_INSUFFICIENT_RESOURCES;
00299         <span class="keywordflow">goto</span> cleanup;
00300     }
00301 
00302     Arbiter-&gt;AllocationStackMaxSize = <a class="code" href="../../d9/d8/arbiter_8h.html#a16">INITIAL_ALLOCATION_STATE_SIZE</a>;
00303 
00304 
00305     <span class="comment">//</span>
00306     <span class="comment">// Allocate buffers to hold the range lists</span>
00307     <span class="comment">//</span>
00308 
00309     Arbiter-&gt;Allocation = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00310                                                 <span class="keyword">sizeof</span>(RTL_RANGE_LIST),
00311                                                 <a class="code" href="../../d8/d8/arbiter_8c.html#a5">ARBITER_RANGE_LIST_TAG</a>
00312                                                 );
00313 
00314     <span class="keywordflow">if</span> (!Arbiter-&gt;Allocation) {
00315         status = STATUS_INSUFFICIENT_RESOURCES;
00316         <span class="keywordflow">goto</span> cleanup;
00317     }
00318 
00319     Arbiter-&gt;PossibleAllocation = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00320                                                         <span class="keyword">sizeof</span>(RTL_RANGE_LIST),
00321                                                         <a class="code" href="../../d8/d8/arbiter_8c.html#a5">ARBITER_RANGE_LIST_TAG</a>
00322                                                         );
00323 
00324     <span class="keywordflow">if</span> (!Arbiter-&gt;PossibleAllocation) {
00325         status = STATUS_INSUFFICIENT_RESOURCES;
00326         <span class="keywordflow">goto</span> cleanup;
00327     }
00328 
00329     <span class="comment">//</span>
00330     <span class="comment">// Initialize the range lists</span>
00331     <span class="comment">//</span>
00332 
00333     <a class="code" href="../../d2/d5/range_8c.html#a15">RtlInitializeRangeList</a>(Arbiter-&gt;Allocation);
00334     <a class="code" href="../../d2/d5/range_8c.html#a15">RtlInitializeRangeList</a>(Arbiter-&gt;PossibleAllocation);
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">// Initialize the data fields</span>
00338     <span class="comment">//</span>
00339     Arbiter-&gt;TransactionInProgress = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00340     Arbiter-&gt;Name = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00341     Arbiter-&gt;ResourceType = ResourceType;
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">// If the caller has not supplied the optional functions set them to the</span>
00345     <span class="comment">// defaults (If this were C++ we'd just inherit this loit but seeing as its</span>
00346     <span class="comment">// not we'll do it the old fashioned way...)</span>
00347     <span class="comment">//</span>
00348 
00349     <span class="keywordflow">if</span> (!Arbiter-&gt;TestAllocation) {
00350         Arbiter-&gt;TestAllocation = <a class="code" href="../../d8/d8/arbiter_8c.html#a25">ArbTestAllocation</a>;
00351     }
00352 
00353     <span class="keywordflow">if</span> (!Arbiter-&gt;RetestAllocation) {
00354         Arbiter-&gt;RetestAllocation = <a class="code" href="../../d8/d8/arbiter_8c.html#a29">ArbRetestAllocation</a>;
00355     }
00356 
00357     <span class="keywordflow">if</span> (!Arbiter-&gt;CommitAllocation) {
00358         Arbiter-&gt;CommitAllocation = <a class="code" href="../../d8/d8/arbiter_8c.html#a27">ArbCommitAllocation</a>;
00359     }
00360 
00361     <span class="keywordflow">if</span> (!Arbiter-&gt;RollbackAllocation) {
00362         Arbiter-&gt;RollbackAllocation = <a class="code" href="../../d8/d8/arbiter_8c.html#a28">ArbRollbackAllocation</a>;
00363     }
00364 
00365     <span class="keywordflow">if</span> (!Arbiter-&gt;AddReserved) {
00366         Arbiter-&gt;AddReserved = <a class="code" href="../../d8/d8/arbiter_8c.html#a45">ArbAddReserved</a>;
00367     }
00368 
00369     <span class="keywordflow">if</span> (!Arbiter-&gt;PreprocessEntry) {
00370         Arbiter-&gt;PreprocessEntry = <a class="code" href="../../d8/d8/arbiter_8c.html#a36">ArbPreprocessEntry</a>;
00371     }
00372 
00373     <span class="keywordflow">if</span> (!Arbiter-&gt;AllocateEntry) {
00374         Arbiter-&gt;AllocateEntry = <a class="code" href="../../d8/d8/arbiter_8c.html#a37">ArbAllocateEntry</a>;
00375     }
00376 
00377     <span class="keywordflow">if</span> (!Arbiter-&gt;GetNextAllocationRange) {
00378         Arbiter-&gt;GetNextAllocationRange = <a class="code" href="../../d8/d8/arbiter_8c.html#a38">ArbGetNextAllocationRange</a>;
00379     }
00380 
00381     <span class="keywordflow">if</span> (!Arbiter-&gt;FindSuitableRange) {
00382         Arbiter-&gt;FindSuitableRange = <a class="code" href="../../d8/d8/arbiter_8c.html#a33">ArbFindSuitableRange</a>;
00383     }
00384 
00385     <span class="keywordflow">if</span> (!Arbiter-&gt;AddAllocation) {
00386         Arbiter-&gt;AddAllocation = <a class="code" href="../../d8/d8/arbiter_8c.html#a34">ArbAddAllocation</a>;
00387     }
00388 
00389     <span class="keywordflow">if</span> (!Arbiter-&gt;BacktrackAllocation) {
00390         Arbiter-&gt;BacktrackAllocation = <a class="code" href="../../d8/d8/arbiter_8c.html#a35">ArbBacktrackAllocation</a>;
00391     }
00392 
00393     <span class="keywordflow">if</span> (!Arbiter-&gt;OverrideConflict) {
00394         Arbiter-&gt;OverrideConflict = <a class="code" href="../../d8/d8/arbiter_8c.html#a44">ArbOverrideConflict</a>;
00395     }
00396 
00397     <span class="keywordflow">if</span> (!Arbiter-&gt;BootAllocation) {
00398         Arbiter-&gt;BootAllocation = <a class="code" href="../../d8/d8/arbiter_8c.html#a30">ArbBootAllocation</a>;
00399     }
00400 
00401     <span class="keywordflow">if</span> (!Arbiter-&gt;QueryConflict) {
00402         Arbiter-&gt;QueryConflict = <a class="code" href="../../d8/d8/arbiter_8c.html#a46">ArbQueryConflict</a>;
00403     }
00404 
00405     <span class="keywordflow">if</span> (!Arbiter-&gt;StartArbiter) {
00406         Arbiter-&gt;StartArbiter = <a class="code" href="../../d8/d8/arbiter_8c.html#a47">ArbStartArbiter</a>;
00407     }
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">// Build the prefered assignment ordering - we assume that the reserved</span>
00411     <span class="comment">// ranges have the same name as the assignment ordering</span>
00412     <span class="comment">//</span>
00413 
00414     status = <a class="code" href="../../d9/d8/arbiter_8h.html#a87">ArbBuildAssignmentOrdering</a>(Arbiter,
00415                                         OrderingName,
00416                                         OrderingName,
00417                                         TranslateOrdering
00418                                         );
00419 
00420     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00421         <span class="keywordflow">goto</span> cleanup;
00422     }
00423 
00424     <span class="keywordflow">return</span> STATUS_SUCCESS;
00425 
00426 cleanup:
00427 
00428     <span class="keywordflow">if</span> (Arbiter-&gt;MutexEvent) {
00429         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Arbiter-&gt;MutexEvent);
00430     }
00431 
00432     <span class="keywordflow">if</span> (Arbiter-&gt;Allocation) {
00433         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Arbiter-&gt;Allocation);
00434     }
00435 
00436     <span class="keywordflow">if</span> (Arbiter-&gt;PossibleAllocation) {
00437         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Arbiter-&gt;PossibleAllocation);
00438     }
00439 
00440     <span class="keywordflow">if</span> (Arbiter-&gt;AllocationStack) {
00441         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Arbiter-&gt;AllocationStack);
00442     }
00443 
00444     <span class="keywordflow">return</span> status;
00445 
00446 }
00447 
00448 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00449"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a22">00449</a> <a class="code" href="../../d8/d8/arbiter_8c.html#a22">ArbReferenceArbiterInstance</a>(
00450     IN PARBITER_INSTANCE Arbiter
00451     )
00452 {
00453     InterlockedIncrement(&amp;Arbiter-&gt;ReferenceCount);
00454 }
00455 
00456 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00457"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a23">00457</a> <a class="code" href="../../d8/d8/arbiter_8c.html#a23">ArbDereferenceArbiterInstance</a>(
00458     IN PARBITER_INSTANCE Arbiter
00459     )
00460 {
00461     InterlockedDecrement(&amp;Arbiter-&gt;ReferenceCount);
00462 
00463     <span class="keywordflow">if</span> (Arbiter-&gt;ReferenceCount == 0) {
00464         <a class="code" href="../../d9/d8/arbiter_8h.html#a68">ArbDeleteArbiterInstance</a>(Arbiter);
00465     }
00466 }
00467 
00468 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00469"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a68">00469</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a68">ArbDeleteArbiterInstance</a>(
00470     IN PARBITER_INSTANCE Arbiter
00471     )
00472 {
00473 
00474     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00475 
00476     <span class="keywordflow">if</span> (Arbiter-&gt;MutexEvent) {
00477         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Arbiter-&gt;MutexEvent);
00478     }
00479 
00480     <span class="keywordflow">if</span> (Arbiter-&gt;Allocation) {
00481         <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(Arbiter-&gt;Allocation);
00482         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Arbiter-&gt;Allocation);
00483     }
00484 
00485     <span class="keywordflow">if</span> (Arbiter-&gt;PossibleAllocation) {
00486         <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(Arbiter-&gt;PossibleAllocation);
00487         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Arbiter-&gt;PossibleAllocation);
00488     }
00489 
00490     <span class="keywordflow">if</span> (Arbiter-&gt;AllocationStack) {
00491         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Arbiter-&gt;AllocationStack);
00492     }
00493 
00494     <a class="code" href="../../d9/d8/arbiter_8h.html#a63">ArbFreeOrderingList</a>(&amp;Arbiter-&gt;OrderingList);
00495     <a class="code" href="../../d9/d8/arbiter_8h.html#a63">ArbFreeOrderingList</a>(&amp;Arbiter-&gt;ReservedList);
00496 
00497 <span class="preprocessor">#if ARB_DBG</span>
00498 <span class="preprocessor"></span>
00499     RtlFillMemory(Arbiter, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html">ARBITER_INSTANCE</a>), <span class="charliteral">'A'</span>);
00500 
00501 <span class="preprocessor">#endif</span>
00502 <span class="preprocessor"></span>
00503 }
00504 
00505 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00506"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a70">00506</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a70">ArbTestAllocation</a>(
00507     IN PARBITER_INSTANCE Arbiter,
00508     IN OUT PLIST_ENTRY ArbitrationList
00509     )
00510 
00511 <span class="comment">/*++</span>
00512 <span class="comment"></span>
00513 <span class="comment">Routine Description:</span>
00514 <span class="comment"></span>
00515 <span class="comment">    This is the default implementation of the arbiter Test Allocation action.</span>
00516 <span class="comment">    It takes a list of requests for resources for particular devices and attempts</span>
00517 <span class="comment">    to satisfy them.</span>
00518 <span class="comment"></span>
00519 <span class="comment">Parameters:</span>
00520 <span class="comment"></span>
00521 <span class="comment">    Arbiter - The instance of the arbiter being called.</span>
00522 <span class="comment"></span>
00523 <span class="comment">    ArbitrationList - A list of ARBITER_LIST_ENTRY entries which contain the</span>
00524 <span class="comment">        requirements and associated devices.</span>
00525 <span class="comment"></span>
00526 <span class="comment">Return Value:</span>
00527 <span class="comment"></span>
00528 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00529 <span class="comment">    These include:</span>
00530 <span class="comment"></span>
00531 <span class="comment">    STATUS_SUCCESSFUL - Arbitration suceeded and an allocation has been made for</span>
00532 <span class="comment">        all the entries in the arbitration list.</span>
00533 <span class="comment"></span>
00534 <span class="comment">    STATUS_UNSUCCESSFUL - Arbitration failed to find an allocation for all</span>
00535 <span class="comment">        entries.</span>
00536 <span class="comment"></span>
00537 <span class="comment">    STATUS_ARBITRATION_UNHANDLED - If returning this error the arbiter is</span>
00538 <span class="comment">        partial (and therefore must have set the ARBITER_PARTIAL flag in its</span>
00539 <span class="comment">        interface.)  This status indicates that this arbiter doesn't handle the</span>
00540 <span class="comment">        resources requested and the next arbiter towards the root of the device</span>
00541 <span class="comment">        tree should be asked instead.</span>
00542 <span class="comment"></span>
00543 <span class="comment">--*/</span>
00544 
00545 {
00546 
00547     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00548     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> current;
00549     PIO_RESOURCE_DESCRIPTOR alternative;
00550     ULONG count;
00551     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> previousOwner;
00552     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> currentOwner;
00553     LONG score;
00554     BOOLEAN performScoring;
00555 
00556     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00557     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Arbiter);
00558 
00559     <span class="comment">//</span>
00560     <span class="comment">// Copy the current allocation</span>
00561     <span class="comment">//</span>
00562 
00563     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(3, (<span class="stringliteral">"Copy current allocation\n"</span>));
00564     status = <a class="code" href="../../d2/d5/range_8c.html#a19">RtlCopyRangeList</a>(Arbiter-&gt;PossibleAllocation, Arbiter-&gt;Allocation);
00565 
00566     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00567         <span class="keywordflow">goto</span> cleanup;
00568     }
00569 
00570     <span class="comment">//</span>
00571     <span class="comment">// Free all the resources currently allocated to all the devices we</span>
00572     <span class="comment">// are arbitrating for</span>
00573     <span class="comment">//</span>
00574 
00575     count = 0;
00576     previousOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00577 
00578     <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">ARBITER_LIST_ENTRY</a>, ArbitrationList, current) {
00579 
00580         count++;
00581 
00582         currentOwner = current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>;
00583 
00584         <span class="keywordflow">if</span> (previousOwner != currentOwner) {
00585 
00586             previousOwner = currentOwner;
00587 
00588             <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(3,
00589                         (<span class="stringliteral">"Delete 0x%08x's resources\n"</span>,
00590                         currentOwner
00591                         ));
00592 
00593             status = <a class="code" href="../../d2/d5/range_8c.html#a18">RtlDeleteOwnersRanges</a>(Arbiter-&gt;PossibleAllocation,
00594                                            (PVOID)currentOwner
00595                                            );
00596 
00597             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00598                 <span class="keywordflow">goto</span> cleanup;
00599             }
00600         }
00601 
00602         <span class="comment">//</span>
00603         <span class="comment">// Score the entries in the arbitration list if a scoring function was</span>
00604         <span class="comment">// provided and this is not a legacy request (which is guaranteed to be</span>
00605         <span class="comment">// made of all fixed requests so sorting is pointless)</span>
00606         <span class="comment">//</span>
00607 
00608         performScoring = Arbiter-&gt;ScoreRequirement != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00609         <span class="comment">// BUGBUG - fix for rebalance being broken and not passing in flags...</span>
00610         <span class="comment">// &amp;&amp; !LEGACY_REQUEST(current);</span>
00611         current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o6">WorkSpace</a> = 0;
00612 
00613         <span class="keywordflow">if</span> (performScoring) {
00614 
00615             <a class="code" href="../../d1/d5/translate_8c.html#a1">FOR_ALL_IN_ARRAY</a>(current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o2">Alternatives</a>,
00616                              current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a>,
00617                              alternative) {
00618 
00619                 <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(3,
00620                             (<span class="stringliteral">"Scoring entry %p\n"</span>,
00621                             currentOwner
00622                             ));
00623 
00624 
00625 
00626                 score = Arbiter-&gt;ScoreRequirement(alternative);
00627 
00628                 <span class="comment">//</span>
00629                 <span class="comment">// Ensure the score is valid</span>
00630                 <span class="comment">//</span>
00631 
00632                 <span class="keywordflow">if</span> (score &lt; 0) {
00633                     status = STATUS_DEVICE_CONFIGURATION_ERROR;
00634                     <span class="keywordflow">goto</span> cleanup;
00635                 }
00636 
00637                 current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o6">WorkSpace</a> += score;
00638             }
00639         }
00640     }
00641 
00642     status = <a class="code" href="../../d9/d8/arbiter_8h.html#a77">ArbSortArbitrationList</a>(ArbitrationList);
00643 
00644     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00645         <span class="keywordflow">goto</span> cleanup;
00646     }
00647 
00648     <span class="comment">//</span>
00649     <span class="comment">// Build the arbitration stack</span>
00650     <span class="comment">//</span>
00651 
00652     status = <a class="code" href="../../d8/d8/arbiter_8c.html#a16">ArbpBuildAllocationStack</a>(Arbiter,
00653                                      ArbitrationList,
00654                                      count
00655                                      );
00656 
00657     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00658         <span class="keywordflow">goto</span> cleanup;
00659     }
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">// Attempt allocation</span>
00663     <span class="comment">//</span>
00664 
00665     status = Arbiter-&gt;AllocateEntry(Arbiter, Arbiter-&gt;AllocationStack);
00666 
00667     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00668 
00669         <span class="comment">//</span>
00670         <span class="comment">// Success.</span>
00671         <span class="comment">//</span>
00672 
00673         <span class="keywordflow">return</span> status;
00674     }
00675 
00676 cleanup:
00677 
00678     <span class="comment">//</span>
00679     <span class="comment">// We didn't succeed so empty the possible allocation list...</span>
00680     <span class="comment">//</span>
00681 
00682     <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(Arbiter-&gt;PossibleAllocation);
00683 
00684     <span class="keywordflow">return</span> status;
00685 }
00686 
00687 
00688 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00689"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a18">00689</a> <a class="code" href="../../d8/d8/arbiter_8c.html#a18">ArbpBuildAlternative</a>(
00690     IN PARBITER_INSTANCE Arbiter,
00691     IN PIO_RESOURCE_DESCRIPTOR Requirement,
00692     OUT <a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html">PARBITER_ALTERNATIVE</a> Alternative
00693     )
00694 
00695 <span class="comment">/*++</span>
00696 <span class="comment"></span>
00697 <span class="comment">Routine Description:</span>
00698 <span class="comment"></span>
00699 <span class="comment">    This routine initializes a arbiter alternative from a given resource</span>
00700 <span class="comment">    requirement descriptor</span>
00701 <span class="comment"></span>
00702 <span class="comment">Parameters:</span>
00703 <span class="comment"></span>
00704 <span class="comment">    Arbiter - The arbiter instance data where the allocation stack should be</span>
00705 <span class="comment">        placed.</span>
00706 <span class="comment"></span>
00707 <span class="comment">    Requirement - The requirement descriptor describing this requirement</span>
00708 <span class="comment"></span>
00709 <span class="comment">    Alternative - The alternative to be initialized</span>
00710 <span class="comment"></span>
00711 <span class="comment">Return Value:</span>
00712 <span class="comment"></span>
00713 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00714 <span class="comment"></span>
00715 <span class="comment">--*/</span>
00716 
00717 {
00718 
00719     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00720 
00721     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00722     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Alternative &amp;&amp; Requirement);
00723 
00724     Alternative-&gt;Descriptor = Requirement;
00725 
00726     <span class="comment">//</span>
00727     <span class="comment">// Unpack the requirement into the alternatives table</span>
00728     <span class="comment">//</span>
00729 
00730     status = Arbiter-&gt;UnpackRequirement(Requirement,
00731                                         &amp;Alternative-&gt;Minimum,
00732                                         &amp;Alternative-&gt;Maximum,
00733                                         &amp;Alternative-&gt;Length,
00734                                         &amp;Alternative-&gt;Alignment
00735                                         );
00736 
00737     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00738         <span class="keywordflow">goto</span> cleanup;
00739     }
00740 
00741     <span class="comment">//</span>
00742     <span class="comment">// Align the minimum if necessary</span>
00743     <span class="comment">//</span>
00744 
00745     <span class="keywordflow">if</span> (Alternative-&gt;Minimum % Alternative-&gt;Alignment != 0) {
00746         <a class="code" href="../../d9/d8/arbiter_8h.html#a4">ALIGN_ADDRESS_UP</a>(Alternative-&gt;Minimum,
00747                          Alternative-&gt;Alignment
00748                          );
00749     }
00750 
00751     Alternative-&gt;Flags = 0;
00752 
00753     <span class="comment">//</span>
00754     <span class="comment">// Check if this alternative is shared</span>
00755     <span class="comment">//</span>
00756 
00757     <span class="keywordflow">if</span>(Requirement-&gt;ShareDisposition == CmResourceShareShared) {
00758         Alternative-&gt;Flags |= <a class="code" href="../../d9/d8/arbiter_8h.html#a6">ARBITER_ALTERNATIVE_FLAG_SHARED</a>;
00759     }
00760 
00761     <span class="comment">//</span>
00762     <span class="comment">// Check if this alternative is fixed</span>
00763     <span class="comment">//</span>
00764 
00765     <span class="keywordflow">if</span> (Alternative-&gt;Maximum - Alternative-&gt;Minimum + 1 == Alternative-&gt;Length) {
00766         Alternative-&gt;Flags |= <a class="code" href="../../d9/d8/arbiter_8h.html#a7">ARBITER_ALTERNATIVE_FLAG_FIXED</a>;
00767     }
00768 
00769     <span class="comment">//</span>
00770     <span class="comment">// Check for validity</span>
00771     <span class="comment">//</span>
00772 
00773     <span class="keywordflow">if</span> (Alternative-&gt;Maximum &lt; Alternative-&gt;Minimum) {
00774         Alternative-&gt;Flags |= <a class="code" href="../../d9/d8/arbiter_8h.html#a8">ARBITER_ALTERNATIVE_FLAG_INVALID</a>;
00775     }
00776 
00777     <span class="keywordflow">return</span> STATUS_SUCCESS;
00778 
00779 cleanup:
00780 
00781     <span class="keywordflow">return</span> status;
00782 }
00783 
00784 
00785 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00786"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a16">00786</a> <a class="code" href="../../d8/d8/arbiter_8c.html#a16">ArbpBuildAllocationStack</a>(
00787     IN PARBITER_INSTANCE Arbiter,
00788     IN PLIST_ENTRY ArbitrationList,
00789     IN ULONG ArbitrationListCount
00790     )
00791 
00792 <span class="comment">/*++</span>
00793 <span class="comment"></span>
00794 <span class="comment">Routine Description:</span>
00795 <span class="comment"></span>
00796 <span class="comment">    This routine initializes the allocation stack for the requests in</span>
00797 <span class="comment">    ArbitrationList.  It overwrites any previous allocation stack and allocates</span>
00798 <span class="comment">    additional memory if more is required.  Arbiter-&gt;AllocationStack contains</span>
00799 <span class="comment">    the initialized stack on success.</span>
00800 <span class="comment"></span>
00801 <span class="comment">Parameters:</span>
00802 <span class="comment"></span>
00803 <span class="comment">    Arbiter - The arbiter instance data where the allocation stack should be</span>
00804 <span class="comment">        placed.</span>
00805 <span class="comment"></span>
00806 <span class="comment">    ArbitrationList - A list of ARBITER_LIST_ENTRY entries which contain the</span>
00807 <span class="comment">        requirements and associated devices.</span>
00808 <span class="comment"></span>
00809 <span class="comment">    ArbitrationListCount - The number of entries in the ArbitrationList</span>
00810 <span class="comment"></span>
00811 <span class="comment">Return Value:</span>
00812 <span class="comment"></span>
00813 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00814 <span class="comment"></span>
00815 <span class="comment">--*/</span>
00816 
00817 {
00818     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00819     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> currentEntry;
00820     <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> currentState;
00821     ULONG stackSize = 0, allocationCount = ArbitrationListCount + 1;
00822     <a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html">PARBITER_ALTERNATIVE</a> currentAlternative;
00823     PIO_RESOURCE_DESCRIPTOR currentDescriptor;
00824 
00825     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00826 
00827     <span class="comment">//</span>
00828     <span class="comment">// Calculate the size the stack needs to be and the</span>
00829     <span class="comment">//</span>
00830 
00831     <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">ARBITER_LIST_ENTRY</a>, ArbitrationList, currentEntry) {
00832 
00833         <span class="keywordflow">if</span> (currentEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a> &gt; 0) {
00834             stackSize += currentEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a>
00835                             * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html">ARBITER_ALTERNATIVE</a>);
00836         } <span class="keywordflow">else</span> {
00837             allocationCount--;
00838         }
00839     }
00840 
00841     stackSize += allocationCount * <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">ARBITER_ALLOCATION_STATE</a>);
00842 
00843     <span class="comment">//</span>
00844     <span class="comment">// Make sure the allocation stack is large enough</span>
00845     <span class="comment">//</span>
00846 
00847     <span class="keywordflow">if</span> (Arbiter-&gt;AllocationStackMaxSize &lt; stackSize) {
00848 
00849         <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> temp;
00850 
00851         <span class="comment">//</span>
00852         <span class="comment">// Enlarge the allocation stack</span>
00853         <span class="comment">//</span>
00854 
00855         temp = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00856                                      stackSize,
00857                                      <a class="code" href="../../d8/d8/arbiter_8c.html#a2">ARBITER_ALLOCATION_STATE_TAG</a>
00858                                      );
00859         <span class="keywordflow">if</span> (!temp) {
00860             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00861         }
00862 
00863         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Arbiter-&gt;AllocationStack);
00864         Arbiter-&gt;AllocationStack = temp;
00865     }
00866 
00867     RtlZeroMemory(Arbiter-&gt;AllocationStack, stackSize);
00868 
00869     <span class="comment">//</span>
00870     <span class="comment">// Fill in the locations</span>
00871     <span class="comment">//</span>
00872 
00873     currentState = Arbiter-&gt;AllocationStack;
00874     currentAlternative = (<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html">PARBITER_ALTERNATIVE</a>) (Arbiter-&gt;AllocationStack
00875         + ArbitrationListCount + 1);
00876 
00877     <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">ARBITER_LIST_ENTRY</a>, ArbitrationList, currentEntry) {
00878 
00879         <span class="comment">//</span>
00880         <span class="comment">// Do we need to allocate anything for this entry?</span>
00881         <span class="comment">//</span>
00882 
00883         <span class="keywordflow">if</span> (currentEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a> &gt; 0) {
00884 
00885             <span class="comment">//</span>
00886             <span class="comment">// Initialize the stack location</span>
00887             <span class="comment">//</span>
00888 
00889             currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a> = currentEntry;
00890             currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o6">AlternativeCount</a> = currentEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a>;
00891             currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o7">Alternatives</a> = currentAlternative;
00892 
00893             <span class="comment">//</span>
00894             <span class="comment">// Initialize the start and end values to an invalid range so</span>
00895             <span class="comment">// that we don't skip the range 0-0 every time...</span>
00896             <span class="comment">//</span>
00897 
00898             currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a> = 1;
00899             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a> == 0);  <span class="comment">// From RtlZeroMemory</span>
00900 
00901             <span class="comment">//</span>
00902             <span class="comment">// Initialize the alternatives table</span>
00903             <span class="comment">//</span>
00904 
00905             <a class="code" href="../../d1/d5/translate_8c.html#a1">FOR_ALL_IN_ARRAY</a>(currentEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o2">Alternatives</a>,
00906                              currentEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a>,
00907                              currentDescriptor) {
00908 
00909 
00910                 status = <a class="code" href="../../d8/d8/arbiter_8c.html#a18">ArbpBuildAlternative</a>(Arbiter,
00911                                             currentDescriptor,
00912                                             currentAlternative
00913                                             );
00914 
00915                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00916                     <span class="keywordflow">goto</span> cleanup;
00917                 }
00918 
00919                 <span class="comment">//</span>
00920                 <span class="comment">// Initialize the priority</span>
00921                 <span class="comment">//</span>
00922 
00923                 currentAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a> = <a class="code" href="../../d9/d8/arbiter_8h.html#a27">ARBITER_PRIORITY_NULL</a>;
00924 
00925                 <span class="comment">//</span>
00926                 <span class="comment">// Advance to the next alternative</span>
00927                 <span class="comment">//</span>
00928 
00929                 currentAlternative++;
00930 
00931             }
00932         }
00933         currentState++;
00934     }
00935 
00936     <span class="comment">//</span>
00937     <span class="comment">// Terminate the stack with NULL entry</span>
00938     <span class="comment">//</span>
00939 
00940     currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00941 
00942     <span class="keywordflow">return</span> STATUS_SUCCESS;
00943 
00944 cleanup:
00945 
00946     <span class="comment">//</span>
00947     <span class="comment">// We don't need to free the buffer as it is attached to the arbiter and</span>
00948     <span class="comment">// will be used next time</span>
00949     <span class="comment">//</span>
00950 
00951     <span class="keywordflow">return</span> status;
00952 }
00953 
00954 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00955"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a77">00955</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a77">ArbSortArbitrationList</a>(
00956     IN OUT PLIST_ENTRY ArbitrationList
00957     )
00958 
00959 <span class="comment">/*++</span>
00960 <span class="comment"></span>
00961 <span class="comment">Routine Description:</span>
00962 <span class="comment"></span>
00963 <span class="comment">    This routine sorts the arbitration list in order of each entry's</span>
00964 <span class="comment">    WorkSpace value.</span>
00965 <span class="comment"></span>
00966 <span class="comment">Parameters:</span>
00967 <span class="comment"></span>
00968 <span class="comment">    ArbitrationList - The list to be sorted.</span>
00969 <span class="comment"></span>
00970 <span class="comment">Return Value:</span>
00971 <span class="comment"></span>
00972 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00973 <span class="comment"></span>
00974 <span class="comment">--*/</span>
00975 
00976 {
00977     <span class="comment">//</span>
00978     <span class="comment">// BUGBUG - maybe should use a get next type thing or a better sort!</span>
00979     <span class="comment">//</span>
00980     BOOLEAN sorted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00981     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> current, next;
00982 
00983     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00984 
00985     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(3, (<span class="stringliteral">"IoSortArbiterList(%p)\n"</span>, ArbitrationList));
00986 
00987     <span class="keywordflow">while</span> (!sorted) {
00988 
00989         sorted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00990 
00991         <span class="keywordflow">for</span> (current=(<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a>) ArbitrationList-&gt;Flink,
00992                next=(<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a>) current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>.Flink;
00993 
00994             (PLIST_ENTRY) current != ArbitrationList
00995                &amp;&amp; (PLIST_ENTRY) next != ArbitrationList;
00996 
00997             current = (<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a>) current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>.Flink,
00998                 next = (<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a>)current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>.Flink) {
00999 
01000 
01001             <span class="keywordflow">if</span> (current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o6">WorkSpace</a> &gt; next-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o6">WorkSpace</a>) {
01002 
01003                 PLIST_ENTRY before = current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>.Blink;
01004                 PLIST_ENTRY after = next-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>.Flink;
01005 
01006                 <span class="comment">//</span>
01007                 <span class="comment">// Swap the locations of current and next</span>
01008                 <span class="comment">//</span>
01009 
01010                 before-&gt;Flink = (PLIST_ENTRY) next;
01011                 after-&gt;Blink = (PLIST_ENTRY) current;
01012                 current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>.Flink = after;
01013                 current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>.Blink = (PLIST_ENTRY) next;
01014                 next-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>.Flink = (PLIST_ENTRY) current;
01015                 next-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>.Blink = before;
01016 
01017                 sorted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01018             }
01019         }
01020     }
01021 
01022     <span class="keywordflow">return</span> STATUS_SUCCESS;
01023 }
01024 
01025 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01026"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a72">01026</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a72">ArbCommitAllocation</a>(
01027     PARBITER_INSTANCE Arbiter
01028     )
01029 
01030 <span class="comment">/*++</span>
01031 <span class="comment"></span>
01032 <span class="comment">Routine Description:</span>
01033 <span class="comment"></span>
01034 <span class="comment">    This provides the default implementation of the CommitAllocation action.</span>
01035 <span class="comment">    It frees the old allocation and replaces it with the new allocation.</span>
01036 <span class="comment"></span>
01037 <span class="comment">Parameters:</span>
01038 <span class="comment"></span>
01039 <span class="comment">    Arbiter - The arbiter instance data for the arbiter being called.</span>
01040 <span class="comment"></span>
01041 <span class="comment">Return Value:</span>
01042 <span class="comment"></span>
01043 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
01044 <span class="comment"></span>
01045 <span class="comment">--*/</span>
01046 
01047 {
01048     PRTL_RANGE_LIST temp;
01049 
01050     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01051 
01052     <span class="comment">//</span>
01053     <span class="comment">// Free up the current allocation</span>
01054     <span class="comment">//</span>
01055 
01056     <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(Arbiter-&gt;Allocation);
01057 
01058     <span class="comment">//</span>
01059     <span class="comment">// Swap the allocated and duplicate lists</span>
01060     <span class="comment">//</span>
01061 
01062     temp = Arbiter-&gt;Allocation;
01063     Arbiter-&gt;Allocation = Arbiter-&gt;PossibleAllocation;
01064     Arbiter-&gt;PossibleAllocation = temp;
01065 
01066     <span class="keywordflow">return</span> STATUS_SUCCESS;
01067 }
01068 
01069 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01070"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a28">01070</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a73">ArbRollbackAllocation</a>(
01071     IN PARBITER_INSTANCE Arbiter
01072     )
01073 
01074 <span class="comment">/*++</span>
01075 <span class="comment"></span>
01076 <span class="comment">Routine Description:</span>
01077 <span class="comment"></span>
01078 <span class="comment">    This provides the default implementation of the RollbackAllocation action.</span>
01079 <span class="comment">    It frees the possible allocation the last TestAllocation provided.</span>
01080 <span class="comment"></span>
01081 <span class="comment">Parameters:</span>
01082 <span class="comment"></span>
01083 <span class="comment">    Arbiter - The arbiter instance data for the arbiter being called.</span>
01084 <span class="comment"></span>
01085 <span class="comment">Return Value:</span>
01086 <span class="comment"></span>
01087 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
01088 <span class="comment"></span>
01089 <span class="comment">--*/</span>
01090 
01091 {
01092 
01093     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01094 
01095     <span class="comment">//</span>
01096     <span class="comment">// Free up the possible allocation</span>
01097     <span class="comment">//</span>
01098 
01099     <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(Arbiter-&gt;PossibleAllocation);
01100 
01101     <span class="keywordflow">return</span> STATUS_SUCCESS;
01102 }
01103 
01104 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01105"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a71">01105</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a71">ArbRetestAllocation</a>(
01106     IN PARBITER_INSTANCE Arbiter,
01107     IN OUT PLIST_ENTRY ArbitrationList
01108     )
01109 
01110 <span class="comment">/*++</span>
01111 <span class="comment"></span>
01112 <span class="comment">Routine Description:</span>
01113 <span class="comment"></span>
01114 <span class="comment">    This provides the default implementation of the RetestAllocation action.</span>
01115 <span class="comment">    It walks the arbitration list and updates the possible allocation to reflect</span>
01116 <span class="comment">    the allocation entries of the list.  For these entries to be valid</span>
01117 <span class="comment">    TestAllocation must have been performed on this arbitration list.</span>
01118 <span class="comment"></span>
01119 <span class="comment">Parameters:</span>
01120 <span class="comment"></span>
01121 <span class="comment">    Arbiter - The arbiter instance data for the arbiter being called.</span>
01122 <span class="comment"></span>
01123 <span class="comment">    ArbitrationList - A list of ARBITER_LIST_ENTRY entries which contain the</span>
01124 <span class="comment">        requirements and associated devices.  TestAllocation for this arbiter</span>
01125 <span class="comment">        should have been called on this list.</span>
01126 <span class="comment"></span>
01127 <span class="comment">Return Value:</span>
01128 <span class="comment"></span>
01129 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
01130 <span class="comment"></span>
01131 <span class="comment">--*/</span>
01132 
01133 {
01134     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01135     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> current;
01136     <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">ARBITER_ALLOCATION_STATE</a> state;
01137     <a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html">ARBITER_ALTERNATIVE</a> alternative;
01138     ULONG length;
01139 
01140     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01141 
01142     <span class="comment">//</span>
01143     <span class="comment">// Initialize the state</span>
01144     <span class="comment">//</span>
01145 
01146     RtlZeroMemory(&amp;state, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">ARBITER_ALLOCATION_STATE</a>));
01147     RtlZeroMemory(&amp;alternative, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html">ARBITER_ALTERNATIVE</a>));
01148     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o6">AlternativeCount</a> = 1;
01149     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o7">Alternatives</a> = &amp;alternative;
01150     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a> = &amp;alternative;
01151     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o8">Flags</a> = <a class="code" href="../../d9/d8/arbiter_8h.html#a9">ARBITER_STATE_FLAG_RETEST</a>;
01152 
01153     <span class="comment">//</span>
01154     <span class="comment">// Copy the current allocation and reserved</span>
01155     <span class="comment">//</span>
01156 
01157     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2, (<span class="stringliteral">"Retest: Copy current allocation\n"</span>));
01158     status = <a class="code" href="../../d2/d5/range_8c.html#a19">RtlCopyRangeList</a>(Arbiter-&gt;PossibleAllocation, Arbiter-&gt;Allocation);
01159 
01160     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01161         <span class="keywordflow">goto</span> cleanup;
01162     }
01163 
01164     <span class="comment">//</span>
01165     <span class="comment">// Free all the resources currently allocated to all the devices we</span>
01166     <span class="comment">// are arbitrating for</span>
01167     <span class="comment">//</span>
01168 
01169     <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">ARBITER_LIST_ENTRY</a>, ArbitrationList, current) {
01170 
01171         <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(3,
01172                     (<span class="stringliteral">"Retest: Delete 0x%08x's resources\n"</span>,
01173                     current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>
01174                     ));
01175 
01176         status = <a class="code" href="../../d2/d5/range_8c.html#a18">RtlDeleteOwnersRanges</a>(Arbiter-&gt;PossibleAllocation,
01177                                        (PVOID) current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>
01178                                        );
01179 
01180         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01181             <span class="keywordflow">goto</span> cleanup;
01182         }
01183     }
01184 
01185     <span class="comment">//</span>
01186     <span class="comment">// Build an allocation state for the allocation and call AddAllocation to</span>
01187     <span class="comment">// update the range lists accordingly</span>
01188     <span class="comment">//</span>
01189 
01190     <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">ARBITER_LIST_ENTRY</a>, ArbitrationList, current) {
01191 
01192         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o10">Assignment</a> &amp;&amp; current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o11">SelectedAlternative</a>);
01193 
01194         state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o11">WorkSpace</a> = 0;
01195         state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a> = current;
01196 
01197         <span class="comment">//</span>
01198         <span class="comment">// Initialize the alternative</span>
01199         <span class="comment">//</span>
01200 
01201         status = <a class="code" href="../../d8/d8/arbiter_8c.html#a18">ArbpBuildAlternative</a>(Arbiter,
01202                                     current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o11">SelectedAlternative</a>,
01203                                     &amp;alternative
01204                                     );
01205 
01206         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
01207 
01208         <span class="comment">//</span>
01209         <span class="comment">// Update it with our allocation</span>
01210         <span class="comment">//</span>
01211 
01212         status = Arbiter-&gt;UnpackResource(current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o10">Assignment</a>,
01213                                          &amp;state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>,
01214                                          &amp;length
01215                                          );
01216 
01217         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
01218 
01219         state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a> = state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a> + length - 1;
01220 
01221         <span class="comment">//</span>
01222         <span class="comment">// Do any preprocessing that is required</span>
01223         <span class="comment">//</span>
01224 
01225         status = Arbiter-&gt;PreprocessEntry(Arbiter,&amp;state);
01226 
01227         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01228             <span class="keywordflow">goto</span> cleanup;
01229         }
01230 
01231         <span class="comment">//</span>
01232         <span class="comment">// If we had a requirement for length 0 then don't attemp to add the</span>
01233         <span class="comment">// range - it will fail!</span>
01234         <span class="comment">//</span>
01235 
01236         <span class="keywordflow">if</span> (length != 0) {
01237 
01238             Arbiter-&gt;AddAllocation(Arbiter, &amp;state);
01239 
01240         }
01241     }
01242 
01243     <span class="keywordflow">return</span> status;
01244 
01245 cleanup:
01246 
01247     <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(Arbiter-&gt;PossibleAllocation);
01248     <span class="keywordflow">return</span> status;
01249 }
01250 
01251 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01252"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a85">01252</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a85">ArbBootAllocation</a>(
01253     IN PARBITER_INSTANCE Arbiter,
01254     IN OUT PLIST_ENTRY ArbitrationList
01255     )
01256 <span class="comment">/*++</span>
01257 <span class="comment"></span>
01258 <span class="comment">Routine Description:</span>
01259 <span class="comment"></span>
01260 <span class="comment">    This provides the default implementation of the BootAllocation action.</span>
01261 <span class="comment">    It walks the arbitration list and updates the allocation to reflect the fact</span>
01262 <span class="comment">    that the allocation entries in the list are in use.</span>
01263 <span class="comment"></span>
01264 <span class="comment">Parameters:</span>
01265 <span class="comment"></span>
01266 <span class="comment">    Arbiter - The arbiter instance data for the arbiter being called.</span>
01267 <span class="comment"></span>
01268 <span class="comment">    ArbitrationList - A list of ARBITER_LIST_ENTRY entries which contain the</span>
01269 <span class="comment">        requirements and associated devices.  Each device should have one and</span>
01270 <span class="comment">        only one requirement reflecting the resources it is currently consuming.</span>
01271 <span class="comment"></span>
01272 <span class="comment">Return Value:</span>
01273 <span class="comment"></span>
01274 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
01275 <span class="comment"></span>
01276 <span class="comment">--*/</span>
01277 
01278 {
01279 
01280     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01281     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> current;
01282     PRTL_RANGE_LIST temp;
01283     <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">ARBITER_ALLOCATION_STATE</a> state;
01284     <a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html">ARBITER_ALTERNATIVE</a> alternative;
01285 
01286     <span class="comment">//</span>
01287     <span class="comment">// Initialize the state</span>
01288     <span class="comment">//</span>
01289 
01290     RtlZeroMemory(&amp;state, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">ARBITER_ALLOCATION_STATE</a>));
01291     RtlZeroMemory(&amp;alternative, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html">ARBITER_ALTERNATIVE</a>));
01292     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o6">AlternativeCount</a> = 1;
01293     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o7">Alternatives</a> = &amp;alternative;
01294     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a> = &amp;alternative;
01295     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o8">Flags</a> = <a class="code" href="../../d9/d8/arbiter_8h.html#a10">ARBITER_STATE_FLAG_BOOT</a>;
01296     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o9">RangeAttributes</a> = <a class="code" href="../../d9/d8/arbiter_8h.html#a13">ARBITER_RANGE_BOOT_ALLOCATED</a>;
01297 
01298     <span class="comment">//</span>
01299     <span class="comment">// Work on the possible allocation list</span>
01300     <span class="comment">//</span>
01301 
01302     status = <a class="code" href="../../d2/d5/range_8c.html#a19">RtlCopyRangeList</a>(Arbiter-&gt;PossibleAllocation, Arbiter-&gt;Allocation);
01303 
01304     <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">ARBITER_LIST_ENTRY</a>, ArbitrationList, current) {
01305 
01306         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a> == 1);
01307         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>);
01308 
01309         <span class="comment">//</span>
01310         <span class="comment">// Build an alternative and state structure for this allocation and</span>
01311         <span class="comment">// add it to the range list</span>
01312         <span class="comment">//</span>
01313 
01314         state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a> = current;
01315 
01316         <span class="comment">//</span>
01317         <span class="comment">// Initialize the alternative</span>
01318         <span class="comment">//</span>
01319 
01320         status = <a class="code" href="../../d8/d8/arbiter_8c.html#a18">ArbpBuildAlternative</a>(Arbiter,
01321                                     &amp;current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o2">Alternatives</a>[0],
01322                                     &amp;alternative
01323                                     );
01324 
01325         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
01326         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(alternative.<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o5">Flags</a> &amp;
01327                (<a class="code" href="../../d9/d8/arbiter_8h.html#a7">ARBITER_ALTERNATIVE_FLAG_FIXED</a> | <a class="code" href="../../d9/d8/arbiter_8h.html#a8">ARBITER_ALTERNATIVE_FLAG_INVALID</a>)
01328                );
01329 
01330         state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a> = alternative.<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o0">Minimum</a>;
01331         state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a> = alternative.<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o1">Maximum</a>;
01332 
01333         <span class="comment">//</span>
01334         <span class="comment">// Blow away the old workspace and masks</span>
01335         <span class="comment">//</span>
01336 
01337         state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o11">WorkSpace</a> = 0;
01338         state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o10">RangeAvailableAttributes</a> = 0;
01339 
01340         <span class="comment">//</span>
01341         <span class="comment">// Validate the requirement</span>
01342         <span class="comment">//</span>
01343 
01344         <span class="keywordflow">if</span> (alternative.<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a> == 0
01345         || alternative.<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o3">Alignment</a> == 0
01346         || state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a> &lt; state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>
01347         || state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a> % alternative.<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o3">Alignment</a> != 0
01348         || <a class="code" href="../../d9/d8/arbiter_8h.html#a5">LENGTH_OF</a>(state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>, state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a>) != alternative.<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a>) {
01349 
01350             <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(1,
01351                         (<span class="stringliteral">"Skipping invalid boot allocation 0x%I64x-0x%I64x L 0x%x A 0x%x for 0x%08x\n"</span>,
01352                          state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>,
01353                          state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a>,
01354                          alternative.<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a>,
01355                          alternative.<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o3">Alignment</a>,
01356                          current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>
01357                          ));
01358 
01359             <span class="keywordflow">continue</span>;
01360         }
01361 
01362 <span class="preprocessor">#if PLUG_FEST_HACKS</span>
01363 <span class="preprocessor"></span>
01364         <span class="keywordflow">if</span> (alternative.<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a6">ARBITER_ALTERNATIVE_FLAG_SHARED</a>) {
01365 
01366             <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(1,
01367                          (<span class="stringliteral">"Skipping shared boot allocation 0x%I64x-0x%I64x L 0x%x A 0x%x for 0x%08x\n"</span>,
01368                           state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>,
01369                           state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a>,
01370                           alternative.<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a>,
01371                           alternative.<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o3">Alignment</a>,
01372                           current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>
01373                           ));
01374 
01375             <span class="keywordflow">continue</span>;
01376         }
01377 <span class="preprocessor">#endif</span>
01378 <span class="preprocessor"></span>
01379 
01380         <span class="comment">//</span>
01381         <span class="comment">// Do any preprocessing that is required</span>
01382         <span class="comment">//</span>
01383 
01384         status = Arbiter-&gt;PreprocessEntry(Arbiter,&amp;state);
01385 
01386         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01387             <span class="keywordflow">goto</span> cleanup;;
01388         }
01389 
01390         Arbiter-&gt;AddAllocation(Arbiter, &amp;state);
01391 
01392     }
01393 
01394     <span class="comment">//</span>
01395     <span class="comment">// Everything went OK so make this our allocated range</span>
01396     <span class="comment">//</span>
01397 
01398     <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(Arbiter-&gt;Allocation);
01399     temp = Arbiter-&gt;Allocation;
01400     Arbiter-&gt;Allocation = Arbiter-&gt;PossibleAllocation;
01401     Arbiter-&gt;PossibleAllocation = temp;
01402 
01403     <span class="keywordflow">return</span> STATUS_SUCCESS;
01404 
01405 cleanup:
01406 
01407     <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(Arbiter-&gt;PossibleAllocation);
01408     <span class="keywordflow">return</span> status;
01409 
01410 }
01411 
01412 
01413 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01414"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a69">01414</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a69">ArbArbiterHandler</a>(
01415     IN PVOID Context,
01416     IN <a class="code" href="../../d6/d9/pnp_8h.html#a52">ARBITER_ACTION</a> Action,
01417     IN OUT <a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html">PARBITER_PARAMETERS</a> Params
01418     )
01419 
01420 <span class="comment">/*++</span>
01421 <span class="comment"></span>
01422 <span class="comment">Routine Description:</span>
01423 <span class="comment"></span>
01424 <span class="comment">    This provides the default entry point to an arbiter.</span>
01425 <span class="comment"></span>
01426 <span class="comment">Parameters:</span>
01427 <span class="comment"></span>
01428 <span class="comment">    Context - The context provided in the interface where this function was</span>
01429 <span class="comment">        called from.  This is converted to an ARBITER_INSTANCE using the</span>
01430 <span class="comment">        ARBITER_CONTEXT_TO_INSTANCE macro which should be defined.</span>
01431 <span class="comment"></span>
01432 <span class="comment">    Action - The action the arbiter should perform.</span>
01433 <span class="comment"></span>
01434 <span class="comment">    Params - The parameters for the action.</span>
01435 <span class="comment"></span>
01436 <span class="comment">Return Value:</span>
01437 <span class="comment"></span>
01438 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
01439 <span class="comment"></span>
01440 <span class="comment">Note:</span>
01441 <span class="comment"></span>
01442 <span class="comment">    The routines which implement each action are determined from the dispatch</span>
01443 <span class="comment">    table in the arbiter instance.</span>
01444 <span class="comment"></span>
01445 <span class="comment">--*/</span>
01446 
01447 {
01448 
01449     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01450     <a class="code" href="../../d9/d8/arbiter_8h.html#a39">PARBITER_INSTANCE</a> arbiter = Context;
01451 
01452     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01453     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Context);
01454     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> &gt;= 0 &amp;&amp; <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> &lt;= <a class="code" href="../../d6/d9/pnp_8h.html#a173a124">ArbiterActionBootAllocation</a>);
01455     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(arbiter-&gt;Signature == <a class="code" href="../../d9/d8/arbiter_8h.html#a17">ARBITER_INSTANCE_SIGNATURE</a>);
01456 
01457     <span class="comment">//</span>
01458     <span class="comment">// Acquire the state lock</span>
01459     <span class="comment">//</span>
01460 
01461     <a class="code" href="../../d9/d8/arbiter_8h.html#a18">ArbAcquireArbiterLock</a>(arbiter);
01462 
01463     <span class="comment">//</span>
01464     <span class="comment">// Announce ourselves</span>
01465     <span class="comment">//</span>
01466 
01467     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
01468                 (<span class="stringliteral">"%s %S\n"</span>,
01469                 <a class="code" href="../../d0/d9/arbp_8h.html#a1">ArbpActionStrings</a>[<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a>],
01470                 arbiter-&gt;Name
01471                 ));
01472 
01473     <span class="comment">//</span>
01474     <span class="comment">// Check the transaction flag</span>
01475     <span class="comment">//</span>
01476 
01477     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>
01478     ||  <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>
01479     ||  <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a173a124">ArbiterActionBootAllocation</a>) {
01480 
01481         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!arbiter-&gt;TransactionInProgress);
01482 
01483     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>
01484            ||  <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a173a118">ArbiterActionRollbackAllocation</a>) {
01485 
01486         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(arbiter-&gt;TransactionInProgress);
01487     }
01488 
01489 <span class="preprocessor">#if ARB_DBG</span>
01490 <span class="preprocessor"></span>
01491 replay:
01492 
01493 <span class="preprocessor">#endif</span>
01494 <span class="preprocessor"></span>
01495     <span class="comment">//</span>
01496     <span class="comment">// Do the appropriate thing</span>
01497     <span class="comment">//</span>
01498 
01499     <span class="keywordflow">switch</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a>) {
01500 
01501     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>:
01502 
01503         <span class="comment">//</span>
01504         <span class="comment">// Suballocation can not occur for a root arbiter</span>
01505         <span class="comment">// BUGBUG - this should be generalised</span>
01506         <span class="comment">//</span>
01507         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Params-&gt;Parameters.TestAllocation.AllocateFromCount == 0);
01508         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Params-&gt;Parameters.TestAllocation.AllocateFrom == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01509 
01510         status = arbiter-&gt;TestAllocation(
01511                      arbiter,
01512                      Params-&gt;Parameters.TestAllocation.ArbitrationList
01513                      );
01514         <span class="keywordflow">break</span>;
01515 
01516     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>:
01517 
01518         <span class="comment">//</span>
01519         <span class="comment">// Suballocation can not occur for a root arbiter</span>
01520         <span class="comment">// BUGBUG - this should be generalised</span>
01521         <span class="comment">//</span>
01522         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Params-&gt;Parameters.TestAllocation.AllocateFromCount == 0);
01523         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Params-&gt;Parameters.TestAllocation.AllocateFrom == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01524 
01525         status = arbiter-&gt;RetestAllocation(
01526                      arbiter,
01527                      Params-&gt;Parameters.TestAllocation.ArbitrationList
01528                      );
01529         <span class="keywordflow">break</span>;
01530 
01531     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>:
01532 
01533         status = arbiter-&gt;CommitAllocation(arbiter);
01534 
01535         <span class="keywordflow">break</span>;
01536 
01537     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a118">ArbiterActionRollbackAllocation</a>:
01538 
01539         status = arbiter-&gt;RollbackAllocation(arbiter);
01540 
01541         <span class="keywordflow">break</span>;
01542 
01543     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a124">ArbiterActionBootAllocation</a>:
01544 
01545         status = arbiter-&gt;BootAllocation(
01546                     arbiter,
01547                     Params-&gt;Parameters.BootAllocation.ArbitrationList
01548                     );
01549         <span class="keywordflow">break</span>;
01550 
01551     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a121">ArbiterActionQueryConflict</a>:
01552 
01553         status = arbiter-&gt;QueryConflict(
01554                     arbiter,
01555                     Params-&gt;Parameters.QueryConflict.PhysicalDeviceObject,
01556                     Params-&gt;Parameters.QueryConflict.ConflictingResource,
01557                     Params-&gt;Parameters.QueryConflict.ConflictCount,
01558                     Params-&gt;Parameters.QueryConflict.Conflicts
01559                     );
01560         <span class="keywordflow">break</span>;
01561 
01562     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a122">ArbiterActionQueryArbitrate</a>:
01563     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a119">ArbiterActionQueryAllocatedResources</a>:
01564     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a120">ArbiterActionWriteReservedResources</a>:
01565     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a123">ArbiterActionAddReserved</a>:
01566 
01567         status = STATUS_NOT_IMPLEMENTED;
01568         <span class="keywordflow">break</span>;
01569 
01570     <span class="keywordflow">default</span>:
01571         status = STATUS_INVALID_PARAMETER;
01572         <span class="keywordflow">break</span>;
01573     }
01574 
01575 <span class="preprocessor">#if ARB_DBG</span>
01576 <span class="preprocessor"></span>
01577     <span class="comment">//</span>
01578     <span class="comment">// Check if we failed and want to stop or replay on errors</span>
01579     <span class="comment">//</span>
01580 
01581     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01582 
01583         <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(1,
01584                  (<span class="stringliteral">"*** %s for %S FAILED status = %08x\n"</span>,
01585                   <a class="code" href="../../d0/d9/arbp_8h.html#a1">ArbpActionStrings</a>[<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a>],
01586                   arbiter-&gt;Name,
01587                   status
01588                  ));
01589 
01590         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/arbp_8h.html#a2">ArbStopOnError</a>) {
01591             DbgBreakPoint();
01592         }
01593 
01594         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/arbp_8h.html#a3">ArbReplayOnError</a>) {
01595             <span class="keywordflow">goto</span> replay;
01596         }
01597     }
01598 
01599 <span class="preprocessor">#endif // ARB_DBG</span>
01600 <span class="preprocessor"></span>
01601     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01602 
01603         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>
01604         ||  <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>) {
01605 
01606             arbiter-&gt;TransactionInProgress = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01607 
01608         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>
01609                ||  <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a173a118">ArbiterActionRollbackAllocation</a>) {
01610 
01611             arbiter-&gt;TransactionInProgress = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01612         }
01613     }
01614 
01615     <a class="code" href="../../d9/d8/arbiter_8h.html#a19">ArbReleaseArbiterLock</a>(arbiter);
01616 
01617     <span class="keywordflow">return</span> status;
01618 
01619 }
01620 
01621 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01622"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a87">01622</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a87">ArbBuildAssignmentOrdering</a>(
01623     IN OUT PARBITER_INSTANCE Arbiter,
01624     IN PWSTR AllocationOrderName,
01625     IN PWSTR ReservedResourcesName,
01626     IN PARBITER_TRANSLATE_ALLOCATION_ORDER Translate OPTIONAL
01627     )
01628 
01629 <span class="comment">/*++</span>
01630 <span class="comment"></span>
01631 <span class="comment">Routine Description:</span>
01632 <span class="comment"></span>
01633 <span class="comment">    This is called as part of arbiter initialization and extracts the allocation</span>
01634 <span class="comment">    ordering and reserved information from the registry and combines them into</span>
01635 <span class="comment">    an ordering list.  The reserved ranges are put in Arbiter-&gt;ReservedList</span>
01636 <span class="comment">    and the initial ordering in Arbiter-&gt;OrderingList.</span>
01637 <span class="comment"></span>
01638 <span class="comment">Parameters:</span>
01639 <span class="comment"></span>
01640 <span class="comment">    Arbiter - The instance data of the arbiter to be initialized.</span>
01641 <span class="comment"></span>
01642 <span class="comment">    AllocationOrderName - The name of the key under HKLM\System\</span>
01643 <span class="comment">        CurrentControlSet\Control\Arbiters\AllocationOrder the ordering</span>
01644 <span class="comment">        information should be taken from.</span>
01645 <span class="comment"></span>
01646 <span class="comment">    ReservedResourcesName - The name of the key under HKLM\System\</span>
01647 <span class="comment">        CurrentControlSet\Control\Arbiters\ReservedResources the reserved ranges</span>
01648 <span class="comment">        information should be taken from.</span>
01649 <span class="comment"></span>
01650 <span class="comment">    Translate - A function to be called for each range that will perform system</span>
01651 <span class="comment">        dependant translations required for this system.</span>
01652 <span class="comment"></span>
01653 <span class="comment">Return Value:</span>
01654 <span class="comment"></span>
01655 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
01656 <span class="comment"></span>
01657 <span class="comment">--*/</span>
01658 
01659 {
01660     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01661     HANDLE arbitersHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, tempHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01662     UNICODE_STRING unicodeString;
01663     PKEY_VALUE_FULL_INFORMATION info = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01664     ULONG <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
01665     PIO_RESOURCE_LIST resourceList;
01666     PIO_RESOURCE_DESCRIPTOR current;
01667     ULONGLONG start, end;
01668     OBJECT_ATTRIBUTES attributes;
01669     IO_RESOURCE_DESCRIPTOR translated;
01670 
01671     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01672 
01673     <a class="code" href="../../d9/d8/arbiter_8h.html#a18">ArbAcquireArbiterLock</a>(Arbiter);
01674 
01675     <span class="comment">//</span>
01676     <span class="comment">// If we are reinitializing the orderings free the old ones</span>
01677     <span class="comment">//</span>
01678 
01679     <a class="code" href="../../d9/d8/arbiter_8h.html#a63">ArbFreeOrderingList</a>(&amp;Arbiter-&gt;OrderingList);
01680     <a class="code" href="../../d9/d8/arbiter_8h.html#a63">ArbFreeOrderingList</a>(&amp;Arbiter-&gt;ReservedList);
01681 
01682     <span class="comment">//</span>
01683     <span class="comment">// Initialize the orderings</span>
01684     <span class="comment">//</span>
01685 
01686     status = <a class="code" href="../../d9/d8/arbiter_8h.html#a62">ArbInitializeOrderingList</a>(&amp;Arbiter-&gt;OrderingList);
01687 
01688     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01689         <span class="keywordflow">goto</span> cleanup;
01690     }
01691 
01692     status = <a class="code" href="../../d9/d8/arbiter_8h.html#a62">ArbInitializeOrderingList</a>(&amp;Arbiter-&gt;ReservedList);
01693 
01694     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01695         <span class="keywordflow">goto</span> cleanup;
01696     }
01697 
01698     <span class="comment">//</span>
01699     <span class="comment">// Open HKLM\System\CurrentControlSet\Control\Arbiters</span>
01700     <span class="comment">//</span>
01701 
01702     <a class="code" href="../../d8/d8/arbiter_8c.html#a13">ArbpWstrToUnicodeString</a>(&amp;unicodeString, <a class="code" href="../../d8/d8/arbiter_8c.html#a7">PATH_ARBITERS</a>);
01703     InitializeObjectAttributes(&amp;attributes,
01704                                &amp;unicodeString,
01705                                OBJ_CASE_INSENSITIVE,
01706                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01707                                (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01708                                );
01709 
01710 
01711     status = ZwOpenKey(&amp;arbitersHandle,
01712                        KEY_READ,
01713                        &amp;attributes
01714                        );
01715 
01716     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01717         <span class="keywordflow">goto</span> cleanup;
01718     }
01719 
01720     <span class="comment">//</span>
01721     <span class="comment">// Open AllocationOrder</span>
01722     <span class="comment">//</span>
01723 
01724     <a class="code" href="../../d8/d8/arbiter_8c.html#a13">ArbpWstrToUnicodeString</a>(&amp;unicodeString, <a class="code" href="../../d8/d8/arbiter_8c.html#a8">KEY_ALLOCATIONORDER</a>);
01725     InitializeObjectAttributes(&amp;attributes,
01726                                &amp;unicodeString,
01727                                OBJ_CASE_INSENSITIVE,
01728                                arbitersHandle,
01729                                (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01730                                );
01731 
01732 
01733     status = ZwOpenKey(&amp;tempHandle,
01734                        KEY_READ,
01735                        &amp;attributes
01736                        );
01737 
01738     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01739         <span class="keywordflow">goto</span> cleanup;
01740     }
01741 
01742     <span class="comment">//</span>
01743     <span class="comment">// Extract the value the user asked for</span>
01744     <span class="comment">//</span>
01745 
01746     status = <a class="code" href="../../d8/d8/arbiter_8c.html#a17">ArbpGetRegistryValue</a>(tempHandle,
01747                                   AllocationOrderName,
01748                                   &amp;info
01749                                   );
01750 
01751     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01752         <span class="keywordflow">goto</span> cleanup;
01753     }
01754 
01755     <span class="comment">//</span>
01756     <span class="comment">// Check if the value we retrieved was a string and if so then it was a</span>
01757     <span class="comment">// short cut to a value of that name - open it.</span>
01758     <span class="comment">//</span>
01759 
01760     <span class="keywordflow">if</span> (info-&gt;Type == REG_SZ) {
01761 
01762         PKEY_VALUE_FULL_INFORMATION tempInfo;
01763 
01764         <span class="comment">// BUGBUG - check this is a valid string...</span>
01765 
01766         status = <a class="code" href="../../d8/d8/arbiter_8c.html#a17">ArbpGetRegistryValue</a>(tempHandle,
01767                                      (PWSTR) <a class="code" href="../../d8/d8/arbiter_8c.html#a11">FULL_INFO_DATA</a>(info),
01768                                      &amp;tempInfo
01769                                      );
01770 
01771         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01772             <span class="keywordflow">goto</span> cleanup;
01773         }
01774 
01775         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(info);
01776         info = tempInfo;
01777 
01778     }
01779 
01780     ZwClose(tempHandle);
01781 
01782     <span class="comment">//</span>
01783     <span class="comment">// We only support one level of short cuts so this should be a</span>
01784     <span class="comment">// REG_RESOURCE_REQUIREMENTS_LIST</span>
01785     <span class="comment">//</span>
01786 
01787     <span class="keywordflow">if</span> (info-&gt;Type != REG_RESOURCE_REQUIREMENTS_LIST) {
01788         status = STATUS_INVALID_PARAMETER;
01789         <span class="keywordflow">goto</span> cleanup;
01790     }
01791 
01792     <span class="comment">//</span>
01793     <span class="comment">// Extract the resource list</span>
01794     <span class="comment">//</span>
01795 
01796     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d8/d8/arbiter_8c.html#a11">FULL_INFO_DATA</a>(info))
01797              -&gt;AlternativeLists == 1);
01798 
01799     resourceList = (PIO_RESOURCE_LIST) &amp;((PIO_RESOURCE_REQUIREMENTS_LIST)
01800                        <a class="code" href="../../d8/d8/arbiter_8c.html#a11">FULL_INFO_DATA</a>(info))-&gt;List[0];
01801 
01802     <span class="comment">//</span>
01803     <span class="comment">// Convert the resource list into an ordering list</span>
01804     <span class="comment">//</span>
01805 
01806     <a class="code" href="../../d1/d5/translate_8c.html#a1">FOR_ALL_IN_ARRAY</a>(resourceList-&gt;Descriptors,
01807                      resourceList-&gt;Count,
01808                      current) {
01809 
01810         <span class="comment">//</span>
01811         <span class="comment">// Perform any translation that is necessary on the resources</span>
01812         <span class="comment">//</span>
01813 
01814         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Translate)) {
01815 
01816             status = (Translate)(&amp;translated, current);
01817 
01818             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01819                 <span class="keywordflow">goto</span> cleanup;
01820             }
01821         } <span class="keywordflow">else</span> {
01822             translated = *current;
01823         }
01824 
01825         <span class="keywordflow">if</span> (translated.Type == Arbiter-&gt;ResourceType) {
01826 
01827             status = Arbiter-&gt;UnpackRequirement(&amp;translated,
01828                                                 &amp;start,
01829                                                 &amp;end,
01830                                                 &amp;<a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>,  <span class="comment">//length</span>
01831                                                 &amp;<a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>   <span class="comment">//alignment</span>
01832                                                );
01833 
01834             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01835                 <span class="keywordflow">goto</span> cleanup;
01836             }
01837 
01838             status = <a class="code" href="../../d9/d8/arbiter_8h.html#a65">ArbAddOrdering</a>(&amp;Arbiter-&gt;OrderingList,
01839                                     start,
01840                                     end
01841                                     );
01842 
01843             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01844                     <span class="keywordflow">goto</span> cleanup;
01845             }
01846         }
01847     }
01848 
01849     <span class="comment">//</span>
01850     <span class="comment">// We're finished with info...</span>
01851     <span class="comment">//</span>
01852 
01853     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(info);
01854     info = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01855 
01856     <span class="comment">//</span>
01857     <span class="comment">// Open ReservedResources</span>
01858     <span class="comment">//</span>
01859 
01860     <a class="code" href="../../d8/d8/arbiter_8c.html#a13">ArbpWstrToUnicodeString</a>(&amp;unicodeString, <a class="code" href="../../d8/d8/arbiter_8c.html#a9">KEY_RESERVEDRESOURCES</a>);
01861     InitializeObjectAttributes(&amp;attributes,
01862                                &amp;unicodeString,
01863                                OBJ_CASE_INSENSITIVE,
01864                                arbitersHandle,
01865                                (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01866                                );
01867 
01868 
01869     status = ZwCreateKey(&amp;tempHandle,
01870                          KEY_READ,
01871                          &amp;attributes,
01872                          0,
01873                          (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01874                          REG_OPTION_NON_VOLATILE,
01875                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01876                          );
01877 
01878     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01879         <span class="keywordflow">goto</span> cleanup;
01880     }
01881 
01882     <span class="comment">//</span>
01883     <span class="comment">// Extract the arbiter's reserved resources</span>
01884     <span class="comment">//</span>
01885 
01886     status = <a class="code" href="../../d8/d8/arbiter_8c.html#a17">ArbpGetRegistryValue</a>(tempHandle,
01887                                   ReservedResourcesName,
01888                                   &amp;info
01889                                   );
01890 
01891     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01892         <span class="keywordflow">goto</span> cleanup;
01893     }
01894 
01895     <span class="comment">//</span>
01896     <span class="comment">// Check if the value we retrieved was a string and if so then it was a</span>
01897     <span class="comment">// short cut to a value of that name - open it.</span>
01898     <span class="comment">//</span>
01899 
01900     <span class="keywordflow">if</span> (info-&gt;Type == REG_SZ) {
01901 
01902         PKEY_VALUE_FULL_INFORMATION tempInfo;
01903 
01904         <span class="comment">// BUGBUG - check this is a valid string...</span>
01905 
01906         status = <a class="code" href="../../d8/d8/arbiter_8c.html#a17">ArbpGetRegistryValue</a>(tempHandle,
01907                                      (PWSTR) <a class="code" href="../../d8/d8/arbiter_8c.html#a11">FULL_INFO_DATA</a>(info),
01908                                      &amp;tempInfo
01909                                      );
01910 
01911         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01912             <span class="keywordflow">goto</span> cleanup;
01913         }
01914 
01915         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(info);
01916         info = tempInfo;
01917 
01918     }
01919 
01920     ZwClose(tempHandle);
01921 
01922     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01923 
01924         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d8/d8/arbiter_8c.html#a11">FULL_INFO_DATA</a>(info))
01925              -&gt;AlternativeLists == 1);
01926 
01927         resourceList = (PIO_RESOURCE_LIST) &amp;((PIO_RESOURCE_REQUIREMENTS_LIST)
01928                        <a class="code" href="../../d8/d8/arbiter_8c.html#a11">FULL_INFO_DATA</a>(info))-&gt;List[0];
01929 
01930         <span class="comment">//</span>
01931         <span class="comment">// Apply the reserved ranges to the ordering</span>
01932         <span class="comment">//</span>
01933 
01934         <a class="code" href="../../d1/d5/translate_8c.html#a1">FOR_ALL_IN_ARRAY</a>(resourceList-&gt;Descriptors,
01935                          resourceList-&gt;Count,
01936                          current) {
01937 
01938             <span class="comment">//</span>
01939             <span class="comment">// Perform any translation that is necessary on the resources</span>
01940             <span class="comment">//</span>
01941 
01942             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Translate)) {
01943 
01944                 status = (Translate)(&amp;translated, current);
01945 
01946                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01947                     <span class="keywordflow">goto</span> cleanup;
01948                 }
01949             } <span class="keywordflow">else</span> {
01950                 translated = *current;
01951             }
01952 
01953             <span class="keywordflow">if</span> (translated.Type == Arbiter-&gt;ResourceType) {
01954 
01955                 status = Arbiter-&gt;UnpackRequirement(&amp;translated,
01956                                                     &amp;start,
01957                                                     &amp;end,
01958                                                     &amp;<a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>,  <span class="comment">//length</span>
01959                                                     &amp;<a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>   <span class="comment">//alignment</span>
01960                                                    );
01961 
01962                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01963                     <span class="keywordflow">goto</span> cleanup;
01964                 }
01965 
01966                 <span class="comment">//</span>
01967                 <span class="comment">// Add the reserved range to the reserved ordering</span>
01968                 <span class="comment">//</span>
01969 
01970                 status = <a class="code" href="../../d9/d8/arbiter_8h.html#a65">ArbAddOrdering</a>(&amp;Arbiter-&gt;ReservedList, start, end);
01971 
01972                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01973                     <span class="keywordflow">goto</span> cleanup;
01974                 }
01975 
01976                 <span class="comment">//</span>
01977                 <span class="comment">// Prune the reserved range from the current ordering</span>
01978                 <span class="comment">//</span>
01979 
01980                 status = <a class="code" href="../../d9/d8/arbiter_8h.html#a66">ArbPruneOrdering</a>(&amp;Arbiter-&gt;OrderingList, start, end);
01981 
01982                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01983                     <span class="keywordflow">goto</span> cleanup;
01984                 }
01985 
01986             }
01987         }
01988 
01989         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(info);
01990     }
01991 
01992     <span class="comment">//</span>
01993     <span class="comment">// All done!</span>
01994     <span class="comment">//</span>
01995 
01996     ZwClose(arbitersHandle);
01997 
01998 <span class="preprocessor">#if ARB_DBG</span>
01999 <span class="preprocessor"></span>
02000     {
02001         <a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html">PARBITER_ORDERING</a> current;
02002 
02003         <a class="code" href="../../d1/d5/translate_8c.html#a1">FOR_ALL_IN_ARRAY</a>(Arbiter-&gt;OrderingList.Orderings,
02004                          Arbiter-&gt;OrderingList.Count,
02005                          current) {
02006             <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
02007                         (<span class="stringliteral">"Ordering: 0x%I64x-0x%I64x\n"</span>,
02008                          current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a>,
02009                          current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a>
02010                         ));
02011         }
02012 
02013         <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2, (<span class="stringliteral">"\n"</span>));
02014 
02015         <a class="code" href="../../d1/d5/translate_8c.html#a1">FOR_ALL_IN_ARRAY</a>(Arbiter-&gt;ReservedList.Orderings,
02016                      Arbiter-&gt;ReservedList.Count,
02017                      current) {
02018             <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
02019                         (<span class="stringliteral">"Reserved: 0x%I64x-0x%I64x\n"</span>,
02020                          current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a>,
02021                          current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a>
02022                         ));
02023         }
02024 
02025     }
02026 
02027 <span class="preprocessor">#endif</span>
02028 <span class="preprocessor"></span>
02029     <a class="code" href="../../d9/d8/arbiter_8h.html#a19">ArbReleaseArbiterLock</a>(Arbiter);
02030 
02031     <span class="keywordflow">return</span> STATUS_SUCCESS;
02032 
02033 cleanup:
02034 
02035     <span class="keywordflow">if</span> (arbitersHandle) {
02036         ZwClose(arbitersHandle);
02037     }
02038 
02039     <span class="keywordflow">if</span> (tempHandle) {
02040         ZwClose(tempHandle);
02041     }
02042 
02043     <span class="keywordflow">if</span> (info) {
02044         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(info);
02045     }
02046 
02047     <span class="keywordflow">if</span> (Arbiter-&gt;OrderingList.Orderings) {
02048         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Arbiter-&gt;OrderingList.Orderings);
02049         Arbiter-&gt;OrderingList.Count = 0;
02050         Arbiter-&gt;OrderingList.Maximum = 0;
02051     }
02052 
02053     <span class="keywordflow">if</span> (Arbiter-&gt;ReservedList.Orderings) {
02054         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Arbiter-&gt;ReservedList.Orderings);
02055         Arbiter-&gt;ReservedList.Count = 0;
02056         Arbiter-&gt;ReservedList.Maximum = 0;
02057     }
02058 
02059     <a class="code" href="../../d9/d8/arbiter_8h.html#a19">ArbReleaseArbiterLock</a>(Arbiter);
02060 
02061     <span class="keywordflow">return</span> status;
02062 }
02063 
02064 BOOLEAN
<a name="l02065"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a83">02065</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a83">ArbFindSuitableRange</a>(
02066     PARBITER_INSTANCE Arbiter,
02067     <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
02068     )
02069 
02070 <span class="comment">/*++</span>
02071 <span class="comment"></span>
02072 <span class="comment">Routine Description:</span>
02073 <span class="comment"></span>
02074 <span class="comment">    This routine is called from AllocateEntry once we have decided where we want</span>
02075 <span class="comment">    to allocate from.  It tries to find a free range that matches the</span>
02076 <span class="comment">    requirements in State while restricting its possible solutions to the range</span>
02077 <span class="comment">    State-&gt;CurrentMinimum to State-&gt;CurrentMaximum.  On success State-&gt;Start and</span>
02078 <span class="comment">    State-&gt;End represent this range.</span>
02079 <span class="comment"></span>
02080 <span class="comment">Arguments:</span>
02081 <span class="comment"></span>
02082 <span class="comment">    Arbiter - The instance data of the arbiter who was called.</span>
02083 <span class="comment"></span>
02084 <span class="comment">    State - The state of the current arbitration.</span>
02085 <span class="comment"></span>
02086 <span class="comment">Return Value:</span>
02087 <span class="comment"></span>
02088 <span class="comment">    TRUE if we found a range, FALSE otherwise.</span>
02089 <span class="comment"></span>
02090 <span class="comment">--*/</span>
02091 
02092 {
02093 
02094     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02095     ULONG findRangeFlags = 0;
02096 
02097     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02098 
02099     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>);
02100 
02101     <span class="comment">//</span>
02102     <span class="comment">// Catch the case where we backtrack and advance past the maximum</span>
02103     <span class="comment">//</span>
02104 
02105     <span class="keywordflow">if</span> (State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o2">CurrentMinimum</a> &gt; State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o3">CurrentMaximum</a>) {
02106         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02107     }
02108 
02109     <span class="comment">//</span>
02110     <span class="comment">// If we are asking for zero ports then trivially succeed with the minimum</span>
02111     <span class="comment">// value and remember that backtracking this is a recipe for infinite loops</span>
02112     <span class="comment">//</span>
02113 
02114     <span class="keywordflow">if</span> (State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a> == 0) {
02115         State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a> = State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a> = State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o2">CurrentMinimum</a>;
02116         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02117     }
02118 
02119     <span class="comment">//</span>
02120     <span class="comment">// For legacy requests from IoAssignResources (directly or by way of</span>
02121     <span class="comment">// HalAssignSlotResources) or IoReportResourceUsage we consider preallocated</span>
02122     <span class="comment">// resources to be available for backward compatibility reasons.</span>
02123     <span class="comment">//</span>
02124     <span class="comment">// If we are allocating a devices boot config then we consider all other</span>
02125     <span class="comment">// boot configs to be available.  BUGBUG(andrewth) - this behavior is bad!</span>
02126     <span class="comment">//</span>
02127 
02128     <span class="keywordflow">if</span> (State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o4">RequestSource</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a174a126">ArbiterRequestLegacyReported</a>
02129         || State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o4">RequestSource</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a174a128">ArbiterRequestLegacyAssigned</a>) {
02130 
02131         State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o10">RangeAvailableAttributes</a> |= <a class="code" href="../../d9/d8/arbiter_8h.html#a13">ARBITER_RANGE_BOOT_ALLOCATED</a>;
02132     }
02133 
02134     <span class="comment">//</span>
02135     <span class="comment">// Check if null conflicts are OK...</span>
02136     <span class="comment">//</span>
02137 
02138     <span class="keywordflow">if</span> (State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o8">Flags</a> &amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a12">ARBITER_STATE_FLAG_NULL_CONFLICT_OK</a>) {
02139         findRangeFlags |= RTL_RANGE_LIST_NULL_CONFLICT_OK;
02140     }
02141 
02142     <span class="comment">//</span>
02143     <span class="comment">// ...or we are shareable...</span>
02144     <span class="comment">//</span>
02145 
02146     <span class="keywordflow">if</span> (State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a6">ARBITER_ALTERNATIVE_FLAG_SHARED</a>) {
02147         findRangeFlags |= RTL_RANGE_LIST_SHARED_OK;
02148     }
02149 
02150     <span class="comment">//</span>
02151     <span class="comment">// Select the first free alternative from the current alternative</span>
02152     <span class="comment">//</span>
02153 
02154     status = <a class="code" href="../../d2/d5/range_8c.html#a22">RtlFindRange</a>(
02155                  Arbiter-&gt;PossibleAllocation,
02156                  State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o2">CurrentMinimum</a>,
02157                  State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o3">CurrentMaximum</a>,
02158                  State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a>,
02159                  State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o3">Alignment</a>,
02160                  findRangeFlags,
02161                  State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o10">RangeAvailableAttributes</a>,
02162                  Arbiter-&gt;ConflictCallbackContext,
02163                  Arbiter-&gt;ConflictCallback,
02164                  &amp;State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>
02165                  );
02166 
02167 
02168     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02169 
02170         <span class="comment">//</span>
02171         <span class="comment">// We found a suitable range</span>
02172         <span class="comment">//</span>
02173         State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a> = State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a> + State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a> - 1;
02174 
02175         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02176 
02177     } <span class="keywordflow">else</span> {
02178 
02179         <span class="comment">//</span>
02180         <span class="comment">// We couldn't find any range so check if we will allow this conflict</span>
02181         <span class="comment">// - if so don'd fail!</span>
02182         <span class="comment">//</span>
02183 
02184         <span class="keywordflow">return</span> Arbiter-&gt;OverrideConflict(Arbiter, State);
02185     }
02186 }
02187 
02188 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02189"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a84">02189</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a84">ArbAddAllocation</a>(
02190      IN PARBITER_INSTANCE Arbiter,
02191      IN <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
02192      )
02193 
02194 <span class="comment">/*++</span>
02195 <span class="comment"></span>
02196 <span class="comment">Routine Description:</span>
02197 <span class="comment"></span>
02198 <span class="comment">    This routine is called from AllocateEntry once we have found a possible</span>
02199 <span class="comment">    solution (State-&gt;Start - State-&gt;End).  It adds the ranges that will not be</span>
02200 <span class="comment">    available if we commit to this solution to Arbiter-&gt;PossibleAllocation.</span>
02201 <span class="comment"></span>
02202 <span class="comment">Arguments:</span>
02203 <span class="comment"></span>
02204 <span class="comment">    Arbiter - The instance data of the arbiter who was called.</span>
02205 <span class="comment"></span>
02206 <span class="comment">    State - The state of the current arbitration.</span>
02207 <span class="comment"></span>
02208 <span class="comment">Return Value:</span>
02209 <span class="comment"></span>
02210 <span class="comment">    None.</span>
02211 <span class="comment"></span>
02212 <span class="comment">--*/</span>
02213 
02214 {
02215 
02216     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02217 
02218     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02219 
02220     status = <a class="code" href="../../d2/d5/range_8c.html#a16">RtlAddRange</a>(
02221                  Arbiter-&gt;PossibleAllocation,
02222                  State-&gt;Start,
02223                  State-&gt;End,
02224                  State-&gt;RangeAttributes,
02225                  RTL_RANGE_LIST_ADD_IF_CONFLICT +
02226                     (State-&gt;CurrentAlternative-&gt;Flags &amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a6">ARBITER_ALTERNATIVE_FLAG_SHARED</a>
02227                         ? RTL_RANGE_LIST_ADD_SHARED : 0),
02228                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02229                  State-&gt;Entry-&gt;PhysicalDeviceObject
02230                  );
02231 
02232     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
02233 
02234 }
02235 
02236 
02237 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02238"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a81">02238</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a81">ArbBacktrackAllocation</a>(
02239      IN PARBITER_INSTANCE Arbiter,
02240      IN <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
02241      )
02242 
02243 <span class="comment">/*++</span>
02244 <span class="comment"></span>
02245 <span class="comment">Routine Description:</span>
02246 <span class="comment"></span>
02247 <span class="comment">    This routine is called from AllocateEntry if the possible solution</span>
02248 <span class="comment">    (State-&gt;Start - State-&gt;End) does not allow us to allocate resources to</span>
02249 <span class="comment">    the rest of the devices being considered.  It deletes the ranges that were</span>
02250 <span class="comment">    added to Arbiter-&gt;PossibleAllocation by AddAllocation.</span>
02251 <span class="comment"></span>
02252 <span class="comment">Arguments:</span>
02253 <span class="comment"></span>
02254 <span class="comment">    Arbiter - The instance data of the arbiter who was called.</span>
02255 <span class="comment"></span>
02256 <span class="comment">    State - The state of the current arbitration.</span>
02257 <span class="comment"></span>
02258 <span class="comment">Return Value:</span>
02259 <span class="comment"></span>
02260 <span class="comment">    None.</span>
02261 <span class="comment"></span>
02262 <span class="comment">--*/</span>
02263 
02264 
02265 {
02266     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02267 
02268     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02269 
02270     <span class="comment">//</span>
02271     <span class="comment">// We couldn't allocate for the rest of the ranges then</span>
02272     <span class="comment">// backtrack</span>
02273     <span class="comment">//</span>
02274 
02275     status = <a class="code" href="../../d2/d5/range_8c.html#a17">RtlDeleteRange</a>(
02276                  Arbiter-&gt;PossibleAllocation,
02277                  State-&gt;Start,
02278                  State-&gt;End,
02279                  State-&gt;Entry-&gt;PhysicalDeviceObject
02280                  );
02281 
02282     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
02283 
02284     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
02285                 (<span class="stringliteral">"\t\tBacktracking on 0x%I64x-0x%I64x for %p\n"</span>,
02286                 State-&gt;Start,
02287                 State-&gt;End,
02288                 State-&gt;Entry-&gt;PhysicalDeviceObject
02289                 ));
02290 
02291 }
02292 
02293 
02294 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02295"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a75">02295</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a75">ArbPreprocessEntry</a>(
02296     IN PARBITER_INSTANCE Arbiter,
02297     IN <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
02298     )
02299 <span class="comment">/*++</span>
02300 <span class="comment"></span>
02301 <span class="comment">Routine Description:</span>
02302 <span class="comment"></span>
02303 <span class="comment">    This routine is called from AllocateEntry to allow preprocessing of</span>
02304 <span class="comment">    entries</span>
02305 <span class="comment"></span>
02306 <span class="comment">Arguments:</span>
02307 <span class="comment"></span>
02308 <span class="comment">    Arbiter - The instance data of the arbiter who was called.</span>
02309 <span class="comment"></span>
02310 <span class="comment">    State - The state of the current arbitration.</span>
02311 <span class="comment"></span>
02312 <span class="comment">Return Value:</span>
02313 <span class="comment"></span>
02314 <span class="comment">    None.</span>
02315 <span class="comment"></span>
02316 <span class="comment">--*/</span>
02317 {
02318 
02319     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02320 
02321     <span class="keywordflow">return</span> STATUS_SUCCESS;
02322 }
02323 
02324 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02325"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a76">02325</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a76">ArbAllocateEntry</a>(
02326     IN PARBITER_INSTANCE Arbiter,
02327     IN <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
02328     )
02329 <span class="comment">/*++</span>
02330 <span class="comment"></span>
02331 <span class="comment">Routine Description:</span>
02332 <span class="comment"></span>
02333 <span class="comment">    This is the core arbitration routine and is called from TestAllocation</span>
02334 <span class="comment">    to allocate resources for all of the entries in the allocation stack.</span>
02335 <span class="comment">    It calls off to various helper routines (described above) to perform this</span>
02336 <span class="comment">    task.</span>
02337 <span class="comment"></span>
02338 <span class="comment">Arguments:</span>
02339 <span class="comment"></span>
02340 <span class="comment">    Arbiter - The instance data of the arbiter who was called.</span>
02341 <span class="comment"></span>
02342 <span class="comment">    State - The state of the current arbitration.</span>
02343 <span class="comment"></span>
02344 <span class="comment">Return Value:</span>
02345 <span class="comment"></span>
02346 <span class="comment">    None.</span>
02347 <span class="comment"></span>
02348 <span class="comment">--*/</span>
02349 
02350 
02351 
02352 {
02353 
02354     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02355     <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> currentState = State;
02356     BOOLEAN backtracking = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02357 
02358     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02359 
02360     <span class="comment">//</span>
02361     <span class="comment">// Have we reached the end of the list?  If so then we have a working</span>
02362     <span class="comment">// allocation.</span>
02363     <span class="comment">//</span>
02364 
02365 tryAllocation:
02366 
02367     <span class="keywordflow">while</span>(currentState &gt;= State &amp;&amp; currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02368 
02369         <span class="comment">//</span>
02370         <span class="comment">// Do any preprocessing that is required</span>
02371         <span class="comment">//</span>
02372 
02373         status = Arbiter-&gt;PreprocessEntry(Arbiter,currentState);
02374 
02375         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02376             <span class="keywordflow">return</span> status;
02377         }
02378 
02379         <span class="comment">//</span>
02380         <span class="comment">// If we need to backtrack do so!</span>
02381         <span class="comment">//</span>
02382 
02383         <span class="keywordflow">if</span> (backtracking) {
02384 
02385             ULONGLONG possibleCurrentMinimum;
02386 
02387             backtracking = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02388 
02389             <span class="comment">//</span>
02390             <span class="comment">// Clear the CurrentAlternative of the *next* alternative - this will</span>
02391             <span class="comment">// cause the priorities to be recalculated next time through so we</span>
02392             <span class="comment">// will attempt to explore the search space again</span>
02393             <span class="comment">//</span>
02394             <span class="comment">// The currentState+1 is guaranteed to be safe because the only way</span>
02395             <span class="comment">// we can get here is from where we currentState-- below.</span>
02396             <span class="comment">//</span>
02397 
02398             (currentState + 1)-&gt;CurrentAlternative = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02399 
02400             <span class="comment">//</span>
02401             <span class="comment">// We can't backtrack length 0 requests because there is nothing to</span>
02402             <span class="comment">// backtrack so we would get stuck in an inifinite loop...</span>
02403             <span class="comment">//</span>
02404 
02405             <span class="keywordflow">if</span> (currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a> == 0) {
02406                 <span class="keywordflow">goto</span> failAllocation;
02407             }
02408 
02409             <span class="comment">//</span>
02410             <span class="comment">// Backtrack</span>
02411             <span class="comment">//</span>
02412 
02413             Arbiter-&gt;BacktrackAllocation(Arbiter, currentState);
02414 
02415             <span class="comment">//</span>
02416             <span class="comment">// Reduce allocation window to not include the range we backtracked</span>
02417             <span class="comment">// and check that that doesn't underflow the minimum or wrap</span>
02418             <span class="comment">//</span>
02419 
02420             possibleCurrentMinimum = currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a> - 1;
02421 
02422             <span class="keywordflow">if</span> (possibleCurrentMinimum &gt; currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o2">CurrentMinimum</a> <span class="comment">// wrapped</span>
02423             ||  possibleCurrentMinimum &lt; currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o0">Minimum</a>) {
02424 
02425                 <span class="comment">//</span>
02426                 <span class="comment">// We have run out space in this alternative move on to the next</span>
02427                 <span class="comment">//</span>
02428 
02429                 <span class="keywordflow">goto</span> continueWithNextAllocationRange;
02430 
02431             } <span class="keywordflow">else</span> {
02432 
02433                 currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o3">CurrentMaximum</a> = possibleCurrentMinimum;
02434 
02435                 <span class="comment">//</span>
02436                 <span class="comment">// Get back into arbitrating at the right point</span>
02437                 <span class="comment">//</span>
02438 
02439                 <span class="keywordflow">goto</span> continueWithNextSuitableRange;
02440             }
02441         }
02442 
02443         <span class="comment">//</span>
02444         <span class="comment">// Try to allocate for this entry</span>
02445         <span class="comment">//</span>
02446 
02447 continueWithNextAllocationRange:
02448 
02449         <span class="keywordflow">while</span> (Arbiter-&gt;GetNextAllocationRange(Arbiter, currentState)) {
02450 
02451             <a class="code" href="../../d9/d8/arbiter_8h.html#a2">ARB_INDENT</a>(2, (ULONG)(currentState - State));
02452 
02453             <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
02454                         (<span class="stringliteral">"Testing 0x%I64x-0x%I64x %s\n"</span>,
02455                         currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o2">CurrentMinimum</a>,
02456                         currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o3">CurrentMaximum</a>,
02457                         currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a6">ARBITER_ALTERNATIVE_FLAG_SHARED</a> ?
02458                             <span class="stringliteral">"shared"</span> : <span class="stringliteral">"non-shared"</span>
02459                         ));
02460 
02461 continueWithNextSuitableRange:
02462 
02463             <span class="keywordflow">while</span> (Arbiter-&gt;FindSuitableRange(Arbiter, currentState)) {
02464 
02465                 <span class="comment">//</span>
02466                 <span class="comment">// We found a possible solution</span>
02467                 <span class="comment">//</span>
02468 
02469                 <a class="code" href="../../d9/d8/arbiter_8h.html#a2">ARB_INDENT</a>(2, (ULONG)(currentState - State));
02470 
02471                 <span class="keywordflow">if</span> (currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a> != 0) {
02472 
02473                     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
02474                         (<span class="stringliteral">"Possible solution for %p = 0x%I64x-0x%I64x, %s\n"</span>,
02475                         currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>,
02476                         currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>,
02477                         currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a>,
02478                         currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a6">ARBITER_ALTERNATIVE_FLAG_SHARED</a> ?
02479                             <span class="stringliteral">"shared"</span> : <span class="stringliteral">"non-shared"</span>
02480                         ));
02481 
02482                     <span class="comment">//</span>
02483                     <span class="comment">// Update the arbiter with the possible allocation</span>
02484                     <span class="comment">//</span>
02485 
02486                     Arbiter-&gt;AddAllocation(Arbiter, currentState);
02487 
02488                 } <span class="keywordflow">else</span> {
02489 
02490                     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
02491                         (<span class="stringliteral">"Zero length solution solution for %p = 0x%I64x-0x%I64x, %s\n"</span>,
02492                         currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>,
02493                         currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>,
02494                         currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a>,
02495                         currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a6">ARBITER_ALTERNATIVE_FLAG_SHARED</a> ?
02496                             <span class="stringliteral">"shared"</span> : <span class="stringliteral">"non-shared"</span>
02497                         ));
02498 
02499                     <span class="comment">//</span>
02500                     <span class="comment">// Set the result in the arbiter appropriatley so that we</span>
02501                     <span class="comment">// don't try and translate this zero requirement - it won't!</span>
02502                     <span class="comment">//</span>
02503 
02504                     currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o12">Result</a> = <a class="code" href="../../d6/d9/pnp_8h.html#a175a134">ArbiterResultNullRequest</a>;
02505                 }
02506 
02507                 <span class="comment">//</span>
02508                 <span class="comment">// Move on to the next entry</span>
02509                 <span class="comment">//</span>
02510 
02511                 currentState++;
02512                 <span class="keywordflow">goto</span> tryAllocation;
02513             }
02514         }
02515 
02516 failAllocation:
02517 
02518         <span class="comment">//</span>
02519         <span class="comment">// We couldn't allocate for this device</span>
02520         <span class="comment">//</span>
02521 
02522         <span class="keywordflow">if</span> (currentState == State) {
02523 
02524             <span class="comment">//</span>
02525             <span class="comment">// We are at the top of the allocation stack to we can't backtrack -</span>
02526             <span class="comment">// *** GAME OVER ***</span>
02527             <span class="comment">//</span>
02528 
02529             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02530 
02531         } <span class="keywordflow">else</span> {
02532 
02533             <span class="comment">//</span>
02534             <span class="comment">// Backtrack and try again</span>
02535             <span class="comment">//</span>
02536 
02537             <a class="code" href="../../d9/d8/arbiter_8h.html#a2">ARB_INDENT</a>(2, (ULONG)(currentState - State));
02538 
02539             <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
02540                 (<span class="stringliteral">"Allocation failed for %p - backtracking\n"</span>,
02541                 currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>
02542                 ));
02543 
02544             backtracking = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02545 
02546             <span class="comment">//</span>
02547             <span class="comment">// Pop the last state off the stack and try a different path</span>
02548             <span class="comment">//</span>
02549 
02550             currentState--;
02551             <span class="keywordflow">goto</span> tryAllocation;
02552         }
02553     }
02554 
02555     <span class="comment">//</span>
02556     <span class="comment">// We have successfully allocated for all ranges so fill in the allocation</span>
02557     <span class="comment">//</span>
02558 
02559     currentState = State;
02560 
02561     <span class="keywordflow">while</span> (currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02562 
02563         status = Arbiter-&gt;PackResource(
02564                     currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o6">Descriptor</a>,
02565                     currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>,
02566                     currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o10">Assignment</a>
02567                     );
02568 
02569         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
02570 
02571         <span class="comment">//</span>
02572         <span class="comment">// Remember the alternative we chose from so we can retrieve it during retest</span>
02573         <span class="comment">//</span>
02574 
02575         currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o11">SelectedAlternative</a>
02576             = currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o6">Descriptor</a>;
02577 
02578         <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
02579                     (<span class="stringliteral">"Assigned - 0x%I64x-0x%I64x\n"</span>,
02580                     currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>,
02581                     currentState-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a>
02582                     ));
02583 
02584         currentState++;
02585     }
02586 
02587     <span class="keywordflow">return</span> STATUS_SUCCESS;
02588 
02589 }
02590 
02591 BOOLEAN
<a name="l02592"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a38">02592</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a82">ArbGetNextAllocationRange</a>(
02593     IN PARBITER_INSTANCE Arbiter,
02594     IN OUT <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
02595     )
02596 
02597 <span class="comment">/*++</span>
02598 <span class="comment"></span>
02599 <span class="comment">Routine Description:</span>
02600 <span class="comment"></span>
02601 <span class="comment">    This routine attempts to find the next range where allocation should be</span>
02602 <span class="comment">    tried.  It updates State-&gt;CurrentMinimum, State-&gt;CurrentMaximum and</span>
02603 <span class="comment">    State-&gt;CurrentAlternative to indicate this range.</span>
02604 <span class="comment"></span>
02605 <span class="comment">Arguments:</span>
02606 <span class="comment"></span>
02607 <span class="comment">    Arbiter - The instance data of the arbiter</span>
02608 <span class="comment"></span>
02609 <span class="comment">    State - The state of the current arbitration</span>
02610 <span class="comment"></span>
02611 <span class="comment">Return Value:</span>
02612 <span class="comment"></span>
02613 <span class="comment">    TRUE if a range to attemp allocation in is found, FALSE otherwise</span>
02614 <span class="comment"></span>
02615 <span class="comment">--*/</span>
02616 
02617 {
02618 
02619     <a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html">PARBITER_ALTERNATIVE</a> current, lowestAlternative;
02620     ULONGLONG <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>, <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>;
02621     <a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html">PARBITER_ORDERING</a> ordering;
02622 
02623 
02624     <span class="keywordflow">for</span> (;;) {
02625 
02626         <span class="keywordflow">if</span> (State-&gt;CurrentAlternative) {
02627 
02628             <span class="comment">//</span>
02629             <span class="comment">// Update the priority of the alternative we selected last time</span>
02630             <span class="comment">//</span>
02631 
02632             <a class="code" href="../../d8/d8/arbiter_8c.html#a19">ArbpUpdatePriority</a>(Arbiter, State-&gt;CurrentAlternative);
02633 
02634         } <span class="keywordflow">else</span> {
02635 
02636             <span class="comment">//</span>
02637             <span class="comment">// This is the first time we are looking at this alternative or a</span>
02638             <span class="comment">// backtrack - either way we need to update all the priorities</span>
02639             <span class="comment">//</span>
02640 
02641             <a class="code" href="../../d1/d5/translate_8c.html#a1">FOR_ALL_IN_ARRAY</a>(State-&gt;Alternatives,
02642                              State-&gt;AlternativeCount,
02643                              current) {
02644 
02645                 current-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a> = <a class="code" href="../../d9/d8/arbiter_8h.html#a27">ARBITER_PRIORITY_NULL</a>;
02646                 <a class="code" href="../../d8/d8/arbiter_8c.html#a19">ArbpUpdatePriority</a>(Arbiter, current);
02647 
02648             }
02649         }
02650 
02651         <span class="comment">//</span>
02652         <span class="comment">// Find the lowest priority of the alternatives</span>
02653         <span class="comment">//</span>
02654 
02655         lowestAlternative = State-&gt;Alternatives;
02656 
02657         <a class="code" href="../../d1/d5/translate_8c.html#a1">FOR_ALL_IN_ARRAY</a>(State-&gt;Alternatives + 1,
02658                          State-&gt;AlternativeCount - 1,
02659                          current) {
02660 
02661             <span class="keywordflow">if</span> (current-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a> &lt; lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a>) {
02662                 lowestAlternative = current;
02663             }
02664         }
02665 
02666         <a class="code" href="../../d9/d8/arbiter_8h.html#a2">ARB_INDENT</a>(2, (ULONG)(State - Arbiter-&gt;AllocationStack));
02667 
02668         <span class="comment">//</span>
02669         <span class="comment">// Check if we have run out of allocation ranges</span>
02670         <span class="comment">//</span>
02671 
02672         <span class="keywordflow">if</span> (lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a> == <a class="code" href="../../d9/d8/arbiter_8h.html#a30">ARBITER_PRIORITY_EXHAUSTED</a>) {
02673 
02674             <span class="keywordflow">if</span> (lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a7">ARBITER_ALTERNATIVE_FLAG_FIXED</a>) {
02675 
02676                 <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,(<span class="stringliteral">"Fixed alternative exhausted\n"</span>));
02677 
02678             } <span class="keywordflow">else</span> {
02679 
02680                 <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,(<span class="stringliteral">"Alternative exhausted\n"</span>));
02681             }
02682 
02683             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02684 
02685         } <span class="keywordflow">else</span> {
02686 
02687             <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,(
02688                 <span class="stringliteral">"LowestAlternative: [%i] 0x%I64x-0x%I64x L=0x%08x A=0x%08x\n"</span>,
02689                 lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a>,
02690                 lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o0">Minimum</a>,
02691                 lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o1">Maximum</a>,
02692                 lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a>,
02693                 lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o3">Alignment</a>
02694                 ));
02695 
02696         }
02697 
02698         <span class="comment">//</span>
02699         <span class="comment">// Check if we are now allowing reserved ranges</span>
02700         <span class="comment">//</span>
02701 
02702         <span class="keywordflow">if</span> (lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a> == <a class="code" href="../../d9/d8/arbiter_8h.html#a29">ARBITER_PRIORITY_RESERVED</a>
02703         ||  lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a> == <a class="code" href="../../d9/d8/arbiter_8h.html#a28">ARBITER_PRIORITY_PREFERRED_RESERVED</a>) {
02704 
02705             <span class="comment">//</span>
02706             <span class="comment">// Set min and max to be the Minimum and Maximum that the descriptor</span>
02707             <span class="comment">// specified ignoring any reservations or orderings - this is our</span>
02708             <span class="comment">// last chance</span>
02709             <span class="comment">//</span>
02710 
02711             <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a> = lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o0">Minimum</a>;
02712             <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> = lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o1">Maximum</a>;
02713 
02714             <a class="code" href="../../d9/d8/arbiter_8h.html#a2">ARB_INDENT</a>(2, (ULONG)(State - Arbiter-&gt;AllocationStack));
02715 
02716             <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,(<span class="stringliteral">"Allowing reserved ranges\n"</span>));
02717 
02718         } <span class="keywordflow">else</span> {
02719 
02720             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d8/arbiter_8c.html#a14">ORDERING_INDEX_FROM_PRIORITY</a>(lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a>) &gt;= 0 &amp;&amp;
02721                     <a class="code" href="../../d8/d8/arbiter_8c.html#a14">ORDERING_INDEX_FROM_PRIORITY</a>(lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a>) &lt;
02722                       Arbiter-&gt;OrderingList.Count);
02723 
02724             <span class="comment">//</span>
02725             <span class="comment">// Locate the ordering we match</span>
02726             <span class="comment">//</span>
02727 
02728             ordering = &amp;Arbiter-&gt;OrderingList.Orderings
02729                 [<a class="code" href="../../d8/d8/arbiter_8c.html#a14">ORDERING_INDEX_FROM_PRIORITY</a>(lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a>)];
02730 
02731             <span class="comment">//</span>
02732             <span class="comment">// Make sure they overlap and are big enough - this is just paranoia</span>
02733             <span class="comment">//</span>
02734 
02735             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d8/arbiter_8h.html#a23">INTERSECT</a>(lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o0">Minimum</a>,
02736                              lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o1">Maximum</a>,
02737                              ordering-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a>,
02738                              ordering-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a>)
02739                 &amp;&amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a24">INTERSECT_SIZE</a>(lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o0">Minimum</a>,
02740                                   lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o1">Maximum</a>,
02741                                   ordering-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a>,
02742                                   ordering-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a>) &gt;= lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a>);
02743 
02744             <span class="comment">//</span>
02745             <span class="comment">// Calculate the allocation range</span>
02746             <span class="comment">//</span>
02747 
02748             <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a> = <a class="code" href="../../d6/d6/nls_8c.html#a17">__max</a>(lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o0">Minimum</a>, ordering-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a>);
02749 
02750             <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> = <a class="code" href="../../d6/d6/nls_8c.html#a18">__min</a>(lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o1">Maximum</a>, ordering-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a>);
02751 
02752         }
02753 
02754         <span class="comment">//</span>
02755         <span class="comment">// If this is a length 0 requirement then succeed now and avoid much</span>
02756         <span class="comment">// trauma later</span>
02757         <span class="comment">//</span>
02758 
02759         <span class="keywordflow">if</span> (lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a> == 0) {
02760 
02761             <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a> = lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o0">Minimum</a>;
02762             <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> = lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o1">Maximum</a>;
02763 
02764         } <span class="keywordflow">else</span> {
02765 
02766             <span class="comment">//</span>
02767             <span class="comment">// Trim range to match alignment.</span>
02768             <span class="comment">//</span>
02769 
02770             <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a> += lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o3">Alignment</a> - 1;
02771             <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a> -= <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a> % lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o3">Alignment</a>;
02772 
02773             <span class="keywordflow">if</span> ((lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a> - 1) &gt; (<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> - <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>)) {
02774 
02775                 <a class="code" href="../../d9/d8/arbiter_8h.html#a2">ARB_INDENT</a>(3, (ULONG)(State - Arbiter-&gt;AllocationStack));
02776                 <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(3, (<span class="stringliteral">"Range cannot be aligned ... Skipping\n"</span>));
02777 
02778                 <span class="comment">//</span>
02779                 <span class="comment">// Set CurrentAlternative so we will update the priority of this</span>
02780                 <span class="comment">// alternative</span>
02781                 <span class="comment">//</span>
02782 
02783                 State-&gt;CurrentAlternative = lowestAlternative;
02784                 <span class="keywordflow">continue</span>;
02785             }
02786 
02787             <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> -= lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a> - 1;
02788             <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> -= <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> % lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o3">Alignment</a>;
02789             <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> += lowestAlternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a> - 1;
02790 
02791         }
02792 
02793         <span class="comment">//</span>
02794         <span class="comment">// Check if we handed back the same range last time, for the same</span>
02795         <span class="comment">// alternative, if so try to find another range</span>
02796         <span class="comment">//</span>
02797 
02798         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a> == State-&gt;CurrentMinimum
02799         &amp;&amp; <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> == State-&gt;CurrentMaximum
02800         &amp;&amp; State-&gt;CurrentAlternative == lowestAlternative) {
02801 
02802             <a class="code" href="../../d9/d8/arbiter_8h.html#a2">ARB_INDENT</a>(2, (ULONG)(State - Arbiter-&gt;AllocationStack));
02803 
02804             <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
02805                   (<span class="stringliteral">"Skipping identical allocation range\n"</span>
02806             ));
02807 
02808             <span class="keywordflow">continue</span>;
02809         }
02810 
02811         State-&gt;CurrentMinimum = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>;
02812         State-&gt;CurrentMaximum = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>;
02813         State-&gt;CurrentAlternative = lowestAlternative;
02814 
02815         <a class="code" href="../../d9/d8/arbiter_8h.html#a2">ARB_INDENT</a>(2, (ULONG)(State - Arbiter-&gt;AllocationStack));
02816         <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(1, (<span class="stringliteral">"AllocationRange: 0x%I64x-0x%I64x\n"</span>, <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>, <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>));
02817 
02818         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02819 
02820     }
02821 }
02822 
02823 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02824"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a17">02824</a> <a class="code" href="../../d8/d8/arbiter_8c.html#a17">ArbpGetRegistryValue</a>(
02825     IN HANDLE KeyHandle,
02826     IN PWSTR  ValueName,
02827     OUT PKEY_VALUE_FULL_INFORMATION *Information
02828     )
02829 
02830 <span class="comment">/*++</span>
02831 <span class="comment"></span>
02832 <span class="comment">Routine Description:</span>
02833 <span class="comment"></span>
02834 <span class="comment">    This routine is invoked to retrieve the data for a registry key's value.</span>
02835 <span class="comment">    This is done by querying the value of the key with a zero-length buffer</span>
02836 <span class="comment">    to determine the size of the value, and then allocating a buffer and</span>
02837 <span class="comment">    actually querying the value into the buffer.</span>
02838 <span class="comment"></span>
02839 <span class="comment">    It is the responsibility of the caller to free the buffer.</span>
02840 <span class="comment"></span>
02841 <span class="comment">Arguments:</span>
02842 <span class="comment"></span>
02843 <span class="comment">    KeyHandle - Supplies the key handle whose value is to be queried</span>
02844 <span class="comment"></span>
02845 <span class="comment">    ValueName - Supplies the null-terminated Unicode name of the value.</span>
02846 <span class="comment"></span>
02847 <span class="comment">    Information - Returns a pointer to the allocated data buffer.</span>
02848 <span class="comment"></span>
02849 <span class="comment">Return Value:</span>
02850 <span class="comment"></span>
02851 <span class="comment">    The function value is the final status of the query operation.</span>
02852 <span class="comment"></span>
02853 <span class="comment">Note:</span>
02854 <span class="comment"></span>
02855 <span class="comment">    The same as IopGetRegistryValue - it allows us to share the arbiter</span>
02856 <span class="comment">    code with pci.sys</span>
02857 <span class="comment"></span>
02858 <span class="comment">--*/</span>
02859 
02860 {
02861     UNICODE_STRING unicodeString;
02862     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02863     PKEY_VALUE_FULL_INFORMATION infoBuffer;
02864     ULONG keyValueLength;
02865 
02866     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02867 
02868     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> );
02869 
02870     <span class="comment">//</span>
02871     <span class="comment">// Figure out how big the data value is so that a buffer of the</span>
02872     <span class="comment">// appropriate size can be allocated.</span>
02873     <span class="comment">//</span>
02874 
02875     status = ZwQueryValueKey( KeyHandle,
02876                               &amp;unicodeString,
02877                               KeyValueFullInformationAlign64,
02878                               (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02879                               0,
02880                               &amp;keyValueLength );
02881     <span class="keywordflow">if</span> (status != STATUS_BUFFER_OVERFLOW &amp;&amp;
02882         status != STATUS_BUFFER_TOO_SMALL) {
02883         <span class="keywordflow">return</span> status;
02884     }
02885 
02886     <span class="comment">//</span>
02887     <span class="comment">// Allocate a buffer large enough to contain the entire key data value.</span>
02888     <span class="comment">//</span>
02889 
02890     infoBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02891                                         keyValueLength,
02892                                         <a class="code" href="../../d8/d8/arbiter_8c.html#a4">ARBITER_MISC_TAG</a>
02893                                         );
02894 
02895     <span class="keywordflow">if</span> (!infoBuffer) {
02896         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02897     }
02898 
02899     <span class="comment">//</span>
02900     <span class="comment">// Query the data for the key value.</span>
02901     <span class="comment">//</span>
02902 
02903     status = ZwQueryValueKey( KeyHandle,
02904                               &amp;unicodeString,
02905                               KeyValueFullInformationAlign64,
02906                               infoBuffer,
02907                               keyValueLength,
02908                               &amp;keyValueLength );
02909     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02910         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( infoBuffer );
02911         <span class="keywordflow">return</span> status;
02912     }
02913 
02914     <span class="comment">//</span>
02915     <span class="comment">// Everything worked, so simply return the address of the allocated</span>
02916     <span class="comment">// buffer to the caller, who is now responsible for freeing it.</span>
02917     <span class="comment">//</span>
02918 
02919     *Information = infoBuffer;
02920     <span class="keywordflow">return</span> STATUS_SUCCESS;
02921 }
02922 
02923 
<a name="l02924"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a15">02924</a> <span class="preprocessor">#define ARBITER_ORDERING_LIST_INITIAL_SIZE      16</span>
02925 <span class="preprocessor"></span>
02926 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02927"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a62">02927</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a62">ArbInitializeOrderingList</a>(
02928     IN OUT <a class="code" href="../../d2/d8/struct__ARBITER__ORDERING__LIST.html">PARBITER_ORDERING_LIST</a> List
02929     )
02930 
02931 <span class="comment">/*++</span>
02932 <span class="comment"></span>
02933 <span class="comment">Routine Description:</span>
02934 <span class="comment"></span>
02935 <span class="comment">    This routine inititialize an arbiter ordering list.</span>
02936 <span class="comment"></span>
02937 <span class="comment">Arguments:</span>
02938 <span class="comment"></span>
02939 <span class="comment">    List - The list to be initialized</span>
02940 <span class="comment"></span>
02941 <span class="comment">Return Value:</span>
02942 <span class="comment"></span>
02943 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
02944 <span class="comment"></span>
02945 <span class="comment">--*/</span>
02946 
02947 {
02948     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02949 
02950     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
02951 
02952     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Orderings = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02953                                             <a class="code" href="../../d8/d8/arbiter_8c.html#a15">ARBITER_ORDERING_LIST_INITIAL_SIZE</a> *
02954                                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html">ARBITER_ORDERING</a>),
02955                                             <a class="code" href="../../d8/d8/arbiter_8c.html#a3">ARBITER_ORDERING_LIST_TAG</a>
02956                                             );
02957 
02958     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Orderings) {
02959         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Maximum = 0;
02960         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count = 0;
02961         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02962     }
02963 
02964     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count = 0;
02965     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Maximum = <a class="code" href="../../d8/d8/arbiter_8c.html#a15">ARBITER_ORDERING_LIST_INITIAL_SIZE</a>;
02966 
02967     <span class="keywordflow">return</span> STATUS_SUCCESS;
02968 }
02969 
02970 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02971"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a64">02971</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a64">ArbCopyOrderingList</a>(
02972     OUT <a class="code" href="../../d2/d8/struct__ARBITER__ORDERING__LIST.html">PARBITER_ORDERING_LIST</a> Destination,
02973     IN <a class="code" href="../../d2/d8/struct__ARBITER__ORDERING__LIST.html">PARBITER_ORDERING_LIST</a> Source
02974     )
02975 
02976 <span class="comment">/*++</span>
02977 <span class="comment"></span>
02978 <span class="comment">Routine Description:</span>
02979 <span class="comment"></span>
02980 <span class="comment">    This routine copies an arbiter ordering list.</span>
02981 <span class="comment"></span>
02982 <span class="comment">Arguments:</span>
02983 <span class="comment"></span>
02984 <span class="comment">    Destination - An uninitialized arbiter ordering list where the data</span>
02985 <span class="comment">        should be copied from</span>
02986 <span class="comment"></span>
02987 <span class="comment">    Source - Arbiter ordering list to be copied</span>
02988 <span class="comment">Return Value:</span>
02989 <span class="comment"></span>
02990 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
02991 <span class="comment"></span>
02992 <span class="comment">--*/</span>
02993 
02994 
02995 {
02996 
02997     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>()
02998 
02999     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Source-&gt;Count &lt;= Source-&gt;Maximum);
03000     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Source-&gt;Maximum &gt; 0);
03001 
03002     Destination-&gt;Orderings =
03003         <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03004                               Source-&gt;Maximum * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html">ARBITER_ORDERING</a>),
03005                               <a class="code" href="../../d8/d8/arbiter_8c.html#a3">ARBITER_ORDERING_LIST_TAG</a>
03006                               );
03007 
03008     <span class="keywordflow">if</span> (Destination-&gt;Orderings == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03009         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03010     }
03011 
03012     Destination-&gt;Count = Source-&gt;Count;
03013     Destination-&gt;Maximum = Source-&gt;Maximum;
03014 
03015     <span class="keywordflow">if</span> (Source-&gt;Count &gt; 0) {
03016 
03017         RtlCopyMemory(Destination-&gt;Orderings,
03018                       Source-&gt;Orderings,
03019                       Source-&gt;Count * <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/arbiter_8h.html#a31">ARBITER_ORDERING</a>)
03020                       );
03021     }
03022 
03023     <span class="keywordflow">return</span> STATUS_SUCCESS;
03024 }
03025 
03026 
03027 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03028"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a65">03028</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a65">ArbAddOrdering</a>(
03029     OUT <a class="code" href="../../d2/d8/struct__ARBITER__ORDERING__LIST.html">PARBITER_ORDERING_LIST</a> List,
03030     IN ULONGLONG Start,
03031     IN ULONGLONG End
03032     )
03033 
03034 <span class="comment">/*++</span>
03035 <span class="comment"></span>
03036 <span class="comment">Routine Description:</span>
03037 <span class="comment"></span>
03038 <span class="comment">    This routine adds the range Start-End to the end of the ordering list.  No</span>
03039 <span class="comment">    checking for overlaps or pruning is done (see ArbpPruneOrdering)</span>
03040 <span class="comment"></span>
03041 <span class="comment">Arguments:</span>
03042 <span class="comment"></span>
03043 <span class="comment">    OrderingList - The list where the range should be added.</span>
03044 <span class="comment"></span>
03045 <span class="comment">    Start - The start of the range to be added.</span>
03046 <span class="comment"></span>
03047 <span class="comment">    End - The end of the range to be added.</span>
03048 <span class="comment"></span>
03049 <span class="comment">Return Value:</span>
03050 <span class="comment"></span>
03051 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03052 <span class="comment"></span>
03053 <span class="comment">--*/</span>
03054 
03055 {
03056 
03057     <span class="comment">//</span>
03058     <span class="comment">// Validate parameters</span>
03059     <span class="comment">//</span>
03060 
03061     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>) {
03062         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
03063     }
03064 
03065     <span class="comment">//</span>
03066     <span class="comment">// Check if the buffer is full</span>
03067     <span class="comment">//</span>
03068 
03069     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count == <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Maximum) {
03070 
03071         <a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html">PARBITER_ORDERING</a> temp;
03072 
03073         <span class="comment">//</span>
03074         <span class="comment">// Out of space - grow the buffer</span>
03075         <span class="comment">//</span>
03076 
03077         temp = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03078                               (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count + <a class="code" href="../../d8/d8/arbiter_8c.html#a10">ARBITER_ORDERING_GROW_SIZE</a>) *
03079                                   <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html">ARBITER_ORDERING</a>),
03080                               <a class="code" href="../../d8/d8/arbiter_8c.html#a3">ARBITER_ORDERING_LIST_TAG</a>
03081                               );
03082 
03083         <span class="keywordflow">if</span> (!temp) {
03084             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03085         }
03086 
03087         <span class="comment">//</span>
03088         <span class="comment">// If we had any orderings copy them</span>
03089         <span class="comment">//</span>
03090 
03091         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Orderings) {
03092 
03093             RtlCopyMemory(temp,
03094                           <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Orderings,
03095                           <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count * <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/arbiter_8h.html#a31">ARBITER_ORDERING</a>)
03096                           );
03097 
03098             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Orderings);
03099         }
03100 
03101         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Maximum += <a class="code" href="../../d8/d8/arbiter_8c.html#a10">ARBITER_ORDERING_GROW_SIZE</a>;
03102         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Orderings = temp;
03103 
03104     }
03105 
03106     <span class="comment">//</span>
03107     <span class="comment">// Add the entry to the list</span>
03108     <span class="comment">//</span>
03109 
03110     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Orderings[<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count].Start = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
03111     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Orderings[<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count].End = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
03112     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count++;
03113 
03114     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count &lt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Maximum);
03115 
03116     <span class="keywordflow">return</span> STATUS_SUCCESS;
03117 }
03118 
03119 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03120"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a66">03120</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a66">ArbPruneOrdering</a>(
03121     IN OUT <a class="code" href="../../d2/d8/struct__ARBITER__ORDERING__LIST.html">PARBITER_ORDERING_LIST</a> OrderingList,
03122     IN ULONGLONG Start,
03123     IN ULONGLONG End
03124     )
03125 
03126 <span class="comment">/*++</span>
03127 <span class="comment"></span>
03128 <span class="comment">Routine Description:</span>
03129 <span class="comment"></span>
03130 <span class="comment">    This routine removes the range Start-End from all entries in the ordering</span>
03131 <span class="comment">    list, splitting ranges into two or deleting them as necessary.</span>
03132 <span class="comment"></span>
03133 <span class="comment">Arguments:</span>
03134 <span class="comment"></span>
03135 <span class="comment">    OrderingList - The list to be pruned.</span>
03136 <span class="comment"></span>
03137 <span class="comment">    Start - The start of the range to be deleted.</span>
03138 <span class="comment"></span>
03139 <span class="comment">    End - The end of the range to be deleted.</span>
03140 <span class="comment"></span>
03141 <span class="comment">Return Value:</span>
03142 <span class="comment"></span>
03143 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03144 <span class="comment"></span>
03145 <span class="comment">Note:</span>
03146 <span class="comment"></span>
03147 <span class="comment">    In the comments below *** represents the range Start - End and --- the range</span>
03148 <span class="comment">    current-&gt;Start - current-&gt;End.</span>
03149 <span class="comment"></span>
03150 <span class="comment">--*/</span>
03151 
03152 {
03153 
03154     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03155     <a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html">PARBITER_ORDERING</a> current, currentInsert, newOrdering = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, temp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03156     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> count;
03157 
03158     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OrderingList);
03159     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OrderingList-&gt;Orderings);
03160 
03161     <span class="comment">//</span>
03162     <span class="comment">// Validate parameters</span>
03163     <span class="comment">//</span>
03164 
03165     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>) {
03166         status = STATUS_INVALID_PARAMETER;
03167         <span class="keywordflow">goto</span> cleanup;
03168     }
03169 
03170     <span class="comment">//</span>
03171     <span class="comment">// Allocate a buffer big enough for all eventualities</span>
03172     <span class="comment">//</span>
03173 
03174     newOrdering = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03175                                         (OrderingList-&gt;Count * 2 + 1) *
03176                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html">ARBITER_ORDERING</a>),
03177                                         <a class="code" href="../../d8/d8/arbiter_8c.html#a3">ARBITER_ORDERING_LIST_TAG</a>
03178                                         );
03179 
03180     <span class="keywordflow">if</span> (!newOrdering) {
03181         status = STATUS_INSUFFICIENT_RESOURCES;
03182         <span class="keywordflow">goto</span> cleanup;
03183     }
03184 
03185     currentInsert = newOrdering;
03186 
03187     <span class="comment">//</span>
03188     <span class="comment">// Do we have a current ordering?</span>
03189     <span class="comment">//</span>
03190 
03191     <span class="keywordflow">if</span> (OrderingList-&gt;Count &gt; 0) {
03192 
03193         <span class="comment">//</span>
03194         <span class="comment">// Iterate through the current ordering and prune accordingly</span>
03195         <span class="comment">//</span>
03196 
03197         <a class="code" href="../../d1/d5/translate_8c.html#a1">FOR_ALL_IN_ARRAY</a>(OrderingList-&gt;Orderings, OrderingList-&gt;Count, current) {
03198 
03199             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &lt; current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a> || <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &gt; current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a>) {
03200 
03201                 <span class="comment">//</span>
03202                 <span class="comment">// ****      or      ****</span>
03203                 <span class="comment">//      ----    ----</span>
03204                 <span class="comment">//</span>
03205                 <span class="comment">// We don't overlap so copy the range unchanged</span>
03206                 <span class="comment">//</span>
03207 
03208                 *currentInsert++ = *current;
03209 
03210             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &gt; current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a>) {
03211 
03212                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &lt; current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a>) {
03213 
03214                     <span class="comment">//</span>
03215                     <span class="comment">//   ****</span>
03216                     <span class="comment">// --------</span>
03217                     <span class="comment">//</span>
03218                     <span class="comment">// Split the range into two</span>
03219                     <span class="comment">//</span>
03220 
03221                     currentInsert-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a> = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> + 1;
03222                     currentInsert-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a> = current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a>;
03223                     currentInsert++;
03224 
03225                     currentInsert-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a> = current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a>;
03226                     currentInsert-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a> = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - 1;
03227                     currentInsert++;
03228 
03229 
03230                 } <span class="keywordflow">else</span> {
03231 
03232                     <span class="comment">//</span>
03233                     <span class="comment">//       **** or     ****</span>
03234                     <span class="comment">// --------      --------</span>
03235                     <span class="comment">//</span>
03236                     <span class="comment">// Prune the end of the range</span>
03237                     <span class="comment">//</span>
03238 
03239                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &gt;= current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a>);
03240 
03241                     currentInsert-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a> = current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a>;
03242                     currentInsert-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a> = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - 1;
03243                     currentInsert++;
03244                 }
03245             } <span class="keywordflow">else</span> {
03246 
03247                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Start &lt;= current-&gt;<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>);
03248 
03249                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &lt; current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a>) {
03250 
03251                     <span class="comment">//</span>
03252                     <span class="comment">// ****       or ****</span>
03253                     <span class="comment">//   --------    --------</span>
03254                     <span class="comment">//</span>
03255                     <span class="comment">// Prune the start of the range</span>
03256                     <span class="comment">//</span>
03257 
03258                     currentInsert-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a> = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> + 1;
03259                     currentInsert-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a> = current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a>;
03260                     currentInsert++;
03261 
03262                 } <span class="keywordflow">else</span> {
03263 
03264                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &gt;= current-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a>);
03265 
03266                     <span class="comment">//</span>
03267                     <span class="comment">// ******** or ********</span>
03268                     <span class="comment">//   ----      --------</span>
03269                     <span class="comment">//</span>
03270                     <span class="comment">// Don't copy the range (ie. Delete it)</span>
03271                     <span class="comment">//</span>
03272 
03273                 }
03274             }
03275         }
03276     }
03277 
03278 
03279     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(currentInsert - newOrdering &gt;= 0);
03280 
03281     count = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(currentInsert - newOrdering);
03282 
03283     <span class="comment">//</span>
03284     <span class="comment">// Check if we have any orderings left</span>
03285     <span class="comment">//</span>
03286 
03287     <span class="keywordflow">if</span> (count &gt; 0) {
03288 
03289         <span class="keywordflow">if</span> (count &gt; OrderingList-&gt;Maximum) {
03290 
03291             <span class="comment">//</span>
03292             <span class="comment">// There isn't enough space so allocate a new buffer</span>
03293             <span class="comment">//</span>
03294 
03295             temp =
03296                 <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03297                                       count * <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/arbiter_8h.html#a31">ARBITER_ORDERING</a>),
03298                                       <a class="code" href="../../d8/d8/arbiter_8c.html#a3">ARBITER_ORDERING_LIST_TAG</a>
03299                                       );
03300 
03301             <span class="keywordflow">if</span> (!temp) {
03302                 status = STATUS_INSUFFICIENT_RESOURCES;
03303                 <span class="keywordflow">goto</span> cleanup;
03304             }
03305 
03306             <span class="keywordflow">if</span> (OrderingList-&gt;Orderings) {
03307                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(OrderingList-&gt;Orderings);
03308             }
03309 
03310             OrderingList-&gt;Orderings = temp;
03311             OrderingList-&gt;Maximum = count;
03312 
03313         }
03314 
03315 
03316         <span class="comment">//</span>
03317         <span class="comment">// Copy the new ordering</span>
03318         <span class="comment">//</span>
03319 
03320         RtlCopyMemory(OrderingList-&gt;Orderings,
03321                       newOrdering,
03322                       count * <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/arbiter_8h.html#a31">ARBITER_ORDERING</a>)
03323                       );
03324     }
03325 
03326     <span class="comment">//</span>
03327     <span class="comment">// Free our temporary buffer</span>
03328     <span class="comment">//</span>
03329 
03330     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(newOrdering);
03331 
03332     OrderingList-&gt;Count = count;
03333 
03334     <span class="keywordflow">return</span> STATUS_SUCCESS;
03335 
03336 cleanup:
03337 
03338     <span class="keywordflow">if</span> (newOrdering) {
03339         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(newOrdering);
03340     }
03341 
03342     <span class="keywordflow">if</span> (temp) {
03343         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(temp);
03344     }
03345 
03346     <span class="keywordflow">return</span> status;
03347 
03348 }
03349 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03350"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a43">03350</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a63">ArbFreeOrderingList</a>(
03351     IN <a class="code" href="../../d2/d8/struct__ARBITER__ORDERING__LIST.html">PARBITER_ORDERING_LIST</a> List
03352     )
03353 <span class="comment">/*++</span>
03354 <span class="comment"></span>
03355 <span class="comment">Routine Description:</span>
03356 <span class="comment"></span>
03357 <span class="comment">    Frees storage associated with an ordering list.</span>
03358 <span class="comment">    Reverses ArbInitializeOrderingList.</span>
03359 <span class="comment"></span>
03360 <span class="comment">Arguments:</span>
03361 <span class="comment"></span>
03362 <span class="comment">    List - The list to be fred</span>
03363 <span class="comment"></span>
03364 <span class="comment">Return Value:</span>
03365 <span class="comment"></span>
03366 <span class="comment">    None</span>
03367 <span class="comment">--*/</span>
03368 
03369 {
03370     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Orderings) {
03371         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Maximum);
03372         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Orderings);
03373     }
03374 
03375     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count = 0;
03376     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Maximum = 0;
03377     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Orderings = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03378 }
03379 
03380 
03381 
03382 BOOLEAN
<a name="l03383"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a79">03383</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a79">ArbOverrideConflict</a>(
03384     IN PARBITER_INSTANCE Arbiter,
03385     IN <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
03386     )
03387 
03388 <span class="comment">/*++</span>
03389 <span class="comment"></span>
03390 <span class="comment">Routine Description:</span>
03391 <span class="comment"></span>
03392 <span class="comment">    This is the default implementation of override conflict which</span>
03393 <span class="comment"></span>
03394 <span class="comment">Arguments:</span>
03395 <span class="comment"></span>
03396 <span class="comment">    Arbiter - The instance data of the arbiter who was called.</span>
03397 <span class="comment"></span>
03398 <span class="comment">    State - The state of the current arbitration.</span>
03399 <span class="comment"></span>
03400 <span class="comment">Return Value:</span>
03401 <span class="comment"></span>
03402 <span class="comment">    TRUE if the conflict is allowable, false otherwise</span>
03403 <span class="comment"></span>
03404 <span class="comment">--*/</span>
03405 
03406 {
03407 
03408     PRTL_RANGE current;
03409     RTL_RANGE_LIST_ITERATOR iterator;
03410     BOOLEAN ok = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03411 
03412     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03413 
03414     <span class="keywordflow">if</span> (!(State-&gt;CurrentAlternative-&gt;Flags &amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a7">ARBITER_ALTERNATIVE_FLAG_FIXED</a>)) {
03415         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03416     }
03417 
03418     FOR_ALL_RANGES(Arbiter-&gt;PossibleAllocation, &amp;iterator, current) {
03419 
03420         <span class="comment">//</span>
03421         <span class="comment">// Only test the overlapping ones</span>
03422         <span class="comment">//</span>
03423 
03424         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d8/arbiter_8h.html#a23">INTERSECT</a>(current-&gt;Start, current-&gt;End, State-&gt;CurrentMinimum, State-&gt;CurrentMaximum)) {
03425 
03426 
03427             <span class="comment">//</span>
03428             <span class="comment">// Check if we should ignore the range because of its attributes</span>
03429             <span class="comment">//</span>
03430 
03431             <span class="keywordflow">if</span> (current-&gt;Attributes &amp; State-&gt;RangeAvailableAttributes) {
03432 
03433                 <span class="comment">//</span>
03434                 <span class="comment">// We DON'T set ok to true because we are just ignoring the range,</span>
03435                 <span class="comment">// as RtlFindRange would have and thus it can't be the cause of</span>
03436                 <span class="comment">// RtlFindRange failing, so ignoring it can't fix the conflict.</span>
03437                 <span class="comment">//</span>
03438 
03439                 <span class="keywordflow">continue</span>;
03440             }
03441 
03442             <span class="comment">//</span>
03443             <span class="comment">// Check if we are conflicting with ourselves AND the conflicting range</span>
03444             <span class="comment">// is a fixed requirement</span>
03445             <span class="comment">//</span>
03446 
03447             <span class="keywordflow">if</span> (current-&gt;Owner == State-&gt;Entry-&gt;PhysicalDeviceObject
03448             &amp;&amp; State-&gt;CurrentAlternative-&gt;Flags &amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a7">ARBITER_ALTERNATIVE_FLAG_FIXED</a>) {
03449 
03450                 State-&gt;Start=State-&gt;CurrentMinimum;
03451                 State-&gt;End=State-&gt;CurrentMaximum;
03452 
03453                 ok = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03454                 <span class="keywordflow">continue</span>;
03455             }
03456 
03457             <span class="comment">//</span>
03458             <span class="comment">// The conflict is still valid</span>
03459             <span class="comment">//</span>
03460 
03461             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03462         }
03463     }
03464     <span class="keywordflow">return</span> ok;
03465 }
03466 
03467 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03468"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a19">03468</a> <a class="code" href="../../d8/d8/arbiter_8c.html#a19">ArbpUpdatePriority</a>(
03469     PARBITER_INSTANCE Arbiter,
03470     <a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html">PARBITER_ALTERNATIVE</a> Alternative
03471     )
03472 
03473 <span class="comment">/*++</span>
03474 <span class="comment"></span>
03475 <span class="comment">Routine Description:</span>
03476 <span class="comment"></span>
03477 <span class="comment">    This routine updates the priority of an arbiter alternative.</span>
03478 <span class="comment"></span>
03479 <span class="comment">Arguments:</span>
03480 <span class="comment"></span>
03481 <span class="comment">    Arbiter - The arbiter we are operating on</span>
03482 <span class="comment"></span>
03483 <span class="comment">    Alternative - The alternative currently being considered</span>
03484 <span class="comment"></span>
03485 <span class="comment">Return Value:</span>
03486 <span class="comment"></span>
03487 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03488 <span class="comment"></span>
03489 <span class="comment">Note:</span>
03490 <span class="comment"></span>
03491 <span class="comment">    The priorities are a LONG values organised as:</span>
03492 <span class="comment"></span>
03493 <span class="comment">    &lt;------Preferred priorities-----&gt; &lt;-----Ordinary Priorities-----&gt;</span>
03494 <span class="comment"></span>
03495 <span class="comment">    MINLONG--------------------------0-----------------------------MAXLONG</span>
03496 <span class="comment">                                     ^                               ^ ^ ^</span>
03497 <span class="comment">                                     |                               | | |</span>
03498 <span class="comment">                                    NULL            PREFERRED_RESERVED | |</span>
03499 <span class="comment">                                                                RESERVED |</span>
03500 <span class="comment">                                                                     EXHAUSTED</span>
03501 <span class="comment"></span>
03502 <span class="comment">    An ordinary priority is calculated the (index + 1) of the next ordering it</span>
03503 <span class="comment">    intersects with (and has enough space for an allocation).</span>
03504 <span class="comment"></span>
03505 <span class="comment">    A preferred priority is the ordinary priority * - 1</span>
03506 <span class="comment"></span>
03507 <span class="comment">    In this way by examining each of the alternatives in priority order (lowest</span>
03508 <span class="comment">    first) we achieve the desired allocation order of:</span>
03509 <span class="comment"></span>
03510 <span class="comment">    (1) Preferred alternative with non-reserved resources</span>
03511 <span class="comment">    (2) Alternatives with non-reserved resources</span>
03512 <span class="comment">    (3) Preferred reserved resources</span>
03513 <span class="comment">    (4) Reserved Resources</span>
03514 <span class="comment"></span>
03515 <span class="comment">    MAXLONG the worst priority indicates that there are no more allocation ranges</span>
03516 <span class="comment">    left.</span>
03517 <span class="comment"></span>
03518 <span class="comment">--*/</span>
03519 
03520 {
03521 
03522     <a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html">PARBITER_ORDERING</a> ordering;
03523     BOOLEAN preferred;
03524     LONG priority;
03525 
03526     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03527 
03528     priority = Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a>;
03529 
03530     <span class="comment">//</span>
03531     <span class="comment">// If we have already tried the reserved resources then we are out of luck!</span>
03532     <span class="comment">//</span>
03533 
03534     <span class="keywordflow">if</span> (priority == <a class="code" href="../../d9/d8/arbiter_8h.html#a29">ARBITER_PRIORITY_RESERVED</a>
03535     ||  priority == <a class="code" href="../../d9/d8/arbiter_8h.html#a28">ARBITER_PRIORITY_PREFERRED_RESERVED</a>) {
03536 
03537         Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a> = <a class="code" href="../../d9/d8/arbiter_8h.html#a30">ARBITER_PRIORITY_EXHAUSTED</a>;
03538         <span class="keywordflow">return</span>;
03539     }
03540 
03541     <span class="comment">//</span>
03542     <span class="comment">// Check if this is a preferred value - we treat them specially</span>
03543     <span class="comment">//</span>
03544 
03545     preferred = Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o6">Descriptor</a>-&gt;Option &amp; IO_RESOURCE_PREFERRED;
03546 
03547     <span class="comment">//</span>
03548     <span class="comment">// If priority is NULL then we haven't started calculating one so we</span>
03549     <span class="comment">// should start the search from the initial ordering</span>
03550     <span class="comment">//</span>
03551 
03552     <span class="keywordflow">if</span> (priority == <a class="code" href="../../d9/d8/arbiter_8h.html#a27">ARBITER_PRIORITY_NULL</a>) {
03553 
03554         ordering = Arbiter-&gt;OrderingList.Orderings;
03555 
03556     } <span class="keywordflow">else</span> {
03557 
03558         <span class="comment">//</span>
03559         <span class="comment">// If we are a fixed resource then there is no point</span>
03560         <span class="comment">// in trying to find another range - it will be the</span>
03561         <span class="comment">// same and thus still conflict.  Mark this alternative as</span>
03562         <span class="comment">// exhausted</span>
03563         <span class="comment">//</span>
03564 
03565         <span class="keywordflow">if</span> (Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a7">ARBITER_ALTERNATIVE_FLAG_FIXED</a>) {
03566 
03567             Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a> = <a class="code" href="../../d9/d8/arbiter_8h.html#a30">ARBITER_PRIORITY_EXHAUSTED</a>;
03568 
03569             <span class="keywordflow">return</span>;
03570         }
03571 
03572         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d8/arbiter_8c.html#a14">ORDERING_INDEX_FROM_PRIORITY</a>(Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a>) &gt;= 0 &amp;&amp;
03573                 <a class="code" href="../../d8/d8/arbiter_8c.html#a14">ORDERING_INDEX_FROM_PRIORITY</a>(Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a>) &lt;
03574                  Arbiter-&gt;OrderingList.Count);
03575 
03576         ordering = &amp;Arbiter-&gt;OrderingList.Orderings
03577             [<a class="code" href="../../d8/d8/arbiter_8c.html#a14">ORDERING_INDEX_FROM_PRIORITY</a>(Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a>) + 1];
03578 
03579     }
03580 
03581     <span class="comment">//</span>
03582     <span class="comment">// Now find the first member of the assignent ordering for this arbiter</span>
03583     <span class="comment">// where we have an overlap big enough</span>
03584     <span class="comment">//</span>
03585 
03586     <a class="code" href="../../d1/d5/translate_8c.html#a2">FOR_REST_IN_ARRAY</a>(Arbiter-&gt;OrderingList.Orderings,
03587                       Arbiter-&gt;OrderingList.Count,
03588                       ordering) {
03589 
03590         <span class="comment">//</span>
03591         <span class="comment">// Is the ordering applicable?</span>
03592         <span class="comment">//</span>
03593 
03594         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d8/arbiter_8h.html#a23">INTERSECT</a>(Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o0">Minimum</a>, Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o1">Maximum</a>,
03595                       ordering-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a>, ordering-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a>)
03596         &amp;&amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a24">INTERSECT_SIZE</a>(Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o0">Minimum</a>, Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o1">Maximum</a>,
03597                           ordering-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o0">Start</a>,ordering-&gt;<a class="code" href="../../d1/d8/struct__ARBITER__ORDERING.html#o1">End</a>) &gt;= Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a>) {
03598 
03599             <span class="comment">//</span>
03600             <span class="comment">// This is out guy, calculate his priority</span>
03601             <span class="comment">//</span>
03602 
03603             Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a> = (LONG)(ordering - Arbiter-&gt;OrderingList.Orderings + 1);
03604 
03605             <span class="comment">//</span>
03606             <span class="comment">// Preferred priorities are -ve</span>
03607             <span class="comment">//</span>
03608 
03609             <span class="keywordflow">if</span> (preferred) {
03610                 Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a> *= -1;
03611             }
03612 
03613             <span class="keywordflow">return</span>;
03614         }
03615     }
03616 
03617     <span class="comment">//</span>
03618     <span class="comment">// We have runout of non-reserved resources so try the reserved ones</span>
03619     <span class="comment">//</span>
03620 
03621     <span class="keywordflow">if</span> (preferred) {
03622         Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a> = <a class="code" href="../../d9/d8/arbiter_8h.html#a28">ARBITER_PRIORITY_PREFERRED_RESERVED</a>;
03623     } <span class="keywordflow">else</span> {
03624         Alternative-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o4">Priority</a> = <a class="code" href="../../d9/d8/arbiter_8h.html#a29">ARBITER_PRIORITY_RESERVED</a>;
03625     }
03626 
03627 }
03628 
03629 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03630"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a74">03630</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a74">ArbAddReserved</a>(
03631     IN PARBITER_INSTANCE Arbiter,
03632     IN PIO_RESOURCE_DESCRIPTOR Requirement      OPTIONAL,
03633     IN PCM_PARTIAL_RESOURCE_DESCRIPTOR Resource OPTIONAL
03634     )
03635 {
03636     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03637 
03638     <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
03639 }
03640 
03641 BOOLEAN
<a name="l03642"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a20">03642</a> <a class="code" href="../../d8/d8/arbiter_8c.html#a20">ArbpQueryConflictCallback</a>(
03643     IN PVOID Context,
03644     IN PRTL_RANGE Range
03645     )
03646 
03647 <span class="comment">/*++</span>
03648 <span class="comment"></span>
03649 <span class="comment">Routine Description:</span>
03650 <span class="comment"></span>
03651 <span class="comment">    This call back is called from FindSuitableRange (via RtlFindRange) when we</span>
03652 <span class="comment">    encounter an conflicting range.</span>
03653 <span class="comment"></span>
03654 <span class="comment">Arguments:</span>
03655 <span class="comment"></span>
03656 <span class="comment">    Context - Actually a PRTL_RANGE * where we store the range we conflicted</span>
03657 <span class="comment">        with.</span>
03658 <span class="comment"></span>
03659 <span class="comment">    Range - The range we conflict with.</span>
03660 <span class="comment"></span>
03661 <span class="comment">Return Value:</span>
03662 <span class="comment"></span>
03663 <span class="comment">    FALSE</span>
03664 <span class="comment"></span>
03665 <span class="comment">--*/</span>
03666 
03667 {
03668     PRTL_RANGE *conflictingRange = (PRTL_RANGE*)Context;
03669 
03670     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03671 
03672     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,(<span class="stringliteral">"Possible conflict: (%p) 0x%I64x-0x%I64x Owner: %p"</span>,
03673                    Range,
03674                    Range-&gt;Start,
03675                    Range-&gt;End,
03676                    Range-&gt;Owner
03677                 ));
03678 
03679     <span class="comment">//</span>
03680     <span class="comment">// Remember the conflicting range</span>
03681     <span class="comment">//</span>
03682 
03683     *conflictingRange = Range;
03684 
03685     <span class="comment">//</span>
03686     <span class="comment">// We want to allow the rest of FindSuitableRange to determine if this really</span>
03687     <span class="comment">// is a conflict.</span>
03688     <span class="comment">//</span>
03689 
03690     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03691 }
03692 
03693 
03694 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03695"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a80">03695</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a80">ArbQueryConflict</a>(
03696     IN PARBITER_INSTANCE Arbiter,
03697     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject,
03698     IN PIO_RESOURCE_DESCRIPTOR ConflictingResource,
03699     OUT PULONG ConflictCount,
03700     OUT <a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">PARBITER_CONFLICT_INFO</a> *Conflicts
03701     )
03702 
03703 <span class="comment">/*++</span>
03704 <span class="comment"></span>
03705 <span class="comment">Routine Description:</span>
03706 <span class="comment"></span>
03707 <span class="comment">    This routine examines the arbiter state and returns a list of devices that</span>
03708 <span class="comment">    conflict with ConflictingResource</span>
03709 <span class="comment"></span>
03710 <span class="comment">Arguments:</span>
03711 <span class="comment"></span>
03712 <span class="comment">    Arbiter - The arbiter to examine conflicts in</span>
03713 <span class="comment"></span>
03714 <span class="comment">    ConflictingResource - The resource we want to know the conflicts with</span>
03715 <span class="comment"></span>
03716 <span class="comment">    ConflictCount - On success contains the number of conflicts detected</span>
03717 <span class="comment"></span>
03718 <span class="comment">    ConflictList - On success contains a pointer to an array of conflicting</span>
03719 <span class="comment">        devices</span>
03720 <span class="comment"></span>
03721 <span class="comment">Return Value:</span>
03722 <span class="comment"></span>
03723 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03724 <span class="comment"></span>
03725 <span class="comment">--*/</span>
03726 {
03727     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03728     RTL_RANGE_LIST backupAllocation;
03729     BOOLEAN backedUp = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03730     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">ARBITER_LIST_ENTRY</a> entry;
03731     <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">ARBITER_ALLOCATION_STATE</a> state;
03732     <a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html">ARBITER_ALTERNATIVE</a> alternative;
03733     ULONG count = 0, size = 10;
03734     PRTL_RANGE conflictingRange;
03735     <a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">PARBITER_CONFLICT_INFO</a> conflictInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03736     PVOID savedContext;
03737     PRTL_CONFLICT_RANGE_CALLBACK savedCallback;
03738     ULONG sz;
03739 
03740     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03741 
03742     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PhysicalDeviceObject);
03743     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ConflictingResource);
03744     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ConflictCount);
03745     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Conflicts);
03746     <span class="comment">//</span>
03747     <span class="comment">// Set up our conflict callback</span>
03748     <span class="comment">//</span>
03749     savedCallback = Arbiter-&gt;ConflictCallback;
03750     savedContext = Arbiter-&gt;ConflictCallbackContext;
03751     Arbiter-&gt;ConflictCallback = <a class="code" href="../../d8/d8/arbiter_8c.html#a20">ArbpQueryConflictCallback</a>;
03752     Arbiter-&gt;ConflictCallbackContext = &amp;conflictingRange;
03753 
03754     <span class="comment">//</span>
03755     <span class="comment">// If there is a transaction in progress then we need to backup the</span>
03756     <span class="comment">// the possible allocation so we can restore it when we are done.</span>
03757     <span class="comment">//</span>
03758 
03759     <span class="keywordflow">if</span> (Arbiter-&gt;TransactionInProgress) {
03760 
03761         <a class="code" href="../../d2/d5/range_8c.html#a15">RtlInitializeRangeList</a>(&amp;backupAllocation);
03762 
03763         status = <a class="code" href="../../d2/d5/range_8c.html#a19">RtlCopyRangeList</a>(&amp;backupAllocation, Arbiter-&gt;PossibleAllocation);
03764 
03765         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03766             <span class="keywordflow">goto</span> cleanup;
03767         }
03768 
03769         <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(Arbiter-&gt;PossibleAllocation);
03770 
03771         backedUp = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03772     }
03773 
03774     <span class="comment">//</span>
03775     <span class="comment">// Fake up the allocation state</span>
03776     <span class="comment">//</span>
03777 
03778 
03779     status = <a class="code" href="../../d2/d5/range_8c.html#a19">RtlCopyRangeList</a>(Arbiter-&gt;PossibleAllocation, Arbiter-&gt;Allocation);
03780 
03781     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03782         <span class="keywordflow">goto</span> cleanup;
03783     }
03784 
03785     status = <a class="code" href="../../d8/d8/arbiter_8c.html#a18">ArbpBuildAlternative</a>(Arbiter, ConflictingResource, &amp;alternative);
03786 
03787     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03788         <span class="keywordflow">goto</span> cleanup;
03789     }
03790 
03791     RtlZeroMemory(&amp;state, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">ARBITER_ALLOCATION_STATE</a>));
03792 
03793     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a> = alternative.<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o0">Minimum</a>;
03794     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a> = alternative.<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o1">Maximum</a>;
03795     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o2">CurrentMinimum</a> = state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>;
03796     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o3">CurrentMaximum</a> = state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a>;
03797     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a> = &amp;alternative;
03798     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o6">AlternativeCount</a> = 1;
03799     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o7">Alternatives</a> = &amp;alternative;
03800     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o8">Flags</a> = <a class="code" href="../../d9/d8/arbiter_8h.html#a11">ARBITER_STATE_FLAG_CONFLICT</a>;
03801     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a> = &amp;entry;
03802 
03803     <span class="comment">//</span>
03804     <span class="comment">// BUGBUG(andrewth) - need to fill in more of this false entry</span>
03805     <span class="comment">//</span>
03806     RtlZeroMemory(&amp;entry, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">ARBITER_LIST_ENTRY</a>));
03807     entry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o4">RequestSource</a> = <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>;
03808     entry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a> = PhysicalDeviceObject;
03809     <span class="comment">//</span>
03810     <span class="comment">// BUGBUG(jamiehun) - we didn't allow for passing interface type</span>
03811     <span class="comment">// now we have to live with the decision</span>
03812     <span class="comment">// this really only comes into being for PCI Translator AFAIK</span>
03813     <span class="comment">// upshot of not doing this is we get false conflicts when PCI Boot alloc</span>
03814     <span class="comment">// maps over top of ISA alias</span>
03815     <span class="comment">// IoGetDeviceProperty generally does the right thing for the times we have to use this info</span>
03816     <span class="comment">//</span>
03817     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a74">IoGetDeviceProperty</a>(PhysicalDeviceObject,<a class="code" href="../../d6/d9/pnp_8h.html#a170a96">DevicePropertyLegacyBusType</a>,<span class="keyword">sizeof</span>(entry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o7">InterfaceType</a>),&amp;entry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o7">InterfaceType</a>,&amp;sz))) {
03818         entry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o7">InterfaceType</a> = Isa; <span class="comment">// not what I want to do! However this has the right effect - good enough for conflict detection</span>
03819     }
03820     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a74">IoGetDeviceProperty</a>(PhysicalDeviceObject,<a class="code" href="../../d6/d9/pnp_8h.html#a170a97">DevicePropertyBusNumber</a>,<span class="keyword">sizeof</span>(entry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o7">InterfaceType</a>),&amp;entry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o9">BusNumber</a>,&amp;sz))) {
03821         entry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o9">BusNumber</a> = 0; <span class="comment">// not what I want to do! However this has the right effect - good enough for conflict detection</span>
03822     }
03823 
03824     <span class="comment">//</span>
03825     <span class="comment">// Initialize the return buffers</span>
03826     <span class="comment">//</span>
03827 
03828     conflictInfo = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03829                                          size * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">ARBITER_CONFLICT_INFO</a>),
03830                                          <a class="code" href="../../d8/d8/arbiter_8c.html#a6">ARBITER_CONFLICT_INFO_TAG</a>
03831                                          );
03832 
03833     <span class="keywordflow">if</span> (!conflictInfo) {
03834         status = STATUS_INSUFFICIENT_RESOURCES;
03835         <span class="keywordflow">goto</span> cleanup;
03836     }
03837 
03838     <span class="comment">//</span>
03839     <span class="comment">// Perform any necessary preprocessing</span>
03840     <span class="comment">//</span>
03841 
03842     status = Arbiter-&gt;PreprocessEntry(Arbiter, &amp;state);
03843 
03844     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03845         <span class="keywordflow">goto</span> cleanup;
03846     }
03847 
03848     <span class="comment">//</span>
03849     <span class="comment">// Remove self from list of possible allocations</span>
03850     <span class="comment">// status may be set, but can be ignored</span>
03851     <span class="comment">// we take ourself out of test completely, so that a user can</span>
03852     <span class="comment">// pick new values in context of rest of the world</span>
03853     <span class="comment">// if we decide to use RtlDeleteRange instead</span>
03854     <span class="comment">// make sure we do it for every alias formed in PreprocessEntry</span>
03855     <span class="comment">//</span>
03856 
03857     status = <a class="code" href="../../d2/d5/range_8c.html#a18">RtlDeleteOwnersRanges</a>(Arbiter-&gt;PossibleAllocation,
03858                             state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>
03859                             );
03860 
03861     <span class="comment">//</span>
03862     <span class="comment">// Keep trying to find a suitable range and each time we fail remember why.</span>
03863     <span class="comment">//</span>
03864     conflictingRange = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03865     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o2">CurrentMinimum</a> = state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>;
03866     state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o3">CurrentMaximum</a> = state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a>;
03867 
03868     <span class="keywordflow">while</span> (!Arbiter-&gt;FindSuitableRange(Arbiter, &amp;state)) {
03869 
03870         <span class="keywordflow">if</span> (count == size) {
03871 
03872             <span class="comment">//</span>
03873             <span class="comment">// We need to resize the return buffer</span>
03874             <span class="comment">//</span>
03875 
03876             <a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">PARBITER_CONFLICT_INFO</a> temp = conflictInfo;
03877 
03878             size += 5;
03879 
03880             conflictInfo =
03881                 <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03882                                       size * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/pnp_8h.html#a54">ARBITER_CONFLICT_INFO</a>),
03883                                       <a class="code" href="../../d8/d8/arbiter_8c.html#a6">ARBITER_CONFLICT_INFO_TAG</a>
03884                                       );
03885 
03886             <span class="keywordflow">if</span> (!conflictInfo) {
03887                 status = STATUS_INSUFFICIENT_RESOURCES;
03888                 conflictInfo = temp;
03889                 <span class="keywordflow">goto</span> cleanup;
03890             }
03891 
03892             RtlCopyMemory(conflictInfo,
03893                           temp,
03894                           count * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/pnp_8h.html#a54">ARBITER_CONFLICT_INFO</a>)
03895                           );
03896 
03897             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(temp);
03898 
03899         }
03900 
03901         <span class="keywordflow">if</span> (conflictingRange != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03902             conflictInfo[count].<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html#o0">OwningObject</a> = conflictingRange-&gt;Owner;
03903             conflictInfo[count].<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html#o1">Start</a> = conflictingRange-&gt;Start;
03904             conflictInfo[count].<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html#o2">End</a> = conflictingRange-&gt;End;
03905             <span class="comment">// BUGBUG - maybe need some more info...</span>
03906             count++;
03907 
03908             <span class="comment">//</span>
03909             <span class="comment">// Delete the range we conflicted with so we don't loop forever</span>
03910             <span class="comment">//</span>
03911 <span class="preprocessor">#if 0</span>
03912 <span class="preprocessor"></span>            status = <a class="code" href="../../d2/d5/range_8c.html#a17">RtlDeleteRange</a>(Arbiter-&gt;PossibleAllocation,
03913                                     conflictingRange-&gt;Start,
03914                                     conflictingRange-&gt;End,
03915                                     conflictingRange-&gt;Owner
03916                                     );
03917 <span class="preprocessor">#endif</span>
03918 <span class="preprocessor"></span>            status = <a class="code" href="../../d2/d5/range_8c.html#a18">RtlDeleteOwnersRanges</a>(Arbiter-&gt;PossibleAllocation,
03919                                     conflictingRange-&gt;Owner
03920                                     );
03921 
03922             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03923                 <span class="keywordflow">goto</span> cleanup;
03924             }
03925 
03926         } <span class="keywordflow">else</span> {
03927             <span class="comment">//</span>
03928             <span class="comment">// someone isn't playing by the rules (such as ACPI!)</span>
03929             <span class="comment">//</span>
03930             <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(0,(<span class="stringliteral">"Conflict detected - but someone hasn't set conflicting info\n"</span>));
03931 
03932             conflictInfo[count].<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html#o0">OwningObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03933             conflictInfo[count].<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html#o1">Start</a> = (ULONGLONG)0;
03934             conflictInfo[count].<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html#o2">End</a> = (ULONGLONG)(-1);
03935             <span class="comment">// BUGBUG - maybe need some more info...</span>
03936             count++;
03937 
03938             <span class="comment">//</span>
03939             <span class="comment">// we daren't continue at risk of looping forever</span>
03940             <span class="comment">//</span>
03941             <span class="keywordflow">break</span>;
03942         }
03943 
03944         <span class="comment">//</span>
03945         <span class="comment">// reset for next round</span>
03946         <span class="comment">//</span>
03947         conflictingRange = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03948         state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o2">CurrentMinimum</a> = state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>;
03949         state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o3">CurrentMaximum</a> = state.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a>;
03950     }
03951 
03952     <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(Arbiter-&gt;PossibleAllocation);
03953 
03954     <span class="keywordflow">if</span> (Arbiter-&gt;TransactionInProgress) {
03955 
03956         status = <a class="code" href="../../d2/d5/range_8c.html#a19">RtlCopyRangeList</a>(Arbiter-&gt;PossibleAllocation, &amp;backupAllocation);
03957 
03958         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03959             <span class="keywordflow">goto</span> cleanup;
03960         }
03961 
03962         <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(&amp;backupAllocation);
03963     }
03964 
03965     Arbiter-&gt;ConflictCallback = savedCallback;
03966     Arbiter-&gt;ConflictCallbackContext = savedContext;
03967 
03968     *Conflicts = conflictInfo;
03969     *ConflictCount = count;
03970 
03971     <span class="keywordflow">return</span> STATUS_SUCCESS;
03972 
03973 cleanup:
03974 
03975     <span class="keywordflow">if</span> (conflictInfo) {
03976         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(conflictInfo);
03977     }
03978 
03979     <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(Arbiter-&gt;PossibleAllocation);
03980 
03981     <span class="keywordflow">if</span> (Arbiter-&gt;TransactionInProgress &amp;&amp; backedUp) {
03982         status = <a class="code" href="../../d2/d5/range_8c.html#a19">RtlCopyRangeList</a>(Arbiter-&gt;PossibleAllocation, &amp;backupAllocation);
03983         <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(&amp;backupAllocation);
03984     }
03985 
03986     Arbiter-&gt;ConflictCallback = savedCallback;
03987     Arbiter-&gt;ConflictCallbackContext = savedContext;
03988 
03989     *Conflicts = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03990 
03991     <span class="keywordflow">return</span> status;
03992 }
03993 
03994 
03995 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03996"></a><a class="code" href="../../d9/d8/arbiter_8h.html#a86">03996</a> <a class="code" href="../../d9/d8/arbiter_8h.html#a86">ArbStartArbiter</a>(
03997     IN PARBITER_INSTANCE Arbiter,
03998     IN PCM_RESOURCE_LIST StartResources
03999     )
04000 
04001 <span class="comment">/*++</span>
04002 <span class="comment"></span>
04003 <span class="comment">Routine Description:</span>
04004 <span class="comment"></span>
04005 <span class="comment">    This function is called by the driver that implements the arbiter once</span>
04006 <span class="comment">    it has been started and knowns what resources it can allocate to its</span>
04007 <span class="comment">    children.</span>
04008 <span class="comment"></span>
04009 <span class="comment">    BUGBUG - It will eventually initialize the range lists correctly but for</span>
04010 <span class="comment">    now it is just an overloadable place holder as that work is done elsewhere.</span>
04011 <span class="comment"></span>
04012 <span class="comment">Parameters:</span>
04013 <span class="comment"></span>
04014 <span class="comment">    Arbiter - The instance of the arbiter being called.</span>
04015 <span class="comment"></span>
04016 <span class="comment"></span>
04017 <span class="comment">Return Value:</span>
04018 <span class="comment"></span>
04019 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
04020 <span class="comment"></span>
04021 <span class="comment">--*/</span>
04022 
04023 {
04024     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04025 
04026     <span class="keywordflow">return</span> STATUS_SUCCESS;
04027 }
04028 
04029 
04030 
04031 
04032 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04033"></a><a class="code" href="../../d8/d8/arbiter_8c.html#a48">04033</a> <a class="code" href="../../d8/d8/arbiter_8c.html#a48">ArbpIndent</a>(
04034     IN ULONG Count
04035     )
04036 {
04037     UCHAR spaces[80];
04038 
04039     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &lt;= 80);
04040 
04041     RtlFillMemory(spaces, <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>, <span class="charliteral">'*'</span>);
04042 
04043     spaces[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = 0;
04044 
04045     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%s"</span>, spaces);
04046 
04047 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:16 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
