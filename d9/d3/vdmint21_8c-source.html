<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: vdmint21.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>vdmint21.c</h1><a href="../../d8/d4/vdmint21_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    vdmint21.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements interfaces that support manipulation of i386</span>
00012 <span class="comment">    int 21 entry of IDT. These entry points only exist on i386 machines.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Shie-Lin Tzong (shielint) 26-Dec-1993</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00027 <span class="preprocessor">#pragma hdrstop</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d1/d5/vdmntos_8h.html">vdmntos.h</a>"</span>
00029 
<a name="l00030"></a><a class="code" href="../../d8/d4/vdmint21_8c.html#a0">00030</a> <span class="preprocessor">#define IDT_ACCESS_DPL_USER 0x6000</span>
<a name="l00031"></a><a class="code" href="../../d8/d4/vdmint21_8c.html#a1">00031</a> <span class="preprocessor"></span><span class="preprocessor">#define IDT_ACCESS_TYPE_386_TRAP 0xF00</span>
<a name="l00032"></a><a class="code" href="../../d8/d4/vdmint21_8c.html#a2">00032</a> <span class="preprocessor"></span><span class="preprocessor">#define IDT_ACCESS_TYPE_286_TRAP 0x700</span>
<a name="l00033"></a><a class="code" href="../../d8/d4/vdmint21_8c.html#a3">00033</a> <span class="preprocessor"></span><span class="preprocessor">#define IDT_ACCESS_PRESENT 0x8000</span>
<a name="l00034"></a><a class="code" href="../../d8/d4/vdmint21_8c.html#a4">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define LDT_MASK 4</span>
00035 <span class="preprocessor"></span>
00036 <span class="comment">//</span>
00037 <span class="comment">// External Reference</span>
00038 <span class="comment">//</span>
00039 
00040 BOOLEAN
00041 <a class="code" href="../../d8/d4/vdmint21_8c.html#a6">Ki386GetSelectorParameters</a>(
00042     IN USHORT Selector,
00043     OUT PULONG Flags,
00044     OUT PULONG Base,
00045     OUT PULONG Limit
00046     );
00047 
00048 <span class="comment">//</span>
00049 <span class="comment">// Define forward referenced function prototypes.</span>
00050 <span class="comment">//</span>
00051 
00052 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00053 <a class="code" href="../../d8/d4/vdmint21_8c.html#a7">Ki386LoadTargetInt21Entry</a> (
00054     IN PKIPI_CONTEXT SignalDone,
00055     IN PVOID Parameter1,
00056     IN PVOID Parameter2,
00057     IN PVOID Parameter3
00058     );
00059 
<a name="l00060"></a><a class="code" href="../../d8/d4/vdmint21_8c.html#a5">00060</a> <span class="preprocessor">#define KiLoadInt21Entry() \</span>
00061 <span class="preprocessor">    KeGetPcr()-&gt;IDT[0x21] = PsGetCurrentProcess()-&gt;Pcb.Int21Descriptor</span>
00062 <span class="preprocessor"></span>
00063 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00064"></a><a class="code" href="../../d8/d4/vdmint21_8c.html#a8">00064</a> <a class="code" href="../../d8/d4/vdmint21_8c.html#a8">Ke386SetVdmInterruptHandler</a> (
00065     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>   Process,
00066     ULONG       Interrupt,
00067     USHORT      Selector,
00068     ULONG       Offset,
00069     BOOLEAN     Gate32
00070     )
00071 
00072 <span class="comment">/*++</span>
00073 <span class="comment"></span>
00074 <span class="comment">Routine Description:</span>
00075 <span class="comment"></span>
00076 <span class="comment">    The specified (software) interrupt entry of IDT will be updated to</span>
00077 <span class="comment">    point to the specified handler.  For all threads which belong to the</span>
00078 <span class="comment">    specified process, their execution processors will be notified to</span>
00079 <span class="comment">    make the same change.</span>
00080 <span class="comment"></span>
00081 <span class="comment">    This function only exists on i386 and i386 compatible processors.</span>
00082 <span class="comment"></span>
00083 <span class="comment">    No checking is done on the validity of the interrupt handler.</span>
00084 <span class="comment"></span>
00085 <span class="comment">Arguments:</span>
00086 <span class="comment"></span>
00087 <span class="comment">    Process - Pointer to KPROCESS object describing the process for</span>
00088 <span class="comment">        which the int 21 entry is to be set.</span>
00089 <span class="comment"></span>
00090 <span class="comment">    Interrupt - The software interrupt vector which will be updated.</span>
00091 <span class="comment"></span>
00092 <span class="comment">    Selector, offset - Specified the address of the new handler.</span>
00093 <span class="comment"></span>
00094 <span class="comment">    Gate32 - True if the gate should be 32 bit, false otherwise</span>
00095 <span class="comment"></span>
00096 <span class="comment">Return Value:</span>
00097 <span class="comment"></span>
00098 <span class="comment">    NTSTATUS.</span>
00099 <span class="comment"></span>
00100 <span class="comment">--*/</span>
00101 
00102 {
00103 
00104     KIRQL OldIrql;
00105     BOOLEAN LocalProcessor;
00106     KAFFINITY TargetProcessors;
00107     PKPRCB  Prcb;
00108     KIDTENTRY IdtDescriptor;
00109     ULONG Flags, Base, Limit;
00110 
00111     <span class="comment">//</span>
00112     <span class="comment">// Check the validity of the request</span>
00113     <span class="comment">// 1. Currently, we support int21 redirection only</span>
00114     <span class="comment">// 2. The specified interrupt handler must be in user space.</span>
00115     <span class="comment">//</span>
00116 
00117     <span class="keywordflow">if</span> (Interrupt != 0x21 || <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &gt;= (ULONG)MM_HIGHEST_USER_ADDRESS ||
00118         !<a class="code" href="../../d8/d4/vdmint21_8c.html#a6">Ki386GetSelectorParameters</a>(Selector, &amp;Flags, &amp;Base, &amp;Limit) ){
00119         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
00120     }
00121 
00122     <span class="comment">//</span>
00123     <span class="comment">// Initialize the contents of the IDT entry</span>
00124     <span class="comment">//</span>
00125 
00126     IdtDescriptor.Offset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00127     IdtDescriptor.Selector = Selector | RPL_MASK | <a class="code" href="../../d8/d4/vdmint21_8c.html#a4">LDT_MASK</a>;
00128     IdtDescriptor.ExtendedOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &gt;&gt; 16);
00129     IdtDescriptor.Access = <a class="code" href="../../d8/d4/vdmint21_8c.html#a0">IDT_ACCESS_DPL_USER</a> | <a class="code" href="../../d8/d4/vdmint21_8c.html#a3">IDT_ACCESS_PRESENT</a>;
00130     <span class="keywordflow">if</span> (Gate32) {
00131         IdtDescriptor.Access |= <a class="code" href="../../d8/d4/vdmint21_8c.html#a1">IDT_ACCESS_TYPE_386_TRAP</a>;
00132 
00133     } <span class="keywordflow">else</span> {
00134         IdtDescriptor.Access |= <a class="code" href="../../d8/d4/vdmint21_8c.html#a2">IDT_ACCESS_TYPE_286_TRAP</a>;
00135     }
00136 
00137     <span class="comment">//</span>
00138     <span class="comment">// Acquire the context swap lock so a context switch will not occur.</span>
00139     <span class="comment">//</span>
00140 
00141     <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
00142 
00143     <span class="comment">//</span>
00144     <span class="comment">// Set the Ldt fields in the process object</span>
00145     <span class="comment">//</span>
00146 
00147     Process-&gt;Int21Descriptor = IdtDescriptor;
00148 
00149     <span class="comment">//</span>
00150     <span class="comment">// Tell all processors active for this process to reload their LDTs</span>
00151     <span class="comment">//</span>
00152 
00153 <span class="preprocessor">#if !defined(NT_UP)</span>
00154 <span class="preprocessor"></span>
00155     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00156     TargetProcessors = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o3">ActiveProcessors</a> &amp; ~Prcb-&gt;SetMember;
00157     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00158         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00159                         <a class="code" href="../../d8/d4/vdmint21_8c.html#a7">Ki386LoadTargetInt21Entry</a>,
00160                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00161                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00162                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00163     }
00164 
00165 <span class="preprocessor">#endif</span>
00166 <span class="preprocessor"></span>
00167     <a class="code" href="../../d8/d4/vdmint21_8c.html#a5">KiLoadInt21Entry</a>();
00168 
00169 <span class="preprocessor">#if !defined(NT_UP)</span>
00170 <span class="preprocessor"></span>
00171     <span class="comment">//</span>
00172     <span class="comment">// Wait until all of the target processors have finished reloading</span>
00173     <span class="comment">// their LDT.</span>
00174     <span class="comment">//</span>
00175 
00176     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00177         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00178     }
00179 
00180 <span class="preprocessor">#endif</span>
00181 <span class="preprocessor"></span>
00182     <span class="comment">//</span>
00183     <span class="comment">// Restore IRQL and unlock the context swap lock.</span>
00184     <span class="comment">//</span>
00185 
00186     <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
00187     <span class="keywordflow">return</span> STATUS_SUCCESS;
00188 }
00189 
00190 <span class="preprocessor">#if !defined(NT_UP)</span>
00191 <span class="preprocessor"></span>
00192 
00193 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00194"></a><a class="code" href="../../d8/d4/vdmint21_8c.html#a7">00194</a> <a class="code" href="../../d8/d4/vdmint21_8c.html#a7">Ki386LoadTargetInt21Entry</a> (
00195     IN PKIPI_CONTEXT    PacketContext,
00196     IN PVOID            Parameter1,
00197     IN PVOID            Parameter2,
00198     IN PVOID            Parameter3
00199     )
00200 <span class="comment">/*++</span>
00201 <span class="comment"></span>
00202 <span class="comment">Routine Description:</span>
00203 <span class="comment"></span>
00204 <span class="comment">    Reload local Ldt register and clear signal bit in TargetProcessor mask</span>
00205 <span class="comment"></span>
00206 <span class="comment">Arguments:</span>
00207 <span class="comment"></span>
00208 <span class="comment">    Argument - pointer to a ipi packet structure.</span>
00209 <span class="comment">    ReadyFlag - Pointer to flag to be set once LDTR has been reloaded</span>
00210 <span class="comment"></span>
00211 <span class="comment">Return Value:</span>
00212 <span class="comment"></span>
00213 <span class="comment">    none.</span>
00214 <span class="comment"></span>
00215 <span class="comment">--*/</span>
00216 
00217 {
00218 
00219     <span class="comment">//</span>
00220     <span class="comment">// Set the int 21 entry of IDT from currently active process object</span>
00221     <span class="comment">//</span>
00222 
00223     <a class="code" href="../../d8/d4/vdmint21_8c.html#a5">KiLoadInt21Entry</a>();
00224     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(PacketContext);
00225     <span class="keywordflow">return</span>;
00226 }
00227 
00228 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:21 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
