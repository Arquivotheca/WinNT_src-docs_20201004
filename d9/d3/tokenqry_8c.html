<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: tokenqry.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>tokenqry.c File Reference</h1><code>#include "<a class="el" href="../../d7/d5/sep_8h-source.html">sep.h</a>"</code><br>
<code>#include "<a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>"</code><br>

<p>
<a href="../../d0/d3/tokenqry_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a> (IN HANDLE TokenHandle, IN TOKEN_INFORMATION_CLASS TokenInformationClass, OUT PVOID TokenInformation, IN ULONG TokenInformationLength, OUT PULONG ReturnLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/tokenqry_8c.html#a1">SeQueryAuthenticationIdToken</a> (IN PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, OUT PLUID AuthenticationId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/tokenqry_8c.html#a2">SeQueryInformationToken</a> (IN PACCESS_TOKEN AccessToken, IN TOKEN_INFORMATION_CLASS TokenInformationClass, OUT PVOID *TokenInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/tokenqry_8c.html#a3">SeQuerySessionIdToken</a> (PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, PULONG SessionId)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="tokenqry.c::NtQueryInformationToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryInformationToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN TOKEN_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">34</a> of file <a class="el" href="../../d0/d3/tokenqry_8c-source.html">tokenqry.c</a>.
<p>
References <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00226">ANYSIZE_ARRAY</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01896">RtlCopyLuidAndAttributesArray()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01436">RtlCopySidAndAttributesArray()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01763">SeQuerySessionIdToken()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/exports_8c-source.html#l00045">_UserTestTokenForInteractive()</a>, <a class="el" href="../../d2/d8/uipers_8c-source.html#l00345">DisplaySecurityContext()</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00225">EnableAllPrivileges()</a>, <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00273">GetMySid()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01844">GetSiteSidFromToken()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l01865">InternalCreateCallbackThread()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l02001">IsTokenRestricted()</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00322">ResetAllPrivileges()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01860">RtlDefaultNpAcl()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00680">RtlNewInstanceSecurityObject()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00818">RtlNewSecurityGrantedAccess()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08795">RtlpGetDefaultsSubjectContext()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03544">RtlpValidOwnerSubjectContext()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00831">SepServerTestIdentification()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00893">SepServerTestImpersonation()</a>, <a class="el" href="../../d7/d3/msgbox_8c-source.html#l00178">ServiceMessageBox()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07016">TestpCompareDuplicateToken()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l04885">TestTokenAdjustGroups()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l03929">TestTokenAdjustPrivileges()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07648">TestTokenAssignPrimary()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00167">TestTokenInitialize()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l01276">TestTokenOpenPrimary()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l01434">TestTokenQuery()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l03311">TestTokenSet()</a>.
<p>
<pre class="fragment"><div>00045                    :
00046 
00047     Retrieve information about a specified token.
00048 
00049 Arguments:
00050 
00051     TokenHandle - Provides a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to operate on.
00052 
00053     TokenInformationClass - The token information <span class="keyword">class </span>about which
00054         to retrieve information.
00055 
00056     TokenInformation - The buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested class of
00057         information.  The buffer must be aligned on at least a
00058         longword boundary.  The actual structures returned are
00059         dependent upon <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information class requested, as defined in
00060         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TokenInformationClass parameter description.
00061 
00062         TokenInformation Format By Information Class:
00063 
00064            TokenUser =&gt; TOKEN_USER data structure.  TOKEN_QUERY
00065            access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information about a
00066            token.
00067 
00068            TokenGroups =&gt; TOKEN_GROUPS data structure.  TOKEN_QUERY
00069            access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information about a
00070            token.
00071 
00072            TokenPrivileges =&gt; TOKEN_PRIVILEGES data structure.
00073            TOKEN_QUERY access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information
00074            about a token.
00075 
00076            TokenOwner =&gt; TOKEN_OWNER data structure.  TOKEN_QUERY
00077            access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information about a
00078            token.
00079 
00080            TokenPrimaryGroup =&gt; TOKEN_PRIMARY_GROUP data structure.
00081            TOKEN_QUERY access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information
00082            about a token.
00083 
00084            TokenDefaultDacl =&gt; TOKEN_DEFAULT_DACL data structure.
00085            TOKEN_QUERY access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information
00086            about a token.
00087 
00088            TokenSource =&gt; TOKEN_SOURCE data structure.
00089            TOKEN_QUERY_SOURCE access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this
00090            information about a token.
00091 
00092            TokenType =&gt; TOKEN_TYPE data structure.
00093            TOKEN_QUERY access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information
00094            about a token.
00095 
00096            TokenStatistics =&gt; TOKEN_STATISTICS data structure.
00097            TOKEN_QUERY access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this
00098            information about a token.
00099 
00100            TokenGroups =&gt; TOKEN_GROUPS data structure.  TOKEN_QUERY
00101            access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information about a
00102            token.
00103 
00104     TokenInformationLength - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00105         TokenInformation buffer.
00106 
00107     ReturnLength - This OUT parameter receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual length of
00108         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information.  If this value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> larger than that
00109         provided by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TokenInformationLength parameter, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00110         buffer provided to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00111         large enough to hold that data and no data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00112 
00113         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queried class <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> TokenDefaultDacl and there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no
00114         default <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> established for <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> return
00115         length will be returned as zero, and no data will be returned.
00116 
00117 Return Value:
00118 
00119     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was successful.
00120 
00121     STATUS_BUFFER_TOO_SMALL - if <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information did not
00122         fit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> provided output buffer.  In this case, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00123         ReturnLength OUT parameter contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes
00124         actually needed to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information.
00125 
00126 --*/
00127 {
00128 
00129     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00130     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00131 
00132     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00133 
00134     ULONG RequiredLength;
00135     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00136 
00137     PTOKEN_TYPE LocalType;
00138     PTOKEN_USER LocalUser;
00139     PTOKEN_GROUPS LocalGroups;
00140     PTOKEN_PRIVILEGES LocalPrivileges;
00141     PTOKEN_OWNER LocalOwner;
00142     PTOKEN_PRIMARY_GROUP LocalPrimaryGroup;
00143     PTOKEN_DEFAULT_DACL LocalDefaultDacl;
00144     PTOKEN_SOURCE LocalSource;
00145     PSECURITY_IMPERSONATION_LEVEL LocalImpersonationLevel;
00146     PTOKEN_STATISTICS LocalStatistics;
00147 
00148     PSID PSid;
00149     PACL PAcl;
00150 
00151     PVOID Ignore;
00152     ULONG SessionId;
00153 
00154     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00155 
00156     <span class="comment">//</span>
00157     <span class="comment">// Get previous processor mode and probe output argument if necessary.</span>
00158     <span class="comment">//</span>
00159 
00160     PreviousMode = KeGetPreviousMode();
00161     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00162         <span class="keywordflow">try</span> {
00163 
00164             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00165                 TokenInformation,
00166                 TokenInformationLength,
00167                 <span class="keyword">sizeof</span>(ULONG)
00168                 );
00169 
00170             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
00171 
00172         } except(EXCEPTION_EXECUTE_HANDLER) {
00173             <span class="keywordflow">return</span> GetExceptionCode();
00174         }
00175     }
00176 
00177     <span class="comment">//</span>
00178     <span class="comment">// Case on information class.</span>
00179     <span class="comment">//</span>
00180 
00181     <span class="keywordflow">switch</span> ( TokenInformationClass ) {
00182 
00183     <span class="keywordflow">case</span> TokenUser:
00184 
00185         LocalUser = (PTOKEN_USER)TokenInformation;
00186 
00187         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00188                  TokenHandle,           <span class="comment">// Handle</span>
00189                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00190                  SepTokenObjectType,    <span class="comment">// ObjectType</span>
00191                  PreviousMode,          <span class="comment">// AccessMode</span>
00192                  (PVOID *)&amp;Token,       <span class="comment">// Object</span>
00193                  NULL                   <span class="comment">// GrantedAccess</span>
00194                  );
00195 
00196         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00197             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00198         }
00199 
00200         <span class="comment">//</span>
00201         <span class="comment">//  Gain exclusive access to the token.</span>
00202         <span class="comment">//</span>
00203 
00204         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
00205 
00206 
00207 
00208         <span class="comment">//</span>
00209         <span class="comment">// Return the length required now in case not enough buffer</span>
00210         <span class="comment">// was provided by the caller and we have to return an error.</span>
00211         <span class="comment">//</span>
00212 
00213         RequiredLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[0].Sid) +
00214                          (ULONG)<span class="keyword">sizeof</span>( TOKEN_USER );
00215 
00216         <span class="keywordflow">try</span> {
00217 
00218             *ReturnLength = RequiredLength;
00219 
00220         } except(EXCEPTION_EXECUTE_HANDLER) {
00221 
00222             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00223             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00224             <span class="keywordflow">return</span> GetExceptionCode();
00225         }
00226 
00227         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00228 
00229             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00230             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00231             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00232 
00233         }
00234 
00235         <span class="comment">//</span>
00236         <span class="comment">// Return the user SID</span>
00237         <span class="comment">//</span>
00238 
00239         <span class="keywordflow">try</span> {
00240 
00241             <span class="comment">//</span>
00242             <span class="comment">//  Put SID immediately following TOKEN_USER data structure</span>
00243             <span class="comment">//</span>
00244             PSid = (PSID)( (ULONG_PTR)LocalUser + (ULONG)<span class="keyword">sizeof</span>(TOKEN_USER) );
00245 
00246             <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
00247                 1,
00248                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups,
00249                 RequiredLength,
00250                 &amp;(LocalUser-&gt;User),
00251                 PSid,
00252                 ((PSID *)&amp;Ignore),
00253                 ((PULONG)&amp;Ignore)
00254                 );
00255 
00256         } except(EXCEPTION_EXECUTE_HANDLER) {
00257 
00258             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00259             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00260             <span class="keywordflow">return</span> GetExceptionCode();
00261         }
00262 
00263 
00264         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00265         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00266         <span class="keywordflow">return</span> STATUS_SUCCESS;
00267 
00268     <span class="keywordflow">case</span> TokenGroups:
00269 
00270         LocalGroups = (PTOKEN_GROUPS)TokenInformation;
00271 
00272         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00273                  TokenHandle,           <span class="comment">// Handle</span>
00274                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00275                  SepTokenObjectType,    <span class="comment">// ObjectType</span>
00276                  PreviousMode,          <span class="comment">// AccessMode</span>
00277                  (PVOID *)&amp;Token,       <span class="comment">// Object</span>
00278                  NULL                   <span class="comment">// GrantedAccess</span>
00279                  );
00280 
00281         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00282             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00283         }
00284 
00285         <span class="comment">//</span>
00286         <span class="comment">//  Gain exclusive access to the token.</span>
00287         <span class="comment">//</span>
00288 
00289         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
00290 
00291         <span class="comment">//</span>
00292         <span class="comment">// Figure out how much space is needed to return the group SIDs.</span>
00293         <span class="comment">// That's the size of TOKEN_GROUPS (without any array entries)</span>
00294         <span class="comment">// plus the size of an SID_AND_ATTRIBUTES times the number of groups.</span>
00295         <span class="comment">// The number of groups is Token-&gt;UserAndGroups-1 (since the count</span>
00296         <span class="comment">// includes the user ID).  Then the lengths of each individual group</span>
00297         <span class="comment">// must be added.</span>
00298         <span class="comment">//</span>
00299 
00300         RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
00301                          ((<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> - 1) *
00302                          ((ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES)) );
00303 
00304         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;
00305         <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount) {
00306 
00307             RequiredLength += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[Index].Sid );
00308 
00309             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00310 
00311         } <span class="comment">// endwhile</span>
00312 
00313         <span class="comment">//</span>
00314         <span class="comment">// Return the length required now in case not enough buffer</span>
00315         <span class="comment">// was provided by the caller and we have to return an error.</span>
00316         <span class="comment">//</span>
00317 
00318         <span class="keywordflow">try</span> {
00319 
00320             *ReturnLength = RequiredLength;
00321 
00322         } except(EXCEPTION_EXECUTE_HANDLER) {
00323 
00324             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00325             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00326             <span class="keywordflow">return</span> GetExceptionCode();
00327         }
00328 
00329         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00330 
00331             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00332             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00333             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00334 
00335         }
00336 
00337         <span class="comment">//</span>
00338         <span class="comment">// Now copy the groups.</span>
00339         <span class="comment">//</span>
00340 
00341         <span class="keywordflow">try</span> {
00342 
00343             LocalGroups-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - 1;
00344 
00345             PSid = (PSID)( (ULONG_PTR)LocalGroups +
00346                            (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
00347                            (   (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> - 1) *
00348                                (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES) )
00349                          );
00350 
00351             <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
00352                 (ULONG)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - 1),
00353                 &amp;(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[1]),
00354                 RequiredLength,
00355                 LocalGroups-&gt;Groups,
00356                 PSid,
00357                 ((PSID *)&amp;Ignore),
00358                 ((PULONG)&amp;Ignore)
00359                 );
00360 
00361         } except(EXCEPTION_EXECUTE_HANDLER) {
00362 
00363             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00364             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00365             <span class="keywordflow">return</span> GetExceptionCode();
00366         }
00367 
00368 
00369         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00370         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00371         <span class="keywordflow">return</span> STATUS_SUCCESS;
00372 
00373     <span class="keywordflow">case</span> TokenRestrictedSids:
00374 
00375         LocalGroups = (PTOKEN_GROUPS)TokenInformation;
00376 
00377         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00378                  TokenHandle,           <span class="comment">// Handle</span>
00379                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00380                  SepTokenObjectType,    <span class="comment">// ObjectType</span>
00381                  PreviousMode,          <span class="comment">// AccessMode</span>
00382                  (PVOID *)&amp;Token,       <span class="comment">// Object</span>
00383                  NULL                   <span class="comment">// GrantedAccess</span>
00384                  );
00385 
00386         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00387             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00388         }
00389 
00390         <span class="comment">//</span>
00391         <span class="comment">//  Gain exclusive access to the token.</span>
00392         <span class="comment">//</span>
00393 
00394         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
00395 
00396         <span class="comment">//</span>
00397         <span class="comment">// Figure out how much space is needed to return the group SIDs.</span>
00398         <span class="comment">// That's the size of TOKEN_GROUPS (without any array entries)</span>
00399         <span class="comment">// plus the size of an SID_AND_ATTRIBUTES times the number of groups.</span>
00400         <span class="comment">// The number of groups is Token-&gt;UserAndGroups-1 (since the count</span>
00401         <span class="comment">// includes the user ID).  Then the lengths of each individual group</span>
00402         <span class="comment">// must be added.</span>
00403         <span class="comment">//</span>
00404 
00405         RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
00406                          ((<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSidCount) *
00407                          ((ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES)) -
00408                          <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> * <span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES) );
00409 
00410         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00411         <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSidCount) {
00412 
00413             RequiredLength += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSids[Index].Sid );
00414 
00415             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00416 
00417         } <span class="comment">// endwhile</span>
00418 
00419         <span class="comment">//</span>
00420         <span class="comment">// Return the length required now in case not enough buffer</span>
00421         <span class="comment">// was provided by the caller and we have to return an error.</span>
00422         <span class="comment">//</span>
00423 
00424         <span class="keywordflow">try</span> {
00425 
00426             *ReturnLength = RequiredLength;
00427 
00428         } except(EXCEPTION_EXECUTE_HANDLER) {
00429 
00430             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00431             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00432             <span class="keywordflow">return</span> GetExceptionCode();
00433         }
00434 
00435         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00436 
00437             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00438             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00439             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00440 
00441         }
00442 
00443         <span class="comment">//</span>
00444         <span class="comment">// Now copy the groups.</span>
00445         <span class="comment">//</span>
00446 
00447         <span class="keywordflow">try</span> {
00448 
00449             LocalGroups-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSidCount;
00450 
00451             PSid = (PSID)( (ULONG_PTR)LocalGroups +
00452                            (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
00453                            (   (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSidCount ) *
00454                                (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES) -
00455                                <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> * <span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES) )
00456                          );
00457 
00458             <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
00459                 (ULONG)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSidCount),
00460                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSids,
00461                 RequiredLength,
00462                 LocalGroups-&gt;Groups,
00463                 PSid,
00464                 ((PSID *)&amp;Ignore),
00465                 ((PULONG)&amp;Ignore)
00466                 );
00467 
00468         } except(EXCEPTION_EXECUTE_HANDLER) {
00469 
00470             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00471             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00472             <span class="keywordflow">return</span> GetExceptionCode();
00473         }
00474 
00475 
00476         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00477         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00478         <span class="keywordflow">return</span> STATUS_SUCCESS;
00479 
00480     <span class="keywordflow">case</span> TokenPrivileges:
00481 
00482         LocalPrivileges = (PTOKEN_PRIVILEGES)TokenInformation;
00483 
00484         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00485                  TokenHandle,           <span class="comment">// Handle</span>
00486                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00487                  SepTokenObjectType,    <span class="comment">// ObjectType</span>
00488                  PreviousMode,          <span class="comment">// AccessMode</span>
00489                  (PVOID *)&amp;Token,       <span class="comment">// Object</span>
00490                  NULL                   <span class="comment">// GrantedAccess</span>
00491                  );
00492 
00493         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00494             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00495         }
00496 
00497         <span class="comment">//</span>
00498         <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
00499         <span class="comment">//  from occuring to the privileges.</span>
00500         <span class="comment">//</span>
00501 
00502         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
00503 
00504 
00505         <span class="comment">//</span>
00506         <span class="comment">// Return the length required now in case not enough buffer</span>
00507         <span class="comment">// was provided by the caller and we have to return an error.</span>
00508         <span class="comment">//</span>
00509 
00510         RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIVILEGES) +
00511                          ((<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>) *
00512                          ((ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)) );
00513 
00514 
00515         <span class="keywordflow">try</span> {
00516 
00517             *ReturnLength = RequiredLength;
00518 
00519         } except(EXCEPTION_EXECUTE_HANDLER) {
00520 
00521             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00522             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00523             <span class="keywordflow">return</span> GetExceptionCode();
00524         }
00525 
00526         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00527 
00528             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00529             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00530             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00531 
00532         }
00533 
00534         <span class="comment">//</span>
00535         <span class="comment">// Return the token privileges.</span>
00536         <span class="comment">//</span>
00537 
00538         <span class="keywordflow">try</span> {
00539 
00540             LocalPrivileges-&gt;PrivilegeCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount;
00541 
00542             <a class="code" href="../../d8/d6/sertl_8c.html#a52">RtlCopyLuidAndAttributesArray</a>(
00543                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount,
00544                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges,
00545                 LocalPrivileges-&gt;Privileges
00546                 );
00547 
00548         } except(EXCEPTION_EXECUTE_HANDLER) {
00549 
00550             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00551             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00552             <span class="keywordflow">return</span> GetExceptionCode();
00553         }
00554 
00555 
00556         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00557         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00558         <span class="keywordflow">return</span> STATUS_SUCCESS;
00559 
00560     <span class="keywordflow">case</span> TokenOwner:
00561 
00562         LocalOwner = (PTOKEN_OWNER)TokenInformation;
00563 
00564         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00565                  TokenHandle,           <span class="comment">// Handle</span>
00566                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00567                  SepTokenObjectType,    <span class="comment">// ObjectType</span>
00568                  PreviousMode,          <span class="comment">// AccessMode</span>
00569                  (PVOID *)&amp;Token,       <span class="comment">// Object</span>
00570                  NULL                   <span class="comment">// GrantedAccess</span>
00571                  );
00572 
00573         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00574             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00575         }
00576 
00577         <span class="comment">//</span>
00578         <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
00579         <span class="comment">//  from occuring to the owner.</span>
00580         <span class="comment">//</span>
00581 
00582         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
00583 
00584         <span class="comment">//</span>
00585         <span class="comment">// Return the length required now in case not enough buffer</span>
00586         <span class="comment">// was provided by the caller and we have to return an error.</span>
00587         <span class="comment">//</span>
00588 
00589         PSid = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex].Sid;
00590         RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER) +
00591                          <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( PSid );
00592 
00593         <span class="keywordflow">try</span> {
00594 
00595             *ReturnLength = RequiredLength;
00596 
00597         } except(EXCEPTION_EXECUTE_HANDLER) {
00598 
00599             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00600             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00601             <span class="keywordflow">return</span> GetExceptionCode();
00602         }
00603 
00604         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00605 
00606             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00607             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00608             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00609 
00610         }
00611 
00612         <span class="comment">//</span>
00613         <span class="comment">// Return the owner SID</span>
00614         <span class="comment">//</span>
00615 
00616         PSid = (PSID)((ULONG_PTR)LocalOwner +
00617                       (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER));
00618 
00619         <span class="keywordflow">try</span> {
00620 
00621             LocalOwner-&gt;Owner = PSid;
00622 
00623             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
00624                          (RequiredLength - (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER)),
00625                          PSid,
00626                          <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex].Sid
00627                          );
00628 
00629             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00630 
00631         } except(EXCEPTION_EXECUTE_HANDLER) {
00632 
00633             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00634             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00635             <span class="keywordflow">return</span> GetExceptionCode();
00636         }
00637 
00638 
00639         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00640         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00641         <span class="keywordflow">return</span> STATUS_SUCCESS;
00642 
00643     <span class="keywordflow">case</span> TokenPrimaryGroup:
00644 
00645         LocalPrimaryGroup = (PTOKEN_PRIMARY_GROUP)TokenInformation;
00646 
00647         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00648                  TokenHandle,           <span class="comment">// Handle</span>
00649                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00650                  SepTokenObjectType,    <span class="comment">// ObjectType</span>
00651                  PreviousMode,          <span class="comment">// AccessMode</span>
00652                  (PVOID *)&amp;Token,       <span class="comment">// Object</span>
00653                  NULL                   <span class="comment">// GrantedAccess</span>
00654                  );
00655 
00656         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00657             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00658         }
00659 
00660         <span class="comment">//</span>
00661         <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
00662         <span class="comment">//  from occuring to the owner.</span>
00663         <span class="comment">//</span>
00664 
00665         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
00666 
00667         <span class="comment">//</span>
00668         <span class="comment">// Return the length required now in case not enough buffer</span>
00669         <span class="comment">// was provided by the caller and we have to return an error.</span>
00670         <span class="comment">//</span>
00671 
00672         RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP) +
00673                          <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup );
00674 
00675         <span class="keywordflow">try</span> {
00676 
00677             *ReturnLength = RequiredLength;
00678 
00679         } except(EXCEPTION_EXECUTE_HANDLER) {
00680 
00681             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00682             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00683             <span class="keywordflow">return</span> GetExceptionCode();
00684         }
00685 
00686         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00687 
00688             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00689             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00690             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00691 
00692         }
00693 
00694         <span class="comment">//</span>
00695         <span class="comment">// Return the primary group SID</span>
00696         <span class="comment">//</span>
00697 
00698         PSid = (PSID)((ULONG_PTR)LocalPrimaryGroup +
00699                       (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP));
00700 
00701         <span class="keywordflow">try</span> {
00702 
00703             LocalPrimaryGroup-&gt;PrimaryGroup = PSid;
00704 
00705             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( (RequiredLength - (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP)),
00706                                  PSid,
00707                                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup
00708                                  );
00709 
00710             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00711 
00712         } except(EXCEPTION_EXECUTE_HANDLER) {
00713 
00714             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00715             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00716             <span class="keywordflow">return</span> GetExceptionCode();
00717         }
00718 
00719 
00720         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00721         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00722         <span class="keywordflow">return</span> STATUS_SUCCESS;
00723 
00724     <span class="keywordflow">case</span> TokenDefaultDacl:
00725 
00726         LocalDefaultDacl = (PTOKEN_DEFAULT_DACL)TokenInformation;
00727 
00728         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00729                  TokenHandle,           <span class="comment">// Handle</span>
00730                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00731                  SepTokenObjectType,    <span class="comment">// ObjectType</span>
00732                  PreviousMode,          <span class="comment">// AccessMode</span>
00733                  (PVOID *)&amp;Token,       <span class="comment">// Object</span>
00734                  NULL                   <span class="comment">// GrantedAccess</span>
00735                  );
00736 
00737         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00738             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00739         }
00740 
00741         <span class="comment">//</span>
00742         <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
00743         <span class="comment">//  from occuring to the owner.</span>
00744         <span class="comment">//</span>
00745 
00746         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
00747 
00748 
00749         <span class="comment">//</span>
00750         <span class="comment">// Return the length required now in case not enough buffer</span>
00751         <span class="comment">// was provided by the caller and we have to return an error.</span>
00752         <span class="comment">//</span>
00753 
00754         RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL);
00755 
00756         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00757 
00758             RequiredLength += <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize;
00759 
00760         }
00761 
00762         <span class="keywordflow">try</span> {
00763 
00764             *ReturnLength = RequiredLength;
00765 
00766         } except(EXCEPTION_EXECUTE_HANDLER) {
00767 
00768             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00769             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00770             <span class="keywordflow">return</span> GetExceptionCode();
00771         }
00772 
00773         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00774 
00775             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00776             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00777             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00778 
00779         }
00780 
00781         <span class="comment">//</span>
00782         <span class="comment">// Return the default Dacl</span>
00783         <span class="comment">//</span>
00784 
00785         PAcl = (PACL)((ULONG_PTR)LocalDefaultDacl +
00786                       (ULONG)<span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL));
00787 
00788         <span class="keywordflow">try</span> {
00789 
00790             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00791 
00792                 LocalDefaultDacl-&gt;DefaultDacl = PAcl;
00793 
00794                 RtlCopyMemory( (PVOID)PAcl,
00795                                (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl,
00796                                <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize
00797                                );
00798             } <span class="keywordflow">else</span> {
00799 
00800                 LocalDefaultDacl-&gt;DefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00801 
00802             }
00803 
00804         } except(EXCEPTION_EXECUTE_HANDLER) {
00805 
00806             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00807             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00808             <span class="keywordflow">return</span> GetExceptionCode();
00809         }
00810 
00811 
00812         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00813         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00814         <span class="keywordflow">return</span> STATUS_SUCCESS;
00815 
00816 
00817 
00818     <span class="keywordflow">case</span> TokenSource:
00819 
00820         LocalSource = (PTOKEN_SOURCE)TokenInformation;
00821 
00822         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00823                  TokenHandle,           <span class="comment">// Handle</span>
00824                  TOKEN_QUERY_SOURCE,    <span class="comment">// DesiredAccess</span>
00825                  SepTokenObjectType,    <span class="comment">// ObjectType</span>
00826                  PreviousMode,          <span class="comment">// AccessMode</span>
00827                  (PVOID *)&amp;Token,       <span class="comment">// Object</span>
00828                  NULL                   <span class="comment">// GrantedAccess</span>
00829                  );
00830 
00831         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00832             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00833         }
00834 
00835         <span class="comment">//</span>
00836         <span class="comment">// The type of a token can not be changed, so</span>
00837         <span class="comment">// exclusive access to the token is not necessary.</span>
00838         <span class="comment">//</span>
00839 
00840         <span class="comment">//</span>
00841         <span class="comment">// Return the length required now in case not enough buffer</span>
00842         <span class="comment">// was provided by the caller and we have to return an error.</span>
00843         <span class="comment">//</span>
00844 
00845         RequiredLength = (ULONG) <span class="keyword">sizeof</span>(TOKEN_SOURCE);
00846 
00847         <span class="keywordflow">try</span> {
00848 
00849             *ReturnLength = RequiredLength;
00850 
00851         } except(EXCEPTION_EXECUTE_HANDLER) {
00852 
00853             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00854             <span class="keywordflow">return</span> GetExceptionCode();
00855         }
00856 
00857         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00858 
00859             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00860             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00861 
00862         }
00863 
00864 
00865         <span class="comment">//</span>
00866         <span class="comment">// Return the token source</span>
00867         <span class="comment">//</span>
00868 
00869         <span class="keywordflow">try</span> {
00870 
00871             (*LocalSource) = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenSource;
00872 
00873         } except(EXCEPTION_EXECUTE_HANDLER) {
00874 
00875             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00876             <span class="keywordflow">return</span> GetExceptionCode();
00877         }
00878 
00879 
00880         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00881         <span class="keywordflow">return</span> STATUS_SUCCESS;
00882 
00883     <span class="keywordflow">case</span> TokenType:
00884 
00885         LocalType = (PTOKEN_TYPE)TokenInformation;
00886 
00887         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00888                  TokenHandle,           <span class="comment">// Handle</span>
00889                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00890                  SepTokenObjectType,    <span class="comment">// ObjectType</span>
00891                  PreviousMode,          <span class="comment">// AccessMode</span>
00892                  (PVOID *)&amp;Token,       <span class="comment">// Object</span>
00893                  NULL                   <span class="comment">// GrantedAccess</span>
00894                  );
00895 
00896         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00897             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00898         }
00899 
00900         <span class="comment">//</span>
00901         <span class="comment">// The type of a token can not be changed, so</span>
00902         <span class="comment">// exclusive access to the token is not necessary.</span>
00903         <span class="comment">//</span>
00904 
00905         <span class="comment">//</span>
00906         <span class="comment">// Return the length required now in case not enough buffer</span>
00907         <span class="comment">// was provided by the caller and we have to return an error.</span>
00908         <span class="comment">//</span>
00909 
00910         RequiredLength = (ULONG) <span class="keyword">sizeof</span>(TOKEN_TYPE);
00911 
00912         <span class="keywordflow">try</span> {
00913 
00914             *ReturnLength = RequiredLength;
00915 
00916         } except(EXCEPTION_EXECUTE_HANDLER) {
00917 
00918             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00919             <span class="keywordflow">return</span> GetExceptionCode();
00920         }
00921 
00922         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
00923 
00924             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00925             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00926 
00927         }
00928 
00929 
00930         <span class="comment">//</span>
00931         <span class="comment">// Return the token type</span>
00932         <span class="comment">//</span>
00933 
00934         <span class="keywordflow">try</span> {
00935 
00936             (*LocalType) = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType;
00937 
00938         } except(EXCEPTION_EXECUTE_HANDLER) {
00939 
00940             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00941             <span class="keywordflow">return</span> GetExceptionCode();
00942         }
00943 
00944 
00945         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00946         <span class="keywordflow">return</span> STATUS_SUCCESS;
00947 
00948 
00949     <span class="keywordflow">case</span> TokenImpersonationLevel:
00950 
00951         LocalImpersonationLevel = (PSECURITY_IMPERSONATION_LEVEL)TokenInformation;
00952 
00953         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00954                  TokenHandle,           <span class="comment">// Handle</span>
00955                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
00956                  SepTokenObjectType,    <span class="comment">// ObjectType</span>
00957                  PreviousMode,          <span class="comment">// AccessMode</span>
00958                  (PVOID *)&amp;Token,       <span class="comment">// Object</span>
00959                  NULL                   <span class="comment">// GrantedAccess</span>
00960                  );
00961 
00962         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00963             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00964         }
00965 
00966         <span class="comment">//</span>
00967         <span class="comment">// The impersonation level of a token can not be changed, so</span>
00968         <span class="comment">// exclusive access to the token is not necessary.</span>
00969         <span class="comment">//</span>
00970 
00971         <span class="comment">//</span>
00972         <span class="comment">//  Make sure the token is an appropriate type to be retrieving</span>
00973         <span class="comment">//  the impersonation level from.</span>
00974         <span class="comment">//</span>
00975 
00976         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType != TokenImpersonation) {
00977 
00978             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00979             <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00980 
00981         }
00982 
00983         <span class="comment">//</span>
00984         <span class="comment">// Return the length required now in case not enough buffer</span>
00985         <span class="comment">// was provided by the caller and we have to return an error.</span>
00986         <span class="comment">//</span>
00987 
00988         RequiredLength = (ULONG) <span class="keyword">sizeof</span>(SECURITY_IMPERSONATION_LEVEL);
00989 
00990         <span class="keywordflow">try</span> {
00991 
00992             *ReturnLength = RequiredLength;
00993 
00994         } except(EXCEPTION_EXECUTE_HANDLER) {
00995 
00996             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00997             <span class="keywordflow">return</span> GetExceptionCode();
00998         }
00999 
01000         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
01001 
01002             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
01003             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
01004 
01005         }
01006 
01007 
01008         <span class="comment">//</span>
01009         <span class="comment">// Return the impersonation level</span>
01010         <span class="comment">//</span>
01011 
01012         <span class="keywordflow">try</span> {
01013 
01014             (*LocalImpersonationLevel) = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel;
01015 
01016         } except(EXCEPTION_EXECUTE_HANDLER) {
01017 
01018             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
01019             <span class="keywordflow">return</span> GetExceptionCode();
01020         }
01021 
01022 
01023         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
01024         <span class="keywordflow">return</span> STATUS_SUCCESS;
01025 
01026 
01027     <span class="keywordflow">case</span> TokenStatistics:
01028 
01029         LocalStatistics = (PTOKEN_STATISTICS)TokenInformation;
01030 
01031         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01032                  TokenHandle,           <span class="comment">// Handle</span>
01033                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
01034                  SepTokenObjectType,    <span class="comment">// ObjectType</span>
01035                  PreviousMode,          <span class="comment">// AccessMode</span>
01036                  (PVOID *)&amp;Token,       <span class="comment">// Object</span>
01037                  NULL                   <span class="comment">// GrantedAccess</span>
01038                  );
01039 
01040         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01041             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01042         }
01043 
01044         <span class="comment">//</span>
01045         <span class="comment">//  Gain exclusive access to the token.</span>
01046         <span class="comment">//</span>
01047 
01048         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
01049 
01050 
01051 
01052         <span class="comment">//</span>
01053         <span class="comment">// Return the length required now in case not enough buffer</span>
01054         <span class="comment">// was provided by the caller and we have to return an error.</span>
01055         <span class="comment">//</span>
01056 
01057         RequiredLength = (ULONG)<span class="keyword">sizeof</span>( TOKEN_STATISTICS );
01058 
01059         <span class="keywordflow">try</span> {
01060 
01061             *ReturnLength = RequiredLength;
01062 
01063         } except(EXCEPTION_EXECUTE_HANDLER) {
01064 
01065             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01066             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
01067             <span class="keywordflow">return</span> GetExceptionCode();
01068         }
01069 
01070         <span class="keywordflow">if</span> ( TokenInformationLength &lt; RequiredLength ) {
01071 
01072             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01073             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
01074             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
01075 
01076         }
01077 
01078         <span class="comment">//</span>
01079         <span class="comment">// Return the statistics</span>
01080         <span class="comment">//</span>
01081 
01082         <span class="keywordflow">try</span> {
01083 
01084             LocalStatistics-&gt;TokenId            = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenId;
01085             LocalStatistics-&gt;AuthenticationId   = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuthenticationId;
01086             LocalStatistics-&gt;ExpirationTime     = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ExpirationTime;
01087             LocalStatistics-&gt;TokenType          = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType;
01088             LocalStatistics-&gt;ImpersonationLevel = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel;
01089             LocalStatistics-&gt;DynamicCharged     = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicCharged;
01090             LocalStatistics-&gt;DynamicAvailable   = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable;
01091             LocalStatistics-&gt;GroupCount         = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount-1;
01092             LocalStatistics-&gt;PrivilegeCount     = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount;
01093             LocalStatistics-&gt;ModifiedId         = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ModifiedId;
01094 
01095         } except(EXCEPTION_EXECUTE_HANDLER) {
01096 
01097             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01098             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
01099             <span class="keywordflow">return</span> GetExceptionCode();
01100         }
01101 
01102 
01103         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01104         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
01105         <span class="keywordflow">return</span> STATUS_SUCCESS;
01106 
01107     <span class="keywordflow">case</span> TokenSessionId:
01108 
01109         <span class="keywordflow">if</span> ( TokenInformationLength != <span class="keyword">sizeof</span>(ULONG) )
01110             <span class="keywordflow">return</span>( STATUS_INFO_LENGTH_MISMATCH );
01111 
01112         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01113                  TokenHandle,           <span class="comment">// Handle</span>
01114                  TOKEN_QUERY,           <span class="comment">// DesiredAccess</span>
01115                  SepTokenObjectType,    <span class="comment">// ObjectType</span>
01116                  PreviousMode,          <span class="comment">// AccessMode</span>
01117                  (PVOID *)&amp;Token,       <span class="comment">// Object</span>
01118                  NULL                   <span class="comment">// GrantedAccess</span>
01119                  );
01120 
01121         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01122             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01123         }
01124 
01125         <span class="comment">//</span>
01126         <span class="comment">// Get SessionId for the token</span>
01127         <span class="comment">//</span>
01128         <a class="code" href="../../d9/d3/tokenqry_8c.html#a3">SeQuerySessionIdToken</a>( (PACCESS_TOKEN)Token,
01129                                &amp;SessionId);
01130 
01131         <span class="keywordflow">try</span> {
01132 
01133             *(PULONG)TokenInformation = SessionId;
01134             *ReturnLength = <span class="keyword">sizeof</span>(ULONG);
01135 
01136         } except(EXCEPTION_EXECUTE_HANDLER) {
01137             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
01138             <span class="keywordflow">return</span> GetExceptionCode();
01139         }
01140 
01141         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
01142         <span class="keywordflow">return</span>( STATUS_SUCCESS );
01143 
01144     <span class="keywordflow">default</span>:
01145 
01146         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
01147     }
01148 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="tokenqry.c::SeQueryAuthenticationIdToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeQueryAuthenticationIdToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>AuthenticationId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01152">1152</a> of file <a class="el" href="../../d0/d3/tokenqry_8c-source.html">tokenqry.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l00222">CheckAllowForeground()</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00050">GetProcessLuid()</a>, <a class="el" href="../../d4/d2/uuid_8c-source.html#l00532">NtSetUuidSeed()</a>, and <a class="el" href="../../d1/d7/subject_8c-source.html#l00529">SeQueryAuthenticationIdSubjectContext()</a>.
<p>
<pre class="fragment"><div>01160                    :
01161 
01162     Retrieve authentication <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
01163 
01164 Arguments:
01165 
01166     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Referenced pointer to a token.
01167 
01168     AutenticationId - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token's authentication <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.
01169 
01170 Return Value:
01171 
01172     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was successful.
01173 
01174     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> expected status.
01175 
01176 --*/
01177 {
01178     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01179 
01180     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( ((PTOKEN)Token) );
01181     (*AuthenticationId) = ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;AuthenticationId;
01182     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( ((PTOKEN)Token) );
01183     <span class="keywordflow">return</span>(STATUS_SUCCESS);
01184 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="tokenqry.c::SeQueryInformationToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeQueryInformationToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN TOKEN_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenInformation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01189">1189</a> of file <a class="el" href="../../d0/d3/tokenqry_8c-source.html">tokenqry.c</a>.
<p>
References <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00226">ANYSIZE_ARRAY</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01896">RtlCopyLuidAndAttributesArray()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01436">RtlCopySidAndAttributesArray()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01763">SeQuerySessionIdToken()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>.
<p>
<pre class="fragment"><div>01198                    :
01199 
01200     Retrieve information about a specified token.
01201 
01202 Arguments:
01203 
01204     TokenHandle - Provides a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to operate on.
01205 
01206     TokenInformationClass - The token information <span class="keyword">class </span>about which
01207         to retrieve information.
01208 
01209     TokenInformation - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information.
01210         The actual structures returned are dependent upon <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information
01211         class requested, as defined in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TokenInformationClass parameter
01212         description.
01213 
01214         TokenInformation Format By Information Class:
01215 
01216            TokenUser =&gt; TOKEN_USER data structure.  TOKEN_QUERY
01217            access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information about a
01218            token.
01219 
01220            TokenGroups =&gt; TOKEN_GROUPS data structure.  TOKEN_QUERY
01221            access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information about a
01222            token.
01223 
01224            TokenPrivileges =&gt; TOKEN_PRIVILEGES data structure.
01225            TOKEN_QUERY access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information
01226            about a token.
01227 
01228            TokenOwner =&gt; TOKEN_OWNER data structure.  TOKEN_QUERY
01229            access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information about a
01230            token.
01231 
01232            TokenPrimaryGroup =&gt; TOKEN_PRIMARY_GROUP data structure.
01233            TOKEN_QUERY access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information
01234            about a token.
01235 
01236            TokenDefaultDacl =&gt; TOKEN_DEFAULT_DACL data structure.
01237            TOKEN_QUERY access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information
01238            about a token.
01239 
01240            TokenSource =&gt; TOKEN_SOURCE data structure.
01241            TOKEN_QUERY_SOURCE access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this
01242            information about a token.
01243 
01244            TokenType =&gt; TOKEN_TYPE data structure.
01245            TOKEN_QUERY access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this information
01246            about a token.
01247 
01248            TokenStatistics =&gt; TOKEN_STATISTICS data structure.
01249            TOKEN_QUERY access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to retrieve this
01250            information about a token.
01251 
01252 Return Value:
01253 
01254     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was successful.
01255 
01256 --*/
01257 {
01258 
01259     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01260 
01261     ULONG RequiredLength;
01262     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01263 
01264     PSID PSid;
01265     PACL PAcl;
01266 
01267     PVOID Ignore;
01268     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)AccessToken;
01269 
01270     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01271 
01272     <span class="comment">//</span>
01273     <span class="comment">// Case on information class.</span>
01274     <span class="comment">//</span>
01275 
01276     <span class="keywordflow">switch</span> ( TokenInformationClass ) {
01277 
01278         <span class="keywordflow">case</span> TokenUser:
01279             {
01280                 PTOKEN_USER LocalUser;
01281 
01282                 <span class="comment">//</span>
01283                 <span class="comment">//  Gain exclusive access to the token.</span>
01284                 <span class="comment">//</span>
01285 
01286                 <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
01287 
01288                 <span class="comment">//</span>
01289                 <span class="comment">// Return the length required now in case not enough buffer</span>
01290                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01291                 <span class="comment">//</span>
01292 
01293                 RequiredLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[0].Sid) +
01294                                  (ULONG)<span class="keyword">sizeof</span>( TOKEN_USER );
01295 
01296                 LocalUser = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, RequiredLength );
01297 
01298                 <span class="keywordflow">if</span> (LocalUser == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01299                     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01300                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01301                 }
01302 
01303                 <span class="comment">//</span>
01304                 <span class="comment">// Return the user SID</span>
01305                 <span class="comment">//</span>
01306                 <span class="comment">//  Put SID immediately following TOKEN_USER data structure</span>
01307                 <span class="comment">//</span>
01308 
01309                 PSid = (PSID)( (ULONG_PTR)LocalUser + (ULONG)<span class="keyword">sizeof</span>(TOKEN_USER) );
01310 
01311                 <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
01312                     1,
01313                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups,
01314                     RequiredLength,
01315                     &amp;(LocalUser-&gt;User),
01316                     PSid,
01317                     ((PSID *)&amp;Ignore),
01318                     ((PULONG)&amp;Ignore)
01319                     );
01320 
01321                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01322                 *TokenInformation = LocalUser;
01323                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01324             }
01325 
01326 
01327         <span class="keywordflow">case</span> TokenGroups:
01328             {
01329                 PTOKEN_GROUPS LocalGroups;
01330 
01331                 <span class="comment">//</span>
01332                 <span class="comment">//  Gain exclusive access to the token.</span>
01333                 <span class="comment">//</span>
01334 
01335                 <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
01336 
01337                 <span class="comment">//</span>
01338                 <span class="comment">// Figure out how much space is needed to return the group SIDs.</span>
01339                 <span class="comment">// That's the size of TOKEN_GROUPS (without any array entries)</span>
01340                 <span class="comment">// plus the size of an SID_AND_ATTRIBUTES times the number of groups.</span>
01341                 <span class="comment">// The number of groups is Token-&gt;UserAndGroups-1 (since the count</span>
01342                 <span class="comment">// includes the user ID).  Then the lengths of each individual group</span>
01343                 <span class="comment">// must be added.</span>
01344                 <span class="comment">//</span>
01345 
01346                 RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
01347                                  ((<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> - 1) *
01348                                  ((ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES)) );
01349 
01350                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;
01351                 <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount) {
01352 
01353                     RequiredLength += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[Index].Sid );
01354 
01355                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01356 
01357                 } <span class="comment">// endwhile</span>
01358 
01359                 LocalGroups = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, RequiredLength );
01360 
01361                 <span class="keywordflow">if</span> (LocalGroups == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01362                     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01363                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01364                 }
01365 
01366                 <span class="comment">//</span>
01367                 <span class="comment">// Now copy the groups.</span>
01368                 <span class="comment">//</span>
01369 
01370                 LocalGroups-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - 1;
01371 
01372                 PSid = (PSID)( (ULONG_PTR)LocalGroups +
01373                                (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
01374                                (   (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> - 1) *
01375                                    (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES) )
01376                              );
01377 
01378                 <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
01379                     (ULONG)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount - 1),
01380                     &amp;(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[1]),
01381                     RequiredLength,
01382                     LocalGroups-&gt;Groups,
01383                     PSid,
01384                     ((PSID *)&amp;Ignore),
01385                     ((PULONG)&amp;Ignore)
01386                     );
01387 
01388                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01389                 *TokenInformation = LocalGroups;
01390                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01391             }
01392 
01393 
01394         <span class="keywordflow">case</span> TokenPrivileges:
01395             {
01396                 PTOKEN_PRIVILEGES LocalPrivileges;
01397 
01398                 <span class="comment">//</span>
01399                 <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
01400                 <span class="comment">//  from occuring to the privileges.</span>
01401                 <span class="comment">//</span>
01402 
01403                 <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
01404 
01405                 <span class="comment">//</span>
01406                 <span class="comment">// Return the length required now in case not enough buffer</span>
01407                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01408                 <span class="comment">//</span>
01409 
01410                 RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIVILEGES) +
01411                                  ((<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>) *
01412                                  ((ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)) );
01413 
01414                 LocalPrivileges = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, RequiredLength );
01415 
01416                 <span class="keywordflow">if</span> (LocalPrivileges == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01417                     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01418                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01419                 }
01420 
01421                 <span class="comment">//</span>
01422                 <span class="comment">// Return the token privileges.</span>
01423                 <span class="comment">//</span>
01424 
01425                 LocalPrivileges-&gt;PrivilegeCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount;
01426 
01427                 <a class="code" href="../../d8/d6/sertl_8c.html#a52">RtlCopyLuidAndAttributesArray</a>(
01428                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount,
01429                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges,
01430                     LocalPrivileges-&gt;Privileges
01431                     );
01432 
01433                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01434                 *TokenInformation = LocalPrivileges;
01435                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01436             }
01437 
01438 
01439         <span class="keywordflow">case</span> TokenOwner:
01440             {
01441                 PTOKEN_OWNER LocalOwner;
01442 
01443                 <span class="comment">//</span>
01444                 <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
01445                 <span class="comment">//  from occuring to the owner.</span>
01446                 <span class="comment">//</span>
01447 
01448                 <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
01449 
01450                 <span class="comment">//</span>
01451                 <span class="comment">// Return the length required now in case not enough buffer</span>
01452                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01453                 <span class="comment">//</span>
01454 
01455                 PSid = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex].Sid;
01456                 RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER) +
01457                                  <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( PSid );
01458 
01459                 LocalOwner = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, RequiredLength );
01460 
01461                 <span class="keywordflow">if</span> (LocalOwner == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01462                     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01463                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01464                 }
01465 
01466                 <span class="comment">//</span>
01467                 <span class="comment">// Return the owner SID</span>
01468                 <span class="comment">//</span>
01469 
01470                 PSid = (PSID)((ULONG_PTR)LocalOwner +
01471                               (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER));
01472 
01473                 LocalOwner-&gt;Owner = PSid;
01474 
01475                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
01476                              (RequiredLength - (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER)),
01477                              PSid,
01478                              <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex].Sid
01479                              );
01480 
01481                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
01482 
01483                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01484                 *TokenInformation = LocalOwner;
01485                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01486             }
01487 
01488 
01489         <span class="keywordflow">case</span> TokenPrimaryGroup:
01490             {
01491                 PTOKEN_PRIMARY_GROUP LocalPrimaryGroup;
01492 
01493                 <span class="comment">//</span>
01494                 <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
01495                 <span class="comment">//  from occuring to the owner.</span>
01496                 <span class="comment">//</span>
01497 
01498                 <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
01499 
01500                 <span class="comment">//</span>
01501                 <span class="comment">// Return the length required now in case not enough buffer</span>
01502                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01503                 <span class="comment">//</span>
01504 
01505                 RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP) +
01506                                  <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup );
01507 
01508                 LocalPrimaryGroup = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, RequiredLength );
01509 
01510                 <span class="keywordflow">if</span> (LocalPrimaryGroup == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01511                     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01512                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01513                 }
01514 
01515                 <span class="comment">//</span>
01516                 <span class="comment">// Return the primary group SID</span>
01517                 <span class="comment">//</span>
01518 
01519                 PSid = (PSID)((ULONG_PTR)LocalPrimaryGroup +
01520                               (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP));
01521 
01522                 LocalPrimaryGroup-&gt;PrimaryGroup = PSid;
01523 
01524                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( (RequiredLength - (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP)),
01525                                      PSid,
01526                                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup
01527                                      );
01528 
01529                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
01530 
01531                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01532                 *TokenInformation = LocalPrimaryGroup;
01533                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01534             }
01535 
01536 
01537         <span class="keywordflow">case</span> TokenDefaultDacl:
01538             {
01539                 PTOKEN_DEFAULT_DACL LocalDefaultDacl;
01540 
01541                 <span class="comment">//</span>
01542                 <span class="comment">//  Gain exclusive access to the token to prevent changes</span>
01543                 <span class="comment">//  from occuring to the owner.</span>
01544                 <span class="comment">//</span>
01545 
01546                 <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
01547 
01548                 <span class="comment">//</span>
01549                 <span class="comment">// Return the length required now in case not enough buffer</span>
01550                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01551                 <span class="comment">//</span>
01552 
01553                 RequiredLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL);
01554 
01555                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
01556 
01557                     RequiredLength += <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize;
01558                 }
01559 
01560                 LocalDefaultDacl = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, RequiredLength );
01561 
01562                 <span class="keywordflow">if</span> (LocalDefaultDacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01563                     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01564                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01565                 }
01566 
01567                 <span class="comment">//</span>
01568                 <span class="comment">// Return the default Dacl</span>
01569                 <span class="comment">//</span>
01570 
01571                 PAcl = (PACL)((ULONG_PTR)LocalDefaultDacl +
01572                               (ULONG)<span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL));
01573 
01574                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
01575 
01576                     LocalDefaultDacl-&gt;DefaultDacl = PAcl;
01577 
01578                     RtlCopyMemory( (PVOID)PAcl,
01579                                    (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl,
01580                                    <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize
01581                                    );
01582                 } <span class="keywordflow">else</span> {
01583 
01584                     LocalDefaultDacl-&gt;DefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01585                 }
01586 
01587                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01588                 *TokenInformation = LocalDefaultDacl;
01589                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01590             }
01591 
01592 
01593         <span class="keywordflow">case</span> TokenSource:
01594             {
01595                 PTOKEN_SOURCE LocalSource;
01596 
01597                 <span class="comment">//</span>
01598                 <span class="comment">// The type of a token can not be changed, so</span>
01599                 <span class="comment">// exclusive access to the token is not necessary.</span>
01600                 <span class="comment">//</span>
01601 
01602                 <span class="comment">//</span>
01603                 <span class="comment">// Return the length required now in case not enough buffer</span>
01604                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01605                 <span class="comment">//</span>
01606 
01607                 RequiredLength = (ULONG) <span class="keyword">sizeof</span>(TOKEN_SOURCE);
01608 
01609                 LocalSource = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, RequiredLength );
01610 
01611                 <span class="keywordflow">if</span> (LocalSource == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01612                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01613                 }
01614 
01615                 <span class="comment">//</span>
01616                 <span class="comment">// Return the token source</span>
01617                 <span class="comment">//</span>
01618 
01619                 (*LocalSource) = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenSource;
01620                 *TokenInformation = LocalSource;
01621 
01622                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01623             }
01624 
01625 
01626         <span class="keywordflow">case</span> TokenType:
01627             {
01628                 PTOKEN_TYPE LocalType;
01629 
01630                 <span class="comment">//</span>
01631                 <span class="comment">// The type of a token can not be changed, so</span>
01632                 <span class="comment">// exclusive access to the token is not necessary.</span>
01633                 <span class="comment">//</span>
01634 
01635                 <span class="comment">//</span>
01636                 <span class="comment">// Return the length required now in case not enough buffer</span>
01637                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01638                 <span class="comment">//</span>
01639 
01640                 RequiredLength = (ULONG) <span class="keyword">sizeof</span>(TOKEN_TYPE);
01641 
01642                 LocalType = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, RequiredLength );
01643 
01644                 <span class="keywordflow">if</span> (LocalType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01645                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01646                 }
01647 
01648                 <span class="comment">//</span>
01649                 <span class="comment">// Return the token type</span>
01650                 <span class="comment">//</span>
01651 
01652                 (*LocalType) = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType;
01653                 *TokenInformation = LocalType;
01654                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01655             }
01656 
01657 
01658         <span class="keywordflow">case</span> TokenImpersonationLevel:
01659             {
01660                 PSECURITY_IMPERSONATION_LEVEL LocalImpersonationLevel;
01661 
01662                 <span class="comment">//</span>
01663                 <span class="comment">// The impersonation level of a token can not be changed, so</span>
01664                 <span class="comment">// exclusive access to the token is not necessary.</span>
01665                 <span class="comment">//</span>
01666 
01667                 <span class="comment">//</span>
01668                 <span class="comment">//  Make sure the token is an appropriate type to be retrieving</span>
01669                 <span class="comment">//  the impersonation level from.</span>
01670                 <span class="comment">//</span>
01671 
01672                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType != TokenImpersonation) {
01673 
01674                     <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
01675                 }
01676 
01677                 <span class="comment">//</span>
01678                 <span class="comment">// Return the length required now in case not enough buffer</span>
01679                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01680                 <span class="comment">//</span>
01681 
01682                 RequiredLength = (ULONG) <span class="keyword">sizeof</span>(SECURITY_IMPERSONATION_LEVEL);
01683 
01684                 LocalImpersonationLevel = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, RequiredLength );
01685 
01686                 <span class="keywordflow">if</span> (LocalImpersonationLevel == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01687                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01688                 }
01689 
01690                 <span class="comment">//</span>
01691                 <span class="comment">// Return the impersonation level</span>
01692                 <span class="comment">//</span>
01693 
01694                 (*LocalImpersonationLevel) = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel;
01695                 *TokenInformation = LocalImpersonationLevel;
01696                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01697             }
01698 
01699 
01700         <span class="keywordflow">case</span> TokenStatistics:
01701             {
01702                 PTOKEN_STATISTICS LocalStatistics;
01703 
01704                 <span class="comment">//</span>
01705                 <span class="comment">//  Gain exclusive access to the token.</span>
01706                 <span class="comment">//</span>
01707 
01708                 <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
01709 
01710                 <span class="comment">//</span>
01711                 <span class="comment">// Return the length required now in case not enough buffer</span>
01712                 <span class="comment">// was provided by the caller and we have to return an error.</span>
01713                 <span class="comment">//</span>
01714 
01715                 RequiredLength = (ULONG)<span class="keyword">sizeof</span>( TOKEN_STATISTICS );
01716 
01717                 LocalStatistics = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, RequiredLength );
01718 
01719                 <span class="keywordflow">if</span> (LocalStatistics == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01720                     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01721                     <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01722                 }
01723 
01724                 <span class="comment">//</span>
01725                 <span class="comment">// Return the statistics</span>
01726                 <span class="comment">//</span>
01727 
01728                 LocalStatistics-&gt;TokenId            = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenId;
01729                 LocalStatistics-&gt;AuthenticationId   = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuthenticationId;
01730                 LocalStatistics-&gt;ExpirationTime     = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ExpirationTime;
01731                 LocalStatistics-&gt;TokenType          = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType;
01732                 LocalStatistics-&gt;ImpersonationLevel = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel;
01733                 LocalStatistics-&gt;DynamicCharged     = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicCharged;
01734                 LocalStatistics-&gt;DynamicAvailable   = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable;
01735                 LocalStatistics-&gt;GroupCount         = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount-1;
01736                 LocalStatistics-&gt;PrivilegeCount     = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount;
01737                 LocalStatistics-&gt;ModifiedId         = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ModifiedId;
01738 
01739                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
01740                 *TokenInformation = LocalStatistics;
01741                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01742             }
01743 
01744     <span class="keywordflow">case</span> TokenSessionId:
01745 
01746         <span class="comment">/*</span>
01747 <span class="comment">         * Get SessionId for the token</span>
01748 <span class="comment">         */</span>
01749         <a class="code" href="../../d9/d3/tokenqry_8c.html#a3">SeQuerySessionIdToken</a>( (PACCESS_TOKEN)Token,
01750                              (PULONG)TokenInformation );
01751 
01752         <span class="keywordflow">return</span>( STATUS_SUCCESS );
01753 
01754     <span class="keywordflow">default</span>:
01755 
01756         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
01757     }
01758 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="tokenqry.c::SeQuerySessionIdToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeQuerySessionIdToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SessionId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01763">1763</a> of file <a class="el" href="../../d0/d3/tokenqry_8c-source.html">tokenqry.c</a>.
<p>
References <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, and <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01189">SeQueryInformationToken()</a>.
<p>
<pre class="fragment"><div>01771                    :
01772 
01773     Gets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SessionId from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified token object.
01774 
01775 Arguments:
01776 
01777     <a class="code" href="../../d2/d1/cttoken_8c.html#a28">Token</a> (input)
01778       Opaque kernel ACCESS_TOKEN pointer
01779     SessionId (output)
01780       pointer to location to return SessionId
01781 
01782 Return Value:
01783 
01784     STATUS_SUCCESS - no error
01785 
01786 --*/
01787 {
01788 
01789     <span class="comment">/*</span>
01790 <span class="comment">     * Get the SessionId.</span>
01791 <span class="comment">     */</span>
01792     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( ((PTOKEN)Token) );
01793     (*SessionId) = ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;SessionId;
01794     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( ((PTOKEN)Token) );
01795     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01796 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
