<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: filtrctx.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>filtrctx.c File Reference</h1><code>#include "FsRtlP.h"</code><br>

<p>
<a href="../../d0/d3/filtrctx_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/filtrctx_8c.html#a0">MySearchList</a>(pHdr, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>)&nbsp;&nbsp;&nbsp;for ( <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> = (pHdr)-&gt;Flink;  <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> != (pHdr);  <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> = <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>-&gt;Flink )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/filtrctx_8c.html#a1">Dbg</a>&nbsp;&nbsp;&nbsp;(0x80000000)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/filtrctx_8c.html#a2">FsRtlInsertFilterContext</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a> <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/filtrctx_8c.html#a3">FsRtlLookupFilterContextInternal</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PVOID OwnerId OPTIONAL, IN PVOID InstanceId OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/filtrctx_8c.html#a4">FsRtlRemoveFilterContext</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PVOID OwnerId OPTIONAL, IN PVOID InstanceId OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/filtrctx_8c.html#a5">FsRtlTeardownFilterContexts</a> (IN PLIST_ENTRY FilterContexts)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="filtrctx.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(0x80000000)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00053">53</a> of file <a class="el" href="../../d0/d3/filtrctx_8c-source.html">filtrctx.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="filtrctx.c::MySearchList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MySearchList          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">pHdr,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;for ( <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> = (pHdr)-&gt;Flink;  <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> != (pHdr);  <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a> = <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>-&gt;Flink )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00046">46</a> of file <a class="el" href="../../d0/d3/filtrctx_8c-source.html">filtrctx.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00108">FsRtlLookupFilterContextInternal()</a>, and <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00189">FsRtlRemoveFilterContext()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="filtrctx.c::FsRtlInsertFilterContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS FsRtlInsertFilterContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Ptr</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00058">58</a> of file <a class="el" href="../../d0/d3/filtrctx_8c-source.html">filtrctx.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00265">FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a85">PFSRTL_FILTER_CONTEXT</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00052">Ptr</a>.
<p>
<pre class="fragment"><div>00064                    :
00065 
00066     This routine associates filter driver context with a stream.
00067 
00068 Arguments:
00069 
00070     FileObject - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream of interest.
00071 
00072     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter-specific context structure.
00073         The common header fields OwnerId and InstanceId should
00074         be filled in by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter driver before calling.
00075 
00076 Return Value:
00077 
00078     STATUS_SUCCESS - operation succeeded.
00079 
00080     STATUS_INVALID_DEVICE_REQUEST - underlying filesystem does not support
00081         filter contexts.
00082 
00083 --*/
00084 
00085 {
00086     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>  <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00087 
00088     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FileObject);
00089     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FileObject-&gt;FsContext);
00090 
00091     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = FileObject-&gt;FsContext;
00092 
00093     <span class="keywordflow">if</span> (! (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Flags2 &amp; <a class="code" href="../../d1/d8/fsrtl_8h.html#a9">FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS</a>) ) {
00094         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
00095     }
00096 
00097     ExAcquireFastMutex (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FastMutex);
00098 
00099     InsertHeadList (&amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts, &amp;<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a>-&gt;Links);
00100 
00101     ExReleaseFastMutex(<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FastMutex);
00102     <span class="keywordflow">return</span> STATUS_SUCCESS;
00103 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="filtrctx.c::FsRtlLookupFilterContextInternal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a> FsRtlLookupFilterContextInternal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID OwnerId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InstanceId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00108">108</a> of file <a class="el" href="../../d0/d3/filtrctx_8c-source.html">filtrctx.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a84">FSRTL_FILTER_CONTEXT</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00265">FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01648">_FSRTL_FILTER_CONTEXT::InstanceId</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00046">MySearchList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01647">_FSRTL_FILTER_CONTEXT::OwnerId</a>.
<p>
<pre class="fragment"><div>00115                    :
00116 
00117     This routine lookups filter driver context associated with a stream.
00118 
00119     The macro <a class="code" href="../../d1/d8/fsrtl_8h.html#a46">FsRtlLookupFilterContext</a> should be used instead of calling
00120     <span class="keyword">this</span> routine directly.  The macro optimizes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common <span class="keywordflow">case</span>
00121     of an empty list.
00122 
00123 Arguments:
00124 
00125     FileObject - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream of interest.
00126 
00127     OwnerId - Used to identify context information belonging to a particular
00128         filter driver.
00129 
00130     InstanceId - Used to search <span class="keywordflow">for</span> a particular instance of a filter driver
00131         context.  If not provided, any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contexts owned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter
00132         driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00133 
00134     If neither <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OwnerId nor <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> InstanceId <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> provided, any associated
00135         filter context will be returned.
00136 
00137 Return Value:
00138 
00139     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter context, or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> no match found.
00140 
00141 --*/
00142 
00143 {
00144     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>  <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00145     <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>     Ctx, RtnCtx;
00146     PLIST_ENTRY               <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00147 
00148     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FileObject);
00149     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FileObject-&gt;FsContext);
00150 
00151     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = FileObject-&gt;FsContext;
00152 
00153     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Flags2 &amp; FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS);
00154 
00155     ExAcquireFastMutex (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FastMutex);
00156     RtnCtx = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00157 
00158   <span class="comment">// Use different loops depending on whether we are comparing both Ids or not.</span>
00159     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(InstanceId) ) {
00160 
00161         <a class="code" href="../../d9/d3/filtrctx_8c.html#a0">MySearchList</a> (&amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts, List) {
00162             Ctx  = CONTAINING_RECORD (List, <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">FSRTL_FILTER_CONTEXT</a>, Links);
00163             <span class="keywordflow">if</span> (Ctx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o1">OwnerId</a> == OwnerId &amp;&amp; Ctx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o2">InstanceId</a> == InstanceId) {
00164                 RtnCtx = Ctx;
00165                 <span class="keywordflow">break</span>;
00166             }
00167         }
00168     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(OwnerId) ) {
00169 
00170         <a class="code" href="../../d9/d3/filtrctx_8c.html#a0">MySearchList</a> (&amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts, List) {
00171             Ctx  = CONTAINING_RECORD (List, <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">FSRTL_FILTER_CONTEXT</a>, Links);
00172             <span class="keywordflow">if</span> (Ctx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o1">OwnerId</a> == OwnerId) {
00173                 RtnCtx = Ctx;
00174                 <span class="keywordflow">break</span>;
00175             }
00176         }
00177     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!IsListEmpty(&amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts)) {
00178 
00179         RtnCtx = (<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>) <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts.Flink;
00180     }
00181 
00182     ExReleaseFastMutex(<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FastMutex);
00183     <span class="keywordflow">return</span> RtnCtx;
00184 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="filtrctx.c::FsRtlRemoveFilterContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a> FsRtlRemoveFilterContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID OwnerId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InstanceId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00189">189</a> of file <a class="el" href="../../d0/d3/filtrctx_8c-source.html">filtrctx.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00265">FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01648">_FSRTL_FILTER_CONTEXT::InstanceId</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01646">_FSRTL_FILTER_CONTEXT::Links</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00046">MySearchList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01647">_FSRTL_FILTER_CONTEXT::OwnerId</a>.
<p>
<pre class="fragment"><div>00196                    :
00197 
00198     This routine deletes filter driver context associated with a stream.
00199 
00200     <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> drivers must explicitly remove all context they associate with
00201     a stream (otherwise the underlying filesystem will BugCheck at close).
00202 
00203     <a class="code" href="../../d9/d3/filtrctx_8c.html#a4">FsRtlRemoveFilterContext</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> identically to <a class="code" href="../../d1/d8/fsrtl_8h.html#a46">FsRtlLookupFilterContext</a>,
00204     except that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned context has been removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00205 
00206 Arguments:
00207 
00208     FileObject - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream of interest.
00209 
00210     OwnerId - Used to identify context information belonging to a particular
00211         filter driver.
00212 
00213     InstanceId - Used to search <span class="keywordflow">for</span> a particular instance of a filter driver
00214         context.  If not provided, any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contexts owned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter
00215         driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed and returned.
00216 
00217     If neither <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OwnerId nor <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> InstanceId <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> provided, any associated
00218         filter context will be removed and returned.
00219 
00220 Return Value:
00221 
00222     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter context, or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> no match found.
00223 
00224 --*/
00225 
00226 {
00227     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>  <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00228     <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>     Ctx, RtnCtx;
00229     PLIST_ENTRY               <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00230 
00231     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FileObject);
00232 
00233     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = FileObject-&gt;FsContext;
00234 
00235     <span class="keywordflow">if</span> ( !<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> || !(<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Flags2 &amp; <a class="code" href="../../d1/d8/fsrtl_8h.html#a9">FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS</a>) ) {
00236         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00237     }
00238 
00239     ExAcquireFastMutex (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FastMutex);
00240     RtnCtx = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00241 
00242   <span class="comment">// Use different loops depending on whether we are comparing both Ids or not.</span>
00243     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(InstanceId) ) {
00244 
00245         <a class="code" href="../../d9/d3/filtrctx_8c.html#a0">MySearchList</a> (&amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts, List) {
00246             Ctx  = CONTAINING_RECORD (List, <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">FSRTL_FILTER_CONTEXT</a>, Links);
00247             <span class="keywordflow">if</span> (Ctx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o1">OwnerId</a> == OwnerId &amp;&amp; Ctx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o2">InstanceId</a> == InstanceId) {
00248                 RtnCtx = Ctx;
00249                 <span class="keywordflow">break</span>;
00250             }
00251         }
00252     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(OwnerId) ) {
00253 
00254         <a class="code" href="../../d9/d3/filtrctx_8c.html#a0">MySearchList</a> (&amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts, List) {
00255             Ctx  = CONTAINING_RECORD (List, <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">FSRTL_FILTER_CONTEXT</a>, Links);
00256             <span class="keywordflow">if</span> (Ctx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o1">OwnerId</a> == OwnerId) {
00257                 RtnCtx = Ctx;
00258                 <span class="keywordflow">break</span>;
00259             }
00260         }
00261     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!IsListEmpty(&amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts)) {
00262 
00263         RtnCtx = (<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>) <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts.Flink;
00264     }
00265 
00266     <span class="keywordflow">if</span> (RtnCtx) {
00267         RemoveEntryList(&amp;RtnCtx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o0">Links</a>);   <span class="comment">// remove the matched entry</span>
00268     }
00269     ExReleaseFastMutex(<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FastMutex);
00270     <span class="keywordflow">return</span> RtnCtx;
00271 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="filtrctx.c::FsRtlTeardownFilterContexts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlTeardownFilterContexts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FilterContexts</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00276">276</a> of file <a class="el" href="../../d0/d3/filtrctx_8c-source.html">filtrctx.c</a>.
<p>
References <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01649">_FSRTL_FILTER_CONTEXT::FreeCallback</a>.
<p>
<pre class="fragment"><div>00281                    :
00282 
00283     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by filesystems to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter contexts
00284     associated with an <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">FSRTL_COMMON_FCB_HEADER</a> by calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FreeCallback
00285     routine <span class="keywordflow">for</span> each FilterContext.
00286 
00287     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed that we <span class="keywordflow">do</span> not need to acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FastMutex.
00288 
00289 Arguments:
00290 
00291     FilterContexts - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FilterContexts field within
00292         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">FSRTL_COMMON_FCB_HEADER</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure being torn down
00293         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filesystem.
00294 
00295 Return Value:
00296 
00297     None.
00298 
00299 --*/
00300 
00301 {
00302     <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a> ctx;
00303     PLIST_ENTRY           ptr;
00304 
00305     ptr = FilterContexts-&gt;Flink;
00306 
00307     <span class="keywordflow">while</span> ( ptr != FilterContexts ) {
00308         ctx = CONTAINING_RECORD (ptr, <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">FSRTL_FILTER_CONTEXT</a>, Links);
00309         ptr = ptr-&gt;Flink;
00310         (*ctx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o3">FreeCallback</a>)(ctx);
00311     }
00312 
00313     InitializeListHead( FilterContexts );
00314     <span class="keywordflow">return</span>;
00315 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
