<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: random.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>random.c</h1><a href="../../d8/d4/w32_2ntuser_2kernel_2random_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: random.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains a random collection of support routines for the User</span>
00007 <span class="comment">* API functions.  Many of these functions will be moved to more appropriate</span>
00008 <span class="comment">* files once we get our act together.</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* History:</span>
00011 <span class="comment">* 10-17-90 DarrinM      Created.</span>
00012 <span class="comment">* 02-06-91 IanJa        HWND revalidation added (none required)</span>
00013 <span class="comment">\***************************************************************************/</span>
00014 
00015 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00016 <span class="preprocessor">#pragma hdrstop</span>
00017 <span class="preprocessor"></span>
00018 
00019 <span class="comment">/***************************************************************************\</span>
00020 <span class="comment">* xxxUpdateWindows</span>
00021 <span class="comment">*</span>
00022 <span class="comment">* User mode wrapper</span>
00023 <span class="comment">\***************************************************************************/</span>
00024 
<a name="l00025"></a><a class="code" href="../../d4/d1/userk_8h.html#a1630">00025</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1630">xxxUpdateWindows</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, HRGN hrgn)
00026 {
00027     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00028 
00029     <a class="code" href="../../d4/d1/userk_8h.html#a1943">xxxUpdateThreadsWindows</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), pwnd, hrgn);
00030 
00031     <span class="comment">/*</span>
00032 <span class="comment">     * This function needs to return a value, since it is</span>
00033 <span class="comment">     * called through NtUserCallHwndParam.</span>
00034 <span class="comment">     */</span>
00035     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00036 }
00037 
00038 <span class="comment">/***************************************************************************\</span>
00039 <span class="comment">* ValidateState</span>
00040 <span class="comment">*</span>
00041 <span class="comment">* States allowed to be set/cleared by Set/ClearWindowState. If you're</span>
00042 <span class="comment">* allowing a new flag here, you must make sure it won't cause an AV</span>
00043 <span class="comment">* in the kernel if someone sets it maliciously.</span>
00044 <span class="comment">\***************************************************************************/</span>
00045 
<a name="l00046"></a><a class="code" href="../../d8/d4/w32_2ntuser_2kernel_2random_8c.html#a0">00046</a> <span class="preprocessor">#define NUM_BYTES 16  // Window state bytes are 0 to F, explanation in user.h</span>
00047 <span class="preprocessor"></span>
<a name="l00048"></a><a class="code" href="../../d8/d4/w32_2ntuser_2kernel_2random_8c.html#a1">00048</a> CONST <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d8/d4/w32_2ntuser_2kernel_2random_8c.html#a1">abValidateState</a>[<a class="code" href="../../d8/d4/w32_2ntuser_2kernel_2random_8c.html#a0">NUM_BYTES</a>] = {
00049     0,      <span class="comment">// 0</span>
00050     0,      <span class="comment">// 1</span>
00051     0,      <span class="comment">// 2</span>
00052     0,      <span class="comment">// 3</span>
00053     0,      <span class="comment">// 4</span>
00054     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>),
00055     0,      <span class="comment">// 6</span>
00056     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a631">WFNOANIMATE</a>),
00057     0,      <span class="comment">// 8</span>
00058     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a622">WEFEDGEMASK</a>),
00059     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a628">WEFSTATICEDGE</a>),
00060     0,      <span class="comment">// B</span>
00061     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a704">EFPASSWORD</a>),
00062     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a689">CBFHASSTRINGS</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a710">EFREADONLY</a>),
00063     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a635">WFTABSTOP</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a639">WFSYSMENU</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a641">WFVSCROLL</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a640">WFHSCROLL</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a644">WFBORDER</a>),
00064     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>)
00065 };
00066 
<a name="l00067"></a><a class="code" href="../../d8/d4/w32_2ntuser_2kernel_2random_8c.html#a3">00067</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d4/w32_2ntuser_2kernel_2random_8c.html#a3">ValidateState</a>(DWORD dwFlags)
00068 {
00069     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bOffset = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>), bState = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00070 
00071     <span class="keywordflow">if</span> (bOffset &gt; <a class="code" href="../../d8/d4/w32_2ntuser_2kernel_2random_8c.html#a0">NUM_BYTES</a> - 1)
00072         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00073 
00074     <span class="keywordflow">return</span> ((bState &amp; <a class="code" href="../../d8/d4/w32_2ntuser_2kernel_2random_8c.html#a1">abValidateState</a>[bOffset]) == bState);
00075 }
00076 
00077 <span class="comment">/***************************************************************************\</span>
00078 <span class="comment">* Set/ClearWindowState</span>
00079 <span class="comment">*</span>
00080 <span class="comment">* Wrapper functions for User mode to be able to set state fags</span>
00081 <span class="comment">\***************************************************************************/</span>
00082 
<a name="l00083"></a><a class="code" href="../../d4/d1/userk_8h.html#a1628">00083</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1628">SetWindowState</a>(
00084     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00085     DWORD dwFlags)
00086 {
00087     <span class="comment">/*</span>
00088 <span class="comment">     * Don't let anyone mess with someone else's window</span>
00089 <span class="comment">     */</span>
00090     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;ppi) {
00091         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/w32_2ntuser_2kernel_2random_8c.html#a3">ValidateState</a>(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>)) {
00092             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00093         } <span class="keywordflow">else</span> {
00094             RIPMSG1(RIP_ERROR, <span class="stringliteral">"SetWindowState: invalid flag %x"</span>, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00095         }
00096     } <span class="keywordflow">else</span> {
00097         RIPMSG1(RIP_WARNING, <span class="stringliteral">"SetWindowState: current ppi doesn't own pwnd %#p"</span>, pwnd);
00098     }
00099 
00100 }
00101 
<a name="l00102"></a><a class="code" href="../../d4/d1/userk_8h.html#a1629">00102</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1629">ClearWindowState</a>(
00103     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00104     DWORD dwFlags)
00105 {
00106     <span class="comment">/*</span>
00107 <span class="comment">     * Don't let anyone mess with someone else's window</span>
00108 <span class="comment">     */</span>
00109     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;ppi) {
00110         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/w32_2ntuser_2kernel_2random_8c.html#a3">ValidateState</a>(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>)) {
00111             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00112         } <span class="keywordflow">else</span> {
00113             RIPMSG1(RIP_ERROR, <span class="stringliteral">"SetWindowState: invalid flag %x"</span>, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00114         }
00115     } <span class="keywordflow">else</span> {
00116         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ClearWindowState: current ppi doesn't own pwnd %#p"</span>, pwnd);
00117     }
00118 
00119 }
00120 
00121 
00122 <span class="comment">/***************************************************************************\</span>
00123 <span class="comment">* CheckPwndFilter</span>
00124 <span class="comment">*</span>
00125 <span class="comment">*</span>
00126 <span class="comment">*</span>
00127 <span class="comment">* History:</span>
00128 <span class="comment">* 11-07-90 DarrinM      Translated Win 3.0 ASM code.</span>
00129 <span class="comment">\***************************************************************************/</span>
00130 
<a name="l00131"></a><a class="code" href="../../d4/d1/userk_8h.html#a1220">00131</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1220">CheckPwndFilter</a>(
00132     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00133     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFilter)
00134 {
00135     <span class="keywordflow">if</span> ((pwndFilter == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pwndFilter == pwnd) ||
00136             ((pwndFilter == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)1) &amp;&amp; (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
00137         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00138     }
00139 
00140     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a16">_IsChild</a>(pwndFilter, pwnd);
00141 }
00142 
00143 
00144 <span class="comment">/***************************************************************************\</span>
00145 <span class="comment">* AllocateUnicodeString</span>
00146 <span class="comment">*</span>
00147 <span class="comment">* History:</span>
00148 <span class="comment">* 10-25-90 MikeHar      Wrote.</span>
00149 <span class="comment">* 11-09-90 DarrinM      Fixed.</span>
00150 <span class="comment">* 01-13-92 GregoryW     Neutralized.</span>
00151 <span class="comment">* 03-05-98 FritzS       Only allocate Length+1</span>
00152 <span class="comment">\***************************************************************************/</span>
00153 
00154 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00155"></a><a class="code" href="../../d4/d1/userk_8h.html#a1533">00155</a> <a class="code" href="../../d4/d1/userk_8h.html#a1533">AllocateUnicodeString</a>(
00156     PUNICODE_STRING pstrDst,
00157     PUNICODE_STRING cczpstrSrc)
00158 {
00159     <span class="keywordflow">if</span> (cczpstrSrc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00160         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(pstrDst, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00161         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00162     }
00163 
00164     pstrDst-&gt;Buffer = UserAllocPoolWithQuota(cczpstrSrc-&gt;Length+<span class="keyword">sizeof</span>(UNICODE_NULL), TAG_TEXT);
00165     <span class="keywordflow">if</span> (pstrDst-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00166         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00167     }
00168 
00169     <span class="keywordflow">try</span> {
00170         RtlCopyMemory(pstrDst-&gt;Buffer, cczpstrSrc-&gt;Buffer, cczpstrSrc-&gt;Length);
00171     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00172         UserFreePool(pstrDst-&gt;Buffer);
00173         pstrDst-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00174         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00175     }
00176     pstrDst-&gt;MaximumLength = cczpstrSrc-&gt;Length+<span class="keyword">sizeof</span>(UNICODE_NULL);
00177     pstrDst-&gt;Length = cczpstrSrc-&gt;Length;
00178     pstrDst-&gt;Buffer[pstrDst-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)] = 0;
00179 
00180     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00181 }
00182 
00183 
00184 <span class="comment">/***************************************************************************\</span>
00185 <span class="comment">* xxxGetControlColor</span>
00186 <span class="comment">*</span>
00187 <span class="comment">* &lt;brief description&gt;</span>
00188 <span class="comment">*</span>
00189 <span class="comment">* History:</span>
00190 <span class="comment">* 02-12-92 JimA     Ported from Win31 sources</span>
00191 <span class="comment">\***************************************************************************/</span>
00192 
<a name="l00193"></a><a class="code" href="../../d4/d1/userk_8h.html#a1565">00193</a> HBRUSH <a class="code" href="../../d4/d1/userk_8h.html#a1565">xxxGetControlColor</a>(
00194     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent,
00195     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndCtl,
00196     HDC hdc,
00197     UINT message)
00198 {
00199     HBRUSH hbrush;
00200 
00201     <span class="comment">/*</span>
00202 <span class="comment">     * If we're sending to a window of another thread, don't send this message</span>
00203 <span class="comment">     * but instead call DefWindowProc().  New rule about the CTLCOLOR messages.</span>
00204 <span class="comment">     * Need to do this so that we don't send an hdc owned by one thread to</span>
00205 <span class="comment">     * another thread.  It is also a harmless change.</span>
00206 <span class="comment">     */</span>
00207     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>() != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndParent)-&gt;ppi) {
00208         <span class="keywordflow">return</span> (HBRUSH)<a class="code" href="../../d4/d1/userk_8h.html#a1632">xxxDefWindowProc</a>(pwndParent, message, (WPARAM)hdc, (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndCtl));
00209     }
00210 
00211     hbrush = (HBRUSH)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndParent, message, (WPARAM)hdc, (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndCtl));
00212 
00213     <span class="comment">/*</span>
00214 <span class="comment">     * If the brush returned from the parent is invalid, get a valid brush from</span>
00215 <span class="comment">     * xxxDefWindowProc.</span>
00216 <span class="comment">     */</span>
00217     <span class="keywordflow">if</span> ((hbrush == 0) || !GreValidateServerHandle(hbrush, BRUSH_TYPE)) {
00218 <span class="preprocessor">#if DBG</span>
00219 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (hbrush != 0)
00220             RIPMSG2(RIP_WARNING,
00221                     <span class="stringliteral">"Invalid HBRUSH from WM_CTLCOLOR*** msg %lX brush %lX"</span>, message, hbrush);
00222 <span class="preprocessor">#endif</span>
00223 <span class="preprocessor"></span>        hbrush = (HBRUSH)<a class="code" href="../../d4/d1/userk_8h.html#a1632">xxxDefWindowProc</a>(pwndParent, message,
00224                 (WPARAM)hdc, (LPARAM)pwndCtl);
00225     }
00226 
00227     <span class="keywordflow">return</span> hbrush;
00228 }
00229 
00230 
00231 <span class="comment">/***************************************************************************\</span>
00232 <span class="comment">* xxxGetControlBrush</span>
00233 <span class="comment">*</span>
00234 <span class="comment">* &lt;brief description&gt;</span>
00235 <span class="comment">*</span>
00236 <span class="comment">* History:</span>
00237 <span class="comment">* 12-10-90 IanJa   type replaced with new 32-bit message</span>
00238 <span class="comment">* 01-21-91 IanJa   Prefix '_' denoting exported function (although not API)</span>
00239 <span class="comment">\***************************************************************************/</span>
00240 
<a name="l00241"></a><a class="code" href="../../d4/d1/userk_8h.html#a1564">00241</a> HBRUSH <a class="code" href="../../d4/d1/userk_8h.html#a1564">xxxGetControlBrush</a>(
00242     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00243     HDC hdc,
00244     UINT message)
00245 {
00246     HBRUSH hbr;
00247     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndSend;
00248     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndSend;
00249 
00250     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00251 
00252     <span class="keywordflow">if</span> ((pwndSend = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a739">TestwndPopup</a>(pwnd) ? pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> : pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>))
00253          == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00254         pwndSend = pwnd;
00255 
00256     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndSend, &amp;tlpwndSend);
00257 
00258     <span class="comment">/*</span>
00259 <span class="comment">     * Last parameter changes the message into a ctlcolor id.</span>
00260 <span class="comment">     */</span>
00261     hbr = <a class="code" href="../../d4/d1/userk_8h.html#a1565">xxxGetControlColor</a>(pwndSend, pwnd, hdc, message);
00262     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndSend);
00263 
00264     <span class="keywordflow">return</span> hbr;
00265 }
00266 
00267 <span class="comment">/***************************************************************************\</span>
00268 <span class="comment">* xxxHardErrorControl</span>
00269 <span class="comment">*</span>
00270 <span class="comment">* Performs kernel-mode hard error support functions.</span>
00271 <span class="comment">*</span>
00272 <span class="comment">* History:</span>
00273 <span class="comment">* 02-08-95 JimA         Created.</span>
00274 <span class="comment">\***************************************************************************/</span>
00275 
<a name="l00276"></a><a class="code" href="../../d4/d1/userk_8h.html#a1175">00276</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d1/userk_8h.html#a1175">xxxHardErrorControl</a>(
00277     DWORD dwCmd,
00278     HANDLE handle,
00279     PDESKRESTOREDATA pdrdRestore)
00280 {
00281     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiClient, ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00282     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
00283     PUNICODE_STRING pstrName;
00284     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00285     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00286     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAllowForeground;
00287 
00288     <span class="comment">/*</span>
00289 <span class="comment">     * turn off BlockInput so the user can respond to the hard error popup</span>
00290 <span class="comment">     */</span>
00291     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a26">gptiBlockInput</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00292 
00293     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
00294     <span class="keywordflow">switch</span> (dwCmd) {
00295     <span class="keywordflow">case</span> HardErrorSetup:
00296 
00297         <span class="comment">/*</span>
00298 <span class="comment">         * Don't do it if the system has not been initialized.</span>
00299 <span class="comment">         */</span>
00300         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00301             RIPMSG0(RIP_WARNING, <span class="stringliteral">"HardErrorControl: System not initialized"</span>);
00302             <span class="keywordflow">return</span> HEC_ERROR;
00303         }
00304 
00305         <span class="comment">/*</span>
00306 <span class="comment">         * Setup caller as the hard error handler.</span>
00307 <span class="comment">         */</span>
00308         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o0">pti</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00309             RIPMSG1(RIP_WARNING, <span class="stringliteral">"HardErrorControl: pti not NULL %#p"</span>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o0">pti</a>);
00310             <span class="keywordflow">return</span> HEC_ERROR;
00311         }
00312 
00313         <span class="comment">/*</span>
00314 <span class="comment">         * Mark the handler as active.</span>
00315 <span class="comment">         */</span>
00316         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o0">pti</a> = ptiCurrent;
00317 
00318         <span class="comment">/*</span>
00319 <span class="comment">         * Clear any pending quits.</span>
00320 <span class="comment">         */</span>
00321         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o16">cQuit</a> = 0;
00322 
00323         <span class="keywordflow">break</span>;
00324 
00325     <span class="keywordflow">case</span> HardErrorCleanup:
00326 
00327         <span class="comment">/*</span>
00328 <span class="comment">         * Remove caller as the hard error handler.</span>
00329 <span class="comment">         */</span>
00330         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o0">pti</a> != ptiCurrent)  {
00331             <span class="keywordflow">return</span> HEC_ERROR;
00332         }
00333 
00334         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o0">pti</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00335         <span class="keywordflow">break</span>;
00336 
00337     <span class="keywordflow">case</span> HardErrorAttachUser:
00338     <span class="keywordflow">case</span> HardErrorInDefDesktop:
00339         <span class="comment">/*</span>
00340 <span class="comment">         * Check for exit conditions. We do not allow attaches to the</span>
00341 <span class="comment">         * disconnect desktop.</span>
00342 <span class="comment">         */</span>
00343         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00344             <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00345 
00346                  ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>) &amp;&amp;
00347                   (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a330">gspdeskShouldBeForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) ||
00348 
00349                  ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>) &amp;&amp;
00350                   (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a330">gspdeskShouldBeForeground</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>))) {
00351                 <span class="keywordflow">return</span> HEC_ERROR;
00352             }
00353         }
00354 
00355         <span class="comment">/*</span>
00356 <span class="comment">         * Only attach to a user desktop.</span>
00357 <span class="comment">         */</span>
00358         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>() &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>) {
00359             pstrName = <a class="code" href="../../d4/d1/userk_8h.html#a522">POBJECT_NAME</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a330">gspdeskShouldBeForeground</a>);
00360         } <span class="keywordflow">else</span> {
00361             pstrName = <a class="code" href="../../d4/d1/userk_8h.html#a522">POBJECT_NAME</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>);
00362         }
00363 
00364         <span class="keywordflow">if</span> (pstrName &amp;&amp; (!_wcsicmp(TEXT(<span class="stringliteral">"Winlogon"</span>), pstrName-&gt;Buffer) ||
00365                 !_wcsicmp(TEXT(<span class="stringliteral">"Disconnect"</span>), pstrName-&gt;Buffer) ||
00366                 !_wcsicmp(TEXT(<span class="stringliteral">"Screen-saver"</span>), pstrName-&gt;Buffer))) {
00367             RIPERR0(ERROR_ACCESS_DENIED, RIP_VERBOSE, <span class="stringliteral">""</span>);
00368             <span class="keywordflow">return</span> HEC_WRONGDESKTOP;
00369         }
00370         <span class="keywordflow">if</span> (dwCmd == HardErrorInDefDesktop) {
00371             <span class="comment">/*</span>
00372 <span class="comment">             * Clear any pending quits.</span>
00373 <span class="comment">             */</span>
00374             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o16">cQuit</a> = 0;
00375             <span class="keywordflow">return</span> HEC_SUCCESS;
00376         }
00377 
00378 
00379         <span class="comment">/*</span>
00380 <span class="comment">         * Fall through.</span>
00381 <span class="comment">         */</span>
00382 
00383     <span class="keywordflow">case</span> HardErrorAttach:
00384 
00385         <span class="comment">/*</span>
00386 <span class="comment">         * Save a pointer to and prevent destruction of the</span>
00387 <span class="comment">         * current queue.  This will give us a queue to return</span>
00388 <span class="comment">         * to if journalling is occuring when we tear down the</span>
00389 <span class="comment">         * hard error popup.</span>
00390 <span class="comment">         */</span>
00391         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
00392         (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>)++;
00393 
00394         <span class="comment">/*</span>
00395 <span class="comment">         * Fall through.</span>
00396 <span class="comment">         */</span>
00397 
00398     <span class="keywordflow">case</span> HardErrorAttachNoQueue:
00399 
00400         <span class="comment">/*</span>
00401 <span class="comment">         * Check for exit conditions. We do not allow attaches to the</span>
00402 <span class="comment">         * disconnect desktop.</span>
00403 <span class="comment">         */</span>
00404         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00405             <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00406 
00407                  ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>) &amp;&amp;
00408                   (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a330">gspdeskShouldBeForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) ||
00409 
00410                  ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>) &amp;&amp;
00411                   (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a330">gspdeskShouldBeForeground</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>))) {
00412                 <span class="keywordflow">return</span> HEC_ERROR;
00413             }
00414         }
00415 
00416         <span class="comment">/*</span>
00417 <span class="comment">         * Attach the handler to the current desktop.</span>
00418 <span class="comment">         */</span>
00419         <span class="comment">/*</span>
00420 <span class="comment">         * Don't allow an attach to the disconnected desktop, but</span>
00421 <span class="comment">         * remember this for later when we detach.</span>
00422 <span class="comment">         */</span>
00423         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a345">gbDisconnectHardErrorAttach</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00424 
00425         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>() &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>) {
00426             pdesk = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a330">gspdeskShouldBeForeground</a>;
00427             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a345">gbDisconnectHardErrorAttach</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00428         } <span class="keywordflow">else</span> {
00429             pdesk = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>;
00430         }
00431 
00432         UserAssert(pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00433 
00434         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1829">xxxSetCsrssThreadDesktop</a>(pdesk, pdrdRestore);
00435 
00436         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00437             RIPMSG1(RIP_WARNING, <span class="stringliteral">"HardErrorControl: HardErrorAttachNoQueue failed:%#lx"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00438             <span class="keywordflow">if</span> (dwCmd != HardErrorAttachNoQueue) {
00439                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00440                 UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>);
00441                 (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>)--;
00442             }
00443             <span class="keywordflow">return</span> HEC_ERROR;
00444         }
00445 
00446         <span class="comment">/*</span>
00447 <span class="comment">         * Make sure we actually set the pdesk in the current thread</span>
00448 <span class="comment">         */</span>
00449         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00450 
00451         <span class="comment">/*</span>
00452 <span class="comment">         * Determine if this box can come to the foreground.</span>
00453 <span class="comment">         * Let it come to the foreground if it doesn't have a pti</span>
00454 <span class="comment">         * (it might have just failed to load).</span>
00455 <span class="comment">         */</span>
00456         fAllowForeground = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00457         <span class="keywordflow">if</span> (handle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00458             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(handle,
00459                                                 THREAD_QUERY_INFORMATION,
00460                                                 *<a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
00461                                                 <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
00462                                                 &amp;Thread,
00463                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00464             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00465                 ptiClient = <a class="code" href="../../d4/d1/userk_8h.html#a17">PtiFromThread</a>(Thread);
00466                 <span class="keywordflow">if</span> ((ptiClient == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || <a class="code" href="../../d4/d1/userk_8h.html#a1663">CanForceForeground</a>(ptiClient-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>)) {
00467                     fAllowForeground = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00468                 }
00469 
00470                 <a class="code" href="../../d4/d1/userk_8h.html#a518">UnlockThread</a>(Thread);
00471 
00472             } <span class="keywordflow">else</span> {
00473                 RIPMSG2(RIP_WARNING, <span class="stringliteral">"HardErrorControl: HardErrorAttach failed to get thread (%#lx) pointer:%#lx"</span>, handle, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00474             }
00475         }
00476 
00477         <span class="keywordflow">if</span> (fAllowForeground) {
00478             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
00479             TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxHardErrorControl set TIF %#lx"</span>, ptiCurrent);
00480         } <span class="keywordflow">else</span> {
00481             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
00482             TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxHardErrorControl clear TIF %#lx"</span>, ptiCurrent);
00483         }
00484 
00485         <span class="keywordflow">break</span>;
00486 
00487     <span class="keywordflow">case</span> HardErrorDetach:
00488 
00489         <span class="comment">/*</span>
00490 <span class="comment">         * xxxSwitchDesktop may have sent WM_QUIT to the msgbox, so</span>
00491 <span class="comment">         * ensure that the quit flag is reset.</span>
00492 <span class="comment">         */</span>
00493         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o16">cQuit</a> = 0;
00494 
00495         <span class="comment">/*</span>
00496 <span class="comment">         * We will reset the hard-error queue to the pre-allocated</span>
00497 <span class="comment">         * one so if we end up looping back (i.e. from a desktop</span>
00498 <span class="comment">         * switch), we will have a valid queue in case the desktop</span>
00499 <span class="comment">         * was deleted.</span>
00500 <span class="comment">         */</span>
00501         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>);
00502         (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>)--;
00503 
00504         <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
00505 
00506         <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00507 
00508         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a>) {
00509             UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> == 0);
00510             <a class="code" href="../../d4/d1/userk_8h.html#a1204">AllocQueue</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a>);
00511             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>++;
00512             <a class="code" href="../../d4/d1/userk_8h.html#a1213">zzzAttachToQueue</a>(ptiCurrent, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00513         }
00514 
00515         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00516 
00517         <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
00518 
00519         <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
00520 
00521         <span class="comment">/*</span>
00522 <span class="comment">         * Fall through.</span>
00523 <span class="comment">         */</span>
00524 
00525     <span class="keywordflow">case</span> HardErrorDetachNoQueue:
00526         <span class="comment">/*</span>
00527 <span class="comment">         * Detach the handler from the desktop and return</span>
00528 <span class="comment">         * status to indicate if a switch has occured.</span>
00529 <span class="comment">         */</span>
00530         pdesk = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;
00531         <a class="code" href="../../d4/d1/userk_8h.html#a1830">xxxRestoreCsrssThreadDesktop</a>(pdrdRestore);
00532 
00533         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00534             <span class="comment">/*</span>
00535 <span class="comment">             * The hard error message box gets a desktop switch notification,</span>
00536 <span class="comment">             * so remember that we lied to him and lie (or unlie) to him again.</span>
00537 <span class="comment">             * A desktop switch did occur.</span>
00538 <span class="comment">             */</span>
00539             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a345">gbDisconnectHardErrorAttach</a>) {
00540                <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a345">gbDisconnectHardErrorAttach</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00541                <span class="keywordflow">return</span> HEC_DESKTOPSWITCH;
00542             }
00543 <span class="preprocessor">#ifdef WAY_LATER</span>
00544 <span class="preprocessor"></span>            <span class="comment">/*</span>
00545 <span class="comment">             * This happened once and caused a trap when a KeyEvent() came in and we</span>
00546 <span class="comment">             * directed it to this queue.  I think this is a MS window that we caught</span>
00547 <span class="comment">             * since we use this so much for license popup's.</span>
00548 <span class="comment">             */</span>
00549             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) {
00550                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00551             }
00552 <span class="preprocessor">#endif</span>
00553 <span class="preprocessor"></span>        }
00554 
00555         <span class="keywordflow">return</span> (pdesk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> ? HEC_DESKTOPSWITCH : HEC_SUCCESS);
00556     }
00557     <span class="keywordflow">return</span> HEC_SUCCESS;
00558 }
00559 
00560 <span class="preprocessor">#if 0 // not used anywhere (IanJa)</span>
00561 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
00562 <span class="comment">* VersionFromWindowFlag</span>
00563 <span class="comment">*</span>
00564 <span class="comment">* Returns the version of a window from its window state flags.</span>
00565 <span class="comment">*</span>
00566 <span class="comment">* History:</span>
00567 <span class="comment">* 04-Apr-1997 adams     Created.</span>
00568 <span class="comment">\***************************************************************************/</span>
00569 
00570 WORD
00571 <a class="code" href="../../d1/d0/inc_2user_8h.html#a1139">VersionFromWindowFlag</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00572 {
00573     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>    bFlags = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFWINCOMPATMASK);
00574     <span class="keywordflow">if</span> (bFlags == <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(WFWIN50COMPAT | WFWIN40COMPAT | WFWIN31COMPAT)) {
00575         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a100">VER50</a>;
00576     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bFlags == <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(WFWIN40COMPAT | WFWIN31COMPAT)) {
00577         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>;
00578     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bFlags == <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(WFWIN31COMPAT)) {
00579         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a102">VER31</a>;
00580     } <span class="keywordflow">else</span> {
00581         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a103">VER30</a>;
00582     }
00583 }
00584 <span class="preprocessor">#endif // not used anywhere (IanJa)</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
