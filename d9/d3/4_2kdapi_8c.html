<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: 4/kdapi.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdapi.c File Reference</h1><code>#include "<a class="el" href="../../d2/d6/4_2kdp_8h-source.html">kdp.h</a>"</code><br>

<p>
<a href="../../d0/d3/4_2kdapi_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a0">SHIFT10000</a>&nbsp;&nbsp;&nbsp;13</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a1">Convert100nsToMilliseconds</a>(LARGE_INTEGER)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>LARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a5">KdpQueryPerformanceCounter</a> (IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a6">KdpProcessInternalBreakpoint</a> (ULONG BreakpointNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a7">KdpGetVersion</a> (IN PDBGKD_MANIPULATE_STATE64 m)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a8">KdpNotSupported</a> (IN PDBGKD_MANIPULATE_STATE64 m)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a9">KdpCauseBugCheck</a> (IN PDBGKD_MANIPULATE_STATE64 m)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a10">KdpWriteBreakPointEx</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a11">KdpRestoreBreakPointEx</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a12">KdpSearchMemory</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a13">KdpSearchHammingDistance</a> (ULONG_PTR Left, ULONG_PTR Right)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a14">KdpSearchPhysicalPage</a> (IN PFN_NUMBER PageFrameIndex, ULONG_PTR RangeStart, ULONG_PTR RangeEnd, ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a15">KdpSearchPhysicalMemoryRequested</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a16">KdpSearchPhysicalPageRange</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a> (IN PKTRAP_FRAME TrapFrame, IN PKEXCEPTION_FRAME ExceptionFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a> (IN BOOLEAN Enable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a19">KdUpdateTimeSlipEvent</a> (PVOID Event)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a20">KdpTimeSlipDpcRoutine</a> (<a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a21">KdpTimeSlipWork</a> (IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/ke_8h.html#a408">KCONTINUE_STATUS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a22">KdpSendWaitContinue</a> (IN ULONG OutPacketType, IN PSTRING OutMessageHeader, IN PSTRING OutMessageData OPTIONAL, IN OUT PCONTEXT ContextRecord)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a23">KdpReadVirtualMemory</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a24">KdpWriteVirtualMemory</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a25">KdpGetContext</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a26">KdpSetContext</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a27">KdpWriteBreakpoint</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a28">KdpRestoreBreakpoint</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a29">KdpSwitchProcessor</a> (IN PEXCEPTION_RECORD ExceptionRecord, IN OUT PCONTEXT ContextRecord, IN BOOLEAN SecondChance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a30">KdpReportExceptionStateChange</a> (IN PEXCEPTION_RECORD ExceptionRecord, IN OUT PCONTEXT ContextRecord, IN BOOLEAN SecondChance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a31">KdpReportLoadSymbolsStateChange</a> (IN PSTRING PathName, IN <a class="el" href="../../d6/d5/struct__KD__SYMBOLS__INFO.html">PKD_SYMBOLS_INFO</a> SymbolInfo, IN BOOLEAN UnloadSymbols, IN OUT PCONTEXT ContextRecord)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a32">KdpReadPhysicalMemory</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a33">KdpWritePhysicalMemory</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a34">KdDisableDebugger</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a35">KdEnableDebugger</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a36">KdpCheckLowMemory</a> (IN PDBGKD_MANIPULATE_STATE64 Message)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>LARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a2">Magic10000</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a3">KdDisableCount</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/4_2kdapi_8c.html#a4">KdPreviouslyEnabled</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="4/kdapi.c::Convert100nsToMilliseconds" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Convert100nsToMilliseconds          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LARGE_INTEGER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                         \
    RtlExtendedMagicDivide( (LARGE_INTEGER), Magic10000, SHIFT10000 )       \
    )
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00044">44</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="4/kdapi.c::SHIFT10000" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SHIFT10000&nbsp;&nbsp;&nbsp;13          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00043">43</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a34" doxytag="4/kdapi.c::KdDisableDebugger" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdDisableDebugger           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03330">3330</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00134">KdDebuggerEnabled</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00243">KdDisableCount</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00066">KdPitchDebugger</a>, <a class="el" href="../../d7/d5/kdlock_8c-source.html#l00026">KdpPortLock()</a>, <a class="el" href="../../d7/d5/kdlock_8c-source.html#l00060">KdpPortUnlock()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00244">KdPreviouslyEnabled</a>, <a class="el" href="../../d8/d7/alpha_2kdtrap_8c-source.html#l00386">KdpStub()</a>, <a class="el" href="../../d1/d3/kdbreak_8c-source.html#l00972">KdpSuspendAllBreakpoints()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, and <a class="el" href="../../d1/d6/kdp_8h-source.html#l00437">KiDebugRoutine</a>.
<p>
<pre class="fragment"><div>03335                    :
03336 
03337     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to disable <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debugger.
03338 
03339 Arguments:
03340 
03341     None.
03342 
03343 Return Value:
03344 
03345     None.
03346 
03347 --*/
03348 
03349 {
03350     KIRQL oldIrql ;
03351 
03352     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(DISPATCH_LEVEL, &amp;oldIrql) ;
03353     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a145">KdpPortLock</a>();
03354 
03355     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d3/kdapi_8c.html#a3">KdDisableCount</a>) {
03356 
03357         <a class="code" href="../../d8/d3/kdapi_8c.html#a4">KdPreviouslyEnabled</a> = <a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> &amp;&amp; (!<a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a>) ;
03358         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a>) {
03359 
03360             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a139">KdpSuspendAllBreakpoints</a>() ;
03361             <a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> = <a class="code" href="../../d7/d8/alpha_2kdtrap_8c.html#a2">KdpStub</a>;
03362             <a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
03363         }
03364     }
03365     <a class="code" href="../../d8/d3/kdapi_8c.html#a3">KdDisableCount</a>++ ;
03366     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a146">KdpPortUnlock</a>();
03367     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(oldIrql);
03368 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="4/kdapi.c::KdEnableDebugger" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdEnableDebugger           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03371">3371</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00243">KdDisableCount</a>, <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00072">KdInitSystem()</a>, <a class="el" href="../../d7/d5/kdlock_8c-source.html#l00026">KdpPortLock()</a>, <a class="el" href="../../d7/d5/kdlock_8c-source.html#l00060">KdpPortUnlock()</a>, <a class="el" href="../../d1/d3/kdbreak_8c-source.html#l01309">KdpRestoreAllBreakpoints()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00244">KdPreviouslyEnabled</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d1/po_8h-source.html#l00464">PoHiberInProgress</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>03376                    :
03377 
03378     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to reenable <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debugger after a call to
03379     <a class="code" href="../../d7/d3/kd_8h.html#a28">KdDisableDebugger</a>.
03380 
03381 Arguments:
03382 
03383     None.
03384 
03385 Return Value:
03386 
03387     None.
03388 
03389 --*/
03390 {
03391     KIRQL oldIrql ;
03392 
03393     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(DISPATCH_LEVEL, &amp;oldIrql) ;
03394     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a145">KdpPortLock</a>();
03395 
03396     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KdDisableCount &gt; 0) ;
03397     <a class="code" href="../../d8/d3/kdapi_8c.html#a3">KdDisableCount</a>-- ;
03398 
03399     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d3/kdapi_8c.html#a3">KdDisableCount</a>) {
03400         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/kdapi_8c.html#a4">KdPreviouslyEnabled</a>) {
03401 
03402             <span class="comment">//</span>
03403             <span class="comment">// Ugly HACKHACK - Make sure the timers aren't reset.</span>
03404             <span class="comment">//</span>
03405             <a class="code" href="../../d1/d2/po_8h.html#a55">PoHiberInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
03406             <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a4">KdInitSystem</a>(NULL, FALSE) ;
03407             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a140">KdpRestoreAllBreakpoints</a>();
03408             <a class="code" href="../../d1/d2/po_8h.html#a55">PoHiberInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
03409         }
03410     }
03411     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a146">KdpPortUnlock</a>();
03412     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(oldIrql);
03413 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="4/kdapi.c::KdEnterDebugger" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdEnterDebugger           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00277">277</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d1/d6/kdp_8h-source.html#l00573">DPRINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00040">FREEZE_BACKUP</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00041">FREEZE_SKIPPED_PROCESSOR</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00301">KdEnteredDebugger</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00056">KdpDebuggerLock</a>, <a class="el" href="../../d2/d7/hal_8h.html#a204">KdPortSave()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00222">KdpPortLocked</a>, <a class="el" href="../../d3/d3/alpha_2kdcmsup_8c-source.html#l00024">KdpQueryPerformanceCounter()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00209">KdTimerDifference</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00207">KdTimerStart</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00208">KdTimerStop</a>, <a class="el" href="../../d0/d4/ke_2debug_8c-source.html#l00055">KeFreezeExecution()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00389">KiFreezeFlag</a>, <a class="el" href="../../d0/d0/ki_8h.html#a155">KiTryToAcquireSpinLock()</a>, <a class="el" href="../../d7/d5/ttime_8c-source.html#l00046">TimeFields</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/alpha_2kdtrap_8c-source.html#l00028">KdpTrap()</a>, and <a class="el" href="../../d1/d3/kdbreak_8c-source.html#l00316">KdSetOwedBreakpoints()</a>.
<p>
<pre class="fragment"><div>00284                    :
00285 
00286     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to enter <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel debugger. Its purpose
00287     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to freeze all other processors and aqcuire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel debugger
00288     comm port.
00289 
00290 Arguments:
00291 
00292     TrapFrame - Supplies a pointer to a trap frame that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00293         trap.
00294 
00295     ExceptionFrame - Supplies a pointer to an exception frame that
00296         describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap.
00297 
00298 Return Value:
00299 
00300     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous interrupt enable.
00301 
00302 --*/
00303 
00304 {
00305 
00306     BOOLEAN Enable;
00307     TIME_FIELDS <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>;
00308 <span class="preprocessor">#if DBG</span>
00309 <span class="preprocessor"></span>    <span class="keyword">extern</span> ULONG <a class="code" href="../../d5/d9/kernldat_8c.html#a43">KiFreezeFlag</a>;
00310 <span class="preprocessor">#endif</span>
00311 <span class="preprocessor"></span>
00312     <span class="comment">//</span>
00313     <span class="comment">// HACKHACK - do some crude timer support</span>
00314     <span class="comment">//            but not if called from KdSetOwedBreakpoints()</span>
00315     <span class="comment">//</span>
00316 
00317     <span class="keywordflow">if</span> (TrapFrame) {
00318         <a class="code" href="../../d8/d5/kddata_8c.html#a57">KdTimerStop</a> = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a5">KdpQueryPerformanceCounter</a> (TrapFrame);
00319         <a class="code" href="../../d8/d5/kddata_8c.html#a58">KdTimerDifference</a>.QuadPart = <a class="code" href="../../d8/d5/kddata_8c.html#a57">KdTimerStop</a>.QuadPart - <a class="code" href="../../d8/d5/kddata_8c.html#a56">KdTimerStart</a>.QuadPart;
00320     } <span class="keywordflow">else</span> {
00321         <a class="code" href="../../d8/d5/kddata_8c.html#a57">KdTimerStop</a>.QuadPart = 0;
00322     }
00323 
00324     <span class="comment">//</span>
00325     <span class="comment">// Freeze all other processors, raise IRQL to HIGH_LEVEL, and save debug</span>
00326     <span class="comment">// port state.  We lock the port so that KdPollBreakin and a debugger</span>
00327     <span class="comment">// operation don't interfere with each other.</span>
00328     <span class="comment">//</span>
00329 
00330     Enable = <a class="code" href="../../d9/d4/ke_2debug_8c.html#a9">KeFreezeExecution</a>(TrapFrame, ExceptionFrame);
00331     <a class="code" href="../../d8/d5/kddata_8c.html#a68">KdpPortLocked</a> = <a class="code" href="../../d0/d0/ki_8h.html#a155">KiTryToAcquireSpinLock</a>(&amp;KdpDebuggerLock);
00332     <a class="code" href="../../d2/d7/hal_8h.html#a204">KdPortSave</a>();
00333     <a class="code" href="../../d8/d5/kddata_8c.html#a109">KdEnteredDebugger</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00334 
00335 <span class="preprocessor">#if DBG</span>
00336 <span class="preprocessor"></span>
00337     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d9/kernldat_8c.html#a43">KiFreezeFlag</a> &amp; <a class="code" href="../../d7/d3/kd_8h.html#a3">FREEZE_BACKUP</a>) != 0) {
00338         <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"FreezeLock was jammed!  Backup SpinLock was used!\n"</span>));
00339     }
00340 
00341     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d9/kernldat_8c.html#a43">KiFreezeFlag</a> &amp; <a class="code" href="../../d7/d3/kd_8h.html#a4">FREEZE_SKIPPED_PROCESSOR</a>) != 0) {
00342         <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"Some processors not frozen in debugger!\n"</span>));
00343     }
00344 
00345     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a68">KdpPortLocked</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00346         <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"Port lock was not acquired!\n"</span>));
00347     }
00348 
00349 <span class="preprocessor">#endif</span>
00350 <span class="preprocessor"></span>
00351     <span class="keywordflow">return</span> Enable;
00352 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="4/kdapi.c::KdExitDebugger" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdExitDebugger           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Enable</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00355">355</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d2/d7/hal_8h.html#a203">KdPortRestore()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00222">KdpPortLocked</a>, <a class="el" href="../../d7/d5/kdlock_8c-source.html#l00060">KdpPortUnlock()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00290">KdpTimeSlipDpc</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00293">KdpTimeSlipPending</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00207">KdTimerStart</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00208">KdTimerStop</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00089">KeInsertQueueDpc()</a>, <a class="el" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter()</a>, <a class="el" href="../../d0/d4/ke_2debug_8c-source.html#l00391">KeThawExecution()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d1/po_8h-source.html#l00464">PoHiberInProgress</a>, and <a class="el" href="../../d7/d5/ttime_8c-source.html#l00046">TimeFields</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/alpha_2kdtrap_8c-source.html#l00028">KdpTrap()</a>, and <a class="el" href="../../d1/d3/kdbreak_8c-source.html#l00316">KdSetOwedBreakpoints()</a>.
<p>
<pre class="fragment"><div>00361                    :
00362 
00363     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel debugger. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reverse
00364     of <a class="code" href="../../d7/d3/kd_8h.html#a17">KdEnterDebugger</a>.
00365 
00366 Arguments:
00367 
00368     Enable - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous interrupt enable which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be restored.
00369 
00370 Return Value:
00371 
00372     None.
00373 
00374 --*/
00375 
00376 {
00377     ULONG ElapsedTime;
00378     ULARGE_INTEGER TimeDifference;
00379     TIME_FIELDS <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>;
00380     ULONG Pending;
00381 
00382     <span class="comment">//</span>
00383     <span class="comment">// restore stuff and exit</span>
00384     <span class="comment">//</span>
00385 
00386     <a class="code" href="../../d2/d7/hal_8h.html#a203">KdPortRestore</a>();
00387     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a68">KdpPortLocked</a>) {
00388         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a146">KdpPortUnlock</a>();
00389     }
00390 
00391     <a class="code" href="../../d9/d4/ke_2debug_8c.html#a12">KeThawExecution</a>(Enable);
00392 
00393     <span class="comment">//</span>
00394     <span class="comment">// Do some crude timer support.  If KdEnterDebugger didn't</span>
00395     <span class="comment">// Query the performance counter, then don't do it here either.</span>
00396     <span class="comment">//</span>
00397 
00398     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a57">KdTimerStop</a>.QuadPart == 0) {
00399         <a class="code" href="../../d8/d5/kddata_8c.html#a56">KdTimerStart</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a57">KdTimerStop</a>;
00400     } <span class="keywordflow">else</span> {
00401         <a class="code" href="../../d8/d5/kddata_8c.html#a56">KdTimerStart</a> = <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a>(NULL);
00402     }
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Process a time slip</span>
00406     <span class="comment">//</span>
00407 
00408     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d2/po_8h.html#a55">PoHiberInProgress</a>) {
00409 
00410         Pending = InterlockedIncrement(&amp;KdpTimeSlipPending);
00411 
00412         <span class="comment">//</span>
00413         <span class="comment">// If there's wasn't a time slip pending, queue the DPC to handle it</span>
00414         <span class="comment">//</span>
00415 
00416         <span class="keywordflow">if</span> (Pending == 1) {
00417             InterlockedIncrement(&amp;KdpTimeSlipPending);
00418             <a class="code" href="../../d4/d1/dpcobj_8c.html#a2">KeInsertQueueDpc</a>(&amp;KdpTimeSlipDpc, NULL, NULL);
00419         }
00420     }
00421 
00422     <span class="keywordflow">return</span>;
00423 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="4/kdapi.c::KdpCauseBugCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpCauseBugCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>m</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03097">3097</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>03103                    :
03104 
03105     This routine causes a bugcheck.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> testing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debugger.
03106 
03107 Arguments:
03108 
03109     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
03110 
03111 Return Value:
03112 
03113     None.
03114 
03115 --*/
03116 
03117 {
03118 
03119     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( MANUALLY_INITIATED_CRASH, 0, 0, 0, 0 );
03120 
03121 } <span class="comment">// KdCauseBugCheck</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="4/kdapi.c::KdpCheckLowMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpCheckLowMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Message</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03633">3633</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03869">KdpSearchPhysicalMemoryRequested()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03909">KdpSearchPhysicalPageRange()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00141">MiNoLowMemory</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00043">MmLowestPhysicalPage</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00821">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>03639                    :
03640 
03641 
03642 Arguments:
03643 
03644     Message - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
03645 
03646 Return Value:
03647 
03648     None.
03649     
03650 <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>:
03651 
03652     This function gets called when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> !chklowmem
03653     debugger <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.    
03654 
03655 --*/
03656 
03657 {
03658 <span class="comment">//+silviuc: move to a header</span>
03659 <span class="preprocessor">#if defined (_X86PAE_)</span>
03660 <span class="preprocessor"></span>    LOGICAL
03661         MiCheckPhysicalPagePattern (
03662         PFN_NUMBER Page,
03663         PULONG CorruptionOffset
03664         );
03665 
03666     <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>;
03667     <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>;
03668     <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a>;
03669 <span class="preprocessor">#endif // #if defined (_X86PAE_)</span>
03670 <span class="preprocessor"></span><span class="comment">//-silviuc</span>
03671 
03672     STRING MessageHeader;
03673     PFN_NUMBER Page;
03674     PHYSICAL_ADDRESS P;
03675     PVOID64 VirtualAddress;
03676     ULONG CorruptionOffset;
03677 
03678     Message-&gt;ReturnStatus = STATUS_SUCCESS;
03679     MessageHeader.Length = <span class="keyword">sizeof</span>(*Message);
03680     MessageHeader.Buffer = (PCHAR)Message;
03681     
03682     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/4_2kdapi_8c.html#a15">KdpSearchPhysicalMemoryRequested</a>()) {
03683       
03684         <span class="comment">//</span>
03685         <span class="comment">// This is a !search kd extension call.</span>
03686         <span class="comment">//</span>
03687 
03688         <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a16">KdpSearchPhysicalPageRange</a>();
03689     }
03690     <span class="keywordflow">else</span> {
03691 
03692         <span class="comment">//</span>
03693         <span class="comment">// Check PAE low physical memory</span>
03694         <span class="comment">//</span>
03695 
03696 <span class="preprocessor">#if defined (_X86PAE_)</span>
03697 <span class="preprocessor"></span>
03698         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a>) {
03699 
03700             <span class="keywordflow">for</span> (Page = <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>;
03701                 Page &lt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> &amp;&amp; Page &lt; 1024 * 1024;
03702                 Page += 1) {
03703 
03704 
03705                 <span class="keywordflow">if</span> (! MiCheckPhysicalPagePattern (Page, &amp;CorruptionOffset)) {
03706                     Message-&gt;ReturnStatus = Page;
03707                     <span class="keywordflow">break</span>;
03708                 }
03709             }
03710         }
03711 
03712 <span class="preprocessor">#endif // #if defined (_X86PAE_)</span>
03713 <span class="preprocessor"></span>    }
03714 
03715     <span class="comment">//</span>
03716     <span class="comment">// Acknowledge the packet received.</span>
03717     <span class="comment">//</span>
03718 
03719     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a> (
03720         PACKET_TYPE_KD_STATE_MANIPULATE,
03721         &amp;MessageHeader,
03722         NULL
03723         );
03724 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="4/kdapi.c::KdpGetContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpGetContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01569">1569</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d5/kdmove_8c-source.html#l00150">KdpQuickMoveMemory()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02782">KiProcessorBlock</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>01577                    :
01578 
01579     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response of a get context state
01580     manipulation message.  Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
01581     context.
01582 
01583 Arguments:
01584 
01585     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
01586 
01587     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
01588 
01589     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
01590 
01591 Return Value:
01592 
01593     None.
01594 
01595 --*/
01596 
01597 {
01598     PDBGKD_GET_CONTEXT a = &amp;m-&gt;u.GetContext;
01599     STRING MessageHeader;
01600 
01601     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
01602     MessageHeader.Buffer = (PCHAR)m;
01603 
01604     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
01605 
01606     <span class="keywordflow">if</span> (m-&gt;Processor &gt;= (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>) {
01607         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
01608     } <span class="keywordflow">else</span> {
01609         m-&gt;ReturnStatus = STATUS_SUCCESS;
01610         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>(CONTEXT);
01611         <span class="keywordflow">if</span> (m-&gt;Processor == (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number) {
01612             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a111">KdpQuickMoveMemory</a>(AdditionalData-&gt;Buffer, (PCHAR)Context, <span class="keyword">sizeof</span>(CONTEXT));
01613         } <span class="keywordflow">else</span> {
01614             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a111">KdpQuickMoveMemory</a>(AdditionalData-&gt;Buffer,
01615                           (PCHAR)&amp;KiProcessorBlock[m-&gt;Processor]-&gt;ProcessorState.ContextFrame,
01616                           <span class="keyword">sizeof</span>(CONTEXT)
01617                          );
01618         }
01619     }
01620 
01621     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
01622                   PACKET_TYPE_KD_STATE_MANIPULATE,
01623                   &amp;MessageHeader,
01624                   AdditionalData
01625                   );
01626 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="4/kdapi.c::KdpGetVersion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpGetVersion           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>m</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l02945">2945</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d9/d4/kddata_8c-source.html#l00280">KdpDebuggerDataListHead</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00266">KdpNtosImageBase</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, <a class="el" href="../../d6/d4/triage_8c-source.html#l00042">NtBuildNumber</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00580">PsNtosImageBase</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>02951                    :
02952 
02953     This function returns to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller a general information packet
02954     that contains useful information to a debugger.  This packet <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also
02955     used <span class="keywordflow">for</span> a debugger to determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> writebreakpointex and
02956     readbreakpointex apis are available.
02957 
02958 Arguments:
02959 
02960     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
02961 
02962 Return Value:
02963 
02964     None.
02965 
02966 --*/
02967 
02968 {
02969     STRING                   messageHeader;
02970 
02971 
02972     messageHeader.Length = <span class="keyword">sizeof</span>(*m);
02973     messageHeader.Buffer = (PCHAR)m;
02974 
02975     RtlZeroMemory(&amp;m-&gt;u.GetVersion64, <span class="keyword">sizeof</span>(m-&gt;u.GetVersion64));
02976     <span class="comment">//</span>
02977     <span class="comment">// the current build number</span>
02978     <span class="comment">//</span>
02979     m-&gt;u.GetVersion64.MinorVersion = (<span class="keywordtype">short</span>)<a class="code" href="../../d5/d5/triage_8c.html#a0">NtBuildNumber</a>;
02980     m-&gt;u.GetVersion64.MajorVersion = (<span class="keywordtype">short</span>)((<a class="code" href="../../d5/d5/triage_8c.html#a0">NtBuildNumber</a> &gt;&gt; 28) &amp; 0xFFFFFFF);
02981 
02982     <span class="comment">//</span>
02983     <span class="comment">// kd protocol version number.  this should be incremented if the</span>
02984     <span class="comment">// protocol changes.</span>
02985     <span class="comment">//</span>
02986     m-&gt;u.GetVersion64.ProtocolVersion = 5;
02987     m-&gt;u.GetVersion64.Flags = DBGKD_VERS_FLAG_DATA;
02988 
02989 <span class="preprocessor">#if !defined(NT_UP)</span>
02990 <span class="preprocessor"></span>    m-&gt;u.GetVersion64.Flags |= DBGKD_VERS_FLAG_MP;
02991 <span class="preprocessor">#endif</span>
02992 <span class="preprocessor"></span>
02993 <span class="preprocessor">#if defined(_M_IX86)</span>
02994 <span class="preprocessor"></span>    m-&gt;u.GetVersion64.MachineType = IMAGE_FILE_MACHINE_I386;
02995 <span class="preprocessor">#elif defined(_M_MRX000)</span>
02996 <span class="preprocessor"></span>    m-&gt;u.GetVersion64.MachineType = IMAGE_FILE_MACHINE_R4000;
02997 <span class="preprocessor">#elif defined(_M_ALPHA)</span>
02998 <span class="preprocessor"></span>    m-&gt;u.GetVersion64.MachineType = IMAGE_FILE_MACHINE_ALPHA;
02999 <span class="preprocessor">#if defined(_AXP64_)</span>
03000 <span class="preprocessor"></span>    m-&gt;u.GetVersion64.Flags |= DBGKD_VERS_FLAG_PTR64;
03001 <span class="preprocessor">#endif</span>
03002 <span class="preprocessor"></span><span class="preprocessor">#elif defined(_M_PPC)</span>
03003 <span class="preprocessor"></span>    m-&gt;u.GetVersion64.MachineType = IMAGE_FILE_MACHINE_POWERPC;
03004 <span class="preprocessor">#elif defined(_M_IA64)</span>
03005 <span class="preprocessor"></span>    m-&gt;u.GetVersion64.MachineType = IMAGE_FILE_MACHINE_IA64;
03006     m-&gt;u.GetVersion64.Flags |= DBGKD_VERS_FLAG_PTR64;
03007 <span class="preprocessor">#else</span>
03008 <span class="preprocessor"></span><span class="preprocessor">#error( "unknown target machine" );</span>
03009 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03010 <span class="preprocessor"></span>
03011     <span class="comment">//</span>
03012     <span class="comment">// address of the loader table</span>
03013     <span class="comment">//</span>
03014     m-&gt;u.GetVersion64.PsLoadedModuleList = (ULONG64)(LONG64)(LONG_PTR)&amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>;
03015 
03016     <span class="comment">//</span>
03017     <span class="comment">// If the debugger is being initialized during boot, PsNtosImageBase</span>
03018     <span class="comment">// and PsLoadedModuleList are not yet valid.  KdInitSystem got</span>
03019     <span class="comment">// the image base from the loader block.</span>
03020     <span class="comment">// On the other hand, if the debugger was initialized by a bugcheck,</span>
03021     <span class="comment">// it didn't get a loader block to look at, but the system was</span>
03022     <span class="comment">// running so the other variables are valid.</span>
03023     <span class="comment">//</span>
03024 
03025     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a94">KdpNtosImageBase</a>) {
03026         m-&gt;u.GetVersion64.KernBase = (ULONG64)(LONG64)(LONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a94">KdpNtosImageBase</a>;
03027     } <span class="keywordflow">else</span> {
03028         m-&gt;u.GetVersion64.KernBase = (ULONG64)(LONG64)(LONG_PTR)<a class="code" href="../../d1/d9/ps_8h.html#a54">PsNtosImageBase</a>;
03029     }
03030 
03031     m-&gt;u.GetVersion64.DebuggerDataList = (ULONG64)(LONG64)(LONG_PTR)&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>;
03032 
03033     <span class="comment">//</span>
03034     <span class="comment">// the usual stuff</span>
03035     <span class="comment">//</span>
03036     m-&gt;ReturnStatus = STATUS_SUCCESS;
03037     m-&gt;ApiNumber = DbgKdGetVersionApi;
03038 
03039     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(PACKET_TYPE_KD_STATE_MANIPULATE,
03040                   &amp;messageHeader,
03041                   NULL
03042                  );
03043 
03044     <span class="keywordflow">return</span>;
03045 } <span class="comment">// KdGetVersion</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="4/kdapi.c::KdpNotSupported" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KdpNotSupported           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>m</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03049">3049</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>03055                    :
03056 
03057     This routine returns STATUS_UNSUCCESSFUL to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debugger
03058 
03059 Arguments:
03060 
03061     m - Supplies a DBGKD_MANIPULATE_STATE64 <span class="keyword">struct </span>to answer with
03062 
03063 Return Value:
03064 
03065     0, to indicate that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system should not continue
03066 
03067 --*/
03068 
03069 {
03070     STRING          MessageHeader;
03071 
03072     <span class="comment">//</span>
03073     <span class="comment">// setup packet</span>
03074     <span class="comment">//</span>
03075     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
03076     MessageHeader.Buffer = (PCHAR)m;
03077     m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
03078 
03079     <span class="comment">//</span>
03080     <span class="comment">// send back our response</span>
03081     <span class="comment">//</span>
03082     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
03083         PACKET_TYPE_KD_STATE_MANIPULATE,
03084         &amp;MessageHeader,
03085         NULL
03086         );
03087 
03088     <span class="comment">//</span>
03089     <span class="comment">// return the caller's continue status value.  if this is a non-zero</span>
03090     <span class="comment">// value the system is continued using this value as the continuestatus.</span>
03091     <span class="comment">//</span>
03092     <span class="keywordflow">return</span> 0;
03093 } <span class="comment">// KdpNotSupported</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="4/kdapi.c::KdpProcessInternalBreakpoint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpProcessInternalBreakpoint           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BreakpointNumber</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="4/kdapi.c::KdpQueryPerformanceCounter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LARGE_INTEGER KdpQueryPerformanceCounter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TrapFrame</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/alpha_2kdcmsup_8c-source.html#l00024">24</a> of file <a class="el" href="../../d3/d3/alpha_2kdcmsup_8c-source.html">alpha/kdcmsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter()</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00303">KdEnterDebugger()</a>.
<p>
<pre class="fragment"><div>00030                    :
00031 
00032     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system performance
00033     counter.
00034 
00035 Arguments:
00036 
00037     None.
00038 
00039 Return Value:
00040 
00041     The value returned by <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00042     function value.
00043 
00044 --*/
00045 
00046 {
00047 
00048     <span class="keywordflow">return</span> <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a>(0);
00049 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="4/kdapi.c::KdpReadPhysicalMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpReadPhysicalMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l02643">2643</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d9/d5/kdmove_8c-source.html#l00031">KdpMoveMemory()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, <a class="el" href="../../d3/d5/ia64_2debugsup_8c-source.html#l00236">MmDbgTranslatePhysicalAddress64()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>02651                    :
02652 
02653     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response to a read physical memory
02654     state manipulation message. Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to read physical memory
02655     and <span class="keywordflow">return</span>.
02656 
02657 Arguments:
02658 
02659     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
02660 
02661     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
02662 
02663     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
02664 
02665 Return Value:
02666 
02667     None.
02668 
02669 --*/
02670 
02671 {
02672     PDBGKD_READ_MEMORY64 a = &amp;m-&gt;u.ReadMemory;
02673     ULONG Length;
02674     STRING MessageHeader;
02675     PVOID64 VirtualAddress;
02676     PHYSICAL_ADDRESS Source;
02677     UCHAR UNALIGNED *Destination;
02678     ULONG NumberBytes;
02679     ULONG BytesLeft;
02680 
02681     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
02682     MessageHeader.Buffer = (PCHAR)m;
02683 
02684     <span class="comment">//</span>
02685     <span class="comment">// make sure that nothing but a read memory message was transmitted</span>
02686     <span class="comment">//</span>
02687 
02688     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
02689 
02690     <span class="comment">//</span>
02691     <span class="comment">// Trim transfer count to fit in a single message</span>
02692     <span class="comment">//</span>
02693 
02694     <span class="keywordflow">if</span> (a-&gt;TransferCount &gt; (PACKET_MAX_SIZE - <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64))) {
02695         Length = PACKET_MAX_SIZE - <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64);
02696     } <span class="keywordflow">else</span> {
02697         Length = a-&gt;TransferCount;
02698     }
02699 
02700     <span class="comment">//</span>
02701     <span class="comment">// Since the MmDbgTranslatePhysicalAddress64 only maps in one physical</span>
02702     <span class="comment">// page at a time (on non-alpha systems),</span>
02703     <span class="comment">// we need to break the memory move up into smaller</span>
02704     <span class="comment">// moves which don't cross page boundaries.  It is important that we</span>
02705     <span class="comment">// access physical memory on naturally-aligned boundaries and with the</span>
02706     <span class="comment">// largest size possible.  (We could be accessing memory-mapped I/O</span>
02707     <span class="comment">// space).  These rules allow kdexts to read physical memory reliably.</span>
02708     <span class="comment">//</span>
02709 
02710     Source.QuadPart = a-&gt;TargetBaseAddress;
02711     Destination = AdditionalData-&gt;Buffer;
02712     <span class="keywordflow">while</span> (Length &gt; 0) {
02713         VirtualAddress = <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a3">MmDbgTranslatePhysicalAddress64</a>(Source);
02714         <span class="keywordflow">if</span> (VirtualAddress == NULL64) {
02715             <span class="keywordflow">break</span>;
02716         }
02717         NumberBytes = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(Source.LowPart);
02718         <span class="keywordflow">if</span> (NumberBytes &gt; Length) {
02719             NumberBytes = Length;
02720         }
02721 
02722 <span class="preprocessor">#ifdef _ALPHA_</span>
02723 <span class="preprocessor"></span>        BytesLeft = NumberBytes;
02724         <span class="keywordflow">while</span> (BytesLeft &gt; 0) {
02725             __MB();
02726 
02727             <span class="keywordflow">if</span> (((ULONG64)VirtualAddress &amp; 7) == 0 &amp;&amp; BytesLeft &gt; 7) {
02728                 *((ULONGLONG UNALIGNED *)Destination)++ =
02729                     *((ULONGLONG * POINTER_64)VirtualAddress)++;
02730                 BytesLeft -= 8;
02731             } <span class="keywordflow">else</span> {
02732                 <span class="keywordflow">if</span> (((ULONG64)VirtualAddress &amp; 3) == 0 &amp;&amp; BytesLeft &gt; 3) {
02733                     *((ULONG UNALIGNED *)Destination)++ =
02734                         *((ULONG * POINTER_64)VirtualAddress)++;
02735                     BytesLeft -= 4;
02736                 } <span class="keywordflow">else</span> {
02737                     <span class="keywordflow">if</span> (((ULONG64)VirtualAddress &amp; 1) == 0 &amp;&amp; BytesLeft &gt; 1) {
02738                         *((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> UNALIGNED *)Destination)++ =
02739                             *((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> * POINTER_64)VirtualAddress)++;
02740                         BytesLeft -= 2;
02741                     } <span class="keywordflow">else</span> {
02742                         *Destination++ =
02743                             *((UCHAR * POINTER_64)VirtualAddress)++;
02744                         BytesLeft -= 1;
02745                     }
02746                 }
02747             }
02748         }
02749 <span class="preprocessor">#else</span>
02750 <span class="preprocessor"></span>        <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(Destination, VirtualAddress, NumberBytes);
02751         Destination += NumberBytes;
02752 
02753 <span class="preprocessor">#endif</span>
02754 <span class="preprocessor"></span>        Source.QuadPart += NumberBytes;
02755         Length -= NumberBytes;
02756         AdditionalData-&gt;Length += (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NumberBytes;
02757     }
02758 
02759     <span class="keywordflow">if</span> (Length == 0) {
02760         m-&gt;ReturnStatus = STATUS_SUCCESS;
02761     } <span class="keywordflow">else</span> {
02762         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
02763     }
02764 
02765     a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
02766 
02767     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
02768                   PACKET_TYPE_KD_STATE_MANIPULATE,
02769                   &amp;MessageHeader,
02770                   AdditionalData
02771                   );
02772     UNREFERENCED_PARAMETER(Context);
02773 
02774 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="4/kdapi.c::KdpReadVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpReadVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01126">1126</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d9/d5/kdmove_8c-source.html#l00031">KdpMoveMemory()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, <a class="el" href="../../d5/d5/ppc_2debugsup_8c-source.html#l00028">MmDbgReadCheck()</a>, <a class="el" href="../../d5/d5/ppc_2debugsup_8c-source.html#l00156">MmDbgReadCheck64()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>01134                    :
01135 
01136     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response to a read <span class="keyword">virtual</span> memory 32-bit
01137     state manipulation message. Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to read <span class="keyword">virtual</span> memory
01138     and <span class="keywordflow">return</span>.
01139 
01140 Arguments:
01141 
01142     m - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
01143 
01144     AdditionalData - Supplies a pointer to a descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data to read.
01145 
01146     Context - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
01147 
01148 Return Value:
01149 
01150     None.
01151 
01152 --*/
01153 
01154 {
01155     ULONG Length;
01156     STRING MessageHeader;
01157 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
01158 <span class="preprocessor"></span>    UCHAR * POINTER_64 Address;
01159     PUCHAR Destination;
01160     UCHAR * POINTER_64 Source;
01161     PUCHAR Source32;
01162 <span class="preprocessor">#endif</span>
01163 <span class="preprocessor"></span>
01164     <span class="comment">//</span>
01165     <span class="comment">// Trim the transfer count to fit in a single message.</span>
01166     <span class="comment">//</span>
01167 
01168     Length = m-&gt;u.ReadMemory.TransferCount;
01169     <span class="keywordflow">if</span> (Length &gt; (PACKET_MAX_SIZE - <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64))) {
01170         Length = PACKET_MAX_SIZE - <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64);
01171     }
01172 
01173     <span class="comment">//</span>
01174     <span class="comment">// Move the data to the destination buffer.</span>
01175     <span class="comment">//</span>
01176 
01177 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
01178 <span class="preprocessor"></span>
01179     AdditionalData-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
01180 
01181     Destination = AdditionalData-&gt;Buffer;
01182     Source = (UCHAR * POINTER_64)m-&gt;u.ReadMemory.TargetBaseAddress;
01183     Source32 = (PUCHAR)m-&gt;u.ReadMemory.TargetBaseAddress;
01184     <span class="keywordflow">while</span> (Length &gt; 0) {
01185         <span class="keywordflow">if</span> ((LONGLONG)Source != (LONGLONG)((LONG)Source)) {
01186             <span class="keywordflow">if</span> ((Address = <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a2">MmDbgReadCheck64</a>(Source)) == NULL64) {
01187                 <span class="keywordflow">break</span>;
01188             }
01189         } <span class="keywordflow">else</span> {
01190             <span class="keywordflow">if</span> ((Address = <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a0">MmDbgReadCheck</a>(Source32)) == NULL64) {
01191                 <span class="keywordflow">break</span>;
01192             }
01193         }
01194 
01195         *Destination++ = *Address;
01196         Source   += 1;
01197         Source32 += 1;
01198         Length -= 1;
01199     }
01200 
01201     <span class="comment">//</span>
01202     <span class="comment">// If all the data is read, then return a success status. Otherwise,</span>
01203     <span class="comment">// return an unsuccessful status.</span>
01204     <span class="comment">//</span>
01205 
01206     m-&gt;ReturnStatus = STATUS_SUCCESS;
01207     <span class="keywordflow">if</span> (Length != 0) {
01208         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
01209     }
01210 
01211     <span class="comment">//</span>
01212     <span class="comment">// Set the actual number of bytes read, initialize the message header,</span>
01213     <span class="comment">// and send the reply packet to the host debugger.</span>
01214     <span class="comment">//</span>
01215 
01216     m-&gt;u.ReadMemory.ActualBytesRead = AdditionalData-&gt;Length - Length;
01217 <span class="preprocessor">#else</span>
01218 <span class="preprocessor"></span>    AdditionalData-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(AdditionalData-&gt;Buffer,
01219                                                    (PVOID)m-&gt;u.ReadMemory.TargetBaseAddress,
01220                                                    Length);
01221 
01222     <span class="comment">//</span>
01223     <span class="comment">// If all the data is read, then return a success status. Otherwise,</span>
01224     <span class="comment">// return an unsuccessful status.</span>
01225     <span class="comment">//</span>
01226 
01227     m-&gt;ReturnStatus = STATUS_SUCCESS;
01228     <span class="keywordflow">if</span> (Length != AdditionalData-&gt;Length) {
01229         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
01230     }
01231 
01232     <span class="comment">//</span>
01233     <span class="comment">// Set the actual number of bytes read, initialize the message header,</span>
01234     <span class="comment">// and send the reply packet to the host debugger.</span>
01235     <span class="comment">//</span>
01236 
01237     m-&gt;u.ReadMemory.ActualBytesRead = AdditionalData-&gt;Length;
01238 <span class="preprocessor">#endif</span>
01239 <span class="preprocessor"></span>
01240     MessageHeader.Length = <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64);
01241     MessageHeader.Buffer = (PCHAR)m;
01242     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(PACKET_TYPE_KD_STATE_MANIPULATE,
01243                   &amp;MessageHeader,
01244                   AdditionalData);
01245 
01246     <span class="keywordflow">return</span>;
01247 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="4/kdapi.c::KdpReportExceptionStateChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdpReportExceptionStateChange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SecondChance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l02459">2459</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d4/d9/ke_8h.html#a408a228">ContinueProcessorReselected</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00353">KCONTINUE_STATUS</a>, <a class="el" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a3">KdpCheckTracePoint()</a>, <a class="el" href="../../d1/d7/4_2kdp_8h.html#a122">KdpSendWaitContinue()</a>, <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00098">KdpSetStateChange()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02318">KdpSwitchProcessor()</a>, and <a class="el" href="../../d8/d7/alpha_2kdtrap_8c-source.html#l00028">KdpTrap()</a>.
<p>
<pre class="fragment"><div>02467                    :
02468 
02469     This routine sends an exception state change packet to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel
02470     debugger and waits <span class="keywordflow">for</span> a manipulate state message.
02471 
02472 Arguments:
02473 
02474     ExceptionRecord - Supplies a pointer to an exception record.
02475 
02476     ContextRecord - Supplies a pointer to a context record.
02477 
02478     SecondChance - Supplies a <span class="keywordtype">boolean</span> value that determines whether <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02479         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first or second chance <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
02480 
02481 Return Value:
02482 
02483     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> handled. Otherwise, a
02484     value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02485 
02486 --*/
02487 
02488 {
02489     STRING MessageData;
02490     STRING MessageHeader;
02491     DBGKD_WAIT_STATE_CHANGE64 WaitStateChange;
02492     <a class="code" href="../../d4/d9/ke_8h.html#a408">KCONTINUE_STATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02493 
02494 <span class="preprocessor">#if i386</span>
02495 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a3">KdpCheckTracePoint</a>(ExceptionRecord,ContextRecord)) <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02496 <span class="preprocessor">#endif</span>
02497 <span class="preprocessor"></span>
02498     <span class="keywordflow">do</span> {
02499 
02500         <span class="comment">//</span>
02501         <span class="comment">// Construct the wait state change message and message descriptor.</span>
02502         <span class="comment">//</span>
02503 
02504         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a114">KdpSetStateChange</a>(&amp;WaitStateChange,
02505                             ExceptionRecord,
02506                             ContextRecord,
02507                             SecondChance
02508                             );
02509 
02510         MessageHeader.Length = <span class="keyword">sizeof</span>(DBGKD_WAIT_STATE_CHANGE64);
02511         MessageHeader.Buffer = (PCHAR)&amp;WaitStateChange;
02512 
02513 <span class="preprocessor">#if i386</span>
02514 <span class="preprocessor"></span>        <span class="comment">//</span>
02515         <span class="comment">// Construct the wait state change data and data descriptor.</span>
02516         <span class="comment">//</span>
02517 
02518         DumpTraceData(&amp;MessageData);
02519 <span class="preprocessor">#else</span>
02520 <span class="preprocessor"></span>        MessageData.Length = 0;
02521 <span class="preprocessor">#endif</span>
02522 <span class="preprocessor"></span>
02523         <span class="comment">//</span>
02524         <span class="comment">// Send packet to the kernel debugger on the host machine,</span>
02525         <span class="comment">// wait for answer.</span>
02526         <span class="comment">//</span>
02527 
02528         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a122">KdpSendWaitContinue</a>(
02529                     PACKET_TYPE_KD_STATE_CHANGE64,
02530                     &amp;MessageHeader,
02531                     &amp;MessageData,
02532                     ContextRecord
02533                     );
02534 
02535     } <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d4/d9/ke_8h.html#a408a228">ContinueProcessorReselected</a>) ;
02536 
02537     <span class="keywordflow">return</span> (BOOLEAN) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02538 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="4/kdapi.c::KdpReportLoadSymbolsStateChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdpReportLoadSymbolsStateChange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>PathName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d5/struct__KD__SYMBOLS__INFO.html">PKD_SYMBOLS_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SymbolInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UnloadSymbols</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l02542">2542</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d4/d9/ke_8h.html#a408a228">ContinueProcessorReselected</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00353">KCONTINUE_STATUS</a>, <a class="el" href="../../d9/d5/kdmove_8c-source.html#l00031">KdpMoveMemory()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00203">KdpPathBuffer</a>, <a class="el" href="../../d1/d7/4_2kdp_8h.html#a122">KdpSendWaitContinue()</a>, <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00036">KdpSetLoadState()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02778">KeProcessorLevel</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/alpha_2kdtrap_8c-source.html#l00028">KdpTrap()</a>.
<p>
<pre class="fragment"><div>02551                    :
02552 
02553     This routine sends a load symbols state change packet to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel
02554     debugger and waits <span class="keywordflow">for</span> a manipulate state message.
02555 
02556 Arguments:
02557 
02558     PathName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pathname of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image whose
02559         symbols are to be loaded.
02560 
02561     BaseOfDll - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image was loaded.
02562 
02563     ProcessId - Unique 32-bit identifier <span class="keywordflow">for</span> process that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">using</span>
02564         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbols.  -1 <span class="keywordflow">for</span> system process.
02565 
02566     CheckSum - Unique 32-bit identifier from image header.
02567 
02568     UnloadSymbol - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbols that were previously loaded <span class="keywordflow">for</span>
02569         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> named image are to be unloaded from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debugger.
02570 
02571 Return Value:
02572 
02573     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> handled. Otherwise, a
02574     value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02575 
02576 --*/
02577 
02578 {
02579 
02580     PSTRING AdditionalData;
02581     STRING MessageData;
02582     STRING MessageHeader;
02583     DBGKD_WAIT_STATE_CHANGE64 WaitStateChange;
02584     <a class="code" href="../../d4/d9/ke_8h.html#a408">KCONTINUE_STATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02585 
02586     <span class="keywordflow">do</span> {
02587 
02588         <span class="comment">//</span>
02589         <span class="comment">// Construct the wait state change message and message descriptor.</span>
02590         <span class="comment">//</span>
02591 
02592         WaitStateChange.NewState = DbgKdLoadSymbolsStateChange;
02593         WaitStateChange.ProcessorLevel = <a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a>;
02594         WaitStateChange.Processor = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number;
02595         WaitStateChange.NumberProcessors = (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
02596         WaitStateChange.Thread = (ULONG64)(LONG64)(LONG_PTR) <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
02597         WaitStateChange.ProgramCounter = (ULONG64)(LONG64)(LONG_PTR) CONTEXT_TO_PROGRAM_COUNTER(ContextRecord);
02598         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a113">KdpSetLoadState</a>(&amp;WaitStateChange, ContextRecord);
02599         WaitStateChange.u.LoadSymbols.UnloadSymbols = UnloadSymbols;
02600         WaitStateChange.u.LoadSymbols.BaseOfDll = (ULONG64)SymbolInfo-&gt;BaseOfDll;
02601         WaitStateChange.u.LoadSymbols.ProcessId = (ULONG) SymbolInfo-&gt;ProcessId;
02602         WaitStateChange.u.LoadSymbols.CheckSum = SymbolInfo-&gt;CheckSum;
02603         WaitStateChange.u.LoadSymbols.SizeOfImage = SymbolInfo-&gt;SizeOfImage;
02604         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( PathName )) {
02605             WaitStateChange.u.LoadSymbols.PathNameLength =
02606                 <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
02607                     (PCHAR)KdpPathBuffer,
02608                     (PCHAR)PathName-&gt;Buffer,
02609                     PathName-&gt;Length
02610                     ) + 1;
02611 
02612             MessageData.Buffer = <a class="code" href="../../d8/d5/kddata_8c.html#a53">KdpPathBuffer</a>;
02613             MessageData.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)WaitStateChange.u.LoadSymbols.PathNameLength;
02614             MessageData.Buffer[MessageData.Length-1] = <span class="charliteral">'\0'</span>;
02615             AdditionalData = &amp;MessageData;
02616         } <span class="keywordflow">else</span> {
02617             WaitStateChange.u.LoadSymbols.PathNameLength = 0;
02618             AdditionalData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02619         }
02620 
02621         MessageHeader.Length = <span class="keyword">sizeof</span>(DBGKD_WAIT_STATE_CHANGE64);
02622         MessageHeader.Buffer = (PCHAR)&amp;WaitStateChange;
02623 
02624         <span class="comment">//</span>
02625         <span class="comment">// Send packet to the kernel debugger on the host machine, wait</span>
02626         <span class="comment">// for the reply.</span>
02627         <span class="comment">//</span>
02628 
02629         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a122">KdpSendWaitContinue</a>(
02630                     PACKET_TYPE_KD_STATE_CHANGE64,
02631                     &amp;MessageHeader,
02632                     AdditionalData,
02633                     ContextRecord
02634                     );
02635 
02636     } <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d4/d9/ke_8h.html#a408a228">ContinueProcessorReselected</a>);
02637 
02638     <span class="keywordflow">return</span> (BOOLEAN) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02639 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="4/kdapi.c::KdpRestoreBreakpoint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpRestoreBreakpoint           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01740">1740</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d3/kdbreak_8c-source.html#l00826">KdpDeleteBreakpoint()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>01748                    :
01749 
01750     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response of a restore breakpoint state
01751     manipulation message.  Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to restore a breakpoint
01752     <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle.
01753 
01754 Arguments:
01755 
01756     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
01757 
01758     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
01759 
01760     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
01761 
01762 Return Value:
01763 
01764     None.
01765 
01766 --*/
01767 
01768 {
01769     PDBGKD_RESTORE_BREAKPOINT a = &amp;m-&gt;u.RestoreBreakPoint;
01770     STRING MessageHeader;
01771 
01772     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
01773     MessageHeader.Buffer = (PCHAR)m;
01774 
01775     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
01776     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a105">KdpDeleteBreakpoint</a>(a-&gt;BreakPointHandle)) {
01777         m-&gt;ReturnStatus = STATUS_SUCCESS;
01778     } <span class="keywordflow">else</span> {
01779         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
01780     }
01781     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
01782                   PACKET_TYPE_KD_STATE_MANIPULATE,
01783                   &amp;MessageHeader,
01784                   NULL
01785                   );
01786     UNREFERENCED_PARAMETER(Context);
01787 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="4/kdapi.c::KdpRestoreBreakPointEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpRestoreBreakPointEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03247">3247</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d1/d3/kdbreak_8c-source.html#l00826">KdpDeleteBreakpoint()</a>, <a class="el" href="../../d9/d5/kdmove_8c-source.html#l00031">KdpMoveMemory()</a>, and <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>03255                    :
03256 
03257     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response of a restore breakpoint state 'ex'
03258     manipulation message.  Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to clear a list of breakpoints.
03259 
03260 Arguments:
03261 
03262     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
03263 
03264     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
03265 
03266     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
03267 
03268 Return Value:
03269 
03270     None.
03271 
03272 --*/
03273 
03274 {
03275     PDBGKD_BREAKPOINTEX         a = &amp;m-&gt;u.BreakPointEx;
03276     PDBGKD_RESTORE_BREAKPOINT   b;
03277     STRING                      MessageHeader;
03278     ULONG                       i;
03279     DBGKD_RESTORE_BREAKPOINT    BpBuf[BREAKPOINT_TABLE_SIZE];
03280 
03281 
03282     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
03283     MessageHeader.Buffer = (PCHAR)m;
03284 
03285     <span class="comment">//</span>
03286     <span class="comment">// verify that the packet size is correct</span>
03287     <span class="comment">//</span>
03288     <span class="keywordflow">if</span> (AdditionalData-&gt;Length !=
03289                        a-&gt;BreakPointCount*<span class="keyword">sizeof</span>(DBGKD_RESTORE_BREAKPOINT)) {
03290         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
03291         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
03292                       PACKET_TYPE_KD_STATE_MANIPULATE,
03293                       &amp;MessageHeader,
03294                       AdditionalData
03295                       );
03296         <span class="keywordflow">return</span>;
03297     }
03298 
03299     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>((PUCHAR)BpBuf,
03300                   AdditionalData-&gt;Buffer,
03301                   a-&gt;BreakPointCount*<span class="keyword">sizeof</span>(DBGKD_RESTORE_BREAKPOINT));
03302 
03303     <span class="comment">//</span>
03304     <span class="comment">// assume success</span>
03305     <span class="comment">//</span>
03306     m-&gt;ReturnStatus = STATUS_SUCCESS;
03307 
03308     <span class="comment">//</span>
03309     <span class="comment">// loop thru the breakpoint handles passed in from the debugger and</span>
03310     <span class="comment">// clear any breakpoint that has a non-zero handle</span>
03311     <span class="comment">//</span>
03312     b = BpBuf;
03313     <span class="keywordflow">for</span> (i=0; i&lt;a-&gt;BreakPointCount; i++,b++) {
03314         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d7/4_2kdp_8h.html#a105">KdpDeleteBreakpoint</a>(b-&gt;BreakPointHandle)) {
03315             m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
03316         }
03317     }
03318 
03319     <span class="comment">//</span>
03320     <span class="comment">// send back our response</span>
03321     <span class="comment">//</span>
03322     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
03323                   PACKET_TYPE_KD_STATE_MANIPULATE,
03324                   &amp;MessageHeader,
03325                   AdditionalData
03326                   );
03327 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="4/kdapi.c::KdpSearchHammingDistance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KdpSearchHammingDistance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Left</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Right</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03735">3735</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03787">KdpSearchPhysicalPage()</a>.
<p>
<pre class="fragment"><div>03741                    :
03742 
03743     This routine computes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Hamming distance (# of positions where the
03744     values are different). 
03745     
03746     If <span class="keyword">this</span> function becomes a bottleneck we should <span class="keywordflow">switch</span> to a function 
03747     table version.
03748 
03749 Arguments:
03750 
03751     Left, Right operand.
03752 
03753 Return Value:
03754 
03755     Hamming distance.
03756 
03757 Environment:
03758 
03759     Any.
03760 
03761 --*/
03762 
03763 {
03764     ULONG_PTR Value;
03765     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
03766     ULONG Distance;
03767 
03768     Value = Left ^ Right;
03769     Distance = 0;
03770 
03771     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; 8 * <span class="keyword">sizeof</span>(ULONG_PTR); <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
03772 
03773         <span class="keywordflow">if</span> ((Value &amp; (ULONG_PTR)0x01)) {
03774             
03775             Distance += 1;
03776         }
03777 
03778         Value &gt;&gt;= 1;        
03779     }
03780 
03781     <span class="keywordflow">return</span> Distance;
03782 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="4/kdapi.c::KdpSearchMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpSearchMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03417">3417</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d5/kdmove_8c-source.html#l00150">KdpQuickMoveMemory()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, <a class="el" href="../../d5/d5/ppc_2debugsup_8c-source.html#l00028">MmDbgReadCheck()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d0/d4/localrtl_8c-source.html#l00032">Pattern</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>03425                    :
03426 
03427     This function implements a memory pattern searcher.  This will
03428     find an instance of a pattern that begins in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range
03429     SearchAddress..SearchAddress+SearchLength.  The pattern may
03430     end outside of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
03431 
03432 Arguments:
03433 
03434     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
03435 
03436     AdditionalData - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pattern to search <span class="keywordflow">for</span>
03437 
03438     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
03439 
03440 Return Value:
03441 
03442     None.
03443 
03444 --*/
03445 
03446 {
03447     PUCHAR <a class="code" href="../../d9/d4/localrtl_8c.html#a2">Pattern</a> = AdditionalData-&gt;Buffer;
03448     ULONG_PTR StartAddress = (ULONG_PTR)m-&gt;u.SearchMemory.SearchAddress;
03449     ULONG_PTR EndAddress = (ULONG_PTR)(StartAddress + m-&gt;u.SearchMemory.SearchLength);
03450     ULONG PatternLength = m-&gt;u.SearchMemory.PatternLength;
03451 
03452     STRING MessageHeader;
03453     ULONG MaskIndex;
03454     PUCHAR PatternTail;
03455     PUCHAR DataTail;
03456     ULONG TailLength;
03457     ULONG Data;
03458     ULONG FirstWordPattern[4];
03459     ULONG FirstWordMask[4];
03460 
03461 
03462     <span class="comment">//</span>
03463     <span class="comment">// On failure, return STATUS_NO_MORE_ENTRIES.  DON'T RETURN</span>
03464     <span class="comment">// STATUS_UNSUCCESSFUL!  That return status indicates that the</span>
03465     <span class="comment">// operation is not supported, and the debugger will fall back</span>
03466     <span class="comment">// to a debugger-side search.</span>
03467     <span class="comment">//</span>
03468 
03469     m-&gt;ReturnStatus = STATUS_NO_MORE_ENTRIES;
03470 
03471     <span class="comment">//</span>
03472     <span class="comment">// Do a fast search for the beginning of the pattern</span>
03473     <span class="comment">//</span>
03474 
03475     <span class="keywordflow">if</span> (PatternLength &gt; 3) {
03476         FirstWordMask[0] = 0xffffffff;
03477     } <span class="keywordflow">else</span> {
03478         FirstWordMask[0] = 0xffffffff &gt;&gt; (8*(4-PatternLength));
03479     }
03480 
03481     FirstWordMask[1] = FirstWordMask[0] &lt;&lt; 8;
03482     FirstWordMask[2] = FirstWordMask[1] &lt;&lt; 8;
03483     FirstWordMask[3] = FirstWordMask[2] &lt;&lt; 8;
03484 
03485     FirstWordPattern[0] = 0;
03486     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a111">KdpQuickMoveMemory</a>((PVOID)FirstWordPattern,
03487                        Pattern,
03488                        PatternLength &lt; 5 ? PatternLength : 4);
03489 
03490     FirstWordPattern[1] = FirstWordPattern[0] &lt;&lt; 8;
03491     FirstWordPattern[2] = FirstWordPattern[1] &lt;&lt; 8;
03492     FirstWordPattern[3] = FirstWordPattern[2] &lt;&lt; 8;
03493 
03494 
03495 <span class="comment">/*</span>
03496 <span class="comment">{</span>
03497 <span class="comment">    int i;</span>
03498 <span class="comment">    for (i = 0; i &lt; (int)PatternLength; i++) {</span>
03499 <span class="comment">        KdpDprintf("%08x: %02x\n", &amp;Pattern[i], Pattern[i]);</span>
03500 <span class="comment">    }</span>
03501 <span class="comment">    for (i = 0; i &lt; 4; i++) {</span>
03502 <span class="comment">        KdpDprintf("%d: %08x %08x\n", i, FirstWordPattern[i], FirstWordMask[i]);</span>
03503 <span class="comment">    }</span>
03504 <span class="comment">}</span>
03505 <span class="comment">*/</span>
03506 
03507 
03508 
03509     <span class="comment">//</span>
03510     <span class="comment">// Get starting mask</span>
03511     <span class="comment">//</span>
03512 
03513     MaskIndex = (ULONG) (StartAddress &amp; 3);
03514     StartAddress = StartAddress &amp; ~3;
03515 
03516     <span class="comment">//</span>
03517     <span class="comment">// check that the starting page is available</span>
03518     <span class="comment">//</span>
03519 
03520     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a0">MmDbgReadCheck</a>((PVOID)StartAddress) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03521         StartAddress = (StartAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-1);
03522         MaskIndex = 0;
03523     }
03524 
03525     <span class="keywordflow">while</span> (StartAddress &lt; EndAddress) {
03526 
03527         <span class="comment">//</span>
03528         <span class="comment">// check when starting a new page</span>
03529         <span class="comment">//</span>
03530         <span class="keywordflow">if</span> ((StartAddress &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-1)) == 0) {
03531             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a0">MmDbgReadCheck</a>((PVOID)StartAddress) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03532                 StartAddress = StartAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03533                 <span class="keywordflow">continue</span>;
03534             }
03535         }
03536 
03537         <span class="comment">//</span>
03538         <span class="comment">// search for a match in each of the 4 starting positions</span>
03539         <span class="comment">//</span>
03540 
03541         Data = *(ULONG*)StartAddress;
03542 <span class="comment">//KdpDprintf("\n%08x: %08x ", StartAddress, Data);</span>
03543 
03544         <span class="keywordflow">for</span> ( ; MaskIndex &lt; 4; MaskIndex++) {
03545 <span class="comment">//KdpDprintf(" %d", MaskIndex);</span>
03546 
03547             <span class="keywordflow">if</span> ( (Data &amp; FirstWordMask[MaskIndex]) == FirstWordPattern[MaskIndex]) {
03548 
03549                 <span class="comment">//</span>
03550                 <span class="comment">// first word matched</span>
03551                 <span class="comment">//</span>
03552 
03553                 <span class="keywordflow">if</span> ( (4-MaskIndex) &gt;= PatternLength ) {
03554 
03555                     <span class="comment">//</span>
03556                     <span class="comment">// string is all in this word; good match</span>
03557                     <span class="comment">//</span>
03558 <span class="comment">//KdpDprintf(" %d hit, complete\n", MaskIndex);</span>
03559 
03560                     m-&gt;u.SearchMemory.FoundAddress = StartAddress + MaskIndex;
03561                     m-&gt;ReturnStatus = STATUS_SUCCESS;
03562                     <span class="keywordflow">goto</span> done;
03563 
03564                 } <span class="keywordflow">else</span> {
03565 
03566                     <span class="comment">//</span>
03567                     <span class="comment">// string is longer; see if tail matches</span>
03568                     <span class="comment">//</span>
03569 <span class="comment">//KdpDprintf(" %d hit, check tail\n", MaskIndex);</span>
03570 
03571                     PatternTail = <a class="code" href="../../d9/d4/localrtl_8c.html#a2">Pattern</a> + 4 - MaskIndex;
03572                     DataTail = (PUCHAR)StartAddress + 4;
03573                     TailLength = PatternLength - 4 + MaskIndex;
03574 
03575 <span class="comment">//KdpDprintf("Pattern == %08x\n", Pattern);</span>
03576 <span class="comment">//KdpDprintf("PatternTail == %08x\n", PatternTail);</span>
03577 <span class="comment">//KdpDprintf("DataTail == %08x\n", DataTail);</span>
03578 
03579                     <span class="keywordflow">while</span> (TailLength) {
03580                         <span class="keywordflow">if</span> ( ((ULONG_PTR)DataTail &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-1)) == 0 &amp;&amp;
03581                              <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a0">MmDbgReadCheck</a>(DataTail) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03582 <span class="comment">//KdpDprintf("Tail failed: page not present at %08x\n", DataTail);</span>
03583                             <span class="keywordflow">break</span>;
03584                         } <span class="keywordflow">else</span>
03585 {
03586 <span class="comment">//KdpDprintf("D: %02x  P: %02x\n", *DataTail, *PatternTail);</span>
03587 
03588                         <span class="keywordflow">if</span> (*DataTail != *PatternTail) {
03589 <span class="comment">//KdpDprintf("Tail failed at %08x\n", DataTail);</span>
03590                             <span class="keywordflow">break</span>;
03591                         } <span class="keywordflow">else</span> {
03592                             DataTail++;
03593                             PatternTail++;
03594                             TailLength--;
03595                         }
03596 }
03597                     }
03598 
03599                     <span class="keywordflow">if</span> (TailLength == 0) {
03600 
03601                         <span class="comment">//</span>
03602                         <span class="comment">// A winner</span>
03603                         <span class="comment">//</span>
03604 
03605                         m-&gt;u.SearchMemory.FoundAddress = StartAddress + MaskIndex;
03606                         m-&gt;ReturnStatus = STATUS_SUCCESS;
03607                         <span class="keywordflow">goto</span> done;
03608 
03609                     }
03610                 }
03611             }
03612         }
03613 
03614         StartAddress += 4;
03615         MaskIndex = 0;
03616     }
03617 
03618 done:
03619 <span class="comment">//KdpDprintf("\n");</span>
03620     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
03621     MessageHeader.Buffer = (PCHAR)m;
03622 
03623     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
03624         PACKET_TYPE_KD_STATE_MANIPULATE,
03625         &amp;MessageHeader,
03626         NULL
03627         );
03628 
03629 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="4/kdapi.c::KdpSearchPhysicalMemoryRequested" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL KdpSearchPhysicalMemoryRequested           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03869">3869</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00327">KdpSearchInProgress</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03633">KdpCheckLowMemory()</a>.
<p>
<pre class="fragment"><div>03874                    :
03875 
03876     This routine determines <span class="keywordflow">if</span> a physical range search has been
03877     requested. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> controlled by a global variable set in
03878     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> `!search' debug <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>.
03879 
03880 Arguments:
03881 
03882     None
03883 
03884 Return Value:
03885 
03886     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> physical range search was requested.
03887     
03888 
03889 Environment:
03890 
03891     Call triggered <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> from Kd <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>.
03892 
03893 --*/
03894 {
03895     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a111">KdpSearchInProgress</a>) {
03896         
03897         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03898     }
03899     <span class="keywordflow">else</span> {
03900 
03901         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03902     }
03903 
03904 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="4/kdapi.c::KdpSearchPhysicalPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL KdpSearchPhysicalPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>PageFrameIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>RangeStart</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>RangeEnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03787">3787</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d2/d6/4_2kdp_8h-source.html#l00727">KDP_SEARCH_ALL_OFFSETS_IN_PAGE</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03735">KdpSearchHammingDistance()</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00325">KdpSearchPageHitIndex</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00324">KdpSearchPageHitOffsets</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00323">KdpSearchPageHits</a>, <a class="el" href="../../d3/d5/ia64_2debugsup_8c-source.html#l00236">MmDbgTranslatePhysicalAddress64()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d6/4_2kdp_8h-source.html#l00687">SEARCH_PAGE_HIT_DATABASE_SIZE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03909">KdpSearchPhysicalPageRange()</a>.
<p>
<pre class="fragment"><div>03795                    :
03796 
03797     This routine searches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical page corresponding to a
03798     certain PFN index <span class="keywordflow">for</span> any ULONG_PTR values in range [<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>..<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>].
03799 
03800 Arguments:
03801 
03802     PageFrameIndex - PFN index
03803     
03804     RangeStart - lowest possible value searched <span class="keywordflow">for</span>
03805     
03806     RangeEnd - highest possible value searched <span class="keywordflow">for</span>
03807     
03808     Flags - flags to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> search
03809 
03810 Return Value:
03811 
03812     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a hit has been found, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
03813     The function stops after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first hit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
03814     encountered and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> infromation related to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hit (PFN index,
03815     offset, corrsponding VA) <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> registered in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hit database.
03816 
03817 Environment:
03818 
03819     Call triggered <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> from Kd <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>.
03820 
03821 --*/
03822 
03823 {
03824     PCHAR Va;
03825     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
03826     PHYSICAL_ADDRESS Pa;
03827     ULONG_PTR Value;
03828 
03829     <span class="comment">//</span>
03830     <span class="comment">// Map the physical page using the debug PTE.</span>
03831     <span class="comment">//</span>
03832 
03833     Pa.QuadPart = ((ULONGLONG)PageFrameIndex) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03834 
03835     Va = (PCHAR) <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a3">MmDbgTranslatePhysicalAddress64</a> (Pa);
03836 
03837     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(ULONG_PTR); <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1, Va += 1) {
03838 
03839         Value = *((PULONG_PTR)Va);
03840 
03841         <span class="keywordflow">if</span> ((Value &gt;= RangeStart &amp;&amp; Value &lt;= RangeEnd) 
03842             || <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a13">KdpSearchHammingDistance</a>(Value, RangeStart) == 1) {
03843 
03844             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a110">KdpSearchPageHitIndex</a> &lt; <a class="code" href="../../d1/d7/4_2kdp_8h.html#a17">SEARCH_PAGE_HIT_DATABASE_SIZE</a>) {
03845 
03846                 <a class="code" href="../../d9/d5/4_2kddata_8c.html#a108">KdpSearchPageHits</a>[<a class="code" href="../../d9/d5/4_2kddata_8c.html#a110">KdpSearchPageHitIndex</a>] = PageFrameIndex;
03847                 <a class="code" href="../../d9/d5/4_2kddata_8c.html#a109">KdpSearchPageHitOffsets</a>[<a class="code" href="../../d9/d5/4_2kddata_8c.html#a110">KdpSearchPageHitIndex</a>] = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
03848                 
03849                 <a class="code" href="../../d9/d5/4_2kddata_8c.html#a110">KdpSearchPageHitIndex</a> += 1;
03850             }
03851 
03852             <span class="keywordflow">if</span> ((Flags &amp; <a class="code" href="../../d1/d7/4_2kdp_8h.html#a19">KDP_SEARCH_ALL_OFFSETS_IN_PAGE</a>)) {
03853 
03854                 <span class="keywordflow">continue</span>;
03855             }
03856             <span class="keywordflow">else</span> {
03857 
03858                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03859             }
03860         }
03861     }
03862 
03863     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03864 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="4/kdapi.c::KdpSearchPhysicalPageRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL KdpSearchPhysicalPageRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03909">3909</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/4_2kdp_8h-source.html#l00727">KDP_SEARCH_ALL_OFFSETS_IN_PAGE</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00333">KdpSearchAddressRangeEnd</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00332">KdpSearchAddressRangeStart</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00330">KdpSearchEndPageFrame</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00327">KdpSearchInProgress</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03787">KdpSearchPhysicalPage()</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00329">KdpSearchStartPageFrame</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03633">KdpCheckLowMemory()</a>.
<p>
<pre class="fragment"><div>03914                    :
03915 
03916     This routine will start a search in a range of physical pages in <span class="keywordflow">case</span>
03917     `<a class="code" href="../../d9/d5/4_2kddata_8c.html#a111">KdpSearchInProgress</a>' <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">true</span>. <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameters <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> search are picked up
03918     from global vairiables that are set inside a kernel debugger <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>.
03919 
03920 Arguments:
03921 
03922     None
03923 
03924 Return Value:
03925 
03926     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function executed a search and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
03927     The results of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> search are specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d9/d5/4_2kddata_8c.html#a108">KdpSearchPageHits</a>
03928     and related variables. <span class="keyword">this</span> global variables offers <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mechanism
03929     <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debugger <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> to pickup <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> results of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> search.
03930     
03931 
03932 Environment:
03933 
03934     Call triggered <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> from Kd <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>.
03935     
03936     Note. The !search <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> make sure that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range requested
03937     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system memory therefore we <span class="keywordflow">do</span> not have to
03938     worry about sparse PFN databases here.
03939 
03940 --*/
03941 
03942 {
03943     PFN_NUMBER CurrentFrame;
03944     ULONG Flags;
03945 
03946     <span class="comment">//</span>
03947     <span class="comment">// The debugger extension is supposed to set KdpSearchInProgress</span>
03948     <span class="comment">// to TRUE if a search is requested. </span>
03949     <span class="comment">//</span>
03950 
03951     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/4_2kddata_8c.html#a111">KdpSearchInProgress</a>) {
03952 
03953         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03954     }
03955 
03956 
03957     Flags = 0;
03958 
03959     <span class="comment">//</span>
03960     <span class="comment">// If the search range is only one page we will give all</span>
03961     <span class="comment">// hits inside a page. By default we get only the first hit inside</span>
03962     <span class="comment">// a page.</span>
03963     <span class="comment">//</span>
03964 
03965     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a113">KdpSearchEndPageFrame</a> == <a class="code" href="../../d9/d5/4_2kddata_8c.html#a112">KdpSearchStartPageFrame</a>) {
03966 
03967         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a113">KdpSearchEndPageFrame</a> += 1;
03968 
03969         Flags |= <a class="code" href="../../d1/d7/4_2kdp_8h.html#a19">KDP_SEARCH_ALL_OFFSETS_IN_PAGE</a>;
03970     }
03971 
03972     <span class="keywordflow">for</span> (CurrentFrame = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a112">KdpSearchStartPageFrame</a>; 
03973          CurrentFrame &lt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a113">KdpSearchEndPageFrame</a>; 
03974          CurrentFrame += 1) {
03975 
03976         <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a14">KdpSearchPhysicalPage</a> (CurrentFrame, 
03977                               KdpSearchAddressRangeStart,
03978                               KdpSearchAddressRangeEnd,
03979                               Flags);
03980         
03981     }
03982 
03983     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03984 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="4/kdapi.c::KdpSendWaitContinue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d9/ke_8h.html#a408">KCONTINUE_STATUS</a> KdpSendWaitContinue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OutPacketType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>OutMessageHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING OutMessageData&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00821">821</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d4/d9/ke_8h.html#a408a226">ContinueError</a>, <a class="el" href="../../d4/d9/ke_8h.html#a408a227">ContinueSuccess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00353">KCONTINUE_STATUS</a>, <a class="el" href="../../d1/d7/4_2kdp_8h.html#a109">KdClearSpecialCalls()</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00133">KdDebuggerNotPresent</a>, <a class="el" href="../../d1/d6/kdp_8h-source.html#l00432">KDP_MESSAGE_BUFFER_SIZE</a>, <a class="el" href="../../d1/d6/kdp_8h-source.html#l00064">KDP_PACKET_RESEND</a>, <a class="el" href="../../d1/d6/kdp_8h-source.html#l00063">KDP_PACKET_TIMEOUT</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03097">KdpCauseBugCheck()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03633">KdpCheckLowMemory()</a>, <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l01057">KdpGetBusData()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01569">KdpGetContext()</a>, <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00189">KdpGetStateChange()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l02945">KdpGetVersion()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00202">KdpMessageBuffer</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03049">KdpNotSupported()</a>, <a class="el" href="../../d2/d7/hal_8h.html#a203">KdPortRestore()</a>, <a class="el" href="../../d2/d7/hal_8h.html#a204">KdPortSave()</a>, <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00218">KdpReadControlSpace()</a>, <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00505">KdpReadIoSpace()</a>, <a class="el" href="../../d2/d4/alpha_2kdcpuapi_8c-source.html#l00623">KdpReadIoSpaceExtended()</a>, <a class="el" href="../../d7/d4/4_2i386_2kdcpuapi_8c-source.html#l01098">KdpReadMachineSpecificRegister()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l02643">KdpReadPhysicalMemory()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01126">KdpReadVirtualMemory()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l01215">KdpReadVirtualMemory64()</a>, <a class="el" href="../../d1/d7/alpha_2kdreboot_8c-source.html#l00025">KdpReboot()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00342">KdpReceivePacket()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01740">KdpRestoreBreakpoint()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03247">KdpRestoreBreakPointEx()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03417">KdpSearchMemory()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l01136">KdpSetBusData()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01629">KdpSetContext()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01688">KdpWriteBreakpoint()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03125">KdpWriteBreakPointEx()</a>, <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00457">KdpWriteControlSpace()</a>, <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00785">KdpWriteIoSpace()</a>, <a class="el" href="../../d2/d4/alpha_2kdcpuapi_8c-source.html#l00899">KdpWriteIoSpaceExtended()</a>, <a class="el" href="../../d7/d4/4_2i386_2kdcpuapi_8c-source.html#l01156">KdpWriteMachineSpecificRegister()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l02779">KdpWritePhysicalMemory()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01345">KdpWriteVirtualMemory()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l01375">KdpWriteVirtualMemory64()</a>, <a class="el" href="../../d1/d7/4_2kdp_8h.html#a108">KdSetSpecialCall()</a>, <a class="el" href="../../d0/d4/ke_2debug_8c-source.html#l00334">KeSwitchFrozenProcessor()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00830                    :
00831 
00832     This function sends a packet, and then waits <span class="keywordflow">for</span> a <span class="keywordflow">continue</span> message.
00833     BreakIns received <span class="keywordflow">while</span> waiting will always cause a resend of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00834     packet originally sent <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.  While waiting, manipulate messages
00835     will be serviced.
00836 
00837     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> resend always resends <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original event sent to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debugger,
00838     not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last response to some debugger command.
00839 
00840 Arguments:
00841 
00842     OutPacketType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of packet to send.
00843 
00844     OutMessageHeader - Supplies a pointer to a string descriptor that describes
00845         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message information.
00846 
00847     OutMessageData - Supplies a pointer to a string descriptor that describes
00848         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> optional message data.
00849 
00850     ContextRecord - Exception context
00851 
00852 Return Value:
00853 
00854     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">continue</span> message indicates
00855     success, Otherwise, a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00856 
00857 --*/
00858 
00859 {
00860 
00861     ULONG Length;
00862     STRING MessageData;
00863     STRING MessageHeader;
00864     DBGKD_MANIPULATE_STATE64 ManipulateState;
00865     ULONG ReturnCode;
00866     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00867     <a class="code" href="../../d4/d9/ke_8h.html#a408">KCONTINUE_STATUS</a> ContinueStatus;
00868 
00869     <span class="comment">//</span>
00870     <span class="comment">// Loop servicing state manipulation message until a continue message</span>
00871     <span class="comment">// is received.</span>
00872     <span class="comment">//</span>
00873 
00874     MessageHeader.MaximumLength = <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64);
00875     MessageHeader.Buffer = (PCHAR)&amp;ManipulateState;
00876     MessageData.MaximumLength = <a class="code" href="../../d0/d7/kdp_8h.html#a14">KDP_MESSAGE_BUFFER_SIZE</a>;
00877     MessageData.Buffer = (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a52">KdpMessageBuffer</a>;
00878 
00879 ResendPacket:
00880 
00881     <span class="comment">//</span>
00882     <span class="comment">// Send event notification packet to debugger on host.  Come back</span>
00883     <span class="comment">// here any time we see a breakin sequence.</span>
00884     <span class="comment">//</span>
00885 
00886     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00887                   OutPacketType,
00888                   OutMessageHeader,
00889                   OutMessageData
00890                   );
00891 
00892     <span class="comment">//</span>
00893     <span class="comment">// After sending packet, if there is no response from debugger</span>
00894     <span class="comment">// AND the packet is for reporting symbol (un)load, the debugger</span>
00895     <span class="comment">// will be declared to be not present.  Note If the packet is for</span>
00896     <span class="comment">// reporting exception, the KdpSendPacket will never stop.</span>
00897     <span class="comment">//</span>
00898 
00899     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a>) {
00900         <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/ke_8h.html#a408a227">ContinueSuccess</a>;
00901     }
00902 
00903     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00904 
00905         <span class="comment">//</span>
00906         <span class="comment">// Wait for State Manipulate Packet without timeout.</span>
00907         <span class="comment">//</span>
00908 
00909         <span class="keywordflow">do</span> {
00910 
00911             ReturnCode = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a112">KdpReceivePacket</a>(
00912                             PACKET_TYPE_KD_STATE_MANIPULATE,
00913                             &amp;MessageHeader,
00914                             &amp;MessageData,
00915                             &amp;Length
00916                             );
00917             <span class="keywordflow">if</span> (ReturnCode == (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a>) {
00918                 <span class="keywordflow">goto</span> ResendPacket;
00919             }
00920         } <span class="keywordflow">while</span> (ReturnCode == <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>);
00921 
00922         <span class="comment">//</span>
00923         <span class="comment">// Switch on the return message API number.</span>
00924         <span class="comment">//</span>
00925 
00926         <span class="keywordflow">switch</span> (ManipulateState.ApiNumber) {
00927 
00928         <span class="keywordflow">case</span> DbgKdReadVirtualMemoryApi:
00929             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a123">KdpReadVirtualMemory</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00930             <span class="keywordflow">break</span>;
00931 <span class="preprocessor">#if 0</span>
00932 <span class="preprocessor"></span>        <span class="keywordflow">case</span> DbgKdReadVirtualMemory64Api:
00933             <a class="code" href="../../d0/d7/kdp_8h.html#a110">KdpReadVirtualMemory64</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00934             <span class="keywordflow">break</span>;
00935 <span class="preprocessor">#endif</span>
00936 <span class="preprocessor"></span>        <span class="keywordflow">case</span> DbgKdWriteVirtualMemoryApi:
00937             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a124">KdpWriteVirtualMemory</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00938             <span class="keywordflow">break</span>;
00939 <span class="preprocessor">#if 0</span>
00940 <span class="preprocessor"></span>        <span class="keywordflow">case</span> DbgKdWriteVirtualMemory64Api:
00941             <a class="code" href="../../d0/d7/kdp_8h.html#a112">KdpWriteVirtualMemory64</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00942             <span class="keywordflow">break</span>;
00943 <span class="preprocessor">#endif</span>
00944 <span class="preprocessor"></span>
00945         <span class="keywordflow">case</span> DbgKdCheckLowMemoryApi:
00946             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a127">KdpCheckLowMemory</a> (&amp;ManipulateState);
00947             <span class="keywordflow">break</span>;
00948 
00949         <span class="keywordflow">case</span> DbgKdReadPhysicalMemoryApi:
00950             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a125">KdpReadPhysicalMemory</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00951             <span class="keywordflow">break</span>;
00952 
00953         <span class="keywordflow">case</span> DbgKdWritePhysicalMemoryApi:
00954             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a126">KdpWritePhysicalMemory</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00955             <span class="keywordflow">break</span>;
00956 
00957         <span class="keywordflow">case</span> DbgKdGetContextApi:
00958             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a128">KdpGetContext</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00959             <span class="keywordflow">break</span>;
00960 
00961         <span class="keywordflow">case</span> DbgKdSetContextApi:
00962             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a129">KdpSetContext</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00963             <span class="keywordflow">break</span>;
00964 
00965         <span class="keywordflow">case</span> DbgKdWriteBreakPointApi:
00966             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a130">KdpWriteBreakpoint</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00967             <span class="keywordflow">break</span>;
00968 
00969         <span class="keywordflow">case</span> DbgKdRestoreBreakPointApi:
00970             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a131">KdpRestoreBreakpoint</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00971             <span class="keywordflow">break</span>;
00972 
00973         <span class="keywordflow">case</span> DbgKdReadControlSpaceApi:
00974             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a132">KdpReadControlSpace</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00975             <span class="keywordflow">break</span>;
00976 
00977         <span class="keywordflow">case</span> DbgKdWriteControlSpaceApi:
00978             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a133">KdpWriteControlSpace</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00979             <span class="keywordflow">break</span>;
00980 
00981         <span class="keywordflow">case</span> DbgKdReadIoSpaceApi:
00982             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a134">KdpReadIoSpace</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00983             <span class="keywordflow">break</span>;
00984 
00985         <span class="keywordflow">case</span> DbgKdWriteIoSpaceApi:
00986             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a136">KdpWriteIoSpace</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00987             <span class="keywordflow">break</span>;
00988 
00989 <span class="preprocessor">#ifdef _ALPHA_</span>
00990 <span class="preprocessor"></span>
00991         <span class="keywordflow">case</span> DbgKdReadIoSpaceExtendedApi:
00992             <a class="code" href="../../d7/d7/4_2axp64_2kdpcpu_8h.html#a10">KdpReadIoSpaceExtended</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00993             <span class="keywordflow">break</span>;
00994 
00995         <span class="keywordflow">case</span> DbgKdWriteIoSpaceExtendedApi:
00996             <a class="code" href="../../d7/d7/4_2axp64_2kdpcpu_8h.html#a11">KdpWriteIoSpaceExtended</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
00997             <span class="keywordflow">break</span>;
00998 
00999         <span class="keywordflow">case</span> DbgKdGetBusDataApi:
01000             <a class="code" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a10">KdpGetBusData</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
01001             <span class="keywordflow">break</span>;
01002 
01003         <span class="keywordflow">case</span> DbgKdSetBusDataApi:
01004             <a class="code" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a11">KdpSetBusData</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
01005             <span class="keywordflow">break</span>;
01006 
01007 <span class="preprocessor">#endif // _ALPHA_</span>
01008 <span class="preprocessor"></span>
01009         <span class="keywordflow">case</span> DbgKdContinueApi:
01010             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ManipulateState.u.Continue.ContinueStatus) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01011                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/ke_8h.html#a408a227">ContinueSuccess</a>;
01012             } <span class="keywordflow">else</span> {
01013                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/ke_8h.html#a408a226">ContinueError</a>;
01014             }
01015             <span class="keywordflow">break</span>;
01016 
01017         <span class="keywordflow">case</span> DbgKdContinueApi2:
01018             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ManipulateState.u.Continue2.ContinueStatus) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01019                 <a class="code" href="../../d1/d7/4_2kdp_8h.html#a115">KdpGetStateChange</a>(&amp;ManipulateState,ContextRecord);
01020                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/ke_8h.html#a408a227">ContinueSuccess</a>;
01021             } <span class="keywordflow">else</span> {
01022                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/ke_8h.html#a408a226">ContinueError</a>;
01023             }
01024             <span class="keywordflow">break</span>;
01025 
01026         <span class="keywordflow">case</span> DbgKdRebootApi:
01027             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a101">KdpReboot</a>();
01028             <span class="keywordflow">break</span>;
01029 
01030 <span class="preprocessor">#if i386</span>
01031 <span class="preprocessor"></span>        <span class="keywordflow">case</span> DbgKdReadMachineSpecificRegister:
01032             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a135">KdpReadMachineSpecificRegister</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
01033             <span class="keywordflow">break</span>;
01034 
01035         <span class="keywordflow">case</span> DbgKdWriteMachineSpecificRegister:
01036             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a137">KdpWriteMachineSpecificRegister</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
01037             <span class="keywordflow">break</span>;
01038 
01039         <span class="keywordflow">case</span> DbgKdSetSpecialCallApi:
01040             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a108">KdSetSpecialCall</a>(&amp;ManipulateState,ContextRecord);
01041             <span class="keywordflow">break</span>;
01042 
01043         <span class="keywordflow">case</span> DbgKdClearSpecialCallsApi:
01044             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a109">KdClearSpecialCalls</a>();
01045             <span class="keywordflow">break</span>;
01046 
01047         <span class="keywordflow">case</span> DbgKdSetInternalBreakPointApi:
01048             KdSetInternalBreakpoint(&amp;ManipulateState);
01049             <span class="keywordflow">break</span>;
01050 
01051         <span class="keywordflow">case</span> DbgKdGetInternalBreakPointApi:
01052             KdGetInternalBreakpoint(&amp;ManipulateState);
01053             <span class="keywordflow">break</span>;
01054 <span class="preprocessor">#endif</span>
01055 <span class="preprocessor"></span>
01056         <span class="keywordflow">case</span> DbgKdGetVersionApi:
01057             <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a7">KdpGetVersion</a>(&amp;ManipulateState);
01058             <span class="keywordflow">break</span>;
01059 
01060         <span class="keywordflow">case</span> DbgKdCauseBugCheckApi:
01061             <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a9">KdpCauseBugCheck</a>(&amp;ManipulateState);
01062             <span class="keywordflow">break</span>;
01063 
01064         <span class="keywordflow">case</span> DbgKdPageInApi:
01065             <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a8">KdpNotSupported</a>(&amp;ManipulateState);
01066             <span class="keywordflow">break</span>;
01067 
01068         <span class="keywordflow">case</span> DbgKdWriteBreakPointExApi:
01069             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a10">KdpWriteBreakPointEx</a>(&amp;ManipulateState,
01070                                           &amp;MessageData,
01071                                           ContextRecord);
01072             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
01073                 ManipulateState.ApiNumber = DbgKdContinueApi;
01074                 ManipulateState.u.Continue.ContinueStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01075                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/ke_8h.html#a408a226">ContinueError</a>;
01076             }
01077             <span class="keywordflow">break</span>;
01078 
01079         <span class="keywordflow">case</span> DbgKdRestoreBreakPointExApi:
01080             <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a11">KdpRestoreBreakPointEx</a>(&amp;ManipulateState,&amp;MessageData,ContextRecord);
01081             <span class="keywordflow">break</span>;
01082 
01083         <span class="keywordflow">case</span> DbgKdSwitchProcessor:
01084             <a class="code" href="../../d2/d7/hal_8h.html#a203">KdPortRestore</a> ();
01085             ContinueStatus = <a class="code" href="../../d9/d4/ke_2debug_8c.html#a11">KeSwitchFrozenProcessor</a>(ManipulateState.Processor);
01086             <a class="code" href="../../d2/d7/hal_8h.html#a204">KdPortSave</a> ();
01087             <span class="keywordflow">return</span> ContinueStatus;
01088 
01089         <span class="keywordflow">case</span> DbgKdSearchMemoryApi:
01090             <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a12">KdpSearchMemory</a>(&amp;ManipulateState, &amp;MessageData, ContextRecord);
01091             <span class="keywordflow">break</span>;
01092 
01093             <span class="comment">//</span>
01094             <span class="comment">// Invalid message.</span>
01095             <span class="comment">//</span>
01096 
01097         <span class="keywordflow">default</span>:
01098             MessageData.Length = 0;
01099             ManipulateState.ReturnStatus = STATUS_UNSUCCESSFUL;
01100             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(PACKET_TYPE_KD_STATE_MANIPULATE, &amp;MessageHeader, &amp;MessageData);
01101             <span class="keywordflow">break</span>;
01102         }
01103 
01104 <span class="preprocessor">#ifdef _ALPHA_</span>
01105 <span class="preprocessor"></span>
01106         <span class="comment">//</span>
01107         <span class="comment">//jnfix</span>
01108         <span class="comment">// this is embarrasing, we have an icache coherency problem that</span>
01109         <span class="comment">// the following imb fixes, later we must track this down to the</span>
01110         <span class="comment">// exact offending API but for now this statement allows the stub</span>
01111         <span class="comment">// work to appropriately for Alpha.</span>
01112         <span class="comment">//</span>
01113 
01114 <span class="preprocessor">#if defined(_MSC_VER)</span>
01115 <span class="preprocessor"></span>        __PAL_IMB();
01116 <span class="preprocessor">#else</span>
01117 <span class="preprocessor"></span>        <span class="keyword">asm</span>( <span class="stringliteral">"call_pal 0x86"</span> );   <span class="comment">// x86 = imb</span>
01118 <span class="preprocessor">#endif</span>
01119 <span class="preprocessor"></span>
01120 <span class="preprocessor">#endif</span>
01121 <span class="preprocessor"></span>
01122     }
01123 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="4/kdapi.c::KdpSetContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpSetContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01629">1629</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d5/kdmove_8c-source.html#l00150">KdpQuickMoveMemory()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02782">KiProcessorBlock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>01637                    :
01638 
01639     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response of a set context state
01640     manipulation message.  Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
01641     context.
01642 
01643 Arguments:
01644 
01645     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
01646 
01647     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
01648 
01649     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
01650 
01651 Return Value:
01652 
01653     None.
01654 
01655 --*/
01656 
01657 {
01658     PDBGKD_SET_CONTEXT a = &amp;m-&gt;u.SetContext;
01659     STRING MessageHeader;
01660 
01661     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
01662     MessageHeader.Buffer = (PCHAR)m;
01663 
01664     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == <span class="keyword">sizeof</span>(CONTEXT));
01665 
01666     <span class="keywordflow">if</span> (m-&gt;Processor &gt;= (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>) {
01667         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
01668     } <span class="keywordflow">else</span> {
01669         m-&gt;ReturnStatus = STATUS_SUCCESS;
01670         <span class="keywordflow">if</span> (m-&gt;Processor == (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number) {
01671             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a111">KdpQuickMoveMemory</a>((PCHAR)Context, AdditionalData-&gt;Buffer, <span class="keyword">sizeof</span>(CONTEXT));
01672         } <span class="keywordflow">else</span> {
01673             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a111">KdpQuickMoveMemory</a>((PCHAR)&amp;KiProcessorBlock[m-&gt;Processor]-&gt;ProcessorState.ContextFrame,
01674                           AdditionalData-&gt;Buffer,
01675                           <span class="keyword">sizeof</span>(CONTEXT)
01676                          );
01677         }
01678     }
01679 
01680     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
01681                   PACKET_TYPE_KD_STATE_MANIPULATE,
01682                   &amp;MessageHeader,
01683                   NULL
01684                   );
01685 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="4/kdapi.c::KdpSwitchProcessor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdpSwitchProcessor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SecondChance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l02426">2426</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d2/d7/hal_8h.html#a203">KdPortRestore()</a>, <a class="el" href="../../d2/d7/hal_8h.html#a204">KdPortSave()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02351">KdpReportExceptionStateChange()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>02431 {
02432     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02433 
02434     <span class="comment">//</span>
02435     <span class="comment">// Save port state</span>
02436     <span class="comment">//</span>
02437 
02438     <a class="code" href="../../d2/d7/hal_8h.html#a204">KdPortSave</a> ();
02439 
02440     <span class="comment">//</span>
02441     <span class="comment">// Process state change for this processor</span>
02442     <span class="comment">//</span>
02443 
02444     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a120">KdpReportExceptionStateChange</a> (
02445                 ExceptionRecord,
02446                 ContextRecord,
02447                 SecondChance
02448                 );
02449 
02450     <span class="comment">//</span>
02451     <span class="comment">// Restore port state and return status</span>
02452     <span class="comment">//</span>
02453 
02454     <a class="code" href="../../d2/d7/hal_8h.html#a203">KdPortRestore</a> ();
02455     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02456 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="4/kdapi.c::KdpTimeSlipDpcRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpTimeSlipDpcRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00468">468</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00293">KdpTimeSlipPending</a>, and <a class="el" href="../../d9/d4/kddata_8c-source.html#l00291">KdpTimeSlipWorkItem</a>.
<p>
<pre class="fragment"><div>00474 {
00475     LONG OldCount, NewCount, j;
00476 
00477     <span class="comment">//</span>
00478     <span class="comment">// Reset pending count.  If the current count is 1, then clear</span>
00479     <span class="comment">// the pending count.  if the current count is greater then 1,</span>
00480     <span class="comment">// then set to one and update the time now.</span>
00481     <span class="comment">//</span>
00482 
00483     j = <a class="code" href="../../d8/d5/kddata_8c.html#a103">KdpTimeSlipPending</a>;
00484     <span class="keywordflow">do</span> {
00485         OldCount = j;
00486         NewCount = OldCount &gt; 1 ? 1 : 0;
00487 
00488         j = InterlockedCompareExchange(&amp;KdpTimeSlipPending, NewCount, OldCount);
00489 
00490     } <span class="keywordflow">while</span> (j != OldCount);
00491 
00492     <span class="comment">//</span>
00493     <span class="comment">// If new count is non-zero, then process a time slip now</span>
00494     <span class="comment">//</span>
00495 
00496     <span class="keywordflow">if</span> (NewCount) {
00497         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(&amp;KdpTimeSlipWorkItem, DelayedWorkQueue);
00498     }
00499 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="4/kdapi.c::KdpTimeSlipWork" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpTimeSlipWork           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00502">502</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a312">ExAcquireTimeRefreshLock()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a313">ExReleaseTimeRefreshLock()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a314">ExUpdateSystemTimeFromCmos()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00290">KdpTimeSlipDpc</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00289">KdpTimeSlipEvent</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00288">KdpTimeSlipEventLock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00292">KdpTimeSlipTimer</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, and <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00243">KeSetTimer()</a>.
<p>
<pre class="fragment"><div>00505 {
00506     KIRQL               OldIrql;
00507     LARGE_INTEGER       DueTime;
00508 
00509     <span class="comment">//</span>
00510     <span class="comment">// Update time from the real time clock</span>
00511     <span class="comment">//</span>
00512 
00513     <a class="code" href="../../d5/d8/ex_8h.html#a312">ExAcquireTimeRefreshLock</a>();
00514     <a class="code" href="../../d5/d8/ex_8h.html#a314">ExUpdateSystemTimeFromCmos</a> (FALSE, 0);
00515     <a class="code" href="../../d5/d8/ex_8h.html#a313">ExReleaseTimeRefreshLock</a>();
00516 
00517     <span class="comment">//</span>
00518     <span class="comment">// If there's a time service installed, signal it's time slip event</span>
00519     <span class="comment">//</span>
00520 
00521     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;KdpTimeSlipEventLock, &amp;OldIrql);
00522     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a99">KdpTimeSlipEvent</a>) {
00523         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (KdpTimeSlipEvent, 0, FALSE);
00524     }
00525     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;KdpTimeSlipEventLock, OldIrql);
00526 
00527     <span class="comment">//</span>
00528     <span class="comment">// Insert a forced delay between time slip operations</span>
00529     <span class="comment">//</span>
00530 
00531     DueTime.QuadPart = -1800000000;
00532     <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a> (&amp;KdpTimeSlipTimer, DueTime, &amp;KdpTimeSlipDpc);
00533 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="4/kdapi.c::KdpWriteBreakpoint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpWriteBreakpoint           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01688">1688</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d3/kdbreak_8c-source.html#l00060">KdpAddBreakpoint()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>01696                    :
01697 
01698     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response of a write breakpoint state
01699     manipulation message.  Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to write a breakpoint
01700     and <span class="keywordflow">return</span> a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> breakpoint.
01701 
01702 Arguments:
01703 
01704     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
01705 
01706     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
01707 
01708     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
01709 
01710 Return Value:
01711 
01712     None.
01713 
01714 --*/
01715 
01716 {
01717     PDBGKD_WRITE_BREAKPOINT64 a = &amp;m-&gt;u.WriteBreakPoint;
01718     STRING MessageHeader;
01719 
01720     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
01721     MessageHeader.Buffer = (PCHAR)m;
01722 
01723     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
01724 
01725     a-&gt;BreakPointHandle = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a104">KdpAddBreakpoint</a>((PVOID)a-&gt;BreakPointAddress);
01726     <span class="keywordflow">if</span> (a-&gt;BreakPointHandle != 0) {
01727         m-&gt;ReturnStatus = STATUS_SUCCESS;
01728     } <span class="keywordflow">else</span> {
01729         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
01730     }
01731     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
01732                   PACKET_TYPE_KD_STATE_MANIPULATE,
01733                   &amp;MessageHeader,
01734                   NULL
01735                   );
01736     UNREFERENCED_PARAMETER(Context);
01737 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="4/kdapi.c::KdpWriteBreakPointEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KdpWriteBreakPointEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03125">3125</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d1/d3/kdbreak_8c-source.html#l00060">KdpAddBreakpoint()</a>, <a class="el" href="../../d1/d3/kdbreak_8c-source.html#l00826">KdpDeleteBreakpoint()</a>, <a class="el" href="../../d9/d5/kdmove_8c-source.html#l00031">KdpMoveMemory()</a>, and <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>03133                    :
03134 
03135     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response of a write breakpoint state 'ex'
03136     manipulation message.  Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to clear breakpoints, write
03137     <span class="keyword">new</span> breakpoints, and <span class="keywordflow">continue</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target system.  The clearing of
03138     breakpoints <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> conditional based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> presence of breakpoint handles.
03139     The setting of breakpoints <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> conditional based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> presence of
03140     valid, non-zero, addresses.  The continueing of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target system
03141     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> conditional based on a non-zero continuestatus.
03142 
03143     This api allows a debugger to clear breakpoints, add <span class="keyword">new</span> breakpoint,
03144     and <span class="keywordflow">continue</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target system all in one api packet.  This reduces <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03145     amount of traffic across <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wire and greatly improves source stepping.
03146 
03147 
03148 Arguments:
03149 
03150     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
03151 
03152     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
03153 
03154     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
03155 
03156 Return Value:
03157 
03158     None.
03159 
03160 --*/
03161 
03162 {
03163     PDBGKD_BREAKPOINTEX       a = &amp;m-&gt;u.BreakPointEx;
03164     PDBGKD_WRITE_BREAKPOINT64 b;
03165     STRING                    MessageHeader;
03166     ULONG                     i;
03167     DBGKD_WRITE_BREAKPOINT64  BpBuf[BREAKPOINT_TABLE_SIZE];
03168 
03169 
03170     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
03171     MessageHeader.Buffer = (PCHAR)m;
03172 
03173     <span class="comment">//</span>
03174     <span class="comment">// verify that the packet size is correct</span>
03175     <span class="comment">//</span>
03176     <span class="keywordflow">if</span> (AdditionalData-&gt;Length !=
03177                          a-&gt;BreakPointCount*<span class="keyword">sizeof</span>(DBGKD_WRITE_BREAKPOINT64)) {
03178         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
03179         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
03180                       PACKET_TYPE_KD_STATE_MANIPULATE,
03181                       &amp;MessageHeader,
03182                       AdditionalData
03183                       );
03184         <span class="keywordflow">return</span> m-&gt;ReturnStatus;
03185     }
03186 
03187     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>((PUCHAR)BpBuf,
03188                   AdditionalData-&gt;Buffer,
03189                   a-&gt;BreakPointCount*<span class="keyword">sizeof</span>(DBGKD_WRITE_BREAKPOINT64));
03190 
03191     <span class="comment">//</span>
03192     <span class="comment">// assume success</span>
03193     <span class="comment">//</span>
03194     m-&gt;ReturnStatus = STATUS_SUCCESS;
03195 
03196     <span class="comment">//</span>
03197     <span class="comment">// loop thru the breakpoint handles passed in from the debugger and</span>
03198     <span class="comment">// clear any breakpoint that has a non-zero handle</span>
03199     <span class="comment">//</span>
03200     b = BpBuf;
03201     <span class="keywordflow">for</span> (i=0; i&lt;a-&gt;BreakPointCount; i++,b++) {
03202         <span class="keywordflow">if</span> (b-&gt;BreakPointHandle) {
03203             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d7/4_2kdp_8h.html#a105">KdpDeleteBreakpoint</a>(b-&gt;BreakPointHandle)) {
03204                 m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
03205             }
03206             b-&gt;BreakPointHandle = 0;
03207         }
03208     }
03209 
03210     <span class="comment">//</span>
03211     <span class="comment">// loop thru the breakpoint addesses passed in from the debugger and</span>
03212     <span class="comment">// add any new breakpoints that have a non-zero address</span>
03213     <span class="comment">//</span>
03214     b = BpBuf;
03215     <span class="keywordflow">for</span> (i=0; i&lt;a-&gt;BreakPointCount; i++,b++) {
03216         <span class="keywordflow">if</span> (b-&gt;BreakPointAddress) {
03217             b-&gt;BreakPointHandle = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a104">KdpAddBreakpoint</a>( (PVOID)b-&gt;BreakPointAddress );
03218             <span class="keywordflow">if</span> (!b-&gt;BreakPointHandle) {
03219                 m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
03220             }
03221         }
03222     }
03223 
03224     <span class="comment">//</span>
03225     <span class="comment">// send back our response</span>
03226     <span class="comment">//</span>
03227 
03228     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(AdditionalData-&gt;Buffer,
03229                   (PUCHAR)BpBuf,
03230                   a-&gt;BreakPointCount*<span class="keyword">sizeof</span>(DBGKD_WRITE_BREAKPOINT64));
03231 
03232     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
03233                   PACKET_TYPE_KD_STATE_MANIPULATE,
03234                   &amp;MessageHeader,
03235                   AdditionalData
03236                   );
03237 
03238     <span class="comment">//</span>
03239     <span class="comment">// return the caller's continue status value.  if this is a non-zero</span>
03240     <span class="comment">// value the system is continued using this value as the continuestatus.</span>
03241     <span class="comment">//</span>
03242     <span class="keywordflow">return</span> a-&gt;ContinueStatus;
03243 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="4/kdapi.c::KdpWritePhysicalMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpWritePhysicalMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l02779">2779</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d9/d5/kdmove_8c-source.html#l00031">KdpMoveMemory()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, <a class="el" href="../../d3/d5/ia64_2debugsup_8c-source.html#l00236">MmDbgTranslatePhysicalAddress64()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>02787                    :
02788 
02789     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response to a write physical memory
02790     state manipulation message. Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to write physical memory
02791     and <span class="keywordflow">return</span>.
02792 
02793 Arguments:
02794 
02795     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
02796 
02797     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
02798 
02799     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
02800 
02801 Return Value:
02802 
02803     None.
02804 
02805 --*/
02806 
02807 {
02808     PDBGKD_WRITE_MEMORY64 a = &amp;m-&gt;u.WriteMemory;
02809     STRING MessageHeader;
02810     ULONG Length;
02811     PVOID64 VirtualAddress;
02812     PHYSICAL_ADDRESS Destination;
02813     UCHAR UNALIGNED *Source;
02814     ULONG NumberBytes;
02815     ULONG BytesLeft;
02816 
02817     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
02818     MessageHeader.Buffer = (PCHAR)m;
02819 
02820 
02821     Length = a-&gt;TransferCount;
02822 
02823     <span class="comment">//</span>
02824     <span class="comment">// The following code depends on the existence of the</span>
02825     <span class="comment">// MmDbgTranslatePhysicalAddress64() routine.  This has only been</span>
02826     <span class="comment">// implemented for Alpha.</span>
02827     <span class="comment">//</span>
02828 
02829     <span class="comment">//</span>
02830     <span class="comment">// Since the MmDbgTranslatePhysicalAddress64 only maps in one physical</span>
02831     <span class="comment">// page at a time, we need to break the memory move up into smaller</span>
02832     <span class="comment">// moves which don't cross page boundaries.  It is important that we</span>
02833     <span class="comment">// access physical memory on naturally-aligned boundaries and with the</span>
02834     <span class="comment">// largest size possible.  (We could be accessing memory-mapped I/O</span>
02835     <span class="comment">// space).  These rules allow kdexts to write physical memory reliably.</span>
02836     <span class="comment">//</span>
02837 
02838     Source = AdditionalData-&gt;Buffer;
02839     Destination.QuadPart = a-&gt;TargetBaseAddress;
02840     <span class="keywordflow">while</span> (Length &gt; 0) {
02841         VirtualAddress = <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a3">MmDbgTranslatePhysicalAddress64</a>(Destination);
02842         <span class="keywordflow">if</span> (VirtualAddress == NULL64) {
02843             <span class="keywordflow">break</span>;
02844         }
02845         NumberBytes = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(Destination.LowPart);
02846         <span class="keywordflow">if</span> (NumberBytes &gt; Length) {
02847             NumberBytes = Length;
02848         }
02849 <span class="preprocessor">#ifdef _ALPHA_</span>
02850 <span class="preprocessor"></span>        BytesLeft = NumberBytes;
02851         <span class="keywordflow">while</span> (BytesLeft &gt; 0) {
02852             <span class="keywordflow">if</span> (((ULONG64)VirtualAddress &amp; 7) == 0 &amp;&amp; BytesLeft &gt; 7) {
02853                 *((ULONGLONG * POINTER_64)VirtualAddress)++ =
02854                     *((ULONGLONG UNALIGNED *)Source)++;
02855                 BytesLeft -= 8;
02856             } <span class="keywordflow">else</span> {
02857                 <span class="keywordflow">if</span> (((ULONG64)VirtualAddress &amp; 3) == 0 &amp;&amp; BytesLeft &gt; 3) {
02858                     *((ULONG * POINTER_64)VirtualAddress)++ =
02859                         *((ULONG UNALIGNED *)Source)++;
02860                     BytesLeft -= 4;
02861                 } <span class="keywordflow">else</span> {
02862                     <span class="keywordflow">if</span> (((ULONG64)VirtualAddress &amp; 1) == 0 &amp;&amp; BytesLeft &gt; 1) {
02863                         *((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> * POINTER_64)VirtualAddress)++ =
02864                             *((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> UNALIGNED *)Source)++;
02865                         BytesLeft -= 2;
02866                     } <span class="keywordflow">else</span> {
02867                         *((UCHAR * POINTER_64)VirtualAddress)++ =
02868                             *(UCHAR UNALIGNED *)Source++;
02869                         BytesLeft -= 1;
02870                     }
02871                 }
02872             }
02873 
02874             __MB();
02875         }
02876 <span class="preprocessor">#else</span>
02877 <span class="preprocessor"></span>        <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(VirtualAddress, Source, NumberBytes);
02878         Source += NumberBytes;
02879 
02880 <span class="preprocessor">#endif</span>
02881 <span class="preprocessor"></span>        Destination.QuadPart += NumberBytes;
02882         Length -= NumberBytes;
02883         a-&gt;ActualBytesWritten += NumberBytes;
02884     }
02885 
02886     <span class="keywordflow">if</span> (Length == 0) {
02887         m-&gt;ReturnStatus = STATUS_SUCCESS;
02888     } <span class="keywordflow">else</span> {
02889         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
02890     }
02891 
02892     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
02893                   PACKET_TYPE_KD_STATE_MANIPULATE,
02894                   &amp;MessageHeader,
02895                   NULL
02896                   );
02897     UNREFERENCED_PARAMETER(Context);
02898 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="4/kdapi.c::KdpWriteVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpWriteVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01345">1345</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d9/d5/kdmove_8c-source.html#l00031">KdpMoveMemory()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, <a class="el" href="../../d3/d5/ia64_2debugsup_8c-source.html#l00174">MmDbgReleaseAddress()</a>, <a class="el" href="../../d5/d5/ppc_2debugsup_8c-source.html#l00078">MmDbgWriteCheck()</a>, <a class="el" href="../../d5/d5/ppc_2debugsup_8c-source.html#l00194">MmDbgWriteCheck64()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00847">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>01353                    :
01354 
01355     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response of a write <span class="keyword">virtual</span> memory 32-bit
01356     state manipulation message. Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to write <span class="keyword">virtual</span> memory
01357     and <span class="keywordflow">return</span>.
01358 
01359 Arguments:
01360 
01361     m - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
01362 
01363     AdditionalData - Supplies a pointer to a descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data to write.
01364 
01365     Context - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
01366 
01367 Return Value:
01368 
01369     None.
01370 
01371 --*/
01372 
01373 {
01374 
01375     ULONG Length;
01376     STRING MessageHeader;
01377     HARDWARE_PTE Opaque;
01378 
01379 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
01380 <span class="preprocessor"></span>    UCHAR * POINTER_64 Address;
01381     UCHAR * POINTER_64 Destination;
01382     PUCHAR Address32;
01383     PUCHAR Source;
01384     PUCHAR Destination32;
01385 
01386 
01387     <span class="comment">//</span>
01388     <span class="comment">// Move the data to the destination buffer.</span>
01389     <span class="comment">//</span>
01390 
01391     Length = AdditionalData-&gt;Length;
01392 
01393     Destination = (UCHAR * POINTER_64)m-&gt;u.WriteMemory.TargetBaseAddress;
01394     Destination32 = (PUCHAR)m-&gt;u.WriteMemory.TargetBaseAddress;
01395     Source = AdditionalData-&gt;Buffer;
01396     <span class="keywordflow">while</span> (Length &gt; 0) {
01397         Address=Destination;
01398         Address32 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01399         <span class="keywordflow">if</span> ((LONGLONG)Destination != (LONGLONG)((LONG)Destination)) {
01400             <span class="keywordflow">if</span> ((Address = <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a3">MmDbgWriteCheck64</a>(Destination)) == NULL64) {
01401                 <span class="keywordflow">break</span>;
01402             }
01403         } <span class="keywordflow">else</span> {
01404             <span class="keywordflow">if</span> ((Address32 = <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a1">MmDbgWriteCheck</a>(Destination32, &amp;Opaque)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01405                 <span class="keywordflow">break</span>;
01406             }
01407         }
01408 
01409         <span class="keywordflow">if</span> (Address32 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01410             *Address32 = *Source++;
01411             <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a2">MmDbgReleaseAddress</a>(Address32, &amp;Opaque);
01412         }
01413         <span class="keywordflow">else</span> {
01414             *Address = *Source++;
01415         }
01416         Destination   += 1;
01417         Destination32 += 1;
01418         Length -= 1;
01419     }
01420 
01421     <span class="comment">//</span>
01422     <span class="comment">// If all the data is written, then return a success status. Otherwise,</span>
01423     <span class="comment">// return an unsuccessful status.</span>
01424     <span class="comment">//</span>
01425 
01426     m-&gt;ReturnStatus = STATUS_SUCCESS;
01427     <span class="keywordflow">if</span> (Length != 0) {
01428         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
01429     }
01430 
01431     <span class="comment">//</span>
01432     <span class="comment">// Set the actual number of bytes written, initialize the message header,</span>
01433     <span class="comment">// and send the reply packet to the host debugger.</span>
01434     <span class="comment">//</span>
01435 
01436     m-&gt;u.WriteMemory.ActualBytesWritten = AdditionalData-&gt;Length - Length;
01437     MessageHeader.Length = <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64);
01438     MessageHeader.Buffer = (PCHAR)m;
01439     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(PACKET_TYPE_KD_STATE_MANIPULATE,
01440                   &amp;MessageHeader,
01441                   NULL);
01442 
01443     <span class="keywordflow">return</span>;
01444 <span class="preprocessor">#else</span>
01445 <span class="preprocessor"></span>
01446     <span class="comment">//</span>
01447     <span class="comment">// Move the data to the destination buffer.</span>
01448     <span class="comment">//</span>
01449 
01450     Length = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>((PVOID)m-&gt;u.WriteMemory.TargetBaseAddress,
01451                            AdditionalData-&gt;Buffer,
01452                            AdditionalData-&gt;Length);
01453 
01454     <span class="comment">//</span>
01455     <span class="comment">// If all the data is written, then return a success status. Otherwise,</span>
01456     <span class="comment">// return an unsuccessful status.</span>
01457     <span class="comment">//</span>
01458 
01459     m-&gt;ReturnStatus = STATUS_SUCCESS;
01460     <span class="keywordflow">if</span> (Length != AdditionalData-&gt;Length) {
01461         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
01462     }
01463 
01464     <span class="comment">//</span>
01465     <span class="comment">// Set the actual number of bytes written, initialize the message header,</span>
01466     <span class="comment">// and send the reply packet to the host debugger.</span>
01467     <span class="comment">//</span>
01468 
01469     m-&gt;u.WriteMemory.ActualBytesWritten = Length;
01470     MessageHeader.Length = <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64);
01471     MessageHeader.Buffer = (PCHAR)m;
01472     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(PACKET_TYPE_KD_STATE_MANIPULATE,
01473                   &amp;MessageHeader,
01474                   NULL);
01475 
01476     <span class="keywordflow">return</span>;
01477 <span class="preprocessor">#endif</span>
01478 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="4/kdapi.c::KdUpdateTimeSlipEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdUpdateTimeSlipEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Event</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00427">427</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00289">KdpTimeSlipEvent</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00288">KdpTimeSlipEventLock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.
<p>
<pre class="fragment"><div>00433                    :
00434 
00435     Update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference to an event object which will be signalled when
00436     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debugger has caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system clock to skew.
00437 
00438 Arguments:
00439 
00440     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - Supplies a pointer to an event object
00441 
00442 Return Value:
00443 
00444     None
00445 
00446 --*/
00447 
00448 {
00449     KIRQL OldIrql;
00450 
00451     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;KdpTimeSlipEventLock, &amp;OldIrql);
00452 
00453     <span class="comment">//</span>
00454     <span class="comment">// Dereference the old event and forget about it.</span>
00455     <span class="comment">// Remember the new event if there is one.</span>
00456     <span class="comment">//</span>
00457 
00458     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a99">KdpTimeSlipEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00459         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(KdpTimeSlipEvent);
00460     }
00461 
00462     <a class="code" href="../../d8/d5/kddata_8c.html#a99">KdpTimeSlipEvent</a> = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00463 
00464     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;KdpTimeSlipEventLock, OldIrql);
00465 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a3" doxytag="4/kdapi.c::KdDisableCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG <a class="el" href="../../d9/d3/4_2kdapi_8c.html#a3">KdDisableCount</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00234">234</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="4/kdapi.c::KdPreviouslyEnabled" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d3/4_2kdapi_8c.html#a4">KdPreviouslyEnabled</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00235">235</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="4/kdapi.c::Magic10000" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LARGE_INTEGER <a class="el" href="../../d1/d2/time_8c.html#a20">Magic10000</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00042">42</a> of file <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html">4/kdapi.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:25 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
