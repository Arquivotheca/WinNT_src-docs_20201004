<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sprite.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sprite.c</h1><a href="../../d8/d4/sprite_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: sprite.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Windows Layering (Sprite) support.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 12/05/97      vadimg      created</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="comment">/***************************************************************************\</span>
00016 <span class="comment">* IncrementRedirectedCount</span>
00017 <span class="comment">*</span>
00018 <span class="comment">\***************************************************************************/</span>
00019 
<a name="l00020"></a><a class="code" href="../../d8/d4/sprite_8c.html#a1">00020</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d4/sprite_8c.html#a1">IncrementRedirectedCount</a>(VOID)
00021 {
00022     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a181">gnRedirectedCount</a>++;
00023 
00024     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a181">gnRedirectedCount</a> == 1) {
00025         <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a39">IDSYS_LAYER</a>, 100,
00026                 <a class="code" href="../../d4/d2/timers_8c.html#a22">xxxSystemTimerProc</a>, TMRF_SYSTEM | TMRF_PTIWINDOW);
00027     }
00028 
00029     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a181">gnRedirectedCount</a> &gt;= 0);
00030 }
00031 
00032 <span class="comment">/***************************************************************************\</span>
00033 <span class="comment">* DecrementRedirectedCount</span>
00034 <span class="comment">*</span>
00035 <span class="comment">\***************************************************************************/</span>
00036 
<a name="l00037"></a><a class="code" href="../../d8/d4/sprite_8c.html#a2">00037</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d4/sprite_8c.html#a2">DecrementRedirectedCount</a>(VOID)
00038 {
00039     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a181">gnRedirectedCount</a>--;
00040 
00041     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a181">gnRedirectedCount</a> == 0) {
00042         <a class="code" href="../../d4/d1/userk_8h.html#a1567">_KillSystemTimer</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a39">IDSYS_LAYER</a>);
00043     }
00044 
00045     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a181">gnRedirectedCount</a> &gt;= 0);
00046 }
00047 
00048 <span class="comment">/***************************************************************************\</span>
00049 <span class="comment">* CreateRedirectionBitmap</span>
00050 <span class="comment">*</span>
00051 <span class="comment">* 10/1/1998        vadimg      created</span>
00052 <span class="comment">\***************************************************************************/</span>
00053 
<a name="l00054"></a><a class="code" href="../../d8/d4/sprite_8c.html#a3">00054</a> HBITMAP <a class="code" href="../../d8/d4/sprite_8c.html#a3">CreateRedirectionBitmap</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00055 {
00056     HBITMAP hbm;
00057 
00058     UserAssert(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right &gt;= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left);
00059     UserAssert(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom &gt;= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top);
00060 
00061     <span class="comment">/*</span>
00062 <span class="comment">     * Make sure the (0,0) case doesn't fail, since the window really</span>
00063 <span class="comment">     * can be sized this way.</span>
00064 <span class="comment">     */</span>
00065     <span class="keywordflow">if</span> ((hbm = GreCreateCompatibleBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>,
00066             <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left, 1),
00067             <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top, 1) |
00068             CCB_NOVIDEOMEMORY)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00069         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateRedirectionBitmap: bitmap create failed"</span>);
00070         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00071     }
00072 
00073     <span class="keywordflow">if</span> (!GreSetBitmapOwner(hbm, OBJECT_OWNER_PUBLIC) ||
00074             !GreMarkUndeletableBitmap(hbm) ||
00075             !<a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a0">InternalSetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a481">PROP_LAYER</a>, hbm, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a> |
00076             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a500">PROPF_NOPOOL</a>)) {
00077         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateRedirectionBitmap: bitmap set failed"</span>);
00078         GreMarkDeletableBitmap(hbm);
00079         GreDeleteObject(hbm);
00080         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00081     }
00082 
00083     <span class="comment">/*</span>
00084 <span class="comment">     * Force the window to redraw if we could recreate the bitmap since</span>
00085 <span class="comment">     * the redirection bitmap we just allocated doesn't contain anything</span>
00086 <span class="comment">     * yet.</span>
00087 <span class="comment">     */</span>
00088     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00089     <a class="code" href="../../d4/d1/userk_8h.html#a1681">xxxInternalInvalidate</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>, RDW_INVALIDATE | RDW_ERASE |
00090             RDW_FRAME | RDW_ALLCHILDREN);
00091     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();    
00092 
00093     <a class="code" href="../../d8/d4/sprite_8c.html#a1">IncrementRedirectedCount</a>();
00094 
00095     <span class="keywordflow">return</span> hbm;
00096 }
00097 
00098 <span class="comment">/***************************************************************************\</span>
00099 <span class="comment">* ConvertRedirectionDCs</span>
00100 <span class="comment">*</span>
00101 <span class="comment">* 11/19/1998        vadimg      created</span>
00102 <span class="comment">\***************************************************************************/</span>
00103 
<a name="l00104"></a><a class="code" href="../../d8/d4/sprite_8c.html#a4">00104</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d4/sprite_8c.html#a4">ConvertRedirectionDCs</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, HBITMAP hbm)
00105 {
00106     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
00107 
00108     GreLockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
00109 
00110     <span class="keywordflow">for</span> (pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; pdce != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
00111 
00112         <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_INUSE))
00113             <span class="keywordflow">continue</span>;
00114 
00115         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>) != pwnd)
00116             <span class="keywordflow">continue</span>;
00117 
00118         <span class="comment">/*</span>
00119 <span class="comment">         * Only normal DCs can be redirected. Redirection on monitor</span>
00120 <span class="comment">         * specific DCs is not supported.</span>
00121 <span class="comment">         */</span>
00122         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o9">pMonitor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00123             <span class="keywordflow">continue</span>;
00124 
00125         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a15">SET_OR_CLEAR_FLAG</a>(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a>, DCX_LAYERED, (hbm != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
00126 
00127         UserVerify(GreSelectRedirectionBitmap(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, hbm));
00128 
00129         <a class="code" href="../../d4/d1/userk_8h.html#a1701">InvalidateDce</a>(pdce);
00130     }
00131 
00132     GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
00133 }
00134 
00135 <span class="comment">/***************************************************************************\</span>
00136 <span class="comment">* UpdateLayeredSprite</span>
00137 <span class="comment">*</span>
00138 <span class="comment">* 11/19/1998        vadimg      created</span>
00139 <span class="comment">\***************************************************************************/</span>
00140 
<a name="l00141"></a><a class="code" href="../../d4/d1/userk_8h.html#a1986">00141</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1986">UpdateLayeredSprite</a>(<a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce)
00142 {
00143     RECT rcBounds;
00144     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00145     SIZE size;
00146     POINT pt;
00147     HBITMAP hbm, hbmOld;
00148 
00149     <span class="comment">/*</span>
00150 <span class="comment">     * Check to see if any drawing has been done into this DC</span>
00151 <span class="comment">     * that should be transferred to the sprite.</span>
00152 <span class="comment">     */</span>
00153     <span class="keywordflow">if</span> (!GreGetBounds(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, &amp;rcBounds, 0))
00154         <span class="keywordflow">return</span>;
00155 
00156     pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a1990">GetLayeredWindow</a>(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>);
00157 
00158     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a1991">FLayeredOrRedirected</a>(pwnd));
00159 
00160     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a621">WEFLAYERED</a>)) {
00161         hbm = (HBITMAP)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a481">PROP_LAYER</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00162     
00163         UserAssert(hbm != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00164     
00165         hbmOld = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbm);
00166     
00167         size.cx = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00168         size.cy = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00169     
00170         pt.x = pt.y = 0;
00171         GreUpdateSprite(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwnd), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00172                 &amp;size, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, &amp;pt, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ULW_DEFAULT_ATTRIBUTES, &amp;rcBounds);
00173     
00174         GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbmOld);
00175     }
00176 
00177 <span class="preprocessor">#ifdef REDIRECTION</span>
00178 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00179         <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00180         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_REDIRECTEDPAINT, pwnd,
00181                 MAKELONG(rcBounds.left, rcBounds.top),
00182                 MAKELONG(rcBounds.right, rcBounds.bottom),
00183                 <a class="code" href="../../d4/d1/userk_8h.html#a612">WEF_ASYNC</a>);
00184         <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
00185     }
00186 <span class="preprocessor">#endif // REDIRECTION</span>
00187 <span class="preprocessor"></span>}
00188 
00189 <span class="comment">/***************************************************************************\</span>
00190 <span class="comment">* DeleteRedirectionBitmap</span>
00191 <span class="comment">*</span>
00192 <span class="comment">\***************************************************************************/</span>
00193 
<a name="l00194"></a><a class="code" href="../../d8/d4/sprite_8c.html#a6">00194</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d4/sprite_8c.html#a6">DeleteRedirectionBitmap</a>(HBITMAP hbm)
00195 {
00196     GreMarkDeletableBitmap(hbm);
00197     GreDeleteObject(hbm);
00198     <a class="code" href="../../d8/d4/sprite_8c.html#a2">DecrementRedirectedCount</a>();
00199 }
00200 
00201 <span class="comment">/***************************************************************************\</span>
00202 <span class="comment">* RemoveRedirectionBitmap</span>
00203 <span class="comment">*</span>
00204 <span class="comment">* 9/23/1998        vadimg      created</span>
00205 <span class="comment">\***************************************************************************/</span>
00206 
<a name="l00207"></a><a class="code" href="../../d8/d4/sprite_8c.html#a7">00207</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d4/sprite_8c.html#a7">RemoveRedirectionBitmap</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00208 {
00209     HBITMAP hbm;
00210 
00211     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a1991">FLayeredOrRedirected</a>(pwnd));
00212 
00213     <span class="comment">/*</span>
00214 <span class="comment">     * Delete the backing bitmap for this layered window.</span>
00215 <span class="comment">     */</span>
00216     <span class="keywordflow">if</span> ((hbm = (HBITMAP)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a481">PROP_LAYER</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00217         <span class="keywordflow">return</span>;
00218 
00219     <a class="code" href="../../d8/d4/sprite_8c.html#a4">ConvertRedirectionDCs</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00220     UserVerify(<a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a1">InternalRemoveProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a481">PROP_LAYER</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00221     <a class="code" href="../../d8/d4/sprite_8c.html#a6">DeleteRedirectionBitmap</a>(hbm);
00222 }
00223 
00224 <span class="comment">/***************************************************************************\</span>
00225 <span class="comment">* _SetLayeredWindowAttributes</span>
00226 <span class="comment">*</span>
00227 <span class="comment">* 9/24/1998        vadimg      created</span>
00228 <span class="comment">\***************************************************************************/</span>
00229 
<a name="l00230"></a><a class="code" href="../../d4/d1/userk_8h.html#a1988">00230</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1988">_SetLayeredWindowAttributes</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, COLORREF crKey, BYTE bAlpha,
00231         DWORD dwFlags)
00232 {
00233     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRet;
00234     BLENDFUNCTION blend;
00235     HBITMAP hbm;
00236 
00237     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a621">WEFLAYERED</a>)) {
00238         RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING,
00239                 <span class="stringliteral">"SetLayeredWindowAttributes: not a sprite %X"</span>, pwnd);
00240         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00241     }
00242 
00243     <span class="keywordflow">if</span> ((hbm = <a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a481">PROP_LAYER</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00244         HBITMAP hbmNew;
00245 
00246         <span class="keywordflow">if</span> ((hbmNew = <a class="code" href="../../d8/d4/sprite_8c.html#a3">CreateRedirectionBitmap</a>(pwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00247             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00248         }
00249 
00250         <a class="code" href="../../d8/d4/sprite_8c.html#a4">ConvertRedirectionDCs</a>(pwnd, hbmNew);
00251     }
00252 
00253     blend.BlendOp = AC_SRC_OVER;
00254     blend.BlendFlags = 0;
00255     blend.AlphaFormat = 0;
00256     blend.SourceConstantAlpha = bAlpha;
00257 
00258     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= ULW_NEW_ATTRIBUTES; <span class="comment">// Notify gdi that these are new attributes</span>
00259 
00260     <span class="keywordflow">if</span> (hbm != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00261         HBITMAP hbmOld;
00262         SIZE size;
00263         POINT ptSrc = {0,0};
00264         
00265         hbmOld = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbm);
00266     
00267         size.cx = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00268         size.cy = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00269     
00270         bRet =  GreUpdateSprite(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwnd), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00271             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;size, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, &amp;ptSrc, crKey, &amp;blend, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00272     
00273         GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbmOld);
00274     } <span class="keywordflow">else</span> {
00275         bRet =  GreUpdateSprite(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwnd), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00276             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, crKey, &amp;blend, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00277     }
00278 
00279     <span class="keywordflow">return</span> bRet;
00280 }
00281 
00282 <span class="comment">/***************************************************************************\</span>
00283 <span class="comment">* UserRecreateRedirectionBitmap</span>
00284 <span class="comment">*</span>
00285 <span class="comment">* Called by GDI during mode changes.</span>
00286 <span class="comment">*</span>
00287 <span class="comment">* 10/6/1998        vadimg      created</span>
00288 <span class="comment">\***************************************************************************/</span>
00289 
<a name="l00290"></a><a class="code" href="../../d8/d4/sprite_8c.html#a9">00290</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d4/sprite_8c.html#a9">UserRecreateRedirectionBitmap</a>(HWND hwnd)
00291 {
00292     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00293 
00294     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00295         RIPMSG0(RIP_WARNING, <span class="stringliteral">"UserRecreateRedirectionBitmap: invalid hwnd"</span>);
00296         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00297     }
00298 
00299     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1989">RecreateRedirectionBitmap</a>(pwnd);
00300 }
00301 
00302 <span class="comment">/***************************************************************************\</span>
00303 <span class="comment">* UserRemoveRedirectionBitmap</span>
00304 <span class="comment">*</span>
00305 <span class="comment">* Called by GDI during mode changes.</span>
00306 <span class="comment">*</span>
00307 <span class="comment">* 2/15/1998        OriG        created</span>
00308 <span class="comment">\***************************************************************************/</span>
00309 
<a name="l00310"></a><a class="code" href="../../d8/d4/sprite_8c.html#a10">00310</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d4/sprite_8c.html#a10">UserRemoveRedirectionBitmap</a>(HWND hwnd)
00311 {
00312     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00313 
00314     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00315         RIPMSG0(RIP_WARNING, <span class="stringliteral">"UserRemoveRedirectionBitmap: invalid hwnd"</span>);
00316         <span class="keywordflow">return</span>;
00317     }
00318 
00319     <a class="code" href="../../d8/d4/sprite_8c.html#a7">RemoveRedirectionBitmap</a>(pwnd);
00320 
00321     <span class="comment">/*</span>
00322 <span class="comment">     * Clear the layered window flag.  This is because GDI is unable to</span>
00323 <span class="comment">     * transfer the sprite to the new PDEV, and so if we keep this flag</span>
00324 <span class="comment">     * we will have a layered window without a corresponding sprite which</span>
00325 <span class="comment">     * can lead to all sort of nasty problems (such as redirection bitmap</span>
00326 <span class="comment">     * not getting recreated in subsequent mode changes).</span>
00327 <span class="comment">     */</span>
00328     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a621">WEFLAYERED</a>);
00329 }
00330 
00331 <span class="comment">/***************************************************************************\</span>
00332 <span class="comment">* RecreateRedirectionBitmap</span>
00333 <span class="comment">*</span>
00334 <span class="comment">* 10/1/1998        vadimg      created</span>
00335 <span class="comment">\***************************************************************************/</span>
00336 
<a name="l00337"></a><a class="code" href="../../d4/d1/userk_8h.html#a1989">00337</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1989">RecreateRedirectionBitmap</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00338 {
00339     HBITMAP hbm, hbmNew, hbmMem, hbmMem2;
00340     BITMAP bm, bmNew;
00341     <span class="keywordtype">int</span> cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00342     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
00343 
00344     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a1991">FLayeredOrRedirected</a>(pwnd));
00345 
00346     <span class="comment">/*</span>
00347 <span class="comment">     * No need to do anything if this layered window doesn't have</span>
00348 <span class="comment">     * a redirection bitmap.</span>
00349 <span class="comment">     */</span>
00350     <span class="keywordflow">if</span> ((hbm = (HBITMAP)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a481">PROP_LAYER</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00351         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00352 
00353     <span class="comment">/*</span>
00354 <span class="comment">     * Try to create a new redirection bitmap with the new size. If failed,</span>
00355 <span class="comment">     * delete the old one and remove it from the window property list.</span>
00356 <span class="comment">     */</span>
00357     <span class="keywordflow">if</span> ((hbmNew = <a class="code" href="../../d8/d4/sprite_8c.html#a3">CreateRedirectionBitmap</a>(pwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00358         <a class="code" href="../../d8/d4/sprite_8c.html#a7">RemoveRedirectionBitmap</a>(pwnd);
00359         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00360     }
00361 
00362     <span class="comment">/*</span>
00363 <span class="comment">     * Make sure that the display is locked, so that nobody can be drawing</span>
00364 <span class="comment">     * into the redirection DCs while we're switching bitmaps under them.</span>
00365 <span class="comment">     */</span>
00366     UserAssert(GreIsDisplayLocked(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>));
00367 
00368     <span class="comment">/*</span>
00369 <span class="comment">     * Get the size of the old bitmap to know how much to copy.</span>
00370 <span class="comment">     */</span>
00371     GreExtGetObjectW(hbm, <span class="keyword">sizeof</span>(bm), (LPSTR)&amp;bm);
00372     GreExtGetObjectW(hbmNew, <span class="keyword">sizeof</span>(bmNew), (LPSTR)&amp;bmNew);
00373 
00374     <span class="comment">/*</span>
00375 <span class="comment">     * Copy the bitmap from the old bitmap into the new one.</span>
00376 <span class="comment">     */</span>
00377     hbmMem = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbm);
00378     hbmMem2 = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, hbmNew);
00379 
00380     cx = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(bm.bmWidth, bmNew.bmWidth);
00381     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(bm.bmHeight, bmNew.bmHeight);
00382 
00383     GreBitBlt(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, 0, 0, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, 0, 0, SRCCOPY | NOMIRRORBITMAP, 0);
00384 
00385     <span class="comment">/*</span>
00386 <span class="comment">     * Find layered DCs that are in use corresponding to this window and</span>
00387 <span class="comment">     * replace the old redirection bitmap by the new one.</span>
00388 <span class="comment">     */</span>
00389     <span class="keywordflow">for</span> (pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; pdce != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
00390 
00391         <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_LAYERED) || !(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_INUSE))
00392             <span class="keywordflow">continue</span>;
00393 
00394         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>) != pwnd)
00395             <span class="keywordflow">continue</span>;
00396 
00397         UserVerify(GreSelectRedirectionBitmap(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, hbmNew));
00398     }
00399 
00400     GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbmMem);
00401     GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, hbmMem2);
00402 
00403     <span class="comment">/*</span>
00404 <span class="comment">     * Finally, delete the old redirection bitmap.</span>
00405 <span class="comment">     */</span>
00406     <a class="code" href="../../d8/d4/sprite_8c.html#a6">DeleteRedirectionBitmap</a>(hbm);
00407 
00408     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00409 }
00410 
00411 <span class="comment">/***************************************************************************\</span>
00412 <span class="comment">* UnsetLayeredWindow</span>
00413 <span class="comment">*</span>
00414 <span class="comment">* 1/30/1998   vadimg          created</span>
00415 <span class="comment">\***************************************************************************/</span>
00416 
<a name="l00417"></a><a class="code" href="../../d4/d1/userk_8h.html#a1984">00417</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1984">UnsetLayeredWindow</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00418 {
00419     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwnd);
00420 
00421     <span class="comment">/*</span>
00422 <span class="comment">     * Remove the layered redirection bitmap.</span>
00423 <span class="comment">     */</span>
00424     <a class="code" href="../../d8/d4/sprite_8c.html#a7">RemoveRedirectionBitmap</a>(pwnd);
00425 
00426     <span class="comment">/*</span>
00427 <span class="comment">     * If the window is still visible, leave the sprite bits on the screen.</span>
00428 <span class="comment">     */</span>
00429     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
00430         GreUpdateSprite(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00431                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ULW_NOREPAINT, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00432     }
00433 
00434     <span class="comment">/*</span>
00435 <span class="comment">     * Delete the sprite object.</span>
00436 <span class="comment">     */</span>
00437     <span class="keywordflow">if</span> (!GreDeleteSprite(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwnd), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00438         RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxSetLayeredWindow failed %X"</span>, pwnd);
00439         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00440     }
00441     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a621">WEFLAYERED</a>);
00442 
00443     <span class="comment">/*</span>
00444 <span class="comment">     * No need to jiggle the mouse when the sprite is removed. As an</span>
00445 <span class="comment">     * added bonus that means that zzzInvalidateDCCache won't leave</span>
00446 <span class="comment">     * the critical section.</span>
00447 <span class="comment">     *</span>
00448 <span class="comment">     * Make sure the window gets painted if visible.</span>
00449 <span class="comment">     *</span>
00450 <span class="comment">     * BUGBUG: should jiggle the mouse. Remove IDC_NOMOUSE when</span>
00451 <span class="comment">     * SetFMouseMoved and thus InvalidateDCCache don't leave crit.</span>
00452 <span class="comment">     */</span>
00453     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
00454         <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00455         <a class="code" href="../../d4/d1/userk_8h.html#a1004">zzzInvalidateDCCache</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a232">IDC_DEFAULT</a> | <a class="code" href="../../d4/d1/userk_8h.html#a236">IDC_NOMOUSE</a>);
00456         <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
00457     }
00458     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00459 }
00460 
00461 <span class="comment">/***************************************************************************\</span>
00462 <span class="comment">* xxxSetLayeredWindow</span>
00463 <span class="comment">*</span>
00464 <span class="comment">* 12/05/97      vadimg      wrote</span>
00465 <span class="comment">\***************************************************************************/</span>
00466 
<a name="l00467"></a><a class="code" href="../../d4/d1/userk_8h.html#a1983">00467</a> HANDLE <a class="code" href="../../d4/d1/userk_8h.html#a1983">xxxSetLayeredWindow</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, BOOL fRepaintBehind)
00468 {
00469     HANDLE hsprite;
00470     SIZE size;
00471 
00472     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00473 
00474 <span class="preprocessor">#ifndef CHILD_LAYERING</span>
00475 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a596">FTopLevel</a>(pwnd)) {
00476         RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxSetLayeredWindow: not top-level %X"</span>, pwnd);
00477         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00478     }
00479 <span class="preprocessor">#endif // CHILD_LAYERING</span>
00480 <span class="preprocessor"></span>
00481 <span class="preprocessor">#ifdef REDIRECTION</span>
00482 <span class="preprocessor"></span>    <span class="comment">/*</span>
00483 <span class="comment">     * For now disallow making a layered window redirected and vice versa.</span>
00484 <span class="comment">     * This is because we need to come up with a clear way to expose</span>
00485 <span class="comment">     * layered attributes for redirected windows and also because we don't</span>
00486 <span class="comment">     * know if the redirected bitmap was created for layered redirection</span>
00487 <span class="comment">     * or redirection in itself. We would need to store a struct with</span>
00488 <span class="comment">     * flags and the bitmap in the window property to keep track of that.</span>
00489 <span class="comment">     */</span>
00490     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFREDIRECTED))
00491         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00492 <span class="preprocessor">#endif // REDIRECTION</span>
00493 <span class="preprocessor"></span>
00494 <span class="preprocessor">#if DBG</span>
00495 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a621">WEFLAYERED</a>)) {
00496         RIPMSG1(RIP_ERROR, <span class="stringliteral">"xxxSetLayeredWindow: already layered %X"</span>, pwnd);
00497     }
00498 <span class="preprocessor">#endif</span>
00499 <span class="preprocessor"></span>    
00500     size.cx = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00501     size.cy = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00502 
00503     hsprite = GreCreateSprite(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwnd), &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
00504     <span class="keywordflow">if</span> (hsprite == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00505         RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxSetLayeredWindow failed %X"</span>, pwnd);
00506         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00507     }
00508 
00509     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a621">WEFLAYERED</a>);
00510     <a class="code" href="../../d4/d1/userk_8h.html#a1985">TrackLayeredZorder</a>(pwnd);
00511 
00512     <span class="comment">/*</span>
00513 <span class="comment">     * Invalidate the DC cache because changing the sprite status</span>
00514 <span class="comment">     * may change the visrgn for some windows.</span>
00515 <span class="comment">     *</span>
00516 <span class="comment">     * BUGBUG: should jiggle the mouse. Remove IDC_NOMOUSE when</span>
00517 <span class="comment">     * SetFMouseMoved and thus InvalidateDCCache don't leave crit.</span>
00518 <span class="comment">     */</span>
00519     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00520     <a class="code" href="../../d4/d1/userk_8h.html#a1004">zzzInvalidateDCCache</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a232">IDC_DEFAULT</a> | <a class="code" href="../../d4/d1/userk_8h.html#a236">IDC_NOMOUSE</a>);
00521     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
00522 
00523     <span class="comment">/*</span>
00524 <span class="comment">     * For the dynamic promotion to a sprite, put the proper bits into</span>
00525 <span class="comment">     * the sprite itself by doing ULW with the current screen content</span>
00526 <span class="comment">     * and into the background by invalidating windows behind.  There</span>
00527 <span class="comment">     * might be some dirty bits if the window is partially obscured, but</span>
00528 <span class="comment">     * they will be refreshed as soon as the app calls ULW on its own.</span>
00529 <span class="comment">     */</span>
00530     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
00531         <span class="keywordflow">if</span> (fRepaintBehind) {
00532             POINT pt;
00533     
00534             pt.x = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00535             pt.y = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00536     
00537             <a class="code" href="../../d4/d1/userk_8h.html#a1987">_UpdateLayeredWindow</a>(pwnd, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>, &amp;pt, &amp;size,
00538                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>, &amp;pt, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ULW_OPAQUE);
00539         }
00540     } <span class="keywordflow">else</span> {
00541         <span class="comment">/*</span>
00542 <span class="comment">         * No need to repaint behind if the window is still invisible.</span>
00543 <span class="comment">         */</span>
00544         fRepaintBehind = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00545     }
00546 
00547     <span class="comment">/*</span>
00548 <span class="comment">     * This must be done after the DC cache is invalidated, because</span>
00549 <span class="comment">     * the xxxUpdateWindows call will redraw some stuff.</span>
00550 <span class="comment">     */</span>
00551     <span class="keywordflow">if</span> (fRepaintBehind) {
00552         HRGN hrgn = GreCreateRectRgnIndirect(&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
00553         <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hrgn, RDW_INVALIDATE | RDW_FRAME |
00554                 RDW_ERASE | RDW_ALLCHILDREN);
00555         <a class="code" href="../../d4/d1/userk_8h.html#a1630">xxxUpdateWindows</a>(pwnd, hrgn);
00556         GreDeleteObject(hrgn);
00557     }
00558     <span class="keywordflow">return</span> hsprite;
00559 }
00560 
00561 <span class="comment">/***************************************************************************\</span>
00562 <span class="comment">* UserVisrgnFromHwnd</span>
00563 <span class="comment">*</span>
00564 <span class="comment">* Calculate a non-clipchildren visrgn for sprites. This function must be</span>
00565 <span class="comment">* called while inside the USER critical section.</span>
00566 <span class="comment">*</span>
00567 <span class="comment">* 12/05/97      vadimg      wrote</span>
00568 <span class="comment">\***************************************************************************/</span>
00569 
<a name="l00570"></a><a class="code" href="../../d8/d4/sprite_8c.html#a14">00570</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d4/sprite_8c.html#a14">UserVisrgnFromHwnd</a>(HRGN *phrgn, HWND hwnd)
00571 {
00572     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00573     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00574     RECT rcWindow;
00575     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
00576 
00577     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00578 
00579     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00580         RIPMSG0(RIP_WARNING, <span class="stringliteral">"VisrgnFromHwnd: invalid hwnd"</span>);
00581         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00582     }
00583 
00584     <span class="comment">/*</span>
00585 <span class="comment">     * So that we don't have to recompute the layered window's visrgn</span>
00586 <span class="comment">     * every time the layered window is moved, we compute the visrgn once </span>
00587 <span class="comment">     * as if the layered window covered the entire screen.  GDI will </span>
00588 <span class="comment">     * automatically intersect with this region whenever the sprite moves.</span>
00589 <span class="comment">     */</span>
00590     rcWindow = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00591     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>;
00592 
00593     <span class="comment">/*</span>
00594 <span class="comment">     * Since we use DCX_WINDOW, only rcWindow needs to be faked and saved.</span>
00595 <span class="comment">     */</span>
00596     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = DCX_WINDOW;
00597     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>))
00598         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= DCX_CLIPSIBLINGS;
00599 
00600     fRet = <a class="code" href="../../d3/d6/visrgn_8c.html#a17">CalcVisRgn</a>(phrgn, pwnd, pwnd, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00601 
00602     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a> = rcWindow;
00603 
00604     <span class="keywordflow">return</span> fRet;
00605 }
00606 
00607 <span class="comment">/***************************************************************************\</span>
00608 <span class="comment">* SetRectRelative</span>
00609 <span class="comment">\***************************************************************************/</span>
00610 
<a name="l00611"></a><a class="code" href="../../d8/d4/sprite_8c.html#a15">00611</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d4/sprite_8c.html#a15">SetRectRelative</a>(PRECT prc, <span class="keywordtype">int</span> dx, <span class="keywordtype">int</span> dy, <span class="keywordtype">int</span> dcx, <span class="keywordtype">int</span> dcy)
00612 {
00613     prc-&gt;left += dx;
00614     prc-&gt;top += dy;
00615     prc-&gt;right += (dx + dcx);
00616     prc-&gt;bottom += (dy + dcy);
00617 }
00618 
00619 <span class="comment">/***************************************************************************\</span>
00620 <span class="comment">* xxxUpdateLayeredWindow</span>
00621 <span class="comment">*</span>
00622 <span class="comment">* 1/20/1998   vadimg          created</span>
00623 <span class="comment">\***************************************************************************/</span>
00624 
<a name="l00625"></a><a class="code" href="../../d4/d1/userk_8h.html#a1987">00625</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1987">_UpdateLayeredWindow</a>(
00626     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, 
00627     HDC hdcDst,
00628     POINT *pptDst,
00629     SIZE *psize,
00630     HDC hdcSrc,
00631     POINT *pptSrc,
00632     COLORREF crKey,
00633     BLENDFUNCTION *pblend,
00634     DWORD dwFlags)
00635 {
00636     <span class="keywordtype">int</span> dx, dy, dcx, dcy;
00637     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fMove = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, fSize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00638 
00639     <span class="comment">/*</span>
00640 <span class="comment">     * Verify that we're called with a real layered window.</span>
00641 <span class="comment">     */</span>
00642     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a621">WEFLAYERED</a>) ||
00643             <a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a481">PROP_LAYER</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00644         RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING,
00645                 <span class="stringliteral">"_UpdateLayeredWindow: can't call on window %X"</span>, pwnd);
00646         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00647     }
00648 
00649     <span class="keywordflow">if</span> (!GreUpdateSprite(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwnd), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hdcDst, pptDst,
00650             psize, hdcSrc, pptSrc, crKey, pblend, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00651         RIPMSG1(RIP_WARNING, <span class="stringliteral">"_UpdateLayeredWindow: !UpdateSprite %X"</span>, pwnd);
00652         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00653     }
00654 
00655     <span class="comment">/*</span>
00656 <span class="comment">     * Figure out relative adjustments in position and size.</span>
00657 <span class="comment">     */</span>
00658     <span class="keywordflow">if</span> (pptDst != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00659         dx = pptDst-&gt;x - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00660         dy = pptDst-&gt;y - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00661         <span class="keywordflow">if</span> (dx != 0 || dy != 0) {
00662             fMove = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00663         }
00664     } <span class="keywordflow">else</span> {
00665         dx = 0;
00666         dy = 0;
00667     }
00668     <span class="keywordflow">if</span> (psize != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00669         dcx = psize-&gt;cx - (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left);
00670         dcy = psize-&gt;cy - (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top);
00671         <span class="keywordflow">if</span> (dcx != 0 || dcy != 0) {
00672             fSize = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00673         }
00674     } <span class="keywordflow">else</span> {
00675         dcx = 0;
00676         dcy = 0;
00677     }
00678 
00679     <span class="keywordflow">if</span> (fMove || fSize) {
00680         <span class="comment">/*</span>
00681 <span class="comment">         * Adjust the client rect position and size relative to </span>
00682 <span class="comment">         * the window rect.</span>
00683 <span class="comment">         */</span>
00684         <a class="code" href="../../d8/d4/sprite_8c.html#a15">SetRectRelative</a>(&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>, dx, dy, dcx, dcy);
00685         <a class="code" href="../../d8/d4/sprite_8c.html#a15">SetRectRelative</a>(&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>, dx, dy, dcx, dcy);
00686 
00687         <span class="comment">/*</span>
00688 <span class="comment">         * Since the client rect could be smaller than the window</span>
00689 <span class="comment">         * rect make sure the client rect doesn't underflow!</span>
00690 <span class="comment">         */</span>
00691         <span class="keywordflow">if</span> ((dcx &lt; 0) &amp;&amp; (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left &lt; pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left)) {
00692             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00693             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00694         }
00695         <span class="keywordflow">if</span> ((dcy &lt; 0) &amp;&amp; (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top &lt; pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top)) {
00696             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00697             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.bottom = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00698         }
00699        <span class="comment">/*</span>
00700 <span class="comment">        * BUGBUG: should jiggle the mouse, do this when SetFMouseMoved </span>
00701 <span class="comment">        * doesn't leave crit.</span>
00702 <span class="comment">        * </span>
00703 <span class="comment">        * SetFMouseMoved();</span>
00704 <span class="comment">        */</span>
00705     }
00706 
00707     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00708 }
00709 
00710 <span class="comment">/***************************************************************************\</span>
00711 <span class="comment">* DeleteFadeSprite</span>
00712 <span class="comment">\***************************************************************************/</span>
00713 
<a name="l00714"></a><a class="code" href="../../d8/d4/sprite_8c.html#a17">00714</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d8/d4/sprite_8c.html#a17">DeleteFadeSprite</a>(<span class="keywordtype">void</span>)
00715 {
00716     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00717 
00718     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o7">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a687">FADE_WINDOW</a>) {
00719         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o0">hsprite</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00720             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a621">WEFLAYERED</a>)) {
00721                 <a class="code" href="../../d4/d1/userk_8h.html#a1984">UnsetLayeredWindow</a>(pwnd);
00722             }
00723         } <span class="keywordflow">else</span> {
00724             RIPMSG0(RIP_WARNING, <span class="stringliteral">"DeleteFadeSprite: hwnd no longer valid"</span>);
00725         }
00726     } <span class="keywordflow">else</span> {
00727         GreDeleteSprite(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o0">hsprite</a>);
00728     }
00729     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o0">hsprite</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00730     <span class="keywordflow">return</span> pwnd;
00731 }
00732 
00733 <span class="comment">/***************************************************************************\</span>
00734 <span class="comment">* UpdateFade</span>
00735 <span class="comment">*</span>
00736 <span class="comment">* 2/16/1998   vadimg          created</span>
00737 <span class="comment">\***************************************************************************/</span>
00738 
<a name="l00739"></a><a class="code" href="../../d8/d4/sprite_8c.html#a18">00739</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d4/sprite_8c.html#a18">UpdateFade</a>(POINT *pptDst, SIZE *psize, HDC hdcSrc, POINT *pptSrc, 
00740         BLENDFUNCTION *pblend)
00741 {
00742     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00743 
00744     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o7">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a687">FADE_WINDOW</a>) {
00745         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o0">hsprite</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00746             <a class="code" href="../../d4/d1/userk_8h.html#a1987">_UpdateLayeredWindow</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pptDst, psize, hdcSrc, 
00747                      pptSrc, 0, pblend, ULW_ALPHA);
00748         }
00749     } <span class="keywordflow">else</span> {
00750         GreUpdateSprite(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o0">hsprite</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 
00751                 pptDst, psize, hdcSrc, pptSrc, 0, pblend, ULW_ALPHA, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00752     }
00753 }
00754 
00755 <span class="comment">/***************************************************************************\</span>
00756 <span class="comment">* CreateFade</span>
00757 <span class="comment">*</span>
00758 <span class="comment">* 2/5/1998   vadimg          created</span>
00759 <span class="comment">\***************************************************************************/</span>
00760 
<a name="l00761"></a><a class="code" href="../../d4/d1/userk_8h.html#a1977">00761</a> HDC <a class="code" href="../../d4/d1/userk_8h.html#a1977">CreateFade</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, RECT *prc, DWORD dwTime, DWORD dwFlags)
00762 {
00763     SIZE size;
00764 
00765     <span class="comment">/*</span>
00766 <span class="comment">     * Bail if there is a fade animation going on already.</span>
00767 <span class="comment">     */</span>
00768     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o2">hbm</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00769         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateFade: failed, fade not available"</span>);
00770         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00771     }
00772 
00773     <span class="comment">/*</span>
00774 <span class="comment">     * Create a cached compatible DC.</span>
00775 <span class="comment">     */</span>
00776     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00777         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a> = GreCreateCompatibleDC(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>);
00778         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00779             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00780         }
00781     }
00782 
00783     <span class="comment">/*</span>
00784 <span class="comment">     * A windowed fade must have window position and size, so </span>
00785 <span class="comment">     * prc passed in is disregarded.</span>
00786 <span class="comment">     */</span>
00787     UserAssert((pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (prc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
00788 
00789     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00790         prc = &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00791     }
00792 
00793     size.cx = prc-&gt;right - prc-&gt;left;
00794     size.cy = prc-&gt;bottom - prc-&gt;top;
00795 
00796     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00797         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o0">hsprite</a> = GreCreateSprite(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, prc);
00798     } <span class="keywordflow">else</span> {
00799         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o7">dwFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a687">FADE_WINDOW</a>;
00800         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o0">hsprite</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00801 
00802         <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00803         <a class="code" href="../../d4/d1/userk_8h.html#a1983">xxxSetLayeredWindow</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00804         <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
00805     }
00806 
00807     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o0">hsprite</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00808         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00809 
00810     <span class="comment">/*</span>
00811 <span class="comment">     * Create a compatible bitmap for this size animation.</span>
00812 <span class="comment">     */</span>
00813     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o2">hbm</a> = GreCreateCompatibleBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>, size.cx, size.cy);
00814     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o2">hbm</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00815         <a class="code" href="../../d8/d4/sprite_8c.html#a17">DeleteFadeSprite</a>();
00816         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00817     }
00818 
00819     GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o2">hbm</a>);
00820 
00821     <span class="comment">/*</span>
00822 <span class="comment">     * Since this isn't necessarily the first animation and the hdc could</span>
00823 <span class="comment">     * be set to public, make sure the owner is the current process. This</span>
00824 <span class="comment">     * way this process will be able to draw into it.</span>
00825 <span class="comment">     */</span>
00826     GreSetDCOwner(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a>, OBJECT_OWNER_CURRENT);
00827 
00828     <span class="comment">/*</span>
00829 <span class="comment">     * Initialize all other fade animation data.</span>
00830 <span class="comment">     */</span>
00831     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o3">ptDst</a>.x = prc-&gt;left;
00832     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o3">ptDst</a>.y = prc-&gt;top;
00833     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o4">size</a>.cx = size.cx;
00834     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o4">size</a>.cy = size.cy;
00835     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o5">dwTime</a> = dwTime;
00836     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o7">dwFlags</a> |= <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00837 
00838     <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a>;
00839 }
00840 
00841 <span class="comment">/***************************************************************************\</span>
00842 <span class="comment">* ShowFade</span>
00843 <span class="comment">*</span>
00844 <span class="comment">* GDI says that for alpha fade-out it's more efficient to do the first </span>
00845 <span class="comment">* show as opaque alpha instead of using ULW_OPAQUE.</span>
00846 <span class="comment">\***************************************************************************/</span>
00847 
<a name="l00848"></a><a class="code" href="../../d8/d4/sprite_8c.html#a0">00848</a> <span class="preprocessor">#define ALPHASTART 40</span>
00849 <span class="preprocessor"></span>
<a name="l00850"></a><a class="code" href="../../d4/d1/userk_8h.html#a1980">00850</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d4/sprite_8c.html#a20">ShowFade</a>(<span class="keywordtype">void</span>)
00851 {
00852     BLENDFUNCTION blend;
00853     POINT ptSrc;
00854     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fShow;
00855 
00856     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00857     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o2">hbm</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00858 
00859     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o7">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a686">FADE_SHOWN</a>)
00860         <span class="keywordflow">return</span>;
00861     
00862     fShow = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o7">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a684">FADE_SHOW</a>);
00863     ptSrc.x = ptSrc.y = 0;
00864     blend.BlendOp = AC_SRC_OVER;
00865     blend.BlendFlags = 0;
00866     blend.AlphaFormat = 0;
00867     blend.SourceConstantAlpha = fShow ? <a class="code" href="../../d3/d8/winmgrc_8c.html#a1">ALPHASTART</a> : (255 - <a class="code" href="../../d3/d8/winmgrc_8c.html#a1">ALPHASTART</a>);
00868     <a class="code" href="../../d8/d4/sprite_8c.html#a18">UpdateFade</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o3">ptDst</a>, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o4">size</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a>, &amp;ptSrc, &amp;blend);
00869 
00870     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o7">dwFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a686">FADE_SHOWN</a>;
00871 }
00872 
00873 <span class="comment">/***************************************************************************\</span>
00874 <span class="comment">* StartFade</span>
00875 <span class="comment">*</span>
00876 <span class="comment">* 2/5/1998   vadimg          created</span>
00877 <span class="comment">\***************************************************************************/</span>
00878 
<a name="l00879"></a><a class="code" href="../../d4/d1/userk_8h.html#a1978">00879</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d4/sprite_8c.html#a21">StartFade</a>(<span class="keywordtype">void</span>)
00880 {
00881     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwElapsed;
00882 
00883     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00884     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o2">hbm</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00885 
00886     <span class="comment">/*</span>
00887 <span class="comment">     * Set dc and bitmap to public so the desktop thread can use them.</span>
00888 <span class="comment">     */</span>
00889     GreSetDCOwner(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a>, OBJECT_OWNER_PUBLIC);
00890     GreSetBitmapOwner(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o2">hbm</a>, OBJECT_OWNER_PUBLIC);
00891 
00892     <span class="comment">/*</span>
00893 <span class="comment">     * If it's not already shown, do the initial update that makes copy of</span>
00894 <span class="comment">     * the source. All other updates will only need to change the alpha value.</span>
00895 <span class="comment">     */</span>
00896     <a class="code" href="../../d8/d4/sprite_8c.html#a20">ShowFade</a>();
00897 
00898     <span class="comment">/*</span>
00899 <span class="comment">     * Get the start time for the fade animation.</span>
00900 <span class="comment">     */</span>
00901     dwElapsed = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o5">dwTime</a> * <a class="code" href="../../d3/d8/winmgrc_8c.html#a1">ALPHASTART</a> + 255) / 255;
00902     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o6">dwStart</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() - dwElapsed;
00903 
00904     <span class="comment">/*</span>
00905 <span class="comment">     * Set the timer in the desktop thread. This will insure that the</span>
00906 <span class="comment">     * animation is smooth and won't get stuck if the current thread hangs.</span>
00907 <span class="comment">     */</span>
00908     <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a40">IDSYS_FADE</a>, 10,
00909             <a class="code" href="../../d4/d2/timers_8c.html#a22">xxxSystemTimerProc</a>, TMRF_SYSTEM | TMRF_PTIWINDOW);
00910 }
00911 
00912 <span class="comment">/***************************************************************************\</span>
00913 <span class="comment">* StopFade</span>
00914 <span class="comment">*</span>
00915 <span class="comment">* 2/5/1998   vadimg          created</span>
00916 <span class="comment">\***************************************************************************/</span>
00917 
<a name="l00918"></a><a class="code" href="../../d4/d1/userk_8h.html#a1979">00918</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d4/sprite_8c.html#a22">StopFade</a>(<span class="keywordtype">void</span>)
00919 {
00920     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRop=SRCCOPY;
00921     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00922 
00923     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00924     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o2">hbm</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00925 
00926     <span class="comment">/*</span>
00927 <span class="comment">     * Stop the fade animation timer.</span>
00928 <span class="comment">     */</span>
00929     <a class="code" href="../../d4/d1/userk_8h.html#a1567">_KillSystemTimer</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a40">IDSYS_FADE</a>);
00930 
00931     pwnd = <a class="code" href="../../d8/d4/sprite_8c.html#a17">DeleteFadeSprite</a>();
00932 
00933     <span class="comment">/*</span>
00934 <span class="comment">     * If showing and the animation isn't completed, blt the last frame.</span>
00935 <span class="comment">     */</span>
00936     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o7">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a685">FADE_COMPLETED</a>) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o7">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a684">FADE_SHOW</a>)) {
00937         <span class="keywordtype">int</span> x, y;
00938         HDC hdc;
00939 
00940         <span class="comment">/*</span>
00941 <span class="comment">         * For a windowed fade, make sure we observe the current visrgn.</span>
00942 <span class="comment">         */</span>
00943         <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00944             hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_WINDOW | DCX_CACHE);
00945             x = 0;
00946             y = 0;
00947         } <span class="keywordflow">else</span> {
00948             hdc = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>;
00949             x = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o3">ptDst</a>.x;
00950             y = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o3">ptDst</a>.y;
00951         }
00952         
00953 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00954 <span class="preprocessor"></span>        <span class="comment">/*</span>
00955 <span class="comment">         * If the destination DC is RTL mirrored, then BitBlt call should mirror the</span>
00956 <span class="comment">         * content, since we want the menu to preserve it text (i.e. not to</span>
00957 <span class="comment">         * be flipped). [samera]</span>
00958 <span class="comment">         */</span>
00959         <span class="keywordflow">if</span> (GreGetLayout(hdc) &amp; LAYOUT_RTL) {
00960             dwRop |= NOMIRRORBITMAP;
00961         }
00962 <span class="preprocessor">#endif</span>
00963 <span class="preprocessor"></span>
00964         GreBitBlt(hdc, x, y, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o4">size</a>.cx, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o4">size</a>.cy, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a>, 0, 0, dwRop, 0);
00965         <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00966     }
00967 
00968     <span class="comment">/*</span>
00969 <span class="comment">     * Clean up the animation data.</span>
00970 <span class="comment">     */</span>
00971     GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a>, GreGetStockObject(PRIV_STOCK_BITMAP));
00972     GreDeleteObject(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o2">hbm</a>);
00973 
00974     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o2">hbm</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00975     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o7">dwFlags</a> = 0;
00976 }
00977 
00978 <span class="comment">/***************************************************************************\</span>
00979 <span class="comment">* AnimateFade</span>
00980 <span class="comment">*</span>
00981 <span class="comment">* 2/5/1998   vadimg          created</span>
00982 <span class="comment">\***************************************************************************/</span>
00983 
<a name="l00984"></a><a class="code" href="../../d4/d1/userk_8h.html#a1981">00984</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d4/sprite_8c.html#a23">AnimateFade</a>(<span class="keywordtype">void</span>)
00985 {
00986     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTimeElapsed;
00987     BLENDFUNCTION blend;
00988     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bAlpha;
00989     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fShow;
00990 
00991     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00992     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o2">hbm</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00993 
00994     dwTimeElapsed = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() - <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o6">dwStart</a>;
00995 
00996     <span class="comment">/*</span>
00997 <span class="comment">     * If exceeding the allowed time, stop the animation now.</span>
00998 <span class="comment">     */</span>
00999     <span class="keywordflow">if</span> (dwTimeElapsed &gt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o5">dwTime</a>) {
01000         <a class="code" href="../../d8/d4/sprite_8c.html#a22">StopFade</a>();
01001         <span class="keywordflow">return</span>;
01002     }
01003 
01004     fShow = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o7">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a684">FADE_SHOW</a>);
01005 
01006     <span class="comment">/*</span>
01007 <span class="comment">     * Calculate new alpha value based on time elapsed.</span>
01008 <span class="comment">     */</span>
01009     <span class="keywordflow">if</span> (fShow) {
01010         bAlpha = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)((255 * dwTimeElapsed) / <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o5">dwTime</a>);
01011     } <span class="keywordflow">else</span> {
01012         bAlpha = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(255 * (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o5">dwTime</a> - dwTimeElapsed) / <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o5">dwTime</a>);
01013     }
01014 
01015     blend.BlendOp = AC_SRC_OVER;
01016     blend.BlendFlags = 0;
01017     blend.AlphaFormat = 0;
01018     blend.SourceConstantAlpha = bAlpha;
01019     <a class="code" href="../../d8/d4/sprite_8c.html#a18">UpdateFade</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;blend);
01020 
01021     <span class="comment">/*</span>
01022 <span class="comment">     * Check if finished animating the fade.</span>
01023 <span class="comment">     */</span>
01024     <span class="keywordflow">if</span> ((fShow &amp;&amp; bAlpha == 255) || (!fShow &amp;&amp; bAlpha == 0)) {
01025         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o7">dwFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a685">FADE_COMPLETED</a>;
01026         <a class="code" href="../../d8/d4/sprite_8c.html#a22">StopFade</a>();
01027     }
01028 }
01029 
01030 <span class="preprocessor">#ifdef REDIRECTION</span>
01031 <span class="preprocessor"></span><span class="preprocessor">#ifndef CHILD_LAYERING</span>
01032 <span class="preprocessor"></span><span class="preprocessor">#error You must enable CHILD_LAYERING to use REDIRECTION</span>
01033 <span class="preprocessor"></span><span class="preprocessor">#endif // CHILD_LAYERING</span>
01034 <span class="preprocessor"></span>
01035 <span class="comment">/***************************************************************************\</span>
01036 <span class="comment">* SetRedirectedWindow</span>
01037 <span class="comment">*</span>
01038 <span class="comment">* 1/27/99      vadimg      wrote</span>
01039 <span class="comment">\***************************************************************************/</span>
01040 
01041 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> SetRedirectedWindow(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01042 {
01043     HBITMAP hbmNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01044 
01045     <span class="comment">/*</span>
01046 <span class="comment">     * For now disallow making a layered window redirected and vice versa.</span>
01047 <span class="comment">     * This is because we need to come up with a clear way to expose</span>
01048 <span class="comment">     * layered attributes for redirected windows and also because we don't</span>
01049 <span class="comment">     * know if the redirected bitmap was created for layered redirection</span>
01050 <span class="comment">     * or redirection in itself. We would need to store a struct with</span>
01051 <span class="comment">     * flags and the bitmap in the window property to keep track of that.</span>
01052 <span class="comment">     */</span>
01053     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYERED))
01054         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01055 
01056     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, PROP_LAYER, TRUE) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01057         <span class="keywordflow">if</span> ((hbmNew = <a class="code" href="../../d8/d4/sprite_8c.html#a3">CreateRedirectionBitmap</a>(pwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01058             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01059         }
01060     }
01061 
01062     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, WEFREDIRECTED);
01063 
01064     <span class="keywordflow">if</span> (hbmNew != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01065         <a class="code" href="../../d8/d4/sprite_8c.html#a4">ConvertRedirectionDCs</a>(pwnd, hbmNew);
01066     }
01067 
01068     <span class="comment">/*</span>
01069 <span class="comment">     * Invalidate the DC cache because changing visual state may</span>
01070 <span class="comment">     * change the visrgn for some windows.</span>
01071 <span class="comment">     */</span>
01072     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
01073     <a class="code" href="../../d4/d1/userk_8h.html#a1004">zzzInvalidateDCCache</a>(pwnd, IDC_DEFAULT | IDC_NOMOUSE);
01074     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
01075 
01076     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01077 }
01078 
01079 <span class="comment">/***************************************************************************\</span>
01080 <span class="comment">* UnsetRedirectedWindow</span>
01081 <span class="comment">*</span>
01082 <span class="comment">* 1/27/1999        vadimg      created</span>
01083 <span class="comment">\***************************************************************************/</span>
01084 
01085 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> UnsetRedirectedWindow(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01086 {
01087     <a class="code" href="../../d8/d4/sprite_8c.html#a7">RemoveRedirectionBitmap</a>(pwnd);
01088 
01089     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, WEFREDIRECTED);
01090 
01091     <span class="comment">/*</span>
01092 <span class="comment">     * Invalidate the DC cache because changing visual state may</span>
01093 <span class="comment">     * change the visrgn for some windows.</span>
01094 <span class="comment">     */</span>
01095     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
01096     <a class="code" href="../../d4/d1/userk_8h.html#a1004">zzzInvalidateDCCache</a>(pwnd, IDC_DEFAULT | IDC_NOMOUSE);
01097     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
01098 
01099     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01100 }
01101 
01102 <span class="preprocessor">#endif // REDIRECTION</span>
01103 <span class="preprocessor"></span>
01104 <span class="preprocessor">#ifdef CHILD_LAYERING</span>
01105 <span class="preprocessor"></span>
01106 <span class="comment">/***************************************************************************\</span>
01107 <span class="comment">* GetNextLayeredWindow</span>
01108 <span class="comment">*</span>
01109 <span class="comment">* Preorder traversal of the window tree to find the next layering window</span>
01110 <span class="comment">* below in zorder than pwnd. We need this because sprites are stored in a</span>
01111 <span class="comment">* linked list. Note that this algorithm is iterative which is cool!</span>
01112 <span class="comment">\***************************************************************************/</span>
01113 
01114 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> GetNextLayeredWindow(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01115 {
01116     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndStop = <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd);
01117 
01118     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01119         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01120             pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01121         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01122             pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01123         } <span class="keywordflow">else</span> {
01124     
01125             <span class="keywordflow">do</span> {
01126                 pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
01127     
01128                 <span class="keywordflow">if</span> (pwnd == pwndStop) {
01129                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01130                 }
01131     
01132             } <span class="keywordflow">while</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01133     
01134             pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01135         }
01136     
01137         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYERED)) {
01138             <span class="keywordflow">return</span> pwnd;
01139         }
01140     }
01141 }
01142 
01143 <span class="comment">/***************************************************************************\</span>
01144 <span class="comment">* GetLayeredWindow</span>
01145 <span class="comment">*</span>
01146 <span class="comment">\***************************************************************************/</span>
01147 
01148 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1990">GetLayeredWindow</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01149 {
01150     <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01151         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1991">FLayeredOrRedirected</a>(pwnd))
01152             <span class="keywordflow">break</span>;
01153 
01154         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
01155     }
01156     <span class="keywordflow">return</span> pwnd;
01157 }
01158 
01159 <span class="preprocessor">#else // CHILD_LAYERING</span>
01160 <span class="preprocessor"></span>
01161 <span class="comment">/***************************************************************************\</span>
01162 <span class="comment">* GetLayeredWindow</span>
01163 <span class="comment">*</span>
01164 <span class="comment">\***************************************************************************/</span>
01165 
<a name="l01166"></a><a class="code" href="../../d4/d1/userk_8h.html#a1990">01166</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1990">GetLayeredWindow</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01167 {
01168     pwnd = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pwnd);
01169 
01170     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a621">WEFLAYERED</a>))
01171         <span class="keywordflow">return</span> pwnd;
01172 
01173     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01174 }
01175 
01176 <span class="preprocessor">#endif // CHILD_LAYERING</span>
01177 <span class="preprocessor"></span>
01178 <span class="comment">/***************************************************************************\</span>
01179 <span class="comment">* TrackLayeredZorder</span>
01180 <span class="comment">*</span>
01181 <span class="comment">* Unlike USER, GDI stores sprites from bottom to top.</span>
01182 <span class="comment">\***************************************************************************/</span>
01183 
<a name="l01184"></a><a class="code" href="../../d4/d1/userk_8h.html#a1985">01184</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1985">TrackLayeredZorder</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01185 {
01186 <span class="preprocessor">#ifdef CHILD_LAYERING</span>
01187 <span class="preprocessor"></span>
01188     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT = GetNextLayeredWindow(pwnd);
01189 
01190 <span class="preprocessor">#else // CHILD_LAYERING</span>
01191 <span class="preprocessor"></span>
01192     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01193 
01194     <span class="keywordflow">while</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01195 
01196         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d1/d0/inc_2user_8h.html#a621">WEFLAYERED</a>))
01197             <span class="keywordflow">break</span>;
01198 
01199         pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01200     }
01201 
01202 <span class="preprocessor">#endif // CHILD_LAYERING</span>
01203 <span class="preprocessor"></span>
01204     GreZorderSprite(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndT));
01205 }
01206 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:51 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
