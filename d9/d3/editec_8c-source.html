<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: editec.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>editec.c</h1><a href="../../d8/d4/editec_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************************************************************\</span>
00002 <span class="comment">* editec.c - Edit controls rewrite. Version II of edit controls.</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Created: 24-Jul-88 davidds</span>
00007 <span class="comment">\****************************************************************************/</span>
00008 
00009 <span class="comment">/* Warning: The single line editcontrols contain internal styles and API which</span>
00010 <span class="comment"> * are need to support comboboxes. They are defined in combcom.h/combcom.inc</span>
00011 <span class="comment"> * and may be redefined or renumbered as needed.</span>
00012 <span class="comment"> */</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
<a name="l00017"></a><a class="code" href="../../d8/d4/editec_8c.html#a8">00017</a> <a class="code" href="../../d2/d4/struct__LOOKASIDE.html">LOOKASIDE</a> <a class="code" href="../../d5/d4/edecrare_8c.html#a5">EditLookaside</a>;
00018 
00019 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d8/d4/editec_8c.html#a10">ECFindTabA</a>(LPSTR lpstr, ICH cch);
00020 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d8/d4/editec_8c.html#a11">ECFindTabW</a>(LPWSTR lpstr, ICH cch);
00021 
<a name="l00022"></a><a class="code" href="../../d8/d4/editec_8c.html#a0">00022</a> <span class="preprocessor">#define umin(a, b)  ((unsigned)(a) &lt; (unsigned)(b) ? (unsigned)(a) : (unsigned)(b))</span>
<a name="l00023"></a><a class="code" href="../../d8/d4/editec_8c.html#a1">00023</a> <span class="preprocessor"></span><span class="preprocessor">#define umax(a, b)  ((unsigned)(a) &gt; (unsigned)(b) ? (unsigned)(a) : (unsigned)(b))</span>
00024 <span class="preprocessor"></span>
<a name="l00025"></a><a class="code" href="../../d8/d4/editec_8c.html#a2">00025</a> <span class="preprocessor">#define UNICODE_CARRIAGERETURN ((WCHAR)0x0d)</span>
<a name="l00026"></a><a class="code" href="../../d8/d4/editec_8c.html#a3">00026</a> <span class="preprocessor"></span><span class="preprocessor">#define UNICODE_LINEFEED ((WCHAR)0x0a)</span>
<a name="l00027"></a><a class="code" href="../../d8/d4/editec_8c.html#a4">00027</a> <span class="preprocessor"></span><span class="preprocessor">#define UNICODE_TAB ((WCHAR)0x09)</span>
00028 <span class="preprocessor"></span>
00029 
00030 <span class="comment">// IME Menu IDs</span>
<a name="l00031"></a><a class="code" href="../../d8/d4/editec_8c.html#a5">00031</a> <span class="preprocessor">#define ID_IMEOPENCLOSE      10001</span>
<a name="l00032"></a><a class="code" href="../../d8/d4/editec_8c.html#a6">00032</a> <span class="preprocessor"></span><span class="preprocessor">#define ID_SOFTKBDOPENCLOSE  10002</span>
<a name="l00033"></a><a class="code" href="../../d8/d4/editec_8c.html#a7">00033</a> <span class="preprocessor"></span><span class="preprocessor">#define ID_RECONVERTSTRING   10003</span>
00034 <span class="preprocessor"></span>
<a name="l00035"></a><a class="code" href="../../d5/d8/structEditMenuItemState.html">00035</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00036"></a><a class="code" href="../../d5/d8/structEditMenuItemState.html#o0">00036</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fDisableCut : 1;
<a name="l00037"></a><a class="code" href="../../d5/d8/structEditMenuItemState.html#o1">00037</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fDisablePaste : 1;
<a name="l00038"></a><a class="code" href="../../d5/d8/structEditMenuItemState.html#o2">00038</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fNeedSeparatorBeforeImeMenu : 1;
<a name="l00039"></a><a class="code" href="../../d5/d8/structEditMenuItemState.html#o3">00039</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fIME : 1;
00040 } <a class="code" href="../../d5/d8/structEditMenuItemState.html">EditMenuItemState</a>;
00041 
00042 <span class="comment">/***************************************************************************\</span>
00043 <span class="comment">* Handlers common to both single and multi line edit controls.</span>
00044 <span class="comment">/***************************************************************************/</span>
00045 
00046 <span class="comment">/***************************************************************************\</span>
00047 <span class="comment">* ECLock</span>
00048 <span class="comment">*</span>
00049 <span class="comment">* History:</span>
00050 <span class="comment">\***************************************************************************/</span>
00051 
<a name="l00052"></a><a class="code" href="../../d6/d0/usercli_8h.html#a433">00052</a> PSTR <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(
00053     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
00054 {
00055     PSTR ptext = <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a4">LOCALLOCK</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o87">hInstance</a>);
00056     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o90">iLockLevel</a>++;
00057 
00058     <span class="comment">/*</span>
00059 <span class="comment">     * If this is the first lock of the text and the text is encoded</span>
00060 <span class="comment">     * decode the text.</span>
00061 <span class="comment">     */</span>
00062     <span class="comment">//RIPMSG2(RIP_VERBOSE, "lock  : %d '%10s'\n", ped-&gt;iLockLevel, ptext);</span>
00063     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o90">iLockLevel</a> == 1 &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o89">fEncoded</a>) {
00064         <span class="comment">/*</span>
00065 <span class="comment">         * rtlrundecode can't handle zero length strings</span>
00066 <span class="comment">         */</span>
00067         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> != 0) {
00068             STRING string;
00069             string.Length = string.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>);
00070             string.Buffer = ptext;
00071 
00072             <a class="code" href="../../d8/d6/sertl_8c.html#a32">RtlRunDecodeUnicodeString</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o88">seed</a>, (PUNICODE_STRING)&amp;string);
00073             <span class="comment">//RIPMSG1(RIP_VERBOSE, "Decoding: '%10s'\n", ptext);</span>
00074         }
00075         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o89">fEncoded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00076     }
00077     <span class="keywordflow">return</span> ptext;
00078 }
00079 
00080 <span class="comment">/***************************************************************************\</span>
00081 <span class="comment">* ECUnlock</span>
00082 <span class="comment">*</span>
00083 <span class="comment">* History:</span>
00084 <span class="comment">\***************************************************************************/</span>
00085 
<a name="l00086"></a><a class="code" href="../../d6/d0/usercli_8h.html#a434">00086</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(
00087     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
00088 {
00089     <span class="comment">/*</span>
00090 <span class="comment">     * if we are removing the last lock on the text and the password</span>
00091 <span class="comment">     * character is set then encode the text</span>
00092 <span class="comment">     */</span>
00093     <span class="comment">//RIPMSG1(RIP_VERBOSE, "unlock: %d '%10s'\n", ped-&gt;iLockLevel, ped-&gt;ptext);</span>
00094     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o12">charPasswordChar</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o90">iLockLevel</a> == 1 &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> != 0) {
00095         UNICODE_STRING string;
00096         string.Length = string.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>);
00097         string.Buffer = <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a4">LOCALLOCK</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o87">hInstance</a>);
00098 
00099         <a class="code" href="../../d8/d6/sertl_8c.html#a31">RtlRunEncodeUnicodeString</a>(&amp;(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o88">seed</a>), &amp;string);
00100         <span class="comment">//RIPMSG1(RIP_VERBOSE, "Encoding: '%10s'\n", ped-&gt;ptext);</span>
00101         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o89">fEncoded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00102         <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a5">LOCALUNLOCK</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o87">hInstance</a>);
00103     }
00104     <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a5">LOCALUNLOCK</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o87">hInstance</a>);
00105     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o90">iLockLevel</a>--;
00106 }
00107 
00108 <span class="comment">/***************************************************************************\</span>
00109 <span class="comment">*</span>
00110 <span class="comment">*  GetActualNegA()</span>
00111 <span class="comment">*     For a given strip of text, this function computes the negative A width</span>
00112 <span class="comment">* for the whole strip and returns the value as a postive number.</span>
00113 <span class="comment">*     It also fills the NegAInfo structure with details about the postion</span>
00114 <span class="comment">* of this strip that results in this Negative A.</span>
00115 <span class="comment">*</span>
00116 <span class="comment">\***************************************************************************/</span>
<a name="l00117"></a><a class="code" href="../../d8/d4/editec_8c.html#a14">00117</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d8/d4/editec_8c.html#a14">GetActualNegA</a>(
00118     HDC hdc,
00119     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00120     <span class="keywordtype">int</span> x,
00121     LPSTR lpstring,
00122     ICH ichString,
00123     <span class="keywordtype">int</span> nCount,
00124     <a class="code" href="../../d6/d0/usercli_8h.html#a366">LPSTRIPINFO</a> NegAInfo)
00125 {
00126     <span class="keywordtype">int</span> iCharCount, i;
00127     <span class="keywordtype">int</span> iLeftmostPoint = x;
00128     PABC  pABCwidthBuff;
00129     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  wCharIndex;
00130     <span class="keywordtype">int</span> xStartPoint = x;
00131     ABC abc;
00132 
00133     <span class="comment">// To begin with, let us assume that there is no negative A width for</span>
00134     <span class="comment">// this strip and initialize accodingly.</span>
00135 
00136     NegAInfo-&gt;XStartPos = x;
00137     NegAInfo-&gt;lpString = lpstring;
00138     NegAInfo-&gt;nCount  = 0;
00139     NegAInfo-&gt;ichString = ichString;
00140 
00141     <span class="comment">// If the current font is not a TrueType font, then there can not be any</span>
00142     <span class="comment">// negative A widths.</span>
00143     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o41">fTrueType</a>) {
00144         <span class="keywordflow">if</span>(!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o69">charOverhang</a>) {
00145             <span class="keywordflow">return</span> 0;
00146         } <span class="keywordflow">else</span> {
00147             NegAInfo-&gt;nCount = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(nCount, (<span class="keywordtype">int</span>)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o77">wMaxNegAcharPos</a>);
00148             <span class="keywordflow">return</span> ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o69">charOverhang</a>;
00149         }
00150     }
00151 
00152     <span class="comment">// How many characters are to be considered for computing Negative A ?</span>
00153     iCharCount = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(nCount, (<span class="keywordtype">int</span>)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o77">wMaxNegAcharPos</a>);
00154 
00155     <span class="comment">// Do we have the info on individual character's widths?</span>
00156     <span class="keywordflow">if</span>(!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>) {
00157         <span class="comment">// No! So, let us tell them to consider all the characters.</span>
00158         NegAInfo-&gt;nCount = iCharCount;
00159         <span class="keywordflow">return</span>(iCharCount * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a>);
00160     }
00161 
00162     pABCwidthBuff = (PABC) ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>;
00163 
00164     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
00165         <span class="keywordflow">for</span> (i = 0; i &lt; iCharCount; i++) {
00166             wCharIndex = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(*((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)lpstring));
00167             <span class="keywordflow">if</span> (*lpstring == VK_TAB) {
00168                 <span class="comment">// To play it safe, we assume that this tab results in a tab length of</span>
00169                 <span class="comment">// 1 pixel because this is the minimum possible tab length.</span>
00170                 x++;
00171             } <span class="keywordflow">else</span> {
00172                 <span class="keywordflow">if</span> ( wCharIndex &lt; <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a> )
00173                     x += pABCwidthBuff[wCharIndex].abcA;  <span class="comment">// Add the 'A' width.</span>
00174                 <span class="keywordflow">else</span> {
00175                     GetCharABCWidthsA(hdc, wCharIndex, wCharIndex, &amp;abc) ;
00176                     x += abc.abcA;
00177                 }
00178 
00179                 <span class="keywordflow">if</span> (x &lt; iLeftmostPoint)
00180                     iLeftmostPoint = x;             <span class="comment">// Reset the leftmost point.</span>
00181                 <span class="keywordflow">if</span> (x &lt; xStartPoint)
00182                     NegAInfo-&gt;nCount = i+1;   <span class="comment">// 'i' is index; To get the count add 1.</span>
00183 
00184                 <span class="keywordflow">if</span> ( wCharIndex &lt; <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a> ) {
00185                     x += pABCwidthBuff[wCharIndex].abcB + pABCwidthBuff[wCharIndex].abcC;
00186                 } <span class="keywordflow">else</span> {
00187                     x += abc.abcB + abc.abcC;
00188                 }
00189             }
00190 
00191             lpstring++;
00192         }
00193     } <span class="keywordflow">else</span> {   <span class="comment">// Unicode</span>
00194         LPWSTR lpwstring = (LPWSTR) lpstring ;
00195 
00196         <span class="keywordflow">for</span> (i = 0; i &lt; iCharCount; i++) {
00197             wCharIndex = *lpwstring ;
00198             <span class="keywordflow">if</span> (*lpwstring == VK_TAB) {
00199                 <span class="comment">// To play it safe, we assume that this tab results in a tab length of</span>
00200                 <span class="comment">// 1 pixel because this is the minimum possible tab length.</span>
00201                 x++;
00202             } <span class="keywordflow">else</span> {
00203                 <span class="keywordflow">if</span> ( wCharIndex &lt; <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a> )
00204                     x += pABCwidthBuff[wCharIndex].abcA;  <span class="comment">// Add the 'A' width.</span>
00205                 <span class="keywordflow">else</span> {
00206                     GetCharABCWidthsW(hdc, wCharIndex, wCharIndex, &amp;abc) ;
00207                     x += abc.abcA ;
00208                 }
00209 
00210                 <span class="keywordflow">if</span> (x &lt; iLeftmostPoint)
00211                     iLeftmostPoint = x;             <span class="comment">// Reset the leftmost point.</span>
00212                 <span class="keywordflow">if</span> (x &lt; xStartPoint)
00213                     NegAInfo-&gt;nCount = i+1;   <span class="comment">// 'i' is index; To get the count add 1.</span>
00214 
00215                 <span class="keywordflow">if</span> ( wCharIndex &lt; <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a> )
00216                     x += pABCwidthBuff[wCharIndex].abcB +
00217                          pABCwidthBuff[wCharIndex].abcC;
00218                 <span class="keywordflow">else</span>
00219                     x += abc.abcB + abc.abcC ;
00220             }
00221 
00222             lpwstring++;
00223         }
00224     }
00225 
00226     <span class="comment">// Let us return the negative A for the whole strip as a positive value.</span>
00227     <span class="keywordflow">return</span>((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(xStartPoint - iLeftmostPoint));
00228 }
00229 
00230 
00231 <span class="comment">/***************************************************************************\</span>
00232 <span class="comment">*</span>
00233 <span class="comment">*  ECIsAncestorActive()</span>
00234 <span class="comment">*</span>
00235 <span class="comment">*  Returns whether or not we're the child of an "active" window.  Looks for</span>
00236 <span class="comment">*  the first parent window that has a caption.</span>
00237 <span class="comment">*</span>
00238 <span class="comment">*  This is a function because we might use it elsewhere when getting left</span>
00239 <span class="comment">*  clicked on, etc.</span>
00240 <span class="comment">*</span>
00241 <span class="comment">\***************************************************************************/</span>
<a name="l00242"></a><a class="code" href="../../d8/d4/editec_8c.html#a15">00242</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   <a class="code" href="../../d8/d4/editec_8c.html#a15">ECIsAncestorActive</a>(HWND hwnd)
00243 {
00244     <span class="comment">// We want to return TRUE always for top level windows.  That's because</span>
00245     <span class="comment">// of how WM_MOUSEACTIVATE works.  If we see the click at all, the</span>
00246     <span class="comment">// window is active.  However, if we reach a child ancestor that has</span>
00247     <span class="comment">// a caption, return the frame-on style bit.</span>
00248     <span class="comment">//</span>
00249     <span class="comment">// Note that calling FlashWindow() will have an effect.  If the user</span>
00250     <span class="comment">// clicks on an edit field in a child window that is flashed off, nothing</span>
00251     <span class="comment">// will happen unless the window stops flashing and ncactivates first.</span>
00252 
00253     <span class="keywordflow">while</span> (hwnd) {
00254         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>( hwnd );
00255         <span class="comment">//</span>
00256         <span class="comment">// Bail out if some parent window isn't 4.0 compatible or we've</span>
00257         <span class="comment">// reached the top.  Fixes compatibility problems with 3.x apps,</span>
00258         <span class="comment">// especially MFC samples.</span>
00259         <span class="comment">//</span>
00260         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>))
00261             hwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; <span class="comment">// to break us out of the loop</span>
00262         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a553">WFCPRESENT</a>))
00263             <span class="keywordflow">return</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a557">WFFRAMEON</a>) != 0);
00264         <span class="keywordflow">else</span>
00265             hwnd = <a class="code" href="../../d3/d9/client_2wow_8c.html#a13">GetParent</a>(hwnd);
00266     }
00267 
00268     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00269 }
00270 
00271 <span class="comment">/***************************************************************************\</span>
00272 <span class="comment"> * ECSetIMEMenu()</span>
00273 <span class="comment"> *</span>
00274 <span class="comment"> * support IME specific context menu</span>
00275 <span class="comment"> *</span>
00276 <span class="comment"> * Create: 30-Apr-97 Hiroyama : Ported from Memphis</span>
00277 <span class="comment">\***************************************************************************/</span>
<a name="l00278"></a><a class="code" href="../../d8/d4/editec_8c.html#a16">00278</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d4/editec_8c.html#a16">ECSetIMEMenu</a>(
00279     HMENU hMenu,
00280     HWND hwnd,
00281     <a class="code" href="../../d5/d8/structEditMenuItemState.html">EditMenuItemState</a> state)
00282 {
00283 
00284     MENUITEMINFO mii;
00285     HIMC hIMC;
00286     HKL hKL;
00287     HMENU hmenuSub;
00288     WCHAR szRes[32];
00289     <span class="keywordtype">int</span> nPrevLastItem;
00290     <span class="keywordtype">int</span> nItemsAdded = 0;
00291 
00292     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>() &amp;&amp; state.<a class="code" href="../../d5/d8/structEditMenuItemState.html#o3">fIME</a>);
00293 
00294     hKL = <a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>();
00295     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a312">fpImmIsIME</a>(hKL))
00296         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00297 
00298     hIMC = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>(hwnd);
00299     <span class="keywordflow">if</span> (hIMC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00300         <span class="comment">// early out</span>
00301         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00302     }
00303 
00304     hmenuSub = <a class="code" href="../../d3/d9/client_2wow_8c.html#a14">GetSubMenu</a>(hMenu, 0);
00305 
00306     <span class="keywordflow">if</span> (hmenuSub == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00307         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00308     }
00309 
00310     nPrevLastItem = <a class="code" href="../../d3/d9/client_2wow_8c.html#a8">GetMenuItemCount</a>(hmenuSub);
00311 
00312     <span class="keywordflow">if</span> (hIMC) {
00313         <span class="keywordflow">if</span> (LOWORD(HandleToUlong(hKL)) != 0x412) {
00314             <span class="comment">//</span>
00315             <span class="comment">// If Korean, do not show open/close menus</span>
00316             <span class="comment">//</span>
00317             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a336">fpImmGetOpenStatus</a>(hIMC))
00318                 LoadString(<a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a161">STR_IMECLOSE</a>, szRes, <span class="keyword">sizeof</span>(szRes));
00319             <span class="keywordflow">else</span>
00320                 LoadString(<a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a160">STR_IMEOPEN</a>, szRes, <span class="keyword">sizeof</span>(szRes));
00321 
00322             mii.cbSize = <span class="keyword">sizeof</span>(MENUITEMINFO);
00323             mii.fMask = MIIM_STRING | MIIM_ID;
00324             mii.dwTypeData = szRes;
00325             mii.cch = 0xffff;
00326             mii.wID = <a class="code" href="../../d8/d4/editec_8c.html#a5">ID_IMEOPENCLOSE</a>;
00327             <a class="code" href="../../d5/d9/cltxt_8h.html#a31">InsertMenuItem</a>(hmenuSub, 0xffff, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;mii);
00328             ++nItemsAdded;
00329         }
00330 
00331         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a342">fpImmGetProperty</a>(hKL, IGP_CONVERSION) &amp; IME_CMODE_SOFTKBD) {
00332             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fdwConversion;
00333 
00334             <a class="code" href="../../d6/d0/usercli_8h.html#a330">fpImmGetConversionStatus</a>(hIMC, &amp;fdwConversion, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00335 
00336             <span class="keywordflow">if</span> (fdwConversion &amp; IME_CMODE_SOFTKBD)
00337                LoadString(<a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a163">STR_SOFTKBDCLOSE</a>, szRes, <span class="keyword">sizeof</span>(szRes));
00338             <span class="keywordflow">else</span>
00339                LoadString(<a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a162">STR_SOFTKBDOPEN</a>, szRes, <span class="keyword">sizeof</span>(szRes));
00340 
00341             mii.cbSize = <span class="keyword">sizeof</span>(MENUITEMINFO);
00342             mii.fMask = MIIM_STRING | MIIM_ID;
00343             mii.dwTypeData = szRes;
00344             mii.cch = 0xffff;
00345             mii.wID = <a class="code" href="../../d8/d4/editec_8c.html#a6">ID_SOFTKBDOPENCLOSE</a>;
00346             <a class="code" href="../../d5/d9/cltxt_8h.html#a31">InsertMenuItem</a>(hmenuSub, 0xffff, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;mii);
00347             ++nItemsAdded;
00348         }
00349 
00350         <span class="keywordflow">if</span> (LOWORD(HandleToUlong(hKL)) != 0x412) {
00351             <span class="comment">//</span>
00352             <span class="comment">// If Korean, do not show reconversion menus</span>
00353             <span class="comment">//</span>
00354             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSCS = <a class="code" href="../../d6/d0/usercli_8h.html#a342">fpImmGetProperty</a>(hKL, IGP_SETCOMPSTR);
00355 
00356             LoadString(<a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a164">STR_RECONVERTSTRING</a>, szRes, <span class="keyword">sizeof</span>(szRes));
00357 
00358             mii.cbSize = <span class="keyword">sizeof</span>(MENUITEMINFO);
00359             mii.fMask = MIIM_STRING | MIIM_ID | MIIM_STATE;
00360             mii.dwTypeData = szRes;
00361             mii.fState = 0;
00362             mii.cch = 0xffff;
00363             mii.wID = <a class="code" href="../../d8/d4/editec_8c.html#a7">ID_RECONVERTSTRING</a>;
00364 
00365             <span class="keywordflow">if</span> (state.<a class="code" href="../../d5/d8/structEditMenuItemState.html#o0">fDisableCut</a> ||
00366                     !(dwSCS &amp; SCS_CAP_SETRECONVERTSTRING) ||
00367                     !(dwSCS &amp; SCS_CAP_MAKEREAD)) {
00368                 mii.fState |= MFS_GRAYED;
00369             }
00370 
00371             <a class="code" href="../../d5/d9/cltxt_8h.html#a31">InsertMenuItem</a>(hmenuSub, 0xffff, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;mii);
00372             ++nItemsAdded;
00373         }
00374     }
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">// Add or remove the menu separator</span>
00378     <span class="comment">//</span>
00379     <span class="keywordflow">if</span> (state.<a class="code" href="../../d5/d8/structEditMenuItemState.html#o2">fNeedSeparatorBeforeImeMenu</a> &amp;&amp; nItemsAdded != 0) {
00380         <span class="comment">//</span>
00381         <span class="comment">// If the menu for Middle East has left a separator,</span>
00382         <span class="comment">// fNeedSeparatorBeforeImeMenu is FALSE.</span>
00383         <span class="comment">// I.e. we don't need to add more.</span>
00384         <span class="comment">//</span>
00385         mii.cbSize = <span class="keyword">sizeof</span>(MENUITEMINFO);
00386         mii.fMask = MIIM_FTYPE;
00387         mii.fType = MFT_SEPARATOR;
00388         <a class="code" href="../../d5/d9/cltxt_8h.html#a31">InsertMenuItem</a>(hmenuSub, nPrevLastItem, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;mii);
00389     }
00390     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!state.<a class="code" href="../../d5/d8/structEditMenuItemState.html#o2">fNeedSeparatorBeforeImeMenu</a> &amp;&amp; nItemsAdded == 0) {
00391         <span class="comment">//</span>
00392         <span class="comment">// Extra separator is left by ME menus. Remove it.</span>
00393         <span class="comment">//</span>
00394         UserVerify(<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a154">NtUserDeleteMenu</a>(hmenuSub, nPrevLastItem - 1, MF_BYPOSITION));
00395     }
00396 
00397     <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(hwnd, hIMC);
00398 
00399     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00400 }
00401 
<a name="l00402"></a><a class="code" href="../../d6/d0/usercli_8h.html#a477">00402</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a477">ECInOutReconversionMode</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, BOOL fIn)
00403 {
00404     UserAssert(fIn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || fIn == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00405     <span class="keywordflow">if</span> (fIn == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o57">fInReconversion</a>) {
00406         <span class="keywordflow">return</span>;
00407     }
00408     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o57">fInReconversion</a> = fIn;
00409     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a>) {
00410         (fIn ? <a class="code" href="../../d0/d0/ntuser_8h.html#a106">NtUserHideCaret</a>: <a class="code" href="../../d0/d0/ntuser_8h.html#a138">NtUserShowCaret</a>)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
00411     }
00412 
00413     <span class="keywordflow">return</span>;
00414 }
00415 
00416 <span class="comment">/***************************************************************************\</span>
00417 <span class="comment"> * ECDoIMEMenuCommand()</span>
00418 <span class="comment"> *</span>
00419 <span class="comment"> * support IME specific context menu</span>
00420 <span class="comment"> *</span>
00421 <span class="comment"> * Create: 30-Apr-97 Hiroyama : Ported from Memphis</span>
00422 <span class="comment">\***************************************************************************/</span>
<a name="l00423"></a><a class="code" href="../../d8/d4/editec_8c.html#a18">00423</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> NEAR <a class="code" href="../../d8/d4/editec_8c.html#a18">ECDoIMEMenuCommand</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, <span class="keywordtype">int</span> cmd, HWND hwnd)
00424 {
00425     HIMC hIMC;
00426 
00427     <span class="comment">// early out</span>
00428     <span class="keywordflow">switch</span> (cmd) {
00429     <span class="keywordflow">case</span> <a class="code" href="../../d8/d4/editec_8c.html#a5">ID_IMEOPENCLOSE</a>:
00430     <span class="keywordflow">case</span> <a class="code" href="../../d8/d4/editec_8c.html#a6">ID_SOFTKBDOPENCLOSE</a>:
00431     <span class="keywordflow">case</span> <a class="code" href="../../d8/d4/editec_8c.html#a7">ID_RECONVERTSTRING</a>:
00432         <span class="keywordflow">break</span>;
00433     <span class="keywordflow">default</span>:
00434         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00435     }
00436 
00437     <span class="comment">// everybody needs hIMC, so get it here</span>
00438     hIMC = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>(hwnd);
00439     <span class="keywordflow">if</span> (hIMC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00440         <span class="comment">// indicate to caller, that no further command processing needed</span>
00441         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00442     }
00443 
00444     <span class="keywordflow">switch</span> (cmd) {
00445     <span class="keywordflow">case</span> <a class="code" href="../../d8/d4/editec_8c.html#a5">ID_IMEOPENCLOSE</a>:
00446         {
00447             <span class="comment">// switch IME Open/Close status</span>
00448             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fOpen = <a class="code" href="../../d6/d0/usercli_8h.html#a336">fpImmGetOpenStatus</a>(hIMC);
00449 
00450             <a class="code" href="../../d6/d0/usercli_8h.html#a325">fpImmSetOpenStatus</a>(hIMC, !fOpen);
00451         }
00452         <span class="keywordflow">break</span>;
00453 
00454     <span class="keywordflow">case</span> <a class="code" href="../../d8/d4/editec_8c.html#a6">ID_SOFTKBDOPENCLOSE</a>:
00455         {
00456             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fdwConversion;
00457 
00458             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a330">fpImmGetConversionStatus</a>(hIMC, &amp;fdwConversion, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00459                 <span class="comment">//</span>
00460                 <span class="comment">// Toggle soft keyboard Open/Close status</span>
00461                 <span class="comment">//</span>
00462                 <a class="code" href="../../d6/d0/usercli_8h.html#a345">fpImmEnumInputContext</a>(0, <a class="code" href="../../d9/d9/imectl_8c.html#a35">SyncSoftKbdState</a>,
00463                         (fdwConversion &amp; IME_CMODE_SOFTKBD) != IME_CMODE_SOFTKBD);
00464             }
00465         }
00466         <span class="keywordflow">break</span>;
00467 
00468     <span class="keywordflow">case</span> <a class="code" href="../../d8/d4/editec_8c.html#a7">ID_RECONVERTSTRING</a>:
00469         {
00470             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwStrLen; <span class="comment">// holds TCHAR count of recionversion string</span>
00471             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbLen;    <span class="comment">// holds BYTE SIZE of reconversion string</span>
00472             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;
00473             LPRECONVERTSTRING lpRCS;
00474 
00475             <span class="comment">// pass current selection to IME for reconversion</span>
00476             dwStrLen = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
00477             cbLen = dwStrLen * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
00478             dwSize = cbLen + <span class="keyword">sizeof</span>(RECONVERTSTRING) + 8;
00479 
00480             lpRCS = (LPRECONVERTSTRING)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, dwSize);
00481 
00482             <span class="keywordflow">if</span> (lpRCS) {
00483                 LPBYTE pText;
00484 
00485                 pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
00486                 <span class="keywordflow">if</span> (pText != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00487                     LPBYTE <a class="code" href="../../d6/d3/kcodecnv_8c.html#a4">lpDest</a>;
00488                     <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (WINAPI* fpSetCompositionStringAW)(HIMC, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, LPCVOID, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, LPCVOID, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00489 
00490                     lpRCS-&gt;dwSize = dwSize;
00491                     lpRCS-&gt;dwVersion = 0;
00492 
00493                     lpRCS-&gt;dwStrLen =
00494                     lpRCS-&gt;dwCompStrLen =
00495                     lpRCS-&gt;dwTargetStrLen = dwStrLen;
00496 
00497                     lpRCS-&gt;dwStrOffset = <span class="keyword">sizeof</span>(RECONVERTSTRING);
00498                     lpRCS-&gt;dwCompStrOffset =
00499                     lpRCS-&gt;dwTargetStrOffset = 0;
00500 
00501                     <a class="code" href="../../d6/d3/kcodecnv_8c.html#a4">lpDest</a> = (LPBYTE)lpRCS + <span class="keyword">sizeof</span>(RECONVERTSTRING);
00502 
00503                     RtlCopyMemory(<a class="code" href="../../d6/d3/kcodecnv_8c.html#a4">lpDest</a>, pText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, cbLen);
00504                     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
00505                         LPBYTE psz = (LPBYTE)<a class="code" href="../../d6/d3/kcodecnv_8c.html#a4">lpDest</a>;
00506                         psz[cbLen] = <span class="charliteral">'\0'</span>;
00507                         fpSetCompositionStringAW = <a class="code" href="../../d6/d0/usercli_8h.html#a343">fpImmSetCompositionStringA</a>;
00508                     } <span class="keywordflow">else</span> {
00509                         LPWSTR pwsz = (LPWSTR)<a class="code" href="../../d6/d3/kcodecnv_8c.html#a4">lpDest</a>;
00510                         pwsz[dwStrLen] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00511                         fpSetCompositionStringAW = <a class="code" href="../../d6/d0/usercli_8h.html#a344">fpImmSetCompositionStringW</a>;
00512                     }
00513 
00514                     <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
00515 
00516                     UserAssert(fpSetCompositionStringAW != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00517 
00518                     <a class="code" href="../../d6/d0/usercli_8h.html#a477">ECInOutReconversionMode</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00519                     <a class="code" href="../../d6/d0/usercli_8h.html#a471">ECImmSetCompositionWindow</a>(ped, 0, 0); <span class="comment">// x and y will be overriden anyway</span>
00520                     fpSetCompositionStringAW(hIMC, SCS_SETRECONVERTSTRING, lpRCS, dwSize, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00521                 } <span class="comment">// pText</span>
00522                 <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpRCS);
00523             }
00524         }
00525         <span class="keywordflow">break</span>;
00526 
00527     <span class="keywordflow">default</span>:
00528         <span class="comment">// should never reach here.</span>
00529         RIPMSG1(RIP_ERROR, <span class="stringliteral">"ECDoIMEMenuCommand: unknown command id %d; should never reach here."</span>, cmd);
00530         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00531     }
00532 
00533     UserAssert(hIMC != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00534     <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(hwnd, hIMC);
00535 
00536     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00537 }
00538 
00539 <span class="comment">/***************************************************************************\</span>
00540 <span class="comment">*</span>
00541 <span class="comment">*  ECMenu()</span>
00542 <span class="comment">*</span>
00543 <span class="comment">*  Handles context menu for edit fields.  Disables inappropriate commands.</span>
00544 <span class="comment">*  Note that this is NOT subclassing friendly, like most of our functions,</span>
00545 <span class="comment">*  for speed and convenience.</span>
00546 <span class="comment">*</span>
00547 <span class="comment">\***************************************************************************/</span>
<a name="l00548"></a><a class="code" href="../../d8/d4/editec_8c.html#a19">00548</a> <span class="keywordtype">void</span>  <a class="code" href="../../d8/d4/editec_8c.html#a19">ECMenu</a>(
00549     HWND hwnd,
00550     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00551     LPPOINT pt)
00552 {
00553     HMENU   hMenu;
00554     <span class="keywordtype">int</span>     cmd = 0;
00555     <span class="keywordtype">int</span>     x;
00556     <span class="keywordtype">int</span>     y;
00557     <a class="code" href="../../d5/d8/structEditMenuItemState.html">EditMenuItemState</a> state = {
00558         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,              <span class="comment">// fDisableCut</span>
00559         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,               <span class="comment">// fDisablePaste</span>
00560         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,               <span class="comment">// fNeedSeparatorBeforeImeMenu</span>
00561         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>() &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a312">fpImmIsIME</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>()), <span class="comment">// fIME</span>
00562     };
00563 
00564     <span class="comment">// Set focus if we don't have it.</span>
00565     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a>)
00566         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a225">NtUserSetFocus</a>(hwnd);
00567 
00568     <span class="comment">// Grab the menu from USER's resources...</span>
00569     <span class="keywordflow">if</span> (!(hMenu = LoadMenu( <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>, MAKEINTRESOURCE( <a class="code" href="../../d6/d0/usercli_8h.html#a155">ID_EC_PROPERTY_MENU</a> ))))
00570         <span class="keywordflow">return</span> ;
00571 
00572 
00573     <span class="comment">// Undo -- not allowed if we have no saved undo info</span>
00574     <span class="keywordflow">if</span> (ped-&gt;undoType == <a class="code" href="../../d6/d0/usercli_8h.html#a82">UNDO_NONE</a>)
00575         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hMenu, WM_UNDO, MF_BYCOMMAND | MFS_GRAYED);
00576 
00577     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o39">fReadOnly</a> || ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o12">charPasswordChar</a>) {
00578         <span class="comment">// Cut and Delete -- not allowed if read-only or password</span>
00579         state.<a class="code" href="../../d5/d8/structEditMenuItemState.html#o0">fDisableCut</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00580     } <span class="keywordflow">else</span> {
00581         <span class="comment">// Cut, Delete -- not allowed if there's no selection</span>
00582         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>)
00583             state.<a class="code" href="../../d5/d8/structEditMenuItemState.html#o0">fDisableCut</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00584     }
00585     <span class="comment">// Paste -- not allowed if there's no text on the clipboard</span>
00586     <span class="comment">// (this works for both OEM and Unicode)</span>
00587     <span class="comment">// Used to be always disabled for password edits MCostea #221035</span>
00588 
00589     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a207">NtUserIsClipboardFormatAvailable</a>(CF_TEXT))
00590         state.<a class="code" href="../../d5/d8/structEditMenuItemState.html#o1">fDisablePaste</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00591 
00592     <span class="keywordflow">if</span> (state.<a class="code" href="../../d5/d8/structEditMenuItemState.html#o0">fDisableCut</a>) {
00593         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hMenu, WM_CUT,   MF_BYCOMMAND | MFS_GRAYED);
00594         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hMenu, WM_CLEAR, MF_BYCOMMAND | MFS_GRAYED);
00595     }
00596 
00597     <span class="keywordflow">if</span> (state.<a class="code" href="../../d5/d8/structEditMenuItemState.html#o1">fDisablePaste</a>)
00598         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hMenu, WM_PASTE, MF_BYCOMMAND | MFS_GRAYED);
00599 
00600     <span class="comment">// Copy -- not allowed if there's no selection or password ec</span>
00601     <span class="keywordflow">if</span> ((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>) || (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o12">charPasswordChar</a>))
00602         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hMenu, WM_COPY, MF_BYCOMMAND | MFS_GRAYED);
00603 
00604     <span class="comment">// Select All -- not allowed if there's no text or if everything is</span>
00605     <span class="comment">// selected.   Latter case takes care of first one.</span>
00606     <span class="keywordflow">if</span> ((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> == 0) &amp;&amp; (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>))
00607         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hMenu, EM_SETSEL, MF_BYCOMMAND | MFS_GRAYED);
00608 
00609     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
00610         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o10">EditSetMenu</a>(ped, hMenu);
00611     } <span class="keywordflow">else</span> {
00612         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a154">NtUserDeleteMenu</a>(hMenu, <a class="code" href="../../d6/d0/usercli_8h.html#a89">ID_CNTX_DISPLAYCTRL</a>, MF_BYCOMMAND);
00613         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a154">NtUserDeleteMenu</a>(hMenu, <a class="code" href="../../d6/d0/usercli_8h.html#a88">ID_CNTX_RTL</a>,         MF_BYCOMMAND);
00614         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a154">NtUserDeleteMenu</a>(hMenu, <a class="code" href="../../d6/d0/usercli_8h.html#a90">ID_CNTX_INSERTCTRL</a>,  MF_BYCOMMAND);
00615 
00616         <span class="keywordflow">if</span> (state.<a class="code" href="../../d5/d8/structEditMenuItemState.html#o3">fIME</a>) {
00617             <span class="comment">// One separator is left in the menu,</span>
00618             <span class="comment">// no need to add the one before IME menus</span>
00619             state.<a class="code" href="../../d5/d8/structEditMenuItemState.html#o2">fNeedSeparatorBeforeImeMenu</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00620         } <span class="keywordflow">else</span> {
00621             <span class="comment">// Extra separator is left. Remove it.</span>
00622             HMENU hmenuSub = <a class="code" href="../../d3/d9/client_2wow_8c.html#a14">GetSubMenu</a>(hMenu, 0);
00623             <span class="keywordtype">int</span> nItems = <a class="code" href="../../d3/d9/client_2wow_8c.html#a8">GetMenuItemCount</a>(hmenuSub) - 1;
00624 
00625             UserAssert(nItems &gt;= 0);
00626             UserAssert(<a class="code" href="../../d3/d9/client_2wow_8c.html#a10">GetMenuState</a>(hmenuSub, nItems, MF_BYPOSITION) &amp; MF_SEPARATOR);
00627             <span class="comment">// remove needless separator</span>
00628             UserVerify(<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a154">NtUserDeleteMenu</a>(hmenuSub, nItems, MF_BYPOSITION));
00629         }
00630     }
00631 
00632     <span class="comment">// IME specific menu</span>
00633     <span class="keywordflow">if</span> (state.<a class="code" href="../../d5/d8/structEditMenuItemState.html#o3">fIME</a>) {
00634         <a class="code" href="../../d8/d4/editec_8c.html#a16">ECSetIMEMenu</a>(hMenu, hwnd, state);
00635     }
00636 
00637     <span class="comment">// BOGUS</span>
00638     <span class="comment">// We position the menu below &amp; to the right of the point clicked on.</span>
00639     <span class="comment">// Is this cool?  I think so.  Excel 4.0 does the same thing.  It</span>
00640     <span class="comment">// seems like it would be neat if we could avoid obscuring the</span>
00641     <span class="comment">// selection.  But in actuality, it seems even more awkward to move</span>
00642     <span class="comment">// the menu out of the way of the selection.  The user can't click</span>
00643     <span class="comment">// and drag that way, and they have to move the mouse a ton.</span>
00644     <span class="comment">//</span>
00645     <span class="comment">// We need to use TPM_NONOTIFY because VBRUN100 and VBRUN200 GP-fault</span>
00646     <span class="comment">// on unexpected menu messages.</span>
00647     <span class="comment">//</span>
00648 
00649     <span class="comment">/*</span>
00650 <span class="comment">     *  if message came via the keyboard then center on the control</span>
00651 <span class="comment">     *  We use -1 &amp;&amp; -1 here not 0xFFFFFFFF like Win95 becuase we</span>
00652 <span class="comment">     *  previously converted the lParam to a point with sign extending.</span>
00653 <span class="comment">     */</span>
00654     <span class="keywordflow">if</span> (pt-&gt;x == -1 &amp;&amp; pt-&gt;y == -1) {
00655         RECT rc;
00656 
00657         <a class="code" href="../../d3/d9/client_2wow_8c.html#a26">GetWindowRect</a>(hwnd, &amp;rc);
00658         x = rc.left + (rc.right - rc.left) / 2;
00659         y = rc.top + (rc.bottom - rc.top) / 2;
00660     } <span class="keywordflow">else</span> {
00661         x = pt-&gt;x;
00662         y = pt-&gt;y;
00663     }
00664 
00665     cmd = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a239">NtUserTrackPopupMenuEx</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a14">GetSubMenu</a>(hMenu, 0), TPM_NONOTIFY |
00666         TPM_LEFTALIGN | TPM_TOPALIGN | TPM_RETURNCMD | TPM_RIGHTBUTTON,
00667         x, y, hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00668 
00669     <span class="comment">// Free our menu</span>
00670     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a158">NtUserDestroyMenu</a>(hMenu);
00671 
00672     <span class="keywordflow">if</span> (cmd &amp;&amp; (cmd != -1)) {
00673         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a> &amp;&amp; cmd) {
00674             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o11">EditProcessMenu</a>(ped, cmd);
00675         }
00676         <span class="keywordflow">if</span> (!state.<a class="code" href="../../d5/d8/structEditMenuItemState.html#o3">fIME</a> || !<a class="code" href="../../d8/d4/editec_8c.html#a18">ECDoIMEMenuCommand</a>(ped, cmd, hwnd)) {
00677             <span class="comment">// if cmd is not IME specific menu, send it.</span>
00678             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwnd, cmd, 0, (cmd == EM_SETSEL) ? 0xFFFFFFFF : 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> );
00679         }
00680     }
00681 }
00682 
00683 
00684 
00685 <span class="comment">/***************************************************************************\</span>
00686 <span class="comment">*</span>
00687 <span class="comment">*  ECClearText()</span>
00688 <span class="comment">*</span>
00689 <span class="comment">*  Clears selected text.  Does NOT _send_ a fake char backspace.</span>
00690 <span class="comment">*</span>
00691 <span class="comment">\***************************************************************************/</span>
<a name="l00692"></a><a class="code" href="../../d8/d4/editec_8c.html#a20">00692</a> <span class="keywordtype">void</span>   <a class="code" href="../../d8/d4/editec_8c.html#a20">ECClearText</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped) {
00693     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o39">fReadOnly</a> &amp;&amp;
00694         (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>)) {
00695         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a>)
00696             <a class="code" href="../../d6/d0/usercli_8h.html#a542">SLEditWndProc</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, ped, WM_CHAR, VK_BACK, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> );
00697         <span class="keywordflow">else</span>
00698             <a class="code" href="../../d6/d0/usercli_8h.html#a502">MLEditWndProc</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, ped, WM_CHAR, VK_BACK, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> );
00699     }
00700 
00701 }
00702 
00703 
00704 <span class="comment">/***************************************************************************\</span>
00705 <span class="comment">*</span>
00706 <span class="comment">*  ECCutText() -</span>
00707 <span class="comment">*</span>
00708 <span class="comment">*  Cuts selected text.  This removes and copies the selection to the clip,</span>
00709 <span class="comment">*  or if nothing is selected we delete (clear) the left character.</span>
00710 <span class="comment">*</span>
00711 <span class="comment">\***************************************************************************/</span>
<a name="l00712"></a><a class="code" href="../../d8/d4/editec_8c.html#a21">00712</a> <span class="keywordtype">void</span>   <a class="code" href="../../d8/d4/editec_8c.html#a21">ECCutText</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped) {
00713     <span class="comment">// Cut selection--IE, remove and copy to clipboard, or if no selection,</span>
00714     <span class="comment">// delete (clear) character left.</span>
00715     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o39">fReadOnly</a> &amp;&amp;
00716         (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>) &amp;&amp;
00717         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, WM_COPY, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) {
00718         <span class="comment">// If copy was successful, delete the copied text by sending a</span>
00719         <span class="comment">// backspace message which will redraw the text and take care of</span>
00720         <span class="comment">// notifying the parent of changes.</span>
00721         <a class="code" href="../../d8/d4/editec_8c.html#a20">ECClearText</a>(ped);
00722     }
00723 }
00724 
00725 <span class="comment">/***************************************************************************\</span>
00726 <span class="comment">*</span>
00727 <span class="comment">*  ECGetModKeys()</span>
00728 <span class="comment">*</span>
00729 <span class="comment">*  Gets modifier key states.  Currently, we only check for VK_CONTROL and</span>
00730 <span class="comment">*  VK_SHIFT.</span>
00731 <span class="comment">*</span>
00732 <span class="comment">\***************************************************************************/</span>
<a name="l00733"></a><a class="code" href="../../d6/d0/usercli_8h.html#a481">00733</a> <span class="keywordtype">int</span>   <a class="code" href="../../d6/d0/usercli_8h.html#a481">ECGetModKeys</a>(<span class="keywordtype">int</span> keyMods) {
00734     <span class="keywordtype">int</span> scState;
00735 
00736     scState = 0;
00737 
00738     <span class="keywordflow">if</span> (!keyMods) {
00739         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_CONTROL) &lt; 0)
00740             scState |= <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a>;
00741         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_SHIFT) &lt; 0)
00742             scState |= <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>;
00743     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (keyMods != <a class="code" href="../../d6/d0/usercli_8h.html#a80">NOMODIFY</a>)
00744         scState = keyMods;
00745 
00746     <span class="keywordflow">return</span> scState;
00747 }
00748 
00749 <span class="comment">/***************************************************************************\</span>
00750 <span class="comment">*</span>
00751 <span class="comment">*  ECTabTheTextOut() AorW</span>
00752 <span class="comment">*    If fDrawText == FALSE, then this function returns the text extent of</span>
00753 <span class="comment">*  of the given strip of text. It does not worry about the Negative widths.</span>
00754 <span class="comment">*</span>
00755 <span class="comment">*    If fDrawText == TRUE, this draws the given strip of Text expanding the</span>
00756 <span class="comment">*  tabs to proper lengths, calculates and fills up the NegCInfoForStrip with</span>
00757 <span class="comment">*  details required to draw the portions of this strip that goes beyond the</span>
00758 <span class="comment">*  xClipEndPos due to Negative C widths.</span>
00759 <span class="comment">*</span>
00760 <span class="comment">*  Returns the max width AS A DWORD.  We don't care about the height</span>
00761 <span class="comment">*  at all.  No one uses it.  We keep a DWORD because that way we avoid</span>
00762 <span class="comment">*  overflow.</span>
00763 <span class="comment">*</span>
00764 <span class="comment">*  NOTE: If the language pack is loaded EcTabTheTextOut is not used - the</span>
00765 <span class="comment">*  language pack must take care of all tab expansion and selection</span>
00766 <span class="comment">*  highlighting with full support for bidi layout and complex script</span>
00767 <span class="comment">*  glyph reordering.</span>
00768 <span class="comment">*</span>
00769 <span class="comment">\***************************************************************************/</span>
<a name="l00770"></a><a class="code" href="../../d6/d0/usercli_8h.html#a478">00770</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d0/usercli_8h.html#a478">ECTabTheTextOut</a>(
00771     HDC hdc,
00772     <span class="keywordtype">int</span> xClipStPos,
00773     <span class="keywordtype">int</span> xClipEndPos,
00774     <span class="keywordtype">int</span> xStart,
00775     <span class="keywordtype">int</span> y,
00776     LPSTR lpstring,
00777     <span class="keywordtype">int</span> nCount,
00778     ICH ichString,
00779     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00780     <span class="keywordtype">int</span> iTabOrigin,
00781     BOOL fDraw,
00782     LPSTRIPINFO NegCInfoForStrip)
00783 {
00784     <span class="keywordtype">int</span>     nTabPositions;         <span class="comment">// Count of tabstops in tabstop array.</span>
00785     LPINT   lpintTabStopPositions; <span class="comment">// Tab stop positions in pixels.</span>
00786 
00787     <span class="keywordtype">int</span>     cch;
00788     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    textextent;
00789     <span class="keywordtype">int</span>     xEnd;
00790     <span class="keywordtype">int</span>     pixeltabstop = 0;
00791     <span class="keywordtype">int</span>     i;
00792     <span class="keywordtype">int</span>     cxCharWidth;
00793     RECT    rc;
00794     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fOpaque;
00795     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fFirstPass = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00796     <a class="code" href="../../d9/d5/ndismain_8h.html#a264">PINT</a>    charWidthBuff;
00797 
00798     <span class="keywordtype">int</span>     iTabLength;
00799     <span class="keywordtype">int</span>     nConsecutiveTabs;
00800     <span class="keywordtype">int</span>     xStripStPos;
00801     <span class="keywordtype">int</span>     xStripEndPos;
00802     <span class="keywordtype">int</span>     xEndOfStrip;
00803     <a class="code" href="../../d6/d7/structSTRIPINFO.html">STRIPINFO</a>  RedrawStripInfo;
00804     <a class="code" href="../../d6/d7/structSTRIPINFO.html">STRIPINFO</a>  NegAInfo;
00805     LPSTR    lpTab;
00806     LPWSTR   lpwTab;
00807     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>     wNegCwidth, wNegAwidth;
00808     <span class="keywordtype">int</span>      xRightmostPoint = xClipStPos;
00809     <span class="keywordtype">int</span>      xTabStartPos;
00810     <span class="keywordtype">int</span>      iSavedBkMode = 0;
00811     WCHAR    wchar;
00812     SIZE     size;
00813     ABC   abc ;
00814 
00815     <span class="comment">// Algorithm: Draw the strip opaquely first. If a tab length is so</span>
00816     <span class="comment">// small that the portions of text on either side of a tab overlap with</span>
00817     <span class="comment">// the other, then this will result in some clipping. So, such portion</span>
00818     <span class="comment">// of the strip is remembered in "RedrawStripInfo" and redrawn</span>
00819     <span class="comment">// transparently later to compensate the clippings.</span>
00820     <span class="comment">//    NOTE: "RedrawStripInfo" can hold info about just one portion. So, if</span>
00821     <span class="comment">// more than one portion of the strip needs to be redrawn transparently,</span>
00822     <span class="comment">// then we "merge" all such portions into a single strip and redraw that</span>
00823     <span class="comment">// strip at the end.</span>
00824 
00825     <span class="keywordflow">if</span> (fDraw) {
00826         <span class="comment">// To begin with, let us assume that there is no Negative C for this</span>
00827         <span class="comment">// strip and initialize the Negative Width Info structure.</span>
00828         NegCInfoForStrip-&gt;nCount = 0;
00829         NegCInfoForStrip-&gt;XStartPos = xClipEndPos;
00830 
00831         <span class="comment">// We may not have to redraw any portion of this strip.</span>
00832         RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o2">nCount</a> = 0;
00833 
00834         fOpaque = (GetBkMode(hdc) == OPAQUE) || (fDraw == <a class="code" href="../../d6/d0/usercli_8h.html#a148">ECT_SELECTED</a>);
00835     }
00836 <span class="preprocessor">#if DBG</span>
00837 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
00838         <span class="comment">//</span>
00839         <span class="comment">// Both MLGetLineWidth() and ECCchInWidth() should be clipping</span>
00840         <span class="comment">// nCount to avoid overflow.</span>
00841         <span class="comment">//</span>
00842         <span class="keywordflow">if</span> (nCount &gt; <a class="code" href="../../d6/d0/usercli_8h.html#a74">MAXLINELENGTH</a>)
00843             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ECTabTheTextOut: nCount &gt; MAXLINELENGTH"</span>);
00844     }
00845 <span class="preprocessor">#endif</span>
00846 <span class="preprocessor"></span>
00847     <span class="comment">// Let us define the Clip rectangle.</span>
00848     rc.left   = xClipStPos;
00849     rc.right  = xClipEndPos;
00850     rc.top    = y;
00851     rc.bottom = y + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>;
00852 
00853     <span class="comment">// Check if anything needs to be drawn.</span>
00854     <span class="keywordflow">if</span> (!lpstring || !nCount) {
00855         <span class="keywordflow">if</span> (fDraw)
00856             ExtTextOutW(hdc, xClipStPos, y,
00857                   (fOpaque ? ETO_OPAQUE | ETO_CLIPPED : ETO_CLIPPED),
00858                   &amp;rc, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00859         <span class="keywordflow">return</span>(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00860     }
00861 
00862     <span class="comment">//</span>
00863     <span class="comment">// Starting position</span>
00864     <span class="comment">//</span>
00865     xEnd = xStart;
00866 
00867     cxCharWidth  = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a>;
00868 
00869     nTabPositions = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o73">pTabStops</a> ? *(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o73">pTabStops</a>) : 0);
00870     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o73">pTabStops</a>) {
00871         lpintTabStopPositions = (LPINT)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o73">pTabStops</a>+1);
00872         <span class="keywordflow">if</span> (nTabPositions == 1) {
00873             pixeltabstop = lpintTabStopPositions[0];
00874             <span class="keywordflow">if</span> (!pixeltabstop)
00875                 pixeltabstop = 1;
00876         }
00877     } <span class="keywordflow">else</span> {
00878         lpintTabStopPositions = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00879         pixeltabstop = 8*cxCharWidth;
00880     }
00881 
00882     <span class="comment">// The first time we will draw the strip Opaquely. If some portions need</span>
00883     <span class="comment">// to be redrawn , then we will set the mode to TRANSPARENT and</span>
00884     <span class="comment">// jump to this location to redraw those portions.</span>
00885 
00886 RedrawStrip:
00887     <span class="keywordflow">while</span> (nCount) {
00888         wNegCwidth = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o78">wMaxNegC</a>;
00889 
00890         <span class="comment">// Search for the first TAB in this strip; also compute the extent</span>
00891         <span class="comment">// of the the strip upto and not including the tab character.</span>
00892         <span class="comment">//</span>
00893         <span class="comment">// Note - If the langpack is loaded, there will be no charWidthBuffer.</span>
00894         <span class="comment">//</span>
00895         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>) {     <span class="comment">// Do we have a character width buffer?</span>
00896             textextent = 0;
00897             cch = nCount;
00898 
00899             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o41">fTrueType</a>) {     <span class="comment">// If so, does it have ABC widths?</span>
00900 
00901                 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> iRightmostPoint = 0;
00902                 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wCharIndex;
00903                 PABC pABCwidthBuff;
00904 
00905                 pABCwidthBuff = (PABC) ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>;
00906 
00907                 <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ) {
00908                     <span class="keywordflow">for</span> (i = 0; i &lt; nCount; i++) {
00909 
00910                         <span class="keywordflow">if</span> (lpstring[i] == VK_TAB) {
00911                             cch = i;
00912                             <span class="keywordflow">break</span>;
00913                         }
00914 
00915                         wCharIndex = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>  *)lpstring)[i]);
00916                         <span class="keywordflow">if</span> (wCharIndex &lt; <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a>) {
00917                             textextent += (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(pABCwidthBuff[wCharIndex].abcA +
00918                                 pABCwidthBuff[wCharIndex].abcB);
00919                         } <span class="keywordflow">else</span> {    <span class="comment">// not in cache, will ask driver</span>
00920                             GetCharABCWidthsA(hdc, wCharIndex, wCharIndex, &amp;abc);
00921                             textextent += abc.abcA + abc.abcB ;
00922                         }
00923 
00924                         <span class="keywordflow">if</span> (textextent &gt; iRightmostPoint)
00925                             iRightmostPoint = textextent;
00926 
00927                         <span class="keywordflow">if</span> (wCharIndex &lt; <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a>) {
00928                             textextent += pABCwidthBuff[wCharIndex].abcC;
00929                         } <span class="keywordflow">else</span> {    <span class="comment">// not in cache</span>
00930                             textextent += abc.abcC;
00931                         }
00932 
00933                         <span class="keywordflow">if</span> (textextent &gt; iRightmostPoint)
00934                             iRightmostPoint = textextent;
00935                     }
00936 
00937                 } <span class="keywordflow">else</span> {   <span class="comment">// Unicode</span>
00938                     <span class="keywordflow">for</span> (i = 0; i &lt; nCount; i++) {
00939                         WCHAR UNALIGNED * lpwstring = (WCHAR UNALIGNED *)lpstring;
00940 
00941                         <span class="keywordflow">if</span> (lpwstring[i] == VK_TAB) {
00942                             cch = i;
00943                             <span class="keywordflow">break</span>;
00944                         }
00945 
00946                         wCharIndex = lpwstring[i] ;
00947                         <span class="keywordflow">if</span> ( wCharIndex &lt; <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a> )
00948                             textextent += pABCwidthBuff[wCharIndex].abcA +
00949                                           pABCwidthBuff[wCharIndex].abcB;
00950                         <span class="keywordflow">else</span> {
00951                             GetCharABCWidthsW(hdc, wCharIndex, wCharIndex, &amp;abc) ;
00952                             textextent += abc.abcA + abc.abcB ;
00953                         }
00954 
00955                         <span class="comment">/*</span>
00956 <span class="comment">                         * Note that abcC could be negative so we need this</span>
00957 <span class="comment">                         * statement here *and* below</span>
00958 <span class="comment">                         */</span>
00959                         <span class="keywordflow">if</span> (textextent &gt; iRightmostPoint)
00960                             iRightmostPoint = textextent;
00961 
00962                         <span class="keywordflow">if</span> ( wCharIndex &lt; <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a> )
00963                             textextent += pABCwidthBuff[wCharIndex].abcC;
00964                         <span class="keywordflow">else</span>
00965                             textextent += abc.abcC ;
00966 
00967                         <span class="keywordflow">if</span> (textextent &gt; iRightmostPoint)
00968                             iRightmostPoint = textextent;
00969                     }
00970                 }
00971 
00972                 wNegCwidth = (<span class="keywordtype">int</span>)(iRightmostPoint - textextent);
00973             } <span class="keywordflow">else</span> {   <span class="comment">// !ped-&gt;fTrueType</span>
00974                 <span class="comment">// No! This is not a TrueType font; So, we have only character</span>
00975                 <span class="comment">// width info in this buffer.</span>
00976 
00977                 charWidthBuff = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>;
00978 
00979                 <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ) {
00980                     <span class="comment">// Initially assume no tabs exist in the text so cch=nCount.</span>
00981                     <span class="keywordflow">for</span> (i = 0; i &lt; nCount; i++) {
00982                         <span class="keywordflow">if</span> (lpstring[i] == VK_TAB) {
00983                             cch = i;
00984                             <span class="keywordflow">break</span>;
00985                         }
00986 
00987                         <span class="comment">//</span>
00988                         <span class="comment">// Call GetTextExtentPoint for dbcs/hankaku characters</span>
00989                         <span class="comment">//</span>
00990                         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a> &amp;&amp; (i+1 &lt; nCount)
00991                                 &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(ped,lpstring[i])) {
00992                             GetTextExtentPointA(hdc, &amp;lpstring[i], 2, &amp;size);
00993                             textextent += size.cx;
00994                             i++;
00995                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((UCHAR)lpstring[i] &gt;= <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a>) {
00996                             <span class="comment">// Skip this GetExtentPoint call for non hankaku code points</span>
00997                             <span class="comment">// Or if the character is in the width cache.</span>
00998                             GetTextExtentPointA(hdc, &amp;lpstring[i], 1, &amp;size);
00999                             textextent += size.cx;
01000                         } <span class="keywordflow">else</span> {
01001                             textextent += (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(charWidthBuff[(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>  *)lpstring)[i])]);
01002                         }
01003                     }
01004                 } <span class="keywordflow">else</span> {
01005                     LPWSTR lpwstring = (LPWSTR) lpstring ;
01006                     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>    cchUStart;  <span class="comment">// start of unicode character count</span>
01007 
01008                     <span class="keywordflow">for</span> (i = 0; i &lt; nCount; i++) {
01009                         <span class="keywordflow">if</span> (lpwstring[i] == VK_TAB) {
01010                             cch = i;
01011                             <span class="keywordflow">break</span>;
01012                         }
01013 
01014                         wchar = lpwstring[i];
01015                         <span class="keywordflow">if</span> (wchar &gt;= <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a>) {
01016 
01017                             <span class="comment">/*</span>
01018 <span class="comment">                             * We have a Unicode character that is not in our</span>
01019 <span class="comment">                             * cache, get all the characters outside the cache</span>
01020 <span class="comment">                             * before getting the text extent on this part of the</span>
01021 <span class="comment">                             * string.</span>
01022 <span class="comment">                             */</span>
01023                             cchUStart = i;
01024                             <span class="keywordflow">while</span> (wchar &gt;= <a class="code" href="../../d6/d0/usercli_8h.html#a86">CHAR_WIDTH_BUFFER_LENGTH</a> &amp;&amp;
01025                                     wchar != VK_TAB &amp;&amp; i &lt; nCount) {
01026                                 wchar = lpwstring[++i];
01027                             }
01028 
01029                             GetTextExtentPointW(hdc, (LPWSTR)lpwstring + cchUStart,
01030                                     i-cchUStart, &amp;size);
01031                             textextent += size.cx;
01032 
01033 
01034                             <span class="keywordflow">if</span> (wchar == VK_TAB || i &gt;= nCount) {
01035                                 cch = i;
01036                                 <span class="keywordflow">break</span>;
01037                             }
01038                             <span class="comment">/*</span>
01039 <span class="comment">                             * We have a char that is in the cache, fall through.</span>
01040 <span class="comment">                             */</span>
01041                         }
01042                         <span class="comment">/*</span>
01043 <span class="comment">                         * The width of this character is in the cache buffer.</span>
01044 <span class="comment">                         */</span>
01045                         textextent += ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o74">charWidthBuffer</a>[wchar];
01046                     }
01047                 }
01048             } <span class="comment">// fTrueType else.</span>
01049 
01050             nCount -= cch;
01051         } <span class="keywordflow">else</span> {  <span class="comment">// If we don't have a buffer that contains the width info.</span>
01052             <span class="comment">/*</span>
01053 <span class="comment">             * Gotta call the driver to do our text extent.</span>
01054 <span class="comment">             */</span>
01055 
01056             <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ) {
01057                 cch = (<span class="keywordtype">int</span>)<a class="code" href="../../d8/d4/editec_8c.html#a10">ECFindTabA</a>(lpstring, nCount);
01058                 GetTextExtentPointA(hdc, lpstring, cch, &amp;size) ;
01059             } <span class="keywordflow">else</span> {
01060                 cch = (<span class="keywordtype">int</span>)<a class="code" href="../../d8/d4/editec_8c.html#a11">ECFindTabW</a>((LPWSTR) lpstring, nCount);
01061                 GetTextExtentPointW(hdc, (LPWSTR)lpstring, cch, &amp;size);
01062             }
01063             nCount -= cch;
01064             <span class="comment">//</span>
01065             <span class="comment">// Subtruct Overhang for Italic fonts.</span>
01066             <span class="comment">//</span>
01067             textextent = (size.cx - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o69">charOverhang</a>);
01068         }
01069 
01070         <span class="comment">//</span>
01071         <span class="comment">// textextent is computed.</span>
01072         <span class="comment">//</span>
01073 
01074         xStripStPos = xEnd;
01075         xEnd += (<span class="keywordtype">int</span>)textextent;
01076         xStripEndPos = xEnd;
01077 
01078         <span class="comment">// We will consider the negative widths only if when we draw opaquely.</span>
01079         <span class="keywordflow">if</span> (fFirstPass &amp;&amp; fDraw) {
01080             xRightmostPoint = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(xStripEndPos + (<span class="keywordtype">int</span>)wNegCwidth, xRightmostPoint);
01081 
01082             <span class="comment">// Check if this strip peeps beyond the clip region.</span>
01083             <span class="keywordflow">if</span> (xRightmostPoint &gt; xClipEndPos) {
01084                 <span class="keywordflow">if</span> (!NegCInfoForStrip-&gt;nCount) {
01085                     NegCInfoForStrip-&gt;lpString = lpstring;
01086                     NegCInfoForStrip-&gt;ichString = ichString;
01087                     NegCInfoForStrip-&gt;nCount = nCount+cch;
01088                     NegCInfoForStrip-&gt;XStartPos = xStripStPos;
01089                 }
01090             }
01091         }  <span class="comment">/* if (fFirstPass &amp;&amp; fDraw) */</span>
01092 
01093         <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> )
01094             lpTab = lpstring + cch; <span class="comment">// Possibly Points to a tab character.</span>
01095         <span class="keywordflow">else</span>
01096             lpwTab = ((LPWSTR)lpstring) + cch ;
01097 
01098         <span class="comment">// we must consider all the consecutive tabs and calculate the</span>
01099         <span class="comment">// the begining of next strip.</span>
01100         nConsecutiveTabs = 0;
01101         <span class="keywordflow">while</span> (nCount &amp;&amp;
01102                (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ? (*lpTab == VK_TAB) : (*lpwTab == VK_TAB))) {
01103             <span class="comment">// Find the next tab position and update the x value.</span>
01104             xTabStartPos = xEnd;
01105             <span class="keywordflow">if</span> (pixeltabstop)
01106                 xEnd = (((xEnd-iTabOrigin)/pixeltabstop)*pixeltabstop) +
01107                     pixeltabstop + iTabOrigin;
01108             <span class="keywordflow">else</span> {
01109                 <span class="keywordflow">for</span> (i = 0; i &lt; nTabPositions; i++) {
01110                     <span class="keywordflow">if</span> (xEnd &lt; (lpintTabStopPositions[i] + iTabOrigin)) {
01111                         xEnd = (lpintTabStopPositions[i] + iTabOrigin);
01112                         <span class="keywordflow">break</span>;
01113                     }
01114                  }
01115 
01116                 <span class="comment">// Check if all the tabstops set are exhausted; Then start using</span>
01117                 <span class="comment">// default tab stop positions.</span>
01118                 <span class="keywordflow">if</span> (i == nTabPositions) {
01119                     pixeltabstop = 8*cxCharWidth;
01120                     xEnd = ((xEnd - iTabOrigin)/pixeltabstop)*pixeltabstop +
01121                         pixeltabstop + iTabOrigin;
01122                 }
01123             }
01124 
01125             <span class="keywordflow">if</span> (fFirstPass &amp;&amp; fDraw) {
01126                 xRightmostPoint = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(xEnd, xRightmostPoint);
01127 
01128                 <span class="comment">/* Check if this strip peeps beyond the clip region */</span>
01129                 <span class="keywordflow">if</span> (xRightmostPoint &gt; xClipEndPos) {
01130                     <span class="keywordflow">if</span> (!NegCInfoForStrip-&gt;nCount) {
01131                         NegCInfoForStrip-&gt;ichString = ichString + cch + nConsecutiveTabs;
01132                         NegCInfoForStrip-&gt;nCount = nCount;
01133                         NegCInfoForStrip-&gt;lpString = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ?
01134                                                         lpTab : (LPSTR) lpwTab);
01135                         NegCInfoForStrip-&gt;XStartPos = xTabStartPos;
01136                     }
01137                 }
01138             }   <span class="comment">/* if(fFirstPass) */</span>
01139 
01140             nConsecutiveTabs++;
01141             nCount--;
01142             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ? lpTab++ : (LPSTR) (lpwTab++) ;  <span class="comment">// Move to the next character.</span>
01143         }  <span class="comment">// while(*lpTab == TAB) //</span>
01144 
01145         <span class="keywordflow">if</span> (fDraw) {
01146             <span class="keywordflow">if</span> (fFirstPass) {
01147                 <span class="comment">// Is anything remaining to be drawn in this strip?</span>
01148                 <span class="keywordflow">if</span> (!nCount)
01149                     rc.right = xEnd;      <span class="comment">// No! We are done.</span>
01150                 <span class="keywordflow">else</span> {
01151                     <span class="comment">// "x" is the effective starting position of next strip.</span>
01152                     iTabLength = xEnd - xStripEndPos;
01153 
01154                     <span class="comment">// Check if there is a possibility of this tab length being too small</span>
01155                     <span class="comment">// compared to the negative A and C widths if any.</span>
01156                     <span class="keywordflow">if</span> ((wNegCwidth + (wNegAwidth = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o76">wMaxNegA</a>)) &gt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)iTabLength) {
01157                         <span class="comment">// Unfortunately, there is a possiblity of an overlap.</span>
01158                         <span class="comment">// Let us find out the actual NegA for the next strip.</span>
01159                         wNegAwidth = <a class="code" href="../../d8/d4/editec_8c.html#a14">GetActualNegA</a>(
01160                               hdc,
01161                               ped,
01162                               xEnd,
01163                               lpstring + (cch + nConsecutiveTabs)*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>,
01164                               ichString + cch + nConsecutiveTabs,
01165                               nCount,
01166                               &amp;NegAInfo);
01167                     }
01168 
01169                     <span class="comment">// Check if they actually overlap //</span>
01170                     <span class="keywordflow">if</span> ((wNegCwidth + wNegAwidth) &lt;= (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)iTabLength) {
01171                         <span class="comment">// No overlap between the strips. This is the ideal situation.</span>
01172                         rc.right = xEnd - wNegAwidth;
01173                     } <span class="keywordflow">else</span> {
01174                         <span class="comment">// Yes! They overlap.</span>
01175                         rc.right = xEnd;
01176 
01177                         <span class="comment">// See if negative C width is too large compared to tab length.</span>
01178                         <span class="keywordflow">if</span> (wNegCwidth &gt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)iTabLength) {
01179                             <span class="comment">// Must redraw transparently a part of the current strip later.</span>
01180                             <span class="keywordflow">if</span> (RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o2">nCount</a>) {
01181                                 <span class="comment">// A previous strip also needs to be redrawn; So, merge this</span>
01182                                 <span class="comment">// strip to that strip.</span>
01183                                 RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o2">nCount</a> = (ichString -
01184                                     RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o1">ichString</a>) + cch;
01185                             } <span class="keywordflow">else</span> {
01186                                 RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o2">nCount</a> = cch;
01187                                 RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o0">lpString</a> = lpstring;
01188                                 RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o1">ichString</a> = ichString;
01189                                 RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o3">XStartPos</a> = xStripStPos;
01190                             }
01191                         }
01192 
01193                         <span class="keywordflow">if</span> (wNegAwidth) {
01194                             <span class="comment">// Must redraw transparently the first part of the next strip later.</span>
01195                             <span class="keywordflow">if</span> (RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o2">nCount</a>) {
01196                                 <span class="comment">// A previous strip also needs to be redrawn; So, merge this</span>
01197                                 <span class="comment">// strip to that strip.</span>
01198                                 RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o2">nCount</a> = (NegAInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o1">ichString</a> - RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o1">ichString</a>) +
01199                                        NegAInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o2">nCount</a>;
01200                             } <span class="keywordflow">else</span>
01201                                 RedrawStripInfo = NegAInfo;
01202                         }
01203                     }
01204                 } <span class="comment">// else (!nCount) //</span>
01205             }  <span class="comment">// if (fFirstPass) //</span>
01206 
01207             <span class="keywordflow">if</span> (rc.left &lt; xClipEndPos) {
01208                 <span class="keywordflow">if</span> (fFirstPass) {
01209                     <span class="comment">// If this is the end of the strip, then complete the rectangle.</span>
01210                     <span class="keywordflow">if</span> ((!nCount) &amp;&amp; (xClipEndPos == <a class="code" href="../../d6/d0/usercli_8h.html#a73">MAXCLIPENDPOS</a>))
01211                         rc.right = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(rc.right, xClipEndPos);
01212                     <span class="keywordflow">else</span>
01213                         rc.right = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(rc.right, xClipEndPos);
01214                 }
01215 
01216                 <span class="comment">// Draw the current strip.</span>
01217                 <span class="keywordflow">if</span> (rc.left &lt; rc.right)
01218                     <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> )
01219                         ExtTextOutA(hdc,
01220                                     xStripStPos,
01221                                     y,
01222                                     (fFirstPass &amp;&amp; fOpaque ? (ETO_OPAQUE | ETO_CLIPPED) : ETO_CLIPPED),
01223                                     (LPRECT)&amp;rc, lpstring, cch, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01224                     <span class="keywordflow">else</span>
01225                         ExtTextOutW(hdc,
01226                                     xStripStPos,
01227                                     y,
01228                                     (fFirstPass &amp;&amp; fOpaque ? (ETO_OPAQUE | ETO_CLIPPED) : ETO_CLIPPED),
01229                                     (LPRECT)&amp;rc, (LPWSTR)lpstring, cch, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01230 
01231             }
01232 
01233             <span class="keywordflow">if</span> (fFirstPass)
01234                 rc.left = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(rc.right, xClipStPos);
01235             ichString += (cch+nConsecutiveTabs);
01236         }  <span class="comment">// if (fDraw) //</span>
01237 
01238         <span class="comment">// Skip over the tab and the characters we just drew.</span>
01239         lpstring += (cch + nConsecutiveTabs) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
01240     }  <span class="comment">// while (nCount) //</span>
01241 
01242     xEndOfStrip = xEnd;
01243 
01244     <span class="comment">// check if we need to draw some portions transparently.</span>
01245     <span class="keywordflow">if</span> (fFirstPass &amp;&amp; fDraw &amp;&amp; RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o2">nCount</a>) {
01246         iSavedBkMode = SetBkMode(hdc, TRANSPARENT);
01247         fFirstPass = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01248 
01249         nCount = RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o2">nCount</a>;
01250         rc.left = xClipStPos;
01251         rc.right = xClipEndPos;
01252         lpstring = RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o0">lpString</a>;
01253         ichString = RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o1">ichString</a>;
01254         xEnd = RedrawStripInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o3">XStartPos</a>;
01255         <span class="keywordflow">goto</span> RedrawStrip;  <span class="comment">// Redraw Transparently.</span>
01256     }
01257 
01258     <span class="keywordflow">if</span> (iSavedBkMode)             <span class="comment">// Did we change the Bk mode?</span>
01259         SetBkMode(hdc, iSavedBkMode);  <span class="comment">// Then, let us set it back!</span>
01260 
01261     <span class="keywordflow">return</span>((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(xEndOfStrip - xStart));
01262 }
01263 
01264 
01265 
01266 <span class="comment">/***************************************************************************\</span>
01267 <span class="comment">* ECCchInWidth AorW</span>
01268 <span class="comment">*</span>
01269 <span class="comment">* Returns maximum count of characters (up to cch) from the given</span>
01270 <span class="comment">* string (starting either at the beginning and moving forward or at the</span>
01271 <span class="comment">* end and moving backwards based on the setting of the fForward flag)</span>
01272 <span class="comment">* which will fit in the given width. ie. Will tell you how much of</span>
01273 <span class="comment">* lpstring will fit in the given width even when using proportional</span>
01274 <span class="comment">* characters. WARNING: If we use kerning, then this loses...</span>
01275 <span class="comment">*</span>
01276 <span class="comment">* History:</span>
01277 <span class="comment">*</span>
01278 <span class="comment">* NOTE: ECCchInWidth is not called if the language pack is loaded.</span>
01279 <span class="comment">\***************************************************************************/</span>
01280 
<a name="l01281"></a><a class="code" href="../../d6/d0/usercli_8h.html#a443">01281</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d6/d0/usercli_8h.html#a443">ECCchInWidth</a>(
01282     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
01283     HDC hdc,
01284     LPSTR lpText,
01285     ICH cch,
01286     <span class="keywordtype">int</span> width,
01287     BOOL fForward)
01288 {
01289     <span class="keywordtype">int</span> stringExtent;
01290     <span class="keywordtype">int</span> cchhigh;
01291     <span class="keywordtype">int</span> cchnew = 0;
01292     <span class="keywordtype">int</span> cchlow = 0;
01293     SIZE size;
01294     LPSTR lpStart;
01295 
01296     <span class="keywordflow">if</span> ((width &lt;= 0) || !cch)
01297         <span class="keywordflow">return</span> (0);
01298 
01299     <span class="comment">/*</span>
01300 <span class="comment">     * Optimize nonproportional fonts for single line ec since they don't have</span>
01301 <span class="comment">     * tabs.</span>
01302 <span class="comment">     */</span>
01303     <span class="comment">//</span>
01304     <span class="comment">// Change optimize condition for fixed pitch font</span>
01305     <span class="comment">//</span>
01306     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o26">fNonPropFont</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a> &amp;&amp; !ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a>) {
01307         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a461">ECAdjustIch</a>( ped, lpText, <a class="code" href="../../d5/d4/edecrare_8c.html#a3">umin</a>(width/ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a>,(<span class="keywordtype">int</span>)cch)));
01308     }
01309 
01310     <span class="comment">/*</span>
01311 <span class="comment">     * Check if password hidden chars are being used.</span>
01312 <span class="comment">     */</span>
01313     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o12">charPasswordChar</a>) {
01314         <span class="keywordflow">return</span> (<a class="code" href="../../d5/d4/edecrare_8c.html#a3">umin</a>(width / ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o13">cPasswordCharWidth</a>, (<span class="keywordtype">int</span>)cch));
01315     }
01316 
01317     <span class="comment">/*</span>
01318 <span class="comment">     * ALWAYS RESTRICT TO AT MOST MAXLINELENGTH to avoid overflow...</span>
01319 <span class="comment">     */</span>
01320     cch = <a class="code" href="../../d5/d4/edecrare_8c.html#a3">umin</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a74">MAXLINELENGTH</a>, cch);
01321 
01322     cchhigh = cch + 1;
01323     <span class="keywordflow">while</span> (cchlow &lt; cchhigh - 1) {
01324         cchnew = <a class="code" href="../../d8/d4/editec_8c.html#a1">umax</a>((cchhigh - cchlow) / 2, 1) + cchlow;
01325 
01326         lpStart = lpText;
01327 
01328         <span class="comment">/*</span>
01329 <span class="comment">         * If we want to figure out how many fit starting at the end and moving</span>
01330 <span class="comment">         * backwards, make sure we move to the appropriate position in the</span>
01331 <span class="comment">         * string before calculating the text extent.</span>
01332 <span class="comment">         */</span>
01333         <span class="keywordflow">if</span> (!fForward)
01334             lpStart += (cch - cchnew)*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
01335 
01336         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a>) {
01337             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>)
01338                 GetTextExtentPointA(hdc, (LPSTR)lpStart, cchnew, &amp;size);
01339             <span class="keywordflow">else</span>
01340                 GetTextExtentPointW(hdc, (LPWSTR)lpStart, cchnew, &amp;size);
01341             stringExtent = size.cx;
01342         } <span class="keywordflow">else</span> {
01343             stringExtent = <a class="code" href="../../d6/d0/usercli_8h.html#a478">ECTabTheTextOut</a>(hdc, 0, 0, 0, 0,
01344                 lpStart,
01345                 cchnew, 0,
01346                 ped, 0, <a class="code" href="../../d6/d0/usercli_8h.html#a146">ECT_CALC</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01347         }
01348 
01349         <span class="keywordflow">if</span> (stringExtent &gt; width) {
01350             cchhigh = cchnew;
01351         } <span class="keywordflow">else</span> {
01352             cchlow = cchnew;
01353         }
01354     }
01355     <span class="comment">//</span>
01356     <span class="comment">// Call ECAdjustIch ( generic case )</span>
01357     <span class="comment">//</span>
01358     cchlow = <a class="code" href="../../d6/d0/usercli_8h.html#a461">ECAdjustIch</a>( ped, lpText, cchlow );
01359     <span class="keywordflow">return</span> (cchlow);
01360 }
01361 
01362 <span class="comment">/***************************************************************************\</span>
01363 <span class="comment">* ECFindTab</span>
01364 <span class="comment">*</span>
01365 <span class="comment">* Scans lpstr and return s the number of CHARs till the first TAB.</span>
01366 <span class="comment">* Scans at most cch chars of lpstr.</span>
01367 <span class="comment">*</span>
01368 <span class="comment">* History:</span>
01369 <span class="comment">\***************************************************************************/</span>
01370 
<a name="l01371"></a><a class="code" href="../../d8/d4/editec_8c.html#a10">01371</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d8/d4/editec_8c.html#a10">ECFindTabA</a>(
01372     LPSTR lpstr,
01373     ICH cch)
01374 {
01375     LPSTR copylpstr = lpstr;
01376 
01377     <span class="keywordflow">if</span> (!cch)
01378         <span class="keywordflow">return</span> 0;
01379 
01380     <span class="keywordflow">while</span> (*lpstr != VK_TAB) {
01381         lpstr++;
01382         <span class="keywordflow">if</span> (--cch == 0)
01383             <span class="keywordflow">break</span>;
01384     }
01385     <span class="keywordflow">return</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)(lpstr - copylpstr));
01386 }
01387 
<a name="l01388"></a><a class="code" href="../../d8/d4/editec_8c.html#a11">01388</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d8/d4/editec_8c.html#a11">ECFindTabW</a>(
01389     LPWSTR lpstr,
01390     ICH cch)
01391 {
01392     LPWSTR copylpstr = lpstr;
01393 
01394     <span class="keywordflow">if</span> (!cch)
01395         <span class="keywordflow">return</span> 0;
01396 
01397     <span class="keywordflow">while</span> (*lpstr != VK_TAB) {
01398         lpstr++;
01399         <span class="keywordflow">if</span> (--cch == 0)
01400             <span class="keywordflow">break</span>;
01401     }
01402     <span class="keywordflow">return</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)(lpstr - copylpstr));
01403 }
01404 
01405 <span class="comment">/***************************************************************************\</span>
01406 <span class="comment">*</span>
01407 <span class="comment">*  ECGetBrush()</span>
01408 <span class="comment">*</span>
01409 <span class="comment">*  Gets appropriate background brush to erase with.</span>
01410 <span class="comment">*</span>
01411 <span class="comment">\***************************************************************************/</span>
<a name="l01412"></a><a class="code" href="../../d6/d0/usercli_8h.html#a480">01412</a> HBRUSH <a class="code" href="../../d6/d0/usercli_8h.html#a480">ECGetBrush</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, HDC hdc)
01413 {
01414     HBRUSH  hbr;
01415     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    f40Compat;
01416 
01417     f40Compat = (<a class="code" href="../../d6/d0/usercli_8h.html#a150">GETAPPVER</a>() &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>);
01418 
01419     <span class="comment">// Get background brush</span>
01420     <span class="keywordflow">if</span> ((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o39">fReadOnly</a> || ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o25">fDisabled</a>) &amp;&amp; f40Compat) {
01421         hbr = <a class="code" href="../../d6/d0/usercli_8h.html#a479">ECGetControlBrush</a>(ped, hdc, WM_CTLCOLORSTATIC);
01422     } <span class="keywordflow">else</span>
01423         hbr = <a class="code" href="../../d6/d0/usercli_8h.html#a479">ECGetControlBrush</a>(ped, hdc, WM_CTLCOLOREDIT);
01424 
01425     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o25">fDisabled</a> &amp;&amp; (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a> || f40Compat)) {
01426         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> rgb;
01427 
01428         <span class="comment">// Change text color</span>
01429         rgb = <a class="code" href="../../d3/d9/client_2wow_8c.html#a15">GetSysColor</a>(COLOR_GRAYTEXT);
01430         <span class="keywordflow">if</span> (rgb != GetBkColor(hdc))
01431             SetTextColor(hdc, rgb);
01432     }
01433     <span class="keywordflow">return</span>(hbr);
01434 }
01435 
01436 
01437 <span class="comment">/***************************************************************************\</span>
01438 <span class="comment">* NextWordCallBack</span>
01439 <span class="comment">*</span>
01440 <span class="comment">*</span>
01441 <span class="comment">*</span>
01442 <span class="comment">* History:</span>
01443 <span class="comment">* 02-19-92 JimA Ported from Win31 sources.</span>
01444 <span class="comment">\***************************************************************************/</span>
01445 
<a name="l01446"></a><a class="code" href="../../d8/d4/editec_8c.html#a26">01446</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d4/editec_8c.html#a26">NextWordCallBack</a>(
01447     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
01448     ICH ichStart,
01449     BOOL fLeft,
01450     ICH  *pichMin,
01451     ICH  *pichMax )
01452 {
01453     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> ichMinSel;
01454     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> ichMaxSel;
01455     LPSTR pText;
01456 
01457     pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
01458 
01459     <span class="keywordflow">if</span> (fLeft || (!(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a81">CALLWORDBREAKPROC</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o63">lpfnNextWord</a>, (LPSTR)pText,
01460             ichStart, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>, WB_ISDELIMITER) &amp;&amp;
01461             (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ? (*(pText + ichStart) != VK_RETURN) : (*((LPWSTR)pText + ichStart) != VK_RETURN))
01462         ))
01463         ichMinSel = <a class="code" href="../../d6/d0/usercli_8h.html#a81">CALLWORDBREAKPROC</a>(*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o63">lpfnNextWord</a>, (LPSTR)pText, ichStart, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>, WB_LEFT);
01464     <span class="keywordflow">else</span>
01465         ichMinSel = <a class="code" href="../../d6/d0/usercli_8h.html#a81">CALLWORDBREAKPROC</a>(*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o63">lpfnNextWord</a>, (LPSTR)pText, ichStart, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>, WB_RIGHT);
01466 
01467     ichMaxSel = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(ichMinSel + 1, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>);
01468 
01469     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
01470         <span class="keywordflow">if</span> (*(pText + ichMinSel) == VK_RETURN) {
01471             <span class="keywordflow">if</span> (ichMinSel &gt; 0 &amp;&amp; *(pText + ichMinSel - 1) == VK_RETURN) {
01472 
01473                 <span class="comment">/*</span>
01474 <span class="comment">                 * So that we can treat CRCRLF as one word also.</span>
01475 <span class="comment">                 */</span>
01476                 ichMinSel--;
01477             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(pText+ichMinSel + 1) == VK_RETURN) {
01478 
01479                 <span class="comment">/*</span>
01480 <span class="comment">                 * Move MaxSel on to the LF</span>
01481 <span class="comment">                 */</span>
01482                 ichMaxSel++;
01483             }
01484         }
01485     } <span class="keywordflow">else</span> {
01486         <span class="keywordflow">if</span> (*((LPWSTR)pText + ichMinSel) == VK_RETURN) {
01487             <span class="keywordflow">if</span> (ichMinSel &gt; 0 &amp;&amp; *((LPWSTR)pText + ichMinSel - 1) == VK_RETURN) {
01488 
01489                 <span class="comment">/*</span>
01490 <span class="comment">                 * So that we can treat CRCRLF as one word also.</span>
01491 <span class="comment">                 */</span>
01492                 ichMinSel--;
01493             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*((LPWSTR)pText+ichMinSel + 1) == VK_RETURN) {
01494 
01495                 <span class="comment">/*</span>
01496 <span class="comment">                 * Move MaxSel on to the LF</span>
01497 <span class="comment">                 */</span>
01498                 ichMaxSel++;
01499             }
01500         }
01501     }
01502     ichMaxSel = <a class="code" href="../../d6/d0/usercli_8h.html#a81">CALLWORDBREAKPROC</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o63">lpfnNextWord</a>, (LPSTR)pText, ichMaxSel, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>, WB_RIGHT);
01503     <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
01504 
01505     <span class="keywordflow">if</span> (pichMin)  *pichMin = ichMinSel;
01506     <span class="keywordflow">if</span> (pichMax)  *pichMax = ichMaxSel;
01507 }
01508 
01509 <span class="comment">/***************************************************************************\</span>
01510 <span class="comment">* NextWordLpkCallback</span>
01511 <span class="comment">*</span>
01512 <span class="comment">* Identifies next/prev word position for complex scripts</span>
01513 <span class="comment">*</span>
01514 <span class="comment">* History:</span>
01515 <span class="comment">* 04-22-97 DBrown</span>
01516 <span class="comment">\***************************************************************************/</span>
01517 
<a name="l01518"></a><a class="code" href="../../d8/d4/editec_8c.html#a27">01518</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d4/editec_8c.html#a27">NextWordLpkCallBack</a>(
01519     <a class="code" href="../../d3/d4/structtagED.html">PED</a>  ped,
01520     ICH  ichStart,
01521     BOOL fLeft,
01522     ICH *pichMin,
01523     ICH *pichMax)
01524 {
01525     PSTR pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
01526     HDC  hdc   = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01527 
01528     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o9">EditNextWord</a>(ped, hdc, pText, ichStart, fLeft, pichMin, pichMax);
01529 
01530     <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01531     <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
01532 }
01533 
01534 <span class="comment">/***************************************************************************\</span>
01535 <span class="comment">* ECWordAorW</span>
01536 <span class="comment">*</span>
01537 <span class="comment">* if fLeft, Returns the ichMinSel and ichMaxSel of the word to the</span>
01538 <span class="comment">* left of ichStart. ichMinSel contains the starting letter of the word,</span>
01539 <span class="comment">* ichmaxsel contains all spaces up to the first character of the next word.</span>
01540 <span class="comment">*</span>
01541 <span class="comment">* if !fLeft, Returns the ichMinSel and ichMaxSel of the word to the right of</span>
01542 <span class="comment">* ichStart. ichMinSel contains the starting letter of the word, ichmaxsel</span>
01543 <span class="comment">* contains the first letter of the next word. If ichStart is in the middle</span>
01544 <span class="comment">* of a word, that word is considered the left or right word.</span>
01545 <span class="comment">*</span>
01546 <span class="comment">* A CR LF pair or CRCRLF triple is considered a single word in</span>
01547 <span class="comment">* multiline edit controls.</span>
01548 <span class="comment">*</span>
01549 <span class="comment">* History:</span>
01550 <span class="comment">\***************************************************************************/</span>
01551 
<a name="l01552"></a><a class="code" href="../../d6/d0/usercli_8h.html#a438">01552</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a438">ECWord</a>(
01553     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
01554     ICH ichStart,
01555     BOOL fLeft,
01556     ICH  *pichMin,
01557     ICH  *pichMax )
01558 {
01559     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> charLocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01560     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> spaceLocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01561 
01562     <span class="keywordflow">if</span> ((!ichStart &amp;&amp; fLeft) || (ichStart == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> &amp;&amp; !fLeft)) {
01563 
01564         <span class="comment">/*</span>
01565 <span class="comment">         * We are at the beginning of the text (looking left) or we are at end</span>
01566 <span class="comment">         * of text (looking right), no word here</span>
01567 <span class="comment">         */</span>
01568         <span class="keywordflow">if</span> (pichMin) *pichMin=0;
01569         <span class="keywordflow">if</span> (pichMax) *pichMax=0;
01570         <span class="keywordflow">return</span>;
01571     }
01572 
01573     <span class="comment">/*</span>
01574 <span class="comment">     * Don't give out hints about word breaks if password chars are being used,</span>
01575 <span class="comment">     */</span>
01576     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o12">charPasswordChar</a>) {
01577         <span class="keywordflow">if</span> (pichMin) *pichMin=0;
01578         <span class="keywordflow">if</span> (pichMax) *pichMax=ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>;
01579         <span class="keywordflow">return</span>;
01580     }
01581 
01582     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
01583         PSTR pText;
01584         PSTR pWordMinSel;
01585         PSTR pWordMaxSel;
01586         PSTR pPrevChar;
01587 
01588         UserAssert(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a> == <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
01589 
01590         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o63">lpfnNextWord</a>) {
01591             <a class="code" href="../../d8/d4/editec_8c.html#a26">NextWordCallBack</a>(ped, ichStart, fLeft, pichMin, pichMax);
01592             <span class="keywordflow">return</span>;
01593         }
01594 
01595         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
01596             <a class="code" href="../../d8/d4/editec_8c.html#a27">NextWordLpkCallBack</a>(ped, ichStart, fLeft, pichMin, pichMax);
01597             <span class="keywordflow">return</span>;
01598         }
01599 
01600         pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
01601         pWordMinSel = pWordMaxSel = pText + ichStart;
01602 
01603         <span class="comment">/*</span>
01604 <span class="comment">         * if fLeft: Move pWordMinSel to the left looking for the start of a word.</span>
01605 <span class="comment">         * If we start at a space, we will include spaces in the selection as we</span>
01606 <span class="comment">         * move left untill we find a nonspace character. At that point, we continue</span>
01607 <span class="comment">         * looking left until we find a space. Thus, the selection will consist of</span>
01608 <span class="comment">         * a word with its trailing spaces or, it will consist of any leading at the</span>
01609 <span class="comment">         * beginning of a line of text.</span>
01610 <span class="comment">         */</span>
01611 
01612         <span class="comment">/*</span>
01613 <span class="comment">         * if !fLeft: (ie. right word) Move pWordMinSel looking for the start of a</span>
01614 <span class="comment">         * word. If the pWordMinSel points to a character, then we move left</span>
01615 <span class="comment">         * looking for a space which will signify the start of the word. If</span>
01616 <span class="comment">         * pWordMinSel points to a space, we look right till we come upon a</span>
01617 <span class="comment">         * character. pMaxWord will look right starting at pMinWord looking for the</span>
01618 <span class="comment">         * end of the word and its trailing spaces.</span>
01619 <span class="comment">         */</span>
01620 
01621         <span class="keywordflow">if</span> (fLeft || !<a class="code" href="../../d6/d0/usercli_8h.html#a152">ISDELIMETERA</a>(*pWordMinSel) &amp;&amp; *pWordMinSel != 0x0D) {
01622 
01623             <span class="comment">/*</span>
01624 <span class="comment">             * If we are moving left or if we are moving right and we are not on a</span>
01625 <span class="comment">             * space or a CR (the start of a word), then we was look left for the</span>
01626 <span class="comment">             * start of a word which is either a CR or a character. We do this by</span>
01627 <span class="comment">             * looking left till we find a character (or if CR we stop), then we</span>
01628 <span class="comment">             * continue looking left till we find a space or LF.</span>
01629 <span class="comment">             */</span>
01630             <span class="keywordflow">while</span> (pWordMinSel &gt; pText &amp;&amp; ((!<a class="code" href="../../d6/d0/usercli_8h.html#a152">ISDELIMETERA</a>(*(pWordMinSel - 1)) &amp;&amp;
01631                     *(pWordMinSel - 1) != 0x0A) || !charLocated)) {
01632 
01633                 <span class="comment">/*</span>
01634 <span class="comment">                 * Treat double byte character as a word  ( in ansi pWordMinSel loop )</span>
01635 <span class="comment">                 */</span>
01636                 pPrevChar = <a class="code" href="../../d6/d0/usercli_8h.html#a466">ECAnsiPrev</a>( ped, pText, pWordMinSel );
01637 
01638                 <span class="comment">/*</span>
01639 <span class="comment">                ** we are looking right ( !fLeft ).</span>
01640 <span class="comment">                ** if current character is a double byte chararacter or</span>
01641 <span class="comment">                ** previous character is a double byte character, we</span>
01642 <span class="comment">                ** are on the beggining of a word.</span>
01643 <span class="comment">                */</span>
01644                 <span class="keywordflow">if</span> ( !fLeft &amp;&amp; ( <a class="code" href="../../d6/d0/usercli_8h.html#a152">ISDELIMETERA</a>( *pPrevChar )           ||
01645                                  *pPrevChar == 0x0A                   ||
01646                                  <a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(ped, *pWordMinSel)  ||
01647                                  pWordMinSel - pPrevChar == 2 ) ) {
01648                     <span class="comment">/*</span>
01649 <span class="comment">                     * If we are looking for the start of the word right, then we</span>
01650 <span class="comment">                     * stop when we have found it. (needed in case charLocated is</span>
01651 <span class="comment">                     * still FALSE)</span>
01652 <span class="comment">                     */</span>
01653                     <span class="keywordflow">break</span>;
01654                 }
01655 
01656                 <span class="keywordflow">if</span> ( pWordMinSel - pPrevChar == 2 ) {
01657                     <span class="comment">/*</span>
01658 <span class="comment">                    ** previous character is a double byte character.</span>
01659 <span class="comment">                    ** if we are in a word ( charLocated == TRUE )</span>
01660 <span class="comment">                    ** current position is the beginning of the word</span>
01661 <span class="comment">                    ** if we are not in a word ( charLocated == FALSE )</span>
01662 <span class="comment">                    ** the previous character is what we looking for.</span>
01663 <span class="comment">                    */</span>
01664                     <span class="keywordflow">if</span> ( ! charLocated ) {
01665                         pWordMinSel = pPrevChar;
01666                     }
01667                     <span class="keywordflow">break</span>;
01668                 }
01669                 pWordMinSel = pPrevChar;
01670 
01671                 <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a152">ISDELIMETERA</a>(*pWordMinSel) &amp;&amp; *pWordMinSel != 0x0A) {
01672 
01673                     <span class="comment">/*</span>
01674 <span class="comment">                     * We have found the last char in the word. Continue looking</span>
01675 <span class="comment">                     * backwards till we find the first char of the word</span>
01676 <span class="comment">                     */</span>
01677                     charLocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01678 
01679                     <span class="comment">/*</span>
01680 <span class="comment">                     * We will consider a CR the start of a word</span>
01681 <span class="comment">                     */</span>
01682                     <span class="keywordflow">if</span> (*pWordMinSel == 0x0D)
01683                         <span class="keywordflow">break</span>;
01684                 }
01685             }
01686         } <span class="keywordflow">else</span> {
01687             <span class="keywordflow">while</span> ((<a class="code" href="../../d6/d0/usercli_8h.html#a152">ISDELIMETERA</a>(*pWordMinSel) || *pWordMinSel == 0x0A) &amp;&amp; pWordMinSel &lt; pText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>)
01688                 pWordMinSel++;
01689         }
01690 
01691         <span class="comment">/*</span>
01692 <span class="comment">         * Adjust the initial position of pWordMaxSel ( in ansi )</span>
01693 <span class="comment">         */</span>
01694         pWordMaxSel = <a class="code" href="../../d6/d0/usercli_8h.html#a465">ECAnsiNext</a>(ped, pWordMinSel);
01695         pWordMaxSel = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(pWordMaxSel, pText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>);
01696 
01697         <span class="comment">/*</span>
01698 <span class="comment">        ** If pWordMinSel points a double byte character AND</span>
01699 <span class="comment">        **    pWordMaxSel points non space</span>
01700 <span class="comment">        ** then</span>
01701 <span class="comment">        **    pWordMaxSel points the beggining of next word.</span>
01702 <span class="comment">        */</span>
01703         <span class="keywordflow">if</span> ( ( pWordMaxSel - pWordMinSel == 2 ) &amp;&amp; ! <a class="code" href="../../d6/d0/usercli_8h.html#a152">ISDELIMETERA</a>(*pWordMaxSel) )
01704             <span class="keywordflow">goto</span> FastReturnA;
01705         <span class="keywordflow">if</span> (*pWordMinSel == 0x0D) {
01706             <span class="keywordflow">if</span> (pWordMinSel &gt; pText &amp;&amp; *(pWordMinSel - 1) == 0x0D)
01707                 <span class="comment">/* So that we can treat CRCRLF as one word also. */</span>
01708                 pWordMinSel--;
01709             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(pWordMinSel + 1) == 0x0D)
01710                 <span class="comment">/* Move MaxSel on to the LF */</span>
01711                 pWordMaxSel++;
01712         }
01713 
01714 
01715 
01716         <span class="comment">/*</span>
01717 <span class="comment">         * Check if we have a one character word</span>
01718 <span class="comment">         */</span>
01719         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a152">ISDELIMETERA</a>(*pWordMaxSel))
01720             spaceLocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01721 
01722         <span class="comment">/*</span>
01723 <span class="comment">         * Move pWordMaxSel to the right looking for the end of a word and its</span>
01724 <span class="comment">         * trailing spaces. WordMaxSel stops on the first character of the next</span>
01725 <span class="comment">         * word. Thus, we break either at a CR or at the first nonspace char after</span>
01726 <span class="comment">         * a run of spaces or LFs.</span>
01727 <span class="comment">         */</span>
01728         <span class="keywordflow">while</span> ((pWordMaxSel &lt; pText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) &amp;&amp; (!spaceLocated || (<a class="code" href="../../d6/d0/usercli_8h.html#a152">ISDELIMETERA</a>(*pWordMaxSel)))) {
01729             <span class="keywordflow">if</span> (*pWordMaxSel == 0x0D)
01730                 <span class="keywordflow">break</span>;
01731 
01732             <span class="comment">/*</span>
01733 <span class="comment">             * Treat double byte character as a word ( in ansi pWordMaxSel loop )</span>
01734 <span class="comment">             */</span>
01735             <span class="comment">/*</span>
01736 <span class="comment">            ** if it's a double byte character then</span>
01737 <span class="comment">            ** we are at the beginning of next word</span>
01738 <span class="comment">            ** which is a double byte character.</span>
01739 <span class="comment">            */</span>
01740             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>( ped, *pWordMaxSel))
01741                 <span class="keywordflow">break</span>;
01742 
01743             pWordMaxSel++;
01744 
01745             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a152">ISDELIMETERA</a>(*pWordMaxSel))
01746                 spaceLocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01747 
01748             <span class="keywordflow">if</span> (*(pWordMaxSel - 1) == 0x0A)
01749                 <span class="keywordflow">break</span>;
01750         }
01751 
01752         <span class="comment">/*</span>
01753 <span class="comment">         * label for fast return ( for Ansi )</span>
01754 <span class="comment">         */</span>
01755 FastReturnA:
01756         <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
01757 
01758         <span class="keywordflow">if</span> (pichMin)   *pichMin = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)(pWordMinSel - pText);
01759         <span class="keywordflow">if</span> (pichMax)   *pichMax = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)(pWordMaxSel - pText);
01760         <span class="keywordflow">return</span>;
01761 
01762     } <span class="keywordflow">else</span> {  <span class="comment">// !fAnsi</span>
01763         LPWSTR pwText;
01764         LPWSTR pwWordMinSel;
01765         LPWSTR pwWordMaxSel;
01766         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> charLocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01767         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> spaceLocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01768         PWSTR pwPrevChar;
01769 
01770         UserAssert(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a> == <span class="keyword">sizeof</span>(WCHAR));
01771 
01772         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o63">lpfnNextWord</a>) {
01773             <a class="code" href="../../d8/d4/editec_8c.html#a26">NextWordCallBack</a>(ped, ichStart, fLeft, pichMin, pichMax);
01774             <span class="keywordflow">return</span>;
01775         }
01776 
01777         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
01778             <a class="code" href="../../d8/d4/editec_8c.html#a27">NextWordLpkCallBack</a>(ped, ichStart, fLeft, pichMin, pichMax);
01779             <span class="keywordflow">return</span>;
01780         }
01781 
01782         pwText = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
01783         pwWordMinSel = pwWordMaxSel = pwText + ichStart;
01784 
01785         <span class="comment">/*</span>
01786 <span class="comment">         * if fLeft: Move pWordMinSel to the left looking for the start of a word.</span>
01787 <span class="comment">         * If we start at a space, we will include spaces in the selection as we</span>
01788 <span class="comment">         * move left untill we find a nonspace character. At that point, we continue</span>
01789 <span class="comment">         * looking left until we find a space. Thus, the selection will consist of</span>
01790 <span class="comment">         * a word with its trailing spaces or, it will consist of any leading at the</span>
01791 <span class="comment">         * beginning of a line of text.</span>
01792 <span class="comment">         */</span>
01793 
01794         <span class="comment">/*</span>
01795 <span class="comment">         * if !fLeft: (ie. right word) Move pWordMinSel looking for the start of a</span>
01796 <span class="comment">         * word. If the pWordMinSel points to a character, then we move left</span>
01797 <span class="comment">         * looking for a space which will signify the start of the word. If</span>
01798 <span class="comment">         * pWordMinSel points to a space, we look right till we come upon a</span>
01799 <span class="comment">         * character. pMaxWord will look right starting at pMinWord looking for the</span>
01800 <span class="comment">         * end of the word and its trailing spaces.</span>
01801 <span class="comment">         */</span>
01802 
01803 
01804         <span class="keywordflow">if</span> (fLeft || (!<a class="code" href="../../d6/d0/usercli_8h.html#a153">ISDELIMETERW</a>(*pwWordMinSel) &amp;&amp; *pwWordMinSel != 0x0D))
01805          <span class="comment">/* If we are moving left or if we are moving right and we are not on a</span>
01806 <span class="comment">          * space or a CR (the start of a word), then we was look left for the</span>
01807 <span class="comment">          * start of a word which is either a CR or a character. We do this by</span>
01808 <span class="comment">          * looking left till we find a character (or if CR we stop), then we</span>
01809 <span class="comment">          * continue looking left till we find a space or LF.</span>
01810 <span class="comment">          */</span> {
01811             <span class="keywordflow">while</span> (pwWordMinSel &gt; pwText &amp;&amp; ((!<a class="code" href="../../d6/d0/usercli_8h.html#a153">ISDELIMETERW</a>(*(pwWordMinSel - 1)) &amp;&amp; *(pwWordMinSel - 1) != 0x0A) || !charLocated)) {
01812                 <span class="comment">/*</span>
01813 <span class="comment">                 * Treat double byte character as a word  ( in unicode pwWordMinSel loop )</span>
01814 <span class="comment">                 */</span>
01815                 pwPrevChar = pwWordMinSel - 1;
01816                 <span class="comment">/*</span>
01817 <span class="comment">                ** we are looking right ( !fLeft ).</span>
01818 <span class="comment">                **</span>
01819 <span class="comment">                ** if current character is a double width chararacter</span>
01820 <span class="comment">                ** or previous character is a double width character,</span>
01821 <span class="comment">                ** we are on the beggining of a word.</span>
01822 <span class="comment">                */</span>
01823                 <span class="keywordflow">if</span> (!fLeft &amp;&amp; (<a class="code" href="../../d6/d0/usercli_8h.html#a153">ISDELIMETERW</a>( *pwPrevChar)  ||
01824                                *pwPrevChar == 0x0A         ||
01825                                <a class="code" href="../../d5/d2/rtl_2drawtext_8c.html#a35">UserIsFullWidth</a>(CP_ACP,*pwWordMinSel) ||
01826                                <a class="code" href="../../d5/d2/rtl_2drawtext_8c.html#a35">UserIsFullWidth</a>(CP_ACP,*pwPrevChar)))    {
01827                     <span class="comment">/*</span>
01828 <span class="comment">                     * If we are looking for the start of the word right, then we</span>
01829 <span class="comment">                     * stop when we have found it. (needed in case charLocated is</span>
01830 <span class="comment">                     * still FALSE)</span>
01831 <span class="comment">                     */</span>
01832                     <span class="keywordflow">break</span>;
01833                 }
01834 
01835                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/rtl_2drawtext_8c.html#a35">UserIsFullWidth</a>(CP_ACP,*pwPrevChar)) {
01836                     <span class="comment">/*</span>
01837 <span class="comment">                    ** Previous character is a double width character.</span>
01838 <span class="comment">                    **</span>
01839 <span class="comment">                    ** if we are in a word ( charLocated == TRUE )</span>
01840 <span class="comment">                    ** current position is the beginning of the word</span>
01841 <span class="comment">                    ** if we are not in a word ( charLocated == FALSE )</span>
01842 <span class="comment">                    ** the previous character is what we looking for.</span>
01843 <span class="comment">                    */</span>
01844                     <span class="keywordflow">if</span> ( ! charLocated ) {
01845                         pwWordMinSel = pwPrevChar;
01846                     }
01847                     <span class="keywordflow">break</span>;
01848                 }
01849                 pwWordMinSel = pwPrevChar;
01850 
01851                 <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a153">ISDELIMETERW</a>(*pwWordMinSel) &amp;&amp; *pwWordMinSel != 0x0A)
01852                  <span class="comment">/*</span>
01853 <span class="comment">                  * We have found the last char in the word. Continue looking</span>
01854 <span class="comment">                  * backwards till we find the first char of the word</span>
01855 <span class="comment">                  */</span> {
01856                     charLocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01857 
01858                     <span class="comment">/*</span>
01859 <span class="comment">                     * We will consider a CR the start of a word</span>
01860 <span class="comment">                     */</span>
01861                     <span class="keywordflow">if</span> (*pwWordMinSel == 0x0D)
01862                         <span class="keywordflow">break</span>;
01863                 }
01864             }
01865         } <span class="keywordflow">else</span> {
01866 
01867             <span class="comment">/*</span>
01868 <span class="comment">             * We are moving right and we are in between words so we need to move</span>
01869 <span class="comment">             * right till we find the start of a word (either a CR or a character.</span>
01870 <span class="comment">             */</span>
01871             <span class="keywordflow">while</span> ((<a class="code" href="../../d6/d0/usercli_8h.html#a153">ISDELIMETERW</a>(*pwWordMinSel) || *pwWordMinSel == 0x0A) &amp;&amp; pwWordMinSel &lt; pwText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>)
01872                 pwWordMinSel++;
01873         }
01874 
01875         pwWordMaxSel = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((pwWordMinSel + 1), (pwText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>));
01876 
01877         <span class="comment">/*</span>
01878 <span class="comment">        ** If pwWordMinSel points a double width character AND</span>
01879 <span class="comment">        **    pwWordMaxSel points non space</span>
01880 <span class="comment">        ** then</span>
01881 <span class="comment">        **    pwWordMaxSel points the beggining of next word.</span>
01882 <span class="comment">        */</span>
01883         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/rtl_2drawtext_8c.html#a35">UserIsFullWidth</a>(CP_ACP,*pwWordMinSel) &amp;&amp; ! <a class="code" href="../../d6/d0/usercli_8h.html#a153">ISDELIMETERW</a>(*pwWordMaxSel))
01884             <span class="keywordflow">goto</span> FastReturnW;
01885         <span class="keywordflow">if</span> (*pwWordMinSel == 0x0D) {
01886             <span class="keywordflow">if</span> (pwWordMinSel &gt; pwText &amp;&amp; *(pwWordMinSel - 1) == 0x0D)
01887                 <span class="comment">/* So that we can treat CRCRLF as one word also. */</span>
01888                 pwWordMinSel--;
01889             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(pwWordMinSel + 1) == 0x0D)
01890                 <span class="comment">/* Move MaxSel on to the LF */</span>
01891                 pwWordMaxSel++;
01892         }
01893 
01894 
01895 
01896         <span class="comment">/*</span>
01897 <span class="comment">         * Check if we have a one character word</span>
01898 <span class="comment">         */</span>
01899         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a153">ISDELIMETERW</a>(*pwWordMaxSel))
01900             spaceLocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01901 
01902         <span class="comment">/*</span>
01903 <span class="comment">         * Move pwWordMaxSel to the right looking for the end of a word and its</span>
01904 <span class="comment">         * trailing spaces. WordMaxSel stops on the first character of the next</span>
01905 <span class="comment">         * word. Thus, we break either at a CR or at the first nonspace char after</span>
01906 <span class="comment">         * a run of spaces or LFs.</span>
01907 <span class="comment">         */</span>
01908         <span class="keywordflow">while</span> ((pwWordMaxSel &lt; pwText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) &amp;&amp; (!spaceLocated || (<a class="code" href="../../d6/d0/usercli_8h.html#a153">ISDELIMETERW</a>(*pwWordMaxSel)))) {
01909             <span class="keywordflow">if</span> (*pwWordMaxSel == 0x0D)
01910                 <span class="keywordflow">break</span>;
01911 
01912             <span class="comment">/*</span>
01913 <span class="comment">             * treat double byte character as a word ( in unicode pwWordMaxSel loop )</span>
01914 <span class="comment">             */</span>
01915             <span class="comment">/*</span>
01916 <span class="comment">            ** if it's a double width character</span>
01917 <span class="comment">            ** then we are at the beginning of</span>
01918 <span class="comment">            ** the next word which is a double</span>
01919 <span class="comment">            ** width character.</span>
01920 <span class="comment">            */</span>
01921             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/rtl_2drawtext_8c.html#a35">UserIsFullWidth</a>(CP_ACP,*pwWordMaxSel))
01922                 <span class="keywordflow">break</span>;
01923 
01924             pwWordMaxSel++;
01925 
01926             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a153">ISDELIMETERW</a>(*pwWordMaxSel))
01927                 spaceLocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01928 
01929 
01930             <span class="keywordflow">if</span> (*(pwWordMaxSel - 1) == 0x0A)
01931                 <span class="keywordflow">break</span>;
01932         }
01933 
01934         <span class="comment">/*</span>
01935 <span class="comment">         * label for fast return ( for Unicode )</span>
01936 <span class="comment">         */</span>
01937 FastReturnW:
01938         <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
01939 
01940         <span class="keywordflow">if</span> (pichMin)   *pichMin = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)(pwWordMinSel - pwText);
01941         <span class="keywordflow">if</span> (pichMax)   *pichMax = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)(pwWordMaxSel - pwText);
01942         <span class="keywordflow">return</span>;
01943     }
01944 }
01945 
01946 <span class="comment">/***************************************************************************\</span>
01947 <span class="comment">*</span>
01948 <span class="comment">*  ECSaveUndo() -</span>
01949 <span class="comment">*</span>
01950 <span class="comment">*  Saves old undo information into given buffer, and clears out info in</span>
01951 <span class="comment">*  passed in undo buffer.  If we're restoring, pundoFrom and pundoTo are</span>
01952 <span class="comment">*  reversed.</span>
01953 <span class="comment">*</span>
01954 <span class="comment">\***************************************************************************/</span>
<a name="l01955"></a><a class="code" href="../../d6/d0/usercli_8h.html#a445">01955</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a445">ECSaveUndo</a>(<a class="code" href="../../d9/d8/structtagUNDO.html">PUNDO</a> pundoFrom, <a class="code" href="../../d9/d8/structtagUNDO.html">PUNDO</a> pundoTo, BOOL fClear)
01956 {
01957     <span class="comment">/*</span>
01958 <span class="comment">     *  Save undo data</span>
01959 <span class="comment">     */</span>
01960     RtlCopyMemory(pundoTo, pundoFrom, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/structtagUNDO.html">UNDO</a>));
01961 
01962     <span class="comment">/*</span>
01963 <span class="comment">     *  Clear passed in undo buffer</span>
01964 <span class="comment">     */</span>
01965     <span class="keywordflow">if</span> (fClear)
01966         RtlZeroMemory(pundoFrom, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/usercli_8h.html#a357">UNDO</a>) );
01967 }
01968 
01969 <span class="comment">/***************************************************************************\</span>
01970 <span class="comment">* ECEmptyUndo AorW</span>
01971 <span class="comment">*</span>
01972 <span class="comment">* empties the undo buffer.</span>
01973 <span class="comment">*</span>
01974 <span class="comment">* History:</span>
01975 <span class="comment">\***************************************************************************/</span>
01976 
<a name="l01977"></a><a class="code" href="../../d6/d0/usercli_8h.html#a444">01977</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a444">ECEmptyUndo</a>(
01978     <a class="code" href="../../d9/d8/structtagUNDO.html">PUNDO</a> pundo )
01979 {
01980     <span class="keywordflow">if</span> (pundo-&gt;<a class="code" href="../../d9/d8/structtagUNDO.html#o1">hDeletedText</a>)
01981         <a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>(pundo-&gt;<a class="code" href="../../d9/d8/structtagUNDO.html#o1">hDeletedText</a>);
01982 
01983     RtlZeroMemory(pundo, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/structtagUNDO.html">UNDO</a>) );
01984 }
01985 
01986 <span class="comment">/***************************************************************************\</span>
01987 <span class="comment">*</span>
01988 <span class="comment">*  ECMergeUndoInsertInfo() -</span>
01989 <span class="comment">*</span>
01990 <span class="comment">*  When an insert takes place, this function is called with the info about</span>
01991 <span class="comment">*  the new insertion (the insertion point and the count of chars inserted);</span>
01992 <span class="comment">*  This looks at the existing Undo info and merges the new new insert info</span>
01993 <span class="comment">*  with it.</span>
01994 <span class="comment">*</span>
01995 <span class="comment">\***************************************************************************/</span>
<a name="l01996"></a><a class="code" href="../../d8/d4/editec_8c.html#a31">01996</a> <span class="keywordtype">void</span>   <a class="code" href="../../d8/d4/editec_8c.html#a31">ECMergeUndoInsertInfo</a>(<a class="code" href="../../d9/d8/structtagUNDO.html">PUNDO</a> pundo, ICH ichInsert, ICH cchInsert) \
01997 {
01998     <span class="comment">//</span>
01999     <span class="comment">// If undo buffer is empty, just insert the new info as UNDO_INSERT</span>
02000     <span class="comment">//</span>
02001     <span class="keywordflow">if</span> (pundo-&gt;undoType == <a class="code" href="../../d6/d0/usercli_8h.html#a82">UNDO_NONE</a>) {
02002         pundo-&gt;undoType    = <a class="code" href="../../d6/d0/usercli_8h.html#a83">UNDO_INSERT</a>;
02003         pundo-&gt;ichInsStart = ichInsert;
02004         pundo-&gt;ichInsEnd   = ichInsert+cchInsert;
02005     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pundo-&gt;undoType &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a83">UNDO_INSERT</a>) {
02006         <span class="comment">//</span>
02007         <span class="comment">// If there's already some undo insert info,</span>
02008         <span class="comment">// try to merge the two.</span>
02009         <span class="comment">//</span>
02010         <span class="keywordflow">if</span> (pundo-&gt;ichInsEnd == ichInsert) <span class="comment">// Check they are adjacent.</span>
02011             pundo-&gt;ichInsEnd += cchInsert; <span class="comment">// if so, just concatenate.</span>
02012         <span class="keywordflow">else</span> {
02013                 <span class="comment">// The new insert is not contiguous with the old one.</span>
02014 UNDOINSERT:
02015             <span class="comment">//</span>
02016             <span class="comment">// If there is some UNDO_DELETE info already here, check to see</span>
02017             <span class="comment">// if the new insert takes place at a point different from where</span>
02018             <span class="comment">// that deletion occurred.</span>
02019             <span class="comment">//</span>
02020             <span class="keywordflow">if</span> ((pundo-&gt;undoType &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a84">UNDO_DELETE</a>) &amp;&amp; (pundo-&gt;ichDeleted != ichInsert)) {
02021                 <span class="comment">//</span>
02022                 <span class="comment">// User is inserting into a different point; So, let us</span>
02023                 <span class="comment">// forget any UNDO_DELETE info;</span>
02024                 <span class="comment">//</span>
02025                 <span class="keywordflow">if</span> (pundo-&gt;hDeletedText)
02026                     <a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>(pundo-&gt;hDeletedText);
02027 
02028                 pundo-&gt;hDeletedText = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02029                 pundo-&gt;ichDeleted = 0xFFFFFFFF;
02030                 pundo-&gt;undoType &amp;= ~<a class="code" href="../../d6/d0/usercli_8h.html#a84">UNDO_DELETE</a>;
02031             }
02032 
02033             <span class="comment">// Since the old insert and new insert are not adjacent, let us</span>
02034             <span class="comment">// forget everything about the old insert and keep just the new</span>
02035             <span class="comment">// insert info as the UNDO_INSERT.</span>
02036             pundo-&gt;ichInsStart = ichInsert;
02037             pundo-&gt;ichInsEnd   = ichInsert + cchInsert;
02038             pundo-&gt;undoType |= <a class="code" href="../../d6/d0/usercli_8h.html#a83">UNDO_INSERT</a>;
02039         }
02040     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pundo-&gt;undoType == <a class="code" href="../../d6/d0/usercli_8h.html#a84">UNDO_DELETE</a>) {
02041         <span class="comment">// If there is some Delete Info already present go and handle it.</span>
02042         <span class="keywordflow">goto</span> UNDOINSERT;
02043     }
02044 }
02045 
02046 
02047 <span class="comment">/***************************************************************************\</span>
02048 <span class="comment">* ECInsertText AorW</span>
02049 <span class="comment">*</span>
02050 <span class="comment">* Adds cch characters from lpText into the ped-&gt;hText starting at</span>
02051 <span class="comment">* ped-&gt;ichCaret. Returns TRUE if successful else FALSE. Updates</span>
02052 <span class="comment">* ped-&gt;cchAlloc and ped-&gt;cch properly if additional memory was allocated or</span>
02053 <span class="comment">* if characters were actually added. Updates ped-&gt;ichCaret to be at the end</span>
02054 <span class="comment">* of the inserted text. min and maxsel are equal to ichcaret.</span>
02055 <span class="comment">*</span>
02056 <span class="comment">* History:</span>
02057 <span class="comment">\***************************************************************************/</span>
02058 
<a name="l02059"></a><a class="code" href="../../d6/d0/usercli_8h.html#a446">02059</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a446">ECInsertText</a>(
02060     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
02061     LPSTR lpText,
02062     ICH* pcchInsert)
02063 {
02064     PSTR pedText;
02065     PSTR pTextBuff;
02066     LONG style;
02067     HANDLE hTextCopy;
02068     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> allocamt;
02069 
02070     <span class="comment">//</span>
02071     <span class="comment">// If the last byte (lpText[cchInsert - 1]) is a DBCS leading byte</span>
02072     <span class="comment">// we need to adjust it.</span>
02073     <span class="comment">//</span>
02074     *pcchInsert = <a class="code" href="../../d6/d0/usercli_8h.html#a461">ECAdjustIch</a>(ped, lpText, *pcchInsert);
02075 
02076     <span class="keywordflow">if</span> (!*pcchInsert)
02077         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02078 
02079     <span class="comment">/*</span>
02080 <span class="comment">     * Do we already have enough memory??</span>
02081 <span class="comment">     */</span>
02082     <span class="keywordflow">if</span> (*pcchInsert &gt;= (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o1">cchAlloc</a> - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>)) {
02083 
02084         <span class="comment">/*</span>
02085 <span class="comment">         * Allocate what we need plus a little extra. Return FALSE if we are</span>
02086 <span class="comment">         * unsuccessful.</span>
02087 <span class="comment">         */</span>
02088         allocamt = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> + *pcchInsert) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
02089         allocamt += <a class="code" href="../../d6/d0/usercli_8h.html#a71">CCHALLOCEXTRA</a>;
02090 
02091 <span class="comment">// if (!ped-&gt;fSingle) {</span>
02092               hTextCopy = <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a3">LOCALREALLOC</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a>, allocamt, <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a0">LHND</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o87">hInstance</a>, &amp;lpText);
02093               <span class="keywordflow">if</span> (hTextCopy) {
02094                   ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a> = hTextCopy;
02095               } <span class="keywordflow">else</span> {
02096                   <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02097               }
02098 <span class="comment">// } else {</span>
02099 <span class="comment">// if (!LocalReallocSafe(ped-&gt;hText, allocamt, LHND, pped))</span>
02100 <span class="comment">//                return FALSE;</span>
02101 <span class="comment">// }</span>
02102 
02103         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o1">cchAlloc</a> = <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a6">LOCALSIZE</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o87">hInstance</a>) / ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
02104     }
02105 
02106 
02107     <span class="comment">/*</span>
02108 <span class="comment">     * Ok, we got the memory. Now copy the text into the structure</span>
02109 <span class="comment">     */</span>
02110     pedText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
02111 
02112     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
02113         HDC     hdc;
02114         <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>     iResult;
02115 
02116         hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a> (ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02117         iResult = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o8">EditVerifyText</a> (ped, hdc, pedText, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, lpText, *pcchInsert);
02118         <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a> (ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02119 
02120         <span class="keywordflow">if</span> (iResult == 0) {
02121             <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a> (ped);
02122             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02123         }
02124     }
02125 
02126     <span class="comment">/*</span>
02127 <span class="comment">     * Get a pointer to the place where text is to be inserted</span>
02128 <span class="comment">     */</span>
02129     pTextBuff = pedText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
02130 
02131     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> != ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
02132 
02133         <span class="comment">/*</span>
02134 <span class="comment">         * We are inserting text into the middle. We have to shift text to the</span>
02135 <span class="comment">         * right before inserting new text.</span>
02136 <span class="comment">         */</span>
02137          memmove(pTextBuff + *pcchInsert * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, pTextBuff, (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>-ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>);
02138     }
02139 
02140     <span class="comment">/*</span>
02141 <span class="comment">     * Make a copy of the text being inserted in the edit buffer.</span>
02142 <span class="comment">     * Use this copy for doing UPPERCASE/LOWERCASE ANSI/OEM conversions</span>
02143 <span class="comment">     * Fix for Bug #3406 -- 01/29/91 -- SANKAR --</span>
02144 <span class="comment">     */</span>
02145     memmove(pTextBuff, lpText, *pcchInsert * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>);
02146     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> += *pcchInsert;
02147 
02148     <span class="comment">/*</span>
02149 <span class="comment">     * Get the control's style</span>
02150 <span class="comment">     */</span>
02151     style = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>-&gt;style;
02152 
02153     <span class="comment">/*</span>
02154 <span class="comment">     * Do the Upper/Lower conversion</span>
02155 <span class="comment">     */</span>
02156     <span class="keywordflow">if</span> (style &amp; ES_LOWERCASE) {
02157         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>)
02158             <a class="code" href="../../d5/d7/strings_8c.html#a13">CharLowerBuffA</a>((LPSTR)pTextBuff, *pcchInsert);
02159         <span class="keywordflow">else</span>
02160             <a class="code" href="../../d8/d0/wstrings_8c.html#a12">CharLowerBuffW</a>((LPWSTR)pTextBuff, *pcchInsert);
02161     } <span class="keywordflow">else</span> {
02162         <span class="keywordflow">if</span> (style &amp; ES_UPPERCASE) {
02163             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
02164                 <a class="code" href="../../d5/d7/strings_8c.html#a14">CharUpperBuffA</a>(pTextBuff, *pcchInsert);
02165             } <span class="keywordflow">else</span> {
02166                 <a class="code" href="../../d8/d0/wstrings_8c.html#a13">CharUpperBuffW</a>((LPWSTR)pTextBuff, *pcchInsert);
02167             }
02168         }
02169     }
02170 
02171     <span class="comment">/*</span>
02172 <span class="comment">     * Do the OEM conversion</span>
02173 <span class="comment">     */</span>
02174     <span class="keywordflow">if</span> ((style &amp; ES_OEMCONVERT) &amp;&amp;
02175             <span class="comment">// For backward compatibility with NT4, we don't perform OEM conversion</span>
02176             <span class="comment">// for older apps if the system locale is FarEast.</span>
02177             <span class="comment">//</span>
02178             (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>() || <a class="code" href="../../d6/d0/usercli_8h.html#a150">GETAPPVER</a>() &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a100">VER50</a> || GetOEMCP() != GetACP())) {
02179 
02180         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> i;
02181 
02182         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
02183             <span class="keywordflow">for</span> (i = 0; i &lt; *pcchInsert; i++) {
02184                 <span class="comment">//</span>
02185                 <span class="comment">// We don't need to call CharToOemBuff etc. if the character</span>
02186                 <span class="comment">// is a double byte character.  And, calling ECIsDBCSLeadByte is</span>
02187                 <span class="comment">// faster and less complicated because we don't have to deal</span>
02188                 <span class="comment">// with the 2 byte dbcs cases.</span>
02189                 <span class="comment">//</span>
02190                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>() &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(ped, *(lpText+i))) {
02191                     i++;
02192                     <span class="keywordflow">continue</span>;
02193                 }
02194 
02195                 <span class="comment">//</span>
02196                 <span class="comment">// Windows Bug (Whistler) 35289</span>
02197                 <span class="comment">// greek has funny rules for casing, so we need to check for it.</span>
02198                 <span class="comment">// for nashville we should be doing something more appropriate</span>
02199                 <span class="comment">// but for now, leave as Win95 golden</span>
02200                 <span class="comment">//</span>
02201                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o75">charSet</a> != GREEK_CHARSET &amp;&amp; <a class="code" href="../../d5/d7/strings_8c.html#a15">IsCharLowerA</a>(*(pTextBuff + i))) {
02202                     <a class="code" href="../../d5/d7/strings_8c.html#a14">CharUpperBuffA</a>(pTextBuff + i, 1);
02203                     <a class="code" href="../../d2/d2/oemxlate_8c.html#a1">CharToOemBuffA</a>(pTextBuff + i, pTextBuff + i, 1);
02204                     <a class="code" href="../../d2/d2/oemxlate_8c.html#a3">OemToCharBuffA</a>(pTextBuff + i, pTextBuff + i, 1);
02205                     <a class="code" href="../../d5/d7/strings_8c.html#a13">CharLowerBuffA</a>(pTextBuff + i, 1);
02206                 } <span class="keywordflow">else</span> {
02207                     <a class="code" href="../../d2/d2/oemxlate_8c.html#a1">CharToOemBuffA</a>(pTextBuff + i, pTextBuff + i, 1);
02208                     <a class="code" href="../../d2/d2/oemxlate_8c.html#a3">OemToCharBuffA</a>(pTextBuff + i, pTextBuff + i, 1);
02209                 }
02210             }
02211         } <span class="keywordflow">else</span> {
02212             <span class="comment">//</span>
02213             <span class="comment">// Because 'ch' may become DBCS, and have a space for NULL.</span>
02214             <span class="comment">//</span>
02215             UCHAR ch[4];
02216             LPWSTR lpTextW = (LPWSTR)pTextBuff;
02217 
02218             <span class="keywordflow">for</span> (i = 0; i &lt; *pcchInsert; i++) {
02219                 <span class="keywordflow">if</span> (*(lpTextW + i) == <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a> ||
02220                     *(lpTextW + i) == <a class="code" href="../../d4/d5/conimep_8h.html#a54">UNICODE_LINEFEED</a> ||
02221                     *(lpTextW + i) == <a class="code" href="../../d9/d5/verifier_8c.html#a3">UNICODE_TAB</a>) {
02222                     <span class="keywordflow">continue</span>;
02223                 }
02224                 <span class="comment">//</span>
02225                 <span class="comment">// Windows Bug (Whistler) 35289</span>
02226                 <span class="comment">// greek has funny rules for casing, so we need to check for it.</span>
02227                 <span class="comment">// for nashville we should be doing something more appropriate</span>
02228                 <span class="comment">// but for now, leave as Win95 golden</span>
02229                 <span class="comment">//</span>
02230                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o75">charSet</a> != GREEK_CHARSET &amp;&amp; <a class="code" href="../../d8/d0/wstrings_8c.html#a14">IsCharLowerW</a>(*(lpTextW + i))) {
02231                     <a class="code" href="../../d8/d0/wstrings_8c.html#a13">CharUpperBuffW</a>(lpTextW + i, 1);
02232                     *(LPDWORD)ch = 0; <span class="comment">// make sure the null-terminate.</span>
02233                     <a class="code" href="../../d2/d2/oemxlate_8c.html#a5">CharToOemBuffW</a>(lpTextW + i, ch, 1);
02234                     <span class="comment">//</span>
02235                     <span class="comment">// We assume any SBCS/DBCS character will converted</span>
02236                     <span class="comment">// to 1 Unicode char, Otherwise, we may overwrite</span>
02237                     <span class="comment">// next character...</span>
02238                     <span class="comment">//</span>
02239                     <a class="code" href="../../d2/d2/oemxlate_8c.html#a7">OemToCharBuffW</a>(ch, lpTextW + i, <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(ch));
02240                     <a class="code" href="../../d8/d0/wstrings_8c.html#a12">CharLowerBuffW</a>(lpTextW + i, 1);
02241                 } <span class="keywordflow">else</span> {
02242                     *(LPDWORD)ch = 0; <span class="comment">// make sure the null-terminate.</span>
02243                     <a class="code" href="../../d2/d2/oemxlate_8c.html#a5">CharToOemBuffW</a>(lpTextW + i, ch, 1);
02244                     <span class="comment">//</span>
02245                     <span class="comment">// We assume any SBCS/DBCS character will converted</span>
02246                     <span class="comment">// to 1 Unicode char, Otherwise, we may overwrite</span>
02247                     <span class="comment">// next character...</span>
02248                     <span class="comment">//</span>
02249                     <a class="code" href="../../d2/d2/oemxlate_8c.html#a7">OemToCharBuffW</a>(ch, lpTextW + i, <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(ch));
02250                 }
02251             }
02252         }
02253     }
02254 
02255     <span class="comment">/* Adjust UNDO fields so that we can undo this insert... */</span>
02256     <a class="code" href="../../d8/d4/editec_8c.html#a31">ECMergeUndoInsertInfo</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a85">Pundo</a>(ped), ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, *pcchInsert);
02257 
02258     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> += *pcchInsert;
02259 
02260     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
02261         HDC     hdc;
02262 
02263         hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a> (ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02264         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o26">EditAdjustCaret</a> (ped, hdc, pedText, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>);
02265         <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a> (ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02266     }
02267 
02268     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02269 
02270     <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
02271 
02272     <span class="comment">/*</span>
02273 <span class="comment">     * Set dirty bit</span>
02274 <span class="comment">     */</span>
02275     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o24">fDirty</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02276 
02277     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02278 }
02279 
02280 <span class="comment">/***************************************************************************\</span>
02281 <span class="comment">* ECDeleteText AorW</span>
02282 <span class="comment">*</span>
02283 <span class="comment">* Deletes the text between ped-&gt;ichMinSel and ped-&gt;ichMaxSel. The</span>
02284 <span class="comment">* character at ichMaxSel is not deleted. But the character at ichMinSel is</span>
02285 <span class="comment">* deleted. ped-&gt;cch is updated properly and memory is deallocated if enough</span>
02286 <span class="comment">* text is removed. ped-&gt;ichMinSel, ped-&gt;ichMaxSel, and ped-&gt;ichCaret are set</span>
02287 <span class="comment">* to point to the original ped-&gt;ichMinSel. Returns the number of characters</span>
02288 <span class="comment">* deleted.</span>
02289 <span class="comment">*</span>
02290 <span class="comment">* History:</span>
02291 <span class="comment">\***************************************************************************/</span>
02292 
<a name="l02293"></a><a class="code" href="../../d6/d0/usercli_8h.html#a447">02293</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d6/d0/usercli_8h.html#a447">ECDeleteText</a>(
02294     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
02295 {
02296     PSTR pedText;
02297     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cchDelete;
02298     LPSTR lpDeleteSaveBuffer;
02299     HANDLE hDeletedText;
02300     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> bufferOffset;
02301 
02302     cchDelete = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
02303 
02304     <span class="keywordflow">if</span> (!cchDelete)
02305         <span class="keywordflow">return</span> (0);
02306 
02307     <span class="comment">/*</span>
02308 <span class="comment">     * Ok, now lets delete the text.</span>
02309 <span class="comment">     */</span>
02310     pedText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
02311 
02312     <span class="comment">/*</span>
02313 <span class="comment">     * Adjust UNDO fields so that we can undo this delete...</span>
02314 <span class="comment">     */</span>
02315     <span class="keywordflow">if</span> (ped-&gt;undoType == <a class="code" href="../../d6/d0/usercli_8h.html#a82">UNDO_NONE</a>) {
02316 UNDODELETEFROMSCRATCH:
02317         <span class="keywordflow">if</span> (ped-&gt;hDeletedText = <a class="code" href="../../d6/d0/usercli_8h.html#a3">UserGlobalAlloc</a>(GPTR, (LONG)((cchDelete+1)*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>))) {
02318             ped-&gt;undoType = <a class="code" href="../../d6/d0/usercli_8h.html#a84">UNDO_DELETE</a>;
02319             ped-&gt;ichDeleted = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
02320             ped-&gt;cchDeleted = cchDelete;
02321             lpDeleteSaveBuffer = ped-&gt;hDeletedText;
02322             RtlCopyMemory(lpDeleteSaveBuffer, pedText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, cchDelete*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>);
02323             lpDeleteSaveBuffer[cchDelete*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>] = 0;
02324         }
02325     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ped-&gt;undoType &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a83">UNDO_INSERT</a>) {
02326 UNDODELETE:
02327         <a class="code" href="../../d6/d0/usercli_8h.html#a444">ECEmptyUndo</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a85">Pundo</a>(ped));
02328 
02329         ped-&gt;ichInsStart = ped-&gt;ichInsEnd = 0xFFFFFFFF;
02330         ped-&gt;ichDeleted = 0xFFFFFFFF;
02331         ped-&gt;cchDeleted = 0;
02332         <span class="keywordflow">goto</span> UNDODELETEFROMSCRATCH;
02333     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ped-&gt;undoType == <a class="code" href="../../d6/d0/usercli_8h.html#a84">UNDO_DELETE</a>) {
02334         <span class="keywordflow">if</span> (ped-&gt;ichDeleted == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>) {
02335 
02336             <span class="comment">/*</span>
02337 <span class="comment">             * Copy deleted text to front of undo buffer</span>
02338 <span class="comment">             */</span>
02339             hDeletedText = <a class="code" href="../../d6/d0/usercli_8h.html#a5">UserGlobalReAlloc</a>(ped-&gt;hDeletedText, (LONG)(cchDelete + ped-&gt;cchDeleted + 1)*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, GHND);
02340             <span class="keywordflow">if</span> (!hDeletedText)
02341                 <span class="keywordflow">goto</span> UNDODELETE;
02342             bufferOffset = 0;
02343             ped-&gt;ichDeleted = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
02344         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ped-&gt;ichDeleted == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>) {
02345 
02346             <span class="comment">/*</span>
02347 <span class="comment">             * Copy deleted text to end of undo buffer</span>
02348 <span class="comment">             */</span>
02349             hDeletedText = <a class="code" href="../../d6/d0/usercli_8h.html#a5">UserGlobalReAlloc</a>(ped-&gt;hDeletedText, (LONG)(cchDelete + ped-&gt;cchDeleted + 1)*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, GHND);
02350             <span class="keywordflow">if</span> (!hDeletedText)
02351                 <span class="keywordflow">goto</span> UNDODELETE;
02352             bufferOffset = ped-&gt;cchDeleted*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
02353         } <span class="keywordflow">else</span> {
02354 
02355             <span class="comment">/*</span>
02356 <span class="comment">             * Clear the current UNDO delete and add the new one since</span>
02357 <span class="comment">               the deletes aren't contiguous.</span>
02358 <span class="comment">             */</span>
02359             <span class="keywordflow">goto</span> UNDODELETE;
02360         }
02361 
02362         ped-&gt;hDeletedText = hDeletedText;
02363         lpDeleteSaveBuffer = (LPSTR)hDeletedText;
02364         <span class="keywordflow">if</span> (!bufferOffset) {
02365 
02366             <span class="comment">/*</span>
02367 <span class="comment">             * Move text in delete buffer up so that we can insert the next</span>
02368 <span class="comment">             * text at the head of the buffer.</span>
02369 <span class="comment">             */</span>
02370             RtlMoveMemory(lpDeleteSaveBuffer + cchDelete*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, lpDeleteSaveBuffer,
02371                     ped-&gt;cchDeleted*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>);
02372         }
02373         RtlCopyMemory(lpDeleteSaveBuffer + bufferOffset, pedText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>,
02374                 cchDelete*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>);
02375 
02376         lpDeleteSaveBuffer[(ped-&gt;cchDeleted + cchDelete)*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>] = 0;
02377         ped-&gt;cchDeleted += cchDelete;
02378     }
02379 
02380     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> != ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
02381 
02382         <span class="comment">/*</span>
02383 <span class="comment">         * We are deleting text from the middle of the buffer so we have to</span>
02384 <span class="comment">           shift text to the left.</span>
02385 <span class="comment">         */</span>
02386         RtlMoveMemory(pedText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, pedText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>,
02387                 (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>)*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>);
02388     }
02389 
02390     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o1">cchAlloc</a> - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> &gt; <a class="code" href="../../d6/d0/usercli_8h.html#a71">CCHALLOCEXTRA</a>) {
02391 
02392         <span class="comment">/*</span>
02393 <span class="comment">         * Free some memory since we deleted a lot</span>
02394 <span class="comment">         */</span>
02395         <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a3">LOCALREALLOC</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a>, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> + (<a class="code" href="../../d6/d0/usercli_8h.html#a71">CCHALLOCEXTRA</a> / 2))*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a0">LHND</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o87">hInstance</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02396         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o1">cchAlloc</a> = <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a6">LOCALSIZE</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o87">hInstance</a>) / ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
02397     }
02398 
02399     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> -= cchDelete;
02400 
02401     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
02402         HDC     hdc;
02403 
02404         hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a> (ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02405         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o26">EditAdjustCaret</a> (ped, hdc, pedText, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>);
02406         <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a> (ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02407     }
02408 
02409     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
02410 
02411     <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
02412 
02413     <span class="comment">/*</span>
02414 <span class="comment">     * Set dirty bit</span>
02415 <span class="comment">     */</span>
02416     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o24">fDirty</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02417 
02418     <span class="keywordflow">return</span> (cchDelete);
02419 }
02420 
02421 <span class="comment">/***************************************************************************\</span>
02422 <span class="comment">* ECNotifyParent AorW</span>
02423 <span class="comment">*</span>
02424 <span class="comment">* Sends the notification code to the parent of the edit control</span>
02425 <span class="comment">*</span>
02426 <span class="comment">* History:</span>
02427 <span class="comment">\***************************************************************************/</span>
02428 
<a name="l02429"></a><a class="code" href="../../d6/d0/usercli_8h.html#a449">02429</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(
02430     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
02431     <span class="keywordtype">int</span> notificationCode)
02432 {
02433     <span class="comment">/*</span>
02434 <span class="comment">     * wParam is NotificationCode (hiword) and WindowID (loword)</span>
02435 <span class="comment">     * lParam is HWND of control sending the message</span>
02436 <span class="comment">     * Windows 95 checks for hwndParent != NULL before sending the message, but</span>
02437 <span class="comment">     * this is surely rare, and SendMessage NULL hwnd does nowt anyway (IanJa)</span>
02438 <span class="comment">     */</span>
02439     <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o17">hwndParent</a>, WM_COMMAND,
02440             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MAKELONG(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>), notificationCode),
02441             (LPARAM)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
02442 }
02443 
02444 <span class="comment">/***************************************************************************\</span>
02445 <span class="comment">*</span>
02446 <span class="comment">*  ECSetEditClip() AorW</span>
02447 <span class="comment">*</span>
02448 <span class="comment">*  Sets the clip rect for the hdc to the formatting rectangle intersected</span>
02449 <span class="comment">*  with the client area.</span>
02450 <span class="comment">*</span>
02451 <span class="comment">\***************************************************************************/</span>
<a name="l02452"></a><a class="code" href="../../d6/d0/usercli_8h.html#a450">02452</a> <span class="keywordtype">void</span>   <a class="code" href="../../d6/d0/usercli_8h.html#a450">ECSetEditClip</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, HDC hdc, BOOL fLeftMargin)
02453 {
02454     RECT rcClient;
02455     RECT rcClip;
02456 
02457     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcClip, &amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>);
02458 
02459     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
02460         <span class="comment">// Complex script handling chooses whether to write margins later</span>
02461         rcClip.left  -= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>;
02462         rcClip.right += ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>;
02463     } <span class="keywordflow">else</span> {
02464         <span class="keywordflow">if</span> (fLeftMargin)  <span class="comment">/* Should we consider the left margin?   */</span>
02465             rcClip.left  -= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>;
02466         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o34">fWrap</a>)        <span class="comment">/* Should we consider the right margin? */</span>
02467             rcClip.right += ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>;
02468     }
02469 
02470     <span class="comment">/* Set clip rectangle to rectClient intersect rectClip */</span>
02471     <span class="comment">/* We must clip for single line edits also. -- B#1360 */</span>
02472     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, &amp;rcClient);
02473     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o45">fFlatBorder</a>)
02474         <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;rcClient, -<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER), -<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER));
02475 
02476     <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcClient, &amp;rcClient, &amp;rcClip);
02477     IntersectClipRect(hdc,rcClient.left, rcClient.top,
02478             rcClient.right, rcClient.bottom);
02479 }
02480 
02481 <span class="comment">/***************************************************************************\</span>
02482 <span class="comment">* ECGetEditDC AorW</span>
02483 <span class="comment">*</span>
02484 <span class="comment">* Hides the caret, gets the DC for the edit control, and clips to</span>
02485 <span class="comment">* the rcFmt rectangle specified for the edit control and sets the proper</span>
02486 <span class="comment">* font. If fFastDC, just select the proper font but don't bother about clip</span>
02487 <span class="comment">* regions or hiding the caret.</span>
02488 <span class="comment">*</span>
02489 <span class="comment">* History:</span>
02490 <span class="comment">\***************************************************************************/</span>
02491 
<a name="l02492"></a><a class="code" href="../../d6/d0/usercli_8h.html#a451">02492</a> HDC <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(
02493     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
02494     BOOL fFastDC )
02495 {
02496     HDC hdc;
02497 
02498     <span class="keywordflow">if</span> (!fFastDC)
02499         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a204">NtUserHideCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
02500 
02501     <span class="keywordflow">if</span> ( hdc = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a250">NtUserGetDC</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>) ) {
02502         <a class="code" href="../../d6/d0/usercli_8h.html#a450">ECSetEditClip</a>(ped, hdc, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> == 0));
02503 
02504         <span class="comment">/*</span>
02505 <span class="comment">         * Select the proper font for this edit control's dc.</span>
02506 <span class="comment">         */</span>
02507         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o66">hFont</a>)
02508             SelectObject(hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o66">hFont</a>);
02509     }
02510 
02511     <span class="keywordflow">return</span> hdc;
02512 }
02513 
02514 <span class="comment">/***************************************************************************\</span>
02515 <span class="comment">* ECReleaseEditDC AorW</span>
02516 <span class="comment">*</span>
02517 <span class="comment">* Releases the DC (hdc) for the edit control and shows the caret.</span>
02518 <span class="comment">* If fFastDC, just select the proper font but don't bother about showing the</span>
02519 <span class="comment">* caret.</span>
02520 <span class="comment">*</span>
02521 <span class="comment">* History:</span>
02522 <span class="comment">\***************************************************************************/</span>
02523 
<a name="l02524"></a><a class="code" href="../../d6/d0/usercli_8h.html#a452">02524</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(
02525     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
02526     HDC hdc,
02527     BOOL fFastDC)
02528 {
02529     <span class="comment">/*</span>
02530 <span class="comment">     * Restoring font not necessary</span>
02531 <span class="comment">     */</span>
02532 
02533     <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, hdc);
02534 
02535     <span class="keywordflow">if</span> (!fFastDC)
02536         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a234">NtUserShowCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
02537 }
02538 
02539 <span class="comment">/***************************************************************************\</span>
02540 <span class="comment">*</span>
02541 <span class="comment">*  ECResetTextInfo() AorW</span>
02542 <span class="comment">*</span>
02543 <span class="comment">*  Handles a global change to the text by resetting text offsets, emptying</span>
02544 <span class="comment">*  the undo buffer, and rebuilding the lines</span>
02545 <span class="comment">*</span>
02546 <span class="comment">\***************************************************************************/</span>
<a name="l02547"></a><a class="code" href="../../d6/d0/usercli_8h.html#a448">02547</a> <span class="keywordtype">void</span>   <a class="code" href="../../d6/d0/usercli_8h.html#a448">ECResetTextInfo</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
02548 {
02549     <span class="comment">//</span>
02550     <span class="comment">// Reset caret, selections, scrolling, and dirty information.</span>
02551     <span class="comment">//</span>
02552     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = 0;
02553     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> = 0;
02554     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a> = 0;
02555     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o24">fDirty</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02556 
02557     <a class="code" href="../../d6/d0/usercli_8h.html#a444">ECEmptyUndo</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a85">Pundo</a>(ped));
02558 
02559     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a>) {
02560         <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o72">listboxHwnd</a>)
02561             <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_UPDATE);
02562     } <span class="keywordflow">else</span> {
02563 <span class="preprocessor">#ifdef BOGUS</span>
02564 <span class="preprocessor"></span>        <span class="comment">// B#14640</span>
02565         <span class="comment">// We don't want to strip soft breaks or anything else from text</span>
02566         <span class="comment">// that was passed in by the caller. - karlst.</span>
02567         <a class="code" href="../../d6/d0/usercli_8h.html#a499">MLStripCrCrLf</a>(ped);
02568 <span class="preprocessor">#endif</span>
02569 <span class="preprocessor"></span>        <a class="code" href="../../d6/d0/usercli_8h.html#a490">MLBuildchLines</a>(ped, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02570     }
02571 
02572     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">_IsWindowVisible</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>)) {
02573         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fErase;
02574 
02575         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a>)
02576             fErase = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02577         <span class="keywordflow">else</span>
02578             fErase = ((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o10">ichLinesOnScreen</a> + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a>) &gt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>);
02579 
02580         <span class="comment">// Always redraw whether or not the insert was successful.  We might</span>
02581         <span class="comment">// have NULL text.  Paint() will check the redraw flag for us.</span>
02582         <a class="code" href="../../d6/d0/usercli_8h.html#a436">ECInvalidateClient</a>(ped, fErase);
02583 
02584         <span class="comment">// BACKWARD COMPAT HACK: RAID expects the text to have been updated,</span>
02585         <span class="comment">// so we have to do an UpdateWindow here.  It moves an edit control</span>
02586         <span class="comment">// around with fRedraw == FALSE, so it'll never get the paint message</span>
02587         <span class="comment">// with the control in the right place.</span>
02588         <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o43">fWin31Compat</a>)
02589             <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
02590     }
02591 
02592     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a> &amp;&amp; !ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o72">listboxHwnd</a>)
02593         <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_CHANGE);
02594 
02595     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
02596         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a12">NotifyWinEvent</a>(EVENT_OBJECT_VALUECHANGE, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>), OBJID_CLIENT,
02597                 INDEXID_CONTAINER);
02598     }
02599 }
02600 
02601 <span class="comment">/***************************************************************************\</span>
02602 <span class="comment">* ECSetText AorW</span>
02603 <span class="comment">*</span>
02604 <span class="comment">* Copies the null terminated text in lpstr to the ped. Notifies the</span>
02605 <span class="comment">* parent if there isn't enough memory. Sets the minsel, maxsel, and caret to</span>
02606 <span class="comment">* the beginning of the inserted text. Returns TRUE if successful else FALSE</span>
02607 <span class="comment">* if no memory (and notifies the parent).</span>
02608 <span class="comment">*</span>
02609 <span class="comment">* History:</span>
02610 <span class="comment">\***************************************************************************/</span>
02611 
<a name="l02612"></a><a class="code" href="../../d6/d0/usercli_8h.html#a441">02612</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a441">ECSetText</a>(
02613     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
02614     LPSTR lpstr)
02615 {
02616     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cchLength;
02617     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cchSave = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>;
02618     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> ichCaretSave = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02619     HWND hwndSave    = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>;
02620     HANDLE hText;
02621 
02622     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = 0;
02623 
02624     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o1">cchAlloc</a> = <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a6">LOCALSIZE</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o87">hInstance</a>) / ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
02625     <span class="keywordflow">if</span> (!lpstr) {
02626         hText = <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a3">LOCALREALLOC</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a71">CCHALLOCEXTRA</a>*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a0">LHND</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o87">hInstance</a>, &amp;lpstr);
02627         <span class="keywordflow">if</span> (hText != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02628             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a> = hText;
02629         } <span class="keywordflow">else</span> {
02630             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02631         }
02632     } <span class="keywordflow">else</span> {
02633         cchLength = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1134">StringLength</a>(lpstr, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>);
02634 
02635 <span class="preprocessor">#ifdef NEVER</span>
02636 <span class="preprocessor"></span><span class="comment">// win3.1 does limit single line edit controls to 32K (minus 3) but NT doesn't</span>
02637 
02638         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a>) {
02639             <span class="comment">/*</span>
02640 <span class="comment">             * Limit single line edit controls to 32K</span>
02641 <span class="comment">             */</span>
02642             cchLength = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(cchLength, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)(0x7FFD/ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>));
02643         }
02644 <span class="preprocessor">#endif</span>
02645 <span class="preprocessor"></span>
02646         <span class="comment">/*</span>
02647 <span class="comment">         * Add the text</span>
02648 <span class="comment">         */</span>
02649         <span class="keywordflow">if</span> (cchLength &amp;&amp; !<a class="code" href="../../d6/d0/usercli_8h.html#a446">ECInsertText</a>(ped, lpstr, &amp;cchLength)) {
02650 
02651             <span class="comment">/*</span>
02652 <span class="comment">             * Restore original state and notify parent we ran out of memory.</span>
02653 <span class="comment">             */</span>
02654             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> = cchSave;
02655             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = ichCaretSave;
02656             <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_ERRSPACE);
02657             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02658         }
02659     }
02660 
02661     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o1">cchAlloc</a> = <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a6">LOCALSIZE</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o87">hInstance</a>) / ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
02662 
02663     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwndSave))
02664         <a class="code" href="../../d6/d0/usercli_8h.html#a448">ECResetTextInfo</a>(ped);
02665 
02666     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02667 }
02668 
02669 <span class="comment">/***************************************************************************\</span>
02670 <span class="comment">*</span>
02671 <span class="comment">* ECInvalidateClient()</span>
02672 <span class="comment">*</span>
02673 <span class="comment">* Invalidates client of edit field.  For old 3.x guys with borders,</span>
02674 <span class="comment">* we draw it ourself (compatibility).  So we don't want to invalidate</span>
02675 <span class="comment">* the border or we'll get flicker.</span>
02676 <span class="comment">*</span>
02677 <span class="comment">\***************************************************************************/</span>
02678 
<a name="l02679"></a><a class="code" href="../../d6/d0/usercli_8h.html#a436">02679</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a436">ECInvalidateClient</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, BOOL fErase)
02680 {
02681     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o45">fFlatBorder</a>) {
02682         RECT    rcT;
02683 
02684         <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, &amp;rcT);
02685         <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;rcT, -<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER),
02686             -<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER));
02687         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, &amp;rcT, fErase);
02688     } <span class="keywordflow">else</span> {
02689         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, fErase);
02690     }
02691 }
02692 
02693 
02694 <span class="comment">/***************************************************************************\</span>
02695 <span class="comment">* ECCopy AorW</span>
02696 <span class="comment">*</span>
02697 <span class="comment">* Copies the text between ichMinSel and ichMaxSel to the clipboard.</span>
02698 <span class="comment">* Returns the number of characters copied.</span>
02699 <span class="comment">*</span>
02700 <span class="comment">* History:</span>
02701 <span class="comment">\***************************************************************************/</span>
02702 
<a name="l02703"></a><a class="code" href="../../d6/d0/usercli_8h.html#a456">02703</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d6/d0/usercli_8h.html#a456">ECCopy</a>(
02704     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
02705 {
02706     HANDLE hData;
02707     <span class="keywordtype">char</span> *pchSel;
02708     <span class="keywordtype">char</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *lpchClip;
02709     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cbData;
02710 
02711     <span class="comment">/*</span>
02712 <span class="comment">     * Don't allow copies from password style controls</span>
02713 <span class="comment">     */</span>
02714     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o12">charPasswordChar</a>) {
02715         <a class="code" href="../../d6/d0/usercli_8h.html#a219">NtUserMessageBeep</a>(0);
02716         <span class="keywordflow">return</span> 0;
02717     }
02718 
02719     cbData = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
02720 
02721     <span class="keywordflow">if</span> (!cbData)
02722         <span class="keywordflow">return</span> 0;
02723 
02724     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a17">OpenClipboard</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>))
02725         <span class="keywordflow">return</span> 0;
02726 
02727     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a130">NtUserEmptyClipboard</a>();
02728 
02729     <span class="comment">/*</span>
02730 <span class="comment">     * If we just called EmptyClipboard in the context of a 16 bit</span>
02731 <span class="comment">     * app then we also have to tell WOW to nix its 16 handle copy of</span>
02732 <span class="comment">     * clipboard data.  WOW does its own clipboard caching because</span>
02733 <span class="comment">     * some 16 bit apps use clipboard data even after the clipboard</span>
02734 <span class="comment">     * has been emptied.  See the note in the server code.</span>
02735 <span class="comment">     *</span>
02736 <span class="comment">     * Note: this is the only place where EmptyClipboard is called</span>
02737 <span class="comment">     * for a 16 bit app not going through WOW.  If we added others</span>
02738 <span class="comment">     * we might want to move this into EmptyClipboard and have two</span>
02739 <span class="comment">     * versions.</span>
02740 <span class="comment">     */</span>
02741     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;CI_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a114">CI_16BIT</a>) {
02742         <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a62">pfnWowEmptyClipBoard</a>();
02743     }
02744 
02745 
02746     <span class="comment">/*</span>
02747 <span class="comment">     * +1 for the terminating NULL</span>
02748 <span class="comment">     */</span>
02749     <span class="keywordflow">if</span> (!(hData = <a class="code" href="../../d6/d0/usercli_8h.html#a3">UserGlobalAlloc</a>(<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a0">LHND</a>, (LONG)(cbData + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>)))) {
02750         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a129">NtUserCloseClipboard</a>();
02751         <span class="keywordflow">return</span> (0);
02752     }
02753 
02754     <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hData, lpchClip);
02755     UserAssert(lpchClip);
02756     pchSel = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
02757     pchSel = pchSel + (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>);
02758 
02759     RtlCopyMemory(lpchClip, pchSel, cbData);
02760 
02761     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>)
02762         *(lpchClip + cbData) = 0;
02763     <span class="keywordflow">else</span>
02764         *(LPWSTR)(lpchClip + cbData) = (WCHAR)0;
02765 
02766     <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
02767     <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hData);
02768 
02769     <a class="code" href="../../d3/d8/client_8c.html#a43">SetClipboardData</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ? CF_TEXT : CF_UNICODETEXT, hData);
02770 
02771     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a129">NtUserCloseClipboard</a>();
02772 
02773     <span class="keywordflow">return</span> (cbData);
02774 }
02775 
02776 
02777 
02778 <span class="comment">/***************************************************************************\</span>
02779 <span class="comment">* EditWndProcA</span>
02780 <span class="comment">*</span>
02781 <span class="comment">* Always receives Ansi messages and translates them if appropriate to unicode</span>
02782 <span class="comment">* depending on the PED type</span>
02783 <span class="comment">*</span>
02784 <span class="comment">*</span>
02785 <span class="comment">\***************************************************************************/</span>
02786 
<a name="l02787"></a><a class="code" href="../../d6/d0/usercli_8h.html#a596">02787</a> LRESULT <a class="code" href="../../d6/d0/usercli_8h.html#a596">EditWndProcA</a>(
02788     HWND hwnd,
02789     UINT message,
02790     WPARAM wParam,
02791     LPARAM lParam)
02792 {
02793     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
02794 
02795     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02796         <span class="keywordflow">return</span> 0;
02797 
02798     <span class="comment">/*</span>
02799 <span class="comment">     * If the control is not interested in this message,</span>
02800 <span class="comment">     * pass it to DefWindowProc.</span>
02801 <span class="comment">     */</span>
02802     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a10">FWINDOWMSG</a>(message, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a204">FNID_EDIT</a>))
02803         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02804 
02805     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a617">EditWndProcWorker</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02806 }
02807 
<a name="l02808"></a><a class="code" href="../../d6/d0/usercli_8h.html#a597">02808</a> LRESULT <a class="code" href="../../d6/d0/usercli_8h.html#a597">EditWndProcW</a>(
02809     HWND hwnd,
02810     UINT message,
02811     WPARAM wParam,
02812     LPARAM lParam)
02813 {
02814     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
02815 
02816     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02817         <span class="keywordflow">return</span> 0;
02818 
02819     <span class="comment">/*</span>
02820 <span class="comment">     * If the control is not interested in this message,</span>
02821 <span class="comment">     * pass it to DefWindowProc.</span>
02822 <span class="comment">     */</span>
02823     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a10">FWINDOWMSG</a>(message, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a204">FNID_EDIT</a>)) {
02824         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02825     }
02826 
02827     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a617">EditWndProcWorker</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02828 }
02829 
02830 
<a name="l02831"></a><a class="code" href="../../d6/d0/usercli_8h.html#a617">02831</a> LRESULT <a class="code" href="../../d6/d0/usercli_8h.html#a617">EditWndProcWorker</a>(
02832     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
02833     UINT message,
02834     WPARAM wParam,
02835     LPARAM lParam,
02836     DWORD fAnsi)
02837 {
02838     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped;
02839     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
02840     <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fInit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02841 
02842     <a class="code" href="../../d6/d0/usercli_8h.html#a28">VALIDATECLASSANDSIZE</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a204">FNID_EDIT</a>);
02843     <a class="code" href="../../d6/d0/usercli_8h.html#a29">INITCONTROLLOOKASIDE</a>(&amp;<a class="code" href="../../d5/d4/edecrare_8c.html#a5">EditLookaside</a>, <a class="code" href="../../d3/d4/structtagED.html">ED</a>, pwnd, 4);
02844 
02845     <span class="comment">/*</span>
02846 <span class="comment">     * Get the ped for the given window now since we will use it a lot in</span>
02847 <span class="comment">     * various handlers. This was stored using SetWindowLong(hwnd,0,hped) when</span>
02848 <span class="comment">     * we initially created the edit control.</span>
02849 <span class="comment">     */</span>
02850     ped = ((<a class="code" href="../../d4/d4/structtagEDITWND.html">PEDITWND</a>)pwnd)-&gt;ped;
02851 
02852     <span class="comment">/*</span>
02853 <span class="comment">     * Make sure the ANSI flag is set correctly.</span>
02854 <span class="comment">     */</span>
02855     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o47">fInitialized</a>) {
02856         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o47">fInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02857         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a581">WFANSICREATOR</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02858     }
02859 
02860     <span class="comment">/*</span>
02861 <span class="comment">     * We just call the regular EditWndProc if the ped is not created, the</span>
02862 <span class="comment">     * incoming message type already matches the PED type or the message</span>
02863 <span class="comment">     * does not need any translation.</span>
02864 <span class="comment">     */</span>
02865     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> == fAnsi ||
02866             (message &gt;= WM_USER) ||
02867             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1144">MessageTable</a>[message].<a class="code" href="../../d6/d2/structtagMSG__TABLE__ENTRY.html#o1">bThunkMessage</a>) {
02868         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a543">EditWndProc</a>(pwnd, message, wParam, lParam);
02869     }
02870 
02871     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam,
02872                          fAnsi ? (ULONG_PTR)<a class="code" href="../../d8/d4/editec_8c.html#a43">EditWndProcW</a> : (ULONG_PTR)<a class="code" href="../../d8/d4/editec_8c.html#a42">EditWndProcA</a>,
02873                          <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a219">FNID_CALLWINDOWPROC</a>, fAnsi);
02874 }
02875 
02876 <span class="comment">/***************************************************************************\</span>
02877 <span class="comment">* EditWndProc</span>
02878 <span class="comment">*</span>
02879 <span class="comment">* Class procedure for all edit controls.</span>
02880 <span class="comment">* Dispatches all messages to the appropriate handlers which are named</span>
02881 <span class="comment">* as follows:</span>
02882 <span class="comment">* SL (single line) prefixes all single line edit control procedures while</span>
02883 <span class="comment">* ML (multi line) prefixes all multi- line edit controls.</span>
02884 <span class="comment">* EC (edit control) prefixes all common handlers.</span>
02885 <span class="comment">*</span>
02886 <span class="comment">* The EditWndProc only handles messages common to both single and multi</span>
02887 <span class="comment">* line edit controls. Messages which are handled differently between</span>
02888 <span class="comment">* single and multi are sent to SLEditWndProc or MLEditWndProc.</span>
02889 <span class="comment">*</span>
02890 <span class="comment">* Top level procedures are EditWndPoc, SLEditWndProc, and MLEditWndProc.</span>
02891 <span class="comment">* SL*Handler or ML*Handler or EC*Handler procs are called to handle</span>
02892 <span class="comment">* the various messages. Support procedures are prefixed with SL ML or</span>
02893 <span class="comment">* EC depending on which code they support. They are never called</span>
02894 <span class="comment">* directly and most assumptions/effects are documented in the effects</span>
02895 <span class="comment">* clause.</span>
02896 <span class="comment">*</span>
02897 <span class="comment">* WARNING: If you add a message here, add it to gawEditWndProc[] in</span>
02898 <span class="comment">* kernel\server.c too, otherwise EditWndProcA/W will send it straight to</span>
02899 <span class="comment">* DefWindowProcWorker</span>
02900 <span class="comment">*</span>
02901 <span class="comment">* History:</span>
02902 <span class="comment">\***************************************************************************/</span>
02903 
<a name="l02904"></a><a class="code" href="../../d6/d0/usercli_8h.html#a543">02904</a> LRESULT <a class="code" href="../../d6/d0/usercli_8h.html#a543">EditWndProc</a>(
02905     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
02906     UINT message,
02907     WPARAM wParam,
02908     LPARAM lParam)
02909 {
02910     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
02911     LRESULT lreturn;
02912     <a class="code" href="../../d3/d4/structtagED.html">PED</a>  ped;
02913 
02914     <span class="comment">/*</span>
02915 <span class="comment">     * Get the ped for the given window now since we will use it a lot in</span>
02916 <span class="comment">     * various handlers. This was stored using SetWindowLong(hwnd,0,hped) when</span>
02917 <span class="comment">     * we initially created the edit control.</span>
02918 <span class="comment">     */</span>
02919     ped = ((<a class="code" href="../../d4/d4/structtagEDITWND.html">PEDITWND</a>)pwnd)-&gt;ped;
02920 
02921     <span class="comment">/*</span>
02922 <span class="comment">     * Dispatch the various messages we can receive</span>
02923 <span class="comment">     */</span>
02924     lreturn = 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02925     <span class="keywordflow">switch</span> (message) {
02926 
02927     <span class="comment">/*</span>
02928 <span class="comment">     * Messages which are handled the same way for both single and multi line</span>
02929 <span class="comment">     * edit controls.</span>
02930 <span class="comment">     */</span>
02931     <span class="keywordflow">case</span> WM_KEYDOWN:
02932          <span class="comment">// LPK handling of Ctrl/LShift, Ctrl/RShift</span>
02933          <span class="keywordflow">if</span> (ped &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o49">fAllowRTL</a>) {
02934 
02935              ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o48">fSwapRoOnUp</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; <span class="comment">// Any keydown cancels a ctrl/shift reading order change</span>
02936 
02937              <span class="keywordflow">switch</span> (wParam) {
02938                  <span class="keywordflow">case</span> VK_SHIFT:
02939                      <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_CONTROL) &amp; 0x8000) &amp;&amp; !(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_MENU) &amp; 0x8000)) {
02940                          <span class="comment">// Left shift or right shift pressed while control held down</span>
02941                          <span class="comment">// Check that alt (VK_MENU) isn't down to avoid false firing on AltGr which equals Ctrl+Alt.</span>
02942                          <span class="keywordflow">if</span> (<a class="code" href="../../d0/d8/ntcftxt_8h.html#a18">MapVirtualKey</a>((LONG)lParam&gt;&gt;16&amp;0xff, 3) == VK_LSHIFT) {
02943                              <span class="comment">// User wants left to right reading order</span>
02944                              ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o48">fSwapRoOnUp</a> = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a>)  || (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> &amp; ES_RIGHT) ;
02945                              ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o58">fLShift</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02946                          } <span class="keywordflow">else</span> {
02947                              <span class="comment">// User wants right to left reading order</span>
02948                              ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o48">fSwapRoOnUp</a> = (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a>) || (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> &amp; ES_RIGHT);
02949                              ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o58">fLShift</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02950                          }
02951                      }
02952                      <span class="keywordflow">break</span>;
02953 
02954                  <span class="keywordflow">case</span> VK_LEFT:
02955                      <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a>) {
02956                         wParam = VK_RIGHT;
02957                      }
02958                      <span class="keywordflow">break</span>;
02959 
02960                  <span class="keywordflow">case</span> VK_RIGHT:
02961                      <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a>) {
02962                          wParam = VK_LEFT;
02963                      }
02964                      <span class="keywordflow">break</span>;
02965              }
02966          }
02967          <span class="keywordflow">goto</span> HandleEditMsg;
02968 
02969     <span class="keywordflow">case</span> WM_KEYUP:
02970         <span class="keywordflow">if</span> (ped &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o49">fAllowRTL</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o48">fSwapRoOnUp</a>) {
02971 
02972             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fReadingOrder;
02973             <span class="comment">// Complete reading order change detected earlier during keydown</span>
02974 
02975             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o48">fSwapRoOnUp</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02976             fReadingOrder = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a>;
02977 
02978             <span class="comment">// Remove any overriding ES_CENTRE or ES_RIGHT format from dwStyle</span>
02979             SetWindowLong(hwnd, GWL_STYLE, GetWindowLong(hwnd, GWL_STYLE) &amp; ~ES_FMTMASK);
02980 
02981             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o58">fLShift</a>) {
02982                 <span class="comment">// Set Left to Right reading order and right scrollbar in EX_STYLE</span>
02983                 SetWindowLong(hwnd, GWL_EXSTYLE, GetWindowLong(hwnd, GWL_EXSTYLE)
02984                               &amp; ~(WS_EX_RTLREADING | WS_EX_RIGHT | WS_EX_LEFTSCROLLBAR));
02985 
02986                 <span class="comment">// Edit control is LTR now, then notify the parent.</span>
02987                 <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_ALIGN_LTR_EC);
02988                 <span class="comment">// ? Select a keyboard layout appropriate to LTR operation</span>
02989             } <span class="keywordflow">else</span> {
02990                 <span class="comment">// Set Right to Left reading order, right alignment and left scrollbar</span>
02991                 SetWindowLong(hwnd, GWL_EXSTYLE, GetWindowLong(hwnd, GWL_EXSTYLE)
02992                               | WS_EX_RTLREADING | WS_EX_RIGHT | WS_EX_LEFTSCROLLBAR);
02993 
02994                 <span class="comment">// Edit control is RTL now, then notify the parent.</span>
02995                 <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_ALIGN_RTL_EC);
02996                 <span class="comment">// ? Select a keyboard layout appropriate to RTL operation</span>
02997             }
02998 
02999             <span class="comment">// If reading order didn't change, so we are sure the alignment changed and the edit window didn't invalidate yet.</span>
03000             <span class="keywordflow">if</span> (fReadingOrder == (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>) ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a>) {
03001               <a class="code" href="../../d6/d0/usercli_8h.html#a436">ECInvalidateClient</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03002             }
03003         }
03004         <span class="keywordflow">goto</span> HandleEditMsg;
03005 
03006     <span class="keywordflow">case</span> WM_INPUTLANGCHANGE:
03007         <span class="keywordflow">if</span> (ped) {
03008             <span class="comment">// EC_INSERT_COMPOSITION_CHAR : WM_INPUTLANGCHANGE - call ECInitInsert()</span>
03009             HKL hkl = <a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>();
03010 
03011             <a class="code" href="../../d6/d0/usercli_8h.html#a473">ECInitInsert</a>(ped, hkl);
03012 
03013             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o57">fInReconversion</a>) {
03014                 <a class="code" href="../../d6/d0/usercli_8h.html#a477">ECInOutReconversionMode</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03015             }
03016 
03017             <span class="comment">//</span>
03018             <span class="comment">// Font and caret position might be changed while</span>
03019             <span class="comment">// another keyboard layout is active. Set those</span>
03020             <span class="comment">// if the edit control has the focus.</span>
03021             <span class="comment">//</span>
03022             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a> &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a312">fpImmIsIME</a>(hkl)) {
03023                 POINT pt;
03024 
03025                 <a class="code" href="../../d6/d0/usercli_8h.html#a470">ECImmSetCompositionFont</a>(ped);
03026                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a274">NtUserGetCaretPos</a>(&amp;pt);
03027                 <a class="code" href="../../d6/d0/usercli_8h.html#a471">ECImmSetCompositionWindow</a>(ped, pt.x, pt.y);
03028             }
03029         }
03030 
03031         <span class="keywordflow">goto</span> HandleEditMsg;
03032 
03033     <span class="keywordflow">case</span> WM_COPY:
03034 
03035         <span class="comment">/*</span>
03036 <span class="comment">         * wParam - not used</span>
03037 <span class="comment">         * lParam - not used</span>
03038 <span class="comment">         */</span>
03039         lreturn = (LONG)<a class="code" href="../../d6/d0/usercli_8h.html#a456">ECCopy</a>(ped);
03040         <span class="keywordflow">break</span>;
03041 
03042     <span class="keywordflow">case</span> WM_CUT:
03043         <span class="comment">/*</span>
03044 <span class="comment">         *</span>
03045 <span class="comment">         * wParamLo --    unused</span>
03046 <span class="comment">         * lParam --    unused</span>
03047 <span class="comment">         */</span>
03048         <a class="code" href="../../d8/d4/editec_8c.html#a21">ECCutText</a>(ped);
03049         <span class="keywordflow">return</span> 0;
03050 
03051     <span class="keywordflow">case</span> WM_CLEAR:
03052         <span class="comment">/*</span>
03053 <span class="comment">         * wParamLo --    unused</span>
03054 <span class="comment">         * lParam --    unused</span>
03055 <span class="comment">         */</span>
03056         <a class="code" href="../../d8/d4/editec_8c.html#a20">ECClearText</a>(ped);
03057         <span class="keywordflow">return</span> 0;
03058 
03059     <span class="keywordflow">case</span> WM_ENABLE:
03060 
03061         <span class="comment">/*</span>
03062 <span class="comment">         * wParam - nonzero if window is enabled else disable window if 0.</span>
03063 <span class="comment">         * lParam - not used</span>
03064 <span class="comment">         */</span>
03065         lreturn = (LONG)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o25">fDisabled</a> = !((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)wParam));
03066         <a class="code" href="../../d6/d0/usercli_8h.html#a436">ECInvalidateClient</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03067         <span class="keywordflow">break</span>;
03068 
03069     <span class="keywordflow">case</span> WM_SYSCHAR:
03070         <span class="comment">//</span>
03071         <span class="comment">// wParamLo --    key value</span>
03072         <span class="comment">// lParam --    unused</span>
03073         <span class="comment">//</span>
03074 
03075         <span class="comment">//</span>
03076         <span class="comment">// If this is a WM_SYSCHAR message generated by the UNDO</span>
03077         <span class="comment">// keystroke we want to EAT IT</span>
03078         <span class="comment">//</span>
03079         <span class="keywordflow">if</span> ((lParam &amp; <a class="code" href="../../d3/d5/editsl_8c.html#a0">SYS_ALTERNATE</a>) &amp;&amp; ((WORD)wParam == VK_BACK))
03080             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03081         <span class="keywordflow">else</span> {
03082             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>);
03083         }
03084         <span class="keywordflow">break</span>;
03085 
03086     <span class="keywordflow">case</span> EM_GETLINECOUNT:
03087 
03088         <span class="comment">/*</span>
03089 <span class="comment">         * wParam - not used</span>
03090 <span class="comment">           lParam - not used</span>
03091 <span class="comment">         */</span>
03092         lreturn = (LONG)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>;
03093         <span class="keywordflow">break</span>;
03094 
03095     <span class="keywordflow">case</span> EM_GETMODIFY:
03096 
03097         <span class="comment">/*</span>
03098 <span class="comment">         * wParam - not used</span>
03099 <span class="comment">           lParam - not used</span>
03100 <span class="comment">         */</span>
03101 
03102         <span class="comment">/*</span>
03103 <span class="comment">         * Gets the state of the modify flag for this edit control.</span>
03104 <span class="comment">         */</span>
03105         lreturn = (LONG)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o24">fDirty</a>;
03106         <span class="keywordflow">break</span>;
03107 
03108     <span class="keywordflow">case</span> EM_SETMODIFY:
03109 
03110         <span class="comment">/*</span>
03111 <span class="comment">         * wParam - specifies the new value for the modify flag</span>
03112 <span class="comment">           lParam - not used</span>
03113 <span class="comment">         */</span>
03114 
03115         <span class="comment">/*</span>
03116 <span class="comment">         * Sets the state of the modify flag for this edit control.</span>
03117 <span class="comment">         */</span>
03118         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o24">fDirty</a> = (wParam != 0);
03119         <span class="keywordflow">break</span>;
03120 
03121     <span class="keywordflow">case</span> EM_GETRECT:
03122 
03123         <span class="comment">/*</span>
03124 <span class="comment">         * wParam - not used</span>
03125 <span class="comment">           lParam - pointer to a RECT data structure that gets the dimensions.</span>
03126 <span class="comment">         */</span>
03127 
03128         <span class="comment">/*</span>
03129 <span class="comment">         * Copies the rcFmt rect to *lpRect.</span>
03130 <span class="comment">         */</span>
03131         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>((LPRECT)lParam, (LPRECT)&amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>);
03132         lreturn = (LONG)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03133         <span class="keywordflow">break</span>;
03134 
03135     <span class="keywordflow">case</span> WM_GETFONT:
03136 
03137         <span class="comment">/*</span>
03138 <span class="comment">         * wParam - not used</span>
03139 <span class="comment">           lParam - not used</span>
03140 <span class="comment">         */</span>
03141         lreturn = (LRESULT)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o66">hFont</a>;
03142         <span class="keywordflow">break</span>;
03143 
03144     <span class="keywordflow">case</span> WM_SETFONT:
03145 
03146         <span class="comment">/*</span>
03147 <span class="comment">         * wParam - handle to the font</span>
03148 <span class="comment">           lParam - redraw if true else don't</span>
03149 <span class="comment">         */</span>
03150         <a class="code" href="../../d6/d0/usercli_8h.html#a454">ECSetFont</a>(ped, (HANDLE)wParam, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)LOWORD(lParam));
03151         <span class="keywordflow">break</span>;
03152 
03153     <span class="keywordflow">case</span> WM_GETTEXT:
03154 
03155         <span class="comment">/*</span>
03156 <span class="comment">         * wParam - max number of _bytes_ (not characters) to copy</span>
03157 <span class="comment">         * lParam - buffer to copy text to. Text is 0 terminated.</span>
03158 <span class="comment">         */</span>
03159         lreturn = (LRESULT)<a class="code" href="../../d6/d0/usercli_8h.html#a453">ECGetText</a>(ped, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)wParam, (LPSTR)lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03160         <span class="keywordflow">break</span>;
03161 
03162     <span class="keywordflow">case</span> WM_SETTEXT:
03163         <span class="comment">//</span>
03164         <span class="comment">// wParamLo --    unused</span>
03165         <span class="comment">// lParam --    LPSTR, null-terminated, with new text.</span>
03166         <span class="comment">//</span>
03167         lreturn = (LRESULT)<a class="code" href="../../d6/d0/usercli_8h.html#a441">ECSetText</a>(ped, (LPSTR)lParam);
03168         <span class="keywordflow">break</span>;
03169 
03170     <span class="keywordflow">case</span> WM_GETTEXTLENGTH:
03171 
03172         <span class="comment">/*</span>
03173 <span class="comment">         * Return count of CHARs!!!</span>
03174 <span class="comment">         */</span>
03175         lreturn = (LONG)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>;
03176         <span class="keywordflow">break</span>;
03177 
03178     <span class="keywordflow">case</span> WM_NCDESTROY:
03179     <span class="keywordflow">case</span> WM_FINALDESTROY:
03180 
03181         <span class="comment">/*</span>
03182 <span class="comment">         * wParam - not used</span>
03183 <span class="comment">           lParam - not used</span>
03184 <span class="comment">         */</span>
03185         <a class="code" href="../../d6/d0/usercli_8h.html#a440">ECNcDestroyHandler</a>(pwnd, ped);
03186         <span class="keywordflow">return</span> 0;
03187 
03188     <span class="comment">/*</span>
03189 <span class="comment">     * Most apps (i.e. everyone but Quicken) don't pass on the rbutton</span>
03190 <span class="comment">     * messages when they do something with 'em inside of subclassed</span>
03191 <span class="comment">     * edit fields.  As such, we keep track of whether we saw the</span>
03192 <span class="comment">     * down before the up.  If we don't see the up, then DefWindowProc</span>
03193 <span class="comment">     * won't generate the context menu message, so no big deal.  If</span>
03194 <span class="comment">     * we didn't see the down, then don't let WM_CONTEXTMENU do</span>
03195 <span class="comment">     * anything.</span>
03196 <span class="comment">     *</span>
03197 <span class="comment">     * We also might want to not generate WM_CONTEXTMENUs for old</span>
03198 <span class="comment">     * apps when the mouse is captured.</span>
03199 <span class="comment">     */</span>
03200 
03201     <span class="keywordflow">case</span> WM_RBUTTONDOWN:
03202         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o46">fSawRButtonDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03203         <span class="keywordflow">goto</span> HandleEditMsg;
03204 
03205     <span class="keywordflow">case</span> WM_RBUTTONUP:
03206         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o46">fSawRButtonDown</a>) {
03207             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o46">fSawRButtonDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03208             <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o57">fInReconversion</a>) {
03209                 <span class="keywordflow">goto</span> HandleEditMsg;
03210             }
03211         }
03212         <span class="comment">// Don't pass this on to DWP so WM_CONTEXTMENU isn't generated.</span>
03213         <span class="keywordflow">return</span> 0;
03214 
03215     <span class="keywordflow">case</span> WM_CONTEXTMENU: {
03216             POINT pt ;
03217             <span class="keywordtype">int</span> nHit = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a0">FindNCHit</a>(pwnd, (LONG)lParam);
03218             <span class="keywordflow">if</span> ((nHit == HTVSCROLL) || (nHit == HTHSCROLL)) {
03219                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>);
03220             }
03221             POINTSTOPOINT(pt, lParam);
03222             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a587">WFOLDUI</a>) &amp;&amp; <a class="code" href="../../d8/d4/editec_8c.html#a15">ECIsAncestorActive</a>(hwnd))
03223                 <a class="code" href="../../d8/d4/editec_8c.html#a19">ECMenu</a>(hwnd, ped, &amp;pt);
03224         }
03225         <span class="keywordflow">return</span> 0;
03226 
03227     <span class="keywordflow">case</span> EM_CANUNDO:
03228 
03229         <span class="comment">/*</span>
03230 <span class="comment">         * wParam - not used</span>
03231 <span class="comment">           lParam - not used</span>
03232 <span class="comment">         */</span>
03233         lreturn = (LONG)(ped-&gt;undoType != <a class="code" href="../../d6/d0/usercli_8h.html#a82">UNDO_NONE</a>);
03234         <span class="keywordflow">break</span>;
03235 
03236     <span class="keywordflow">case</span> EM_EMPTYUNDOBUFFER:
03237 
03238         <span class="comment">/*</span>
03239 <span class="comment">         * wParam - not used</span>
03240 <span class="comment">           lParam - not used</span>
03241 <span class="comment">         */</span>
03242         <a class="code" href="../../d6/d0/usercli_8h.html#a444">ECEmptyUndo</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a85">Pundo</a>(ped));
03243         <span class="keywordflow">break</span>;
03244 
03245     <span class="keywordflow">case</span> EM_GETMARGINS:
03246         <span class="comment">//</span>
03247         <span class="comment">// wParam --    unused</span>
03248         <span class="comment">// lParam --    unused</span>
03249         <span class="comment">//</span>
03250         <span class="keywordflow">return</span>(MAKELONG(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>));
03251 
03252     <span class="keywordflow">case</span> EM_SETMARGINS:
03253         <span class="comment">//</span>
03254         <span class="comment">// wParam --    EC_ margin flags</span>
03255         <span class="comment">// lParam --    LOWORD is left, HIWORD is right margin</span>
03256         <span class="comment">//</span>
03257         <a class="code" href="../../d6/d0/usercli_8h.html#a455">ECSetMargin</a>(ped, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03258         <span class="keywordflow">return</span> 0;
03259 
03260     <span class="keywordflow">case</span> EM_GETSEL:
03261 
03262         <span class="comment">/*</span>
03263 <span class="comment">         * Gets the selection range for the given edit control. The</span>
03264 <span class="comment">         * starting position is in the low order word. It contains the position</span>
03265 <span class="comment">         * of the first nonselected character after the end of the selection in</span>
03266 <span class="comment">         * the high order word.</span>
03267 <span class="comment">         */</span>
03268         <span class="keywordflow">if</span> ((PDWORD)wParam != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03269            *((PDWORD)wParam) = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
03270         }
03271         <span class="keywordflow">if</span> ((PDWORD)lParam != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03272            *((PDWORD)lParam) = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>;
03273         }
03274         lreturn = MAKELONG(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>,ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>);
03275         <span class="keywordflow">break</span>;
03276 
03277     <span class="keywordflow">case</span> EM_GETLIMITTEXT:
03278         <span class="comment">//</span>
03279         <span class="comment">// wParamLo --    unused</span>
03280         <span class="comment">// lParam --    unused</span>
03281         <span class="comment">//</span>
03282         <span class="keywordflow">return</span>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o2">cchTextMax</a>);
03283 
03284     <span class="keywordflow">case</span> EM_SETLIMITTEXT:        <span class="comment">/* Renamed from EM_LIMITTEXT in Chicago */</span>
03285         <span class="comment">/*</span>
03286 <span class="comment">         * wParam - max number of CHARACTERS that can be entered</span>
03287 <span class="comment">         * lParam - not used</span>
03288 <span class="comment">         */</span>
03289 
03290         <span class="comment">/*</span>
03291 <span class="comment">         * Specifies the maximum number of characters of text the user may</span>
03292 <span class="comment">         * enter. If maxLength is 0, we may enter MAXINT number of CHARACTERS.</span>
03293 <span class="comment">         */</span>
03294         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a>) {
03295             <span class="keywordflow">if</span> (wParam) {
03296                 wParam = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(0x7FFFFFFEu, wParam);
03297             } <span class="keywordflow">else</span> {
03298                 wParam = 0x7FFFFFFEu;
03299             }
03300         }
03301 
03302         <span class="keywordflow">if</span> (wParam) {
03303             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o2">cchTextMax</a> = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)wParam;
03304         } <span class="keywordflow">else</span> {
03305             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o2">cchTextMax</a> = 0xFFFFFFFFu;
03306         }
03307         <span class="keywordflow">break</span>;
03308 
03309     <span class="keywordflow">case</span> EM_POSFROMCHAR:
03310         <span class="comment">//</span>
03311         <span class="comment">// Validate that char index is within text range</span>
03312         <span class="comment">//</span>
03313         <span class="keywordflow">if</span> (wParam &gt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
03314             <span class="keywordflow">return</span>(-1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
03315         }
03316         <span class="keywordflow">goto</span> HandleEditMsg;
03317 
03318     <span class="keywordflow">case</span> EM_CHARFROMPOS: {
03319         <span class="comment">// Validate that point is within client of edit field</span>
03320         RECT    rc;
03321         POINT   pt;
03322 
03323         POINTSTOPOINT(pt, lParam);
03324         <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(pwnd, &amp;rc);
03325         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;rc, pt)) {
03326             <span class="keywordflow">return</span>(-1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
03327         }
03328         <span class="keywordflow">goto</span> HandleEditMsg;
03329     }
03330 
03331     <span class="keywordflow">case</span> EM_SETPASSWORDCHAR:
03332 
03333         <span class="comment">/*</span>
03334 <span class="comment">         * wParam - sepecifies the new char to display instead of the</span>
03335 <span class="comment">         * real text. if null, display the real text.</span>
03336 <span class="comment">         */</span>
03337         <a class="code" href="../../d6/d0/usercli_8h.html#a442">ECSetPasswordChar</a>(ped, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam);
03338         <span class="keywordflow">break</span>;
03339 
03340     <span class="keywordflow">case</span> EM_GETPASSWORDCHAR:
03341         lreturn = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o12">charPasswordChar</a>;
03342         <span class="keywordflow">break</span>;
03343 
03344     <span class="keywordflow">case</span> EM_SETREADONLY:
03345 
03346         <span class="comment">/*</span>
03347 <span class="comment">         * wParam - state to set read only flag to</span>
03348 <span class="comment">         */</span>
03349         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o39">fReadOnly</a> = (wParam != 0);
03350         <span class="keywordflow">if</span> (wParam)
03351             <a class="code" href="../../d4/d1/userk_8h.html#a1628">SetWindowState</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a710">EFREADONLY</a>);
03352         <span class="keywordflow">else</span>
03353             <a class="code" href="../../d4/d1/userk_8h.html#a1629">ClearWindowState</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a710">EFREADONLY</a>);
03354         lreturn = 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03355 
03356         <a class="code" href="../../d6/d0/usercli_8h.html#a469">ECEnableDisableIME</a>( ped );
03357         <span class="comment">// We need to redraw the edit field so that the background color</span>
03358         <span class="comment">// changes.  Read-only edits are drawn in CTLCOLOR_STATIC while</span>
03359         <span class="comment">// others are drawn with CTLCOLOR_EDIT.</span>
03360         <a class="code" href="../../d6/d0/usercli_8h.html#a436">ECInvalidateClient</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03361         <span class="keywordflow">break</span>;
03362 
03363     <span class="keywordflow">case</span> EM_SETWORDBREAKPROC:
03364 
03365         <span class="comment">/*</span>
03366 <span class="comment">         * wParam - unused</span>
03367 <span class="comment">         * lParam - FARPROC address of an app supplied call back function</span>
03368 <span class="comment">         */</span>
03369         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o63">lpfnNextWord</a> = (EDITWORDBREAKPROCA)lParam;
03370         <span class="keywordflow">break</span>;
03371 
03372     <span class="keywordflow">case</span> EM_GETWORDBREAKPROC:
03373         lreturn = (LRESULT)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o63">lpfnNextWord</a>;
03374         <span class="keywordflow">break</span>;
03375 
03376     <span class="comment">// IME</span>
03377     <span class="keywordflow">case</span> EM_GETIMESTATUS:
03378         <span class="comment">// wParam == sub command</span>
03379         <span class="keywordflow">switch</span> (wParam) {
03380         <span class="keywordflow">case</span>  EMSIS_COMPOSITIONSTRING:
03381             <span class="keywordflow">return</span> ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o59">wImeStatus</a>;
03382 <span class="preprocessor">#if 0   // memphis</span>
03383 <span class="preprocessor"></span>        <span class="keywordflow">case</span>  EMSIS_GETLBBIT:
03384             <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)ped-&gt;bLBBit;
03385 <span class="preprocessor">#endif</span>
03386 <span class="preprocessor"></span>        }
03387         <span class="keywordflow">break</span>;
03388 
03389     <span class="keywordflow">case</span> EM_SETIMESTATUS:
03390         <span class="comment">// wParam == sub command</span>
03391         <span class="keywordflow">switch</span> (wParam) {
03392         <span class="keywordflow">case</span> EMSIS_COMPOSITIONSTRING:
03393             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o59">wImeStatus</a> = (WORD)lParam;
03394         }
03395         <span class="keywordflow">break</span>;
03396 
03397 
03398     <span class="keywordflow">case</span> WM_NCCREATE:
03399         lreturn = <a class="code" href="../../d6/d0/usercli_8h.html#a435">ECNcCreate</a>(ped, pwnd, (LPCREATESTRUCT)lParam);
03400         <span class="keywordflow">break</span>;
03401 
03402     <span class="keywordflow">case</span> WM_LBUTTONDOWN:
03403         <span class="comment">//</span>
03404         <span class="comment">// B#3623</span>
03405         <span class="comment">// Don't set focus to edit field if it is within an inactive,</span>
03406         <span class="comment">// captioned child.</span>
03407         <span class="comment">// We might want to version switch this...  I haven't found</span>
03408         <span class="comment">// any problems by not, but you never know...</span>
03409         <span class="comment">//</span>
03410         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/editec_8c.html#a15">ECIsAncestorActive</a>(hwnd)) {
03411             <span class="comment">/*</span>
03412 <span class="comment">             * Reconversion support: quit reconversion if left button is clicked.</span>
03413 <span class="comment">             * Otherwise, if the current KL is Korean, finailize the composition string.</span>
03414 <span class="comment">             */</span>
03415             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o57">fInReconversion</a> || ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o56">fKorea</a>) {
03416                 BOOLEAN fReconversion = (BOOLEAN)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o57">fInReconversion</a>;
03417                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIndex = fReconversion ? CPS_CANCEL : CPS_COMPLETE;
03418                 HIMC hImc;
03419 
03420                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03421 
03422                 hImc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
03423                 <span class="keywordflow">if</span> (hImc) {
03424                     <a class="code" href="../../d6/d0/usercli_8h.html#a322">fpImmNotifyIME</a>(hImc, NI_COMPOSITIONSTR, dwIndex, 0);
03425                     <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, hImc);
03426                 }
03427 
03428                 <span class="keywordflow">if</span> (fReconversion) {
03429                     <a class="code" href="../../d6/d0/usercli_8h.html#a477">ECInOutReconversionMode</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03430                 }
03431 
03432                 <a class="code" href="../../d6/d0/usercli_8h.html#a472">ECSetCaretHandler</a>(ped);
03433             }
03434 
03435             <span class="keywordflow">goto</span> HandleEditMsg;
03436         }
03437         <span class="keywordflow">break</span>;
03438 
03439     <span class="keywordflow">case</span> WM_MOUSEMOVE:
03440         <span class="comment">//</span>
03441         <span class="comment">// We only care about mouse messages when mouse is down.</span>
03442         <span class="comment">//</span>
03443         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o22">fMouseDown</a>)
03444             <span class="keywordflow">goto</span> HandleEditMsg;
03445         <span class="keywordflow">break</span>;
03446 
03447     <span class="keywordflow">case</span> WM_IME_SETCONTEXT:
03448         <span class="comment">//</span>
03449         <span class="comment">// If ped-&gt;fInsertCompChr is TRUE, that means we will do</span>
03450         <span class="comment">// all the composition character drawing by ourself.</span>
03451         <span class="comment">//</span>
03452         <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o52">fInsertCompChr</a> ) {
03453             lParam &amp;= ~ISC_SHOWUICOMPOSITIONWINDOW;
03454         }
03455 
03456         <span class="keywordflow">if</span> ( wParam ) {
03457 
03458             PINPUTCONTEXT pInputContext;
03459             HIMC hImc;
03460 
03461             hImc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>( hwnd );
03462             <span class="keywordflow">if</span> ( (pInputContext = <a class="code" href="../../d6/d0/usercli_8h.html#a313">fpImmLockIMC</a>( hImc )) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03463                 pInputContext-&gt;fdw31Compat &amp;= ~F31COMPAT_ECSETCFS;
03464                 <a class="code" href="../../d6/d0/usercli_8h.html#a323">fpImmUnlockIMC</a>( hImc );
03465             }
03466             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;CI_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a114">CI_16BIT</a>) {
03467                 <a class="code" href="../../d6/d0/usercli_8h.html#a322">fpImmNotifyIME</a>(hImc, NI_COMPOSITIONSTR, CPS_CANCEL, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
03468             }
03469             <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>( hwnd, hImc );
03470         }
03471         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>);
03472 
03473     <span class="keywordflow">case</span> WM_IME_ENDCOMPOSITION:
03474         <a class="code" href="../../d6/d0/usercli_8h.html#a477">ECInOutReconversionMode</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03475 
03476         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a>) {
03477             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> ich;
03478             HDC hdc;
03479             <span class="comment">//</span>
03480             <span class="comment">// we have a DBCS character to be replaced.</span>
03481             <span class="comment">// let's delete it before inserting the new one.</span>
03482             <span class="comment">//</span>
03483             ich = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) ? 2 : 1;
03484             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03485             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> + ich, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>);
03486             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
03487             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a>) {
03488                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a447">ECDeleteText</a>( ped ) &gt; 0) {
03489                     <span class="comment">//</span>
03490                     <span class="comment">// Update the display</span>
03491                     <span class="comment">//</span>
03492                     <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_UPDATE);
03493                     hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03494                     <a class="code" href="../../d6/d0/usercli_8h.html#a527">SLDrawText</a>(ped, hdc, 0);
03495                     <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03496                     <span class="comment">//</span>
03497                     <span class="comment">// Tell parent our text contents changed.</span>
03498                     <span class="comment">//</span>
03499                     <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_CHANGE);
03500                 }
03501             }
03502             <span class="keywordflow">else</span> {
03503                 <a class="code" href="../../d6/d0/usercli_8h.html#a484">MLDeleteText</a>(ped);
03504             }
03505 
03506             <a class="code" href="../../d6/d0/usercli_8h.html#a472">ECSetCaretHandler</a>( ped );
03507         }
03508         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>);
03509 
03510     <span class="keywordflow">case</span> WM_IME_STARTCOMPOSITION:
03511         <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o52">fInsertCompChr</a> ) {
03512             <span class="comment">//</span>
03513             <span class="comment">// BUG BUG</span>
03514             <span class="comment">//</span>
03515             <span class="comment">// sending WM_IME_xxxCOMPOSITION will let</span>
03516             <span class="comment">// IME draw composition window. IME should</span>
03517             <span class="comment">// not do that since we cleared</span>
03518             <span class="comment">// ISC_SHOWUICOMPOSITIONWINDOW bit when</span>
03519             <span class="comment">// we got WM_IME_SETCONTEXT message.</span>
03520             <span class="comment">//</span>
03521             <span class="comment">// Korean IME should be fixed in the future.</span>
03522             <span class="comment">//</span>
03523             <span class="keywordflow">break</span>;
03524 
03525         } <span class="keywordflow">else</span> {
03526             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>);
03527         }
03528 
03529     <span class="comment">// simple composition character support for FE IME.</span>
03530     <span class="keywordflow">case</span> WM_IME_COMPOSITION:
03531         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a474">ECImeComposition</a>(ped, wParam, lParam);
03532 
03533     <span class="keywordflow">case</span> WM_KILLFOCUS:
03534         <span class="comment">//</span>
03535         <span class="comment">// when focus is removed from the window,</span>
03536         <span class="comment">// composition character should be finalized</span>
03537         <span class="comment">//</span>
03538         <span class="keywordflow">if</span> (ped &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a312">fpImmIsIME</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>())) {
03539             HIMC hImc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>(hwnd);
03540 
03541             <span class="keywordflow">if</span> (hImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>) {
03542                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o53">fReplaceCompChr</a> || (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o59">wImeStatus</a> &amp; EIMES_COMPLETECOMPSTRKILLFOCUS)) {
03543                     <span class="comment">// If the composition string to be determined upon kill focus,</span>
03544                     <span class="comment">// do it now.</span>
03545                     <a class="code" href="../../d6/d0/usercli_8h.html#a322">fpImmNotifyIME</a>(hImc, NI_COMPOSITIONSTR, CPS_COMPLETE, 0);
03546                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o57">fInReconversion</a>) {
03547                     <span class="comment">// If the composition string it not to be determined,</span>
03548                     <span class="comment">// and if we're in reconversion mode, cancel reconversion now.</span>
03549                     <a class="code" href="../../d6/d0/usercli_8h.html#a322">fpImmNotifyIME</a>(hImc, NI_COMPOSITIONSTR, CPS_CANCEL, 0);
03550                 }
03551 
03552                 <span class="comment">// Get out from reconversion mode</span>
03553                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o57">fInReconversion</a>) {
03554                     <a class="code" href="../../d6/d0/usercli_8h.html#a477">ECInOutReconversionMode</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03555                 }
03556 
03557                 <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(hwnd, hImc);
03558             }
03559         }
03560         <span class="keywordflow">goto</span> HandleEditMsg;
03561         <span class="keywordflow">break</span>;
03562 
03563     <span class="keywordflow">case</span> WM_SETFOCUS:
03564         <span class="keywordflow">if</span> (ped &amp;&amp; !ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a>) {
03565             HKL hkl = <a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>();
03566 
03567             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a312">fpImmIsIME</a>(hkl)) {
03568                 HIMC hImc;
03569 
03570                 hImc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>(hwnd);
03571                 <span class="keywordflow">if</span> (hImc) {
03572                     LPINPUTCONTEXT lpImc;
03573 
03574                     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o59">wImeStatus</a> &amp; EIMES_CANCELCOMPSTRINFOCUS) {
03575                         <span class="comment">// cancel when in-focus</span>
03576                         <a class="code" href="../../d6/d0/usercli_8h.html#a322">fpImmNotifyIME</a>(hImc, NI_COMPOSITIONSTR, CPS_CANCEL, 0);
03577                     }
03578 
03579                     <a class="code" href="../../d6/d0/usercli_8h.html#a470">ECImmSetCompositionFont</a>(ped);
03580 
03581                     <span class="keywordflow">if</span> ((lpImc = <a class="code" href="../../d6/d0/usercli_8h.html#a313">fpImmLockIMC</a>(hImc)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03582 
03583                         <span class="comment">// We presume the CompForm will reset to CFS_DEFAULT,</span>
03584                         <span class="comment">// when the edit control loses Focus.</span>
03585                         <span class="comment">// IMEWndProc32 will call ImmSetCompositionWindow with</span>
03586                         <span class="comment">// CFS_DEFAULT, when it receive WM_IME_SETCONTEXT.</span>
03587                         lpImc-&gt;fdw31Compat |= F31COMPAT_ECSETCFS;
03588 
03589                         <a class="code" href="../../d6/d0/usercli_8h.html#a323">fpImmUnlockIMC</a>(hImc);
03590                     }
03591                     <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(hwnd, hImc);
03592                 }
03593 
03594                 <span class="comment">//</span>
03595                 <span class="comment">// force to set IME composition window when</span>
03596                 <span class="comment">// first getting focus.</span>
03597                 <span class="comment">//</span>
03598                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o93">ptScreenBounding</a>.x = -1;
03599                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o93">ptScreenBounding</a>.y = -1;
03600             }
03601             <a class="code" href="../../d6/d0/usercli_8h.html#a473">ECInitInsert</a>(ped, hkl);
03602         }
03603         <span class="keywordflow">goto</span> HandleEditMsg;
03604         <span class="keywordflow">break</span>;
03605 
03606     <span class="keywordflow">case</span> WM_IME_REQUEST:
03607         <span class="comment">// simple ImeRequest Handler</span>
03608         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a475">EcImeRequestHandler</a>(ped, wParam, lParam);
03609 
03610     <span class="keywordflow">case</span> WM_CREATE:
03611         <span class="keywordflow">if</span> (ped)
03612             <a class="code" href="../../d6/d0/usercli_8h.html#a469">ECEnableDisableIME</a>(ped);
03613         <span class="keywordflow">goto</span> HandleEditMsg;
03614         <span class="keywordflow">break</span>;
03615 
03616     <span class="keywordflow">default</span>:
03617 HandleEditMsg:
03618         <span class="comment">/* (picked up from NT40FE SP3)</span>
03619 <span class="comment">         * HACK ALERT: We may receive messages before the PED has been</span>
03620 <span class="comment">         * allocated (eg: WM_GETMINMAXINFO is sent before WM_NCCREATE)</span>
03621 <span class="comment">         * so we must test ped before dreferencing.</span>
03622 <span class="comment">         */</span>
03623         <span class="keywordflow">if</span> (ped != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03624             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o20">fSingle</a>) {
03625                 lreturn = <a class="code" href="../../d6/d0/usercli_8h.html#a542">SLEditWndProc</a>(hwnd, ped, message, wParam, lParam);
03626             } <span class="keywordflow">else</span> {
03627                 lreturn = <a class="code" href="../../d6/d0/usercli_8h.html#a502">MLEditWndProc</a>(hwnd, ped, message, wParam, lParam);
03628             }
03629         }
03630     }
03631 
03632     <span class="keywordflow">return</span> lreturn;
03633 }
03634 
03635 <span class="comment">/***************************************************************************\</span>
03636 <span class="comment">* ECFindXORblks</span>
03637 <span class="comment">*</span>
03638 <span class="comment">* This finds the XOR of lpOldBlk and lpNewBlk and return s resulting blocks</span>
03639 <span class="comment">* through the lpBlk1 and lpBlk2; This could result in a single block or</span>
03640 <span class="comment">* at the maximum two blocks;</span>
03641 <span class="comment">* If a resulting block is empty, then it's StPos field has -1.</span>
03642 <span class="comment">* NOTE:</span>
03643 <span class="comment">* When called from MultiLine edit control, StPos and EndPos fields of</span>
03644 <span class="comment">* these blocks have the Starting line and Ending line of the block;</span>
03645 <span class="comment">* When called from SingleLine edit control, StPos and EndPos fields</span>
03646 <span class="comment">* of these blocks have the character index of starting position and</span>
03647 <span class="comment">* ending position of the block.</span>
03648 <span class="comment">*</span>
03649 <span class="comment">* History:</span>
03650 <span class="comment">\***************************************************************************/</span>
03651 
<a name="l03652"></a><a class="code" href="../../d6/d0/usercli_8h.html#a458">03652</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a458">ECFindXORblks</a>(
03653     <a class="code" href="../../d7/d8/structtagBLOCK.html">LPBLOCK</a> lpOldBlk,
03654     <a class="code" href="../../d7/d8/structtagBLOCK.html">LPBLOCK</a> lpNewBlk,
03655     <a class="code" href="../../d7/d8/structtagBLOCK.html">LPBLOCK</a> lpBlk1,
03656     <a class="code" href="../../d7/d8/structtagBLOCK.html">LPBLOCK</a> lpBlk2)
03657 {
03658     <span class="keywordflow">if</span> (lpOldBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> &gt;= lpNewBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a>) {
03659         lpBlk1-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> = lpNewBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a>;
03660         lpBlk1-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(lpOldBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a>, lpNewBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a>);
03661     } <span class="keywordflow">else</span> {
03662         lpBlk1-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> = lpOldBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a>;
03663         lpBlk1-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(lpNewBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a>, lpOldBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a>);
03664     }
03665 
03666     <span class="keywordflow">if</span> (lpOldBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a> &lt;= lpNewBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a>) {
03667         lpBlk2-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(lpOldBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a>, lpNewBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a>);
03668         lpBlk2-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a> = lpNewBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a>;
03669     } <span class="keywordflow">else</span> {
03670         lpBlk2-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(lpNewBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a>, lpOldBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a>);
03671         lpBlk2-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a> = lpOldBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a>;
03672     }
03673 }
03674 
03675 <span class="comment">/***************************************************************************\</span>
03676 <span class="comment">* ECCalcChangeSelection</span>
03677 <span class="comment">*</span>
03678 <span class="comment">* This function finds the XOR between two selection blocks(OldBlk and NewBlk)</span>
03679 <span class="comment">* and return s the resulting areas thro the same parameters; If the XOR of</span>
03680 <span class="comment">* both the blocks is empty, then this return s FALSE; Otherwise TRUE.</span>
03681 <span class="comment">*</span>
03682 <span class="comment">* NOTE:</span>
03683 <span class="comment">* When called from MultiLine edit control, StPos and EndPos fields of</span>
03684 <span class="comment">* these blocks have the Starting line and Ending line of the block;</span>
03685 <span class="comment">* When called from SingleLine edit control, StPos and EndPos fields</span>
03686 <span class="comment">* of these blocks have the character index of starting position and</span>
03687 <span class="comment">* ending position of the block.</span>
03688 <span class="comment">*</span>
03689 <span class="comment">* History:</span>
03690 <span class="comment">\***************************************************************************/</span>
03691 
<a name="l03692"></a><a class="code" href="../../d6/d0/usercli_8h.html#a457">03692</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a457">ECCalcChangeSelection</a>(
03693     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
03694     ICH ichOldMinSel,
03695     ICH ichOldMaxSel,
03696     <a class="code" href="../../d7/d8/structtagBLOCK.html">LPBLOCK</a> OldBlk,
03697     <a class="code" href="../../d7/d8/structtagBLOCK.html">LPBLOCK</a> NewBlk)
03698 {
03699     <a class="code" href="../../d7/d8/structtagBLOCK.html">BLOCK</a> Blk[2];
03700     <span class="keywordtype">int</span> iBlkCount = 0;
03701 
03702     Blk[0].<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> = Blk[0].<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a> = Blk[1].<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> = Blk[1].<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a> = 0xFFFFFFFF;
03703 
03704     <span class="comment">/*</span>
03705 <span class="comment">     * Check if the Old selection block existed</span>
03706 <span class="comment">     */</span>
03707     <span class="keywordflow">if</span> (ichOldMinSel != ichOldMaxSel) {
03708 
03709         <span class="comment">/*</span>
03710 <span class="comment">         * Yes! Old block existed.</span>
03711 <span class="comment">         */</span>
03712         Blk[0].<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> = OldBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a>;
03713         Blk[0].<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a> = OldBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a>;
03714         iBlkCount++;
03715     }
03716 
03717     <span class="comment">/*</span>
03718 <span class="comment">     * Check if the new Selection block exists</span>
03719 <span class="comment">     */</span>
03720     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> != ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>) {
03721 
03722         <span class="comment">/*</span>
03723 <span class="comment">         * Yes! New block exists</span>
03724 <span class="comment">         */</span>
03725         Blk[1].<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> = NewBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a>;
03726         Blk[1].<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a> = NewBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a>;
03727         iBlkCount++;
03728     }
03729 
03730     <span class="comment">/*</span>
03731 <span class="comment">     * If both the blocks exist find the XOR of them</span>
03732 <span class="comment">     */</span>
03733     <span class="keywordflow">if</span> (iBlkCount == 2) {
03734 
03735         <span class="comment">/*</span>
03736 <span class="comment">         * Check if both blocks start at the same character position</span>
03737 <span class="comment">         */</span>
03738         <span class="keywordflow">if</span> (ichOldMinSel == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>) {
03739 
03740             <span class="comment">/*</span>
03741 <span class="comment">             * Check if they end at the same character position</span>
03742 <span class="comment">             */</span>
03743             <span class="keywordflow">if</span> (ichOldMaxSel == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>)
03744                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; <span class="comment">/* Nothing changes */</span>
03745 
03746             Blk[0].<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(NewBlk -&gt; EndPos, OldBlk -&gt; EndPos);
03747             Blk[0].<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(NewBlk -&gt; EndPos, OldBlk -&gt; EndPos);
03748             Blk[1].<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> = 0xFFFFFFFF;
03749         } <span class="keywordflow">else</span> {
03750             <span class="keywordflow">if</span> (ichOldMaxSel == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>) {
03751                 Blk[0].<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(NewBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a>, OldBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a>);
03752                 Blk[0].<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(NewBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a>, OldBlk-&gt;<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a>);
03753                 Blk[1].<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> = 0xFFFFFFFF;
03754             } <span class="keywordflow">else</span> {
03755                 <a class="code" href="../../d6/d0/usercli_8h.html#a458">ECFindXORblks</a>(OldBlk, NewBlk, &amp;Blk[0], &amp;Blk[1]);
03756             }
03757         }
03758     }
03759 
03760     RtlCopyMemory(OldBlk, &amp;Blk[0], <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d8/structtagBLOCK.html">BLOCK</a>));
03761     RtlCopyMemory(NewBlk, &amp;Blk[1], <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/usercli_8h.html#a364">BLOCK</a>));
03762 
03763     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; <span class="comment">/* Yup , There is something to paint */</span>
03764 }
03765 
03766 
03767 <span class="comment">/***************************************************************************\</span>
03768 <span class="comment">* ECGetControlBrush</span>
03769 <span class="comment">*</span>
03770 <span class="comment">* Client side optimization replacement for NtUserGetControlBrush</span>
03771 <span class="comment">*</span>
03772 <span class="comment">* message is one of the WM_CTLCOLOR* messages.</span>
03773 <span class="comment">*</span>
03774 <span class="comment">\***************************************************************************/</span>
03775 
<a name="l03776"></a><a class="code" href="../../d6/d0/usercli_8h.html#a479">03776</a> HBRUSH <a class="code" href="../../d6/d0/usercli_8h.html#a479">ECGetControlBrush</a>(
03777     <a class="code" href="../../d3/d4/structtagED.html">PED</a>  ped,
03778     HDC  hdc,
03779     LONG message)
03780 {
03781     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndSend;
03782     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndEdit;
03783 
03784     pwndEdit = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
03785 
03786     <span class="keywordflow">if</span> (pwndEdit == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03787         <span class="keywordflow">return</span> (HBRUSH)0;
03788 
03789     <span class="keywordflow">if</span> ((pwndSend = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a739">TestwndPopup</a>(pwndEdit) ? pwndEdit-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> : pwndEdit-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03790         pwndSend = pwndEdit;
03791     <span class="keywordflow">else</span>
03792         pwndSend = <a class="code" href="../../d6/d0/usercli_8h.html#a25">REBASEPTR</a>(pwndEdit, pwndSend);
03793 
03794     UserAssert(pwndSend);
03795 
03796     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndSend)) {
03797         <span class="keywordflow">return</span> (HBRUSH)<a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwndSend, message,
03798                 (WPARAM)hdc, (LPARAM)pwndEdit, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>);
03799     }
03800 
03801     <span class="comment">/*</span>
03802 <span class="comment">     * By using the correct A/W call we avoid a c/s transition</span>
03803 <span class="comment">     * on this SendMessage().</span>
03804 <span class="comment">     */</span>
03805     <span class="keywordflow">return</span> (HBRUSH)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwndSend, message, (WPARAM)hdc,
03806             (LPARAM)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>);
03807 }
03808 
03809 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> WINAPI <a class="code" href="../../d8/d4/editec_8c.html#a49">QueryFontAssocStatus</a>(<span class="keywordtype">void</span>);
<a name="l03810"></a><a class="code" href="../../d8/d4/editec_8c.html#a9">03810</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d8/d4/editec_8c.html#a9">fFontAssocStatus</a> = 0xffff;
03811 
03812 <span class="comment">/***************************************************************************\</span>
03813 <span class="comment">* ECGetDBCSVector( PED ped, BYTE CharSet )</span>
03814 <span class="comment">*</span>
03815 <span class="comment">*   This function sets DBCS Vector for specified character set and sets</span>
03816 <span class="comment">*   ped-&gt;fDBCS flag if needed.</span>
03817 <span class="comment">*</span>
03818 <span class="comment">* History: 18-Jun-1996 Hideyuki Nagase</span>
03819 <span class="comment">\***************************************************************************/</span>
<a name="l03820"></a><a class="code" href="../../d6/d0/usercli_8h.html#a463">03820</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d0/usercli_8h.html#a463">ECGetDBCSVector</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, HDC hdc, BYTE CharSet)
03821 {
03822     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bDBCSCodePage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03823     <span class="comment">/*</span>
03824 <span class="comment">     * if DEFAUT_CHARSET was passed, we will convert that to Shell charset..</span>
03825 <span class="comment">     */</span>
03826     <span class="keywordflow">if</span> (CharSet == DEFAULT_CHARSET) {
03827         CharSet = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)GetTextCharset(hdc);
03828 
03829         <span class="comment">/*</span>
03830 <span class="comment">         * if CharSet is still DEFAULT_CHARSET, it means gdi has some problem..</span>
03831 <span class="comment">         * then just return default.. we get charset from CP_ACP..</span>
03832 <span class="comment">         */</span>
03833         <span class="keywordflow">if</span> (CharSet == DEFAULT_CHARSET) {
03834             CharSet = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)<a class="code" href="../../d0/d9/dlgbegin_8c.html#a18">GetACPCharSet</a>();
03835         }
03836     }
03837 
03838     <span class="keywordflow">switch</span> (CharSet) {
03839     <span class="keywordflow">case</span> SHIFTJIS_CHARSET:
03840     <span class="keywordflow">case</span> HANGEUL_CHARSET:
03841     <span class="keywordflow">case</span> CHINESEBIG5_CHARSET:
03842     <span class="keywordflow">case</span> GB2312_CHARSET:
03843         bDBCSCodePage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03844         <span class="keywordflow">break</span>;
03845 
03846     <span class="keywordflow">case</span> ANSI_CHARSET:            <span class="comment">// 0</span>
03847     <span class="keywordflow">case</span> SYMBOL_CHARSET:          <span class="comment">// 2</span>
03848     <span class="keywordflow">case</span> OEM_CHARSET:             <span class="comment">// 255</span>
03849         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/editec_8c.html#a9">fFontAssocStatus</a> == 0xffff)
03850             <a class="code" href="../../d8/d4/editec_8c.html#a9">fFontAssocStatus</a> = <a class="code" href="../../d8/d4/editec_8c.html#a49">QueryFontAssocStatus</a>();
03851 
03852         <span class="keywordflow">if</span> ((((CharSet + 2) &amp; 0xf) &amp; <a class="code" href="../../d8/d4/editec_8c.html#a9">fFontAssocStatus</a>)) {
03853             bDBCSCodePage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03854             <span class="comment">/*</span>
03855 <span class="comment">             * Bug 117558, etc.</span>
03856 <span class="comment">             * Try to get a meaningful character set for associated font.</span>
03857 <span class="comment">             */</span>
03858             CharSet = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)<a class="code" href="../../d0/d9/dlgbegin_8c.html#a18">GetACPCharSet</a>();
03859         } <span class="keywordflow">else</span> {
03860             bDBCSCodePage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03861         }
03862         <span class="keywordflow">break</span>;
03863 
03864     <span class="keywordflow">default</span>:
03865         bDBCSCodePage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03866     }
03867 
03868     <span class="keywordflow">if</span> (bDBCSCodePage) {
03869         CHARSETINFO CharsetInfo;
03870         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CodePage;
03871         CPINFO CPInfo;
03872         <span class="keywordtype">int</span> lbIX;
03873 
03874         <span class="keywordflow">if</span> (TranslateCharsetInfo((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)CharSet, &amp;CharsetInfo, TCI_SRCCHARSET)) {
03875             CodePage = CharsetInfo.ciACP;
03876         } <span class="keywordflow">else</span> {
03877             CodePage = CP_ACP;
03878         }
03879 
03880         GetCPInfo(CodePage, &amp;CPInfo);
03881         <span class="keywordflow">for</span> (lbIX=0 ; CPInfo.LeadByte[lbIX] != 0 ; lbIX+=2) {
03882             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o91">DBCSVector</a>[lbIX  ] = CPInfo.LeadByte[lbIX];
03883             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o91">DBCSVector</a>[lbIX+1] = CPInfo.LeadByte[lbIX+1];
03884         }
03885         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o91">DBCSVector</a>[lbIX  ] = 0x0;
03886         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o91">DBCSVector</a>[lbIX+1] = 0x0;
03887     } <span class="keywordflow">else</span> {
03888         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o91">DBCSVector</a>[0] = 0x0;
03889         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o91">DBCSVector</a>[1] = 0x0;
03890     }
03891 
03892     <span class="comment">//</span>
03893     <span class="comment">// Final check: if the font supports DBCS glyphs</span>
03894     <span class="comment">//</span>
03895     <span class="comment">// If we've got a font with DBCS glyphs, let's mark PED so.</span>
03896     <span class="comment">// But since the font's primary charset is the one other than FE,</span>
03897     <span class="comment">// we can only support UNICODE Edit control.</span>
03898     <span class="comment">//</span>
03899     <span class="comment">//  a) GDI performs A/W conversion for ANSI apps based on the primary</span>
03900     <span class="comment">//     character set in hDC, so it will break anyway.</span>
03901     <span class="comment">//  b) ANSI applications are only supported on their native system locales:</span>
03902     <span class="comment">//     GetACPCharSet() is expected to return a FE code page.</span>
03903     <span class="comment">//  c) ANSI Edit control requires DBCSVector, which cannot be</span>
03904     <span class="comment">//     initialized without a FE code page.</span>
03905     <span class="comment">//</span>
03906     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
03907         FONTSIGNATURE fontSig;
03908 
03909         GetTextCharsetInfo(hdc, &amp;fontSig, 0);
03910         <span class="keywordflow">if</span> (fontSig.fsCsb[0] &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a87">FAREAST_CHARSET_BITS</a>) {
03911             bDBCSCodePage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03912             <span class="comment">// Since this is UNICODE, we're not</span>
03913         }
03914     }
03915 
03916     <span class="keywordflow">return</span> bDBCSCodePage;
03917 }
03918 
03919 <span class="comment">/***************************************************************************\</span>
03920 <span class="comment">* LPSTR ECAnsiNext( ped, lpCurrent )</span>
03921 <span class="comment">*</span>
03922 <span class="comment">*   This function advances string pointer for Edit Control use only.</span>
03923 <span class="comment">*</span>
03924 <span class="comment">* History:</span>
03925 <span class="comment">\***************************************************************************/</span>
<a name="l03926"></a><a class="code" href="../../d6/d0/usercli_8h.html#a465">03926</a> LPSTR <a class="code" href="../../d6/d0/usercli_8h.html#a465">ECAnsiNext</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, LPSTR lpCurrent)
03927 {
03928     <span class="keywordflow">return</span> lpCurrent+((<a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(ped,*lpCurrent)==<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ? 2 : 1);
03929 }
03930 
03931 <span class="comment">/***************************************************************************\</span>
03932 <span class="comment">* LPSTR ECAnsiPrev( ped, lpBase, lpStr )</span>
03933 <span class="comment">*</span>
03934 <span class="comment">*   This function decrements string pointer for Edit Control use only.</span>
03935 <span class="comment">*</span>
03936 <span class="comment">* History:</span>
03937 <span class="comment">\***************************************************************************/</span>
<a name="l03938"></a><a class="code" href="../../d6/d0/usercli_8h.html#a466">03938</a> LPSTR <a class="code" href="../../d6/d0/usercli_8h.html#a466">ECAnsiPrev</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, LPSTR lpBase, LPSTR lpStr )
03939 {
03940     LPSTR lpCurrent = lpStr -1;
03941 
03942     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a>)
03943         <span class="keywordflow">return</span> lpCurrent;                        <span class="comment">// just return ( lpStr - 1 )</span>
03944 
03945     <span class="keywordflow">if</span> (lpBase &gt;= lpCurrent)
03946         <span class="keywordflow">return</span> lpBase;
03947 
03948     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(ped, *lpCurrent))     <span class="comment">// this check makes things faster</span>
03949         <span class="keywordflow">return</span> (lpCurrent - 1);                  <span class="comment">// 92/04/04 takaok</span>
03950 
03951     <span class="keywordflow">do</span> {
03952         lpCurrent--;
03953         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(ped, *lpCurrent)) {
03954             lpCurrent++;
03955             <span class="keywordflow">break</span>;
03956         }
03957     } <span class="keywordflow">while</span>(lpCurrent != lpBase);
03958 
03959     <span class="keywordflow">return</span> lpStr - (((lpStr - lpCurrent) &amp; 1) ? 1 : 2);
03960 }
03961 
03962 <span class="comment">/***************************************************************************\</span>
03963 <span class="comment">* ICH ECNextIch( ped, pText, ichCurrent )</span>
03964 <span class="comment">*</span>
03965 <span class="comment">*   This function advances string pointer for Edit Control use only.</span>
03966 <span class="comment">*</span>
03967 <span class="comment">* History:</span>
03968 <span class="comment">\***************************************************************************/</span>
<a name="l03969"></a><a class="code" href="../../d6/d0/usercli_8h.html#a468">03969</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d6/d0/usercli_8h.html#a468">ECNextIch</a>( <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, LPSTR pStart, ICH ichCurrent )
03970 {
03971     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a> || !ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
03972 
03973         <span class="keywordflow">return</span> (ichCurrent + 1);
03974 
03975     } <span class="keywordflow">else</span> {
03976 
03977         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> ichRet;
03978         LPSTR pText;
03979 
03980         <span class="keywordflow">if</span> (pStart)
03981             pText = pStart + ichCurrent;
03982         <span class="keywordflow">else</span>
03983             pText = (LPSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped) + ichCurrent;
03984 
03985         ichRet = ichCurrent + ( <a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(ped, *pText) ? 2 : 1 );
03986 
03987         <span class="keywordflow">if</span> (!pStart)
03988             <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
03989 
03990         <span class="keywordflow">return</span> (ichRet);
03991     }
03992 }
03993 
03994 <span class="comment">/***************************************************************************\</span>
03995 <span class="comment">* ICH ECPrevIch( ped, LPSTR pStart, ICH ichCurrent )</span>
03996 <span class="comment">*</span>
03997 <span class="comment">*   This function decrements string pointer for Edit Control use only.</span>
03998 <span class="comment">*</span>
03999 <span class="comment">* History:</span>
04000 <span class="comment">\***************************************************************************/</span>
<a name="l04001"></a><a class="code" href="../../d6/d0/usercli_8h.html#a467">04001</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d6/d0/usercli_8h.html#a467">ECPrevIch</a>( <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, LPSTR pStart, ICH ichCurrent )
04002 {
04003     LPSTR lpCurrent;
04004     LPSTR lpStr;
04005     LPSTR lpBase;
04006 
04007 <span class="preprocessor">#ifdef SURROGATE</span>
04008 <span class="preprocessor"></span>    <span class="comment">// Handle Unicode surrogates pairs when CSLPK is loaded</span>
04009     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> || !ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>)  <span class="comment">// if no surrogate processing required</span>
04010 <span class="preprocessor">#endif</span>
04011 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a> || !ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>)
04012             <span class="keywordflow">if</span> ( ichCurrent )
04013                 <span class="keywordflow">return</span> (ichCurrent - 1);
04014             <span class="keywordflow">else</span>
04015                 <span class="keywordflow">return</span> (ichCurrent);
04016 
04017     <span class="keywordflow">if</span> (ichCurrent &lt;= 1)
04018         <span class="keywordflow">return</span> 0;
04019 
04020     <span class="keywordflow">if</span> (pStart)
04021         lpBase = pStart;
04022     <span class="keywordflow">else</span>
04023         lpBase = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
04024 
04025 <span class="preprocessor">#ifdef SURROGATE</span>
04026 <span class="preprocessor"></span>
04027     <span class="comment">// Handle characters represented by multiple codepoints</span>
04028 
04029     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
04030 
04031         <span class="comment">// ANSI PrevIch with DBCS support</span>
04032 <span class="preprocessor">#endif</span>
04033 <span class="preprocessor"></span>
04034         lpStr = lpBase + ichCurrent;
04035         lpCurrent = lpStr - 1;
04036         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(ped,*lpCurrent)) {
04037             <span class="keywordflow">if</span> (!pStart)
04038                 <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
04039             <span class="keywordflow">return</span> (ichCurrent - 2);
04040         }
04041 
04042         <span class="keywordflow">do</span> {
04043             lpCurrent--;
04044             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(ped, *lpCurrent)) {
04045                 lpCurrent++;
04046                 <span class="keywordflow">break</span>;
04047             }
04048         } <span class="keywordflow">while</span>(lpCurrent != lpBase);
04049 
04050         <span class="keywordflow">if</span> (!pStart)
04051             <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
04052         <span class="keywordflow">return</span> (ichCurrent - (((lpStr - lpCurrent) &amp; 1) ? 1 : 2));
04053 
04054 <span class="preprocessor">#ifdef SURROGATE</span>
04055 <span class="preprocessor"></span>
04056     } <span class="keywordflow">else</span> {
04057 
04058         <span class="comment">// Unicode PrevIch with surrogate pair support</span>
04059 
04060         ichCurrent--;
04061 
04062         <span class="keywordflow">if</span> (    (((WCHAR*)lpBase)[ichCurrent]   &amp; 0xFC00) == 0xDC00
04063             &amp;&amp;  (((WCHAR*)lpBase)[ichCurrent-1] &amp; 0xFC00) == 0xD800) {
04064 
04065             ichCurrent--;
04066         }
04067 
04068         <span class="keywordflow">if</span> (!pStart)
04069             <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
04070 
04071         <span class="keywordflow">return</span> ichCurrent;
04072     }
04073 <span class="preprocessor">#endif</span>
04074 <span class="preprocessor"></span>}
04075 
04076 <span class="comment">/***************************************************************************\</span>
04077 <span class="comment">* BOOL ECIsDBCSLeadByte( PED ped, BYTE cch )</span>
04078 <span class="comment">*</span>
04079 <span class="comment">*   IsDBCSLeadByte for Edit Control use only.</span>
04080 <span class="comment">*</span>
04081 <span class="comment">* History: 18-Jun-1996 Hideyuki Nagase</span>
04082 <span class="comment">\***************************************************************************/</span>
<a name="l04083"></a><a class="code" href="../../d6/d0/usercli_8h.html#a464">04083</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, BYTE cch)
04084 {
04085     <span class="keywordtype">int</span> i;
04086 
04087     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a> || !ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>)
04088         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04089 
04090     <span class="keywordflow">for</span> (i = 0; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o91">DBCSVector</a>[i]; i += 2) {
04091         <span class="keywordflow">if</span> ((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o91">DBCSVector</a>[i] &lt;= cch) &amp;&amp; (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o91">DBCSVector</a>[i+1] &gt;= cch))
04092             <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04093     }
04094 
04095     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04096 }
04097 
04098 <span class="comment">/***************************************************************************\</span>
04099 <span class="comment">* int DBCSCombine(HWND hwnd, int ch)</span>
04100 <span class="comment">*</span>
04101 <span class="comment">* Assemble two WM_CHAR messages to single DBCS character.</span>
04102 <span class="comment">* If program detects first byte of DBCS character in WM_CHAR message,</span>
04103 <span class="comment">* it calls this function to obtain second WM_CHAR message from queue.</span>
04104 <span class="comment">* finally this routine assembles first byte and second byte into single</span>
04105 <span class="comment">* DBCS character.</span>
04106 <span class="comment">*</span>
04107 <span class="comment">* History:</span>
04108 <span class="comment">\***************************************************************************/</span>
<a name="l04109"></a><a class="code" href="../../d6/d0/usercli_8h.html#a460">04109</a> WORD <a class="code" href="../../d6/d0/usercli_8h.html#a460">DbcsCombine</a>(HWND hwnd, WORD ch)
04110 {
04111     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
04112     <span class="keywordtype">int</span> i = 10; <span class="comment">/* loop counter to avoid the infinite loop */</span>
04113 
04114     <span class="keywordflow">while</span> (!PeekMessageA(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, hwnd, WM_CHAR, WM_CHAR, PM_REMOVE)) {
04115         <span class="keywordflow">if</span> (--i == 0)
04116             <span class="keywordflow">return</span> 0;
04117         Sleep(1);
04118     }
04119 
04120     <span class="keywordflow">return</span> (WORD)ch | ((WORD)(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam) &lt;&lt; 8);
04121 }
04122 
04123 <span class="comment">/***************************************************************************\</span>
04124 <span class="comment">* ICH ECAdjustIch( PED ped, LPSTR lpstr, ICH ch )</span>
04125 <span class="comment">*</span>
04126 <span class="comment">* This function adjusts a current pointer correctly. If a current</span>
04127 <span class="comment">* pointer is lying between DBCS first byte and second byte, this</span>
04128 <span class="comment">* function adjusts a current pointer to a first byte of DBCS position</span>
04129 <span class="comment">* by decrement once.</span>
04130 <span class="comment">*</span>
04131 <span class="comment">* History:</span>
04132 <span class="comment">\***************************************************************************/</span>
<a name="l04133"></a><a class="code" href="../../d6/d0/usercli_8h.html#a461">04133</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d6/d0/usercli_8h.html#a461">ECAdjustIch</a>( <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, LPSTR lpstr, ICH ch )
04134 {
04135     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> newch = ch;
04136 
04137     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> || !ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a> || newch == 0)
04138         <span class="keywordflow">return</span> ( ch );
04139 
04140     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(ped,lpstr[--newch]))
04141         <span class="keywordflow">return</span> ( ch );  <span class="comment">// previous char is SBCS</span>
04142     <span class="keywordflow">while</span>(1) {
04143         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(ped,lpstr[newch])) {
04144             newch++;
04145             <span class="keywordflow">break</span>;
04146         }
04147         <span class="keywordflow">if</span> (newch)
04148             newch--;
04149         <span class="keywordflow">else</span>
04150             <span class="keywordflow">break</span>;
04151     }
04152     <span class="keywordflow">return</span> ((ch - newch) &amp; 1) ? ch-1 : ch;
04153 }
04154 
04155 <span class="comment">/***************************************************************************\</span>
04156 <span class="comment">* ICH ECAdjustIchNext( PED ped, LPSTR lpstr, ICH ch )</span>
04157 <span class="comment">*</span>
04158 <span class="comment">* History:</span>
04159 <span class="comment">* 19.Jun.1996 Hideyuki Nagase [hideyukn] - Port from Win95-FarEast version</span>
04160 <span class="comment">\***************************************************************************/</span>
04161 
<a name="l04162"></a><a class="code" href="../../d6/d0/usercli_8h.html#a462">04162</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> PASCAL <a class="code" href="../../d6/d0/usercli_8h.html#a462">ECAdjustIchNext</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, LPSTR lpstr, ICH ch)
04163 {
04164     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> ichNew = <a class="code" href="../../d6/d0/usercli_8h.html#a461">ECAdjustIch</a>(ped,lpstr,ch);
04165     LPSTR lpnew = lpstr+ichNew;
04166 
04167     <span class="comment">// if ch &gt; ichNew then ECAdjustIch adjusted ich.</span>
04168     <span class="keywordflow">if</span> (ch &gt; ichNew)
04169        lpnew = <a class="code" href="../../d6/d0/usercli_8h.html#a465">ECAnsiNext</a>(ped, lpnew);
04170 
04171     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)(lpnew-lpstr);
04172 }
04173 
04174 <span class="comment">/***************************************************************************\</span>
04175 <span class="comment">* ECUpdateFormat</span>
04176 <span class="comment">*</span>
04177 <span class="comment">* Computes ped-&gt;format and ped-&gt;fRtoLReading from dwStyle and dwExStyle.</span>
04178 <span class="comment">* Refreshes the display if either are changed.</span>
04179 <span class="comment">*</span>
04180 <span class="comment">* History:</span>
04181 <span class="comment">*    May 12, 1997   [samera]     wrote it</span>
04182 <span class="comment">*    May 12, 1997   [dbrown]     rewrote it</span>
04183 <span class="comment">\***************************************************************************/</span>
04184 
<a name="l04185"></a><a class="code" href="../../d6/d0/usercli_8h.html#a426">04185</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a426">ECUpdateFormat</a>(
04186     <a class="code" href="../../d3/d4/structtagED.html">PED</a>   ped,
04187     DWORD dwStyle,
04188     DWORD dwExStyle)
04189 {
04190     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fNewRtoLReading;
04191     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uiNewFormat;
04192 
04193     <span class="comment">// Extract new format and reading order from style</span>
04194 
04195     fNewRtoLReading = dwExStyle &amp; WS_EX_RTLREADING ? 1 : 0;
04196     uiNewFormat     = dwStyle &amp; ES_FMTMASK;
04197 
04198 
04199     <span class="comment">// WS_EX_RIGHT is ignored unless dwStyle is ES_LEFT</span>
04200 
04201     <span class="keywordflow">if</span> (uiNewFormat == ES_LEFT &amp;&amp; dwExStyle &amp; WS_EX_RIGHT) {
04202         uiNewFormat = ES_RIGHT;
04203     }
04204 
04205 
04206     <span class="comment">// Internally ES_LEFT and ES_RIGHT are swapped for RtoLReading order</span>
04207     <span class="comment">// (Think of them as ES_LEADING and ES_TRAILING)</span>
04208 
04209     <span class="keywordflow">if</span> (fNewRtoLReading) {
04210         <span class="keywordflow">switch</span> (uiNewFormat) {
04211             <span class="keywordflow">case</span> ES_LEFT:  uiNewFormat = ES_RIGHT; <span class="keywordflow">break</span>;
04212             <span class="keywordflow">case</span> ES_RIGHT: uiNewFormat = ES_LEFT;  <span class="keywordflow">break</span>;
04213         }
04214     }
04215 
04216 
04217     <span class="comment">// Format change does not cause redisplay by itself</span>
04218 
04219     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> = uiNewFormat;
04220 
04221 
04222     <span class="comment">// Refresh display on change of reading order</span>
04223 
04224     <span class="keywordflow">if</span> (fNewRtoLReading != ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a>) {
04225 
04226         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a> = fNewRtoLReading;
04227 
04228         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o34">fWrap</a>) {
04229             <span class="comment">// Redo wordwrap</span>
04230             <a class="code" href="../../d6/d0/usercli_8h.html#a490">MLBuildchLines</a>(ped, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04231             <a class="code" href="../../d6/d0/usercli_8h.html#a519">MLUpdateiCaretLine</a>(ped);
04232         } <span class="keywordflow">else</span> {
04233             <span class="comment">// Refresh horizontal scrollbar display</span>
04234             <a class="code" href="../../d6/d0/usercli_8h.html#a517">MLScroll</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0xffffffff, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04235         }
04236         <a class="code" href="../../d6/d0/usercli_8h.html#a436">ECInvalidateClient</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04237     }
04238 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
