<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dynmem.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dynmem.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d0/d3/dynmem_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/dynmem_8c.html#a0">PFN_REMOVED</a>&nbsp;&nbsp;&nbsp;((<a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(INT_PTR)(int)0x99887766)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_COUNT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/dynmem_8c.html#a3">MiRemovePhysicalPages</a> (IN PFN_NUMBER StartPage, IN PFN_NUMBER EndPage)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/dynmem_8c.html#a4">MmAddPhysicalMemory</a> (IN PPHYSICAL_ADDRESS StartAddress, IN OUT PLARGE_INTEGER NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/dynmem_8c.html#a5">MmRemovePhysicalMemory</a> (IN PPHYSICAL_ADDRESS StartAddress, IN OUT PLARGE_INTEGER NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">PPHYSICAL_MEMORY_RANGE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/dynmem_8c.html#a6">MmGetPhysicalMemoryRanges</a> (VOID)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/dynmem_8c.html#a1">MmDynamicMemoryMutex</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/dynmem_8c.html#a2">MiTrimRemovalPagesOnly</a> = FALSE</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="dynmem.c::PFN_REMOVED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PFN_REMOVED&nbsp;&nbsp;&nbsp;((<a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(INT_PTR)(int)0x99887766)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00033">33</a> of file <a class="el" href="../../d0/d3/dynmem_8c-source.html">dynmem.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00043">MmAddPhysicalMemory()</a>, and <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="dynmem.c::MiRemovePhysicalPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_COUNT MiRemovePhysicalPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>StartPage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>EndPage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/dynmem_8c-source.html#l01109">1109</a> of file <a class="el" href="../../d0/d3/dynmem_8c-source.html">dynmem.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01082">_MMPFNLIST::Blink</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01893">_MMCOLOR_TABLES::Blink</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01892">_MMCOLOR_TABLES::Flink</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01219">MI_MAGIC_AWE_PTEFRAME</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01245">MiRestoreTransitionPte()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00821">MiUnlinkFreeOrZeroedPage()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00112">MmFreePagesByColor</a>, <a class="el" href="../../d2/d1/mm_8h.html#a147">MMLISTS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">MmPfnDatabase</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00081">MmSecondaryColors</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>.
<p>
<pre class="fragment"><div>01116                    :
01117 
01118     This routine searches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database <span class="keywordflow">for</span> free, zeroed or standby pages
01119     that are marked <span class="keywordflow">for</span> removal.
01120 
01121 Arguments:
01122 
01123     StartPage - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> physical frame number to remove.
01124 
01125     EndPage - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last physical frame number to remove.
01126 
01127 Return Value:
01128 
01129     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of pages removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free, zeroed and standby lists.
01130 
01131 Environment:
01132 
01133     Kernel mode, PFN lock held.
01134 
01135 --*/
01136 
01137 {
01138     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01139     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01140     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnNextColored;
01141     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnNextFlink;
01142     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnLastColored;
01143     PFN_NUMBER Page;
01144     LOGICAL RemovePage;
01145     ULONG Color;
01146     <a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a> ColorHead;
01147     PFN_NUMBER MovedPage;
01148     <a class="code" href="../../d2/d1/mm_8h.html#a147">MMLISTS</a> MemoryList;
01149     PFN_NUMBER PageNextColored;
01150     PFN_NUMBER PageNextFlink;
01151     PFN_NUMBER PageLastColored;
01152     PFN_COUNT NumberOfPages;
01153     <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead;
01154     LOGICAL RescanNeeded;
01155 
01156     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01157 
01158     NumberOfPages = 0;
01159 
01160 rescan:
01161 
01162     <span class="comment">//</span>
01163     <span class="comment">// Grab all zeroed (and then free) pages first directly from the</span>
01164     <span class="comment">// colored lists to avoid multiple walks down these singly linked lists.</span>
01165     <span class="comment">// Handle transition pages last.</span>
01166     <span class="comment">//</span>
01167 
01168     <span class="keywordflow">for</span> (MemoryList = <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>; MemoryList &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>; MemoryList += 1) {
01169 
01170         ListHead = <a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[MemoryList];
01171 
01172         <span class="keywordflow">for</span> (Color = 0; Color &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>; Color += 1) {
01173             ColorHead = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[MemoryList][Color];
01174 
01175             MovedPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01176 
01177             <span class="keywordflow">while</span> (ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01178 
01179                 Page = ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
01180     
01181                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01182 
01183                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == MemoryList);
01184 
01185                 <span class="comment">// </span>
01186                 <span class="comment">// The Flink and Blink must be nonzero here for the page</span>
01187                 <span class="comment">// to be on the listhead.  Only code that scans the</span>
01188                 <span class="comment">// MmPhysicalMemoryBlock has to check for the zero case.</span>
01189                 <span class="comment">//</span>
01190 
01191                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != 0);
01192                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != 0);
01193 
01194                 <span class="comment">//</span>
01195                 <span class="comment">// See if the page is desired by the caller.</span>
01196                 <span class="comment">//</span>
01197 
01198                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 1) {
01199 
01200                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 0);
01201     
01202                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a12">MiUnlinkFreeOrZeroedPage</a> (Page);
01203     
01204                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[BadPageList],
01205                                         Page);
01206 
01207                     NumberOfPages += 1;
01208                 }
01209                 <span class="keywordflow">else</span> {
01210 
01211                     <span class="comment">//</span>
01212                     <span class="comment">// Unwanted so put the page on the end of list.</span>
01213                     <span class="comment">// If first time, save pfn.</span>
01214                     <span class="comment">//</span>
01215 
01216                     <span class="keywordflow">if</span> (MovedPage == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01217                         MovedPage = Page;
01218                     }
01219                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Page == MovedPage) {
01220 
01221                         <span class="comment">//</span>
01222                         <span class="comment">// No more pages available in this colored chain.</span>
01223                         <span class="comment">//</span>
01224 
01225                         <span class="keywordflow">break</span>;
01226                     }
01227 
01228                     <span class="comment">//</span>
01229                     <span class="comment">// If the colored chain has more than one entry then</span>
01230                     <span class="comment">// put this page on the end.</span>
01231                     <span class="comment">//</span>
01232 
01233                     PageNextColored = (PFN_NUMBER)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01234 
01235                     <span class="keywordflow">if</span> (PageNextColored == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01236 
01237                         <span class="comment">//</span>
01238                         <span class="comment">// No more pages available in this colored chain.</span>
01239                         <span class="comment">//</span>
01240 
01241                         <span class="keywordflow">break</span>;
01242                     }
01243 
01244                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != 0);
01245                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != MM_EMPTY_LIST);
01246                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01247 
01248                     PfnNextColored = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageNextColored);
01249                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)PfnNextColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == MemoryList);
01250                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnNextColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01251 
01252                     <span class="comment">//</span>
01253                     <span class="comment">// Adjust the free page list so Page</span>
01254                     <span class="comment">// follows PageNextFlink.</span>
01255                     <span class="comment">//</span>
01256 
01257                     PageNextFlink = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
01258                     PfnNextFlink = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageNextFlink);
01259 
01260                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == MemoryList);
01261                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01262 
01263                     PfnLastColored = ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a>;
01264                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored != (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)MM_EMPTY_LIST);
01265                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == MM_EMPTY_LIST);
01266                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01267                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != MM_EMPTY_LIST);
01268 
01269                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == MemoryList);
01270                     PageLastColored = PfnLastColored - <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>;
01271 
01272                     <span class="keywordflow">if</span> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> == Page) {
01273 
01274                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink == MM_EMPTY_LIST);
01275                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> != Page);
01276 
01277                         ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = PageNextFlink;
01278 
01279                         PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01280                     }
01281                     <span class="keywordflow">else</span> {
01282 
01283                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != MM_EMPTY_LIST);
01284                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink)-&gt;u1.Flink)))-&gt;PteFrame != MI_MAGIC_AWE_PTEFRAME);
01285                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink)-&gt;u1.Flink)))-&gt;u3.e1.PageLocation == MemoryList);
01286 
01287                         <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink)-&gt;u1.Flink = PageNextFlink;
01288                         PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink;
01289                     }
01290 
01291 <span class="preprocessor">#if DBG</span>
01292 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01293                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> == PageLastColored);
01294                     }
01295 <span class="preprocessor">#endif</span>
01296 <span class="preprocessor"></span>
01297                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
01298                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = PageLastColored;
01299 
01300                     <span class="keywordflow">if</span> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> == PageLastColored) {
01301                         ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = Page;
01302                     }
01303 
01304                     <span class="comment">//</span>
01305                     <span class="comment">// Adjust the colored chains.</span>
01306                     <span class="comment">//</span>
01307 
01308                     <span class="keywordflow">if</span> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01309                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink)-&gt;PteFrame != MI_MAGIC_AWE_PTEFRAME);
01310                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink)-&gt;u3.e1.PageLocation) == MemoryList);
01311                         <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink)-&gt;u2.Blink = Page;
01312                     }
01313 
01314                     PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = Page;
01315 
01316                     ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> = PageNextColored;
01317                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01318 
01319                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == MM_EMPTY_LIST);
01320                     PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = Page;
01321                     ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a> = Pfn1;
01322                 }
01323             }
01324         }
01325     }
01326 
01327     RescanNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01328     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (StartPage);
01329 
01330     <span class="keywordflow">do</span> {
01331 
01332         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) &amp;&amp;
01333             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != 0) &amp;&amp;
01334             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != 0) &amp;&amp;
01335             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0)) {
01336 
01337             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 0);
01338 
01339             RemovePage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01340 
01341             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 0) {
01342 
01343                 <span class="comment">//</span>
01344                 <span class="comment">// This page is not directly needed for a hot remove - but if</span>
01345                 <span class="comment">// it contains a chunk of prototype PTEs (and this chunk is</span>
01346                 <span class="comment">// in a page that needs to be removed), then any pages</span>
01347                 <span class="comment">// referenced by transition prototype PTEs must also be removed</span>
01348                 <span class="comment">// before the desired page can be removed.</span>
01349                 <span class="comment">//</span>
01350                 <span class="comment">// The same analogy holds for page parent, directory and table</span>
01351                 <span class="comment">// pages.</span>
01352                 <span class="comment">//</span>
01353 
01354                 Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01355                 <span class="keywordflow">if</span> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 0) {
01356 <span class="preprocessor">#if defined (_WIN64)</span>
01357 <span class="preprocessor"></span>                    Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01358                     <span class="keywordflow">if</span> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 0) {
01359                         RemovePage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01360                     }
01361                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1) {
01362                         RescanNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01363                     }
01364 <span class="preprocessor">#else</span>
01365 <span class="preprocessor"></span>                    RemovePage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01366 <span class="preprocessor">#endif</span>
01367 <span class="preprocessor"></span>                }
01368                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1) {
01369                     RescanNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01370                 }
01371             }
01372     
01373             <span class="keywordflow">if</span> (RemovePage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01374 
01375                 <span class="comment">//</span>
01376                 <span class="comment">// This page is in the desired range - grab it.</span>
01377                 <span class="comment">//</span>
01378     
01379                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
01380                 <a class="code" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (StartPage);
01381                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[BadPageList],
01382                                     StartPage);
01383                 NumberOfPages += 1;
01384             }
01385         }
01386 
01387         StartPage += 1;
01388         Pfn1 += 1;
01389 
01390     } <span class="keywordflow">while</span> (StartPage &lt; EndPage);
01391 
01392     <span class="keywordflow">if</span> (RescanNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01393 
01394         <span class="comment">//</span>
01395         <span class="comment">// A page table, directory or parent was freed by removing a transition</span>
01396         <span class="comment">// page from the cache.  Rescan from the top to pick it up.</span>
01397         <span class="comment">//</span>
01398 
01399 <span class="preprocessor">#if DBG</span>
01400 <span class="preprocessor"></span>        MiDynmemData[7] += 1;
01401 <span class="preprocessor">#endif</span>
01402 <span class="preprocessor"></span>
01403         <span class="keywordflow">goto</span> rescan;
01404     }
01405 <span class="preprocessor">#if DBG</span>
01406 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
01407         MiDynmemData[8] += 1;
01408     }
01409 <span class="preprocessor">#endif</span>
01410 <span class="preprocessor"></span>
01411     <span class="keywordflow">return</span> NumberOfPages;
01412 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="dynmem.c::MmAddPhysicalMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmAddPhysicalMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PPHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>StartAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00043">43</a> of file <a class="el" href="../../d0/d3/dynmem_8c-source.html">dynmem.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00059">ASSERT64</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01177">MiRemoveZeroPage()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00024">MmDynamicMemoryMutex</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00085">MmDynamicPfn</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00076">MmHighestPossiblePhysicalPage</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00399">MmNumberOfPhysicalPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">MmPfnDatabase</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00100">MmTotalCommitLimitMaximum</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00040">MmTotalCommittedPages</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00040">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfPages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00035">_PHYSICAL_MEMORY_RUN::PageCount</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00033">PFN_REMOVED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02433">PMMPTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00041">_PHYSICAL_MEMORY_DESCRIPTOR::Run</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
<pre class="fragment"><div>00050                    :
00051 
00052     This routine adds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical address range to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
00053     This includes initializing PFN database entries and adding <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00054     freelists.
00055 
00056 Arguments:
00057 
00058     StartAddress  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting physical address.
00059 
00060     NumberOfBytes  - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes being added.
00061                      If any bytes were added (ie: STATUS_SUCCESS is being
00062                      returned), <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual amount <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned here.
00063 
00064 Return Value:
00065 
00066     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>.
00067 
00068 Environment:
00069 
00070     Kernel mode.  PASSIVE level.  No locks held.
00071 
00072 --*/
00073 
00074 {
00075     ULONG i;
00076     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00077     KIRQL OldIrql;
00078     LOGICAL Inserted;
00079     LOGICAL Updated;
00080     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00081     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00082     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00083     PFN_NUMBER NumberOfPages;
00084     PFN_NUMBER start;
00085     PFN_NUMBER count;
00086     PFN_NUMBER StartPage;
00087     PFN_NUMBER EndPage;
00088     PFN_NUMBER PageFrameIndex;
00089     PFN_NUMBER Page;
00090     PFN_NUMBER LastPage;
00091     PFN_COUNT PagesNeeded;
00092     <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> OldPhysicalMemoryBlock;
00093     <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> NewPhysicalMemoryBlock;
00094     <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PPHYSICAL_MEMORY_RUN</a> NewRun;
00095     LOGICAL PfnDatabaseIsPhysical;
00096 
00097     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PASSIVE_LEVEL);
00098 
00099     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(NumberOfBytes-&gt;LowPart) == 0);
00100     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(StartAddress-&gt;LowPart) == 0);
00101 
00102     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(MmPfnDatabase)) {
00103 
00104         <span class="comment">//</span>
00105         <span class="comment">// The system must be configured for dynamic memory addition.  This is</span>
00106         <span class="comment">// critical as only then is the database guaranteed to be non-sparse.</span>
00107         <span class="comment">//</span>
00108     
00109         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a29">MmDynamicPfn</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00110             <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00111         }
00112 
00113         PfnDatabaseIsPhysical = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00114     }
00115     <span class="keywordflow">else</span> {
00116         PfnDatabaseIsPhysical = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00117     }
00118 
00119     StartPage = (PFN_NUMBER)(StartAddress-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00120     NumberOfPages = (PFN_NUMBER)(NumberOfBytes-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00121 
00122     EndPage = StartPage + NumberOfPages;
00123 
00124     <span class="keywordflow">if</span> (EndPage - 1 &gt; <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a>) {
00125 
00126         <span class="comment">//</span>
00127         <span class="comment">// Truncate the request into something that can be mapped by the PFN</span>
00128         <span class="comment">// database.</span>
00129         <span class="comment">//</span>
00130 
00131         EndPage = <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> + 1;
00132         NumberOfPages = EndPage - StartPage;
00133     }
00134 
00135     <span class="comment">//</span>
00136     <span class="comment">// The range cannot wrap.</span>
00137     <span class="comment">//</span>
00138 
00139     <span class="keywordflow">if</span> (StartPage &gt;= EndPage) {
00140         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_1;
00141     }
00142 
00143     ExAcquireFastMutex (&amp;MmDynamicMemoryMutex);
00144 
00145     i = (<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a>) +
00146          (<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>) * (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> + 1)));
00147 
00148     NewPhysicalMemoryBlock = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00149                                                     i,
00150                                                     '  mM');
00151 
00152     <span class="keywordflow">if</span> (NewPhysicalMemoryBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00153         ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
00154         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00155     }
00156 
00157     <span class="comment">//</span>
00158     <span class="comment">// The range cannot overlap any ranges that are already present.</span>
00159     <span class="comment">//</span>
00160 
00161     start = 0;
00162 
00163     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00164 
00165     <span class="keywordflow">do</span> {
00166 
00167         count = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
00168         Page = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
00169 
00170         <span class="keywordflow">if</span> (count != 0) {
00171 
00172             LastPage = Page + count;
00173 
00174             <span class="keywordflow">if</span> ((StartPage &lt; Page) &amp;&amp; (EndPage &gt; Page)) {
00175                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00176                 ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
00177                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewPhysicalMemoryBlock);
00178                 <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
00179             }
00180 
00181             <span class="keywordflow">if</span> ((StartPage &gt;= Page) &amp;&amp; (StartPage &lt; LastPage)) {
00182                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00183                 ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
00184                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewPhysicalMemoryBlock);
00185                 <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
00186             }
00187         }
00188 
00189         start += 1;
00190 
00191     } <span class="keywordflow">while</span> (start != <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>);
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">// Fill any gaps in the (sparse) PFN database needed for these pages,</span>
00195     <span class="comment">// unless the PFN database was physically allocated and completely</span>
00196     <span class="comment">// committed up front.</span>
00197     <span class="comment">//</span>
00198 
00199     PagesNeeded = 0;
00200 
00201     <span class="keywordflow">if</span> (PfnDatabaseIsPhysical == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00202         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(StartPage));
00203         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PCHAR)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(EndPage)) - 1);
00204     
00205         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00206             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00207                 PagesNeeded += 1;
00208             }
00209             PointerPte += 1;
00210         }
00211     
00212         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; PagesNeeded) {
00213             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00214             ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
00215             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewPhysicalMemoryBlock);
00216             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00217         }
00218     
00219         TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
00220     
00221         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(StartPage));
00222     
00223         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00224             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00225     
00226                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a>(MI_GET_PAGE_COLOR_FROM_PTE (PointerPte));
00227     
00228                 <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 0);
00229     
00230                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
00231                 *PointerPte = TempPte;
00232             }
00233             PointerPte += 1;
00234         }
00235         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= PagesNeeded;
00236     }
00237 
00238     <span class="comment">//</span>
00239     <span class="comment">// If the new range is adjacent to an existing range, just merge it into</span>
00240     <span class="comment">// the old block.  Otherwise use the new block as a new entry will have to</span>
00241     <span class="comment">// be used.</span>
00242     <span class="comment">//</span>
00243 
00244     NewPhysicalMemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> + 1;
00245     NewPhysicalMemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> + NumberOfPages;
00246 
00247     NewRun = &amp;NewPhysicalMemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[0];
00248     start = 0;
00249     Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00250     Updated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00251 
00252     <span class="keywordflow">do</span> {
00253 
00254         Page = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
00255         count = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
00256 
00257         <span class="keywordflow">if</span> (Inserted == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00258 
00259             <span class="comment">//</span>
00260             <span class="comment">// Note overlaps into adjacent ranges were already checked above.</span>
00261             <span class="comment">//</span>
00262 
00263             <span class="keywordflow">if</span> (StartPage == Page + count) {
00264                 <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> += NumberOfPages;
00265                 OldPhysicalMemoryBlock = NewPhysicalMemoryBlock;
00266                 <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> += NumberOfPages;
00267 
00268                 <span class="comment">//</span>
00269                 <span class="comment">// Coalesce below and above to avoid leaving zero length gaps</span>
00270                 <span class="comment">// as these gaps would prevent callers from removing ranges</span>
00271                 <span class="comment">// the span them.</span>
00272                 <span class="comment">//</span>
00273 
00274                 <span class="keywordflow">if</span> (start + 1 &lt; <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>) {
00275 
00276                     start += 1;
00277                     Page = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
00278                     count = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
00279 
00280                     <span class="keywordflow">if</span> (StartPage + NumberOfPages == Page) {
00281                         <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start - 1].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> +=
00282                             count;
00283                         <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> -= 1;
00284 
00285                         <span class="comment">//</span>
00286                         <span class="comment">// Copy any remaining entries.</span>
00287                         <span class="comment">//</span>
00288     
00289                         <span class="keywordflow">if</span> (start != <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>) {
00290                             RtlMoveMemory (&amp;<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start],
00291                                            &amp;<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start + 1],
00292                                            (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> - start) * sizeof (<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>));
00293                         }
00294                     }
00295                 }
00296                 Updated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00297                 <span class="keywordflow">break</span>;
00298             }
00299 
00300             <span class="keywordflow">if</span> (StartPage + NumberOfPages == Page) {
00301                 <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> = StartPage;
00302                 <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> += NumberOfPages;
00303                 OldPhysicalMemoryBlock = NewPhysicalMemoryBlock;
00304                 <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> += NumberOfPages;
00305                 Updated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00306                 <span class="keywordflow">break</span>;
00307             }
00308 
00309             <span class="keywordflow">if</span> (StartPage + NumberOfPages &lt;= Page) {
00310 
00311                 <span class="keywordflow">if</span> (start + 1 &lt; <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>) {
00312 
00313                     <span class="keywordflow">if</span> (StartPage + NumberOfPages &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start + 1].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>) {
00314                         <span class="comment">//</span>
00315                         <span class="comment">// Don't insert here - the new entry really belongs</span>
00316                         <span class="comment">// (at least) one entry further down.</span>
00317                         <span class="comment">//</span>
00318 
00319                         <span class="keywordflow">continue</span>;
00320                     }
00321                 }
00322 
00323                 NewRun-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> = StartPage;
00324                 NewRun-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> = NumberOfPages;
00325                 NewRun += 1;
00326                 Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00327                 Updated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00328             }
00329         }
00330 
00331         *NewRun = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start];
00332         NewRun += 1;
00333 
00334         start += 1;
00335 
00336     } <span class="keywordflow">while</span> (start != <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>);
00337 
00338     <span class="comment">//</span>
00339     <span class="comment">// If the memory block has not been updated, then the new entry must</span>
00340     <span class="comment">// be added at the very end.</span>
00341     <span class="comment">//</span>
00342 
00343     <span class="keywordflow">if</span> (Updated == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00344         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Inserted == FALSE);
00345         NewRun-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> = StartPage;
00346         NewRun-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> = NumberOfPages;
00347         Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00348     }
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">// Repoint the MmPhysicalMemoryBlock at the new chunk, free the old after</span>
00352     <span class="comment">// releasing the PFN lock.</span>
00353     <span class="comment">//</span>
00354 
00355     <span class="keywordflow">if</span> (Inserted == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00356         OldPhysicalMemoryBlock = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>;
00357         <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a> = NewPhysicalMemoryBlock;
00358     }
00359 
00360     <span class="comment">//</span>
00361     <span class="comment">// Note that the page directory (page parent entries on Win64) must be</span>
00362     <span class="comment">// filled in at system boot so that already-created processes do not fault</span>
00363     <span class="comment">// when referencing the new PFNs.</span>
00364     <span class="comment">//</span>
00365 
00366     <span class="comment">//</span>
00367     <span class="comment">// Walk through the memory descriptors and add pages to the</span>
00368     <span class="comment">// free list in the PFN database.</span>
00369     <span class="comment">//</span>
00370 
00371     PageFrameIndex = StartPage;
00372     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00373 
00374     <span class="keywordflow">if</span> (EndPage - 1 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
00375         <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> = EndPage - 1;
00376     }
00377 
00378     <span class="keywordflow">while</span> (PageFrameIndex &lt; EndPage) {
00379 
00380         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
00381         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ShortFlags == 0);
00382         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
00383         <a class="code" href="../../d4/d8/mi_8h.html#a1">ASSERT64</a> (Pfn1-&gt;UsedPageTableEntries == 0);
00384         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00385         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == 0);
00386         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> == PFN_REMOVED) ||
00387                 (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> == (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(UINT_PTR)0));
00388 
00389         <span class="comment">//</span>
00390         <span class="comment">// Set the PTE address to the physical page for</span>
00391         <span class="comment">// virtual address alignment checking.</span>
00392         <span class="comment">//</span>
00393 
00394         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(PageFrameIndex &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
00395 
00396         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
00397                             PageFrameIndex);
00398 
00399         PageFrameIndex += 1;
00400         
00401         Pfn1 += 1;
00402     }
00403 
00404     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += NumberOfPages;
00405     <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> += (PFN_COUNT)NumberOfPages;
00406 
00407     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">// Increase all commit limits to reflect the additional memory.</span>
00411     <span class="comment">//</span>
00412 
00413     ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
00414 
00415     <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> += NumberOfPages;
00416     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> += NumberOfPages;
00417 
00418     <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> += PagesNeeded;
00419 
00420     ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
00421 
00422     ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
00423 
00424     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (OldPhysicalMemoryBlock);
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// Indicate number of bytes actually added to our caller.</span>
00428     <span class="comment">//</span>
00429 
00430     NumberOfBytes-&gt;QuadPart = (ULONGLONG)NumberOfPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00431 
00432     <span class="keywordflow">return</span> STATUS_SUCCESS;
00433 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="dynmem.c::MmGetPhysicalMemoryRanges" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">PPHYSICAL_MEMORY_RANGE</a> MmGetPhysicalMemoryRanges           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/dynmem_8c-source.html#l01032">1032</a> of file <a class="el" href="../../d0/d3/dynmem_8c-source.html">dynmem.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01476">_PHYSICAL_MEMORY_RANGE::BaseAddress</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00024">MmDynamicMemoryMutex</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01477">_PHYSICAL_MEMORY_RANGE::NumberOfBytes</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00035">_PHYSICAL_MEMORY_RUN::PageCount</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d2/d1/mm_8h.html#a155">PHYSICAL_MEMORY_RANGE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00041">_PHYSICAL_MEMORY_DESCRIPTOR::Run</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
<pre class="fragment"><div>01038                    :
01039 
01040     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address of a nonpaged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> block which
01041     contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical memory ranges in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
01042 
01043     The returned block contains physical address and page count pairs.
01044     The last entry contains zero <span class="keywordflow">for</span> both.
01045 
01046     The caller must understand that <span class="keyword">this</span> block can change at any point before
01047     or after <span class="keyword">this</span> snapshot.
01048 
01049     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's responsibility to free <span class="keyword">this</span> block.
01050 
01051 Arguments:
01052 
01053     None.
01054 
01055 Return Value:
01056 
01057     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
01058 
01059 Environment:
01060 
01061     Kernel mode.  PASSIVE level.  No locks held.
01062 
01063 --*/
01064 
01065 {
01066     ULONG i;
01067     KIRQL OldIrql;
01068     <a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">PPHYSICAL_MEMORY_RANGE</a> p;
01069     <a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">PPHYSICAL_MEMORY_RANGE</a> PhysicalMemoryBlock;
01070 
01071     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PASSIVE_LEVEL);
01072 
01073     ExAcquireFastMutex (&amp;MmDynamicMemoryMutex);
01074 
01075     i = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">PHYSICAL_MEMORY_RANGE</a>) * (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> + 1);
01076 
01077     PhysicalMemoryBlock = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
01078                                                  i,
01079                                                  'hPmM');
01080 
01081     <span class="keywordflow">if</span> (PhysicalMemoryBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01082         ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
01083         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01084     }
01085 
01086     p = PhysicalMemoryBlock;
01087 
01088     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01089 
01090     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (i == (<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">PHYSICAL_MEMORY_RANGE</a>) * (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> + 1)));
01091 
01092     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>; i += 1) {
01093         p-&gt;<a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html#o0">BaseAddress</a>.QuadPart = (LONGLONG)<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01094         p-&gt;<a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html#o1">NumberOfBytes</a>.QuadPart = (LONGLONG)<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01095         p += 1;
01096     }
01097 
01098     p-&gt;<a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html#o0">BaseAddress</a>.QuadPart = 0;
01099     p-&gt;<a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html#o1">NumberOfBytes</a>.QuadPart = 0;
01100 
01101     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01102 
01103     ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
01104 
01105     <span class="keywordflow">return</span> PhysicalMemoryBlock;
01106 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="dynmem.c::MmRemovePhysicalMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmRemovePhysicalMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PPHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>StartAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">437</a> of file <a class="el" href="../../d0/d3/dynmem_8c-source.html">dynmem.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00059">ASSERT64</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04555">MiDelayPageFaults</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">MiEmptyAllWorkingSets()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04870">MiFlushAllPages()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l01109">MiRemovePhysicalPages()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00026">MiTrimRemovalPagesOnly</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00024">MmDynamicMemoryMutex</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00085">MmDynamicPfn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00216">MmHalfSecond</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00076">MmHighestPossiblePhysicalPage</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00399">MmNumberOfPhysicalPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">MmPfnDatabase</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00100">MmTotalCommitLimitMaximum</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00040">MmTotalCommittedPages</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00040">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfPages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00035">_PHYSICAL_MEMORY_RUN::PageCount</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00033">PFN_REMOVED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00041">_PHYSICAL_MEMORY_DESCRIPTOR::Run</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
<pre class="fragment"><div>00444                    :
00445 
00446     This routine attempts to remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical address range
00447     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
00448 
00449 Arguments:
00450 
00451     StartAddress  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting physical address.
00452 
00453     NumberOfBytes  - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes being removed.
00454 
00455 Return Value:
00456 
00457     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>.
00458 
00459 Environment:
00460 
00461     Kernel mode.  PASSIVE level.  No locks held.
00462 
00463 --*/
00464 
00465 {
00466     ULONG i;
00467     ULONG Additional;
00468     PFN_NUMBER Page;
00469     PFN_NUMBER LastPage;
00470     PFN_NUMBER OriginalLastPage;
00471     PFN_NUMBER start;
00472     PFN_NUMBER PagesReleased;
00473     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00474     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> StartPfn;
00475     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> EndPfn;
00476     KIRQL OldIrql;
00477     PFN_NUMBER StartPage;
00478     PFN_NUMBER EndPage;
00479     PFN_COUNT NumberOfPages;
00480     SPFN_NUMBER MaxPages;
00481     PFN_NUMBER PageFrameIndex;
00482     PFN_NUMBER RemovedPages;
00483     LOGICAL Inserted;
00484     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00485     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00486     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPte;
00487     PVOID VirtualAddress;
00488     <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> OldPhysicalMemoryBlock;
00489     <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> NewPhysicalMemoryBlock;
00490     <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PPHYSICAL_MEMORY_RUN</a> NewRun;
00491     LOGICAL PfnDatabaseIsPhysical;
00492 
00493     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PASSIVE_LEVEL);
00494 
00495     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(NumberOfBytes-&gt;LowPart) == 0);
00496     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(StartAddress-&gt;LowPart) == 0);
00497 
00498     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(MmPfnDatabase)) {
00499 
00500         <span class="comment">//</span>
00501         <span class="comment">// The system must be configured for dynamic memory addition.  This is</span>
00502         <span class="comment">// not strictly required to remove the memory, but it's better to check</span>
00503         <span class="comment">// for it now under the assumption that the administrator is probably</span>
00504         <span class="comment">// going to want to add this range of memory back in - better to give</span>
00505         <span class="comment">// the error now and refuse the removal than to refuse the addition</span>
00506         <span class="comment">// later.</span>
00507         <span class="comment">//</span>
00508     
00509         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a29">MmDynamicPfn</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00510             <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00511         }
00512 
00513         PfnDatabaseIsPhysical = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00514     }
00515     <span class="keywordflow">else</span> {
00516         PfnDatabaseIsPhysical = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00517     }
00518 
00519     StartPage = (PFN_NUMBER)(StartAddress-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00520     NumberOfPages = (PFN_COUNT)(NumberOfBytes-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00521 
00522     EndPage = StartPage + NumberOfPages;
00523 
00524     <span class="keywordflow">if</span> (EndPage - 1 &gt; <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a>) {
00525 
00526         <span class="comment">//</span>
00527         <span class="comment">// Truncate the request into something that can be mapped by the PFN</span>
00528         <span class="comment">// database.</span>
00529         <span class="comment">//</span>
00530 
00531         EndPage = <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> + 1;
00532         NumberOfPages = (PFN_COUNT)(EndPage - StartPage);
00533     }
00534 
00535     <span class="comment">//</span>
00536     <span class="comment">// The range cannot wrap.</span>
00537     <span class="comment">//</span>
00538 
00539     <span class="keywordflow">if</span> (StartPage &gt;= EndPage) {
00540         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_1;
00541     }
00542 
00543     StartPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (StartPage);
00544     EndPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (EndPage);
00545 
00546     ExAcquireFastMutex (&amp;MmDynamicMemoryMutex);
00547 
00548 <span class="preprocessor">#if DBG</span>
00549 <span class="preprocessor"></span>    MiDynmemData[0] += 1;
00550 <span class="preprocessor">#endif</span>
00551 <span class="preprocessor"></span>
00552     <span class="comment">//</span>
00553     <span class="comment">// Decrease all commit limits to reflect the removed memory.</span>
00554     <span class="comment">//</span>
00555 
00556     ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
00557 
00558     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTotalCommitLimit &lt;= MmTotalCommitLimitMaximum);
00559 
00560     <span class="keywordflow">if</span> ((NumberOfPages + 100 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> - <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>) ||
00561         (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>)) {
00562 
00563 <span class="preprocessor">#if DBG</span>
00564 <span class="preprocessor"></span>        MiDynmemData[1] += 1;
00565 <span class="preprocessor">#endif</span>
00566 <span class="preprocessor"></span>        ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
00567         ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
00568         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00569     }
00570 
00571     <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> -= NumberOfPages;
00572     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> -= NumberOfPages;
00573 
00574     ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
00575 
00576     <span class="comment">//</span>
00577     <span class="comment">// Check for outstanding promises that cannot be broken.</span>
00578     <span class="comment">//</span>
00579 
00580     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00581 
00582     MaxPages = <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 100;
00583 
00584     <span class="keywordflow">if</span> ((SPFN_NUMBER)NumberOfPages &gt; MaxPages) {
00585 <span class="preprocessor">#if DBG</span>
00586 <span class="preprocessor"></span>        MiDynmemData[2] += 1;
00587 <span class="preprocessor">#endif</span>
00588 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00589         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00590         <span class="keywordflow">goto</span> giveup2;
00591     }
00592 
00593     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= NumberOfPages;
00594     <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> -= NumberOfPages;
00595 
00596     <span class="comment">//</span>
00597     <span class="comment">// The range must be contained in a single entry.  It is permissible for</span>
00598     <span class="comment">// it to be part of a single entry, but it must not cross multiple entries.</span>
00599     <span class="comment">//</span>
00600 
00601     Additional = (ULONG)-2;
00602 
00603     start = 0;
00604     <span class="keywordflow">do</span> {
00605 
00606         Page = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
00607         LastPage = Page + <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
00608 
00609         <span class="keywordflow">if</span> ((StartPage &gt;= Page) &amp;&amp; (EndPage &lt;= LastPage)) {
00610             <span class="keywordflow">if</span> ((StartPage == Page) &amp;&amp; (EndPage == LastPage)) {
00611                 Additional = (ULONG)-1;
00612             }
00613             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((StartPage == Page) || (EndPage == LastPage)) {
00614                 Additional = 0;
00615             }
00616             <span class="keywordflow">else</span> {
00617                 Additional = 1;
00618             }
00619             <span class="keywordflow">break</span>;
00620         }
00621 
00622         start += 1;
00623 
00624     } <span class="keywordflow">while</span> (start != <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>);
00625 
00626     <span class="keywordflow">if</span> (Additional == (ULONG)-2) {
00627 <span class="preprocessor">#if DBG</span>
00628 <span class="preprocessor"></span>        MiDynmemData[3] += 1;
00629 <span class="preprocessor">#endif</span>
00630 <span class="preprocessor"></span>        <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += NumberOfPages;
00631         <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> += NumberOfPages;
00632         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00633         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00634         <span class="keywordflow">goto</span> giveup2;
00635     }
00636 
00637     <span class="keywordflow">for</span> (Pfn1 = StartPfn; Pfn1 &lt; EndPfn; Pfn1 += 1) {
00638         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested = 1;
00639     }
00640 
00641     <span class="comment">//</span>
00642     <span class="comment">// The free and zero lists must be pruned now before releasing the PFN</span>
00643     <span class="comment">// lock otherwise if another thread allocates the page from these lists,</span>
00644     <span class="comment">// the allocation will clear the RemovalRequested flag forever.</span>
00645     <span class="comment">//</span>
00646 
00647     RemovedPages = <a class="code" href="../../d9/d3/dynmem_8c.html#a3">MiRemovePhysicalPages</a> (StartPage, EndPage);
00648 
00649     <span class="keywordflow">if</span> (RemovedPages != NumberOfPages) {
00650 
00651 <span class="preprocessor">#if DBG</span>
00652 <span class="preprocessor"></span>retry:
00653 <span class="preprocessor">#endif</span>
00654 <span class="preprocessor"></span>    
00655         Pfn1 = StartPfn;
00656     
00657         InterlockedIncrement (&amp;MiDelayPageFaults);
00658     
00659         <span class="keywordflow">for</span> (i = 0; i &lt; 5; i += 1) {
00660     
00661             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00662     
00663             <span class="comment">//</span>
00664             <span class="comment">// Attempt to move pages to the standby list.  Note that only the</span>
00665             <span class="comment">// pages with RemovalRequested set are moved.</span>
00666             <span class="comment">//</span>
00667     
00668             <a class="code" href="../../d9/d3/dynmem_8c.html#a2">MiTrimRemovalPagesOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00669     
00670             <a class="code" href="../../d5/d0/wsmanage_8c.html#a47">MiEmptyAllWorkingSets</a> ();
00671     
00672             <a class="code" href="../../d9/d3/dynmem_8c.html#a2">MiTrimRemovalPagesOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00673     
00674             <a class="code" href="../../d6/d3/modwrite_8c.html#a57">MiFlushAllPages</a> ();
00675     
00676             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmHalfSecond);
00677     
00678             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00679     
00680             RemovedPages += <a class="code" href="../../d9/d3/dynmem_8c.html#a3">MiRemovePhysicalPages</a> (StartPage, EndPage);
00681     
00682             <span class="keywordflow">if</span> (RemovedPages == NumberOfPages) {
00683                 <span class="keywordflow">break</span>;
00684             }
00685     
00686             <span class="comment">//</span>
00687             <span class="comment">// RemovedPages doesn't include pages that were freed directly to</span>
00688             <span class="comment">// the bad page list via MiDecrementReferenceCount.  So use the above</span>
00689             <span class="comment">// check purely as an optimization - and walk here when necessary.</span>
00690             <span class="comment">//</span>
00691     
00692             <span class="keywordflow">for</span> ( ; Pfn1 &lt; EndPfn; Pfn1 += 1) {
00693                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>) {
00694                     <span class="keywordflow">break</span>;
00695                 }
00696             }
00697     
00698             <span class="keywordflow">if</span> (Pfn1 == EndPfn) {
00699                 RemovedPages = NumberOfPages;
00700                 <span class="keywordflow">break</span>;
00701             }
00702         }
00703 
00704         InterlockedDecrement (&amp;MiDelayPageFaults);
00705     }
00706 
00707     <span class="keywordflow">if</span> (RemovedPages != NumberOfPages) {
00708 <span class="preprocessor">#if DBG</span>
00709 <span class="preprocessor"></span>        MiDynmemData[4] += 1;
00710         <span class="keywordflow">if</span> (MiShowStuckPages != 0) {
00711 
00712             RemovedPages = 0;
00713             <span class="keywordflow">for</span> (Pfn1 = StartPfn; Pfn1 &lt; EndPfn; Pfn1 += 1) {
00714                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>) {
00715                     RemovedPages += 1;
00716                 }
00717             }
00718 
00719             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RemovedPages != 0);
00720 
00721             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MmRemovePhysicalMemory : could not get %d of %d pages\n"</span>,
00722                 RemovedPages, NumberOfPages);
00723 
00724             <span class="keywordflow">if</span> (MiShowStuckPages &amp; 0x2) {
00725 
00726                 ULONG PfnsPrinted;
00727                 ULONG EnoughShown;
00728                 <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> FirstPfn;
00729                 PFN_COUNT PfnCount;
00730 
00731                 PfnCount = 0;
00732                 PfnsPrinted = 0;
00733                 EnoughShown = 100;
00734     
00735                 <span class="keywordflow">if</span> (MiShowStuckPages &amp; 0x4) {
00736                     EnoughShown = (ULONG)-1;
00737                 }
00738     
00739                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Stuck PFN list: "</span>);
00740                 <span class="keywordflow">for</span> (Pfn1 = StartPfn; Pfn1 &lt; EndPfn; Pfn1 += 1) {
00741                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>) {
00742                         <span class="keywordflow">if</span> (PfnCount == 0) {
00743                             FirstPfn = Pfn1;
00744                         }
00745                         PfnCount += 1;
00746                     }
00747                     <span class="keywordflow">else</span> {
00748                         <span class="keywordflow">if</span> (PfnCount != 0) {
00749                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%x -&gt; %x ; "</span>, FirstPfn - MmPfnDatabase,
00750                                                     (FirstPfn - MmPfnDatabase) + PfnCount - 1);
00751                             PfnsPrinted += 1;
00752                             <span class="keywordflow">if</span> (PfnsPrinted == EnoughShown) {
00753                                 <span class="keywordflow">break</span>;
00754                             }
00755                             PfnCount = 0;
00756                         }
00757                     }
00758                 }
00759                 <span class="keywordflow">if</span> (PfnCount != 0) {
00760                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%x -&gt; %x ; "</span>, FirstPfn - MmPfnDatabase,
00761                                             (FirstPfn - MmPfnDatabase) + PfnCount - 1);
00762                 }
00763                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
00764             }
00765             <span class="keywordflow">if</span> (MiShowStuckPages &amp; 0x8) {
00766                 DbgBreakPoint ();
00767             }
00768             <span class="keywordflow">if</span> (MiShowStuckPages &amp; 0x10) {
00769                 <span class="keywordflow">goto</span> retry;
00770             }
00771         }
00772 <span class="preprocessor">#endif</span>
00773 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00774         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00775         <span class="keywordflow">goto</span> giveup;
00776     }
00777 
00778 <span class="preprocessor">#if DBG</span>
00779 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (Pfn1 = StartPfn; Pfn1 &lt; EndPfn; Pfn1 += 1) {
00780         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == BadPageList);
00781     }
00782 <span class="preprocessor">#endif</span>
00783 <span class="preprocessor"></span>
00784     <span class="comment">//</span>
00785     <span class="comment">// All the pages in the range have been removed.  Update the physical</span>
00786     <span class="comment">// memory blocks and other associated housekeeping.</span>
00787     <span class="comment">//</span>
00788 
00789     <span class="keywordflow">if</span> (Additional == 0) {
00790 
00791         <span class="comment">//</span>
00792         <span class="comment">// The range can be split off from an end of an existing chunk so no</span>
00793         <span class="comment">// pool growth or shrinkage is required.</span>
00794         <span class="comment">//</span>
00795 
00796         NewPhysicalMemoryBlock = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>;
00797         OldPhysicalMemoryBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00798     }
00799     <span class="keywordflow">else</span> {
00800 
00801         <span class="comment">//</span>
00802         <span class="comment">// The range cannot be split off from an end of an existing chunk so</span>
00803         <span class="comment">// pool growth or shrinkage is required.</span>
00804         <span class="comment">//</span>
00805 
00806         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00807 
00808         i = (<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a>) +
00809              (<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>) * (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> + Additional)));
00810 
00811         NewPhysicalMemoryBlock = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00812                                                         i,
00813                                                         '  mM');
00814 
00815         <span class="keywordflow">if</span> (NewPhysicalMemoryBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00816             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00817 <span class="preprocessor">#if DBG</span>
00818 <span class="preprocessor"></span>            MiDynmemData[5] += 1;
00819 <span class="preprocessor">#endif</span>
00820 <span class="preprocessor"></span>            <span class="keywordflow">goto</span> giveup;
00821         }
00822 
00823         OldPhysicalMemoryBlock = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>;
00824         RtlZeroMemory (NewPhysicalMemoryBlock, i);
00825 
00826         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00827     }
00828 
00829     <span class="comment">//</span>
00830     <span class="comment">// Remove or split the requested range from the existing memory block.</span>
00831     <span class="comment">//</span>
00832 
00833     NewPhysicalMemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> + Additional;
00834     NewPhysicalMemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> - NumberOfPages;
00835 
00836     NewRun = &amp;NewPhysicalMemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[0];
00837     start = 0;
00838     Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00839 
00840     <span class="keywordflow">do</span> {
00841 
00842         Page = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
00843         LastPage = Page + <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
00844 
00845         <span class="keywordflow">if</span> (Inserted == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00846 
00847             <span class="keywordflow">if</span> ((StartPage &gt;= Page) &amp;&amp; (EndPage &lt;= LastPage)) {
00848 
00849                 <span class="keywordflow">if</span> ((StartPage == Page) &amp;&amp; (EndPage == LastPage)) {
00850                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Additional == -1);
00851                     start += 1;
00852                     <span class="keywordflow">continue</span>;
00853                 }
00854                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((StartPage == Page) || (EndPage == LastPage)) {
00855                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Additional == 0);
00856                     <span class="keywordflow">if</span> (StartPage == Page) {
00857                         <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> += NumberOfPages;
00858                     }
00859                     <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> -= NumberOfPages;
00860                 }
00861                 <span class="keywordflow">else</span> {
00862                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Additional == 1);
00863 
00864                     OriginalLastPage = LastPage;
00865 
00866                     <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> =
00867                         StartPage - <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
00868 
00869                     *NewRun = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start];
00870                     NewRun += 1;
00871 
00872                     NewRun-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> = EndPage;
00873                     NewRun-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> = OriginalLastPage - EndPage;
00874                     NewRun += 1;
00875 
00876                     start += 1;
00877                     <span class="keywordflow">continue</span>;
00878                 }
00879 
00880                 Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00881             }
00882         }
00883 
00884         *NewRun = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start];
00885         NewRun += 1;
00886         start += 1;
00887 
00888     } <span class="keywordflow">while</span> (start != <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>);
00889 
00890     <span class="comment">//</span>
00891     <span class="comment">// Repoint the MmPhysicalMemoryBlock at the new chunk.</span>
00892     <span class="comment">// Free the old block after releasing the PFN lock.</span>
00893     <span class="comment">//</span>
00894 
00895     <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a> = NewPhysicalMemoryBlock;
00896 
00897     <span class="keywordflow">if</span> (EndPage - 1 == <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
00898         <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> = StartPage - 1;
00899     }
00900 
00901     <span class="comment">//</span>
00902     <span class="comment">// Throw away all the removed pages that are currently enqueued.</span>
00903     <span class="comment">//</span>
00904 
00905     <span class="keywordflow">for</span> (Pfn1 = StartPfn; Pfn1 &lt; EndPfn; Pfn1 += 1) {
00906 
00907         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == BadPageList);
00908         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 1);
00909 
00910         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
00911 
00912         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink == 0);
00913         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink == 0);
00914         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
00915         <a class="code" href="../../d4/d8/mi_8h.html#a1">ASSERT64</a> (Pfn1-&gt;UsedPageTableEntries == 0);
00916 
00917         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = <a class="code" href="../../d9/d3/dynmem_8c.html#a0">PFN_REMOVED</a>;
00918         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ShortFlags = 0;
00919         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00920         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = 0;
00921     }
00922 
00923     <span class="comment">//</span>
00924     <span class="comment">// Now that the removed pages have been discarded, eliminate the PFN</span>
00925     <span class="comment">// entries that mapped them.  Straddling entries left over from an</span>
00926     <span class="comment">// adjacent earlier removal are not collapsed at this point.</span>
00927     <span class="comment">//</span>
00928     <span class="comment">//</span>
00929 
00930     PagesReleased = 0;
00931 
00932     <span class="keywordflow">if</span> (PfnDatabaseIsPhysical == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00933 
00934         VirtualAddress = (PVOID)<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(StartPage));
00935         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
00936         EndPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(EndPage)));
00937 
00938         <span class="keywordflow">while</span> (PointerPte &lt; EndPte) {
00939             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
00940             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00941             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
00942             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
00943             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
00944             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00945 <span class="preprocessor">#if DBG</span>
00946 <span class="preprocessor"></span>            Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
00947 <span class="preprocessor">#endif //DBG</span>
00948 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
00949     
00950             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (VirtualAddress,
00951                              TRUE,
00952                              TRUE,
00953                              (PHARDWARE_PTE)PointerPte,
00954                              <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
00955     
00956             PagesReleased += 1;
00957             PointerPte += 1;
00958             VirtualAddress = (PVOID)((PCHAR)VirtualAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00959         }
00960 
00961         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesReleased;
00962     }
00963 
00964 <span class="preprocessor">#if DBG</span>
00965 <span class="preprocessor"></span>    MiDynmemData[6] += 1;
00966 <span class="preprocessor">#endif</span>
00967 <span class="preprocessor"></span>
00968     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00969 
00970     <span class="keywordflow">if</span> (PagesReleased != 0) {
00971         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (PagesReleased);
00972     }
00973 
00974     ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
00975 
00976     <span class="keywordflow">if</span> (OldPhysicalMemoryBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00977         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (OldPhysicalMemoryBlock);
00978     }
00979 
00980     NumberOfBytes-&gt;QuadPart = (ULONGLONG)NumberOfPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00981 
00982     <span class="keywordflow">return</span> STATUS_SUCCESS;
00983 
00984 giveup:
00985 
00986     <span class="comment">//</span>
00987     <span class="comment">// All the pages in the range were not obtained.  Back everything out.</span>
00988     <span class="comment">//</span>
00989 
00990     PageFrameIndex = StartPage;
00991     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00992 
00993     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00994 
00995     <span class="keywordflow">while</span> (PageFrameIndex &lt; EndPage) {
00996 
00997         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 1);
00998 
00999         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested = 0;
01000 
01001         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>) &amp;&amp;
01002             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ParityError == 0)) {
01003 
01004             <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
01005             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01006                                 PageFrameIndex);
01007         }
01008 
01009         Pfn1 += 1;
01010         PageFrameIndex += 1;
01011     }
01012 
01013     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += NumberOfPages;
01014     <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> += NumberOfPages;
01015 
01016     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01017 
01018 giveup2:
01019 
01020     ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
01021     <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> += NumberOfPages;
01022     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> += NumberOfPages;
01023     ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
01024 
01025     ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
01026 
01027     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01028 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a2" doxytag="dynmem.c::MiTrimRemovalPagesOnly" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL <a class="el" href="../../d4/d0/wslist_8c.html#a11">MiTrimRemovalPagesOnly</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00026">26</a> of file <a class="el" href="../../d0/d3/dynmem_8c-source.html">dynmem.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, and <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="dynmem.c::MmDynamicMemoryMutex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d4/d8/mi_8h.html#a441">MmDynamicMemoryMutex</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00024">24</a> of file <a class="el" href="../../d0/d3/dynmem_8c-source.html">dynmem.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01095">MiCheckForCrashDump()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00043">MmAddPhysicalMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l01032">MmGetPhysicalMemoryRanges()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>, and <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:31 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
