<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mpipi.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mpipi.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d0/d3/mpipi_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/mpipi_8c.html#a0">KiFlushUserRseState</a> (IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/mpipi_8c.html#a1">KiRestoreProcessorState</a> (IN PKTRAP_FRAME TrapFrame, IN PKEXCEPTION_FRAME ExceptionFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/mpipi_8c.html#a2">KiSaveProcessorState</a> (IN PKTRAP_FRAME TrapFrame, IN PKEXCEPTION_FRAME ExceptionFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/mpipi_8c.html#a3">KiIpiServiceRoutine</a> (IN PKTRAP_FRAME TrapFrame, IN PKEXCEPTION_FRAME ExceptionFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/mpipi_8c.html#a4">KiIpiProcessRequests</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/mpipi_8c.html#a5">KiIpiSend</a> (IN KAFFINITY TargetProcessors, IN <a class="el" href="../../d0/d0/ki_8h.html#a32">KIPI_REQUEST</a> IpiRequest)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/mpipi_8c.html#a6">KiIpiSendPacket</a> (IN KAFFINITY TargetProcessors, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a55">PKIPI_WORKER</a> WorkerFunction, IN PVOID Parameter1, IN PVOID Parameter2, IN PVOID Parameter3)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/mpipi_8c.html#a7">KiIpiSignalPacketDone</a> (IN PKPRCB SignalDone)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="mpipi.c::KiFlushUserRseState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiFlushUserRseState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TrapFrame</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00646">646</a> of file <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html">ke/ia64/context.c</a>.
<p>
<pre class="fragment"><div>00652                    :
00653 
00654     This routine flushes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user rse state from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel backing store to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00655     user backing store. The user context frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> update to reflect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> 
00656     context state.
00657 
00658 Arguments:
00659 
00660     TrapFrame - Supplies a pointer to a trap frame.
00661 
00662 Return Value:
00663 
00664     None.
00665 
00666 --*/
00667 
00668 {
00669     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> BsFrameSize;
00670     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RNatSaveIndex;
00671     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> Temp;
00672     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TearPointOffset;
00673     ULONGLONG TopBound, BottomBound;
00674     ULONGLONG UserRnats1, UserRnats2;
00675     ULONGLONG Mask;
00676 
00677     <span class="comment">//</span>
00678     <span class="comment">// Copy user stacked registers' contents to user backing store.</span>
00679     <span class="comment">// N.B. Stack overflow could happen.</span>
00680     <span class="comment">//</span>
00681 
00682     <span class="keywordflow">try</span> {
00683 
00684         BsFrameSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TrapFrame-&gt;RsBSP - TrapFrame-&gt;RsBSPSTORE);
00685 
00686         <span class="keywordflow">if</span> (BsFrameSize) {
00687 
00688             ULONGLONG Bsp, Rnat, KernelInitBsp;
00689 
00690             <span class="comment">//</span>
00691             <span class="comment">// Copy the dirty stacked registers back into the</span>
00692             <span class="comment">// user backing store</span>
00693             <span class="comment">//</span>
00694 
00695             <a class="code" href="../../d8/d0/rtl_2ia64_2miscc_8c.html#a0">RtlpFlushRSE</a>(&amp;Bsp, &amp;Rnat);
00696             TearPointOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) TrapFrame-&gt;RsBSPSTORE &amp; 0x1F8;
00697 
00698             KernelInitBsp= (PCR-&gt;InitialBStore | TearPointOffset) + BsFrameSize;
00699             <span class="keywordflow">if</span> ((KernelInitBsp | RNAT_ALIGNMENT) != (Bsp | RNAT_ALIGNMENT)) {
00700                 Rnat = *(PULONGLONG)(KernelInitBsp | RNAT_ALIGNMENT);
00701             }
00702 
00703             RtlCopyMemory((PVOID)(TrapFrame-&gt;RsBSPSTORE),
00704                          (PVOID)(PCR-&gt;InitialBStore + TearPointOffset),
00705                          BsFrameSize);
00706 
00707             TopBound = TrapFrame-&gt;RsBSP | RNAT_ALIGNMENT;
00708             BottomBound = TrapFrame-&gt;RsBSPSTORE | RNAT_ALIGNMENT;
00709 
00710             RNatSaveIndex = TearPointOffset &gt;&gt; 3;
00711             Mask = (((1ULL &lt;&lt; (NAT_BITS_PER_RNAT_REG - RNatSaveIndex)) - 1) &lt;&lt; RNatSaveIndex);
00712             UserRnats1 = TrapFrame-&gt;RsRNAT &amp; ((1ULL &lt;&lt; RNatSaveIndex) - 1);
00713 
00714             <span class="keywordflow">if</span> (TopBound &gt; BottomBound) {
00715 
00716                 <span class="comment">//</span>
00717                 <span class="comment">// user dirty stacked GR span across at least one RNAT</span>
00718                 <span class="comment">// boundary; need to deposit the valid RNAT bits from</span>
00719                 <span class="comment">// the trap frame into the kernel backing store.  Also,</span>
00720                 <span class="comment">// the RNAT field in the trap frame has to be updated.</span>
00721                 <span class="comment">//</span>
00722 
00723                 UserRnats2 = *(PULONGLONG)BottomBound &amp; Mask;
00724                 *(PULONGLONG)BottomBound = UserRnats1 | UserRnats2;
00725                 TrapFrame-&gt;RsRNAT = Rnat;
00726                 
00727 <span class="preprocessor">#if DEBUG</span>
00728 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KiFlushUserRseState 1: UserRnats1 = 0x%I64x, UserRnats2 = 0x%I64x, TF-&gt;RsRNAT = 0x%I64x\n"</span>,
00729                          UserRnats1, UserRnats2, TrapFrame-&gt;RsRNAT);
00730 <span class="preprocessor">#endif // DEBUG</span>
00731 <span class="preprocessor"></span>
00732             } <span class="keywordflow">else</span> {
00733 
00734                 <span class="comment">//</span>
00735                 <span class="comment">// user stacked register region does not span across an</span>
00736                 <span class="comment">// RNAT boundary; combine the RNAT fields from both the</span>
00737                 <span class="comment">// trap frame and the context frame.</span>
00738                 <span class="comment">//</span>
00739 
00740                 UserRnats2 = Rnat &amp; Mask;
00741                 TrapFrame-&gt;RsRNAT = UserRnats1 | UserRnats2;
00742 
00743 <span class="preprocessor">#if DEBUG</span>
00744 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KiFlushUserRseState 2: UserRnats1 = 0x%I64x, UserRnats2 = 0x%I64x, TF-&gt;RsRNAT = 0x%I64x\n"</span>,
00745                          UserRnats1, UserRnats2, TrapFrame-&gt;RsRNAT);
00746 <span class="preprocessor">#endif // DEBUG</span>
00747 <span class="preprocessor"></span>
00748             }
00749         }
00750 
00751         <span class="comment">//</span>
00752         <span class="comment">// Successfully copied to user backing store; set the user's</span>
00753         <span class="comment">// bspstore to the value of its own bsp.</span>
00754         <span class="comment">//</span>
00755 
00756         TrapFrame-&gt;RsBSPSTORE = TrapFrame-&gt;RsBSP;
00757 
00758     } except (EXCEPTION_EXECUTE_HANDLER) {
00759         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"WARNING: Exception raised in krnl-to-user bstore copy\n"</span>);
00760     }
00761 
00762     <span class="keywordflow">return</span>;
00763 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="mpipi.c::KiIpiProcessRequests" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KiIpiProcessRequests           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/mpipi_8c-source.html#l00196">196</a> of file <a class="el" href="../../d0/d3/mpipi_8c-source.html">mpipi.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00279">IPI_APC</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00280">IPI_DPC</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d0/d4/intsupc_8c-source.html#l00159">KiRequestSoftwareInterrupt()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00347">PKIPI_CONTEXT</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/alpha_2ipi_8c-source.html#l00130">KiIpiServiceRoutine()</a>.
<p>
<pre class="fragment"><div>00202                    :
00203 
00204     This routine processes interprocessor requests and returns a summary
00205     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requests that were processed.
00206 
00207 Arguments:
00208 
00209     None.
00210 
00211 Return Value:
00212 
00213     The request summary <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value.
00214 
00215 --*/
00216 {
00217     ULONG RequestSummary;
00218     PKPRCB SignalDone;
00219     PKPRCB Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00220 
00221     RequestSummary = (ULONG)InterlockedExchange((PLONG)&amp;Prcb-&gt;RequestSummary, 0);
00222 
00223     <span class="comment">//</span>
00224     <span class="comment">// If a packet is ready, then get the address of the requested function</span>
00225     <span class="comment">// and call the function passing the address of the packet address as a</span>
00226     <span class="comment">// parameter.</span>
00227     <span class="comment">//</span>
00228 
00229     SignalDone = (PKPRCB)Prcb-&gt;SignalDone;
00230 
00231     <span class="keywordflow">if</span> (SignalDone != 0) {
00232      
00233         Prcb-&gt;SignalDone = 0;
00234 
00235         (*SignalDone-&gt;WorkerRoutine) ((<a class="code" href="../../d0/d9/ntosdef_8h.html#a54">PKIPI_CONTEXT</a>)SignalDone,
00236                                       SignalDone-&gt;CurrentPacket[0], 
00237                                       SignalDone-&gt;CurrentPacket[1], 
00238                                       SignalDone-&gt;CurrentPacket[2]);
00239 
00240     } 
00241 
00242     <span class="keywordflow">if</span> ((RequestSummary &amp; <a class="code" href="../../d0/d0/ki_8h.html#a16">IPI_APC</a>) != 0) {
00243         <a class="code" href="../../d9/d4/intsupc_8c.html#a3">KiRequestSoftwareInterrupt</a> (APC_LEVEL);
00244     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((RequestSummary &amp; <a class="code" href="../../d0/d0/ki_8h.html#a17">IPI_DPC</a>) != 0) {
00245         <a class="code" href="../../d9/d4/intsupc_8c.html#a3">KiRequestSoftwareInterrupt</a> (DISPATCH_LEVEL);
00246     }
00247 
00248     <span class="keywordflow">return</span> RequestSummary;
00249 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="mpipi.c::KiIpiSend" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiIpiSend           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN KAFFINITY&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetProcessors</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d0/ki_8h.html#a32">KIPI_REQUEST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IpiRequest</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/mpipi_8c-source.html#l00253">253</a> of file <a class="el" href="../../d0/d3/mpipi_8c-source.html">mpipi.c</a>.
<p>
References <a class="el" href="../../d2/d7/hal_8h.html#a198">HalRequestIpi()</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l02782">KiProcessorBlock</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d0/d4/ke_2debug_8c-source.html#l00055">KeFreezeExecution()</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00089">KeInsertQueueDpc()</a>, and <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00270">KiReadyThread()</a>.
<p>
<pre class="fragment"><div>00260                    :
00261 
00262     This routine requests <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target set of
00263     processors.
00264 
00265 Arguments:
00266 
00267     TargetProcessors (a0) - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set of processors on which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00268         specified operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be executed.
00269 
00270     IpiRequest (a1) - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request operation mask.
00271 
00272 Return Value:
00273 
00274     None.
00275 
00276 --*/
00277 
00278 {
00279 <span class="preprocessor">#if !defined(NT_UP)</span>
00280 <span class="preprocessor"></span>    ULONG RequestSummary;
00281     KAFFINITY NextProcessors;
00282     ULONG Next;
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">// Loop through the target processors and send the packet to the specified</span>
00286     <span class="comment">// recipients.</span>
00287     <span class="comment">//</span>
00288 
00289     NextProcessors = TargetProcessors;
00290     Next = 0;
00291 
00292     <span class="keywordflow">while</span> (NextProcessors != 0) {
00293 
00294         <span class="keywordflow">if</span> ((NextProcessors &amp; 1) != 0) {
00295 
00296             <span class="keywordflow">do</span> {
00297             
00298                 RequestSummary = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[Next]-&gt;RequestSummary;
00299 
00300             } <span class="keywordflow">while</span>(InterlockedCompareExchange(
00301                 (PLONG) &amp;KiProcessorBlock[Next]-&gt;RequestSummary, 
00302                 (LONG) (RequestSummary | IpiRequest),
00303                 (LONG) RequestSummary) != (LONG) RequestSummary);  
00304         }
00305 
00306         NextProcessors = NextProcessors &gt;&gt; 1;
00307         
00308         Next = Next + 1;
00309 
00310     }
00311     <a class="code" href="../../d2/d7/hal_8h.html#a198">HalRequestIpi</a> (TargetProcessors);
00312 <span class="preprocessor">#endif</span>
00313 <span class="preprocessor"></span>
00314     <span class="keywordflow">return</span>;
00315 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="mpipi.c::KiIpiSendPacket" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiIpiSendPacket           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN KAFFINITY&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetProcessors</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a55">PKIPI_WORKER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkerFunction</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter3</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/mpipi_8c-source.html#l00319">319</a> of file <a class="el" href="../../d0/d3/mpipi_8c-source.html">mpipi.c</a>.
<p>
References <a class="el" href="../../d2/d7/hal_8h.html#a198">HalRequestIpi()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l02782">KiProcessorBlock</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00318">Ke386IoSetAccessProcess()</a>, <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00080">Ke386SetIoAccessMap()</a>, <a class="el" href="../../d5/d2/i386_2ldtsup_8c-source.html#l00063">Ke386SetLdtProcess()</a>, <a class="el" href="../../d9/d3/vdmint21_8c-source.html#l00064">Ke386SetVdmInterruptHandler()</a>, <a class="el" href="../../d3/d4/mips_2flush_8c-source.html#l00074">KeChangeColorPage()</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00543">KeDetachSessionSpace()</a>, <a class="el" href="../../d8/d4/alpha_2flushtb_8c-source.html#l00086">KeFlushEntireTb()</a>, <a class="el" href="../../d0/d4/alpha_2flush_8c-source.html#l00374">KeFlushIoBuffers()</a>, <a class="el" href="../../d8/d4/alpha_2flushtb_8c-source.html#l00231">KeFlushMultipleTb()</a>, <a class="el" href="../../d8/d4/alpha_2flushtb_8c-source.html#l00587">KeFlushMultipleTb64()</a>, <a class="el" href="../../d8/d4/alpha_2flushtb_8c-source.html#l00420">KeFlushSingleTb()</a>, <a class="el" href="../../d8/d4/alpha_2flushtb_8c-source.html#l00797">KeFlushSingleTb64()</a>, <a class="el" href="../../d1/d7/profobj_8c-source.html#l00289">KeStartProfile()</a>, <a class="el" href="../../d1/d7/profobj_8c-source.html#l00520">KeStopProfile()</a>, <a class="el" href="../../d2/d4/ia64_2flush_8c-source.html#l00453">KeSweepCacheRange()</a>, <a class="el" href="../../d0/d4/alpha_2flush_8c-source.html#l00071">KeSweepDcache()</a>, <a class="el" href="../../d2/d4/ia64_2flush_8c-source.html#l00674">KeSweepDcacheRange()</a>, <a class="el" href="../../d0/d4/alpha_2flush_8c-source.html#l00202">KeSweepIcache()</a>, <a class="el" href="../../d2/d4/ia64_2flush_8c-source.html#l00559">KeSweepIcacheRange()</a>, <a class="el" href="../../d0/d4/alpha_2flush_8c-source.html#l00561">KeSynchronizeMemoryAccess()</a>, <a class="el" href="../../d0/d5/ia64_2flushtb_8c-source.html#l00733">KiGetNewRid()</a>, <a class="el" href="../../d3/d0/xipi_8c-source.html#l00040">KiIpiGenericCall()</a>, and <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00122">KiSyncNewRegionId()</a>.
<p>
<pre class="fragment"><div>00329                    :
00330 
00331     This routine executes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified worker function on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00332     set of processors.
00333 
00334 Arguments:
00335 
00336     TargetProcessors (a0) - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set of processors on which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00337         specified operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be executed.
00338 
00339     WorkerFunction (a1) - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker function.
00340 
00341     Parameter1 - Parameter3 (a2, a3, 4 * 4(sp)) - Supplies worker
00342         function specific parameters.
00343 
00344 Return Value:
00345 
00346     None.
00347 
00348 --*/
00349 {
00350 <span class="preprocessor">#if !defined(NT_UP)</span>
00351 <span class="preprocessor"></span>    PKPRCB Prcb;
00352     KAFFINITY NextProcessors;
00353     ULONG Next;
00354 
00355     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00356     Prcb-&gt;TargetSet = TargetProcessors;
00357     Prcb-&gt;WorkerRoutine = WorkerFunction;
00358     Prcb-&gt;CurrentPacket[0] = Parameter1;
00359     Prcb-&gt;CurrentPacket[1] = Parameter2;
00360     Prcb-&gt;CurrentPacket[2] = Parameter3;
00361 
00362     <span class="comment">//</span>
00363     <span class="comment">// synchronize memory access</span>
00364     <span class="comment">// </span>
00365 
00366     __mf();
00367     
00368     <span class="comment">//</span>
00369     <span class="comment">// Loop through the target processors and send the packet to the specified</span>
00370     <span class="comment">// recipients.</span>
00371     <span class="comment">//</span>
00372 
00373     NextProcessors = TargetProcessors;
00374     Next = 0;
00375 
00376     <span class="keywordflow">while</span> (NextProcessors != 0) {
00377 
00378         <span class="keywordflow">if</span> ((NextProcessors &amp; 1) != 0) {
00379             
00380             <span class="keywordflow">while</span>(InterlockedCompareExchangePointer(
00381                 (PVOID)&amp;KiProcessorBlock[Next]-&gt;SignalDone, 
00382                 (PVOID)Prcb,
00383                 (PVOID)0) != (PVOID)0);
00384 
00385         }
00386             
00387         NextProcessors = NextProcessors &gt;&gt; 1;
00388         
00389         Next = Next + 1;
00390 
00391     }
00392     <a class="code" href="../../d2/d7/hal_8h.html#a198">HalRequestIpi</a> (TargetProcessors);
00393 <span class="preprocessor">#endif    </span>
00394 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="mpipi.c::KiIpiServiceRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiIpiServiceRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/mpipi_8c-source.html#l00149">149</a> of file <a class="el" href="../../d0/d3/mpipi_8c-source.html">mpipi.c</a>.
<p>
References <a class="el" href="../../d1/d9/ki_8h-source.html#l00281">IPI_FREEZE</a>, <a class="el" href="../../d0/d4/ke_2debug_8c-source.html#l00220">KiFreezeTargetExecution()</a>, and <a class="el" href="../../d0/d3/mpipi_8c-source.html#l00196">KiIpiProcessRequests()</a>.
<p>
<pre class="fragment"><div>00156                    :
00157 
00158 
00159     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called at <a class="code" href="../../d6/d7/halmips_8h.html#a54">IPI_LEVEL</a> to process any outstanding
00160     interprocess request <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current processor.
00161 
00162 Arguments:
00163 
00164     TrapFrame - Supplies a pointer to a trap frame.
00165 
00166     ExceptionFrame - Supplies a pointer to an exception frame
00167 
00168 Return Value:
00169 
00170     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned, <span class="keywordflow">if</span> one of more requests were service.
00171     Otherwise, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00172 
00173 --*/
00174 
00175 {
00176     ULONG RequestSummary;
00177 
00178     <span class="comment">//</span>
00179     <span class="comment">// Process any outstanding IPI requests</span>
00180     <span class="comment">//</span>
00181 
00182     RequestSummary = <a class="code" href="../../d9/d3/mpipi_8c.html#a4">KiIpiProcessRequests</a>();
00183 
00184     <span class="comment">//</span>
00185     <span class="comment">// If freeze is requested, then freeze target execution.</span>
00186     <span class="comment">//</span>
00187 
00188     <span class="keywordflow">if</span> ((RequestSummary &amp; <a class="code" href="../../d0/d0/ki_8h.html#a18">IPI_FREEZE</a>) != 0) {
00189         <a class="code" href="../../d0/d0/ki_8h.html#a149">KiFreezeTargetExecution</a>(TrapFrame, ExceptionFrame);
00190     }
00191 
00192     <span class="keywordflow">return</span> ((RequestSummary &amp; ~<a class="code" href="../../d0/d0/ki_8h.html#a18">IPI_FREEZE</a>) != 0);
00193 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="mpipi.c::KiIpiSignalPacketDone" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiIpiSignalPacketDone           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKPRCB&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SignalDone</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/mpipi_8c-source.html#l00400">400</a> of file <a class="el" href="../../d0/d3/mpipi_8c-source.html">mpipi.c</a>.
<p>
References <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>.
<p>
<pre class="fragment"><div>00406                    :
00407 
00408     This routine signals that a processor has completed a packet by
00409     clearing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling processor's set member of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requesting
00410     processor's packet.
00411 
00412 Arguments:
00413 
00414     SignalDone (a0) - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor block of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00415         sending processor.
00416 
00417 Return Value:
00418 
00419     None.
00420 
00421 --*/
00422 {
00423     PKPRCB Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00424 
00425     KAFFINITY TargetSet; 
00426 
00427     <span class="keywordflow">do</span> {
00428 
00429         TargetSet = SignalDone-&gt;TargetSet; 
00430 
00431     } <span class="keywordflow">while</span> (InterlockedCompareExchange(
00432         (PLONG) &amp;SignalDone-&gt;TargetSet, 
00433         (LONG) (TargetSet ^ Prcb-&gt;SetMember), 
00434         (LONG) TargetSet) != (LONG)TargetSet);
00435 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="mpipi.c::KiRestoreProcessorState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiRestoreProcessorState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/mpipi_8c-source.html#l00035">35</a> of file <a class="el" href="../../d0/d3/mpipi_8c-source.html">mpipi.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00239">CONTEXT_FULL</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00230">KeContextToKframes()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>.
<p>
<pre class="fragment"><div>00042                    :
00043 
00044     This function moves processor <span class="keyword">register</span> state from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
00045     processor context structure in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor block to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00046     specified trap and exception frames.
00047 
00048 Arguments:
00049 
00050     TrapFrame - Supplies a pointer to a trap frame.
00051 
00052     ExceptionFrame - Supplies a pointer to an exception frame.
00053 
00054 Return Value:
00055 
00056     None.
00057 
00058 --*/
00059 
00060 {
00061 
00062 <span class="preprocessor">#if !defined(NT_UP)</span>
00063 <span class="preprocessor"></span>
00064     PKPRCB Prcb;
00065 
00066     <span class="comment">//</span>
00067     <span class="comment">// Get the address of the current processor block and move the</span>
00068     <span class="comment">// specified register state from the processor context structure</span>
00069     <span class="comment">// to the specified trap and exception frames</span>
00070     <span class="comment">//</span>
00071 
00072     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00073     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame,
00074                        ExceptionFrame,
00075                        &amp;Prcb-&gt;ProcessorState.ContextFrame,
00076                        CONTEXT_FULL,
00077                        (KPROCESSOR_MODE)TrapFrame-&gt;PreviousMode);
00078 
00079 <span class="preprocessor">#endif</span>
00080 <span class="preprocessor"></span>
00081     <span class="keywordflow">return</span>;
00082 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="mpipi.c::KiSaveProcessorState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiSaveProcessorState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/mpipi_8c-source.html#l00085">85</a> of file <a class="el" href="../../d0/d3/mpipi_8c-source.html">mpipi.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00239">CONTEXT_FULL</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00081">KeContextFromKframes()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00646">KiFlushUserRseState()</a>, <a class="el" href="../../d6/d0/xxmpipi_8c-source.html#l00124">KiSaveProcessorControlState()</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
<pre class="fragment"><div>00092                    :
00093 
00094     This function moves processor <span class="keyword">register</span> state from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified trap
00095     and exception frames to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor context structure in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
00096     processor block.
00097 
00098 Arguments:
00099 
00100     TrapFrame - Supplies a pointer to a trap frame.
00101 
00102     ExceptionFrame - Supplies a pointer to an exception frame.
00103 
00104 Return Value:
00105 
00106     None.
00107 
00108 --*/
00109 
00110 {
00111 
00112 <span class="preprocessor">#if !defined(NT_UP)</span>
00113 <span class="preprocessor"></span>
00114     PKPRCB Prcb;
00115 
00116     <span class="comment">//</span>
00117     <span class="comment">// Get the address of the current processor block and move the</span>
00118     <span class="comment">// specified register state from specified trap and exception</span>
00119     <span class="comment">// frames to the current processor context structure.</span>
00120     <span class="comment">//</span>
00121 
00122     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00123     Prcb-&gt;ProcessorState.ContextFrame.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00124     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a>(TrapFrame,
00125                          ExceptionFrame,
00126                          &amp;Prcb-&gt;ProcessorState.ContextFrame);
00127 
00128     <span class="keywordflow">if</span> (TrapFrame-&gt;PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>)
00129         <a class="code" href="../../d5/d0/psctxi64_8c.html#a4">KiFlushUserRseState</a>(TrapFrame);
00130 
00131     <span class="comment">//</span>
00132     <span class="comment">// Save ISR in special registers</span>
00133     <span class="comment">//</span>
00134 
00135     Prcb-&gt;ProcessorState.SpecialRegisters.StISR = TrapFrame-&gt;StISR;
00136 
00137     <span class="comment">//</span>
00138     <span class="comment">// Save the current processor control state.</span>
00139     <span class="comment">//</span>
00140 
00141     <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a1">KiSaveProcessorControlState</a>(&amp;Prcb-&gt;ProcessorState);
00142 
00143 <span class="preprocessor">#endif</span>
00144 <span class="preprocessor"></span>
00145     <span class="keywordflow">return</span>;
00146 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
