<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: readwrt.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>readwrt.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d0/d5/readwrt_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/readwrt_8c.html#a0">MAX_LOCK_SIZE</a>&nbsp;&nbsp;&nbsp;((ULONG)(14 * PAGE_SIZE))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/readwrt_8c.html#a1">MAX_MOVE_SIZE</a>&nbsp;&nbsp;&nbsp;(LONG)0x10000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/readwrt_8c.html#a2">MINIMUM_ALLOCATION</a>&nbsp;&nbsp;&nbsp;(LONG)128</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/readwrt_8c.html#a3">POOL_MOVE_THRESHOLD</a>&nbsp;&nbsp;&nbsp;511</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/readwrt_8c.html#a4">COPY_STACK_SIZE</a>&nbsp;&nbsp;&nbsp;64</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/readwrt_8c.html#a5">MiValidateUserTransfer</a> (IN PVOID BaseAddress, IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/readwrt_8c.html#a6">MiGetExceptionInfo</a> (IN PEXCEPTION_POINTERS ExceptionPointers, IN PULONG_PTR BadVa1, IN PULONG_PTR BadVa2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/readwrt_8c.html#a7">MiDoMappedCopy</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> FromProcess, IN PVOID FromAddress, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ToProcess, OUT PVOID ToAddress, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, OUT PULONG NumberOfBytesRead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/readwrt_8c.html#a8">MiDoPoolCopy</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> FromProcess, IN PVOID FromAddress, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ToProcess, OUT PVOID ToAddress, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, OUT PULONG NumberOfBytesRead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a> (IN HANDLE ProcessHandle, IN PVOID BaseAddress, OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, OUT PULONG NumberOfBytesRead OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a> (IN HANDLE ProcessHandle, OUT PVOID BaseAddress, IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, OUT PULONG NumberOfBytesWritten OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/readwrt_8c.html#a11">MmCopyVirtualMemory</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> FromProcess, IN PVOID FromAddress, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ToProcess, OUT PVOID ToAddress, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, OUT PULONG NumberOfBytesCopied)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a4" doxytag="readwrt.c::COPY_STACK_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define COPY_STACK_SIZE&nbsp;&nbsp;&nbsp;64          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00099">99</a> of file <a class="el" href="../../d0/d5/readwrt_8c-source.html">readwrt.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="readwrt.c::MAX_LOCK_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_LOCK_SIZE&nbsp;&nbsp;&nbsp;((ULONG)(14 * PAGE_SIZE))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00030">30</a> of file <a class="el" href="../../d0/d5/readwrt_8c-source.html">readwrt.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">MiDoMappedCopy()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="readwrt.c::MAX_MOVE_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_MOVE_SIZE&nbsp;&nbsp;&nbsp;(LONG)0x10000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00036">36</a> of file <a class="el" href="../../d0/d5/readwrt_8c-source.html">readwrt.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00758">MiDoPoolCopy()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="readwrt.c::MINIMUM_ALLOCATION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MINIMUM_ALLOCATION&nbsp;&nbsp;&nbsp;(LONG)128          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00042">42</a> of file <a class="el" href="../../d0/d5/readwrt_8c-source.html">readwrt.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="readwrt.c::POOL_MOVE_THRESHOLD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define POOL_MOVE_THRESHOLD&nbsp;&nbsp;&nbsp;511          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00048">48</a> of file <a class="el" href="../../d0/d5/readwrt_8c-source.html">readwrt.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00362">MmCopyVirtualMemory()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a7" doxytag="readwrt.c::MiDoMappedCopy" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiDoMappedCopy           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FromProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FromAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ToProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ToAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytesRead</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">529</a> of file <a class="el" href="../../d0/d5/readwrt_8c-source.html">readwrt.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00030">MAX_LOCK_SIZE</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00464">MiGetExceptionInfo()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01789">MmInitializeMdl</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00362">MmCopyVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00541                    :
00542 
00543     This function copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address range from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00544     process into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address range of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00545 
00546 Arguments:
00547 
00548      FromProcess - Supplies an open handle to a process object.
00549 
00550      FromAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process
00551                    to be read.
00552 
00553      ToProcess - Supplies an open handle to a process object.
00554 
00555      ToAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a buffer which receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00556                  contents from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process address space.
00557 
00558      <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested number of bytes to read from
00559                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process.
00560 
00561      PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous processor mode.
00562 
00563      NumberOfBytesRead - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual number of bytes
00564                          transferred into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified buffer.
00565 
00566 Return Value:
00567 
00568     TBS
00569 
00570 --*/
00571 
00572 {
00573 
00574     ULONG AmountToMove;
00575     ULONG_PTR BadVa1;
00576     ULONG_PTR BadVa2;
00577     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00578     LOGICAL Moving;
00579     LOGICAL Probing;
00580     BOOLEAN LockedMdlPages;
00581     PVOID InVa;
00582     ULONG LeftToMove;
00583     PULONG MappedAddress;
00584     ULONG MaximumMoved;
00585     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
00586     PFN_NUMBER MdlHack[(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)/<span class="keyword">sizeof</span>(PFN_NUMBER)) + (<a class="code" href="../../d9/d5/readwrt_8c.html#a0">MAX_LOCK_SIZE</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) + 1];
00587     PVOID OutVa;
00588     LOGICAL MappingFailed;
00589 
00590     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00591 
00592     MappingFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00593 
00594     <span class="comment">//</span>
00595     <span class="comment">// Get the address of the current process object and initialize copy</span>
00596     <span class="comment">// parameters.</span>
00597     <span class="comment">//</span>
00598 
00599     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00600 
00601     InVa = FromAddress;
00602     OutVa = ToAddress;
00603 
00604     MaximumMoved = <a class="code" href="../../d9/d5/readwrt_8c.html#a0">MAX_LOCK_SIZE</a>;
00605     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt;= <a class="code" href="../../d9/d5/readwrt_8c.html#a0">MAX_LOCK_SIZE</a>) {
00606         MaximumMoved = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00607     }
00608 
00609     Mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)&amp;MdlHack[0];
00610 
00611     <span class="comment">//</span>
00612     <span class="comment">// Map the data into the system part of the address space, then copy it.</span>
00613     <span class="comment">//</span>
00614 
00615     LeftToMove = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00616     AmountToMove = MaximumMoved;
00617     <span class="keywordflow">while</span> (LeftToMove &gt; 0) {
00618 
00619         <span class="keywordflow">if</span> (LeftToMove &lt; AmountToMove) {
00620 
00621             <span class="comment">//</span>
00622             <span class="comment">// Set to move the remaining bytes.</span>
00623             <span class="comment">//</span>
00624 
00625             AmountToMove = LeftToMove;
00626         }
00627 
00628         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00629         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;FromProcess-&gt;Pcb);
00630 
00631         <span class="comment">//</span>
00632         <span class="comment">// We may be touching a user's memory which could be invalid,</span>
00633         <span class="comment">// declare an exception handler.</span>
00634         <span class="comment">//</span>
00635 
00636         <span class="keywordflow">try</span> {
00637 
00638             <span class="comment">//</span>
00639             <span class="comment">// Probe to make sure that the specified buffer is accessible in</span>
00640             <span class="comment">// the target process.</span>
00641             <span class="comment">//</span>
00642 
00643             MappedAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00644             LockedMdlPages = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00645 
00646             <span class="keywordflow">if</span> ((InVa == FromAddress) &amp;&amp; (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)){
00647                 Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00648                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a> (FromAddress, BufferSize, <span class="keyword">sizeof</span>(CHAR));
00649             }
00650             Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00651 
00652             <span class="comment">//</span>
00653             <span class="comment">// Initialize MDL for request.</span>
00654             <span class="comment">//</span>
00655 
00656             <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a> (Mdl, (PVOID)InVa, AmountToMove);
00657 
00658             Moving = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00659             <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a> (Mdl, PreviousMode, IoReadAccess);
00660             Moving = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00661 
00662             LockedMdlPages = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00663 
00664             MappedAddress = <a class="code" href="../../d5/d6/iosup_8c.html#a50">MmMapLockedPagesSpecifyCache</a> (Mdl,
00665                                                           KernelMode,
00666                                                           MmCached,
00667                                                           NULL,
00668                                                           FALSE,
00669                                                           HighPagePriority);
00670 
00671             <span class="keywordflow">if</span> (MappedAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00672                 MappingFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00673                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INSUFFICIENT_RESOURCES);
00674             }
00675 
00676             <span class="comment">//</span>
00677             <span class="comment">// Deattach from the FromProcess and attach to the ToProcess.</span>
00678             <span class="comment">//</span>
00679 
00680             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00681             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;ToProcess-&gt;Pcb);
00682 
00683             <span class="comment">//</span>
00684             <span class="comment">// Now operating in the context of the ToProcess.</span>
00685             <span class="comment">//</span>
00686             <span class="keywordflow">if</span> ((InVa == FromAddress) &amp;&amp; (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)){
00687                 Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00688                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> (ToAddress, BufferSize, <span class="keyword">sizeof</span>(CHAR));
00689             }
00690             Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00691 
00692             RtlCopyMemory (OutVa, MappedAddress, AmountToMove);
00693 
00694         } except (MiGetExceptionInfo (GetExceptionInformation(),
00695                                       &amp;BadVa1,
00696                                       &amp;BadVa2)) {
00697 
00698 
00699             <span class="comment">//</span>
00700             <span class="comment">// If an exception occurs during the move operation or probe,</span>
00701             <span class="comment">// return the exception code as the status value.</span>
00702             <span class="comment">//</span>
00703 
00704             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00705             <span class="keywordflow">if</span> (MappedAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00706                 <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (MappedAddress, Mdl);
00707             }
00708             <span class="keywordflow">if</span> (LockedMdlPages == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00709                 <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Mdl);
00710             }
00711 
00712             <span class="keywordflow">if</span> (GetExceptionCode() == STATUS_WORKING_SET_QUOTA) {
00713                 <span class="keywordflow">return</span> STATUS_WORKING_SET_QUOTA;
00714             }
00715 
00716             <span class="keywordflow">if</span> ((Probing == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) || (MappingFailed == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00717                 <span class="keywordflow">return</span> GetExceptionCode();
00718 
00719             } <span class="keywordflow">else</span> {
00720 
00721                 <span class="comment">//</span>
00722                 <span class="comment">// The failure occurred during the move operation, determine</span>
00723                 <span class="comment">// which move failed, and calculate the number of bytes</span>
00724                 <span class="comment">// actually moved.</span>
00725                 <span class="comment">//</span>
00726 
00727                 <span class="keywordflow">if</span> (Moving == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00728                     <span class="keywordflow">if</span> (BadVa1 != 0xFFFFFFFF) {
00729                         *NumberOfBytesRead = (ULONG)((ULONG_PTR)BadVa2 - (ULONG_PTR)FromAddress);
00730                     }
00731 
00732                 } <span class="keywordflow">else</span> {
00733                     *NumberOfBytesRead = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - LeftToMove;
00734                 }
00735             }
00736 
00737             <span class="keywordflow">return</span> STATUS_PARTIAL_COPY;
00738         }
00739         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (MappedAddress, Mdl);
00740         <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Mdl);
00741 
00742         LeftToMove -= AmountToMove;
00743         InVa = (PVOID)((ULONG_PTR)InVa + AmountToMove);
00744         OutVa = (PVOID)((ULONG_PTR)OutVa + AmountToMove);
00745     }
00746 
00747     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00748 
00749     <span class="comment">//</span>
00750     <span class="comment">// Set number of bytes moved.</span>
00751     <span class="comment">//</span>
00752 
00753     *NumberOfBytesRead = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00754     <span class="keywordflow">return</span> STATUS_SUCCESS;
00755 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="readwrt.c::MiDoPoolCopy" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiDoPoolCopy           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FromProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FromAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ToProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ToAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytesRead</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00758">758</a> of file <a class="el" href="../../d0/d5/readwrt_8c-source.html">readwrt.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l00065">COPY_STACK_SIZE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00036">MAX_MOVE_SIZE</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00464">MiGetExceptionInfo()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00362">MmCopyVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00770                    :
00771 
00772     This function copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address range from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00773     process into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address range of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00774 
00775 Arguments:
00776 
00777      ProcessHandle - Supplies an open handle to a process object.
00778 
00779      BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process
00780                    to be read.
00781 
00782      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a buffer which receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00783               contents from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process address space.
00784 
00785      <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested number of bytes to read from
00786                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process.
00787 
00788      PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous processor mode.
00789 
00790      NumberOfBytesRead - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual number of bytes
00791                          transferred into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified buffer.
00792 
00793 Return Value:
00794 
00795     TBS
00796 
00797 --*/
00798 
00799 {
00800 
00801     ULONG AmountToMove;
00802     ULONG_PTR BadVa1;
00803     ULONG_PTR BadVa2;
00804     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00805     LOGICAL Moving;
00806     LOGICAL Probing;
00807     PVOID InVa;
00808     ULONG LeftToMove;
00809     ULONG MaximumMoved;
00810     PVOID OutVa;
00811     PVOID PoolArea;
00812     LONGLONG StackArray[<a class="code" href="../../d8/d5/physical_8c.html#a0">COPY_STACK_SIZE</a>];
00813     ULONG FreePool;
00814 
00815     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00816 
00817     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (BufferSize != 0);
00818 
00819     <span class="comment">//</span>
00820     <span class="comment">// Get the address of the current process object and initialize copy</span>
00821     <span class="comment">// parameters.</span>
00822     <span class="comment">//</span>
00823 
00824     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00825 
00826     InVa = FromAddress;
00827     OutVa = ToAddress;
00828 
00829     <span class="comment">//</span>
00830     <span class="comment">// Allocate non-paged memory to copy in and out of.</span>
00831     <span class="comment">//</span>
00832 
00833     MaximumMoved = <a class="code" href="../../d9/d5/readwrt_8c.html#a1">MAX_MOVE_SIZE</a>;
00834     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt;= <a class="code" href="../../d9/d5/readwrt_8c.html#a1">MAX_MOVE_SIZE</a>) {
00835         MaximumMoved = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00836     }
00837 
00838     FreePool = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00839     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt;= <span class="keyword">sizeof</span>(StackArray)) {
00840         PoolArea = (PULONG)&amp;StackArray[0];
00841     } <span class="keywordflow">else</span> {
00842         <span class="keywordflow">do</span> {
00843             PoolArea = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool, MaximumMoved, 'wRmM');
00844             <span class="keywordflow">if</span> (PoolArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00845                 FreePool = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00846                 <span class="keywordflow">break</span>;
00847             }
00848 
00849             MaximumMoved = MaximumMoved &gt;&gt; 1;
00850             <span class="keywordflow">if</span> (MaximumMoved &lt;= <span class="keyword">sizeof</span>(StackArray)) {
00851                 PoolArea = (PULONG)&amp;StackArray[0];
00852                 <span class="keywordflow">break</span>;
00853             }
00854         } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00855     }
00856 
00857     <span class="comment">//</span>
00858     <span class="comment">// Copy the data into pool, then copy back into the ToProcess.</span>
00859     <span class="comment">//</span>
00860 
00861     LeftToMove = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00862     AmountToMove = MaximumMoved;
00863     <span class="keywordflow">while</span> (LeftToMove &gt; 0) {
00864 
00865         <span class="keywordflow">if</span> (LeftToMove &lt; AmountToMove) {
00866 
00867             <span class="comment">//</span>
00868             <span class="comment">// Set to move the remaining bytes.</span>
00869             <span class="comment">//</span>
00870 
00871             AmountToMove = LeftToMove;
00872         }
00873 
00874         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00875         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;FromProcess-&gt;Pcb);
00876 
00877         <span class="comment">//</span>
00878         <span class="comment">// We may be touching a user's memory which could be invalid,</span>
00879         <span class="comment">// declare an exception handler.</span>
00880         <span class="comment">//</span>
00881 
00882         <span class="keywordflow">try</span> {
00883 
00884             <span class="comment">//</span>
00885             <span class="comment">// Probe to make sure that the specified buffer is accessible in</span>
00886             <span class="comment">// the target process.</span>
00887             <span class="comment">//</span>
00888 
00889             <span class="keywordflow">if</span> ((InVa == FromAddress) &amp;&amp; (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)){
00890                 Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00891                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a> (FromAddress, BufferSize, <span class="keyword">sizeof</span>(CHAR));
00892             }
00893 
00894             Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00895 
00896             Moving = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00897 
00898             RtlCopyMemory (PoolArea, InVa, AmountToMove);
00899 
00900             Moving = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00901 
00902             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00903             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;ToProcess-&gt;Pcb);
00904 
00905             <span class="comment">//</span>
00906             <span class="comment">// Now operating in the context of the ToProcess.</span>
00907             <span class="comment">//</span>
00908 
00909             <span class="keywordflow">if</span> ((InVa == FromAddress) &amp;&amp; (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)){
00910                 Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00911                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> (ToAddress, BufferSize, <span class="keyword">sizeof</span>(CHAR));
00912             }
00913             Probing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00914 
00915             RtlCopyMemory (OutVa, PoolArea, AmountToMove);
00916 
00917         } except (MiGetExceptionInfo (GetExceptionInformation(),
00918                                       &amp;BadVa1,
00919                                       &amp;BadVa2)) {
00920 
00921             <span class="comment">//</span>
00922             <span class="comment">// If an exception occurs during the move operation or probe,</span>
00923             <span class="comment">// return the exception code as the status value.</span>
00924             <span class="comment">//</span>
00925 
00926             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00927 
00928             <span class="keywordflow">if</span> (FreePool) {
00929                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PoolArea);
00930             }
00931             <span class="keywordflow">if</span> (Probing == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00932                 <span class="keywordflow">return</span> GetExceptionCode();
00933 
00934             } <span class="keywordflow">else</span> {
00935 
00936                 <span class="comment">//</span>
00937                 <span class="comment">// The failure occurred during the move operation, determine</span>
00938                 <span class="comment">// which move failed, and calculate the number of bytes</span>
00939                 <span class="comment">// actually moved.</span>
00940                 <span class="comment">//</span>
00941 
00942                 <span class="keywordflow">if</span> (Moving == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00943 
00944                     <span class="comment">//</span>
00945                     <span class="comment">// The failure occurred getting the data.</span>
00946                     <span class="comment">//</span>
00947 
00948                     <span class="keywordflow">if</span> (BadVa1 != 0xFFFFFFFF) {
00949                         *NumberOfBytesRead = (ULONG)((ULONG_PTR)(BadVa2 - (ULONG_PTR)FromAddress));
00950                     }
00951 
00952                 } <span class="keywordflow">else</span> {
00953 
00954                     <span class="comment">//</span>
00955                     <span class="comment">// The failure occurred writing the data.</span>
00956                     <span class="comment">//</span>
00957 
00958                     *NumberOfBytesRead = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - LeftToMove;
00959                 }
00960             }
00961 
00962             <span class="keywordflow">return</span> STATUS_PARTIAL_COPY;
00963         }
00964 
00965         LeftToMove -= AmountToMove;
00966         InVa = (PVOID)((ULONG_PTR)InVa + AmountToMove);
00967         OutVa = (PVOID)((ULONG_PTR)OutVa + AmountToMove);
00968     }
00969 
00970     <span class="keywordflow">if</span> (FreePool) {
00971         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PoolArea);
00972     }
00973     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00974 
00975     <span class="comment">//</span>
00976     <span class="comment">// Set number of bytes moved.</span>
00977     <span class="comment">//</span>
00978 
00979     *NumberOfBytesRead = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00980     <span class="keywordflow">return</span> STATUS_SUCCESS;
00981 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="readwrt.c::MiGetExceptionInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiGetExceptionInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionPointers</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>BadVa1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>BadVa2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00464">464</a> of file <a class="el" href="../../d0/d5/readwrt_8c-source.html">readwrt.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">MiDoMappedCopy()</a>, and <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00758">MiDoPoolCopy()</a>.
<p>
<pre class="fragment"><div>00472                    :
00473 
00474     This routine examines a exception record and extracts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span>
00475     address of an access violation, guard page violation, or in-page error.
00476 
00477 Arguments:
00478 
00479     ExceptionPointers - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception record.
00480 
00481     BadVa - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address which caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access violation.
00482 
00483 Return Value:
00484 
00485     EXECUTE_EXCEPTION_HANDLER
00486 
00487 --*/
00488 
00489 {
00490     PEXCEPTION_RECORD ExceptionRecord;
00491 
00492     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00493 
00494     <span class="comment">//</span>
00495     <span class="comment">// If the exception code is an access violation, guard page violation,</span>
00496     <span class="comment">// or an in-page read error, then return the faulting address. Otherwise.</span>
00497     <span class="comment">// return a special address value.</span>
00498     <span class="comment">//</span>
00499 
00500     *BadVa2 = 0;
00501     ExceptionRecord = ExceptionPointers-&gt;ExceptionRecord;
00502     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_ACCESS_VIOLATION) ||
00503         (ExceptionRecord-&gt;ExceptionCode == STATUS_GUARD_PAGE_VIOLATION) ||
00504         (ExceptionRecord-&gt;ExceptionCode == STATUS_IN_PAGE_ERROR)) {
00505 
00506         <span class="comment">//</span>
00507         <span class="comment">// The virtual address which caused the exception is the 2nd</span>
00508         <span class="comment">// parameter in the exception information array.</span>
00509         <span class="comment">//</span>
00510 
00511         *BadVa1 = ExceptionRecord-&gt;ExceptionInformation[1];
00512         <span class="keywordflow">if</span> (ExceptionRecord-&gt;NumberParameters == 3) {
00513             *BadVa2 = ExceptionRecord-&gt;ExceptionInformation[2];
00514         }
00515 
00516     } <span class="keywordflow">else</span> {
00517 
00518         <span class="comment">//</span>
00519         <span class="comment">// Unexpected exception - set the number of bytes copied to zero.</span>
00520         <span class="comment">//</span>
00521 
00522         *BadVa2 = 0xFFFFFFFF;
00523     }
00524 
00525     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00526 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="readwrt.c::MiValidateUserTransfer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiValidateUserTransfer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00985">985</a> of file <a class="el" href="../../d0/d5/readwrt_8c-source.html">readwrt.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00102">NtReadVirtualMemory()</a>, and <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00231">NtWriteVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00993                    :
00994 
00995     This function checks whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameter source and destination address
00996     ranges lie within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user <span class="keyword">virtual</span> address space.  This function does NOT
00997     guarantee that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> addresses are in fact mapped or that faults will not
00998     occur - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> just validates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address range.
00999 
01000 Arguments:
01001 
01002      BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address within a process to be read.
01003 
01004      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a buffer which sends or receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01005               contents from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process address space.
01006 
01007      <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested number of bytes to read or write from
01008                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process.
01009 
01010 Return Value:
01011 
01012     STATUS_SUCCESS <span class="keywordflow">if</span> valid user ranges, error otherwise.
01013 
01014 Environment:
01015 
01016     None.
01017 
01018 --*/
01019 
01020 {
01021     ULONG_PTR   BaseAddress;
01022     ULONG_PTR   <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01023 
01024     BaseAddress = (ULONG_PTR)BaseAddressPointer;
01025     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (ULONG_PTR)BufferPointer;
01026 
01027     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01028 
01029     <span class="comment">//</span>
01030     <span class="comment">// check that both the base address and the target buffer qualify</span>
01031     <span class="comment">// as valid user address ranges.  Wrapping is not allowed.</span>
01032     <span class="comment">//</span>
01033     <span class="keywordflow">if</span> (BaseAddress + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt; BaseAddress) {
01034         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01035     }
01036 
01037     <span class="keywordflow">if</span> (((PVOID)BaseAddress &gt; MM_HIGHEST_USER_ADDRESS) ||
01038         ((PVOID)(BaseAddress + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) &gt; MM_HIGHEST_USER_ADDRESS)) {
01039 
01040             <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01041     }
01042 
01043     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) {
01044         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01045     }
01046 
01047     <span class="keywordflow">if</span> (((PVOID)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> &gt; MM_HIGHEST_USER_ADDRESS) ||
01048         ((PVOID)(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) &gt; MM_HIGHEST_USER_ADDRESS)) {
01049 
01050             <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01051     }
01052 
01053     <span class="keywordflow">return</span> STATUS_SUCCESS;
01054 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="readwrt.c::MmCopyVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmCopyVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FromProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FromAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ToProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ToAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytesCopied</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00362">362</a> of file <a class="el" href="../../d0/d5/readwrt_8c-source.html">readwrt.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00216">_EPROCESS::AddressSpaceDeleted</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">MiDoMappedCopy()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00758">MiDoPoolCopy()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00822">MiLockSystemSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00825">MiUnlockSystemSpace</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00048">POOL_MOVE_THRESHOLD</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00220">_EPROCESS::VmOperation</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00223">_EPROCESS::VmOperationEvent</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/lpcreply_8c-source.html#l00915">LpcpCopyRequestData()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00102">NtReadVirtualMemory()</a>, and <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00231">NtWriteVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00371 {
00372     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00373     KIRQL OldIrql;
00374     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToLock;
00375 
00376     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> == 0) {
00377         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);         <span class="comment">// No one should call with a zero size.</span>
00378         <span class="keywordflow">return</span> STATUS_SUCCESS;
00379     }
00380 
00381     ProcessToLock = FromProcess;
00382     <span class="keywordflow">if</span> (FromProcess == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()) {
00383         ProcessToLock = ToProcess;
00384     }
00385 
00386     <span class="comment">//</span>
00387     <span class="comment">// Make sure the process still has an address space.</span>
00388     <span class="comment">//</span>
00389 
00390     <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
00391     <span class="keywordflow">if</span> (ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
00392         <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00393         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00394     }
00395     ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o31">VmOperation</a> += 1;
00396     <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00397 
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">// If the buffer size is greater than the pool move threshold,</span>
00401     <span class="comment">// then attempt to write the memory via direct mapping.</span>
00402     <span class="comment">//</span>
00403 
00404     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &gt; <a class="code" href="../../d9/d5/readwrt_8c.html#a3">POOL_MOVE_THRESHOLD</a>) {
00405         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a7">MiDoMappedCopy</a>(FromProcess,
00406                                 FromAddress,
00407                                 ToProcess,
00408                                 ToAddress,
00409                                 BufferSize,
00410                                 PreviousMode,
00411                                 NumberOfBytesCopied);
00412 
00413         <span class="comment">//</span>
00414         <span class="comment">// If the completion status is not a working quota problem,</span>
00415         <span class="comment">// then finish the service. Otherwise, attempt to write the</span>
00416         <span class="comment">// memory through nonpaged pool.</span>
00417         <span class="comment">//</span>
00418 
00419         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_WORKING_SET_QUOTA) {
00420             <span class="keywordflow">goto</span> CompleteService;
00421         }
00422 
00423         *NumberOfBytesCopied = 0;
00424     }
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// There was not enough working set quota to write the memory via</span>
00428     <span class="comment">// direct mapping or the size of the write was below the pool move</span>
00429     <span class="comment">// threshold. Attempt to write the specified memory through nonpaged</span>
00430     <span class="comment">// pool.</span>
00431     <span class="comment">//</span>
00432 
00433     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a8">MiDoPoolCopy</a>(FromProcess,
00434                           FromAddress,
00435                           ToProcess,
00436                           ToAddress,
00437                           BufferSize,
00438                           PreviousMode,
00439                           NumberOfBytesCopied);
00440 
00441     <span class="comment">//</span>
00442     <span class="comment">// Dereference the target process.</span>
00443     <span class="comment">//</span>
00444 
00445 CompleteService:
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">// Indicate that the vm operation is complete.</span>
00449     <span class="comment">//</span>
00450 
00451     <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
00452     ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o31">VmOperation</a> -= 1;
00453     <span class="keywordflow">if</span> ((ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o31">VmOperation</a> == 0) &amp;&amp;
00454         (ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o34">VmOperationEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00455        <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o34">VmOperationEvent</a>, 0, FALSE);
00456     }
00457     <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00458 
00459     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00460 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="readwrt.c::NtReadVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtReadVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG NumberOfBytesRead&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00102">102</a> of file <a class="el" href="../../d0/d5/readwrt_8c-source.html">readwrt.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00985">MiValidateUserTransfer()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00362">MmCopyVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01091">ConsoleClientConnectRoutine()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00423">GetHardErrorText()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01788">RtlCheckForOrphanedCriticalSections()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00399">RtlDestroyQueryDebugBuffer()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l01385">RtlFreeUserThreadStack()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00469">RtlQueryProcessDebugInformation()</a>, and <a class="el" href="../../d3/d7/directio_8c-source.html#l01284">SrvWriteConsoleOutput()</a>.
<p>
<pre class="fragment"><div>00112                    :
00113 
00114     This function copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address range from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00115     process into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address range of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00116 
00117 Arguments:
00118 
00119      ProcessHandle - Supplies an open handle to a process object.
00120 
00121      BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process
00122           to be read.
00123 
00124      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a buffer which receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00125           contents from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process address space.
00126 
00127      <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested number of bytes to read from
00128           <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process.
00129 
00130      NumberOfBytesRead - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual number of bytes
00131           transferred into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified buffer.
00132 
00133 Return Value:
00134 
00135     TBS
00136 
00137 --*/
00138 
00139 {
00140 
00141     ULONG BytesCopied;
00142     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00143     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00144     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00145 
00146     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Get the previous mode and probe output argument if necessary.</span>
00150     <span class="comment">//</span>
00151 
00152     PreviousMode = KeGetPreviousMode();
00153     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00154 
00155         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a5">MiValidateUserTransfer</a>(BaseAddress, Buffer, BufferSize);
00156         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00157             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00158         }
00159 
00160         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NumberOfBytesRead)) {
00161             <span class="keywordflow">try</span> {
00162                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(NumberOfBytesRead);
00163 
00164             } except(EXCEPTION_EXECUTE_HANDLER) {
00165                 <span class="keywordflow">return</span> GetExceptionCode();
00166             }
00167         }
00168     }
00169 
00170     <span class="comment">//</span>
00171     <span class="comment">// If the buffer size is not zero, then attempt to read data from the</span>
00172     <span class="comment">// specified process address space into the current process address</span>
00173     <span class="comment">// space.</span>
00174     <span class="comment">//</span>
00175 
00176     BytesCopied = 0;
00177     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00178     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> != 0) {
00179 
00180         <span class="comment">//</span>
00181         <span class="comment">// Reference the target process.</span>
00182         <span class="comment">//</span>
00183 
00184         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(ProcessHandle,
00185                                            PROCESS_VM_READ,
00186                                            PsProcessType,
00187                                            PreviousMode,
00188                                            (PVOID *)&amp;Process,
00189                                            NULL);
00190 
00191         <span class="comment">//</span>
00192         <span class="comment">// If the process was successfully referenced, then attempt to</span>
00193         <span class="comment">// read the specified memory either by direct mapping or copying</span>
00194         <span class="comment">// through nonpaged pool.</span>
00195         <span class="comment">//</span>
00196 
00197         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
00198 
00199             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a11">MmCopyVirtualMemory</a> (Process,
00200                                           BaseAddress,
00201                                           <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
00202                                           Buffer,
00203                                           BufferSize,
00204                                           PreviousMode,
00205                                           &amp;BytesCopied);
00206 
00207             <span class="comment">//</span>
00208             <span class="comment">// Dereference the target process.</span>
00209             <span class="comment">//</span>
00210 
00211             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00212         }
00213     }
00214 
00215     <span class="comment">//</span>
00216     <span class="comment">// If requested, return the number of bytes read.</span>
00217     <span class="comment">//</span>
00218 
00219     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NumberOfBytesRead)) {
00220         <span class="keywordflow">try</span> {
00221             *NumberOfBytesRead = BytesCopied;
00222 
00223         } except(EXCEPTION_EXECUTE_HANDLER) {
00224             NOTHING;
00225         }
00226     }
00227 
00228     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00229 }
<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="readwrt.c::NtWriteVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtWriteVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG NumberOfBytesWritten&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00231">231</a> of file <a class="el" href="../../d0/d5/readwrt_8c-source.html">readwrt.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00985">MiValidateUserTransfer()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00362">MmCopyVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/rtl_2alpha_2context_8c-source.html#l00193">RtlRemoteCall()</a>.
<p>
<pre class="fragment"><div>00241                    :
00242 
00243     This function copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address range from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
00244     process into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address range of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process.
00245 
00246 Arguments:
00247 
00248      ProcessHandle - Supplies an open handle to a process object.
00249 
00250      BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address to be written to in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00251           specified process.
00252 
00253      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a buffer which contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00254           contents to be written into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process
00255           address space.
00256 
00257      <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested number of bytes to write
00258           into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process.
00259 
00260      NumberOfBytesWritten - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual number of
00261           bytes transferred into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address
00262           space.
00263 
00264 Return Value:
00265 
00266     TBS
00267 
00268 --*/
00269 
00270 {
00271     ULONG BytesCopied;
00272     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00273     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00274     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00275 
00276     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00277 
00278     <span class="comment">//</span>
00279     <span class="comment">// Get the previous mode and probe output argument if necessary.</span>
00280     <span class="comment">//</span>
00281 
00282     PreviousMode = KeGetPreviousMode();
00283     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00284 
00285         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a5">MiValidateUserTransfer</a>(BaseAddress, Buffer, BufferSize);
00286         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00287             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00288         }
00289 
00290         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NumberOfBytesWritten)) {
00291             <span class="keywordflow">try</span> {
00292                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(NumberOfBytesWritten);
00293 
00294             } except(EXCEPTION_EXECUTE_HANDLER) {
00295                 <span class="keywordflow">return</span> GetExceptionCode();
00296             }
00297         }
00298     }
00299 
00300     <span class="comment">//</span>
00301     <span class="comment">// If the buffer size is not zero, then attempt to write data from the</span>
00302     <span class="comment">// current process address space into the target process address space.</span>
00303     <span class="comment">//</span>
00304 
00305     BytesCopied = 0;
00306     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00307     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> != 0) {
00308 
00309         <span class="comment">//</span>
00310         <span class="comment">// Reference the target process.</span>
00311         <span class="comment">//</span>
00312 
00313         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(ProcessHandle,
00314                                            PROCESS_VM_WRITE,
00315                                            PsProcessType,
00316                                            PreviousMode,
00317                                            (PVOID *)&amp;Process,
00318                                            NULL);
00319 
00320         <span class="comment">//</span>
00321         <span class="comment">// If the process was successfully referenced, then attempt to</span>
00322         <span class="comment">// write the specified memory either by direct mapping or copying</span>
00323         <span class="comment">// through nonpaged pool.</span>
00324         <span class="comment">//</span>
00325 
00326         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
00327 
00328             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a11">MmCopyVirtualMemory</a> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
00329                                           Buffer,
00330                                           Process,
00331                                           BaseAddress,
00332                                           BufferSize,
00333                                           PreviousMode,
00334                                           &amp;BytesCopied);
00335 
00336             <span class="comment">//</span>
00337             <span class="comment">// Dereference the target process.</span>
00338             <span class="comment">//</span>
00339 
00340             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00341         }
00342     }
00343 
00344     <span class="comment">//</span>
00345     <span class="comment">// If requested, return the number of bytes read.</span>
00346     <span class="comment">//</span>
00347 
00348     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NumberOfBytesWritten)) {
00349         <span class="keywordflow">try</span> {
00350             *NumberOfBytesWritten = BytesCopied;
00351 
00352         } except(EXCEPTION_EXECUTE_HANDLER) {
00353             NOTHING;
00354         }
00355     }
00356 
00357     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00358 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
