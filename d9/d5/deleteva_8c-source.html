<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: deleteva.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>deleteva.c</h1><a href="../../d8/d6/deleteva_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   deleteva.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines for deleting virtual address space.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Lou Perazzoli (loup) 11-May-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Landy Wang (landyw) 08-April-1998 : Modifications for 3-level 64-bit NT.</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00024 
00025 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00026"></a><a class="code" href="../../d4/d8/mi_8h.html#a885">00026</a> <a class="code" href="../../d4/d8/mi_8h.html#a885">MiDeleteVirtualAddresses</a> (
00027     IN PUCHAR StartingAddress,
00028     IN PUCHAR EndingAddress,
00029     IN ULONG AddressSpaceDeletion,
00030     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad
00031     )
00032 
00033 <span class="comment">/*++</span>
00034 <span class="comment"></span>
00035 <span class="comment">Routine Description:</span>
00036 <span class="comment"></span>
00037 <span class="comment">    This routine deletes the specified virtual address range within</span>
00038 <span class="comment">    the current process.</span>
00039 <span class="comment"></span>
00040 <span class="comment">Arguments:</span>
00041 <span class="comment"></span>
00042 <span class="comment">    StartingAddress - Supplies the first virtual address to delete.</span>
00043 <span class="comment"></span>
00044 <span class="comment">    EndingAddress - Supplies the last address to delete.</span>
00045 <span class="comment"></span>
00046 <span class="comment">    AddressSpaceDeletion - Supplies TRUE if the address space is being</span>
00047 <span class="comment">                           deleted, FALSE otherwise.  If TRUE is specified</span>
00048 <span class="comment">                           the TB is not flushed and valid addresses are</span>
00049 <span class="comment">                           not removed from the working set.</span>
00050 <span class="comment"></span>
00051 <span class="comment">    Vad - Supplies the virtual address descriptor which maps this range</span>
00052 <span class="comment">          or NULL if we are not concerned about views.  From the Vad the</span>
00053 <span class="comment">          range of prototype PTEs is determined and this information is</span>
00054 <span class="comment">          used to uncover if the PTE refers to a prototype PTE or a</span>
00055 <span class="comment">          fork PTE.</span>
00056 <span class="comment"></span>
00057 <span class="comment">Return Value:</span>
00058 <span class="comment"></span>
00059 <span class="comment">    None.</span>
00060 <span class="comment"></span>
00061 <span class="comment"></span>
00062 <span class="comment">Environment:</span>
00063 <span class="comment"></span>
00064 <span class="comment">    Kernel mode, called with APCs disabled, working set mutex and PFN lock</span>
00065 <span class="comment">    held.  These mutexes may be released and reacquired to fault pages in.</span>
00066 <span class="comment"></span>
00067 <span class="comment">--*/</span>
00068 
00069 {
00070     PUCHAR Va;
00071     PUCHAR FirstValidVa;
00072     PVOID TempVa;
00073     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00074     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00075     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00076     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> OriginalPointerPte;
00077     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
00078     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte2;
00079     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastProtoPte;
00080     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastProtoPte2;
00081     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00082     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00083     PVOID UsedPageTableHandle;
00084     PVOID UsedPageDirectoryHandle;
00085     KIRQL OldIrql;
00086     <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a> FlushList;
00087     ULONG Waited;
00088     LOGICAL Skipped;
00089 
00090     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00091     FlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = 0;
00092 
00093     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00094     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00095 
00096     Va = StartingAddress;
00097     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (Va);
00098     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (Va);
00099     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Va);
00100     OriginalPointerPte = PointerPte;
00101 
00102     <span class="keywordflow">do</span> {
00103 
00104         <span class="keywordflow">while</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00105                                            CurrentProcess,
00106                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00107                                            &amp;Waited)           ==  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00108 
00109             <span class="comment">//</span>
00110             <span class="comment">// This page directory parent entry is empty, go to the next one.</span>
00111             <span class="comment">//</span>
00112 
00113             PointerPpe += 1;
00114             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00115             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00116             Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00117 
00118             <span class="keywordflow">if</span> (Va &gt; EndingAddress) {
00119 
00120                 <span class="comment">//</span>
00121                 <span class="comment">// All done, return.</span>
00122                 <span class="comment">//</span>
00123 
00124                 <span class="keywordflow">return</span>;
00125             }
00126         }
00127 
00128         Waited = 0;
00129 
00130         <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00131                                            CurrentProcess,
00132                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00133                                            &amp;Waited)           ==  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00134 
00135             <span class="comment">//</span>
00136             <span class="comment">// This page directory entry is empty, go to the next one.</span>
00137             <span class="comment">//</span>
00138 
00139             PointerPde += 1;
00140             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00141             Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00142 
00143             <span class="keywordflow">if</span> (Va &gt; EndingAddress) {
00144 
00145                 <span class="comment">//</span>
00146                 <span class="comment">// All done, return.</span>
00147                 <span class="comment">//</span>
00148 
00149                 <span class="keywordflow">return</span>;
00150             }
00151 <span class="preprocessor">#if defined (_WIN64)</span>
00152 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
00153                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00154                 Waited = 1;
00155                 <span class="keywordflow">break</span>;
00156             }
00157 <span class="preprocessor">#endif</span>
00158 <span class="preprocessor"></span>        }
00159 
00160     } <span class="keywordflow">while</span> (Waited != 0);
00161 
00162     FirstValidVa = Va;
00163     UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (Va);
00164 
00165     <span class="comment">//</span>
00166     <span class="comment">// A valid PDE has been located, examine each PTE and delete them.</span>
00167     <span class="comment">//</span>
00168 
00169     <span class="keywordflow">if</span> ((Vad == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00170         (Vad-&gt;u.VadFlags.PrivateMemory) ||
00171         (Vad-&gt;FirstPrototypePte == (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00172         ProtoPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00173         LastProtoPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00174     } <span class="keywordflow">else</span> {
00175         ProtoPte = Vad-&gt;FirstPrototypePte;
00176         LastProtoPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)4;
00177     }
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">// Examine each PTE within the address range and delete it.</span>
00181     <span class="comment">//</span>
00182 
00183     <span class="keywordflow">while</span> (Va &lt;= EndingAddress) {
00184 
00185         <span class="comment">//</span>
00186         <span class="comment">// Note that the initial address could be aligned on a PPE or PDE</span>
00187         <span class="comment">// boundary so we must check for it here.</span>
00188         <span class="comment">//</span>
00189 
00190         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a165">MiIsVirtualAddressOnPdeBoundary</a>(Va)) {
00191 
00192             <span class="comment">//</span>
00193             <span class="comment">// The virtual address is on a page directory boundary,</span>
00194             <span class="comment">// check the next PDE for validity and flush PTEs for the</span>
00195             <span class="comment">// previous page table page.</span>
00196             <span class="comment">//</span>
00197 
00198             <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;FlushList, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
00199 
00200             <span class="comment">//</span>
00201             <span class="comment">// If all the entries have been eliminated from the previous</span>
00202             <span class="comment">// page table page, delete the page table page itself.</span>
00203             <span class="comment">//</span>
00204 
00205             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageTableHandle) == 0) &amp;&amp;
00206                 (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0)) {
00207 
00208                 TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPde);
00209                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPde,
00210                              TempVa,
00211                              AddressSpaceDeletion,
00212                              CurrentProcess,
00213                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00214                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00215 
00216 <span class="preprocessor">#if defined (_WIN64)</span>
00217 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Va == FirstValidVa) {
00218                     UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00219                 }
00220                 <span class="keywordflow">else</span> {
00221                     UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte - 1);
00222                 }
00223 
00224                 <a class="code" href="../../d4/d8/mi_8h.html#a183">MI_DECREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00225 <span class="preprocessor">#endif</span>
00226 <span class="preprocessor"></span>
00227             }
00228 
00229             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a164">MiIsVirtualAddressOnPpeBoundary</a>(Va)) {
00230 
00231                 <span class="keywordflow">if</span> (Va == FirstValidVa) {
00232                     UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00233                 }
00234                 <span class="keywordflow">else</span> {
00235                     UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte - 1);
00236                 }
00237 
00238                 <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageDirectoryHandle) == 0) &amp;&amp;
00239                     (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0)) {
00240 
00241                         TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPpe);
00242                         <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPpe,
00243                                      TempVa,
00244                                      AddressSpaceDeletion,
00245                                      CurrentProcess,
00246                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00247                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00248                 }
00249             }
00250 
00251             <span class="comment">//</span>
00252             <span class="comment">// Release the PFN lock.  This prevents a single thread</span>
00253             <span class="comment">// from forcing other high priority threads from being</span>
00254             <span class="comment">// blocked while a large address range is deleted.  There</span>
00255             <span class="comment">// is nothing magic about the instructions within the</span>
00256             <span class="comment">// lock and unlock.</span>
00257             <span class="comment">//</span>
00258 
00259             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00260             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (Va);
00261             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (Va);
00262             Skipped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00263             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00264 
00265             <span class="keywordflow">do</span> {
00266                 <span class="keywordflow">while</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00267                                                    CurrentProcess,
00268                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00269                                                    &amp;Waited)       ==  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00270 
00271                     <span class="comment">//</span>
00272                     <span class="comment">// This page directory parent entry is empty,</span>
00273                     <span class="comment">// go to the next one.</span>
00274                     <span class="comment">//</span>
00275 
00276                     Skipped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00277                     PointerPpe += 1;
00278                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00279                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00280                     Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00281 
00282                     <span class="keywordflow">if</span> (Va &gt; EndingAddress) {
00283 
00284                         <span class="comment">//</span>
00285                         <span class="comment">// All done, return.</span>
00286                         <span class="comment">//</span>
00287 
00288                         <span class="keywordflow">return</span>;
00289                     }
00290                 }
00291 
00292                 Waited = 0;
00293 
00294                 <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00295                                                    CurrentProcess,
00296                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00297                                                    &amp;Waited)       ==  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00298 
00299                     <span class="comment">//</span>
00300                     <span class="comment">// This page directory entry is empty, go to the next one.</span>
00301                     <span class="comment">//</span>
00302 
00303                     Skipped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00304                     PointerPde += 1;
00305                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00306                     Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00307 
00308                     <span class="keywordflow">if</span> (Va &gt; EndingAddress) {
00309 
00310                         <span class="comment">//</span>
00311                         <span class="comment">// All done, remove any straggling page directories and</span>
00312                         <span class="comment">// return.</span>
00313                         <span class="comment">//</span>
00314 
00315 <span class="preprocessor">#if defined (_WIN64)</span>
00316 <span class="preprocessor"></span>
00317                         PointerPde -= 1;
00318                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00319                         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00320 
00321                         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageDirectoryHandle) == 0) &amp;&amp;
00322                             (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0)) {
00323 
00324                                 TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPpe);
00325                                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPpe,
00326                                              TempVa,
00327                                              AddressSpaceDeletion,
00328                                              CurrentProcess,
00329                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00330                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00331                         }
00332 <span class="preprocessor">#endif</span>
00333 <span class="preprocessor"></span>
00334                         <span class="keywordflow">return</span>;
00335                     }
00336 
00337 <span class="preprocessor">#if defined (_WIN64)</span>
00338 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
00339                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00340                         Waited = 1;
00341                         <span class="keywordflow">break</span>;
00342                     }
00343 <span class="preprocessor">#endif</span>
00344 <span class="preprocessor"></span>
00345 <span class="preprocessor">#if DBG</span>
00346 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> ((LastProtoPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  &amp;&amp;
00347                         (Vad-&gt;u2.VadFlags2.ExtendableFile == 0)) {
00348                         ProtoPte2 = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a>(Vad, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (Va));
00349                         Subsection = <a class="code" href="../../d4/d8/mi_8h.html#a909">MiLocateSubsection</a> (Vad,<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (Va));
00350                         LastProtoPte2 = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
00351                         <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.ImageMap != 1) {
00352                             <span class="keywordflow">if</span> ((ProtoPte2 &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>) ||
00353                                 (ProtoPte2 &gt;= LastProtoPte2)) {
00354                                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"bad proto pte %p va %p Vad %p sub %p\n"</span>,
00355                                     ProtoPte2,Va,Vad,Subsection);
00356                                 DbgBreakPoint();
00357                             }
00358                         }
00359                     }
00360 <span class="preprocessor">#endif //DBG</span>
00361 <span class="preprocessor"></span>                }
00362 
00363             } <span class="keywordflow">while</span> (Waited != 0);
00364 
00365             <span class="comment">//</span>
00366             <span class="comment">// The PPE and PDE are now valid, get the page table use count.</span>
00367             <span class="comment">//</span>
00368 
00369             UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (Va);
00370 
00371             <span class="comment">//</span>
00372             <span class="comment">// If we skipped chunks of address space, the prototype PTE pointer</span>
00373             <span class="comment">// must be updated now so VADs that span multiple subsections</span>
00374             <span class="comment">// are handled properly.</span>
00375             <span class="comment">//</span>
00376 
00377             <span class="keywordflow">if</span> ((Skipped == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (LastProtoPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00378 
00379                 ProtoPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a>(Vad, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(Va));
00380                 Subsection = <a class="code" href="../../d4/d8/mi_8h.html#a909">MiLocateSubsection</a> (Vad, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(Va));
00381 
00382                 <span class="keywordflow">if</span> (Subsection != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00383                     LastProtoPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
00384 <span class="preprocessor">#if DBG</span>
00385 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.ImageMap != 1) {
00386                         <span class="keywordflow">if</span> ((ProtoPte &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>) ||
00387                             (ProtoPte &gt;= LastProtoPte)) {
00388                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"bad proto pte %p va %p Vad %p sub %p\n"</span>,
00389                                         ProtoPte,Va,Vad,Subsection);
00390                             DbgBreakPoint();
00391                         }
00392                     }
00393 <span class="preprocessor">#endif //DBG</span>
00394 <span class="preprocessor"></span>                }
00395                 <span class="keywordflow">else</span> {
00396 
00397                     <span class="comment">//</span>
00398                     <span class="comment">// The Vad span is larger than the section being mapped.</span>
00399                     <span class="comment">// Null the proto PTE local as no more proto PTEs will</span>
00400                     <span class="comment">// need to be deleted at this point.</span>
00401                     <span class="comment">//</span>
00402 
00403                     LastProtoPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00404                 }
00405             }
00406         }
00407 
00408         <span class="comment">//</span>
00409         <span class="comment">// The PPE and PDE are now valid, delete the PTEs.</span>
00410         <span class="comment">//</span>
00411 
00412         <span class="keywordflow">if</span> (PointerPte-&gt;u.Long != 0) {
00413 
00414             <span class="comment">//</span>
00415             <span class="comment">// One less used page table entry in this page table page.</span>
00416             <span class="comment">//</span>
00417 
00418             <a class="code" href="../../d4/d8/mi_8h.html#a183">MI_DECREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
00419 
00420             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a171">IS_PTE_NOT_DEMAND_ZERO</a> (*PointerPte)) {
00421 
00422                 <span class="keywordflow">if</span> (LastProtoPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00423                     <span class="keywordflow">if</span> (ProtoPte &gt;= LastProtoPte) {
00424                         ProtoPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a>(Vad, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(Va));
00425                         Subsection = <a class="code" href="../../d4/d8/mi_8h.html#a909">MiLocateSubsection</a> (Vad, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(Va));
00426                         LastProtoPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
00427                     }
00428 <span class="preprocessor">#if DBG</span>
00429 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.ImageMap != 1) {
00430                         <span class="keywordflow">if</span> ((ProtoPte &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>) ||
00431                             (ProtoPte &gt;= LastProtoPte)) {
00432                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"bad proto pte %p va %p Vad %p sub %p\n"</span>,
00433                                         ProtoPte,Va,Vad,Subsection);
00434                             DbgBreakPoint();
00435                         }
00436                     }
00437 <span class="preprocessor">#endif //DBG</span>
00438 <span class="preprocessor"></span>                }
00439 
00440                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPte,
00441                              (PVOID)Va,
00442                              AddressSpaceDeletion,
00443                              CurrentProcess,
00444                              ProtoPte,
00445                              &amp;FlushList);
00446             } <span class="keywordflow">else</span> {
00447                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
00448             }
00449         }
00450 
00451         Va += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00452         PointerPte += 1;
00453         ProtoPte += 1;
00454     }
00455 
00456     <span class="comment">//</span>
00457     <span class="comment">// Flush out entries for the last page table page.</span>
00458     <span class="comment">//</span>
00459 
00460     <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;FlushList, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
00461 
00462     <span class="comment">//</span>
00463     <span class="comment">// If all the entries have been eliminated from the previous</span>
00464     <span class="comment">// page table page, delete the page table page itself.</span>
00465     <span class="comment">//</span>
00466 
00467     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageTableHandle) == 0) &amp;&amp;
00468         (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0)) {
00469 
00470         TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPde);
00471         <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPde,
00472                      TempVa,
00473                      AddressSpaceDeletion,
00474                      CurrentProcess,
00475                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00476                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00477 
00478 <span class="preprocessor">#if defined (_WIN64)</span>
00479 <span class="preprocessor"></span>        UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte - 1);
00480 
00481         <a class="code" href="../../d4/d8/mi_8h.html#a183">MI_DECREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00482 
00483         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageDirectoryHandle) == 0) &amp;&amp;
00484             (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0)) {
00485 
00486             TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPpe);
00487             <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPpe,
00488                          TempVa,
00489                          AddressSpaceDeletion,
00490                          CurrentProcess,
00491                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00492                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00493         }
00494 <span class="preprocessor">#endif</span>
00495 <span class="preprocessor"></span>    }
00496 
00497     <span class="comment">//</span>
00498     <span class="comment">// All done, return.</span>
00499     <span class="comment">//</span>
00500 
00501     <span class="keywordflow">return</span>;
00502 }
00503 
00504 
00505 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00506"></a><a class="code" href="../../d4/d8/mi_8h.html#a886">00506</a> <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (
00507     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
00508     IN PVOID VirtualAddress,
00509     IN ULONG AddressSpaceDeletion,
00510     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess,
00511     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PrototypePte,
00512     IN <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">PMMPTE_FLUSH_LIST</a> PteFlushList OPTIONAL
00513     )
00514 
00515 <span class="comment">/*++</span>
00516 <span class="comment"></span>
00517 <span class="comment">Routine Description:</span>
00518 <span class="comment"></span>
00519 <span class="comment">    This routine deletes the contents of the specified PTE.  The PTE</span>
00520 <span class="comment">    can be in one of the following states:</span>
00521 <span class="comment"></span>
00522 <span class="comment">        - active and valid</span>
00523 <span class="comment">        - transition</span>
00524 <span class="comment">        - in paging file</span>
00525 <span class="comment">        - in prototype PTE format</span>
00526 <span class="comment"></span>
00527 <span class="comment">Arguments:</span>
00528 <span class="comment"></span>
00529 <span class="comment">    PointerPte - Supplies a pointer to the PTE to delete.</span>
00530 <span class="comment"></span>
00531 <span class="comment">    VirtualAddress - Supplies the virtual address which corresponds to</span>
00532 <span class="comment">                     the PTE.  This is used to locate the working set entry</span>
00533 <span class="comment">                     to eliminate it.</span>
00534 <span class="comment"></span>
00535 <span class="comment">    AddressSpaceDeletion - Supplies TRUE if the address space is being</span>
00536 <span class="comment">                           deleted, FALSE otherwise.  If TRUE is specified</span>
00537 <span class="comment">                           the TB is not flushed and valid addresses are</span>
00538 <span class="comment">                           not removed from the working set.</span>
00539 <span class="comment"></span>
00540 <span class="comment"></span>
00541 <span class="comment">    CurrentProcess - Supplies a pointer to the current process.</span>
00542 <span class="comment"></span>
00543 <span class="comment">    PrototypePte - Supplies a pointer to the prototype PTE which currently</span>
00544 <span class="comment">                   or originally mapped this page.  This is used to determine</span>
00545 <span class="comment">                   if the PTE is a fork PTE and should have its reference block</span>
00546 <span class="comment">                   decremented.</span>
00547 <span class="comment"></span>
00548 <span class="comment">Return Value:</span>
00549 <span class="comment"></span>
00550 <span class="comment">    None.</span>
00551 <span class="comment"></span>
00552 <span class="comment">Environment:</span>
00553 <span class="comment"></span>
00554 <span class="comment">    Kernel mode, APCs disabled, PFN lock and working set mutex held.</span>
00555 <span class="comment"></span>
00556 <span class="comment">--*/</span>
00557 
00558 {
00559     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00560     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00561     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00562     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00563     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00564     ULONG WorkingSetIndex;
00565     ULONG Entry;
00566     PVOID SwapVa;
00567     <a class="code" href="../../d4/d8/struct__MMWSLENTRY.html">MMWSLENTRY</a> Locked;
00568     ULONG WsPfnIndex;
00569     <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a> CloneBlock;
00570     <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a> CloneDescriptor;
00571     ULONG Waited;
00572 
00573     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00574 
00575 <span class="preprocessor">#if DBG</span>
00576 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a57">MM_DBG_PTE_UPDATE</a>) {
00577         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"deleting PTE\n"</span>);
00578         <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
00579     }
00580 <span class="preprocessor">#endif //DBG</span>
00581 <span class="preprocessor"></span>
00582     PteContents = *PointerPte;
00583 
00584     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00585 
00586 <span class="preprocessor">#ifdef _X86_</span>
00587 <span class="preprocessor"></span><span class="preprocessor">#if DBG</span>
00588 <span class="preprocessor"></span><span class="preprocessor">#if !defined(NT_UP)</span>
00589 <span class="preprocessor"></span>
00590         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Writable == 1) {
00591             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Dirty == 1);
00592         }
00593         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Accessed == 1);
00594 <span class="preprocessor">#endif //NTUP</span>
00595 <span class="preprocessor"></span><span class="preprocessor">#endif //DBG</span>
00596 <span class="preprocessor"></span><span class="preprocessor">#endif //X86</span>
00597 <span class="preprocessor"></span>
00598         <span class="comment">//</span>
00599         <span class="comment">// PTE is valid.  Check PFN database to see if this is a prototype PTE.</span>
00600         <span class="comment">//</span>
00601 
00602         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00603         WsPfnIndex = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex;
00604 
00605 <span class="preprocessor">#if DBG</span>
00606 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a57">MM_DBG_PTE_UPDATE</a>) {
00607             <a class="code" href="../../d4/d8/mi_8h.html#a971">MiFormatPfn</a>(Pfn1);
00608         }
00609 <span class="preprocessor">#endif //DBG</span>
00610 <span class="preprocessor"></span>
00611         CloneDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00612 
00613         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1) {
00614 
00615             CloneBlock = (<a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a>)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
00616 
00617             <span class="comment">//</span>
00618             <span class="comment">// Capture the state of the modified bit for this PTE.</span>
00619             <span class="comment">//</span>
00620 
00621             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (PointerPte, Pfn1);
00622 
00623             <span class="comment">//</span>
00624             <span class="comment">// Decrement the share and valid counts of the page table</span>
00625             <span class="comment">// page which maps this PTE.</span>
00626             <span class="comment">//</span>
00627 
00628             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00629             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00630 <span class="preprocessor">#if !defined (_WIN64)</span>
00631 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d8/mi_8h.html#a836">MiCheckPdeForPagedPool</a> (PointerPte))) {
00632 <span class="preprocessor">#endif</span>
00633 <span class="preprocessor"></span>                    <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
00634                                   0x61940, 
00635                                   (ULONG_PTR)PointerPte,
00636                                   (ULONG_PTR)PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00637                                   (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
00638 <span class="preprocessor">#if !defined (_WIN64)</span>
00639 <span class="preprocessor"></span>                }
00640 <span class="preprocessor">#endif</span>
00641 <span class="preprocessor"></span>            }
00642             <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPde));
00643 
00644             <span class="comment">//</span>
00645             <span class="comment">// Decrement the share count for the physical page.</span>
00646             <span class="comment">//</span>
00647 
00648             <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PteContents));
00649 
00650             <span class="comment">//</span>
00651             <span class="comment">// Check to see if this is a fork prototype PTE and if so</span>
00652             <span class="comment">// update the clone descriptor address.</span>
00653             <span class="comment">//</span>
00654 
00655             <span class="keywordflow">if</span> (PointerPte &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a755">MiHighestUserPte</a>) {
00656 
00657                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a> != Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>) {
00658 
00659                     <span class="comment">//</span>
00660                     <span class="comment">// Locate the clone descriptor within the clone tree.</span>
00661                     <span class="comment">//</span>
00662 
00663                     CloneDescriptor = <a class="code" href="../../d4/d8/mi_8h.html#a104">MiLocateCloneAddress</a> ((PVOID)CloneBlock);
00664 
00665 <span class="preprocessor">#if DBG</span>
00666 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (CloneDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00667                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"1PrototypePte %p Clone desc %p pfn pte addr %p\n"</span>,
00668                         <a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>, CloneDescriptor, Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
00669                         <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
00670                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00671                     }
00672 <span class="preprocessor">#endif // DBG</span>
00673 <span class="preprocessor"></span>
00674                 }
00675             }
00676         } <span class="keywordflow">else</span> {
00677 
00678             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
00679 
00680             <span class="comment">//</span>
00681             <span class="comment">// This PTE is a NOT a prototype PTE, delete the physical page.</span>
00682             <span class="comment">//</span>
00683 
00684             <span class="comment">//</span>
00685             <span class="comment">// Decrement the share and valid counts of the page table</span>
00686             <span class="comment">// page which maps this PTE.</span>
00687             <span class="comment">//</span>
00688 
00689             <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00690 
00691             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00692 
00693             <span class="comment">//</span>
00694             <span class="comment">// Decrement the share count for the physical page.  As the page</span>
00695             <span class="comment">// is private it will be put on the free list.</span>
00696             <span class="comment">//</span>
00697 
00698             <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PteContents));
00699 
00700             <span class="comment">//</span>
00701             <span class="comment">// Decrement the count for the number of private pages.</span>
00702             <span class="comment">//</span>
00703 
00704             CurrentProcess-&gt;NumberOfPrivatePages -= 1;
00705         }
00706 
00707         <span class="comment">//</span>
00708         <span class="comment">// Find the WSLE for this page and eliminate it.</span>
00709         <span class="comment">//</span>
00710 
00711         <span class="comment">//</span>
00712         <span class="comment">// If we are deleting the system portion of the address space, do</span>
00713         <span class="comment">// not remove WSLEs or flush translation buffers as there can be</span>
00714         <span class="comment">// no other usage of this address space.</span>
00715         <span class="comment">//</span>
00716 
00717         <span class="keywordflow">if</span> (AddressSpaceDeletion == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00718 
00719             WorkingSetIndex = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (VirtualAddress,
00720                                             <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>,
00721                                             WsPfnIndex );
00722 
00723             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex != <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>);
00724 
00725             <span class="comment">//</span>
00726             <span class="comment">// Check to see if this entry is locked in the working set</span>
00727             <span class="comment">// or locked in memory.</span>
00728             <span class="comment">//</span>
00729 
00730             Locked = <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1;
00731 
00732             <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (WorkingSetIndex, <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>);
00733 
00734             <span class="comment">//</span>
00735             <span class="comment">// Add this entry to the list of free working set entries</span>
00736             <span class="comment">// and adjust the working set count.</span>
00737             <span class="comment">//</span>
00738 
00739             <a class="code" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> (WorkingSetIndex, &amp;CurrentProcess-&gt;Vm);
00740 
00741             <span class="keywordflow">if</span> ((Locked.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o1">LockedInWs</a> == 1) || (Locked.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o2">LockedInMemory</a> == 1)) {
00742 
00743                 <span class="comment">//</span>
00744                 <span class="comment">// This entry is locked.</span>
00745                 <span class="comment">//</span>
00746 
00747                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &lt; MmWorkingSetList-&gt;FirstDynamic);
00748                 <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> -= 1;
00749 
00750                 <span class="keywordflow">if</span> (WorkingSetIndex != <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
00751 
00752                     Entry = <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
00753                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[Entry].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o2">e1</a>.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o0">Valid</a>);
00754                     SwapVa = <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress;
00755                     SwapVa = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (SwapVa);
00756                     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (
00757                               <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (SwapVa)-&gt;u.Hard.PageFrameNumber);
00758 <span class="preprocessor">#if 0</span>
00759 <span class="preprocessor"></span>                    Entry = MiLocateWsleAndParent (SwapVa,
00760                                                    &amp;Parent,
00761                                                    <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>,
00762                                                    Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
00763 
00764                     <span class="comment">//</span>
00765                     <span class="comment">// Swap the removed entry with the last locked entry</span>
00766                     <span class="comment">// which is located at first dynamic.</span>
00767                     <span class="comment">//</span>
00768 
00769                     <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry,
00770                                       Parent,
00771                                       WorkingSetIndex,
00772                                       <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>);
00773 <span class="preprocessor">#endif //0</span>
00774 <span class="preprocessor"></span>
00775                     <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry,
00776                                       WorkingSetIndex,
00777                                       &amp;CurrentProcess-&gt;Vm);
00778                 }
00779             } <span class="keywordflow">else</span> {
00780                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
00781             }
00782 
00783             <span class="comment">//</span>
00784             <span class="comment">// Flush the entry out of the TB.</span>
00785             <span class="comment">//</span>
00786 
00787             <span class="keywordflow">if</span> (!ARGUMENT_PRESENT (PteFlushList)) {
00788                 <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (VirtualAddress,
00789                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00790                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00791                                  (PHARDWARE_PTE)PointerPte,
00792                                  <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
00793             } <span class="keywordflow">else</span> {
00794                 <span class="keywordflow">if</span> (PteFlushList-&gt;Count != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
00795                     PteFlushList-&gt;FlushPte[PteFlushList-&gt;Count] = PointerPte;
00796                     PteFlushList-&gt;FlushVa[PteFlushList-&gt;Count] = VirtualAddress;
00797                     PteFlushList-&gt;Count += 1;
00798                 }
00799                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
00800             }
00801 
00802             <span class="keywordflow">if</span> (CloneDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00803 
00804                 <span class="comment">//</span>
00805                 <span class="comment">// Flush PTEs as this could release the PFN_LOCK.</span>
00806                 <span class="comment">//</span>
00807 
00808                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT (PteFlushList)) {
00809                     <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (PteFlushList, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
00810                 }
00811 
00812                 <span class="comment">//</span>
00813                 <span class="comment">// Decrement the reference count for the clone block,</span>
00814                 <span class="comment">// note that this could release and reacquire</span>
00815                 <span class="comment">// the mutexes hence cannot be done until after the</span>
00816                 <span class="comment">// working set index has been removed.</span>
00817                 <span class="comment">//</span>
00818 
00819                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a854">MiDecrementCloneBlockReference</a> ( CloneDescriptor,
00820                                                      CloneBlock,
00821                                                      CurrentProcess )) {
00822 
00823                     <span class="comment">//</span>
00824                     <span class="comment">// The working set mutex was released.  This may</span>
00825                     <span class="comment">// have removed the current page directory &amp; table page.</span>
00826                     <span class="comment">//</span>
00827 
00828                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00829 
00830                     <span class="keywordflow">do</span> {
00831 
00832                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00833                                                     CurrentProcess,
00834                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00835                                                     &amp;Waited);
00836 
00837                         Waited = 0;
00838 
00839                         <span class="comment">//</span>
00840                         <span class="comment">// If the call below results in a PFN release and</span>
00841                         <span class="comment">// reacquire, then we must redo them both.</span>
00842                         <span class="comment">//</span>
00843 
00844                         <a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00845                                                     CurrentProcess,
00846                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00847                                                     &amp;Waited);
00848 
00849                     } <span class="keywordflow">while</span> (Waited != 0);
00850                 }
00851             }
00852         }
00853 
00854     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
00855 
00856         <span class="comment">//</span>
00857         <span class="comment">// This is a prototype PTE, if it is a fork PTE clean up the</span>
00858         <span class="comment">// fork structures.</span>
00859         <span class="comment">//</span>
00860 
00861         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) {
00862 
00863             <span class="comment">//</span>
00864             <span class="comment">// Check to see if the prototype PTE is a fork prototype PTE.</span>
00865             <span class="comment">//</span>
00866 
00867             <span class="keywordflow">if</span> (PointerPte &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a755">MiHighestUserPte</a>) {
00868 
00869                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (PointerPte)) {
00870 
00871                     CloneBlock = (<a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (PointerPte);
00872                     CloneDescriptor = <a class="code" href="../../d4/d8/mi_8h.html#a104">MiLocateCloneAddress</a> ((PVOID)CloneBlock);
00873 
00874 
00875 <span class="preprocessor">#if DBG</span>
00876 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (CloneDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00877                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"1PrototypePte %p Clone desc %p \n"</span>,
00878                             <a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>, CloneDescriptor);
00879                         <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
00880                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00881                     }
00882 <span class="preprocessor">#endif //DBG</span>
00883 <span class="preprocessor"></span>
00884                     <span class="comment">//</span>
00885                     <span class="comment">// Decrement the reference count for the clone block,</span>
00886                     <span class="comment">// note that this could release and reacquire</span>
00887                     <span class="comment">// the mutexes.</span>
00888                     <span class="comment">//</span>
00889 
00890                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
00891 
00892                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT (PteFlushList)) {
00893                         <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (PteFlushList, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
00894                     }
00895 
00896                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a854">MiDecrementCloneBlockReference</a> ( CloneDescriptor,
00897                                                          CloneBlock,
00898                                                          CurrentProcess )) {
00899 
00900                         <span class="comment">//</span>
00901                         <span class="comment">// The working set mutex was released.  This may</span>
00902                         <span class="comment">// have removed the current page directory &amp; table page.</span>
00903                         <span class="comment">//</span>
00904 
00905                         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00906                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00907 
00908                         <span class="comment">//</span>
00909                         <span class="comment">// If either call below results in a PFN release and</span>
00910                         <span class="comment">// reacquire, then we must redo them both.</span>
00911                         <span class="comment">//</span>
00912 
00913                         <span class="keywordflow">do</span> {
00914 
00915                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00916                                                         CurrentProcess,
00917                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00918                                                         &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00919 
00920                                 <span class="comment">//</span>
00921                                 <span class="comment">// The PPE has been deleted when the PFN lock</span>
00922                                 <span class="comment">// was released.  Just bail as the PDE/PTE are</span>
00923                                 <span class="comment">// gone now anyway.</span>
00924                                 <span class="comment">//</span>
00925 
00926                                 <span class="keywordflow">return</span>;
00927                             }
00928 
00929                             Waited = 0;
00930 
00931                             <span class="comment">//</span>
00932                             <span class="comment">// If the call below results in a PFN release and</span>
00933                             <span class="comment">// reacquire, then we must redo them both.  If the</span>
00934                             <span class="comment">// PDE was deleted when the PFN lock was released</span>
00935                             <span class="comment">// then we just bail as the PTE is gone anyway.</span>
00936                             <span class="comment">//</span>
00937 
00938                             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00939                                                         CurrentProcess,
00940                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00941                                                         &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00942                                 <span class="keywordflow">return</span>;
00943                             }
00944 
00945                         } <span class="keywordflow">while</span> (Waited != 0);
00946                     }
00947                 }
00948             }
00949         }
00950 
00951     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
00952 
00953         <span class="comment">//</span>
00954         <span class="comment">// This is a transition PTE. (Page is private)</span>
00955         <span class="comment">//</span>
00956 
00957         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
00958 
00959         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00960 
00961         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00962 
00963         <span class="comment">//</span>
00964         <span class="comment">// Check the reference count for the page, if the reference</span>
00965         <span class="comment">// count is zero, move the page to the free list, if the reference</span>
00966         <span class="comment">// count is not zero, ignore this page.  When the reference count</span>
00967         <span class="comment">// goes to zero, it will be placed on the free list.</span>
00968         <span class="comment">//</span>
00969 
00970         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
00971             <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
00972             <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00973             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
00974                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>(&amp;PteContents));
00975         }
00976 
00977         <span class="comment">//</span>
00978         <span class="comment">// Decrement the count for the number of private pages.</span>
00979         <span class="comment">//</span>
00980 
00981         CurrentProcess-&gt;NumberOfPrivatePages -= 1;
00982 
00983     } <span class="keywordflow">else</span> {
00984 
00985         <span class="comment">//</span>
00986         <span class="comment">// Must be page file space.</span>
00987         <span class="comment">//</span>
00988 
00989         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) {
00990 
00991             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (*PointerPte)) {
00992 
00993                 <span class="comment">//</span>
00994                 <span class="comment">// Decrement the count for the number of private pages.</span>
00995                 <span class="comment">//</span>
00996 
00997                 CurrentProcess-&gt;NumberOfPrivatePages -= 1;
00998             }
00999         }
01000     }
01001 
01002     <span class="comment">//</span>
01003     <span class="comment">// Zero the PTE contents.</span>
01004     <span class="comment">//</span>
01005 
01006     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
01007 
01008     <span class="keywordflow">return</span>;
01009 }
01010 
01011 
01012 ULONG
01013 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l01014"></a><a class="code" href="../../d4/d8/mi_8h.html#a889">01014</a> <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (
01015     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents
01016     )
01017 
01018 <span class="comment">/*++</span>
01019 <span class="comment"></span>
01020 <span class="comment">Routine Description:</span>
01021 <span class="comment"></span>
01022 <span class="comment">    This routine frees the paging file allocated to the specified PTE</span>
01023 <span class="comment">    and adjusts the necessary quotas.</span>
01024 <span class="comment"></span>
01025 <span class="comment">Arguments:</span>
01026 <span class="comment"></span>
01027 <span class="comment">    PteContents - Supplies the PTE which is in page file format.</span>
01028 <span class="comment"></span>
01029 <span class="comment">Return Value:</span>
01030 <span class="comment"></span>
01031 <span class="comment">    Returns TRUE if any paging file space was deallocated.</span>
01032 <span class="comment"></span>
01033 <span class="comment">Environment:</span>
01034 <span class="comment"></span>
01035 <span class="comment">    Kernel mode, APCs disabled, PFN lock held.</span>
01036 <span class="comment"></span>
01037 <span class="comment">--*/</span>
01038 
01039 {
01040     ULONG FreeBit;
01041     ULONG PageFileNumber;
01042 
01043     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01044 
01045     <span class="keywordflow">if</span> (PteContents.u.Soft.Prototype == 1) {
01046 
01047         <span class="comment">//</span>
01048         <span class="comment">// Not in page file format.</span>
01049         <span class="comment">//</span>
01050 
01051         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01052     }
01053 
01054     FreeBit = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a170">GET_PAGING_FILE_OFFSET</a> (PteContents);
01055 
01056     <span class="keywordflow">if</span> ((FreeBit == 0) || (FreeBit == 0xFFFFF)) {
01057 
01058         <span class="comment">//</span>
01059         <span class="comment">// Page is not in a paging file, just return.</span>
01060         <span class="comment">//</span>
01061 
01062         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01063     }
01064 
01065     PageFileNumber = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a169">GET_PAGING_FILE_NUMBER</a> (PteContents);
01066 
01067     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RtlCheckBit( <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;Bitmap, FreeBit) == 1);
01068 
01069 <span class="preprocessor">#if DBG</span>
01070 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((FreeBit &lt; 8192) &amp;&amp; (PageFileNumber == 0)) {
01071         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[FreeBit] &amp; 1) != 0);
01072         <a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[FreeBit] ^= 1;
01073     }
01074 <span class="preprocessor">#endif //DBG</span>
01075 <span class="preprocessor"></span>
01076     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> ( <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;Bitmap, FreeBit, 1);
01077 
01078     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> += 1;
01079     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a> -= 1;
01080 
01081     <span class="comment">//</span>
01082     <span class="comment">// Check to see if we should move some MDL entries for the</span>
01083     <span class="comment">// modified page writer now that more free space is available.</span>
01084     <span class="comment">//</span>
01085 
01086     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> == 0) ||
01087         (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> == <a class="code" href="../../d4/d8/mi_8h.html#a17">MM_USABLE_PAGES_FREE</a>)) {
01088 
01089         <a class="code" href="../../d4/d8/mi_8h.html#a890">MiUpdateModifiedWriterMdls</a> (PageFileNumber);
01090     }
01091 
01092     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01093 }
01094 
01095 
01096 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01097 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l01098"></a><a class="code" href="../../d4/d8/mi_8h.html#a890">01098</a> <a class="code" href="../../d4/d8/mi_8h.html#a890">MiUpdateModifiedWriterMdls</a> (
01099     IN ULONG PageFileNumber
01100     )
01101 
01102 <span class="comment">/*++</span>
01103 <span class="comment"></span>
01104 <span class="comment">Routine Description:</span>
01105 <span class="comment"></span>
01106 <span class="comment">    This routine ensures the MDLs for the specified paging file</span>
01107 <span class="comment">    are in the proper state such that paging i/o can continue.</span>
01108 <span class="comment"></span>
01109 <span class="comment">Arguments:</span>
01110 <span class="comment"></span>
01111 <span class="comment">    PageFileNumber - Supplies the page file number to check the MDLs for.</span>
01112 <span class="comment"></span>
01113 <span class="comment">Return Value:</span>
01114 <span class="comment"></span>
01115 <span class="comment">    None.</span>
01116 <span class="comment"></span>
01117 <span class="comment">Environment:</span>
01118 <span class="comment"></span>
01119 <span class="comment">    Kernel mode, PFN lock held.</span>
01120 <span class="comment"></span>
01121 <span class="comment">--*/</span>
01122 
01123 {
01124     ULONG i;
01125     <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a> WriterEntry;
01126 
01127     <span class="comment">//</span>
01128     <span class="comment">// Put the MDL entries into the active list.</span>
01129     <span class="comment">//</span>
01130 
01131     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d8/mi_8h.html#a236">MM_PAGING_FILE_MDLS</a>; i += 1) {
01132 
01133         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[i]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>.Flink !=
01134                                                     <a class="code" href="../../d4/d8/mi_8h.html#a23">MM_IO_IN_PROGRESS</a>)
01135                           &amp;&amp;
01136             (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[i]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> ==
01137                     &amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>)) {
01138 
01139             <span class="comment">//</span>
01140             <span class="comment">// Remove this entry and put it on the active list.</span>
01141             <span class="comment">//</span>
01142 
01143             WriterEntry = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[i];
01144             RemoveEntryList (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
01145             WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>;
01146 
01147             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01148 
01149             InsertTailList (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>,
01150                             &amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
01151             <a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> += 1;
01152         }
01153     }
01154 
01155     <span class="keywordflow">return</span>;
01156 }
01157 
01158 
01159 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01160"></a><a class="code" href="../../d4/d8/mi_8h.html#a888">01160</a> <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (
01161     IN <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">PMMPTE_FLUSH_LIST</a> PteFlushList,
01162     IN ULONG AllProcessors,
01163     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> FillPte
01164     )
01165 
01166 <span class="comment">/*++</span>
01167 <span class="comment"></span>
01168 <span class="comment">Routine Description:</span>
01169 <span class="comment"></span>
01170 <span class="comment">    This routine flushes all the PTEs in the PTE flush list.</span>
01171 <span class="comment">    If the list has overflowed, the entire TB is flushed.</span>
01172 <span class="comment"></span>
01173 <span class="comment">Arguments:</span>
01174 <span class="comment"></span>
01175 <span class="comment">    PteFlushList - Supplies an optional pointer to the list to be flushed.</span>
01176 <span class="comment"></span>
01177 <span class="comment">    AllProcessors - Supplies TRUE if the flush occurs on all processors.</span>
01178 <span class="comment"></span>
01179 <span class="comment">    FillPte - Supplies the PTE to fill with.</span>
01180 <span class="comment"></span>
01181 <span class="comment">Return Value:</span>
01182 <span class="comment"></span>
01183 <span class="comment">    None.</span>
01184 <span class="comment"></span>
01185 <span class="comment">Environment:</span>
01186 <span class="comment"></span>
01187 <span class="comment">    Kernel mode, PFN lock held.</span>
01188 <span class="comment"></span>
01189 <span class="comment">--*/</span>
01190 
01191 {
01192     ULONG count;
01193 
01194     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ARGUMENT_PRESENT (PteFlushList));
01195     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a> ();
01196 
01197     count = PteFlushList-&gt;Count;
01198 
01199     <span class="keywordflow">if</span> (count != 0) {
01200         <span class="keywordflow">if</span> (count != 1) {
01201             <span class="keywordflow">if</span> (count &lt; <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01202                 <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a1">KeFlushMultipleTb</a> (count,
01203                                    &amp;PteFlushList-&gt;FlushVa[0],
01204                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01205                                    (BOOLEAN)AllProcessors,
01206                                    &amp;((PHARDWARE_PTE)PteFlushList-&gt;FlushPte[0]),
01207                                    FillPte.u.Flush);
01208             } <span class="keywordflow">else</span> {
01209 
01210                 <span class="comment">//</span>
01211                 <span class="comment">// Array has overflowed, flush the entire TB.</span>
01212                 <span class="comment">//</span>
01213 
01214                 <span class="keywordflow">if</span> (AllProcessors == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01215                     <a class="code" href="../../d4/d8/mi_8h.html#a119">MiLockSystemSpaceAtDpcLevel</a>();
01216                     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01217                     <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> = (<a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> + 1) &amp; <a class="code" href="../../d4/d8/mi_8h.html#a8">MM_FLUSH_COUNTER_MASK</a>;
01218                     <a class="code" href="../../d4/d8/mi_8h.html#a120">MiUnlockSystemSpaceFromDpcLevel</a>();
01219                 } <span class="keywordflow">else</span> {
01220                     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01221                 }
01222             }
01223         } <span class="keywordflow">else</span> {
01224             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (PteFlushList-&gt;FlushVa[0],
01225                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01226                              (BOOLEAN)AllProcessors,
01227                              (PHARDWARE_PTE)PteFlushList-&gt;FlushPte[0],
01228                              FillPte.u.Flush);
01229         }
01230         PteFlushList-&gt;Count = 0;
01231     }
01232     <span class="keywordflow">return</span>;
01233 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
