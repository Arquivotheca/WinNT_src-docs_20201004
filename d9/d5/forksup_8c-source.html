<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: forksup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>forksup.c</h1><a href="../../d8/d6/forksup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   forksup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which support the POSIX fork operation.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Lou Perazzoli (loup) 22-Jul-1989</span>
00016 <span class="comment">    Landy Wang (landyw) 02-June-1997</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00023 
00024 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00025 <a class="code" href="../../d8/d6/forksup_8c.html#a2">MiUpPfnReferenceCount</a> (
00026     IN PFN_NUMBER Page,
00027     IN USHORT Count
00028     );
00029 
00030 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00031 <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (
00032     IN PFN_NUMBER Page,
00033     IN USHORT Count
00034     );
00035 
00036 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00037 <a class="code" href="../../d8/d6/forksup_8c.html#a4">MiUpControlAreaRefs</a> (
00038     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea
00039     );
00040 
00041 ULONG
00042 <a class="code" href="../../d8/d6/forksup_8c.html#a5">MiDoneWithThisPageGetAnother</a> (
00043     IN PPFN_NUMBER PageFrameIndex,
00044     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde,
00045     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
00046     );
00047 
00048 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00049 <a class="code" href="../../d8/d6/forksup_8c.html#a6">MiUpForkPageShareCount</a>(
00050     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnForkPtePage
00051     );
00052 
00053 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00054 <a class="code" href="../../d8/d6/forksup_8c.html#a7">MiUpCloneProcessRefCount</a> (
00055     IN <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a> Clone
00056     );
00057 
00058 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00059 <a class="code" href="../../d8/d6/forksup_8c.html#a8">MiUpCloneProtoRefCount</a> (
00060     IN <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a> CloneProto,
00061     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
00062     );
00063 
00064 ULONG
00065 <a class="code" href="../../d8/d6/forksup_8c.html#a9">MiHandleForkTransitionPte</a> (
00066     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
00067     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerNewPte,
00068     IN <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a> ForkProtoPte
00069     );
00070 
00071 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00072 <a class="code" href="../../d8/d6/forksup_8c.html#a10">MiDownShareCountFlushEntireTb</a> (
00073     IN PFN_NUMBER PageFrameIndex
00074     );
00075 
00076 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00077 <a class="code" href="../../d8/d6/forksup_8c.html#a11">MiBuildForkPageTable</a>(
00078     IN PFN_NUMBER PageFrameIndex,
00079     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde,
00080     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerNewPde,
00081     IN PFN_NUMBER PdePhysicalPage,
00082     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnPdPage
00083     );
00084 
00085 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00086 <a class="code" href="../../d8/d6/forksup_8c.html#a12">MiRetrievePageDirectoryFrames</a>(
00087     IN PFN_NUMBER RootPhysicalPage,
00088     OUT PPFN_NUMBER PageDirectoryFrames
00089     );
00090 
<a name="l00091"></a><a class="code" href="../../d8/d6/forksup_8c.html#a0">00091</a> <span class="preprocessor">#define MM_FORK_SUCCEEDED 0</span>
<a name="l00092"></a><a class="code" href="../../d8/d6/forksup_8c.html#a1">00092</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_FORK_FAILED 1</span>
00093 <span class="preprocessor"></span>    
00094 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00095 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiCloneProcessAddressSpace)</span>
00096 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00097 <span class="preprocessor"></span>
00098 
00099 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00100"></a><a class="code" href="../../d4/d8/mi_8h.html#a853">00100</a> <a class="code" href="../../d4/d8/mi_8h.html#a853">MiCloneProcessAddressSpace</a> (
00101     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToClone,
00102     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToInitialize,
00103     IN PFN_NUMBER RootPhysicalPage,
00104     IN PFN_NUMBER HyperPhysicalPage
00105     )
00106 
00107 <span class="comment">/*++</span>
00108 <span class="comment"></span>
00109 <span class="comment">Routine Description:</span>
00110 <span class="comment"></span>
00111 <span class="comment">    This routine stands on its head to produce a copy of the specified</span>
00112 <span class="comment">    process's address space in the process to initialize.  This</span>
00113 <span class="comment">    is done by examining each virtual address descriptor's inherit</span>
00114 <span class="comment">    attributes.  If the pages described by the VAD should be inherited,</span>
00115 <span class="comment">    each PTE is examined and copied into the new address space.</span>
00116 <span class="comment"></span>
00117 <span class="comment">    For private pages, fork prototype PTEs are constructed and the pages</span>
00118 <span class="comment">    become shared, copy-on-write, between the two processes.</span>
00119 <span class="comment"></span>
00120 <span class="comment"></span>
00121 <span class="comment">Arguments:</span>
00122 <span class="comment"></span>
00123 <span class="comment">    ProcessToClone - Supplies the process whose address space should be</span>
00124 <span class="comment">                     cloned.</span>
00125 <span class="comment"></span>
00126 <span class="comment">    ProcessToInitialize - Supplies the process whose address space is to</span>
00127 <span class="comment">                          be created.</span>
00128 <span class="comment"></span>
00129 <span class="comment">    RootPhysicalPage - Supplies the physical page number of the top level</span>
00130 <span class="comment">                       page (parent on 64-bit systems) directory</span>
00131 <span class="comment">                       of the process to initialize.</span>
00132 <span class="comment"></span>
00133 <span class="comment">    HyperPhysicalPage - Supplies the physical page number of the page table</span>
00134 <span class="comment">                        page which maps hyperspace for the process to</span>
00135 <span class="comment">                        initialize.  This is only needed for 32-bit systems.</span>
00136 <span class="comment"></span>
00137 <span class="comment">Return Value:</span>
00138 <span class="comment"></span>
00139 <span class="comment">    None.</span>
00140 <span class="comment"></span>
00141 <span class="comment">Environment:</span>
00142 <span class="comment"></span>
00143 <span class="comment">    Kernel mode, APCs disabled.</span>
00144 <span class="comment"></span>
00145 <span class="comment">--*/</span>
00146 
00147 {
00148     PFN_NUMBER PpePhysicalPage;
00149     PFN_NUMBER PdePhysicalPage;
00150     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00151     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PdeBase;
00152     <a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html">PMMCLONE_HEADER</a> CloneHeader;
00153     <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a> CloneProtos;
00154     <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a> CloneDescriptor;
00155     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NewVad;
00156     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
00157     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NextVad;
00158     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> *VadList;
00159     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FirstNewVad;
00160     <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a> *CloneList;
00161     <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a> FirstNewClone;
00162     <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a> Clone;
00163     <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a> NextClone;
00164     <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a> NewClone;
00165     ULONG Attached;
00166     ULONG CloneFailed;
00167     ULONG VadInsertFailed;
00168     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
00169     PVOID VirtualAddress;
00170     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00171     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00172     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnPdPage;
00173     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00174     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00175 <span class="preprocessor">#if defined (_X86PAE_)</span>
00176 <span class="preprocessor"></span>    <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MdlPageDirectory;
00177     PPFN_NUMBER MdlPageFrames;
00178     PFN_NUMBER PageDirectoryFrames[PD_PER_SYSTEM];
00179     PFN_NUMBER MdlHackPageDirectory[(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)/<span class="keyword">sizeof</span>(PFN_NUMBER)) + PD_PER_SYSTEM];
00180 <span class="preprocessor">#endif</span>
00181 <span class="preprocessor"></span>    PFN_NUMBER MdlPage;
00182     PFN_NUMBER MdlDirPage;
00183     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00184     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00185     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00186     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00187     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerNewPte;
00188     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> NewPteMappedAddress;
00189     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerNewPde;
00190     PLIST_ENTRY NextEntry;
00191     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
00192     PFN_NUMBER PageFrameIndex;
00193     PFN_NUMBER PageDirFrameIndex;
00194     <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a> ForkProtoPte;
00195     <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a> CloneProto;
00196     <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a> LockedForkPte;
00197     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ContainingPte;
00198     ULONG NumberOfForkPtes;
00199     PFN_NUMBER NumberOfPrivatePages;
00200     PFN_NUMBER PageTablePage;
00201     SIZE_T TotalPagedPoolCharge;
00202     SIZE_T TotalNonPagedPoolCharge;
00203     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnForkPtePage;
00204     PVOID UsedPageTableEntries;
00205     ULONG ReleasedWorkingSetMutex;
00206     ULONG FirstTime;
00207     ULONG Waited;
00208     ULONG i;
00209     ULONG PpePdeOffset;
00210 <span class="preprocessor">#if defined (_WIN64)</span>
00211 <span class="preprocessor"></span>    PVOID UsedPageDirectoryEntries;
00212     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerNewPpe;
00213     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PpeBase;
00214     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnPpPage;
00215 <span class="preprocessor">#else</span>
00216 <span class="preprocessor"></span>    <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> HyperBase;
00217 <span class="preprocessor">#endif</span>
00218 <span class="preprocessor"></span>
00219     PageTablePage = 2;
00220     NumberOfForkPtes = 0;
00221     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00222     PageFrameIndex = (PFN_NUMBER)-1;
00223     PageDirFrameIndex = (PFN_NUMBER)-1;
00224 
00225 <span class="preprocessor">#if DBG</span>
00226 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a69">MM_DBG_FORK</a>) {
00227         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"beginning clone operation process to clone = %lx\n"</span>,
00228             ProcessToClone);
00229     }
00230 <span class="preprocessor">#endif //DBG</span>
00231 <span class="preprocessor"></span>
00232     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00233 
00234     <span class="keywordflow">if</span> (ProcessToClone != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()) {
00235         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00236         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;ProcessToClone-&gt;Pcb);
00237     }
00238 
00239 <span class="preprocessor">#if defined (_X86PAE_)</span>
00240 <span class="preprocessor"></span>    <a class="code" href="../../d8/d6/forksup_8c.html#a12">MiRetrievePageDirectoryFrames</a> (RootPhysicalPage, PageDirectoryFrames);
00241 <span class="preprocessor">#endif</span>
00242 <span class="preprocessor"></span>
00243     CurrentProcess = ProcessToClone;
00244 
00245     <span class="comment">//</span>
00246     <span class="comment">// Get the working set mutex and the address creation mutex</span>
00247     <span class="comment">// of the process to clone.  This prevents page faults while we</span>
00248     <span class="comment">// are examining the address map and prevents virtual address space</span>
00249     <span class="comment">// from being created or deleted.</span>
00250     <span class="comment">//</span>
00251 
00252     <a class="code" href="../../d4/d8/mi_8h.html#a160">LOCK_ADDRESS_SPACE</a> (CurrentProcess);
00253 
00254     <span class="comment">//</span>
00255     <span class="comment">// Write-watch VAD bitmaps are not currently duplicated</span>
00256     <span class="comment">// so fork is not allowed.</span>
00257     <span class="comment">//</span>
00258 
00259     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.WriteWatch == 1) {
00260         status = STATUS_INVALID_PAGE_PROTECTION;
00261         <span class="keywordflow">goto</span> ErrorReturn1;
00262     }
00263 
00264     <span class="comment">//</span>
00265     <span class="comment">// Check for AWE regions as they are not duplicated so fork is not allowed.</span>
00266     <span class="comment">// Note that since this is a readonly list walk, the address space mutex</span>
00267     <span class="comment">// is sufficient to synchronize properly.</span>
00268     <span class="comment">//</span>
00269 
00270     NextEntry = CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o61">PhysicalVadList</a>.Flink;
00271     <span class="keywordflow">while</span> (NextEntry != &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o61">PhysicalVadList</a>) {
00272 
00273         PhysicalView = CONTAINING_RECORD(NextEntry,
00274                                          <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>,
00275                                          ListEntry);
00276 
00277         <span class="keywordflow">if</span> (PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
00278             status = STATUS_INVALID_PAGE_PROTECTION;
00279             <span class="keywordflow">goto</span> ErrorReturn1;
00280         }
00281 
00282         NextEntry = NextEntry-&gt;Flink;
00283     }
00284 
00285     <span class="comment">//</span>
00286     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00287     <span class="comment">//</span>
00288 
00289     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
00290         status = STATUS_PROCESS_IS_TERMINATING;
00291         <span class="keywordflow">goto</span> ErrorReturn1;
00292     }
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">// Attempt to acquire the needed pool before starting the</span>
00296     <span class="comment">// clone operation, this allows an easier failure path in</span>
00297     <span class="comment">// the case of insufficient system resources.</span>
00298     <span class="comment">//</span>
00299 
00300     NumberOfPrivatePages = CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a>;
00301 
00302     CloneProtos = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">MMCLONE_BLOCK</a>) *
00303                                                 NumberOfPrivatePages,
00304                                                 'lCmM');
00305     <span class="keywordflow">if</span> (CloneProtos == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00306         status = STATUS_INSUFFICIENT_RESOURCES;
00307         <span class="keywordflow">goto</span> ErrorReturn1;
00308     }
00309 
00310     CloneHeader = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00311                                          <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html">MMCLONE_HEADER</a>),
00312                                          '  mM');
00313     <span class="keywordflow">if</span> (CloneHeader == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00314         status = STATUS_INSUFFICIENT_RESOURCES;
00315         <span class="keywordflow">goto</span> ErrorReturn2;
00316     }
00317 
00318     CloneDescriptor = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00319                                              <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">MMCLONE_DESCRIPTOR</a>),
00320                                              '  mM');
00321     <span class="keywordflow">if</span> (CloneDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00322         status = STATUS_INSUFFICIENT_RESOURCES;
00323         <span class="keywordflow">goto</span> ErrorReturn3;
00324     }
00325 
00326     Vad = <a class="code" href="../../d4/d8/mi_8h.html#a97">MiGetFirstVad</a> (CurrentProcess);
00327     VadList = &amp;FirstNewVad;
00328 
00329     <span class="keywordflow">while</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00330 
00331         <span class="comment">//</span>
00332         <span class="comment">// If the VAD does not go to the child, ignore it.</span>
00333         <span class="comment">//</span>
00334 
00335         <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 0) &amp;&amp;
00336 
00337             ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 1) ||
00338             (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.Inherit == <a class="code" href="../../d4/d8/mi_8h.html#a229">MM_VIEW_SHARE</a>))) {
00339 
00340             NewVad = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>), ' daV');
00341 
00342             <span class="keywordflow">if</span> (NewVad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00343 
00344                 <span class="comment">//</span>
00345                 <span class="comment">// Unable to allocate pool for all the VADs.  Deallocate</span>
00346                 <span class="comment">// all VADs and other pool obtained so far.</span>
00347                 <span class="comment">//</span>
00348 
00349                 *VadList = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00350                 status = STATUS_INSUFFICIENT_RESOURCES;
00351                 <span class="keywordflow">goto</span> ErrorReturn4;
00352             }
00353             *VadList = NewVad;
00354             VadList = &amp;NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>;
00355         }
00356         Vad = <a class="code" href="../../d4/d8/mi_8h.html#a96">MiGetNextVad</a> (Vad);
00357     }
00358 
00359     <span class="comment">//</span>
00360     <span class="comment">// Terminate list of VADs for new process.</span>
00361     <span class="comment">//</span>
00362 
00363     *VadList = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">// Charge the current process the quota for the paged and nonpaged</span>
00367     <span class="comment">// global structures.  This consists of the array of clone blocks</span>
00368     <span class="comment">// in paged pool and the clone header in non-paged pool.</span>
00369     <span class="comment">//</span>
00370 
00371     <span class="keywordflow">try</span> {
00372         <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a> (CurrentProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a496">MMCLONE_BLOCK</a>) *
00373                                                 NumberOfPrivatePages);
00374         PageTablePage = 1;
00375         <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a> (CurrentProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a498">MMCLONE_HEADER</a>));
00376         PageTablePage = 0;
00377 
00378     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00379 
00380         <span class="comment">//</span>
00381         <span class="comment">// Unable to charge quota for the clone blocks.</span>
00382         <span class="comment">//</span>
00383 
00384         status = GetExceptionCode();
00385         <span class="keywordflow">goto</span> ErrorReturn4;
00386     }
00387 
00388     <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
00389 
00390     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o30">ForkInProgress</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">// Indicate to the pager that the current process is being</span>
00394     <span class="comment">// forked.  This blocks other threads in that process from</span>
00395     <span class="comment">// modifying clone blocks counts and contents.</span>
00396     <span class="comment">//</span>
00397 
00398     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o30">ForkInProgress</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00399 
00400 <span class="preprocessor">#if defined (_WIN64)</span>
00401 <span class="preprocessor"></span>
00402     <span class="comment">//</span>
00403     <span class="comment">// Increment the reference count for the pages which are being "locked"</span>
00404     <span class="comment">// in MDLs.  This prevents the page from being reused while it is</span>
00405     <span class="comment">// being double mapped.  Note we have a count of 3 below because in addition</span>
00406     <span class="comment">// to the PPE, we also set up a initial dummy PDE and PTE.</span>
00407     <span class="comment">//</span>
00408 
00409     <a class="code" href="../../d8/d6/forksup_8c.html#a2">MiUpPfnReferenceCount</a> (RootPhysicalPage, 3);
00410 
00411     <span class="comment">//</span>
00412     <span class="comment">// Map the page directory parent page into the system address</span>
00413     <span class="comment">// space.  This is accomplished by building an MDL to describe the</span>
00414     <span class="comment">// Page directory parent page.</span>
00415     <span class="comment">//</span>
00416 
00417     PpeBase = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d8/mi_8h.html#a818">MiMapSinglePage</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00418                                        RootPhysicalPage,
00419                                        <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>,
00420                                        <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>);
00421 
00422     <span class="keywordflow">if</span> (PpeBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00423         <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (RootPhysicalPage, 3);
00424         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o30">ForkInProgress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00425         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00426         status = STATUS_INSUFFICIENT_RESOURCES;
00427         <span class="keywordflow">goto</span> ErrorReturn4;
00428     }
00429 
00430     PfnPpPage = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (RootPhysicalPage);
00431 
00432 <span class="preprocessor">#else</span>
00433 <span class="preprocessor"></span>
00434 <span class="preprocessor">#if !defined (_X86PAE_)</span>
00435 <span class="preprocessor"></span>    <a class="code" href="../../d8/d6/forksup_8c.html#a2">MiUpPfnReferenceCount</a> (RootPhysicalPage, 1);
00436 <span class="preprocessor">#endif</span>
00437 <span class="preprocessor"></span>
00438 <span class="preprocessor">#endif</span>
00439 <span class="preprocessor"></span>
00440     <span class="comment">//</span>
00441     <span class="comment">// Initialize a page directory map so it can be</span>
00442     <span class="comment">// unlocked in the loop and the end of the loop without</span>
00443     <span class="comment">// any testing to see if has a valid value the first time through.</span>
00444     <span class="comment">// Note this is a dummy map for 64-bit systems and a real one for 32-bit.</span>
00445     <span class="comment">//</span>
00446 
00447 <span class="preprocessor">#if !defined (_X86PAE_)</span>
00448 <span class="preprocessor"></span>
00449     MdlDirPage = RootPhysicalPage;
00450 
00451     PdePhysicalPage = RootPhysicalPage;
00452 
00453     PdeBase = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d8/mi_8h.html#a818">MiMapSinglePage</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00454                                        MdlDirPage,
00455                                        <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>,
00456                                        <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>);
00457 
00458     <span class="keywordflow">if</span> (PdeBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00459 <span class="preprocessor">#if defined (_WIN64)</span>
00460 <span class="preprocessor"></span>        <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (RootPhysicalPage, 3);
00461         <a class="code" href="../../d4/d8/mi_8h.html#a819">MiUnmapSinglePage</a> (PpeBase);
00462 <span class="preprocessor">#else</span>
00463 <span class="preprocessor"></span>        <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (RootPhysicalPage, 1);
00464 <span class="preprocessor">#endif</span>
00465 <span class="preprocessor"></span>        CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o30">ForkInProgress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00466         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00467         status = STATUS_INSUFFICIENT_RESOURCES;
00468         <span class="keywordflow">goto</span> ErrorReturn4;
00469     }
00470 
00471 <span class="preprocessor">#else</span>
00472 <span class="preprocessor"></span>
00473     <span class="comment">//</span>
00474     <span class="comment">// All 4 page directory pages need to be mapped for PAE so the heavyweight</span>
00475     <span class="comment">// mapping must be used.</span>
00476     <span class="comment">//</span>
00477 
00478     MdlPageDirectory = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)&amp;MdlHackPageDirectory[0];
00479 
00480     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(MdlPageDirectory, (PVOID)PDE_BASE, PD_PER_SYSTEM * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00481     MdlPageDirectory-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
00482 
00483     MdlPageFrames = (PPFN_NUMBER)(MdlPageDirectory + 1);
00484 
00485     <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM; i += 1) {
00486         *(MdlPageFrames + i) = PageDirectoryFrames[i];
00487         <a class="code" href="../../d8/d6/forksup_8c.html#a2">MiUpPfnReferenceCount</a> (PageDirectoryFrames[i], 1);
00488     }
00489 
00490     PdePhysicalPage = RootPhysicalPage;
00491 
00492     PdeBase = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d5/d6/iosup_8c.html#a50">MmMapLockedPagesSpecifyCache</a> (MdlPageDirectory,
00493                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00494                                                     <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>,
00495                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00496                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00497                                                     <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>);
00498 
00499     <span class="keywordflow">if</span> (PdeBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00500         <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM; i += 1) {
00501             <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (PageDirectoryFrames[i], 1);
00502         }
00503         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o30">ForkInProgress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00504         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00505         status = STATUS_INSUFFICIENT_RESOURCES;
00506         <span class="keywordflow">goto</span> ErrorReturn4;
00507     }
00508 
00509 <span class="preprocessor">#endif</span>
00510 <span class="preprocessor"></span>
00511     PfnPdPage = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (RootPhysicalPage);
00512 
00513 <span class="preprocessor">#if !defined (_WIN64)</span>
00514 <span class="preprocessor"></span>
00515     <span class="comment">//</span>
00516     <span class="comment">// Map hyperspace so target UsedPageTable entries can be incremented.</span>
00517     <span class="comment">//</span>
00518 
00519     <a class="code" href="../../d8/d6/forksup_8c.html#a2">MiUpPfnReferenceCount</a> (HyperPhysicalPage, 2);
00520 
00521     HyperBase = (<a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a>)<a class="code" href="../../d4/d8/mi_8h.html#a818">MiMapSinglePage</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00522                                          HyperPhysicalPage,
00523                                          <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>,
00524                                          <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>);
00525 
00526     <span class="keywordflow">if</span> (HyperBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00527         <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (HyperPhysicalPage, 2);
00528 <span class="preprocessor">#if !defined (_X86PAE_)</span>
00529 <span class="preprocessor"></span>        <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (RootPhysicalPage, 1);
00530         <a class="code" href="../../d4/d8/mi_8h.html#a819">MiUnmapSinglePage</a> (PdeBase);
00531 <span class="preprocessor">#else</span>
00532 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM; i += 1) {
00533             <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (PageDirectoryFrames[i], 1);
00534         }
00535         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (PdeBase, MdlPageDirectory);
00536 <span class="preprocessor">#endif</span>
00537 <span class="preprocessor"></span>        CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o30">ForkInProgress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00538         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00539         status = STATUS_INSUFFICIENT_RESOURCES;
00540         <span class="keywordflow">goto</span> ErrorReturn4;
00541     }
00542 <span class="preprocessor">#endif</span>
00543 <span class="preprocessor"></span>
00544     <span class="comment">//</span>
00545     <span class="comment">// Initialize a page table MDL to lock and map the hyperspace page so it</span>
00546     <span class="comment">// can be unlocked in the loop and the end of the loop without</span>
00547     <span class="comment">// any testing to see if has a valid value the first time through.</span>
00548     <span class="comment">//</span>
00549 
00550 <span class="preprocessor">#if defined (_WIN64)</span>
00551 <span class="preprocessor"></span>    MdlPage = RootPhysicalPage;
00552 <span class="preprocessor">#else</span>
00553 <span class="preprocessor"></span>    MdlPage = HyperPhysicalPage;
00554 <span class="preprocessor">#endif</span>
00555 <span class="preprocessor"></span>
00556     NewPteMappedAddress = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d8/mi_8h.html#a818">MiMapSinglePage</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00557                                                    MdlPage,
00558                                                    <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>,
00559                                                    <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>);
00560 
00561     <span class="keywordflow">if</span> (NewPteMappedAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00562 
00563 <span class="preprocessor">#if defined (_WIN64)</span>
00564 <span class="preprocessor"></span>
00565         <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (RootPhysicalPage, 3);
00566         <a class="code" href="../../d4/d8/mi_8h.html#a819">MiUnmapSinglePage</a> (PpeBase);
00567         <a class="code" href="../../d4/d8/mi_8h.html#a819">MiUnmapSinglePage</a> (PdeBase);
00568 
00569 <span class="preprocessor">#else</span>
00570 <span class="preprocessor"></span>        <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (HyperPhysicalPage, 2);
00571         <a class="code" href="../../d4/d8/mi_8h.html#a819">MiUnmapSinglePage</a> (HyperBase);
00572 <span class="preprocessor">#if !defined (_X86PAE_)</span>
00573 <span class="preprocessor"></span>        <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (RootPhysicalPage, 1);
00574         <a class="code" href="../../d4/d8/mi_8h.html#a819">MiUnmapSinglePage</a> (PdeBase);
00575 <span class="preprocessor">#else</span>
00576 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM; i += 1) {
00577             <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (PageDirectoryFrames[i], 1);
00578         }
00579         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (PdeBase, MdlPageDirectory);
00580 <span class="preprocessor">#endif</span>
00581 <span class="preprocessor"></span>
00582 <span class="preprocessor">#endif</span>
00583 <span class="preprocessor"></span>
00584         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o30">ForkInProgress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00585         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00586         status = STATUS_INSUFFICIENT_RESOURCES;
00587         <span class="keywordflow">goto</span> ErrorReturn4;
00588     }
00589 
00590     PointerNewPte = NewPteMappedAddress;
00591 
00592     <span class="comment">//</span>
00593     <span class="comment">// Build new clone prototype PTE block and descriptor, note that</span>
00594     <span class="comment">// each prototype PTE has a reference count following it.</span>
00595     <span class="comment">//</span>
00596 
00597     ForkProtoPte = CloneProtos;
00598 
00599     LockedForkPte = ForkProtoPte;
00600     <a class="code" href="../../d0/d2/mmsup_8c.html#a12">MiLockPagedAddress</a> (LockedForkPte, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00601 
00602     CloneHeader-&gt;<a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html#o0">NumberOfPtes</a> = (ULONG)NumberOfPrivatePages;
00603     CloneHeader-&gt;<a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html#o1">NumberOfProcessReferences</a> = 1;
00604     CloneHeader-&gt;<a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html#o2">ClonePtes</a> = CloneProtos;
00605 
00606 
00607 
00608     CloneDescriptor-&gt;<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o0">StartingVpn</a> = (ULONG_PTR)CloneProtos;
00609     CloneDescriptor-&gt;<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o1">EndingVpn</a> = (ULONG_PTR)((ULONG_PTR)CloneProtos +
00610                             NumberOfPrivatePages *
00611                               <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a496">MMCLONE_BLOCK</a>));
00612     CloneDescriptor-&gt;<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o7">NumberOfReferences</a> = 0;
00613     CloneDescriptor-&gt;<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o6">NumberOfPtes</a> = (ULONG)NumberOfPrivatePages;
00614     CloneDescriptor-&gt;<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o5">CloneHeader</a> = CloneHeader;
00615     CloneDescriptor-&gt;<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o8">PagedPoolQuotaCharge</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a496">MMCLONE_BLOCK</a>) *
00616                                 NumberOfPrivatePages;
00617 
00618     <span class="comment">//</span>
00619     <span class="comment">// Insert the clone descriptor for this fork operation into the</span>
00620     <span class="comment">// process which was cloned.</span>
00621     <span class="comment">//</span>
00622 
00623     <a class="code" href="../../d4/d8/mi_8h.html#a102">MiInsertClone</a> (CloneDescriptor);
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">// Examine each virtual address descriptor and create the</span>
00627     <span class="comment">// proper structures for the new process.</span>
00628     <span class="comment">//</span>
00629 
00630     Vad = <a class="code" href="../../d4/d8/mi_8h.html#a97">MiGetFirstVad</a> (CurrentProcess);
00631     NewVad = FirstNewVad;
00632 
00633     <span class="keywordflow">while</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00634 
00635         <span class="comment">//</span>
00636         <span class="comment">// Examine the VAD to determine its type and inheritance</span>
00637         <span class="comment">// attribute.</span>
00638         <span class="comment">//</span>
00639 
00640         <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 0) &amp;&amp;
00641 
00642             ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 1) ||
00643             (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.Inherit == <a class="code" href="../../d4/d8/mi_8h.html#a229">MM_VIEW_SHARE</a>))) {
00644 
00645             <span class="comment">//</span>
00646             <span class="comment">// The virtual address descriptor should be shared in the</span>
00647             <span class="comment">// forked process.</span>
00648             <span class="comment">//</span>
00649 
00650             <span class="comment">//</span>
00651             <span class="comment">// Make a copy of the VAD for the new process, the new VADs</span>
00652             <span class="comment">// are preallocated and linked together through the parent</span>
00653             <span class="comment">// field.</span>
00654             <span class="comment">//</span>
00655 
00656             NextVad = NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>;
00657 
00658 
00659             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 1) {
00660                 *(<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">PMMVAD_SHORT</a>)NewVad = *(<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">PMMVAD_SHORT</a>)Vad;
00661                 NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 0;
00662             } <span class="keywordflow">else</span> {
00663                 *NewVad = *Vad;
00664             }
00665 
00666             <span class="keywordflow">if</span> (NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange) {
00667                 <span class="keywordflow">if</span> ((NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured) ||
00668                     (NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured)) {
00669 
00670                     <span class="comment">//</span>
00671                     <span class="comment">// Eliminate these as the memory was secured</span>
00672                     <span class="comment">// only in this process, not in the new one.</span>
00673                     <span class="comment">//</span>
00674 
00675                     NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 0;
00676                     NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured = 0;
00677                     NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.StoredInVad = 0;
00678                     NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00679                     NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00680                 }
00681                 <span class="keywordflow">if</span> (NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.SecNoChange == 0) {
00682                     NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 0;
00683                 }
00684             }
00685             NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a> = NextVad;
00686 
00687             <span class="comment">//</span>
00688             <span class="comment">// If the VAD refers to a section, up the view count for that</span>
00689             <span class="comment">// section.  This requires the PFN mutex to be held.</span>
00690             <span class="comment">//</span>
00691 
00692             <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 0) &amp;&amp;
00693                 (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> != (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00694 
00695                 <span class="comment">//</span>
00696                 <span class="comment">// Increment the count of the number of views for the</span>
00697                 <span class="comment">// section object.  This requires the PFN mutex to be held.</span>
00698                 <span class="comment">//</span>
00699 
00700                 <a class="code" href="../../d8/d6/forksup_8c.html#a4">MiUpControlAreaRefs</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>);
00701             }
00702 
00703             <span class="comment">//</span>
00704             <span class="comment">// Examine each PTE and create the appropriate PTE for the</span>
00705             <span class="comment">// new process.</span>
00706             <span class="comment">//</span>
00707 
00708             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>));
00709             PointerPte = (<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>) <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
00710                                           <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>));
00711             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>));
00712             FirstTime = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00713 
00714             <span class="keywordflow">while</span> ((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)PointerPte &lt;= LastPte) {
00715 
00716                 <span class="comment">//</span>
00717                 <span class="comment">// For each PTE contained in the VAD check the page table</span>
00718                 <span class="comment">// page, and if non-zero, make the appropriate modifications</span>
00719                 <span class="comment">// to copy the PTE to the new process.</span>
00720                 <span class="comment">//</span>
00721 
00722                 <span class="keywordflow">if</span> ((FirstTime) || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
00723 
00724                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PointerPte);
00725                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00726 
00727                     <span class="keywordflow">do</span> {
00728 
00729                         <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00730                                                             CurrentProcess,
00731                                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00732                                                             &amp;Waited)) {
00733     
00734                             <span class="comment">//</span>
00735                             <span class="comment">// Page directory parent is empty, go to the next one.</span>
00736                             <span class="comment">//</span>
00737     
00738                             PointerPpe += 1;
00739                             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00740                             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00741     
00742                             <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)PointerPte &gt; LastPte) {
00743     
00744                                 <span class="comment">//</span>
00745                                 <span class="comment">// All done with this VAD, exit loop.</span>
00746                                 <span class="comment">//</span>
00747     
00748                                 <span class="keywordflow">goto</span> AllDone;
00749                             }
00750                         }
00751     
00752                         Waited = 0;
00753     
00754                         <span class="keywordflow">while</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00755                                                             CurrentProcess,
00756                                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00757                                                             &amp;Waited)) {
00758     
00759                             <span class="comment">//</span>
00760                             <span class="comment">// This page directory is empty, go to the next one.</span>
00761                             <span class="comment">//</span>
00762     
00763                             PointerPde += 1;
00764                             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00765     
00766                             <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)PointerPte &gt; LastPte) {
00767     
00768                                 <span class="comment">//</span>
00769                                 <span class="comment">// All done with this VAD, exit loop.</span>
00770                                 <span class="comment">//</span>
00771     
00772                                 <span class="keywordflow">goto</span> AllDone;
00773                             }
00774 <span class="preprocessor">#if defined (_WIN64)</span>
00775 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
00776                                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00777                                 Waited = 1;
00778                                 <span class="keywordflow">break</span>;
00779                             }
00780 <span class="preprocessor">#endif</span>
00781 <span class="preprocessor"></span>                        }
00782     
00783                     } <span class="keywordflow">while</span> (Waited != 0);
00784 
00785                     FirstTime = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00786 
00787 <span class="preprocessor">#if defined (_WIN64)</span>
00788 <span class="preprocessor"></span>                    <span class="comment">//</span>
00789                     <span class="comment">// Calculate the address of the PPE in the new process's</span>
00790                     <span class="comment">// page directory parent page.</span>
00791                     <span class="comment">//</span>
00792 
00793                     PointerNewPpe = &amp;PpeBase[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(PointerPte)];
00794 
00795                     <span class="keywordflow">if</span> (PointerNewPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00796 
00797                         <span class="comment">//</span>
00798                         <span class="comment">// No physical page has been allocated yet, get a page</span>
00799                         <span class="comment">// and map it in as a transition page.  This will</span>
00800                         <span class="comment">// become a page table page for the new process.</span>
00801                         <span class="comment">//</span>
00802 
00803                         ReleasedWorkingSetMutex =
00804                                 <a class="code" href="../../d8/d6/forksup_8c.html#a5">MiDoneWithThisPageGetAnother</a> (&amp;PageDirFrameIndex,
00805                                                               PointerPpe,
00806                                                               CurrentProcess);
00807 
00808                         MI_ZERO_USED_PAGETABLE_ENTRIES (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageDirFrameIndex));
00809 
00810                         <span class="keywordflow">if</span> (ReleasedWorkingSetMutex) {
00811 
00812                             <span class="keywordflow">do</span> {
00813 
00814                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00815                                                             CurrentProcess,
00816                                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00817                                                             &amp;Waited);
00818     
00819                                 Waited = 0;
00820     
00821                                 <a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00822                                                             CurrentProcess,
00823                                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00824                                                             &amp;Waited);
00825                             } <span class="keywordflow">while</span> (Waited != 0);
00826                         }
00827 
00828                         <span class="comment">//</span>
00829                         <span class="comment">// Hand initialize this PFN as normal initialization</span>
00830                         <span class="comment">// would do it for the process whose context we are</span>
00831                         <span class="comment">// attached to.</span>
00832                         <span class="comment">//</span>
00833                         <span class="comment">// The PFN lock must be held while initializing the</span>
00834                         <span class="comment">// frame to prevent those scanning the database for</span>
00835                         <span class="comment">// free frames from taking it after we fill in the</span>
00836                         <span class="comment">// u2 field.</span>
00837                         <span class="comment">//</span>
00838 
00839                         <a class="code" href="../../d8/d6/forksup_8c.html#a11">MiBuildForkPageTable</a> (PageDirFrameIndex,
00840                                               PointerPpe,
00841                                               PointerNewPpe,
00842                                               RootPhysicalPage,
00843                                               PfnPpPage);
00844 
00845                         <span class="comment">//</span>
00846                         <span class="comment">// Map the new page directory page into the system</span>
00847                         <span class="comment">// portion of the address space.  Note that hyperspace</span>
00848                         <span class="comment">// cannot be used as other operations (allocating</span>
00849                         <span class="comment">// nonpaged pool at DPC level) could cause the</span>
00850                         <span class="comment">// hyperspace page being used to be reused.</span>
00851                         <span class="comment">//</span>
00852 
00853                         <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (MdlDirPage, 1);
00854 
00855                         MdlDirPage = PageDirFrameIndex;
00856 
00857                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PdeBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00858 
00859                         PdeBase = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d8/mi_8h.html#a818">MiMapSinglePage</a> (PdeBase,
00860                                                            MdlDirPage,
00861                                                            <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>,
00862                                                            <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>);
00863 
00864                         <a class="code" href="../../d8/d6/forksup_8c.html#a2">MiUpPfnReferenceCount</a> (MdlDirPage, 1);
00865 
00866                         PointerNewPde = PdeBase;
00867                     }
00868                     <span class="keywordflow">else</span> {
00869                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerNewPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1 ||
00870                                 PointerNewPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1);
00871 
00872                         <span class="keywordflow">if</span> (PointerNewPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00873                             PageDirFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerNewPpe);
00874                         }
00875                         <span class="keywordflow">else</span> {
00876                             PageDirFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (PointerNewPpe);
00877                         }
00878                     }
00879 
00880                     <span class="comment">//</span>
00881                     <span class="comment">// Calculate the address of the new PDE to build.</span>
00882                     <span class="comment">// Note that FirstTime could be true, yet the page</span>
00883                     <span class="comment">// directory page might already be built.</span>
00884                     <span class="comment">//</span>
00885 
00886                     PointerNewPde = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((ULONG_PTR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(PointerNewPde) |
00887                                             <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a> (PointerPde));
00888 
00889                     PdePhysicalPage = PageDirFrameIndex;
00890                 
00891                     PfnPdPage = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePhysicalPage);
00892 
00893                     UsedPageDirectoryEntries = (PVOID)PfnPdPage;
00894 <span class="preprocessor">#endif</span>
00895 <span class="preprocessor"></span>
00896                     <span class="comment">//</span>
00897                     <span class="comment">// Calculate the address of the PDE in the new process's</span>
00898                     <span class="comment">// page directory page.</span>
00899                     <span class="comment">//</span>
00900 
00901                     PpePdeOffset = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
00902                     PointerNewPde = &amp;PdeBase[PpePdeOffset];
00903 
00904                     <span class="keywordflow">if</span> (PointerNewPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00905 
00906                         <span class="comment">//</span>
00907                         <span class="comment">// No physical page has been allocated yet, get a page</span>
00908                         <span class="comment">// and map it in as a transition page.  This will</span>
00909                         <span class="comment">// become a page table page for the new process.</span>
00910                         <span class="comment">//</span>
00911 
00912                         ReleasedWorkingSetMutex =
00913                                 <a class="code" href="../../d8/d6/forksup_8c.html#a5">MiDoneWithThisPageGetAnother</a> (&amp;PageFrameIndex,
00914                                                               PointerPde,
00915                                                               CurrentProcess);
00916 
00917                         <span class="keywordflow">if</span> (ReleasedWorkingSetMutex) {
00918 
00919                             <span class="keywordflow">do</span> {
00920 
00921                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00922                                                             CurrentProcess,
00923                                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00924                                                             &amp;Waited);
00925     
00926                                 Waited = 0;
00927     
00928                                 <a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00929                                                             CurrentProcess,
00930                                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00931                                                             &amp;Waited);
00932                             } <span class="keywordflow">while</span> (Waited != 0);
00933                         }
00934 
00935                         <span class="comment">//</span>
00936                         <span class="comment">// Hand initialize this PFN as normal initialization</span>
00937                         <span class="comment">// would do it for the process whose context we are</span>
00938                         <span class="comment">// attached to.</span>
00939                         <span class="comment">//</span>
00940                         <span class="comment">// The PFN lock must be held while initializing the</span>
00941                         <span class="comment">// frame to prevent those scanning the database for</span>
00942                         <span class="comment">// free frames from taking it after we fill in the</span>
00943                         <span class="comment">// u2 field.</span>
00944                         <span class="comment">//</span>
00945 
00946 <span class="preprocessor">#if defined (_X86PAE_)</span>
00947 <span class="preprocessor"></span>                        PdePhysicalPage = PageDirectoryFrames[MiGetPdPteOffset(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte))];
00948                         PfnPdPage = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePhysicalPage);
00949 <span class="preprocessor">#endif</span>
00950 <span class="preprocessor"></span>
00951                         <a class="code" href="../../d8/d6/forksup_8c.html#a11">MiBuildForkPageTable</a> (PageFrameIndex,
00952                                               PointerPde,
00953                                               PointerNewPde,
00954                                               PdePhysicalPage,
00955                                               PfnPdPage);
00956 
00957 <span class="preprocessor">#if defined (_WIN64)</span>
00958 <span class="preprocessor"></span>                        <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryEntries);
00959 <span class="preprocessor">#endif</span>
00960 <span class="preprocessor"></span>
00961                         <span class="comment">//</span>
00962                         <span class="comment">// Map the new page table page into the system portion</span>
00963                         <span class="comment">// of the address space.  Note that hyperspace</span>
00964                         <span class="comment">// cannot be used as other operations (allocating</span>
00965                         <span class="comment">// nonpaged pool at DPC level) could cause the</span>
00966                         <span class="comment">// hyperspace page being used to be reused.</span>
00967                         <span class="comment">//</span>
00968 
00969                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NewPteMappedAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00970 
00971                         <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (MdlPage, 1);
00972 
00973                         MdlPage = PageFrameIndex;
00974 
00975                         PointerNewPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d8/mi_8h.html#a818">MiMapSinglePage</a> (NewPteMappedAddress,
00976                                                                  MdlPage,
00977                                                                  <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>,
00978                                                                  <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>);
00979                     
00980                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerNewPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00981 
00982                         <a class="code" href="../../d8/d6/forksup_8c.html#a2">MiUpPfnReferenceCount</a> (MdlPage, 1);
00983                     }
00984 
00985                     <span class="comment">//</span>
00986                     <span class="comment">// Calculate the address of the new PTE to build.</span>
00987                     <span class="comment">// Note that FirstTime could be true, yet the page</span>
00988                     <span class="comment">// table page already built.</span>
00989                     <span class="comment">//</span>
00990 
00991                     PointerNewPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((ULONG_PTR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(PointerNewPte) |
00992                                             <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a> (PointerPte));
00993 
00994 <span class="preprocessor">#ifdef _WIN64</span>
00995 <span class="preprocessor"></span>                    UsedPageTableEntries = (PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>((PFN_NUMBER)PointerNewPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00996 <span class="preprocessor">#else</span>
00997 <span class="preprocessor"></span><span class="preprocessor">#if !defined (_X86PAE_)</span>
00998 <span class="preprocessor"></span>                    UsedPageTableEntries = (PVOID)&amp;HyperBase-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o16">UsedPageTableEntries</a>
00999                                                 [<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a158">MiGetPteOffset</a>( PointerPte )];
01000 <span class="preprocessor">#else</span>
01001 <span class="preprocessor"></span>                    UsedPageTableEntries = (PVOID)&amp;HyperBase-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o16">UsedPageTableEntries</a>
01002                                                 [<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte))];
01003 <span class="preprocessor">#endif</span>
01004 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01005 <span class="preprocessor"></span>
01006                 }
01007 
01008                 <span class="comment">//</span>
01009                 <span class="comment">// Make the fork prototype PTE location resident.</span>
01010                 <span class="comment">//</span>
01011 
01012                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (ForkProtoPte) != <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (LockedForkPte)) {
01013                     <a class="code" href="../../d0/d2/mmsup_8c.html#a13">MiUnlockPagedAddress</a> (LockedForkPte, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01014                     LockedForkPte = ForkProtoPte;
01015                     <a class="code" href="../../d0/d2/mmsup_8c.html#a12">MiLockPagedAddress</a> (LockedForkPte, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01016                 }
01017 
01018                 <a class="code" href="../../d0/d2/mmsup_8c.html#a8">MiMakeSystemAddressValid</a> (PointerPte, CurrentProcess);
01019 
01020                 PteContents = *PointerPte;
01021 
01022                 <span class="comment">//</span>
01023                 <span class="comment">// Check each PTE.</span>
01024                 <span class="comment">//</span>
01025 
01026                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01027                     NOTHING;
01028 
01029                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01030 
01031                     <span class="comment">//</span>
01032                     <span class="comment">// Valid.</span>
01033                     <span class="comment">//</span>
01034 
01035                     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01036                     VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01037                     WorkingSetIndex = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (VirtualAddress,
01038                                                     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>,
01039                                                     Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
01040 
01041                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex != <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>);
01042 
01043                     <span class="keywordflow">if</span> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1) {
01044 
01045                         <span class="comment">//</span>
01046                         <span class="comment">// This PTE is already in prototype PTE format.</span>
01047                         <span class="comment">//</span>
01048 
01049                         <span class="comment">//</span>
01050                         <span class="comment">// This is a prototype PTE.  The PFN database does</span>
01051                         <span class="comment">// not contain the contents of this PTE it contains</span>
01052                         <span class="comment">// the contents of the prototype PTE.  This PTE must</span>
01053                         <span class="comment">// be reconstructed to contain a pointer to the</span>
01054                         <span class="comment">// prototype PTE.</span>
01055                         <span class="comment">//</span>
01056                         <span class="comment">// The working set list entry contains information about</span>
01057                         <span class="comment">// how to reconstruct the PTE.</span>
01058                         <span class="comment">//</span>
01059 
01060                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.SameProtectAsProto
01061                                                                         == 0) {
01062 
01063                             <span class="comment">//</span>
01064                             <span class="comment">// The protection for the prototype PTE is in the</span>
01065                             <span class="comment">// WSLE.</span>
01066                             <span class="comment">//</span>
01067 
01068                             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
01069                             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection =
01070                                 <a class="code" href="../../d4/d8/mi_8h.html#a192">MI_GET_PROTECTION_FROM_WSLE</a>(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[WorkingSetIndex]);
01071                             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>;
01072 
01073                         } <span class="keywordflow">else</span> {
01074 
01075                             <span class="comment">//</span>
01076                             <span class="comment">// The protection is in the prototype PTE.</span>
01077                             <span class="comment">//</span>
01078 
01079                             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (
01080                                                             Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
01081  <span class="comment">//                            TempPte.u.Proto.ForkType =</span>
01082  <span class="comment">//                                        MmWsle[WorkingSetIndex].u1.e1.ForkType;</span>
01083                         }
01084 
01085                         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Proto.Prototype = 1;
01086                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerNewPte, TempPte);
01087 
01088                         <span class="comment">//</span>
01089                         <span class="comment">// A PTE is now non-zero, increment the used page</span>
01090                         <span class="comment">// table entries counter.</span>
01091                         <span class="comment">//</span>
01092 
01093                         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableEntries);
01094 
01095                         <span class="comment">//</span>
01096                         <span class="comment">// Check to see if this is a fork prototype PTE,</span>
01097                         <span class="comment">// and if it is increment the reference count</span>
01098                         <span class="comment">// which is in the longword following the PTE.</span>
01099                         <span class="comment">//</span>
01100 
01101                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a104">MiLocateCloneAddress</a> ((PVOID)Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>) !=
01102                                     (<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01103 
01104                             <span class="comment">//</span>
01105                             <span class="comment">// The reference count field, or the prototype PTE</span>
01106                             <span class="comment">// for that matter may not be in the working set.</span>
01107                             <span class="comment">//</span>
01108 
01109                             CloneProto = (<a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a>)Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
01110 
01111                             <a class="code" href="../../d8/d6/forksup_8c.html#a8">MiUpCloneProtoRefCount</a> (CloneProto,
01112                                                     CurrentProcess);
01113 
01114                             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (ForkProtoPte) !=
01115                                                     <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (LockedForkPte)) {
01116                                 <a class="code" href="../../d0/d2/mmsup_8c.html#a13">MiUnlockPagedAddress</a> (LockedForkPte, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01117                                 LockedForkPte = ForkProtoPte;
01118                                 <a class="code" href="../../d0/d2/mmsup_8c.html#a12">MiLockPagedAddress</a> (LockedForkPte, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01119                             }
01120 
01121                             <a class="code" href="../../d0/d2/mmsup_8c.html#a8">MiMakeSystemAddressValid</a> (PointerPte,
01122                                                       CurrentProcess);
01123                         }
01124 
01125                     } <span class="keywordflow">else</span> {
01126 
01127                         <span class="comment">//</span>
01128                         <span class="comment">// This is a private page, create a fork prototype PTE</span>
01129                         <span class="comment">// which becomes the "prototype" PTE for this page.</span>
01130                         <span class="comment">// The protection is the same as that in the prototype'</span>
01131                         <span class="comment">// PTE so the WSLE does not need to be updated.</span>
01132                         <span class="comment">//</span>
01133 
01134                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a135">MI_MAKE_VALID_PTE_WRITE_COPY</a> (PointerPte);
01135 
01136                         ForkProtoPte-&gt;ProtoPte = *PointerPte;
01137                         ForkProtoPte-&gt;CloneRefCount = 2;
01138 
01139                         <span class="comment">//</span>
01140                         <span class="comment">// Transform the PFN element to reference this new fork</span>
01141                         <span class="comment">// prototype PTE.</span>
01142                         <span class="comment">//</span>
01143 
01144                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = &amp;ForkProtoPte-&gt;ProtoPte;
01145                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte = 1;
01146 
01147                         ContainingPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(&amp;ForkProtoPte-&gt;ProtoPte);
01148                         <span class="keywordflow">if</span> (ContainingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01149 <span class="preprocessor">#if !defined (_WIN64)</span>
01150 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d8/mi_8h.html#a836">MiCheckPdeForPagedPool</a> (&amp;ForkProtoPte-&gt;ProtoPte))) {
01151 <span class="preprocessor">#endif</span>
01152 <span class="preprocessor"></span>                                <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
01153                                               0x61940, 
01154                                               (ULONG_PTR)&amp;ForkProtoPte-&gt;ProtoPte,
01155                                               (ULONG_PTR)ContainingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
01156                                               (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(&amp;ForkProtoPte-&gt;ProtoPte));
01157 <span class="preprocessor">#if !defined (_WIN64)</span>
01158 <span class="preprocessor"></span>                            }
01159 <span class="preprocessor">#endif</span>
01160 <span class="preprocessor"></span>                        }
01161                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (ContainingPte);
01162 
01163 
01164                         <span class="comment">//</span>
01165                         <span class="comment">// Increment the share count for the page containing the</span>
01166                         <span class="comment">// fork prototype PTEs as we have just placed a valid</span>
01167                         <span class="comment">// PTE into the page.</span>
01168                         <span class="comment">//</span>
01169 
01170                         PfnForkPtePage = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (
01171                                             ContainingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber );
01172 
01173                         <a class="code" href="../../d8/d6/forksup_8c.html#a6">MiUpForkPageShareCount</a> (PfnForkPtePage);
01174 
01175                         <span class="comment">//</span>
01176                         <span class="comment">// Change the protection in the PFN database to COPY</span>
01177                         <span class="comment">// on write, if writable.</span>
01178                         <span class="comment">//</span>
01179 
01180                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a174">MI_MAKE_PROTECT_WRITE_COPY</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01181 
01182                         <span class="comment">//</span>
01183                         <span class="comment">// Put the protection into the WSLE and mark the WSLE</span>
01184                         <span class="comment">// to indicate that the protection field for the PTE</span>
01185                         <span class="comment">// is the same as the prototype PTE.</span>
01186                         <span class="comment">//</span>
01187 
01188                         <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Protection =
01189                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a184">MI_GET_PROTECTION_FROM_SOFT_PTE</a>(&amp;Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01190 
01191                         <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.SameProtectAsProto = 1;
01192 
01193                         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
01194                         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Proto.Prototype = 1;
01195                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerNewPte, TempPte);
01196 
01197                         <span class="comment">//</span>
01198                         <span class="comment">// A PTE is now non-zero, increment the used page</span>
01199                         <span class="comment">// table entries counter.</span>
01200                         <span class="comment">//</span>
01201 
01202                         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableEntries);
01203 
01204                         <span class="comment">//</span>
01205                         <span class="comment">// One less private page (it's now shared).</span>
01206                         <span class="comment">//</span>
01207 
01208                         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> -= 1;
01209 
01210                         ForkProtoPte += 1;
01211                         NumberOfForkPtes += 1;
01212 
01213                     }
01214 
01215                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
01216 
01217                     <span class="comment">//</span>
01218                     <span class="comment">// Prototype PTE, check to see if this is a fork</span>
01219                     <span class="comment">// prototype PTE already.  Note that if COW is set,</span>
01220                     <span class="comment">// the PTE can just be copied (fork compatible format).</span>
01221                     <span class="comment">//</span>
01222 
01223                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerNewPte, PteContents);
01224 
01225                     <span class="comment">//</span>
01226                     <span class="comment">// A PTE is now non-zero, increment the used page</span>
01227                     <span class="comment">// table entries counter.</span>
01228                     <span class="comment">//</span>
01229 
01230                     <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableEntries);
01231 
01232                     <span class="comment">//</span>
01233                     <span class="comment">// Check to see if this is a fork prototype PTE,</span>
01234                     <span class="comment">// and if it is increment the reference count</span>
01235                     <span class="comment">// which is in the longword following the PTE.</span>
01236                     <span class="comment">//</span>
01237 
01238                     CloneProto = (<a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a>)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a>(PointerPte));
01239 
01240                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a104">MiLocateCloneAddress</a> ((PVOID)CloneProto) !=
01241                                 (<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01242 
01243                         <span class="comment">//</span>
01244                         <span class="comment">// The reference count field, or the prototype PTE</span>
01245                         <span class="comment">// for that matter may not be in the working set.</span>
01246                         <span class="comment">//</span>
01247 
01248                         <a class="code" href="../../d8/d6/forksup_8c.html#a8">MiUpCloneProtoRefCount</a> (CloneProto,
01249                                                 CurrentProcess);
01250 
01251                         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (ForkProtoPte) !=
01252                                                 <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (LockedForkPte)) {
01253                             <a class="code" href="../../d0/d2/mmsup_8c.html#a13">MiUnlockPagedAddress</a> (LockedForkPte, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01254                             LockedForkPte = ForkProtoPte;
01255                             <a class="code" href="../../d0/d2/mmsup_8c.html#a12">MiLockPagedAddress</a> (LockedForkPte, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01256                         }
01257 
01258                         <a class="code" href="../../d0/d2/mmsup_8c.html#a8">MiMakeSystemAddressValid</a> (PointerPte,
01259                                                     CurrentProcess);
01260                     }
01261 
01262                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
01263 
01264                     <span class="comment">//</span>
01265                     <span class="comment">// Transition.</span>
01266                     <span class="comment">//</span>
01267 
01268                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/forksup_8c.html#a9">MiHandleForkTransitionPte</a> (PointerPte,
01269                                                    PointerNewPte,
01270                                                    ForkProtoPte)) {
01271                         <span class="comment">//</span>
01272                         <span class="comment">// PTE is no longer transition, try again.</span>
01273                         <span class="comment">//</span>
01274 
01275                         <span class="keywordflow">continue</span>;
01276                     }
01277 
01278                     <span class="comment">//</span>
01279                     <span class="comment">// A PTE is now non-zero, increment the used page</span>
01280                     <span class="comment">// table entries counter.</span>
01281                     <span class="comment">//</span>
01282 
01283                     <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableEntries);
01284 
01285                     <span class="comment">//</span>
01286                     <span class="comment">// One less private page (it's now shared).</span>
01287                     <span class="comment">//</span>
01288 
01289                     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> -= 1;
01290 
01291                     ForkProtoPte += 1;
01292                     NumberOfForkPtes += 1;
01293 
01294                 } <span class="keywordflow">else</span> {
01295 
01296                     <span class="comment">//</span>
01297                     <span class="comment">// Page file format (may be demand zero).</span>
01298                     <span class="comment">//</span>
01299 
01300                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a171">IS_PTE_NOT_DEMAND_ZERO</a> (PteContents)) {
01301 
01302                         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection == <a class="code" href="../../d4/d8/mi_8h.html#a45">MM_DECOMMIT</a>) {
01303 
01304                             <span class="comment">//</span>
01305                             <span class="comment">// This is a decommitted PTE, just move it</span>
01306                             <span class="comment">// over to the new process.  Don't increment</span>
01307                             <span class="comment">// the count of private pages.</span>
01308                             <span class="comment">//</span>
01309 
01310                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerNewPte, PteContents);
01311                         } <span class="keywordflow">else</span> {
01312 
01313                             <span class="comment">//</span>
01314                             <span class="comment">// The PTE is not demand zero, move the PTE to</span>
01315                             <span class="comment">// a fork prototype PTE and make this PTE and</span>
01316                             <span class="comment">// the new processes PTE refer to the fork</span>
01317                             <span class="comment">// prototype PTE.</span>
01318                             <span class="comment">//</span>
01319 
01320                             ForkProtoPte-&gt;ProtoPte = PteContents;
01321 
01322                             <span class="comment">//</span>
01323                             <span class="comment">// Make the protection write-copy if writable.</span>
01324                             <span class="comment">//</span>
01325 
01326                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a174">MI_MAKE_PROTECT_WRITE_COPY</a> (ForkProtoPte-&gt;ProtoPte);
01327 
01328                             ForkProtoPte-&gt;CloneRefCount = 2;
01329 
01330                             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long =
01331                                  <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (&amp;ForkProtoPte-&gt;ProtoPte);
01332 
01333                             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Proto.Prototype = 1;
01334 
01335                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
01336                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerNewPte, TempPte);
01337 
01338                             <span class="comment">//</span>
01339                             <span class="comment">// One less private page (it's now shared).</span>
01340                             <span class="comment">//</span>
01341 
01342                             CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> -= 1;
01343 
01344                             ForkProtoPte += 1;
01345                             NumberOfForkPtes += 1;
01346                         }
01347                     } <span class="keywordflow">else</span> {
01348 
01349                         <span class="comment">//</span>
01350                         <span class="comment">// The page is demand zero, make the new process's</span>
01351                         <span class="comment">// page demand zero.</span>
01352                         <span class="comment">//</span>
01353 
01354                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerNewPte, PteContents);
01355                     }
01356 
01357                     <span class="comment">//</span>
01358                     <span class="comment">// A PTE is now non-zero, increment the used page</span>
01359                     <span class="comment">// table entries counter.</span>
01360                     <span class="comment">//</span>
01361 
01362                     <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableEntries);
01363                 }
01364 
01365                 PointerPte += 1;
01366                 PointerNewPte += 1;
01367 
01368             }  <span class="comment">// end while for PTEs</span>
01369 AllDone:
01370             NewVad = NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>;
01371         }
01372         Vad = <a class="code" href="../../d4/d8/mi_8h.html#a96">MiGetNextVad</a> (Vad);
01373 
01374     } <span class="comment">// end while for VADs</span>
01375 
01376     <span class="comment">//</span>
01377     <span class="comment">// Unlock paged pool page.</span>
01378     <span class="comment">//</span>
01379 
01380     <a class="code" href="../../d0/d2/mmsup_8c.html#a13">MiUnlockPagedAddress</a> (LockedForkPte, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01381 
01382     <span class="comment">//</span>
01383     <span class="comment">// Unmap the PD Page and hyper space page.</span>
01384     <span class="comment">//</span>
01385 
01386 <span class="preprocessor">#if defined (_WIN64)</span>
01387 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a819">MiUnmapSinglePage</a> (PpeBase);
01388 <span class="preprocessor">#endif</span>
01389 <span class="preprocessor"></span>
01390 <span class="preprocessor">#if !defined (_X86PAE_)</span>
01391 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a819">MiUnmapSinglePage</a> (PdeBase);
01392 <span class="preprocessor">#else</span>
01393 <span class="preprocessor"></span>    <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (PdeBase, MdlPageDirectory);
01394 <span class="preprocessor">#endif</span>
01395 <span class="preprocessor"></span>
01396 <span class="preprocessor">#if !defined (_WIN64)</span>
01397 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a819">MiUnmapSinglePage</a> (HyperBase);
01398 <span class="preprocessor">#endif</span>
01399 <span class="preprocessor"></span>
01400     <a class="code" href="../../d4/d8/mi_8h.html#a819">MiUnmapSinglePage</a> (NewPteMappedAddress);
01401 
01402 <span class="preprocessor">#if defined (_WIN64)</span>
01403 <span class="preprocessor"></span>    <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (RootPhysicalPage, 1);
01404 <span class="preprocessor">#endif</span>
01405 <span class="preprocessor"></span>
01406 <span class="preprocessor">#if defined (_X86PAE_)</span>
01407 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM; i += 1) {
01408         <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (PageDirectoryFrames[i], 1);
01409     }
01410 <span class="preprocessor">#else</span>
01411 <span class="preprocessor"></span>    <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (MdlDirPage, 1);
01412 <span class="preprocessor">#endif</span>
01413 <span class="preprocessor"></span>
01414 <span class="preprocessor">#if !defined (_WIN64)</span>
01415 <span class="preprocessor"></span>    <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (HyperPhysicalPage, 1);
01416 <span class="preprocessor">#endif</span>
01417 <span class="preprocessor"></span>
01418     <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (MdlPage, 1);
01419 
01420     <span class="comment">//</span>
01421     <span class="comment">// Make the count of private pages match between the two processes.</span>
01422     <span class="comment">//</span>
01423 
01424     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((SPFN_NUMBER)CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> &gt;= 0);
01425 
01426     ProcessToInitialize-&gt;NumberOfPrivatePages =
01427                                           CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a>;
01428 
01429     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfForkPtes &lt;= CloneDescriptor-&gt;NumberOfPtes);
01430 
01431     <span class="keywordflow">if</span> (NumberOfForkPtes != 0) {
01432 
01433         <span class="comment">//</span>
01434         <span class="comment">// The number of fork PTEs is non-zero, set the values</span>
01435         <span class="comment">// into the structures.</span>
01436         <span class="comment">//</span>
01437 
01438         CloneHeader-&gt;<a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html#o0">NumberOfPtes</a> = NumberOfForkPtes;
01439         CloneDescriptor-&gt;<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o7">NumberOfReferences</a> = NumberOfForkPtes;
01440         CloneDescriptor-&gt;<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o6">NumberOfPtes</a> = NumberOfForkPtes;
01441 
01442     } <span class="keywordflow">else</span> {
01443 
01444         <span class="comment">//</span>
01445         <span class="comment">// There were no fork PTEs created.  Remove the clone descriptor</span>
01446         <span class="comment">// from this process and clean up the related structures.</span>
01447         <span class="comment">// Note - must be holding the working set mutex and not holding</span>
01448         <span class="comment">// the PFN lock.</span>
01449         <span class="comment">//</span>
01450 
01451         <a class="code" href="../../d4/d8/mi_8h.html#a103">MiRemoveClone</a> (CloneDescriptor);
01452 
01453         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
01454 
01455         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CloneDescriptor-&gt;<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o5">CloneHeader</a>-&gt;<a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html#o2">ClonePtes</a>);
01456 
01457         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CloneDescriptor-&gt;<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o5">CloneHeader</a>);
01458 
01459         <span class="comment">//</span>
01460         <span class="comment">// Return the pool for the global structures referenced by the</span>
01461         <span class="comment">// clone descriptor.</span>
01462         <span class="comment">//</span>
01463 
01464         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess,
01465                            <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01466                            CloneDescriptor-&gt;<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o8">PagedPoolQuotaCharge</a>);
01467 
01468         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a498">MMCLONE_HEADER</a>));
01469 
01470         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CloneDescriptor);
01471 
01472         <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
01473     }
01474 
01475     <a class="code" href="../../d8/d6/forksup_8c.html#a10">MiDownShareCountFlushEntireTb</a> (PageFrameIndex);
01476 
01477 <span class="preprocessor">#if defined (_WIN64)</span>
01478 <span class="preprocessor"></span>    <a class="code" href="../../d8/d6/forksup_8c.html#a10">MiDownShareCountFlushEntireTb</a> (PageDirFrameIndex);
01479 <span class="preprocessor">#endif</span>
01480 <span class="preprocessor"></span>
01481     PageFrameIndex = (PFN_NUMBER)-1;
01482     PageDirFrameIndex = (PFN_NUMBER)-1;
01483 
01484     <span class="comment">//</span>
01485     <span class="comment">// Copy the clone descriptors from this process to the new process.</span>
01486     <span class="comment">//</span>
01487 
01488     Clone = <a class="code" href="../../d4/d8/mi_8h.html#a101">MiGetFirstClone</a> ();
01489     CloneList = &amp;FirstNewClone;
01490     CloneFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01491 
01492     <span class="keywordflow">while</span> (Clone != (<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01493 
01494         <span class="comment">//</span>
01495         <span class="comment">// Increment the count of processes referencing this clone block.</span>
01496         <span class="comment">//</span>
01497 
01498         <a class="code" href="../../d8/d6/forksup_8c.html#a7">MiUpCloneProcessRefCount</a> (Clone);
01499 
01500         <span class="keywordflow">do</span> {
01501             NewClone = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01502                                               <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d8/mi_8h.html#a500">MMCLONE_DESCRIPTOR</a>),
01503                                               '  mM');
01504 
01505             <span class="keywordflow">if</span> (NewClone != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01506                 <span class="keywordflow">break</span>;
01507             }
01508 
01509             <span class="comment">//</span>
01510             <span class="comment">// There are insufficient resources to continue this operation,</span>
01511             <span class="comment">// however, to properly clean up at this point, all the</span>
01512             <span class="comment">// clone headers must be allocated, so when the cloned process</span>
01513             <span class="comment">// is deleted, the clone headers will be found.  if the pool</span>
01514             <span class="comment">// is not readily available, loop periodically trying for it.</span>
01515             <span class="comment">// Force the clone operation to fail so the pool will soon be</span>
01516             <span class="comment">// released.</span>
01517             <span class="comment">//</span>
01518 
01519             CloneFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01520             status = STATUS_INSUFFICIENT_RESOURCES;
01521 
01522             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01523                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01524                                     (PLARGE_INTEGER)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
01525             <span class="keywordflow">continue</span>;
01526         } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01527 
01528         *NewClone = *Clone;
01529 
01530         *CloneList = NewClone;
01531         CloneList = &amp;NewClone-&gt;<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o2">Parent</a>;
01532         Clone = <a class="code" href="../../d4/d8/mi_8h.html#a99">MiGetNextClone</a> (Clone);
01533     }
01534 
01535     *CloneList = (<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01536 
01537     <span class="comment">//</span>
01538     <span class="comment">// Release the working set mutex and the address creation mutex from</span>
01539     <span class="comment">// the current process as all the necessary information is now</span>
01540     <span class="comment">// captured.</span>
01541     <span class="comment">//</span>
01542 
01543     <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
01544 
01545     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o30">ForkInProgress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01546 
01547     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (CurrentProcess);
01548 
01549     <span class="comment">//</span>
01550     <span class="comment">// As we have updated many PTEs to clear dirty bits, flush the</span>
01551     <span class="comment">// TB cache.  Note that this was not done every time we changed</span>
01552     <span class="comment">// a valid PTE so other threads could be modifying the address</span>
01553     <span class="comment">// space without causing copy on writes. (Too bad).</span>
01554     <span class="comment">//</span>
01555 
01556 
01557     <span class="comment">//</span>
01558     <span class="comment">// Attach to the process to initialize and insert the vad and clone</span>
01559     <span class="comment">// descriptors into the tree.</span>
01560     <span class="comment">//</span>
01561 
01562     <span class="keywordflow">if</span> (Attached) {
01563         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01564         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01565     }
01566 
01567     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != ProcessToInitialize) {
01568         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01569         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;ProcessToInitialize-&gt;Pcb);
01570     }
01571 
01572     CurrentProcess = ProcessToInitialize;
01573 
01574     <span class="comment">//</span>
01575     <span class="comment">// We are now in the context of the new process, build the</span>
01576     <span class="comment">// VAD list and the clone list.</span>
01577     <span class="comment">//</span>
01578 
01579     Vad = FirstNewVad;
01580     VadInsertFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01581 
01582     <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
01583 
01584     <span class="keywordflow">while</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01585 
01586         NextVad = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>;
01587 
01588         <span class="keywordflow">try</span> {
01589 
01590             <span class="keywordflow">if</span> (VadInsertFailed) {
01591                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge = <a class="code" href="../../d4/d8/mi_8h.html#a227">MM_MAX_COMMIT</a>;
01592             }
01593 
01594             <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (Vad);
01595 
01596         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01597 
01598             <span class="comment">//</span>
01599             <span class="comment">// Charging quota for the VAD failed, set the</span>
01600             <span class="comment">// remaining quota fields in this VAD and all</span>
01601             <span class="comment">// subsequent VADs to zero so the VADs can be</span>
01602             <span class="comment">// inserted and later deleted.</span>
01603             <span class="comment">//</span>
01604 
01605             VadInsertFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01606             status = GetExceptionCode();
01607 
01608             <span class="comment">//</span>
01609             <span class="comment">// Do the loop again for this VAD.</span>
01610             <span class="comment">//</span>
01611 
01612             <span class="keywordflow">continue</span>;
01613         }
01614 
01615         <span class="comment">//</span>
01616         <span class="comment">// Update the current virtual size.</span>
01617         <span class="comment">//</span>
01618 
01619         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o15">VirtualSize</a> += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> +
01620                             ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> - Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01621 
01622         Vad = NextVad;
01623     }
01624 
01625     <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
01626     <span class="comment">//MmUnlockCode (MiCloneProcessAddressSpace, 5000);</span>
01627 
01628     <span class="comment">//</span>
01629     <span class="comment">// Update the peak virtual size.</span>
01630     <span class="comment">//</span>
01631 
01632     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o14">PeakVirtualSize</a> = CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o15">VirtualSize</a>;
01633 
01634     Clone = FirstNewClone;
01635     TotalPagedPoolCharge = 0;
01636     TotalNonPagedPoolCharge = 0;
01637 
01638     <span class="keywordflow">while</span> (Clone != (<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01639 
01640         NextClone = Clone-&gt;<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o2">Parent</a>;
01641         <a class="code" href="../../d4/d8/mi_8h.html#a102">MiInsertClone</a> (Clone);
01642 
01643         <span class="comment">//</span>
01644         <span class="comment">// Calculate the page pool and non-paged pool to charge for these</span>
01645         <span class="comment">// operations.</span>
01646         <span class="comment">//</span>
01647 
01648         TotalPagedPoolCharge += Clone-&gt;<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o8">PagedPoolQuotaCharge</a>;
01649         TotalNonPagedPoolCharge += <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a498">MMCLONE_HEADER</a>);
01650 
01651         Clone = NextClone;
01652     }
01653 
01654     <span class="keywordflow">if</span> (CloneFailed || VadInsertFailed) {
01655 
01656         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o32">ForkWasSuccessful</a> = <a class="code" href="../../d8/d6/forksup_8c.html#a1">MM_FORK_FAILED</a>;
01657 
01658         <span class="keywordflow">if</span> (Attached) {
01659             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01660         }
01661         KdPrint((<span class="stringliteral">"MMFORK: vad insert failed\n"</span>));
01662 
01663         <span class="keywordflow">return</span> status;
01664     }
01665 
01666     <span class="keywordflow">try</span> {
01667 
01668         PageTablePage = 1;
01669         <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a> (CurrentProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, TotalPagedPoolCharge);
01670         PageTablePage = 0;
01671         <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a> (CurrentProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, TotalNonPagedPoolCharge);
01672 
01673     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01674 
01675         <span class="keywordflow">if</span> (PageTablePage == 0) {
01676             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, TotalPagedPoolCharge);
01677         }
01678         KdPrint((<span class="stringliteral">"MMFORK: pool quota failed\n"</span>));
01679 
01680         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o32">ForkWasSuccessful</a> = <a class="code" href="../../d8/d6/forksup_8c.html#a1">MM_FORK_FAILED</a>;
01681 
01682         <span class="keywordflow">if</span> (Attached) {
01683             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01684         }
01685         <span class="keywordflow">return</span> GetExceptionCode();
01686     }
01687 
01688     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToClone-&gt;ForkWasSuccessful == <a class="code" href="../../d8/d6/forksup_8c.html#a0">MM_FORK_SUCCEEDED</a>);
01689     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o32">ForkWasSuccessful</a> == <a class="code" href="../../d8/d6/forksup_8c.html#a0">MM_FORK_SUCCEEDED</a>);
01690 
01691     <span class="keywordflow">if</span> (Attached) {
01692         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01693     }
01694 
01695 <span class="preprocessor">#if DBG</span>
01696 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a69">MM_DBG_FORK</a>) {
01697         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ending clone operation process to clone = %lx\n"</span>,
01698             ProcessToClone);
01699     }
01700 <span class="preprocessor">#endif //DBG</span>
01701 <span class="preprocessor"></span>
01702     <span class="keywordflow">return</span> STATUS_SUCCESS;
01703 
01704     <span class="comment">//</span>
01705     <span class="comment">// Error returns.</span>
01706     <span class="comment">//</span>
01707 
01708 ErrorReturn4:
01709         <span class="keywordflow">if</span> (PageTablePage == 2) {
01710             NOTHING;
01711         }
01712         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PageTablePage == 1) {
01713             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a496">MMCLONE_BLOCK</a>) *
01714                                 NumberOfPrivatePages);
01715         }
01716         <span class="keywordflow">else</span> {
01717             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageTablePage == 0);
01718             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a496">MMCLONE_BLOCK</a>) *
01719                                 NumberOfPrivatePages);
01720             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a498">MMCLONE_HEADER</a>));
01721         }
01722 
01723         NewVad = FirstNewVad;
01724         <span class="keywordflow">while</span> (NewVad != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01725             Vad = NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>;
01726             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewVad);
01727             NewVad = Vad;
01728         }
01729 
01730         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CloneDescriptor);
01731 ErrorReturn3:
01732         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CloneHeader);
01733 ErrorReturn2:
01734         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CloneProtos);
01735 ErrorReturn1:
01736         <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (CurrentProcess);
01737         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o32">ForkWasSuccessful</a> == <a class="code" href="../../d8/d6/forksup_8c.html#a0">MM_FORK_SUCCEEDED</a>);
01738         <span class="keywordflow">if</span> (Attached) {
01739             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01740         }
01741         <span class="keywordflow">return</span> status;
01742 }
01743 
01744 ULONG
<a name="l01745"></a><a class="code" href="../../d4/d8/mi_8h.html#a854">01745</a> <a class="code" href="../../d4/d8/mi_8h.html#a854">MiDecrementCloneBlockReference</a> (
01746     IN <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a> CloneDescriptor,
01747     IN <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a> CloneBlock,
01748     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
01749     )
01750 
01751 <span class="comment">/*++</span>
01752 <span class="comment"></span>
01753 <span class="comment">Routine Description:</span>
01754 <span class="comment"></span>
01755 <span class="comment">    This routine decrements the reference count field of a "fork prototype</span>
01756 <span class="comment">    PTE" (clone-block).  If the reference count becomes zero, the reference</span>
01757 <span class="comment">    count for the clone-descriptor is decremented and if that becomes zero,</span>
01758 <span class="comment">    it is deallocated and the number of process count for the clone header is</span>
01759 <span class="comment">    decremented.  If the number of process count becomes zero, the clone</span>
01760 <span class="comment">    header is deallocated.</span>
01761 <span class="comment"></span>
01762 <span class="comment">Arguments:</span>
01763 <span class="comment"></span>
01764 <span class="comment">    CloneDescriptor - Supplies the clone descriptor which describes the</span>
01765 <span class="comment">                      clone block.</span>
01766 <span class="comment"></span>
01767 <span class="comment">    CloneBlock - Supplies the clone block to decrement the reference count of.</span>
01768 <span class="comment"></span>
01769 <span class="comment">    CurrentProcess - Supplies the current process.</span>
01770 <span class="comment"></span>
01771 <span class="comment">Return Value:</span>
01772 <span class="comment"></span>
01773 <span class="comment">    TRUE if the working set mutex was released, FALSE if it was not.</span>
01774 <span class="comment"></span>
01775 <span class="comment">Environment:</span>
01776 <span class="comment"></span>
01777 <span class="comment">    Kernel mode, APCs disabled, working set mutex and PFN mutex held.</span>
01778 <span class="comment"></span>
01779 <span class="comment">--*/</span>
01780 
01781 {
01782 
01783     ULONG MutexReleased;
01784     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> CloneContents;
01785     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn3;
01786     KIRQL OldIrql;
01787     LONG NewCount;
01788     LOGICAL WsHeldSafe;
01789 
01790     MutexReleased = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01791     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
01792 
01793     MutexReleased = <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (CloneBlock, CurrentProcess);
01794 
01795     <span class="keywordflow">while</span> (CurrentProcess-&gt;ForkInProgress) {
01796         <a class="code" href="../../d4/d8/mi_8h.html#a855">MiWaitForForkToComplete</a> (CurrentProcess);
01797         <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (CloneBlock, CurrentProcess);
01798         MutexReleased = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01799     }
01800 
01801     CloneBlock-&gt;CloneRefCount -= 1;
01802     NewCount = CloneBlock-&gt;CloneRefCount;
01803 
01804     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NewCount &gt;= 0);
01805 
01806     <span class="keywordflow">if</span> (NewCount == 0) {
01807         CloneContents = CloneBlock-&gt;ProtoPte;
01808     } <span class="keywordflow">else</span> {
01809         CloneContents = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
01810     }
01811 
01812     <span class="keywordflow">if</span> ((NewCount == 0) &amp;&amp; (CloneContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0)) {
01813 
01814         <span class="comment">//</span>
01815         <span class="comment">// The last reference to a fork prototype PTE</span>
01816         <span class="comment">// has been removed.  Deallocate any page file</span>
01817         <span class="comment">// space and the transition page, if any.</span>
01818         <span class="comment">//</span>
01819 
01820 
01821         <span class="comment">//</span>
01822         <span class="comment">// Assert that the page is no longer valid.</span>
01823         <span class="comment">//</span>
01824 
01825         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CloneContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
01826 
01827         <span class="comment">//</span>
01828         <span class="comment">// Assert that the PTE is not in subsection format (doesn't point</span>
01829         <span class="comment">// to a file).</span>
01830         <span class="comment">//</span>
01831 
01832         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CloneContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0);
01833 
01834         <span class="keywordflow">if</span> (CloneContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
01835 
01836             <span class="comment">//</span>
01837             <span class="comment">// Prototype PTE in transition, put the page</span>
01838             <span class="comment">// on the free list.</span>
01839             <span class="comment">//</span>
01840 
01841             Pfn3 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (CloneContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
01842             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn3);
01843 
01844             <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn3-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01845 
01846             <span class="comment">//</span>
01847             <span class="comment">// Check the reference count for the page, if the reference</span>
01848             <span class="comment">// count is zero and the page is not on the freelist,</span>
01849             <span class="comment">// move the page to the free list, if the reference</span>
01850             <span class="comment">// count is not zero, ignore this page.</span>
01851             <span class="comment">// When the reference count goes to zero, it will be placed on the</span>
01852             <span class="comment">// free list.</span>
01853             <span class="comment">//</span>
01854 
01855             <span class="keywordflow">if</span> ((Pfn3-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) &amp;&amp;
01856                 (Pfn3-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>)) {
01857 
01858                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn3);
01859                 <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn3-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01860                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
01861                              <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>(&amp;CloneContents));
01862             }
01863         } <span class="keywordflow">else</span> {
01864 
01865             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a171">IS_PTE_NOT_DEMAND_ZERO</a> (CloneContents)) {
01866                 <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (CloneContents);
01867             }
01868         }
01869     }
01870 
01871     <span class="comment">//</span>
01872     <span class="comment">// Decrement the number of references to the</span>
01873     <span class="comment">// clone descriptor.</span>
01874     <span class="comment">//</span>
01875 
01876     CloneDescriptor-&gt;NumberOfReferences -= 1;
01877 
01878     <span class="keywordflow">if</span> (CloneDescriptor-&gt;NumberOfReferences == 0) {
01879 
01880         <span class="comment">//</span>
01881         <span class="comment">// There are no longer any PTEs in this process which refer</span>
01882         <span class="comment">// to the fork prototype PTEs for this clone descriptor.</span>
01883         <span class="comment">// Remove the CloneDescriptor and decrement the CloneHeader</span>
01884         <span class="comment">// number of process's reference count.</span>
01885         <span class="comment">//</span>
01886 
01887         CloneDescriptor-&gt;CloneHeader-&gt;NumberOfProcessReferences -= 1;
01888 
01889         <a class="code" href="../../d4/d8/mi_8h.html#a103">MiRemoveClone</a> (CloneDescriptor);
01890 
01891         <span class="keywordflow">if</span> (CloneDescriptor-&gt;CloneHeader-&gt;NumberOfProcessReferences == 0) {
01892 
01893             <span class="comment">//</span>
01894             <span class="comment">// There are no more processes pointing to this fork header</span>
01895             <span class="comment">// blow it away.</span>
01896             <span class="comment">//</span>
01897 
01898             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01899 
01900             <span class="comment">//</span>
01901             <span class="comment">// The working set lock may have been acquired safely or unsafely</span>
01902             <span class="comment">// by our caller.  Handle both cases here and below.</span>
01903             <span class="comment">//</span>
01904 
01905             <a class="code" href="../../d4/d8/mi_8h.html#a164">UNLOCK_WS_REGARDLESS</a> (CurrentProcess, WsHeldSafe);
01906 
01907             MutexReleased = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01908 
01909 
01910 <span class="preprocessor">#if DBG</span>
01911 <span class="preprocessor"></span>            {
01912 
01913             ULONG i;
01914             <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a> OldCloneBlock;
01915 
01916             OldCloneBlock = CloneDescriptor-&gt;CloneHeader-&gt;ClonePtes;
01917             <span class="keywordflow">for</span> (i = 0; i &lt; CloneDescriptor-&gt;CloneHeader-&gt;NumberOfPtes; i += 1) {
01918                 <span class="keywordflow">if</span> (OldCloneBlock-&gt;<a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html#o1">CloneRefCount</a> != 0) {
01919                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"fork block with non zero ref count %lx %lx %lx\n"</span>,
01920                         OldCloneBlock, CloneDescriptor,
01921                         CloneDescriptor-&gt;CloneHeader);
01922                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT, 1, 0, 0, 0);
01923                 }
01924             }
01925 
01926             <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a69">MM_DBG_FORK</a>) {
01927                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"removing clone header at address %lx\n"</span>,
01928                         CloneDescriptor-&gt;CloneHeader);
01929             }
01930 
01931             }
01932 <span class="preprocessor">#endif //DBG</span>
01933 <span class="preprocessor"></span>
01934             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CloneDescriptor-&gt;CloneHeader-&gt;ClonePtes);
01935 
01936             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CloneDescriptor-&gt;CloneHeader);
01937 
01938             <span class="comment">//</span>
01939             <span class="comment">// The working set lock may have been acquired safely or unsafely</span>
01940             <span class="comment">// by our caller.  Reacquire it in the same manner our caller did.</span>
01941             <span class="comment">//</span>
01942 
01943             <a class="code" href="../../d4/d8/mi_8h.html#a165">LOCK_WS_REGARDLESS</a> (CurrentProcess, WsHeldSafe);
01944 
01945             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01946         }
01947 
01948 <span class="preprocessor">#if DBG</span>
01949 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a69">MM_DBG_FORK</a>) {
01950           <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"removing clone descriptor at address %lx\n"</span>,CloneDescriptor);
01951         }
01952 <span class="preprocessor">#endif //DBG</span>
01953 <span class="preprocessor"></span>
01954         <span class="comment">//</span>
01955         <span class="comment">// Return the pool for the global structures referenced by the</span>
01956         <span class="comment">// clone descriptor.</span>
01957         <span class="comment">//</span>
01958 
01959         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01960 
01961         <span class="keywordflow">if</span> (CurrentProcess-&gt;ForkWasSuccessful == <a class="code" href="../../d8/d6/forksup_8c.html#a0">MM_FORK_SUCCEEDED</a>) {
01962 
01963             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess,
01964                                <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01965                                CloneDescriptor-&gt;PagedPoolQuotaCharge);
01966     
01967             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess,
01968                                <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01969                                <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html">MMCLONE_HEADER</a>));
01970         }
01971 
01972         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CloneDescriptor);
01973         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01974     }
01975 
01976     <span class="keywordflow">return</span> MutexReleased;
01977 }
01978 
01979 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01980"></a><a class="code" href="../../d4/d8/mi_8h.html#a855">01980</a> <a class="code" href="../../d4/d8/mi_8h.html#a855">MiWaitForForkToComplete</a> (
01981     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
01982     )
01983 
01984 <span class="comment">/*++</span>
01985 <span class="comment"></span>
01986 <span class="comment">Routine Description:</span>
01987 <span class="comment"></span>
01988 <span class="comment">    This routine waits for the current process to complete a fork</span>
01989 <span class="comment">    operation.</span>
01990 <span class="comment"></span>
01991 <span class="comment">Arguments:</span>
01992 <span class="comment"></span>
01993 <span class="comment">    CurrentProcess - Supplies the current process value.</span>
01994 <span class="comment"></span>
01995 <span class="comment">Return Value:</span>
01996 <span class="comment"></span>
01997 <span class="comment">    None.</span>
01998 <span class="comment"></span>
01999 <span class="comment">Environment:</span>
02000 <span class="comment"></span>
02001 <span class="comment">    Kernel mode, APCs disabled, working set mutex and PFN mutex held.</span>
02002 <span class="comment"></span>
02003 <span class="comment">--*/</span>
02004 
02005 {
02006     ULONG OldIrql;
02007     LOGICAL WsHeldSafe;
02008 
02009     <span class="comment">//</span>
02010     <span class="comment">// A fork operation is in progress and the count of clone-blocks</span>
02011     <span class="comment">// and other structures may not be changed.  Release the mutexes</span>
02012     <span class="comment">// and wait for the address creation mutex which governs the</span>
02013     <span class="comment">// fork operation.</span>
02014     <span class="comment">//</span>
02015 
02016     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
02017 
02018     <span class="comment">//</span>
02019     <span class="comment">// The working set mutex may have been acquired safely or unsafely</span>
02020     <span class="comment">// by our caller.  Handle both cases here and below, carefully making sure</span>
02021     <span class="comment">// that the OldIrql left in the WS mutex on return is the same as on entry.</span>
02022     <span class="comment">//</span>
02023 
02024     OldIrql = CurrentProcess-&gt;WorkingSetLock.OldIrql;
02025 
02026     <a class="code" href="../../d4/d8/mi_8h.html#a164">UNLOCK_WS_REGARDLESS</a> (CurrentProcess, WsHeldSafe);
02027 
02028     <span class="comment">//</span>
02029     <span class="comment">// Explicitly acquire the working set lock safely as it may be released and</span>
02030     <span class="comment">// reacquired by our caller.</span>
02031     <span class="comment">//</span>
02032 
02033     <a class="code" href="../../d4/d8/mi_8h.html#a160">LOCK_ADDRESS_SPACE</a> (CurrentProcess);
02034 
02035     <span class="comment">//</span>
02036     <span class="comment">// The working set lock may have been acquired safely or unsafely</span>
02037     <span class="comment">// by our caller.  Reacquire it in the same manner our caller did.</span>
02038     <span class="comment">//</span>
02039 
02040     <a class="code" href="../../d4/d8/mi_8h.html#a165">LOCK_WS_REGARDLESS</a> (CurrentProcess, WsHeldSafe);
02041 
02042     <span class="comment">//</span>
02043     <span class="comment">// Release the address creation mutex, the working set mutex</span>
02044     <span class="comment">// must be held to set the ForkInProgress field.</span>
02045     <span class="comment">//</span>
02046 
02047     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (CurrentProcess);
02048 
02049     <span class="comment">//</span>
02050     <span class="comment">// Ensure the previous IRQL is correctly set to its entry value.</span>
02051     <span class="comment">//</span>
02052 
02053     CurrentProcess-&gt;WorkingSetLock.OldIrql = OldIrql;
02054 
02055     <span class="comment">//</span>
02056     <span class="comment">// Get the PFN lock again.</span>
02057     <span class="comment">//</span>
02058 
02059     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02060     <span class="keywordflow">return</span>;
02061 }
02062 <span class="preprocessor">#if DBG</span>
02063 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02064 CloneTreeWalk (
02065     <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a> Start
02066     )
02067 
02068 {
02069     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
02070     <a class="code" href="../../d4/d8/mi_8h.html#a848">NodeTreeWalk</a> ( (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;CloneRoot));
02071     <span class="keywordflow">return</span>;
02072 }
02073 <span class="preprocessor">#endif //DBG</span>
02074 <span class="preprocessor"></span>
02075 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02076"></a><a class="code" href="../../d8/d6/forksup_8c.html#a2">02076</a> <a class="code" href="../../d8/d6/forksup_8c.html#a2">MiUpPfnReferenceCount</a> (
02077     IN PFN_NUMBER Page,
02078     IN USHORT Count
02079     )
02080 
02081     <span class="comment">// non paged helper routine.</span>
02082 
02083 {
02084     KIRQL OldIrql;
02085     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02086 
02087     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Page);
02088     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02089     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
02090     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02091     <span class="keywordflow">return</span>;
02092 }
02093 
02094 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02095"></a><a class="code" href="../../d8/d6/forksup_8c.html#a3">02095</a> <a class="code" href="../../d8/d6/forksup_8c.html#a3">MiDownPfnReferenceCount</a> (
02096     IN PFN_NUMBER Page,
02097     IN USHORT Count
02098     )
02099 
02100     <span class="comment">// non paged helper routine.</span>
02101 
02102 {
02103     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i;
02104     KIRQL OldIrql;
02105 
02106     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02107     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>; i += 1) {
02108         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (Page);
02109     }
02110     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02111     <span class="keywordflow">return</span>;
02112 }
02113 
02114 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02115"></a><a class="code" href="../../d8/d6/forksup_8c.html#a4">02115</a> <a class="code" href="../../d8/d6/forksup_8c.html#a4">MiUpControlAreaRefs</a> (
02116     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea
02117     )
02118 
02119 {
02120     KIRQL OldIrql;
02121 
02122     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02123 
02124     ControlArea-&gt;NumberOfMappedViews += 1;
02125     ControlArea-&gt;NumberOfUserReferences += 1;
02126 
02127     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02128     <span class="keywordflow">return</span>;
02129 }
02130 
02131 
02132 ULONG
<a name="l02133"></a><a class="code" href="../../d8/d6/forksup_8c.html#a5">02133</a> <a class="code" href="../../d8/d6/forksup_8c.html#a5">MiDoneWithThisPageGetAnother</a> (
02134     IN PPFN_NUMBER PageFrameIndex,
02135     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde,
02136     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
02137     )
02138 
02139 {
02140     KIRQL OldIrql;
02141     ULONG ReleasedMutex;
02142 
02143     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02144 
02145     <span class="keywordflow">if</span> (*PageFrameIndex != (PFN_NUMBER)-1) {
02146 
02147         <span class="comment">//</span>
02148         <span class="comment">// Decrement the share count of the last page which</span>
02149         <span class="comment">// we operated on.</span>
02150         <span class="comment">//</span>
02151 
02152         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (*PageFrameIndex);
02153     }
02154 
02155     ReleasedMutex =
02156                   <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (
02157                                         CurrentProcess,
02158                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02159 
02160     *PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (
02161                    <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (PointerPde,
02162                                               &amp;CurrentProcess-&gt;NextPageColor));
02163 
02164     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02165     <span class="keywordflow">return</span> ReleasedMutex;
02166 }
02167 
02168 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02169"></a><a class="code" href="../../d8/d6/forksup_8c.html#a7">02169</a> <a class="code" href="../../d8/d6/forksup_8c.html#a7">MiUpCloneProcessRefCount</a> (
02170     IN <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a> Clone
02171     )
02172 {
02173     KIRQL OldIrql;
02174 
02175     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02176 
02177     Clone-&gt;CloneHeader-&gt;NumberOfProcessReferences += 1;
02178 
02179     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02180     <span class="keywordflow">return</span>;
02181 }
02182 
02183 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02184"></a><a class="code" href="../../d8/d6/forksup_8c.html#a8">02184</a> <a class="code" href="../../d8/d6/forksup_8c.html#a8">MiUpCloneProtoRefCount</a> (
02185     IN <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a> CloneProto,
02186     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
02187     )
02188 
02189 {
02190     KIRQL OldIrql;
02191 
02192     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02193 
02194     <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (CloneProto,
02195                                    CurrentProcess);
02196 
02197     CloneProto-&gt;CloneRefCount += 1;
02198 
02199     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02200     <span class="keywordflow">return</span>;
02201 }
02202 
02203 ULONG
<a name="l02204"></a><a class="code" href="../../d8/d6/forksup_8c.html#a9">02204</a> <a class="code" href="../../d8/d6/forksup_8c.html#a9">MiHandleForkTransitionPte</a> (
02205     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
02206     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerNewPte,
02207     IN <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a> ForkProtoPte
02208     )
02209 
02210 {
02211     KIRQL OldIrql;
02212     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
02213     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
02214     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ContainingPte;
02215     PFN_NUMBER PageTablePage;
02216     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02217     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnForkPtePage;
02218 
02219 
02220     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02221 
02222     <span class="comment">//</span>
02223     <span class="comment">// Now that we have the PFN mutex which prevents pages from</span>
02224     <span class="comment">// leaving the transition state, examine the PTE again to</span>
02225     <span class="comment">// ensure that it is still transition.</span>
02226     <span class="comment">//</span>
02227 
02228     PteContents = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)PointerPte;
02229 
02230     <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 0) ||
02231         (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1)) {
02232 
02233         <span class="comment">//</span>
02234         <span class="comment">// The PTE is no longer in transition... do this</span>
02235         <span class="comment">// loop again.</span>
02236         <span class="comment">//</span>
02237 
02238         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02239         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02240 
02241     } <span class="keywordflow">else</span> {
02242 
02243         <span class="comment">//</span>
02244         <span class="comment">// The PTE is still in transition, handle like a</span>
02245         <span class="comment">// valid PTE.</span>
02246         <span class="comment">//</span>
02247 
02248         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
02249 
02250         <span class="comment">//</span>
02251         <span class="comment">// Assertion that PTE is not in prototype PTE format.</span>
02252         <span class="comment">//</span>
02253 
02254         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte != 1);
02255 
02256         <span class="comment">//</span>
02257         <span class="comment">// This is a private page in transition state,</span>
02258         <span class="comment">// create a fork prototype PTE</span>
02259         <span class="comment">// which becomes the "prototype" PTE for this page.</span>
02260         <span class="comment">//</span>
02261 
02262         ForkProtoPte-&gt;ProtoPte = PteContents;
02263 
02264         <span class="comment">//</span>
02265         <span class="comment">// Make the protection write-copy if writable.</span>
02266         <span class="comment">//</span>
02267 
02268         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a174">MI_MAKE_PROTECT_WRITE_COPY</a> (ForkProtoPte-&gt;ProtoPte);
02269 
02270         ForkProtoPte-&gt;CloneRefCount = 2;
02271 
02272         <span class="comment">//</span>
02273         <span class="comment">// Transform the PFN element to reference this new fork</span>
02274         <span class="comment">// prototype PTE.</span>
02275         <span class="comment">//</span>
02276 
02277         <span class="comment">//</span>
02278         <span class="comment">// Decrement the share count for the page table</span>
02279         <span class="comment">// page which contains the PTE as it is no longer</span>
02280         <span class="comment">// valid or in transition.</span>
02281         <span class="comment">//</span>
02282         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = &amp;ForkProtoPte-&gt;ProtoPte;
02283         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte = 1;
02284 
02285         <span class="comment">//</span>
02286         <span class="comment">// Make original PTE copy on write.</span>
02287         <span class="comment">//</span>
02288 
02289         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a174">MI_MAKE_PROTECT_WRITE_COPY</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
02290 
02291         ContainingPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(&amp;ForkProtoPte-&gt;ProtoPte);
02292 
02293         <span class="keywordflow">if</span> (ContainingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
02294 <span class="preprocessor">#if !defined (_WIN64)</span>
02295 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d8/mi_8h.html#a836">MiCheckPdeForPagedPool</a> (&amp;ForkProtoPte-&gt;ProtoPte))) {
02296 <span class="preprocessor">#endif</span>
02297 <span class="preprocessor"></span>                <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
02298                               0x61940, 
02299                               (ULONG_PTR)&amp;ForkProtoPte-&gt;ProtoPte,
02300                               (ULONG_PTR)ContainingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
02301                               (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(&amp;ForkProtoPte-&gt;ProtoPte));
02302 <span class="preprocessor">#if !defined (_WIN64)</span>
02303 <span class="preprocessor"></span>            }
02304 <span class="preprocessor">#endif</span>
02305 <span class="preprocessor"></span>        }
02306 
02307         PageTablePage = Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>;
02308 
02309         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (ContainingPte);
02310 
02311         <span class="comment">//</span>
02312         <span class="comment">// Increment the share count for the page containing</span>
02313         <span class="comment">// the fork prototype PTEs as we have just placed</span>
02314         <span class="comment">// a transition PTE into the page.</span>
02315         <span class="comment">//</span>
02316 
02317         PfnForkPtePage = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (
02318                         ContainingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber );
02319 
02320         PfnForkPtePage-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
02321 
02322         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long =
02323                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
02324         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Proto.Prototype = 1;
02325         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
02326         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerNewPte, TempPte);
02327 
02328         <span class="comment">//</span>
02329         <span class="comment">// Decrement the share count for the page table</span>
02330         <span class="comment">// page which contains the PTE as it is no longer</span>
02331         <span class="comment">// valid or in transition.</span>
02332         <span class="comment">//</span>
02333 
02334         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageTablePage);
02335     }
02336     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02337     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02338 }
02339 
02340 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02341"></a><a class="code" href="../../d8/d6/forksup_8c.html#a10">02341</a> <a class="code" href="../../d8/d6/forksup_8c.html#a10">MiDownShareCountFlushEntireTb</a> (
02342     IN PFN_NUMBER PageFrameIndex
02343     )
02344 
02345 {
02346     KIRQL OldIrql;
02347 
02348     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02349 
02350     <span class="keywordflow">if</span> (PageFrameIndex != (PFN_NUMBER)-1) {
02351 
02352         <span class="comment">//</span>
02353         <span class="comment">// Decrement the share count of the last page which</span>
02354         <span class="comment">// we operated on.</span>
02355         <span class="comment">//</span>
02356 
02357         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
02358     }
02359 
02360     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02361     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02362     <span class="keywordflow">return</span>;
02363 }
02364 
02365 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02366"></a><a class="code" href="../../d8/d6/forksup_8c.html#a6">02366</a> <a class="code" href="../../d8/d6/forksup_8c.html#a6">MiUpForkPageShareCount</a>(
02367     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnForkPtePage
02368     )
02369 {
02370     KIRQL OldIrql;
02371 
02372     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02373     PfnForkPtePage-&gt;u2.ShareCount += 1;
02374 
02375     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02376     <span class="keywordflow">return</span>;
02377 }
02378 
02379 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02380"></a><a class="code" href="../../d8/d6/forksup_8c.html#a11">02380</a> <a class="code" href="../../d8/d6/forksup_8c.html#a11">MiBuildForkPageTable</a>(
02381     IN PFN_NUMBER PageFrameIndex,
02382     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde,
02383     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerNewPde,
02384     IN PFN_NUMBER PdePhysicalPage,
02385     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnPdPage
02386     )
02387 {
02388     KIRQL OldIrql;
02389     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02390 
02391     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02392 
02393     <span class="comment">//</span>
02394     <span class="comment">// The PFN lock must be held while initializing the</span>
02395     <span class="comment">// frame to prevent those scanning the database for</span>
02396     <span class="comment">// free frames from taking it after we fill in the</span>
02397     <span class="comment">// u2 field.</span>
02398     <span class="comment">//</span>
02399 
02400     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02401 
02402     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a> = <a class="code" href="../../d4/d2/datalpha_8c.html#a9">DemandZeroPde</a>;
02403     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 1;
02404     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
02405     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPde;
02406     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
02407     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
02408     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PdePhysicalPage;
02409 
02410     <span class="comment">//</span>
02411     <span class="comment">// Increment the share count for the page containing</span>
02412     <span class="comment">// this PTE as the PTE is in transition.</span>
02413     <span class="comment">//</span>
02414 
02415     PfnPdPage-&gt;u2.ShareCount += 1;
02416 
02417     <span class="comment">//</span>
02418     <span class="comment">// Put the PDE into the transition state as it is not</span>
02419     <span class="comment">// really mapped and decrement share count does not</span>
02420     <span class="comment">// put private pages into transition, only prototypes.</span>
02421     <span class="comment">//</span>
02422 
02423     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerNewPde, <a class="code" href="../../d4/d2/datalpha_8c.html#a11">TransitionPde</a>);
02424 
02425     <span class="comment">//</span>
02426     <span class="comment">// Make the PTE owned by user mode.</span>
02427     <span class="comment">//</span>
02428 
02429 <span class="preprocessor">#ifndef _ALPHA_</span>
02430 <span class="preprocessor"></span>    <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a139">MI_SET_OWNER_IN_PTE</a> (PointerNewPde, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
02431 <span class="preprocessor">#endif //_ALPHA_</span>
02432 <span class="preprocessor"></span>    PointerNewPde-&gt;u.Trans.PageFrameNumber = PageFrameIndex;
02433 
02434     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02435 }
02436 
02437 <span class="preprocessor">#if defined (_X86PAE_)</span>
02438 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02439 <a class="code" href="../../d8/d6/forksup_8c.html#a12">MiRetrievePageDirectoryFrames</a>(
02440     IN PFN_NUMBER RootPhysicalPage,
02441     OUT PPFN_NUMBER PageDirectoryFrames
02442     )
02443 {
02444     ULONG i;
02445     KIRQL OldIrql;
02446     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02447 
02448     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (RootPhysicalPage, &amp;OldIrql);
02449 
02450     <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM; i += 1) {
02451         PageDirectoryFrames[i] = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
02452         PointerPte += 1;
02453     }
02454 
02455     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02456 
02457     <span class="keywordflow">return</span>;
02458 }
02459 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:03 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
