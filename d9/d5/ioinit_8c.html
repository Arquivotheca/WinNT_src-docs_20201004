<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ioinit.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ioinit.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>
<code>#include &lt;<a class="el" href="../../d4/d7/setupblk_8h-source.html">setupblk.h</a>&gt;</code><br>
<code>#include &lt;<a class="el" href="../../d1/d0/inbv_8h-source.html">inbv.h</a>&gt;</code><br>
<code>#include &lt;ntddstor.h&gt;</code><br>

<p>
<a href="../../d0/d5/ioinit_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">_TREE_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/struct__DRIVER__INFORMATION.html">_DRIVER_INFORMATION</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a0">DEFAULT_LARGE_IRP_LOCATIONS</a>&nbsp;&nbsp;&nbsp;8</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a1">DEFAULT_LOOKASIDE_IRP_LIMIT</a>&nbsp;&nbsp;&nbsp;512</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a2">InitializeDriverObject</a>(Object)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">_TREE_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a3">TREE_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">_TREE_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d9/struct__DRIVER__INFORMATION.html">_DRIVER_INFORMATION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a5">DRIVER_INFORMATION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d9/struct__DRIVER__INFORMATION.html">_DRIVER_INFORMATION</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a6">PDRIVER_INFORMATION</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a13">IopInitializeData</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a14">RawInitialize</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject, IN PUNICODE_STRING RegistryPath)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a15">IopCheckDependencies</a> (IN HANDLE KeyHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a16">IopCreateArcNames</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a17">IopCreateObjectTypes</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a18">IopCreateEntry</a> (IN PUNICODE_STRING GroupName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a19">IopCreateRootDirectories</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a20">IopFreeGroupTree</a> (IN <a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a> TreeEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a21">IopInitializeAttributesAndCreateObject</a> (IN PUNICODE_STRING ObjectName, IN OUT POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, OUT <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a22">IopInitializeBootDrivers</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock, OUT <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *PreviousDriver)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a23">IopInitializeBuiltinDriver</a> (IN PUNICODE_STRING DriverName, IN PUNICODE_STRING RegistryPath, IN <a class="el" href="../../d0/d5/io_8h.html#a284">PDRIVER_INITIALIZE</a> DriverInitializeRoutine, IN PLDR_DATA_TABLE_ENTRY TableEntry, IN BOOLEAN TextModeSetup)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a24">IopInitializeSingleBootDriver</a> (IN HANDLE KeyHandle, IN <a class="el" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">PBOOT_DRIVER_LIST_ENTRY</a> BootDriver, OUT PUNICODE_STRING DriverName OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a25">IopInitializeSystemDrivers</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a26">IopLookupGroupName</a> (IN PUNICODE_STRING GroupName, IN BOOLEAN Insert)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a27">IopMarkBootPartition</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a28">IopReassignSystemRoot</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock, OUT PSTRING NtDeviceName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a29">IopStoreSystemPartitionInformation</a> (IN PUNICODE_STRING NtSystemPartitionDeviceName, IN OUT PUNICODE_STRING OsLoaderPathName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a30">IopGetDriverTagPriority</a> (IN HANDLE Servicehandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a31">IopInsertDriverList</a> (IN PLIST_ENTRY ListHead, IN <a class="el" href="../../d2/d9/struct__DRIVER__INFORMATION.html">PDRIVER_INFORMATION</a> DriverInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a32">IopNotifySetupDevices</a> (<a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a33">IopWaitForBootDevicesStarted</a> (IN VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a34">IopWaitForBootDevicesDeleted</a> (IN VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a35">IopSetIoRoutines</a> (IN VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a36">IoInitSystem</a> (<a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a37">IopSetIoRoutines</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a38">IopFreeGroupTree</a> (<a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a> TreeEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a39">IopLogErrorEvent</a> (IN ULONG SequenceNumber, IN ULONG UniqueErrorValue, IN NTSTATUS FinalStatus, IN NTSTATUS SpecificIOStatus, IN ULONG LengthOfInsert1, IN PWCHAR Insert1, IN ULONG LengthOfInsert2, IN PWCHAR Insert2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a40">IopLoadBootFilterDriver</a> (IN PUNICODE_STRING DriverName, IN ULONG GroupIndex)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a7">IopGroupListHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a8">IopErrorLogObject</a> = NULL</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PLIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>GENERIC_MAPPING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a11">IopFileMapping</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>GENERIC_MAPPING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d5/ioinit_8c.html#a12">IopCompletionMapping</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="ioinit.c::DEFAULT_LARGE_IRP_LOCATIONS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEFAULT_LARGE_IRP_LOCATIONS&nbsp;&nbsp;&nbsp;8          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00037">37</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ioinit.c::DEFAULT_LOOKASIDE_IRP_LIMIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEFAULT_LOOKASIDE_IRP_LIMIT&nbsp;&nbsp;&nbsp;512          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00044">44</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ioinit.c::InitializeDriverObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define InitializeDriverObject          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Object&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                 \
    ULONG i;                                                               \
    RtlZeroMemory( Object,                                                 \
                   <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> ) + <span class="keyword">sizeof</span> ( <a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html">DRIVER_EXTENSION</a> )); \
    Object-&gt;DriverExtension = (<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html">PDRIVER_EXTENSION</a>) (Object + 1);            \
    Object-&gt;DriverExtension-&gt;DriverObject = Object;                        \
    <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d0/d5/io_8h.html#a42">IRP_MJ_MAXIMUM_FUNCTION</a>; i++)                         \
        Object-&gt;MajorFunction[i] = <a class="code" href="../../d2/d4/internal_8c.html#a45">IopInvalidDeviceRequest</a>;                \
    Object-&gt;Type = <a class="code" href="../../d0/d5/io_8h.html#a3">IO_TYPE_DRIVER</a>;                                         \
    Object-&gt;Size = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d5/io_8h.html#a345">DRIVER_OBJECT</a> );                                \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00088">88</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a5" doxytag="ioinit.c::DRIVER_INFORMATION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d9/struct__DRIVER__INFORMATION.html">_DRIVER_INFORMATION</a>  <a class="el" href="../../d2/d9/struct__DRIVER__INFORMATION.html">DRIVER_INFORMATION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ioinit.c::PDRIVER_INFORMATION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d9/struct__DRIVER__INFORMATION.html">_DRIVER_INFORMATION</a> * <a class="el" href="../../d2/d9/struct__DRIVER__INFORMATION.html">PDRIVER_INFORMATION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04267">IopInsertDriverList()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04654">IopLoadBootFilterDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ioinit.c::PTREE_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">_TREE_ENTRY</a> * <a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00978">IopCheckDependencies()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02107">IopCreateEntry()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03379">IopLookupGroupName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ioinit.c::TREE_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">_TREE_ENTRY</a>  <a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">TREE_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02107">IopCreateEntry()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a36" doxytag="ioinit.c::IoInitSystem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IoInitSystem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">270</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00184">CmRegistryMachineSystemCurrentControlSetServicesEventLog</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00345">_REINIT_PACKET::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01330">_DRIVER_EXTENSION::Count</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00037">DEFAULT_LARGE_IRP_LOCATIONS</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00044">DEFAULT_LOOKASIDE_IRP_LIMIT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00383">DNF_HAL_NODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00493">DNF_LEGACY_DRIVER</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01378">_DRIVER_OBJECT::DriverExtension</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00343">_REINIT_PACKET::DriverObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00344">_REINIT_PACKET::DriverReinitializationRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01303">DRVO_REINIT_REGISTERED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00330">_LINK_TRACKING_PACKET::Event</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d5/ex_2lookasid_8c-source.html#l00408">ExInitializeNPagedLookasideList()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00104">_IOP_HARD_ERROR_QUEUE::ExWorkItem</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01367">_DRIVER_OBJECT::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01555">HalInitPnpDriver</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d2/d7/hal_8h.html#a191">IoAssignDriveLetters()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00480">IOP_FIXED_SIZE_MDL_PFNS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a69">IOP_MINI_COMPLETION_PACKET</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00314">IopAddRemoteBootValuesToRegistry()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00121">IopBootDriverReinitializeQueueHead</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00034">IopCancelSpinLock</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00094">IopCdRomFileSystemQueueHead</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00196">IopCompletionLock</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00156">IopCompletionLookasideList</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02155">IopCreateRootDirectories()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00210">IopCurrentHardError</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00065">IopDatabaseResource</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00084">IopDiskFileSystemQueueHead</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00128">IopDriverReinitializeQueueHead</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00049">IopErrorLogAllocationLock</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00079">IopErrorLogDisabledThisBoot</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00178">IopErrorLogListHead</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00048">IopErrorLogLock</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02223">IopFreeGroupTree()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00144">IopFsNotifyChangeQueueHead</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00070">IopGroupListHead</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00203">IopHardError</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02977">IopHardErrorThread()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00041">IopInitHalDeviceNode</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00066">IopInitializeResourceMap()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00157">IopLargeIrpLookasideList</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00112">IopLargeIrpStackLocations</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00303">IopLinkTrackingPacket</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00302">IopLinkTrackingPortObject</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00346">IopLinkTrackingServiceEvent</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00719">IopLoaderBlock</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00547">IopLookasideIrpLimit</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00159">IopMdlLookasideList</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00104">IopNetworkFileSystemQueueHead</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00136">IopNotifyLastChanceShutdownQueueHead</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00135">IopNotifyShutdownQueueHead</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00074">IopProfileChangeSemaphore</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00053">IopProtectSystemPartition()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00659">IopQueryFsOperationAccess</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00613">IopQueryFsOperationLength</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00511">IopQueryOperationAccess</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00358">IopQueryOperationLength</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03612">IopReassignSystemRoot()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00337">IopRegistrySemaphore</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00074">IopSecurityResource</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00682">IopSetFsOperationAccess</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00636">IopSetFsOperationLength</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00953">IopSetIoRoutines()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00562">IopSetOperationAccess</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00409">IopSetOperationLength</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00158">IopSmallIrpLookasideList</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00770">IopStartNetworkForRemoteBoot()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00114">IopTapeFileSystemQueueHead</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00224">IopTimer</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07182">IopTimerDispatch()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00223">IopTimerDpc</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00050">IopTimerLock</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00222">IopTimerQueueHead</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00280">IopUniqueDeviceObjectNumber</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00042">IopVpbSpinLock</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04577">IoRemoteBootClient</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02592">IoStatisticsLock</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00039">KeInitializeDpc()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00039">KeInitializeSemaphore()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00075">KeInitializeTimerEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00285">KeSetTimerEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02782">KiProcessorBlock</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00755">_NPAGED_LOOKASIDE_LIST::L</a>, <a class="el" href="../../d5/d8/ex_8h.html#a331a203">LookasideCompletionList</a>, <a class="el" href="../../d5/d8/ex_8h.html#a331a198">LookasideLargeIrpList</a>, <a class="el" href="../../d5/d8/ex_8h.html#a331a199">LookasideMdlList</a>, <a class="el" href="../../d5/d8/ex_8h.html#a331a197">LookasideSmallIrpList</a>, <a class="el" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l03087">MmIsThisAnNtAsSystem()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a166">MmMediumSystem</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l03073">MmQuerySystemSize()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a104">NPAGED_LOOKASIDE_LIST</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00180">NtCreateEvent()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00028">NtSystemRoot</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d2/po_8h.html#a59">PoInitDriverServices()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00525">PsLocateSystemDll()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00136">RtlAllocateStringRoutine</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00246">RtlUnicodeStringToAnsiString()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00108">_IOP_HARD_ERROR_QUEUE::ThreadStarted</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d0/d5/io_8h.html#a576">WMIInitialize()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00105">_IOP_HARD_ERROR_QUEUE::WorkQueue</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00107">_IOP_HARD_ERROR_QUEUE::WorkQueueSemaphore</a>, and <a class="el" href="../../d1/d5/iop_8h-source.html#l00106">_IOP_HARD_ERROR_QUEUE::WorkQueueSpinLock</a>.
<p>
<pre class="fragment"><div>00276                    :
00277 
00278     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system.
00279 
00280 Arguments:
00281 
00282     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader parameter block that was
00283         created by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS Loader.
00284 
00285 Return Value:
00286 
00287     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a BOOLEAN indicating whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system
00288     was successfully initialized.
00289 
00290 --*/
00291 
00292 {
00293     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
00294     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *nextDriverObject;
00295     STRING ntDeviceName;
00296     UCHAR deviceNameBuffer[256];
00297     ULONG largePacketSize;
00298     ULONG smallPacketSize;
00299     ULONG mdlPacketSize;
00300     ULONG numberOfPackets;
00301     ULONG poolSize;
00302     PLIST_ENTRY entry;
00303     <a class="code" href="../../d5/d3/struct__REINIT__PACKET.html">PREINIT_PACKET</a> reinitEntry;
00304     LARGE_INTEGER deltaTime;
00305     <a class="code" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a> systemSize;
00306     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> completionZoneSize;
00307     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> largeIrpZoneSize;
00308     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> smallIrpZoneSize;
00309     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> mdlZoneSize;
00310     ULONG oldNtGlobalFlag;
00311     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00312     ANSI_STRING ansiString;
00313     UNICODE_STRING eventName;
00314     UNICODE_STRING startTypeName;
00315     OBJECT_ATTRIBUTES objectAttributes;
00316     HANDLE handle;
00317     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00318     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> lookaside;
00319     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00320     PKPRCB prcb;
00321     ULONG len;
00322     PKEY_VALUE_PARTIAL_INFORMATION value;
00323     UCHAR   valueBuffer[32];
00324 
00325     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IopQueryOperationLength[FileMaximumInformation] == 0xff );
00326     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IopSetOperationLength[FileMaximumInformation] == 0xff );
00327     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IopQueryOperationAccess[FileMaximumInformation] == 0xffffffff );
00328     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IopSetOperationAccess[FileMaximumInformation] == 0xffffffff );
00329 
00330     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IopQueryFsOperationLength[FileFsMaximumInformation] == 0xff );
00331     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IopSetFsOperationLength[FileFsMaximumInformation] == 0xff );
00332     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IopQueryFsOperationAccess[FileFsMaximumInformation] == 0xffffffff );
00333     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IopSetFsOperationAccess[FileFsMaximumInformation] == 0xffffffff );
00334 
00335     <span class="comment">//</span>
00336     <span class="comment">// Initialize the I/O database resource, lock, and the file system and</span>
00337     <span class="comment">// network file system queue headers.  Also allocate the cancel spin</span>
00338     <span class="comment">// lock.</span>
00339     <span class="comment">//</span>
00340 
00341     ntDeviceName.Buffer = deviceNameBuffer;
00342     ntDeviceName.MaximumLength = <span class="keyword">sizeof</span>(deviceNameBuffer);
00343     ntDeviceName.Length = 0;
00344 
00345     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( &amp;IopDatabaseResource );
00346     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( &amp;IopSecurityResource );
00347     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;IopDatabaseLock );
00348     InitializeListHead( &amp;IopDiskFileSystemQueueHead );
00349     InitializeListHead( &amp;IopCdRomFileSystemQueueHead );
00350     InitializeListHead( &amp;IopTapeFileSystemQueueHead );
00351     InitializeListHead( &amp;IopNetworkFileSystemQueueHead );
00352     InitializeListHead( &amp;IopBootDriverReinitializeQueueHead );
00353     InitializeListHead( &amp;IopDriverReinitializeQueueHead );
00354     InitializeListHead( &amp;IopNotifyShutdownQueueHead );
00355     InitializeListHead( &amp;IopNotifyLastChanceShutdownQueueHead );
00356     InitializeListHead( &amp;IopFsNotifyChangeQueueHead );
00357     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;IopCancelSpinLock );
00358     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;IopVpbSpinLock );
00359     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;IoStatisticsLock );
00360 
00361     <a class="code" href="../../d9/d5/ioinit_8c.html#a37">IopSetIoRoutines</a>();
00362     <span class="comment">//</span>
00363     <span class="comment">// Initialize the unique device object number counter used by IoCreateDevice</span>
00364     <span class="comment">// when automatically generating a device object name.</span>
00365     <span class="comment">//</span>
00366     <a class="code" href="../../d3/d5/iodata_8c.html#a50">IopUniqueDeviceObjectNumber</a> = 0;
00367 
00368     <span class="comment">//</span>
00369     <span class="comment">// Initialize the large I/O Request Packet (IRP) lookaside list head and the</span>
00370     <span class="comment">// mutex which guards the list.</span>
00371     <span class="comment">//</span>
00372 
00373     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d0/cmdat3_8c.html#a56">IopLargeIrpStackLocations</a>) {
00374         <a class="code" href="../../d8/d0/cmdat3_8c.html#a56">IopLargeIrpStackLocations</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a0">DEFAULT_LARGE_IRP_LOCATIONS</a>;
00375     }
00376 
00377     systemSize = <a class="code" href="../../d5/d1/mminit_8c.html#a57">MmQuerySystemSize</a>();
00378 
00379     <span class="keywordflow">switch</span> ( systemSize ) {
00380 
00381     <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a> :
00382         completionZoneSize = 6;
00383         smallIrpZoneSize = 6;
00384         largeIrpZoneSize = 8;
00385         mdlZoneSize = 16;
00386         <a class="code" href="../../d0/d6/iop_8h.html#a131">IopLookasideIrpLimit</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a1">DEFAULT_LOOKASIDE_IRP_LIMIT</a>;
00387         <span class="keywordflow">break</span>;
00388 
00389     <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a166">MmMediumSystem</a> :
00390         completionZoneSize = 24;
00391         smallIrpZoneSize = 24;
00392         largeIrpZoneSize = 32;
00393         mdlZoneSize = 90;
00394         <a class="code" href="../../d0/d6/iop_8h.html#a131">IopLookasideIrpLimit</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a1">DEFAULT_LOOKASIDE_IRP_LIMIT</a> * 2;
00395         <span class="keywordflow">break</span>;
00396 
00397     <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a> :
00398         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/mminit_8c.html#a58">MmIsThisAnNtAsSystem</a>()) {
00399             completionZoneSize = 96;
00400             smallIrpZoneSize = 96;
00401             largeIrpZoneSize = 128;
00402             mdlZoneSize = 256;
00403             <a class="code" href="../../d0/d6/iop_8h.html#a131">IopLookasideIrpLimit</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a1">DEFAULT_LOOKASIDE_IRP_LIMIT</a> * 4;
00404 
00405         } <span class="keywordflow">else</span> {
00406             completionZoneSize = 32;
00407             smallIrpZoneSize = 32;
00408             largeIrpZoneSize = 64;
00409             mdlZoneSize = 128;
00410             <a class="code" href="../../d0/d6/iop_8h.html#a131">IopLookasideIrpLimit</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a1">DEFAULT_LOOKASIDE_IRP_LIMIT</a> * 3;
00411         }
00412 
00413         <span class="keywordflow">break</span>;
00414     }
00415 
00416     <span class="comment">//</span>
00417     <span class="comment">// Initialize the system I/O completion lookaside list.</span>
00418     <span class="comment">//</span>
00419 
00420     <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;IopCompletionLookasideList,
00421                                      NULL,
00422                                      NULL,
00423                                      0,
00424                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d0/struct__IOP__MINI__COMPLETION__PACKET.html">IOP_MINI_COMPLETION_PACKET</a>),
00425                                      ' pcI',
00426                                      completionZoneSize );
00427 
00428     <span class="comment">//</span>
00429     <span class="comment">// Initialize the system large IRP lookaside list.</span>
00430     <span class="comment">//</span>
00431 
00432     largePacketSize = (ULONG) (<span class="keyword">sizeof</span>( <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> ) + (<a class="code" href="../../d8/d0/cmdat3_8c.html#a56">IopLargeIrpStackLocations</a> * <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> )));
00433     <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;IopLargeIrpLookasideList,
00434                                      NULL,
00435                                      NULL,
00436                                      0,
00437                                      largePacketSize,
00438                                      'lprI',
00439                                      largeIrpZoneSize );
00440 
00441     <span class="comment">//</span>
00442     <span class="comment">// Initialize the system small IRP lookaside list.</span>
00443     <span class="comment">//</span>
00444 
00445     smallPacketSize = (ULONG) (<span class="keyword">sizeof</span>( <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> ) + <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> ));
00446     <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;IopSmallIrpLookasideList,
00447                                      NULL,
00448                                      NULL,
00449                                      0,
00450                                      smallPacketSize,
00451                                      'sprI',
00452                                      smallIrpZoneSize );
00453 
00454     <span class="comment">//</span>
00455     <span class="comment">// Initialize the system MDL lookaside list.</span>
00456     <span class="comment">//</span>
00457 
00458     mdlPacketSize = (ULONG) (<span class="keyword">sizeof</span>( <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> ) + (<a class="code" href="../../d0/d6/iop_8h.html#a12">IOP_FIXED_SIZE_MDL_PFNS</a> * <span class="keyword">sizeof</span>( PFN_NUMBER )));
00459     <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;IopMdlLookasideList,
00460                                      NULL,
00461                                      NULL,
00462                                      0,
00463                                      mdlPacketSize,
00464                                      ' ldM',
00465                                      mdlZoneSize );
00466 
00467     <span class="comment">//</span>
00468     <span class="comment">// Initialize the per processor nonpaged lookaside lists and descriptors.</span>
00469     <span class="comment">//</span>
00470 
00471     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00472         prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00473 
00474         <span class="comment">//</span>
00475         <span class="comment">// Initialize the I/O completion per processor lookaside pointers</span>
00476         <span class="comment">//</span>
00477 
00478         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a203">LookasideCompletionList</a>].L = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a15">IopCompletionLookasideList</a>;
00479         lookaside = (<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool,
00480                                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>),
00481                                                                    'PpcI');
00482 
00483         <span class="keywordflow">if</span> (lookaside != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00484             <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( lookaside,
00485                                              NULL,
00486                                              NULL,
00487                                              0,
00488                                              <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d0/struct__IOP__MINI__COMPLETION__PACKET.html">IOP_MINI_COMPLETION_PACKET</a>),
00489                                              'PpcI',
00490                                              completionZoneSize );
00491 
00492         } <span class="keywordflow">else</span> {
00493             lookaside = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a15">IopCompletionLookasideList</a>;
00494         }
00495 
00496         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a203">LookasideCompletionList</a>].P = lookaside;
00497 
00498         <span class="comment">//</span>
00499         <span class="comment">// Initialize the large IRP per processor lookaside pointers.</span>
00500         <span class="comment">//</span>
00501 
00502         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a198">LookasideLargeIrpList</a>].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a> = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a16">IopLargeIrpLookasideList</a>;
00503         lookaside = (<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool,
00504                                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>),
00505                                                                    'LprI');
00506 
00507         <span class="keywordflow">if</span> (lookaside != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00508             <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( lookaside,
00509                                              NULL,
00510                                              NULL,
00511                                              0,
00512                                              largePacketSize,
00513                                              'LprI',
00514                                              largeIrpZoneSize );
00515 
00516         } <span class="keywordflow">else</span> {
00517             lookaside = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a16">IopLargeIrpLookasideList</a>;
00518         }
00519 
00520         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a198">LookasideLargeIrpList</a>].P = lookaside;
00521 
00522         <span class="comment">//</span>
00523         <span class="comment">// Initialize the small IRP per processor lookaside pointers.</span>
00524         <span class="comment">//</span>
00525 
00526         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a197">LookasideSmallIrpList</a>].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a> = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a17">IopSmallIrpLookasideList</a>;
00527         lookaside = (<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool,
00528                                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>),
00529                                                                    'SprI');
00530 
00531         <span class="keywordflow">if</span> (lookaside != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00532             <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( lookaside,
00533                                              NULL,
00534                                              NULL,
00535                                              0,
00536                                              smallPacketSize,
00537                                              'SprI',
00538                                              smallIrpZoneSize);
00539 
00540         } <span class="keywordflow">else</span> {
00541             lookaside = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a17">IopSmallIrpLookasideList</a>;
00542         }
00543 
00544         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a197">LookasideSmallIrpList</a>].P = lookaside;
00545 
00546         <span class="comment">//</span>
00547         <span class="comment">// Initialize the MDL per processor lookaside list pointers.</span>
00548         <span class="comment">//</span>
00549 
00550         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a199">LookasideMdlList</a>].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a> = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a18">IopMdlLookasideList</a>;
00551         lookaside = (<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool,
00552                                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>),
00553                                                                    'PldM');
00554 
00555         <span class="keywordflow">if</span> (lookaside != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00556             <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( lookaside,
00557                                              NULL,
00558                                              NULL,
00559                                              0,
00560                                              mdlPacketSize,
00561                                              'PldM',
00562                                              mdlZoneSize );
00563 
00564         } <span class="keywordflow">else</span> {
00565             lookaside = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a18">IopMdlLookasideList</a>;
00566         }
00567 
00568         prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a199">LookasideMdlList</a>].P = lookaside;
00569     }
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">// Initialize the I/O completion spin lock.</span>
00573     <span class="comment">//</span>
00574 
00575     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;IopCompletionLock );
00576 
00577     <span class="comment">//</span>
00578     <span class="comment">// Initalize the error log spin locks and log list.</span>
00579     <span class="comment">//</span>
00580 
00581     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;IopErrorLogLock );
00582     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;IopErrorLogAllocationLock );
00583     InitializeListHead( &amp;IopErrorLogListHead );
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">// Determine if the Error Log service will ever run this boot.</span>
00587     <span class="comment">//</span>
00588     InitializeObjectAttributes (&amp;objectAttributes,
00589                                 &amp;CmRegistryMachineSystemCurrentControlSetServicesEventLog,
00590                                 OBJ_CASE_INSENSITIVE,
00591                                 (HANDLE) NULL,
00592                                 (PSECURITY_DESCRIPTOR) NULL );
00593 
00594     status = ZwOpenKey(&amp;handle,
00595                        KEY_READ,
00596                        &amp;objectAttributes
00597                        );
00598 
00599     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00600         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;startTypeName, L<span class="stringliteral">"Start"</span>);
00601         value = (PKEY_VALUE_PARTIAL_INFORMATION) valueBuffer;
00602         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a> (handle,
00603                                   &amp;startTypeName,
00604                                   KeyValuePartialInformation,
00605                                   valueBuffer,
00606                                   <span class="keyword">sizeof</span> (valueBuffer),
00607                                   &amp;len);
00608 
00609         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) &amp;&amp; (value-&gt;Type == REG_DWORD)) {
00610             <span class="keywordflow">if</span> (SERVICE_DISABLED == (*(PULONG) (value-&gt;Data))) {
00611                 <span class="comment">//</span>
00612                 <span class="comment">// We are disabled for this boot.</span>
00613                 <span class="comment">//</span>
00614                 <a class="code" href="../../d7/d7/errorlog_8c.html#a7">IopErrorLogDisabledThisBoot</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00615             } <span class="keywordflow">else</span> {
00616                 <a class="code" href="../../d7/d7/errorlog_8c.html#a7">IopErrorLogDisabledThisBoot</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00617             }
00618         } <span class="keywordflow">else</span> {
00619             <span class="comment">//</span>
00620             <span class="comment">// Didn't find the value so we are not enabled.</span>
00621             <span class="comment">//</span>
00622             <a class="code" href="../../d7/d7/errorlog_8c.html#a7">IopErrorLogDisabledThisBoot</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00623         }
00624     } <span class="keywordflow">else</span> {
00625         <span class="comment">//</span>
00626         <span class="comment">// Didn't find the key so we are not enabled</span>
00627         <span class="comment">//</span>
00628         <a class="code" href="../../d7/d7/errorlog_8c.html#a7">IopErrorLogDisabledThisBoot</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00629     }
00630 
00631     <span class="comment">//</span>
00632     <span class="comment">// Initialize the registry access semaphore.</span>
00633     <span class="comment">//</span>
00634 
00635     <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>( &amp;IopRegistrySemaphore, 1, 1 );
00636 
00637     <span class="comment">//</span>
00638     <span class="comment">// Initialize the timer database and start the timer DPC routine firing</span>
00639     <span class="comment">// so that drivers can use it during initialization.</span>
00640     <span class="comment">//</span>
00641 
00642     deltaTime.QuadPart = - 10 * 1000 * 1000;
00643 
00644     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;IopTimerLock );
00645     InitializeListHead( &amp;IopTimerQueueHead );
00646     <a class="code" href="../../d4/d1/dpcobj_8c.html#a1">KeInitializeDpc</a>( &amp;IopTimerDpc, IopTimerDispatch, NULL );
00647     <a class="code" href="../../d3/d2/timerobj_8c.html#a2">KeInitializeTimerEx</a>( &amp;IopTimer, SynchronizationTimer );
00648     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a>( &amp;IopTimer, deltaTime, 1000, &amp;IopTimerDpc );
00649 
00650     <span class="comment">//</span>
00651     <span class="comment">// Initialize the IopHardError structure used for informational pop-ups.</span>
00652     <span class="comment">//</span>
00653 
00654     <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o0">ExWorkItem</a>,
00655                           IopHardErrorThread,
00656                           NULL );
00657 
00658     InitializeListHead( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o1">WorkQueue</a> );
00659 
00660     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o2">WorkQueueSpinLock</a> );
00661 
00662     <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o3">WorkQueueSemaphore</a>,
00663                            0,
00664                            MAXLONG );
00665 
00666     <a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o4">ThreadStarted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00667 
00668     <a class="code" href="../../d3/d5/iodata_8c.html#a26">IopCurrentHardError</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00669 
00670     <span class="comment">//</span>
00671     <span class="comment">// Create the link tracking named event.</span>
00672     <span class="comment">//</span>
00673 
00674     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;eventName, L<span class="stringliteral">"\\Security\\TRKWKS_EVENT"</span> );
00675     InitializeObjectAttributes( &amp;objectAttributes,
00676                                 &amp;eventName,
00677                                 OBJ_PERMANENT,
00678                                 (HANDLE) NULL,
00679                                 (PSECURITY_DESCRIPTOR) NULL );
00680     status = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>( &amp;handle,
00681                             EVENT_ALL_ACCESS,
00682                             &amp;objectAttributes,
00683                             NotificationEvent,
00684                             FALSE );
00685     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00686 <span class="preprocessor">#if DBG</span>
00687 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: NtCreateEvent failed\n"</span> );
00688 <span class="preprocessor">#endif</span>
00689 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00690     }
00691 
00692     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( handle,
00693                                       0,
00694                                       ExEventObjectType,
00695                                       KernelMode,
00696                                       (PVOID *) &amp;IopLinkTrackingServiceEvent,
00697                                       NULL );
00698 
00699     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a53">IopLinkTrackingPacket</a>.<a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html#o1">Event</a>, NotificationEvent, FALSE );
00700     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;IopLinkTrackingPortObject, SynchronizationEvent, TRUE );
00701 
00702     <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(&amp;IopProfileChangeSemaphore, 1, 1) ;
00703 
00704     <span class="comment">//</span>
00705     <span class="comment">// Create all of the objects for the I/O system.</span>
00706     <span class="comment">//</span>
00707 
00708     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a17">IopCreateObjectTypes</a>()) {
00709 <span class="preprocessor">#if DBG</span>
00710 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: IopCreateObjectTypes failed\n"</span> );
00711 <span class="preprocessor">#endif</span>
00712 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00713     }
00714 
00715     <span class="comment">//</span>
00716     <span class="comment">// Create the root directories for the I/O system.</span>
00717     <span class="comment">//</span>
00718 
00719     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a19">IopCreateRootDirectories</a>()) {
00720 <span class="preprocessor">#if DBG</span>
00721 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: IopCreateRootDirectories failed\n"</span> );
00722 <span class="preprocessor">#endif</span>
00723 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00724     }
00725 
00726     <span class="comment">//</span>
00727     <span class="comment">// Initialize the resource map</span>
00728     <span class="comment">//</span>
00729 
00730     <a class="code" href="../../d1/d8/report_8c.html#a10">IopInitializeResourceMap</a> (LoaderBlock);
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">// Initialize PlugPlay services phase 0</span>
00734     <span class="comment">//</span>
00735 
00736     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a237">IopInitializePlugPlayServices</a>(LoaderBlock, 0);
00737     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00738         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00739     }
00740 
00741     <span class="comment">//</span>
00742     <span class="comment">// Call Power manager to initialize for drivers</span>
00743     <span class="comment">//</span>
00744 
00745     <a class="code" href="../../d1/d2/po_8h.html#a59">PoInitDriverServices</a>(0);
00746 
00747     <span class="comment">//</span>
00748     <span class="comment">// Call HAL to initialize PnP bus driver</span>
00749     <span class="comment">//</span>
00750 
00751     <a class="code" href="../../d2/d7/hal_8h.html#a31">HalInitPnpDriver</a>();
00752     deviceNode = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00753     <span class="keywordflow">while</span> (deviceNode) {
00754         <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) &amp;&amp;
00755             !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>)) {
00756             <a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a> = deviceNode;
00757             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a7">DNF_HAL_NODE</a>;
00758             <span class="keywordflow">break</span>;
00759         }
00760         deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00761     }
00762 
00763     <span class="comment">//</span>
00764     <span class="comment">// Call WMI to initialize it and allow it to create its driver object</span>
00765     <span class="comment">// Note that no calls to WMI can occur until it is initialized here.</span>
00766     <span class="comment">//</span>
00767 
00768     <a class="code" href="../../d0/d5/io_8h.html#a576">WMIInitialize</a>();
00769 
00770     <span class="comment">//</span>
00771     <span class="comment">// Save this for use during PnP enumeration -- we NULL it out later</span>
00772     <span class="comment">// before LoaderBlock is reused.</span>
00773     <span class="comment">//</span>
00774 
00775     <a class="code" href="../../d3/d5/iodata_8c.html#a73">IopLoaderBlock</a> = (PVOID)LoaderBlock;
00776 
00777     <span class="comment">//</span>
00778     <span class="comment">// If this is a remote boot, we need to add a few values to the registry.</span>
00779     <span class="comment">//</span>
00780 
00781     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a399">IoRemoteBootClient</a>) {
00782         status = <a class="code" href="../../d4/d6/netboot_8c.html#a10">IopAddRemoteBootValuesToRegistry</a>(LoaderBlock);
00783         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00784             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( NETWORK_BOOT_INITIALIZATION_FAILED,
00785                           1,
00786                           status,
00787                           0,
00788                           0 );
00789         }
00790     }
00791 
00792     <span class="comment">//</span>
00793     <span class="comment">// Initialize PlugPlay services phase 1 to execute firmware mapper</span>
00794     <span class="comment">//</span>
00795 
00796     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a237">IopInitializePlugPlayServices</a>(LoaderBlock, 1);
00797     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00798         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00799     }
00800 
00801     <span class="comment">//</span>
00802     <span class="comment">// Initialize the drivers loaded by the boot loader (OSLOADER)</span>
00803     <span class="comment">//</span>
00804 
00805     nextDriverObject = &amp;driverObject;
00806     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a22">IopInitializeBootDrivers</a>( LoaderBlock,
00807                                    nextDriverObject )) {
00808 <span class="preprocessor">#if DBG</span>
00809 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: Initializing boot drivers failed\n"</span> );
00810 <span class="preprocessor">#endif // DBG</span>
00811 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00812     }
00813 
00814     <span class="comment">//</span>
00815     <span class="comment">// Once we have initialized the boot drivers, we don't need the</span>
00816     <span class="comment">// copy of the pointer to the loader block any more.</span>
00817     <span class="comment">//</span>
00818 
00819     <a class="code" href="../../d3/d5/iodata_8c.html#a73">IopLoaderBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00820 
00821     <span class="comment">//</span>
00822     <span class="comment">// If this is a remote boot, start the network and assign</span>
00823     <span class="comment">// C: to \Device\LanmanRedirector.</span>
00824     <span class="comment">//</span>
00825 
00826     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a399">IoRemoteBootClient</a>) {
00827         status = <a class="code" href="../../d4/d6/netboot_8c.html#a11">IopStartNetworkForRemoteBoot</a>(LoaderBlock);
00828         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00829             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( NETWORK_BOOT_INITIALIZATION_FAILED,
00830                           2,
00831                           status,
00832                           0,
00833                           0 );
00834         }
00835     }
00836 
00837     <span class="comment">//</span>
00838     <span class="comment">// Save the current value of the NT Global Flags and enable kernel debugger</span>
00839     <span class="comment">// symbol loading while drivers are being loaded so that systems can be</span>
00840     <span class="comment">// debugged regardless of whether they are free or checked builds.</span>
00841     <span class="comment">//</span>
00842 
00843     oldNtGlobalFlag = <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a>;
00844 
00845     <span class="keywordflow">if</span> (!(<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_KDEBUG_SYMBOL_LOAD)) {
00846         <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> |= FLG_ENABLE_KDEBUG_SYMBOL_LOAD;
00847     }
00848 
00849     status = <a class="code" href="../../d0/d1/psinit_8c.html#a44">PsLocateSystemDll</a>();
00850     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00851         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00852     }
00853 
00854     <span class="comment">//</span>
00855     <span class="comment">// Initialize the device drivers for the system.</span>
00856     <span class="comment">//</span>
00857 
00858     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a25">IopInitializeSystemDrivers</a>()) {
00859 <span class="preprocessor">#if DBG</span>
00860 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: Initializing system drivers failed\n"</span> );
00861 <span class="preprocessor">#endif // DBG</span>
00862 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00863     }
00864 
00865     <span class="comment">//</span>
00866     <span class="comment">// Free the memory allocated to contain the group dependency list.</span>
00867     <span class="comment">//</span>
00868 
00869     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a7">IopGroupListHead</a>) {
00870         <a class="code" href="../../d9/d5/ioinit_8c.html#a38">IopFreeGroupTree</a>( IopGroupListHead );
00871     }
00872 
00873     <span class="comment">//</span>
00874     <span class="comment">// Walk the list of drivers that have requested that they be called again</span>
00875     <span class="comment">// for reinitialization purposes.</span>
00876     <span class="comment">//</span>
00877 
00878     <span class="keywordflow">while</span> (entry = <a class="code" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList</a>( &amp;IopDriverReinitializeQueueHead, &amp;IopDatabaseLock )) {
00879         reinitEntry = CONTAINING_RECORD( entry, <a class="code" href="../../d5/d3/struct__REINIT__PACKET.html">REINIT_PACKET</a>, ListEntry );
00880         reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o2">Count</a>++;
00881         reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a146">DRVO_REINIT_REGISTERED</a>;
00882         reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o2">DriverReinitializationRoutine</a>( reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>,
00883                                                     reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o3">Context</a>,
00884                                                     reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o2">Count</a> );
00885         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( reinitEntry );
00886     }
00887 
00888     <span class="comment">//</span>
00889     <span class="comment">// Reassign \SystemRoot to NT device name path.</span>
00890     <span class="comment">//</span>
00891 
00892     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a28">IopReassignSystemRoot</a>( LoaderBlock, &amp;ntDeviceName )) {
00893         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00894     }
00895 
00896     <span class="comment">//</span>
00897     <span class="comment">// Protect the system partition of an ARC system if necessary</span>
00898     <span class="comment">//</span>
00899 
00900     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a201">IopProtectSystemPartition</a>( LoaderBlock )) {
00901         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00902     }
00903 
00904     <span class="comment">//</span>
00905     <span class="comment">// Assign DOS drive letters to disks and cdroms and define \SystemRoot.</span>
00906     <span class="comment">//</span>
00907 
00908     ansiString.MaximumLength = <a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>.MaximumLength / <span class="keyword">sizeof</span>( WCHAR );
00909     ansiString.Length = 0;
00910     ansiString.Buffer = (<a class="code" href="../../d8/d2/ldrinit_8c.html#a7">RtlAllocateStringRoutine</a>)( ansiString.MaximumLength );
00911     status = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;ansiString,
00912                                            &amp;NtSystemRoot,
00913                                            FALSE
00914                                          );
00915     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00916         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: UnicodeToAnsi( %wZ ) failed - %x\n"</span>, &amp;NtSystemRoot, status );
00917         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00918     }
00919 
00920     <a class="code" href="../../d2/d7/hal_8h.html#a191">IoAssignDriveLetters</a>( LoaderBlock,
00921                           &amp;ntDeviceName,
00922                           ansiString.Buffer,
00923                           &amp;ansiString );
00924 
00925     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;NtSystemRoot,
00926                                            &amp;ansiString,
00927                                            FALSE
00928                                          );
00929     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00930         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: AnsiToUnicode( %Z ) failed - %x\n"</span>, &amp;ansiString, status );
00931         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00932     }
00933 
00934     <span class="comment">//</span>
00935     <span class="comment">// Also restore the NT Global Flags to their original state.</span>
00936     <span class="comment">//</span>
00937 
00938     <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> = oldNtGlobalFlag;
00939 
00940     <span class="comment">//</span>
00941     <span class="comment">// Call Power manager to initialize for post-boot drivers</span>
00942     <span class="comment">//</span>
00943     <a class="code" href="../../d1/d2/po_8h.html#a59">PoInitDriverServices</a>(1);
00944 
00945     <span class="comment">//</span>
00946     <span class="comment">// Indicate that the I/O system successfully initialized itself.</span>
00947     <span class="comment">//</span>
00948 
00949     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00950 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="ioinit.c::IopCheckDependencies" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopCheckDependencies           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00978">978</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00056">_TREE_ENTRY::DriversLoaded</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03379">IopLookupGroupName()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>.
<p>
<pre class="fragment"><div>00984                    :
00985 
00986     This routine gets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"DependOnGroup"</span> field <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified key node
00987     and determines whether any driver in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group(s) that this entry is
00988     dependent on has successfully loaded.
00989 
00990 Arguments:
00991 
00992     KeyHandle - Supplies a handle to the key representing the driver in
00993         question.
00994 
00995 Return Value:
00996 
00997     The function value is TRUE if the driver should be loaded, otherwise
00998     FALSE
00999 
01000 --*/
01001 
01002 {
01003     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01004     UNICODE_STRING groupName;
01005     BOOLEAN load;
01006     ULONG length;
01007     PWSTR source;
01008     <a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a> treeEntry;
01009 
01010     <span class="comment">//</span>
01011     <span class="comment">// Attempt to obtain the "DependOnGroup" key for the specified driver</span>
01012     <span class="comment">// entry.  If one does not exist, then simply mark this driver as being</span>
01013     <span class="comment">// one to attempt to load.  If it does exist, then check to see whether</span>
01014     <span class="comment">// or not any driver in the groups that it is dependent on has loaded</span>
01015     <span class="comment">// and allow it to load.</span>
01016     <span class="comment">//</span>
01017 
01018     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle, L<span class="stringliteral">"DependOnGroup"</span>, &amp;keyValueInformation ))) {
01019         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01020     }
01021 
01022     length = keyValueInformation-&gt;DataLength;
01023 
01024     source = (PWSTR) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
01025     load = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01026 
01027     <span class="keywordflow">while</span> (length) {
01028         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;groupName, source );
01029         groupName.Length = groupName.MaximumLength;
01030         treeEntry = <a class="code" href="../../d9/d5/ioinit_8c.html#a26">IopLookupGroupName</a>( &amp;groupName, FALSE );
01031         <span class="keywordflow">if</span> (treeEntry) {
01032             <span class="keywordflow">if</span> (!treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o4">DriversLoaded</a>) {
01033                 load = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01034                 <span class="keywordflow">break</span>;
01035             }
01036         }
01037         length -= groupName.MaximumLength;
01038         source = (PWSTR) ((PUCHAR) source + groupName.MaximumLength);
01039     }
01040 
01041     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
01042     <span class="keywordflow">return</span> load;
01043 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="ioinit.c::IopCreateArcNames" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCreateArcNames           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01047">1047</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d2/d8/arc_8h-source.html#l01719">_ARC_DISK_SIGNATURE::ArcName</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01720">_ARC_DISK_SIGNATURE::CheckSum</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02549">_CONFIGURATION_INFORMATION::DiskCount</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01726">_ARC_DISK_INFORMATION::DiskSignatures</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01545">HalExamineMBR</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00735">IoArcBootDeviceName</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00736">IoArcHalDeviceName</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01933">IoBuildSynchronousFsdRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05675">IoCreateSymbolicLink()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06927">IoGetConfigurationInformation()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03419">IoGetDeviceInterfaces()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06998">IoGetDeviceObjectPointer()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00737">IoLoaderArcBootDeviceName</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03862">IopStoreSystemPartitionInformation()</a>, <a class="el" href="../../d2/d7/hal_8h.html#a192">IoReadPartitionTable()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04577">IoRemoteBootClient</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00058">IRP_MJ_READ</a>, <a class="el" href="../../d8/d2/i386init_8c-source.html#l00038">KeI386MachineType</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">max</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a179">NonPagedPoolCacheAlignedMustS</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00399">RtlEqualString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01718">_ARC_DISK_SIGNATURE::Signature</a>, <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a203">Suspended</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d8/arc_8h-source.html#l01721">_ARC_DISK_SIGNATURE::ValidPartitionTable</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>01053                    :
01054 
01055     The loader block contains a table of disk signatures and corresponding
01056     ARC names. Each device that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader can access will appear in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01057     table. This routine opens each disk device in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system, reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01058     signature and compares <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table. For each match, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> creates a
01059     symbolic link between <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> nt device name and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ARC name.
01060 
01061     The checksum value provided by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ULONG sum of all
01062     elements in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> checksum, inverted, plus 1:
01063     checksum = ~sum + 1;
01064     This way <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sum of all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> elements can be calculated here and
01065     added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> checksum in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader block.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero, then
01066     there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a match.
01067 
01068 Arguments:
01069 
01070     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader parameter block that was
01071         created by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS Loader.
01072 
01073 Return Value:
01074 
01075     None.
01076 
01077 --*/
01078 
01079 {
01080     STRING arcBootDeviceString;
01081     UCHAR deviceNameBuffer[128];
01082     STRING deviceNameString;
01083     UNICODE_STRING deviceNameUnicodeString;
01084     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
01085     UCHAR arcNameBuffer[128];
01086     STRING arcNameString;
01087     UNICODE_STRING arcNameUnicodeString;
01088     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
01089     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01090     IO_STATUS_BLOCK ioStatusBlock;
01091     DISK_GEOMETRY diskGeometry;
01092     PDRIVE_LAYOUT_INFORMATION driveLayout;
01093     PLIST_ENTRY listEntry;
01094     <a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html">PARC_DISK_SIGNATURE</a> diskBlock;
01095     ULONG diskNumber;
01096     ULONG partitionNumber;
01097     PCHAR arcName;
01098     PULONG buffer;
01099     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
01100     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
01101     LARGE_INTEGER offset;
01102     ULONG checkSum;
01103     ULONG i;
01104     PVOID tmpPtr;
01105     BOOLEAN useLegacyEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01106     BOOLEAN singleBiosDiskFound;
01107     BOOLEAN bootDiskFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01108     <a class="code" href="../../d2/d9/struct__ARC__DISK__INFORMATION.html">PARC_DISK_INFORMATION</a> arcInformation = LoaderBlock-&gt;ArcDiskInformation;
01109     ULONG totalDriverDisksFound = <a class="code" href="../../d4/d6/iosubs_8c.html#a69">IoGetConfigurationInformation</a>()-&gt;<a class="code" href="../../d6/d8/struct__CONFIGURATION__INFORMATION.html#o0">DiskCount</a>;
01110     ULONG totalPnpDisksFound = 0;
01111     STRING arcSystemDeviceString;
01112     STRING osLoaderPathString;
01113     UNICODE_STRING osLoaderPathUnicodeString;
01114     PWSTR diskList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01115     <span class="keywordtype">wchar_t</span> *pDiskNameList;
01116     STORAGE_DEVICE_NUMBER   pnpDiskDeviceNumber;
01117 
01118 
01119     <span class="comment">//</span>
01120     <span class="comment">// ask PNP to give us a list with all the currently active disks</span>
01121     <span class="comment">//</span>
01122 
01123     pDiskNameList = diskList;
01124     pnpDiskDeviceNumber.DeviceNumber = 0xFFFFFFFF;
01125     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a86">IoGetDeviceInterfaces</a>(&amp;DiskClassGuid, NULL, 0, &amp;diskList);
01126 
01127     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01128 
01129         useLegacyEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01130         <span class="keywordflow">if</span> (pDiskNameList) {
01131             *pDiskNameList = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01132         }
01133 
01134     } <span class="keywordflow">else</span> {
01135 
01136         <span class="comment">//</span>
01137         <span class="comment">// count the number of disks returned</span>
01138         <span class="comment">//</span>
01139 
01140         pDiskNameList = diskList;
01141         <span class="keywordflow">while</span> (*pDiskNameList != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) {
01142 
01143             totalPnpDisksFound++;
01144             pDiskNameList = pDiskNameList + (wcslen(pDiskNameList) + 1);
01145 
01146         }
01147 
01148         pDiskNameList = diskList;
01149 
01150         <span class="comment">//</span>
01151         <span class="comment">// if the disk returned by PNP are not all the disks in the system</span>
01152         <span class="comment">// it means that some legacy driver has generated a disk device object/link.</span>
01153         <span class="comment">// In that case we need to enumerate all pnp disks and then using the legacy</span>
01154         <span class="comment">// for-loop also enumerate the non-pnp disks</span>
01155         <span class="comment">//</span>
01156 
01157         <span class="keywordflow">if</span> (totalPnpDisksFound &lt; totalDriverDisksFound) {
01158             useLegacyEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01159         }
01160 
01161     }
01162 
01163     <span class="comment">//</span>
01164     <span class="comment">// If a single bios disk was found if there is only a</span>
01165     <span class="comment">// single entry on the disk signature list.</span>
01166     <span class="comment">//</span>
01167 
01168     singleBiosDiskFound = (arcInformation-&gt;<a class="code" href="../../d2/d9/struct__ARC__DISK__INFORMATION.html#o0">DiskSignatures</a>.Flink-&gt;Flink ==
01169                            &amp;arcInformation-&gt;<a class="code" href="../../d2/d9/struct__ARC__DISK__INFORMATION.html#o0">DiskSignatures</a>) ? (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) : (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01170 
01171 
01172     <span class="comment">//</span>
01173     <span class="comment">// Create hal/loader partition name</span>
01174     <span class="comment">//</span>
01175 
01176     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( arcNameBuffer, <span class="stringliteral">"\\ArcName\\%s"</span>, LoaderBlock-&gt;ArcHalDeviceName );
01177     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcNameString, arcNameBuffer );
01178     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a> (&amp;IoArcHalDeviceName, &amp;arcNameString, TRUE);
01179 
01180     <span class="comment">//</span>
01181     <span class="comment">// Create boot partition name</span>
01182     <span class="comment">//</span>
01183 
01184     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( arcNameBuffer, <span class="stringliteral">"\\ArcName\\%s"</span>, LoaderBlock-&gt;ArcBootDeviceName );
01185     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcNameString, arcNameBuffer );
01186     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a> (&amp;IoArcBootDeviceName, &amp;arcNameString, TRUE);
01187     i = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a> (LoaderBlock-&gt;ArcBootDeviceName) + 1;
01188     <a class="code" href="../../d3/d5/iodata_8c.html#a88">IoLoaderArcBootDeviceName</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (PagedPool, i);
01189     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a88">IoLoaderArcBootDeviceName</a>) {
01190         memcpy (IoLoaderArcBootDeviceName, LoaderBlock-&gt;ArcBootDeviceName, i);
01191     }
01192 
01193     <span class="keywordflow">if</span> (singleBiosDiskFound &amp;&amp; strstr(LoaderBlock-&gt;ArcBootDeviceName, <span class="stringliteral">"cdrom"</span>)) {
01194         singleBiosDiskFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01195     }
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">// Get ARC boot device name from loader block.</span>
01199     <span class="comment">//</span>
01200 
01201     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcBootDeviceString,
01202                        LoaderBlock-&gt;ArcBootDeviceName );
01203 
01204     <span class="comment">//</span>
01205     <span class="comment">// Get ARC system device name from loader block.</span>
01206     <span class="comment">//</span>
01207 
01208     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcSystemDeviceString,
01209                        LoaderBlock-&gt;ArcHalDeviceName );
01210 
01211     <span class="comment">//</span>
01212     <span class="comment">// If this is a remote boot, create an ArcName for the redirector path.</span>
01213     <span class="comment">//</span>
01214 
01215     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a399">IoRemoteBootClient</a>) {
01216 
01217         bootDiskFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01218 
01219         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;deviceNameString, <span class="stringliteral">"\\Device\\LanmanRedirector"</span> );
01220         status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;deviceNameUnicodeString,
01221                                                &amp;deviceNameString,
01222                                                TRUE );
01223 
01224         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01225 
01226             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( arcNameBuffer,
01227                      <span class="stringliteral">"\\ArcName\\%s"</span>,
01228                      LoaderBlock-&gt;ArcBootDeviceName );
01229             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcNameString, arcNameBuffer );
01230             status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;arcNameUnicodeString,
01231                                                    &amp;arcNameString,
01232                                                    TRUE );
01233             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01234 
01235                 <span class="comment">//</span>
01236                 <span class="comment">// Create symbolic link between NT device name and ARC name.</span>
01237                 <span class="comment">//</span>
01238 
01239                 <a class="code" href="../../d4/d6/iosubs_8c.html#a50">IoCreateSymbolicLink</a>( &amp;arcNameUnicodeString,
01240                                       &amp;deviceNameUnicodeString );
01241                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;arcNameUnicodeString );
01242 
01243                 <span class="comment">//</span>
01244                 <span class="comment">// We've found the system partition--store it away in the registry</span>
01245                 <span class="comment">// to later be transferred to a application-friendly location.</span>
01246                 <span class="comment">//</span>
01247                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;osLoaderPathString, LoaderBlock-&gt;NtHalPathName );
01248                 status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;osLoaderPathUnicodeString,
01249                                                        &amp;osLoaderPathString,
01250                                                        TRUE );
01251 
01252 <span class="preprocessor">#if DBG</span>
01253 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01254                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopCreateArcNames: couldn't allocate unicode string for OsLoader path - %x\n"</span>, status);
01255                 }
01256 <span class="preprocessor">#endif // DBG</span>
01257 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01258 
01259                     <a class="code" href="../../d9/d5/ioinit_8c.html#a29">IopStoreSystemPartitionInformation</a>( &amp;deviceNameUnicodeString,
01260                                                         &amp;osLoaderPathUnicodeString );
01261 
01262                     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;osLoaderPathUnicodeString );
01263                 }
01264             }
01265 
01266             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
01267         }
01268     }
01269 
01270     <span class="comment">//</span>
01271     <span class="comment">// For each disk in the system do the following:</span>
01272     <span class="comment">// 1. open the device</span>
01273     <span class="comment">// 2. get its geometry</span>
01274     <span class="comment">// 3. read the MBR</span>
01275     <span class="comment">// 4. determine ARC name via disk signature and checksum</span>
01276     <span class="comment">// 5. construct ARC name.</span>
01277     <span class="comment">// In order to deal with the case of disk dissappearing before we get to this point</span>
01278     <span class="comment">// (due to a failed start on one of many disks present in the system) we ask PNP for a list</span>
01279     <span class="comment">// of all the currenttly active disks in the system. If the number of disks returned is</span>
01280     <span class="comment">// less than the IoGetConfigurationInformation()-&gt;DiskCount, then we have legacy disks</span>
01281     <span class="comment">// that we need to enumerate in the for loop.</span>
01282     <span class="comment">// In the legacy case, the ending condition for the loop is NOT the total disk on the</span>
01283     <span class="comment">// system but an arbitrary number of the max total legacy disks expected in the system..</span>
01284     <span class="comment">// Additional note: Legacy disks get assigned symbolic links AFTER all pnp enumeration is complete</span>
01285     <span class="comment">//</span>
01286 
01287     totalDriverDisksFound = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(totalPnpDisksFound,totalDriverDisksFound);
01288 
01289     <span class="keywordflow">if</span> (useLegacyEnumeration &amp;&amp; (totalPnpDisksFound == 0)) {
01290 
01291         <span class="comment">//</span>
01292         <span class="comment">// search up to a maximum arbitrary number of legacy disks</span>
01293         <span class="comment">//</span>
01294 
01295         totalDriverDisksFound +=20;
01296     }
01297 
01298     <span class="keywordflow">for</span> (diskNumber = 0;
01299          diskNumber &lt; totalDriverDisksFound;
01300          diskNumber++) {
01301 
01302         <span class="comment">//</span>
01303         <span class="comment">// Construct the NT name for a disk and obtain a reference.</span>
01304         <span class="comment">//</span>
01305 
01306         <span class="keywordflow">if</span> (pDiskNameList &amp;&amp; (*pDiskNameList != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>)) {
01307 
01308             <span class="comment">//</span>
01309             <span class="comment">// retrieve the first symbolic linkname from the PNP disk list</span>
01310             <span class="comment">//</span>
01311 
01312             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;deviceNameUnicodeString, pDiskNameList);
01313             pDiskNameList = pDiskNameList + (wcslen(pDiskNameList) + 1);
01314 
01315             status = <a class="code" href="../../d4/d6/iosubs_8c.html#a71">IoGetDeviceObjectPointer</a>( &amp;deviceNameUnicodeString,
01316                                                FILE_READ_ATTRIBUTES,
01317                                                &amp;fileObject,
01318                                                &amp;deviceObject );
01319 
01320             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01321 
01322                 <span class="comment">//</span>
01323                 <span class="comment">// since PNP gave s just asym link we have to retrieve the actual</span>
01324                 <span class="comment">// disk number through an IOCTL call to the disk stack.</span>
01325                 <span class="comment">// Create IRP for get device number device control.</span>
01326                 <span class="comment">//</span>
01327 
01328                 irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( IOCTL_STORAGE_GET_DEVICE_NUMBER,
01329                                                      deviceObject,
01330                                                      NULL,
01331                                                      0,
01332                                                      &amp;pnpDiskDeviceNumber,
01333                                                      <span class="keyword">sizeof</span>(STORAGE_DEVICE_NUMBER),
01334                                                      FALSE,
01335                                                      &amp;event,
01336                                                      &amp;ioStatusBlock );
01337                 <span class="keywordflow">if</span> (!irp) {
01338                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01339                     <span class="keywordflow">continue</span>;
01340                 }
01341 
01342                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
01343                                    NotificationEvent,
01344                                    FALSE );
01345                 status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject,
01346                                        irp );
01347 
01348                 <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01349                     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
01350                                            Suspended,
01351                                            KernelMode,
01352                                            FALSE,
01353                                            NULL );
01354                     status = ioStatusBlock.Status;
01355                 }
01356 
01357                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01358                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01359                     <span class="keywordflow">continue</span>;
01360                 }
01361 
01362             }
01363 
01364             <span class="keywordflow">if</span> (useLegacyEnumeration &amp;&amp; (*pDiskNameList == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) ) {
01365 
01366                 <span class="comment">//</span>
01367                 <span class="comment">// end of pnp disks</span>
01368                 <span class="comment">// if there are any legacy disks following we need to update</span>
01369                 <span class="comment">// the total disk found number to cover the maximum disk number</span>
01370                 <span class="comment">// a legacy disk could be at. (in a sparse name space)</span>
01371                 <span class="comment">//</span>
01372 
01373                 <span class="keywordflow">if</span> (pnpDiskDeviceNumber.DeviceNumber == 0xFFFFFFFF) {
01374                     pnpDiskDeviceNumber.DeviceNumber = 0;
01375                 }
01376 
01377                 diskNumber = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(diskNumber,pnpDiskDeviceNumber.DeviceNumber);
01378                 totalDriverDisksFound = diskNumber + 20;
01379 
01380             }
01381 
01382         } <span class="keywordflow">else</span> {
01383 
01384             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
01385                      <span class="stringliteral">"\\Device\\Harddisk%d\\Partition0"</span>,
01386                      diskNumber );
01387             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;deviceNameString, deviceNameBuffer );
01388             status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;deviceNameUnicodeString,
01389                                                    &amp;deviceNameString,
01390                                                    TRUE );
01391             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01392                 <span class="keywordflow">continue</span>;
01393             }
01394 
01395             status = <a class="code" href="../../d4/d6/iosubs_8c.html#a71">IoGetDeviceObjectPointer</a>( &amp;deviceNameUnicodeString,
01396                                                FILE_READ_ATTRIBUTES,
01397                                                &amp;fileObject,
01398                                                &amp;deviceObject );
01399 
01400             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
01401 
01402             <span class="comment">//</span>
01403             <span class="comment">// set the pnpDiskNumber value so its not used.</span>
01404             <span class="comment">//</span>
01405 
01406             pnpDiskDeviceNumber.DeviceNumber = 0xFFFFFFFF;
01407 
01408         }
01409 
01410 
01411         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01412 
01413             <span class="keywordflow">continue</span>;
01414         }
01415 
01416         <span class="comment">//</span>
01417         <span class="comment">// Create IRP for get drive geometry device control.</span>
01418         <span class="comment">//</span>
01419 
01420         irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( IOCTL_DISK_GET_DRIVE_GEOMETRY,
01421                                              deviceObject,
01422                                              NULL,
01423                                              0,
01424                                              &amp;diskGeometry,
01425                                              <span class="keyword">sizeof</span>(DISK_GEOMETRY),
01426                                              FALSE,
01427                                              &amp;event,
01428                                              &amp;ioStatusBlock );
01429         <span class="keywordflow">if</span> (!irp) {
01430             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01431             <span class="keywordflow">continue</span>;
01432         }
01433 
01434         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
01435                            NotificationEvent,
01436                            FALSE );
01437         status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject,
01438                                irp );
01439 
01440         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01441             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
01442                                    Suspended,
01443                                    KernelMode,
01444                                    FALSE,
01445                                    NULL );
01446             status = ioStatusBlock.Status;
01447         }
01448 
01449         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01450             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01451             <span class="keywordflow">continue</span>;
01452         }
01453 
01454         <span class="comment">//</span>
01455         <span class="comment">// Get partition information for this disk.</span>
01456         <span class="comment">//</span>
01457 
01458         status = <a class="code" href="../../d2/d7/hal_8h.html#a192">IoReadPartitionTable</a>( deviceObject,
01459                                        diskGeometry.BytesPerSector,
01460                                        TRUE,
01461                                        &amp;driveLayout );
01462 
01463         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01464 
01465         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01466             <span class="keywordflow">continue</span>;
01467         }
01468 
01469         <span class="comment">//</span>
01470         <span class="comment">// Make sure sector size is at least 512 bytes.</span>
01471         <span class="comment">//</span>
01472 
01473         <span class="keywordflow">if</span> (diskGeometry.BytesPerSector &lt; 512) {
01474             diskGeometry.BytesPerSector = 512;
01475         }
01476 
01477         <span class="comment">//</span>
01478         <span class="comment">// Check to see if EZ Drive is out there on this disk.  If</span>
01479         <span class="comment">// it is then zero out the signature in the drive layout since</span>
01480         <span class="comment">// this will never be written by anyone AND change to offset to</span>
01481         <span class="comment">// actually read sector 1 rather than 0 cause that's what the</span>
01482         <span class="comment">// loader actually did.</span>
01483         <span class="comment">//</span>
01484 
01485         offset.QuadPart = 0;
01486         <a class="code" href="../../d2/d7/hal_8h.html#a23">HalExamineMBR</a>( deviceObject,
01487                        diskGeometry.BytesPerSector,
01488                        (ULONG)0x55,
01489                        &amp;tmpPtr );
01490 
01491         <span class="keywordflow">if</span> (tmpPtr) {
01492 
01493             offset.QuadPart = diskGeometry.BytesPerSector;
01494             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(tmpPtr);
01495 <span class="preprocessor">#ifdef _X86_</span>
01496 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/i386init_8c.html#a1">KeI386MachineType</a> &amp; MACHINE_TYPE_PC_9800_COMPATIBLE) {
01497 
01498             <span class="comment">//</span>
01499             <span class="comment">//  PC 9800 compatible machines do not have a standard</span>
01500             <span class="comment">//  MBR format and use a different sector for checksuming.</span>
01501             <span class="comment">//</span>
01502 
01503             offset.QuadPart = 512;
01504 <span class="preprocessor">#endif //_X86_</span>
01505 <span class="preprocessor"></span>        }
01506 
01507         <span class="comment">//</span>
01508         <span class="comment">// Allocate buffer for sector read and construct the read request.</span>
01509         <span class="comment">//</span>
01510 
01511         buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPoolCacheAlignedMustS,
01512                                  diskGeometry.BytesPerSector );
01513 
01514         <span class="keywordflow">if</span> (buffer) {
01515             irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a27">IoBuildSynchronousFsdRequest</a>( IRP_MJ_READ,
01516                                                 deviceObject,
01517                                                 buffer,
01518                                                 diskGeometry.BytesPerSector,
01519                                                 &amp;offset,
01520                                                 &amp;event,
01521                                                 &amp;ioStatusBlock );
01522 
01523             <span class="keywordflow">if</span> (!irp) {
01524                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(driveLayout);
01525                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
01526                 <span class="keywordflow">continue</span>;
01527             }
01528         } <span class="keywordflow">else</span> {
01529             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(driveLayout);
01530             <span class="keywordflow">continue</span>;
01531         }
01532         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
01533                            NotificationEvent,
01534                            FALSE );
01535         status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject,
01536                                irp );
01537         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01538             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
01539                                    Suspended,
01540                                    KernelMode,
01541                                    FALSE,
01542                                    NULL );
01543             status = ioStatusBlock.Status;
01544         }
01545 
01546         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01547             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(driveLayout);
01548             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
01549             <span class="keywordflow">continue</span>;
01550         }
01551 
01552         <span class="comment">//</span>
01553         <span class="comment">// Calculate MBR sector checksum.  Only 512 bytes are used.</span>
01554         <span class="comment">//</span>
01555 
01556         checkSum = 0;
01557         <span class="keywordflow">for</span> (i = 0; i &lt; 128; i++) {
01558             checkSum += buffer[i];
01559         }
01560 
01561         <span class="comment">//</span>
01562         <span class="comment">// For each ARC disk information record in the loader block</span>
01563         <span class="comment">// match the disk signature and checksum to determine its ARC</span>
01564         <span class="comment">// name and construct the NT ARC names symbolic links.</span>
01565         <span class="comment">//</span>
01566 
01567         <span class="keywordflow">for</span> (listEntry = arcInformation-&gt;<a class="code" href="../../d2/d9/struct__ARC__DISK__INFORMATION.html#o0">DiskSignatures</a>.Flink;
01568              listEntry != &amp;arcInformation-&gt;<a class="code" href="../../d2/d9/struct__ARC__DISK__INFORMATION.html#o0">DiskSignatures</a>;
01569              listEntry = listEntry-&gt;Flink) {
01570 
01571             <span class="comment">//</span>
01572             <span class="comment">// Get next record and compare disk signatures.</span>
01573             <span class="comment">//</span>
01574 
01575             diskBlock = CONTAINING_RECORD( listEntry,
01576                                            <a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html">ARC_DISK_SIGNATURE</a>,
01577                                            ListEntry );
01578 
01579             <span class="comment">//</span>
01580             <span class="comment">// Compare disk signatures.</span>
01581             <span class="comment">//</span>
01582             <span class="comment">// Or if there is only a single disk drive from</span>
01583             <span class="comment">// both the bios and driver viewpoints then</span>
01584             <span class="comment">// assign an arc name to that drive.</span>
01585             <span class="comment">//</span>
01586 
01587             <span class="keywordflow">if</span> ((singleBiosDiskFound &amp;&amp; (totalDriverDisksFound == 1)) ||
01588                 (diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o1">Signature</a> == driveLayout-&gt;Signature &amp;&amp;
01589                  !(diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o3">CheckSum</a> + checkSum) &amp;&amp;
01590                  diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o4">ValidPartitionTable</a>)) {
01591 
01592                 <span class="comment">//</span>
01593                 <span class="comment">// Create unicode device name for physical disk.</span>
01594                 <span class="comment">//</span>
01595 
01596                 <span class="keywordflow">if</span> (pnpDiskDeviceNumber.DeviceNumber == 0xFFFFFFFF) {
01597 
01598                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
01599                              <span class="stringliteral">"\\Device\\Harddisk%d\\Partition0"</span>,
01600                              diskNumber );
01601 
01602                 } <span class="keywordflow">else</span> {
01603 
01604                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
01605                              <span class="stringliteral">"\\Device\\Harddisk%d\\Partition0"</span>,
01606                              pnpDiskDeviceNumber.DeviceNumber );
01607 
01608                 }
01609 
01610                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;deviceNameString, deviceNameBuffer );
01611                 status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;deviceNameUnicodeString,
01612                                                        &amp;deviceNameString,
01613                                                        TRUE );
01614                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01615                     <span class="keywordflow">continue</span>;
01616                 }
01617 
01618                 <span class="comment">//</span>
01619                 <span class="comment">// Create unicode ARC name for this partition.</span>
01620                 <span class="comment">//</span>
01621 
01622                 arcName = diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o2">ArcName</a>;
01623                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( arcNameBuffer,
01624                          <span class="stringliteral">"\\ArcName\\%s"</span>,
01625                          arcName );
01626                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcNameString, arcNameBuffer );
01627                 status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;arcNameUnicodeString,
01628                                                        &amp;arcNameString,
01629                                                        TRUE );
01630                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01631                     <span class="keywordflow">continue</span>;
01632                 }
01633 
01634                 <span class="comment">//</span>
01635                 <span class="comment">// Create symbolic link between NT device name and ARC name.</span>
01636                 <span class="comment">//</span>
01637 
01638                 <a class="code" href="../../d4/d6/iosubs_8c.html#a50">IoCreateSymbolicLink</a>( &amp;arcNameUnicodeString,
01639                                       &amp;deviceNameUnicodeString );
01640                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;arcNameUnicodeString );
01641                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
01642 
01643                 <span class="comment">//</span>
01644                 <span class="comment">// Create an ARC name for every partition on this disk.</span>
01645                 <span class="comment">//</span>
01646 
01647                 <span class="keywordflow">for</span> (partitionNumber = 0;
01648                      partitionNumber &lt; driveLayout-&gt;PartitionCount;
01649                      partitionNumber++) {
01650 
01651                     <span class="comment">//</span>
01652                     <span class="comment">// Create unicode NT device name.</span>
01653                     <span class="comment">//</span>
01654 
01655                     <span class="keywordflow">if</span> (pnpDiskDeviceNumber.DeviceNumber == 0xFFFFFFFF) {
01656 
01657                         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
01658                                  <span class="stringliteral">"\\Device\\Harddisk%d\\Partition%d"</span>,
01659                                  diskNumber,
01660                                  partitionNumber+1 );
01661 
01662 
01663                     } <span class="keywordflow">else</span> {
01664 
01665                         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
01666                                  <span class="stringliteral">"\\Device\\Harddisk%d\\Partition%d"</span>,
01667                                  pnpDiskDeviceNumber.DeviceNumber,
01668                                  partitionNumber+1 );
01669 
01670                     }
01671 
01672                     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;deviceNameString, deviceNameBuffer );
01673                     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;deviceNameUnicodeString,
01674                                                            &amp;deviceNameString,
01675                                                            TRUE );
01676                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01677                         <span class="keywordflow">continue</span>;
01678                     }
01679 
01680                     <span class="comment">//</span>
01681                     <span class="comment">// Create unicode ARC name for this partition and</span>
01682                     <span class="comment">// check to see if this is the boot disk.</span>
01683                     <span class="comment">//</span>
01684 
01685                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( arcNameBuffer,
01686                              <span class="stringliteral">"%spartition(%d)"</span>,
01687                              arcName,
01688                              partitionNumber+1 );
01689                     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcNameString, arcNameBuffer );
01690                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a11">RtlEqualString</a>( &amp;arcNameString,
01691                                         &amp;arcBootDeviceString,
01692                                         TRUE )) {
01693                         bootDiskFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01694                     }
01695 
01696                     <span class="comment">//</span>
01697                     <span class="comment">// See if this is the system partition.</span>
01698                     <span class="comment">//</span>
01699                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a11">RtlEqualString</a>( &amp;arcNameString,
01700                                         &amp;arcSystemDeviceString,
01701                                         TRUE )) {
01702                         <span class="comment">//</span>
01703                         <span class="comment">// We've found the system partition--store it away in the registry</span>
01704                         <span class="comment">// to later be transferred to a application-friendly location.</span>
01705                         <span class="comment">//</span>
01706                         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;osLoaderPathString, LoaderBlock-&gt;NtHalPathName );
01707                         status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;osLoaderPathUnicodeString,
01708                                                                &amp;osLoaderPathString,
01709                                                                TRUE );
01710 
01711 <span class="preprocessor">#if DBG</span>
01712 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01713                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopCreateArcNames: couldn't allocate unicode string for OsLoader path - %x\n"</span>, status);
01714                         }
01715 <span class="preprocessor">#endif // DBG</span>
01716 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01717 
01718                             <a class="code" href="../../d9/d5/ioinit_8c.html#a29">IopStoreSystemPartitionInformation</a>( &amp;deviceNameUnicodeString,
01719                                                                 &amp;osLoaderPathUnicodeString );
01720 
01721                             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;osLoaderPathUnicodeString );
01722                         }
01723                     }
01724 
01725                     <span class="comment">//</span>
01726                     <span class="comment">// Add the NT ARC namespace prefix to the ARC name constructed.</span>
01727                     <span class="comment">//</span>
01728 
01729                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( arcNameBuffer,
01730                              <span class="stringliteral">"\\ArcName\\%spartition(%d)"</span>,
01731                              arcName,
01732                              partitionNumber+1 );
01733                     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcNameString, arcNameBuffer );
01734                     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;arcNameUnicodeString,
01735                                                            &amp;arcNameString,
01736                                                            TRUE );
01737                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01738                         <span class="keywordflow">continue</span>;
01739                     }
01740 
01741                     <span class="comment">//</span>
01742                     <span class="comment">// Create symbolic link between NT device name and ARC name.</span>
01743                     <span class="comment">//</span>
01744 
01745                     <a class="code" href="../../d4/d6/iosubs_8c.html#a50">IoCreateSymbolicLink</a>( &amp;arcNameUnicodeString,
01746                                           &amp;deviceNameUnicodeString );
01747                     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;arcNameUnicodeString );
01748                     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
01749                 }
01750 
01751             } <span class="keywordflow">else</span> {
01752 
01753 <span class="preprocessor">#if DBG</span>
01754 <span class="preprocessor"></span>                <span class="comment">//</span>
01755                 <span class="comment">// Check key indicators to see if this condition may be</span>
01756                 <span class="comment">// caused by a viral infection.</span>
01757                 <span class="comment">//</span>
01758 
01759                 <span class="keywordflow">if</span> (diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o1">Signature</a> == driveLayout-&gt;Signature &amp;&amp;
01760                     (diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o3">CheckSum</a> + checkSum) != 0 &amp;&amp;
01761                     diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o4">ValidPartitionTable</a>) {
01762                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopCreateArcNames: Virus or duplicate disk signatures\n"</span>);
01763                 }
01764 <span class="preprocessor">#endif</span>
01765 <span class="preprocessor"></span>            }
01766         }
01767 
01768         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( driveLayout );
01769         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( buffer );
01770     }
01771 
01772     <span class="keywordflow">if</span> (!bootDiskFound) {
01773 
01774         <span class="comment">//</span>
01775         <span class="comment">// Locate the disk block that represents the boot device.</span>
01776         <span class="comment">//</span>
01777 
01778         diskBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01779         <span class="keywordflow">for</span> (listEntry = arcInformation-&gt;<a class="code" href="../../d2/d9/struct__ARC__DISK__INFORMATION.html#o0">DiskSignatures</a>.Flink;
01780              listEntry != &amp;arcInformation-&gt;<a class="code" href="../../d2/d9/struct__ARC__DISK__INFORMATION.html#o0">DiskSignatures</a>;
01781              listEntry = listEntry-&gt;Flink) {
01782 
01783             diskBlock = CONTAINING_RECORD( listEntry,
01784                                            <a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html">ARC_DISK_SIGNATURE</a>,
01785                                            ListEntry );
01786             <span class="keywordflow">if</span> (strcmp( diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o2">ArcName</a>, LoaderBlock-&gt;ArcBootDeviceName ) == 0) {
01787                 <span class="keywordflow">break</span>;
01788             }
01789             diskBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01790         }
01791 
01792         <span class="keywordflow">if</span> (diskBlock) {
01793 
01794             <span class="comment">//</span>
01795             <span class="comment">// This could be a CdRom boot.  Search all of the NT CdRoms</span>
01796             <span class="comment">// to locate a checksum match on the diskBlock found.  If</span>
01797             <span class="comment">// there is a match, assign the ARC name to the CdRom.</span>
01798             <span class="comment">//</span>
01799 
01800             irp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01801             buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPoolCacheAlignedMustS,
01802                                      2048 );
01803             <span class="keywordflow">if</span> (buffer) {
01804 
01805                 <span class="comment">//</span>
01806                 <span class="comment">// Construct the NT names for CdRoms and search each one</span>
01807                 <span class="comment">// for a checksum match.  If found, create the ARC Name</span>
01808                 <span class="comment">// symbolic link.</span>
01809                 <span class="comment">//</span>
01810 
01811                 <span class="keywordflow">for</span> (diskNumber = 0; <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; diskNumber++) {
01812 
01813                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
01814                              <span class="stringliteral">"\\Device\\CdRom%d"</span>,
01815                              diskNumber );
01816 
01817                     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;deviceNameString, deviceNameBuffer );
01818                     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;deviceNameUnicodeString,
01819                                                            &amp;deviceNameString,
01820                                                            TRUE );
01821                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01822 
01823                         status = <a class="code" href="../../d4/d6/iosubs_8c.html#a71">IoGetDeviceObjectPointer</a>( &amp;deviceNameUnicodeString,
01824                                                            FILE_READ_ATTRIBUTES,
01825                                                            &amp;fileObject,
01826                                                            &amp;deviceObject );
01827                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01828 
01829                             <span class="comment">//</span>
01830                             <span class="comment">// All CdRoms have been processed.</span>
01831                             <span class="comment">//</span>
01832 
01833                             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
01834                             <span class="keywordflow">break</span>;
01835                         }
01836 
01837                         <span class="comment">//</span>
01838                         <span class="comment">// Read the block for the checksum calculation.</span>
01839                         <span class="comment">//</span>
01840 
01841                         offset.QuadPart = 0x8000;
01842                         irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a27">IoBuildSynchronousFsdRequest</a>( IRP_MJ_READ,
01843                                                             deviceObject,
01844                                                             buffer,
01845                                                             2048,
01846                                                             &amp;offset,
01847                                                             &amp;event,
01848                                                             &amp;ioStatusBlock );
01849                         checkSum = 0;
01850                         <span class="keywordflow">if</span> (irp) {
01851                             <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
01852                                                NotificationEvent,
01853                                                FALSE );
01854                             status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject,
01855                                                    irp );
01856                             <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01857                                 <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
01858                                                        Suspended,
01859                                                        KernelMode,
01860                                                        FALSE,
01861                                                        NULL );
01862                                 status = ioStatusBlock.Status;
01863                             }
01864 
01865                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01866 
01867                                 <span class="comment">//</span>
01868                                 <span class="comment">// Calculate MBR sector checksum.</span>
01869                                 <span class="comment">// 2048 bytes are used.</span>
01870                                 <span class="comment">//</span>
01871 
01872                                 <span class="keywordflow">for</span> (i = 0; i &lt; 2048 / <span class="keyword">sizeof</span>(ULONG) ; i++) {
01873                                     checkSum += buffer[i];
01874                                 }
01875                             }
01876                         }
01877                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01878 
01879                         <span class="keywordflow">if</span> (!(diskBlock-&gt;<a class="code" href="../../d3/d9/struct__ARC__DISK__SIGNATURE.html#o3">CheckSum</a> + checkSum)) {
01880 
01881                             <span class="comment">//</span>
01882                             <span class="comment">// This is the boot CdRom.  Create the symlink for</span>
01883                             <span class="comment">// the ARC name from the loader block.</span>
01884                             <span class="comment">//</span>
01885 
01886                             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( arcNameBuffer,
01887                                      <span class="stringliteral">"\\ArcName\\%s"</span>,
01888                                      LoaderBlock-&gt;ArcBootDeviceName );
01889                             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;arcNameString, arcNameBuffer );
01890                             status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;arcNameUnicodeString,
01891                                                                    &amp;arcNameString,
01892                                                                    TRUE );
01893                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01894 
01895                                 <a class="code" href="../../d4/d6/iosubs_8c.html#a50">IoCreateSymbolicLink</a>( &amp;arcNameUnicodeString,
01896                                                       &amp;deviceNameUnicodeString );
01897                                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;arcNameUnicodeString );
01898                             }
01899                             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
01900                             <span class="keywordflow">break</span>;
01901                         }
01902                         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
01903                     }
01904                 }
01905                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
01906             }
01907         }
01908     }
01909 
01910     <span class="keywordflow">if</span> (diskList) {
01911         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(diskList);
01912     }
01913 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="ioinit.c::IopCreateEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a> IopCreateEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>GroupName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02107">2107</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00057">_TREE_ENTRY::GroupName</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>, and <a class="el" href="../../d9/d5/ioinit_8c.html#a3">TREE_ENTRY</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03379">IopLookupGroupName()</a>.
<p>
<pre class="fragment"><div>02113                    :
02114 
02115     This routine creates an entry <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified group name suitable <span class="keywordflow">for</span>
02116     being inserted into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group name tree.
02117 
02118 Arguments:
02119 
02120     GroupName - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry.
02121 
02122 Return Value:
02123 
02124     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created entry.
02125 
02126 
02127 --*/
02128 
02129 {
02130     <a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a> treeEntry;
02131 
02132     <span class="comment">//</span>
02133     <span class="comment">// Allocate and initialize an entry suitable for placing into the group</span>
02134     <span class="comment">// name tree.</span>
02135     <span class="comment">//</span>
02136 
02137     treeEntry = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool,
02138                                 <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">TREE_ENTRY</a> ) + GroupName-&gt;Length );
02139     <span class="keywordflow">if</span> (!treeEntry) {
02140         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
02141     }
02142 
02143     RtlZeroMemory( treeEntry, <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">TREE_ENTRY</a> ) );
02144     treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>.Length = GroupName-&gt;Length;
02145     treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>.MaximumLength = GroupName-&gt;Length;
02146     treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>.Buffer = (PWCHAR) (treeEntry + 1);
02147     RtlCopyMemory( treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>.Buffer,
02148                    GroupName-&gt;Buffer,
02149                    GroupName-&gt;Length );
02150 
02151     <span class="keywordflow">return</span> treeEntry;
02152 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="ioinit.c::IopCreateObjectTypes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopCreateObjectTypes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">1936</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02615">IO_FILE_OBJECT_NON_PAGED_POOL_CHARGE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02616">IO_FILE_OBJECT_PAGED_POOL_CHARGE</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00232">IoAdapterObjectType</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00234">IoCompletionObjectType</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00233">IoControllerObjectType</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00239">IoDeviceHandlerObjectSize</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00237">IoDeviceHandlerObjectType</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00235">IoDeviceObjectType</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00236">IoDriverObjectType</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">IopCloseFile()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01925">IopCompletionMapping</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00769">IopDeleteDevice()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00698">IopDeleteDriver()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00864">IopDeleteIoCompletion()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01915">IopFileMapping</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">IopGetSetSecurityObject()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l01690">IopParseFile()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l01811">IopQueryName()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00107">OB_PARSE_METHOD</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00131">OB_QUERYNAME_METHOD</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00120">OB_SECURITY_METHOD</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>01942                    :
01943 
01944     This routine creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object types used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system and its
01945     components.  The object types created are:
01946 
01947         Adapter
01948         Controller
01949         Device
01950         Driver
01951         <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>
01952         I/O Completion
01953 
01954 Arguments:
01955 
01956     None.
01957 
01958 Return Value:
01959 
01960     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a BOOLEAN indicating whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
01961     types were successfully created.
01962 
01963 
01964 --*/
01965 
01966 {
01967     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> objectTypeInitializer;
01968     UNICODE_STRING nameString;
01969 
01970     <span class="comment">//</span>
01971     <span class="comment">// Initialize the common fields of the Object Type Initializer record</span>
01972     <span class="comment">//</span>
01973 
01974     RtlZeroMemory( &amp;objectTypeInitializer, <span class="keyword">sizeof</span>( objectTypeInitializer ) );
01975     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o0">Length</a> = <span class="keyword">sizeof</span>( objectTypeInitializer );
01976     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = OBJ_OPENLINK;
01977     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a11">IopFileMapping</a>;
01978     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
01979     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = FILE_ALL_ACCESS;
01980     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o1">UseDefaultObject</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01981 
01982 
01983     <span class="comment">//</span>
01984     <span class="comment">// Create the object type for adapter objects.</span>
01985     <span class="comment">//</span>
01986 
01987     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, L<span class="stringliteral">"Adapter"</span> );
01988     <span class="comment">// objectTypeInitializer.DefaultNonPagedPoolCharge = sizeof( struct _ADAPTER_OBJECT );</span>
01989     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;nameString,
01990                                       &amp;objectTypeInitializer,
01991                                       (PSECURITY_DESCRIPTOR) NULL,
01992                                       &amp;IoAdapterObjectType ))) {
01993         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01994     }
01995 
01996 <span class="preprocessor">#ifdef _PNP_POWER_</span>
01997 <span class="preprocessor"></span>
01998     <span class="comment">//</span>
01999     <span class="comment">// Create the object type for device helper objects.</span>
02000     <span class="comment">//</span>
02001 
02002     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, L<span class="stringliteral">"DeviceHandler"</span> );
02003     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;nameString,
02004                                       &amp;objectTypeInitializer,
02005                                       (PSECURITY_DESCRIPTOR) NULL,
02006                                       &amp;IoDeviceHandlerObjectType ))) {
02007         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02008     }
02009     <a class="code" href="../../d3/d5/iodata_8c.html#a39">IoDeviceHandlerObjectSize</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d3/struct__DEVICE__HANDLER__OBJECT.html">DEVICE_HANDLER_OBJECT</a>);
02010 
02011 <span class="preprocessor">#endif</span>
02012 <span class="preprocessor"></span>
02013     <span class="comment">//</span>
02014     <span class="comment">// Create the object type for controller objects.</span>
02015     <span class="comment">//</span>
02016 
02017     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, L<span class="stringliteral">"Controller"</span> );
02018     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d8/struct__CONTROLLER__OBJECT.html">CONTROLLER_OBJECT</a> );
02019     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;nameString,
02020                                       &amp;objectTypeInitializer,
02021                                       (PSECURITY_DESCRIPTOR) NULL,
02022                                       &amp;IoControllerObjectType ))) {
02023         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02024     }
02025 
02026     <span class="comment">//</span>
02027     <span class="comment">// Create the object type for device objects.</span>
02028     <span class="comment">//</span>
02029 
02030     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, L<span class="stringliteral">"Device"</span> );
02031     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">DEVICE_OBJECT</a> );
02032     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o16">ParseProcedure</a> = <a class="code" href="../../d0/d6/iop_8h.html#a199">IopParseDevice</a>;
02033     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d0/d6/iop_8h.html#a163">IopDeleteDevice</a>;
02034     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a> = <a class="code" href="../../d0/d6/iop_8h.html#a183">IopGetSetSecurityObject</a>;
02035     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o18">QueryNameProcedure</a> = (<a class="code" href="../../d4/d0/ob_8h.html#a28">OB_QUERYNAME_METHOD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02036     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;nameString,
02037                                       &amp;objectTypeInitializer,
02038                                       (PSECURITY_DESCRIPTOR) NULL,
02039                                       &amp;IoDeviceObjectType ))) {
02040         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02041     }
02042 
02043     <span class="comment">//</span>
02044     <span class="comment">// Create the object type for driver objects.</span>
02045     <span class="comment">//</span>
02046 
02047     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, L<span class="stringliteral">"Driver"</span> );
02048     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> );
02049     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o16">ParseProcedure</a> = (<a class="code" href="../../d4/d0/ob_8h.html#a26">OB_PARSE_METHOD</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02050     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d0/d6/iop_8h.html#a162">IopDeleteDriver</a>;
02051     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a> = (<a class="code" href="../../d4/d0/ob_8h.html#a27">OB_SECURITY_METHOD</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02052     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o18">QueryNameProcedure</a> = (<a class="code" href="../../d4/d0/ob_8h.html#a28">OB_QUERYNAME_METHOD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02053     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;nameString,
02054                                       &amp;objectTypeInitializer,
02055                                       (PSECURITY_DESCRIPTOR) NULL,
02056                                       &amp;IoDriverObjectType ))) {
02057         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02058     }
02059 
02060     <span class="comment">//</span>
02061     <span class="comment">// Create the object type for I/O completion objects.</span>
02062     <span class="comment">//</span>
02063 
02064     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, L<span class="stringliteral">"IoCompletion"</span> );
02065     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d7/struct__KQUEUE.html">KQUEUE</a> );
02066     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = OBJ_PERMANENT | OBJ_OPENLINK;
02067     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a12">IopCompletionMapping</a>;
02068     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = IO_COMPLETION_ALL_ACCESS;
02069     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d5/d4/complete_8c.html#a7">IopDeleteIoCompletion</a>;
02070     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;nameString,
02071                                       &amp;objectTypeInitializer,
02072                                       (PSECURITY_DESCRIPTOR) NULL,
02073                                       &amp;IoCompletionObjectType ))) {
02074         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02075     }
02076 
02077     <span class="comment">//</span>
02078     <span class="comment">// Create the object type for file objects.</span>
02079     <span class="comment">//</span>
02080 
02081     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, L<span class="stringliteral">"File"</span> );
02082     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o10">DefaultPagedPoolCharge</a> = <a class="code" href="../../d0/d5/io_8h.html#a221">IO_FILE_OBJECT_PAGED_POOL_CHARGE</a>;
02083     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <a class="code" href="../../d0/d5/io_8h.html#a220">IO_FILE_OBJECT_NON_PAGED_POOL_CHARGE</a> +
02084                                                       <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">FILE_OBJECT</a> );
02085     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = OBJ_PERMANENT | OBJ_EXCLUSIVE | OBJ_OPENLINK;
02086     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a11">IopFileMapping</a>;
02087     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = FILE_ALL_ACCESS;
02088     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02089     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a> = <a class="code" href="../../d0/d6/iop_8h.html#a154">IopCloseFile</a>;
02090     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d0/d6/iop_8h.html#a164">IopDeleteFile</a>;
02091     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o16">ParseProcedure</a> = <a class="code" href="../../d0/d6/iop_8h.html#a200">IopParseFile</a>;
02092     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a> = <a class="code" href="../../d0/d6/iop_8h.html#a183">IopGetSetSecurityObject</a>;
02093     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o18">QueryNameProcedure</a> = <a class="code" href="../../d0/d6/iop_8h.html#a202">IopQueryName</a>;
02094     objectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o1">UseDefaultObject</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02095 
02096     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;nameString,
02097                                       &amp;objectTypeInitializer,
02098                                       (PSECURITY_DESCRIPTOR) NULL,
02099                                       &amp;IoFileObjectType ))) {
02100         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02101     }
02102 
02103     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02104 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="ioinit.c::IopCreateRootDirectories" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopCreateRootDirectories           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02155">2155</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00032">NtCreateDirectoryObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>02161                    :
02162 
02163     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to create <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object manager directory objects
02164     to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> various device and <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system driver objects.
02165 
02166 Arguments:
02167 
02168     None.
02169 
02170 Return Value:
02171 
02172     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a BOOLEAN indicating whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory
02173     objects were successfully created.
02174 
02175 
02176 --*/
02177 
02178 {
02179     HANDLE handle;
02180     OBJECT_ATTRIBUTES objectAttributes;
02181     UNICODE_STRING nameString;
02182     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02183 
02184     <span class="comment">//</span>
02185     <span class="comment">// Create the root directory object for the \Driver directory.</span>
02186     <span class="comment">//</span>
02187 
02188     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, L<span class="stringliteral">"\\Driver"</span> );
02189     InitializeObjectAttributes( &amp;objectAttributes,
02190                                 &amp;nameString,
02191                                 OBJ_PERMANENT,
02192                                 (HANDLE) NULL,
02193                                 (PSECURITY_DESCRIPTOR) NULL );
02194 
02195     status = <a class="code" href="../../d8/d0/obdir_8c.html#a0">NtCreateDirectoryObject</a>( &amp;handle,
02196                                       DIRECTORY_ALL_ACCESS,
02197                                       &amp;objectAttributes );
02198     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02199         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02200     } <span class="keywordflow">else</span> {
02201         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
02202     }
02203 
02204     <span class="comment">//</span>
02205     <span class="comment">// Create the root directory object for the \FileSystem directory.</span>
02206     <span class="comment">//</span>
02207 
02208     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, L<span class="stringliteral">"\\FileSystem"</span> );
02209 
02210     status = <a class="code" href="../../d8/d0/obdir_8c.html#a0">NtCreateDirectoryObject</a>( &amp;handle,
02211                                       DIRECTORY_ALL_ACCESS,
02212                                       &amp;objectAttributes );
02213     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02214         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02215     } <span class="keywordflow">else</span> {
02216         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
02217     }
02218 
02219     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02220 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="ioinit.c::IopFreeGroupTree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeGroupTree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TreeEntry</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02223">2223</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00052">_TREE_ENTRY::Left</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00053">_TREE_ENTRY::Right</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00054">_TREE_ENTRY::Sibling</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>02229                    :
02230 
02231     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to free a node from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group dependency tree.
02232     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first time with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree, and thereafter
02233     recursively to walk <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree and remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> nodes.
02234 
02235 Arguments:
02236 
02237     TreeEntry - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node to be freed.
02238 
02239 Return Value:
02240 
02241     None.
02242 
02243 --*/
02244 
02245 {
02246     <span class="comment">//</span>
02247     <span class="comment">// Simply walk the tree in ascending order from the bottom up and free</span>
02248     <span class="comment">// each node along the way.</span>
02249     <span class="comment">//</span>
02250 
02251     <span class="keywordflow">if</span> (TreeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o0">Left</a>) {
02252         <a class="code" href="../../d9/d5/ioinit_8c.html#a38">IopFreeGroupTree</a>( TreeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o0">Left</a> );
02253     }
02254 
02255     <span class="keywordflow">if</span> (TreeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o2">Sibling</a>) {
02256         <a class="code" href="../../d9/d5/ioinit_8c.html#a38">IopFreeGroupTree</a>( TreeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o2">Sibling</a> );
02257     }
02258 
02259     <span class="keywordflow">if</span> (TreeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o1">Right</a>) {
02260         <a class="code" href="../../d9/d5/ioinit_8c.html#a38">IopFreeGroupTree</a>( TreeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o1">Right</a> );
02261     }
02262 
02263     <span class="comment">//</span>
02264     <span class="comment">// All of the children and siblings for this node have been freed, so</span>
02265     <span class="comment">// now free this node as well.</span>
02266     <span class="comment">//</span>
02267 
02268     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TreeEntry );
02269 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="ioinit.c::IopFreeGroupTree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeGroupTree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TreeEntry</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="ioinit.c::IopGetDriverTagPriority" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> IopGetDriverTagPriority           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Servicehandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04120">4120</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>04126                    :
04127 
04128     This routine reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Tag value of a driver and determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag's priority
04129     among its driver group.
04130 
04131 Arguments:
04132 
04133     ServiceHandle - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's service key.
04134 
04135 Return Value:
04136 
04137     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <span class="keywordflow">for</span> priority.
04138 
04139 --*/
04140 
04141 {
04142     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04143     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04144     PKEY_VALUE_FULL_INFORMATION keyValueInformation1;
04145     UNICODE_STRING groupName;
04146     HANDLE handle;
04147     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> index = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) -1;
04148     PULONG groupOrder;
04149     ULONG count, tag;
04150 
04151     <span class="comment">//</span>
04152     <span class="comment">// Open System\CurrentControlSet\Control\GroupOrderList</span>
04153     <span class="comment">//</span>
04154 
04155     PiWstrToUnicodeString(&amp;groupName, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\GroupOrderList"</span>);
04156     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04157                                    NULL,
04158                                    &amp;groupName,
04159                                    KEY_READ
04160                                    );
04161 
04162     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04163         <span class="keywordflow">return</span> index;
04164     }
04165 
04166     <span class="comment">//</span>
04167     <span class="comment">// Read service key's Group value</span>
04168     <span class="comment">//</span>
04169 
04170     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (ServiceHandle,
04171                                   L<span class="stringliteral">"Group"</span>,
04172                                   &amp;keyValueInformation);
04173     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04174 
04175         <span class="comment">//</span>
04176         <span class="comment">// Try to read what caller wants.</span>
04177         <span class="comment">//</span>
04178 
04179         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_SZ) &amp;&amp;
04180             (keyValueInformation-&gt;DataLength != 0)) {
04181             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;groupName,
04182                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
04183                                            keyValueInformation-&gt;DataLength
04184                                            );
04185         }
04186     } <span class="keywordflow">else</span> {
04187 
04188         <span class="comment">//</span>
04189         <span class="comment">// If we failed to read the Group value, or no Group value...</span>
04190         <span class="comment">//</span>
04191 
04192         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
04193         <span class="keywordflow">return</span> index;
04194     }
04195 
04196     <span class="comment">//</span>
04197     <span class="comment">// Read service key's Tag value</span>
04198     <span class="comment">//</span>
04199 
04200     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (ServiceHandle,
04201                                   L<span class="stringliteral">"Tag"</span>,
04202                                   &amp;keyValueInformation1);
04203     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04204 
04205         <span class="comment">//</span>
04206         <span class="comment">// Try to read what caller wants.</span>
04207         <span class="comment">//</span>
04208 
04209         <span class="keywordflow">if</span> ((keyValueInformation1-&gt;Type == REG_DWORD) &amp;&amp;
04210             (keyValueInformation1-&gt;DataLength != 0)) {
04211             tag = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation1);
04212         }
04213         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation1);
04214     } <span class="keywordflow">else</span> {
04215 
04216         <span class="comment">//</span>
04217         <span class="comment">// If we failed to read the Group value, or no Group value...</span>
04218         <span class="comment">//</span>
04219 
04220         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04221         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
04222         <span class="keywordflow">return</span> index;
04223     }
04224 
04225     <span class="comment">//</span>
04226     <span class="comment">// Read group order list value for the driver's Group</span>
04227     <span class="comment">//</span>
04228 
04229     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
04230                                   groupName.Buffer,
04231                                   &amp;keyValueInformation1);
04232     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04233     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
04234     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04235 
04236         <span class="comment">//</span>
04237         <span class="comment">// Try to read what caller wants.</span>
04238         <span class="comment">//</span>
04239 
04240         <span class="keywordflow">if</span> ((keyValueInformation1-&gt;Type == REG_BINARY) &amp;&amp;
04241             (keyValueInformation1-&gt;DataLength != 0)) {
04242             groupOrder = (PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation1);
04243             count = *groupOrder;
04244             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((count + 1) * <span class="keyword">sizeof</span>(ULONG) &lt;= keyValueInformation1-&gt;DataLength);
04245             groupOrder++;
04246             <span class="keywordflow">for</span> (index = 1; index &lt;= count; index++) {
04247                 <span class="keywordflow">if</span> (tag == *groupOrder) {
04248                     <span class="keywordflow">break</span>;
04249                 } <span class="keywordflow">else</span> {
04250                     groupOrder++;
04251                 }
04252             }
04253         }
04254         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation1);
04255     } <span class="keywordflow">else</span> {
04256 
04257         <span class="comment">//</span>
04258         <span class="comment">// If we failed to read the Group value, or no Group value...</span>
04259         <span class="comment">//</span>
04260 
04261         <span class="keywordflow">return</span> index;
04262     }
04263     <span class="keywordflow">return</span> index;
04264 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="ioinit.c::IopInitializeAttributesAndCreateObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopInitializeAttributesAndCreateObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02272">2272</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d4/d4/iodata_8c-source.html#l00236">IoDriverObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, and <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>.
<p>
<pre class="fragment"><div>02280                    :
02281 
02282     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to initialize a set of object attributes and
02283     to create a driver object.
02284 
02285 Arguments:
02286 
02287     ObjectName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object.
02288 
02289     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object attributes structure
02290         to be initialized.
02291 
02292     DriverObject - Supplies a variable to receive a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resultant
02293         created driver object.
02294 
02295 Return Value:
02296 
02297     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
02298 
02299 --*/
02300 
02301 {
02302     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02303 
02304     <span class="comment">//</span>
02305     <span class="comment">// Simply initialize the object attributes and create the driver object.</span>
02306     <span class="comment">//</span>
02307 
02308     InitializeObjectAttributes( ObjectAttributes,
02309                                 ObjectName,
02310                                 OBJ_PERMANENT | OBJ_CASE_INSENSITIVE,
02311                                 (HANDLE) NULL,
02312                                 (PSECURITY_DESCRIPTOR) NULL );
02313 
02314     status = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( KeGetPreviousMode(),
02315                              IoDriverObjectType,
02316                              ObjectAttributes,
02317                              KernelMode,
02318                              (PVOID) NULL,
02319                              (ULONG) (<span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> ) + <span class="keyword">sizeof</span> ( <a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html">DRIVER_EXTENSION</a> )),
02320                              0,
02321                              0,
02322                              (PVOID *)DriverObject );
02323     <span class="keywordflow">return</span> status;
02324 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="ioinit.c::IopInitializeBootDrivers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopInitializeBootDrivers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousDriver</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">2327</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00673">BUS_DRIVER_GROUP</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00345">_REINIT_PACKET::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01330">_DRIVER_EXTENSION::Count</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00063">_DRIVER_INFORMATION::DataTableEntry</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01366">_DRIVER_OBJECT::DeviceObject</a>, <a class="el" href="../../d9/d5/ioinit_8c.html#a5">DRIVER_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01378">_DRIVER_OBJECT::DriverExtension</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00343">_REINIT_PACKET::DriverObject</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00062">_DRIVER_INFORMATION::DriverObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00344">_REINIT_PACKET::DriverReinitializationRoutine</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00056">_TREE_ENTRY::DriversLoaded</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01413">_DRIVER_OBJECT::DriverUnload</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01305">DRVO_BOOTREINIT_REGISTERED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01303">DRVO_REINIT_REGISTERED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01299">DRVO_UNLOAD_INVOKED</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00066">_DRIVER_INFORMATION::Failed</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01367">_DRIVER_OBJECT::Flags</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00117">IopAddDevicesToBootDriver()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07141">IopAllocateBootResources()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00134">IopBootConfigsReserved</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00121">IopBootDriverReinitializeQueueHead</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00978">IopCheckDependencies()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01047">IopCreateArcNames()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02072">IopGetDriverNameFromKeyNode()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04120">IopGetDriverTagPriority()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05221">IopGetGroupOrderIndex()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00081">IopGroupIndex</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00082">IopGroupTable</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00040">IopInitHalResources</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00042">IopInitReservedResourceList</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04267">IopInsertDriverList()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05177">IopIsLegacyDriver()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03379">IopLookupGroupName()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03479">IopMarkBootPartition()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04318">IopNotifySetupDevices()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00148">IopReserveResourcesRoutine</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00142">IopResourcesReleased</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l01834">IopStartTcpIpForRemoteBoot()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04617">IopWaitForBootDevicesDeleted()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04508">IopWaitForBootDevicesStarted()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04577">IoRemoteBootClient</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d8/d8/cm_8h-source.html#l00103">_BOOT_DRIVER_LIST_ENTRY::LdrEntry</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00061">_DRIVER_INFORMATION::Link</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l06717">MmCallDllInitialize()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00671">NO_MORE_GROUP</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00484">ObMakeTemporaryObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d9/d5/ioinit_8c.html#a6">PDRIVER_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00522">PDRIVER_INITIALIZE</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00173">PnpAsyncOk</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00122">PnPBootDriversInitialized</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00128">PnPBootDriversLoaded</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00067">_DRIVER_INFORMATION::Processed</a>, <a class="el" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>, <a class="el" href="../../d9/d5/ioinit_8c.html#a14">RawInitialize()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a220">ReenumerateBootDevices</a>, <a class="el" href="../../d8/d8/cm_8h-source.html#l00102">_BOOT_DRIVER_LIST_ENTRY::RegistryPath</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a221">RestartEnumeration</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00064">_DRIVER_INFORMATION::ServiceHandle</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00672">SETUP_RESERVED_GROUP</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a124">START_CONTEXT</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00065">_DRIVER_INFORMATION::TagPosition</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>02334                    :
02335 
02336     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot drivers that were loaded
02337     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS Loader.  The list of drivers <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> provided as part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader
02338     parameter block.
02339 
02340 Arguments:
02341 
02342     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader parameter block, created
02343         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS Loader.
02344 
02345     Previous Driver - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02346         driver object chain created by initializing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> drivers.
02347 
02348 Return Value:
02349 
02350     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a BOOLEAN indicating whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot
02351     drivers were successfully initialized.
02352 
02353 --*/
02354 
02355 {
02356     UNICODE_STRING completeName;
02357     UNICODE_STRING rawFsName;
02358     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02359     PLIST_ENTRY nextEntry;
02360     PLIST_ENTRY entry;
02361     <a class="code" href="../../d5/d3/struct__REINIT__PACKET.html">PREINIT_PACKET</a> reinitEntry;
02362     <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">PBOOT_DRIVER_LIST_ENTRY</a> bootDriver;
02363     HANDLE keyHandle;
02364     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
02365     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
02366     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i, j;
02367     PLDR_DATA_TABLE_ENTRY driverEntry;
02368     PLDR_DATA_TABLE_ENTRY dllEntry;
02369     UNICODE_STRING groupName;
02370     <a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a> treeEntry;
02371     <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">PDRIVER_INFORMATION</a> driverInfo;
02372     <a class="code" href="../../d0/d6/struct__START__CONTEXT.html">START_CONTEXT</a> startContext;
02373     BOOLEAN moreProcessing;
02374     BOOLEAN newDevice;
02375     BOOLEAN textModeSetup = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02376     BOOLEAN bootReinitDriversFound;
02377     BOOLEAN bootConfigsOK;
02378 
02379     UNREFERENCED_PARAMETER( PreviousDriver );
02380 
02381     <span class="comment">//</span>
02382     <span class="comment">// Initialize the built-in RAW file system driver.</span>
02383     <span class="comment">//</span>
02384 
02385     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;rawFsName, L<span class="stringliteral">"\\FileSystem\\RAW"</span> );
02386     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;completeName, L<span class="stringliteral">""</span> );
02387     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a23">IopInitializeBuiltinDriver</a>( &amp;rawFsName,
02388                                      &amp;completeName,
02389                                      RawInitialize,
02390                                      NULL,
02391                                      textModeSetup )) {
02392 <span class="preprocessor">#if DBG</span>
02393 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: Failed to initialize RAW filsystem \n"</span> );
02394 
02395 <span class="preprocessor">#endif</span>
02396 <span class="preprocessor"></span>
02397         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02398     }
02399 
02400     <span class="comment">//</span>
02401     <span class="comment">// Determine number of group orders and build a list_entry array to link all the drivers</span>
02402     <span class="comment">// together based on their groups.</span>
02403     <span class="comment">//</span>
02404 
02405     <a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a> = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a33">IopGetGroupOrderIndex</a>(NULL);
02406     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a> == <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>) {
02407         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02408     }
02409 
02410     <a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a> = (PLIST_ENTRY) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, IopGroupIndex * <span class="keyword">sizeof</span> (LIST_ENTRY));
02411     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02412         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02413     }
02414     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a>; i++) {
02415         InitializeListHead(&amp;IopGroupTable[i]);
02416     }
02417 
02418     <a class="code" href="../../d1/d0/pnpdata_8c.html#a24">PnpAsyncOk</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02419 
02420     <span class="comment">//</span>
02421     <span class="comment">// Call DllInitialize for driver dependent DLLs.</span>
02422     <span class="comment">//</span>
02423 
02424     nextEntry = LoaderBlock-&gt;LoadOrderListHead.Flink;
02425     <span class="keywordflow">while</span> (nextEntry != &amp;LoaderBlock-&gt;LoadOrderListHead) {
02426         dllEntry = CONTAINING_RECORD(nextEntry, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
02427         <span class="keywordflow">if</span> (dllEntry-&gt;Flags &amp; LDRP_DRIVER_DEPENDENT_DLL) {
02428             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/sysload_8c.html#a67">MmCallDllInitialize</a>(dllEntry);
02429         }
02430         nextEntry = nextEntry-&gt;Flink;
02431     }
02432     <span class="comment">//</span>
02433     <span class="comment">// Allocate pool to store driver's start information.</span>
02434     <span class="comment">// All the driver info records with the same group value will be linked into a list.</span>
02435     <span class="comment">//</span>
02436 
02437     nextEntry = LoaderBlock-&gt;BootDriverListHead.Flink;
02438     <span class="keywordflow">while</span> (nextEntry != &amp;LoaderBlock-&gt;BootDriverListHead) {
02439         bootDriver = CONTAINING_RECORD( nextEntry,
02440                                         <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">BOOT_DRIVER_LIST_ENTRY</a>,
02441                                         Link );
02442         driverEntry = bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o3">LdrEntry</a>;
02443         driverInfo = (<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">PDRIVER_INFORMATION</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
02444                         PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">DRIVER_INFORMATION</a>));
02445         <span class="keywordflow">if</span> (driverInfo) {
02446             RtlZeroMemory(driverInfo, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">DRIVER_INFORMATION</a>));
02447             InitializeListHead(&amp;driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o0">Link</a>);
02448             driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o2">DataTableEntry</a> = bootDriver;
02449 
02450             <span class="comment">//</span>
02451             <span class="comment">// Open the driver's registry key to find out if this is a</span>
02452             <span class="comment">// filesystem or a driver.</span>
02453             <span class="comment">//</span>
02454 
02455             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;keyHandle,
02456                                            (HANDLE)NULL,
02457                                            &amp;bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o2">RegistryPath</a>,
02458                                            KEY_READ
02459                                            );
02460             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02461                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(driverInfo);
02462             } <span class="keywordflow">else</span> {
02463                 driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o3">ServiceHandle</a> = keyHandle;
02464                 j = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a33">IopGetGroupOrderIndex</a>(keyHandle);
02465                 <span class="keywordflow">if</span> (j == <a class="code" href="../../d9/d0/pnpiop_8h.html#a55">SETUP_RESERVED_GROUP</a>) {
02466 
02467                     textModeSetup = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02468 
02469                     <span class="comment">//</span>
02470                     <span class="comment">// Special handling for setupdd.sys</span>
02471                     <span class="comment">//</span>
02472 
02473                     status = <a class="code" href="../../d0/d6/iop_8h.html#a175">IopGetDriverNameFromKeyNode</a>( keyHandle,
02474                                                           &amp;completeName );
02475                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02476                         driverObject = <a class="code" href="../../d9/d5/ioinit_8c.html#a23">IopInitializeBuiltinDriver</a>(
02477                                            &amp;completeName,
02478                                            &amp;bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o2">RegistryPath</a>,
02479                                            (PDRIVER_INITIALIZE) driverEntry-&gt;EntryPoint,
02480                                            driverEntry,
02481                                            textModeSetup );
02482                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( completeName.Buffer );
02483                         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(keyHandle);
02484                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(driverInfo);
02485                         <span class="keywordflow">if</span> (driverObject) {
02486 
02487                             <span class="comment">//</span>
02488                             <span class="comment">// Once we successfully initialized the setupdd.sys, we are ready</span>
02489                             <span class="comment">// to notify it all the root enumerated devices.</span>
02490                             <span class="comment">//</span>
02491 
02492                             <a class="code" href="../../d9/d5/ioinit_8c.html#a32">IopNotifySetupDevices</a>(IopRootDeviceNode);
02493                         } <span class="keywordflow">else</span> {
02494                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopGroupTable);
02495                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02496                         }
02497                     }
02498 
02499                 } <span class="keywordflow">else</span> {
02500                     driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o4">TagPosition</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a30">IopGetDriverTagPriority</a>(keyHandle);
02501                     <a class="code" href="../../d9/d5/ioinit_8c.html#a31">IopInsertDriverList</a>(&amp;IopGroupTable[j], driverInfo);
02502                 }
02503             }
02504         }
02505         nextEntry = nextEntry-&gt;Flink;
02506     }
02507 
02508     <span class="comment">//</span>
02509     <span class="comment">// Process each driver base on its group.  The group with lower index number (higher</span>
02510     <span class="comment">// priority) is processed first.</span>
02511     <span class="comment">//</span>
02512 
02513     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a>; i++) {
02514         nextEntry = <a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>[i].Flink;
02515         <span class="keywordflow">while</span> (nextEntry != &amp;<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>[i]) {
02516 
02517             driverInfo = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">DRIVER_INFORMATION</a>, Link);
02518             keyHandle = driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o3">ServiceHandle</a>;
02519             bootDriver = driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o2">DataTableEntry</a>;
02520             driverEntry = bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o3">LdrEntry</a>;
02521             driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o6">Processed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02522 
02523             <span class="comment">//</span>
02524             <span class="comment">// call the driver's driver entry</span>
02525             <span class="comment">//</span>
02526             <span class="comment">// See if this driver has an ObjectName value.  If so, this value</span>
02527             <span class="comment">// overrides the default ("\Driver" or "\FileSystem").</span>
02528             <span class="comment">//</span>
02529 
02530             status = <a class="code" href="../../d0/d6/iop_8h.html#a175">IopGetDriverNameFromKeyNode</a>( keyHandle,
02531                                                   &amp;completeName );
02532             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02533 
02534 <span class="preprocessor">#if DBG</span>
02535 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: Could not get driver name for %wZ\n"</span>,
02536                           &amp;bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o2">RegistryPath</a> );
02537 <span class="preprocessor">#endif // DBG</span>
02538 <span class="preprocessor"></span>
02539                 driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o5">Failed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02540             } <span class="keywordflow">else</span> {
02541 
02542                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( keyHandle,
02543                                               L<span class="stringliteral">"Group"</span>,
02544                                               &amp;keyValueInformation );
02545                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02546 
02547                     <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
02548                         groupName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyValueInformation-&gt;DataLength;
02549                         groupName.MaximumLength = groupName.Length;
02550                         groupName.Buffer = (PWSTR) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
02551                         treeEntry = <a class="code" href="../../d9/d5/ioinit_8c.html#a26">IopLookupGroupName</a>( &amp;groupName, TRUE );
02552                     } <span class="keywordflow">else</span> {
02553                         treeEntry = (<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02554                     }
02555                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
02556                 } <span class="keywordflow">else</span> {
02557                     treeEntry = (<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02558                 }
02559 
02560                 <span class="comment">//</span>
02561                 <span class="comment">// Check if this bus has a BOOT config.</span>
02562                 <span class="comment">// Buses with BOOT configs allow assignment of BOOT configs on their level.</span>
02563                 <span class="comment">//</span>
02564 
02565                 bootConfigsOK = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02566                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( keyHandle,
02567                                               L<span class="stringliteral">"HasBootConfig"</span>,
02568                                               &amp;keyValueInformation );
02569                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02570                     <span class="keywordflow">if</span> (*(PULONG)((PUCHAR)keyValueInformation + keyValueInformation-&gt;DataOffset) == 0) {
02571                         bootConfigsOK = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02572                     }
02573                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
02574                 }
02575 
02576                 driverObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02577                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a15">IopCheckDependencies</a>( keyHandle )) {
02578                     <span class="comment">//</span>
02579                     <span class="comment">// The driver may already be initialized by IopInitializeBootFilterDriver</span>
02580                     <span class="comment">// if it is boot filter driver.</span>
02581                     <span class="comment">// If not, initialize it.</span>
02582                     <span class="comment">//</span>
02583 
02584                     driverObject = driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o1">DriverObject</a>;
02585                     <span class="keywordflow">if</span> (driverObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02586                         driverObject = <a class="code" href="../../d9/d5/ioinit_8c.html#a23">IopInitializeBuiltinDriver</a>(
02587                                            &amp;completeName,
02588                                            &amp;bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o2">RegistryPath</a>,
02589                                            (PDRIVER_INITIALIZE) driverEntry-&gt;EntryPoint,
02590                                            driverEntry,
02591                                            textModeSetup);
02592                         <span class="comment">//</span>
02593                         <span class="comment">// Pnp might unload the driver before we get a chance to look at this. So take an extra</span>
02594                         <span class="comment">// reference.</span>
02595                         <span class="comment">//</span>
02596                         <span class="keywordflow">if</span> (driverObject) {
02597                             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(driverObject);
02598                         }
02599                     }
02600                 }
02601                 <span class="keywordflow">if</span> (driverObject) {
02602                     <span class="keywordflow">if</span> (treeEntry) {
02603                         treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o4">DriversLoaded</a>++;
02604                     }
02605                     driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o1">DriverObject</a> = driverObject;
02606 
02607                 } <span class="keywordflow">else</span> {
02608                     driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o5">Failed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02609                 }
02610                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( completeName.Buffer );
02611             }
02612             <span class="keywordflow">if</span> (!driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o5">Failed</a>) {
02613 
02614                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> group;
02615 
02616                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a260">IopAddDevicesToBootDriver</a>(driverObject);
02617 
02618                 <span class="comment">//</span>
02619                 <span class="comment">// Scan the hardware tree looking for devices which need</span>
02620                 <span class="comment">// resources or starting.</span>
02621                 <span class="comment">//</span>
02622 
02623                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>(NULL, ReenumerateBootDevices, NULL, (PNTSTATUS)&amp;bootConfigsOK);
02624 
02625             }
02626 
02627             <span class="comment">//</span>
02628             <span class="comment">// Before processing next boot driver, wait for IoRequestDeviceRemoval complete.</span>
02629             <span class="comment">// The driver to be processed may need the resources being released by</span>
02630             <span class="comment">// IoRequestDeviceRemoval.  (For drivers report detected BOOT device if they fail to</span>
02631             <span class="comment">// get the resources in their DriverEntry.  They will fail and we will bugcheck with</span>
02632             <span class="comment">// inaccessible boot device.)</span>
02633             <span class="comment">//</span>
02634 
02635             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a34">IopWaitForBootDevicesDeleted</a>()) {
02636                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02637             }
02638 
02639             nextEntry = nextEntry-&gt;Flink;
02640         }
02641 
02642         <span class="comment">//</span>
02643         <span class="comment">// If we are done with Bus driver group, then it's time to reserved the Hal resources</span>
02644         <span class="comment">// and reserve boot resources</span>
02645         <span class="comment">//</span>
02646 
02647         <span class="keywordflow">if</span> (i == <a class="code" href="../../d9/d0/pnpiop_8h.html#a56">BUS_DRIVER_GROUP</a>) {
02648             <span class="keywordflow">if</span> (textModeSetup == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02649                 <span class="comment">//</span>
02650                 <span class="comment">// BUGBUG - There problems with Async ops, disable for now.</span>
02651                 <span class="comment">//</span>
02652                 <span class="comment">// PnpAsyncOk = TRUE;</span>
02653             }
02654 
02655             <span class="comment">//</span>
02656             <span class="comment">// Reserve BOOT configs on Internal bus 0.</span>
02657             <span class="comment">//</span>
02658 
02659             <a class="code" href="../../d5/d1/pnpres_8c.html#a110">IopReserveLegacyBootResources</a>(Internal, 0);
02660             <a class="code" href="../../d1/d0/pnpdata_8c.html#a20">IopReserveResourcesRoutine</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a335">IopAllocateBootResources</a>;
02661             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IopInitHalResources == NULL);
02662             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IopInitReservedResourceList == NULL);
02663             <a class="code" href="../../d1/d0/pnpdata_8c.html#a18">IopBootConfigsReserved</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02664 
02665         }
02666     }
02667 
02668     <span class="comment">//</span>
02669     <span class="comment">// If we started a network boot driver, then imitate what DHCP does</span>
02670     <span class="comment">// in sending IOCTLs.</span>
02671     <span class="comment">//</span>
02672 
02673     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a399">IoRemoteBootClient</a>) {
02674         status = <a class="code" href="../../d4/d6/netboot_8c.html#a13">IopStartTcpIpForRemoteBoot</a>(LoaderBlock);
02675         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02676             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( NETWORK_BOOT_INITIALIZATION_FAILED,
02677                           3,
02678                           status,
02679                           0,
02680                           0 );
02681         }
02682     }
02683 
02684     <span class="comment">//</span>
02685     <span class="comment">// Scan the hardware tree looking for devices which need</span>
02686     <span class="comment">// resources or starting.</span>
02687     <span class="comment">//</span>
02688     <a class="code" href="../../d1/d0/pnpdata_8c.html#a17">PnPBootDriversLoaded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02689     <a class="code" href="../../d1/d0/pnpdata_8c.html#a19">IopResourcesReleased</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02690 
02691     <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>(NULL, RestartEnumeration, NULL, NULL);
02692 
02693     <span class="comment">//</span>
02694     <span class="comment">// If start irps are handled asynchronously, we need to make sure all the boot devices</span>
02695     <span class="comment">// started before continue.</span>
02696     <span class="comment">//</span>
02697 
02698     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a33">IopWaitForBootDevicesStarted</a>()) {
02699         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02700     }
02701 
02702     bootReinitDriversFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02703 
02704     <span class="keywordflow">while</span> (entry = <a class="code" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList</a>( &amp;IopBootDriverReinitializeQueueHead, &amp;IopDatabaseLock )) {
02705         bootReinitDriversFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02706         reinitEntry = CONTAINING_RECORD( entry, <a class="code" href="../../d5/d3/struct__REINIT__PACKET.html">REINIT_PACKET</a>, ListEntry );
02707         reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o2">Count</a>++;
02708         reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a148">DRVO_BOOTREINIT_REGISTERED</a>;
02709         reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o2">DriverReinitializationRoutine</a>( reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>,
02710                                                     reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o3">Context</a>,
02711                                                     reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o2">Count</a> );
02712         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( reinitEntry );
02713     }
02714 
02715     <span class="comment">//</span>
02716     <span class="comment">// If there were any drivers that registered for boot reinitialization, then</span>
02717     <span class="comment">// we need to wait one more time to make sure we catch any additional</span>
02718     <span class="comment">// devices that were created in response to the reinitialization callback.</span>
02719     <span class="comment">//</span>
02720 
02721     <span class="keywordflow">if</span> (bootReinitDriversFound &amp;&amp; !<a class="code" href="../../d9/d5/ioinit_8c.html#a33">IopWaitForBootDevicesStarted</a>()) {
02722         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02723     }
02724 
02725     <span class="comment">//</span>
02726     <span class="comment">// Link NT device names to ARC names now that all of the boot drivers</span>
02727     <span class="comment">// have intialized.</span>
02728     <span class="comment">//</span>
02729 
02730     <a class="code" href="../../d9/d5/ioinit_8c.html#a16">IopCreateArcNames</a>( LoaderBlock );
02731 
02732     <span class="comment">//</span>
02733     <span class="comment">// Find and mark the boot partition device object so that if a subsequent</span>
02734     <span class="comment">// access or mount of the device during initialization occurs, an more</span>
02735     <span class="comment">// bugcheck can be produced that helps the user understand why the system</span>
02736     <span class="comment">// is failing to boot and run properly.  This occurs when either one of the</span>
02737     <span class="comment">// device drivers or the file system fails to load, or when the file system</span>
02738     <span class="comment">// cannot mount the device for some other reason.</span>
02739     <span class="comment">//</span>
02740 
02741     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a27">IopMarkBootPartition</a>( LoaderBlock )) {
02742         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02743     }
02744 
02745     <span class="comment">//</span>
02746     <span class="comment">// BUGBUG - There problems with Async ops, disable for now.</span>
02747     <span class="comment">//</span>
02748     <span class="comment">// PnpAsyncOk = TRUE;</span>
02749     <a class="code" href="../../d1/d0/pnpdata_8c.html#a16">PnPBootDriversInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02750 
02751     <span class="comment">//</span>
02752     <span class="comment">// Go thru every driver that we initialized.  If it supports AddDevice entry and</span>
02753     <span class="comment">// did not create any device object after we start it.  We mark it as failure so</span>
02754     <span class="comment">// text mode setup knows this driver is not needed.</span>
02755     <span class="comment">//</span>
02756 
02757     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a>; i++) {
02758         <span class="keywordflow">while</span> (IsListEmpty(&amp;IopGroupTable[i]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02759 
02760             BOOLEAN failed;
02761 
02762             nextEntry = RemoveHeadList(&amp;IopGroupTable[i]);
02763             driverInfo = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">DRIVER_INFORMATION</a>, Link);
02764             driverObject = driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o1">DriverObject</a>;
02765 
02766             <span class="keywordflow">if</span> (textModeSetup                    &amp;&amp;
02767                 (driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o5">Failed</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)    &amp;&amp;
02768                 !<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a32">IopIsLegacyDriver</a>(driverObject) &amp;&amp;
02769                 (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o2">DeviceObject</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02770                 !(driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a146">DRVO_REINIT_REGISTERED</a>)) {
02771 
02772                 <span class="comment">//</span>
02773                 <span class="comment">// If failed is not set and it's not a legacy driver and it has no device object</span>
02774                 <span class="comment">// tread it as failure case.</span>
02775                 <span class="comment">//</span>
02776 
02777                 driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o5">Failed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02778 
02779                 <span class="keywordflow">if</span> (!(driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a143">DRVO_UNLOAD_INVOKED</a>)) {
02780                     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a143">DRVO_UNLOAD_INVOKED</a>;
02781                     <span class="keywordflow">if</span> (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o13">DriverUnload</a>) {
02782                         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o13">DriverUnload</a>(driverObject);
02783                     }
02784                     <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( driverObject );  <span class="comment">// Reference taken while inserting into the object table.</span>
02785                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(driverObject);      <span class="comment">// Reference taken when getting driver object pointer.</span>
02786                 }
02787             }
02788             <span class="keywordflow">if</span> (driverObject) {
02789                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(driverObject);          <span class="comment">// Reference taken specifically for text mode setup.</span>
02790             }
02791 
02792             <span class="keywordflow">if</span> (driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o5">Failed</a>) {
02793                 driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o2">DataTableEntry</a>-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o3">LdrEntry</a>-&gt;Flags |= LDRP_FAILED_BUILTIN_LOAD;
02794             }
02795             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o3">ServiceHandle</a>);
02796             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(driverInfo);
02797         }
02798     }
02799 
02800     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopGroupTable);
02801 
02802     <span class="comment">//</span>
02803     <span class="comment">// Initialize the drivers necessary to dump all of physical memory to the</span>
02804     <span class="comment">// disk if the system is configured to do so.</span>
02805     <span class="comment">//</span>
02806 
02807 
02808     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02809 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="ioinit.c::IopInitializeBuiltinDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> IopInitializeBuiltinDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RegistryPath</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a284">PDRIVER_INITIALIZE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverInitializeRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLDR_DATA_TABLE_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>TableEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>TextModeSetup</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">2812</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00170">CmRegistryMachineHardwareDescriptionSystemName</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01366">_DRIVER_OBJECT::DeviceObject</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01378">_DRIVER_OBJECT::DriverExtension</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01411">_DRIVER_OBJECT::DriverInit</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01385">_DRIVER_OBJECT::DriverName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01377">_DRIVER_OBJECT::DriverSection</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01376">_DRIVER_OBJECT::DriverSize</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01375">_DRIVER_OBJECT::DriverStart</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01300">DRVO_LEGACY_DRIVER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01303">DRVO_REINIT_REGISTERED</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01367">_DRIVER_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01392">_DRIVER_OBJECT::HardwareDatabase</a>, <a class="el" href="../../d0/d1/inbv_8h.html#a13">InbvIndicateProgress()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00088">InitializeDriverObject</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00236">IoDriverObjectType</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05338">IopDeleteLegacyKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02609">IopDriverLoadingFailed()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02272">IopInitializeAttributesAndCreateObject()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03071">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05177">IopIsLegacyDriver()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05910">IopReadyDeviceObjects()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00484">ObMakeTemporaryObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02166">PERFINFO_DRIVER_INIT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02167">PERFINFO_DRIVER_INIT_COMPLETE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00399">RtlEqualString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01337">_DRIVER_EXTENSION::ServiceKeyName</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04654">IopLoadBootFilterDriver()</a>.
<p>
<pre class="fragment"><div>02822                    :
02823 
02824     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to initialize a built-in driver.
02825 
02826 Arguments:
02827 
02828     DriverName - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name to be used in creating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object.
02829 
02830     RegistryPath - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to be used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to get to
02831         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
02832 
02833     DriverInitializeRoutine - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initialization entry point of
02834         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> built-in driver.
02835 
02836     <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver data table entry to determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02837         driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a wdm driver.
02838 
02839     TextModeSetup - Specifies <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> TextMode setup boot.
02840 
02841 Return Value:
02842 
02843     The function returns a pointer to a <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> built-in
02844     driver successfully initialized.  Otherwise, a value of <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02845 
02846 --*/
02847 
02848 {
02849     HANDLE handle;
02850     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
02851     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> tmpDriverObject;
02852     OBJECT_ATTRIBUTES objectAttributes;
02853     PWSTR buffer;
02854     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02855     HANDLE serviceHandle;
02856     PWSTR pserviceName;
02857     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> serviceNameLength;
02858     <a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html">PDRIVER_EXTENSION</a> driverExtension;
02859     PIMAGE_NT_HEADERS ntHeaders;
02860     PVOID imageBase;
02861 <span class="preprocessor">#if DBG</span>
02862 <span class="preprocessor"></span>    LARGE_INTEGER stime, etime;
02863     ULONG dtime;
02864 <span class="preprocessor">#endif</span>
02865 <span class="preprocessor"></span>    PLIST_ENTRY entry;
02866     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02867 
02868     <span class="comment">//</span>
02869     <span class="comment">// Begin by creating the driver object.</span>
02870     <span class="comment">//</span>
02871 
02872     status = <a class="code" href="../../d9/d5/ioinit_8c.html#a21">IopInitializeAttributesAndCreateObject</a>( DriverName,
02873                                                      &amp;objectAttributes,
02874                                                      &amp;driverObject );
02875     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02876         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02877     }
02878 
02879     <span class="comment">//</span>
02880     <span class="comment">// Initialize the driver object.</span>
02881     <span class="comment">//</span>
02882 
02883     <a class="code" href="../../d9/d5/ioinit_8c.html#a2">InitializeDriverObject</a>( driverObject );
02884     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o11">DriverInit</a> = DriverInitializeRoutine;
02885 
02886     <span class="comment">//</span>
02887     <span class="comment">// Insert the driver object into the object table.</span>
02888     <span class="comment">//</span>
02889 
02890     status = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( driverObject,
02891                              NULL,
02892                              FILE_READ_DATA,
02893                              0,
02894                              (PVOID *) NULL,
02895                              &amp;handle );
02896 
02897     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02898         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02899     }
02900 
02901     <span class="comment">//</span>
02902     <span class="comment">// Reference the handle and obtain a pointer to the driver object so that</span>
02903     <span class="comment">// the handle can be deleted without the object going away.</span>
02904     <span class="comment">//</span>
02905 
02906     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( handle,
02907                                         0,
02908                                         IoDriverObjectType,
02909                                         KernelMode,
02910                                         (PVOID *) &amp;tmpDriverObject,
02911                                         (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) NULL );
02912     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
02913     <span class="comment">//</span>
02914     <span class="comment">// Fill in the DriverSection so the image will be automatically unloaded on</span>
02915     <span class="comment">// failures. We should use the entry from the PsModuleList.</span>
02916     <span class="comment">//</span>
02917 
02918     entry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
02919     <span class="keywordflow">while</span> (entry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a> &amp;&amp; <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>) {
02920         DataTableEntry = CONTAINING_RECORD(entry,
02921                                            LDR_DATA_TABLE_ENTRY,
02922                                            InLoadOrderLinks);
02923         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a11">RtlEqualString</a>((PSTRING)&amp;<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;BaseDllName,
02924                     (PSTRING)&amp;DataTableEntry-&gt;BaseDllName,
02925                     TRUE
02926                     )) {
02927             driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o6">DriverSection</a> = DataTableEntry;
02928             <span class="keywordflow">break</span>;
02929         }
02930         entry = entry-&gt;Flink;
02931     }
02932 
02933     <span class="comment">//</span>
02934     <span class="comment">// The boot process takes a while loading drivers.   Indicate that</span>
02935     <span class="comment">// progress is being made.</span>
02936     <span class="comment">//</span>
02937 
02938     <a class="code" href="../../d0/d1/inbv_8h.html#a13">InbvIndicateProgress</a>();
02939 
02940     <span class="comment">//</span>
02941     <span class="comment">// Get start and sice for the DriverObject.</span>
02942     <span class="comment">//</span>
02943 
02944     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>) {
02945         imageBase = <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;DllBase;
02946         ntHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(imageBase);
02947         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o4">DriverStart</a> = imageBase;
02948         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o5">DriverSize</a> = ntHeaders-&gt;OptionalHeader.SizeOfImage;
02949         <span class="keywordflow">if</span> (!(ntHeaders-&gt;OptionalHeader.DllCharacteristics &amp; IMAGE_DLLCHARACTERISTICS_WDM_DRIVER)) {
02950             driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a144">DRVO_LEGACY_DRIVER</a>;
02951         }
02952     } <span class="keywordflow">else</span> {
02953         ntHeaders = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02954         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a144">DRVO_LEGACY_DRIVER</a>;
02955     }
02956 
02957     <span class="comment">//</span>
02958     <span class="comment">// Save the name of the driver so that it can be easily located by functions</span>
02959     <span class="comment">// such as error logging.</span>
02960     <span class="comment">//</span>
02961 
02962     buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, DriverName-&gt;MaximumLength + 2 );
02963 
02964     <span class="keywordflow">if</span> (buffer) {
02965         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Buffer = buffer;
02966         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.MaximumLength = DriverName-&gt;MaximumLength;
02967         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Length = DriverName-&gt;Length;
02968 
02969         RtlCopyMemory( driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Buffer,
02970                        DriverName-&gt;Buffer,
02971                        DriverName-&gt;MaximumLength );
02972         buffer[DriverName-&gt;Length &gt;&gt; 1] = (WCHAR) <span class="charliteral">'\0'</span>;
02973     }
02974 
02975     <span class="comment">//</span>
02976     <span class="comment">// Save the name of the service key so that it can be easily located by PnP</span>
02977     <span class="comment">// mamager.</span>
02978     <span class="comment">//</span>
02979 
02980     driverExtension = driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>;
02981     <span class="keywordflow">if</span> (RegistryPath &amp;&amp; RegistryPath-&gt;Length != 0) {
02982         pserviceName = RegistryPath-&gt;Buffer + RegistryPath-&gt;Length / <span class="keyword">sizeof</span> (WCHAR) - 1;
02983         <span class="keywordflow">if</span> (*pserviceName == OBJ_NAME_PATH_SEPARATOR) {
02984             pserviceName--;
02985         }
02986         serviceNameLength = 0;
02987         <span class="keywordflow">while</span> (pserviceName != RegistryPath-&gt;Buffer) {
02988             <span class="keywordflow">if</span> (*pserviceName == OBJ_NAME_PATH_SEPARATOR) {
02989                 pserviceName++;
02990                 <span class="keywordflow">break</span>;
02991             } <span class="keywordflow">else</span> {
02992                 serviceNameLength += <span class="keyword">sizeof</span>(WCHAR);
02993                 pserviceName--;
02994             }
02995         }
02996         <span class="keywordflow">if</span> (pserviceName == RegistryPath-&gt;Buffer) {
02997             serviceNameLength += <span class="keyword">sizeof</span>(WCHAR);
02998         }
02999         buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, serviceNameLength + <span class="keyword">sizeof</span>(UNICODE_NULL) );
03000 
03001         <span class="keywordflow">if</span> (buffer) {
03002             driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Buffer = buffer;
03003             driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.MaximumLength = serviceNameLength + <span class="keyword">sizeof</span>(UNICODE_NULL);
03004             driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Length = serviceNameLength;
03005 
03006             RtlCopyMemory( driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Buffer,
03007                            pserviceName,
03008                            serviceNameLength );
03009             buffer[driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Length &gt;&gt; 1] = UNICODE_NULL;
03010         } <span class="keywordflow">else</span> {
03011             status = STATUS_INSUFFICIENT_RESOURCES;
03012             driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03013             driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Length = 0;
03014             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03015         }
03016 
03017         <span class="comment">//</span>
03018         <span class="comment">// Prepare driver initialization</span>
03019         <span class="comment">//</span>
03020 
03021         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;serviceHandle,
03022                                        NULL,
03023                                        RegistryPath,
03024                                        KEY_ALL_ACCESS
03025                                        );
03026         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03027             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a5">IopPrepareDriverLoading</a>(&amp;driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>,
03028                                              serviceHandle,
03029                                              ntHeaders);
03030             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(serviceHandle);
03031             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03032                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03033             }
03034         } <span class="keywordflow">else</span> {
03035             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03036         }
03037     } <span class="keywordflow">else</span> {
03038         driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03039         driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.MaximumLength = 0;
03040         driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Length = 0;
03041     }
03042 
03043     <span class="comment">//</span>
03044     <span class="comment">// Load the Registry information in the appropriate fields of the device</span>
03045     <span class="comment">// object.</span>
03046     <span class="comment">//</span>
03047 
03048     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o9">HardwareDatabase</a> = &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a17">CmRegistryMachineHardwareDescriptionSystemName</a>;
03049 
03050 <span class="preprocessor">#if DBG</span>
03051 <span class="preprocessor"></span>    <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;stime);
03052 <span class="preprocessor">#endif</span>
03053 <span class="preprocessor"></span>
03054     <span class="comment">//</span>
03055     <span class="comment">// Now invoke the driver's initialization routine to initialize itself.</span>
03056     <span class="comment">//</span>
03057 
03058     <a class="code" href="../../d2/d1/mm_8h.html#a45">PERFINFO_DRIVER_INIT</a>( driverObject);
03059 
03060     status = driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o11">DriverInit</a>( driverObject, RegistryPath );
03061 
03062     <a class="code" href="../../d2/d1/mm_8h.html#a46">PERFINFO_DRIVER_INIT_COMPLETE</a>( driverObject);
03063 
03064 <span class="preprocessor">#if DBG</span>
03065 <span class="preprocessor"></span>
03066     <span class="comment">//</span>
03067     <span class="comment">// If DriverInit took longer than 5 seconds or the driver did not load,</span>
03068     <span class="comment">// print a message.</span>
03069     <span class="comment">//</span>
03070 
03071     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;etime);
03072     dtime  = (ULONG) ((etime.QuadPart - stime.QuadPart) / 1000000);
03073 
03074     <span class="keywordflow">if</span> (dtime &gt; 50  ||  !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03075         <span class="keywordflow">if</span> (dtime &lt; 10) {
03076             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: Built-in driver %wZ failed to initialize - %lX\n"</span>,
03077                 DriverName, status );
03078 
03079         } <span class="keywordflow">else</span> {
03080             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOINIT: Built-in driver %wZ took %d.%ds to "</span>,
03081                 DriverName, dtime/10, dtime%10 );
03082 
03083             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03084                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"initialize\n"</span>);
03085             } <span class="keywordflow">else</span> {
03086                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"fail initialization - %lX\n"</span>, status);
03087             }
03088         }
03089     }
03090 <span class="preprocessor">#endif</span>
03091 <span class="preprocessor"></span><a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
03092     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
03093 
03094     <span class="comment">//</span>
03095     <span class="comment">// If we load the driver because we think it is a legacy driver and</span>
03096     <span class="comment">// it does not create any device object in its DriverEntry.  We will</span>
03097     <span class="comment">// unload this driver.</span>
03098     <span class="comment">//</span>
03099 
03100     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; !<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a32">IopIsLegacyDriver</a>(driverObject)) {
03101         <span class="keywordflow">if</span> (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o2">DeviceObject</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>     &amp;&amp;
03102             driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Buffer &amp;&amp;
03103             !<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">IopIsAnyDeviceInstanceEnabled</a>(&amp;driverExtension-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>, NULL, FALSE)) {
03104             <span class="keywordflow">if</span> (TextModeSetup &amp;&amp; !(driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a146">DRVO_REINIT_REGISTERED</a>)) {
03105 
03106                 <span class="comment">//</span>
03107                 <span class="comment">// Clean up but leave driver object.  Because it may be needed later.</span>
03108                 <span class="comment">// After boot driver phase completes, we will process all the driver objects</span>
03109                 <span class="comment">// which still have no device to control.</span>
03110                 <span class="comment">//</span>
03111 
03112                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a18">IopDriverLoadingFailed</a>(NULL, &amp;driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>);
03113             }
03114         } <span class="keywordflow">else</span> {
03115 
03116             <span class="comment">//</span>
03117             <span class="comment">// Start the devices controlled by the driver and enumerate them</span>
03118             <span class="comment">// At this point, we know there is at least one device controlled by the driver.</span>
03119             <span class="comment">//</span>
03120 
03121             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a34">IopDeleteLegacyKey</a>(driverObject);
03122         }
03123     }
03124 
03125     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03126         <a class="code" href="../../d0/d6/iop_8h.html#a207">IopReadyDeviceObjects</a>( driverObject );
03127         <span class="keywordflow">return</span> driverObject;
03128     } <span class="keywordflow">else</span> {
03129         <span class="keywordflow">if</span> (status != STATUS_PLUGPLAY_NO_DEVICE) {
03130 
03131             <span class="comment">//</span>
03132             <span class="comment">// if STATUS_PLUGPLAY_NO_DEVICE, the driver was disable by hardware profile.</span>
03133             <span class="comment">//</span>
03134 
03135             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a18">IopDriverLoadingFailed</a>(NULL, &amp;driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>);
03136             <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( driverObject );
03137             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ( driverObject );
03138         }
03139         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03140     }
03141 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ioinit.c::IopInitializeData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopInitializeData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="ioinit.c::IopInitializeSingleBootDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopInitializeSingleBootDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">PBOOT_DRIVER_LIST_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>BootDriver</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING DriverName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="ioinit.c::IopInitializeSystemDrivers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopInitializeSystemDrivers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">3146</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00684">_START_CONTEXT::AddContext</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00056">_TREE_ENTRY::DriversLoaded</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00678">_ADD_CONTEXT::DriverStartType</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00676">_ADD_CONTEXT::GroupsToStart</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00677">_ADD_CONTEXT::GroupToStartNext</a>, <a class="el" href="../../d0/d1/inbv_8h.html#a13">InbvIndicateProgress()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00978">IopCheckDependencies()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02072">IopGetDriverNameFromKeyNode()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03379">IopLookupGroupName()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01053">IopProcessAddDevices()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01185">IopProcessAssignResources()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00821">IopProcessStartDevices()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03578">IopReferenceDriverObjectByName()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00682">_START_CONTEXT::LoadDriver</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00683">_START_CONTEXT::NewDevice</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00671">NO_MORE_GROUP</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00110">PnPInitialized</a>, <a class="el" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>03152                    :
03153 
03154     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to load and initialize all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> drivers that
03155     are supposed to be loaded during Phase 1 initialization of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O
03156     system.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accomplished by calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Configuration <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a> to
03157     get a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>-terminated array of handles to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open keys <span class="keywordflow">for</span> each driver
03158     that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be loaded, and then loading and initializing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver.
03159 
03160 Arguments:
03161 
03162     None.
03163 
03164 Return Value:
03165 
03166     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a BOOLEAN indicating whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> drivers
03167     were successfully loaded and initialized.
03168 
03169 --*/
03170 
03171 {
03172     BOOLEAN  newDevice, moreProcessing;
03173     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03174     PHANDLE driverList;
03175     PHANDLE savedList;
03176     HANDLE enumHandle;
03177     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03178     UNICODE_STRING groupName, enumName;
03179     <a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a> treeEntry;
03180     UNICODE_STRING driverName;
03181     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
03182     <a class="code" href="../../d0/d6/struct__START__CONTEXT.html">START_CONTEXT</a> startContext;
03183 
03184     <span class="comment">//</span>
03185     <span class="comment">// Scan the device node tree to process any device which have been enumerated</span>
03186     <span class="comment">// but not been added/started.</span>
03187     <span class="comment">//</span>
03188 
03189     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o0">LoadDriver</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03190     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o2">DriverStartType</a> = SERVICE_DEMAND_START;
03191 
03192     <a class="code" href="../../d9/d0/pnpiop_8h.html#a261">IopProcessAddDevices</a>(IopRootDeviceNode, NO_MORE_GROUP, SERVICE_DEMAND_START);
03193 
03194     <span class="comment">//</span>
03195     <span class="comment">// Process the whole device tree to assign resources to those devices who</span>
03196     <span class="comment">// have been successfully added to their drivers.</span>
03197     <span class="comment">//</span>
03198 
03199     newDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03200     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o0">GroupsToStart</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
03201     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
03202     <span class="keywordflow">while</span> (newDevice || moreProcessing) {
03203         startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03204         moreProcessing = <a class="code" href="../../d9/d0/pnpiop_8h.html#a262">IopProcessAssignResources</a>(IopRootDeviceNode, FALSE, TRUE);
03205 
03206         <span class="comment">//</span>
03207         <span class="comment">// Process the whole device tree to start those devices who have been allocated</span>
03208         <span class="comment">// resources and waiting to be started.</span>
03209         <span class="comment">// Note, the IopProcessStartDevices routine may enumerate new devices.</span>
03210         <span class="comment">//</span>
03211 
03212         <a class="code" href="../../d9/d0/pnpiop_8h.html#a263">IopProcessStartDevices</a>(IopRootDeviceNode, &amp;startContext);
03213         newDevice = startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a>;
03214     }
03215 
03216     <span class="comment">//</span>
03217     <span class="comment">// Walk thru the service list to load the remaining system start drivers.</span>
03218     <span class="comment">// (Most likely these drivers are software drivers.)</span>
03219     <span class="comment">//</span>
03220 
03221     <span class="comment">//</span>
03222     <span class="comment">// Get the list of drivers that are to be loaded during this phase of</span>
03223     <span class="comment">// system initialization, and invoke each driver in turn.  Ensure that</span>
03224     <span class="comment">// the list really exists, otherwise get out now.</span>
03225     <span class="comment">//</span>
03226 
03227     <span class="keywordflow">if</span> (!(driverList = <a class="code" href="../../d7/d9/cm_8h.html#a29">CmGetSystemDriverList</a>())) {
03228         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03229     }
03230 
03231     <span class="comment">//</span>
03232     <span class="comment">// Walk the entire list, loading each of the drivers if not already loaded,</span>
03233     <span class="comment">// until there are no more drivers in the list.</span>
03234     <span class="comment">//</span>
03235 
03236     <span class="keywordflow">for</span> (savedList = driverList; *driverList; driverList++) {
03237 
03238         <span class="comment">//</span>
03239         <span class="comment">// Now check if the driver has been loaded already.</span>
03240         <span class="comment">// get the name of the driver object first ...</span>
03241         <span class="comment">//</span>
03242 
03243         status = <a class="code" href="../../d0/d6/iop_8h.html#a175">IopGetDriverNameFromKeyNode</a>( *driverList,
03244                                               &amp;driverName );
03245         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03246 
03247             driverObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a22">IopReferenceDriverObjectByName</a>(&amp;driverName);
03248             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;driverName);
03249             <span class="keywordflow">if</span> (driverObject) {
03250 
03251                 <span class="comment">//</span>
03252                 <span class="comment">// Driver was loaded already.  Dereference the driver object</span>
03253                 <span class="comment">// and skip it.</span>
03254                 <span class="comment">//</span>
03255 
03256                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(driverObject);
03257                 <span class="keywordflow">continue</span>;
03258             }
03259         }
03260 
03261         <span class="comment">//</span>
03262         <span class="comment">// Open registry ServiceKeyName\Enum branch to check if the driver was</span>
03263         <span class="comment">// loaded before but failed.</span>
03264         <span class="comment">//</span>
03265 
03266         PiWstrToUnicodeString(&amp;enumName, REGSTR_KEY_ENUM);
03267         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumHandle,
03268                                        *driverList,
03269                                        &amp;enumName,
03270                                        KEY_READ
03271                                        );
03272 
03273         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03274 
03275             ULONG startFailed = 0;
03276 
03277             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(enumHandle, L<span class="stringliteral">"INITSTARTFAILED"</span>, &amp;keyValueInformation);
03278 
03279             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03280                 <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
03281                     startFailed = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03282                 }
03283                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
03284             }
03285             ZwClose(enumHandle);
03286             <span class="keywordflow">if</span> (startFailed != 0) {
03287                 <span class="keywordflow">continue</span>;
03288             }
03289         }
03290 
03291         <span class="comment">//</span>
03292         <span class="comment">// The driver is not loaded yet.  Load it ...</span>
03293         <span class="comment">//</span>
03294 
03295         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( *driverList,
03296                                       L<span class="stringliteral">"Group"</span>,
03297                                       &amp;keyValueInformation );
03298         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03299             <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
03300                 groupName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyValueInformation-&gt;DataLength;
03301                 groupName.MaximumLength = groupName.Length;
03302                 groupName.Buffer = (PWSTR) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
03303                 treeEntry = <a class="code" href="../../d9/d5/ioinit_8c.html#a26">IopLookupGroupName</a>( &amp;groupName, TRUE );
03304             } <span class="keywordflow">else</span> {
03305                 treeEntry = (<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03306             }
03307             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
03308         } <span class="keywordflow">else</span> {
03309             treeEntry = (<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03310         }
03311 
03312         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a15">IopCheckDependencies</a>( *driverList )) {
03313             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a191">IopLoadDriver</a>( *driverList, TRUE ) )) {
03314                 <span class="keywordflow">if</span> (treeEntry) {
03315                     treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o4">DriversLoaded</a>++;
03316                 }
03317             }
03318         }
03319 
03320         <span class="comment">//</span>
03321         <span class="comment">// The boot process takes a while loading drivers.   Indicate that</span>
03322         <span class="comment">// progress is being made.</span>
03323         <span class="comment">//</span>
03324 
03325         <a class="code" href="../../d0/d1/inbv_8h.html#a13">InbvIndicateProgress</a>();
03326 
03327     }
03328 
03329     <span class="comment">//</span>
03330     <span class="comment">// Finally, free the pool that was allocated for the list and return</span>
03331     <span class="comment">// an indicator the load operation worked.</span>
03332     <span class="comment">//</span>
03333 
03334     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( (PVOID) savedList );
03335 
03336     <span class="comment">//</span>
03337     <span class="comment">// Walk the device tree again to enumerate any devices reported after the system drivers</span>
03338     <span class="comment">// started.</span>
03339     <span class="comment">//</span>
03340 
03341     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o0">LoadDriver</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03342     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o2">DriverStartType</a> = SERVICE_DEMAND_START;
03343 
03344     <a class="code" href="../../d9/d0/pnpiop_8h.html#a261">IopProcessAddDevices</a>(IopRootDeviceNode, NO_MORE_GROUP, SERVICE_DEMAND_START);
03345 
03346     <span class="comment">//</span>
03347     <span class="comment">// Process the whole device tree to assign resources to those devices who</span>
03348     <span class="comment">// have been successfully added to their drivers.</span>
03349     <span class="comment">//</span>
03350 
03351     newDevice = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03352     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o0">GroupsToStart</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
03353     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
03354     <span class="keywordflow">do</span> {
03355         startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03356         moreProcessing = <a class="code" href="../../d9/d0/pnpiop_8h.html#a262">IopProcessAssignResources</a>(IopRootDeviceNode, newDevice, TRUE);
03357 
03358         <span class="comment">//</span>
03359         <span class="comment">// Process the whole device tree to start those devices who have been allocated</span>
03360         <span class="comment">// resources and waiting to be started.</span>
03361         <span class="comment">// Note, the IopProcessStartDevices routine may enumerate new devices.</span>
03362         <span class="comment">//</span>
03363 
03364         <a class="code" href="../../d9/d0/pnpiop_8h.html#a263">IopProcessStartDevices</a>(IopRootDeviceNode, &amp;startContext);
03365         newDevice = startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a>;
03366     } <span class="keywordflow">while</span> (newDevice || moreProcessing) ;
03367 
03368     <span class="comment">//</span>
03369     <span class="comment">// Mark pnp has completed the driver loading for both system and</span>
03370     <span class="comment">// autoload drivers.</span>
03371     <span class="comment">//</span>
03372 
03373     <a class="code" href="../../d1/d0/pnpdata_8c.html#a14">PnPInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03374 
03375     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03376 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="ioinit.c::IopInsertDriverList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopInsertDriverList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>ListHead</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d9/struct__DRIVER__INFORMATION.html">PDRIVER_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04267">4267</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d9/d5/ioinit_8c.html#a6">PDRIVER_INFORMATION</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00065">_DRIVER_INFORMATION::TagPosition</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>04274                    :
04275 
04276     This routine reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Tag value of a driver and determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag's priority
04277     among its driver group.
04278 
04279 Arguments:
04280 
04281     ServiceHandle - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's service key.
04282 
04283 Return Value:
04284 
04285     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <span class="keywordflow">for</span> priority.
04286 
04287 --*/
04288 
04289 {
04290     PLIST_ENTRY nextEntry;
04291     <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">PDRIVER_INFORMATION</a> info;
04292 
04293     nextEntry = ListHead-&gt;Flink;
04294     <span class="keywordflow">while</span> (nextEntry != ListHead) {
04295         info = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">DRIVER_INFORMATION</a>, Link);
04296 
04297         <span class="comment">//</span>
04298         <span class="comment">// Scan the driver info list to find the driver whose priority is</span>
04299         <span class="comment">// lower than current driver's.</span>
04300         <span class="comment">// (Lower TagPosition value means higher Priority)</span>
04301         <span class="comment">//</span>
04302 
04303         <span class="keywordflow">if</span> (info-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o4">TagPosition</a> &gt; DriverInfo-&gt;TagPosition) {
04304             <span class="keywordflow">break</span>;
04305         }
04306         nextEntry = nextEntry-&gt;Flink;
04307     }
04308 
04309     <span class="comment">//</span>
04310     <span class="comment">// Insert the Driver info to the front of the nextEntry</span>
04311     <span class="comment">//</span>
04312 
04313     nextEntry = nextEntry-&gt;Blink;
04314     InsertHeadList(nextEntry, &amp;DriverInfo-&gt;Link);
04315 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="ioinit.c::IopLoadBootFilterDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> IopLoadBootFilterDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04654">4654</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00063">_DRIVER_INFORMATION::DataTableEntry</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00062">_DRIVER_INFORMATION::DriverObject</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02072">IopGetDriverNameFromKeyNode()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00081">IopGroupIndex</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00082">IopGroupTable</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d8/d8/cm_8h-source.html#l00103">_BOOT_DRIVER_LIST_ENTRY::LdrEntry</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d9/d5/ioinit_8c.html#a6">PDRIVER_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00522">PDRIVER_INITIALIZE</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00067">_DRIVER_INFORMATION::Processed</a>, <a class="el" href="../../d8/d8/cm_8h-source.html#l00102">_BOOT_DRIVER_LIST_ENTRY::RegistryPath</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00064">_DRIVER_INFORMATION::ServiceHandle</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>.
<p>
<pre class="fragment"><div>04661                    :
04662 
04663     This initializes boot filter drivers.
04664 
04665 Arguments:
04666 
04667     DriverName - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to be initialized.
04668 
04669     GroupIndex - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Driver's group index (could be anything)
04670 
04671 Return Value:
04672 
04673     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>
04674 
04675 --*/
04676 
04677 {
04678     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04679     PLIST_ENTRY nextEntry;
04680     <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">PDRIVER_INFORMATION</a> driverInfo;
04681     UNICODE_STRING completeName;
04682     <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">PBOOT_DRIVER_LIST_ENTRY</a> bootDriver;
04683     PLDR_DATA_TABLE_ENTRY driverEntry;
04684     HANDLE keyHandle;
04685     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04686 
04687     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || GroupIndex &gt;= <a class="code" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a>) {
04688 
04689         <span class="comment">//</span>
04690         <span class="comment">// If we have not reached the boot driver initialization phase or</span>
04691         <span class="comment">// the filter driver is not a boot driver.</span>
04692         <span class="comment">//</span>
04693 
04694         <span class="keywordflow">return</span> driverObject;
04695     }
04696 
04697     <span class="comment">//</span>
04698     <span class="comment">// Go thru every driver that we initialized.  If it supports AddDevice entry and</span>
04699     <span class="comment">// did not create any device object after we start it.  We mark it as failure so</span>
04700     <span class="comment">// text mode setup knows this driver is not needed.</span>
04701     <span class="comment">//</span>
04702 
04703     nextEntry = <a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>[GroupIndex].Flink;
04704     <span class="keywordflow">while</span> (nextEntry != &amp;<a class="code" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>[GroupIndex]) {
04705 
04706         driverInfo = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html">DRIVER_INFORMATION</a>, Link);
04707         <span class="keywordflow">if</span> (driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o6">Processed</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04708 
04709             keyHandle = driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o3">ServiceHandle</a>;
04710 
04711             status = <a class="code" href="../../d0/d6/iop_8h.html#a175">IopGetDriverNameFromKeyNode</a>( keyHandle,
04712                                                   &amp;completeName );
04713             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04714                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(DriverName,
04715                                           &amp;completeName,
04716                                           TRUE)) {    <span class="comment">// case-insensitive</span>
04717 
04718                     bootDriver = driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o2">DataTableEntry</a>;
04719                     driverEntry = bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o3">LdrEntry</a>;
04720 
04721                     driverObject = <a class="code" href="../../d9/d5/ioinit_8c.html#a23">IopInitializeBuiltinDriver</a>(
04722                                        &amp;completeName,
04723                                        &amp;bootDriver-&gt;<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o2">RegistryPath</a>,
04724                                        (PDRIVER_INITIALIZE) driverEntry-&gt;EntryPoint,
04725                                        driverEntry,
04726                                        FALSE);
04727                     driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o1">DriverObject</a> = driverObject;
04728                     driverInfo-&gt;<a class="code" href="../../d2/d9/struct__DRIVER__INFORMATION.html#o6">Processed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04729                     <span class="comment">//</span>
04730                     <span class="comment">// Pnp might unload the driver before we get a chance to look at this. So take an extra</span>
04731                     <span class="comment">// reference.</span>
04732                     <span class="comment">//</span>
04733                     <span class="keywordflow">if</span> (driverObject) {
04734                         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(driverObject);
04735                     }
04736                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(completeName.Buffer);
04737                     <span class="keywordflow">break</span>;
04738                 }
04739                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(completeName.Buffer);
04740             }
04741         }
04742 
04743         nextEntry = nextEntry-&gt;Flink;
04744     }
04745     <span class="keywordflow">return</span> driverObject;
04746 }
<span class="preprocessor">#if 0</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="ioinit.c::IopLogErrorEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopLogErrorEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SequenceNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UniqueErrorValue</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>FinalStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>SpecificIOStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LengthOfInsert1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Insert1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LengthOfInsert2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Insert2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04393">4393</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00428">IoAllocateErrorLogEntry()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00075">IopErrorLogObject</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11556">IoWriteErrorLogEntry()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04061">IopCompleteDumpInitialization()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04746">IopConfigureCrashDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>.
<p>
<pre class="fragment"><div>04406                    :
04407 
04408     This routine allocates an error log entry, copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied data
04409     to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, and requests that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> be written to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
04410 
04411 Arguments:
04412     SequenceNumber - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unique to an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> over <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> life of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp in
04413     <span class="keyword">this</span> driver. - 0 generally means an error not associated with an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>
04414 
04415     UniqueErrorValue - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> unique <span class="keywordtype">long</span> word that identifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> particular
04416     call to <span class="keyword">this</span> function.
04417 
04418     FinalStatus - The <span class="keyword">final</span> status given to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp that was associated
04419     with <span class="keyword">this</span> error.  If <span class="keyword">this</span> log entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> during one of
04420     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> retries <span class="keyword">this</span> value will be STATUS_SUCCESS.
04421 
04422     SpecificIOStatus - The IO status <span class="keywordflow">for</span> a particular error.
04423 
04424     LengthOfInsert1 - The length in bytes (including the terminating NULL)
04425                       of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first insertion string.
04426 
04427     Insert1 - The first insertion string.
04428 
04429     LengthOfInsert2 - The length in bytes (including the terminating NULL)
04430                       of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second insertion string.  NOTE, there must
04431                       be a first insertion string <span class="keywordflow">for</span> their to be
04432                       a second insertion string.
04433 
04434     Insert2 - The second insertion string.
04435 
04436 Return Value:
04437 
04438     STATUS_SUCCESS - Success
04439     STATUS_INVALID_HANDLE - <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a114">Uninitialized</a> error log device object
04440     STATUS_NO_DATA_DETECTED - <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> log entry
04441 
04442 --*/
04443 
04444 {
04445     PIO_ERROR_LOG_PACKET errorLogEntry;
04446     PUCHAR ptrToFirstInsert;
04447     PUCHAR ptrToSecondInsert;
04448 
04449     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a8">IopErrorLogObject</a>) {
04450         <span class="keywordflow">return</span>(STATUS_INVALID_HANDLE);
04451     }
04452 
04453 
04454     errorLogEntry = <a class="code" href="../../d4/d6/iosubs_8c.html#a14">IoAllocateErrorLogEntry</a>(
04455                         IopErrorLogObject,
04456                         (UCHAR)( <span class="keyword">sizeof</span>(IO_ERROR_LOG_PACKET) +
04457                                 LengthOfInsert1 +
04458                                 LengthOfInsert2) );
04459 
04460    <span class="keywordflow">if</span> ( errorLogEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04461 
04462       errorLogEntry-&gt;ErrorCode = SpecificIOStatus;
04463       errorLogEntry-&gt;SequenceNumber = SequenceNumber;
04464       errorLogEntry-&gt;MajorFunctionCode = 0;
04465       errorLogEntry-&gt;RetryCount = 0;
04466       errorLogEntry-&gt;UniqueErrorValue = UniqueErrorValue;
04467       errorLogEntry-&gt;FinalStatus = FinalStatus;
04468       errorLogEntry-&gt;DumpDataSize = 0;
04469 
04470       ptrToFirstInsert = (PUCHAR)&amp;errorLogEntry-&gt;DumpData[0];
04471 
04472       ptrToSecondInsert = ptrToFirstInsert + LengthOfInsert1;
04473 
04474       <span class="keywordflow">if</span> (LengthOfInsert1) {
04475 
04476          errorLogEntry-&gt;NumberOfStrings = 1;
04477          errorLogEntry-&gt;StringOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(ptrToFirstInsert -
04478                                                 (PUCHAR)errorLogEntry);
04479          RtlCopyMemory(
04480                       ptrToFirstInsert,
04481                       Insert1,
04482                       LengthOfInsert1
04483                       );
04484 
04485          <span class="keywordflow">if</span> (LengthOfInsert2) {
04486 
04487             errorLogEntry-&gt;NumberOfStrings = 2;
04488             RtlCopyMemory(
04489                          ptrToSecondInsert,
04490                          Insert2,
04491                          LengthOfInsert2
04492                          );
04493 
04494          } <span class="comment">//LenghtOfInsert2</span>
04495 
04496       } <span class="comment">// LenghtOfInsert1</span>
04497 
04498       <a class="code" href="../../d4/d6/iosubs_8c.html#a123">IoWriteErrorLogEntry</a>(errorLogEntry);
04499       <span class="keywordflow">return</span>(STATUS_SUCCESS);
04500 
04501    }  <span class="comment">// errorLogEntry != NULL</span>
04502 
04503     <span class="keywordflow">return</span>(STATUS_NO_DATA_DETECTED);
04504 
04505 } <span class="comment">//IopLogErrorEvent</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="ioinit.c::IopLookupGroupName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a> IopLookupGroupName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Insert</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03379">3379</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00057">_TREE_ENTRY::GroupName</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02107">IopCreateEntry()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00070">IopGroupListHead</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00052">_TREE_ENTRY::Left</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d5/ioinit_8c.html#a4">PTREE_ENTRY</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00053">_TREE_ENTRY::Right</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00054">_TREE_ENTRY::Sibling</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00978">IopCheckDependencies()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>.
<p>
<pre class="fragment"><div>03386                    :
03387 
03388     This routine looks up a group entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group load tree and either
03389     returns a pointer to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, or optionally creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry and inserts
03390     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree.
03391 
03392 Arguments:
03393 
03394     GroupName - The name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group to look up, or insert.
03395 
03396     Insert - Indicates whether or not an entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be created and inserted
03397         into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name does not already exist.
03398 
03399 Return Value:
03400 
03401     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified group
03402     name, or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
03403 
03404 --*/
03405 
03406 {
03407     <a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a> treeEntry;
03408     <a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a> previousEntry;
03409 
03410     <span class="comment">//</span>
03411     <span class="comment">// Begin by determining whether or not there are any entries in the tree</span>
03412     <span class="comment">// whatsoever.  If not, and it is OK to insert, then insert this entry</span>
03413     <span class="comment">// into the tree.</span>
03414     <span class="comment">//</span>
03415 
03416     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d5/ioinit_8c.html#a7">IopGroupListHead</a>) {
03417         <span class="keywordflow">if</span> (!Insert) {
03418             <span class="keywordflow">return</span> (<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03419         } <span class="keywordflow">else</span> {
03420             <a class="code" href="../../d9/d5/ioinit_8c.html#a7">IopGroupListHead</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a18">IopCreateEntry</a>( GroupName );
03421             <span class="keywordflow">return</span> <a class="code" href="../../d9/d5/ioinit_8c.html#a7">IopGroupListHead</a>;
03422         }
03423     }
03424 
03425     <span class="comment">//</span>
03426     <span class="comment">// The tree is not empty, so actually attempt to do a lookup.</span>
03427     <span class="comment">//</span>
03428 
03429     treeEntry = <a class="code" href="../../d9/d5/ioinit_8c.html#a7">IopGroupListHead</a>;
03430 
03431     <span class="keywordflow">for</span> (;;) {
03432         <span class="keywordflow">if</span> (GroupName-&gt;Length &lt; treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>.Length) {
03433             <span class="keywordflow">if</span> (treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o0">Left</a>) {
03434                 treeEntry = treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o0">Left</a>;
03435             } <span class="keywordflow">else</span> {
03436                 <span class="keywordflow">if</span> (!Insert) {
03437                     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03438                 } <span class="keywordflow">else</span> {
03439                     treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o0">Left</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a18">IopCreateEntry</a>( GroupName );
03440                     <span class="keywordflow">return</span> treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o0">Left</a>;
03441                 }
03442 
03443             }
03444         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GroupName-&gt;Length &gt; treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>.Length) {
03445             <span class="keywordflow">if</span> (treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o1">Right</a>) {
03446                 treeEntry = treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o1">Right</a>;
03447             } <span class="keywordflow">else</span> {
03448                 <span class="keywordflow">if</span> (!Insert) {
03449                     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03450                 } <span class="keywordflow">else</span> {
03451                     treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o1">Right</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a18">IopCreateEntry</a>( GroupName );
03452                     <span class="keywordflow">return</span> treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o1">Right</a>;
03453                 }
03454             }
03455         } <span class="keywordflow">else</span> {
03456             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>( GroupName, &amp;treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o5">GroupName</a>, TRUE )) {
03457                 previousEntry = treeEntry;
03458                 <span class="keywordflow">while</span> (treeEntry-&gt;Sibling) {
03459                     treeEntry = treeEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o2">Sibling</a>;
03460                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>( GroupName, &amp;treeEntry-&gt;GroupName, TRUE )) {
03461                         <span class="keywordflow">return</span> treeEntry;
03462                     }
03463                     previousEntry = previousEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o2">Sibling</a>;
03464                 }
03465                 <span class="keywordflow">if</span> (!Insert) {
03466                     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03467                 } <span class="keywordflow">else</span> {
03468                     previousEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o2">Sibling</a> = <a class="code" href="../../d9/d5/ioinit_8c.html#a18">IopCreateEntry</a>( GroupName );
03469                     <span class="keywordflow">return</span> previousEntry-&gt;<a class="code" href="../../d4/d2/struct__TREE__ENTRY.html#o2">Sibling</a>;
03470                 }
03471             } <span class="keywordflow">else</span> {
03472                 <span class="keywordflow">return</span> treeEntry;
03473             }
03474         }
03475     }
03476 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="ioinit.c::IopMarkBootPartition" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopMarkBootPartition           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03479">3479</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01160">DO_SYSTEM_BOOT_PARTITION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00075">IopErrorLogObject</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00582">ZwOpenFile()</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>03485                    :
03486 
03487     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to locate and mark <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot partition device object
03488     as a boot device so that subsequent operations can fail more cleanly and
03489     with a better explanation of why <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system failed to boot and run properly.
03490 
03491 Arguments:
03492 
03493     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader parameter block created
03494         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS Loader during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot process.  This structure contains
03495         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> various system partition and boot device names and paths.
03496 
03497 Return Value:
03498 
03499     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> everything worked, otherwise <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
03500 
03501 Notes:
03502 
03503     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot partition device object cannot be found, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system will
03504     bugcheck.
03505 
03506 --*/
03507 
03508 {
03509     OBJECT_ATTRIBUTES objectAttributes;
03510     STRING deviceNameString;
03511     UCHAR deviceNameBuffer[256];
03512     UNICODE_STRING deviceNameUnicodeString;
03513     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03514     HANDLE fileHandle;
03515     IO_STATUS_BLOCK ioStatus;
03516     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
03517     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> ArcNameFmt[12];
03518 
03519     ArcNameFmt[0] = <span class="charliteral">'\\'</span>;
03520     ArcNameFmt[1] = <span class="charliteral">'A'</span>;
03521     ArcNameFmt[2] = <span class="charliteral">'r'</span>;
03522     ArcNameFmt[3] = <span class="charliteral">'c'</span>;
03523     ArcNameFmt[4] = <span class="charliteral">'N'</span>;
03524     ArcNameFmt[5] = <span class="charliteral">'a'</span>;
03525     ArcNameFmt[6] = <span class="charliteral">'m'</span>;
03526     ArcNameFmt[7] = <span class="charliteral">'e'</span>;
03527     ArcNameFmt[8] = <span class="charliteral">'\\'</span>;
03528     ArcNameFmt[9] = <span class="charliteral">'%'</span>;
03529     ArcNameFmt[10] = <span class="charliteral">'s'</span>;
03530     ArcNameFmt[11] = <span class="charliteral">'\0'</span>;
03531     <span class="comment">//</span>
03532     <span class="comment">// Open the ARC boot device object. The boot device driver should have</span>
03533     <span class="comment">// created the object.</span>
03534     <span class="comment">//</span>
03535 
03536     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
03537              ArcNameFmt,
03538              LoaderBlock-&gt;ArcBootDeviceName );
03539 
03540     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;deviceNameString, deviceNameBuffer );
03541 
03542     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;deviceNameUnicodeString,
03543                                            &amp;deviceNameString,
03544                                            TRUE );
03545 
03546     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03547         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03548     }
03549 
03550     InitializeObjectAttributes( &amp;objectAttributes,
03551                                 &amp;deviceNameUnicodeString,
03552                                 OBJ_CASE_INSENSITIVE,
03553                                 NULL,
03554                                 NULL );
03555 
03556     status = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>( &amp;fileHandle,
03557                          FILE_READ_ATTRIBUTES,
03558                          &amp;objectAttributes,
03559                          &amp;ioStatus,
03560                          0,
03561                          FILE_NON_DIRECTORY_FILE );
03562     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03563         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( INACCESSIBLE_BOOT_DEVICE,
03564                       (ULONG_PTR) &amp;deviceNameUnicodeString,
03565                       status,
03566                       0,
03567                       0 );
03568     }
03569 
03570     <span class="comment">//</span>
03571     <span class="comment">// Convert the file handle into a pointer to the device object itself.</span>
03572     <span class="comment">//</span>
03573 
03574     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( fileHandle,
03575                                         0,
03576                                         IoFileObjectType,
03577                                         KernelMode,
03578                                         (PVOID *) &amp;fileObject,
03579                                         NULL );
03580     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03581         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
03582         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03583     }
03584 
03585     <span class="comment">//</span>
03586     <span class="comment">// Mark the device object represented by the file object.</span>
03587     <span class="comment">//</span>
03588 
03589     fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a129">DO_SYSTEM_BOOT_PARTITION</a>;
03590 
03591 
03592     <span class="comment">//</span>
03593     <span class="comment">// Reference the device object and store the reference.</span>
03594     <span class="comment">//</span>
03595     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>);
03596 
03597     <a class="code" href="../../d9/d5/ioinit_8c.html#a8">IopErrorLogObject</a> =  fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>;
03598 
03599     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
03600 
03601     <span class="comment">//</span>
03602     <span class="comment">// Finally, close the handle and dereference the file object.</span>
03603     <span class="comment">//</span>
03604 
03605     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( fileHandle );
03606     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
03607 
03608     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03609 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="ioinit.c::IopNotifySetupDevices" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopNotifySetupDevices           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04318">4318</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00831">IopClearDevNodeProblem</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">IopIsDevNodeProblem</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08162">IopNotifySetupDeviceArrival()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00185">_DEVICE_NODE::ServiceName</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>04324                    :
04325 
04326     This routine notifies setupdd.sys <span class="keywordflow">for</span> all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumerated devices whose
04327     service have not been setup.
04328 
04329     This routine <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> gets executed on textmode setup phase.
04330 
04331 Parameters:
04332 
04333     DeviceNode - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subtree to be processed.
04334 
04335 Return Value:
04336 
04337     None.
04338 
04339 --*/
04340 
04341 {
04342     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
04343     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
04344     HANDLE handle;
04345     UNICODE_STRING unicodeString;
04346     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04347     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04348 
04349     <span class="keywordflow">while</span> (deviceNode) {
04350         <a class="code" href="../../d9/d5/ioinit_8c.html#a32">IopNotifySetupDevices</a>(deviceNode);
04351         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>.Length == 0) {
04352 
04353             <span class="comment">//</span>
04354             <span class="comment">// We only notify setupdd the device nodes which do not have service setup yet.</span>
04355             <span class="comment">// It is impossible that at this point, a device has a service setup and</span>
04356             <span class="comment">// setupdd has to change it.</span>
04357             <span class="comment">//</span>
04358 
04359             deviceObject = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
04360             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(deviceObject, &amp;handle, KEY_ALL_ACCESS);
04361             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04362 
04363                 <span class="comment">//</span>
04364                 <span class="comment">// Notify setup about the device.</span>
04365                 <span class="comment">//</span>
04366 
04367                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a347">IopNotifySetupDeviceArrival</a>(deviceObject, handle, TRUE);
04368 
04369                 <span class="comment">//</span>
04370                 <span class="comment">// Finally register the device</span>
04371                 <span class="comment">//</span>
04372 
04373                 status = <a class="code" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration</a>(
04374                              &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>,
04375                              TRUE,
04376                              &amp;unicodeString       <span class="comment">// registered ServiceName</span>
04377                              );
04378 
04379                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04380                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a> = unicodeString;
04381                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_NOT_CONFIGURED)) {
04382                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(deviceNode);
04383                     }
04384                 }
04385                 ZwClose(handle);
04386             }
04387         }
04388         deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
04389     }
04390 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="ioinit.c::IopReassignSystemRoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopReassignSystemRoot           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>NtDeviceName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03612">3612</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00024">INIT_SYSTEMROOT_LINKNAME</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00052">NtCreateSymbolicLinkObject()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00414">NtMakeTemporaryObject()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00247">NtOpenSymbolicLinkObject()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00333">NtQuerySymbolicLinkObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00196">RtlCopyString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00246">RtlUnicodeStringToAnsiString()</a>, <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>03619                    :
03620 
03621     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to reassign \SystemRoot from being an ARC <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>
03622     name to its NT <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> name equivalent.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by looking up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03623     ARC device name as a symbolic link and determining which NT device object
03624     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> referred to by <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  The link <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> then replaced with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> name.
03625 
03626 Arguments:
03627 
03628     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader parameter block created
03629         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS Loader during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot process.  This structure contains
03630         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> various system partition and boot device names and paths.
03631 
03632     NtDeviceName - Specifies a pointer to a STRING to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT name of
03633         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device from which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system was booted.
03634 
03635 Return Value:
03636 
03637     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a BOOLEAN indicating whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ARC name
03638     was resolved to an NT name.
03639 
03640 --*/
03641 
03642 {
03643     OBJECT_ATTRIBUTES objectAttributes;
03644     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03645     UCHAR deviceNameBuffer[256];
03646     WCHAR arcNameUnicodeBuffer[64];
03647     UCHAR arcNameStringBuffer[256];
03648     STRING deviceNameString;
03649     STRING arcNameString;
03650     STRING linkString;
03651     UNICODE_STRING linkUnicodeString;
03652     UNICODE_STRING deviceNameUnicodeString;
03653     UNICODE_STRING arcNameUnicodeString;
03654     HANDLE linkHandle;
03655 
03656 <span class="preprocessor">#if DBG</span>
03657 <span class="preprocessor"></span>
03658     UCHAR debugBuffer[256];
03659     STRING debugString;
03660     UNICODE_STRING debugUnicodeString;
03661 
03662 <span class="preprocessor">#endif</span>
03663 <span class="preprocessor"></span>    <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> ArcNameFmt[12];
03664 
03665     ArcNameFmt[0] = <span class="charliteral">'\\'</span>;
03666     ArcNameFmt[1] = <span class="charliteral">'A'</span>;
03667     ArcNameFmt[2] = <span class="charliteral">'r'</span>;
03668     ArcNameFmt[3] = <span class="charliteral">'c'</span>;
03669     ArcNameFmt[4] = <span class="charliteral">'N'</span>;
03670     ArcNameFmt[5] = <span class="charliteral">'a'</span>;
03671     ArcNameFmt[6] = <span class="charliteral">'m'</span>;
03672     ArcNameFmt[7] = <span class="charliteral">'e'</span>;
03673     ArcNameFmt[8] = <span class="charliteral">'\\'</span>;
03674     ArcNameFmt[9] = <span class="charliteral">'%'</span>;
03675     ArcNameFmt[10] = <span class="charliteral">'s'</span>;
03676     ArcNameFmt[11] = <span class="charliteral">'\0'</span>;
03677 
03678     <span class="comment">//</span>
03679     <span class="comment">// Open the ARC boot device symbolic link object. The boot device</span>
03680     <span class="comment">// driver should have created the object.</span>
03681     <span class="comment">//</span>
03682 
03683     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
03684              ArcNameFmt,
03685              LoaderBlock-&gt;ArcBootDeviceName );
03686 
03687     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;deviceNameString, deviceNameBuffer );
03688 
03689     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;deviceNameUnicodeString,
03690                                            &amp;deviceNameString,
03691                                            TRUE );
03692 
03693     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03694         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03695     }
03696 
03697     InitializeObjectAttributes( &amp;objectAttributes,
03698                                 &amp;deviceNameUnicodeString,
03699                                 OBJ_CASE_INSENSITIVE,
03700                                 NULL,
03701                                 NULL );
03702 
03703     status = <a class="code" href="../../d4/d1/oblink_8c.html#a6">NtOpenSymbolicLinkObject</a>( &amp;linkHandle,
03704                                        SYMBOLIC_LINK_ALL_ACCESS,
03705                                        &amp;objectAttributes );
03706 
03707     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03708 
03709 <span class="preprocessor">#if DBG</span>
03710 <span class="preprocessor"></span>
03711         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( debugBuffer, <span class="stringliteral">"IOINIT: unable to resolve %s, Status == %X\n"</span>,
03712                  deviceNameBuffer,
03713                  status );
03714 
03715         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;debugString, debugBuffer );
03716 
03717         status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;debugUnicodeString,
03718                                                &amp;debugString,
03719                                                TRUE );
03720 
03721         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03722             ZwDisplayString( &amp;debugUnicodeString );
03723             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;debugUnicodeString );
03724         }
03725 
03726 <span class="preprocessor">#endif // DBG</span>
03727 <span class="preprocessor"></span>
03728         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
03729         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03730     }
03731 
03732     <span class="comment">//</span>
03733     <span class="comment">// Get handle to \SystemRoot symbolic link.</span>
03734     <span class="comment">//</span>
03735 
03736     arcNameUnicodeString.Buffer = arcNameUnicodeBuffer;
03737     arcNameUnicodeString.Length = 0;
03738     arcNameUnicodeString.MaximumLength = <span class="keyword">sizeof</span>( arcNameUnicodeBuffer );
03739 
03740     status = <a class="code" href="../../d4/d1/oblink_8c.html#a7">NtQuerySymbolicLinkObject</a>( linkHandle,
03741                                         &amp;arcNameUnicodeString,
03742                                         NULL );
03743 
03744     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03745         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03746     }
03747 
03748     arcNameString.Buffer = arcNameStringBuffer;
03749     arcNameString.Length = 0;
03750     arcNameString.MaximumLength = <span class="keyword">sizeof</span>( arcNameStringBuffer );
03751 
03752     status = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;arcNameString,
03753                                            &amp;arcNameUnicodeString,
03754                                            FALSE );
03755 
03756     arcNameStringBuffer[arcNameString.Length] = <span class="charliteral">'\0'</span>;
03757 
03758     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( linkHandle );
03759     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;deviceNameUnicodeString );
03760 
03761     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;linkString, INIT_SYSTEMROOT_LINKNAME );
03762 
03763     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;linkUnicodeString,
03764                                            &amp;linkString,
03765                                            TRUE);
03766 
03767     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03768         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03769     }
03770 
03771     InitializeObjectAttributes( &amp;objectAttributes,
03772                                 &amp;linkUnicodeString,
03773                                 OBJ_CASE_INSENSITIVE,
03774                                 NULL,
03775                                 NULL );
03776 
03777     status = <a class="code" href="../../d4/d1/oblink_8c.html#a6">NtOpenSymbolicLinkObject</a>( &amp;linkHandle,
03778                                        SYMBOLIC_LINK_ALL_ACCESS,
03779                                        &amp;objectAttributes );
03780 
03781     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03782         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03783     }
03784 
03785     <a class="code" href="../../d5/d0/obclose_8c.html#a2">NtMakeTemporaryObject</a>( linkHandle );
03786     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( linkHandle );
03787 
03788     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( deviceNameBuffer,
03789              <span class="stringliteral">"%Z%s"</span>,
03790              &amp;arcNameString,
03791              LoaderBlock-&gt;NtBootPathName );
03792 
03793     <span class="comment">//</span>
03794     <span class="comment">// Get NT device name for \SystemRoot assignment.</span>
03795     <span class="comment">//</span>
03796 
03797     <a class="code" href="../../d2/d7/string_8c.html#a8">RtlCopyString</a>( NtDeviceName, &amp;arcNameString );
03798 
03799     deviceNameBuffer[<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(deviceNameBuffer)-1] = <span class="charliteral">'\0'</span>;
03800 
03801     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;deviceNameString, deviceNameBuffer);
03802 
03803     InitializeObjectAttributes( &amp;objectAttributes,
03804                                 &amp;linkUnicodeString,
03805                                 OBJ_CASE_INSENSITIVE | OBJ_PERMANENT,
03806                                 NULL,
03807                                 NULL );
03808 
03809     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;arcNameUnicodeString,
03810                                            &amp;deviceNameString,
03811                                            TRUE);
03812 
03813     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03814         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03815     }
03816 
03817     status = <a class="code" href="../../d4/d1/oblink_8c.html#a5">NtCreateSymbolicLinkObject</a>( &amp;linkHandle,
03818                                          SYMBOLIC_LINK_ALL_ACCESS,
03819                                          &amp;objectAttributes,
03820                                          &amp;arcNameUnicodeString );
03821 
03822     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;arcNameUnicodeString );
03823     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;linkUnicodeString );
03824     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( linkHandle );
03825 
03826 <span class="preprocessor">#if DBG</span>
03827 <span class="preprocessor"></span>
03828     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03829 
03830         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( debugBuffer,
03831                  <span class="stringliteral">"INIT: Reassigned %s =&gt; %s\n"</span>,
03832                  INIT_SYSTEMROOT_LINKNAME,
03833                  deviceNameBuffer );
03834 
03835     } <span class="keywordflow">else</span> {
03836 
03837         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( debugBuffer,
03838                  <span class="stringliteral">"INIT: unable to create %s =&gt; %s, Status == %X\n"</span>,
03839                  INIT_SYSTEMROOT_LINKNAME,
03840                  deviceNameBuffer,
03841                  status );
03842     }
03843 
03844     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;debugString, debugBuffer );
03845 
03846     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;debugUnicodeString,
03847                                            &amp;debugString,
03848                                            TRUE );
03849 
03850     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03851 
03852         ZwDisplayString( &amp;debugUnicodeString );
03853         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;debugUnicodeString );
03854     }
03855 
03856 <span class="preprocessor">#endif // DBG</span>
03857 <span class="preprocessor"></span>
03858     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03859 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="ioinit.c::IopSetIoRoutines" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopSetIoRoutines           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00953">953</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00662">IopAllocateIrpPrivate()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a235">IopfCallDriver()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l03180">IopfCompleteRequest()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06641">IopFreeIrp()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00315">pIoAllocateIrp</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00313">pIofCallDriver</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00314">pIofCompleteRequest</a>, and <a class="el" href="../../d4/d4/iodata_8c-source.html#l00316">pIoFreeIrp</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>00954 {
00955     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a55">pIofCallDriver</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00956 
00957         <a class="code" href="../../d3/d5/iodata_8c.html#a55">pIofCallDriver</a> = <a class="code" href="../../d0/d6/iop_8h.html#a235">IopfCallDriver</a>;
00958     }
00959 
00960     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a56">pIofCompleteRequest</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00961 
00962         <a class="code" href="../../d3/d5/iodata_8c.html#a56">pIofCompleteRequest</a> = <a class="code" href="../../d0/d6/iop_8h.html#a236">IopfCompleteRequest</a>;
00963     }
00964 
00965     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a57">pIoAllocateIrp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00966 
00967         <a class="code" href="../../d3/d5/iodata_8c.html#a57">pIoAllocateIrp</a> = <a class="code" href="../../d0/d6/iop_8h.html#a237">IopAllocateIrpPrivate</a>;
00968     }
00969 
00970     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a58">pIoFreeIrp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00971 
00972         <a class="code" href="../../d3/d5/iodata_8c.html#a58">pIoFreeIrp</a> = <a class="code" href="../../d0/d6/iop_8h.html#a238">IopFreeIrp</a>;
00973     }
00974 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="ioinit.c::IopSetIoRoutines" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopSetIoRoutines           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VOID</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="ioinit.c::IopStoreSystemPartitionInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopStoreSystemPartitionInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>NtSystemPartitionDeviceName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>OsLoaderPathName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03862">3862</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00174">CmRegistryMachineSystemName</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00247">NtOpenSymbolicLinkObject()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00333">NtQuerySymbolicLinkObject()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01047">IopCreateArcNames()</a>.
<p>
<pre class="fragment"><div>03869                    :
03870 
03871     This routine writes two values to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry (under HKLM\SYSTEM\Setup)--one
03872     containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT device name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system partition and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> other containing
03873     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS loader.  These values will later be migrated into a
03874     Win95-compatible registry location (NT path converted to DOS path), so that
03875     installation programs (including our own setup) have a rock-solid way of knowing
03876     what <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system partition <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, on both ARC and x86.
03877 
03878     ERRORS ENCOUNTERED IN THIS ROUTINE ARE NOT CONSIDERED <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a6">FATAL</a>.
03879 
03880 Arguments:
03881 
03882     NtSystemPartitionDeviceName - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT device name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system partition.
03883         This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> \Device\Harddisk&lt;n&gt;\Partition&lt;m&gt; name, which used to be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual
03884         device name, but now <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a symbolic link to a name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> form \Device\Volume&lt;x&gt;.
03885         We open up <span class="keyword">this</span> symbolic link, and retrieve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> points to.  The
03886         target name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one we store away in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
03887 
03888     OsLoaderPathName - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> (on the partition specified in the 1st parameter)
03889         where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS loader <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> located.  Upon <span class="keywordflow">return</span>, <span class="keyword">this</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> will have had its trailing
03890         backslash removed (<span class="keywordflow">if</span> present, and path isn't root).
03891 
03892 Return Value:
03893 
03894     None.
03895 
03896 --*/
03897 
03898 {
03899     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03900     HANDLE linkHandle;
03901     OBJECT_ATTRIBUTES objectAttributes;
03902     HANDLE systemHandle, setupHandle;
03903     UNICODE_STRING nameString, volumeNameString;
03904     WCHAR voumeNameStringBuffer[256];
03905     <span class="comment">//</span>
03906     <span class="comment">// Declare a unicode buffer big enough to contain the longest string we'll be using.</span>
03907     <span class="comment">// (ANSI string in 'sizeof()' below on purpose--we want the number of chars here.)</span>
03908     <span class="comment">//</span>
03909     WCHAR nameBuffer[<span class="keyword">sizeof</span>(<span class="stringliteral">"SystemPartition"</span>)];
03910 
03911     <span class="comment">//</span>
03912     <span class="comment">// Both UNICODE_STRING buffers should be NULL-terminated.</span>
03913     <span class="comment">//</span>
03914 
03915     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( NtSystemPartitionDeviceName-&gt;MaximumLength &gt;= NtSystemPartitionDeviceName-&gt;Length + <span class="keyword">sizeof</span>(WCHAR) );
03916     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( NtSystemPartitionDeviceName-&gt;Buffer[NtSystemPartitionDeviceName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)] == L<span class="charliteral">'\0'</span> );
03917 
03918     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( OsLoaderPathName-&gt;MaximumLength &gt;= OsLoaderPathName-&gt;Length + <span class="keyword">sizeof</span>(WCHAR) );
03919     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( OsLoaderPathName-&gt;Buffer[OsLoaderPathName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)] == L<span class="charliteral">'\0'</span> );
03920 
03921     <span class="comment">//</span>
03922     <span class="comment">// Open the NtSystemPartitionDeviceName symbolic link, and find out the volume device</span>
03923     <span class="comment">// it points to.</span>
03924     <span class="comment">//</span>
03925 
03926     InitializeObjectAttributes(&amp;objectAttributes,
03927                                NtSystemPartitionDeviceName,
03928                                OBJ_CASE_INSENSITIVE,
03929                                NULL,
03930                                NULL
03931                               );
03932 
03933     status = <a class="code" href="../../d4/d1/oblink_8c.html#a6">NtOpenSymbolicLinkObject</a>(&amp;linkHandle,
03934                                       SYMBOLIC_LINK_QUERY,
03935                                       &amp;objectAttributes
03936                                      );
03937 
03938     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03939 <span class="preprocessor">#if DBG</span>
03940 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopStoreSystemPartitionInformation: couldn't open symbolic link %wZ - %x\n"</span>,
03941                  NtSystemPartitionDeviceName,
03942                  status
03943                 );
03944 <span class="preprocessor">#endif // DBG</span>
03945 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
03946     }
03947 
03948     volumeNameString.Buffer = voumeNameStringBuffer;
03949     volumeNameString.Length = 0;
03950     <span class="comment">//</span>
03951     <span class="comment">// Leave room at the end of the buffer for a terminating null, in case we need to add one.</span>
03952     <span class="comment">//</span>
03953     volumeNameString.MaximumLength = <span class="keyword">sizeof</span>(voumeNameStringBuffer) - <span class="keyword">sizeof</span>(WCHAR);
03954 
03955     status = <a class="code" href="../../d4/d1/oblink_8c.html#a7">NtQuerySymbolicLinkObject</a>(linkHandle,
03956                                        &amp;volumeNameString,
03957                                        NULL
03958                                       );
03959 
03960     <span class="comment">//</span>
03961     <span class="comment">// We don't need the handle to the symbolic link any longer.</span>
03962     <span class="comment">//</span>
03963 
03964     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(linkHandle);
03965 
03966     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03967 <span class="preprocessor">#if DBG</span>
03968 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopStoreSystemPartitionInformation: couldn't query symbolic link %wZ - %x\n"</span>,
03969                  NtSystemPartitionDeviceName,
03970                  status
03971                 );
03972 <span class="preprocessor">#endif // DBG</span>
03973 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
03974     }
03975 
03976     <span class="comment">//</span>
03977     <span class="comment">// Make sure the volume name string is null-terminated.</span>
03978     <span class="comment">//</span>
03979 
03980     volumeNameString.Buffer[volumeNameString.Length / <span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
03981 
03982     <span class="comment">//</span>
03983     <span class="comment">// Open HKLM\SYSTEM key.</span>
03984     <span class="comment">//</span>
03985 
03986     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;systemHandle,
03987                                    NULL,
03988                                    &amp;CmRegistryMachineSystemName,
03989                                    KEY_ALL_ACCESS
03990                                    );
03991 
03992     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03993 <span class="preprocessor">#if DBG</span>
03994 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopStoreSystemPartitionInformation: couldn't open \\REGISTRY\\MACHINE\\SYSTEM - %x\n"</span>, status);
03995 <span class="preprocessor">#endif // DBG</span>
03996 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
03997     }
03998 
03999     <span class="comment">//</span>
04000     <span class="comment">// Now open/create the setup subkey.</span>
04001     <span class="comment">//</span>
04002 
04003     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(L<span class="stringliteral">"Setup"</span>) &lt;= <span class="keyword">sizeof</span>(nameBuffer) );
04004 
04005     nameBuffer[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'S'</span>;
04006     nameBuffer[1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'e'</span>;
04007     nameBuffer[2] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'t'</span>;
04008     nameBuffer[3] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'u'</span>;
04009     nameBuffer[4] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'p'</span>;
04010     nameBuffer[5] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04011 
04012     nameString.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Setup"</span>);
04013     nameString.Length        = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Setup"</span>) - <span class="keyword">sizeof</span>(WCHAR);
04014     nameString.Buffer        = nameBuffer;
04015 
04016     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;setupHandle,
04017                                      systemHandle,
04018                                      &amp;nameString,
04019                                      KEY_ALL_ACCESS,
04020                                      REG_OPTION_NON_VOLATILE,
04021                                      NULL
04022                                      );
04023 
04024     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(systemHandle);  <span class="comment">// Don't need the handle to the HKLM\System key anymore.</span>
04025 
04026     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04027 <span class="preprocessor">#if DBG</span>
04028 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopStoreSystemPartitionInformation: couldn't open Setup subkey - %x\n"</span>, status);
04029 <span class="preprocessor">#endif // DBG</span>
04030 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
04031     }
04032 
04033     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(L<span class="stringliteral">"SystemPartition"</span>) &lt;= <span class="keyword">sizeof</span>(nameBuffer) );
04034 
04035     nameBuffer[0]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'S'</span>;
04036     nameBuffer[1]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'y'</span>;
04037     nameBuffer[2]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'s'</span>;
04038     nameBuffer[3]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'t'</span>;
04039     nameBuffer[4]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'e'</span>;
04040     nameBuffer[5]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'m'</span>;
04041     nameBuffer[6]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'P'</span>;
04042     nameBuffer[7]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span>;
04043     nameBuffer[8]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'r'</span>;
04044     nameBuffer[9]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'t'</span>;
04045     nameBuffer[10] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'i'</span>;
04046     nameBuffer[11] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'t'</span>;
04047     nameBuffer[12] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'i'</span>;
04048     nameBuffer[13] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'o'</span>;
04049     nameBuffer[14] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'n'</span>;
04050     nameBuffer[15] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04051 
04052     nameString.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SystemPartition"</span>);
04053     nameString.Length        = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SystemPartition"</span>) - <span class="keyword">sizeof</span>(WCHAR);
04054 
04055     
04056   
04057     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(setupHandle,
04058                             &amp;nameString,
04059                             TITLE_INDEX_VALUE,
04060                             REG_SZ,
04061                             volumeNameString.Buffer,
04062                             volumeNameString.Length + <span class="keyword">sizeof</span>(WCHAR)
04063                            );
04064     
04065 
04066 <span class="preprocessor">#if DBG</span>
04067 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04068         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopStoreSystemPartitionInformation: couldn't write SystemPartition value - %x\n"</span>, status);
04069     }
04070 <span class="preprocessor">#endif // DBG</span>
04071 <span class="preprocessor"></span>
04072     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(L<span class="stringliteral">"OsLoaderPath"</span>) &lt;= <span class="keyword">sizeof</span>(nameBuffer) );
04073 
04074     nameBuffer[0]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'O'</span>;
04075     nameBuffer[1]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'s'</span>;
04076     nameBuffer[2]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'L'</span>;
04077     nameBuffer[3]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'o'</span>;
04078     nameBuffer[4]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span>;
04079     nameBuffer[5]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'d'</span>;
04080     nameBuffer[6]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'e'</span>;
04081     nameBuffer[7]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'r'</span>;
04082     nameBuffer[8]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'P'</span>;
04083     nameBuffer[9]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span>;
04084     nameBuffer[10] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'t'</span>;
04085     nameBuffer[11] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'h'</span>;
04086     nameBuffer[12] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04087 
04088     nameString.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OsLoaderPath"</span>);
04089     nameString.Length        = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OsLoaderPath"</span>) - <span class="keyword">sizeof</span>(WCHAR);
04090 
04091     <span class="comment">//</span>
04092     <span class="comment">// Strip off the trailing backslash from the path (unless, of course, the path is a</span>
04093     <span class="comment">// single backslash).</span>
04094     <span class="comment">//</span>
04095 
04096     <span class="keywordflow">if</span> ((OsLoaderPathName-&gt;Length &gt; <span class="keyword">sizeof</span>(WCHAR)) &amp;&amp;
04097         (*(PWCHAR)((PCHAR)OsLoaderPathName-&gt;Buffer + OsLoaderPathName-&gt;Length - <span class="keyword">sizeof</span>(WCHAR)) == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>)) {
04098 
04099         OsLoaderPathName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
04100         *(PWCHAR)((PCHAR)OsLoaderPathName-&gt;Buffer + OsLoaderPathName-&gt;Length) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04101     }
04102 
04103     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(setupHandle,
04104                            &amp;nameString,
04105                            TITLE_INDEX_VALUE,
04106                            REG_SZ,
04107                            OsLoaderPathName-&gt;Buffer,
04108                            OsLoaderPathName-&gt;Length + <span class="keyword">sizeof</span>(WCHAR)
04109                            );
04110 <span class="preprocessor">#if DBG</span>
04111 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04112         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopStoreSystemPartitionInformation: couldn't write OsLoaderPath value - %x\n"</span>, status);
04113     }
04114 <span class="preprocessor">#endif // DBG</span>
04115 <span class="preprocessor"></span>
04116     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(setupHandle);
04117 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="ioinit.c::IopWaitForBootDevicesDeleted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopWaitForBootDevicesDeleted           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VOID</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04617">4617</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00080">PiEventQueueEmpty</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>04623                    :
04624 
04625     This routine waits <span class="keywordflow">for</span> IoRequestDeviceRemoval to be completed.
04626 
04627 Arguments:
04628 
04629     None.
04630 
04631 Return Value:
04632 
04633     BOOLEAN.
04634 
04635 --*/
04636 
04637 {
04638     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04639 
04640     <span class="comment">//</span>
04641     <span class="comment">// Wait on device removal event to make sure all the deleted devcies are processed</span>
04642     <span class="comment">// before moving on to process next boot driver.</span>
04643     <span class="comment">//</span>
04644 
04645     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;PiEventQueueEmpty,
04646                                     Executive,
04647                                     KernelMode,
04648                                     FALSE,
04649                                     NULL );
04650     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status);
04651 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="ioinit.c::IopWaitForBootDevicesStarted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopWaitForBootDevicesStarted           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VOID</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04508">4508</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00621">DNF_ASYNC_REQUEST_PENDING</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00068">IopPnPSpinLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00086">PiEnumerationLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00173">PnpAsyncOk</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>04514                    :
04515 
04516     This routine waits <span class="keywordflow">for</span> enumeration lock to be released <span class="keywordflow">for</span> <a class="code" href="../../d0/d2/usrbench_8h.html#a13">ALL</a> devices.
04517 
04518 Arguments:
04519 
04520     None.
04521 
04522 Return Value:
04523 
04524     BOOLEAN.
04525 
04526 --*/
04527 
04528 {
04529     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
04530     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04531     KIRQL oldIrql;
04532 
04533     <span class="comment">//</span>
04534     <span class="comment">// Wait on IoInvalidateDeviceRelations event to make sure all the devcies are enumerated</span>
04535     <span class="comment">// before progressing to mark boot partitions.</span>
04536     <span class="comment">//</span>
04537 
04538     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;PiEnumerationLock,
04539                                     Executive,
04540                                     KernelMode,
04541                                     FALSE,
04542                                     NULL );
04543     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04544         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04545     }
04546 
04547     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a24">PnpAsyncOk</a>) {
04548 
04549         <span class="comment">//</span>
04550         <span class="comment">// Perform top-down check to make sure all the devices with Async start and Async Query</span>
04551         <span class="comment">// Device Relations are done.</span>
04552         <span class="comment">//</span>
04553 
04554         deviceNode = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>;
04555         <span class="keywordflow">for</span> (; ;) {
04556 
04557             ExAcquireSpinLock(&amp;IopPnPSpinLock, &amp;oldIrql);
04558 
04559             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a44">DNF_ASYNC_REQUEST_PENDING</a>) {
04560 
04561                 <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(&amp;PiEnumerationLock);
04562                 ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
04563 
04564                 <span class="comment">//</span>
04565                 <span class="comment">// Wait on PiEnumerationLock to be signaled before proceeding.</span>
04566                 <span class="comment">// At this point if a device node is marked ASYNC request pending,  this</span>
04567                 <span class="comment">// must be an ASYNC start or enumeration which will queue an enumeration</span>
04568                 <span class="comment">// request and once the enumeration completes, the PiEnumerationLock</span>
04569                 <span class="comment">// will be signaled.</span>
04570                 <span class="comment">//</span>
04571 
04572                 status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;PiEnumerationLock,
04573                                                 Executive,
04574                                                 KernelMode,
04575                                                 FALSE,
04576                                                 NULL );
04577                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04578                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04579                 }
04580                 <span class="keywordflow">continue</span>;   <span class="comment">// Make sure this device is done.</span>
04581             } <span class="keywordflow">else</span> {
04582                 ExReleaseSpinLock(&amp;IopPnPSpinLock, oldIrql);
04583             }
04584 
04585             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>) {
04586                 deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
04587                 <span class="keywordflow">continue</span>;
04588             }
04589             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
04590                 deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
04591                 <span class="keywordflow">continue</span>;
04592             }
04593 
04594             <span class="keywordflow">for</span> (; ;) {
04595                 deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
04596 
04597                 <span class="comment">//</span>
04598                 <span class="comment">// If that was the last node to check, then exit loop</span>
04599                 <span class="comment">//</span>
04600 
04601                 <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
04602                     <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
04603                 }
04604                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
04605                     deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
04606                     <span class="keywordflow">break</span>;
04607                 }
04608             }
04609         }
04610     <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
04611         ;
04612     }
04613     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04614 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="ioinit.c::RawInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RawInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RegistryPath</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a12" doxytag="ioinit.c::IopCompletionMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> GENERIC_MAPPING <a class="el" href="../../d0/d6/iop_8h.html#a52">IopCompletionMapping</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    STANDARD_RIGHTS_READ |
        IO_COMPLETION_QUERY_STATE,
    STANDARD_RIGHTS_WRITE |
        IO_COMPLETION_MODIFY_STATE,
    STANDARD_RIGHTS_EXECUTE |
        SYNCHRONIZE,
    IO_COMPLETION_ALL_ACCESS
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01925">1925</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ioinit.c::IopErrorLogObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d9/d5/ioinit_8c.html#a8">IopErrorLogObject</a> = NULL          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00075">75</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04393">IopLogErrorEvent()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03479">IopMarkBootPartition()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ioinit.c::IopFileMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> GENERIC_MAPPING <a class="el" href="../../d0/d6/iop_8h.html#a51">IopFileMapping</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    STANDARD_RIGHTS_READ |
        FILE_READ_DATA | FILE_READ_ATTRIBUTES | FILE_READ_EA | SYNCHRONIZE,
    STANDARD_RIGHTS_WRITE |
        FILE_WRITE_DATA | FILE_WRITE_ATTRIBUTES | FILE_WRITE_EA | FILE_APPEND_DATA | SYNCHRONIZE,
    STANDARD_RIGHTS_EXECUTE |
        SYNCHRONIZE | FILE_READ_ATTRIBUTES | FILE_EXECUTE,
    FILE_ALL_ACCESS
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01915">1915</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07183">IoGetFileObjectGenericMapping()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01936">IopCreateObjectTypes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ioinit.c::IopGroupIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d5/ioinit_8c.html#a9">IopGroupIndex</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00081">81</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04654">IopLoadBootFilterDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ioinit.c::IopGroupListHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d2/struct__TREE__ENTRY.html">PTREE_ENTRY</a> <a class="el" href="../../d9/d5/ioinit_8c.html#a7">IopGroupListHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00070">70</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03379">IopLookupGroupName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ioinit.c::IopGroupTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLIST_ENTRY <a class="el" href="../../d9/d5/ioinit_8c.html#a10">IopGroupTable</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00082">82</a> of file <a class="el" href="../../d0/d5/ioinit_8c-source.html">ioinit.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04654">IopLoadBootFilterDriver()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:18 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
