<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: umapview.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>umapview.c</h1><a href="../../d4/d9/umapview_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   umapview.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which implement the</span>
00012 <span class="comment">    NtUnmapViewOfSection service.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 22-May-1989</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Landy Wang (landyw) 08-April-1998 : Modifications for 3-level 64-bit NT.</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00025 
00026 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtUnmapViewOfSection)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmUnmapViewOfSection)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00030 <span class="preprocessor"></span>
00031 
00032 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00033"></a><a class="code" href="../../d4/d9/umapview_8c.html#a0">00033</a> <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(
00034     IN HANDLE ProcessHandle,
00035     IN PVOID BaseAddress
00036      )
00037 
00038 <span class="comment">/*++</span>
00039 <span class="comment"></span>
00040 <span class="comment">Routine Description:</span>
00041 <span class="comment"></span>
00042 <span class="comment">    This function unmaps a previously created view to a section.</span>
00043 <span class="comment"></span>
00044 <span class="comment">Arguments:</span>
00045 <span class="comment"></span>
00046 <span class="comment">    ProcessHandle - Supplies an open handle to a process object.</span>
00047 <span class="comment"></span>
00048 <span class="comment">    BaseAddress - Supplies the base address of the view.</span>
00049 <span class="comment"></span>
00050 <span class="comment">Return Value:</span>
00051 <span class="comment"></span>
00052 <span class="comment">    Returns the status</span>
00053 <span class="comment"></span>
00054 <span class="comment">    TBS</span>
00055 <span class="comment"></span>
00056 <span class="comment"></span>
00057 <span class="comment">--*/</span>
00058 
00059 {
00060     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00061     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00062     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00063 
00064     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00065 
00066     PreviousMode = KeGetPreviousMode();
00067 
00068     <span class="keywordflow">if</span> ((PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) &amp;&amp; (BaseAddress &gt; MM_HIGHEST_USER_ADDRESS)) {
00069         <span class="keywordflow">return</span> STATUS_NOT_MAPPED_VIEW;
00070     }
00071 
00072     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( ProcessHandle,
00073                                          PROCESS_VM_OPERATION,
00074                                          <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00075                                          PreviousMode,
00076                                          (PVOID *)&amp;Process,
00077                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00078 
00079     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00080         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00081     }
00082 
00083     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a> ( Process, BaseAddress );
00084     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00085 
00086     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00087 }
00088 
00089 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00090"></a><a class="code" href="../../d4/d9/umapview_8c.html#a1">00090</a> <a class="code" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a>(
00091     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00092     IN PVOID BaseAddress
00093      )
00094 
00095 <span class="comment">/*++</span>
00096 <span class="comment"></span>
00097 <span class="comment">Routine Description:</span>
00098 <span class="comment"></span>
00099 <span class="comment">    This function unmaps a previously created view to a section.</span>
00100 <span class="comment"></span>
00101 <span class="comment">Arguments:</span>
00102 <span class="comment"></span>
00103 <span class="comment">    Process - Supplies a referenced pointer to a process object.</span>
00104 <span class="comment"></span>
00105 <span class="comment">    BaseAddress - Supplies the base address of the view.</span>
00106 <span class="comment"></span>
00107 <span class="comment">Return Value:</span>
00108 <span class="comment"></span>
00109 <span class="comment">    Returns the status</span>
00110 <span class="comment"></span>
00111 <span class="comment">    TBS</span>
00112 <span class="comment"></span>
00113 <span class="comment"></span>
00114 <span class="comment">--*/</span>
00115 
00116 {
00117     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
00118     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> PreviousVad;
00119     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NextVad;
00120     SIZE_T RegionSize;
00121     PVOID UnMapImageBase;
00122     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00123     BOOLEAN Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00124 
00125     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00126 
00127     UnMapImageBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// If the specified process is not the current process, attach</span>
00131     <span class="comment">// to the specified process.</span>
00132     <span class="comment">//</span>
00133 
00134     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
00135         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
00136         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00137     }
00138 
00139     <span class="comment">//</span>
00140     <span class="comment">// Get the address creation mutex to block multiple threads from</span>
00141     <span class="comment">// creating or deleting address space at the same time and</span>
00142     <span class="comment">// get the working set mutex so virtual address descriptors can</span>
00143     <span class="comment">// be inserted and walked.</span>
00144     <span class="comment">// Raise IRQL to block APCs.</span>
00145     <span class="comment">//</span>
00146     <span class="comment">// Get the working set mutex, no page faults allowed for now until</span>
00147     <span class="comment">// working set mutex released.</span>
00148     <span class="comment">//</span>
00149 
00150 
00151     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00152 
00153     <span class="comment">//</span>
00154     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00155     <span class="comment">//</span>
00156 
00157     <span class="keywordflow">if</span> (Process-&gt;AddressSpaceDeleted != 0) {
00158         status = STATUS_PROCESS_IS_TERMINATING;
00159         <span class="keywordflow">goto</span> ErrorReturn;
00160     }
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// Find the associated vad.</span>
00164     <span class="comment">//</span>
00165 
00166     Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (BaseAddress);
00167 
00168     <span class="keywordflow">if</span> ((Vad == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory)) {
00169 
00170         <span class="comment">//</span>
00171         <span class="comment">// No Virtual Address Descriptor located for Base Address.</span>
00172         <span class="comment">//</span>
00173 
00174         status = STATUS_NOT_MAPPED_VIEW;
00175         <span class="keywordflow">goto</span> ErrorReturn;
00176     }
00177 
00178     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1) {
00179 
00180         <span class="comment">//</span>
00181         <span class="comment">// An attempt is being made to delete a secured VAD, check</span>
00182         <span class="comment">// the whole VAD to see if this deletion is allowed.</span>
00183         <span class="comment">//</span>
00184 
00185         status = <a class="code" href="../../d0/d9/protect_8c.html#a9">MiCheckSecuredVad</a> ((<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad,
00186                                     <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>),
00187                                     ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> - Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) +
00188                                             (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1),
00189                                     <a class="code" href="../../d4/d8/mi_8h.html#a55">MM_SECURE_DELETE_CHECK</a>);
00190 
00191         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00192             <span class="keywordflow">goto</span> ErrorReturn;
00193         }
00194     }
00195 
00196     <span class="comment">//</span>
00197     <span class="comment">// If this Vad is for an image section, then</span>
00198     <span class="comment">// get the base address of the section</span>
00199     <span class="comment">//</span>
00200 
00201     <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.ImageMap == 1) &amp;&amp; (Process == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>())) {
00202         UnMapImageBase = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>);
00203     }
00204 
00205     RegionSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> + ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> - Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00206 
00207     PreviousVad = <a class="code" href="../../d4/d8/mi_8h.html#a95">MiGetPreviousVad</a> (Vad);
00208     NextVad = <a class="code" href="../../d4/d8/mi_8h.html#a96">MiGetNextVad</a> (Vad);
00209 
00210 
00211     <a class="code" href="../../d6/d3/vadtree_8c.html#a1">MiRemoveVad</a> (Vad);
00212 
00213     <span class="comment">//</span>
00214     <span class="comment">// Return commitment for page table pages if possible.</span>
00215     <span class="comment">//</span>
00216 
00217     <a class="code" href="../../d6/d1/mmquota_8c.html#a21">MiReturnPageTablePageCommitment</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>),
00218                                      <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>),
00219                                      Process,
00220                                      PreviousVad,
00221                                      NextVad);
00222 
00223     <a class="code" href="../../d4/d9/umapview_8c.html#a2">MiRemoveMappedView</a> (Process, Vad);
00224 
00225 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00226 <span class="preprocessor"></span>
00227     <span class="keywordflow">if</span> (Process-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00228 
00229         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00230 
00231         <a class="code" href="../../d2/d9/miia64_8h.html#a308">MiDeleteFor4kPage</a>(<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>),
00232                           <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>),
00233                           Process);
00234 
00235         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
00236 
00237     }
00238 
00239 <span class="preprocessor">#endif</span>
00240 <span class="preprocessor"></span>
00241     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
00242 
00243     <span class="comment">//</span>
00244     <span class="comment">// Update the current virtual size in the process header.</span>
00245     <span class="comment">//</span>
00246 
00247     Process-&gt;VirtualSize -= RegionSize;
00248     status = STATUS_SUCCESS;
00249 
00250 ErrorReturn:
00251 
00252     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00253 
00254     <span class="keywordflow">if</span> ( UnMapImageBase ) {
00255         <a class="code" href="../../d4/d3/dbgk_8h.html#a4">DbgkUnMapViewOfSection</a>(UnMapImageBase);
00256     }
00257     <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00258         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00259     }
00260 
00261     <span class="keywordflow">return</span> status;
00262 }
00263 
00264 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00265"></a><a class="code" href="../../d4/d9/umapview_8c.html#a2">00265</a> <a class="code" href="../../d4/d9/umapview_8c.html#a2">MiRemoveMappedView</a> (
00266     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess,
00267     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad
00268     )
00269 
00270 <span class="comment">/*++</span>
00271 <span class="comment"></span>
00272 <span class="comment">Routine Description:</span>
00273 <span class="comment"></span>
00274 <span class="comment">    This function removes the mapping from the current process's</span>
00275 <span class="comment">    address space.  The physical VAD may be a normal mapping (backed by</span>
00276 <span class="comment">    a control area) or it may have no control area (it was mapped by a driver).</span>
00277 <span class="comment"></span>
00278 <span class="comment">Arguments:</span>
00279 <span class="comment"></span>
00280 <span class="comment">    Process - Supplies a referenced pointer to the current process object.</span>
00281 <span class="comment"></span>
00282 <span class="comment">    Vad - Supplies the VAD which maps the view.</span>
00283 <span class="comment"></span>
00284 <span class="comment">Return Value:</span>
00285 <span class="comment"></span>
00286 <span class="comment">    None.</span>
00287 <span class="comment"></span>
00288 <span class="comment">Environment:</span>
00289 <span class="comment"></span>
00290 <span class="comment">    APC level, working set mutex and address creation mutex held.</span>
00291 <span class="comment"></span>
00292 <span class="comment">    NOTE:  THE WORKING SET MUTEXES MAY BE RELEASED THEN REACQUIRED!!!!</span>
00293 <span class="comment"></span>
00294 <span class="comment">           SINCE MiCheckControlArea releases unsafe, the WS mutex must be</span>
00295 <span class="comment">           acquired UNSAFE.</span>
00296 <span class="comment"></span>
00297 <span class="comment">--*/</span>
00298 
00299 {
00300     KIRQL OldIrql;
00301     BOOLEAN DereferenceSegment;
00302     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00303     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00304     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00305     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00306     PFN_NUMBER PdePage;
00307     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> PurgeEvent;
00308     PVOID TempVa;
00309     BOOLEAN DeleteOnClose;
00310     <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a> PteFlushList;
00311     PVOID UsedPageTableHandle;
00312     PLIST_ENTRY NextEntry;
00313     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
00314     PVOID PhysicalPool;
00315 <span class="preprocessor">#if defined (_WIN64)</span>
00316 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00317     PVOID UsedPageDirectoryHandle;
00318 <span class="preprocessor">#endif</span>
00319 <span class="preprocessor"></span>
00320     DereferenceSegment = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00321     PurgeEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00322     DeleteOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00323     PhysicalPool = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00324 
00325     ControlArea = Vad-&gt;ControlArea;
00326 
00327     <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.PhysicalMapping == 1) {
00328 
00329         <span class="keywordflow">if</span> (Vad-&gt;u4.Banked) {
00330             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad-&gt;u4.Banked);
00331         }
00332 
00333 <span class="preprocessor">#ifdef LARGE_PAGES</span>
00334 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.LargePages == 1) {
00335 
00336             <span class="comment">//</span>
00337             <span class="comment">// Delete the subsection allocated to hold the large pages.</span>
00338             <span class="comment">//</span>
00339 
00340             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad-&gt;FirstPrototypePte);
00341             Vad-&gt;FirstPrototypePte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00342             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00343             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00344         } <span class="keywordflow">else</span> {
00345 
00346 <span class="preprocessor">#endif //LARGE_PAGES</span>
00347 <span class="preprocessor"></span>
00348             <span class="comment">//</span>
00349             <span class="comment">// This is a physical memory view.  The pages map physical memory</span>
00350             <span class="comment">// and are not accounted for in the working set list or in the PFN</span>
00351             <span class="comment">// database.</span>
00352             <span class="comment">//</span>
00353 
00354             <a class="code" href="../../d4/d8/mi_8h.html#a133">LOCK_AWE</a> (CurrentProcess, OldIrql);
00355 
00356             NextEntry = CurrentProcess-&gt;PhysicalVadList.Flink;
00357             <span class="keywordflow">while</span> (NextEntry != &amp;CurrentProcess-&gt;PhysicalVadList) {
00358     
00359                 PhysicalView = CONTAINING_RECORD(NextEntry,
00360                                                  <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>,
00361                                                  ListEntry);
00362     
00363                 <span class="keywordflow">if</span> (Vad == PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a>) {
00364                     RemoveEntryList (NextEntry);
00365                     PhysicalPool = (PVOID)PhysicalView;
00366                     <span class="keywordflow">break</span>;
00367                 }
00368                 NextEntry = NextEntry-&gt;Flink;
00369             }
00370 
00371             <a class="code" href="../../d4/d8/mi_8h.html#a134">UNLOCK_AWE</a> (CurrentProcess, OldIrql);
00372 
00373             <span class="comment">//</span>
00374             <span class="comment">// Set count so only flush entire TB operations are performed.</span>
00375             <span class="comment">//</span>
00376 
00377             PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>;
00378 
00379             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00380 
00381             <span class="comment">//</span>
00382             <span class="comment">// Remove the PTES from the address space.</span>
00383             <span class="comment">//</span>
00384 
00385             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;StartingVpn));
00386             PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPde);
00387             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;StartingVpn));
00388             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;EndingVpn));
00389 
00390             UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;StartingVpn));
00391 
00392             <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00393 
00394                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
00395 
00396                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00397                     PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPde);
00398 
00399                     UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte));
00400                 }
00401 
00402                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
00403                 <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (PdePage);
00404 
00405                 <span class="comment">//</span>
00406                 <span class="comment">// Decrement the count of non-zero page table entries for this</span>
00407                 <span class="comment">// page table.</span>
00408                 <span class="comment">//</span>
00409 
00410                 <a class="code" href="../../d4/d8/mi_8h.html#a183">MI_DECREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
00411 
00412                 <span class="comment">//</span>
00413                 <span class="comment">// If all the entries have been eliminated from the previous</span>
00414                 <span class="comment">// page table page, delete the page table page itself.  And if</span>
00415                 <span class="comment">// this results in an empty page directory page, then delete</span>
00416                 <span class="comment">// that too.</span>
00417                 <span class="comment">//</span>
00418 
00419                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a>(UsedPageTableHandle) == 0) {
00420 
00421                     TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPde);
00422 
00423                     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>;
00424 
00425                     <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPde,
00426                                  TempVa,
00427                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00428                                  CurrentProcess,
00429                                  (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00430                                  &amp;PteFlushList);
00431 
00432                     <span class="comment">//</span>
00433                     <span class="comment">// Add back in the private page MiDeletePte subtracted.</span>
00434                     <span class="comment">//</span>
00435     
00436                     CurrentProcess-&gt;NumberOfPrivatePages += 1;
00437 
00438 <span class="preprocessor">#if defined (_WIN64)</span>
00439 <span class="preprocessor"></span>                    UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00440     
00441                     <a class="code" href="../../d4/d8/mi_8h.html#a183">MI_DECREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00442 
00443                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a>(UsedPageDirectoryHandle) == 0) {
00444     
00445                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PointerPte);
00446                         TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPpe);
00447     
00448                         PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>;
00449     
00450                         <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPpe,
00451                                      TempVa,
00452                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00453                                      CurrentProcess,
00454                                      (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00455                                      &amp;PteFlushList);
00456 
00457                         <span class="comment">//</span>
00458                         <span class="comment">// Add back in the private page MiDeletePte subtracted.</span>
00459                         <span class="comment">//</span>
00460         
00461                         CurrentProcess-&gt;NumberOfPrivatePages += 1;
00462                     }
00463 <span class="preprocessor">#endif</span>
00464 <span class="preprocessor"></span>                }
00465                 PointerPte += 1;
00466             }
00467             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00468 
00469 <span class="preprocessor">#ifdef LARGE_PAGES</span>
00470 <span class="preprocessor"></span>        }
00471 <span class="preprocessor">#endif //LARGE_PAGES</span>
00472 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00473 
00474         <span class="keywordflow">if</span> (Vad-&gt;u2.VadFlags2.ExtendableFile) {
00475             <a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html">PMMEXTEND_INFO</a> exinfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00476             <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a678">MmSectionBasedMutex</a>);
00477             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;ControlArea-&gt;Segment-&gt;ExtendInfo == Vad-&gt;u4.ExtendedInfo);
00478             Vad-&gt;u4.ExtendedInfo-&gt;ReferenceCount -= 1;
00479             <span class="keywordflow">if</span> (Vad-&gt;u4.ExtendedInfo-&gt;ReferenceCount == 0) {
00480                 exinfo = Vad-&gt;u4.ExtendedInfo;
00481                 Vad-&gt;ControlArea-&gt;Segment-&gt;ExtendInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00482             }
00483             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a678">MmSectionBasedMutex</a>);
00484             <span class="keywordflow">if</span> (exinfo) {
00485                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (exinfo);
00486             }
00487         }
00488 
00489         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00490         <a class="code" href="../../d4/d8/mi_8h.html#a885">MiDeleteVirtualAddresses</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;StartingVpn),
00491                                   <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;EndingVpn),
00492                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00493                                   Vad);
00494     }
00495 
00496     <span class="comment">//</span>
00497     <span class="comment">// Only physical VADs mapped by drivers don't have control areas.</span>
00498     <span class="comment">// If this view has a control area, the view count must be decremented now.</span>
00499     <span class="comment">//</span>
00500 
00501     <span class="keywordflow">if</span> (ControlArea) {
00502 
00503         <span class="comment">//</span>
00504         <span class="comment">// Decrement the count of the number of views for the</span>
00505         <span class="comment">// Segment object.  This requires the PFN mutex to be held (it is</span>
00506         <span class="comment">// already).</span>
00507         <span class="comment">//</span>
00508     
00509         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00510         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
00511     
00512         <span class="comment">//</span>
00513         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
00514         <span class="comment">// This routine releases the PFN lock.</span>
00515         <span class="comment">//</span>
00516     
00517         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, CurrentProcess, OldIrql);
00518     }
00519     <span class="keywordflow">else</span> {
00520 
00521         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00522 
00523         <span class="comment">//</span>
00524         <span class="comment">// Even though it says short VAD in VadFlags, it better be a long VAD.</span>
00525         <span class="comment">//</span>
00526 
00527         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;u.VadFlags.PhysicalMapping == 1);
00528         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;u4.Banked == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00529         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00530         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;FirstPrototypePte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00531     }
00532     
00533     <span class="keywordflow">if</span> (PhysicalPool != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00534         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PhysicalPool);
00535     }
00536 
00537     <span class="keywordflow">return</span>;
00538 }
00539 
00540 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00541"></a><a class="code" href="../../d4/d9/umapview_8c.html#a3">00541</a> <a class="code" href="../../d4/d9/umapview_8c.html#a3">MiPurgeImageSection</a> (
00542     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea,
00543     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process OPTIONAL
00544     )
00545 
00546 <span class="comment">/*++</span>
00547 <span class="comment"></span>
00548 <span class="comment">Routine Description:</span>
00549 <span class="comment"></span>
00550 <span class="comment">    This function locates subsections within an image section that</span>
00551 <span class="comment">    contain global memory and resets the global memory back to</span>
00552 <span class="comment">    the initial subsection contents.</span>
00553 <span class="comment"></span>
00554 <span class="comment">    Note, that for this routine to be called the section is not</span>
00555 <span class="comment">    referenced nor is it mapped in any process.</span>
00556 <span class="comment"></span>
00557 <span class="comment">Arguments:</span>
00558 <span class="comment"></span>
00559 <span class="comment">    ControlArea - Supplies a pointer to the control area for the section.</span>
00560 <span class="comment"></span>
00561 <span class="comment">    Process - Supplies a pointer to the process IFF the working set mutex</span>
00562 <span class="comment">              is held, else NULL is supplied.  Note that IFF the working set</span>
00563 <span class="comment">              mutex is held, it must always be acquired unsafe.</span>
00564 <span class="comment"></span>
00565 <span class="comment">Return Value:</span>
00566 <span class="comment"></span>
00567 <span class="comment">    None.</span>
00568 <span class="comment"></span>
00569 <span class="comment">Environment:</span>
00570 <span class="comment"></span>
00571 <span class="comment">    PFN LOCK held.</span>
00572 <span class="comment"></span>
00573 <span class="comment">--*/</span>
00574 
00575 {
00576     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00577     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00578     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00579     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00580     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> NewContents;
00581     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> NewContentsDemandZero;
00582     KIRQL OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00583     ULONG i;
00584     ULONG SizeOfRawData;
00585     ULONG OffsetIntoSubsection;
00586     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00587 <span class="preprocessor">#if DBG</span>
00588 <span class="preprocessor"></span>    ULONG DelayCount = 0;
00589 <span class="preprocessor">#endif //DBG</span>
00590 <span class="preprocessor"></span>
00591     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;u.Flags.Image != 0);
00592 
00593     i = ControlArea-&gt;NumberOfSubsections;
00594 
00595     <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.GlobalOnlyPerSession == 0) {
00596         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
00597     }
00598     <span class="keywordflow">else</span> {
00599         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea + 1);
00600     }
00601 
00602     <span class="comment">//</span>
00603     <span class="comment">// Loop through all the subsections</span>
00604 
00605     <span class="keywordflow">while</span> (i &gt; 0) {
00606 
00607         <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.GlobalMemory == 1) {
00608 
00609             NewContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
00610             NewContentsDemandZero.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
00611             SizeOfRawData = 0;
00612             OffsetIntoSubsection = 0;
00613 
00614             <span class="comment">//</span>
00615             <span class="comment">// Purge this section.</span>
00616             <span class="comment">//</span>
00617 
00618             <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o4">StartingSector</a> != 0) {
00619 
00620                 <span class="comment">//</span>
00621                 <span class="comment">// This is not a demand zero section.</span>
00622                 <span class="comment">//</span>
00623 
00624                 NewContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a>(Subsection);
00625                 NewContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 1;
00626 
00627                 SizeOfRawData = (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a27">MMSECTOR_SHIFT</a>) |
00628                                Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset;
00629             }
00630 
00631             NewContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection =
00632                                        Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection;
00633             NewContentsDemandZero.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection =
00634                                         NewContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection;
00635 
00636             PointerPte = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>;
00637             LastPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
00638             ControlArea = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>;
00639 
00640             <span class="comment">//</span>
00641             <span class="comment">// The WS lock may be released and reacquired and our callers</span>
00642             <span class="comment">// always acquire it unsafe.</span>
00643             <span class="comment">//</span>
00644 
00645             <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (PointerPte, Process);
00646 
00647             <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
00648 
00649                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) {
00650 
00651                     <span class="comment">//</span>
00652                     <span class="comment">// We are on a page boundary, make sure this PTE is resident.</span>
00653                     <span class="comment">//</span>
00654 
00655                     <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (PointerPte, Process);
00656                 }
00657 
00658                 PteContents = *PointerPte;
00659                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00660 
00661                     <span class="comment">//</span>
00662                     <span class="comment">// No more valid PTEs to deal with.</span>
00663                     <span class="comment">//</span>
00664 
00665                     <span class="keywordflow">break</span>;
00666                 }
00667 
00668                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00669 
00670                 <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
00671                          (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
00672 
00673                     <span class="comment">//</span>
00674                     <span class="comment">// The prototype PTE is in transition format.</span>
00675                     <span class="comment">//</span>
00676 
00677                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
00678 
00679                     <span class="comment">//</span>
00680                     <span class="comment">// If the prototype PTE is no longer pointing to</span>
00681                     <span class="comment">// the original image page (not in protopte format),</span>
00682                     <span class="comment">// or has been modified, remove it from memory.</span>
00683                     <span class="comment">//</span>
00684 
00685                     <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1) ||
00686                         (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0)) {
00687                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00688 
00689                         <span class="comment">//</span>
00690                         <span class="comment">// This is a transition PTE which has been</span>
00691                         <span class="comment">// modified or is no longer in protopte format.</span>
00692                         <span class="comment">//</span>
00693 
00694                         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0) {
00695 
00696                             <span class="comment">//</span>
00697                             <span class="comment">// There must be an I/O in progress on this</span>
00698                             <span class="comment">// page.  Wait for the I/O operation to complete.</span>
00699                             <span class="comment">//</span>
00700 
00701                             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00702 
00703                             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
00704 
00705                             <span class="comment">//</span>
00706                             <span class="comment">// Redo the loop.</span>
00707                             <span class="comment">//</span>
00708 <span class="preprocessor">#if DBG</span>
00709 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> ((DelayCount % 1024) == 0) {
00710                                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MMFLUSHSEC: waiting for i/o to complete PFN %lx\n"</span>,
00711                                     Pfn1);
00712                             }
00713                             DelayCount += 1;
00714 <span class="preprocessor">#endif //DBG</span>
00715 <span class="preprocessor"></span>
00716                             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00717 
00718                             <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (PointerPte, Process);
00719                             <span class="keywordflow">continue</span>;
00720                         }
00721 
00722                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
00723                            (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)));
00724 
00725                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00726                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00727 
00728                         <span class="comment">//</span>
00729                         <span class="comment">// Only reduce the number of PFN references if</span>
00730                         <span class="comment">// the original PTE is still in prototype PTE</span>
00731                         <span class="comment">// format.</span>
00732                         <span class="comment">//</span>
00733 
00734                         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
00735                             ControlArea-&gt;NumberOfPfnReferences -= 1;
00736                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;NumberOfPfnReferences &gt;= 0);
00737                         }
00738                         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
00739 
00740                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00741 
00742                         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00743 
00744                         <span class="comment">//</span>
00745                         <span class="comment">// If the reference count for the page is zero, insert</span>
00746                         <span class="comment">// it into the free page list, otherwise leave it alone</span>
00747                         <span class="comment">// and when the reference count is decremented to zero</span>
00748                         <span class="comment">// the page will go to the free list.</span>
00749                         <span class="comment">//</span>
00750 
00751                         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
00752                             <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00753                             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
00754                                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents));
00755                         }
00756 
00757                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, NewContents);
00758                     }
00759                 } <span class="keywordflow">else</span> {
00760 
00761                     <span class="comment">//</span>
00762                     <span class="comment">// Prototype PTE is not in transition format.</span>
00763                     <span class="comment">//</span>
00764 
00765                     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) {
00766 
00767                         <span class="comment">//</span>
00768                         <span class="comment">// This refers to a page in the paging file,</span>
00769                         <span class="comment">// as it no longer references the image,</span>
00770                         <span class="comment">// restore the PTE contents to what they were</span>
00771                         <span class="comment">// at the initial image creation.</span>
00772                         <span class="comment">//</span>
00773 
00774                         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d4/d2/datalpha_8c.html#a13">NoAccessPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
00775                             <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (PteContents);
00776                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, NewContents);
00777                         }
00778                     }
00779                 }
00780                 PointerPte += 1;
00781                 OffsetIntoSubsection += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00782 
00783                 <span class="keywordflow">if</span> (OffsetIntoSubsection &gt;= SizeOfRawData) {
00784 
00785                     <span class="comment">//</span>
00786                     <span class="comment">// There are trailing demand zero pages in this</span>
00787                     <span class="comment">// subsection, set the PTE contents to be demand</span>
00788                     <span class="comment">// zero for the remainder of the PTEs in this</span>
00789                     <span class="comment">// subsection.</span>
00790                     <span class="comment">//</span>
00791 
00792                     NewContents = NewContentsDemandZero;
00793                 }
00794 
00795 <span class="preprocessor">#if DBG</span>
00796 <span class="preprocessor"></span>                DelayCount = 0;
00797 <span class="preprocessor">#endif //DBG</span>
00798 <span class="preprocessor"></span>
00799             } <span class="comment">//end while</span>
00800         }
00801 
00802         i -=1;
00803         Subsection += 1;
00804      }
00805 
00806     <span class="keywordflow">return</span>;
00807 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:11 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
