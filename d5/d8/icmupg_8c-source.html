<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: icmupg.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>icmupg.c</h1><a href="../../d4/d9/icmupg_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************Module*Header******************************\</span>
00002 <span class="comment">* Module Name: ICMUPG.C</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Module Descripton: This file has code that upgrades Win9x ICM to</span>
00005 <span class="comment">*                    Memphis and NT 5.0</span>
00006 <span class="comment">*</span>
00007 <span class="comment">* Warnings:</span>
00008 <span class="comment">*</span>
00009 <span class="comment">* Issues:</span>
00010 <span class="comment">*</span>
00011 <span class="comment">* Public Routines:</span>
00012 <span class="comment">*</span>
00013 <span class="comment">* Created:  14 November 1996</span>
00014 <span class="comment">* Author:   Srinivasan Chandrasekar    [srinivac]</span>
00015 <span class="comment">*</span>
00016 <span class="comment">* Copyright (c) 1996, 1997  Microsoft Corporation</span>
00017 <span class="comment">\***********************************************************************/</span>
00018 
00019 <span class="preprocessor">#include "<a class="code" href="../../d6/d9/icmupg_8h.html">icmupg.h</a>"</span>
00020 <span class="preprocessor">#include "msg.h"</span>
00021 <span class="preprocessor">#include &lt;setupapi.h&gt;</span>
00022 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00023 
00024 
00025 <span class="comment">//#define ICM_MIG_DEBUG</span>
00026 
00027 <span class="preprocessor">#ifdef UNICODE</span>
00028 <span class="preprocessor"></span>error.
00029 This dll needs to be built with ANSI, not UNICODE because <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must run on
00030 Win95, Win98 and on Windows 2000
00031 <span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span>
00033 
00034 <span class="comment">//</span>
00035 <span class="comment">// Local typedefs</span>
00036 <span class="comment">//</span>
00037 
<a name="l00038"></a><a class="code" href="../../d5/d0/structtagMANUMODELIDS.html">00038</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d0/structtagMANUMODELIDS.html">tagMANUMODELIDS</a> {
<a name="l00039"></a><a class="code" href="../../d5/d0/structtagMANUMODELIDS.html#o0">00039</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d0/structtagMANUMODELIDS.html#o0">dwManuID</a>;
<a name="l00040"></a><a class="code" href="../../d5/d0/structtagMANUMODELIDS.html#o1">00040</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d0/structtagMANUMODELIDS.html#o1">dwModelID</a>;
00041 } <a class="code" href="../../d5/d0/structtagMANUMODELIDS.html">MANUMODELIDS</a>, *<a class="code" href="../../d5/d0/structtagMANUMODELIDS.html">PMANUMODELIDS</a>;
00042 
<a name="l00043"></a><a class="code" href="../../d2/d5/structtagREGDATA.html">00043</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d5/structtagREGDATA.html">tagREGDATA</a> {
00044     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d2/d5/structtagREGDATA.html#o0">dwRefCount</a>;
00045     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d2/d5/structtagREGDATA.html#o1">dwManuID</a>;
00046     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d2/d5/structtagREGDATA.html#o2">dwModelID</a>;
00047 } <a class="code" href="../../d2/d5/structtagREGDATA.html">REGDATA</a>, *<a class="code" href="../../d2/d5/structtagREGDATA.html">PREGDATA</a>;
00048 
<a name="l00049"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a4">00049</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (WINAPI *<a class="code" href="../../d4/d9/icmupg_8c.html#a4">PFNINSTALLCOLORPROFILEA</a>)(PSTR, PSTR);
<a name="l00050"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a5">00050</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (WINAPI *<a class="code" href="../../d4/d9/icmupg_8c.html#a5">PFNINSTALLCOLORPROFILE</a>)(LPCTSTR, LPCTSTR);
<a name="l00051"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a6">00051</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (WINAPI *<a class="code" href="../../d4/d9/icmupg_8c.html#a6">PFNENUMCOLORPROFILES</a>)(PCTSTR, PENUMTYPE, <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>, PDWORD, PDWORD);
00052 
<a name="l00053"></a><a class="code" href="../../d0/d2/structVENDORINFO.html">00053</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00054"></a><a class="code" href="../../d0/d2/structVENDORINFO.html#o0">00054</a>     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> CompanyName[256];
<a name="l00055"></a><a class="code" href="../../d0/d2/structVENDORINFO.html#o1">00055</a>     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> SupportNumber[256];
<a name="l00056"></a><a class="code" href="../../d0/d2/structVENDORINFO.html#o2">00056</a>     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> SupportUrl[256];
<a name="l00057"></a><a class="code" href="../../d0/d2/structVENDORINFO.html#o3">00057</a>     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> InstructionsToUser[1024];
00058 } <a class="code" href="../../d0/d2/structVENDORINFO.html">VENDORINFO</a>, *<a class="code" href="../../d4/d9/icmupg_8c.html#a7">PVENDORINFO</a>;
00059 
00060 
00061 <span class="comment">//</span>
00062 <span class="comment">// Global variables</span>
00063 <span class="comment">//</span>
00064 
<a name="l00065"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a8">00065</a> TCHAR  <span class="keyword">const</span> <a class="code" href="../../d4/d9/icmupg_8c.html#a8">gszICMRegPath</a>[]     = <span class="stringliteral">"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\ICM"</span>;
<a name="l00066"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a9">00066</a> TCHAR  <span class="keyword">const</span> <a class="code" href="../../d4/d9/icmupg_8c.html#a9">gszProfile</a>[]        = <span class="stringliteral">"profile"</span>;
<a name="l00067"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a10">00067</a> TCHAR  <span class="keyword">const</span> <a class="code" href="../../d4/d9/icmupg_8c.html#a10">gszMSCMSdll</a>[]       = <span class="stringliteral">"mscms.dll"</span>;
00068 
<a name="l00069"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a11">00069</a> <span class="keywordtype">char</span>   <span class="keyword">const</span> <a class="code" href="../../d4/d9/icmupg_8c.html#a11">gszProductID</a>[]      = <span class="stringliteral">"Microsoft Color Management System"</span>;
00070 
<a name="l00071"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a12">00071</a> <span class="keywordtype">char</span>   <span class="keyword">const</span> <a class="code" href="../../d4/d9/icmupg_8c.html#a12">gszInstallColorProfile</a>[] = <span class="stringliteral">"InstallColorProfileA"</span>;
<a name="l00072"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a13">00072</a> <span class="keywordtype">char</span>   <span class="keyword">const</span> <a class="code" href="../../d4/d9/icmupg_8c.html#a13">gszGetColorDirectory</a>[]   = <span class="stringliteral">"GetColorDirectoryA"</span>;
<a name="l00073"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a14">00073</a> <span class="keywordtype">char</span>   <span class="keyword">const</span> <a class="code" href="../../d4/d9/icmupg_8c.html#a14">gszEnumColorProfiles</a>[]   = <span class="stringliteral">"EnumColorProfilesA"</span>;
<a name="l00074"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a15">00074</a> <a class="code" href="../../d0/d2/structVENDORINFO.html">VENDORINFO</a>   <a class="code" href="../../d4/d9/icmupg_8c.html#a15">gVendorInfo</a>;
<a name="l00075"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a16">00075</a> <span class="keywordtype">char</span>         <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
<a name="l00076"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a17">00076</a> <span class="keywordtype">char</span>   <span class="keyword">const</span> <a class="code" href="../../d4/d9/icmupg_8c.html#a17">gszFullICMRegPath</a>[]      = <span class="stringliteral">"\"HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\ICM\""</span>;
00077 
<a name="l00078"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a18">00078</a> <span class="keywordtype">char</span>   <span class="keyword">const</span> <a class="code" href="../../d4/d9/icmupg_8c.html#a18">gszInstallColorProfileA</a>[] = <span class="stringliteral">"InstallColorProfileA"</span>;
00079 
00080 
00081 <span class="comment">//BOOL gbWin98 = FALSE;</span>
00082 
00083 <span class="preprocessor">#ifdef DBG</span>
00084 <span class="preprocessor"></span><a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  gdwDebugControl;
00085 <span class="preprocessor">#endif</span>
<a name="l00086"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a19">00086</a> <span class="preprocessor"></span>TCHAR  <a class="code" href="../../d4/d9/icmupg_8c.html#a19">szValue</a>[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
<a name="l00087"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a20">00087</a> TCHAR  <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00088 
<a name="l00089"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a21">00089</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a4">PFNINSTALLCOLORPROFILEA</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a21">pInstallColorProfileA</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00090"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a22">00090</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a5">PFNINSTALLCOLORPROFILE</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a22">pInstallColorProfile</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00091"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a23">00091</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a6">PFNENUMCOLORPROFILES</a>   <a class="code" href="../../d4/d9/icmupg_8c.html#a23">pEnumColorProfiles</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00092 
00093 <span class="comment">//</span>
00094 <span class="comment">// Local functions</span>
00095 <span class="comment">//</span>
00096 
00097 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>  <a class="code" href="../../d4/d9/icmupg_8c.html#a25">InternalUpgradeICM</a>();
00098 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>  <a class="code" href="../../d4/d9/icmupg_8c.html#a26">UpgradeClass</a>(HKEY);
00099 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d4/d9/icmupg_8c.html#a27">AssociateMonitorProfile</a>();
00100 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d4/d9/icmupg_8c.html#a28">AssociatePrinterProfiles</a>(HKEY);
00101 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>  <a class="code" href="../../d4/d9/icmupg_8c.html#a29">InstallProfiles</a>();
00102 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>  <a class="code" href="../../d4/d9/icmupg_8c.html#a30">DeleteOldICMKey</a>();
00103 <span class="keywordtype">void</span>  <a class="code" href="../../d4/d9/icmupg_8c.html#a31">GetManuAndModelIDs</a>(PTSTR, DWORD*, DWORD*);
00104 <span class="keywordtype">int</span>   <a class="code" href="../../d4/d9/icmupg_8c.html#a32">lstrcmpn</a>(PTSTR, PTSTR, DWORD);
00105 
<a name="l00106"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a24">00106</a> HINSTANCE <a class="code" href="../../d4/d9/icmupg_8c.html#a24">hinstMigDll</a>;
00107 
00108 
00109 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI 
<a name="l00110"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a33">00110</a> <a class="code" href="../../d7/d9/dllentry_8c.html#a0">DllEntryPoint</a>(HINSTANCE hinstDll, DWORD dwReason, LPVOID lpReserved) {
00111   <span class="keywordflow">if</span>(dwReason==DLL_PROCESS_ATTACH) {
00112     <a class="code" href="../../d4/d9/icmupg_8c.html#a24">hinstMigDll</a> = hinstDll;
00113   }
00114   <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00115 }
00116 
00117 
00118 
00119 <span class="comment">/******************************************************************************</span>
00120 <span class="comment"> *</span>
00121 <span class="comment"> *                            QueryVersion</span>
00122 <span class="comment"> *</span>
00123 <span class="comment"> *  Function:</span>
00124 <span class="comment"> *       This function is called to get the DLL version information.</span>
00125 <span class="comment"> *</span>
00126 <span class="comment"> *  Arguments:</span>
00127 <span class="comment"> *       pszProductID - Fill in a unique string identifying us.</span>
00128 <span class="comment"> *       puDllVersion - Our DLL version</span>
00129 <span class="comment"> *</span>
00130 <span class="comment"> *       None of the other arguments are used</span>
00131 <span class="comment"> *</span>
00132 <span class="comment"> *  Returns:</span>
00133 <span class="comment"> *       ERROR_SUCCESS to indicate success</span>
00134 <span class="comment"> *</span>
00135 <span class="comment"> ******************************************************************************/</span>
00136 
00137 LONG
00138 CALLBACK
<a name="l00139"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a34">00139</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a34">QueryVersion</a>(
00140         OUT LPCSTR  *pszProductID,
00141         OUT LPUINT  puDllVersion,
00142         OUT LPINT   *pCodePageArray,    OPTIONAL
00143         OUT LPCSTR  *ppszExeNamesBuf,   OPTIONAL
00144         OUT PVENDORINFO  *ppVendorInfo
00145         )
00146 {
00147     *pszProductID = <a class="code" href="../../d4/d9/icmupg_8c.html#a11">gszProductID</a>;
00148     *puDllVersion = 1;
00149     *ppszExeNamesBuf    = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00150     *pCodePageArray = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00151     *ppVendorInfo = &amp;<a class="code" href="../../d4/d9/icmupg_8c.html#a15">gVendorInfo</a>;
00152     memset(&amp;<a class="code" href="../../d4/d9/icmupg_8c.html#a15">gVendorInfo</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d2/structVENDORINFO.html">VENDORINFO</a>));
00153     FormatMessageA(
00154                  FORMAT_MESSAGE_FROM_HMODULE,
00155                  <a class="code" href="../../d4/d9/icmupg_8c.html#a24">hinstMigDll</a>,
00156                  MSG_VI_COMPANY_NAME,
00157                  MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
00158                  <a class="code" href="../../d4/d9/icmupg_8c.html#a15">gVendorInfo</a>.<a class="code" href="../../d0/d2/structVENDORINFO.html#o0">CompanyName</a>,
00159                  <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/icmupg_8c.html#a15">gVendorInfo</a>.<a class="code" href="../../d0/d2/structVENDORINFO.html#o0">CompanyName</a>),
00160                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00161                  );
00162 
00163     FormatMessageA(
00164                  FORMAT_MESSAGE_FROM_HMODULE,
00165                  <a class="code" href="../../d4/d9/icmupg_8c.html#a24">hinstMigDll</a>,
00166                  MSG_VI_SUPPORT_NUMBER,
00167                  MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
00168                  <a class="code" href="../../d4/d9/icmupg_8c.html#a15">gVendorInfo</a>.<a class="code" href="../../d0/d2/structVENDORINFO.html#o1">SupportNumber</a>,
00169                  <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/icmupg_8c.html#a15">gVendorInfo</a>.<a class="code" href="../../d0/d2/structVENDORINFO.html#o1">SupportNumber</a>),
00170                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00171                  );
00172 
00173     FormatMessageA(
00174                  FORMAT_MESSAGE_FROM_HMODULE,
00175                  <a class="code" href="../../d4/d9/icmupg_8c.html#a24">hinstMigDll</a>,
00176                  MSG_VI_SUPPORT_URL,
00177                  MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
00178                  <a class="code" href="../../d4/d9/icmupg_8c.html#a15">gVendorInfo</a>.<a class="code" href="../../d0/d2/structVENDORINFO.html#o2">SupportUrl</a>,
00179                  <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/icmupg_8c.html#a15">gVendorInfo</a>.<a class="code" href="../../d0/d2/structVENDORINFO.html#o2">SupportUrl</a>),
00180                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00181                  );
00182 
00183     FormatMessageA(
00184                  FORMAT_MESSAGE_FROM_HMODULE,
00185                  <a class="code" href="../../d4/d9/icmupg_8c.html#a24">hinstMigDll</a>,
00186                  MSG_VI_INSTRUCTIONS,
00187                  MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
00188                  <a class="code" href="../../d4/d9/icmupg_8c.html#a15">gVendorInfo</a>.<a class="code" href="../../d0/d2/structVENDORINFO.html#o3">InstructionsToUser</a>,
00189                  <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/icmupg_8c.html#a15">gVendorInfo</a>.<a class="code" href="../../d0/d2/structVENDORINFO.html#o3">InstructionsToUser</a>),
00190                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00191                  );
00192     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"QueryVersion called\n"</span>)));
00193     <span class="keywordflow">return</span> ERROR_SUCCESS;
00194 }
00195 
00196 
00197 <span class="comment">/******************************************************************************</span>
00198 <span class="comment"> *</span>
00199 <span class="comment"> *                            Initialize9x</span>
00200 <span class="comment"> *</span>
00201 <span class="comment"> *  Function:</span>
00202 <span class="comment"> *       This function is called when upgrading to NT 5.0 from Win9x on the</span>
00203 <span class="comment"> *       Win9x side.</span>
00204 <span class="comment"> *</span>
00205 <span class="comment"> *  Arguments:</span>
00206 <span class="comment"> *       pszWorkingDir - Directory where migrate.inf will be found</span>
00207 <span class="comment"> *</span>
00208 <span class="comment"> *  Returns:</span>
00209 <span class="comment"> *       ERROR_SUCCESS to indicate success</span>
00210 <span class="comment"> *</span>
00211 <span class="comment"> ******************************************************************************/</span>
00212 
00213 LONG
00214 CALLBACK
<a name="l00215"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a35">00215</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a35">Initialize9x</a>(
00216     IN  LPCSTR   pszWorkingDir,
00217     IN  LPCSTR   pszSourceDir,
00218     IN  LPVOID   pvReserved
00219     )
00220 {
00221   <span class="comment">//</span>
00222   <span class="comment">// Lets figure out if we're on a Win98 or Win95 system</span>
00223   <span class="comment">// We don't migrate Win95 because Win95 doesn't have a </span>
00224   <span class="comment">// profile database to migrate.</span>
00225   <span class="comment">//</span>
00226 
00227 <span class="comment">/*  OSVERSIONINFO osVer;</span>
00228 <span class="comment"></span>
00229 <span class="comment">  osVer.dwOSVersionInfoSize = sizeof(OSVERSIONINFO);</span>
00230 <span class="comment">  GetVersionEx(&amp;osVer);</span>
00231 <span class="comment">  gbWin98 = </span>
00232 <span class="comment">    (osVer.dwPlatformId == VER_PLATFORM_WIN32_WINDOWS) &amp;&amp;</span>
00233 <span class="comment">    ( (osVer.dwMajorVersion &gt; 4) ||</span>
00234 <span class="comment">    ( (osVer.dwMajorVersion == 4) &amp;&amp; (osVer.dwMinorVersion &gt; 0) ) );</span>
00235 <span class="comment"> */</span>
00236   <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Initialize9x called\n"</span>)));
00237    
00238   lstrcpyA(<a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>, pszWorkingDir);
00239   lstrcatA(<a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>, <span class="stringliteral">"\\migrate.inf"</span>);
00240 
00241   <span class="keywordflow">return</span> ERROR_SUCCESS;
00242 }
00243 
00244 
00245 <span class="comment">/******************************************************************************</span>
00246 <span class="comment"> *</span>
00247 <span class="comment"> *                            MigrateUser9x</span>
00248 <span class="comment"> *</span>
00249 <span class="comment"> *  Function:</span>
00250 <span class="comment"> *       This function is called on Win9x to upgrade per user settings.</span>
00251 <span class="comment"> *</span>
00252 <span class="comment"> *  Arguments:</span>
00253 <span class="comment"> *       None of the arguments are used</span>
00254 <span class="comment"> *</span>
00255 <span class="comment"> *  Returns:</span>
00256 <span class="comment"> *       ERROR_SUCCES to indicate success</span>
00257 <span class="comment"> *</span>
00258 <span class="comment"> ******************************************************************************/</span>
00259 
00260 LONG
00261 CALLBACK
<a name="l00262"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a36">00262</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a36">MigrateUser9x</a>(
00263     IN  HWND     hwndParent,
00264     IN  LPCSTR   pszUnattendFile,
00265     IN  HKEY     hUserRegKey,
00266     IN  LPCSTR   pszUserName,
00267     LPVOID       pvReserved
00268     )
00269 {
00270     <span class="comment">//</span>
00271     <span class="comment">// Nothing to do</span>
00272     <span class="comment">//</span>
00273 
00274     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"MigrateUser9x called\n"</span>)));
00275     <span class="keywordflow">return</span>  ERROR_SUCCESS;
00276 }
00277 
00278 
00279 <span class="comment">/******************************************************************************</span>
00280 <span class="comment"> *</span>
00281 <span class="comment"> *                            MigrateSystem9x</span>
00282 <span class="comment"> *</span>
00283 <span class="comment"> *  Function:</span>
00284 <span class="comment"> *       This function is called on the Win9x to upgrade system settings.</span>
00285 <span class="comment"> *</span>
00286 <span class="comment"> *  Arguments:</span>
00287 <span class="comment"> *       None of the arguments are used</span>
00288 <span class="comment"> *</span>
00289 <span class="comment"> *  Returns:</span>
00290 <span class="comment"> *       ERROR_SUCCES to indicate success</span>
00291 <span class="comment"> *</span>
00292 <span class="comment"> ******************************************************************************/</span>
00293 
00294 LONG
00295 CALLBACK
<a name="l00296"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a37">00296</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a37">MigrateSystem9x</a>(
00297     IN  HWND    hwndParent,
00298     IN  LPCSTR  pszUnattendFile,
00299     LPVOID      pvReserved
00300     )
00301 {
00302     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            nProfiles;
00303     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            dwSize;
00304     <span class="keywordtype">char</span>             szColorDir[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00305     <span class="keywordtype">char</span>             szNewColorDir[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00306     <span class="keywordtype">char</span>             szDrive[2];
00307     HMODULE          hModule;
00308     ENUMTYPE         et = {<span class="keyword">sizeof</span> (ENUMTYPE), ENUM_TYPE_VERSION, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>};    
00309     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>            pBuffer;
00310     PSTR             pstrBuffer;
00311     PSTR             pstrTraversal;
00312 
00313     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"MigrateSystem9x called\n"</span>)));
00314     
00315     <span class="comment">//</span>
00316     <span class="comment">// Produce the Win9x Color Directory.</span>
00317     <span class="comment">//</span>
00318 
00319     GetWindowsDirectoryA(szColorDir, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>);
00320     <span class="keywordflow">if</span> (szColorDir[lstrlenA(szColorDir)-1] != <span class="charliteral">'\\'</span>) 
00321     {
00322         lstrcatA(szColorDir,<span class="stringliteral">"\\"</span>);
00323     }
00324     lstrcatA(szColorDir, <span class="stringliteral">"system\\color\\"</span>);
00325     
00326     GetWindowsDirectoryA(szNewColorDir, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>);
00327     <span class="keywordflow">if</span> (szNewColorDir[lstrlenA(szNewColorDir)-1] != <span class="charliteral">'\\'</span>) 
00328     {
00329         lstrcatA(szNewColorDir,<span class="stringliteral">"\\"</span>);
00330     }
00331     lstrcatA(szNewColorDir, <span class="stringliteral">"system32\\spool\\drivers\\color\\"</span>);
00332 
00333 
00334     <span class="comment">//</span>
00335     <span class="comment">// If this is a Win95 system we have nothing to do because</span>
00336     <span class="comment">// Win95 doesn't have a color profile database.</span>
00337     <span class="comment">//</span>
00338 
00339     
00340     <span class="comment">//</span>
00341     <span class="comment">// We can't have mscms as an implib because when they try to load us in</span>
00342     <span class="comment">// Win95, they won't find mscms.dll and reject us.</span>
00343     <span class="comment">//</span>
00344     
00345     hModule = LoadLibrary(<a class="code" href="../../d4/d9/icmupg_8c.html#a10">gszMSCMSdll</a>);
00346     <span class="keywordflow">if</span> (hModule) {
00347 <span class="preprocessor">      #ifdef ICM_MIG_DEBUG</span>
00348 <span class="preprocessor"></span>      WritePrivateProfileStringA(<span class="stringliteral">"ICM Debug"</span>, <span class="stringliteral">"hModule"</span>, <span class="stringliteral">"not NULL"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>);
00349       WritePrivateProfileStringA(<span class="stringliteral">"ICM Debug"</span>, <span class="stringliteral">"gbWin98"</span>, <span class="stringliteral">"TRUE"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>);
00350 <span class="preprocessor">      #endif</span>
00351 <span class="preprocessor"></span>
00352       <a class="code" href="../../d4/d9/icmupg_8c.html#a23">pEnumColorProfiles</a> = (<a class="code" href="../../d4/d9/icmupg_8c.html#a6">PFNENUMCOLORPROFILES</a>)GetProcAddress(hModule, <a class="code" href="../../d4/d9/icmupg_8c.html#a14">gszEnumColorProfiles</a>);
00353       <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/icmupg_8c.html#a23">pEnumColorProfiles</a>) {
00354         
00355 <span class="preprocessor">        #ifdef ICM_MIG_DEBUG</span>
00356 <span class="preprocessor"></span>        WritePrivateProfileStringA(<span class="stringliteral">"ICM Debug"</span>, <span class="stringliteral">"pEnumColorProfiles"</span>, <span class="stringliteral">"not NULL"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>);
00357 <span class="preprocessor">        #endif</span>
00358 <span class="preprocessor"></span>
00359         <span class="comment">//</span>
00360         <span class="comment">// Compute the size of the EnumColorProfiles buffer.</span>
00361         <span class="comment">//</span>
00362     
00363         dwSize = 0;
00364         <a class="code" href="../../d4/d9/icmupg_8c.html#a23">pEnumColorProfiles</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;et, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;dwSize, &amp;nProfiles);
00365         
00366         <span class="keywordflow">if</span>(dwSize==0) 
00367         {
00368 <span class="preprocessor">          #ifdef ICM_MIG_DEBUG</span>
00369 <span class="preprocessor"></span>          WritePrivateProfileStringA(<span class="stringliteral">"ICM Debug"</span>, <span class="stringliteral">"dwSize"</span>, <span class="stringliteral">"0"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>);
00370 <span class="preprocessor">          #endif </span>
00371 <span class="preprocessor"></span>          <span class="comment">//</span>
00372           <span class="comment">// Need to exit - nothing to do if there are no profiles installed,</span>
00373           <span class="comment">// except to move the directory and registry settings.</span>
00374           <span class="comment">//</span>
00375           <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"No profiles installed\n"</span>)));
00376           <span class="keywordflow">goto</span> EndMigrateSystem9x;
00377         }
00378     
00379     
00380         <span class="comment">//</span>
00381         <span class="comment">// Enumerate all the currently installed color profiles.</span>
00382         <span class="comment">//</span>
00383 
00384 <span class="preprocessor">        #ifdef ICM_MIG_DEBUG</span>
00385 <span class="preprocessor"></span>        WritePrivateProfileStringA(<span class="stringliteral">"ICM Debug"</span>, <span class="stringliteral">"Enumerate"</span>, <span class="stringliteral">"Start"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>);
00386 <span class="preprocessor">        #endif </span>
00387 <span class="preprocessor"></span>
00388         pBuffer = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)malloc(dwSize);
00389         pstrBuffer = (PSTR)pBuffer;
00390         
00391 <span class="preprocessor">        #ifdef ICM_MIG_DEBUG</span>
00392 <span class="preprocessor"></span>        WritePrivateProfileStringA(<span class="stringliteral">"ICM Debug"</span>, <span class="stringliteral">"Enumerate"</span>, <span class="stringliteral">"TRUE"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>);
00393 <span class="preprocessor">        #endif         </span>
00394 <span class="preprocessor"></span>        
00395         <span class="keywordflow">if</span>(<a class="code" href="../../d4/d9/icmupg_8c.html#a23">pEnumColorProfiles</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;et, pBuffer, &amp;dwSize, &amp;nProfiles))
00396         {            
00397 <span class="preprocessor">            #ifdef ICM_MIG_DEBUG</span>
00398 <span class="preprocessor"></span>            WritePrivateProfileStringA(<span class="stringliteral">"ICM Debug"</span>, <span class="stringliteral">"Enumerate"</span>, <span class="stringliteral">"for"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>);
00399 <span class="preprocessor">            #endif </span>
00400 <span class="preprocessor"></span>
00401             <span class="keywordflow">for</span>(pstrTraversal = pstrBuffer;
00402                 nProfiles--;
00403                 pstrTraversal += 1 + lstrlenA(pstrTraversal)) {
00404 
00405                 <span class="comment">//</span>
00406                 <span class="comment">// Write the fact into the Migration Information file.</span>
00407                 <span class="comment">//</span>
00408                 
00409                 WritePrivateProfileStringA(<span class="stringliteral">"Installed ICM Profiles"</span>, pstrTraversal, <span class="stringliteral">"1"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>);
00410             }
00411         }
00412         free(pBuffer);
00413       } 
00414 <span class="preprocessor">      #ifdef ICM_MIG_DEBUG</span>
00415 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
00416         WritePrivateProfileStringA(<span class="stringliteral">"ICM Debug"</span>, <span class="stringliteral">"pEnumColorProfiles"</span>, <span class="stringliteral">"NULL"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>);
00417       }
00418 <span class="preprocessor">      #endif</span>
00419 <span class="preprocessor"></span>
00420   
00421       EndMigrateSystem9x:
00422       <span class="keywordflow">if</span> (hModule)
00423       {
00424           FreeLibrary(hModule);
00425       }
00426   }
00427 <span class="preprocessor">  #ifdef ICM_MIG_DEBUG</span>
00428 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
00429     WritePrivateProfileStringA(<span class="stringliteral">"ICM Debug"</span>, <span class="stringliteral">"hModule"</span>, <span class="stringliteral">"NULL"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>);    
00430     WritePrivateProfileStringA(<span class="stringliteral">"ICM Debug"</span>, <span class="stringliteral">"gbWin98"</span>, <span class="stringliteral">"FALSE"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>);
00431   }
00432 <span class="preprocessor">  #endif</span>
00433 <span class="preprocessor"></span>
00434   <span class="comment">//</span>
00435   <span class="comment">// We'll handle the ICM branch of the registry</span>
00436   <span class="comment">//</span>
00437 
00438   WritePrivateProfileStringA(<span class="stringliteral">"Handled"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a17">gszFullICMRegPath</a>, <span class="stringliteral">"Registry"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>);
00439 
00440       
00441   <span class="comment">//</span>
00442   <span class="comment">// We'll be moving the entire subdirectory.</span>
00443   <span class="comment">//</span>
00444 
00445   WritePrivateProfileStringA(<span class="stringliteral">"Moved"</span>, szColorDir, szNewColorDir, <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>);
00446 
00447 
00448   <span class="keywordflow">return</span>  ERROR_SUCCESS;
00449 }
00450 
00451 
00452 <span class="comment">/******************************************************************************</span>
00453 <span class="comment"> *</span>
00454 <span class="comment"> *                            InitializeNT</span>
00455 <span class="comment"> *</span>
00456 <span class="comment"> *  Function:</span>
00457 <span class="comment"> *       This function is called when upgrading to NT 5.0 from Win9x on the NT</span>
00458 <span class="comment"> *       side. Its main purpose is to initialize us.</span>
00459 <span class="comment"> *</span>
00460 <span class="comment"> *  Arguments:</span>
00461 <span class="comment"> *       None of the arguments are used</span>
00462 <span class="comment"> *</span>
00463 <span class="comment"> *  Returns:</span>
00464 <span class="comment"> *       ERROR_SUCCESS to indicate success</span>
00465 <span class="comment"> *</span>
00466 <span class="comment"> ******************************************************************************/</span>
00467 
00468 LONG
00469 CALLBACK
<a name="l00470"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a38">00470</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a38">InitializeNT</a>(
00471     IN  LPCWSTR pszWorkingDir,
00472     IN  LPCWSTR pszSourceDir,
00473     LPVOID      pvReserved
00474     )
00475 {
00476     SetupOpenLog(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00477     SetupLogError(<span class="stringliteral">"ICM Migration: InitializeNT called\r\n"</span>, LogSevInformation);
00478     <span class="keywordflow">return</span> ERROR_SUCCESS;
00479 }
00480 
00481 
00482 <span class="comment">/******************************************************************************</span>
00483 <span class="comment"> *</span>
00484 <span class="comment"> *                            MigrateUserNT</span>
00485 <span class="comment"> *</span>
00486 <span class="comment"> *  Function:</span>
00487 <span class="comment"> *       This function is called on the NT to upgrade per user settings.</span>
00488 <span class="comment"> *</span>
00489 <span class="comment"> *  Arguments:</span>
00490 <span class="comment"> *       None of the arguments are used</span>
00491 <span class="comment"> *</span>
00492 <span class="comment"> *  Returns:</span>
00493 <span class="comment"> *       ERROR_SUCCES to indicate success</span>
00494 <span class="comment"> *</span>
00495 <span class="comment"> ******************************************************************************/</span>
00496 
00497 LONG
00498 CALLBACK
<a name="l00499"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a39">00499</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a39">MigrateUserNT</a>(
00500     IN  HANDLE    hUnattendInf,
00501     IN  HKEY      hUserRegKey,
00502     IN  LPCWSTR   pszUserName,
00503     LPVOID        pvReserved
00504     )
00505 {
00506     SetupLogError(<span class="stringliteral">"ICM Migration: MigrateUserNT called\r\n"</span>, LogSevInformation);
00507 
00508     <span class="comment">//</span>
00509     <span class="comment">// Nothing to do</span>
00510     <span class="comment">//</span>
00511 
00512     <span class="keywordflow">return</span>  ERROR_SUCCESS;
00513 }
00514 
00515 
00516 <span class="comment">/******************************************************************************</span>
00517 <span class="comment"> *</span>
00518 <span class="comment"> *                            MigrateSystemNT</span>
00519 <span class="comment"> *</span>
00520 <span class="comment"> *  Function:</span>
00521 <span class="comment"> *       This function is called on the Win9x to upgrade system settings. This</span>
00522 <span class="comment"> *       is where we upgrade ICM 2.0</span>
00523 <span class="comment"> *</span>
00524 <span class="comment"> *  Arguments:</span>
00525 <span class="comment"> *       None of the other arguments are used</span>
00526 <span class="comment"> *</span>
00527 <span class="comment"> *  Returns:</span>
00528 <span class="comment"> *       ERROR_SUCCES to indicate success</span>
00529 <span class="comment"> *</span>
00530 <span class="comment"> ******************************************************************************/</span>
00531 
00532 LONG
00533 CALLBACK
<a name="l00534"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a40">00534</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a40">MigrateSystemNT</a>(
00535     IN  HANDLE  hUnattendInf,
00536     LPVOID      pvReserved
00537     )
00538 {
00539     HINSTANCE hModule;
00540     LONG      rc = ERROR_FILE_NOT_FOUND;
00541     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>      szMessage[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00542 
00543     SetupLogError(<span class="stringliteral">"ICM Migration: MigrateSystemNT called\r\n"</span>, LogSevInformation);
00544     
00545     <span class="comment">//</span>
00546     <span class="comment">// We can't have mscms as an implib because when they try to load us in</span>
00547     <span class="comment">// Win95, they won't find mscms.dll and reject us.</span>
00548     <span class="comment">//</span>
00549 
00550     hModule = LoadLibrary(<a class="code" href="../../d4/d9/icmupg_8c.html#a10">gszMSCMSdll</a>);
00551     <span class="keywordflow">if</span> (!hModule)
00552     {
00553         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(szMessage, <span class="stringliteral">"ICM Migration: Fatal Error, cannot load mscms.dll. Error %d\r\n"</span>, GetLastError());
00554         SetupLogError(szMessage, LogSevFatalError);
00555         <span class="keywordflow">return</span> rc;
00556     }
00557 
00558     <a class="code" href="../../d4/d9/icmupg_8c.html#a21">pInstallColorProfileA</a> = (<a class="code" href="../../d4/d9/icmupg_8c.html#a4">PFNINSTALLCOLORPROFILEA</a>)GetProcAddress(hModule, <a class="code" href="../../d4/d9/icmupg_8c.html#a18">gszInstallColorProfileA</a>);
00559     <a class="code" href="../../d4/d9/icmupg_8c.html#a22">pInstallColorProfile</a> = (<a class="code" href="../../d4/d9/icmupg_8c.html#a5">PFNINSTALLCOLORPROFILE</a>)GetProcAddress(hModule, <a class="code" href="../../d4/d9/icmupg_8c.html#a12">gszInstallColorProfile</a>);
00560 
00561     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/icmupg_8c.html#a22">pInstallColorProfile</a> || !<a class="code" href="../../d4/d9/icmupg_8c.html#a21">pInstallColorProfileA</a>)
00562     {
00563         SetupLogError(<span class="stringliteral">"ICM Migration: Fatal Error, cannot find mscms functions. \r\n"</span>, LogSevFatalError);
00564         <span class="keywordflow">goto</span> EndMigrateSystemNT;
00565     }
00566 
00567     <a class="code" href="../../d4/d9/icmupg_8c.html#a25">InternalUpgradeICM</a>();   <span class="comment">// Upgrade over Win9x</span>
00568     <a class="code" href="../../d4/d9/icmupg_8c.html#a29">InstallProfiles</a>();      <span class="comment">// Install all profiles in the old color directory</span>
00569     <a class="code" href="../../d4/d9/icmupg_8c.html#a30">DeleteOldICMKey</a>();
00570 
00571     rc = ERROR_SUCCESS;
00572 
00573 EndMigrateSystemNT:
00574 
00575     <span class="keywordflow">if</span> (hModule)
00576     {
00577         FreeLibrary(hModule);
00578     }
00579 
00580     <span class="keywordflow">return</span> rc;
00581 }
00582 
00583 
00584 <span class="comment">/******************************************************************************</span>
00585 <span class="comment"> *</span>
00586 <span class="comment"> *                           DeleteOldICMKey</span>
00587 <span class="comment"> *</span>
00588 <span class="comment"> *  Function:</span>
00589 <span class="comment"> *       This function deletes the ICM key and subkeys from the Windows branch.</span>
00590 <span class="comment"> *</span>
00591 <span class="comment"> *  Arguments:</span>
00592 <span class="comment"> *       None</span>
00593 <span class="comment"> *</span>
00594 <span class="comment"> *  Returns:</span>
00595 <span class="comment"> *       Nothing</span>
00596 <span class="comment"> *</span>
00597 <span class="comment"> ******************************************************************************/</span>
00598 
00599 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00600"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a30">00600</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a30">DeleteOldICMKey</a>()
00601 {
00602     HKEY      hkICM = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;         <span class="comment">// key to ICM branch in registry</span>
00603     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nSubkeys, i;
00604     TCHAR szKeyName[32];
00605 
00606     <span class="comment">//</span>
00607     <span class="comment">// Open the registry path where profiles used to be kept</span>
00608     <span class="comment">//</span>
00609 
00610     <span class="keywordflow">if</span> (RegCreateKeyEx(HKEY_LOCAL_MACHINE, <a class="code" href="../../d4/d9/icmupg_8c.html#a8">gszICMRegPath</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 
00611                        REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS,
00612                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;hkICM, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) != ERROR_SUCCESS)
00613     {
00614         
00615         SetupLogError(<span class="stringliteral">"ICM Migration: Cannot open ICM branch of registry\r\n"</span>, LogSevError);
00616         <span class="keywordflow">return</span>;
00617     }
00618 
00619     <span class="keywordflow">if</span> (RegQueryInfoKey(hkICM, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, &amp;nSubkeys, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00620         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) != ERROR_SUCCESS)
00621     {
00622         SetupLogError(<span class="stringliteral">"ICM Migration: Cannot enumerate ICM branch of registry\r\n"</span>, LogSevError);
00623         <span class="keywordflow">goto</span> EndDeleteOldICMKey;
00624     }
00625 
00626     <span class="comment">//</span>
00627     <span class="comment">// Go through all the device classes and delete all subkeys - this should</span>
00628     <span class="comment">// only be one level deep</span>
00629     <span class="comment">//</span>
00630 
00631     <span class="keywordflow">for</span> (i=nSubkeys; i&gt;0; i--)
00632     {
00633         RegEnumKey(hkICM, i-1, szKeyName, <span class="keyword">sizeof</span>(szKeyName));
00634         RegDeleteKey(hkICM, szKeyName);
00635     }
00636 
00637 EndDeleteOldICMKey:
00638     <span class="keywordflow">if</span> (hkICM)
00639     {
00640         RegCloseKey(hkICM);
00641     }
00642     RegDeleteKey(HKEY_LOCAL_MACHINE, <a class="code" href="../../d4/d9/icmupg_8c.html#a8">gszICMRegPath</a>);
00643 
00644     <span class="keywordflow">return</span>;
00645 }
00646 
00647 
00648 <span class="comment">//</span>
00649 <span class="comment">// Move directory with contents.</span>
00650 <span class="comment">// Note this is not recursive.</span>
00651 <span class="comment">// The purpose of this routine is to move the old color directory to the </span>
00652 <span class="comment">// new color directory. During setup the new color directory may have already</span>
00653 <span class="comment">// been created and populated with files. Vendor apps may have populated the </span>
00654 <span class="comment">// old color directory with private subdirectories and files which will not </span>
00655 <span class="comment">// appear in the new directory created by setup. This routine is designed </span>
00656 <span class="comment">// to move those files.</span>
00657 <span class="comment">//</span>
00658 <span class="comment">// Note it'll fail to move a subdirectory of the old color directory if </span>
00659 <span class="comment">// a similar subdirectory exists in the new color directory - this should not</span>
00660 <span class="comment">// be the case.</span>
00661 <span class="comment">//</span>
00662 <span class="comment">// s and d should have the trailing slash.</span>
00663 <span class="comment">//</span>
00664 
<a name="l00665"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a41">00665</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d9/icmupg_8c.html#a41">MyMoveDir</a>(<span class="keywordtype">char</span> *s, <span class="keywordtype">char</span> *d) {
00666   WIN32_FIND_DATA rf;
00667   HANDLE hf;
00668   <span class="keywordtype">char</span> s2[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00669   <span class="keywordtype">char</span> s_[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00670   <span class="keywordtype">char</span> d_[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00671   <span class="keywordtype">char</span> err[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00672 
00673   <span class="comment">//</span>
00674   <span class="comment">// If MoveFileEx succeeds, we're done.</span>
00675   <span class="comment">//</span>
00676 
00677   <span class="keywordflow">if</span>(!MoveFileEx(s, d, MOVEFILE_REPLACE_EXISTING)) {
00678     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(s2, <span class="stringliteral">"%s*"</span>, s);
00679     hf = FindFirstFile(s2, &amp;rf);
00680     <span class="keywordflow">do</span> {
00681       <span class="comment">// don't move . and ..</span>
00682       <span class="keywordflow">if</span>(!(strcmp(<span class="stringliteral">"."</span>, rf.cFileName)==0 ||
00683            strcmp(<span class="stringliteral">".."</span>, rf.cFileName)==0) ) {
00684         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(s_, <span class="stringliteral">"%s%s"</span>, s, rf.cFileName);
00685         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(d_, <span class="stringliteral">"%s%s"</span>, d, rf.cFileName);
00686         <span class="keywordflow">if</span>(!MoveFileEx(s_, d_, MOVEFILE_REPLACE_EXISTING)) {
00687           <span class="keywordtype">int</span> e = GetLastError();  
00688           <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(err, <span class="stringliteral">"ICM Migration: Failed the move of %s with %d\r\n"</span>, s_, e);
00689           SetupLogError(err, LogSevError);
00690         } <span class="keywordflow">else</span> {
00691           <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(err, <span class="stringliteral">"ICM Migration: Moved %s to %s\n"</span>, s_, d_);
00692           SetupLogError(err, LogSevInformation);
00693         }
00694       }
00695 
00696     } <span class="keywordflow">while</span>(FindNextFile(hf, &amp;rf));
00697     FindClose(hf);
00698   }
00699 
00700   <span class="comment">//</span>
00701   <span class="comment">// source directory should theoretically be empty at this point</span>
00702   <span class="comment">// If there are errors, we'll leave files behind and report this in </span>
00703   <span class="comment">// the setup log as a LogSevError.</span>
00704   <span class="comment">//</span>
00705 }
00706 
00707 
00708 
00709 <span class="comment">/******************************************************************************</span>
00710 <span class="comment"> *</span>
00711 <span class="comment"> *                           InstallProfiles</span>
00712 <span class="comment"> *</span>
00713 <span class="comment"> *  Function:</span>
00714 <span class="comment"> *       This function installs all profiles in %windir%\system\color.</span>
00715 <span class="comment"> *       This is used when upgrading from Win9x to NT 5.0.</span>
00716 <span class="comment"> *</span>
00717 <span class="comment"> *  Arguments:</span>
00718 <span class="comment"> *       None</span>
00719 <span class="comment"> *</span>
00720 <span class="comment"> *  Returns:</span>
00721 <span class="comment"> *       Nothing</span>
00722 <span class="comment"> *</span>
00723 <span class="comment"> ******************************************************************************/</span>
00724 
00725 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00726"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a29">00726</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a29">InstallProfiles</a>()
00727 {
00728     WIN32_FIND_DATAA wfd;
00729     PSTR             pNewColorDirEnd;
00730     HANDLE           hFindFile;
00731     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>             szOldColorDir[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00732     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>             szNewColorDir[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00733     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>             szReturnString[2];
00734     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>             szDefaultString[2];
00735     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>             szMessage[2*<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>+100];
00736 
00737     GetWindowsDirectoryA(szOldColorDir, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>);
00738     <span class="keywordflow">if</span> (szOldColorDir[lstrlenA(szOldColorDir)-1] != <span class="charliteral">'\\'</span>)
00739         lstrcatA(szOldColorDir, <span class="stringliteral">"\\"</span>);
00740     lstrcatA(szOldColorDir, <span class="stringliteral">"system\\color\\"</span>);
00741 
00742 
00743     GetWindowsDirectoryA(szNewColorDir, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>);
00744     <span class="keywordflow">if</span> (szNewColorDir[lstrlenA(szNewColorDir)-1] != <span class="charliteral">'\\'</span>)
00745     {
00746         lstrcatA(szNewColorDir, <span class="stringliteral">"\\"</span>);
00747     }
00748     lstrcatA(szNewColorDir, <span class="stringliteral">"system32\\spool\\drivers\\color\\"</span>);
00749 
00750     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d9/icmupg_8c.html#a21">pInstallColorProfileA</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00751 
00752 
00753     <span class="comment">//</span>
00754     <span class="comment">// Eat any errors on the MoveFile. This is just in case the migration </span>
00755     <span class="comment">// was stopped after a previous move and now the source doesn't exist.</span>
00756     <span class="comment">//</span>
00757 
00758     <a class="code" href="../../d4/d9/icmupg_8c.html#a41">MyMoveDir</a>(szOldColorDir, szNewColorDir);
00759 
00760     <span class="comment">//</span>
00761     <span class="comment">// Now we have presumably moved everything so run through the list of </span>
00762     <span class="comment">// previously installed profiles and install those in the new directory</span>
00763     <span class="comment">// (if we find them).</span>
00764     <span class="comment">//</span>
00765 
00766     pNewColorDirEnd = szNewColorDir + lstrlenA(szNewColorDir);
00767     lstrcatA(szNewColorDir, <span class="stringliteral">"*.*"</span>);
00768 
00769 
00770 
00771     szDefaultString[0]=<span class="charliteral">'0'</span>;
00772     szDefaultString[1]=0;
00773     hFindFile = FindFirstFileA(szNewColorDir, &amp;wfd);
00774 
00775 
00776     <span class="keywordflow">if</span> (hFindFile != <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>)
00777     {
00778         <span class="keywordflow">do</span>
00779         {
00780             lstrcpyA(pNewColorDirEnd, wfd.cFileName);
00781 
00782             <span class="comment">//</span>
00783             <span class="comment">// Check to see if the profile was installed on Win9x</span>
00784             <span class="comment">//</span>
00785 
00786             GetPrivateProfileStringA(<span class="stringliteral">"Installed ICM Profiles"</span>, wfd.cFileName, szDefaultString, szReturnString, 2, <a class="code" href="../../d4/d9/icmupg_8c.html#a16">gszMigInf</a>);
00787 
00788             <span class="comment">//</span>
00789             <span class="comment">// If it was installed, attempt to install it on NT</span>
00790             <span class="comment">//</span>
00791 
00792             <span class="keywordflow">if</span>(szReturnString[0]==<span class="charliteral">'1'</span>) { 
00793                 <span class="keywordflow">if</span> (!(*pInstallColorProfileA)(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, szNewColorDir))
00794                 {
00795                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(szMessage, <span class="stringliteral">"ICM Migration: Error %d installing profile %s\r\n"</span>, GetLastError(), szNewColorDir);
00796                     SetupLogError(szMessage, LogSevError);
00797                 }
00798                 <span class="keywordflow">else</span>
00799                 {
00800                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(szMessage, <span class="stringliteral">"ICM Migration: Installed profile %s\r\n"</span>, szNewColorDir);
00801                     SetupLogError(szMessage, LogSevInformation);
00802                 }
00803             }
00804 
00805         } <span class="keywordflow">while</span> (FindNextFileA(hFindFile, &amp;wfd));
00806 
00807         FindClose(hFindFile);
00808     }
00809     <span class="keywordflow">else</span>
00810     {
00811         SetupLogError(<span class="stringliteral">"ICM Migration: FindFirstFile returned an invalid handle\r\n"</span>, LogSevFatalError);
00812     }
00813 }
00814 
00815 
00816 <span class="comment">/******************************************************************************</span>
00817 <span class="comment"> *</span>
00818 <span class="comment"> *                           InternalUpgradeICM</span>
00819 <span class="comment"> *</span>
00820 <span class="comment"> *  Function:</span>
00821 <span class="comment"> *       This function forms the core of the upgrade code. It installs all</span>
00822 <span class="comment"> *       profiles in the regsitry, and associates with the right devices</span>
00823 <span class="comment"> *</span>
00824 <span class="comment"> *  Arguments:</span>
00825 <span class="comment"> *       None</span>
00826 <span class="comment"> *</span>
00827 <span class="comment"> *  Returns:</span>
00828 <span class="comment"> *       Nothing</span>
00829 <span class="comment"> *</span>
00830 <span class="comment"> ******************************************************************************/</span>
00831 
00832 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00833"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a25">00833</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a25">InternalUpgradeICM</a>()
00834 {
00835     HKEY      hkICM = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;         <span class="comment">// key to ICM branch in registry</span>
00836     HKEY      hkDevice = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;      <span class="comment">// key to ICM device branch in registry</span>
00837     <span class="keywordtype">int</span>       i;                    <span class="comment">// counter variable</span>
00838     TCHAR    *pszClasses[] = {      <span class="comment">// different profile classes</span>
00839         __TEXT(<span class="stringliteral">"mntr"</span>),
00840         __TEXT(<span class="stringliteral">"prtr"</span>),
00841         __TEXT(<span class="stringliteral">"scnr"</span>),
00842         __TEXT(<span class="stringliteral">"link"</span>),
00843         __TEXT(<span class="stringliteral">"abst"</span>),
00844         __TEXT(<span class="stringliteral">"spac"</span>),
00845         __TEXT(<span class="stringliteral">"nmcl"</span>)
00846     };
00847     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> szMessage[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00848     LONG errcode;
00849 
00850     <span class="comment">//</span>
00851     <span class="comment">// Open the registry path where profiles are kept</span>
00852     <span class="comment">//</span>
00853     
00854     <span class="keywordflow">if</span> (errcode = RegCreateKeyEx(HKEY_LOCAL_MACHINE, <a class="code" href="../../d4/d9/icmupg_8c.html#a8">gszICMRegPath</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 
00855                                  REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 
00856                                  &amp;hkICM, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) != ERROR_SUCCESS)
00857     {
00858         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(szMessage, <span class="stringliteral">"ICM Migration: Fatal Error, cannot open registry entry (%s) code:%d\r\n"</span>, 
00859                 <a class="code" href="../../d4/d9/icmupg_8c.html#a8">gszICMRegPath</a>, errcode);
00860         SetupLogError(szMessage, LogSevFatalError);
00861         <span class="keywordflow">return</span>;
00862     }
00863 
00864     <span class="comment">//</span>
00865     <span class="comment">// Go through all the device classes and install the profiles</span>
00866     <span class="comment">//</span>
00867 
00868     <span class="keywordflow">for</span> (i=0; i&lt;<span class="keyword">sizeof</span>(pszClasses)/<span class="keyword">sizeof</span>(PTSTR); i++)
00869     {
00870         <span class="keywordflow">if</span> (RegOpenKeyEx(hkICM, pszClasses[i], 0, KEY_ALL_ACCESS, &amp;hkDevice) != ERROR_SUCCESS)
00871         {
00872             <span class="keywordflow">continue</span>;           <span class="comment">// go to next key</span>
00873         }
00874        
00875         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(szMessage, <span class="stringliteral">"ICM Migration: Upgrading %s\r\n"</span>, pszClasses[i]);
00876         SetupLogError(szMessage, LogSevInformation);
00877         <a class="code" href="../../d4/d9/icmupg_8c.html#a26">UpgradeClass</a>(hkDevice);
00878 
00879         RegCloseKey(hkDevice);
00880     }
00881 
00882     <span class="comment">//</span>
00883     <span class="comment">// Set default monitor profile</span>
00884     <span class="comment">//</span>
00885 
00886     <span class="comment">// AssociateMonitorProfile(); - Not needed for Memphis</span>
00887     <span class="comment">// If Pnp moves everything from Win9x PnP S/W section to NT 5.0 PnP S/W</span>
00888     <span class="comment">// section, then we don't need this for NT either</span>
00889 
00890     <span class="keywordflow">if</span> (hkICM)
00891     {
00892         RegCloseKey(hkICM);
00893     }
00894 
00895     <span class="keywordflow">return</span>;
00896 }
00897 
00898 
00899 <span class="comment">/******************************************************************************</span>
00900 <span class="comment"> *</span>
00901 <span class="comment"> *                           UpgradeClass</span>
00902 <span class="comment"> *</span>
00903 <span class="comment"> *  Function:</span>
00904 <span class="comment"> *       This function recursively calls itself to go down a registry path</span>
00905 <span class="comment"> *       till it reaches the leaf, and installs all profiles it finds there</span>
00906 <span class="comment"> *</span>
00907 <span class="comment"> *  Arguments:</span>
00908 <span class="comment"> *       hKey            - registry key for root node</span>
00909 <span class="comment"> *</span>
00910 <span class="comment"> *  Returns:</span>
00911 <span class="comment"> *       Nothing</span>
00912 <span class="comment"> *</span>
00913 <span class="comment"> ******************************************************************************/</span>
00914 
00915 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00916"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a26">00916</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a26">UpgradeClass</a>(
00917     HKEY  hKey
00918     )
00919 {
00920     HKEY  hSubkey;
00921     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nSubkeys, nValues, i, cbName, cbValue;
00922     TCHAR szKeyName[32];
00923     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>  szMessage[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00924 
00925     <span class="comment">//</span>
00926     <span class="comment">// If there is an error, return</span>
00927     <span class="comment">//</span>
00928 
00929     <span class="keywordflow">if</span> (RegQueryInfoKey(hKey, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, &amp;nSubkeys, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00930         &amp;nValues, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) != ERROR_SUCCESS)
00931     {
00932         <span class="keywordflow">return</span>;
00933     }
00934 
00935     <span class="keywordflow">if</span> (nSubkeys &gt; 0)
00936     {
00937         <span class="comment">//</span>
00938         <span class="comment">// This is not the leaf node, recurse</span>
00939         <span class="comment">//</span>
00940 
00941         <span class="keywordflow">for</span> (i=nSubkeys; i&gt;0; i--)
00942         {
00943             RegEnumKey(hKey, i-1, szKeyName, <span class="keyword">sizeof</span>(szKeyName));
00944             <span class="keywordflow">if</span> (RegOpenKeyEx(hKey, szKeyName, 0, KEY_ALL_ACCESS, &amp;hSubkey) == ERROR_SUCCESS)
00945             {
00946                 <a class="code" href="../../d4/d9/icmupg_8c.html#a26">UpgradeClass</a>(hSubkey);
00947                 RegCloseKey(hSubkey);
00948                 RegDeleteKey(hKey, szKeyName);
00949             }
00950         }
00951     }
00952     <span class="keywordflow">else</span>
00953     {
00954         <span class="comment">//</span>
00955         <span class="comment">// This is the leaf node - install all the profiles registered</span>
00956         <span class="comment">//</span>
00957 
00958         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d9/icmupg_8c.html#a22">pInstallColorProfile</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00959 
00960         <span class="keywordflow">for</span> (i=nValues; i&gt;0; i--)
00961         {
00962             cbName = <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>;
00963             cbValue = <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>;
00964             <span class="keywordflow">if</span> (RegEnumValue(hKey, i-1, <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>, &amp;cbName, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (LPBYTE)<a class="code" href="../../d4/d9/icmupg_8c.html#a19">szValue</a>,
00965                 &amp;cbValue) == ERROR_SUCCESS)
00966             {
00967                 <span class="keywordflow">if</span> (! <a class="code" href="../../d4/d9/icmupg_8c.html#a32">lstrcmpn</a>(<a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>, (PTSTR)<a class="code" href="../../d4/d9/icmupg_8c.html#a9">gszProfile</a>, lstrlen(<a class="code" href="../../d4/d9/icmupg_8c.html#a9">gszProfile</a>)))
00968                 {
00969                     <span class="keywordflow">if</span> (! (*pInstallColorProfile)(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d9/icmupg_8c.html#a19">szValue</a>))
00970                     {
00971                         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(szMessage, <span class="stringliteral">"ICM Migration: Error installing profile %s\r\n"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a19">szValue</a>);
00972                         SetupLogError(szMessage, LogSevError);
00973                     }
00974                     <span class="keywordflow">else</span>
00975                     {
00976                         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(szMessage, <span class="stringliteral">"ICM Migration: Installed profile %s\r\n"</span>, <a class="code" href="../../d4/d9/icmupg_8c.html#a19">szValue</a>);
00977                         SetupLogError(szMessage, LogSevInformation);
00978                     }            
00979                 }
00980                 <span class="keywordflow">else</span>
00981                 {
00982                     PTSTR pProfile;
00983                 
00984                     <span class="comment">//</span>
00985                     <span class="comment">// We might be upgrading over Memphis or later</span>
00986                     <span class="comment">// In Memphis it is "file name" "value" instead of</span>
00987                     <span class="comment">// "profilexx" "value" in Win95 &amp; OSR2</span>
00988                     <span class="comment">//</span>
00989                 
00990                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>[1] == <span class="charliteral">':'</span>)
00991                     {
00992                         <span class="comment">//</span>
00993                         <span class="comment">// Assume full path name</span>
00994                         <span class="comment">//</span>
00995                 
00996                         pProfile = <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>;
00997                 
00998                     }
00999                     <span class="keywordflow">else</span>
01000                     {
01001                         GetWindowsDirectory(<a class="code" href="../../d4/d9/icmupg_8c.html#a19">szValue</a>, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>);
01002                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/icmupg_8c.html#a19">szValue</a>[lstrlen(<a class="code" href="../../d4/d9/icmupg_8c.html#a19">szValue</a>)-1] != <span class="charliteral">'\\'</span>)
01003                             lstrcat(<a class="code" href="../../d4/d9/icmupg_8c.html#a19">szValue</a>, __TEXT(<span class="stringliteral">"\\"</span>));
01004                         lstrcat(<a class="code" href="../../d4/d9/icmupg_8c.html#a19">szValue</a>, __TEXT(<span class="stringliteral">"system\\color\\"</span>));
01005                         lstrcat(<a class="code" href="../../d4/d9/icmupg_8c.html#a19">szValue</a>, <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>);
01006                         pProfile = <a class="code" href="../../d4/d9/icmupg_8c.html#a19">szValue</a>;
01007                     }
01008                 
01009                     <span class="keywordflow">if</span> (! (*pInstallColorProfile)(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pProfile))
01010                     {
01011                         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(szMessage, <span class="stringliteral">"ICM Migration: Error installing profile %s\r\n"</span>, pProfile);
01012                         SetupLogError(szMessage, LogSevError);
01013                     }
01014                     <span class="keywordflow">else</span>
01015                     {
01016                         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(szMessage, <span class="stringliteral">"ICM Migration: Installed Profile %s\r\n"</span>, pProfile);
01017                         SetupLogError(szMessage, LogSevInformation);
01018                     }
01019                 }                
01020                 RegDeleteValue(hKey, <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>);
01021             }
01022         }
01023     }
01024 
01025     <span class="keywordflow">return</span>;
01026 }
01027 
01028 
01029 <span class="comment">/******************************************************************************</span>
01030 <span class="comment"> *</span>
01031 <span class="comment"> *                            lstrcmpn</span>
01032 <span class="comment"> *</span>
01033 <span class="comment"> *  Function:</span>
01034 <span class="comment"> *       This function compares dwLen characters of two strings and decides if</span>
01035 <span class="comment"> *       they are equal</span>
01036 <span class="comment"> *</span>
01037 <span class="comment"> *  Arguments:</span>
01038 <span class="comment"> *       pStr1           - pointer to string 1</span>
01039 <span class="comment"> *       pStr2           - pointer to string 2</span>
01040 <span class="comment"> *       dwLen           - number of characters to compare</span>
01041 <span class="comment"> *</span>
01042 <span class="comment"> *  Returns:</span>
01043 <span class="comment"> *       Zero if the strings are equal, non zero otherwise</span>
01044 <span class="comment"> *</span>
01045 <span class="comment"> ******************************************************************************/</span>
01046 
01047 <span class="keywordtype">int</span>
<a name="l01048"></a><a class="code" href="../../d4/d9/icmupg_8c.html#a32">01048</a> <a class="code" href="../../d4/d9/icmupg_8c.html#a32">lstrcmpn</a>(
01049     PTSTR pStr1,
01050     PTSTR pStr2,
01051     DWORD dwLen
01052     )
01053 {
01054     <span class="comment">//</span>
01055     <span class="comment">// Assume no NULL strings</span>
01056     <span class="comment">//</span>
01057 
01058     <span class="keywordflow">while</span> (*pStr1 &amp;&amp; *pStr2 &amp;&amp; --dwLen)
01059     {
01060         <span class="keywordflow">if</span> (*pStr1 != *pStr2)
01061             <span class="keywordflow">break</span>;
01062 
01063         pStr1++;
01064         pStr2++;
01065     }
01066 
01067     <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)(*pStr1 - *pStr2);
01068 }
01069 <span class="preprocessor">#if DBG</span>
01070 <span class="preprocessor"></span>
01071 <span class="comment">/******************************************************************************</span>
01072 <span class="comment"> *</span>
01073 <span class="comment"> *                              MyDebugPrint</span>
01074 <span class="comment"> *</span>
01075 <span class="comment"> *  Function:</span>
01076 <span class="comment"> *       This function takes a format string and paramters, composes a string</span>
01077 <span class="comment"> *       and sends it out to the debug port. Available only in debug build.</span>
01078 <span class="comment"> *</span>
01079 <span class="comment"> *  Arguments:</span>
01080 <span class="comment"> *       pFormat  - pointer to format string</span>
01081 <span class="comment"> *       .......  - parameters based on the format string like printf()</span>
01082 <span class="comment"> *</span>
01083 <span class="comment"> *  Returns:</span>
01084 <span class="comment"> *       No return value</span>
01085 <span class="comment"> *</span>
01086 <span class="comment"> ******************************************************************************/</span>
01087 
01088 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01089 MyDebugPrintA(
01090     PSTR pFormat,
01091     ...
01092     )
01093 {
01094     <span class="keywordtype">char</span>     szBuffer[256];
01095     va_list  arglist;
01096 
01097     va_start(arglist, pFormat);
01098     <a class="code" href="../../d6/d0/wsprintf_8c.html#a5">wvsprintfA</a>(szBuffer, pFormat, arglist);
01099     va_end(arglist);
01100 
01101     OutputDebugStringA(szBuffer);
01102 
01103     <span class="keywordflow">return</span>;
01104 }
01105 
01106 
01107 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01108 MyDebugPrintW(
01109     PWSTR pFormat,
01110     ...
01111     )
01112 {
01113     WCHAR    szBuffer[256];
01114     va_list  arglist;
01115 
01116     va_start(arglist, pFormat);
01117     <a class="code" href="../../d6/d0/wsprintf_8c.html#a9">wvsprintfW</a>(szBuffer, pFormat, arglist);
01118     va_end(arglist);
01119 
01120     OutputDebugStringW(szBuffer);
01121 
01122     <span class="keywordflow">return</span>;
01123 }
01124 
01125 <span class="comment">/******************************************************************************</span>
01126 <span class="comment"> *</span>
01127 <span class="comment"> *                              StripDirPrefixA</span>
01128 <span class="comment"> *</span>
01129 <span class="comment"> *  Function:</span>
01130 <span class="comment"> *       This function takes a path name and returns a pointer to the filename</span>
01131 <span class="comment"> *       part. This is availabel only for the debug build.</span>
01132 <span class="comment"> *</span>
01133 <span class="comment"> *  Arguments:</span>
01134 <span class="comment"> *       pszPathName - path name of file (can be file name alone)</span>
01135 <span class="comment"> *</span>
01136 <span class="comment"> *  Returns:</span>
01137 <span class="comment"> *       A pointer to the file name</span>
01138 <span class="comment"> *</span>
01139 <span class="comment"> ******************************************************************************/</span>
01140 
01141 PSTR
01142 StripDirPrefixA(
01143     PSTR pszPathName
01144     )
01145 {
01146     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLen = lstrlenA(pszPathName);
01147 
01148     pszPathName += dwLen - 1;       <span class="comment">// go to the end</span>
01149 
01150     <span class="keywordflow">while</span> (*pszPathName != <span class="charliteral">'\\'</span> &amp;&amp; dwLen--)
01151     {
01152         pszPathName--;
01153     }
01154 
01155     <span class="keywordflow">return</span> pszPathName + 1;
01156 }
01157 
01158 <span class="preprocessor">#endif</span>
01159 <span class="preprocessor"></span>
01160 <span class="preprocessor">#ifdef STANDALONE</span>
01161 <span class="preprocessor"></span>
01162 <span class="comment">//</span>
01163 <span class="comment">// For testing</span>
01164 <span class="comment">//</span>
01165 
01166 <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a>()
01167 {
01168     UpgradeICM(NULL, NULL, NULL, 0);
01169     
01170     TCHAR buffer[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
01171     MigrateInit(buffer, NULL, 0, NULL, NULL);
01172     MigrateInit(NULL, NULL, 0, NULL, NULL);
01173     MigrateLocalMachine(NULL, NULL);
01174     <span class="keywordflow">return</span> 0;
01175 }
01176 <span class="preprocessor">#endif</span>
01177 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:20 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
