<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: heapdbg.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>heapdbg.c</h1><a href="../../d4/d9/heapdbg_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    heapdbg.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements a debugging layer on top of heap allocator.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 20-Sep-1994</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="../../d3/d9/heap_8h.html">heap.h</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="../../d9/d9/heappriv_8h.html">heappriv.h</a>"</span>
00024 
<a name="l00025"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a0">00025</a> BOOLEAN <a class="code" href="../../d3/d9/heap_8h.html#a62">RtlpValidateHeapHdrsEnable</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; <span class="comment">// Set to TRUE if headers are being corrupted</span>
<a name="l00026"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a1">00026</a> BOOLEAN <a class="code" href="../../d3/d9/heap_8h.html#a63">RtlpValidateHeapTagsEnable</a>;         <span class="comment">// Set to TRUE if tag counts are off and you want to know why</span>
00027 
<a name="l00028"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a2">00028</a> <a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html">HEAP_STOP_ON_VALUES</a> <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>;
00029 
00030 
00031 <span class="keyword">const</span> <span class="keyword">struct </span>{
00032 
<a name="l00033"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a3">00033</a>     ULONG <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
<a name="l00034"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a4">00034</a>     LPSTR <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>;
00035 
00036 } <a class="code" href="../../d4/d9/heapdbg_8c.html#a5">RtlpHeapHeaderFieldOffsets</a>[] = {
00037 
00038     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, Entry ),                        <span class="stringliteral">"Entry"</span>,
00039     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, Signature ),                    <span class="stringliteral">"Signature"</span>,
00040     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, Flags ),                        <span class="stringliteral">"Flags"</span>,
00041     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, ForceFlags ),                   <span class="stringliteral">"ForceFlags"</span>,
00042     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, VirtualMemoryThreshold ),       <span class="stringliteral">"VirtualMemoryThreshold"</span>,
00043     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, SegmentReserve ),               <span class="stringliteral">"SegmentReserve"</span>,
00044     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, SegmentCommit ),                <span class="stringliteral">"SegmentCommit"</span>,
00045     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, DeCommitFreeBlockThreshold ),   <span class="stringliteral">"DeCommitFreeBlockThreshold"</span>,
00046     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, DeCommitTotalFreeThreshold ),   <span class="stringliteral">"DeCommitTotalFreeThreshold"</span>,
00047     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, TotalFreeSize ),                <span class="stringliteral">"TotalFreeSize"</span>,
00048     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, MaximumAllocationSize ),        <span class="stringliteral">"MaximumAllocationSize"</span>,
00049     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, ProcessHeapsListIndex ),        <span class="stringliteral">"ProcessHeapsListIndex"</span>,
00050     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, HeaderValidateLength ),         <span class="stringliteral">"HeaderValidateLength"</span>,
00051     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, HeaderValidateCopy ),           <span class="stringliteral">"HeaderValidateCopy"</span>,
00052     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, NextAvailableTagIndex ),        <span class="stringliteral">"NextAvailableTagIndex"</span>,
00053     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, MaximumTagIndex ),              <span class="stringliteral">"MaximumTagIndex"</span>,
00054     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, TagEntries ),                   <span class="stringliteral">"TagEntries"</span>,
00055     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, UCRSegments ),                  <span class="stringliteral">"UCRSegments"</span>,
00056     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, UnusedUnCommittedRanges ),      <span class="stringliteral">"UnusedUnCommittedRanges"</span>,
00057     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, AlignRound ),                   <span class="stringliteral">"AlignRound"</span>,
00058     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, AlignMask ),                    <span class="stringliteral">"AlignMask"</span>,
00059     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, VirtualAllocdBlocks ),          <span class="stringliteral">"VirtualAllocdBlocks"</span>,
00060     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, Segments ),                     <span class="stringliteral">"Segments"</span>,
00061     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, u ),                            <span class="stringliteral">"FreeListsInUse"</span>,
00062     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, FreeListsInUseTerminate ),      <span class="stringliteral">"FreeListsInUseTerminate"</span>,
00063     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, AllocatorBackTraceIndex ),      <span class="stringliteral">"AllocatorBackTraceIndex"</span>,
00064     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, <a class="code" href="../../d1/d9/arc_8h.html#a313a149">Reserved1</a> ),                    <span class="stringliteral">"Reserved1"</span>,
00065     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, PseudoTagEntries ),             <span class="stringliteral">"PseudoTagEntries"</span>,
00066     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, FreeLists ),                    <span class="stringliteral">"FreeLists"</span>,
00067     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, LockVariable ),                 <span class="stringliteral">"LockVariable"</span>,
00068     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, Lookaside ),                    <span class="stringliteral">"Lookaside"</span>,
00069     FIELD_OFFSET( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a>, LookasideLockCount ),           <span class="stringliteral">"LookasideLockCount"</span>,
00070     <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a> ),                                     <span class="stringliteral">"Uncommitted Ranges"</span>,
00071     0xFFFF, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00072 };
00073 
00074 
00075 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00076"></a><a class="code" href="../../d9/d9/heappriv_8h.html#a49">00076</a> <a class="code" href="../../d9/d9/heappriv_8h.html#a49">RtlpUpdateHeapListIndex</a> (
00077     USHORT OldIndex,
00078     USHORT NewIndex
00079     )
00080 
00081 <span class="comment">/*++</span>
00082 <span class="comment"></span>
00083 <span class="comment">Routine Description:</span>
00084 <span class="comment"></span>
00085 <span class="comment">Arguments:</span>
00086 <span class="comment"></span>
00087 <span class="comment">Return Value:</span>
00088 <span class="comment"></span>
00089 <span class="comment">--*/</span>
00090 
00091 {
00092     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o1">AllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a> == OldIndex) {
00093 
00094         <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o1">AllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a> = NewIndex;
00095     }
00096 
00097     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o3">ReAllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a> == OldIndex) {
00098 
00099         <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o3">ReAllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a> = NewIndex;
00100     }
00101 
00102     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o5">FreeTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a> == OldIndex) {
00103 
00104         <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o5">FreeTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a> = NewIndex;
00105     }
00106 
00107     <span class="keywordflow">return</span>;
00108 }
00109 
00110 
00111 BOOLEAN
<a name="l00112"></a><a class="code" href="../../d9/d9/heappriv_8h.html#a50">00112</a> <a class="code" href="../../d9/d9/heappriv_8h.html#a50">RtlpValidateHeapHeaders</a> (
00113     IN <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap,
00114     IN BOOLEAN Recompute
00115     )
00116 
00117 <span class="comment">/*++</span>
00118 <span class="comment"></span>
00119 <span class="comment">Routine Description:</span>
00120 <span class="comment"></span>
00121 <span class="comment">Arguments:</span>
00122 <span class="comment"></span>
00123 <span class="comment">Return Value:</span>
00124 <span class="comment"></span>
00125 <span class="comment">--*/</span>
00126 
00127 {
00128     ULONG i;
00129     SIZE_T <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00130     SIZE_T nEqual;
00131     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00132 
00133     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9/heap_8h.html#a62">RtlpValidateHeapHdrsEnable</a>) {
00134 
00135         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00136     }
00137 
00138     <span class="keywordflow">if</span> (Heap-&gt;HeaderValidateCopy == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00139 
00140         <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = Heap-&gt;HeaderValidateLength;
00141 
00142         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d6/allocvm_8c.html#a7">NtAllocateVirtualMemory</a>( NtCurrentProcess(),
00143                                           &amp;Heap-&gt;HeaderValidateCopy,
00144                                           0,
00145                                           &amp;<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>,
00146                                           MEM_COMMIT,
00147                                           PAGE_READWRITE );
00148 
00149         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00150 
00151             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00152         }
00153 
00154         Recompute = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00155     }
00156 
00157     <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = Heap-&gt;HeaderValidateLength;
00158 
00159     <span class="keywordflow">if</span> (!Recompute) {
00160 
00161         nEqual = RtlCompareMemory( Heap,
00162                                    Heap-&gt;HeaderValidateCopy,
00163                                    <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> );
00164 
00165     } <span class="keywordflow">else</span> {
00166 
00167         RtlMoveMemory( Heap-&gt;HeaderValidateCopy,
00168                        Heap,
00169                        <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> );
00170 
00171         nEqual = <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00172     }
00173 
00174     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> != nEqual) {
00175 
00176         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Heap %x - headers modified (%x is %x instead of %x)\n"</span>,
00177                          Heap,
00178                          (PCHAR)Heap + nEqual,
00179                          *(PULONG)((PCHAR)Heap + nEqual),
00180                          *(PULONG)((PCHAR)Heap-&gt;HeaderValidateCopy + nEqual)));
00181 
00182         <span class="keywordflow">for</span> (i=0; <a class="code" href="../../d4/d9/heapdbg_8c.html#a5">RtlpHeapHeaderFieldOffsets</a>[ i ].Description != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; i++) {
00183 
00184             <span class="keywordflow">if</span> ((nEqual &gt;= <a class="code" href="../../d4/d9/heapdbg_8c.html#a5">RtlpHeapHeaderFieldOffsets</a>[ i ].Offset) &amp;&amp;
00185                 (nEqual &lt; <a class="code" href="../../d4/d9/heapdbg_8c.html#a5">RtlpHeapHeaderFieldOffsets</a>[ i+1 ].Offset)) {
00186 
00187                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"    This is located in the %s field of the heap header.\n"</span>,
00188                                  <a class="code" href="../../d4/d9/heapdbg_8c.html#a5">RtlpHeapHeaderFieldOffsets</a>[ i ].<a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a> );
00189 
00190                 <span class="keywordflow">break</span>;
00191             }
00192         }
00193 
00194         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00195 
00196     } <span class="keywordflow">else</span> {
00197 
00198         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00199     }
00200 }
00201 
00202 
00203 PVOID
<a name="l00204"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a10">00204</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a10">RtlDebugCreateHeap</a> (
00205     IN ULONG Flags,
00206     IN PVOID HeapBase OPTIONAL,
00207     IN SIZE_T ReserveSize OPTIONAL,
00208     IN SIZE_T CommitSize OPTIONAL,
00209     IN PVOID Lock OPTIONAL,
00210     IN PRTL_HEAP_PARAMETERS Parameters
00211     )
00212 
00213 <span class="comment">/*++</span>
00214 <span class="comment"></span>
00215 <span class="comment">Routine Description:</span>
00216 <span class="comment"></span>
00217 <span class="comment">Arguments:</span>
00218 <span class="comment"></span>
00219 <span class="comment">Return Value:</span>
00220 <span class="comment"></span>
00221 <span class="comment">--*/</span>
00222 
00223 {
00224     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap;
00225     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00226     MEMORY_BASIC_INFORMATION MemoryInformation;
00227 
00228     <span class="keywordflow">if</span> (ReserveSize &lt;= <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">HEAP_ENTRY</a> )) {
00229 
00230         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Invalid ReserveSize parameter - %lx\n"</span>, ReserveSize ));
00231         <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00232 
00233         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00234     }
00235 
00236     <span class="keywordflow">if</span> (ReserveSize &lt; CommitSize) {
00237 
00238         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Invalid CommitSize parameter - %lx\n"</span>, CommitSize ));
00239         <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00240 
00241         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00242     }
00243 
00244     <span class="keywordflow">if</span> ((Flags &amp; HEAP_NO_SERIALIZE) &amp;&amp; ARGUMENT_PRESENT( <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> )) {
00245 
00246         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"May not specify Lock parameter with HEAP_NO_SERIALIZE\n"</span> ));
00247         <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00248 
00249         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00250     }
00251 
00252     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( HeapBase )) {
00253 
00254         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/queryvm_8c.html#a4">NtQueryVirtualMemory</a>( NtCurrentProcess(),
00255                                        HeapBase,
00256                                        MemoryBasicInformation,
00257                                        &amp;MemoryInformation,
00258                                        <span class="keyword">sizeof</span>( MemoryInformation ),
00259                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00260 
00261         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00262 
00263             <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Specified HeapBase (%lx) invalid,  Status = %lx\n"</span>,
00264                              HeapBase,
00265                              <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
00266 
00267             <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00268 
00269             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00270         }
00271 
00272         <span class="keywordflow">if</span> (MemoryInformation.BaseAddress != HeapBase) {
00273 
00274             <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Specified HeapBase (%lx) != to BaseAddress (%lx)\n"</span>,
00275                              HeapBase,
00276                              MemoryInformation.BaseAddress ));
00277 
00278             <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00279 
00280             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00281         }
00282 
00283         <span class="keywordflow">if</span> (MemoryInformation.State == MEM_FREE) {
00284 
00285             <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Specified HeapBase (%lx) is free or not writable\n"</span>,
00286                              MemoryInformation.BaseAddress ));
00287 
00288             <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00289 
00290             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00291         }
00292     }
00293 
00294     Heap = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a15">RtlCreateHeap</a>( Flags |
00295                             <a class="code" href="../../d3/d9/heap_8h.html#a23">HEAP_SKIP_VALIDATION_CHECKS</a> |
00296                             HEAP_TAIL_CHECKING_ENABLED  |
00297                             HEAP_FREE_CHECKING_ENABLED,
00298                           HeapBase,
00299                           ReserveSize,
00300                           CommitSize,
00301                           <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>,
00302                           Parameters );
00303 
00304     <span class="keywordflow">if</span> (Heap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00305 
00306 <span class="preprocessor">#if i386</span>
00307 <span class="preprocessor"></span>
00308         <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a24">HEAP_CAPTURE_STACK_BACKTRACES</a>) {
00309 
00310             Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o27">AllocatorBackTraceIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)RtlLogStackBackTrace();
00311         }
00312 
00313 <span class="preprocessor">#endif // i386</span>
00314 <span class="preprocessor"></span>
00315         <a class="code" href="../../d9/d9/heappriv_8h.html#a50">RtlpValidateHeapHeaders</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00316     }
00317 
00318     <span class="keywordflow">return</span> Heap;
00319 }
00320 
00321 
00322 BOOLEAN
<a name="l00323"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a11">00323</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a11">RtlpSerializeHeap</a> (
00324     IN PVOID HeapHandle
00325     )
00326 
00327 <span class="comment">/*++</span>
00328 <span class="comment"></span>
00329 <span class="comment">Routine Description:</span>
00330 <span class="comment"></span>
00331 <span class="comment">Arguments:</span>
00332 <span class="comment"></span>
00333 <span class="comment">Return Value:</span>
00334 <span class="comment"></span>
00335 <span class="comment">--*/</span>
00336 
00337 {
00338     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00339     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
00340     <a class="code" href="../../d4/d6/struct__HEAP__LOCK.html">PHEAP_LOCK</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
00341 
00342     <a class="code" href="../../d7/d9/heappage_8h.html#a6">IF_DEBUG_PAGE_HEAP_THEN_RETURN</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>,
00343                                     <a class="code" href="../../d7/d9/heappage_8h.html#a24">RtlpDebugPageHeapSerialize</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> ));
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">//  Validate that HeapAddress points to a HEAP structure.</span>
00347     <span class="comment">//</span>
00348 
00349     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlpSerializeHeap"</span> )) {
00350 
00351         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00352     }
00353 
00354     <span class="comment">//</span>
00355     <span class="comment">//  Lock the heap.</span>
00356     <span class="comment">//</span>
00357 
00358     <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> &amp; HEAP_NO_SERIALIZE) {
00359 
00360         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, HEAP_NO_SERIALIZE, <span class="keyword">sizeof</span>( *<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> ) );
00361 
00362         <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00363 
00364             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00365         }
00366     
00367         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/heappriv_8h.html#a2">RtlInitializeLockRoutine</a>( <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> );
00368 
00369         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00370 
00371             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, HEAP_NO_SERIALIZE, <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> );
00372 
00373             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00374         }
00375 
00376         Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
00377         Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> &amp;= ~HEAP_NO_SERIALIZE;
00378         Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o3">ForceFlags</a> &amp;= ~HEAP_NO_SERIALIZE;
00379 
00380         <a class="code" href="../../d9/d9/heappriv_8h.html#a50">RtlpValidateHeapHeaders</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00381     }
00382 
00383     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00384 }
00385 
00386 
00387 BOOLEAN
<a name="l00388"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a12">00388</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a12">RtlDebugDestroyHeap</a> (
00389     IN PVOID HeapHandle
00390     )
00391 
00392 <span class="comment">/*++</span>
00393 <span class="comment"></span>
00394 <span class="comment">Routine Description:</span>
00395 <span class="comment"></span>
00396 <span class="comment">Arguments:</span>
00397 <span class="comment"></span>
00398 <span class="comment">Return Value:</span>
00399 <span class="comment"></span>
00400 <span class="comment">--*/</span>
00401 
00402 {
00403     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
00404     LIST_ENTRY ListEntry;
00405     SIZE_T <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00406 
00407     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> == NtCurrentPeb()-&gt;ProcessHeap) {
00408 
00409         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"May not destroy the process heap at %x\n"</span>, <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> ));
00410 
00411         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00412     }
00413 
00414     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlDestroyHeap"</span> )) {
00415 
00416         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00417     }
00418 
00419     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> )) {
00420 
00421         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00422     }
00423 
00424     <span class="comment">//</span>
00425     <span class="comment">//  Now mark the heap as invalid by zeroing the signature field.</span>
00426     <span class="comment">//</span>
00427 
00428     Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o1">Signature</a> = 0;
00429 
00430     <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o13">HeaderValidateCopy</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00431 
00432         <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = 0;
00433         <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>( NtCurrentProcess(),
00434                              &amp;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o13">HeaderValidateCopy</a>,
00435                              &amp;<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>,
00436                              MEM_RELEASE );
00437     }
00438 
00439     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00440 }
00441 
00442 
00443 PVOID
<a name="l00444"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a13">00444</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a13">RtlDebugAllocateHeap</a> (
00445     IN PVOID HeapHandle,
00446     IN ULONG Flags,
00447     IN SIZE_T Size
00448     )
00449 
00450 <span class="comment">/*++</span>
00451 <span class="comment"></span>
00452 <span class="comment">Routine Description:</span>
00453 <span class="comment"></span>
00454 <span class="comment">Arguments:</span>
00455 <span class="comment"></span>
00456 <span class="comment">Return Value:</span>
00457 <span class="comment"></span>
00458 <span class="comment">--*/</span>
00459 
00460 {
00461     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
00462     BOOLEAN LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00463     PVOID ReturnValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00464     SIZE_T AllocationSize;
00465     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TagIndex;
00466     <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> BusyBlock;
00467     <a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">PHEAP_ENTRY_EXTRA</a> ExtraStuff;
00468 
00469     <a class="code" href="../../d7/d9/heappage_8h.html#a6">IF_DEBUG_PAGE_HEAP_THEN_RETURN</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>,
00470                                     <a class="code" href="../../d7/d9/heappage_8h.html#a10">RtlpDebugPageHeapAllocate</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> ));
00471 
00472     <span class="keywordflow">try</span> {
00473 
00474         <span class="keywordflow">try</span> {
00475 
00476             <span class="comment">//</span>
00477             <span class="comment">//  Validate that HeapAddress points to a HEAP structure.</span>
00478             <span class="comment">//</span>
00479 
00480             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlAllocateHeap"</span> )) {
00481 
00482                 ReturnValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00483                 leave;
00484             }
00485 
00486             Flags |= Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o3">ForceFlags</a> | HEAP_SETTABLE_USER_VALUE | <a class="code" href="../../d3/d9/heap_8h.html#a23">HEAP_SKIP_VALIDATION_CHECKS</a>;
00487 
00488             <span class="comment">//</span>
00489             <span class="comment">//  Verify that the size did not wrap or exceed the limit for this heap.</span>
00490             <span class="comment">//</span>
00491 
00492             AllocationSize = (((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> ? <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> : 1) + Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o19">AlignRound</a>) &amp; Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o20">AlignMask</a>) +
00493                              <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">HEAP_ENTRY_EXTRA</a> );
00494 
00495             <span class="keywordflow">if</span> ((AllocationSize &lt; Size) || (AllocationSize &gt; Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o10">MaximumAllocationSize</a>)) {
00496 
00497                 <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Invalid allocation size - %lx (exceeded %x)\n"</span>,
00498                                  <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00499                                  Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o10">MaximumAllocationSize</a> ));
00500 
00501                 ReturnValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00502                 leave;
00503             }
00504 
00505             <span class="comment">//</span>
00506             <span class="comment">//  Lock the heap</span>
00507             <span class="comment">//</span>
00508 
00509             <span class="keywordflow">if</span> (!(Flags &amp; HEAP_NO_SERIALIZE)) {
00510 
00511                 <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
00512 
00513                 LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00514 
00515                 Flags |= HEAP_NO_SERIALIZE;
00516             }
00517 
00518             <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00519 
00520             ReturnValue = <a class="code" href="../../d9/d9/heappriv_8h.html#a38">RtlAllocateHeapSlowly</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
00521 
00522             <a class="code" href="../../d9/d9/heappriv_8h.html#a50">RtlpValidateHeapHeaders</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00523 
00524             <span class="keywordflow">if</span> (ReturnValue != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00525 
00526                 BusyBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)ReturnValue - 1;
00527 
00528                 <span class="keywordflow">if</span> (BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a9">HEAP_ENTRY_EXTRA_PRESENT</a>) {
00529 
00530                     ExtraStuff = <a class="code" href="../../d9/d9/heappriv_8h.html#a41">RtlpGetExtraStuffPointer</a>( BusyBlock );
00531 
00532 <span class="preprocessor">    #if i386</span>
00533 <span class="preprocessor"></span>
00534                     <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a24">HEAP_CAPTURE_STACK_BACKTRACES</a>) {
00535 
00536                         ExtraStuff-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o0">AllocatorBackTraceIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)RtlLogStackBackTrace();
00537 
00538                     } <span class="keywordflow">else</span> {
00539 
00540                         ExtraStuff-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o0">AllocatorBackTraceIndex</a> = 0;
00541                     }
00542 
00543 <span class="preprocessor">    #endif // i386</span>
00544 <span class="preprocessor"></span>
00545                     TagIndex = ExtraStuff-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o1">TagIndex</a>;
00546 
00547                 } <span class="keywordflow">else</span> {
00548 
00549                     TagIndex = BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o5">SmallTagIndex</a>;
00550                 }
00551 
00552                 <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a22">HEAP_VALIDATE_ALL_ENABLED</a>) {
00553 
00554                     <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00555                 }
00556             }
00557 
00558             <span class="keywordflow">if</span> (ReturnValue != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00559 
00560                 <span class="keywordflow">if</span> ((ULONG_PTR)ReturnValue == <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o0">AllocAddress</a>) {
00561 
00562                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Just allocated block at %lx for 0x%x bytes\n"</span>,
00563                                      <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o0">AllocAddress</a>,
00564                                      <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> ));
00565 
00566                     <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00567 
00568                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d9/heappriv_8h.html#a22">IS_HEAP_TAGGING_ENABLED</a>()) &amp;&amp;
00569                            (TagIndex != 0) &amp;&amp;
00570                            (TagIndex == <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o1">AllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o1">TagIndex</a>) &amp;&amp;
00571                            (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o11">ProcessHeapsListIndex</a> == <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o1">AllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a>)) {
00572 
00573                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Just allocated block at %lx for 0x%x bytes with tag %ws\n"</span>,
00574                                      ReturnValue,
00575                                      <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00576                                      <a class="code" href="../../d9/d9/heappriv_8h.html#a51">RtlpGetTagName</a>( Heap, TagIndex )));
00577 
00578                     <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00579                 }
00580             }
00581 
00582         } except( GetExceptionCode() == STATUS_NO_MEMORY ? <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a> :
00583                                                            <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00584 
00585             <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( GetExceptionCode() );
00586 
00587             ReturnValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00588         }
00589 
00590     } finally {
00591 
00592         <span class="keywordflow">if</span> (LockAcquired) {
00593 
00594             <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
00595         }
00596     }
00597 
00598     <span class="keywordflow">return</span> ReturnValue;
00599 }
00600 
00601 
00602 PVOID
<a name="l00603"></a><a class="code" href="../../d5/d9/heapdll_8c.html#a8">00603</a> <a class="code" href="../../d5/d9/heapdll_8c.html#a8">RtlDebugReAllocateHeap</a> (
00604     IN PVOID HeapHandle,
00605     IN ULONG Flags,
00606     IN PVOID BaseAddress,
00607     IN SIZE_T Size
00608     )
00609 
00610 <span class="comment">/*++</span>
00611 <span class="comment"></span>
00612 <span class="comment">Routine Description:</span>
00613 <span class="comment"></span>
00614 <span class="comment">Arguments:</span>
00615 <span class="comment"></span>
00616 <span class="comment">Return Value:</span>
00617 <span class="comment"></span>
00618 <span class="comment">--*/</span>
00619 
00620 {
00621     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
00622     SIZE_T AllocationSize;
00623     <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> BusyBlock;
00624     <a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">PHEAP_ENTRY_EXTRA</a> ExtraStuff;
00625     BOOLEAN LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00626     PVOID ReturnValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00627     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TagIndex;
00628 
00629     <a class="code" href="../../d7/d9/heappage_8h.html#a6">IF_DEBUG_PAGE_HEAP_THEN_RETURN</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>,
00630                                     <a class="code" href="../../d7/d9/heappage_8h.html#a12">RtlpDebugPageHeapReAllocate</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, BaseAddress, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> ));
00631 
00632     <span class="keywordflow">try</span> {
00633 
00634         <span class="keywordflow">try</span> {
00635 
00636             <span class="comment">//</span>
00637             <span class="comment">//  Validate that HeapAddress points to a HEAP structure.</span>
00638             <span class="comment">//</span>
00639 
00640             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlReAllocateHeap"</span> )) {
00641 
00642                 ReturnValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00643                 leave;
00644             }
00645 
00646             Flags |= Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o3">ForceFlags</a> | HEAP_SETTABLE_USER_VALUE | <a class="code" href="../../d3/d9/heap_8h.html#a23">HEAP_SKIP_VALIDATION_CHECKS</a>;
00647 
00648             <span class="comment">//</span>
00649             <span class="comment">//  Verify that the size did not wrap or exceed the limit for this heap.</span>
00650             <span class="comment">//</span>
00651 
00652             AllocationSize = (((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> ? <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> : 1) + Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o19">AlignRound</a>) &amp; Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o20">AlignMask</a>) +
00653                              <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">HEAP_ENTRY_EXTRA</a> );
00654 
00655             <span class="keywordflow">if</span> (AllocationSize &lt; Size || AllocationSize &gt; Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o10">MaximumAllocationSize</a>) {
00656 
00657                 <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Invalid allocation size - %lx (exceeded %x)\n"</span>,
00658                                  <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00659                                  Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o10">MaximumAllocationSize</a> ));
00660 
00661                 <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00662 
00663                 ReturnValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00664                 leave;
00665             }
00666 
00667             <span class="comment">//</span>
00668             <span class="comment">//  Lock the heap</span>
00669             <span class="comment">//</span>
00670 
00671             <span class="keywordflow">if</span> (!(Flags &amp; HEAP_NO_SERIALIZE)) {
00672 
00673                 <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
00674 
00675                 LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00676 
00677                 Flags |= HEAP_NO_SERIALIZE;
00678             }
00679 
00680             <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00681             BusyBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)BaseAddress - 1;
00682 
00683             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a47">RtlpValidateHeapEntry</a>( Heap, BusyBlock, <span class="stringliteral">"RtlReAllocateHeap"</span> )) {
00684 
00685                 <span class="keywordflow">if</span> ((ULONG_PTR)BaseAddress == <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o2">ReAllocAddress</a>) {
00686 
00687                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"About to reallocate block at %lx to 0x%x bytes\n"</span>,
00688                                      <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o2">ReAllocAddress</a>,
00689                                      <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> ));
00690 
00691                     <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00692 
00693                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a22">IS_HEAP_TAGGING_ENABLED</a>() &amp;&amp; <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o3">ReAllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o0">HeapAndTagIndex</a> != 0) {
00694 
00695                     <span class="keywordflow">if</span> (BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a9">HEAP_ENTRY_EXTRA_PRESENT</a>) {
00696 
00697                         ExtraStuff = <a class="code" href="../../d9/d9/heappriv_8h.html#a41">RtlpGetExtraStuffPointer</a>( BusyBlock );
00698                         TagIndex = ExtraStuff-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o1">TagIndex</a>;
00699 
00700                     } <span class="keywordflow">else</span> {
00701 
00702                         TagIndex = BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o5">SmallTagIndex</a>;
00703                     }
00704 
00705                     <span class="keywordflow">if</span> ((TagIndex != 0) &amp;&amp;
00706                         (TagIndex == <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o3">ReAllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o1">TagIndex</a>) &amp;&amp;
00707                         (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o11">ProcessHeapsListIndex</a> == <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o3">ReAllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a>)) {
00708 
00709                         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"About to rellocate block at %lx to 0x%x bytes with tag %ws\n"</span>,
00710                                          BaseAddress,
00711                                          <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00712                                          <a class="code" href="../../d9/d9/heappriv_8h.html#a51">RtlpGetTagName</a>( Heap, TagIndex )));
00713 
00714                         <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00715                     }
00716                 }
00717 
00718                 ReturnValue = <a class="code" href="../../d5/d9/heapdll_8c.html#a24">RtlReAllocateHeap</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, BaseAddress, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
00719 
00720                 <span class="keywordflow">if</span> (ReturnValue != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00721 
00722                     BusyBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)ReturnValue - 1;
00723 
00724                     <span class="keywordflow">if</span> (BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a9">HEAP_ENTRY_EXTRA_PRESENT</a>) {
00725 
00726                         ExtraStuff = <a class="code" href="../../d9/d9/heappriv_8h.html#a41">RtlpGetExtraStuffPointer</a>( BusyBlock );
00727 
00728 <span class="preprocessor">    #if i386</span>
00729 <span class="preprocessor"></span>
00730                         <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a24">HEAP_CAPTURE_STACK_BACKTRACES</a>) {
00731 
00732                             ExtraStuff-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o0">AllocatorBackTraceIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)RtlLogStackBackTrace();
00733 
00734                         } <span class="keywordflow">else</span> {
00735 
00736                             ExtraStuff-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o0">AllocatorBackTraceIndex</a> = 0;
00737                         }
00738 
00739 <span class="preprocessor">    #endif // i386</span>
00740 <span class="preprocessor"></span>
00741                         TagIndex = ExtraStuff-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o1">TagIndex</a>;
00742 
00743                     } <span class="keywordflow">else</span> {
00744 
00745                         TagIndex = BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o5">SmallTagIndex</a>;
00746                     }
00747                 }
00748 
00749                 <a class="code" href="../../d9/d9/heappriv_8h.html#a50">RtlpValidateHeapHeaders</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00750                 <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00751             }
00752 
00753             <span class="keywordflow">if</span> (ReturnValue != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00754 
00755                 <span class="keywordflow">if</span> ((ULONG_PTR)ReturnValue == <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o2">ReAllocAddress</a>) {
00756 
00757                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Just reallocated block at %lx to 0x%x bytes\n"</span>,
00758                                      <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o2">ReAllocAddress</a>,
00759                                      <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> ));
00760 
00761                     <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00762 
00763                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d9/heappriv_8h.html#a22">IS_HEAP_TAGGING_ENABLED</a>()) &amp;&amp;
00764                            (TagIndex == <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o3">ReAllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o1">TagIndex</a>) &amp;&amp;
00765                            (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o11">ProcessHeapsListIndex</a> == <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o3">ReAllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a>)) {
00766 
00767                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Just reallocated block at %lx to 0x%x bytes with tag %ws\n"</span>,
00768                                      ReturnValue,
00769                                      <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00770                                      <a class="code" href="../../d9/d9/heappriv_8h.html#a51">RtlpGetTagName</a>( Heap, TagIndex )));
00771 
00772                     <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00773                 }
00774             }
00775 
00776         } except( GetExceptionCode() == STATUS_NO_MEMORY ? <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a> :
00777                                                            <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00778 
00779             <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( GetExceptionCode() );
00780 
00781             ReturnValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00782         }
00783 
00784     } finally {
00785 
00786         <span class="keywordflow">if</span> (LockAcquired) {
00787 
00788             <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
00789         }
00790     }
00791 
00792     <span class="keywordflow">return</span> ReturnValue;
00793 }
00794 
00795 
00796 BOOLEAN
<a name="l00797"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a15">00797</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a15">RtlDebugFreeHeap</a> (
00798     IN PVOID HeapHandle,
00799     IN ULONG Flags,
00800     IN PVOID BaseAddress
00801     )
00802 
00803 <span class="comment">/*++</span>
00804 <span class="comment"></span>
00805 <span class="comment">Routine Description:</span>
00806 <span class="comment"></span>
00807 <span class="comment">Arguments:</span>
00808 <span class="comment"></span>
00809 <span class="comment">Return Value:</span>
00810 <span class="comment"></span>
00811 <span class="comment">--*/</span>
00812 
00813 {
00814     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
00815     <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> BusyBlock;
00816     <a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">PHEAP_ENTRY_EXTRA</a> ExtraStuff;
00817     SIZE_T <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00818     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00819     BOOLEAN LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00820     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TagIndex;
00821 
00822     <a class="code" href="../../d7/d9/heappage_8h.html#a6">IF_DEBUG_PAGE_HEAP_THEN_RETURN</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>,
00823                                     <a class="code" href="../../d7/d9/heappage_8h.html#a11">RtlpDebugPageHeapFree</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, BaseAddress ));
00824 
00825     <span class="keywordflow">try</span> {
00826 
00827         <span class="keywordflow">try</span> {
00828 
00829             <span class="comment">//</span>
00830             <span class="comment">//  Validate that HeapAddress points to a HEAP structure.</span>
00831             <span class="comment">//</span>
00832 
00833             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlFreeHeap"</span> )) {
00834 
00835                 Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00836                 leave;
00837             }
00838 
00839             Flags |= Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o3">ForceFlags</a> | <a class="code" href="../../d3/d9/heap_8h.html#a23">HEAP_SKIP_VALIDATION_CHECKS</a>;
00840 
00841             <span class="comment">//</span>
00842             <span class="comment">//  Lock the heap</span>
00843             <span class="comment">//</span>
00844 
00845             <span class="keywordflow">if</span> (!(Flags &amp; HEAP_NO_SERIALIZE)) {
00846 
00847                 <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
00848 
00849                 LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00850 
00851                 Flags |= HEAP_NO_SERIALIZE;
00852             }
00853 
00854             <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00855 
00856             BusyBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)BaseAddress - 1;
00857             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a> &lt;&lt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>;
00858 
00859             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a47">RtlpValidateHeapEntry</a>( Heap, BusyBlock, <span class="stringliteral">"RtlFreeHeap"</span> )) {
00860 
00861                 <span class="keywordflow">if</span> ((ULONG_PTR)BaseAddress == <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o4">FreeAddress</a>) {
00862 
00863                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"About to free block at %lx\n"</span>,
00864                                      <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o4">FreeAddress</a> ));
00865 
00866                     <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00867 
00868                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d9/heappriv_8h.html#a22">IS_HEAP_TAGGING_ENABLED</a>()) &amp;&amp; (<a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o5">FreeTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o0">HeapAndTagIndex</a> != 0)) {
00869 
00870                     <span class="keywordflow">if</span> (BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a9">HEAP_ENTRY_EXTRA_PRESENT</a>) {
00871 
00872                         ExtraStuff = <a class="code" href="../../d9/d9/heappriv_8h.html#a41">RtlpGetExtraStuffPointer</a>( BusyBlock );
00873 
00874                         TagIndex = ExtraStuff-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o1">TagIndex</a>;
00875 
00876                     } <span class="keywordflow">else</span> {
00877 
00878                         TagIndex = BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o5">SmallTagIndex</a>;
00879                     }
00880 
00881                     <span class="keywordflow">if</span> ((TagIndex != 0) &amp;&amp;
00882                         (TagIndex == <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o5">FreeTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o1">TagIndex</a>) &amp;&amp;
00883                         (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o11">ProcessHeapsListIndex</a> == <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o5">FreeTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a>)) {
00884 
00885                         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"About to free block at %lx with tag %ws\n"</span>,
00886                                          BaseAddress,
00887                                          <a class="code" href="../../d9/d9/heappriv_8h.html#a51">RtlpGetTagName</a>( Heap, TagIndex )));
00888 
00889                         <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00890                     }
00891                 }
00892 
00893                 Result = <a class="code" href="../../d9/d9/heappriv_8h.html#a39">RtlFreeHeapSlowly</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, BaseAddress );
00894 
00895                 <a class="code" href="../../d9/d9/heappriv_8h.html#a50">RtlpValidateHeapHeaders</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00896                 <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00897             }
00898 
00899         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00900 
00901             <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( GetExceptionCode() );
00902 
00903             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00904         }
00905 
00906     } finally {
00907 
00908         <span class="keywordflow">if</span> (LockAcquired) {
00909 
00910             <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
00911         }
00912     }
00913 
00914     <span class="keywordflow">return</span> Result;
00915 }
00916 
00917 
00918 BOOLEAN
<a name="l00919"></a><a class="code" href="../../d5/d9/heapdll_8c.html#a9">00919</a> <a class="code" href="../../d5/d9/heapdll_8c.html#a9">RtlDebugGetUserInfoHeap</a> (
00920     IN PVOID HeapHandle,
00921     IN ULONG Flags,
00922     IN PVOID BaseAddress,
00923     OUT PVOID *UserValue OPTIONAL,
00924     OUT PULONG UserFlags OPTIONAL
00925     )
00926 
00927 <span class="comment">/*++</span>
00928 <span class="comment"></span>
00929 <span class="comment">Routine Description:</span>
00930 <span class="comment"></span>
00931 <span class="comment">Arguments:</span>
00932 <span class="comment"></span>
00933 <span class="comment">Return Value:</span>
00934 <span class="comment"></span>
00935 <span class="comment">--*/</span>
00936 
00937 {
00938     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
00939     <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> BusyBlock;
00940     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00941     BOOLEAN LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00942 
00943     <a class="code" href="../../d7/d9/heappage_8h.html#a6">IF_DEBUG_PAGE_HEAP_THEN_RETURN</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>,
00944                                     <a class="code" href="../../d7/d9/heappage_8h.html#a22">RtlpDebugPageHeapGetUserInfo</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, BaseAddress, UserValue, UserFlags ));
00945 
00946     <span class="keywordflow">try</span> {
00947 
00948         <span class="keywordflow">try</span> {
00949 
00950             <span class="comment">//</span>
00951             <span class="comment">//  Validate that HeapAddress points to a HEAP structure.</span>
00952             <span class="comment">//</span>
00953 
00954             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlGetUserInfoHeap"</span> )) {
00955 
00956                 Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00957                 leave;
00958             }
00959 
00960             Flags |= Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o3">ForceFlags</a> | <a class="code" href="../../d3/d9/heap_8h.html#a23">HEAP_SKIP_VALIDATION_CHECKS</a>;
00961 
00962             <span class="comment">//</span>
00963             <span class="comment">//  Lock the heap</span>
00964             <span class="comment">//</span>
00965 
00966             <span class="keywordflow">if</span> (!(Flags &amp; HEAP_NO_SERIALIZE)) {
00967 
00968                 <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
00969 
00970                 LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00971 
00972                 Flags |= HEAP_NO_SERIALIZE;
00973             }
00974 
00975             <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00976 
00977             BusyBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)BaseAddress - 1;
00978 
00979             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a47">RtlpValidateHeapEntry</a>( Heap, BusyBlock, <span class="stringliteral">"RtlGetUserInfoHeap"</span> )) {
00980 
00981                 Result = <a class="code" href="../../d5/d9/heapdll_8c.html#a25">RtlGetUserInfoHeap</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, BaseAddress, UserValue, UserFlags );
00982             }
00983 
00984         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00985 
00986             <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( GetExceptionCode() );
00987         }
00988 
00989     } finally {
00990 
00991         <span class="keywordflow">if</span> (LockAcquired) {
00992 
00993             <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
00994         }
00995     }
00996 
00997     <span class="keywordflow">return</span> Result;
00998 }
00999 
01000 
01001 BOOLEAN
<a name="l01002"></a><a class="code" href="../../d5/d9/heapdll_8c.html#a10">01002</a> <a class="code" href="../../d5/d9/heapdll_8c.html#a10">RtlDebugSetUserValueHeap</a> (
01003     IN PVOID HeapHandle,
01004     IN ULONG Flags,
01005     IN PVOID BaseAddress,
01006     IN PVOID UserValue
01007     )
01008 
01009 <span class="comment">/*++</span>
01010 <span class="comment"></span>
01011 <span class="comment">Routine Description:</span>
01012 <span class="comment"></span>
01013 <span class="comment">Arguments:</span>
01014 <span class="comment"></span>
01015 <span class="comment">Return Value:</span>
01016 <span class="comment"></span>
01017 <span class="comment">--*/</span>
01018 
01019 {
01020     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
01021     <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> BusyBlock;
01022     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01023     BOOLEAN LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01024 
01025     <a class="code" href="../../d7/d9/heappage_8h.html#a6">IF_DEBUG_PAGE_HEAP_THEN_RETURN</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>,
01026                                     <a class="code" href="../../d7/d9/heappage_8h.html#a21">RtlpDebugPageHeapSetUserValue</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, BaseAddress, UserValue ));
01027 
01028     <span class="keywordflow">try</span> {
01029 
01030         <span class="keywordflow">try</span> {
01031 
01032             <span class="comment">//</span>
01033             <span class="comment">//  Validate that HeapAddress points to a HEAP structure.</span>
01034             <span class="comment">//</span>
01035 
01036             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlSetUserValueHeap"</span> )) {
01037 
01038                 Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01039                 leave;
01040             }
01041 
01042             Flags |= Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o3">ForceFlags</a> | <a class="code" href="../../d3/d9/heap_8h.html#a23">HEAP_SKIP_VALIDATION_CHECKS</a>;
01043 
01044             <span class="comment">//</span>
01045             <span class="comment">//  Lock the heap</span>
01046             <span class="comment">//</span>
01047 
01048             <span class="keywordflow">if</span> (!(Flags &amp; HEAP_NO_SERIALIZE)) {
01049 
01050                 <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01051 
01052                 LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01053 
01054                 Flags |= HEAP_NO_SERIALIZE;
01055             }
01056 
01057             <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01058 
01059             BusyBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)BaseAddress - 1;
01060 
01061             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a47">RtlpValidateHeapEntry</a>( Heap, BusyBlock, <span class="stringliteral">"RtlSetUserValueHeap"</span> )) {
01062 
01063                 Result = <a class="code" href="../../d5/d9/heapdll_8c.html#a26">RtlSetUserValueHeap</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, BaseAddress, UserValue );
01064 
01065                 <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01066             }
01067 
01068         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
01069 
01070             <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( GetExceptionCode() );
01071         }
01072 
01073     } finally {
01074 
01075         <span class="keywordflow">if</span> (LockAcquired) {
01076 
01077             <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01078         }
01079     }
01080 
01081     <span class="keywordflow">return</span> Result;
01082 }
01083 
01084 
01085 BOOLEAN
<a name="l01086"></a><a class="code" href="../../d5/d9/heapdll_8c.html#a11">01086</a> <a class="code" href="../../d5/d9/heapdll_8c.html#a11">RtlDebugSetUserFlagsHeap</a> (
01087     IN PVOID HeapHandle,
01088     IN ULONG Flags,
01089     IN PVOID BaseAddress,
01090     IN ULONG UserFlagsReset,
01091     IN ULONG UserFlagsSet
01092     )
01093 
01094 <span class="comment">/*++</span>
01095 <span class="comment"></span>
01096 <span class="comment">Routine Description:</span>
01097 <span class="comment"></span>
01098 <span class="comment">Arguments:</span>
01099 <span class="comment"></span>
01100 <span class="comment">Return Value:</span>
01101 <span class="comment"></span>
01102 <span class="comment">--*/</span>
01103 
01104 {
01105     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
01106     <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> BusyBlock;
01107     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01108     BOOLEAN LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01109 
01110     <a class="code" href="../../d7/d9/heappage_8h.html#a6">IF_DEBUG_PAGE_HEAP_THEN_RETURN</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>,
01111                                     <a class="code" href="../../d7/d9/heappage_8h.html#a23">RtlpDebugPageHeapSetUserFlags</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, BaseAddress, UserFlagsReset, UserFlagsSet ));
01112 
01113     <span class="keywordflow">if</span> ((UserFlagsReset &amp; ~HEAP_SETTABLE_USER_FLAGS) ||
01114         (UserFlagsSet &amp; ~HEAP_SETTABLE_USER_FLAGS)) {
01115 
01116         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01117     }
01118 
01119     <span class="keywordflow">try</span> {
01120 
01121         <span class="keywordflow">try</span> {
01122 
01123             <span class="comment">//</span>
01124             <span class="comment">//  Validate that HeapAddress points to a HEAP structure.</span>
01125             <span class="comment">//</span>
01126 
01127             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlSetUserFlagsHeap"</span> )) {
01128 
01129                 Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01130                 leave;
01131             }
01132 
01133             Flags |= Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o3">ForceFlags</a> | <a class="code" href="../../d3/d9/heap_8h.html#a23">HEAP_SKIP_VALIDATION_CHECKS</a>;
01134 
01135             <span class="comment">//</span>
01136             <span class="comment">//  Lock the heap</span>
01137             <span class="comment">//</span>
01138 
01139             <span class="keywordflow">if</span> (!(Flags &amp; HEAP_NO_SERIALIZE)) {
01140 
01141                 <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01142 
01143                 LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01144 
01145                 Flags |= HEAP_NO_SERIALIZE;
01146             }
01147 
01148             <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01149 
01150             BusyBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)BaseAddress - 1;
01151 
01152             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a47">RtlpValidateHeapEntry</a>( Heap, BusyBlock, <span class="stringliteral">"RtlSetUserFlagsHeap"</span> )) {
01153 
01154                 Result = <a class="code" href="../../d5/d9/heapdll_8c.html#a27">RtlSetUserFlagsHeap</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, BaseAddress, UserFlagsReset, UserFlagsSet );
01155 
01156                 <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01157             }
01158 
01159         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
01160 
01161             <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( GetExceptionCode() );
01162         }
01163 
01164     } finally {
01165 
01166         <span class="keywordflow">if</span> (LockAcquired) {
01167 
01168             <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01169         }
01170     }
01171 
01172     <span class="keywordflow">return</span> Result;
01173 }
01174 
01175 
01176 SIZE_T
<a name="l01177"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a19">01177</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a19">RtlDebugSizeHeap</a> (
01178     IN PVOID HeapHandle,
01179     IN ULONG Flags,
01180     IN PVOID BaseAddress
01181     )
01182 
01183 <span class="comment">/*++</span>
01184 <span class="comment"></span>
01185 <span class="comment">Routine Description:</span>
01186 <span class="comment"></span>
01187 <span class="comment">Arguments:</span>
01188 <span class="comment"></span>
01189 <span class="comment">Return Value:</span>
01190 <span class="comment"></span>
01191 <span class="comment">--*/</span>
01192 
01193 {
01194     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
01195     <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> BusyBlock;
01196     BOOLEAN LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01197     SIZE_T BusySize;
01198 
01199     <a class="code" href="../../d7/d9/heappage_8h.html#a6">IF_DEBUG_PAGE_HEAP_THEN_RETURN</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>,
01200                                     <a class="code" href="../../d7/d9/heappage_8h.html#a14">RtlpDebugPageHeapSize</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, BaseAddress ));
01201 
01202     BusySize = 0xFFFFFFFF;
01203 
01204     <span class="keywordflow">try</span> {
01205 
01206         <span class="keywordflow">try</span> {
01207 
01208             <span class="comment">//</span>
01209             <span class="comment">//  Validate that HeapAddress points to a HEAP structure.</span>
01210             <span class="comment">//</span>
01211 
01212             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlSizeHeap"</span> )) {
01213 
01214                 BusySize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01215                 leave;
01216             }
01217 
01218             Flags |= Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o3">ForceFlags</a> | <a class="code" href="../../d3/d9/heap_8h.html#a23">HEAP_SKIP_VALIDATION_CHECKS</a>;
01219 
01220             <span class="comment">//</span>
01221             <span class="comment">//  Lock the heap</span>
01222             <span class="comment">//</span>
01223 
01224             <span class="keywordflow">if</span> (!(Flags &amp; HEAP_NO_SERIALIZE)) {
01225 
01226                 <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01227 
01228                 Flags |= HEAP_NO_SERIALIZE;
01229 
01230                 LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01231             }
01232 
01233             <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01234 
01235             BusyBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)BaseAddress - 1;
01236 
01237             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a47">RtlpValidateHeapEntry</a>( Heap, BusyBlock, <span class="stringliteral">"RtlSizeHeap"</span> )) {
01238 
01239                 BusySize = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a21">RtlSizeHeap</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, BaseAddress );
01240             }
01241 
01242         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
01243 
01244             <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( GetExceptionCode() );
01245         }
01246 
01247     } finally {
01248 
01249         <span class="keywordflow">if</span> (LockAcquired) {
01250 
01251             <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01252         }
01253     }
01254 
01255     <span class="keywordflow">return</span> BusySize;
01256 }
01257 
01258 
01259 SIZE_T
<a name="l01260"></a><a class="code" href="../../d5/d9/heapdll_8c.html#a12">01260</a> <a class="code" href="../../d5/d9/heapdll_8c.html#a12">RtlDebugCompactHeap</a> (
01261     IN PVOID HeapHandle,
01262     IN ULONG Flags
01263     )
01264 
01265 <span class="comment">/*++</span>
01266 <span class="comment"></span>
01267 <span class="comment">Routine Description:</span>
01268 <span class="comment"></span>
01269 <span class="comment">Arguments:</span>
01270 <span class="comment"></span>
01271 <span class="comment">Return Value:</span>
01272 <span class="comment"></span>
01273 <span class="comment">--*/</span>
01274 
01275 {
01276     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
01277     BOOLEAN LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01278     SIZE_T LargestFreeSize;
01279 
01280     <a class="code" href="../../d7/d9/heappage_8h.html#a6">IF_DEBUG_PAGE_HEAP_THEN_RETURN</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>,
01281                                     <a class="code" href="../../d7/d9/heappage_8h.html#a16">RtlpDebugPageHeapCompact</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags ));
01282 
01283     LargestFreeSize = 0;
01284 
01285     <span class="keywordflow">try</span> {
01286 
01287         <span class="keywordflow">try</span> {
01288 
01289             <span class="comment">//</span>
01290             <span class="comment">//  Validate that HeapAddress points to a HEAP structure.</span>
01291             <span class="comment">//</span>
01292 
01293             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlCompactHeap"</span> )) {
01294 
01295                 LargestFreeSize = 0;
01296                 leave;
01297             }
01298 
01299             Flags |= Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o3">ForceFlags</a> | <a class="code" href="../../d3/d9/heap_8h.html#a23">HEAP_SKIP_VALIDATION_CHECKS</a>;
01300 
01301             <span class="comment">//</span>
01302             <span class="comment">//  Lock the heap</span>
01303             <span class="comment">//</span>
01304 
01305             <span class="keywordflow">if</span> (!(Flags &amp; HEAP_NO_SERIALIZE)) {
01306 
01307                 <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01308 
01309                 LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01310 
01311                 Flags |= HEAP_NO_SERIALIZE;
01312             }
01313 
01314             <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01315 
01316             LargestFreeSize = <a class="code" href="../../d5/d9/heapdll_8c.html#a31">RtlCompactHeap</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags );
01317 
01318             <a class="code" href="../../d9/d9/heappriv_8h.html#a50">RtlpValidateHeapHeaders</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01319 
01320         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
01321 
01322             <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( GetExceptionCode() );
01323         }
01324 
01325     } finally {
01326 
01327         <span class="keywordflow">if</span> (LockAcquired) {
01328 
01329             <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01330         }
01331     }
01332 
01333     <span class="keywordflow">return</span> LargestFreeSize;
01334 }
01335 
01336 
01337 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01338"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a21">01338</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a21">RtlDebugZeroHeap</a> (
01339     IN PVOID HeapHandle,
01340     IN ULONG Flags
01341     )
01342 
01343 <span class="comment">/*++</span>
01344 <span class="comment"></span>
01345 <span class="comment">Routine Description:</span>
01346 <span class="comment"></span>
01347 <span class="comment">Arguments:</span>
01348 <span class="comment"></span>
01349 <span class="comment">Return Value:</span>
01350 <span class="comment"></span>
01351 <span class="comment">--*/</span>
01352 
01353 {
01354     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01355     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
01356     BOOLEAN LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01357     SIZE_T LargestFreeSize;
01358 
01359     <a class="code" href="../../d7/d9/heappage_8h.html#a6">IF_DEBUG_PAGE_HEAP_THEN_RETURN</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>,
01360                                     <a class="code" href="../../d7/d9/heappage_8h.html#a26">RtlpDebugPageHeapZero</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags ));
01361 
01362     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01363     LargestFreeSize = 0;
01364 
01365     <span class="keywordflow">try</span> {
01366 
01367         <span class="keywordflow">try</span> {
01368 
01369             <span class="comment">//</span>
01370             <span class="comment">//  Validate that HeapAddress points to a HEAP structure.</span>
01371             <span class="comment">//</span>
01372 
01373             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlZeroHeap"</span> )) {
01374 
01375                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01376                 leave;
01377             }
01378 
01379             Flags |= Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o3">ForceFlags</a> | <a class="code" href="../../d3/d9/heap_8h.html#a23">HEAP_SKIP_VALIDATION_CHECKS</a>;
01380 
01381             <span class="comment">//</span>
01382             <span class="comment">//  Lock the heap</span>
01383             <span class="comment">//</span>
01384 
01385             <span class="keywordflow">if</span> (!(Flags &amp; HEAP_NO_SERIALIZE)) {
01386 
01387                 <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01388 
01389                 LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01390 
01391                 Flags |= HEAP_NO_SERIALIZE;
01392             }
01393 
01394             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> )) {
01395 
01396                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01397 
01398             } <span class="keywordflow">else</span> {
01399 
01400                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a22">RtlZeroHeap</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags );
01401             }
01402 
01403         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
01404 
01405             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01406         }
01407 
01408     } finally {
01409 
01410         <span class="keywordflow">if</span> (LockAcquired) {
01411 
01412             <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01413         }
01414     }
01415 
01416     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01417 }
01418 
01419 
01420 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01421"></a><a class="code" href="../../d5/d9/heapdll_8c.html#a13">01421</a> <a class="code" href="../../d5/d9/heapdll_8c.html#a13">RtlDebugCreateTagHeap</a> (
01422     IN PVOID HeapHandle,
01423     IN ULONG Flags,
01424     IN PWSTR TagPrefix OPTIONAL,
01425     IN PWSTR TagNames
01426     )
01427 
01428 <span class="comment">/*++</span>
01429 <span class="comment"></span>
01430 <span class="comment">Routine Description:</span>
01431 <span class="comment"></span>
01432 <span class="comment">Arguments:</span>
01433 <span class="comment"></span>
01434 <span class="comment">Return Value:</span>
01435 <span class="comment"></span>
01436 <span class="comment">--*/</span>
01437 
01438 {
01439     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
01440     BOOLEAN LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01441     ULONG TagIndex;
01442 
01443     TagIndex = 0;
01444 
01445     <span class="keywordflow">try</span> {
01446 
01447         <span class="keywordflow">try</span> {
01448 
01449             <span class="comment">//</span>
01450             <span class="comment">//  Validate that HeapAddress points to a HEAP structure.</span>
01451             <span class="comment">//</span>
01452 
01453             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlCreateTagHeap"</span> )) {
01454 
01455                 Flags |= Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o3">ForceFlags</a> | <a class="code" href="../../d3/d9/heap_8h.html#a23">HEAP_SKIP_VALIDATION_CHECKS</a>;
01456 
01457                 <span class="comment">//</span>
01458                 <span class="comment">//  Lock the heap</span>
01459                 <span class="comment">//</span>
01460 
01461                 <span class="keywordflow">if</span> (!(Flags &amp; HEAP_NO_SERIALIZE)) {
01462 
01463                     <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01464 
01465                     LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01466 
01467                     Flags |= HEAP_NO_SERIALIZE;
01468                 }
01469 
01470                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> )) {
01471 
01472                     TagIndex = <a class="code" href="../../d5/d9/heapdll_8c.html#a28">RtlCreateTagHeap</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, TagPrefix, TagNames );
01473                 }
01474 
01475                 <a class="code" href="../../d9/d9/heappriv_8h.html#a50">RtlpValidateHeapHeaders</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01476             }
01477 
01478         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
01479 
01480             <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( GetExceptionCode() );
01481         }
01482 
01483     } finally {
01484 
01485         <span class="keywordflow">if</span> (LockAcquired) {
01486 
01487             <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01488         }
01489     }
01490 
01491     <span class="keywordflow">return</span> TagIndex;
01492 }
01493 
01494 
01495 NTSYSAPI
01496 PWSTR
01497 NTAPI
<a name="l01498"></a><a class="code" href="../../d5/d9/heapdll_8c.html#a14">01498</a> <a class="code" href="../../d5/d9/heapdll_8c.html#a14">RtlDebugQueryTagHeap</a> (
01499     IN PVOID HeapHandle,
01500     IN ULONG Flags,
01501     IN USHORT TagIndex,
01502     IN BOOLEAN ResetCounters,
01503     OUT PRTL_HEAP_TAG_INFO TagInfo OPTIONAL
01504     )
01505 
01506 <span class="comment">/*++</span>
01507 <span class="comment"></span>
01508 <span class="comment">Routine Description:</span>
01509 <span class="comment"></span>
01510 <span class="comment">Arguments:</span>
01511 <span class="comment"></span>
01512 <span class="comment">Return Value:</span>
01513 <span class="comment"></span>
01514 <span class="comment">--*/</span>
01515 
01516 {
01517     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
01518     BOOLEAN LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01519     PWSTR Result;
01520 
01521     Result = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01522 
01523     <span class="keywordflow">try</span> {
01524 
01525         <span class="keywordflow">try</span> {
01526 
01527             <span class="comment">//</span>
01528             <span class="comment">//  Validate that HeapAddress points to a HEAP structure.</span>
01529             <span class="comment">//</span>
01530 
01531             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlQueryTagHeap"</span> )) {
01532 
01533                 Flags |= Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o3">ForceFlags</a> | <a class="code" href="../../d3/d9/heap_8h.html#a23">HEAP_SKIP_VALIDATION_CHECKS</a>;
01534 
01535                 <span class="comment">//</span>
01536                 <span class="comment">//  Lock the heap</span>
01537                 <span class="comment">//</span>
01538 
01539                 <span class="keywordflow">if</span> (!(Flags &amp; HEAP_NO_SERIALIZE)) {
01540 
01541                     <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01542 
01543                     LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01544 
01545                     Flags |= HEAP_NO_SERIALIZE;
01546                 }
01547 
01548                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> )) {
01549 
01550                     Result = <a class="code" href="../../d5/d9/heapdll_8c.html#a29">RtlQueryTagHeap</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, TagIndex, ResetCounters, TagInfo );
01551                 }
01552             }
01553 
01554         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
01555 
01556             <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( GetExceptionCode() );
01557         }
01558 
01559     } finally {
01560 
01561         <span class="keywordflow">if</span> (LockAcquired) {
01562 
01563             <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01564         }
01565     }
01566 
01567     <span class="keywordflow">return</span> Result;
01568 }
01569 
01570 
01571 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01572"></a><a class="code" href="../../d5/d9/heapdll_8c.html#a15">01572</a> <a class="code" href="../../d5/d9/heapdll_8c.html#a15">RtlDebugUsageHeap</a> (
01573     IN PVOID HeapHandle,
01574     IN ULONG Flags,
01575     IN OUT PRTL_HEAP_USAGE Usage
01576     )
01577 
01578 <span class="comment">/*++</span>
01579 <span class="comment"></span>
01580 <span class="comment">Routine Description:</span>
01581 <span class="comment"></span>
01582 <span class="comment">Arguments:</span>
01583 <span class="comment"></span>
01584 <span class="comment">Return Value:</span>
01585 <span class="comment"></span>
01586 <span class="comment">--*/</span>
01587 
01588 {
01589     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
01590     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01591     BOOLEAN LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01592 
01593     <a class="code" href="../../d7/d9/heappage_8h.html#a6">IF_DEBUG_PAGE_HEAP_THEN_RETURN</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>,
01594                                     <a class="code" href="../../d7/d9/heappage_8h.html#a28">RtlpDebugPageHeapUsage</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a> ));
01595 
01596     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01597 
01598     <span class="keywordflow">try</span> {
01599 
01600         <span class="keywordflow">try</span> {
01601 
01602             <span class="comment">//</span>
01603             <span class="comment">//  Validate that HeapAddress points to a HEAP structure.</span>
01604             <span class="comment">//</span>
01605 
01606             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlUsageHeap"</span> )) {
01607 
01608                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01609                 leave;
01610             }
01611 
01612             Flags |= Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o3">ForceFlags</a> | <a class="code" href="../../d3/d9/heap_8h.html#a23">HEAP_SKIP_VALIDATION_CHECKS</a>;
01613 
01614             <span class="comment">//</span>
01615             <span class="comment">//  Lock the heap</span>
01616             <span class="comment">//</span>
01617 
01618             <span class="keywordflow">if</span> (!(Flags &amp; HEAP_NO_SERIALIZE)) {
01619 
01620                 <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01621 
01622                 LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01623 
01624                 Flags |= HEAP_NO_SERIALIZE;
01625             }
01626 
01627             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> )) {
01628 
01629                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01630 
01631             } <span class="keywordflow">else</span> {
01632 
01633                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d9/heapdll_8c.html#a36">RtlUsageHeap</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a> );
01634             }
01635 
01636         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
01637 
01638             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01639         }
01640 
01641     } finally {
01642 
01643         <span class="keywordflow">if</span> (LockAcquired) {
01644 
01645             <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01646         }
01647     }
01648 
01649     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01650 }
01651 
01652 
01653 BOOLEAN
<a name="l01654"></a><a class="code" href="../../d5/d9/heapdll_8c.html#a16">01654</a> <a class="code" href="../../d5/d9/heapdll_8c.html#a16">RtlDebugWalkHeap</a> (
01655     IN PVOID HeapHandle,
01656     IN OUT PRTL_HEAP_WALK_ENTRY Entry
01657     )
01658 
01659 <span class="comment">/*++</span>
01660 <span class="comment"></span>
01661 <span class="comment">Routine Description:</span>
01662 <span class="comment"></span>
01663 <span class="comment">Arguments:</span>
01664 <span class="comment"></span>
01665 <span class="comment">Return Value:</span>
01666 <span class="comment"></span>
01667 <span class="comment">--*/</span>
01668 
01669 {
01670     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
01671     BOOLEAN Result;
01672 
01673     <span class="comment">//</span>
01674     <span class="comment">//  Assumed the caller has serialized via RtlLockHeap or their own locking mechanism.</span>
01675     <span class="comment">//</span>
01676 
01677     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01678 
01679     <span class="keywordflow">try</span> {
01680 
01681         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlWalkHeap"</span> )) {
01682 
01683             Result = <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01684         }
01685 
01686     } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
01687 
01688         <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( GetExceptionCode() );
01689     }
01690 
01691     <span class="keywordflow">return</span> Result;
01692 }
01693 
01694 
01695 BOOLEAN
<a name="l01696"></a><a class="code" href="../../d9/d9/heappriv_8h.html#a47">01696</a> <a class="code" href="../../d9/d9/heappriv_8h.html#a47">RtlpValidateHeapEntry</a> (
01697     IN <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap,
01698     IN <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> BusyBlock,
01699     IN PCHAR Reason
01700     )
01701 
01702 <span class="comment">/*++</span>
01703 <span class="comment"></span>
01704 <span class="comment">Routine Description:</span>
01705 <span class="comment"></span>
01706 <span class="comment">Arguments:</span>
01707 <span class="comment"></span>
01708 <span class="comment">Return Value:</span>
01709 <span class="comment"></span>
01710 <span class="comment">--*/</span>
01711 
01712 {
01713     <a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a> Segment;
01714     UCHAR SegmentIndex;
01715     BOOLEAN Result;
01716 
01717     <span class="keywordflow">if</span> ((BusyBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01718 
01719             ||
01720 
01721         ((ULONG_PTR)BusyBlock &amp; (<a class="code" href="../../d3/d9/heap_8h.html#a3">HEAP_GRANULARITY</a>-1))
01722 
01723             ||
01724 
01725         ((BusyBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a11">HEAP_ENTRY_VIRTUAL_ALLOC</a>) &amp;&amp;
01726          ((ULONG_PTR)BusyBlock &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-1)) != FIELD_OFFSET( <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">HEAP_VIRTUAL_ALLOC_ENTRY</a>, BusyBlock ))
01727 
01728             ||
01729 
01730         (!(BusyBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a11">HEAP_ENTRY_VIRTUAL_ALLOC</a>) &amp;&amp;
01731          ((BusyBlock-&gt;SegmentIndex &gt;= <a class="code" href="../../d3/d9/heap_8h.html#a7">HEAP_MAXIMUM_SEGMENTS</a>) ||
01732           !(Segment = Heap-&gt;Segments[ BusyBlock-&gt;SegmentIndex ]) ||
01733           (BusyBlock &lt; Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o7">FirstEntry</a>) ||
01734           (BusyBlock &gt;= Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o8">LastValidEntry</a>)))
01735 
01736             ||
01737 
01738         !(BusyBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a8">HEAP_ENTRY_BUSY</a>)
01739 
01740             ||
01741 
01742         ((BusyBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a10">HEAP_ENTRY_FILL_PATTERN</a>) &amp;&amp; !<a class="code" href="../../d9/d9/heappriv_8h.html#a42">RtlpCheckBusyBlockTail</a>( BusyBlock ))) {
01743 
01744 InvalidBlock:
01745 
01746         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Invalid Address specified to %s( %lx, %lx )\n"</span>,
01747                          Reason,
01748                          Heap,
01749                          BusyBlock + 1 ));
01750 
01751         <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( BusyBlock );
01752 
01753         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01754 
01755     } <span class="keywordflow">else</span> {
01756 
01757         <span class="keywordflow">if</span> (BusyBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a11">HEAP_ENTRY_VIRTUAL_ALLOC</a>) {
01758 
01759             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01760 
01761         } <span class="keywordflow">else</span> {
01762 
01763             <span class="keywordflow">for</span> (SegmentIndex=0; SegmentIndex&lt;<a class="code" href="../../d3/d9/heap_8h.html#a7">HEAP_MAXIMUM_SEGMENTS</a>; SegmentIndex++) {
01764 
01765                 Segment = Heap-&gt;Segments[ SegmentIndex ];
01766 
01767                 <span class="keywordflow">if</span> (Segment) {
01768 
01769                     <span class="keywordflow">if</span> ((BusyBlock &gt;= Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o7">FirstEntry</a>) &amp;&amp;
01770                         (BusyBlock &lt; Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o8">LastValidEntry</a>)) {
01771 
01772                         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01773                         <span class="keywordflow">break</span>;
01774                     }
01775                 }
01776             }
01777         }
01778 
01779         <span class="keywordflow">if</span> (!Result) {
01780 
01781             <span class="keywordflow">goto</span> InvalidBlock;
01782         }
01783 
01784         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01785     }
01786 }
01787 
01788 
01789 BOOLEAN
<a name="l01790"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a27">01790</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a27">RtlpValidateHeapSegment</a> (
01791     IN <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap,
01792     IN <a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a> Segment,
01793     IN UCHAR SegmentIndex,
01794     IN OUT PULONG CountOfFreeBlocks,
01795     IN OUT PSIZE_T TotalFreeSize,
01796     OUT PVOID *BadAddress,
01797     IN OUT PSIZE_T ComputedTagEntries,
01798     IN OUT PSIZE_T ComputedPseudoTagEntries
01799     )
01800 
01801 <span class="comment">/*++</span>
01802 <span class="comment"></span>
01803 <span class="comment">Routine Description:</span>
01804 <span class="comment"></span>
01805 <span class="comment">Arguments:</span>
01806 <span class="comment"></span>
01807 <span class="comment">Return Value:</span>
01808 <span class="comment"></span>
01809 <span class="comment">--*/</span>
01810 
01811 {
01812     <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> CurrentBlock, PreviousBlock;
01813     SIZE_T <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01814     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> PreviousSize, TagIndex;
01815     <a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html">PHEAP_UNCOMMMTTED_RANGE</a> UnCommittedRange;
01816     <a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">PHEAP_ENTRY_EXTRA</a> ExtraStuff;
01817     ULONG NumberOfUnCommittedPages;
01818     ULONG NumberOfUnCommittedRanges;
01819 
01820     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01821 
01822     NumberOfUnCommittedPages = 0;
01823     NumberOfUnCommittedRanges = 0;
01824 
01825     UnCommittedRange = Segment-&gt;UnCommittedRanges;
01826 
01827     <span class="keywordflow">if</span> (Segment-&gt;BaseAddress == Heap) {
01828 
01829         CurrentBlock = &amp;Heap-&gt;Entry;
01830 
01831     } <span class="keywordflow">else</span> {
01832 
01833         CurrentBlock = &amp;Segment-&gt;Entry;
01834     }
01835 
01836     <span class="keywordflow">while</span> (CurrentBlock &lt; Segment-&gt;LastValidEntry) {
01837 
01838         *BadAddress = CurrentBlock;
01839 
01840         <span class="keywordflow">if</span> ((UnCommittedRange != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01841             ((ULONG_PTR)CurrentBlock &gt;= UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o1">Address</a>)) {
01842 
01843             <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Heap entry %lx is beyond uncommited range [%x .. %x)\n"</span>,
01844                              CurrentBlock,
01845                              UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o1">Address</a>,
01846                              (PCHAR)UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o1">Address</a> + UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o2">Size</a> ));
01847 
01848             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01849         }
01850 
01851         PreviousSize = 0;
01852 
01853         <span class="keywordflow">while</span> (CurrentBlock &lt; Segment-&gt;LastValidEntry) {
01854 
01855             *BadAddress = CurrentBlock;
01856 
01857             <span class="keywordflow">if</span> (PreviousSize != CurrentBlock-&gt;PreviousSize) {
01858 
01859                 <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Heap entry %lx has incorrect PreviousSize field (%04x instead of %04x)\n"</span>,
01860                                  CurrentBlock, CurrentBlock-&gt;PreviousSize, PreviousSize ));
01861 
01862                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01863             }
01864 
01865             PreviousSize = CurrentBlock-&gt;Size;
01866             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (ULONG_PTR)CurrentBlock-&gt;Size &lt;&lt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>;
01867 
01868             <span class="keywordflow">if</span> (CurrentBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a8">HEAP_ENTRY_BUSY</a>) {
01869 
01870                 <span class="keywordflow">if</span> (ComputedTagEntries != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01871 
01872                     <span class="keywordflow">if</span> (CurrentBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a9">HEAP_ENTRY_EXTRA_PRESENT</a>) {
01873 
01874                         ExtraStuff = <a class="code" href="../../d9/d9/heappriv_8h.html#a41">RtlpGetExtraStuffPointer</a>( CurrentBlock );
01875                         TagIndex = ExtraStuff-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o1">TagIndex</a>;
01876 
01877                     } <span class="keywordflow">else</span> {
01878 
01879                         TagIndex = CurrentBlock-&gt;SmallTagIndex;
01880                     }
01881 
01882                     <span class="keywordflow">if</span> (TagIndex != 0) {
01883 
01884                         <span class="keywordflow">if</span> (TagIndex &amp; HEAP_PSEUDO_TAG_FLAG) {
01885 
01886                             TagIndex &amp;= ~HEAP_PSEUDO_TAG_FLAG;
01887 
01888                             <span class="keywordflow">if</span> (TagIndex &lt; <a class="code" href="../../d3/d9/heap_8h.html#a32">HEAP_NUMBER_OF_PSEUDO_TAG</a>) {
01889 
01890                                 ComputedPseudoTagEntries[ TagIndex ] += CurrentBlock-&gt;Size;
01891                             }
01892 
01893                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TagIndex &amp; HEAP_GLOBAL_TAG) {
01894 
01895                             <span class="comment">//</span>
01896                             <span class="comment">//  Ignore these since they are global across more than</span>
01897                             <span class="comment">//  one heap.</span>
01898                             <span class="comment">//</span>
01899 
01900                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TagIndex &lt; Heap-&gt;NextAvailableTagIndex) {
01901 
01902                             ComputedTagEntries[ TagIndex ] += CurrentBlock-&gt;Size;
01903                         }
01904                     }
01905                 }
01906 
01907                 <span class="keywordflow">if</span> (CurrentBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a10">HEAP_ENTRY_FILL_PATTERN</a>) {
01908 
01909                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a42">RtlpCheckBusyBlockTail</a>( CurrentBlock )) {
01910 
01911                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01912                     }
01913                 }
01914 
01915             } <span class="keywordflow">else</span> {
01916 
01917                 *CountOfFreeBlocks += 1;
01918                 *TotalFreeSize += CurrentBlock-&gt;Size;
01919 
01920                 <span class="keywordflow">if</span> ((Heap-&gt;Flags &amp; HEAP_FREE_CHECKING_ENABLED) &amp;&amp;
01921                     (CurrentBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a10">HEAP_ENTRY_FILL_PATTERN</a>)) {
01922 
01923                     SIZE_T cb, cbEqual;
01924 
01925                     cb = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">HEAP_FREE_ENTRY</a> );
01926 
01927                     <span class="keywordflow">if</span> ((CurrentBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a9">HEAP_ENTRY_EXTRA_PRESENT</a>) &amp;&amp;
01928                         (cb &gt; <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/struct__HEAP__FREE__ENTRY__EXTRA.html">HEAP_FREE_ENTRY_EXTRA</a> ))) {
01929 
01930                         cb -= <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/struct__HEAP__FREE__ENTRY__EXTRA.html">HEAP_FREE_ENTRY_EXTRA</a> );
01931                     }
01932 
01933                     cbEqual = <a class="code" href="../../d2/d7/string_8c.html#a17">RtlCompareMemoryUlong</a>( (PCHAR)((<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)CurrentBlock + 1),
01934                                                      cb,
01935                                                      <a class="code" href="../../d3/d9/heap_8h.html#a27">FREE_HEAP_FILL</a> );
01936 
01937                     <span class="keywordflow">if</span> (cbEqual != cb) {
01938 
01939                         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Free Heap block %lx modified at %lx after it was freed\n"</span>,
01940                                          CurrentBlock,
01941                                          (PCHAR)(CurrentBlock + 1) + cbEqual ));
01942 
01943                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01944                     }
01945                 }
01946             }
01947 
01948             <span class="keywordflow">if</span> (CurrentBlock-&gt;SegmentIndex != SegmentIndex) {
01949 
01950                 <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Heap block at %lx has incorrect segment index (%x)\n"</span>,
01951                                  CurrentBlock,
01952                                  SegmentIndex ));
01953 
01954                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01955             }
01956 
01957             <span class="keywordflow">if</span> (CurrentBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>) {
01958 
01959                 CurrentBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)((PCHAR)CurrentBlock + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
01960 
01961                 <span class="keywordflow">if</span> (UnCommittedRange == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01962 
01963                     <span class="keywordflow">if</span> (CurrentBlock != Segment-&gt;LastValidEntry) {
01964 
01965                         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Heap block at %lx is not last block in segment (%x)\n"</span>,
01966                                          CurrentBlock,
01967                                          Segment-&gt;LastValidEntry ));
01968 
01969                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01970                     }
01971 
01972                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ULONG_PTR)CurrentBlock != UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o1">Address</a>) {
01973 
01974                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Heap block at %lx does not match address of next uncommitted address (%x)\n"</span>,
01975                                      CurrentBlock,
01976                                      UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o1">Address</a> ));
01977 
01978                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01979 
01980                 } <span class="keywordflow">else</span> {
01981 
01982                     NumberOfUnCommittedPages += (ULONG) (UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o2">Size</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01983                     NumberOfUnCommittedRanges += 1;
01984 
01985                     CurrentBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)
01986                         ((PCHAR)UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o1">Address</a> + UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o2">Size</a>);
01987 
01988                     UnCommittedRange = UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o0">Next</a>;
01989                 }
01990 
01991                 <span class="keywordflow">break</span>;
01992             }
01993 
01994             CurrentBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)((PCHAR)CurrentBlock + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
01995         }
01996     }
01997 
01998     *BadAddress = Segment;
01999 
02000     <span class="keywordflow">if</span> (Segment-&gt;NumberOfUnCommittedPages != NumberOfUnCommittedPages) {
02001 
02002         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Heap Segment at %lx contains invalid NumberOfUnCommittedPages (%x != %x)\n"</span>,
02003                          Segment,
02004                          Segment-&gt;NumberOfUnCommittedPages,
02005                          NumberOfUnCommittedPages ));
02006 
02007         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02008     }
02009 
02010     <span class="keywordflow">if</span> (Segment-&gt;NumberOfUnCommittedRanges != NumberOfUnCommittedRanges) {
02011 
02012         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Heap Segment at %lx contains invalid NumberOfUnCommittedRanges (%x != %x)\n"</span>,
02013                          Segment,
02014                          Segment-&gt;NumberOfUnCommittedRanges,
02015                          NumberOfUnCommittedRanges ));
02016 
02017         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02018     }
02019 
02020     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02021 }
02022 
02023 
02024 BOOLEAN
<a name="l02025"></a><a class="code" href="../../d9/d9/heappriv_8h.html#a48">02025</a> <a class="code" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a> (
02026     IN <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap,
02027     IN BOOLEAN AlwaysValidate
02028     )
02029 
02030 <span class="comment">/*++</span>
02031 <span class="comment"></span>
02032 <span class="comment">Routine Description:</span>
02033 <span class="comment"></span>
02034 <span class="comment">Arguments:</span>
02035 <span class="comment"></span>
02036 <span class="comment">Return Value:</span>
02037 <span class="comment"></span>
02038 <span class="comment">--*/</span>
02039 
02040 {
02041     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02042     <a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a> Segment;
02043     PLIST_ENTRY Head, Next;
02044     <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> FreeBlock;
02045     BOOLEAN EmptyFreeList;
02046     ULONG NumberOfFreeListEntries;
02047     ULONG CountOfFreeBlocks;
02048     SIZE_T TotalFreeSize;
02049     SIZE_T <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02050     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> PreviousSize;
02051     UCHAR SegmentIndex;
02052     PVOID BadAddress;
02053     PSIZE_T ComputedTagEntries = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02054     PSIZE_T ComputedPseudoTagEntries = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02055     <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">PHEAP_VIRTUAL_ALLOC_ENTRY</a> VirtualAllocBlock;
02056     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TagIndex;
02057 
02058     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02059 
02060     BadAddress = Heap;
02061 
02062     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a50">RtlpValidateHeapHeaders</a>( Heap, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> )) {
02063 
02064         <span class="keywordflow">goto</span> errorExit;
02065     }
02066 
02067     <span class="keywordflow">if</span> (!AlwaysValidate &amp;&amp; !(Heap-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a22">HEAP_VALIDATE_ALL_ENABLED</a>)) {
02068 
02069         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02070     }
02071 
02072     NumberOfFreeListEntries = 0;
02073     Head = &amp;Heap-&gt;FreeLists[ 0 ];
02074 
02075     <span class="keywordflow">for</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a>; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>++) {
02076 
02077         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> != 0) {
02078 
02079             EmptyFreeList = (BOOLEAN)(IsListEmpty( Head ));
02080             BadAddress = &amp;Heap-&gt;u.FreeListsInUseBytes[ <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / 8 ];
02081 
02082             <span class="keywordflow">if</span> (Heap-&gt;u.FreeListsInUseBytes[ <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / 8 ] &amp; (1 &lt;&lt; (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &amp; 7)) ) {
02083 
02084                 <span class="keywordflow">if</span> (EmptyFreeList) {
02085 
02086                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"dedicated (%04x) free list empty but marked as non-empty\n"</span>,
02087                                      <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> ));
02088 
02089                     <span class="keywordflow">goto</span> errorExit;
02090                 }
02091 
02092             } <span class="keywordflow">else</span> {
02093 
02094                 <span class="keywordflow">if</span> (!EmptyFreeList) {
02095 
02096                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"dedicated (%04x) free list non-empty but marked as empty\n"</span>,
02097                                      <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> ));
02098 
02099                     <span class="keywordflow">goto</span> errorExit;
02100                 }
02101             }
02102         }
02103 
02104         Next = Head-&gt;Flink;
02105         PreviousSize = 0;
02106 
02107         <span class="keywordflow">while</span> (Head != Next) {
02108 
02109             FreeBlock = CONTAINING_RECORD( Next, <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">HEAP_FREE_ENTRY</a>, FreeList );
02110             Next = Next-&gt;Flink;
02111 
02112             BadAddress = FreeBlock;
02113 
02114             <span class="keywordflow">if</span> (FreeBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a8">HEAP_ENTRY_BUSY</a>) {
02115 
02116                 <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"dedicated (%04x) free list element %lx is marked busy\n"</span>,
02117                                  <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
02118                                  FreeBlock ));
02119 
02120                 <span class="keywordflow">goto</span> errorExit;
02121             }
02122 
02123             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> != 0) &amp;&amp; (FreeBlock-&gt;Size != <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>)) {
02124 
02125                 <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Dedicated (%04x) free list element %lx is wrong size (%04x)\n"</span>,
02126                                  <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
02127                                  FreeBlock,
02128                                  FreeBlock-&gt;Size ));
02129 
02130                 <span class="keywordflow">goto</span> errorExit;
02131 
02132             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> == 0) &amp;&amp; (FreeBlock-&gt;Size &lt; <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a>)) {
02133 
02134                 <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Non-Dedicated free list element %lx with too small size (%04x)\n"</span>,
02135                                  FreeBlock,
02136                                  FreeBlock-&gt;Size ));
02137 
02138                 <span class="keywordflow">goto</span> errorExit;
02139 
02140             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> == 0) &amp;&amp; (FreeBlock-&gt;Size &lt; PreviousSize)) {
02141 
02142                 <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Non-Dedicated free list element %lx is out of order\n"</span>,
02143                                  FreeBlock ));
02144 
02145                 <span class="keywordflow">goto</span> errorExit;
02146 
02147             } <span class="keywordflow">else</span> {
02148 
02149                 PreviousSize = FreeBlock-&gt;Size;
02150             }
02151 
02152             NumberOfFreeListEntries++;
02153         }
02154 
02155         Head++;
02156     }
02157 
02158     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (<a class="code" href="../../d3/d9/heap_8h.html#a32">HEAP_NUMBER_OF_PSEUDO_TAG</a> + Heap-&gt;NextAvailableTagIndex + 1) * <span class="keyword">sizeof</span>( SIZE_T );
02159 
02160     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d9/heap_8h.html#a63">RtlpValidateHeapTagsEnable</a>) &amp;&amp; (Heap-&gt;PseudoTagEntries != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02161 
02162         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d6/allocvm_8c.html#a7">NtAllocateVirtualMemory</a>( NtCurrentProcess(),
02163                                           &amp;ComputedPseudoTagEntries,
02164                                           0,
02165                                           &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
02166                                           MEM_COMMIT,
02167                                           PAGE_READWRITE );
02168 
02169         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02170 
02171             ComputedTagEntries = ComputedPseudoTagEntries + <a class="code" href="../../d3/d9/heap_8h.html#a32">HEAP_NUMBER_OF_PSEUDO_TAG</a>;
02172         }
02173     }
02174 
02175     Head = &amp;Heap-&gt;VirtualAllocdBlocks;
02176     Next = Head-&gt;Flink;
02177 
02178     <span class="keywordflow">while</span> (Head != Next) {
02179 
02180         VirtualAllocBlock = CONTAINING_RECORD( Next, <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">HEAP_VIRTUAL_ALLOC_ENTRY</a>, Entry );
02181 
02182         <span class="keywordflow">if</span> (ComputedTagEntries != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02183 
02184             TagIndex = VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o1">ExtraStuff</a>.<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o1">TagIndex</a>;
02185 
02186             <span class="keywordflow">if</span> (TagIndex != 0) {
02187 
02188                 <span class="keywordflow">if</span> (TagIndex &amp; HEAP_PSEUDO_TAG_FLAG) {
02189 
02190                     TagIndex &amp;= ~HEAP_PSEUDO_TAG_FLAG;
02191 
02192                     <span class="keywordflow">if</span> (TagIndex &lt; <a class="code" href="../../d3/d9/heap_8h.html#a32">HEAP_NUMBER_OF_PSEUDO_TAG</a>) {
02193 
02194                         ComputedPseudoTagEntries[ TagIndex ] +=
02195                             VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o2">CommitSize</a> &gt;&gt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>;
02196                     }
02197 
02198                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TagIndex &amp; HEAP_GLOBAL_TAG) {
02199 
02200                     <span class="comment">//</span>
02201                     <span class="comment">//  Ignore these since they are global across more than</span>
02202                     <span class="comment">//  one heap.</span>
02203                     <span class="comment">//</span>
02204 
02205                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TagIndex &lt; Heap-&gt;NextAvailableTagIndex) {
02206 
02207                     ComputedTagEntries[ TagIndex ] +=
02208                         VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o2">CommitSize</a> &gt;&gt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>;
02209                 }
02210             }
02211         }
02212 
02213         <span class="keywordflow">if</span> (VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o4">BusyBlock</a>.<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a10">HEAP_ENTRY_FILL_PATTERN</a>) {
02214 
02215             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a42">RtlpCheckBusyBlockTail</a>( &amp;VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o4">BusyBlock</a> )) {
02216 
02217                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02218             }
02219         }
02220 
02221         Next = Next-&gt;Flink;
02222     }
02223 
02224     CountOfFreeBlocks = 0;
02225     TotalFreeSize = 0;
02226 
02227     <span class="keywordflow">for</span> (SegmentIndex=0; SegmentIndex&lt;<a class="code" href="../../d3/d9/heap_8h.html#a7">HEAP_MAXIMUM_SEGMENTS</a>; SegmentIndex++) {
02228 
02229         Segment = Heap-&gt;Segments[ SegmentIndex ];
02230 
02231         <span class="keywordflow">if</span> (Segment) {
02232 
02233             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/heapdbg_8c.html#a27">RtlpValidateHeapSegment</a>( Heap,
02234                                           Segment,
02235                                           SegmentIndex,
02236                                           &amp;CountOfFreeBlocks,
02237                                           &amp;TotalFreeSize,
02238                                           &amp;BadAddress,
02239                                           ComputedTagEntries,
02240                                           ComputedPseudoTagEntries )) {
02241 
02242                 <span class="keywordflow">goto</span> errorExit;
02243             }
02244         }
02245     }
02246 
02247     BadAddress = Heap;
02248 
02249     <span class="keywordflow">if</span> (NumberOfFreeListEntries != CountOfFreeBlocks) {
02250 
02251         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Number of free blocks in arena (%ld) does not match number in the free lists (%ld)\n"</span>,
02252                          CountOfFreeBlocks,
02253                          NumberOfFreeListEntries ));
02254 
02255         <span class="keywordflow">goto</span> errorExit;
02256     }
02257 
02258     <span class="keywordflow">if</span> (Heap-&gt;TotalFreeSize != TotalFreeSize) {
02259 
02260         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Total size of free blocks in arena (%ld) does not match number total in heap header (%ld)\n"</span>,
02261                          TotalFreeSize,
02262                          Heap-&gt;TotalFreeSize ));
02263 
02264         <span class="keywordflow">goto</span> errorExit;
02265     }
02266 
02267     <span class="keywordflow">if</span> (ComputedPseudoTagEntries != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02268 
02269         <a class="code" href="../../d7/d6/struct__HEAP__PSEUDO__TAG__ENTRY.html">PHEAP_PSEUDO_TAG_ENTRY</a> PseudoTagEntries;
02270         <a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html">PHEAP_TAG_ENTRY</a> TagEntries;
02271         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TagIndex;
02272 
02273         PseudoTagEntries = Heap-&gt;PseudoTagEntries;
02274 
02275         <span class="keywordflow">if</span> (PseudoTagEntries != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02276 
02277             <span class="keywordflow">for</span> (TagIndex=1; TagIndex&lt;<a class="code" href="../../d3/d9/heap_8h.html#a32">HEAP_NUMBER_OF_PSEUDO_TAG</a>; TagIndex++) {
02278 
02279                 PseudoTagEntries += 1;
02280 
02281                 <span class="keywordflow">if</span> (ComputedPseudoTagEntries[ TagIndex ] != PseudoTagEntries-&gt;<a class="code" href="../../d7/d6/struct__HEAP__PSEUDO__TAG__ENTRY.html#o2">Size</a>) {
02282 
02283                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Pseudo Tag %04x size incorrect (%x != %x) %x\n"</span>,
02284                                      TagIndex,
02285                                      PseudoTagEntries-&gt;<a class="code" href="../../d7/d6/struct__HEAP__PSEUDO__TAG__ENTRY.html#o2">Size</a>,
02286                                      ComputedPseudoTagEntries[ TagIndex ]
02287                                      &amp;ComputedPseudoTagEntries[ TagIndex ] ));
02288 
02289                     <span class="keywordflow">goto</span> errorExit;
02290                 }
02291             }
02292         }
02293 
02294         TagEntries = Heap-&gt;TagEntries;
02295 
02296         <span class="keywordflow">if</span> (TagEntries != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02297 
02298             <span class="keywordflow">for</span> (TagIndex=1; TagIndex&lt;Heap-&gt;NextAvailableTagIndex; TagIndex++) {
02299 
02300                 TagEntries += 1;
02301 
02302                 <span class="keywordflow">if</span> (ComputedTagEntries[ TagIndex ] != TagEntries-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o2">Size</a>) {
02303 
02304                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Tag %04x (%ws) size incorrect (%x != %x) %x\n"</span>,
02305                                      TagIndex,
02306                                      TagEntries-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o5">TagName</a>,
02307                                      TagEntries-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o2">Size</a>,
02308                                      ComputedTagEntries[ TagIndex ],
02309                                      &amp;ComputedTagEntries[ TagIndex ] ));
02310 
02311                     <span class="keywordflow">goto</span> errorExit;
02312                 }
02313             }
02314         }
02315 
02316         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
02317 
02318         <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>( NtCurrentProcess(),
02319                              &amp;ComputedPseudoTagEntries,
02320                              &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
02321                              MEM_RELEASE );
02322     }
02323 
02324 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
02325 
02326     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02327 
02328 errorExit:
02329 
02330     <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( BadAddress );
02331 
02332     <span class="keywordflow">if</span> (ComputedPseudoTagEntries != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02333 
02334         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
02335 
02336         <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>( NtCurrentProcess(),
02337                              &amp;ComputedPseudoTagEntries,
02338                              &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
02339                              MEM_RELEASE );
02340     }
02341 
02342     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02343 
02344 }
02345 
02346 
<a name="l02347"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a6">02347</a> BOOLEAN <a class="code" href="../../d4/d9/heapdbg_8c.html#a6">RtlpHeapInvalidBreakPoint</a>;
<a name="l02348"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a7">02348</a> PVOID <a class="code" href="../../d4/d9/heapdbg_8c.html#a7">RtlpHeapInvalidBadAddress</a>;
02349 
02350 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02351"></a><a class="code" href="../../d4/d9/heapdbg_8c.html#a29">02351</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a29">RtlpBreakPointHeap</a> (
02352     IN PVOID BadAddress
02353     )
02354 
02355 <span class="comment">/*++</span>
02356 <span class="comment"></span>
02357 <span class="comment">Routine Description:</span>
02358 <span class="comment"></span>
02359 <span class="comment">Arguments:</span>
02360 <span class="comment"></span>
02361 <span class="comment">Return Value:</span>
02362 <span class="comment"></span>
02363 <span class="comment">--*/</span>
02364 
02365 {
02366     <span class="keywordflow">if</span> (NtCurrentPeb()-&gt;BeingDebugged) {
02367 
02368         *(BOOLEAN <span class="keyword">volatile</span> *)&amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a6">RtlpHeapInvalidBreakPoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02369 
02370         <a class="code" href="../../d4/d9/heapdbg_8c.html#a7">RtlpHeapInvalidBadAddress</a> = BadAddress;
02371 
02372         DbgBreakPoint();
02373 
02374         *(BOOLEAN <span class="keyword">volatile</span> *)&amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a6">RtlpHeapInvalidBreakPoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02375     }
02376 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:15 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
