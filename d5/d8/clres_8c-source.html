<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: clres.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>clres.c</h1><a href="../../d4/d9/clres_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: clres.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Resource Loading/Creation Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 24-Sep-1990 MikeKe    From win30</span>
00010 <span class="comment">* 19-Sep-1995 ChrisWil  Win95/NT merge.</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="comment">/*</span>
00017 <span class="comment"> * Constants.</span>
00018 <span class="comment"> */</span>
<a name="l00019"></a><a class="code" href="../../d4/d9/clres_8c.html#a0">00019</a> <span class="preprocessor">#define BPP01_MAXCOLORS     2</span>
<a name="l00020"></a><a class="code" href="../../d4/d9/clres_8c.html#a1">00020</a> <span class="preprocessor"></span><span class="preprocessor">#define BPP04_MAXCOLORS    16</span>
<a name="l00021"></a><a class="code" href="../../d4/d9/clres_8c.html#a2">00021</a> <span class="preprocessor"></span><span class="preprocessor">#define BPP08_MAXCOLORS   256</span>
00022 <span class="preprocessor"></span>
<a name="l00023"></a><a class="code" href="../../d4/d9/clres_8c.html#a3">00023</a> <span class="preprocessor">#define RESCLR_BLACK      0x00000000</span>
<a name="l00024"></a><a class="code" href="../../d4/d9/clres_8c.html#a4">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define RESCLR_WHITE      0x00FFFFFF</span>
00025 <span class="preprocessor"></span>
<a name="l00026"></a><a class="code" href="../../d7/d6/structRESOURCE__ACCEL.html">00026</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00027"></a><a class="code" href="../../d7/d6/structRESOURCE__ACCEL.html#o0">00027</a>     ACCEL accel;
<a name="l00028"></a><a class="code" href="../../d7/d6/structRESOURCE__ACCEL.html#o1">00028</a>     WORD  padding;
00029 } <a class="code" href="../../d7/d6/structRESOURCE__ACCEL.html">RESOURCE_ACCEL</a>, *<a class="code" href="../../d4/d9/clres_8c.html#a21">PRESOURCE_ACCEL</a>;
00030 
00031 <span class="comment">/*</span>
00032 <span class="comment"> * Bitmap resource IDs</span>
00033 <span class="comment"> */</span>
<a name="l00034"></a><a class="code" href="../../d4/d9/clres_8c.html#a5">00034</a> <span class="preprocessor">#define BMR_ICON    1</span>
<a name="l00035"></a><a class="code" href="../../d4/d9/clres_8c.html#a6">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define BMR_BITMAP  2</span>
<a name="l00036"></a><a class="code" href="../../d4/d9/clres_8c.html#a7">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define BMR_CURSOR  3</span>
00037 <span class="preprocessor"></span>
<a name="l00038"></a><a class="code" href="../../d1/d7/struct__OLDCURSOR.html">00038</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d7/struct__OLDCURSOR.html">_OLDCURSOR</a> {
<a name="l00039"></a><a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o0">00039</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o0">bType</a>;
<a name="l00040"></a><a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o1">00040</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o1">bFormat</a>;
<a name="l00041"></a><a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o2">00041</a>     WORD <a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o2">xHotSpot</a>;  <span class="comment">// 0 for icons</span>
<a name="l00042"></a><a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o3">00042</a>     WORD <a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o3">yHotSpot</a>;  <span class="comment">// 0 for icons</span>
<a name="l00043"></a><a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o4">00043</a>     WORD <a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o4">cx</a>;
<a name="l00044"></a><a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o5">00044</a>     WORD <a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o5">cy</a>;
<a name="l00045"></a><a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o6">00045</a>     WORD <a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o6">cxBytes</a>;
<a name="l00046"></a><a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o7">00046</a>     WORD <a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o7">wReserved2</a>;
<a name="l00047"></a><a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o8">00047</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d1/d7/struct__OLDCURSOR.html#o8">abBitmap</a>[1];
00048 } <a class="code" href="../../d1/d7/struct__OLDCURSOR.html">OLDCURSOR</a>, *<a class="code" href="../../d1/d7/struct__OLDCURSOR.html">POLDCURSOR</a>;
<a name="l00049"></a><a class="code" href="../../d4/d9/clres_8c.html#a24">00049</a> <span class="keyword">typedef</span> <a class="code" href="../../d1/d7/struct__OLDCURSOR.html">OLDCURSOR</a> UNALIGNED *<a class="code" href="../../d4/d9/clres_8c.html#a24">UPOLDCURSOR</a>;
00050 
00051 <span class="comment">/*</span>
00052 <span class="comment"> * Local Macros.</span>
00053 <span class="comment"> */</span>
<a name="l00054"></a><a class="code" href="../../d4/d9/clres_8c.html#a8">00054</a> <span class="preprocessor">#define GETINITDC() \</span>
00055 <span class="preprocessor">    (gfSystemInitialized ? NtUserGetDC(NULL) : CreateDCW(L"DISPLAY", L"", NULL, NULL))</span>
00056 <span class="preprocessor"></span>
<a name="l00057"></a><a class="code" href="../../d4/d9/clres_8c.html#a9">00057</a> <span class="preprocessor">#define RELEASEINITDC(hdc) \</span>
00058 <span class="preprocessor">    (gfSystemInitialized ? ReleaseDC(NULL, hdc) : DeleteDC(hdc))</span>
00059 <span class="preprocessor"></span>
<a name="l00060"></a><a class="code" href="../../d4/d9/clres_8c.html#a10">00060</a> <span class="preprocessor">#define ISRIFFFORMAT(p) \</span>
00061 <span class="preprocessor">    (((UNALIGNED RTAG *)(p))-&gt;ckID == FOURCC_RIFF)</span>
00062 <span class="preprocessor"></span>
<a name="l00063"></a><a class="code" href="../../d4/d9/clres_8c.html#a11">00063</a> <span class="preprocessor">#define MR_FAILFOR40    0x01</span>
<a name="l00064"></a><a class="code" href="../../d4/d9/clres_8c.html#a12">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define MR_MONOCHROME   0x02</span>
00065 <span class="preprocessor"></span>
00066 
<a name="l00067"></a><a class="code" href="../../d6/d0/structtagMAPRES.html">00067</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d0/structtagMAPRES.html">tagMAPRES</a> {
<a name="l00068"></a><a class="code" href="../../d6/d0/structtagMAPRES.html#o0">00068</a>     WORD <a class="code" href="../../d6/d0/structtagMAPRES.html#o0">idDisp</a>;                <span class="comment">// display driver ID</span>
<a name="l00069"></a><a class="code" href="../../d6/d0/structtagMAPRES.html#o1">00069</a>     WORD <a class="code" href="../../d6/d0/structtagMAPRES.html#o1">idUser</a>;                <span class="comment">// USER ID</span>
<a name="l00070"></a><a class="code" href="../../d6/d0/structtagMAPRES.html#o2">00070</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d6/d0/structtagMAPRES.html#o2">bFlags</a>;                <span class="comment">// Flags</span>
<a name="l00071"></a><a class="code" href="../../d6/d0/structtagMAPRES.html#o3">00071</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d6/d0/structtagMAPRES.html#o3">bReserved</a>;             <span class="comment">// unused</span>
00072 } <a class="code" href="../../d6/d0/structtagMAPRES.html">MAPRES</a>, *<a class="code" href="../../d6/d0/structtagMAPRES.html">LPMAPRES</a>, *<a class="code" href="../../d6/d0/structtagMAPRES.html">PMAPRES</a>;
00073 
00074 
00075 HBITMAP <a class="code" href="../../d4/d9/clres_8c.html#a28">CopyBmp</a>(HBITMAP hbmpOrg, <span class="keywordtype">int</span> cxNew, <span class="keywordtype">int</span> cyNew, UINT LR_flags);
00076 
00077 <span class="comment">/***************************************************************************\</span>
00078 <span class="comment">* SplFindResource</span>
00079 <span class="comment">*</span>
00080 <span class="comment">* Check whether the hInstance passed is that of the present display driver;</span>
00081 <span class="comment">* if so, it will call the GetDriverResourceId() in the display to allow</span>
00082 <span class="comment">* it to map the given id/name to a new id/name.  Then it will call</span>
00083 <span class="comment">* FindResource9) in KERNEL.</span>
00084 <span class="comment">*</span>
00085 <span class="comment">* 13-Nov-1995 SanfordS  Added mapping for DEFAULT constants.</span>
00086 <span class="comment">\***************************************************************************/</span>
00087 
<a name="l00088"></a><a class="code" href="../../d4/d9/clres_8c.html#a29">00088</a> HANDLE <a class="code" href="../../d4/d9/clres_8c.html#a29">SplFindResource</a>(
00089     HINSTANCE hmod,
00090     LPCWSTR   lpName,
00091     LPCWSTR   lpType)
00092 {
00093     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a126">FINDRESOURCEW</a>(hmod, lpName, lpType);
00094 }
00095 
00096 <span class="comment">/***************************************************************************\</span>
00097 <span class="comment">* SplFreeResource</span>
00098 <span class="comment">*</span>
00099 <span class="comment">* Really frees a resource that is shared (won't be touched again unless</span>
00100 <span class="comment">* LR_COPYFROMRESOURCE is used) or system.</span>
00101 <span class="comment">*</span>
00102 <span class="comment">* 13-Nov-1995 SanfordS  Added mapping for DEFAULT constants.</span>
00103 <span class="comment">\***************************************************************************/</span>
00104 
<a name="l00105"></a><a class="code" href="../../d4/d9/clres_8c.html#a30">00105</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d9/clres_8c.html#a30">SplFreeResource</a>(
00106     HANDLE    hRes,
00107     HINSTANCE hmod,
00108     UINT      lrFlags)
00109 {
00110     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a132">FREERESOURCE</a>(hRes, hmod) &amp;&amp;
00111         ((hmod == <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>) || (lrFlags &amp; LR_SHARED))) {
00112 
00113         <a class="code" href="../../d6/d0/usercli_8h.html#a132">FREERESOURCE</a>(hRes, hmod);
00114     }
00115 }
00116 
00117 <span class="comment">/***********************************************************************\</span>
00118 <span class="comment">* WowGetModuleFileName</span>
00119 <span class="comment">*</span>
00120 <span class="comment">* This converts a WOW or non-WOW module handle to a string form that</span>
00121 <span class="comment">* can be restored even for WOW handles.</span>
00122 <span class="comment">*</span>
00123 <span class="comment">* Returns: fSuccess</span>
00124 <span class="comment">*</span>
00125 <span class="comment">* 29-Nov-1995 SanfordS  Created.</span>
00126 <span class="comment">\***********************************************************************/</span>
00127 
<a name="l00128"></a><a class="code" href="../../d6/d0/usercli_8h.html#a647">00128</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a647">WowGetModuleFileName</a>(
00129     HMODULE hModule,
00130     LPWSTR  pwsz,
00131     DWORD   cchMax)
00132 {
00133     <span class="keywordflow">if</span> (!GetModuleFileName(hModule, pwsz, cchMax)) {
00134 
00135         <span class="keywordflow">if</span> (cchMax &lt; 10) {
00136             RIPMSG0(RIP_WARNING, <span class="stringliteral">"WowGetModuleFileName: exceeded Char-Max"</span>);
00137             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00138         }
00139 
00140         wsprintf(pwsz, TEXT(<span class="stringliteral">"\001%08lx"</span>), hModule);
00141     }
00142 
00143     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00144 }
00145 
00146 <span class="comment">/***********************************************************************\</span>
00147 <span class="comment">* WowGetModuleHandle</span>
00148 <span class="comment">*</span>
00149 <span class="comment">* This restores the string form of a module handle created by</span>
00150 <span class="comment">* WowGetModuleFileName to the original handle.</span>
00151 <span class="comment">*</span>
00152 <span class="comment">* Returns: fSuccess</span>
00153 <span class="comment">*</span>
00154 <span class="comment">* 29-Nov-1995 Created   SanfordS</span>
00155 <span class="comment">\***********************************************************************/</span>
00156 
<a name="l00157"></a><a class="code" href="../../d4/d9/clres_8c.html#a32">00157</a> HMODULE <a class="code" href="../../d4/d9/clres_8c.html#a32">WowGetModuleHandle</a>(
00158     LPCWSTR pwsz)
00159 {
00160     HMODULE hMod = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00161     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   digit;
00162 
00163     <span class="keywordflow">if</span> (pwsz[0] == TEXT(<span class="charliteral">'\001'</span>)) {
00164 
00165         <span class="comment">/*</span>
00166 <span class="comment">         * Cant seem to link to swscanf without CRT0 problems so just</span>
00167 <span class="comment">         * do it by hand.</span>
00168 <span class="comment">         */</span>
00169         <span class="keywordflow">while</span> (*(++pwsz)) {
00170 
00171             <span class="keywordflow">if</span> (*pwsz == TEXT(<span class="charliteral">' '</span>))
00172                 <span class="keywordflow">continue</span>;
00173 
00174             digit = *pwsz - TEXT(<span class="charliteral">'0'</span>);
00175 
00176             <span class="keywordflow">if</span> (digit &gt; 9)
00177                 digit += (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(TEXT(<span class="charliteral">'0'</span>) - TEXT(<span class="charliteral">'a'</span>) + 10);
00178 
00179             (ULONG_PTR)hMod &lt;&lt;= 4;
00180             (ULONG_PTR)hMod += digit;
00181         }
00182 
00183     } <span class="keywordflow">else</span> {
00184 
00185         hMod = GetModuleHandle(pwsz);
00186     }
00187 
00188     <span class="keywordflow">return</span> hMod;
00189 }
00190 
00191 <span class="comment">/***************************************************************************\</span>
00192 <span class="comment">* CreateAcceleratorTableA (API)</span>
00193 <span class="comment">*</span>
00194 <span class="comment">* Creates an accel table, returns handle to accel table.</span>
00195 <span class="comment">*</span>
00196 <span class="comment">* 02-May-1991 ScottLu   Created.</span>
00197 <span class="comment">\***************************************************************************/</span>
00198 
<a name="l00199"></a><a class="code" href="../../d4/d9/clres_8c.html#a33">00199</a> HACCEL WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a33">CreateAcceleratorTableA</a>(
00200     LPACCEL paccel,
00201     <span class="keywordtype">int</span>     cAccel)
00202 {
00203     <span class="keywordtype">int</span>     nAccel = cAccel;
00204     LPACCEL pAccelT = paccel;
00205 
00206     <span class="comment">/*</span>
00207 <span class="comment">     * Convert any character keys from ANSI to Unicode.</span>
00208 <span class="comment">     */</span>
00209     <span class="keywordflow">while</span> (nAccel--) {
00210 
00211         <span class="keywordflow">if</span> ((pAccelT-&gt;fVirt &amp; FVIRTKEY) == 0) {
00212 
00213             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d6/nlsxlat_8c.html#a33">RtlMultiByteToUnicodeN</a>((LPWSTR)&amp;(pAccelT-&gt;key),
00214                                                    <span class="keyword">sizeof</span>(WCHAR),
00215                                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00216                                                    (LPSTR)&amp;(pAccelT-&gt;key),
00217                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)))) {
00218                 pAccelT-&gt;key = 0xFFFF;
00219             }
00220         }
00221 
00222         pAccelT++;
00223     }
00224 
00225     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a153">NtUserCreateAcceleratorTable</a>(paccel, cAccel);
00226 }
00227 
00228 <span class="comment">/***************************************************************************\</span>
00229 <span class="comment">* CopyAcceleratorTableA (API)</span>
00230 <span class="comment">*</span>
00231 <span class="comment">* Copies an accel table</span>
00232 <span class="comment">*</span>
00233 <span class="comment">* 02-May-1991 ScottLu   Created.</span>
00234 <span class="comment">\***************************************************************************/</span>
00235 
<a name="l00236"></a><a class="code" href="../../d4/d9/clres_8c.html#a34">00236</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d9/clres_8c.html#a34">CopyAcceleratorTableA</a>(
00237     HACCEL hacc,
00238     LPACCEL paccel,
00239     <span class="keywordtype">int</span> length)
00240 {
00241     <span class="keywordtype">int</span> retval;
00242 
00243     retval = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a305">NtUserCopyAcceleratorTable</a>(hacc, paccel, length);
00244 
00245     <span class="comment">/*</span>
00246 <span class="comment">     * If we are doing a copy and we succeeded then convert the accelerator</span>
00247 <span class="comment">     */</span>
00248     <span class="keywordflow">if</span> ((paccel != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (retval &gt; 0)) {
00249 
00250         <span class="comment">/*</span>
00251 <span class="comment">         * Translate UNICODE character keys to ANSI</span>
00252 <span class="comment">         */</span>
00253         <span class="keywordtype">int</span> nAccel = retval;
00254         LPACCEL pAccelT = paccel;
00255 
00256         <span class="keywordflow">while</span> (nAccel--) {
00257             <span class="keywordflow">if</span> ((pAccelT-&gt;fVirt &amp; FVIRTKEY) == 0) {
00258                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d6/nlsxlat_8c.html#a37">RtlUnicodeToMultiByteN</a>((PCHAR)&amp;(pAccelT-&gt;key),
00259                                                        <span class="keyword">sizeof</span>(WCHAR),
00260                                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00261                                                        (PWSTR)&amp;(pAccelT-&gt;key),
00262                                                         <span class="keyword">sizeof</span>(pAccelT-&gt;key)))) {
00263                         pAccelT-&gt;key = 0;
00264                     }
00265                 }
00266             pAccelT++;
00267         }
00268     }
00269 
00270     <span class="keywordflow">return</span> retval;
00271 }
00272 
00273 <span class="comment">/***************************************************************************\</span>
00274 <span class="comment">* FindAccResource</span>
00275 <span class="comment">*</span>
00276 <span class="comment">* Resource accelerator tables are to be loaded only once to be compatible</span>
00277 <span class="comment">*  with Win95. So we keep track of the addresses we've loaded tables from</span>
00278 <span class="comment">*  and the corresponding handle.</span>
00279 <span class="comment">*</span>
00280 <span class="comment">* This function finds an entry in the table. It returns the address</span>
00281 <span class="comment">*  of the pacNext pointer that contains the requested entry.</span>
00282 <span class="comment">*</span>
00283 <span class="comment">* 01/31/97 GerardoB     Created.</span>
00284 <span class="comment">\***************************************************************************/</span>
<a name="l00285"></a><a class="code" href="../../d4/d9/clres_8c.html#a35">00285</a> <a class="code" href="../../d9/d7/structtagACCELCACHE.html">PACCELCACHE</a> * <a class="code" href="../../d4/d9/clres_8c.html#a35">FindAccResource</a> (HACCEL hAccel, PVOID pRes)
00286 {
00287      <span class="comment">/************************************</span>
00288 <span class="comment">     * The caller must own gcsAccelCache *</span>
00289 <span class="comment">     *************************************/</span>
00290 
00291     <a class="code" href="../../d9/d7/structtagACCELCACHE.html">PACCELCACHE</a> * ppacNext = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a66">gpac</a>;
00292     <a class="code" href="../../d9/d7/structtagACCELCACHE.html">PACCELCACHE</a> pac;
00293 
00294     <span class="comment">/*</span>
00295 <span class="comment">     * This is meant to search by handle or by pointer, not both</span>
00296 <span class="comment">     * So at least one of the parameters must be NULL.</span>
00297 <span class="comment">     */</span>
00298     UserAssert(!(hAccel &amp;&amp; pRes));
00299     <span class="comment">/*</span>
00300 <span class="comment">     * Walk the table</span>
00301 <span class="comment">     */</span>
00302     <span class="keywordflow">while</span> (*ppacNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00303         pac = *ppacNext;
00304         <span class="keywordflow">if</span> ((pac-&gt;<a class="code" href="../../d9/d7/structtagACCELCACHE.html#o3">pRes</a> == pRes) || (pac-&gt;<a class="code" href="../../d9/d7/structtagACCELCACHE.html#o2">hAccel</a> == hAccel)) {
00305             <span class="comment">/*</span>
00306 <span class="comment">            * Found it. Validate this entry before returning.</span>
00307 <span class="comment">            */</span>
00308             UserAssert(pac-&gt;<a class="code" href="../../d9/d7/structtagACCELCACHE.html#o1">dwLockCount</a> != 0);
00309             UserAssert(<a class="code" href="../../d1/d0/inc_2user_8h.html#a1179">HMValidateHandleNoDesktop</a>(pac-&gt;<a class="code" href="../../d9/d7/structtagACCELCACHE.html#o2">hAccel</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a244">TYPE_ACCELTABLE</a>));
00310             <span class="keywordflow">break</span>;
00311         }
00312 
00313         ppacNext = &amp;(pac-&gt;<a class="code" href="../../d9/d7/structtagACCELCACHE.html#o0">pacNext</a>);
00314     }
00315 
00316     <span class="keywordflow">return</span> ppacNext;
00317 }
00318 <span class="comment">/***************************************************************************\</span>
00319 <span class="comment">* AddAccResource</span>
00320 <span class="comment">*</span>
00321 <span class="comment">* This is called everytime LoadAcc loads a new table. It adds an</span>
00322 <span class="comment">*  entry (handle and resource address) to the global list and</span>
00323 <span class="comment">*  sets the lock count to 1</span>
00324 <span class="comment">*</span>
00325 <span class="comment">* 01/31/97 GerardoB     Created.</span>
00326 <span class="comment">\***************************************************************************/</span>
<a name="l00327"></a><a class="code" href="../../d4/d9/clres_8c.html#a36">00327</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d9/clres_8c.html#a36">AddAccResource</a> (HACCEL hAccel, PVOID pRes)
00328 {
00329     <a class="code" href="../../d9/d7/structtagACCELCACHE.html">PACCELCACHE</a> pac;
00330 
00331     UserAssert(<a class="code" href="../../d1/d0/inc_2user_8h.html#a1179">HMValidateHandleNoDesktop</a>(hAccel, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a244">TYPE_ACCELTABLE</a>));
00332     UserAssert(pRes != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00333 
00334     <span class="comment">/*</span>
00335 <span class="comment">     * Allocate and initialize a new entry.</span>
00336 <span class="comment">     */</span>
00337     pac = (<a class="code" href="../../d9/d7/structtagACCELCACHE.html">PACCELCACHE</a>)LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/structtagACCELCACHE.html">ACCELCACHE</a>));
00338     <span class="keywordflow">if</span> (pac != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00339         pac-&gt;<a class="code" href="../../d9/d7/structtagACCELCACHE.html#o1">dwLockCount</a> = 1;
00340         pac-&gt;<a class="code" href="../../d9/d7/structtagACCELCACHE.html#o2">hAccel</a> = hAccel;
00341         pac-&gt;<a class="code" href="../../d9/d7/structtagACCELCACHE.html#o3">pRes</a> = pRes;
00342 
00343         <span class="comment">/*</span>
00344 <span class="comment">         * Make it the new head of the list</span>
00345 <span class="comment">         */</span>
00346         RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a25">gcsAccelCache</a>);
00347             pac-&gt;<a class="code" href="../../d9/d7/structtagACCELCACHE.html#o0">pacNext</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a66">gpac</a>;
00348             <a class="code" href="../../d1/d8/clglobal_8c.html#a66">gpac</a> = pac;
00349         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a25">gcsAccelCache</a>);
00350 
00351     }
00352 }
00353 <span class="comment">/***************************************************************************\</span>
00354 <span class="comment">* DestroyAcceleratorTable</span>
00355 <span class="comment">*</span>
00356 <span class="comment">* 01/31/97 GerardoB     Created.</span>
00357 <span class="comment">\***************************************************************************/</span>
<a name="l00358"></a><a class="code" href="../../d4/d9/clres_8c.html#a37">00358</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d9/clres_8c.html#a37">DestroyAcceleratorTable</a> (HACCEL hAccel)
00359 {
00360     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fUnlocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00361     <a class="code" href="../../d9/d7/structtagACCELCACHE.html">PACCELCACHE</a> *ppacNext, pac;
00362 
00363     <span class="comment">/*</span>
00364 <span class="comment">     * If we added this table to our list, decrement the lock count</span>
00365 <span class="comment">     */</span>
00366     RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a25">gcsAccelCache</a>);
00367         ppacNext = <a class="code" href="../../d4/d9/clres_8c.html#a35">FindAccResource</a>(hAccel, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00368         <span class="keywordflow">if</span> (*ppacNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00369             pac = *ppacNext;
00370             <span class="comment">/*</span>
00371 <span class="comment">             * Found it. Decrement lock count.</span>
00372 <span class="comment">             */</span>
00373             UserAssert(pac-&gt;<a class="code" href="../../d9/d7/structtagACCELCACHE.html#o1">dwLockCount</a> != 0);
00374             fUnlocked = (--pac-&gt;<a class="code" href="../../d9/d7/structtagACCELCACHE.html#o1">dwLockCount</a> == 0);
00375             <span class="comment">/*</span>
00376 <span class="comment">             * If noboby else wants this around, unlink it and nuke it.</span>
00377 <span class="comment">             */</span>
00378             <span class="keywordflow">if</span> (fUnlocked) {
00379                 *ppacNext = pac-&gt;<a class="code" href="../../d9/d7/structtagACCELCACHE.html#o0">pacNext</a>;
00380                 LocalFree(pac);
00381             }
00382         }
00383     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a25">gcsAccelCache</a>);
00384 
00385     <span class="comment">/*</span>
00386 <span class="comment">     * If not totally deref'ed, return FALSE (win95 compat).</span>
00387 <span class="comment">     */</span>
00388     <span class="keywordflow">if</span> (fUnlocked) {
00389         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a155">NtUserDestroyAcceleratorTable</a>(hAccel);
00390     } <span class="keywordflow">else</span> {
00391         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00392     }
00393 }
00394 <span class="comment">/***************************************************************************\</span>
00395 <span class="comment">* LoadAcc (Worker)</span>
00396 <span class="comment">*</span>
00397 <span class="comment">* This is the worker-routine for loading accelerator tables.</span>
00398 <span class="comment">*</span>
00399 <span class="comment">\***************************************************************************/</span>
00400 
<a name="l00401"></a><a class="code" href="../../d4/d9/clres_8c.html#a13">00401</a> <span class="preprocessor">#define FACCEL_VALID (FALT | FCONTROL | FNOINVERT | FSHIFT | FVIRTKEY | FLASTKEY)</span>
00402 <span class="preprocessor"></span>
<a name="l00403"></a><a class="code" href="../../d4/d9/clres_8c.html#a38">00403</a> HANDLE <a class="code" href="../../d4/d9/clres_8c.html#a38">LoadAcc</a>(
00404     HINSTANCE hmod,
00405     HANDLE    hrl)
00406 {
00407     <a class="code" href="../../d9/d7/structtagACCELCACHE.html">PACCELCACHE</a> * ppacNext;
00408     HANDLE handle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00409 
00410     <span class="keywordflow">if</span> (hrl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00411 
00412         <span class="keywordflow">if</span> (hrl = <a class="code" href="../../d6/d0/usercli_8h.html#a129">LOADRESOURCE</a>(hmod, hrl)) {
00413 
00414             <a class="code" href="../../d4/d9/clres_8c.html#a21">PRESOURCE_ACCEL</a> paccel;
00415 
00416             <span class="keywordflow">if</span> ((paccel = (<a class="code" href="../../d4/d9/clres_8c.html#a21">PRESOURCE_ACCEL</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a130">LOCKRESOURCE</a>(hrl, hmod)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00417 
00418                 <span class="keywordtype">int</span> nAccel = 0;
00419                 <span class="keywordtype">int</span> i;
00420                 LPACCEL paccelT;
00421 
00422                 <span class="comment">/*</span>
00423 <span class="comment">                 * Check if we've already loaded accelerators from this</span>
00424 <span class="comment">                 *  same address</span>
00425 <span class="comment">                 */</span>
00426                 RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a25">gcsAccelCache</a>);
00427                     ppacNext = <a class="code" href="../../d4/d9/clres_8c.html#a35">FindAccResource</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, paccel);
00428                     <span class="keywordflow">if</span> (*ppacNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00429                         (*ppacNext)-&gt;dwLockCount++;
00430                         handle = (*ppacNext)-&gt;hAccel;
00431                     }
00432                 RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a25">gcsAccelCache</a>);
00433                 <span class="comment">/*</span>
00434 <span class="comment">                 * If we found this table on the global list,</span>
00435 <span class="comment">                 *  return the same handle (Win95 compat)</span>
00436 <span class="comment">                 */</span>
00437                 <span class="keywordflow">if</span> (handle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00438                     <span class="keywordflow">goto</span> UnlockAndFree;
00439                 }
00440 
00441                 <span class="keywordflow">while</span> (!((paccel[nAccel].accel.fVirt) &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a190">FLASTKEY</a>)) {
00442 
00443                     <span class="keywordflow">if</span> (paccel[nAccel].accel.fVirt &amp; ~<a class="code" href="../../d4/d9/clres_8c.html#a13">FACCEL_VALID</a>) {
00444                         RIPMSG0(RIP_WARNING, <span class="stringliteral">"LoadAcc: Invalid Parameter"</span>);
00445                         <span class="keywordflow">goto</span> UnlockAndFree;
00446                     }
00447 
00448                     nAccel++;
00449                 }
00450 
00451                 <span class="keywordflow">if</span> (paccel[nAccel].accel.fVirt &amp; ~<a class="code" href="../../d4/d9/clres_8c.html#a13">FACCEL_VALID</a>) {
00452                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"LoadAcc: Invalid Parameter"</span>);
00453                     <span class="keywordflow">goto</span> UnlockAndFree;
00454                 }
00455 
00456                 <span class="comment">/*</span>
00457 <span class="comment">                 * Since the accelerator table is coming from a resource, each</span>
00458 <span class="comment">                 * element has an extra WORD of padding which we strip here</span>
00459 <span class="comment">                 * to conform with the public (and internal) ACCEL structure.</span>
00460 <span class="comment">                 */</span>
00461                 paccelT = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, <span class="keyword">sizeof</span>(ACCEL) * (nAccel + 1));
00462                 <span class="keywordflow">if</span> (paccelT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00463                     <span class="keywordflow">goto</span> UnlockAndFree;
00464                 }
00465                 <span class="keywordflow">for</span> (i = 0; i &lt; nAccel + 1; i++) {
00466                     paccelT[i] = paccel[i].accel;
00467                 }
00468 
00469                 handle = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a153">NtUserCreateAcceleratorTable</a>(paccelT,
00470                                                       nAccel + 1);
00471 
00472                 <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(paccelT);
00473 
00474                 <span class="comment">/*</span>
00475 <span class="comment">                 * Add this handle/address to the global table so</span>
00476 <span class="comment">                 *  we won't load it twice.</span>
00477 <span class="comment">                 */</span>
00478                 <span class="keywordflow">if</span> (handle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00479                     <a class="code" href="../../d4/d9/clres_8c.html#a36">AddAccResource</a>(handle, paccel);
00480                 }
00481 UnlockAndFree:
00482 
00483                 <a class="code" href="../../d6/d0/usercli_8h.html#a131">UNLOCKRESOURCE</a>(hrl, hmod);
00484             }
00485 
00486             <a class="code" href="../../d6/d0/usercli_8h.html#a132">FREERESOURCE</a>(hrl, hmod);
00487         }
00488     }
00489 
00490     <span class="keywordflow">return</span> handle;
00491 }
00492 
00493 <span class="comment">/***************************************************************************\</span>
00494 <span class="comment">* LoadAcceleratorsA (API)</span>
00495 <span class="comment">* LoadAcceleratorsW (API)</span>
00496 <span class="comment">*</span>
00497 <span class="comment">*</span>
00498 <span class="comment">* 24-Sep-1990 MikeKe    From Win30</span>
00499 <span class="comment">\***************************************************************************/</span>
00500 
<a name="l00501"></a><a class="code" href="../../d4/d9/clres_8c.html#a39">00501</a> HACCEL WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a39">LoadAcceleratorsA</a>(
00502     HINSTANCE hmod,
00503     LPCSTR    lpAccName)
00504 {
00505     HANDLE hRes;
00506 
00507     hRes = <a class="code" href="../../d6/d0/usercli_8h.html#a125">FINDRESOURCEA</a>((HANDLE)hmod, lpAccName, (LPSTR)RT_ACCELERATOR);
00508 
00509     <span class="keywordflow">return</span> (HACCEL)<a class="code" href="../../d4/d9/clres_8c.html#a38">LoadAcc</a>(hmod, hRes);
00510 }
00511 
<a name="l00512"></a><a class="code" href="../../d4/d9/clres_8c.html#a40">00512</a> HACCEL WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a40">LoadAcceleratorsW</a>(
00513     HINSTANCE hmod,
00514     LPCWSTR   lpAccName)
00515 {
00516     HANDLE hRes;
00517 
00518     hRes = <a class="code" href="../../d6/d0/usercli_8h.html#a126">FINDRESOURCEW</a>((HANDLE)hmod, lpAccName, RT_ACCELERATOR);
00519 
00520     <span class="keywordflow">return</span> (HACCEL)<a class="code" href="../../d4/d9/clres_8c.html#a38">LoadAcc</a>(hmod, hRes);
00521 }
00522 
00523 <span class="comment">/***************************************************************************\</span>
00524 <span class="comment">* LoadStringA (API)</span>
00525 <span class="comment">* LoadStringW (API)</span>
00526 <span class="comment">*</span>
00527 <span class="comment">*</span>
00528 <span class="comment">* 05-Apr-1991 ScottLu   Fixed to work with client/server.</span>
00529 <span class="comment">\***************************************************************************/</span>
00530 
<a name="l00531"></a><a class="code" href="../../d4/d9/clres_8c.html#a41">00531</a> <span class="keywordtype">int</span> WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a41">LoadStringA</a>(
00532     HINSTANCE hmod,
00533     UINT      wID,
00534     LPSTR     lpAnsiBuffer,
00535     <span class="keywordtype">int</span>       cchBufferMax)
00536 {
00537     LPWSTR          lpUniBuffer;
00538     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>             cchUnicode;
00539     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>             cbAnsi = 0;
00540 
00541     <span class="comment">/*</span>
00542 <span class="comment">     * LoadStringOrError appends a NULL but does not include it in the</span>
00543 <span class="comment">     * return count-of-bytes</span>
00544 <span class="comment">     */</span>
00545     cchUnicode = <a class="code" href="../../d6/d0/usercli_8h.html#a427">LoadStringOrError</a>((HANDLE)hmod,
00546                                       wID,
00547                                       (LPWSTR)&amp;lpUniBuffer,
00548                                       0,
00549                                       0);
00550 
00551     <span class="keywordflow">if</span> (cchUnicode) {
00552 
00553         cbAnsi = WCSToMB(lpUniBuffer,
00554                          cchUnicode,
00555                          &amp;lpAnsiBuffer,
00556                          cchBufferMax - 1,
00557                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00558 
00559         cbAnsi = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(cbAnsi, cchBufferMax - 1);
00560     }
00561 
00562     <span class="comment">/*</span>
00563 <span class="comment">     * Append a NULL but do not include it in the count returned</span>
00564 <span class="comment">     */</span>
00565     lpAnsiBuffer[cbAnsi] = 0;
00566     <span class="keywordflow">return</span> cbAnsi;
00567 }
00568 
<a name="l00569"></a><a class="code" href="../../d4/d9/clres_8c.html#a42">00569</a> <span class="keywordtype">int</span> WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a42">LoadStringW</a>(
00570     HINSTANCE hmod,
00571     UINT      wID,
00572     LPWSTR    lpBuffer,
00573     <span class="keywordtype">int</span>       cchBufferMax)
00574 {
00575     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a427">LoadStringOrError</a>((HANDLE)hmod,
00576                                 wID,
00577                                 lpBuffer,
00578                                 cchBufferMax,
00579                                 0);
00580 }
00581 
00582 <span class="comment">/***************************************************************************\</span>
00583 <span class="comment">* SkipIDorString</span>
00584 <span class="comment">*</span>
00585 <span class="comment">* Skips string (or ID) and returns the next aligned WORD.</span>
00586 <span class="comment">*</span>
00587 <span class="comment">\***************************************************************************/</span>
00588 
<a name="l00589"></a><a class="code" href="../../d4/d9/clres_8c.html#a43">00589</a> <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> <a class="code" href="../../d4/d9/clres_8c.html#a43">SkipIDorString</a>(
00590     LPBYTE pb)
00591 {
00592     <span class="keywordflow">if</span> (*((LPWORD)pb) == 0xFFFF)
00593         <span class="keywordflow">return</span> (pb + 4);
00594 
00595     <span class="keywordflow">while</span> (*((PWCHAR)pb)++ != 0);
00596 
00597     <span class="keywordflow">return</span> pb;
00598 }
00599 
00600 <span class="comment">/***************************************************************************\</span>
00601 <span class="comment">* GetSizeDialogTemplate</span>
00602 <span class="comment">*</span>
00603 <span class="comment">* This gets called by thank produced stubs. It returns the size of a</span>
00604 <span class="comment">* dialog template.</span>
00605 <span class="comment">*</span>
00606 <span class="comment">* 07-Apr-1991 ScottLu   Created.</span>
00607 <span class="comment">\***************************************************************************/</span>
00608 
<a name="l00609"></a><a class="code" href="../../d4/d9/clres_8c.html#a44">00609</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d9/clres_8c.html#a44">GetSizeDialogTemplate</a>(
00610     HINSTANCE      hmod,
00611     LPCDLGTEMPLATE pdt)
00612 {
00613     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>           cdit;
00614     LPBYTE         pb;
00615     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           fChicago;
00616     LPDLGTEMPLATE2 pdt2;
00617 
00618     <span class="keywordflow">if</span> (HIWORD(pdt-&gt;style) == 0xFFFF) {
00619 
00620         pdt2 = (LPDLGTEMPLATE2)pdt;
00621         fChicago = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00622 
00623         <span class="comment">/*</span>
00624 <span class="comment">         * Fail if the app is passing invalid style bits.</span>
00625 <span class="comment">         */</span>
00626         <span class="keywordflow">if</span> (pdt2-&gt;style &amp; ~(DS_VALID40 | 0xffff0000)) {
00627             RIPMSG0(RIP_WARNING, <span class="stringliteral">"Bad dialog style bits - please remove"</span>);
00628             <span class="keywordflow">return</span> 0;
00629         }
00630 
00631         pb = (LPBYTE)(((LPDLGTEMPLATE2)pdt) + 1);
00632 
00633     } <span class="keywordflow">else</span> {
00634 
00635         fChicago = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00636 
00637         <span class="comment">/*</span>
00638 <span class="comment">         * Check if invalid style bits are being passed. Fail if the app</span>
00639 <span class="comment">         * is a new app ( &gt;= VER40).</span>
00640 <span class="comment">         * This is to ensure that we are compatible with Chicago.</span>
00641 <span class="comment">         */</span>
00642         <span class="keywordflow">if</span> ((pdt-&gt;style &amp; ~(DS_VALID40 | 0xffff0000)) &amp;&amp;
00643                 (<a class="code" href="../../d6/d0/usercli_8h.html#a134">GETEXPWINVER</a>(hmod) &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>)) {
00644 
00645             <span class="comment">/*</span>
00646 <span class="comment">             * It's a new app with invalid style bits - fail.</span>
00647 <span class="comment">             */</span>
00648             RIPMSG0(RIP_WARNING, <span class="stringliteral">"Bad dialog style bits - please remove"</span>);
00649             <span class="keywordflow">return</span> 0;
00650         }
00651 
00652         pb = (LPBYTE)(pdt + 1);
00653     }
00654 
00655     <span class="comment">/*</span>
00656 <span class="comment">     * If there is a menu ordinal, add 4 bytes skip it. Otherwise it is a</span>
00657 <span class="comment">     * string or just a 0.</span>
00658 <span class="comment">     */</span>
00659     pb = <a class="code" href="../../d4/d9/clres_8c.html#a43">SkipIDorString</a>(pb);
00660 
00661     <span class="comment">/*</span>
00662 <span class="comment">     * Skip window class and window text, adjust to next word boundary.</span>
00663 <span class="comment">     */</span>
00664     pb = <a class="code" href="../../d4/d9/clres_8c.html#a43">SkipIDorString</a>(pb);
00665     pb = <a class="code" href="../../d4/d9/clres_8c.html#a43">SkipIDorString</a>(pb);
00666 
00667     <span class="comment">/*</span>
00668 <span class="comment">     * Skip font type, size and name, adjust to next dword boundary.</span>
00669 <span class="comment">     */</span>
00670     <span class="keywordflow">if</span> ((fChicago ? pdt2-&gt;style : pdt-&gt;style) &amp; DS_SETFONT) {
00671         pb += fChicago ? <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) + <span class="keyword">sizeof</span>(WORD): <span class="keyword">sizeof</span>(WORD);
00672         pb = <a class="code" href="../../d4/d9/clres_8c.html#a43">SkipIDorString</a>(pb);
00673     }
00674     pb = (LPBYTE)(((ULONG_PTR)pb + 3) &amp; ~3);
00675 
00676     <span class="comment">/*</span>
00677 <span class="comment">     * Loop through dialog items now...</span>
00678 <span class="comment">     */</span>
00679     cdit = fChicago ? pdt2-&gt;cDlgItems : pdt-&gt;cdit;
00680 
00681     <span class="keywordflow">while</span> (cdit-- != 0) {
00682 
00683         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cbCreateParams;
00684 
00685         pb += fChicago ? <span class="keyword">sizeof</span>(DLGITEMTEMPLATE2) : <span class="keyword">sizeof</span>(DLGITEMTEMPLATE);
00686 
00687         <span class="comment">/*</span>
00688 <span class="comment">         * Skip the dialog control class name.</span>
00689 <span class="comment">         */</span>
00690         pb = <a class="code" href="../../d4/d9/clres_8c.html#a43">SkipIDorString</a>(pb);
00691 
00692         <span class="comment">/*</span>
00693 <span class="comment">         * Look at window text now.</span>
00694 <span class="comment">         */</span>
00695         pb = <a class="code" href="../../d4/d9/clres_8c.html#a43">SkipIDorString</a>(pb);
00696 
00697         cbCreateParams = *((LPWORD)pb);
00698 
00699         <span class="comment">/*</span>
00700 <span class="comment">         * skip any CreateParams which include the generated size WORD.</span>
00701 <span class="comment">         */</span>
00702         <span class="keywordflow">if</span> (cbCreateParams)
00703             pb += cbCreateParams;
00704 
00705         pb += <span class="keyword">sizeof</span>(WORD);
00706 
00707         <span class="comment">/*</span>
00708 <span class="comment">         * Point at the next dialog item. (DWORD aligned)</span>
00709 <span class="comment">         */</span>
00710         pb = (LPBYTE)(((ULONG_PTR)pb + 3) &amp; ~3);
00711     }
00712 
00713     <span class="comment">/*</span>
00714 <span class="comment">     * Return template size.</span>
00715 <span class="comment">     */</span>
00716     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(pb - (LPBYTE)pdt);
00717 }
00718 
00719 <span class="comment">/***************************************************************************\</span>
00720 <span class="comment">* DialogBoxIndirectParamA (API)</span>
00721 <span class="comment">* DialogBoxIndirectParamW (API)</span>
00722 <span class="comment">*</span>
00723 <span class="comment">* Creates the dialog and goes into a modal loop processing input for it.</span>
00724 <span class="comment">*</span>
00725 <span class="comment">* 05-Apr-1991 ScottLu   Created.</span>
00726 <span class="comment">\***************************************************************************/</span>
00727 
<a name="l00728"></a><a class="code" href="../../d4/d9/clres_8c.html#a45">00728</a> INT_PTR WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a45">DialogBoxIndirectParamA</a>(
00729     HINSTANCE       hmod,
00730     LPCDLGTEMPLATEA lpDlgTemplate,
00731     HWND            hwndOwner,
00732     DLGPROC         lpDialogFunc,
00733     LPARAM          dwInitParam)
00734 {
00735     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a47">DialogBoxIndirectParamAorW</a>(hmod,
00736                                       (LPCDLGTEMPLATEW)lpDlgTemplate,
00737                                       hwndOwner,
00738                                       lpDialogFunc,
00739                                       dwInitParam,
00740                                       SCDLG_ANSI);
00741 }
00742 
<a name="l00743"></a><a class="code" href="../../d4/d9/clres_8c.html#a46">00743</a> INT_PTR WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a46">DialogBoxIndirectParamW</a>(
00744     HINSTANCE       hmod,
00745     LPCDLGTEMPLATEW lpDlgTemplate,
00746     HWND            hwndOwner,
00747     DLGPROC         lpDialogFunc,
00748     LPARAM          dwInitParam)
00749 {
00750     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a47">DialogBoxIndirectParamAorW</a>(hmod,
00751                                       lpDlgTemplate,
00752                                       hwndOwner,
00753                                       lpDialogFunc,
00754                                       dwInitParam,
00755                                       0);
00756 }
00757 
<a name="l00758"></a><a class="code" href="../../d4/d9/clres_8c.html#a47">00758</a> INT_PTR WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a47">DialogBoxIndirectParamAorW</a>(
00759     HINSTANCE       hmod,
00760     LPCDLGTEMPLATEW lpDlgTemplate,
00761     HWND            hwndOwner,
00762     DLGPROC         lpDialogFunc,
00763     LPARAM          dwInitParam,
00764     UINT            fAnsiFlags)
00765 {
00766     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cb;
00767 
00768     <span class="comment">/*</span>
00769 <span class="comment">     * The server routine destroys the menu if it fails.</span>
00770 <span class="comment">     */</span>
00771     cb = <a class="code" href="../../d4/d9/clres_8c.html#a44">GetSizeDialogTemplate</a>(hmod, lpDlgTemplate);
00772 
00773     <span class="keywordflow">if</span> (!cb) {
00774         RIPMSG0(RIP_WARNING, <span class="stringliteral">"DialogBoxIndirectParam: Invalid Paramter"</span>);
00775         <span class="keywordflow">return</span> -1;
00776     }
00777 
00778     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a751">InternalDialogBox</a>(hmod,
00779                             (LPDLGTEMPLATE)lpDlgTemplate,
00780                             hwndOwner,
00781                             lpDialogFunc,
00782                             dwInitParam,
00783                             SCDLG_CLIENT | (fAnsiFlags &amp; (SCDLG_ANSI | SCDLG_16BIT)));
00784 }
00785 
00786 <span class="comment">/***************************************************************************\</span>
00787 <span class="comment">* CreateDialogIndirectParamA (API)</span>
00788 <span class="comment">* CreateDialogIndirectParamW (API)</span>
00789 <span class="comment">*</span>
00790 <span class="comment">* Creates a dialog given a template and return s the window handle.</span>
00791 <span class="comment">* fAnsi determines if the dialog has an ANSI or UNICODE lpDialogFunc</span>
00792 <span class="comment">*</span>
00793 <span class="comment">* 05-Apr-1991 ScottLu   Created.</span>
00794 <span class="comment">\***************************************************************************/</span>
00795 
<a name="l00796"></a><a class="code" href="../../d4/d9/clres_8c.html#a48">00796</a> HWND WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a48">CreateDialogIndirectParamA</a>(
00797     HINSTANCE       hmod,
00798     LPCDLGTEMPLATEA lpDlgTemplate,
00799     HWND            hwndOwner,
00800     DLGPROC         lpDialogFunc,
00801     LPARAM          dwInitParam)
00802 {
00803     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a50">CreateDialogIndirectParamAorW</a>(hmod,
00804                                          (LPCDLGTEMPLATE)lpDlgTemplate,
00805                                          hwndOwner,
00806                                          lpDialogFunc,
00807                                          dwInitParam,
00808                                          SCDLG_ANSI);
00809 }
00810 
<a name="l00811"></a><a class="code" href="../../d4/d9/clres_8c.html#a49">00811</a> HWND WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a49">CreateDialogIndirectParamW</a>(
00812     HINSTANCE       hmod,
00813     LPCDLGTEMPLATEW lpDlgTemplate,
00814     HWND            hwndOwner,
00815     DLGPROC         lpDialogFunc,
00816     LPARAM          dwInitParam)
00817 {
00818     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a50">CreateDialogIndirectParamAorW</a>(hmod,
00819                                          (LPCDLGTEMPLATE)lpDlgTemplate,
00820                                          hwndOwner,
00821                                          lpDialogFunc,
00822                                          dwInitParam,
00823                                          0);
00824 }
00825 
<a name="l00826"></a><a class="code" href="../../d4/d9/clres_8c.html#a50">00826</a> HWND WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a50">CreateDialogIndirectParamAorW</a>(
00827     HANDLE         hmod,
00828     LPCDLGTEMPLATE lpDlgTemplate,
00829     HWND           hwndOwner,
00830     DLGPROC        lpDialogFunc,
00831     LPARAM         dwInitParam,
00832     UINT           fAnsi)
00833 {
00834     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cb;
00835     HWND  hwndRet;
00836 
00837     <span class="comment">/*</span>
00838 <span class="comment">     * The server routine destroys the menu if it fails.</span>
00839 <span class="comment">     */</span>
00840     cb = <a class="code" href="../../d4/d9/clres_8c.html#a44">GetSizeDialogTemplate</a>(hmod, lpDlgTemplate);
00841 
00842     <span class="keywordflow">if</span> (!cb) {
00843         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateDialogIndirect: Invalid Parameter"</span>);
00844         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00845     }
00846 
00847     hwndRet = <a class="code" href="../../d6/d0/usercli_8h.html#a750">InternalCreateDialog</a>(hmod,
00848                                    (LPDLGTEMPLATE)lpDlgTemplate,
00849                                    cb,
00850                                    hwndOwner,
00851                                    lpDialogFunc,
00852                                    dwInitParam,
00853                                    SCDLG_CLIENT | (fAnsi &amp; (SCDLG_ANSI|SCDLG_16BIT)));
00854 
00855     <span class="keywordflow">return</span> hwndRet;
00856 }
00857 
00858 <span class="comment">/***************************************************************************\</span>
00859 <span class="comment">* DialogBoxParamA (API)</span>
00860 <span class="comment">* DialogBoxParamW (API)</span>
00861 <span class="comment">*</span>
00862 <span class="comment">* Loads the resource, creates the dialog and goes into a modal loop processing</span>
00863 <span class="comment">* input for it.</span>
00864 <span class="comment">*</span>
00865 <span class="comment">* 05-Apr-1991 ScottLu   Created.</span>
00866 <span class="comment">\***************************************************************************/</span>
00867 
<a name="l00868"></a><a class="code" href="../../d4/d9/clres_8c.html#a51">00868</a> INT_PTR WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a51">DialogBoxParamA</a>(
00869     HINSTANCE hmod,
00870     LPCSTR    lpName,
00871     HWND      hwndOwner,
00872     DLGPROC   lpDialogFunc,
00873     LPARAM    dwInitParam)
00874 {
00875     HANDLE h;
00876     PVOID  p;
00877     INT_PTR i = -1;
00878 
00879     <span class="keywordflow">if</span> (h = <a class="code" href="../../d6/d0/usercli_8h.html#a125">FINDRESOURCEA</a>(hmod, (LPSTR)lpName, (LPSTR)RT_DIALOG)) {
00880 
00881         <span class="keywordflow">if</span> (h = <a class="code" href="../../d6/d0/usercli_8h.html#a129">LOADRESOURCE</a>(hmod, h)) {
00882 
00883             <span class="keywordflow">if</span> (p = <a class="code" href="../../d6/d0/usercli_8h.html#a130">LOCKRESOURCE</a>(h, hmod)) {
00884 
00885                 i = <a class="code" href="../../d4/d9/clres_8c.html#a47">DialogBoxIndirectParamAorW</a>(hmod,
00886                                                p,
00887                                                hwndOwner,
00888                                                lpDialogFunc,
00889                                                dwInitParam,
00890                                                SCDLG_ANSI);
00891 
00892                 <a class="code" href="../../d6/d0/usercli_8h.html#a131">UNLOCKRESOURCE</a>(h, hmod);
00893             }
00894 
00895             <a class="code" href="../../d6/d0/usercli_8h.html#a132">FREERESOURCE</a>(h, hmod);
00896         }
00897     }
00898 
00899     <span class="keywordflow">return</span> i;
00900 }
00901 
<a name="l00902"></a><a class="code" href="../../d4/d9/clres_8c.html#a52">00902</a> INT_PTR WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a52">DialogBoxParamW</a>(
00903     HINSTANCE hmod,
00904     LPCWSTR   lpName,
00905     HWND      hwndOwner,
00906     DLGPROC   lpDialogFunc,
00907     LPARAM    dwInitParam)
00908 {
00909     HANDLE h;
00910     PVOID  p;
00911     INT_PTR i = -1;
00912 
00913     UserAssert(LOWORD(hmod) == 0); <span class="comment">// This should never be a WOW module</span>
00914 
00915     <span class="keywordflow">if</span> (h = <a class="code" href="../../d6/d0/usercli_8h.html#a126">FINDRESOURCEW</a>(hmod, lpName, RT_DIALOG)) {
00916 
00917         <span class="keywordflow">if</span> (p = LoadResource(hmod, h)) {
00918 
00919             i = <a class="code" href="../../d4/d9/clres_8c.html#a47">DialogBoxIndirectParamAorW</a>(hmod,
00920                                            p,
00921                                            hwndOwner,
00922                                            lpDialogFunc,
00923                                            dwInitParam,
00924                                            0);
00925         }
00926     }
00927 
00928     <span class="keywordflow">return</span> i;
00929 }
00930 
00931 <span class="comment">/***************************************************************************\</span>
00932 <span class="comment">* CreateDialogParamA (API)</span>
00933 <span class="comment">* CreateDialogParamW (API)</span>
00934 <span class="comment">*</span>
00935 <span class="comment">* Loads the resource, creates a dialog from that template, return s the</span>
00936 <span class="comment">* window handle.</span>
00937 <span class="comment">*</span>
00938 <span class="comment">* 05-Apr-1991 ScottLu   Created.</span>
00939 <span class="comment">\***************************************************************************/</span>
00940 
<a name="l00941"></a><a class="code" href="../../d4/d9/clres_8c.html#a53">00941</a> HWND WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a53">CreateDialogParamA</a>(
00942     HINSTANCE hmod,
00943     LPCSTR    lpName,
00944     HWND      hwndOwner,
00945     DLGPROC   lpDialogFunc,
00946     LPARAM    dwInitParam)
00947 {
00948     HANDLE         h;
00949     LPDLGTEMPLATEA p;
00950     HWND           hwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00951 
00952     <span class="keywordflow">if</span> (h = <a class="code" href="../../d6/d0/usercli_8h.html#a125">FINDRESOURCEA</a>(hmod, lpName, (LPSTR)RT_DIALOG)) {
00953 
00954         <span class="keywordflow">if</span> (h = <a class="code" href="../../d6/d0/usercli_8h.html#a129">LOADRESOURCE</a>(hmod, h)) {
00955 
00956             <span class="keywordflow">if</span> (p = (LPDLGTEMPLATEA)<a class="code" href="../../d6/d0/usercli_8h.html#a130">LOCKRESOURCE</a>(h, hmod)) {
00957 
00958                 hwnd = <a class="code" href="../../d4/d9/clres_8c.html#a50">CreateDialogIndirectParamAorW</a>(hmod,
00959                                                      (LPCDLGTEMPLATE)p,
00960                                                      hwndOwner,
00961                                                      lpDialogFunc,
00962                                                      dwInitParam,
00963                                                      SCDLG_ANSI);
00964 
00965                 <a class="code" href="../../d6/d0/usercli_8h.html#a131">UNLOCKRESOURCE</a>(h, hmod);
00966             }
00967 
00968             <a class="code" href="../../d6/d0/usercli_8h.html#a132">FREERESOURCE</a>(h, hmod);
00969         }
00970     }
00971 
00972     <span class="keywordflow">return</span> hwnd;
00973 }
00974 
<a name="l00975"></a><a class="code" href="../../d4/d9/clres_8c.html#a54">00975</a> HWND WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a54">CreateDialogParamW</a>(
00976     HINSTANCE hmod,
00977     LPCWSTR   lpName,
00978     HWND      hwndOwner,
00979     DLGPROC   lpDialogFunc,
00980     LPARAM    dwInitParam)
00981 {
00982     HANDLE h;
00983     PVOID  p;
00984     HWND   hwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00985 
00986     <span class="keywordflow">if</span> (h = <a class="code" href="../../d6/d0/usercli_8h.html#a126">FINDRESOURCEW</a>(hmod, lpName, RT_DIALOG)) {
00987 
00988         <span class="keywordflow">if</span> (h = <a class="code" href="../../d6/d0/usercli_8h.html#a129">LOADRESOURCE</a>(hmod, h)) {
00989 
00990             <span class="keywordflow">if</span> (p = <a class="code" href="../../d6/d0/usercli_8h.html#a130">LOCKRESOURCE</a>(h, hmod)) {
00991 
00992                 hwnd = <a class="code" href="../../d4/d9/clres_8c.html#a50">CreateDialogIndirectParamAorW</a>(hmod,
00993                                                      p,
00994                                                      hwndOwner,
00995                                                      lpDialogFunc,
00996                                                      dwInitParam,
00997                                                      0);
00998 
00999                 <a class="code" href="../../d6/d0/usercli_8h.html#a131">UNLOCKRESOURCE</a>(h, hmod);
01000             }
01001 
01002             <a class="code" href="../../d6/d0/usercli_8h.html#a132">FREERESOURCE</a>(h, hmod);
01003         }
01004     }
01005 
01006     <span class="keywordflow">return</span> hwnd;
01007 }
01008 
01009 <span class="comment">/***************************************************************************\</span>
01010 <span class="comment">* DestroyCursor (API)</span>
01011 <span class="comment">*</span>
01012 <span class="comment">* Client wrapper for NtUserDestroyCursor.</span>
01013 <span class="comment">*</span>
01014 <span class="comment">* 28-Nov-1994 JimA      Created.</span>
01015 <span class="comment">\***************************************************************************/</span>
01016 
<a name="l01017"></a><a class="code" href="../../d4/d9/clres_8c.html#a55">01017</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a55">DestroyCursor</a>(
01018     HCURSOR hcur)
01019 {
01020     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">NtUserDestroyCursor</a>(hcur, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a532">CURSOR_CALLFROMCLIENT</a>);
01021 }
01022 
01023 <span class="comment">/***************************************************************************\</span>
01024 <span class="comment">* CreateIcoCur</span>
01025 <span class="comment">*</span>
01026 <span class="comment">*</span>
01027 <span class="comment">\***************************************************************************/</span>
01028 
<a name="l01029"></a><a class="code" href="../../d4/d9/clres_8c.html#a56">01029</a> HICON <a class="code" href="../../d4/d9/clres_8c.html#a56">CreateIcoCur</a>(
01030     <a class="code" href="../../d8/d1/structtagCURSORDATA.html">PCURSORDATA</a> lpi)
01031 {
01032     HCURSOR hcur;
01033 
01034     UserAssert(lpi-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o11">hbmColor</a> || lpi-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o10">hbmMask</a>);
01035 
01036     hcur = (HCURSOR)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>((lpi-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o0">CURSORF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a535">CURSORF_GLOBAL</a>),
01037                                        SFI__CREATEEMPTYCURSOROBJECT);
01038 
01039     <span class="keywordflow">if</span> (hcur == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01040         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01041 
01042 <span class="preprocessor">#if DBG</span>
01043 <span class="preprocessor"></span>    {
01044         BITMAP bmMask;
01045         BITMAP bmColor;
01046 
01047         UserAssert(GetObject(lpi-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o10">hbmMask</a>, <span class="keyword">sizeof</span>(BITMAP), &amp;bmMask));
01048         
01049         <span class="comment">/* Bug 252902 - joejo</span>
01050 <span class="comment">         * Since the width and height of the mask bitmap is set below</span>
01051 <span class="comment">         * we really don't need to assert on the width/height check. Throwing</span>
01052 <span class="comment">         * a warning should be good enough.</span>
01053 <span class="comment">         */</span>
01054         <span class="keywordflow">if</span> (bmMask.bmWidth != (LONG)lpi-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o6">cx</a>) {
01055            RIPMSG1(RIP_WARNING, <span class="stringliteral">"Mask width not equal to requested width: lpi %#p"</span>, lpi);
01056         }
01057 
01058         <span class="keywordflow">if</span> (bmMask.bmHeight != (LONG)lpi-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o7">cy</a>) {
01059            RIPMSG1(RIP_WARNING, <span class="stringliteral">"Mask height not equal to requested height: lpi %#p"</span>, lpi);
01060         }
01061 
01062         <span class="keywordflow">if</span> (lpi-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o11">hbmColor</a>) {
01063             UserAssert(GetObject(lpi-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o11">hbmColor</a>, <span class="keyword">sizeof</span>(BITMAP), &amp;bmColor));
01064             UserAssert(bmMask.bmHeight == bmColor.bmHeight * 2);
01065             UserAssert(bmMask.bmWidth  == bmColor.bmWidth);
01066         }
01067     }
01068 <span class="preprocessor">#endif</span>
01069 <span class="preprocessor"></span>
01070     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1114">_SetCursorIconData</a>(hcur, lpi))
01071         <span class="keywordflow">return</span> hcur;
01072 
01073     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">NtUserDestroyCursor</a>(hcur, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a531">CURSOR_ALWAYSDESTROY</a>);
01074 
01075     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01076 }
01077 
01078 <span class="comment">/***************************************************************************\</span>
01079 <span class="comment">* CreateIcoCurIndirect</span>
01080 <span class="comment">*</span>
01081 <span class="comment">*</span>
01082 <span class="comment">\***************************************************************************/</span>
01083 
<a name="l01084"></a><a class="code" href="../../d4/d9/clres_8c.html#a57">01084</a> HCURSOR <a class="code" href="../../d4/d9/clres_8c.html#a57">CreateIcoCurIndirect</a>(
01085     <a class="code" href="../../d8/d1/structtagCURSORDATA.html">PCURSORDATA</a> pcurCreate,
01086     UINT        cPlanes,
01087     UINT        cBitsPixel,
01088     CONST BYTE  *lpANDbits,
01089     CONST BYTE  *lpXORbits)
01090 {
01091     <span class="keywordtype">int</span>     cbBits;
01092     HCURSOR hcurNew;
01093     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    bColor;
01094     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    cx;
01095     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
01096     LPBYTE  pBits = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01097 
01098     <span class="comment">/*</span>
01099 <span class="comment">     * Allocate CURSOR structure.</span>
01100 <span class="comment">     */</span>
01101     hcurNew = (HCURSOR)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(0, SFI__CREATEEMPTYCURSOROBJECT);
01102 
01103     <span class="keywordflow">if</span> (hcurNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01104         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01105 
01106     <span class="comment">/*</span>
01107 <span class="comment">     * If there is no Color bitmap, create a single buffer that contains both</span>
01108 <span class="comment">     * the AND and XOR bits.  The AND bitmap is always MonoChrome</span>
01109 <span class="comment">     */</span>
01110     bColor = (cPlanes | cBitsPixel) &gt; 1;
01111 
01112     <span class="keywordflow">if</span> (!bColor) {
01113 
01114         cbBits = (((pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o6">cx</a> + 0x0F) &amp; ~0x0F) &gt;&gt; 3) * pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o7">cy</a>;
01115 
01116         pBits = (LPBYTE)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, (cbBits * 2));
01117 
01118         <span class="keywordflow">if</span> (pBits == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01119             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">NtUserDestroyCursor</a>(hcurNew, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a531">CURSOR_ALWAYSDESTROY</a>);
01120             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01121         }
01122 
01123         RtlCopyMemory(pBits, lpANDbits, cbBits);
01124         RtlCopyMemory(pBits + cbBits, lpXORbits, cbBits);
01125         lpANDbits = pBits;
01126     }
01127 
01128     <span class="comment">/*</span>
01129 <span class="comment">     * Create hbmMask (its always MonoChrome)</span>
01130 <span class="comment">     */</span>
01131     cx = pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o6">cx</a>;
01132     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o7">cy</a> * 2;
01133 
01134     pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o10">hbmMask</a> = CreateBitmap(cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, 1, 1, lpANDbits);
01135 
01136     <span class="keywordflow">if</span> (pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o10">hbmMask</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01137 
01138         <span class="comment">/*</span>
01139 <span class="comment">         * If this is a COLOR icon/cursor, lpANDBits doesn't need to be</span>
01140 <span class="comment">         * pcurCreate-&gt;cy * 2; indeed, we don't use this double height at all.</span>
01141 <span class="comment">         * This is a bug that will be fixed post 4.0.</span>
01142 <span class="comment">         * For now, let's try to handle the case where the CreateBitmap call</span>
01143 <span class="comment">         * failed because the caller didn't pass in a double height AND mask</span>
01144 <span class="comment">         * (Win95 doesn't have this bug)</span>
01145 <span class="comment">         */</span>
01146         <span class="keywordflow">if</span> (bColor) {
01147 
01148             RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateIcoCurIndirect: Retrying hbmMask creation."</span>);
01149 
01150             cbBits = (((pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o6">cx</a> + 0x0F) &amp; ~0x0F) &gt;&gt; 3) * pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o7">cy</a>;
01151             pBits = (LPBYTE)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, cbBits*2);
01152 
01153             <span class="keywordflow">if</span> (pBits == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01154                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">NtUserDestroyCursor</a>(hcurNew, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a531">CURSOR_ALWAYSDESTROY</a>);
01155                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01156             }
01157 
01158             RtlCopyMemory(pBits, lpANDbits, cbBits);
01159             pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o10">hbmMask</a> = CreateBitmap(cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, 1, 1, pBits);
01160             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pBits);
01161 
01162             pBits = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01163         }
01164 
01165         <span class="keywordflow">if</span> (pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o10">hbmMask</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01166 
01167             <span class="comment">/*</span>
01168 <span class="comment">             * CreateBitmap() failed.  Clean-up and get out of here.</span>
01169 <span class="comment">             */</span>
01170             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">NtUserDestroyCursor</a>(hcurNew, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a531">CURSOR_ALWAYSDESTROY</a>);
01171 
01172             <span class="keywordflow">if</span> (pBits != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01173                 <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pBits);
01174 
01175             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01176         }
01177     }
01178 
01179     <span class="comment">/*</span>
01180 <span class="comment">     * Create hbmColor or NULL it so that CallOEMCursor doesn't think we are</span>
01181 <span class="comment">     * color.</span>
01182 <span class="comment">     */</span>
01183     <span class="keywordflow">if</span> (bColor) {
01184         pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o11">hbmColor</a> = CreateBitmap(cx,
01185                                             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> / 2,
01186                                             cPlanes,
01187                                             cBitsPixel,
01188                                             lpXORbits);
01189 
01190         <span class="keywordflow">if</span> (pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o11">hbmColor</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01191 
01192             <span class="comment">/*</span>
01193 <span class="comment">             * CreateBitmap() failed.  Clean-up and get out of here.</span>
01194 <span class="comment">             */</span>
01195             DeleteObject(pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o10">hbmMask</a>);
01196             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">NtUserDestroyCursor</a>(hcurNew, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a531">CURSOR_ALWAYSDESTROY</a>);
01197             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01198         }
01199 
01200         pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o5">bpp</a> = (cPlanes * cBitsPixel);
01201 
01202     } <span class="keywordflow">else</span> {
01203         pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o11">hbmColor</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01204         pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o5">bpp</a>      = 1;
01205     }
01206 
01207     <span class="comment">/*</span>
01208 <span class="comment">     * Load contents into the cursor/icon object</span>
01209 <span class="comment">     */</span>
01210     pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o7">cy</a>            = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
01211     pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o2">lpModName</a>     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01212     pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o1">lpName</a>        = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01213     pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o3">rt</a>            = 0;
01214     pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o0">CURSORF_flags</a> = 0;
01215 
01216     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1114">_SetCursorIconData</a>(hcurNew, pcurCreate)) {
01217         <span class="keywordflow">if</span> (pBits != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01218             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pBits);
01219         <span class="keywordflow">return</span> hcurNew;
01220     }
01221 
01222     <span class="comment">/*</span>
01223 <span class="comment">     * Could not set up cursor/icon, so free resources.</span>
01224 <span class="comment">     */</span>
01225     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">NtUserDestroyCursor</a>(hcurNew, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a531">CURSOR_ALWAYSDESTROY</a>);
01226     DeleteObject(pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o10">hbmMask</a>);
01227 
01228     <span class="keywordflow">if</span> (pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o11">hbmColor</a>)
01229         DeleteObject(pcurCreate-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o11">hbmColor</a>);
01230     <span class="keywordflow">if</span> (pBits != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01231         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pBits);
01232 
01233     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01234 }
01235 
01236 <span class="comment">/***************************************************************************\</span>
01237 <span class="comment">* CreateCursor (API)</span>
01238 <span class="comment">*</span>
01239 <span class="comment">* History:</span>
01240 <span class="comment">* 26-Feb-1991 MikeKe    Created.</span>
01241 <span class="comment">* 01-Aug-1991 IanJa     Init cur.pszModname or DestroyCursor will work</span>
01242 <span class="comment">\***************************************************************************/</span>
01243 
<a name="l01244"></a><a class="code" href="../../d4/d9/clres_8c.html#a58">01244</a> HCURSOR WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a58">CreateCursor</a>(
01245     HINSTANCE hModule,
01246     <span class="keywordtype">int</span>       iXhotspot,
01247     <span class="keywordtype">int</span>       iYhotspot,
01248     <span class="keywordtype">int</span>       iWidth,
01249     <span class="keywordtype">int</span>       iHeight,
01250     LPBYTE    lpANDplane,
01251     LPBYTE    lpXORplane)
01252 {
01253     <a class="code" href="../../d8/d1/structtagCURSORDATA.html">CURSORDATA</a> cur;
01254     UNREFERENCED_PARAMETER(hModule);
01255 
01256     <span class="keywordflow">if</span> ((iXhotspot &lt; 0) || (iXhotspot &gt; iWidth) ||
01257         (iYhotspot &lt; 0) || (iYhotspot &gt; iHeight)) {
01258         <span class="keywordflow">return</span> 0;
01259     }
01260 
01261     RtlZeroMemory(&amp;cur, <span class="keyword">sizeof</span>(cur));
01262     cur.xHotspot = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)iXhotspot;
01263     cur.yHotspot = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)iYhotspot;
01264     cur.cx       = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)iWidth;
01265     cur.cy       = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)iHeight;
01266 
01267     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a57">CreateIcoCurIndirect</a>(&amp;cur, 1, 1, lpANDplane, lpXORplane);
01268 }
01269 
01270 <span class="comment">/***************************************************************************\</span>
01271 <span class="comment">* CreateIcon (API)</span>
01272 <span class="comment">*</span>
01273 <span class="comment">* History:</span>
01274 <span class="comment">* 26-Feb-1991 MikeKe    Created.</span>
01275 <span class="comment">* 01-Aug-1991 IanJa     Init cur.pszModname so DestroyIcon will work</span>
01276 <span class="comment">\***************************************************************************/</span>
01277 
<a name="l01278"></a><a class="code" href="../../d4/d9/clres_8c.html#a59">01278</a> HICON WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a59">CreateIcon</a>(
01279     HINSTANCE  hModule,
01280     <span class="keywordtype">int</span>        iWidth,
01281     <span class="keywordtype">int</span>        iHeight,
01282     BYTE       planes,
01283     BYTE       bpp,
01284     CONST BYTE *lpANDplane,
01285     CONST BYTE *lpXORplane)
01286 {
01287     <a class="code" href="../../d8/d1/structtagCURSORDATA.html">CURSORDATA</a> cur;
01288     UNREFERENCED_PARAMETER(hModule);
01289 
01290     RtlZeroMemory(&amp;cur, <span class="keyword">sizeof</span>(cur));
01291     cur.xHotspot = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(iWidth / 2);
01292     cur.yHotspot = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(iHeight / 2);
01293     cur.cx       = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)iWidth;
01294     cur.cy       = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)iHeight;
01295 
01296     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a57">CreateIcoCurIndirect</a>(&amp;cur, planes, bpp, lpANDplane, lpXORplane);
01297 }
01298 
01299 <span class="comment">/***************************************************************************\</span>
01300 <span class="comment">* CreateIconIndirect (API)</span>
01301 <span class="comment">*</span>
01302 <span class="comment">* Creates an icon or cursor from an ICONINFO structure. Does not destroy</span>
01303 <span class="comment">* cursor/icon bitmaps.</span>
01304 <span class="comment">*</span>
01305 <span class="comment">* 24-Jul-1991 ScottLu   Created.</span>
01306 <span class="comment">\***************************************************************************/</span>
<a name="l01307"></a><a class="code" href="../../d4/d9/clres_8c.html#a60">01307</a> HICON WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a60">CreateIconIndirect</a>(
01308     PICONINFO piconinfo)
01309 {
01310     HCURSOR    hcur;
01311     <a class="code" href="../../d8/d1/structtagCURSORDATA.html">CURSORDATA</a> cur;
01312     BITMAP     bmMask;
01313     BITMAP     bmColor;
01314     HBITMAP    hbmpBits2, hbmpMem;
01315     HDC        hdcMem;
01316 
01317     <span class="comment">/*</span>
01318 <span class="comment">     * Make sure the bitmaps are real, and get their dimensions.</span>
01319 <span class="comment">     */</span>
01320     <span class="keywordflow">if</span> (!GetObjectW(piconinfo-&gt;hbmMask, <span class="keyword">sizeof</span>(BITMAP), &amp;bmMask))
01321         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01322 
01323     <span class="keywordflow">if</span> (piconinfo-&gt;hbmColor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01324         <span class="keywordflow">if</span> (!GetObjectW(piconinfo-&gt;hbmColor, <span class="keyword">sizeof</span>(BITMAP), &amp;bmColor))
01325             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01326     }
01327 
01328     <span class="comment">/*</span>
01329 <span class="comment">     * Allocate CURSOR structure.</span>
01330 <span class="comment">     */</span>
01331     hcur = (HCURSOR)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(0, SFI__CREATEEMPTYCURSOROBJECT);
01332     <span class="keywordflow">if</span> (hcur == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01333         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01334 
01335     <span class="comment">/*</span>
01336 <span class="comment">     * Internally, USER stores the height as 2 icons high - because when</span>
01337 <span class="comment">     * loading bits from a resource, in both b/w and color icons, the</span>
01338 <span class="comment">     * bits are stored on top of one another (AND/XOR mask, AND/COLOR bitmap).</span>
01339 <span class="comment">     * When bitmaps are passed in to CreateIconIndirect(), they are passed</span>
01340 <span class="comment">     * as two bitmaps in the color case, and one bitmap (with the stacked</span>
01341 <span class="comment">     * masks) in the black and white case.  Adjust cur.cy so it is 2 icons</span>
01342 <span class="comment">     * high in both cases.</span>
01343 <span class="comment">     */</span>
01344 
01345     RtlZeroMemory(&amp;cur, <span class="keyword">sizeof</span>(cur));
01346     cur.cx = bmMask.bmWidth;
01347 
01348     <span class="keywordflow">if</span> (piconinfo-&gt;hbmColor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01349 
01350         cur.cy  = bmMask.bmHeight;
01351         cur.bpp = 1;
01352 
01353     } <span class="keywordflow">else</span> {
01354         cur.cy       = bmMask.bmHeight * 2;
01355         cur.bpp      = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(bmColor.bmBitsPixel * bmColor.bmPlanes);
01356         cur.hbmColor = <a class="code" href="../../d4/d9/clres_8c.html#a28">CopyBmp</a>(piconinfo-&gt;hbmColor, 0, 0, LR_DEFAULTCOLOR);
01357 
01358         <span class="keywordflow">if</span> (cur.hbmColor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01359             RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateIconIndirect: Failed to copy piconinfo-&gt;hbmColor"</span>);
01360             <span class="keywordflow">goto</span> CleanUp;
01361         }
01362     }
01363 
01364     <span class="comment">/*</span>
01365 <span class="comment">     * hbmMask must always be double height, even for color icons.</span>
01366 <span class="comment">     * So cy might be equal to bmMask.bmHeight * 2 at this point.</span>
01367 <span class="comment">     * If this is the case, the second half of hbmMask won't be initilized;</span>
01368 <span class="comment">     * nobody is supposed to use it but GDI expects it there when checking the</span>
01369 <span class="comment">     * bitmap dimensions (for cursors)</span>
01370 <span class="comment">     */</span>
01371     cur.hbmMask  =  CreateBitmap(cur.cx, cur.cy, 1, 1, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01372 
01373     <span class="keywordflow">if</span> (cur.hbmMask == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01374         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateIconIndirect: Failed to create cur.hbmMask"</span>);
01375         <span class="keywordflow">goto</span> CleanUp;
01376     }
01377 
01378     RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
01379 
01380 
01381     <span class="keywordflow">if</span> (hdcMem = CreateCompatibleDC (<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>)) {
01382 
01383         hbmpMem = SelectObject(hdcMem, cur.hbmMask);
01384         hbmpBits2 = SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, piconinfo-&gt;hbmMask);
01385 
01386         BitBlt(hdcMem,
01387                0,
01388                0,
01389                bmMask.bmWidth,
01390                bmMask.bmHeight,
01391                <a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,
01392                0,
01393                0,
01394                SRCCOPY);
01395 
01396         SelectObject(hdcMem, hbmpMem);
01397         SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, hbmpBits2);
01398         DeleteDC (hdcMem);
01399 
01400     } <span class="keywordflow">else</span> {
01401 
01402         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
01403         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateIconIndirect: CreateCompatibleDC failed"</span>);
01404         <span class="keywordflow">goto</span> CleanUp;
01405     }
01406 
01407     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
01408 
01409     <span class="comment">/*</span>
01410 <span class="comment">     * rt and Hotspot</span>
01411 <span class="comment">     */</span>
01412     <span class="keywordflow">if</span> (piconinfo-&gt;fIcon) {
01413         cur.rt        = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_ICON);
01414         cur.xHotspot = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(cur.cx / 2);
01415         cur.yHotspot = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(cur.cy / 4);
01416     } <span class="keywordflow">else</span> {
01417         cur.rt        = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_CURSOR);
01418         cur.xHotspot = ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)piconinfo-&gt;xHotspot);
01419         cur.yHotspot = ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)piconinfo-&gt;yHotspot);
01420     }
01421 
01422 
01423     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1114">_SetCursorIconData</a>(hcur, &amp;cur)) {
01424         <span class="keywordflow">return</span> hcur;
01425     }
01426 
01427 CleanUp:
01428     <span class="comment">/*</span>
01429 <span class="comment">     * Note that if this fails, the bitmaps have NOT been made public.</span>
01430 <span class="comment">     */</span>
01431     <span class="keywordflow">if</span> (cur.hbmMask != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01432         DeleteObject(cur.hbmMask);
01433     }
01434     <span class="keywordflow">if</span> (cur.hbmColor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01435         DeleteObject(cur.hbmColor);
01436     }
01437 
01438     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">NtUserDestroyCursor</a>(hcur, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a531">CURSOR_ALWAYSDESTROY</a>);
01439     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01440 }
01441 
01442 <span class="comment">/***************************************************************************\</span>
01443 <span class="comment">* GetIconInfo (API)</span>
01444 <span class="comment">*</span>
01445 <span class="comment">* Returns icon information, including bitmaps.</span>
01446 <span class="comment">*</span>
01447 <span class="comment">* 24-Jul-1991 ScottLu   Created.</span>
01448 <span class="comment">\***************************************************************************/</span>
01449 
<a name="l01450"></a><a class="code" href="../../d4/d9/clres_8c.html#a61">01450</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a61">GetIconInfo</a>(
01451     HICON     hicon,
01452     PICONINFO piconinfo)
01453 {
01454     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a105">NtUserGetIconInfo</a>(hicon, piconinfo, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01455 }
01456 
01457 <span class="comment">/***************************************************************************\</span>
01458 <span class="comment">* GetCursorFrameInfo (API)</span>
01459 <span class="comment">*</span>
01460 <span class="comment">* Returns cursor information.</span>
01461 <span class="comment">*</span>
01462 <span class="comment">* 24-Jul-1991 ScottLu   Created.</span>
01463 <span class="comment">\***************************************************************************/</span>
01464 
<a name="l01465"></a><a class="code" href="../../d4/d9/clres_8c.html#a62">01465</a> HCURSOR WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a62">GetCursorFrameInfo</a>(
01466     HCURSOR hcur,
01467     LPWSTR  lpName,
01468     <span class="keywordtype">int</span>     iFrame,
01469     LPDWORD pjifRate,
01470     LPINT   pccur)
01471 {
01472     <span class="comment">/*</span>
01473 <span class="comment">     * Caller wants us to return the version of this cursor that is stored</span>
01474 <span class="comment">     * in the display driver.</span>
01475 <span class="comment">     */</span>
01476     <span class="keywordflow">if</span> (hcur == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01477 
01478         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a655">LoadIcoCur</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01479                           lpName,
01480                           RT_CURSOR,
01481                           0,
01482                           0,
01483                           LR_DEFAULTSIZE);
01484     }
01485 
01486     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a268">NtUserGetCursorFrameInfo</a>(hcur, iFrame, pjifRate, pccur);
01487 }
01488 
01489 <span class="comment">/***************************************************************************\</span>
01490 <span class="comment">* _FreeResource   (API)</span>
01491 <span class="comment">* _LockResource   (API)</span>
01492 <span class="comment">* _UnlockResource (API)</span>
01493 <span class="comment">*</span>
01494 <span class="comment">* These are dummy routines that need to exist for the apfnResCallNative</span>
01495 <span class="comment">* array, which is used when calling the run-time libraries.</span>
01496 <span class="comment">*</span>
01497 <span class="comment">\***************************************************************************/</span>
01498 
<a name="l01499"></a><a class="code" href="../../d6/d0/usercli_8h.html#a412">01499</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a412">_FreeResource</a>(
01500     HANDLE    hResData,
01501     HINSTANCE hModule)
01502 {
01503     UNREFERENCED_PARAMETER(hResData);
01504     UNREFERENCED_PARAMETER(hModule);
01505 
01506     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01507 }
01508 
<a name="l01509"></a><a class="code" href="../../d6/d0/usercli_8h.html#a413">01509</a> LPSTR WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a413">_LockResource</a>(
01510     HANDLE    hResData,
01511     HINSTANCE hModule)
01512 {
01513     UNREFERENCED_PARAMETER(hModule);
01514 
01515     <span class="keywordflow">return</span> (LPSTR)(hResData);
01516 }
01517 
<a name="l01518"></a><a class="code" href="../../d6/d0/usercli_8h.html#a414">01518</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a414">_UnlockResource</a>(
01519     HANDLE    hResData,
01520     HINSTANCE hModule)
01521 {
01522     UNREFERENCED_PARAMETER(hResData);
01523     UNREFERENCED_PARAMETER(hModule);
01524 
01525     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01526 }
01527 
01528 <span class="comment">/***************************************************************************\</span>
01529 <span class="comment">* LookupIconIdFromDirectory (API)</span>
01530 <span class="comment">*</span>
01531 <span class="comment">* This searches through an icon directory for the icon that best fits the</span>
01532 <span class="comment">* current display device.</span>
01533 <span class="comment">*</span>
01534 <span class="comment">* 24-07-1991 ScottLu    Created.</span>
01535 <span class="comment">\***************************************************************************/</span>
01536 
<a name="l01537"></a><a class="code" href="../../d4/d9/clres_8c.html#a66">01537</a> <span class="keywordtype">int</span> WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a66">LookupIconIdFromDirectory</a>(
01538     PBYTE presbits,
01539     BOOL  fIcon)
01540 {
01541     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a67">LookupIconIdFromDirectoryEx</a>(presbits, fIcon, 0, 0, 0);
01542 }
01543 
01544 <span class="comment">/***************************************************************************\</span>
01545 <span class="comment">* LookupIconIdFromDirectoryEx (API)</span>
01546 <span class="comment">*</span>
01547 <span class="comment">*</span>
01548 <span class="comment">\***************************************************************************/</span>
01549 
<a name="l01550"></a><a class="code" href="../../d4/d9/clres_8c.html#a67">01550</a> <span class="keywordtype">int</span> WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a67">LookupIconIdFromDirectoryEx</a>(
01551     PBYTE           presbits,
01552     BOOL            fIcon,
01553     <span class="keywordtype">int</span>             cxDesired,
01554     <span class="keywordtype">int</span>             cyDesired,
01555     UINT            LR_flags)
01556 {
01557     <a class="code" href="../../d1/d0/inc_2user_8h.html#a848">ConnectIfNecessary</a>();
01558 
01559     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a428">RtlGetIdFromDirectory</a>(presbits,
01560                                  fIcon,
01561                                  cxDesired,
01562                                  cyDesired,
01563                                  LR_flags,
01564                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01565 }
01566 <span class="comment">/***************************************************************************\</span>
01567 <span class="comment">* LoadCursorIconFromResource (API)</span>
01568 <span class="comment">*</span>
01569 <span class="comment">* Loads animated icon/cursor from a pointer to a resource</span>
01570 <span class="comment">*</span>
01571 <span class="comment">* 02-20-1996 GerardoB    Created.</span>
01572 <span class="comment">\***************************************************************************/</span>
<a name="l01573"></a><a class="code" href="../../d4/d9/clres_8c.html#a68">01573</a> HANDLE <a class="code" href="../../d4/d9/clres_8c.html#a68">LoadCursorIconFromResource</a>(
01574     PBYTE   presbits,
01575     LPCWSTR lpName,
01576     <span class="keywordtype">int</span>     cxDesired,
01577     <span class="keywordtype">int</span>     cyDesired,
01578     UINT    LR_flags)
01579 {
01580     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     fAni;
01581     <a class="code" href="../../d1/d2/struct__FILEINFO.html">FILEINFO</a> fi;
01582     LPWSTR   lpwszRT;
01583 
01584     fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a> = presbits;
01585     fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o1">pFilePtr</a> = fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a>;
01586     fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o2">pFileEnd</a> = fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a> + <span class="keyword">sizeof</span> (RTAG) + ((RTAG *)presbits)-&gt;ckSize;
01587     fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o3">pszName</a>  = lpName;
01588 
01589     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a651">LoadCursorIconFromFileMap</a>(&amp;fi,
01590                                      &amp;lpwszRT,
01591                                      cxDesired,
01592                                      cyDesired,
01593                                      LR_flags,
01594                                      &amp;fAni);
01595 }
01596 <span class="comment">/***************************************************************************\</span>
01597 <span class="comment">* CreateIconFromResource (API)</span>
01598 <span class="comment">*</span>
01599 <span class="comment">* Takes resource bits and creates either an icon or cursor.</span>
01600 <span class="comment">*</span>
01601 <span class="comment">* 24-07-1991 ScottLu    Created.</span>
01602 <span class="comment">\***************************************************************************/</span>
01603 
<a name="l01604"></a><a class="code" href="../../d4/d9/clres_8c.html#a69">01604</a> HICON WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a69">CreateIconFromResource</a>(
01605     PBYTE presbits,
01606     DWORD dwResSize,
01607     BOOL  fIcon,
01608     DWORD dwVer)
01609 {
01610     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a70">CreateIconFromResourceEx</a>(presbits,
01611                                     dwResSize,
01612                                     fIcon,
01613                                     dwVer,
01614                                     0,
01615                                     0,
01616                                     LR_DEFAULTSIZE | LR_SHARED);
01617 }
01618 
01619 <span class="comment">/***************************************************************************\</span>
01620 <span class="comment">* CreateIconFromResourceEx (API)</span>
01621 <span class="comment">*</span>
01622 <span class="comment">* Takes resource bits and creates either an icon or cursor.</span>
01623 <span class="comment">*</span>
01624 <span class="comment">* 30-Aug-1994 FritzS    Created</span>
01625 <span class="comment">\***************************************************************************/</span>
01626 
<a name="l01627"></a><a class="code" href="../../d4/d9/clres_8c.html#a70">01627</a> HICON WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a70">CreateIconFromResourceEx</a>(
01628     PBYTE presbits,
01629     DWORD dwResSize,
01630     BOOL  fIcon,
01631     DWORD dwVer,
01632     <span class="keywordtype">int</span>   cxDesired,
01633     <span class="keywordtype">int</span>   cyDesired,
01634     UINT  LR_flags)
01635 {
01636     UNREFERENCED_PARAMETER(dwResSize);
01637 
01638     <span class="comment">/*</span>
01639 <span class="comment">     * NT Specific code to validate the version.</span>
01640 <span class="comment">     */</span>
01641     <span class="keywordflow">if</span> ((dwVer &lt; 0x00020000) || (dwVer &gt; 0x00030000)) {
01642         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateIconFromResourceEx: Invalid Paramter"</span>);
01643         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01644     }
01645 
01646     <span class="comment">/*</span>
01647 <span class="comment">     * Set desired size of resource based on flags and/or true</span>
01648 <span class="comment">     * dimensions passed in.</span>
01649 <span class="comment">     */</span>
01650     cxDesired = <a class="code" href="../../d6/d0/usercli_8h.html#a652">GetIcoCurWidth</a>(cxDesired , fIcon, LR_flags, 0);
01651     cyDesired = <a class="code" href="../../d6/d0/usercli_8h.html#a653">GetIcoCurHeight</a>(cyDesired, fIcon, LR_flags, 0);
01652 
01653     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/clres_8c.html#a10">ISRIFFFORMAT</a>(presbits)) {
01654         <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a68">LoadCursorIconFromResource</a> (presbits, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, cxDesired, cyDesired, LR_flags);
01655     } <span class="keywordflow">else</span> {
01656         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a660">ConvertDIBIcon</a>((LPBITMAPINFOHEADER)presbits,
01657                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01658                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01659                               fIcon,
01660                               cxDesired,
01661                               cyDesired,
01662                               LR_flags);
01663     }
01664 }
01665 
01666 <span class="comment">/***************************************************************************\</span>
01667 <span class="comment">* Convert1BppToMonoBitmap</span>
01668 <span class="comment">*</span>
01669 <span class="comment">* This routine converts a 1bpp bitmap to a true monochrome surface.  This</span>
01670 <span class="comment">* is done for bitmaps which need to do foreground/background color matching</span>
01671 <span class="comment">* at output time.  Otherwise, a 1bpp will just match to its palette.</span>
01672 <span class="comment">*</span>
01673 <span class="comment">* NOTE: This routine deletes the original bitmap if successful.  If failure</span>
01674 <span class="comment">*       we'll return the original bitmap.</span>
01675 <span class="comment">*</span>
01676 <span class="comment">* History:</span>
01677 <span class="comment">* 17-Apr-1996 ChrisWil  Created</span>
01678 <span class="comment">\***************************************************************************/</span>
01679 
<a name="l01680"></a><a class="code" href="../../d4/d9/clres_8c.html#a71">01680</a> HBITMAP <a class="code" href="../../d4/d9/clres_8c.html#a71">Convert1BppToMonoBitmap</a>(
01681     HDC     hdcSrc,
01682     HBITMAP hbm1Bpp)
01683 {
01684     HBITMAP hbmMono = hbm1Bpp;
01685     HBITMAP hbmDst;
01686     HBITMAP hbmS;
01687     HBITMAP hbmD;
01688     HDC     hdcDst;
01689     BITMAP  bm;
01690 
01691     <span class="keywordflow">if</span> (hdcDst = CreateCompatibleDC(hdcSrc)) {
01692 
01693         GetObject(hbm1Bpp, <span class="keyword">sizeof</span>(BITMAP), &amp;bm);
01694 
01695         <span class="keywordflow">if</span> (hbmDst = CreateBitmap(bm.bmWidth, bm.bmHeight, 1, 1, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01696 
01697             hbmS = SelectBitmap(hdcSrc, hbm1Bpp);
01698             hbmD = SelectBitmap(hdcDst, hbmDst);
01699 
01700             BitBlt(hdcDst,
01701                    0,
01702                    0,
01703                    bm.bmWidth,
01704                    bm.bmHeight,
01705                    hdcSrc,
01706                    0,
01707                    0,
01708                    SRCCOPY);
01709 
01710             SelectBitmap(hdcSrc, hbmS);
01711             SelectBitmap(hdcDst, hbmD);
01712 
01713             hbmMono = hbmDst;
01714             DeleteObject(hbm1Bpp);
01715         }
01716 
01717         DeleteDC(hdcDst);
01718     }
01719 
01720     <span class="keywordflow">return</span> hbmMono;
01721 }
01722 
01723 <span class="comment">/***************************************************************************\</span>
01724 <span class="comment">* CreateScreenBitmap</span>
01725 <span class="comment">*</span>
01726 <span class="comment">* This routine creates a screen bitmap.  We use the CreateDIBitmap call</span>
01727 <span class="comment">* to do compatible color-matching with Win95.  Also, note that this</span>
01728 <span class="comment">* routine takes in WORD aligned bits.</span>
01729 <span class="comment">*</span>
01730 <span class="comment">\***************************************************************************/</span>
01731 
<a name="l01732"></a><a class="code" href="../../d4/d9/clres_8c.html#a72">01732</a> HBITMAP <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a28">CreateScreenBitmap</a>(
01733     <span class="keywordtype">int</span>    cx,
01734     <span class="keywordtype">int</span>    cy,
01735     UINT   planes,
01736     UINT   bpp,
01737     LPSTR  lpBits,
01738     LPBOOL pf1Bpp)
01739 {
01740     HDC     hdcScreen;
01741     HBITMAP hbm = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01742     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwCount;
01743 
01744     <span class="keyword">static</span> <span class="keyword">struct </span>{
01745         BITMAPINFOHEADER bi;
01746         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            ct[16];
01747     } dib4Vga = {{<span class="keyword">sizeof</span>(BITMAPINFOHEADER),
01748                   0,
01749                   0,
01750                   1,
01751                   4,
01752                   BI_RGB,
01753                   0,
01754                   0,
01755                   0,
01756                   16,
01757                   0
01758                  },
01759                  {0x00000000,
01760                   0x00800000,
01761                   0x00008000,
01762                   0x00808000,
01763                   0x00000080,
01764                   0x00800080,
01765                   0x00008080,
01766                   0x00C0C0C0,
01767                   0x00808080,
01768                   0x00FF0000,
01769                   0x0000FF00,
01770                   0x00FFFF00,
01771                   0x000000FF,
01772                   0x00FF00FF,
01773                   0x0000FFFF,
01774                   0x00FFFFFF
01775                  }
01776                 };
01777 
01778     <span class="keyword">static</span> <span class="keyword">struct </span>{
01779         BITMAPINFOHEADER bi;
01780         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            ct[2];
01781     } dib1Vga = {{<span class="keyword">sizeof</span>(BITMAPINFOHEADER),
01782                   0,
01783                   0,
01784                   1,
01785                   1,
01786                   BI_RGB,
01787                   0,
01788                   0,
01789                   0,
01790                   2,
01791                   0
01792                  },
01793                  {0x00000000,
01794                   0x00FFFFFF
01795                  }
01796                 };
01797 
01798 
01799     <span class="comment">/*</span>
01800 <span class="comment">     * Create the surface.</span>
01801 <span class="comment">     */</span>
01802     <span class="keywordflow">if</span> (hdcScreen = <a class="code" href="../../d4/d9/clres_8c.html#a8">GETINITDC</a>()) {
01803 
01804         <span class="comment">/*</span>
01805 <span class="comment">         * This appears to mess up color to mono conversion by losing all</span>
01806 <span class="comment">         * the data and forcing all non-forground colors to black.</span>
01807 <span class="comment">         * (try copyimage with IDC_WARNING_DEFAULT)</span>
01808 <span class="comment">         * This is what win95 does but their system works.  The scary thing</span>
01809 <span class="comment">         * (according to marke) is that win95 may have changed GDI to make</span>
01810 <span class="comment">         * this work.</span>
01811 <span class="comment">         *</span>
01812 <span class="comment">         * In order to get nearest-color-matching compatible with Win95,</span>
01813 <span class="comment">         * we're going to need to use the CreateDIBitmap() for mono-surfaces.</span>
01814 <span class="comment">         * This code-path will do nearest-color, rather than color-matching.</span>
01815 <span class="comment">         */</span>
01816         <span class="keywordflow">if</span> ((bpp == 1) &amp;&amp; (planes == 1)) {
01817 
01818             dib1Vga.bi.biWidth  = cx;
01819             dib1Vga.bi.biHeight = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
01820 
01821             hbm = CreateDIBitmap(hdcScreen,
01822                                  (LPBITMAPINFOHEADER)&amp;dib1Vga,
01823                                  CBM_CREATEDIB,
01824                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01825                                  (LPBITMAPINFO)&amp;dib1Vga,
01826                                  DIB_RGB_COLORS);
01827 
01828             *pf1Bpp = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01829 
01830         } <span class="keywordflow">else</span> {
01831 
01832             <span class="keywordflow">if</span> (((planes == 0) || (planes == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;Planes)) &amp;&amp;
01833                 ((bpp == 0) || (bpp == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;BitsPixel))) {
01834 
01835                 hbm = CreateCompatibleBitmap(hdcScreen, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
01836 
01837             } <span class="keywordflow">else</span> {
01838 
01839                 dib4Vga.bi.biBitCount = planes * bpp ? planes * bpp : <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;BitCount;
01840 
01841 <span class="preprocessor">#if 0 // We use to do the dib-section create, but this breaks icons</span>
01842 <span class="preprocessor"></span>      <span class="comment">// when they are made public (can't make a dibsection public). So</span>
01843       <span class="comment">// we now wil create this as a real-dib.</span>
01844       <span class="comment">//</span>
01845                 {
01846                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDummy;
01847 
01848                 dib4Vga.bi.biWidth    =  cx;
01849                 dib4Vga.bi.biHeight   = -<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;     <span class="comment">// top-down DIB (like a DDB)</span>
01850 
01851                 hbm = CreateDIBSection(hdcScreen,
01852                                        (LPBITMAPINFO)&amp;dib4Vga,
01853                                        DIB_RGB_COLORS,
01854                                        (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)&amp;dwDummy,
01855                                        0,
01856                                        0);
01857                 }
01858 <span class="preprocessor">#else</span>
01859 <span class="preprocessor"></span>                dib4Vga.bi.biWidth  = cx;
01860                 dib4Vga.bi.biHeight = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
01861 
01862                 hbm = CreateDIBitmap(hdcScreen,
01863                                      (LPBITMAPINFOHEADER)&amp;dib4Vga,
01864                                      CBM_CREATEDIB,
01865                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01866                                      (LPBITMAPINFO)&amp;dib4Vga,
01867                                      DIB_RGB_COLORS);
01868 <span class="preprocessor">#endif</span>
01869 <span class="preprocessor"></span>            }
01870         }
01871 
01872         <a class="code" href="../../d4/d9/clres_8c.html#a9">RELEASEINITDC</a>(hdcScreen);
01873     }
01874 
01875     <span class="keywordflow">if</span> (hbm &amp;&amp; lpBits) {
01876 
01877         BITMAP bm;
01878 
01879         GetObject(hbm, <span class="keyword">sizeof</span>(BITMAP), &amp;bm);
01880         dwCount = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(bm.bmWidthBytes * bm.bmPlanes) * (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
01881         SetBitmapBits(hbm, dwCount, lpBits);
01882     }
01883 
01884     <span class="keywordflow">return</span> hbm;
01885 }
01886 
01887 <span class="comment">/***************************************************************************\</span>
01888 <span class="comment">* LoadBmp (Worker)</span>
01889 <span class="comment">*</span>
01890 <span class="comment">* This routine decides whether the bitmap to be loaded is in old or new (DIB)</span>
01891 <span class="comment">* format and calls appropriate handlers.</span>
01892 <span class="comment">*</span>
01893 <span class="comment">* History:</span>
01894 <span class="comment">* 24-Sep-1990 MikeKe    From Win30.</span>
01895 <span class="comment">* 18-Jun-1991 ChuckWh   Added local bitmap handle support.</span>
01896 <span class="comment">* 05-Sep-1995 ChrisWil  Port/Change for Chicago functionality.</span>
01897 <span class="comment">\***************************************************************************/</span>
01898 
<a name="l01899"></a><a class="code" href="../../d4/d9/clres_8c.html#a73">01899</a> HBITMAP <a class="code" href="../../d4/d9/clres_8c.html#a73">LoadBmp</a>(
01900     HINSTANCE hmod,
01901     LPCWSTR   lpName,
01902     <span class="keywordtype">int</span>       cxDesired,
01903     <span class="keywordtype">int</span>       cyDesired,
01904     UINT      flags)
01905 {
01906     HBITMAP hbmp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01907     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fFree = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01908     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    f1Bpp = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01909 
01910 <span class="comment">/***************************************************************************\</span>
01911 <span class="comment">* Bitmap Resource Table</span>
01912 <span class="comment">*</span>
01913 <span class="comment">* As of WIN4.0, most system bitmaps are rendered instead of grabbed from the</span>
01914 <span class="comment">* display driver.  However, a lot of apps, especially those that fake their</span>
01915 <span class="comment">* own MDI, do LoadBitmap(NULL, OBM_...) to grab a system bitmap.  So we</span>
01916 <span class="comment">* hook those requests here and copy our rendered bitmaps into a newly-</span>
01917 <span class="comment">* created bitmap.  Note that this is actually faster than loading from a</span>
01918 <span class="comment">* resource table!</span>
01919 <span class="comment">*</span>
01920 <span class="comment">* BOGUS -- give 'em old close buttons, not new cool X's</span>
01921 <span class="comment">*</span>
01922 <span class="comment">\***************************************************************************/</span>
01923 <span class="preprocessor">#define MAX_BMPMAP  32</span>
01924 <span class="preprocessor"></span>
01925     CONST <span class="keyword">static</span> <a class="code" href="../../d6/d0/structtagMAPRES.html">MAPRES</a> MapOemBmp[<a class="code" href="../../d4/d9/clres_8c.html#a14">MAX_BMPMAP</a>] = {
01926 
01927         {OBM_BTNCORNERS , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a338">OBI_RADIOMASK</a>      ,               },
01928         {OBM_BTSIZE     , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a312">OBI_NCGRIP</a>         ,               },
01929         {OBM_CHECK      , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a330">OBI_MENUCHECK</a>      , <a class="code" href="../../d4/d9/clres_8c.html#a12">MR_MONOCHROME</a> },
01930         {OBM_CHECKBOXES , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a339">OBI_CHECK</a>          ,               },
01931         {OBM_COMBO      , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a317">OBI_DNARROW</a>        ,               },
01932         {OBM_DNARROW    , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a317">OBI_DNARROW</a>        ,               },
01933         {OBM_DNARROWD   , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a318">OBI_DNARROW_D</a>      ,               },
01934         {OBM_DNARROWI   , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a320">OBI_DNARROW_I</a>      ,               },
01935         {OBM_LFARROW    , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a325">OBI_LFARROW</a>        ,               },
01936         {OBM_LFARROWD   , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a326">OBI_LFARROW_D</a>      ,               },
01937         {OBM_LFARROWI   , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a328">OBI_LFARROW_I</a>      ,               },
01938 
01939         <span class="comment">/*</span>
01940 <span class="comment">         * Use MONO bitmaps in future once flat/mono controls are worked out.</span>
01941 <span class="comment">         */</span>
01942         {OBM_OLD_DNARROW, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a317">OBI_DNARROW</a>        , <a class="code" href="../../d4/d9/clres_8c.html#a11">MR_FAILFOR40</a>  },
01943         {OBM_OLD_LFARROW, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a325">OBI_LFARROW</a>        , <a class="code" href="../../d4/d9/clres_8c.html#a11">MR_FAILFOR40</a>  },
01944         {OBM_OLD_REDUCE , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a289">OBI_REDUCE_MBAR</a>    , <a class="code" href="../../d4/d9/clres_8c.html#a11">MR_FAILFOR40</a>  },
01945         {OBM_OLD_RESTORE, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a293">OBI_RESTORE_MBAR</a>   , <a class="code" href="../../d4/d9/clres_8c.html#a11">MR_FAILFOR40</a>  },
01946         {OBM_OLD_RGARROW, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a321">OBI_RGARROW</a>        , <a class="code" href="../../d4/d9/clres_8c.html#a11">MR_FAILFOR40</a>  },
01947         {OBM_OLD_UPARROW, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a313">OBI_UPARROW</a>        , <a class="code" href="../../d4/d9/clres_8c.html#a11">MR_FAILFOR40</a>  },
01948         {OBM_OLD_ZOOM   , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a281">OBI_ZOOM</a>           , <a class="code" href="../../d4/d9/clres_8c.html#a11">MR_FAILFOR40</a>  },
01949 
01950         {OBM_MNARROW    , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a329">OBI_MENUARROW</a>      , <a class="code" href="../../d4/d9/clres_8c.html#a12">MR_MONOCHROME</a> },
01951         {OBM_REDUCE     , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a289">OBI_REDUCE_MBAR</a>    ,               },
01952         {OBM_REDUCED    , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a290">OBI_REDUCE_MBAR_D</a>  ,               },
01953         {OBM_RESTORE    , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a293">OBI_RESTORE_MBAR</a>   ,               },
01954         {OBM_RESTORED   , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a294">OBI_RESTORE_MBAR_D</a> ,               },
01955         {OBM_RGARROW    , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a321">OBI_RGARROW</a>        ,               },
01956         {OBM_RGARROWD   , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a322">OBI_RGARROW_D</a>      ,               },
01957         {OBM_RGARROWI   , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a324">OBI_RGARROW_I</a>      ,               },
01958         {OBM_SIZE       , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a312">OBI_NCGRIP</a>         ,               },
01959         {OBM_UPARROW    , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a313">OBI_UPARROW</a>        ,               },
01960         {OBM_UPARROWD   , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a314">OBI_UPARROW_D</a>      ,               },
01961         {OBM_UPARROWI   , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a316">OBI_UPARROW_I</a>      ,               },
01962         {OBM_ZOOM       , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a281">OBI_ZOOM</a>           ,               },
01963         {OBM_ZOOMD      , <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a282">OBI_ZOOM_D</a>         ,               }
01964     };
01965 
01966 
01967     <span class="comment">/*</span>
01968 <span class="comment">     * If hmod is valid, load the client-side bits.</span>
01969 <span class="comment">     */</span>
01970     <span class="keywordflow">if</span> (hmod == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01971 
01972         HBITMAP hOldBmp;
01973         WORD    bm;
01974         WORD    wID;
01975         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fCombo;
01976         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fCheckBoxes;
01977         <span class="keywordtype">int</span>     i;
01978         RECT    rc;
01979         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fSysMenu = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01980         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fMenu = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01981         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fMono = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01982 
01983         hmod = <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>;
01984 
01985         <span class="comment">/*</span>
01986 <span class="comment">         * Since the resource is coming from USER32, we only</span>
01987 <span class="comment">         * deal with ID types.</span>
01988 <span class="comment">         */</span>
01989         wID = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(lpName);
01990 
01991         <span class="keywordflow">switch</span>(wID) {
01992         <span class="keywordflow">case</span> OBM_OLD_CLOSE:
01993             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a150">GETAPPVER</a>() &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>)
01994                 <span class="keywordflow">goto</span> FailOldLoad;
01995 
01996             <span class="comment">/*</span>
01997 <span class="comment">             * fall through to the Close case.</span>
01998 <span class="comment">             */</span>
01999 
02000         <span class="keywordflow">case</span> OBM_CLOSE:
02001             <span class="comment">/* the new look for the system menu is to use the window's</span>
02002 <span class="comment">             * class icon -- but since here we don't know which window</span>
02003 <span class="comment">             * they'll be using this for, fall back on the good ole'</span>
02004 <span class="comment">             * windows logo icon</span>
02005 <span class="comment">             */</span>
02006             cxDesired = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMENUSIZE) + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE)) * 2;
02007             cyDesired = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMENUSIZE) + (2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE));
02008             fSysMenu  = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02009             <span class="keywordflow">break</span>;
02010 
02011         <span class="keywordflow">case</span> OBM_TRUETYPE: {
02012 
02013                 PVOID  p;
02014                 HANDLE h;
02015                 <span class="keywordtype">int</span>    nOffset;
02016 
02017                 <span class="comment">/*</span>
02018 <span class="comment">                 * Offset into resource.</span>
02019 <span class="comment">                 */</span>
02020                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dmLogPixels == 120) {
02021                     nOffset = <a class="code" href="../../d6/d0/usercli_8h.html#a245">OFFSET_120_DPI</a>;
02022                 } <span class="keywordflow">else</span> {
02023                     nOffset = <a class="code" href="../../d6/d0/usercli_8h.html#a244">OFFSET_96_DPI</a>;
02024                 }
02025 
02026                 lpName = (LPWSTR)(<a class="code" href="../../d6/d0/usercli_8h.html#a247">MAX_RESOURCE_INDEX</a> -
02027                         ((ULONG_PTR)lpName) + nOffset);
02028 
02029                 <span class="keywordflow">if</span> (h = <a class="code" href="../../d6/d0/usercli_8h.html#a126">FINDRESOURCEW</a>(hmod, (LPWSTR)lpName, RT_BITMAP)) {
02030 
02031                     <span class="keywordflow">if</span> (h = <a class="code" href="../../d6/d0/usercli_8h.html#a129">LOADRESOURCE</a>(hmod, h)) {
02032 
02033                         <span class="keywordflow">if</span> (p = <a class="code" href="../../d6/d0/usercli_8h.html#a130">LOCKRESOURCE</a>(h, hmod)) {
02034 
02035 
02036                             hbmp = (HBITMAP)<a class="code" href="../../d6/d0/usercli_8h.html#a656">ObjectFromDIBResource</a>(hmod,
02037                                                                   lpName,
02038                                                                   RT_BITMAP,
02039                                                                   cxDesired,
02040                                                                   cyDesired,
02041                                                                   flags);
02042 
02043                             <a class="code" href="../../d6/d0/usercli_8h.html#a131">UNLOCKRESOURCE</a>(h, hmod);
02044                         }
02045 
02046                         <a class="code" href="../../d6/d0/usercli_8h.html#a132">FREERESOURCE</a>(h, hmod);
02047                     }
02048                 }
02049 
02050                 <span class="keywordflow">goto</span> LoadBmpDone;
02051             }
02052             <span class="keywordflow">break</span>;
02053 
02054         <span class="keywordflow">default</span>:
02055             fCombo      = (wID == OBM_COMBO);
02056             fCheckBoxes = (wID == OBM_CHECKBOXES);
02057 
02058             <span class="comment">/*</span>
02059 <span class="comment">             * hard loop to check for mapping.</span>
02060 <span class="comment">             */</span>
02061             <span class="keywordflow">for</span> (i=0; (i &lt; <a class="code" href="../../d4/d9/clres_8c.html#a14">MAX_BMPMAP</a>) &amp;&amp; (MapOemBmp[i].idDisp != wID); i++);
02062 
02063             <span class="keywordflow">if</span> (i == <a class="code" href="../../d4/d9/clres_8c.html#a14">MAX_BMPMAP</a>)
02064                 <span class="keywordflow">goto</span> LoadForReal;
02065 
02066             <span class="keywordflow">if</span> ((MapOemBmp[i].bFlags &amp; <a class="code" href="../../d4/d9/clres_8c.html#a11">MR_FAILFOR40</a>) &amp;&amp;
02067                     (<a class="code" href="../../d6/d0/usercli_8h.html#a150">GETAPPVER</a>() &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>)) {
02068 
02069 FailOldLoad:
02070                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"LoadBitmap: old IDs not allowed for 4.0 apps"</span>);
02071                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02072             }
02073 
02074             <span class="keywordflow">if</span> (MapOemBmp[i].bFlags &amp; <a class="code" href="../../d4/d9/clres_8c.html#a12">MR_MONOCHROME</a>)
02075                 fMono = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02076 
02077             bm = MapOemBmp[i].idUser;
02078 
02079             <span class="keywordflow">if</span> ((bm == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a289">OBI_REDUCE_MBAR</a>) || (bm == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a293">OBI_RESTORE_MBAR</a>))
02080                 fMenu = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02081 
02082             cxDesired = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi[bm].cx;
02083             cyDesired = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi[bm].cy;
02084 
02085             <span class="keywordflow">if</span> (fMenu)
02086                 cyDesired += (2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE));
02087 
02088             <span class="keywordflow">if</span> (fCheckBoxes) {
02089                 cxDesired *= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a31">NUM_BUTTON_STATES</a>;
02090                 cyDesired *= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a30">NUM_BUTTON_TYPES</a>;
02091             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fCombo) {
02092                 cxDesired -= (2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE));
02093                 cyDesired -= (2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE));
02094             }
02095             <span class="keywordflow">break</span>;
02096         }
02097 
02098         <span class="comment">/*</span>
02099 <span class="comment">         * Creates DIB section or color compatible.</span>
02100 <span class="comment">         */</span>
02101         <span class="keywordflow">if</span> (fMono) {
02102 
02103             <span class="comment">/*</span>
02104 <span class="comment">             * Create mono-bitmaps as DIBs on NT.  On Win95 this is</span>
02105 <span class="comment">             * called as:</span>
02106 <span class="comment">             *</span>
02107 <span class="comment">             *   hbmp = CreateBitmap(cxDesired, cyDesired, 1, 1, NULL);</span>
02108 <span class="comment">             *</span>
02109 <span class="comment">             * However, due to color-matching differences, we need to</span>
02110 <span class="comment">             * use dibs to get the nearest-color-matching.  At the</span>
02111 <span class="comment">             * end of this routine we will convert to a true-mono so that</span>
02112 <span class="comment">             * foreground/background matching can be performed normally.</span>
02113 <span class="comment">             */</span>
02114             hbmp = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a28">CreateScreenBitmap</a>(cxDesired, cyDesired, 1, 1, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;f1Bpp);
02115 
02116         } <span class="keywordflow">else</span> {
02117 
02118             hbmp = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a28">CreateScreenBitmap</a>(cxDesired, cyDesired, 0, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;f1Bpp);
02119         }
02120 
02121         <span class="keywordflow">if</span> (hbmp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02122             <span class="keywordflow">goto</span> LoadBmpDone;
02123 
02124         RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
02125         hOldBmp = SelectBitmap(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, hbmp);
02126         UserAssert(GetBkColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>) == RGB(255,255,255));
02127         UserAssert(GetTextColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>) == RGB(0, 0, 0));
02128 
02129         rc.top    = 0;
02130         rc.left   = 0;
02131         rc.bottom = cyDesired;
02132         rc.right  = cxDesired;
02133 
02134         <span class="keywordflow">if</span> (fMono) {
02135             PatBlt(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, 0, 0, cxDesired, cyDesired, WHITENESS);
02136         } <span class="keywordflow">else</span> {
02137             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,
02138                      &amp;rc,
02139                      ((fMenu | fSysMenu) ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(<a class="code" href="../../d1/d1/structtagMENU.html">MENU</a>) : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a273">WINDOW</a>)));
02140         }
02141 
02142         <span class="keywordflow">if</span> (fSysMenu) {
02143             <span class="keywordtype">int</span> x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE);
02144             <span class="keywordtype">int</span> i;
02145 
02146             cxDesired /= 2;
02147 
02148             <span class="keywordflow">for</span> (i=0; i &lt; 2; i++) {
02149 
02150                 <a class="code" href="../../d3/d8/client_8c.html#a50">DrawIconEx</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,
02151                            x,
02152                            <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE),
02153                            <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hIconSmWindows,
02154                            cxDesired - 2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE),
02155                            <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMENUSIZE) - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE),
02156                            0,
02157                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02158                            DI_NORMAL);
02159 
02160                 x += cxDesired;
02161             }
02162 
02163         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fCombo) {
02164 
02165             <span class="comment">/*</span>
02166 <span class="comment">             * Revisit when we start using TTF -- that'll take care of</span>
02167 <span class="comment">             * this hack.</span>
02168 <span class="comment">             */</span>
02169             rc.top     = -<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE);
02170             rc.bottom +=  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE);
02171             rc.left    = -<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE);
02172             rc.right  +=  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE);
02173 
02174             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a14">DrawFrameControl</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,
02175                              &amp;rc,
02176                              DFC_SCROLL,
02177                              DFCS_SCROLLDOWN);
02178 
02179         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fCheckBoxes) {
02180 
02181             <span class="keywordtype">int</span>   wType;
02182             <span class="keywordtype">int</span>   wState;
02183             <span class="keywordtype">int</span>   x;
02184             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> clrTextSave;
02185             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> clrBkSave;
02186             <span class="keywordtype">int</span>   y = 0;
02187 
02188             <span class="keywordflow">for</span> (wType=0; wType &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a30">NUM_BUTTON_TYPES</a>; wType++) {
02189 
02190                 x = 0;
02191 
02192                 cxDesired = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi[bm].cx;
02193                 cyDesired = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi[bm].cy;
02194 
02195                 <span class="keywordflow">if</span> (wType == 1) {
02196 
02197                     <span class="comment">/*</span>
02198 <span class="comment">                     * BOGUS UGLINESS -- will be fixed once the Graphics dudes</span>
02199 <span class="comment">                     * get me the icon TTF -- I'll revisit this then and make</span>
02200 <span class="comment">                     * REAL</span>
02201 <span class="comment">                     */</span>
02202                     clrTextSave = SetTextColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, <a class="code" href="../../d4/d9/clres_8c.html#a3">RESCLR_BLACK</a>);
02203                     clrBkSave   = SetBkColor  (<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, <a class="code" href="../../d4/d9/clres_8c.html#a4">RESCLR_WHITE</a>);
02204 
02205                     <span class="keywordflow">for</span> (wState = 0; wState &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a31">NUM_BUTTON_STATES</a>; wState++) {
02206 
02207                         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a330">NtUserBitBltSysBmp</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,
02208                                            x,
02209                                            y,
02210                                            cxDesired,
02211                                            cyDesired,
02212                                            <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a338">OBI_RADIOMASK</a>].x,
02213                                            <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a338">OBI_RADIOMASK</a>].y,
02214                                            SRCAND);
02215 
02216                         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a330">NtUserBitBltSysBmp</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,
02217                                            x,
02218                                            y,
02219                                            cxDesired,
02220                                            cyDesired,
02221                                            <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi[bm].x,
02222                                            <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi[bm].y,
02223                                            SRCINVERT);
02224                         x += cxDesired;
02225                         bm++;
02226                     }
02227 
02228                     SetTextColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, clrTextSave);
02229                     SetBkColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, clrBkSave);
02230 
02231                 } <span class="keywordflow">else</span> {
02232 
02233                     <span class="keywordflow">for</span> (wState=0; wState &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a31">NUM_BUTTON_STATES</a>; wState++) {
02234 
02235                         <a class="code" href="../../d4/d1/userk_8h.html#a1773">BitBltSysBmp</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, x, y, bm);
02236                         x += cxDesired;
02237                         bm++;
02238                     }
02239 
02240                     <span class="comment">/*</span>
02241 <span class="comment">                     * Skip OBI_*_CDI.</span>
02242 <span class="comment">                     */</span>
02243                     bm++;
02244                 }
02245 
02246                 y += cyDesired;
02247             }
02248 
02249         } <span class="keywordflow">else</span> {
02250 
02251             <a class="code" href="../../d4/d1/userk_8h.html#a1773">BitBltSysBmp</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, 0, fMenu ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE) : 0, bm);
02252         }
02253 
02254         SelectBitmap(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, hOldBmp);
02255 
02256         <span class="comment">/*</span>
02257 <span class="comment">         * If the bitmap was created as a 1bpp, we need to convert to a</span>
02258 <span class="comment">         * true mono-bitmap.  GDI performs different color-matching depending</span>
02259 <span class="comment">         * upon this case.</span>
02260 <span class="comment">         */</span>
02261         <span class="keywordflow">if</span> (f1Bpp &amp;&amp; hbmp)
02262             hbmp = <a class="code" href="../../d4/d9/clres_8c.html#a71">Convert1BppToMonoBitmap</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, hbmp);
02263 
02264         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
02265 
02266     } <span class="keywordflow">else</span> {
02267 
02268 LoadForReal:
02269 
02270         hbmp = (HBITMAP)<a class="code" href="../../d6/d0/usercli_8h.html#a656">ObjectFromDIBResource</a>(hmod,
02271                                               lpName,
02272                                               RT_BITMAP,
02273                                               cxDesired,
02274                                               cyDesired,
02275                                               flags);
02276     }
02277 
02278 LoadBmpDone:
02279 
02280     <span class="keywordflow">return</span> hbmp;
02281 }
02282 
02283 <span class="comment">/***************************************************************************\</span>
02284 <span class="comment">* LoadBitmapA (API)</span>
02285 <span class="comment">* LoadBitmapW (API)</span>
02286 <span class="comment">*</span>
02287 <span class="comment">* Loads a bitmap from client.  If hmod == NULL, loads a bitmap from the</span>
02288 <span class="comment">* system.</span>
02289 <span class="comment">*</span>
02290 <span class="comment">\***************************************************************************/</span>
02291 
<a name="l02292"></a><a class="code" href="../../d4/d9/clres_8c.html#a74">02292</a> HBITMAP WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a74">LoadBitmapA</a>(
02293     HINSTANCE hmod,
02294     LPCSTR    lpName)
02295 {
02296     LPWSTR  lpUniName;
02297     HBITMAP hRet;
02298 
02299     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(lpName))
02300         <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a73">LoadBmp</a>(hmod, (LPCWSTR)lpName, 0, 0, 0);
02301 
02302     <span class="keywordflow">if</span> (!MBToWCS(lpName, -1, &amp;lpUniName, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
02303         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02304 
02305     hRet = <a class="code" href="../../d4/d9/clres_8c.html#a73">LoadBmp</a>(hmod, lpUniName, 0, 0, 0);
02306 
02307     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpUniName);
02308 
02309     <span class="keywordflow">return</span> hRet;
02310 }
02311 
<a name="l02312"></a><a class="code" href="../../d4/d9/clres_8c.html#a75">02312</a> HBITMAP WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a75">LoadBitmapW</a>(
02313     HINSTANCE hmod,
02314     LPCWSTR   lpName)
02315 {
02316     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a73">LoadBmp</a>(hmod, lpName, 0, 0, 0);
02317 }
02318 
02319 <span class="comment">/***************************************************************************\</span>
02320 <span class="comment">* LoadCursorA (API)</span>
02321 <span class="comment">* LoadCursorW (API)</span>
02322 <span class="comment">*</span>
02323 <span class="comment">* Loads a cursor from client.  If hmod == NULL, loads a cursor from the</span>
02324 <span class="comment">* system.</span>
02325 <span class="comment">*</span>
02326 <span class="comment">* 05-Apr-1991 ScottLu   Rewrote to work with client server.</span>
02327 <span class="comment">\***************************************************************************/</span>
02328 
<a name="l02329"></a><a class="code" href="../../d4/d9/clres_8c.html#a76">02329</a> HCURSOR WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a76">LoadCursorA</a>(
02330     HINSTANCE hmod,
02331     LPCSTR    lpName)
02332 {
02333     HCURSOR hRet;
02334     LPWSTR  lpUniName;
02335 
02336     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(lpName))
02337         <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a77">LoadCursorW</a>(hmod, (LPWSTR)lpName);
02338 
02339     <span class="keywordflow">if</span> (!MBToWCS(lpName, -1, &amp;lpUniName, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
02340         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02341 
02342     hRet = <a class="code" href="../../d4/d9/clres_8c.html#a77">LoadCursorW</a>(hmod, lpUniName);
02343 
02344     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpUniName);
02345 
02346     <span class="keywordflow">return</span> hRet;
02347 }
02348 
<a name="l02349"></a><a class="code" href="../../d4/d9/clres_8c.html#a77">02349</a> HCURSOR WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a77">LoadCursorW</a>(
02350     HINSTANCE hmod,
02351     LPCWSTR   lpName)
02352 {
02353 
02354     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a655">LoadIcoCur</a>(hmod,
02355                       lpName,
02356                       RT_CURSOR,
02357                       0,
02358                       0,
02359                       LR_DEFAULTSIZE | LR_SHARED);
02360 
02361 }
02362 
02363 <span class="comment">/***************************************************************************\</span>
02364 <span class="comment">* LoadIconA (API)</span>
02365 <span class="comment">* LoadIconW (API)</span>
02366 <span class="comment">*</span>
02367 <span class="comment">* Loads an icon from client.  If hmod == NULL, loads an icon from the</span>
02368 <span class="comment">* system.</span>
02369 <span class="comment">*</span>
02370 <span class="comment">* 05-Apr-1991 ScottLu   Rewrote to work with client server.</span>
02371 <span class="comment">\***************************************************************************/</span>
02372 
<a name="l02373"></a><a class="code" href="../../d4/d9/clres_8c.html#a78">02373</a> HICON WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a78">LoadIconA</a>(
02374     HINSTANCE hmod,
02375     LPCSTR    lpName)
02376 {
02377     HICON  hRet;
02378     LPWSTR lpUniName;
02379 
02380     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(lpName))
02381         <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a79">LoadIconW</a>(hmod, (LPWSTR)lpName);
02382 
02383     <span class="keywordflow">if</span> (!MBToWCS(lpName, -1, &amp;lpUniName, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
02384         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02385 
02386     hRet = <a class="code" href="../../d4/d9/clres_8c.html#a79">LoadIconW</a>(hmod, lpUniName);
02387 
02388     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpUniName);
02389 
02390     <span class="keywordflow">return</span> hRet;
02391 }
02392 
<a name="l02393"></a><a class="code" href="../../d4/d9/clres_8c.html#a79">02393</a> HICON WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a79">LoadIconW</a>(
02394     HINSTANCE hmod,
02395     LPCWSTR   lpName)
02396 {
02397     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a655">LoadIcoCur</a>(hmod,
02398                       lpName,
02399                       RT_ICON,
02400                       0,
02401                       0,
02402                       LR_DEFAULTSIZE | LR_SHARED);
02403 }
02404 
02405 <span class="comment">/***************************************************************************\</span>
02406 <span class="comment">* LoadImageA (API)</span>
02407 <span class="comment">* LoadImageW (API)</span>
02408 <span class="comment">*</span>
02409 <span class="comment">* Loads a bitmap, icon or cursor resource from client.  If hmod == NULL,</span>
02410 <span class="comment">* then it will load from system-resources.</span>
02411 <span class="comment">*</span>
02412 <span class="comment">\***************************************************************************/</span>
02413 
<a name="l02414"></a><a class="code" href="../../d4/d9/clres_8c.html#a80">02414</a> HANDLE WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a80">LoadImageA</a>(
02415     HINSTANCE hmod,
02416     LPCSTR    lpName,
02417     UINT      type,
02418     <span class="keywordtype">int</span>       cxDesired,
02419     <span class="keywordtype">int</span>       cyDesired,
02420     UINT      flags)
02421 {
02422     LPWSTR lpUniName;
02423     HANDLE hRet;
02424 
02425     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(lpName))
02426         <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a81">LoadImageW</a>(hmod,
02427                           (LPCWSTR)lpName,
02428                           <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>,
02429                           cxDesired,
02430                           cyDesired,
02431                           flags);
02432 
02433     <span class="keywordflow">if</span> (!MBToWCS(lpName, -1, &amp;lpUniName, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
02434         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02435 
02436     hRet = <a class="code" href="../../d4/d9/clres_8c.html#a81">LoadImageW</a>(hmod, lpUniName, <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>, cxDesired, cyDesired, flags);
02437 
02438     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpUniName);
02439 
02440     <span class="keywordflow">return</span> hRet;
02441 }
02442 
<a name="l02443"></a><a class="code" href="../../d4/d9/clres_8c.html#a81">02443</a> HANDLE WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a81">LoadImageW</a>(
02444     HINSTANCE hmod,
02445     LPCWSTR   lpName,
02446     UINT      IMAGE_code,
02447     <span class="keywordtype">int</span>       cxDesired,
02448     <span class="keywordtype">int</span>       cyDesired,
02449     UINT      flags)
02450 {
02451     <span class="comment">/*</span>
02452 <span class="comment">     * If we specified LR_LOADFROMFILE, then we can tweak the</span>
02453 <span class="comment">     * flags to turn off LR_SHARED.</span>
02454 <span class="comment">     */</span>
02455     <span class="keywordflow">if</span> (flags &amp; LR_LOADFROMFILE)
02456         flags &amp;= ~LR_SHARED;
02457 
02458     <span class="keywordflow">switch</span> (IMAGE_code) {
02459     <span class="keywordflow">case</span> IMAGE_BITMAP:
02460         <span class="keywordflow">return</span> (HANDLE)<a class="code" href="../../d4/d9/clres_8c.html#a73">LoadBmp</a>(hmod, lpName, cxDesired, cyDesired, flags);
02461 
02462     <span class="keywordflow">case</span> IMAGE_CURSOR:
02463 <span class="preprocessor">#if 0 //CHRISWIL : oemInfo.fColorCursors doesn't exist on NT.</span>
02464 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!oemInfo.fColorCursors)
02465             flags |= LR_MONOCHROME;
02466 <span class="preprocessor">#endif</span>
02467 <span class="preprocessor"></span>
02468     <span class="keywordflow">case</span> IMAGE_ICON:
02469 
02470         <span class="comment">/*</span>
02471 <span class="comment">         * On WinNT 3.51, an app can successfully load a</span>
02472 <span class="comment">         * USER icon without specifying LR_SHARED. We enable</span>
02473 <span class="comment">         * these apps to succeed, but make 4.0 apps conform to</span>
02474 <span class="comment">         * Windows95 behavior.</span>
02475 <span class="comment">         */</span>
02476 
02477         <span class="keywordflow">if</span> (!hmod &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a134">GETEXPWINVER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) {
02478             flags |= LR_SHARED;
02479         }
02480 
02481         <span class="keywordflow">return</span> (HANDLE)<a class="code" href="../../d6/d0/usercli_8h.html#a655">LoadIcoCur</a>(hmod,
02482                                   lpName,
02483                                   ((IMAGE_code == IMAGE_ICON) ? RT_ICON : RT_CURSOR),
02484                                   cxDesired,
02485                                   cyDesired,
02486                                   flags);
02487 
02488     <span class="keywordflow">default</span>:
02489         RIPMSG0(RIP_WARNING, <span class="stringliteral">"LoadImage: invalid IMAGE_code"</span>);
02490         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02491     }
02492 }
02493 
02494 <span class="comment">/***************************************************************************\</span>
02495 <span class="comment">* GetIconIdEx</span>
02496 <span class="comment">*</span>
02497 <span class="comment">* This one accepts width, height, and other flags.  Just not exported right</span>
02498 <span class="comment">* now.</span>
02499 <span class="comment">*</span>
02500 <span class="comment">\***************************************************************************/</span>
02501 
<a name="l02502"></a><a class="code" href="../../d4/d9/clres_8c.html#a82">02502</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d9/clres_8c.html#a82">GetIconIdEx</a>(
02503     HINSTANCE hmod,
02504     HANDLE    hrsd,
02505     LPCWSTR   lpszType,
02506     DWORD     cxDesired,
02507     DWORD     cyDesired,
02508     UINT      LR_flags)
02509 {
02510     <span class="keywordtype">int</span>         idIcon = 0;
02511     LPNEWHEADER lpnh;
02512 
02513     <span class="keywordflow">if</span> (lpnh = (LPNEWHEADER)<a class="code" href="../../d6/d0/usercli_8h.html#a130">LOCKRESOURCE</a>(hrsd, hmod)) {
02514 
02515         <span class="comment">/*</span>
02516 <span class="comment">         * Do a sanity check on this data structure.  Otherwise we'll GP FAULT</span>
02517 <span class="comment">         * when extracting an icon from a corrupted area.  Fix for B#9290.</span>
02518 <span class="comment">         * SANKAR, 08/13/91</span>
02519 <span class="comment">         */</span>
02520         <span class="keywordflow">if</span> ((lpnh-&gt;Reserved == 0) &amp;&amp;
02521             ((lpnh-&gt;ResType == IMAGE_ICON) || (lpnh-&gt;ResType == IMAGE_CURSOR))) {
02522 
02523             idIcon = <a class="code" href="../../d4/d9/clres_8c.html#a67">LookupIconIdFromDirectoryEx</a>((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)lpnh,
02524                                                  (lpszType == RT_ICON),
02525                                                  cxDesired,
02526                                                  cyDesired,
02527                                                  LR_flags);
02528         }
02529 
02530         <a class="code" href="../../d6/d0/usercli_8h.html#a131">UNLOCKRESOURCE</a>(hrsd, hmod);
02531     }
02532 
02533     <span class="keywordflow">return</span> idIcon;
02534 }
02535 
02536 <span class="comment">/***************************************************************************\</span>
02537 <span class="comment">* LoadDib (Worker)</span>
02538 <span class="comment">*</span>
02539 <span class="comment">* This is the worker-routine for loading a resource and returning a handle</span>
02540 <span class="comment">* to the object as a dib.</span>
02541 <span class="comment">*</span>
02542 <span class="comment">\***************************************************************************/</span>
02543 
<a name="l02544"></a><a class="code" href="../../d4/d9/clres_8c.html#a83">02544</a> HANDLE <a class="code" href="../../d4/d9/clres_8c.html#a83">LoadDIB</a>(
02545     HINSTANCE hmod,
02546     LPCWSTR   lpName,
02547     LPWSTR    type,
02548     DWORD     cxDesired,
02549     DWORD     cyDesired,
02550     UINT      LR_flags)
02551 {
02552     HANDLE  hDir;
02553     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    idIcon;
02554     LPWSTR  lpszGroupType;
02555     HANDLE  hRes = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02556 
02557     <span class="keywordflow">switch</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>)) {
02558 
02559     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_ICON):
02560     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_CURSOR):
02561 
02562         lpszGroupType = RT_GROUP_CURSOR + (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> - RT_CURSOR);
02563 
02564         <span class="comment">/*</span>
02565 <span class="comment">         * For WOW support, OIC_ICON and OIC_SIZE need to be supported.</span>
02566 <span class="comment">         * Since these resources match other existing resources, we map</span>
02567 <span class="comment">         * them here so we produce results that emulates</span>
02568 <span class="comment">         * behavor as if we had the actual resources in USER.</span>
02569 <span class="comment">         *</span>
02570 <span class="comment">         * Note that obsolete mapping of lpName in LoadIcoCur prevents</span>
02571 <span class="comment">         * win4.0 apps from getting here.</span>
02572 <span class="comment">         */</span>
02573         <span class="keywordflow">if</span> (hmod == <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>) {
02574 
02575             <span class="keywordflow">switch</span> ((ULONG_PTR)lpName) {
02576             <span class="keywordflow">case</span> OCR_SIZE:
02577                 lpName = (LPCWSTR)OCR_SIZEALL_DEFAULT;
02578                 <span class="keywordflow">break</span>;
02579 
02580             <span class="keywordflow">case</span> OCR_ICON:
02581                 lpName = (LPCWSTR)OCR_ICON_DEFAULT;
02582                 <span class="keywordflow">break</span>;
02583             }
02584         }
02585         <span class="comment">/*</span>
02586 <span class="comment">         * The resource is actually a directory which contains multiple</span>
02587 <span class="comment">         * individual image resources we must choose from.</span>
02588 <span class="comment">         * Locate the directory</span>
02589 <span class="comment">         */</span>
02590         <span class="keywordflow">if</span> (hDir = <a class="code" href="../../d4/d9/clres_8c.html#a29">SplFindResource</a>(hmod, lpName, (LPCWSTR)lpszGroupType)) {
02591 
02592             <span class="comment">/*</span>
02593 <span class="comment">             * Load the directory.</span>
02594 <span class="comment">             */</span>
02595             <span class="keywordflow">if</span> (hDir = <a class="code" href="../../d6/d0/usercli_8h.html#a129">LOADRESOURCE</a>(hmod, hDir)) {
02596 
02597                 <span class="comment">/*</span>
02598 <span class="comment">                 * Get the name of the best individual image.</span>
02599 <span class="comment">                 */</span>
02600                 <span class="keywordflow">if</span> (idIcon = <a class="code" href="../../d4/d9/clres_8c.html#a82">GetIconIdEx</a>(hmod,
02601                                          hDir,
02602                                          <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>,
02603                                          cxDesired,
02604                                          cyDesired,
02605                                          LR_flags)) {
02606 
02607                     <span class="comment">/*</span>
02608 <span class="comment">                     * NOTE: Don't free the directory resource!!! - ChipA.</span>
02609 <span class="comment">                     * We can't call SplFindResource here, because idIcon</span>
02610 <span class="comment">                     * is internal to us and GetDriverResourceId()</span>
02611 <span class="comment">                     * doesn't know how to map it.</span>
02612 <span class="comment">                     */</span>
02613                     hRes = <a class="code" href="../../d6/d0/usercli_8h.html#a126">FINDRESOURCEW</a>(hmod, MAKEINTRESOURCE(idIcon), <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>);
02614                 }
02615 
02616                 <span class="comment">/*</span>
02617 <span class="comment">                 * BOGUS:</span>
02618 <span class="comment">                 * It would be very cool if we could loop through all the</span>
02619 <span class="comment">                 * items in the directory and free 'em too.  Free the ones</span>
02620 <span class="comment">                 * except for the one we're about to load, that is.</span>
02621 <span class="comment">                 *</span>
02622 <span class="comment">                 * Free directory resources TWICE so they get really freed.</span>
02623 <span class="comment">                 */</span>
02624                 <a class="code" href="../../d4/d9/clres_8c.html#a30">SplFreeResource</a>(hDir, hmod, LR_flags);
02625             }
02626         } <span class="keywordflow">else</span> {
02627             <span class="comment">/*</span>
02628 <span class="comment">             * Failed to load a regular icon\cursor.</span>
02629 <span class="comment">             * Try to load an animated icon/cursor with the same name</span>
02630 <span class="comment">             */</span>
02631             hRes = <a class="code" href="../../d4/d9/clres_8c.html#a29">SplFindResource</a>(hmod, lpName,
02632                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_CURSOR) ? RT_ANICURSOR : RT_ANIICON);
02633         }
02634         <span class="keywordflow">break</span>;
02635 
02636     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_BITMAP):
02637         hRes = <a class="code" href="../../d4/d9/clres_8c.html#a29">SplFindResource</a>(hmod, lpName, RT_BITMAP);
02638         <span class="keywordflow">break</span>;
02639 
02640     <span class="keywordflow">default</span>:
02641         RIPMSG0(RIP_WARNING, <span class="stringliteral">"LoadDIB: Invalid resource type"</span>);
02642         <span class="keywordflow">break</span>;
02643     }
02644 
02645     <span class="keywordflow">if</span> (hRes)
02646         hRes = <a class="code" href="../../d6/d0/usercli_8h.html#a129">LOADRESOURCE</a>(hmod, hRes);
02647 
02648     <span class="keywordflow">return</span> hRes;
02649 }
02650 
02651 <span class="comment">/***************************************************************************\</span>
02652 <span class="comment">* LoadIcoCur (Worker)</span>
02653 <span class="comment">*</span>
02654 <span class="comment">*</span>
02655 <span class="comment">\***************************************************************************/</span>
02656 
<a name="l02657"></a><a class="code" href="../../d6/d0/usercli_8h.html#a655">02657</a> HICON <a class="code" href="../../d6/d0/usercli_8h.html#a655">LoadIcoCur</a>(
02658     HINSTANCE hmod,
02659     LPCWSTR   pszResName,
02660     LPWSTR    type,
02661     DWORD     cxDesired,
02662     DWORD     cyDesired,
02663     UINT      LR_flags)
02664 {
02665     HICON     hico;
02666     LPWSTR    pszModName;
02667     WCHAR     achModName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
02668 
02669     <a class="code" href="../../d1/d0/inc_2user_8h.html#a848">ConnectIfNecessary</a>();
02670 
02671     <span class="comment">/*</span>
02672 <span class="comment">     * Setup module name and handles for lookup.</span>
02673 <span class="comment">     */</span>
02674     <span class="keywordflow">if</span> (hmod == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
02675 
02676         hmod = <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>;
02677         pszModName = <a class="code" href="../../d1/d8/clglobal_8c.html#a12">szUSER32</a>;
02678 
02679     } <span class="keywordflow">else</span> {
02680 
02681         <a class="code" href="../../d6/d0/usercli_8h.html#a647">WowGetModuleFileName</a>(hmod,
02682                              achModName,
02683                              <span class="keyword">sizeof</span>(achModName) / <span class="keyword">sizeof</span>(WCHAR));
02684 
02685         pszModName = achModName;
02686     }
02687 
02688     <span class="keywordflow">if</span> (LR_flags &amp; LR_CREATEDIBSECTION)
02689         LR_flags = (LR_flags &amp; ~LR_CREATEDIBSECTION) | LR_CREATEREALDIB;
02690 
02691     <span class="comment">/*</span>
02692 <span class="comment">     * Setup defaults.</span>
02693 <span class="comment">     */</span>
02694     <span class="keywordflow">if</span> ((hmod == <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pszResName)) {
02695 
02696         <span class="keywordtype">int</span>      imapMax;
02697         <a class="code" href="../../d4/d9/clres_8c.html#a26">LPMAPRES</a> lpMapRes;
02698 
02699         <span class="comment">/*</span>
02700 <span class="comment">         * Map some old OEM IDs for people.</span>
02701 <span class="comment">         */</span>
02702         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> == RT_ICON) {
02703 
02704             <span class="keyword">static</span> <a class="code" href="../../d6/d0/structtagMAPRES.html">MAPRES</a> MapOemOic[] = {
02705                 {OCR_ICOCUR, OIC_WINLOGO, <a class="code" href="../../d4/d9/clres_8c.html#a11">MR_FAILFOR40</a>}
02706             };
02707 
02708             lpMapRes = MapOemOic;
02709             imapMax  = 1;
02710 
02711         } <span class="keywordflow">else</span> {
02712 
02713             <span class="keyword">static</span> <a class="code" href="../../d6/d0/structtagMAPRES.html">MAPRES</a> MapOemOcr[] = {
02714                 {OCR_ICON, OCR_ICON, <a class="code" href="../../d4/d9/clres_8c.html#a11">MR_FAILFOR40</a>},
02715                 {OCR_SIZE, OCR_SIZE, <a class="code" href="../../d4/d9/clres_8c.html#a11">MR_FAILFOR40</a>}
02716             };
02717 
02718             lpMapRes = MapOemOcr;
02719             imapMax  = 2;
02720         }
02721 
02722         <span class="keywordflow">while</span> (--imapMax &gt;= 0) {
02723 
02724             <span class="keywordflow">if</span> (lpMapRes-&gt;<a class="code" href="../../d6/d0/structtagMAPRES.html#o0">idDisp</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(pszResName)) {
02725 
02726                 <span class="keywordflow">if</span> ((lpMapRes-&gt;<a class="code" href="../../d6/d0/structtagMAPRES.html#o2">bFlags</a> &amp; <a class="code" href="../../d4/d9/clres_8c.html#a11">MR_FAILFOR40</a>) &amp;&amp;
02727                     <a class="code" href="../../d6/d0/usercli_8h.html#a150">GETAPPVER</a>() &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) {
02728 
02729                     RIPMSG1(RIP_WARNING,
02730                           <span class="stringliteral">"LoadIcoCur: Old ID 0x%x not allowed for 4.0 apps"</span>,
02731                           <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(pszResName));
02732 
02733                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02734                 }
02735 
02736                 pszResName = MAKEINTRESOURCE(lpMapRes-&gt;<a class="code" href="../../d6/d0/structtagMAPRES.html#o1">idUser</a>);
02737                 <span class="keywordflow">break</span>;
02738             }
02739 
02740             ++lpMapRes;
02741         }
02742     }
02743 
02744     <span class="comment">/*</span>
02745 <span class="comment">     * Determine size of requested object.</span>
02746 <span class="comment">     */</span>
02747     cxDesired = <a class="code" href="../../d6/d0/usercli_8h.html#a652">GetIcoCurWidth</a>(cxDesired , (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> == RT_ICON), LR_flags, 0);
02748     cyDesired = <a class="code" href="../../d6/d0/usercli_8h.html#a653">GetIcoCurHeight</a>(cyDesired, (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> == RT_ICON), LR_flags, 0);
02749 
02750     <span class="comment">/*</span>
02751 <span class="comment">     * See if this is a cached icon/cursor, and grab it if we have one</span>
02752 <span class="comment">     * already.</span>
02753 <span class="comment">     */</span>
02754     <span class="keywordflow">if</span> (LR_flags &amp; LR_SHARED) {
02755 
02756         <a class="code" href="../../d9/d1/structtagCURSORFIND.html">CURSORFIND</a> cfSearch;
02757 
02758         <span class="comment">/*</span>
02759 <span class="comment">         * Note that win95 fails to load any USER resources unless</span>
02760 <span class="comment">         * LR_SHARED is specified - so we do too.  Also, win95 will</span>
02761 <span class="comment">         * ignore your cx, cy and LR_flag parameters and just give</span>
02762 <span class="comment">         * you whats in the cache so we do too.</span>
02763 <span class="comment">         * A shame but thats life...</span>
02764 <span class="comment">         *</span>
02765 <span class="comment">         * Setup search criteria.  Since this is a load, we will have</span>
02766 <span class="comment">         * no source-cursor to lookup.  Find something respectable.</span>
02767 <span class="comment">         */</span>
02768         cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o0">hcur</a> = (HCURSOR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02769         cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o1">rt</a>   = PtrToUlong(<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>);
02770 
02771         <span class="keywordflow">if</span> (hmod == <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>) {
02772 
02773             cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o2">cx</a>  = 0;
02774             cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o3">cy</a>  = 0;
02775             cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o4">bpp</a> = 0;
02776 
02777         } <span class="keywordflow">else</span> {
02778 
02779             cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o2">cx</a>  = cxDesired;
02780             cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o3">cy</a>  = cyDesired;
02781 
02782 <span class="comment">/*</span>
02783 <span class="comment"> * On NT we have a more strict cache-lookup.  By passing in (zero), we</span>
02784 <span class="comment"> * will tell the cache-lookup to ignore the bpp.  This fixes a problem</span>
02785 <span class="comment"> * in Crayola Art Studio where the coloring-book cursor was being created</span>
02786 <span class="comment"> * as an invisible cursor.  This lookup is compatible with Win95.</span>
02787 <span class="comment"> */</span>
02788 <span class="preprocessor">#if 0</span>
02789 <span class="preprocessor"></span>            cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o4">bpp</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a654">GetIcoCurBpp</a>(LR_flags);
02790 <span class="preprocessor">#else</span>
02791 <span class="preprocessor"></span>            cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o4">bpp</a> = 0;
02792 <span class="preprocessor">#endif</span>
02793 <span class="preprocessor"></span>        }
02794 
02795         hico = <a class="code" href="../../d6/d0/usercli_8h.html#a627">FindExistingCursorIcon</a>(pszModName, pszResName, &amp;cfSearch);
02796 
02797         <span class="keywordflow">if</span> (hico != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02798             <span class="keywordflow">goto</span> IcoCurFound;
02799     }
02800 
02801 <span class="preprocessor">#ifdef LATER // SanfordS</span>
02802 <span class="preprocessor"></span>    <span class="comment">/*</span>
02803 <span class="comment">     * We need to handle the case where a configurable icon has been</span>
02804 <span class="comment">     * loaded from some arbitrary module or file and someone now wants</span>
02805 <span class="comment">     * to load the same thing in a different size or color content.</span>
02806 <span class="comment">     *</span>
02807 <span class="comment">     * A cheezier alternative is to just call CopyImage on what we</span>
02808 <span class="comment">     * found.</span>
02809 <span class="comment">     */</span>
02810     <span class="keywordflow">if</span> (hmod == <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>) {
02811         hico = <a class="code" href="../../d6/d0/usercli_8h.html#a627">FindExistingCursorIcon</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02812                                       szUSER,
02813                                       <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>,
02814                                       pszResName,
02815                                       0,
02816                                       0,
02817                                       0);
02818         <span class="keywordflow">if</span> (hico != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02819             <span class="comment">/*</span>
02820 <span class="comment">             * Find out where the original came from and load it.</span>
02821 <span class="comment">             * This may require some redesign to remember the</span>
02822 <span class="comment">             * filename that LR_LOADFROMFILE images came from.</span>
02823 <span class="comment">             */</span>
02824             _GetIconInfo(....);
02825             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a655">LoadIcoCur</a>(....);
02826         }
02827     }
02828 <span class="preprocessor">#endif</span>
02829 <span class="preprocessor"></span>
02830     hico = (HICON)<a class="code" href="../../d6/d0/usercli_8h.html#a656">ObjectFromDIBResource</a>(hmod,
02831                                         pszResName,
02832                                         <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>,
02833                                         cxDesired,
02834                                         cyDesired,
02835                                         LR_flags);
02836 
02837 IcoCurFound:
02838 
02839     <span class="keywordflow">return</span> hico;
02840 }
02841 
02842 <span class="comment">/***************************************************************************\</span>
02843 <span class="comment">* ObjectFromDIBResource</span>
02844 <span class="comment">*</span>
02845 <span class="comment">*</span>
02846 <span class="comment">\***************************************************************************/</span>
<a name="l02847"></a><a class="code" href="../../d6/d0/usercli_8h.html#a656">02847</a> HANDLE <a class="code" href="../../d6/d0/usercli_8h.html#a656">ObjectFromDIBResource</a>(
02848     HINSTANCE hmod,
02849     LPCWSTR   lpName,
02850     LPWSTR    type,
02851     DWORD     cxDesired,
02852     DWORD     cyDesired,
02853     UINT      LR_flags)
02854 {
02855     HANDLE  hObj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02856 
02857     <span class="keywordflow">if</span> (LR_flags &amp; LR_LOADFROMFILE) {
02858 
02859         hObj = <a class="code" href="../../d6/d0/usercli_8h.html#a657">RtlLoadObjectFromDIBFile</a>(lpName,
02860                                         <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>,
02861                                         cxDesired,
02862                                         cyDesired,
02863                                         LR_flags);
02864     } <span class="keywordflow">else</span> {
02865 
02866         HANDLE hdib;
02867 
02868         hdib = <a class="code" href="../../d4/d9/clres_8c.html#a83">LoadDIB</a>(hmod, lpName, <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>, cxDesired, cyDesired, LR_flags);
02869 
02870         <span class="keywordflow">if</span> (hdib != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02871 
02872             LPBITMAPINFOHEADER lpbih;
02873 
02874             <span class="comment">/*</span>
02875 <span class="comment">             * We cast the resource-bits to a BITMAPINFOHEADER.  If the</span>
02876 <span class="comment">             * resource is a CURSOR type, then there are actually two</span>
02877 <span class="comment">             * WORDs preceeding the BITMAPINFOHDEADER indicating the</span>
02878 <span class="comment">             * hot-spot.  Be careful in assuming you have a real</span>
02879 <span class="comment">             * dib in this case.</span>
02880 <span class="comment">             */</span>
02881             <span class="keywordflow">if</span>(lpbih = (LPBITMAPINFOHEADER)<a class="code" href="../../d6/d0/usercli_8h.html#a130">LOCKRESOURCE</a>(hdib, hmod)) {
02882 
02883                 <span class="keywordflow">switch</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>)) {
02884                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_BITMAP):
02885                     <span class="comment">/*</span>
02886 <span class="comment">                     * Create a physical bitmap from the DIB.</span>
02887 <span class="comment">                     */</span>
02888                     hObj = <a class="code" href="../../d6/d0/usercli_8h.html#a659">ConvertDIBBitmap</a>(lpbih,
02889                                             cxDesired,
02890                                             cyDesired,
02891                                             LR_flags,
02892                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02893                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02894                     <span class="keywordflow">break</span>;
02895 
02896                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_ICON):
02897                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_CURSOR):
02898                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_ANICURSOR):
02899                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_ANIICON):
02900                     <span class="comment">/*</span>
02901 <span class="comment">                     * Animated icon\cursors resources use the RIFF format</span>
02902 <span class="comment">                     */</span>
02903                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/clres_8c.html#a10">ISRIFFFORMAT</a>(lpbih)) {
02904                         hObj = <a class="code" href="../../d4/d9/clres_8c.html#a68">LoadCursorIconFromResource</a> ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)lpbih, lpName, cxDesired, cyDesired, LR_flags);
02905                     } <span class="keywordflow">else</span> {
02906                         <span class="comment">/*</span>
02907 <span class="comment">                         * Create the object from the DIB.</span>
02908 <span class="comment">                         */</span>
02909                         hObj = <a class="code" href="../../d6/d0/usercli_8h.html#a660">ConvertDIBIcon</a>(lpbih,
02910                                               hmod,
02911                                               lpName,
02912                                               (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> == RT_ICON),
02913                                               cxDesired,
02914                                               cyDesired,
02915                                               LR_flags);
02916                     }
02917                     <span class="keywordflow">break</span>;
02918                 }
02919 
02920                 <a class="code" href="../../d6/d0/usercli_8h.html#a131">UNLOCKRESOURCE</a>(hdib, hmod);
02921             }
02922 
02923             <span class="comment">/*</span>
02924 <span class="comment">             * DO THIS TWICE!  The resource compiler always makes icon images</span>
02925 <span class="comment">             * (RT_ICON) in a group icon discardable, whether the group dude</span>
02926 <span class="comment">             * is or not!  So the first free won't really free the thing;</span>
02927 <span class="comment">             * it'll just set the ref count to 0 and let the discard logic</span>
02928 <span class="comment">             * go on its merry way.</span>
02929 <span class="comment">             *</span>
02930 <span class="comment">             * We take care of shared guys, so we don't need this dib no more.</span>
02931 <span class="comment">             * Don't need this DIB no more no more, no more no more no more</span>
02932 <span class="comment">             * don't need this DIB no more.</span>
02933 <span class="comment">             */</span>
02934             <a class="code" href="../../d4/d9/clres_8c.html#a30">SplFreeResource</a>(hdib, hmod, LR_flags);
02935         }
02936     }
02937 
02938     <span class="keywordflow">return</span> hObj;
02939 }
02940 
02941 <span class="comment">/***************************************************************************\</span>
02942 <span class="comment">* BitmapFromDIB</span>
02943 <span class="comment">*</span>
02944 <span class="comment">* Creates a bitmap-handle from a DIB-Spec.  This function supports the</span>
02945 <span class="comment">* LR_CREATEDIBSECTION flag, sets proper color depth, and stretches the</span>
02946 <span class="comment">* DIBs as requested.</span>
02947 <span class="comment">*</span>
02948 <span class="comment">\***************************************************************************/</span>
02949 
<a name="l02950"></a><a class="code" href="../../d4/d9/clres_8c.html#a86">02950</a> HBITMAP <a class="code" href="../../d4/d9/clres_8c.html#a86">BitmapFromDIB</a>(
02951     <span class="keywordtype">int</span>          cxNew,
02952     <span class="keywordtype">int</span>          cyNew,
02953     WORD         bPlanesNew,
02954     WORD         bBitsPixelNew,
02955     UINT         LR_flags,
02956     <span class="keywordtype">int</span>          cxOld,
02957     <span class="keywordtype">int</span>          cyOld,
02958     LPSTR        lpBits,
02959     LPBITMAPINFO lpbi,
02960     HPALETTE     hpal)
02961 {
02962     HBITMAP hbmpNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02963     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fStretch;
02964     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    f1Bpp = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02965 
02966     RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
02967 
02968     <span class="keywordflow">if</span> (cxNew == 0)
02969         cxNew = cxOld;
02970 
02971     <span class="keywordflow">if</span> (cyNew == 0)
02972         cyNew = cyOld;
02973 
02974     fStretch = ((cxNew != cxOld) || (cyNew != cyOld));
02975 
02976     <span class="comment">/*</span>
02977 <span class="comment">     * If LR_flags indicate DIB-Section, then return that as the</span>
02978 <span class="comment">     * bitmap handle.</span>
02979 <span class="comment">     */</span>
02980     <span class="keywordflow">if</span> (LR_flags &amp; (LR_CREATEDIBSECTION | LR_CREATEREALDIB)) {
02981 
02982         <span class="keywordtype">int</span>   cxTemp;
02983         <span class="keywordtype">int</span>   cyTemp;
02984         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fOldFormat;
02985         <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> dwDummy;
02986         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTemp;
02987 
02988 <span class="preprocessor">#define lpbch ((LPBITMAPCOREHEADER)lpbi)</span>
02989 <span class="preprocessor"></span>
02990         fOldFormat = ((WORD)lpbi-&gt;bmiHeader.biSize == <span class="keyword">sizeof</span>(BITMAPCOREHEADER));
02991 
02992         <span class="keywordflow">if</span> (fOldFormat) {
02993 
02994             cxTemp = <a class="code" href="../../d4/d9/clres_8c.html#a15">lpbch</a>-&gt;bcWidth;
02995             cyTemp = <a class="code" href="../../d4/d9/clres_8c.html#a15">lpbch</a>-&gt;bcHeight;
02996 
02997             <a class="code" href="../../d4/d9/clres_8c.html#a15">lpbch</a>-&gt;bcWidth  = (WORD)cxNew;
02998             <a class="code" href="../../d4/d9/clres_8c.html#a15">lpbch</a>-&gt;bcHeight = (WORD)cyNew;
02999 
03000         } <span class="keywordflow">else</span> {
03001 
03002             cxTemp = lpbi-&gt;bmiHeader.biWidth;
03003             cyTemp = lpbi-&gt;bmiHeader.biHeight;
03004             dwTemp = lpbi-&gt;bmiHeader.biCompression;
03005 
03006             lpbi-&gt;bmiHeader.biWidth  = cxNew;
03007             lpbi-&gt;bmiHeader.biHeight = cyNew;
03008 
03009             <span class="keywordflow">if</span> (dwTemp != BI_BITFIELDS)
03010                 lpbi-&gt;bmiHeader.biCompression = BI_RGB;
03011         }
03012 
03013         <span class="keywordflow">if</span> (LR_flags &amp; LR_CREATEREALDIB) {
03014             hbmpNew = CreateDIBitmap(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,
03015                                      (LPBITMAPINFOHEADER)lpbi,
03016                                      CBM_CREATEDIB,
03017                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03018                                      lpbi,
03019                                      DIB_RGB_COLORS);
03020         } <span class="keywordflow">else</span> {
03021             hbmpNew = CreateDIBSection(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,
03022                                        lpbi,
03023                                        DIB_RGB_COLORS,
03024                                        &amp;dwDummy,
03025                                        0,
03026                                        0);
03027         }
03028 
03029         <span class="keywordflow">if</span> (fOldFormat) {
03030             <a class="code" href="../../d4/d9/clres_8c.html#a15">lpbch</a>-&gt;bcWidth  = (WORD)cxTemp;
03031             <a class="code" href="../../d4/d9/clres_8c.html#a15">lpbch</a>-&gt;bcHeight = (WORD)cyTemp;
03032         } <span class="keywordflow">else</span> {
03033             lpbi-&gt;bmiHeader.biWidth       = cxTemp;
03034             lpbi-&gt;bmiHeader.biHeight      = cyTemp;
03035             lpbi-&gt;bmiHeader.biCompression = dwTemp;
03036         }
03037 <span class="preprocessor">#undef lpbch</span>
03038 <span class="preprocessor"></span>    }
03039 
03040     <span class="keywordflow">if</span> (hbmpNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03041 
03042         hbmpNew = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a28">CreateScreenBitmap</a>(cxNew,
03043                                      cyNew,
03044                                      bPlanesNew,
03045                                      bBitsPixelNew,
03046                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03047                                      &amp;f1Bpp);
03048     }
03049 
03050     <span class="keywordflow">if</span> (hbmpNew) {
03051 
03052         <span class="keywordtype">int</span>     nStretchMode;
03053         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   rgbBk;
03054         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   rgbText;
03055         HBITMAP hbmpT;
03056         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fFail;
03057 
03058         <span class="comment">/*</span>
03059 <span class="comment">         * We need to select in appropriate bitmap immediately!  That way,</span>
03060 <span class="comment">         * if we need to handle palette realization, the color matching</span>
03061 <span class="comment">         * will work properly.</span>
03062 <span class="comment">         */</span>
03063         hbmpT = SelectBitmap(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, hbmpNew);
03064 
03065         <span class="comment">/*</span>
03066 <span class="comment">         * Setup for stretching</span>
03067 <span class="comment">         */</span>
03068         <span class="keywordflow">if</span> (fStretch) {
03069             nStretchMode = <a class="code" href="../../d6/d0/usercli_8h.html#a31">SetBestStretchMode</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,
03070                                               bPlanesNew,
03071                                               bBitsPixelNew);
03072         }
03073 
03074         rgbBk   = SetBkColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, <a class="code" href="../../d4/d9/clres_8c.html#a4">RESCLR_WHITE</a>);
03075         rgbText = SetTextColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, <a class="code" href="../../d4/d9/clres_8c.html#a3">RESCLR_BLACK</a>);
03076 
03077         <span class="comment">/*</span>
03078 <span class="comment">         * Realize the palette.</span>
03079 <span class="comment">         */</span>
03080         <span class="keywordflow">if</span> (hpal) {
03081 <span class="preprocessor">#if DBG</span>
03082 <span class="preprocessor"></span>            UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a368">TEST_PUSIF</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a364">PUSIF_PALETTEDISPLAY</a>));
03083 <span class="preprocessor">#endif // DBG</span>
03084 <span class="preprocessor"></span>
03085             hpal = <a class="code" href="../../d3/d0/user32_8def.html#a83">SelectPalette</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, hpal, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03086             <a class="code" href="../../d3/d0/user32_8def.html#a84">RealizePalette</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>);
03087         }
03088 
03089         <span class="keywordflow">if</span> (fStretch) {
03090 
03091             fFail = <a class="code" href="../../d6/d0/usercli_8h.html#a661">SmartStretchDIBits</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,
03092                                0,
03093                                0,
03094                                cxNew,
03095                                cyNew,
03096                                0,
03097                                0,
03098                                cxOld,
03099                                cyOld,
03100                                lpBits,
03101                                lpbi,
03102                                DIB_RGB_COLORS,
03103                                SRCCOPY) &lt;= 0;
03104         } <span class="keywordflow">else</span> {
03105 
03106             fFail = SetDIBits(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,
03107                       hbmpNew,
03108                       0,
03109                       cyNew,
03110                       lpBits,
03111                       lpbi,
03112                       DIB_RGB_COLORS) &lt;= 0;
03113         }
03114 
03115         <span class="comment">/*</span>
03116 <span class="comment">         * Unrealize the palette</span>
03117 <span class="comment">         */</span>
03118         <span class="keywordflow">if</span> (hpal) {
03119             <a class="code" href="../../d3/d0/user32_8def.html#a83">SelectPalette</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, hpal, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03120             <a class="code" href="../../d3/d0/user32_8def.html#a84">RealizePalette</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>);
03121         }
03122 
03123         <span class="comment">/*</span>
03124 <span class="comment">         * Cleanup after stretching</span>
03125 <span class="comment">         */</span>
03126         SetTextColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, rgbText);
03127         SetBkColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, rgbBk);
03128         <span class="keywordflow">if</span> (fStretch)
03129             SetStretchBltMode(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, nStretchMode);
03130 
03131         SelectBitmap(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, hbmpT);
03132 
03133         <span class="comment">/*</span>
03134 <span class="comment">         * If the SetDIBits() of StretchDIBits() failed, it is probably because</span>
03135 <span class="comment">         * GDI or the driver did not like the DIB format.  This may happen if</span>
03136 <span class="comment">         * the file is truncated and we are using a memory mapped file to read</span>
03137 <span class="comment">         * the DIB in.  In this case, an exception gets thrown in GDI, that it</span>
03138 <span class="comment">         * traps and will return failure from the GDI call.</span>
03139 <span class="comment">         */</span>
03140 
03141         <span class="keywordflow">if</span> (fFail) {
03142             DeleteObject(hbmpNew);
03143             hbmpNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03144         }
03145     }
03146 
03147     <span class="comment">/*</span>
03148 <span class="comment">     * If the bitmap was created as a 1bpp, we need to convert to a</span>
03149 <span class="comment">     * true mono-bitmap.  GDI performs different color-matching depending</span>
03150 <span class="comment">     * upon this case.</span>
03151 <span class="comment">     */</span>
03152     <span class="keywordflow">if</span> (f1Bpp &amp;&amp; hbmpNew)
03153         hbmpNew = <a class="code" href="../../d4/d9/clres_8c.html#a71">Convert1BppToMonoBitmap</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, hbmpNew);
03154 
03155     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
03156     <span class="keywordflow">return</span> hbmpNew;
03157 }
03158 
03159 <span class="comment">/***************************************************************************\</span>
03160 <span class="comment">* HowManyColors</span>
03161 <span class="comment">*</span>
03162 <span class="comment">*</span>
03163 <span class="comment">\***************************************************************************/</span>
03164 
<a name="l03165"></a><a class="code" href="../../d4/d9/clres_8c.html#a87">03165</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d9/clres_8c.html#a87">HowManyColors</a>(
03166     IN  <a class="code" href="../../d6/d0/usercli_8h.html#a378">UPBITMAPINFOHEADER</a> upbih,
03167     IN  BOOL               fOldFormat,
03168     OUT OPTIONAL LPBYTE    *ppColorTable)
03169 {
03170 <span class="preprocessor">#define upbch ((UPBITMAPCOREHEADER)upbih)</span>
03171 <span class="preprocessor"></span>
03172     <span class="keywordflow">if</span> (fOldFormat) {
03173         <span class="keywordflow">if</span> (ppColorTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03174             *ppColorTable = (LPBYTE)(<a class="code" href="../../d4/d9/clres_8c.html#a16">upbch</a> + 1);
03175         }
03176         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/clres_8c.html#a16">upbch</a>-&gt;bcBitCount &lt;= 8)
03177             <span class="keywordflow">return</span> (1 &lt;&lt; <a class="code" href="../../d4/d9/clres_8c.html#a16">upbch</a>-&gt;bcBitCount);
03178     } <span class="keywordflow">else</span> {
03179         <span class="keywordflow">if</span> (ppColorTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03180             *ppColorTable = (LPBYTE)(upbih + 1);
03181         }
03182         <span class="keywordflow">if</span> (upbih-&gt;biClrUsed)
03183             <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)upbih-&gt;biClrUsed;
03184         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (upbih-&gt;biBitCount &lt;= 8)
03185             <span class="keywordflow">return</span> (1 &lt;&lt; upbih-&gt;biBitCount);
03186         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((upbih-&gt;biBitCount == 16) || (upbih-&gt;biBitCount == 32))
03187             <span class="keywordflow">return</span> 3;
03188     }
03189     <span class="keywordflow">return</span> 0;
03190 
03191 <span class="preprocessor">#undef upbch</span>
03192 <span class="preprocessor"></span>}
03193 
03194 <span class="comment">/***************************************************************************\</span>
03195 <span class="comment">* ChangeDibColors</span>
03196 <span class="comment">*</span>
03197 <span class="comment">* Given a DIB, processes LR_MONOCHROME, LR_LOADTRANSPARENT and</span>
03198 <span class="comment">* LR_LOADMAP3DCOLORS flags on the given header and colortable.</span>
03199 <span class="comment">*</span>
03200 <span class="comment">*</span>
03201 <span class="comment">\***************************************************************************/</span>
03202 
<a name="l03203"></a><a class="code" href="../../d4/d9/clres_8c.html#a88">03203</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d9/clres_8c.html#a88">ChangeDibColors</a>(
03204     IN LPBITMAPINFOHEADER lpbih,
03205     IN UINT               LR_flags)
03206 {
03207     LPDWORD lpColorTable;
03208     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  rgb;
03209     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   iColor;
03210     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   cColors;
03211 
03212     cColors = <a class="code" href="../../d4/d9/clres_8c.html#a87">HowManyColors</a>(lpbih, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;(LPBYTE)lpColorTable);
03213 
03214     <span class="comment">/*</span>
03215 <span class="comment">     * NT Bug 366661: Don't check the color count here b/c we will do different</span>
03216 <span class="comment">     * things depending on what type of change we are performing.  For example,</span>
03217 <span class="comment">     * when loading hi-color/true-color icons, we always need to do the </span>
03218 <span class="comment">     * monochrome conversion in order to properly get an icon-mask.</span>
03219 <span class="comment">     */</span>
03220 
03221     <span class="comment">/*</span>
03222 <span class="comment">     * LR_MONOCHROME is the only option that handles PM dibs.</span>
03223 <span class="comment">     */</span>
03224     <span class="keywordflow">if</span> (LR_flags &amp; LR_MONOCHROME) {
03225         <span class="comment">/*</span>
03226 <span class="comment">         * LR_MONOCHROME is the only option that handles PM dibs.</span>
03227 <span class="comment">         *</span>
03228 <span class="comment">         * DO THIS NO MATTER WHETHER WE HAVE A COLOR TABLE!  We need </span>
03229 <span class="comment">         * to do this for mono conversion and for &gt; 8 BPP </span>
03230 <span class="comment">         * icons/cursors.  In CopyDibHdr, we already made a copy of </span>
03231 <span class="comment">         * the header big enough to hold 2 colors even on 16 and 24 </span>
03232 <span class="comment">         * BPP images.</span>
03233 <span class="comment">         */</span>
03234 
03235         lpbih-&gt;biBitCount = lpbih-&gt;biPlanes = 1;
03236         lpColorTable[0] = <a class="code" href="../../d4/d9/clres_8c.html#a3">RESCLR_BLACK</a>;
03237         lpColorTable[1] = <a class="code" href="../../d4/d9/clres_8c.html#a4">RESCLR_WHITE</a>;
03238     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (LR_flags &amp; LR_LOADTRANSPARENT) {
03239 
03240         LPBYTE pb;
03241 
03242         <span class="comment">/*</span>
03243 <span class="comment">         * No color table!  Do nothing.</span>
03244 <span class="comment">         */</span>
03245         <span class="keywordflow">if</span> (cColors == 0) {
03246             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ChangeDibColors: DIB doesn't have a color table"</span>);
03247             <span class="keywordflow">return</span>;
03248         }
03249 
03250         pb = (LPBYTE)(lpColorTable + cColors);
03251 
03252         <span class="comment">/*</span>
03253 <span class="comment">         * Change the first pixel's color table entry to RGB_WINDOW</span>
03254 <span class="comment">         * Gosh, I love small-endian</span>
03255 <span class="comment">         */</span>
03256         <span class="keywordflow">if</span> (lpbih-&gt;biCompression == 0)
03257             iColor = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pb[0];
03258         <span class="keywordflow">else</span>
03259             <span class="comment">/*</span>
03260 <span class="comment">             * RLE bitmap, will start with cnt,clr  or  0,cnt,clr</span>
03261 <span class="comment">             */</span>
03262             iColor = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(pb[0] == 0 ? pb[2] : pb[1]);
03263 
03264         <span class="keywordflow">switch</span> (cColors) {
03265         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/clres_8c.html#a0">BPP01_MAXCOLORS</a>:
03266             iColor &amp;= 0x01;
03267             <span class="keywordflow">break</span>;
03268 
03269         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/clres_8c.html#a1">BPP04_MAXCOLORS</a>:
03270             iColor &amp;= 0x0F;
03271             <span class="keywordflow">break</span>;
03272 
03273         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/clres_8c.html#a2">BPP08_MAXCOLORS</a>:
03274             iColor &amp;= 0xFF;
03275             <span class="keywordflow">break</span>;
03276         }
03277 
03278         rgb = (LR_flags &amp; LR_LOADMAP3DCOLORS ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(3DFACE) : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a273">WINDOW</a>));
03279 
03280         lpColorTable[iColor] = <a class="code" href="../../d6/d0/usercli_8h.html#a34">RGBX</a>(rgb);
03281 
03282     } <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (LR_flags &amp; LR_LOADMAP3DCOLORS) {
03283 
03284         <span class="comment">/*</span>
03285 <span class="comment">         * Fix up the color table, mapping shades of grey to the current</span>
03286 <span class="comment">         * 3D colors.</span>
03287 <span class="comment">         */</span>
03288         <span class="keywordflow">for</span> (iColor = 0; iColor &lt; cColors; iColor++) {
03289 
03290             <span class="keywordflow">switch</span> (*lpColorTable &amp; 0x00FFFFFF) {
03291 
03292             <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/usercli_8h.html#a34">RGBX</a>(RGB(223, 223, 223)):
03293                 rgb = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(3DLIGHT);
03294                 <span class="keywordflow">goto</span> <a class="code" href="../../d2/d5/mips_2flush_8c.html#a0">ChangeColor</a>;
03295 
03296             <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/usercli_8h.html#a34">RGBX</a>(RGB(192, 192, 192)):
03297                 rgb = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(3DFACE);
03298                 <span class="keywordflow">goto</span> <a class="code" href="../../d2/d5/mips_2flush_8c.html#a0">ChangeColor</a>;
03299 
03300             <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/usercli_8h.html#a34">RGBX</a>(RGB(128, 128, 128)):
03301                 rgb = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(3DSHADOW);
03302 
03303                 <span class="comment">/*</span>
03304 <span class="comment">                 * NOTE: byte-order is different in DIBs than in RGBs</span>
03305 <span class="comment">                 */</span>
03306 <a class="code" href="../../d2/d5/mips_2flush_8c.html#a0">ChangeColor</a>:
03307                 *lpColorTable = <a class="code" href="../../d6/d0/usercli_8h.html#a34">RGBX</a>(rgb);
03308                 <span class="keywordflow">break</span>;
03309             }
03310             lpColorTable++;
03311         }
03312     }
03313 }
03314 
03315 <span class="comment">/***************************************************************************\</span>
03316 <span class="comment">* ConvertDIBIcon</span>
03317 <span class="comment">*</span>
03318 <span class="comment">* Called when a cursor/icon in DIB format is loaded.  This converts the</span>
03319 <span class="comment">* cursor/icon into the old format and returns the resource handle.  IE,</span>
03320 <span class="comment">* grabs the DIB bits and transforms them into physical bitmap bits.</span>
03321 <span class="comment">*</span>
03322 <span class="comment">*</span>
03323 <span class="comment">* DIB Formats for icons/cursors 101</span>
03324 <span class="comment">*</span>
03325 <span class="comment">* Old Win 3.0 format icons/cursors start with an OLDICON/OLDCURSOR header</span>
03326 <span class="comment">* followed by a double high monochrome DIB.  The height refered to in the</span>
03327 <span class="comment">* header is the icon/cursor height, not the DIB height which is twice as</span>
03328 <span class="comment">* high.  The XOR mask is in the first-half of the DIB bits.</span>
03329 <span class="comment">*</span>
03330 <span class="comment">* Old PM format icons/cursors start with a BITMAPCOREHEADER and</span>
03331 <span class="comment">* are identical to the current win 3.1/NT format thereafter.</span>
03332 <span class="comment">*</span>
03333 <span class="comment">* Current NT/Chicago/Win 3.1 format icons/cursors start with</span>
03334 <span class="comment">* a BITAMPINFOHEADER.  The height of this header refers to the height</span>
03335 <span class="comment">* of the first bitmap which may either be color or truely monochrome.</span>
03336 <span class="comment">* If its color, it is followed by the monochrome AND mask bits imediately</span>
03337 <span class="comment">* after the color bits.  If it is truely monochrome, the AND and XOR</span>
03338 <span class="comment">* masks are totally contained in the first DIB bits and no more bits</span>
03339 <span class="comment">* follow.</span>
03340 <span class="comment">*</span>
03341 <span class="comment">* 5-Oct-1994 SanfordS   Recreated</span>
03342 <span class="comment">\***************************************************************************/</span>
03343 
<a name="l03344"></a><a class="code" href="../../d6/d0/usercli_8h.html#a660">03344</a> HICON <a class="code" href="../../d6/d0/usercli_8h.html#a660">ConvertDIBIcon</a>(
03345     LPBITMAPINFOHEADER lpbih,
03346     HINSTANCE          hmod,
03347     LPCWSTR            lpName,
03348     BOOL               fIcon,
03349     DWORD              cxNew,
03350     DWORD              cyNew,
03351     UINT               LR_flags)
03352 {
03353     LPBITMAPINFOHEADER lpbihNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03354     LPSTR              lpBitsNextMask = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03355     HICON              hicoNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03356     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>               fOldFormat = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03357     <a class="code" href="../../d8/d1/structtagCURSORDATA.html">CURSORDATA</a>         cur;
03358     WCHAR              achModName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
03359 
03360     <span class="comment">/*</span>
03361 <span class="comment">     * Because Icons/Cursors always get public bitmaps, we cannot use</span>
03362 <span class="comment">     * LR_CREATEDIBSECTION on them.</span>
03363 <span class="comment">     */</span>
03364     <span class="keywordflow">if</span> (LR_flags &amp; LR_CREATEDIBSECTION)
03365         LR_flags = (LR_flags &amp; ~LR_CREATEDIBSECTION) | LR_CREATEREALDIB;
03366 
03367     RtlZeroMemory(&amp;cur, <span class="keyword">sizeof</span>(cur));
03368 
03369     <span class="keywordflow">if</span> (!fIcon) {
03370         <span class="comment">/*</span>
03371 <span class="comment">         * Cursors have an extra two words preceeding the BITMAPINFOHEADER</span>
03372 <span class="comment">         * indicating the hot-spot.  After doing the increments, the</span>
03373 <span class="comment">         * pointer should be at the dib-header.</span>
03374 <span class="comment">         */</span>
03375         cur.xHotspot = (<span class="keywordtype">short</span>)(<span class="keywordtype">int</span>)*(((LPWORD)lpbih)++);
03376         cur.yHotspot = (<span class="keywordtype">short</span>)(<span class="keywordtype">int</span>)*(((LPWORD)lpbih)++);
03377     }
03378 
03379     <span class="comment">/*</span>
03380 <span class="comment">     * Get the XOR/Color mask.</span>
03381 <span class="comment">     * The XOR bits are first in the DIB because the header info</span>
03382 <span class="comment">     * pertains to them.</span>
03383 <span class="comment">     * The AND mask is always monochrome.</span>
03384 <span class="comment">     */</span>
03385     lpBitsNextMask = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;  <span class="comment">// not passing lpBits in.</span>
03386     cur.hbmColor = <a class="code" href="../../d6/d0/usercli_8h.html#a659">ConvertDIBBitmap</a>(lpbih,
03387                                     cxNew,
03388                                     cyNew,
03389                                     LR_flags,
03390                                     &amp;lpbihNew,
03391                                     &amp;lpBitsNextMask);
03392     <span class="keywordflow">if</span> (cur.hbmColor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03393         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03394 
03395     <span class="keywordflow">if</span> (hmod == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03396         cur.lpModName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03397     } <span class="keywordflow">else</span> {
03398         cur.CURSORF_flags = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a534">CURSORF_FROMRESOURCE</a>;
03399         <span class="keywordflow">if</span> (hmod == <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>) {
03400             cur.lpModName     = <a class="code" href="../../d1/d8/clglobal_8c.html#a12">szUSER32</a>;
03401         } <span class="keywordflow">else</span>  {
03402             <a class="code" href="../../d6/d0/usercli_8h.html#a647">WowGetModuleFileName</a>(hmod,
03403                               achModName,
03404                               <span class="keyword">sizeof</span>(achModName) / <span class="keyword">sizeof</span>(WCHAR));
03405             cur.lpModName = achModName;
03406         }
03407     }
03408     cur.rt     = (fIcon ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_ICON) : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_CURSOR));
03409     cur.lpName = (LPWSTR)lpName;
03410     cur.bpp    = lpbihNew-&gt;biBitCount * lpbihNew-&gt;biPlanes;
03411 
03412     <span class="keywordflow">if</span> (cxNew == 0)
03413         cxNew = lpbihNew-&gt;biWidth;
03414 
03415     <span class="keywordflow">if</span> (cyNew == 0)
03416         cyNew = lpbihNew-&gt;biHeight / 2;
03417 
03418     <span class="keywordflow">if</span> (!fIcon) {
03419 
03420         cur.xHotspot = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(cur.xHotspot,
03421                                cxNew,
03422                                lpbihNew-&gt;biWidth);
03423         cur.yHotspot = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(cur.yHotspot,
03424                                cyNew,
03425                                lpbihNew-&gt;biHeight / 2);
03426     } <span class="keywordflow">else</span> {
03427 
03428         <span class="comment">/*</span>
03429 <span class="comment">         * For an icon the hot spot is the center of the icon</span>
03430 <span class="comment">         */</span>
03431         cur.xHotspot = (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)(cxNew) / 2;
03432         cur.yHotspot = (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)(cyNew) / 2;
03433     }
03434 
03435     <span class="comment">/*</span>
03436 <span class="comment">     * Setup header for monochrome DIB.  Note that we use the COPY.</span>
03437 <span class="comment">     */</span>
03438     <a class="code" href="../../d4/d9/clres_8c.html#a88">ChangeDibColors</a>(lpbihNew, LR_MONOCHROME);
03439 
03440     <span class="keywordflow">if</span> (lpBitsNextMask != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03441         cur.hbmMask = <a class="code" href="../../d4/d9/clres_8c.html#a86">BitmapFromDIB</a>(cxNew,
03442                                     cyNew * 2,
03443                                     1,
03444                                     1,
03445                                     0,
03446                                     lpbihNew-&gt;biWidth,
03447                                     lpbihNew-&gt;biHeight,
03448                                     lpBitsNextMask,
03449                                     (LPBITMAPINFO)lpbihNew,
03450                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03451         <span class="keywordflow">if</span> (cur.hbmMask == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03452             DeleteObject(cur.hbmColor);
03453             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpbihNew);
03454             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03455         }
03456 
03457     } <span class="keywordflow">else</span> {
03458         cur.hbmMask = cur.hbmColor;
03459         cur.hbmColor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03460     }
03461 
03462     cur.cx = cxNew;
03463     cur.cy = cyNew * 2;
03464 
03465     <span class="comment">/*</span>
03466 <span class="comment">     * Free our dib header copy allocated by ConvertDIBBitmap</span>
03467 <span class="comment">     */</span>
03468     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpbihNew);
03469 
03470     <span class="keywordflow">if</span> (LR_flags &amp; LR_SHARED)
03471         cur.CURSORF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a536">CURSORF_LRSHARED</a>;
03472 
03473     <span class="keywordflow">if</span> (LR_flags &amp; LR_GLOBAL)
03474         cur.CURSORF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a535">CURSORF_GLOBAL</a>;
03475 
03476     <span class="keywordflow">if</span> (LR_flags &amp; LR_ACONFRAME)
03477         cur.CURSORF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a539">CURSORF_ACONFRAME</a>;
03478 
03479     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a56">CreateIcoCur</a>(&amp;cur);
03480 }
03481 
03482 <span class="comment">/***************************************************************************\</span>
03483 <span class="comment">* TrulyMonochrome</span>
03484 <span class="comment">*</span>
03485 <span class="comment">* Checks to see if a DIB colro table is truly monochrome.  ie: the color</span>
03486 <span class="comment">* table has black &amp; white entries only.</span>
03487 <span class="comment">*</span>
03488 <span class="comment">\***************************************************************************/</span>
03489 
<a name="l03490"></a><a class="code" href="../../d4/d9/clres_8c.html#a90">03490</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d9/clres_8c.html#a90">TrulyMonochrome</a>(
03491     LPVOID lpColorTable,
03492     BOOL   fOldFormat)
03493 {
03494 <span class="preprocessor">    #define lpRGB  ((UNALIGNED LONG *)lpColorTable)</span>
03495 <span class="preprocessor"></span><span class="preprocessor">    #define lpRGBw ((UNALIGNED WORD *)lpColorTable)</span>
03496 <span class="preprocessor"></span>
03497     <span class="keywordflow">if</span> (fOldFormat) {
03498 
03499         <span class="comment">/*</span>
03500 <span class="comment">         * Honey - its triplets.</span>
03501 <span class="comment">         */</span>
03502         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/clres_8c.html#a18">lpRGBw</a>[0] == 0x0000)
03503             <span class="keywordflow">return</span> (<a class="code" href="../../d4/d9/clres_8c.html#a18">lpRGBw</a>[1] == 0xFF00) &amp;&amp; (<a class="code" href="../../d4/d9/clres_8c.html#a18">lpRGBw</a>[2] == 0xFFFF);
03504         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/clres_8c.html#a18">lpRGBw</a>[0] == 0xFFFF)
03505             <span class="keywordflow">return</span> (<a class="code" href="../../d4/d9/clres_8c.html#a18">lpRGBw</a>[1] == 0x00FF) &amp;&amp; (<a class="code" href="../../d4/d9/clres_8c.html#a18">lpRGBw</a>[2] == 0x0000);
03506 
03507     } <span class="keywordflow">else</span> {
03508 
03509         <span class="comment">/*</span>
03510 <span class="comment">         * Honey - its quadruplets!</span>
03511 <span class="comment">         */</span>
03512         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/clres_8c.html#a17">lpRGB</a>[0] == <a class="code" href="../../d4/d9/clres_8c.html#a3">RESCLR_BLACK</a>)
03513             <span class="keywordflow">return</span> (<a class="code" href="../../d4/d9/clres_8c.html#a17">lpRGB</a>[1] == <a class="code" href="../../d4/d9/clres_8c.html#a4">RESCLR_WHITE</a>);
03514         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/clres_8c.html#a17">lpRGB</a>[0] == <a class="code" href="../../d4/d9/clres_8c.html#a4">RESCLR_WHITE</a>)
03515             <span class="keywordflow">return</span> (<a class="code" href="../../d4/d9/clres_8c.html#a17">lpRGB</a>[1] == <a class="code" href="../../d4/d9/clres_8c.html#a3">RESCLR_BLACK</a>);
03516     }
03517 
03518 <span class="preprocessor">    #undef lpRGB</span>
03519 <span class="preprocessor"></span><span class="preprocessor">    #undef lpRGBw</span>
03520 <span class="preprocessor"></span>
03521     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03522 }
03523 
03524 <span class="comment">/***************************************************************************\</span>
03525 <span class="comment">* CopyDibHdr</span>
03526 <span class="comment">*</span>
03527 <span class="comment">* Copies and converts a DIB resource header</span>
03528 <span class="comment">*</span>
03529 <span class="comment">* Handles conversion of OLDICON, OLDCURSOR and BITMAPCOREHEADER</span>
03530 <span class="comment">* structures to BITMAPINFOHEADER headers.</span>
03531 <span class="comment">*</span>
03532 <span class="comment">* Note: fSingleHeightMasks is set for OLDICON and OLDCURSOR formats.</span>
03533 <span class="comment">*       This identifies that a monochrome AND/Color mask</span>
03534 <span class="comment">*       is NOT double height as it is in the newer formats.</span>
03535 <span class="comment">*</span>
03536 <span class="comment">* NOTE:  On the off chance that LR_LOADTRANSPARENT is used, we want to</span>
03537 <span class="comment">*     copy a DWORD of the bits.  Since DIB bits are DWORD aligned, we know</span>
03538 <span class="comment">*     at least a DWORD is there, even if the thing is a 1x1 mono bmp.</span>
03539 <span class="comment">*</span>
03540 <span class="comment">* The returned buffer is allocated in this function and needs to be</span>
03541 <span class="comment">* freed by the caller.</span>
03542 <span class="comment">*</span>
03543 <span class="comment">* 22-Oct-1995 SanfordS  Revised</span>
03544 <span class="comment">\***************************************************************************/</span>
03545 
<a name="l03546"></a><a class="code" href="../../d4/d9/clres_8c.html#a91">03546</a> LPBITMAPINFOHEADER <a class="code" href="../../d4/d9/clres_8c.html#a91">CopyDibHdr</a>(
03547     IN  UPBITMAPINFOHEADER upbih,
03548     OUT LPSTR             *lplpBits,
03549     OUT LPBOOL             lpfMono)
03550 {
03551 
03552 <span class="preprocessor">#define upbch ((UPBITMAPCOREHEADER)upbih)</span>
03553 <span class="preprocessor"></span>
03554     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              cColors;
03555     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              i;
03556     LPBITMAPINFOHEADER lpbihNew;
03557     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              cbAlloc;
03558     LPBYTE             lpColorTable;
03559     <span class="keyword">struct  </span>{
03560         BITMAPINFOHEADER   bih;
03561         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              rgb[256];
03562         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              dwBuffer;
03563     } Fake;
03564 
03565     <span class="keywordflow">switch</span> (upbih-&gt;biSize) {
03566     <span class="keywordflow">case</span> <span class="keyword">sizeof</span>(BITMAPINFOHEADER):
03567         <span class="comment">/*</span>
03568 <span class="comment">         * Cool.  No conversion needed.</span>
03569 <span class="comment">         */</span>
03570         cColors   = <a class="code" href="../../d4/d9/clres_8c.html#a87">HowManyColors</a>(upbih, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;lpColorTable);
03571         *lplpBits = (LPSTR)(((LPDWORD)lpColorTable) + cColors);
03572         <span class="keywordflow">break</span>;
03573 
03574     <span class="keywordflow">case</span> <span class="keyword">sizeof</span>(BITMAPCOREHEADER):
03575         <span class="comment">/*</span>
03576 <span class="comment">         * Convert the BITMAPCOREHEADER to a BITMAPINFOHEADER</span>
03577 <span class="comment">         */</span>
03578         Fake.bih.biSize          = <span class="keyword">sizeof</span>(BITMAPINFOHEADER);
03579         Fake.bih.biWidth         = <a class="code" href="../../d4/d9/clres_8c.html#a16">upbch</a>-&gt;bcWidth;
03580         Fake.bih.biHeight        = <a class="code" href="../../d4/d9/clres_8c.html#a16">upbch</a>-&gt;bcHeight;
03581         Fake.bih.biPlanes        = <a class="code" href="../../d4/d9/clres_8c.html#a16">upbch</a>-&gt;bcPlanes;
03582         Fake.bih.biBitCount      = <a class="code" href="../../d4/d9/clres_8c.html#a16">upbch</a>-&gt;bcBitCount;
03583         Fake.bih.biCompression   =
03584         Fake.bih.biXPelsPerMeter =
03585         Fake.bih.biYPelsPerMeter =
03586         Fake.bih.biClrImportant  = 0;
03587         Fake.bih.biClrUsed       = cColors =
03588                                    <a class="code" href="../../d4/d9/clres_8c.html#a87">HowManyColors</a>(upbih, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;lpColorTable);
03589         Fake.bih.biSizeImage     =
03590                 <a class="code" href="../../d6/d0/usercli_8h.html#a33">BitmapWidth</a>(Fake.bih.biWidth, Fake.bih.biBitCount) *
03591                             Fake.bih.biHeight;
03592         <span class="comment">/*</span>
03593 <span class="comment">         * Copy and convert tripplet color table to rgbQuad color table.</span>
03594 <span class="comment">         */</span>
03595         <span class="keywordflow">for</span> (i = 0; i &lt; cColors; i++, lpColorTable += 3) {
03596 
03597             Fake.rgb[i] = lpColorTable[0]        +
03598                           (lpColorTable[1] &lt;&lt; 8) +
03599                           (lpColorTable[2] &lt;&lt; 16);
03600         }
03601 
03602         Fake.rgb[i] = *(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> UNALIGNED *)lpColorTable;  <span class="comment">// For LR_LOADTRANSPARENT</span>
03603         upbih       = (<a class="code" href="../../d6/d0/usercli_8h.html#a378">UPBITMAPINFOHEADER</a>)&amp;Fake;
03604         *lplpBits   = lpColorTable;
03605         <span class="keywordflow">break</span>;
03606 
03607     <span class="keywordflow">default</span>:
03608 
03609 <span class="preprocessor">#define upOldIcoCur ((UPOLDCURSOR)upbih)</span>
03610 <span class="preprocessor"></span>
03611         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/clres_8c.html#a20">upOldIcoCur</a>-&gt;bType == <a class="code" href="../../d4/d9/clres_8c.html#a5">BMR_ICON</a> ||
03612                 <a class="code" href="../../d4/d9/clres_8c.html#a20">upOldIcoCur</a>-&gt;bType == <a class="code" href="../../d4/d9/clres_8c.html#a7">BMR_CURSOR</a>) {
03613             <span class="comment">/*</span>
03614 <span class="comment">             * Convert OLDICON/OLDCURSOR header to BITMAPINFHEADER</span>
03615 <span class="comment">             */</span>
03616             RIPMSG0(RIP_WARNING, <span class="stringliteral">"USER32:Converting a OLD header. - email sanfords if you see this"</span>);
03617             Fake.bih.biSize          = <span class="keyword">sizeof</span>(BITMAPINFOHEADER);
03618             Fake.bih.biWidth         = <a class="code" href="../../d4/d9/clres_8c.html#a20">upOldIcoCur</a>-&gt;cx;
03619             Fake.bih.biHeight        = <a class="code" href="../../d4/d9/clres_8c.html#a20">upOldIcoCur</a>-&gt;cy * 2;
03620             Fake.bih.biPlanes        =
03621             Fake.bih.biBitCount      = 1;
03622             Fake.bih.biCompression   =
03623             Fake.bih.biXPelsPerMeter =
03624             Fake.bih.biYPelsPerMeter =
03625             Fake.bih.biClrImportant  = 0;
03626             Fake.bih.biClrUsed       = cColors = <a class="code" href="../../d4/d9/clres_8c.html#a0">BPP01_MAXCOLORS</a>;
03627             Fake.bih.biSizeImage     =
03628                     <a class="code" href="../../d6/d0/usercli_8h.html#a33">BitmapWidth</a>(<a class="code" href="../../d4/d9/clres_8c.html#a20">upOldIcoCur</a>-&gt;cx, 1) * <a class="code" href="../../d4/d9/clres_8c.html#a20">upOldIcoCur</a>-&gt;cy;
03629             Fake.rgb[0]              = <a class="code" href="../../d4/d9/clres_8c.html#a3">RESCLR_BLACK</a>;
03630             Fake.rgb[1]              = <a class="code" href="../../d4/d9/clres_8c.html#a4">RESCLR_WHITE</a>;
03631             upbih                    = (LPBITMAPINFOHEADER)&amp;Fake;
03632             *lplpBits                = <a class="code" href="../../d4/d9/clres_8c.html#a20">upOldIcoCur</a>-&gt;abBitmap;
03633             Fake.rgb[2]              = *((LPDWORD)*lplpBits);  <span class="comment">// For LR_LOADTRANSPARENT</span>
03634 
03635         } <span class="keywordflow">else</span> {
03636 
03637             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ConvertDIBBitmap: not a valid format"</span>);
03638             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03639         }
03640 
03641 <span class="preprocessor">#undef pOldIcoCur</span>
03642 <span class="preprocessor"></span>
03643         <span class="keywordflow">break</span>;
03644     }
03645 
03646     *lpfMono = (cColors == <a class="code" href="../../d4/d9/clres_8c.html#a0">BPP01_MAXCOLORS</a>) &amp;&amp;
03647             <a class="code" href="../../d4/d9/clres_8c.html#a90">TrulyMonochrome</a>((LPBYTE)upbih + <span class="keyword">sizeof</span>(BITMAPINFOHEADER), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03648 
03649     cbAlloc = <span class="keyword">sizeof</span>(BITMAPINFOHEADER) + (cColors * <span class="keyword">sizeof</span>(RGBQUAD)) + 4;
03650 
03651     <span class="keywordflow">if</span> (lpbihNew = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, cbAlloc))
03652         RtlCopyMemory(lpbihNew, upbih, cbAlloc);
03653 
03654     <span class="keywordflow">return</span> lpbihNew;
03655 
03656 <span class="preprocessor">#undef upbch</span>
03657 <span class="preprocessor"></span>
03658 }
03659 
03660 <span class="comment">/***************************************************************************\</span>
03661 <span class="comment">* ConvertDIBBitmap</span>
03662 <span class="comment">*</span>
03663 <span class="comment">* This takes a BITMAPCOREHEADER, OLDICON, OLDCURSOR or BITMAPINFOHEADER DIB</span>
03664 <span class="comment">* specification and creates a physical object from it.</span>
03665 <span class="comment">* Handles Color fixups, DIB sections, color depth, and stretching options.</span>
03666 <span class="comment">*</span>
03667 <span class="comment">* Passes back: (if lplpbih is not NULL)</span>
03668 <span class="comment">*   lplpbih = copy of given header converted to BITMAPINFOHEADER form.</span>
03669 <span class="comment">*   lplpBits = pointer to next mask bits, or NULL if no second mask.</span>
03670 <span class="comment">*   Caller must free lplpbih returned.</span>
03671 <span class="comment">*</span>
03672 <span class="comment">* If lplpBits is not NULL and points to a non-NULL value, it supplies</span>
03673 <span class="comment">* the location of the DIB bits allowing the header to be from a different</span>
03674 <span class="comment">* location.</span>
03675 <span class="comment">*</span>
03676 <span class="comment">* 04-Oct-1995 SanfordS  Recreated.</span>
03677 <span class="comment">\***************************************************************************/</span>
03678 
<a name="l03679"></a><a class="code" href="../../d4/d9/clres_8c.html#a92">03679</a> HBITMAP <a class="code" href="../../d6/d0/usercli_8h.html#a659">ConvertDIBBitmap</a>(
03680     IN  UPBITMAPINFOHEADER           upbih,
03681     IN  DWORD                        cxDesired,
03682     IN  DWORD                        cyDesired,
03683     IN  UINT                         LR_flags,
03684     OUT OPTIONAL LPBITMAPINFOHEADER *lplpbih,
03685     IN OUT OPTIONAL LPSTR           *lplpBits)
03686 {
03687     LPBITMAPINFOHEADER lpbihNew;
03688     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>               fMono, fMonoGiven;
03689     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>               bPlanesDesired;
03690     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>               bppDesired;
03691     LPSTR              lpBits;
03692     HBITMAP            hBmpRet;
03693 
03694     <span class="comment">/*</span>
03695 <span class="comment">     * Make a copy of the DIB-Header.  This returns a pointer</span>
03696 <span class="comment">     * which was allocated, so it must be freed later.</span>
03697 <span class="comment">     * The also converts the header to BITMAPINFOHEADER format.</span>
03698 <span class="comment">     */</span>
03699     <span class="keywordflow">if</span> ((lpbihNew = <a class="code" href="../../d4/d9/clres_8c.html#a91">CopyDibHdr</a>(upbih, &amp;lpBits, &amp;fMono)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03700         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03701 
03702     <span class="comment">/*</span>
03703 <span class="comment">     * When loading a DIB file, we may need to use a different</span>
03704 <span class="comment">     * bits pointer.  See RtlRes.c/RtlLoadObjectFromDIBFile.</span>
03705 <span class="comment">     */</span>
03706     <span class="keywordflow">if</span> (lplpBits &amp;&amp; *lplpBits)
03707         lpBits = *lplpBits;
03708 
03709     fMonoGiven = fMono;
03710 
03711     <span class="keywordflow">if</span> (!fMono) {
03712 
03713         <span class="keywordflow">if</span> (LR_flags &amp; (LR_LOADTRANSPARENT | LR_LOADMAP3DCOLORS))
03714             <a class="code" href="../../d4/d9/clres_8c.html#a88">ChangeDibColors</a>(lpbihNew, LR_flags &amp; ~LR_MONOCHROME);
03715 
03716         bPlanesDesired = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;Planes;
03717         bppDesired     = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;BitsPixel;
03718         fMono          = LR_flags &amp; LR_MONOCHROME;
03719     }
03720 
03721     <span class="keywordflow">if</span> (fMono) {
03722         bPlanesDesired =
03723         bppDesired     = 1;
03724     }
03725 
03726     <span class="comment">/*</span>
03727 <span class="comment">     * HACK area</span>
03728 <span class="comment">     */</span>
03729     <span class="keywordflow">if</span> (lplpbih != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03730 
03731         <span class="comment">/*</span>
03732 <span class="comment">         * pass back the translated/copied header</span>
03733 <span class="comment">         */</span>
03734         *lplpbih = lpbihNew;
03735 
03736         <span class="comment">/*</span>
03737 <span class="comment">         * When loading icon/cursors on a system with multiple monitors</span>
03738 <span class="comment">         * with different color depths, always convert to VGA color.</span>
03739 <span class="comment">         */</span>
03740         <span class="keywordflow">if</span> (!fMono &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(SAMEDISPLAYFORMAT)) {
03741             bPlanesDesired = 1;
03742             bppDesired = 4;
03743         }
03744 
03745         <span class="comment">/*</span>
03746 <span class="comment">         * Return a ponter to the bits following this set of bits</span>
03747 <span class="comment">         * if there are any there.</span>
03748 <span class="comment">         *</span>
03749 <span class="comment">         * Note that the header given with an ICON DIB always reflects</span>
03750 <span class="comment">         * twice the height of the icon desired but the COLOR bitmap</span>
03751 <span class="comment">         * (if there is one) will only be half that high.  We need to</span>
03752 <span class="comment">         * fixup cyDesired for monochrome icons so that the mask isnt</span>
03753 <span class="comment">         * stretched to half the height its supposed to be.  Color</span>
03754 <span class="comment">         * bitmaps, however, must have the header corrected to reflect</span>
03755 <span class="comment">         * the bits actual height which is half what the header said.</span>
03756 <span class="comment">         * The correction must later be backed out so that the returned</span>
03757 <span class="comment">         * header reflects the dimensions of the XOR mask that immediately</span>
03758 <span class="comment">         * follows the color mask.</span>
03759 <span class="comment">         */</span>
03760         <span class="keywordflow">if</span> (fMonoGiven) {
03761 
03762             *lplpBits = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03763 
03764             <span class="keywordflow">if</span> (cyDesired)
03765                 cyDesired &lt;&lt;= 1;    <span class="comment">// mono icon bitmaps are double high.</span>
03766 
03767         } <span class="keywordflow">else</span> {
03768 
03769             UserAssert(!(lpbihNew-&gt;biHeight &amp; 1));
03770             lpbihNew-&gt;biHeight &gt;&gt;= 1;  <span class="comment">// color icon headers are off by 2</span>
03771 
03772             <span class="comment">/*</span>
03773 <span class="comment">             * Gross calculation!  We subtract the XOR part of the mask</span>
03774 <span class="comment">             * for this calculation so that we submit a double-high mask.</span>
03775 <span class="comment">             * The first half of this is garbage, but for icons its not</span>
03776 <span class="comment">             * used.  This may be a bug for cursor use of icons.</span>
03777 <span class="comment">             */</span>
03778             *lplpBits = lpBits +
03779                     (<a class="code" href="../../d6/d0/usercli_8h.html#a33">BitmapWidth</a>(lpbihNew-&gt;biWidth, lpbihNew-&gt;biBitCount) -
03780                     <a class="code" href="../../d6/d0/usercli_8h.html#a33">BitmapWidth</a>(lpbihNew-&gt;biWidth, 1)) *
03781                     lpbihNew-&gt;biHeight;
03782         }
03783     }
03784 
03785     <span class="keywordflow">if</span> (cxDesired == 0)
03786         cxDesired = lpbihNew-&gt;biWidth;
03787 
03788     <span class="keywordflow">if</span> (cyDesired == 0)
03789         cyDesired = lpbihNew-&gt;biHeight;
03790 
03791     hBmpRet = <a class="code" href="../../d4/d9/clres_8c.html#a86">BitmapFromDIB</a>(cxDesired,
03792                             cyDesired,
03793                             bPlanesDesired,
03794                             bppDesired,
03795                             LR_flags,
03796                             lpbihNew-&gt;biWidth,
03797                             lpbihNew-&gt;biHeight,
03798                             lpBits,
03799                             (LPBITMAPINFO)lpbihNew,
03800                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03801 
03802     <span class="keywordflow">if</span> (lplpbih == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || hBmpRet == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03803         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpbihNew);
03804     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fMonoGiven) {
03805         lpbihNew-&gt;biHeight &lt;&lt;= 1;   <span class="comment">// restore header for next mask</span>
03806     }
03807 
03808     <span class="keywordflow">return</span> hBmpRet;
03809 }
03810 
03811 <span class="comment">/***************************************************************************\</span>
03812 <span class="comment">* MyAbs</span>
03813 <span class="comment">*</span>
03814 <span class="comment">* Calcules my weighted absolute value of the difference between 2 nums.</span>
03815 <span class="comment">* This of course normalizes values to &gt;= zero.  But it also doubles them</span>
03816 <span class="comment">* if valueHave &lt; valueWant.  This is because you get worse results trying</span>
03817 <span class="comment">* to extrapolate from less info up then interpolating from more info down.</span>
03818 <span class="comment">* I paid $150 to take the SAT.  I'm damned well going to get my vocab's</span>
03819 <span class="comment">* money worth.</span>
03820 <span class="comment">*</span>
03821 <span class="comment">\***************************************************************************/</span>
03822 
<a name="l03823"></a><a class="code" href="../../d4/d9/clres_8c.html#a93">03823</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d9/clres_8c.html#a93">MyAbs</a>(
03824     <span class="keywordtype">int</span> valueHave,
03825     <span class="keywordtype">int</span> valueWant)
03826 {
03827     <span class="keywordtype">int</span> diff = (valueHave - valueWant);
03828 
03829     <span class="keywordflow">if</span> (diff &lt; 0)
03830         diff = 2 * (-diff);
03831 
03832     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)diff;
03833 }
03834 
03835 <span class="comment">/***************************************************************************\</span>
03836 <span class="comment">* Magnitude</span>
03837 <span class="comment">*</span>
03838 <span class="comment">* Used by the color-delta calculations.  The reason is that num colors is</span>
03839 <span class="comment">* always a power of 2.  So we use the log 2 of the want vs. have values</span>
03840 <span class="comment">* to avoid having weirdly huge sets.</span>
03841 <span class="comment">*</span>
03842 <span class="comment">\***************************************************************************/</span>
03843 
<a name="l03844"></a><a class="code" href="../../d4/d9/clres_8c.html#a94">03844</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d9/clres_8c.html#a94">Magnitude</a>(
03845     <span class="keywordtype">int</span> nValue)
03846 {
03847     <span class="keywordflow">if</span> (nValue &lt; 4)
03848         <span class="keywordflow">return</span> 1;
03849     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nValue &lt; 8)
03850         <span class="keywordflow">return</span> 2;
03851     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nValue &lt; 16)
03852         <span class="keywordflow">return</span> 3;
03853     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nValue &lt; 256)
03854         <span class="keywordflow">return</span> 4;
03855     <span class="keywordflow">else</span>
03856         <span class="keywordflow">return</span> 8;
03857 }
03858 
03859 <span class="comment">/***************************************************************************\</span>
03860 <span class="comment">* MatchImage</span>
03861 <span class="comment">*</span>
03862 <span class="comment">* This function takes LPINTs for width &amp; height in case of "real size".</span>
03863 <span class="comment">* For this option, we use dimensions of 1st icon in resdir as size to</span>
03864 <span class="comment">* load, instead of system metrics.</span>
03865 <span class="comment">*</span>
03866 <span class="comment">* Returns a number that measures how "far away" the given image is</span>
03867 <span class="comment">* from a desired one.  The value is 0 for an exact match.  Note that our</span>
03868 <span class="comment">* formula has the following properties:</span>
03869 <span class="comment">*     (1) Differences in width/height count much more than differences in</span>
03870 <span class="comment">*         color format.</span>
03871 <span class="comment">*     (2) Fewer colors give a smaller difference than more</span>
03872 <span class="comment">*     (3) Bigger images are better than smaller, since shrinking produces</span>
03873 <span class="comment">*             better results than stretching.</span>
03874 <span class="comment">*</span>
03875 <span class="comment">* The formula is the sum of the following terms:</span>
03876 <span class="comment">*     Log2(colors wanted) - Log2(colors really), times -2 if the image</span>
03877 <span class="comment">*         has more colors than we'd like.  This is because we will lose</span>
03878 <span class="comment">*         information when converting to fewer colors, like 16 color to</span>
03879 <span class="comment">*         monochrome.</span>
03880 <span class="comment">*     Log2(width really) - Log2(width wanted), times -2 if the image is</span>
03881 <span class="comment">*         narrower than what we'd like.  This is because we will get a</span>
03882 <span class="comment">*         better result when consolidating more information into a smaller</span>
03883 <span class="comment">*         space, than when extrapolating from less information to more.</span>
03884 <span class="comment">*     Log2(height really) - Log2(height wanted), times -2 if the image is</span>
03885 <span class="comment">*         shorter than what we'd like.  This is for the same reason as</span>
03886 <span class="comment">*         the width.</span>
03887 <span class="comment">*</span>
03888 <span class="comment">* Let's step through an example.  Suppose we want a 16 color, 32x32 image,</span>
03889 <span class="comment">* and are choosing from the following list:</span>
03890 <span class="comment">*     16 color, 64x64 image</span>
03891 <span class="comment">*     16 color, 16x16 image</span>
03892 <span class="comment">*      8 color, 32x32 image</span>
03893 <span class="comment">*      2 color, 32x32 image</span>
03894 <span class="comment">*</span>
03895 <span class="comment">* We'd prefer the images in the following order:</span>
03896 <span class="comment">*      8 color, 32x32         : Match value is 0 + 0 + 1     == 1</span>
03897 <span class="comment">*     16 color, 64x64         : Match value is 1 + 1 + 0     == 2</span>
03898 <span class="comment">*      2 color, 32x32         : Match value is 0 + 0 + 3     == 3</span>
03899 <span class="comment">*     16 color, 16x16         : Match value is 2*1 + 2*1 + 0 == 4</span>
03900 <span class="comment">*</span>
03901 <span class="comment">\***************************************************************************/</span>
03902 
<a name="l03903"></a><a class="code" href="../../d4/d9/clres_8c.html#a95">03903</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d9/clres_8c.html#a95">MatchImage</a>(
03904     LPRESDIR lprd,
03905     LPINT    lpcxWant,
03906     LPINT    lpcyWant,
03907     UINT     uColorsWant,
03908     BOOL     fIcon)
03909 {
03910     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uColorsNew;
03911     <span class="keywordtype">int</span>  cxNew;
03912     <span class="keywordtype">int</span>  cyNew;
03913 
03914     cxNew = lprd-&gt;Icon.Width;
03915     cyNew = lprd-&gt;Icon.Height;
03916 
03917     <span class="keywordflow">if</span> (fIcon) {
03918         uColorsNew = lprd-&gt;Icon.ColorCount;
03919     } <span class="keywordflow">else</span> {
03920         cyNew &gt;&gt;= 1;
03921         uColorsNew = <a class="code" href="../../d4/d9/clres_8c.html#a0">BPP01_MAXCOLORS</a>;
03922     }
03923 
03924     <span class="comment">/*</span>
03925 <span class="comment">     * 0 really means maximum size (256) or colors (256).</span>
03926 <span class="comment">     */</span>
03927     <span class="keywordflow">if</span> (!cxNew)
03928         cxNew = <a class="code" href="../../d4/d9/clres_8c.html#a2">BPP08_MAXCOLORS</a>;
03929 
03930     <span class="keywordflow">if</span> (!*lpcxWant)
03931         *lpcxWant = cxNew;
03932 
03933     <span class="keywordflow">if</span> (!cyNew)
03934         cyNew = <a class="code" href="../../d4/d9/clres_8c.html#a2">BPP08_MAXCOLORS</a>;
03935 
03936     <span class="keywordflow">if</span> (!*lpcyWant)
03937         *lpcyWant = cyNew;
03938 
03939     <span class="keywordflow">if</span> (!uColorsNew)
03940         uColorsNew = <a class="code" href="../../d4/d9/clres_8c.html#a2">BPP08_MAXCOLORS</a>;
03941 
03942     <span class="comment">/*</span>
03943 <span class="comment">     * Here are the rules for our "match" formula:</span>
03944 <span class="comment">     *      (1) A close size match is much preferable to a color match</span>
03945 <span class="comment">     *      (2) Fewer colors are better than more</span>
03946 <span class="comment">     *      (3) Bigger icons are better than smaller</span>
03947 <span class="comment">     *</span>
03948 <span class="comment">     * The color count, width, and height are powers of 2.  So we use Magnitude()</span>
03949 <span class="comment">     * which calculates the order of magnitude in base 2.</span>
03950 <span class="comment">     */</span>
03951 <span class="preprocessor">#if 0 //CHRISWIL: Not in Win95</span>
03952 <span class="preprocessor"></span>
03953     <span class="keywordflow">return</span> (MagnitudeDiff(uColorsWant, uColorsNew) +
03954             MagnitudeDiff(cxNew, *lpcxWant) +
03955             MagnitudeDiff(cyNew, *lpcyWant));
03956 
03957 <span class="preprocessor">#else</span>
03958 <span class="preprocessor"></span>
03959     <span class="keywordflow">return</span>( 2*<a class="code" href="../../d4/d9/clres_8c.html#a93">MyAbs</a>(<a class="code" href="../../d4/d9/clres_8c.html#a94">Magnitude</a>(uColorsWant), <a class="code" href="../../d4/d9/clres_8c.html#a94">Magnitude</a>(uColorsNew)) +
03960               <a class="code" href="../../d4/d9/clres_8c.html#a93">MyAbs</a>(cxNew, *lpcxWant) +
03961               <a class="code" href="../../d4/d9/clres_8c.html#a93">MyAbs</a>(cyNew, *lpcyWant));
03962 <span class="preprocessor">#endif</span>
03963 <span class="preprocessor"></span>}
03964 
03965 <span class="comment">/***************************************************************************\</span>
03966 <span class="comment">* GetBestImage</span>
03967 <span class="comment">*</span>
03968 <span class="comment">* Among the different forms of images, choose the one that best matches the</span>
03969 <span class="comment">* color format &amp; dimensions of the request.  We try to match the size, then</span>
03970 <span class="comment">* the color info.  So we find the item that</span>
03971 <span class="comment">*</span>
03972 <span class="comment">* (1) Has closest dimensions (smaller or bigger equally good) to minimize</span>
03973 <span class="comment">*     the width, height difference</span>
03974 <span class="comment">* (2) Has best colors.  We favor less over more colors.</span>
03975 <span class="comment">*</span>
03976 <span class="comment">* If we find an identical match, we return immediately.</span>
03977 <span class="comment">*</span>
03978 <span class="comment">\***************************************************************************/</span>
03979 
<a name="l03980"></a><a class="code" href="../../d4/d9/clres_8c.html#a96">03980</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d9/clres_8c.html#a96">GetBestImage</a>(
03981     LPRESDIR lprd,
03982     UINT     uCount,
03983     <span class="keywordtype">int</span>      cxDesired,
03984     <span class="keywordtype">int</span>      cyDesired,
03985     UINT     bpp,
03986     BOOL     fIcon)
03987 {
03988     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uIndex;
03989     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uT;
03990     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uIndexBest = 0;
03991     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uBest = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1;
03992 
03993 
03994     <span class="comment">/*</span>
03995 <span class="comment">     * Get desired number of colors in # value, not bits value.  Note that</span>
03996 <span class="comment">     * we do NOT allow you to have  16- or 32- or 24- bit color icons.</span>
03997 <span class="comment">     *</span>
03998 <span class="comment">     * the icon resources can be 16, 24, 32 bpp, but the restable only has</span>
03999 <span class="comment">     * a color count, so a HiColor icon would have a max value in the</span>
04000 <span class="comment">     * restable.  we treat a 0 in the color count as "max colors"</span>
04001 <span class="comment">     */</span>
04002     <span class="keywordflow">if</span> (bpp == 0)
04003         bpp = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;BitCount;
04004 
04005     <span class="keywordflow">if</span> (bpp &gt; 8)
04006         bpp = 8;
04007 
04008     bpp = 1 &lt;&lt; bpp;
04009 
04010     <span class="comment">/*</span>
04011 <span class="comment">     * Loop through resource entries, saving the "closest" item so far.  Most</span>
04012 <span class="comment">     * of the real work is in MatchImage(), which uses a fabricated formula</span>
04013 <span class="comment">     * to give us the results that we desire.  Namely, an image as close in</span>
04014 <span class="comment">     * size to what we want preferring bigger over smaller, then an image</span>
04015 <span class="comment">     * with the right color format</span>
04016 <span class="comment">     */</span>
04017     <span class="keywordflow">for</span> (uIndex = 0; uIndex &lt; uCount; uIndex++, lprd++) {
04018 
04019         <span class="comment">/*</span>
04020 <span class="comment">         * Get "matching" value.  How close are we to what we want?</span>
04021 <span class="comment">         */</span>
04022         uT = <a class="code" href="../../d4/d9/clres_8c.html#a95">MatchImage</a>(lprd, &amp;cxDesired, &amp;cyDesired, bpp, fIcon);
04023 
04024         <span class="keywordflow">if</span> (!uT) {
04025 
04026             <span class="comment">/*</span>
04027 <span class="comment">             * We've found an exact match!</span>
04028 <span class="comment">             */</span>
04029             <span class="keywordflow">return</span> uIndex;
04030 
04031         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (uT &lt; uBest) {
04032 
04033             <span class="comment">/*</span>
04034 <span class="comment">             * We've found a better match than the current alternative.</span>
04035 <span class="comment">             */</span>
04036             uBest = uT;
04037             uIndexBest = uIndex;
04038         }
04039     }
04040 
04041     <span class="keywordflow">return</span> uIndexBest;
04042 }
04043 
04044 <span class="comment">/***************************************************************************\</span>
04045 <span class="comment">* GetIcoCurWidth</span>
04046 <span class="comment">*</span>
04047 <span class="comment">* When zero is passed in for a dimension, calculates what size we should</span>
04048 <span class="comment">* really used.  Done in a couple o' places, so made it a FN().</span>
04049 <span class="comment">*</span>
04050 <span class="comment">\***************************************************************************/</span>
04051 
<a name="l04052"></a><a class="code" href="../../d6/d0/usercli_8h.html#a652">04052</a> _inline <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d0/usercli_8h.html#a652">GetIcoCurWidth</a>(
04053     DWORD cxOrg,
04054     BOOL  fIcon,
04055     UINT  lrFlags,
04056     DWORD cxDes)
04057 {
04058     <span class="keywordflow">if</span> (cxOrg) {
04059         <span class="keywordflow">return</span> cxOrg;
04060     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lrFlags &amp; LR_DEFAULTSIZE) {
04061         <span class="keywordflow">return</span> (fIcon ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXICON) : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXCURSOR));
04062     } <span class="keywordflow">else</span> {
04063         <span class="keywordflow">return</span> cxDes;
04064     }
04065 }
04066 
04067 <span class="comment">/***************************************************************************\</span>
04068 <span class="comment">* GetIcoCurHeight</span>
04069 <span class="comment">*</span>
04070 <span class="comment">* Vertical counterpart to GetWidth().</span>
04071 <span class="comment">*</span>
04072 <span class="comment">\***************************************************************************/</span>
04073 
<a name="l04074"></a><a class="code" href="../../d6/d0/usercli_8h.html#a653">04074</a> _inline <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d0/usercli_8h.html#a653">GetIcoCurHeight</a>(
04075     DWORD cyOrg,
04076     BOOL  fIcon,
04077     UINT  lrFlags,
04078     DWORD cyDes)
04079 {
04080     <span class="keywordflow">if</span> (cyOrg) {
04081         <span class="keywordflow">return</span> cyOrg;
04082     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lrFlags &amp; LR_DEFAULTSIZE) {
04083         <span class="keywordflow">return</span> (fIcon ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYICON) : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCURSOR));
04084     } <span class="keywordflow">else</span> {
04085         <span class="keywordflow">return</span> cyDes;
04086     }
04087 }
04088 
04089 <span class="comment">/***************************************************************************\</span>
04090 <span class="comment">* GetIcoCurBpp</span>
04091 <span class="comment">*</span>
04092 <span class="comment">* Returns best match Bpp based on lr-flags.</span>
04093 <span class="comment">*</span>
04094 <span class="comment">\***************************************************************************/</span>
04095 
<a name="l04096"></a><a class="code" href="../../d6/d0/usercli_8h.html#a654">04096</a> _inline <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d0/usercli_8h.html#a654">GetIcoCurBpp</a>(
04097     UINT lrFlags)
04098 {
04099     <span class="keywordflow">if</span> (lrFlags &amp; LR_MONOCHROME) {
04100 
04101 <span class="preprocessor">#if DBG</span>
04102 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (lrFlags &amp; LR_VGACOLOR) {
04103             RIPMSG0(RIP_WARNING, <span class="stringliteral">"lrFlags has both MONOCHROME and VGACOLOR; assuming MONOCHROME"</span>);
04104         }
04105 <span class="preprocessor">#endif</span>
04106 <span class="preprocessor"></span>        <span class="keywordflow">return</span> 1;
04107 
04108     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
04109             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a368">TEST_PUSIF</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a364">PUSIF_PALETTEDISPLAY</a>) ||
04110             (lrFlags &amp; LR_VGACOLOR) ||
04111             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(SAMEDISPLAYFORMAT)) {
04112 
04113         <span class="keywordflow">return</span> 4;
04114     } <span class="keywordflow">else</span> {
04115         <span class="keywordflow">return</span> 0;
04116     }
04117 }
04118 
04119 <span class="comment">/***************************************************************************\</span>
04120 <span class="comment">* WOWFindResourceExWCover</span>
04121 <span class="comment">*</span>
04122 <span class="comment">* The WOW FindResource routines expect an ansi string so we have to</span>
04123 <span class="comment">* convert the calling string IFF it is not an ID</span>
04124 <span class="comment">*</span>
04125 <span class="comment">\***************************************************************************/</span>
04126 
<a name="l04127"></a><a class="code" href="../../d4/d9/clres_8c.html#a100">04127</a> HANDLE <a class="code" href="../../d4/d9/clres_8c.html#a100">WOWFindResourceExWCover</a>(
04128     HANDLE  hmod,
04129     LPCWSTR rt,
04130     LPCWSTR lpUniName,
04131     WORD    LangId)
04132 {
04133     LPSTR  lpAnsiName;
04134     HANDLE hRes;
04135 
04136     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(lpUniName))
04137         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a127">FINDRESOURCEEXA</a>(hmod, (LPSTR)lpUniName, (LPSTR)rt, LangId);
04138 
04139     <span class="comment">/*</span>
04140 <span class="comment">     * Otherwise convert the name of the menu then call LoadMenu</span>
04141 <span class="comment">     */</span>
04142     <span class="keywordflow">if</span> (!WCSToMB(lpUniName, -1, &amp;lpAnsiName, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
04143         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04144 
04145     hRes = <a class="code" href="../../d6/d0/usercli_8h.html#a127">FINDRESOURCEEXA</a>(hmod, lpAnsiName, (LPSTR)rt, LangId);
04146 
04147     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpAnsiName);
04148 
04149     <span class="keywordflow">return</span> hRes;
04150 }
04151 
04152 <span class="comment">/***************************************************************************\</span>
04153 <span class="comment">* WOWLoadBitmapA</span>
04154 <span class="comment">*</span>
04155 <span class="comment">*</span>
04156 <span class="comment">\***************************************************************************/</span>
04157 
<a name="l04158"></a><a class="code" href="../../d4/d9/clres_8c.html#a101">04158</a> HBITMAP <a class="code" href="../../d4/d9/clres_8c.html#a101">WOWLoadBitmapA</a>(
04159     HINSTANCE hmod,
04160     LPCSTR    lpName,
04161     LPBYTE    pResData,
04162     DWORD     cbResData)
04163 {
04164     LPWSTR  lpUniName;
04165     HBITMAP hRet;
04166 
04167     UNREFERENCED_PARAMETER(cbResData);
04168 
04169     <span class="keywordflow">if</span> (pResData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04170 
04171         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(lpName))
04172             <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a73">LoadBmp</a>(hmod, (LPCWSTR)lpName, 0, 0, 0);
04173 
04174         <span class="keywordflow">if</span> (!MBToWCS(lpName, -1, &amp;lpUniName, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
04175             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04176 
04177         hRet = <a class="code" href="../../d4/d9/clres_8c.html#a73">LoadBmp</a>(hmod, lpUniName, 0, 0, 0);
04178 
04179         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpUniName);
04180 
04181     } <span class="keywordflow">else</span> {
04182 
04183         hRet = <a class="code" href="../../d6/d0/usercli_8h.html#a659">ConvertDIBBitmap</a>((LPBITMAPINFOHEADER)pResData,
04184                                 0,
04185                                 0,
04186                                 LR_DEFAULTSIZE,
04187                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04188                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04189     }
04190 
04191     <span class="keywordflow">return</span> hRet;
04192 }
04193 
04194 <span class="comment">/***************************************************************************\</span>
04195 <span class="comment">* WOWServerLoadCreateCursorIcon</span>
04196 <span class="comment">*</span>
04197 <span class="comment">*</span>
04198 <span class="comment">\***************************************************************************/</span>
04199 
<a name="l04200"></a><a class="code" href="../../d4/d9/clres_8c.html#a102">04200</a> HICON <a class="code" href="../../d6/d0/usercli_8h.html#a648">WowServerLoadCreateCursorIcon</a>(
04201     HANDLE  hmod,
04202     LPWSTR  pszModName,
04203     DWORD   dwExpWinVer,
04204     LPCWSTR lpName,
04205     DWORD   cb,
04206     PVOID   pResData,
04207     LPWSTR  type,
04208     BOOL    fClient)
04209 {
04210     HICON hRet;
04211     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fIcon = (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> == RT_ICON);
04212     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  LR_Flags = LR_SHARED;
04213 
04214     UNREFERENCED_PARAMETER(pszModName);
04215     UNREFERENCED_PARAMETER(dwExpWinVer);
04216     UNREFERENCED_PARAMETER(cb);
04217     UNREFERENCED_PARAMETER(fClient);
04218 
04219     <span class="keywordflow">if</span> (!fIcon)
04220         LR_Flags |= LR_MONOCHROME;
04221 
04222     <span class="keywordflow">if</span> (pResData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04223 
04224         hRet = <a class="code" href="../../d6/d0/usercli_8h.html#a655">LoadIcoCur</a>(hmod,
04225                           lpName,
04226                           <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>,
04227                           0,
04228                           0,
04229                           LR_Flags | LR_DEFAULTSIZE);
04230 
04231     } <span class="keywordflow">else</span> {
04232 
04233         hRet = <a class="code" href="../../d6/d0/usercli_8h.html#a660">ConvertDIBIcon</a>((LPBITMAPINFOHEADER)pResData,
04234                               hmod,
04235                               lpName,
04236                               fIcon,
04237                               <a class="code" href="../../d6/d0/usercli_8h.html#a652">GetIcoCurWidth</a>(0 , fIcon, LR_DEFAULTSIZE, 0),
04238                               <a class="code" href="../../d6/d0/usercli_8h.html#a653">GetIcoCurHeight</a>(0, fIcon, LR_DEFAULTSIZE, 0),
04239                               LR_Flags);
04240     }
04241 
04242     <span class="keywordflow">return</span> hRet;
04243 }
04244 
04245 <span class="comment">/***************************************************************************\</span>
04246 <span class="comment">* WOWServerLoadCreateMenu</span>
04247 <span class="comment">*</span>
04248 <span class="comment">*</span>
04249 <span class="comment">\***************************************************************************/</span>
<a name="l04250"></a><a class="code" href="../../d4/d9/clres_8c.html#a103">04250</a> HMENU <a class="code" href="../../d4/d9/clres_8c.html#a103">WowServerLoadCreateMenu</a>(
04251     HANDLE hMod,
04252     LPCSTR lpName,
04253     CONST  LPMENUTEMPLATE pmt,
04254     DWORD  cb,
04255     BOOL   fCallClient)
04256 {
04257     UNREFERENCED_PARAMETER(cb);
04258     UNREFERENCED_PARAMETER(fCallClient);
04259 
04260     <span class="keywordflow">if</span> (pmt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04261         <span class="keywordflow">return</span> <a class="code" href="../../d9/d8/clmenu_8c.html#a5">LoadMenuA</a>(hMod, lpName);
04262     } <span class="keywordflow">else</span>
04263         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a650">CreateMenuFromResource</a>(pmt);
04264 }
04265 
04266 <span class="comment">/***********************************************************************\</span>
04267 <span class="comment">* DIBFromBitmap()</span>
04268 <span class="comment">*</span>
04269 <span class="comment">*  Creates a memory block with DIB information from a physical bitmap tagged</span>
04270 <span class="comment">*  to a specific DC.</span>
04271 <span class="comment">*</span>
04272 <span class="comment">*  A DIB block consists of a BITMAPINFOHEADER + RGB colors + DIB bits.</span>
04273 <span class="comment">*</span>
04274 <span class="comment">* Returns: UserLocalAlloc pointer to DIB info.</span>
04275 <span class="comment">*</span>
04276 <span class="comment">* 03-Nov-1995 SanfordS  Created.</span>
04277 <span class="comment">\***********************************************************************/</span>
04278 
<a name="l04279"></a><a class="code" href="../../d4/d9/clres_8c.html#a104">04279</a> PVOID <a class="code" href="../../d4/d9/clres_8c.html#a104">DIBFromBitmap</a>(
04280     HBITMAP hbmp,
04281     HDC     hdc)
04282 {
04283     BITMAP             bmp;
04284     LPBITMAPINFOHEADER lpbi;
04285     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              cbBits;
04286     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              cbPalette;
04287     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              cbTotal;
04288     WORD               cBits;
04289 
04290     UserAssert(hbmp);
04291     UserAssert(hdc);
04292 
04293     <span class="keywordflow">if</span> (GetObject(hbmp, <span class="keyword">sizeof</span>(BITMAP), &amp;bmp) == 0)
04294         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04295 
04296     cBits = ((WORD)bmp.bmPlanes * (WORD)bmp.bmBitsPixel);
04297 
04298 TrySmallerDIB:
04299 
04300     cbBits = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a548">WIDTHBYTES</a>((WORD)bmp.bmWidth * cBits) * (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)bmp.bmHeight;
04301 
04302     cbPalette = 0;
04303     <span class="keywordflow">if</span> (cBits &lt;= 8)
04304         cbPalette = (1 &lt;&lt; cBits) * <span class="keyword">sizeof</span>(RGBQUAD);
04305     <span class="keywordflow">else</span>
04306         cbPalette = 3 * <span class="keyword">sizeof</span>(RGBQUAD);
04307 
04308     cbTotal  = <span class="keyword">sizeof</span>(BITMAPINFOHEADER) + cbPalette + cbBits;
04309     lpbi = (LPBITMAPINFOHEADER)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, cbTotal);
04310     <span class="keywordflow">if</span> (lpbi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04311 
04312         <span class="comment">/*</span>
04313 <span class="comment">         * Try a smaller DIB, if we can.  We can't if the DIB is mono.</span>
04314 <span class="comment">         */</span>
04315         <span class="keywordflow">switch</span> (cBits) {
04316         <span class="keywordflow">case</span> 4:
04317             cBits = 1;
04318             <span class="keywordflow">break</span>;
04319 
04320         <span class="keywordflow">case</span> 8:
04321             cBits = 4;
04322             <span class="keywordflow">break</span>;
04323 
04324         <span class="keywordflow">case</span> 16:
04325             cBits = 8;
04326             <span class="keywordflow">break</span>;
04327 
04328         <span class="keywordflow">case</span> 24:
04329             cBits = 16;
04330             <span class="keywordflow">break</span>;
04331 
04332         <span class="keywordflow">case</span> 32:
04333             cBits = 24;
04334             <span class="keywordflow">break</span>;
04335 
04336         <span class="keywordflow">default</span>:
04337             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// 1 or wierd.</span>
04338         }
04339 
04340         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Not enough memory to create large color DIB, trying %d bpp."</span>, cBits);
04341         <span class="keywordflow">goto</span> TrySmallerDIB;
04342     }
04343 
04344     RtlZeroMemory(lpbi, <span class="keyword">sizeof</span>(BITMAPINFOHEADER));
04345     lpbi-&gt;biSize        = <span class="keyword">sizeof</span>(BITMAPINFOHEADER);
04346     lpbi-&gt;biWidth       = bmp.bmWidth;
04347     lpbi-&gt;biHeight      = bmp.bmHeight;
04348     lpbi-&gt;biPlanes      = 1;
04349     lpbi-&gt;biBitCount    = cBits;
04350 
04351     <span class="comment">/*</span>
04352 <span class="comment">     * Get old bitmap's DIB bits, using the current DC.</span>
04353 <span class="comment">     */</span>
04354     GetDIBits(hdc,
04355               hbmp,
04356               0,
04357               lpbi-&gt;biHeight,
04358               ((LPSTR)lpbi) + lpbi-&gt;biSize + cbPalette,
04359               (LPBITMAPINFO)lpbi,
04360               DIB_RGB_COLORS);
04361 
04362     lpbi-&gt;biClrUsed   = cbPalette / <span class="keyword">sizeof</span>(RGBQUAD);
04363     lpbi-&gt;biSizeImage = cbBits;
04364 
04365     <span class="keywordflow">return</span> lpbi;
04366 }
04367 
04368 <span class="comment">/***************************************************************************\</span>
04369 <span class="comment">* CopyBmp</span>
04370 <span class="comment">*</span>
04371 <span class="comment">* Creates a new bitmap and copies the given bitmap to the new one,</span>
04372 <span class="comment">* stretching and color-converting the bits if desired.</span>
04373 <span class="comment">*</span>
04374 <span class="comment">* 03-Nov-1995 SanfordS  Created.</span>
04375 <span class="comment">\***************************************************************************/</span>
04376 
<a name="l04377"></a><a class="code" href="../../d4/d9/clres_8c.html#a28">04377</a> HBITMAP <a class="code" href="../../d4/d9/clres_8c.html#a28">CopyBmp</a>(
04378     HBITMAP hbmpOrg,
04379     <span class="keywordtype">int</span>     cxNew,
04380     <span class="keywordtype">int</span>     cyNew,
04381     UINT    LR_flags)
04382 {
04383     HBITMAP hbmNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04384     LPBITMAPINFOHEADER pdib;
04385 
04386     RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
04387 
04388     <span class="keywordflow">if</span> (pdib = <a class="code" href="../../d4/d9/clres_8c.html#a104">DIBFromBitmap</a>(hbmpOrg, <a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>)) {
04389 
04390 <span class="preprocessor">#if 0  // Win-9x comments this code out</span>
04391 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (LR_flags &amp; LR_COPYRETURNORG) {
04392 
04393             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> bpp = <a class="code" href="../../d6/d0/usercli_8h.html#a654">GetIcoCurBpp</a>(LR_flags);
04394 
04395             <span class="keywordflow">if</span> ((cxNew == 0 || cxNew == pdib-&gt;biWidth)  &amp;&amp;
04396                 (cyNew == 0 || cyNew == pdib-&gt;biHeight) &amp;&amp;
04397                 (bpp == 0 || bpp == pdib-&gt;biBitCount)) {
04398 
04399                 hbmNew = hbmpOrg;
04400             }
04401         }
04402 
04403         <span class="keywordflow">if</span> (hbmNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04404             hbmNew = <a class="code" href="../../d6/d0/usercli_8h.html#a659">ConvertDIBBitmap</a>(pdib, cxNew, cyNew, LR_flags, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04405 <span class="preprocessor">#endif</span>
04406 <span class="preprocessor"></span>
04407         hbmNew = <a class="code" href="../../d6/d0/usercli_8h.html#a659">ConvertDIBBitmap</a>(pdib, cxNew, cyNew, LR_flags, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04408 
04409         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pdib);
04410     }
04411 
04412     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
04413 
04414     <span class="keywordflow">if</span> ((LR_flags &amp; LR_COPYDELETEORG) &amp;&amp; hbmNew &amp;&amp; (hbmNew != hbmpOrg))
04415         DeleteObject(hbmpOrg);
04416 
04417     <span class="keywordflow">return</span> hbmNew;
04418 }
04419 
04420 <span class="comment">/***********************************************************************\</span>
04421 <span class="comment">* CopyImageFromRes</span>
04422 <span class="comment">*</span>
04423 <span class="comment">* This is used by the LR_COPYFROMRESOURCE option.  We assume that the</span>
04424 <span class="comment">* icon/cursor passed in is among the process list of loaded shared</span>
04425 <span class="comment">* icons.  If we find it there, we can attempt to load the icon from</span>
04426 <span class="comment">* the resource to get an image that looks better than a stretched or</span>
04427 <span class="comment">* compressed one.</span>
04428 <span class="comment">*</span>
04429 <span class="comment">* That way we will not stretch a 32x32 icon to 16x16 if someone added</span>
04430 <span class="comment">* a 16x16 image to their class icon--a simple way for apps to jazz up</span>
04431 <span class="comment">* their appearance.</span>
04432 <span class="comment">*</span>
04433 <span class="comment">* 12-Mar-1996 ChrisWil  Created.</span>
04434 <span class="comment">\***********************************************************************/</span>
04435 
<a name="l04436"></a><a class="code" href="../../d4/d9/clres_8c.html#a105">04436</a> HICON <a class="code" href="../../d4/d9/clres_8c.html#a105">CopyImageFromRes</a>(
04437     LPWSTR      pszModName,
04438     LPWSTR      pszResName,
04439     <a class="code" href="../../d9/d1/structtagCURSORFIND.html">PCURSORFIND</a> pcfSearch,
04440     UINT        LR_flags)
04441 {
04442     HINSTANCE hmod;
04443     HICON     hicoDst = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04444 
04445     <span class="comment">/*</span>
04446 <span class="comment">     * Override the search-criteria if this is the user-module.  By</span>
04447 <span class="comment">     * setting these to zero, we are basically saying "don't care" for</span>
04448 <span class="comment">     * these attributes.</span>
04449 <span class="comment">     */</span>
04450     hmod = (pszModName ? <a class="code" href="../../d4/d9/clres_8c.html#a32">WowGetModuleHandle</a>(pszModName) : <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>);
04451 
04452     <span class="keywordflow">if</span> (hmod == <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>) {
04453 
04454         pcfSearch-&gt;<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o2">cx</a>  = 0;
04455         pcfSearch-&gt;<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o3">cy</a>  = 0;
04456         pcfSearch-&gt;<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o4">bpp</a> = 0;
04457 
04458         pszModName = <a class="code" href="../../d1/d8/clglobal_8c.html#a12">szUSER32</a>;
04459     }
04460 
04461     <span class="comment">/*</span>
04462 <span class="comment">     * If a resource has been found with this name/bpp, then attempt</span>
04463 <span class="comment">     * to load the resource with the desired dimensions.</span>
04464 <span class="comment">     */</span>
04465     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a627">FindExistingCursorIcon</a>(pszModName, pszResName, pcfSearch)) {
04466 
04467         hicoDst = <a class="code" href="../../d6/d0/usercli_8h.html#a655">LoadIcoCur</a>(hmod,
04468                              pszResName,
04469                              (LPWSTR)ULongToPtr( pcfSearch-&gt;<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o1">rt</a> ),
04470                              pcfSearch-&gt;<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o2">cx</a>,
04471                              pcfSearch-&gt;<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o3">cy</a>,
04472                              LR_flags);
04473     }
04474 
04475     <span class="keywordflow">return</span> hicoDst;
04476 }
04477 
04478 <span class="comment">/***********************************************************************\</span>
04479 <span class="comment">*  CopyIcoCur()</span>
04480 <span class="comment">*</span>
04481 <span class="comment">*  Allocates a new icon resource and transmogrifies the old icon into the</span>
04482 <span class="comment">*  newly desired format.</span>
04483 <span class="comment">*</span>
04484 <span class="comment">*  Note that if we have to stretch the icon, the hotspot area changes.  For</span>
04485 <span class="comment">*  icons, the hotspot is set to be the middle of the icon.</span>
04486 <span class="comment">*</span>
04487 <span class="comment">* Returns:</span>
04488 <span class="comment">*</span>
04489 <span class="comment">* 01-Nov-1995 SanfordS  Created.</span>
04490 <span class="comment">* 12-Mar-1996 ChrisWil  Added lookup for existing icon/cursor.</span>
04491 <span class="comment">\***********************************************************************/</span>
04492 
<a name="l04493"></a><a class="code" href="../../d4/d9/clres_8c.html#a106">04493</a> HICON <a class="code" href="../../d4/d9/clres_8c.html#a106">CopyIcoCur</a>(
04494     HICON hicoSrc,
04495     BOOL  fIcon,
04496     <span class="keywordtype">int</span>   cxNew,
04497     <span class="keywordtype">int</span>   cyNew,
04498     UINT  LR_flags)
04499 {
04500     HBITMAP        hbmMaskNew;
04501     HBITMAP        hbmColorNew;
04502     <span class="keywordtype">int</span>            cx;
04503     <span class="keywordtype">int</span>            <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
04504     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>          bpp;
04505     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>          bppDesired;
04506     HICON          hicoDst = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04507     ICONINFO       ii;
04508     <a class="code" href="../../d8/d1/structtagCURSORDATA.html">CURSORDATA</a>     cur;
04509     UNICODE_STRING strModName;
04510     UNICODE_STRING strResName;
04511     WCHAR          awszModName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
04512     WCHAR          awszResName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
04513 
04514     <span class="comment">/*</span>
04515 <span class="comment">     * Extract needed info from existing icon/cursor from the kernel</span>
04516 <span class="comment">     */</span>
04517     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a106">NtUserGetIconSize</a>(hicoSrc, 0, &amp;cx, &amp;<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>))
04518         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04519 
04520     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> &gt;&gt;= 1;
04521 
04522     <span class="keywordflow">if</span> (LR_flags &amp; LR_CREATEDIBSECTION)
04523         LR_flags = (LR_flags &amp; ~LR_CREATEDIBSECTION) | LR_CREATEREALDIB;
04524 
04525     <span class="comment">/*</span>
04526 <span class="comment">     * Setup unicode-strings for calls to kernel-side.</span>
04527 <span class="comment">     */</span>
04528     strModName.Length        = 0;
04529     strModName.MaximumLength = <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>;
04530     strModName.Buffer        = awszModName;
04531 
04532     strResName.Length        = 0;
04533     strResName.MaximumLength = <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>;
04534     strResName.Buffer        = awszResName;
04535 
04536     <span class="comment">/*</span>
04537 <span class="comment">     * Note: this creates copies of hbmMask and hbmColor that need to be</span>
04538 <span class="comment">     * freed before we leave.</span>
04539 <span class="comment">     */</span>
04540     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a105">NtUserGetIconInfo</a>(hicoSrc,
04541                            &amp;ii,
04542                            &amp;strModName,
04543                            &amp;strResName,
04544                            &amp;bpp,
04545                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
04546 
04547         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04548     }
04549 
04550     cxNew = <a class="code" href="../../d6/d0/usercli_8h.html#a652">GetIcoCurWidth</a>(cxNew, fIcon, LR_flags, cx);
04551     cyNew = <a class="code" href="../../d6/d0/usercli_8h.html#a653">GetIcoCurHeight</a>(cyNew, fIcon, LR_flags, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
04552 
04553     <span class="keywordflow">if</span> (LR_flags &amp; LR_COPYFROMRESOURCE) {
04554 
04555         <a class="code" href="../../d9/d1/structtagCURSORFIND.html">CURSORFIND</a> cfSearch;
04556         LPWSTR     pszModName;
04557 
04558         <span class="comment">/*</span>
04559 <span class="comment">         * Setup the search criteria.</span>
04560 <span class="comment">         */</span>
04561         cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o0">hcur</a> = hicoSrc;
04562         cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o1">rt</a>   = PtrToUlong((fIcon ? RT_ICON : RT_CURSOR));
04563         cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o2">cx</a>   = cxNew;
04564         cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o3">cy</a>   = cyNew;
04565         cfSearch.<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o4">bpp</a>  = bpp;
04566 
04567         <span class="comment">/*</span>
04568 <span class="comment">         * Copy the image.  This performs a lookup for the hicoSrc.  If</span>
04569 <span class="comment">         * it is not found in the process and shared caches, then we</span>
04570 <span class="comment">         * will proceed with copying the hicoSrc.  If an icon is found</span>
04571 <span class="comment">         * in the cache, then we will attempt to reload the image for</span>
04572 <span class="comment">         * the best resolution possible.</span>
04573 <span class="comment">         */</span>
04574         pszModName = (strModName.Length ? strModName.Buffer : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04575 
04576         hicoDst = <a class="code" href="../../d4/d9/clres_8c.html#a105">CopyImageFromRes</a>(pszModName,
04577                                    strResName.Buffer,
04578                                    &amp;cfSearch,
04579                                    LR_flags);
04580 
04581         <span class="keywordflow">if</span> (hicoDst)
04582             <span class="keywordflow">goto</span> CleanupExit;
04583     }
04584 
04585     bppDesired = <a class="code" href="../../d6/d0/usercli_8h.html#a654">GetIcoCurBpp</a>(LR_flags);
04586 
04587     <span class="keywordflow">if</span> ((cxNew != cx) ||
04588         (cyNew != <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>) ||
04589         ((bpp != 1) &amp;&amp; (bppDesired != 0) &amp;&amp; (bppDesired != bpp))) {
04590 
04591         <span class="comment">/*</span>
04592 <span class="comment">         * Since we have to stretch or maybe fixup the colors just get</span>
04593 <span class="comment">         * the DIB bits and let ConverDIBBitmap do all the magic.</span>
04594 <span class="comment">         */</span>
04595         hbmMaskNew = <a class="code" href="../../d4/d9/clres_8c.html#a28">CopyBmp</a>(ii.hbmMask, cxNew, cyNew * 2, LR_MONOCHROME);
04596 
04597         <span class="keywordflow">if</span> (hbmMaskNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04598             <span class="keywordflow">goto</span> CleanupExit;
04599 
04600         hbmColorNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04601 
04602         <span class="keywordflow">if</span> (ii.hbmColor) {
04603 
04604             hbmColorNew = <a class="code" href="../../d4/d9/clres_8c.html#a28">CopyBmp</a>(ii.hbmColor, cxNew, cyNew, LR_flags);
04605 
04606             <span class="keywordflow">if</span> (hbmColorNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04607                 DeleteObject(hbmMaskNew);
04608                 <span class="keywordflow">goto</span> CleanupExit;
04609             }
04610         }
04611 
04612         <span class="comment">/*</span>
04613 <span class="comment">         * Replace ii.hbmxxx guys with our fixed up copies and delete the old.</span>
04614 <span class="comment">         */</span>
04615         DeleteObject(ii.hbmMask);
04616         ii.hbmMask = hbmMaskNew;
04617 
04618         <span class="keywordflow">if</span> (ii.hbmColor &amp;&amp; (ii.hbmColor != hbmColorNew)) {
04619             DeleteObject(ii.hbmColor);
04620             ii.hbmColor = hbmColorNew;
04621         }
04622 
04623         <span class="comment">/*</span>
04624 <span class="comment">         * tweak the hotspots for changes in size.</span>
04625 <span class="comment">         */</span>
04626         <span class="keywordflow">if</span> (cxNew != cx)
04627             ii.xHotspot = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(ii.xHotspot, cxNew, cx);
04628 
04629         <span class="keywordflow">if</span> (cyNew != <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)
04630             ii.yHotspot = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(ii.yHotspot, cyNew, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
04631 
04632     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (LR_flags &amp; LR_COPYRETURNORG) {
04633 
04634         hicoDst = hicoSrc;
04635 
04636 CleanupExit:
04637 
04638         <span class="comment">/*</span>
04639 <span class="comment">         * Free up the bitmaps which were created by GetIconInfo().</span>
04640 <span class="comment">         */</span>
04641         DeleteObject(ii.hbmMask);
04642 
04643         <span class="keywordflow">if</span> (ii.hbmColor)
04644             DeleteObject(ii.hbmColor);
04645 
04646         <span class="keywordflow">goto</span> Exit;
04647     }
04648 
04649     <span class="comment">/*</span>
04650 <span class="comment">     * Build the icon/cursor object from the info.  The bitmaps</span>
04651 <span class="comment">     * are not freed in this case.</span>
04652 <span class="comment">     */</span>
04653     hicoDst = (HICON)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(0, SFI__CREATEEMPTYCURSOROBJECT);
04654 
04655     <span class="keywordflow">if</span> (hicoDst == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04656         <span class="keywordflow">goto</span> CleanupExit;
04657 
04658     RtlZeroMemory(&amp;cur, <span class="keyword">sizeof</span>(cur));
04659     cur.lpName    = strResName.Length ? strResName.Buffer : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04660     cur.lpModName = strModName.Length ? strModName.Buffer : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04661     cur.rt        = ii.fIcon ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_ICON) : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_CURSOR);
04662     cur.bpp       = bpp;
04663     cur.cx        = cxNew;
04664     cur.cy        = cyNew * 2;
04665     cur.xHotspot  = (<span class="keywordtype">short</span>)ii.xHotspot;
04666     cur.yHotspot  = (<span class="keywordtype">short</span>)ii.yHotspot;
04667     cur.hbmMask   = ii.hbmMask;
04668     cur.hbmColor  = ii.hbmColor;
04669 
04670     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1114">_SetCursorIconData</a>(hicoDst, &amp;cur)) {
04671         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">NtUserDestroyCursor</a>(hicoDst, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a531">CURSOR_ALWAYSDESTROY</a>);
04672         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04673     }
04674 
04675 Exit:
04676 
04677     <span class="comment">/*</span>
04678 <span class="comment">     * destroy the original if asked to.</span>
04679 <span class="comment">     */</span>
04680     <span class="keywordflow">if</span> (hicoDst != hicoSrc &amp;&amp; (LR_flags &amp; LR_COPYDELETEORG))
04681         <a class="code" href="../../d4/d9/clres_8c.html#a55">DestroyCursor</a>(hicoSrc);
04682 
04683     <span class="keywordflow">return</span> hicoDst;
04684 }
04685 
04686 <span class="comment">/***********************************************************************\</span>
04687 <span class="comment">* CopyImage</span>
04688 <span class="comment">*</span>
04689 <span class="comment">* Allocates a new icon resource and copies the attributes of the old icon</span>
04690 <span class="comment">* to the new icon.</span>
04691 <span class="comment">*</span>
04692 <span class="comment">* Returns: hIconNew</span>
04693 <span class="comment">*</span>
04694 <span class="comment">* 01-Nov-1995 SanfordS  Created.</span>
04695 <span class="comment">\***********************************************************************/</span>
04696 
<a name="l04697"></a><a class="code" href="../../d4/d9/clres_8c.html#a107">04697</a> HANDLE WINAPI <a class="code" href="../../d4/d9/clres_8c.html#a107">CopyImage</a>(
04698     HANDLE hImage,
04699     UINT   IMAGE_flag,
04700     <span class="keywordtype">int</span>    cxNew,
04701     <span class="keywordtype">int</span>    cyNew,
04702     UINT   LR_flags)
04703 {
04704     <span class="keywordflow">if</span> (LR_flags &amp; ~LR_VALID) {
04705         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"CopyImage: bad LR_flags."</span>);
04706         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04707     }
04708 
04709     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a649">InternalCopyImage</a>(hImage, IMAGE_flag, cxNew, cyNew, LR_flags);
04710 }
04711 
04712 <span class="comment">/***********************************************************************\</span>
04713 <span class="comment">* InternalCopyImage</span>
04714 <span class="comment">*</span>
04715 <span class="comment">* Performs the copyimage work.  This is called from the callback-thunk.</span>
04716 <span class="comment">*</span>
04717 <span class="comment">\***********************************************************************/</span>
04718 
<a name="l04719"></a><a class="code" href="../../d6/d0/usercli_8h.html#a649">04719</a> HANDLE <a class="code" href="../../d6/d0/usercli_8h.html#a649">InternalCopyImage</a>(
04720     HANDLE hImage,
04721     UINT   IMAGE_flag,
04722     <span class="keywordtype">int</span>    cxNew,
04723     <span class="keywordtype">int</span>    cyNew,
04724     UINT   LR_flags)
04725 {
04726     <span class="keywordflow">switch</span> (IMAGE_flag) {
04727 
04728     <span class="keywordflow">case</span> IMAGE_BITMAP:
04729         <span class="keywordflow">if</span> (GetObjectType(hImage) != OBJ_BITMAP) {
04730             RIPMSG0(RIP_ERROR, <span class="stringliteral">"CopyImage: invalid bitmap"</span>);
04731             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04732         }
04733 
04734         <span class="keywordflow">return</span> (HICON)<a class="code" href="../../d4/d9/clres_8c.html#a28">CopyBmp</a>(hImage, cxNew, cyNew, LR_flags);
04735 
04736     <span class="keywordflow">case</span> IMAGE_CURSOR:
04737     <span class="keywordflow">case</span> IMAGE_ICON:
04738 
04739         <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/clres_8c.html#a106">CopyIcoCur</a>(hImage,
04740                           (IMAGE_flag == IMAGE_ICON),
04741                           cxNew,
04742                           cyNew,
04743                           LR_flags);
04744     }
04745 
04746     RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"CopyImage: bad IMAGE_flag."</span>);
04747 
04748     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04749 }
04750 
04751 <span class="comment">/***************************************************************************\</span>
04752 <span class="comment">* RtlGetIdFromDirectory</span>
04753 <span class="comment">*</span>
04754 <span class="comment">* History:</span>
04755 <span class="comment">* 06-Apr-1991 ScottLu   Cleaned up, make work with client/server.</span>
04756 <span class="comment">* 16-Nov-1995 SanfordS  Now uses LookupIconIdFromDirectoryEx</span>
04757 <span class="comment">\***************************************************************************/</span>
04758 
<a name="l04759"></a><a class="code" href="../../d6/d0/usercli_8h.html#a428">04759</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d0/usercli_8h.html#a428">RtlGetIdFromDirectory</a>(
04760     PBYTE  presbits,
04761     BOOL   fIcon,
04762     <span class="keywordtype">int</span>    cxDesired,
04763     <span class="keywordtype">int</span>    cyDesired,
04764     DWORD  LR_flags,
04765     PDWORD pdwResSize)
04766 {
04767     LPNEWHEADER lpnh;
04768     LPRESDIR    lprsd;
04769     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        iImage;
04770     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        cImage;
04771     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        bpp;
04772 
04773     <span class="comment">/*</span>
04774 <span class="comment">     * Make sure this is pointing to valid resource bits.</span>
04775 <span class="comment">     */</span>
04776     <span class="keywordflow">if</span> (presbits == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04777         <span class="keywordflow">return</span> 0;
04778 
04779     lpnh = (LPNEWHEADER)presbits;
04780 
04781     <span class="comment">/*</span>
04782 <span class="comment">     * Fill in defaults.</span>
04783 <span class="comment">     */</span>
04784     cxDesired = <a class="code" href="../../d6/d0/usercli_8h.html#a652">GetIcoCurWidth</a>(cxDesired, fIcon, LR_flags, 0);
04785     cyDesired = <a class="code" href="../../d6/d0/usercli_8h.html#a653">GetIcoCurHeight</a>(cyDesired, fIcon, LR_flags, 0);
04786 
04787     bpp = <a class="code" href="../../d6/d0/usercli_8h.html#a654">GetIcoCurBpp</a>(LR_flags);
04788 
04789     <span class="comment">/*</span>
04790 <span class="comment">     * We'll use the first image in the directory if we can't find one</span>
04791 <span class="comment">     * that's appropriate.</span>
04792 <span class="comment">     */</span>
04793     cImage = lpnh-&gt;ResCount;
04794     lprsd  = (LPRESDIR)(lpnh + 1);
04795 
04796     iImage = <a class="code" href="../../d4/d9/clres_8c.html#a96">GetBestImage</a>(lprsd, cImage, cxDesired, cyDesired, bpp, fIcon);
04797 
04798     <span class="keywordflow">if</span> (iImage == cImage)
04799         iImage = 0;
04800 
04801     <span class="keywordflow">if</span> (pdwResSize != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04802         *pdwResSize = (lprsd + iImage)-&gt;BytesInRes;
04803 
04804     <span class="keywordflow">return</span> ((LPRESDIR)(lprsd + iImage))-&gt;idIcon;
04805 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
