<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: minmax.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>minmax.c</h1><a href="../../d4/d9/minmax_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: minmax.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">*  Window Minimize/Maximize Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">\***************************************************************************/</span>
00009 
00010 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00011 <span class="preprocessor">#pragma hdrstop</span>
00012 <span class="preprocessor"></span>
00013 <span class="comment">/*</span>
00014 <span class="comment"> * How long we want animation to last, in milliseconds</span>
00015 <span class="comment"> */</span>
<a name="l00016"></a><a class="code" href="../../d4/d9/minmax_8c.html#a0">00016</a> <span class="preprocessor">#define CMS_ANIMATION       250</span>
<a name="l00017"></a><a class="code" href="../../d4/d9/minmax_8c.html#a1">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define DX_GAP      (SYSMET(CXMINSPACING) - SYSMET(CXMINIMIZED))</span>
<a name="l00018"></a><a class="code" href="../../d4/d9/minmax_8c.html#a2">00018</a> <span class="preprocessor"></span><span class="preprocessor">#define DY_GAP      (SYSMET(CYMINSPACING) - SYSMET(CYMINIMIZED))</span>
00019 <span class="preprocessor"></span>
00020 
00021 <span class="comment">/***************************************************************************\</span>
00022 <span class="comment">* xxxInitSendValidateMinMaxInfo()</span>
00023 <span class="comment">*</span>
00024 <span class="comment">* Routine which initializes the minmax array, sends WM_GETMINMAXINFO to</span>
00025 <span class="comment">* the caller, and validates the results.</span>
00026 <span class="comment">*</span>
00027 <span class="comment">* Returns FALSE is the window went away in the middle.</span>
00028 <span class="comment">*</span>
00029 <span class="comment">\***************************************************************************/</span>
00030 
00031 <span class="keywordtype">void</span>
<a name="l00032"></a><a class="code" href="../../d4/d1/userk_8h.html#a1161">00032</a> <a class="code" href="../../d4/d1/userk_8h.html#a1161">xxxInitSendValidateMinMaxInfo</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, LPMINMAXINFO lpmmi)
00033 {
00034     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>     ptiCurrent;
00035     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>        pMonitorReal;
00036     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>        pMonitorPrimary;
00037     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpMonitorReal;
00038     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpMonitorPrimary;
00039     <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">CHECKPOINT</a> *    pcp;
00040     RECT            rcParent;
00041     <span class="keywordtype">int</span>             cBorders;
00042     <span class="keywordtype">int</span>             xMin, yMin;
00043 
00044     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00045 
00046     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00047 
00048     <span class="comment">/*</span>
00049 <span class="comment">     * FILL IN THE MINMAXINFO WE THINK IS APPROPRIATE</span>
00050 <span class="comment">     */</span>
00051 
00052     <span class="comment">/*</span>
00053 <span class="comment">     * Minimized Size</span>
00054 <span class="comment">     */</span>
00055     lpmmi-&gt;ptReserved.x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINIMIZED);
00056     lpmmi-&gt;ptReserved.y = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINIMIZED);
00057 
00058     <span class="comment">/*</span>
00059 <span class="comment">     * Maximized Position and Size</span>
00060 <span class="comment">     * Figure out where the window would be maximized within its parent.</span>
00061 <span class="comment">     */</span>
00062     pMonitorPrimary = <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
00063     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00064         <span class="comment">/* What monitor is the window really going to maximize to? */</span>
00065         pMonitorReal = <a class="code" href="../../d9/d1/mmrtl_8c.html#a8">_MonitorFromWindow</a>(pwnd, MONITOR_DEFAULTTOPRIMARY);
00066 
00067         <span class="comment">/* Send dimensions based on the primary only. */</span>
00068         rcParent = pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>;
00069     } <span class="keywordflow">else</span> {
00070         pMonitorReal = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00071         <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>, &amp;rcParent);
00072     }
00073 
00074     cBorders = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a7">GetWindowBorders</a>(pwnd-&gt;style, pwnd-&gt;ExStyle, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00075 
00076     <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;rcParent,
00077                 cBorders * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER),
00078                 cBorders * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER));
00079 
00080     rcParent.right -= rcParent.left;
00081     rcParent.bottom -= rcParent.top;
00082 
00083     <span class="comment">/* rcParent.right, bottom are width and height now. */</span>
00084     lpmmi-&gt;ptMaxSize.x = rcParent.right;
00085     lpmmi-&gt;ptMaxSize.y = rcParent.bottom;
00086 
00087     pcp = (<a class="code" href="../../d0/d0/structtagCHECKPOINT.html">CHECKPOINT</a> *)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a475">PROP_CHECKPOINT</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
00088     <span class="keywordflow">if</span> (pcp &amp;&amp; pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o7">fMaxInitialized</a>) {
00089         <span class="comment">/*</span>
00090 <span class="comment">         * Note:  For top level windows, we will fix this point up after</span>
00091 <span class="comment">         * the fact if it has gotten out of date because the size border</span>
00092 <span class="comment">         * changed.</span>
00093 <span class="comment">         */</span>
00094         lpmmi-&gt;ptMaxPosition = pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o2">ptMax</a>;
00095     } <span class="keywordflow">else</span> {
00096         lpmmi-&gt;ptMaxPosition = *((LPPOINT)&amp;rcParent.left);
00097     }
00098 
00099     <span class="comment">/*</span>
00100 <span class="comment">     * Normal minimum tracking size</span>
00101 <span class="comment">     * Only enforce min tracking size for windows with captions</span>
00102 <span class="comment">     */</span>
00103     xMin = cBorders*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE);
00104     yMin = cBorders*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE);
00105 
00106     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a646">WFCAPTION</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>)) {
00107         lpmmi-&gt;ptMinTrackSize.x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINTRACK);
00108         lpmmi-&gt;ptMinTrackSize.y = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINTRACK);
00109     } <span class="keywordflow">else</span> {
00110         lpmmi-&gt;ptMinTrackSize.x = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE), xMin);
00111         lpmmi-&gt;ptMinTrackSize.y = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE), yMin);
00112     }
00113 
00114     <span class="comment">/*</span>
00115 <span class="comment">     * Normal maximum tracking size</span>
00116 <span class="comment">     */</span>
00117     lpmmi-&gt;ptMaxTrackSize.x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMAXTRACK);
00118     lpmmi-&gt;ptMaxTrackSize.y = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMAXTRACK);
00119 
00120     <span class="comment">/*</span>
00121 <span class="comment">     * SEND THE WM_GETMINMAXINFO MESSAGE</span>
00122 <span class="comment">     */</span>
00123 
00124     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pMonitorReal, &amp;tlpMonitorReal);
00125     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pMonitorPrimary, &amp;tlpMonitorPrimary);
00126     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_GETMINMAXINFO, 0, (LPARAM)lpmmi);
00127 
00128     <span class="comment">/*</span>
00129 <span class="comment">     * VALIDATE THE MINMAXINFO</span>
00130 <span class="comment">     */</span>
00131 
00132     <span class="comment">/*</span>
00133 <span class="comment">     * Minimized Size (this is read only)</span>
00134 <span class="comment">     */</span>
00135     lpmmi-&gt;ptReserved.x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINIMIZED);
00136     lpmmi-&gt;ptReserved.y = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINIMIZED);
00137 
00138     <span class="comment">/*</span>
00139 <span class="comment">     * Maximized Postion and Size (only for top level windows)</span>
00140 <span class="comment">     */</span>
00141     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00142         LPRECT  lprcRealMax;
00143 
00144         <a class="code" href="../../d4/d1/userk_8h.html#a1332">GetMonitorMaxArea</a>(pwnd, pMonitorReal, &amp;lprcRealMax);
00145 
00146         <span class="comment">/*</span>
00147 <span class="comment">         * Is the window a TRUE maximized dude, or somebody like the DOS box</span>
00148 <span class="comment">         * who can maximize but not take up the entire screen?</span>
00149 <span class="comment">         *</span>
00150 <span class="comment">         * Is the window really maximizeable?</span>
00151 <span class="comment">         */</span>
00152         <span class="keywordflow">if</span> ((lpmmi-&gt;ptMaxSize.x &gt;= (pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right - pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left)) &amp;&amp;
00153             (lpmmi-&gt;ptMaxSize.y &gt;= (pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom - pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top))) {
00154 
00155             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a582">WFREALLYMAXIMIZABLE</a>);
00156 
00157             <span class="comment">/*</span>
00158 <span class="comment">             * Need to reload the checkpoint here, since it might have gotten</span>
00159 <span class="comment">             * blown away while we were in the xxxSendMessage call above.</span>
00160 <span class="comment">             */</span>
00161             pcp = (<a class="code" href="../../d0/d0/structtagCHECKPOINT.html">CHECKPOINT</a> *)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a475">PROP_CHECKPOINT</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
00162 
00163             <span class="keywordflow">if</span> (    pcp &amp;&amp;
00164                     pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o7">fMaxInitialized</a> &amp;&amp;
00165                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a638">WFSIZEBOX</a>) &amp;&amp;
00166                     (lpmmi-&gt;ptMaxPosition.x != rcParent.left) &amp;&amp;
00167                     (pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o2">ptMax</a>.x == lpmmi-&gt;ptMaxPosition.x)) {
00168 
00169                 <span class="comment">/*</span>
00170 <span class="comment">                 * If this window has a weird maximize point that doesn't jibe</span>
00171 <span class="comment">                 * with what we'd expect and it has a checkpoint, fix up the</span>
00172 <span class="comment">                 * checkpoint.  It means that somebody's WINDOWPLACEMENT</span>
00173 <span class="comment">                 * got out of date when the size border changed dimensions.</span>
00174 <span class="comment">                 */</span>
00175                 pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o7">fMaxInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00176 
00177                 lpmmi-&gt;ptMaxPosition.y += (rcParent.left - lpmmi-&gt;ptMaxPosition.x);
00178                 lpmmi-&gt;ptMaxPosition.x = rcParent.left;
00179             }
00180 
00181             <span class="comment">/*</span>
00182 <span class="comment">             * Transfer the maximum size over to the monitor we are REALLY</span>
00183 <span class="comment">             * moving to.  And fix up guys going fullscreen.  A whole bunch</span>
00184 <span class="comment">             * of Consumer titles + Word '95 and XL '95 move their caption</span>
00185 <span class="comment">             * above the top of the monitor when going fullscreen.  Detect</span>
00186 <span class="comment">             * these guys now, and let them take up the monitor.</span>
00187 <span class="comment">             */</span>
00188             <span class="keywordflow">if</span> (    lpmmi-&gt;ptMaxPosition.y + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCAPTION) &lt;=
00189                         pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top
00190                     &amp;&amp;
00191                     lpmmi-&gt;ptMaxPosition.y + lpmmi-&gt;ptMaxSize.y &gt;=
00192                         pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom) {
00193 
00194                 lprcRealMax = &amp;pMonitorReal-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>;
00195             }
00196 
00197             <span class="comment">/*</span>
00198 <span class="comment">             * Compensate for the difference between the primary monitor</span>
00199 <span class="comment">             * and the monitor we are actually on.</span>
00200 <span class="comment">             */</span>
00201             lpmmi-&gt;ptMaxSize.x = lpmmi-&gt;ptMaxSize.x -
00202                 (pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right - pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left) +
00203                 (lprcRealMax-&gt;right - lprcRealMax-&gt;left);
00204 
00205             lpmmi-&gt;ptMaxSize.y = lpmmi-&gt;ptMaxSize.y -
00206                 (pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom - pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top) +
00207                 (lprcRealMax-&gt;bottom - lprcRealMax-&gt;top);
00208         } <span class="keywordflow">else</span> {
00209             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a582">WFREALLYMAXIMIZABLE</a>);
00210         }
00211 
00212         <span class="comment">/*</span>
00213 <span class="comment">         * Now transfer the max position over to the monitor we are REALLY</span>
00214 <span class="comment">         * moving to.</span>
00215 <span class="comment">         */</span>
00216         lpmmi-&gt;ptMaxPosition.x += lprcRealMax-&gt;left;
00217         lpmmi-&gt;ptMaxPosition.y += lprcRealMax-&gt;top;
00218     }
00219 
00220     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpMonitorPrimary);
00221     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpMonitorReal);
00222 
00223     <span class="comment">/*</span>
00224 <span class="comment">     * Normal minimum tracking size.</span>
00225 <span class="comment">     */</span>
00226 
00227     <span class="comment">/*</span>
00228 <span class="comment">     * WFCAPTION == WFBORDER | WFDLGFRAME; So, when we want to test for the</span>
00229 <span class="comment">     * presence of CAPTION, we must test for both the bits. Otherwise we</span>
00230 <span class="comment">     * might mistake WFBORDER or WFDLGFRAME to be a CAPTION.</span>
00231 <span class="comment">     *</span>
00232 <span class="comment">     *</span>
00233 <span class="comment">     * We must not allow a window to be sized smaller than the border</span>
00234 <span class="comment">     * thickness -- SANKAR -- 06/12/91 --</span>
00235 <span class="comment">     */</span>
00236     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a553">WFCPRESENT</a>)) {
00237 
00238         <span class="comment">/*</span>
00239 <span class="comment">         * NOTE THAT IF YOU CHANGE THE SPACING OF STUFF IN THE CAPTION,</span>
00240 <span class="comment">         * YOU NEED TO KEEP THE FOLLOWING IN SSYNC:</span>
00241 <span class="comment">         *      (1) Default CXMINTRACK, CYMINTRACK in inctlpan.c</span>
00242 <span class="comment">         *      (2) The default minimum right below</span>
00243 <span class="comment">         *      (3) Hit testing</span>
00244 <span class="comment">         *</span>
00245 <span class="comment">         * The minimum size should be space for:</span>
00246 <span class="comment">         *      * The borders</span>
00247 <span class="comment">         *      * The buttons</span>
00248 <span class="comment">         *      * Margins</span>
00249 <span class="comment">         *      * 4 chars of text</span>
00250 <span class="comment">         *      * Caption icon</span>
00251 <span class="comment">         */</span>
00252         yMin = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINTRACK);
00253 
00254         <span class="comment">/*</span>
00255 <span class="comment">         * Min track size is determined by the number of buttons in</span>
00256 <span class="comment">         * the caption.</span>
00257 <span class="comment">         */</span>
00258         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>)) {
00259 
00260             <span class="comment">/*</span>
00261 <span class="comment">             * Add in space for close button.</span>
00262 <span class="comment">             */</span>
00263             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a639">WFSYSMENU</a>))
00264                 xMin += <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSMSIZE);
00265 
00266             <span class="comment">/*</span>
00267 <span class="comment">             * DON'T add in space for 2 characters--breaks</span>
00268 <span class="comment">             * MFC toolbar stuff.  They want to make vertical undocked</span>
00269 <span class="comment">             * toolbars narrower than what that would produce.</span>
00270 <span class="comment">             */</span>
00271             xMin += (2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE));
00272 
00273         } <span class="keywordflow">else</span> {
00274 
00275             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a639">WFSYSMENU</a>)) {
00276 
00277                 <span class="comment">/*</span>
00278 <span class="comment">                 * Add in space for min/max/close buttons.  Otherwise,</span>
00279 <span class="comment">                 * if it's a contexthelp window, then add in space</span>
00280 <span class="comment">                 * for help/close buttons.</span>
00281 <span class="comment">                 */</span>
00282                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a636">WFMINBOX</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a634">WFMAXBOX</a>)))
00283                     xMin += 3 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSIZE);
00284                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a623">WEFCONTEXTHELP</a>))
00285                     xMin += 2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSIZE);
00286 
00287 
00288                 <span class="comment">/*</span>
00289 <span class="comment">                 * Add in space for system menu icon.</span>
00290 <span class="comment">                 */</span>
00291                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a10">_HasCaptionIcon</a>(pwnd))
00292                     xMin += <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSIZE);
00293             }
00294 
00295             <span class="comment">/*</span>
00296 <span class="comment">             * Add in space for 4 characters and margins.</span>
00297 <span class="comment">             */</span>
00298             xMin += 4 * <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a132">gcxCaptionFontChar</a> + 2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE);
00299         }
00300     }
00301 
00302     lpmmi-&gt;ptMinTrackSize.x = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(lpmmi-&gt;ptMinTrackSize.x, xMin);
00303     lpmmi-&gt;ptMinTrackSize.y = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(lpmmi-&gt;ptMinTrackSize.y, yMin);
00304 }
00305 
00306 
00307 
00308 <span class="comment">/***************************************************************************\</span>
00309 <span class="comment">* ParkIcon</span>
00310 <span class="comment">*</span>
00311 <span class="comment">* Called when minimizing a window.  This parks the minwnd in the position</span>
00312 <span class="comment">* given in the checkpoint or calculates a new position for it.</span>
00313 <span class="comment">*</span>
00314 <span class="comment">* LauraBu 10/15/92</span>
00315 <span class="comment">* We now let the user specify two things that affect parking and arranging:</span>
00316 <span class="comment">*     (1) The corner to start arranging from</span>
00317 <span class="comment">*     (2) The direction to move in first</span>
00318 <span class="comment">* MCostea 11/13/98  #246397</span>
00319 <span class="comment">*   Add sanity check for the number of tries.  If the metrics are messed up</span>
00320 <span class="comment">*   and pwnd has a lot of siblings, the for-ever loop would make us timeout</span>
00321 <span class="comment">*</span>
00322 <span class="comment">\***************************************************************************/</span>
00323 
<a name="l00324"></a><a class="code" href="../../d4/d9/minmax_8c.html#a4">00324</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d9/minmax_8c.html#a4">ParkIcon</a>(
00325     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwnd,
00326     <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">PCHECKPOINT</a> pcp)
00327 {
00328     RECT        rcTest;
00329     RECT        rcT;
00330     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        xIconPositions;
00331     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        xIconT;
00332     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndTest;
00333     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndParent;
00334     <span class="keywordtype">int</span>         xOrg;
00335     <span class="keywordtype">int</span>         yOrg;
00336     <span class="keywordtype">int</span>         dx;
00337     <span class="keywordtype">int</span>         dy;
00338     <span class="keywordtype">int</span>         dxSlot;
00339     <span class="keywordtype">int</span>         dySlot;
00340     <span class="keywordtype">int</span>         iteration;
00341     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fHorizontal;
00342     <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">PCHECKPOINT</a> pncp;
00343 
00344     <span class="comment">/*</span>
00345 <span class="comment">     * Put these into local vars immediately.  The compiler is too dumb to</span>
00346 <span class="comment">     * know that we're using a constant offset into a constant address, and</span>
00347 <span class="comment">     * thus a resulting constant address.</span>
00348 <span class="comment">     */</span>
00349     dxSlot = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINSPACING);
00350     dySlot = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINSPACING);
00351 
00352     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwnd)) {
00353 
00354         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o6">fMinInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00355         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.x         = <a class="code" href="../../d4/d1/userk_8h.html#a608">WHERE_NOONE_CAN_SEE_ME</a>;
00356         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.y         = <a class="code" href="../../d4/d1/userk_8h.html#a608">WHERE_NOONE_CAN_SEE_ME</a>;
00357 
00358         <span class="keywordflow">return</span>;
00359     }
00360 
00361     <span class="comment">/* We need to adjust the client rectangle for scrollbars, just like we</span>
00362 <span class="comment">     * do in ArrangeIconicWindows().  If one thing is clear, it is that</span>
00363 <span class="comment">     * parking and arranging must follow the same principles.  This is to</span>
00364 <span class="comment">     * avoid the user arranging some windows, creating a new one, and parking</span>
00365 <span class="comment">     * it in a place not consistent with the arrangement of the others.</span>
00366 <span class="comment">     */</span>
00367     pwndParent = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00368     <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a3">GetRealClientRect</a>(pwndParent, &amp;rcT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a873">GRC_SCROLLS</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00369 
00370     <span class="comment">/*</span>
00371 <span class="comment">     * Get gravity &amp; move vars.  We want gaps to start on the sides that</span>
00372 <span class="comment">     * we begin arranging from.</span>
00373 <span class="comment">     *</span>
00374 <span class="comment">     * Horizontal gravity</span>
00375 <span class="comment">     */</span>
00376     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(ARRANGE) &amp; ARW_STARTRIGHT) {
00377 
00378         <span class="comment">/*</span>
00379 <span class="comment">         * Starting on right side</span>
00380 <span class="comment">         */</span>
00381         rcTest.left = xOrg = rcT.right - dxSlot;
00382         dx = -dxSlot;
00383 
00384     } <span class="keywordflow">else</span> {
00385 
00386         <span class="comment">/*</span>
00387 <span class="comment">         * Starting on left</span>
00388 <span class="comment">         */</span>
00389         rcTest.left = xOrg = rcT.left + <a class="code" href="../../d7/d9/icons_8c.html#a0">DX_GAP</a>;
00390         dx = dxSlot;
00391     }
00392 
00393     <span class="comment">/*</span>
00394 <span class="comment">     * Vertical gravity</span>
00395 <span class="comment">     */</span>
00396     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(ARRANGE) &amp; ARW_STARTTOP) {
00397 
00398         <span class="comment">/*</span>
00399 <span class="comment">         * Starting on top side</span>
00400 <span class="comment">         */</span>
00401         rcTest.top = yOrg = rcT.top + <a class="code" href="../../d7/d9/icons_8c.html#a1">DY_GAP</a>;
00402         dy = dySlot;
00403 
00404     } <span class="keywordflow">else</span> {
00405 
00406         <span class="comment">/*</span>
00407 <span class="comment">         * Starting on bottom</span>
00408 <span class="comment">         */</span>
00409         rcTest.top = yOrg = rcT.bottom - dySlot;
00410         dy = -dySlot;
00411     }
00412 
00413     <span class="comment">/*</span>
00414 <span class="comment">     * Get arrangement direction.  Note that ARW_HORIZONTAL is 0, so we</span>
00415 <span class="comment">     * can't test for it.</span>
00416 <span class="comment">     */</span>
00417     fHorizontal = ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(ARRANGE) &amp; ARW_DOWN) ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00418 
00419     <span class="keywordflow">if</span> (fHorizontal)
00420         xIconPositions = xIconT = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(1, (rcT.right / dxSlot));
00421     <span class="keywordflow">else</span>
00422         xIconPositions = xIconT = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(1, (rcT.bottom / dySlot));
00423 
00424     <span class="comment">/*</span>
00425 <span class="comment">     * BOGUS</span>
00426 <span class="comment">     * LauraBu 10/15/92</span>
00427 <span class="comment">     * What happens if the parent is scrolled over horizontally or</span>
00428 <span class="comment">     * vertically?  Just like when you drop an object...</span>
00429 <span class="comment">     */</span>
00430     iteration = 0;
00431     <span class="keywordflow">while</span> (iteration &lt; 5000) {
00432 
00433         <span class="comment">/*</span>
00434 <span class="comment">         * Make a rectangle representing this position, in screen coords</span>
00435 <span class="comment">         */</span>
00436         rcTest.right = rcTest.left + dxSlot;
00437         rcTest.bottom = rcTest.top + dySlot;
00438 
00439         <span class="comment">/*</span>
00440 <span class="comment">         * Look for intersections with existing iconic windows</span>
00441 <span class="comment">         */</span>
00442         <span class="keywordflow">for</span> (pwndTest = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>; pwndTest; pwndTest = pwndTest-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
00443 
00444             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndTest, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>))
00445                     <span class="keywordflow">continue</span>;
00446 
00447             <span class="keywordflow">if</span> (pwndTest == pwnd)
00448                     <span class="keywordflow">continue</span>;
00449 
00450             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndTest, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00451 
00452                 <span class="comment">/*</span>
00453 <span class="comment">                 * This is a non-minimized window.  See if it has a checkpoint</span>
00454 <span class="comment">                 * and find out where it would be if it were minimized.  We</span>
00455 <span class="comment">                 * will try not to park an icon in this spot.</span>
00456 <span class="comment">                 */</span>
00457                 pncp = (<a class="code" href="../../d0/d0/structtagCHECKPOINT.html">PCHECKPOINT</a>)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwndTest,
00458                                              <a class="code" href="../../d4/d1/userk_8h.html#a475">PROP_CHECKPOINT</a>,
00459                                              <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
00460 
00461                 <span class="keywordflow">if</span> (!pncp || !pncp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o3">fDragged</a> || !pncp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o6">fMinInitialized</a>)
00462                     <span class="keywordflow">continue</span>;
00463 
00464                 <span class="comment">/*</span>
00465 <span class="comment">                 * Get parent coordinates of minimized window pos.</span>
00466 <span class="comment">                 */</span>
00467                 rcT.right   = rcT.left = pncp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.x;
00468                 rcT.right  += dxSlot;
00469                 rcT.bottom  = rcT.top  = pncp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.y;
00470                 rcT.bottom += dySlot;
00471 
00472             } <span class="keywordflow">else</span> {
00473 
00474                 <span class="comment">/*</span>
00475 <span class="comment">                 * Get parent coordinates of currently minimized window</span>
00476 <span class="comment">                 */</span>
00477                 <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a12">GetRect</a>(pwndTest, &amp;rcT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a903">GRECT_WINDOW</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a907">GRECT_PARENTCOORDS</a>);
00478             }
00479 
00480             iteration++;
00481             <span class="comment">/*</span>
00482 <span class="comment">             * Get out of loop if they overlap</span>
00483 <span class="comment">             */</span>
00484             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcT, &amp;rcT, &amp;rcTest))
00485                 <span class="keywordflow">break</span>;
00486         }
00487 
00488         <span class="comment">/*</span>
00489 <span class="comment">         * Found a position that doesn't overlap, so get out of search loop</span>
00490 <span class="comment">         */</span>
00491         <span class="keywordflow">if</span> (!pwndTest)
00492             <span class="keywordflow">break</span>;
00493 
00494         <span class="comment">/*</span>
00495 <span class="comment">         * Else setup to process the next position</span>
00496 <span class="comment">         */</span>
00497         <span class="keywordflow">if</span> (--xIconT == 0) {
00498 
00499             <span class="comment">/*</span>
00500 <span class="comment">             * Setup next pass</span>
00501 <span class="comment">             */</span>
00502             xIconT = xIconPositions;
00503 
00504             <span class="keywordflow">if</span> (fHorizontal) {
00505                 rcTest.left = xOrg;
00506                 rcTest.top += dy;
00507             } <span class="keywordflow">else</span> {
00508                 rcTest.left += dx;
00509                 rcTest.top = yOrg;
00510             }
00511 
00512         } <span class="keywordflow">else</span> {
00513 
00514             <span class="comment">/*</span>
00515 <span class="comment">             * Same pass.</span>
00516 <span class="comment">             */</span>
00517             <span class="keywordflow">if</span> (fHorizontal)
00518                 rcTest.left += dx;
00519             <span class="keywordflow">else</span>
00520                 rcTest.top += dy;
00521         }
00522     }
00523 
00524     <span class="comment">/*</span>
00525 <span class="comment">     * Note that rcTest is in parent coordinates already.</span>
00526 <span class="comment">     */</span>
00527     pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o6">fMinInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00528     pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.x         = rcTest.left;
00529     pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.y         = rcTest.top;
00530 }
00531 
00532 <span class="comment">/***************************************************************************\</span>
00533 <span class="comment">* xxxAnimateCaption</span>
00534 <span class="comment">*</span>
00535 <span class="comment">*</span>
00536 <span class="comment">\***************************************************************************/</span>
00537 
<a name="l00538"></a><a class="code" href="../../d4/d9/minmax_8c.html#a5">00538</a> ULONG_PTR <a class="code" href="../../d4/d9/minmax_8c.html#a5">SaveScreen</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, ULONG iMode, ULONG_PTR iSave, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> cx, <span class="keywordtype">int</span> cy)
00539 {
00540     RECT rc;
00541 
00542     <span class="comment">/*</span>
00543 <span class="comment">     * x and y are in the DC coordinates, make the screen in the</span>
00544 <span class="comment">     * (meta hdev) coordinates for the call to Gre/driver.</span>
00545 <span class="comment">     */</span>
00546     rc.left = x + pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00547     rc.right = x + cx;
00548     rc.top = y + pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00549     rc.bottom = y + <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00550 
00551     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, &amp;rc, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>)) {
00552         <span class="keywordflow">return</span> GreSaveScreenBits(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, iMode, iSave, (RECTL*)&amp;rc);
00553     } <span class="keywordflow">else</span> {
00554         <span class="keywordflow">return</span> 0;
00555     }
00556 }
00557 
<a name="l00558"></a><a class="code" href="../../d4/d9/minmax_8c.html#a6">00558</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d9/minmax_8c.html#a6">xxxAnimateCaption</a>(
00559     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd,
00560     HDC    hdc,
00561     LPRECT lprcStart,
00562     LPRECT lprcEnd)
00563 {
00564     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        dwTimeStart;
00565     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        iTimeElapsed;
00566     <span class="keywordtype">int</span>          iLeftStart;
00567     <span class="keywordtype">int</span>          iTopStart;
00568     <span class="keywordtype">int</span>          cxStart;
00569     <span class="keywordtype">int</span>          dLeft;
00570     <span class="keywordtype">int</span>          dTop;
00571     <span class="keywordtype">int</span>          dcx;
00572     <span class="keywordtype">int</span>          iLeft;
00573     <span class="keywordtype">int</span>          iTop;
00574     <span class="keywordtype">int</span>          cx;
00575     <span class="keywordtype">int</span>          iLeftNew;
00576     <span class="keywordtype">int</span>          iTopNew;
00577     <span class="keywordtype">int</span>          cxNew;
00578     <span class="keywordtype">int</span>          cBorders;
00579     HBITMAP      hbmpOld;
00580     RECT         rc;
00581     <span class="keywordtype">int</span>          <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00582     HDC          hdcMem;
00583     ULONG_PTR     uSave;
00584     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>         pwndOrg;
00585 
00586     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00587 
00588     <span class="keywordflow">if</span> ((pwndOrg = <a class="code" href="../../d4/d1/userk_8h.html#a1903">_WindowFromDC</a>(hdc)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00589         RIPMSG0(RIP_WARNING, <span class="stringliteral">"SaveScreen: invalid DC passed in"</span>);
00590         <span class="keywordflow">return</span>;
00591     }
00592 
00593     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCAPTION) - 1;
00594 
00595     <span class="comment">/*</span>
00596 <span class="comment">     *  kurtp: 29-Jan-1997</span>
00597 <span class="comment">     *</span>
00598 <span class="comment">     *  We don't do anything when animating the caption,</span>
00599 <span class="comment">     *  because we couldn't get the desired effect at the</span>
00600 <span class="comment">     *  client.  If we do use it then the</span>
00601 <span class="comment">     *  cache gets a bunch of bitmaps (size: 2xCaption by CXScreen)</span>
00602 <span class="comment">     *  that are never re-used.  This slows down clients</span>
00603 <span class="comment">     *  because the GreBitBlts always generate new bitmaps</span>
00604 <span class="comment">     *  and the cache is displaced by the new bitmaps (yuk!).</span>
00605 <span class="comment">     */</span>
00606 
00607     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>)
00608         <span class="keywordflow">return</span>;
00609 
00610     <span class="keywordflow">if</span> ((hdcMem = GreCreateCompatibleDC(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00611         <span class="keywordflow">return</span>;
00612 
00613     <span class="comment">/*</span>
00614 <span class="comment">     * If the caption strip doesn't exist, then attempt to recreate it.  This</span>
00615 <span class="comment">     * might be necessary if the user does a mode-switch during low memory</span>
00616 <span class="comment">     * and is not able to recreate the surface.  When the memory becomes</span>
00617 <span class="comment">     * available, we'll attempt to recreate it here.</span>
00618 <span class="comment">     */</span>
00619     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a131">ghbmCaption</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00620         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a131">ghbmCaption</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1843">CreateCaptionStrip</a>();
00621     }
00622 
00623     hbmpOld = GreSelectBitmap(hdcMem, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a131">ghbmCaption</a>);
00624 
00625     <span class="comment">/*</span>
00626 <span class="comment">     * initialize start values</span>
00627 <span class="comment">     */</span>
00628     iTopStart  = lprcStart-&gt;top;
00629     iLeftStart = lprcStart-&gt;left;
00630     cxStart    = lprcStart-&gt;right - iLeftStart;
00631 
00632     <span class="comment">/*</span>
00633 <span class="comment">     * initialize delta values to the destination dimensions</span>
00634 <span class="comment">     */</span>
00635     dLeft  = lprcEnd-&gt;left;
00636     dTop   = lprcEnd-&gt;top;
00637     dcx    = lprcEnd-&gt;right - dLeft;
00638 
00639     <span class="comment">/*</span>
00640 <span class="comment">     * adjust for window borders as appropriate</span>
00641 <span class="comment">     */</span>
00642     cBorders = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a7">GetWindowBorders</a>(pwnd-&gt;style,
00643                                 pwnd-&gt;ExStyle,
00644                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00645                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00646 
00647     <span class="keywordflow">if</span> ((lprcStart-&gt;bottom - iTopStart) &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCAPTION)) {
00648 
00649         iLeftStart += cBorders;
00650         iTopStart  += cBorders;
00651         cxStart    -= 2*cBorders;
00652     }
00653 
00654     <span class="keywordflow">if</span> ((lprcEnd-&gt;bottom - dTop) &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCAPTION)) {
00655 
00656         dLeft += cBorders;
00657         dTop  += cBorders;
00658         dcx   -= 2*cBorders;
00659     }
00660 
00661     <span class="comment">/*</span>
00662 <span class="comment">     * initialize step values</span>
00663 <span class="comment">     */</span>
00664     iLeft = iLeftStart;
00665     iTop  = iTopStart;
00666     cx    = cxStart;
00667 
00668     <span class="comment">/*</span>
00669 <span class="comment">     * initialize off screen bitmap with caption drawing and first saved rect</span>
00670 <span class="comment">     */</span>
00671     rc.left   = 0;
00672     rc.top    = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00673     rc.right  = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(cxStart, dcx);
00674     rc.bottom = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> * 2;
00675 
00676     <a class="code" href="../../d4/d1/userk_8h.html#a1935">xxxDrawCaptionTemp</a>(pwnd,
00677                        hdcMem,
00678                        &amp;rc,
00679                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00680                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00681                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00682                        DC_ACTIVE | DC_ICON | DC_TEXT |
00683                        (<a class="code" href="../../d4/d1/userk_8h.html#a666">TestALPHA</a>(GRADIENTCAPTIONS) ? DC_GRADIENT : 0));
00684 
00685     <span class="keywordflow">if</span> ((uSave = <a class="code" href="../../d4/d9/minmax_8c.html#a5">SaveScreen</a>(pwndOrg, SS_SAVE, 0,iLeft, iTop, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)) == 0) {
00686         <span class="keywordflow">if</span> (!GreBitBlt(hdcMem,
00687                   0,
00688                   0,
00689                   cx,
00690                   <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00691                   hdc,
00692                   iLeft,
00693                   iTop,
00694                   SRCCOPY,
00695                   0)) {
00696             <span class="keywordflow">goto</span> Cleanup;
00697         }
00698     }
00699 
00700     <span class="comment">/*</span>
00701 <span class="comment">     * compute delta values by subtracting source dimensions</span>
00702 <span class="comment">     */</span>
00703     dLeft -= iLeftStart;
00704     dTop  -= iTopStart;
00705     dcx   -= cxStart;
00706 
00707     <span class="comment">/*</span>
00708 <span class="comment">     * blt and time first caption on screen</span>
00709 <span class="comment">     * WARNING: If you use *lpSystemTickCount here,</span>
00710 <span class="comment">     * the compiler may not generate code to do a DWORD fetch;</span>
00711 <span class="comment">     */</span>
00712     dwTimeStart = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
00713     GreBitBlt(hdc,
00714               iLeft,
00715               iTop,
00716               cx,
00717               <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00718               hdcMem,
00719               0,
00720               <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00721               SRCCOPY,
00722               0);
00723 
00724     iTimeElapsed = (<a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() - dwTimeStart);
00725 
00726     <span class="keywordflow">while</span> (LOWORD(iTimeElapsed) &lt;= <a class="code" href="../../d4/d9/minmax_8c.html#a0">CMS_ANIMATION</a>) {
00727 
00728         iLeftNew = iLeftStart + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(dLeft, LOWORD(iTimeElapsed), <a class="code" href="../../d4/d9/minmax_8c.html#a0">CMS_ANIMATION</a>);
00729         iTopNew  = iTopStart  + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(dTop,  LOWORD(iTimeElapsed), <a class="code" href="../../d4/d9/minmax_8c.html#a0">CMS_ANIMATION</a>);
00730         cxNew    = cxStart    + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(dcx,   LOWORD(iTimeElapsed), <a class="code" href="../../d4/d9/minmax_8c.html#a0">CMS_ANIMATION</a>);
00731 
00732         <span class="comment">/*</span>
00733 <span class="comment">         * Delay before next frame</span>
00734 <span class="comment">         */</span>
00735         <a class="code" href="../../d4/d1/userk_8h.html#a1294">UserSleep</a>(1);
00736 
00737         <span class="comment">/*</span>
00738 <span class="comment">         * restore saved rect</span>
00739 <span class="comment">         */</span>
00740         <span class="keywordflow">if</span> (uSave != 0) {
00741             <a class="code" href="../../d4/d9/minmax_8c.html#a5">SaveScreen</a>(pwndOrg, SS_RESTORE, uSave, iLeft, iTop, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
00742         } <span class="keywordflow">else</span> {
00743             GreBitBlt(hdc,
00744                       iLeft,
00745                       iTop,
00746                       cx,
00747                       <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00748                       hdcMem,
00749                       0,
00750                       0,
00751                       SRCCOPY,
00752                       0);
00753         }
00754 
00755         iLeft = iLeftNew;
00756         iTop  = iTopNew;
00757         cx    = cxNew;
00758 
00759         <span class="comment">/*</span>
00760 <span class="comment">         * save new rect offscreen and then draw over it onscreen.</span>
00761 <span class="comment">         */</span>
00762         <span class="keywordflow">if</span> (uSave != 0) {
00763             uSave = <a class="code" href="../../d4/d9/minmax_8c.html#a5">SaveScreen</a>(pwndOrg, SS_SAVE, 0, iLeft, iTop, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
00764         } <span class="keywordflow">else</span> {
00765             GreBitBlt(hdcMem,
00766                       0,
00767                       0,
00768                       cx,
00769                       <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00770                       hdc,
00771                       iLeft,
00772                       iTop,
00773                       SRCCOPY,
00774                       0);
00775         }
00776         GreBitBlt(hdc,
00777                   iLeft,
00778                   iTop,
00779                   cx,
00780                   <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00781                   hdcMem,
00782                   0,
00783                   <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00784                   SRCCOPY,
00785                   0);
00786 
00787         <span class="comment">/*</span>
00788 <span class="comment">         * update elapsed time</span>
00789 <span class="comment">         * WARNING: If you use *lpSystemTickCount here,</span>
00790 <span class="comment">         * the compiler may not generate code to do a DWORD fetch;</span>
00791 <span class="comment">         */</span>
00792         iTimeElapsed = (<a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() - dwTimeStart);
00793     }
00794 
00795     <span class="comment">/*</span>
00796 <span class="comment">     * restore saved rect</span>
00797 <span class="comment">     */</span>
00798     <span class="keywordflow">if</span> (uSave != 0) {
00799         <a class="code" href="../../d4/d9/minmax_8c.html#a5">SaveScreen</a>(pwndOrg, SS_RESTORE, uSave, iLeft, iTop, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
00800     } <span class="keywordflow">else</span> {
00801         GreBitBlt(hdc,
00802                   iLeft,
00803                   iTop,
00804                   cx,
00805                   <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00806                   hdcMem,
00807                   0,
00808                   0,
00809                   SRCCOPY,
00810                   0);
00811     }
00812 
00813 Cleanup:
00814     GreSelectBitmap(hdcMem, hbmpOld);
00815     GreDeleteDC(hdcMem);
00816 }
00817 
00818 <span class="preprocessor">#if 0 // DISABLE OLD ANIMATION FOR M7</span>
00819 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
00820 <span class="comment">* DrawWireFrame</span>
00821 <span class="comment">*</span>
00822 <span class="comment">* Draws wire frame trapezoid</span>
00823 <span class="comment">*</span>
00824 <span class="comment">*</span>
00825 <span class="comment">\***************************************************************************/</span>
00826 
00827 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> DrawWireFrame(
00828     HDC    hdc,
00829     LPRECT prcFront,
00830     LPRECT prcBack)
00831 {
00832     RECT rcFront;
00833     RECT rcBack;
00834     RECT rcT;
00835     HRGN hrgnSave;
00836     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fClip;
00837 
00838     <span class="comment">/*</span>
00839 <span class="comment">     * Save these locally</span>
00840 <span class="comment">     */</span>
00841     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcFront, prcFront);
00842     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcBack, prcBack);
00843 
00844     <span class="comment">/*</span>
00845 <span class="comment">     * Front face</span>
00846 <span class="comment">     */</span>
00847     GreMoveTo(hdc, rcFront.left, rcFront.top);
00848     GreLineTo(hdc, rcFront.left, rcFront.bottom);
00849     GreLineTo(hdc, rcFront.right, rcFront.bottom);
00850     GreLineTo(hdc, rcFront.right, rcFront.top);
00851     GreLineTo(hdc, rcFront.left, rcFront.top);
00852 
00853     <span class="comment">/*</span>
00854 <span class="comment">     * Exclude front face from clipping area, only if back face isn't</span>
00855 <span class="comment">     * entirely within interior.  We need variable because SaveClipRgn()</span>
00856 <span class="comment">     * can return NULL.</span>
00857 <span class="comment">     */</span>
00858     fClip = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a34">EqualRect</a>(&amp;rcFront, &amp;rcBack)            ||
00859              !<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcT, &amp;rcFront, &amp;rcBack) ||
00860              !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a34">EqualRect</a>(&amp;rcT, &amp;rcBack));
00861 
00862     <span class="keywordflow">if</span> (fClip) {
00863 
00864         hrgnSave = GreSaveClipRgn(hdc);
00865 
00866         GreExcludeClipRect(hdc,
00867                            rcFront.left,
00868                            rcFront.top,
00869                            rcFront.right,
00870                            rcFront.bottom);
00871     }
00872 
00873     <span class="comment">/*</span>
00874 <span class="comment">     * Edges</span>
00875 <span class="comment">     */</span>
00876     GreMoveTo(hdc, rcBack.left, rcBack.top);
00877     LineTo(hdc, rcFront.left, rcFront.top);
00878 
00879     GreMoveTo(hdc, rcBack.right, rcBack.top);
00880     GreLineTo(hdc, rcFront.right, rcFront.top);
00881 
00882     GreMoveTo(hdc, rcBack.right, rcBack.bottom);
00883     GreLineTo(hdc, rcFront.right, rcFront.bottom);
00884 
00885     GreMoveTo(hdc, rcBack.left, rcBack.bottom);
00886     GreLineTo(hdc, rcFront.left, rcFront.bottom);
00887 
00888     <span class="comment">/*</span>
00889 <span class="comment">     * Back face</span>
00890 <span class="comment">     */</span>
00891     MoveTo(hdc, rcBack.left, rcBack.top);
00892     LineTo(hdc, rcBack.left, rcBack.bottom);
00893     LineTo(hdc, rcBack.right, rcBack.bottom);
00894     LineTo(hdc, rcBack.right, rcBack.top);
00895     LineTo(hdc, rcBack.left, rcBack.top);
00896 
00897     <span class="keywordflow">if</span> (fClip)
00898         GreRestoreClipRgn(hdc, hrgnSave);
00899 }
00900 
00901 <span class="comment">/***************************************************************************\</span>
00902 <span class="comment">* AnimateFrame</span>
00903 <span class="comment">*</span>
00904 <span class="comment">* Draws wire frame 3D trapezoid</span>
00905 <span class="comment">*</span>
00906 <span class="comment">*</span>
00907 <span class="comment">\***************************************************************************/</span>
00908 
00909 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> AnimateFrame(
00910     HDC    hdc,
00911     LPRECT prcStart,
00912     LPRECT prcEnd,
00913     BOOL   fGrowing)
00914 {
00915     RECT  rcBack;
00916     RECT  rcFront;
00917     RECT  rcT;
00918     HPEN  hpen;
00919     <span class="keywordtype">int</span>   nMode;
00920     <span class="keywordtype">int</span>   iTrans;
00921     <span class="keywordtype">int</span>   nTrans;
00922     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTimeStart;
00923     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTimeCur;
00924 
00925     <span class="comment">/*</span>
00926 <span class="comment">     * Get pen for drawing lines</span>
00927 <span class="comment">     */</span>
00928     hpen = GreSelectPen(hdc, GetStockObject(WHITE_PEN));
00929     nMode = GreSetROP2(hdc, R2_XORPEN);
00930 
00931     <span class="comment">/*</span>
00932 <span class="comment">     * Save these locally</span>
00933 <span class="comment">     */</span>
00934     <span class="keywordflow">if</span> (fGrowing) {
00935 
00936         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcBack, prcStart);
00937         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcFront, prcStart);
00938 
00939     } <span class="keywordflow">else</span> {
00940 
00941        <span class="comment">/*</span>
00942 <span class="comment">        * Initial is trapezoid entire way from small to big.  We're going</span>
00943 <span class="comment">        * to shrink it from the front face.</span>
00944 <span class="comment">        */</span>
00945        <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcFront, prcStart);
00946        <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcBack, prcEnd);
00947     }
00948 
00949     <span class="comment">/*</span>
00950 <span class="comment">     * Offset left &amp; top edges of rects, due to way that lines work.</span>
00951 <span class="comment">     */</span>
00952     rcFront.left -= 1;
00953     rcFront.top  -= 1;
00954     rcBack.left  -= 1;
00955     rcBack.top   -= 1;
00956 
00957     <span class="comment">/*</span>
00958 <span class="comment">     * Get tick count.  We'll draw then check how much time elapsed.  From</span>
00959 <span class="comment">     * that we can calculate how many more transitions to draw.  For the first</span>
00960 <span class="comment">     * We basically want whole animation to last 3/4 of a second, or 750</span>
00961 <span class="comment">     * milliseconds.</span>
00962 <span class="comment">     *</span>
00963 <span class="comment">     * WARNING: If you use *lpSystemTickCount here,</span>
00964 <span class="comment">     * the compiler may not generate code to do a DWORD fetch;</span>
00965 <span class="comment">     */</span>
00966     dwTimeStart = GetSystemMsecCount();
00967 
00968     DrawWireFrame(hdc, &amp;rcFront, &amp;rcBack);
00969 
00970     <span class="comment">/*</span>
00971 <span class="comment">     * WARNING: If you use *lpSystemTickCount here,</span>
00972 <span class="comment">     * the compiler may not generate code to do a DWORD fetch;</span>
00973 <span class="comment">     */</span>
00974     dwTimeCur = GetSystemMsecCount();
00975 
00976     <span class="comment">/*</span>
00977 <span class="comment">     * Get rough estimate for how much time it took.</span>
00978 <span class="comment">     */</span>
00979     <span class="keywordflow">if</span> (dwTimeCur == dwTimeStart)
00980         nTrans = <a class="code" href="../../d4/d9/minmax_8c.html#a0">CMS_ANIMATION</a> / 55;
00981     <span class="keywordflow">else</span>
00982         nTrans = <a class="code" href="../../d4/d9/minmax_8c.html#a0">CMS_ANIMATION</a> / ((<span class="keywordtype">int</span>)(dwTimeCur - dwTimeStart));
00983 
00984     iTrans = 1;
00985     <span class="keywordflow">while</span> (iTrans &lt;= nTrans) {
00986 
00987         <span class="comment">/*</span>
00988 <span class="comment">         * Grow the trapezoid out or shrink it in.  Fortunately, prcStart</span>
00989 <span class="comment">         * and prcEnd are already set up for us.</span>
00990 <span class="comment">         */</span>
00991         rcT.left = prcStart-&gt;left +
00992             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(prcEnd-&gt;left - prcStart-&gt;left, iTrans, nTrans);
00993         rcT.top = prcStart-&gt;top +
00994             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(prcEnd-&gt;top - prcStart-&gt;top, iTrans, nTrans);
00995         rcT.right = prcStart-&gt;right +
00996             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(prcEnd-&gt;right - prcStart-&gt;right, iTrans, nTrans);
00997         rcT.bottom = prcStart-&gt;bottom +
00998             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(prcEnd-&gt;bottom - prcStart-&gt;bottom, iTrans, nTrans);
00999 
01000         <span class="comment">/*</span>
01001 <span class="comment">         * Undraw old and draw new</span>
01002 <span class="comment">         */</span>
01003         DrawWireFrame(hdc, &amp;rcFront, &amp;rcBack);
01004         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcFront, &amp;rcT);
01005         DrawWireFrame(hdc, &amp;rcFront, &amp;rcBack);
01006 
01007         <span class="comment">/*</span>
01008 <span class="comment">         * Check the time.  How many more transitions left?</span>
01009 <span class="comment">         *  iTrans / nTrans AS (dwTimeCur-dwTimeStart) / 750</span>
01010 <span class="comment">         *</span>
01011 <span class="comment">         * WARNING: If you use *lpSystemTickCount here,</span>
01012 <span class="comment">         * the compiler may not generate code to do a DWORD fetch;</span>
01013 <span class="comment">         */</span>
01014         dwTimeCur = GetSystemMsecCount();
01015         iTrans = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(nTrans,
01016                          (<span class="keywordtype">int</span>)(dwTimeCur - dwTimeStart),
01017                          CMS_ANIMATION);
01018     }
01019 
01020     <span class="comment">/*</span>
01021 <span class="comment">     * Undraw wire frame</span>
01022 <span class="comment">     */</span>
01023     DrawWireFrame(hdc, &amp;rcFront, &amp;rcBack);
01024 
01025     <span class="comment">/*</span>
01026 <span class="comment">     * Clean up</span>
01027 <span class="comment">     */</span>
01028     GreSetROP2(hdc, nMode);
01029     hpen = GreSelectPen(hdc, hpen);
01030 }
01031 <span class="preprocessor">#endif // END DISABLE OLD ANIMATION FOR M7</span>
01032 <span class="preprocessor"></span>
01033 <span class="comment">/***************************************************************************\</span>
01034 <span class="comment">* xxxDrawAnimatedRects</span>
01035 <span class="comment">*</span>
01036 <span class="comment">* General routine, like PlaySoundEvent(), that calls other routines for</span>
01037 <span class="comment">* various animation effects.  Currently used for changing state from/to</span>
01038 <span class="comment">* minimized.</span>
01039 <span class="comment">*</span>
01040 <span class="comment">\***************************************************************************/</span>
01041 
<a name="l01042"></a><a class="code" href="../../d4/d1/userk_8h.html#a1043">01042</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1043">xxxDrawAnimatedRects</a>(
01043     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwndClip,
01044     <span class="keywordtype">int</span>    idAnimation,
01045     LPRECT lprcStart,
01046     LPRECT lprcEnd)
01047 {
01048     HDC   hdc;
01049     POINT rgPt[4];
01050     RECT  rcClip;
01051     HRGN  hrgn;
01052     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndAnimate = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01053     <span class="keywordtype">int</span>   iPt;
01054 
01055     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndClip);
01056 
01057     <span class="comment">/*</span>
01058 <span class="comment">     * Get rects into variables</span>
01059 <span class="comment">     */</span>
01060     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>((LPRECT)&amp;rgPt[0], lprcStart);
01061     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>((LPRECT)&amp;rgPt[2], lprcEnd);
01062 
01063     <span class="comment">/*</span>
01064 <span class="comment">     * DISABLE OLD ANIMATION FOR M7</span>
01065 <span class="comment">     */</span>
01066     <span class="keywordflow">if</span> (idAnimation != IDANI_CAPTION)
01067         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01068 
01069     pwndAnimate = pwndClip;
01070     <span class="keywordflow">if</span> (!pwndAnimate || pwndAnimate == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwndAnimate))
01071         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01072 
01073     pwndClip = pwndClip-&gt;spwndParent;
01074     <span class="keywordflow">if</span> (!pwndClip) {
01075         RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxDrawAnimatedRects: pwndClip-&gt;spwndParent is NULL"</span>);
01076     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwndClip == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwndClip)) {
01077         pwndClip = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01078     }
01079 
01080     <span class="comment">/*</span>
01081 <span class="comment">     * NOTE:</span>
01082 <span class="comment">     * We do NOT need to do LockWindowUpdate().  We never yield within this</span>
01083 <span class="comment">     * function!  Anything that was invalid will stay invalid, etc.  So our</span>
01084 <span class="comment">     * XOR drawing won't leave remnants around.</span>
01085 <span class="comment">     *</span>
01086 <span class="comment">     * WIN32NT may need to take display critical section or do LWU().</span>
01087 <span class="comment">     *</span>
01088 <span class="comment">     * Get clipping area</span>
01089 <span class="comment">     * Neat feature:</span>
01090 <span class="comment">     *      NULL window means whole screen, don't clip out children</span>
01091 <span class="comment">     *      hwndDesktop means working area, don't clip out children</span>
01092 <span class="comment">     */</span>
01093     <span class="keywordflow">if</span> (pwndClip == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01094         pwndClip = <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>();
01095         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcClip, &amp;pwndClip-&gt;rcClient);
01096         <span class="keywordflow">if</span> ((hrgn = GreCreateRectRgnIndirect(&amp;rcClip)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01097             hrgn = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
01098         }
01099 
01100         <span class="comment">/*</span>
01101 <span class="comment">         * Get drawing DC</span>
01102 <span class="comment">         */</span>
01103         hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwndClip,
01104                        hrgn,
01105                        DCX_WINDOW           |
01106                            DCX_CACHE        |
01107                            DCX_INTERSECTRGN |
01108                            DCX_LOCKWINDOWUPDATE);
01109     } <span class="keywordflow">else</span> {
01110 
01111         hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwndClip,
01112                        <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>,
01113                        DCX_WINDOW | DCX_USESTYLE | DCX_INTERSECTRGN);
01114 
01115         <span class="comment">/*</span>
01116 <span class="comment">         * We now have a window DC.  We need to convert client coords</span>
01117 <span class="comment">         * to window coords.</span>
01118 <span class="comment">         */</span>
01119         <span class="keywordflow">for</span> (iPt = 0; iPt &lt; 4; iPt++) {
01120 
01121             rgPt[iPt].x += (pwndClip-&gt;rcClient.left - pwndClip-&gt;rcWindow.left);
01122             rgPt[iPt].y += (pwndClip-&gt;rcClient.top - pwndClip-&gt;rcWindow.top);
01123         }
01124     }
01125 
01126     <span class="comment">/*</span>
01127 <span class="comment">     * Get drawing DC:</span>
01128 <span class="comment">     * Unclipped if desktop, clipped otherwise.</span>
01129 <span class="comment">     * Note that ReleaseDC() will free the region if needed.</span>
01130 <span class="comment">     */</span>
01131     <span class="keywordflow">if</span> (idAnimation == IDANI_CAPTION) {
01132         <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndAnimate);
01133         <a class="code" href="../../d4/d9/minmax_8c.html#a6">xxxAnimateCaption</a>(pwndAnimate, hdc, (LPRECT)&amp;rgPt[0], (LPRECT)&amp;rgPt[2]);
01134     }
01135 
01136 <span class="comment">/*</span>
01137 <span class="comment"> * DISABLE OLD ANIMATION FOR M7</span>
01138 <span class="comment"> */</span>
01139 <span class="preprocessor">#if 0</span>
01140 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
01141         AnimateFrame(hdc,
01142                      (LPRECT)&amp;rgPt[0],
01143                      (LPRECT)&amp;rgPt[2],
01144                      (idAnimation == IDANI_OPEN));
01145     }
01146 <span class="preprocessor">#endif</span>
01147 <span class="preprocessor"></span><span class="comment">/*</span>
01148 <span class="comment"> * END DISABLE OLD ANIMATION FOR M7</span>
01149 <span class="comment"> */</span>
01150 
01151     <span class="comment">/*</span>
01152 <span class="comment">     * Clean up</span>
01153 <span class="comment">     */</span>
01154     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
01155 
01156     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01157 }
01158 
01159 
01160 <span class="comment">/***************************************************************************\</span>
01161 <span class="comment">* CalcMinZOrder</span>
01162 <span class="comment">*</span>
01163 <span class="comment">*</span>
01164 <span class="comment">* Compute the Z-order of a window to be minimized.</span>
01165 <span class="comment">*</span>
01166 <span class="comment">* The strategy is to find the bottom-most sibling of pwndMinimize that</span>
01167 <span class="comment">* shares the same owner, and insert ourself behind that.  We must also</span>
01168 <span class="comment">* take into account that a TOPMOST window should stay among other TOPMOST,</span>
01169 <span class="comment">* and vice versa.</span>
01170 <span class="comment">*</span>
01171 <span class="comment">* We must make sure never to insert after a bottom-most window.</span>
01172 <span class="comment">*</span>
01173 <span class="comment">* This code works for child windows too, since they don't have owners</span>
01174 <span class="comment">* and never have WEFTOPMOST set.</span>
01175 <span class="comment">*</span>
01176 <span class="comment">* If NULL is returned, the window shouldn't be Z-ordered.</span>
01177 <span class="comment">*</span>
01178 <span class="comment">\***************************************************************************/</span>
01179 
<a name="l01180"></a><a class="code" href="../../d4/d9/minmax_8c.html#a8">01180</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d9/minmax_8c.html#a8">CalcMinZOrder</a>(
01181     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndMinimize)
01182 {
01183     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bTopmost;
01184     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndAfter;
01185     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01186 
01187     bTopmost = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndMinimize, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>);
01188     pwndAfter = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01189 
01190     <span class="keywordflow">for</span> (pwnd = pwndMinimize-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>; pwnd &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>); pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
01191 
01192         <span class="comment">/*</span>
01193 <span class="comment">         * If we've enumerated a window that isn't the same topmost-wise</span>
01194 <span class="comment">         * as pwndMinimize, we've gone as far as we can.</span>
01195 <span class="comment">         */</span>
01196         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>) != bTopmost)
01197             <span class="keywordflow">break</span>;
01198 
01199         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> == pwndMinimize-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>)
01200             pwndAfter = pwnd;
01201     }
01202 
01203     <span class="keywordflow">return</span> pwndAfter;
01204 }
01205 
01206 <span class="comment">/***************************************************************************\</span>
01207 <span class="comment">* xxxActivateOnMinimize</span>
01208 <span class="comment">*</span>
01209 <span class="comment">* Activate the previously active window, provided that window still exists</span>
01210 <span class="comment">* and is a NORMAL window (not bottomost, minimized, disabled, or invisible).</span>
01211 <span class="comment">* If it's not NORMAL, then activate the first non WS_EX_TOPMOST window</span>
01212 <span class="comment">* that's normal. Return TRUE when no activation is needed or the activation</span>
01213 <span class="comment">* has been done in this function. Return FALSE if failed to find a window</span>
01214 <span class="comment">* to activate.</span>
01215 <span class="comment">*</span>
01216 <span class="comment">\***************************************************************************/</span>
01217 
<a name="l01218"></a><a class="code" href="../../d4/d9/minmax_8c.html#a9">01218</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d9/minmax_8c.html#a9">xxxActivateOnMinimize</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01219 {
01220     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01221     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndStart, pwndFirstTool, pwndT;
01222     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fTryTopmost = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01223     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fPrevCheck = (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01224     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
01225 
01226     <span class="comment">/*</span>
01227 <span class="comment">     * We should always have a last-topmost window.</span>
01228 <span class="comment">     */</span>
01229     pwndStart = <a class="code" href="../../d2/d8/swp_8c.html#a35">GetLastTopMostWindow</a>();
01230     <span class="keywordflow">if</span> (pwndStart) {
01231         pwndStart = pwndStart-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01232     } <span class="keywordflow">else</span> {
01233         pwndStart = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01234     }
01235 
01236     UserAssert(<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) == <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>));
01237     UserAssert(<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>) == <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>));
01238 
01239 SearchAgain:
01240 
01241     pwndT = (fPrevCheck ? ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a> : pwndStart);
01242     pwndFirstTool = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01243 
01244     <span class="keywordflow">for</span> ( ; pwndT ; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
01245 
01246 TryThisWindow:
01247 
01248         <span class="comment">/*</span>
01249 <span class="comment">         * Use the first nonminimized, visible, nondisabled, and</span>
01250 <span class="comment">         * nonbottommost window</span>
01251 <span class="comment">         */</span>
01252         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pwndT) &amp;&amp;
01253             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d1/d0/inc_2user_8h.html#a624">WEFNOACTIVATE</a>) &amp;&amp;
01254             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>) == <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) &amp;&amp;
01255             (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a744">GetFullScreen</a>(pwndT) == FULLSCREEN)) {
01256 
01257             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>)) {
01258                 <span class="keywordflow">if</span> (!pwndFirstTool) {
01259                     pwndFirstTool = pwndT;
01260                 }
01261             } <span class="keywordflow">else</span> {
01262                 <span class="keywordflow">break</span>;
01263             }
01264         }
01265 
01266         <span class="keywordflow">if</span> (fPrevCheck) {
01267             fPrevCheck = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01268             pwndT = pwndStart;
01269             <span class="keywordflow">goto</span> TryThisWindow;
01270         }
01271     }
01272 
01273     <span class="keywordflow">if</span> (!pwndT) {
01274 
01275         <span class="keywordflow">if</span> (fTryTopmost) {
01276 
01277             fTryTopmost = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01278             <span class="keywordflow">if</span> (pwndStart != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01279                 pwndStart = pwndStart-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01280             } <span class="keywordflow">else</span> {
01281                 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDesktop = <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>();
01282                 pwndStart = (pwndDesktop != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ? pwndDesktop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01283             }
01284             <span class="keywordflow">goto</span> SearchAgain;
01285         }
01286 
01287         pwndT = pwndFirstTool;
01288     }
01289 
01290     <span class="keywordflow">if</span> (pwndT) {
01291         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndT, &amp;tlpwndT);
01292         <a class="code" href="../../d4/d1/userk_8h.html#a1665">xxxSetForegroundWindow</a>(pwndT, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01293         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
01294     } <span class="keywordflow">else</span> {
01295         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01296     }
01297 
01298     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01299 }
01300 
01301 
01302 
01303 <span class="comment">/***************************************************************************\</span>
01304 <span class="comment">* xxxMinMaximize</span>
01305 <span class="comment">*</span>
01306 <span class="comment">* cmd = SW_MINIMIZE, SW_SHOWMINNOACTIVE, SW_SHOWMINIZED,</span>
01307 <span class="comment">*     SW_SHOWMAXIMIZED, SW_SHOWNOACTIVE, SW_NORMAL</span>
01308 <span class="comment">*</span>
01309 <span class="comment">* If MINMAX_KEEPHIDDEN is set in dwFlags, keep it hidden, otherwise show it.</span>
01310 <span class="comment">*    This is always cleared, except in the case we call it from</span>
01311 <span class="comment">*    createwindow(), where the wnd is iconic, but hidden.  we</span>
01312 <span class="comment">*    need to call this func, to set it up correctly so that when</span>
01313 <span class="comment">*    the app shows the wnd, it is displayed correctly.</span>
01314 <span class="comment">*</span>
01315 <span class="comment">* When changing state, we always add on SWP_STATECHANGE.  This lets</span>
01316 <span class="comment">* SetWindowPos() know to always send WM_WINDOWPOSCHANGING/CHANGED messages</span>
01317 <span class="comment">* even if the new size is the same as the old size.  This is because</span>
01318 <span class="comment">* apps watch the WM_SIZE wParam field to see when they are changing state.</span>
01319 <span class="comment">* If SWP doesn't send WM_WINDOWPOSCHANGED, then they won't get a WM_SIZE</span>
01320 <span class="comment">* message at all.</span>
01321 <span class="comment">*</span>
01322 <span class="comment">* Furthermore, when changing state to/from maximized, if we are really</span>
01323 <span class="comment">* maximizing and are in multiple monitor mode, we want to set the window's</span>
01324 <span class="comment">* region so that it can't draw outside of the monitor.  Otherwise, it</span>
01325 <span class="comment">* will spill over onto another.  The borders are really annoying.</span>
01326 <span class="comment">*</span>
01327 <span class="comment">\***************************************************************************/</span>
01328 
<a name="l01329"></a><a class="code" href="../../d4/d1/userk_8h.html#a1159">01329</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1159">xxxMinMaximize</a>(
01330     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
01331     UINT cmd,
01332     DWORD dwFlags)
01333 {
01334     RECT        rc;
01335     RECT        rcWindow;
01336     RECT        rcRestore;
01337     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fShow = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01338     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fSetFocus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01339     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fShowOwned = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01340     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fSendActivate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01341     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fMaxStateChanging = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01342     <span class="keywordtype">int</span>         idAnimation = 0;
01343     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fFlushPalette = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01344     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        swpFlags = 0;
01345     HWND        hwndAfter = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01346     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndT;
01347     <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">PCHECKPOINT</a> pcp;
01348     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01349     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndParent;
01350     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndT;
01351     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a>       psmwp;
01352     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fIsTrayWindowNow = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01353     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01354     MINMAXINFO  mmi;
01355     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        uEvent = 0;
01356 <span class="preprocessor">#if defined(USE_MIRRORING)</span>
01357 <span class="preprocessor"></span>    <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndParent = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
01358     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    bMirroredParent=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01359 <span class="preprocessor">#endif</span>
01360 <span class="preprocessor"></span>
01361     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01362 
01363     <span class="comment">/*</span>
01364 <span class="comment">     * Get window rect, in parent client coordinates.</span>
01365 <span class="comment">     */</span>
01366     <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a12">GetRect</a>(pwnd, &amp;rcWindow, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a903">GRECT_WINDOW</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a907">GRECT_PARENTCOORDS</a>);
01367 
01368     <span class="comment">/*</span>
01369 <span class="comment">     * If this is NULL, we're out of memory, so punt now.</span>
01370 <span class="comment">     */</span>
01371     pcp = <a class="code" href="../../d4/d1/userk_8h.html#a1240">CkptRestore</a>(pwnd, &amp;rcWindow);
01372     <span class="keywordflow">if</span> (!pcp)
01373         <span class="keywordflow">goto</span> Exit;
01374 
01375 <span class="preprocessor">#if defined(USE_MIRRORING)</span>
01376 <span class="preprocessor"></span>    <span class="comment">/*</span>
01377 <span class="comment">     * If this top-level window is placed in a mirrored desktop,</span>
01378 <span class="comment">     * its coordinates should be mirrored here so that xxxAnimateCaptions</span>
01379 <span class="comment">     * works properly, however we shouldn't change the actual screen coordinates</span>
01380 <span class="comment">     * of the window. This is why I do it after CkptRestore(...). [samera]</span>
01381 <span class="comment">     */</span>
01382     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndParent,WEFLAYOUTRTL) &amp;&amp;
01383             (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>))) {
01384         <span class="keywordtype">int</span> iLeft = rcWindow.left;
01385         rcWindow.left  = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - rcWindow.right;
01386         rcWindow.right = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - iLeft;
01387         bMirroredParent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01388     }
01389 <span class="preprocessor">#endif</span>
01390 <span class="preprocessor"></span>
01391 
01392     <span class="comment">/*</span>
01393 <span class="comment">     * Save the previous restore size.</span>
01394 <span class="comment">     */</span>
01395     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcRestore, &amp;pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o0">rcNormal</a>);
01396 
01397     <span class="comment">/*</span>
01398 <span class="comment">     * First ask the CBT hook if we can do this operation.</span>
01399 <span class="comment">     */</span>
01400     <span class="keywordflow">if</span> (    <a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a518">WHF_CBT</a>) &amp;&amp;
01401             <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HCBT_MINMAX, (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd), (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)cmd, WH_CBT)) {
01402 
01403         <span class="keywordflow">goto</span> Exit;
01404     }
01405 
01406     <span class="comment">/*</span>
01407 <span class="comment">     * If another MDI window is being maximized, and we want to restore this</span>
01408 <span class="comment">     * one to its previous state, we can't change the zorder or the</span>
01409 <span class="comment">     * activation.  We'd screw things up that way.  BTW, this SW_ value is</span>
01410 <span class="comment">     * internal.</span>
01411 <span class="comment">     */</span>
01412     <span class="keywordflow">if</span> (cmd == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a769">SW_MDIRESTORE</a>) {
01413 
01414         swpFlags |= SWP_NOZORDER | SWP_NOACTIVATE;
01415 
01416         cmd = (pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o5">fWasMinimizedBeforeMaximized</a> ?
01417                 SW_SHOWMINIMIZED : SW_SHOWNORMAL);
01418     }
01419 
01420     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01421 
01422     <span class="keywordflow">switch</span> (cmd) {
01423     <span class="keywordflow">case</span> SW_MINIMIZE:        <span class="comment">// Bottom of zorder, make top-level active</span>
01424     <span class="keywordflow">case</span> SW_SHOWMINNOACTIVE: <span class="comment">// Bottom of zorder, don't change activation</span>
01425 
01426         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>)
01427             swpFlags |= SWP_NOACTIVATE;
01428 
01429         <span class="keywordflow">if</span> ((pwndT = <a class="code" href="../../d4/d9/minmax_8c.html#a8">CalcMinZOrder</a>(pwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01430             swpFlags |= SWP_NOZORDER;
01431         } <span class="keywordflow">else</span> {
01432             hwndAfter = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwndT);
01433         }
01434 
01435 
01436         <span class="comment">/*</span>
01437 <span class="comment">         * FALL THRU</span>
01438 <span class="comment">         */</span>
01439 
01440     <span class="keywordflow">case</span> SW_SHOWMINIMIZED:   <span class="comment">// Top of zorder, make active</span>
01441 
01442         <span class="comment">/*</span>
01443 <span class="comment">         * Force a show.</span>
01444 <span class="comment">         */</span>
01445         fShow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01446 
01447         <span class="comment">/*</span>
01448 <span class="comment">         * If already minimized, then don't change the existing</span>
01449 <span class="comment">         * parking spot.</span>
01450 <span class="comment">         */</span>
01451         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
01452 
01453             <span class="comment">/*</span>
01454 <span class="comment">             * If we're already minimized and we're properly visible</span>
01455 <span class="comment">             * or not visible, don't do anything</span>
01456 <span class="comment">             */</span>
01457             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>))
01458                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01459 
01460             swpFlags |= SWP_NOMOVE | SWP_NOSIZE | SWP_NOZORDER | SWP_NOACTIVATE;
01461 
01462             <span class="keywordflow">goto</span> Showit;
01463         }
01464 
01465         <span class="comment">/*</span>
01466 <span class="comment">         * We're becoming minimized although we currently are not.  So</span>
01467 <span class="comment">         * we want to draw the transition animation, and ALWAYS send</span>
01468 <span class="comment">         * sizing messages.</span>
01469 <span class="comment">         */</span>
01470         idAnimation = IDANI_CLOSE;
01471 
01472         <span class="keywordflow">if</span> (!pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o3">fDragged</a>)
01473             pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o6">fMinInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01474 
01475         <span class="keywordflow">if</span> (!pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o6">fMinInitialized</a>)
01476             <a class="code" href="../../d4/d9/minmax_8c.html#a4">ParkIcon</a>(pwnd, pcp);
01477 
01478         rc.left   = pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.x;
01479         rc.top    = pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.y;
01480         rc.right  = pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.x + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINIMIZED);
01481         rc.bottom = pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.y + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINIMIZED);
01482 
01483         <a class="code" href="../../d4/d1/userk_8h.html#a1509">xxxShowOwnedWindows</a>(pwnd, SW_PARENTCLOSING, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01484 
01485         pwndT = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>;
01486 
01487         <span class="keywordflow">while</span> (pwndT) {
01488 
01489             <span class="comment">/*</span>
01490 <span class="comment">             * if we or any child has the focus, punt it away</span>
01491 <span class="comment">             */</span>
01492             <span class="keywordflow">if</span> (pwndT != pwnd) {
01493                 pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
01494                 <span class="keywordflow">continue</span>;
01495             }
01496 
01497             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndT, &amp;tlpwndT);
01498 
01499             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)) {
01500 
01501                 <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwnd-&gt;spwndParent, &amp;tlpwndParent);
01502                 <a class="code" href="../../d4/d1/userk_8h.html#a1662">xxxSetFocus</a>(pwnd-&gt;spwndParent);
01503                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
01504 
01505             } <span class="keywordflow">else</span> {
01506                 <a class="code" href="../../d4/d1/userk_8h.html#a1662">xxxSetFocus</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01507             }
01508 
01509             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
01510             <span class="keywordflow">break</span>;
01511         }
01512 
01513         <span class="comment">/*</span>
01514 <span class="comment">         * Save the maximized state so that we can restore the window maxed</span>
01515 <span class="comment">         */</span>
01516         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>)) {
01517             pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o4">fWasMaximizedBeforeMinimized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01518             fMaxStateChanging = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01519         } <span class="keywordflow">else</span>{
01520             pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o4">fWasMaximizedBeforeMinimized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01521         }
01522 
01523         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>))
01524             fIsTrayWindowNow = <a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwnd);
01525 
01526         <span class="comment">/*</span>
01527 <span class="comment">         * Decrement the visible-windows count only if the</span>
01528 <span class="comment">         * window is visible.  If the window is marked for</span>
01529 <span class="comment">         * destruction, we will not decrement for that as</span>
01530 <span class="comment">         * well. Let SetMinimize take care of this.</span>
01531 <span class="comment">         */</span>
01532         <a class="code" href="../../d4/d1/userk_8h.html#a1631">SetMinimize</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a575">SMIN_SET</a>);
01533         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>);
01534 
01535         uEvent = EVENT_SYSTEM_MINIMIZESTART;
01536 
01537         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>))
01538             fIsTrayWindowNow = (fIsTrayWindowNow != <a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwnd));
01539 
01540         <span class="comment">/*</span>
01541 <span class="comment">         * The children of this window are now no longer visible.</span>
01542 <span class="comment">         * Ensure that they no longer have any update regions...</span>
01543 <span class="comment">         */</span>
01544         <span class="keywordflow">for</span> (pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>; pwndT; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>)
01545             <a class="code" href="../../d4/d1/userk_8h.html#a1627">ClrFTrueVis</a>(pwndT);
01546 
01547         <span class="comment">/*</span>
01548 <span class="comment">         * B#2919</span>
01549 <span class="comment">         * Ensure that the client area gets recomputed, and make</span>
01550 <span class="comment">         * sure that no bits are copied when the size is changed.  And</span>
01551 <span class="comment">         * make sure that WM_SIZE messages get sent, even if our client</span>
01552 <span class="comment">         * size is staying the same.</span>
01553 <span class="comment">         */</span>
01554         swpFlags |= (SWP_DRAWFRAME | SWP_NOCOPYBITS | SWP_STATECHANGE);
01555 
01556         <span class="comment">/*</span>
01557 <span class="comment">         * We are going minimized, so we want to give palette focus to</span>
01558 <span class="comment">         * another app.</span>
01559 <span class="comment">         */</span>
01560         <span class="keywordflow">if</span> (pwnd-&gt;spwndParent == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01561             fFlushPalette = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a572">WFHASPALETTE</a>);
01562         }
01563 
01564         <span class="keywordflow">break</span>;
01565 
01566     <span class="keywordflow">case</span> SW_SHOWNOACTIVATE:
01567         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>)
01568             swpFlags |= SWP_NOACTIVATE;
01569 
01570         <span class="comment">/*</span>
01571 <span class="comment">         * FALL THRU</span>
01572 <span class="comment">         */</span>
01573 
01574     <span class="keywordflow">case</span> SW_RESTORE:
01575 
01576         <span class="comment">/*</span>
01577 <span class="comment">         * If restoring a minimized window that was maximized before</span>
01578 <span class="comment">         * being minimized, go back to being maximized.</span>
01579 <span class="comment">         */</span>
01580         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) &amp;&amp; pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o4">fWasMaximizedBeforeMinimized</a>)
01581             cmd = SW_SHOWMAXIMIZED;
01582         <span class="keywordflow">else</span>
01583             cmd = SW_NORMAL;
01584 
01585         <span class="comment">/*</span>
01586 <span class="comment">         * FALL THRU</span>
01587 <span class="comment">         */</span>
01588 
01589     <span class="keywordflow">case</span> SW_NORMAL:
01590     <span class="keywordflow">case</span> SW_SHOWMAXIMIZED:
01591 
01592         <span class="keywordflow">if</span> (cmd == SW_SHOWMAXIMIZED) {
01593 
01594             <span class="comment">/*</span>
01595 <span class="comment">             * If already maximized and visible, we have nothing to do</span>
01596 <span class="comment">             * Otherwise, for the DOSbox, still set fMaxStateChanging</span>
01597 <span class="comment">             * to TRUE so we recalc the monitor region if need be.</span>
01598 <span class="comment">             * That way WinOldAp can change its "changing from maxed to</span>
01599 <span class="comment">             * maxed with new bigger font" code to work right.</span>
01600 <span class="comment">             */</span>
01601             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>)) {
01602                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
01603                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01604                 }
01605             } <span class="keywordflow">else</span> {
01606                 <span class="comment">/*</span>
01607 <span class="comment">                 * We're changing from normal to maximized, so always</span>
01608 <span class="comment">                 * send WM_SIZE.</span>
01609 <span class="comment">                 */</span>
01610                 swpFlags |= SWP_STATECHANGE;
01611             }
01612             fMaxStateChanging = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01613 
01614             <span class="comment">/*</span>
01615 <span class="comment">             * If calling from CreateWindow, don't let the thing become</span>
01616 <span class="comment">             * activated by the SWP call below.  Acitvation will happen</span>
01617 <span class="comment">             * on the ShowWindow done by CreateWindow or the app.</span>
01618 <span class="comment">             */</span>
01619             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a503">MINMAX_KEEPHIDDEN</a>)
01620                 swpFlags |= SWP_NOACTIVATE;
01621 
01622             <span class="comment">/*</span>
01623 <span class="comment">             * This is for MDI's auto-restore behaviour (craigc)</span>
01624 <span class="comment">             */</span>
01625             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>))
01626                 pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o5">fWasMinimizedBeforeMaximized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01627 
01628             <a class="code" href="../../d4/d1/userk_8h.html#a1161">xxxInitSendValidateMinMaxInfo</a>(pwnd, &amp;mmi);
01629 
01630         } <span class="keywordflow">else</span> {
01631 
01632             <span class="comment">/*</span>
01633 <span class="comment">             * We're changing state from non-normal to normal.  Make</span>
01634 <span class="comment">             * sure WM_SIZE gets sents.</span>
01635 <span class="comment">             */</span>
01636             UserAssert(<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) == <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>));
01637             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>)) {
01638                 swpFlags |= SWP_STATECHANGE;
01639             }
01640             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>)) {
01641                 fMaxStateChanging = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01642             }
01643         }
01644 
01645         <span class="comment">/*</span>
01646 <span class="comment">         * If currently minimized, show windows' popups</span>
01647 <span class="comment">         */</span>
01648         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
01649 
01650             <span class="comment">/*</span>
01651 <span class="comment">             * Send WM_QUERYOPEN to make sure this guy should unminimize</span>
01652 <span class="comment">             */</span>
01653             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_QUERYOPEN, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>))
01654                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01655 
01656             idAnimation = IDANI_OPEN;
01657             fShowOwned  = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01658             fSetFocus   = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01659 
01660             <span class="comment">/*</span>
01661 <span class="comment">             * JEFFBOG B#2868</span>
01662 <span class="comment">             * Condition added before setting fSendActivate prevents</span>
01663 <span class="comment">             * WM_ACTIVATE message from reaching a child window.  Might</span>
01664 <span class="comment">             * be backwards compatibility problems if a pre 3.1 app</span>
01665 <span class="comment">             * relies on WM_ACTIVATE reaching a child.</span>
01666 <span class="comment">             */</span>
01667             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>))
01668                 fSendActivate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01669 
01670             swpFlags |= SWP_NOCOPYBITS;
01671         } <span class="keywordflow">else</span> {
01672             idAnimation = IDANI_CAPTION;
01673         }
01674 
01675         <span class="keywordflow">if</span> (cmd == SW_SHOWMAXIMIZED) {
01676             rc.left     = mmi.ptMaxPosition.x;
01677             rc.top      = mmi.ptMaxPosition.y;
01678             rc.right    = rc.left + mmi.ptMaxSize.x;
01679             rc.bottom   = rc.top + mmi.ptMaxSize.y;
01680 
01681             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>);
01682 
01683         } <span class="keywordflow">else</span> {
01684             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;rcRestore);
01685             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>);
01686         }
01687 
01688         <span class="comment">/*</span>
01689 <span class="comment">         * We do this TestWF again since we left the critical section</span>
01690 <span class="comment">         * above and someone might have already 'un-minimized us'.</span>
01691 <span class="comment">         */</span>
01692         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
01693 
01694             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>))
01695                 fIsTrayWindowNow = <a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwnd);
01696 
01697             <span class="comment">/*</span>
01698 <span class="comment">             * Mark it as minimized and adjust cVisWindows.</span>
01699 <span class="comment">             */</span>
01700             <a class="code" href="../../d4/d1/userk_8h.html#a1631">SetMinimize</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a574">SMIN_CLEAR</a>);
01701 
01702             uEvent = EVENT_SYSTEM_MINIMIZEEND;
01703 
01704             <span class="comment">/*</span>
01705 <span class="comment">             * if we're unminimizing a window that is now</span>
01706 <span class="comment">             * not seen in maximized/restore mode then remove him</span>
01707 <span class="comment">             * from the tray</span>
01708 <span class="comment">             */</span>
01709             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>)             &amp;&amp;
01710                 (fIsTrayWindowNow != <a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwnd)) &amp;&amp;
01711                 <a class="code" href="../../d4/d1/userk_8h.html#a592">FDoTray</a>()) {
01712 
01713                 HWND hw = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
01714 
01715                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a593">FCallHookTray</a>()) {
01716                     <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_WINDOWDESTROYED,
01717                                 (WPARAM)hw,
01718                                 (LPARAM)0,
01719                                 WH_SHELL);
01720                 }
01721 
01722                 <span class="comment">/*</span>
01723 <span class="comment">                 * NT specific code.  Post the window-destroyed message</span>
01724 <span class="comment">                 * to the shell.</span>
01725 <span class="comment">                 */</span>
01726                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a594">FPostTray</a>(pwnd-&gt;head.rpdesk))
01727                     <a class="code" href="../../d4/d1/userk_8h.html#a1867">PostShellHookMessages</a>(HSHELL_WINDOWDESTROYED, (LPARAM)hw);
01728             }
01729 
01730             fIsTrayWindowNow = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01731 
01732             <span class="comment">/*</span>
01733 <span class="comment">             * If we're un-minimizing a visible top-level window, cVisWindows</span>
01734 <span class="comment">             * was zero, and we're either activating a window or showing</span>
01735 <span class="comment">             * the currently active window, set ourselves into the</span>
01736 <span class="comment">             * foreground.  If the window isn't currently visible</span>
01737 <span class="comment">             * then we can rely on SetWindowPos() to do the right</span>
01738 <span class="comment">             * thing for us.</span>
01739 <span class="comment">             */</span>
01740             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)                 &amp;&amp;
01741                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)             &amp;&amp;
01742                 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;cVisWindows == 1)    &amp;&amp;
01743                 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) &amp;&amp;
01744                 (!(swpFlags &amp; SWP_NOACTIVATE)
01745                     || (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq-&gt;spwndActive == pwnd))) {
01746 
01747                 <a class="code" href="../../d4/d1/userk_8h.html#a1225">xxxSetForegroundWindow2</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), <a class="code" href="../../d4/d1/userk_8h.html#a506">SFW_STARTUP</a>);
01748             }
01749         }
01750 
01751         <span class="comment">/*</span>
01752 <span class="comment">         * Ensure that client area gets recomputed, and that</span>
01753 <span class="comment">         * the frame gets redrawn to reflect the new state.</span>
01754 <span class="comment">         */</span>
01755         swpFlags |= SWP_DRAWFRAME;
01756         <span class="keywordflow">break</span>;
01757     }
01758 
01759     <span class="comment">/*</span>
01760 <span class="comment">     * For the iconic case, we need to also show the window because it</span>
01761 <span class="comment">     * might not be visible yet.</span>
01762 <span class="comment">     */</span>
01763 
01764 Showit:
01765 
01766     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a503">MINMAX_KEEPHIDDEN</a>)) {
01767 
01768         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
01769 
01770             <span class="keywordflow">if</span> (fShow)
01771                 swpFlags |= SWP_SHOWWINDOW;
01772 
01773             <span class="comment">/* if we're full screening a DOS BOX then don't draw</span>
01774 <span class="comment">             * the animation 'cause it looks bad.</span>
01775 <span class="comment">             * overloaded WFFULLSCREEN bit for MDI child windows --</span>
01776 <span class="comment">             * use it to indicate to not animate size change.</span>
01777 <span class="comment">             */</span>
01778             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a6">IsVisible</a>(pwnd)            &amp;&amp;
01779                 (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a504">MINMAX_ANIMATE</a>) &amp;&amp;
01780                 idAnimation                &amp;&amp;
01781                 (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a631">WFNOANIMATE</a>))) {
01782 
01783 <span class="preprocessor">#if defined(USE_MIRRORING)</span>
01784 <span class="preprocessor"></span>                <span class="comment">/*</span>
01785 <span class="comment">                 * If this top-level window is placed in a mirrored desktop,</span>
01786 <span class="comment">                 * its coordinates should be mirrored here so that xxxAnimateCaptions</span>
01787 <span class="comment">                 * works properly, however we shouldn't change the actual screen coordinates</span>
01788 <span class="comment">                 * of the window. This is why I do it here and restore it afterwards before</span>
01789 <span class="comment">                 * doing the _DeferWindowPos(...). [samera]</span>
01790 <span class="comment">                 */</span>
01791                  RECT rcT;
01792                  <span class="keywordflow">if</span> (bMirroredParent) {
01793                      <span class="keywordtype">int</span> iLeft = rc.left;
01794                      rcT = rc;
01795                      rc.left  = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - rc.right;
01796                      rc.right = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - iLeft;
01797                  }
01798 <span class="preprocessor">#endif</span>
01799 <span class="preprocessor"></span>
01800                 <span class="keywordflow">if</span> ((idAnimation != IDANI_CAPTION) &amp;&amp; <a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwnd)) {
01801 
01802                     RECT rcMin;
01803 
01804                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(&amp;rcMin);
01805 <span class="preprocessor">#if 0 // Win95 call.</span>
01806 <span class="preprocessor"></span>                    CallHook(HSHELL_GETMINRECT, (WPARAM)HW16(hwnd), (LPARAM)(LPRECT)&amp;rcMin, WH_SHELL);
01807 <span class="preprocessor">#else</span>
01808 <span class="preprocessor"></span>                    <a class="code" href="../../d4/d1/userk_8h.html#a1866">xxxSendMinRectMessages</a>(pwnd, &amp;rcMin);
01809 <span class="preprocessor">#endif</span>
01810 <span class="preprocessor"></span>
01811                     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a4">IsRectEmpty</a>(&amp;rcMin)) {
01812 
01813                         <span class="keywordflow">if</span> (idAnimation == IDANI_CLOSE) {
01814 
01815                             <a class="code" href="../../d4/d1/userk_8h.html#a1043">xxxDrawAnimatedRects</a>(pwnd,
01816                                                   IDANI_CAPTION,
01817                                                   &amp;rcWindow,
01818                                                   &amp;rcMin);
01819 
01820                         } <span class="keywordflow">else</span> {
01821 
01822                             <a class="code" href="../../d4/d1/userk_8h.html#a1043">xxxDrawAnimatedRects</a>(pwnd,
01823                                                   IDANI_CAPTION,
01824                                                   &amp;rcMin,
01825                                                   &amp;rc);
01826                         }
01827                     }
01828 
01829                 } <span class="keywordflow">else</span> {
01830                     <a class="code" href="../../d4/d1/userk_8h.html#a1043">xxxDrawAnimatedRects</a>(pwnd, IDANI_CAPTION, &amp;rcWindow, &amp;rc);
01831                 }
01832 
01833 <span class="preprocessor">#if defined(USE_MIRRORING)</span>
01834 <span class="preprocessor"></span>                    <span class="comment">/*</span>
01835 <span class="comment">                     * Restore the original rect, after doing the animation</span>
01836 <span class="comment">                     */</span>
01837                      <span class="keywordflow">if</span> (bMirroredParent) {
01838                          rc = rcT;
01839                      }
01840 <span class="preprocessor">#endif</span>
01841 <span class="preprocessor"></span>            }
01842 
01843         } <span class="keywordflow">else</span> {
01844             swpFlags |= SWP_SHOWWINDOW;
01845         }
01846     }
01847 
01848     <span class="comment">/*</span>
01849 <span class="comment">     * hack for VB - we add their window in when their minimizing.</span>
01850 <span class="comment">     */</span>
01851     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>) &amp;&amp; fIsTrayWindowNow &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a592">FDoTray</a>()) {
01852 
01853         HWND hw = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
01854 
01855         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a593">FCallHookTray</a>()) {
01856             <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_WINDOWCREATED,
01857                         (WPARAM)hw,
01858                         (LPARAM)0,
01859                         WH_SHELL);
01860         }
01861 
01862         <span class="comment">/*</span>
01863 <span class="comment">         * NT specific code.  Post the window-created message</span>
01864 <span class="comment">         * to the shell.</span>
01865 <span class="comment">         */</span>
01866         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a594">FPostTray</a>(pwnd-&gt;head.rpdesk))
01867             <a class="code" href="../../d4/d1/userk_8h.html#a1867">PostShellHookMessages</a>(HSHELL_WINDOWCREATED, (LPARAM)hw);
01868     }
01869 
01870     <span class="comment">/*</span>
01871 <span class="comment">     * BACKWARD COMPATIBILITY HACK:</span>
01872 <span class="comment">     *</span>
01873 <span class="comment">     * Because SetWindowPos() won't honor sizing, moving and SWP_SHOWWINDOW</span>
01874 <span class="comment">     * at the same time in version 3.0 or below, we call DeferWindowPos()</span>
01875 <span class="comment">     * directly here.</span>
01876 <span class="comment">     */</span>
01877     <span class="keywordflow">if</span> (psmwp = <a class="code" href="../../d4/d1/userk_8h.html#a1616">InternalBeginDeferWindowPos</a>(1)) {
01878 
01879         psmwp = <a class="code" href="../../d4/d1/userk_8h.html#a1619">_DeferWindowPos</a>(psmwp,
01880                                 pwnd,
01881                                 ((hwndAfter != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ? <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwndAfter) : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>),
01882                                 rc.left, rc.top,
01883                                 rc.right - rc.left,
01884                                 rc.bottom - rc.top,
01885                                 swpFlags);
01886 
01887         <span class="keywordflow">if</span> (psmwp) {
01888 
01889             <span class="comment">/*</span>
01890 <span class="comment">             * HACK FOR MULTIPLE MONITOR TRUE MAXIMIZATION CLIPPING</span>
01891 <span class="comment">             *      On a multiple monitor system, we would like the</span>
01892 <span class="comment">             *      borders not to spill over onto another monitor when a</span>
01893 <span class="comment">             *      window 'really' maximizes.  The only way to get this</span>
01894 <span class="comment">             *      to work right is to set a rectangular region, namely</span>
01895 <span class="comment">             *      a copy of the monitor region, on the window.  We can</span>
01896 <span class="comment">             *      only do this if the window isn't currently regional.</span>
01897 <span class="comment">             *</span>
01898 <span class="comment">             *  Going to maximized:     Add the monitor region</span>
01899 <span class="comment">             *  Coming from maximized:  Remove the monitor region</span>
01900 <span class="comment">             */</span>
01901             <span class="keywordflow">if</span> (fMaxStateChanging &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o11">cMonitors</a> &gt; 1) {
01902                 <span class="keywordflow">if</span> (    <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>) &amp;&amp;
01903                         pwnd-&gt;spwndParent == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01904 
01905                     psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[0].<a class="code" href="../../d2/d2/structtagCVR.html#o11">hrgnClip</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a878">HRGN_MONITOR</a>;
01906 
01907                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a596">WFMAXFAKEREGIONAL</a>)) {
01908                     UserAssert(pwnd-&gt;hrgnClip);
01909                     psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[0].<a class="code" href="../../d2/d2/structtagCVR.html#o11">hrgnClip</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
01910                 }
01911             }
01912 
01913             <a class="code" href="../../d4/d1/userk_8h.html#a1620">xxxEndDeferWindowPosEx</a>(psmwp, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01914         }
01915     }
01916 
01917     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>() &amp;&amp; uEvent) {
01918         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(uEvent, pwnd, OBJID_WINDOW, 0, <a class="code" href="../../d4/d1/userk_8h.html#a610">WEF_USEPWNDTHREAD</a>);
01919     }
01920 
01921     <span class="comment">/*</span>
01922 <span class="comment">     * COMPATIBILITY HACK:</span>
01923 <span class="comment">     * Borland's OBEX expects a WM_PAINT message when it starts running</span>
01924 <span class="comment">     * minimized and initializes all it's data during that message.</span>
01925 <span class="comment">     * So, we generate a bogus WM_PAINT message here.</span>
01926 <span class="comment">     * Also, Visionware's XServer can not handle getting a WM_PAINT msg, as it</span>
01927 <span class="comment">     * would always get a WM_PAINTICON msg in 3.1, so make sure the logic is here</span>
01928 <span class="comment">     * to generate the correct message.</span>
01929 <span class="comment">     */</span>
01930     <span class="keywordflow">if</span>((cmd == SW_SHOWMINIMIZED)      &amp;&amp;
01931        (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>)) &amp;&amp;
01932         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)       &amp;&amp;
01933         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a643">WFTOPLEVEL</a>)) {
01934 
01935         <span class="keywordflow">if</span> (pwnd-&gt;pcls-&gt;spicn)
01936             <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, WM_PAINTICON, (WPARAM)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01937         <span class="keywordflow">else</span>
01938             <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, WM_PAINT, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01939     }
01940 
01941     <span class="keywordflow">if</span> (fShowOwned)
01942         <a class="code" href="../../d4/d1/userk_8h.html#a1509">xxxShowOwnedWindows</a>(pwnd, SW_PARENTOPENING, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01943 
01944     <span class="keywordflow">if</span> ((cmd == SW_MINIMIZE) &amp;&amp; (pwnd-&gt;spwndParent == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd))) {
01945         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/minmax_8c.html#a9">xxxActivateOnMinimize</a>(pwnd)) {
01946             <a class="code" href="../../d4/d1/userk_8h.html#a1230">xxxActivateWindow</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a252">AW_SKIP</a>);
01947         }
01948 
01949         {
01950             <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> p;
01951 
01952             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> &amp;&amp; !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>)) {
01953 
01954                 p = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(ptiCurrent-&gt;pEThread);
01955                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;p-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
01956                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/wslist_8c.html#a31">MmAdjustWorkingSetSize</a>((SIZE_T)-1, (SIZE_T)-1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01957                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01958 
01959                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01960                     RIPMSG1(RIP_ERROR, <span class="stringliteral">"Error adjusting working set, status = %x\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01961                 }
01962             }
01963         }
01964 
01965         <span class="comment">/*</span>
01966 <span class="comment">         * If any app is starting, restore its right to foreground activate</span>
01967 <span class="comment">         * (activate and come on top of everything else) because we just</span>
01968 <span class="comment">         * minimized what we were working on.</span>
01969 <span class="comment">         */</span>
01970         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a34">RestoreForegroundActivate</a>();
01971     }
01972 
01973     <span class="comment">/*</span>
01974 <span class="comment">     * If going from iconic, insure the focus is in the window.</span>
01975 <span class="comment">     */</span>
01976     <span class="keywordflow">if</span> (fSetFocus)
01977         <a class="code" href="../../d4/d1/userk_8h.html#a1662">xxxSetFocus</a>(pwnd);
01978 
01979     <span class="comment">/*</span>
01980 <span class="comment">     * This was added for 1.03 compatibility reasons.  If apps watch</span>
01981 <span class="comment">     * WM_ACTIVATE to set their focus, sending this message will appear</span>
01982 <span class="comment">     * as if the window just got activated (like in 1.03).  Before this</span>
01983 <span class="comment">     * was added, opening an iconic window never sent this message since</span>
01984 <span class="comment">     * it was already active (but HIWORD(lParam) != 0).</span>
01985 <span class="comment">     */</span>
01986     <span class="keywordflow">if</span> (fSendActivate)
01987         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_ACTIVATE, WA_ACTIVE, 0);
01988 
01989     <span class="comment">/*</span>
01990 <span class="comment">     * Flush the palette.  We do this on a minimize of a palette app.</span>
01991 <span class="comment">     */</span>
01992     <span class="keywordflow">if</span> (fFlushPalette)
01993         <a class="code" href="../../d4/d1/userk_8h.html#a1105">xxxFlushPalette</a>(pwnd);
01994 
01995 Exit:
01996     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01997 }
01998 
01999 <span class="comment">/***************************************************************************\</span>
02000 <span class="comment">* xxxMinimizeHungWindow</span>
02001 <span class="comment">*</span>
02002 <span class="comment">* 10/31/96      vadimg      created</span>
02003 <span class="comment">\***************************************************************************/</span>
02004 
<a name="l02005"></a><a class="code" href="../../d4/d1/userk_8h.html#a1160">02005</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1160">xxxMinimizeHungWindow</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
02006 {
02007     RECT rcMin;
02008     HRGN hrgnHung;
02009 
02010 
02011     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
02012 
02013     <span class="comment">/*</span>
02014 <span class="comment">     * If the window is already minimized or not visible don't do anything.</span>
02015 <span class="comment">     */</span>
02016    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>))
02017        <span class="keywordflow">return</span>;
02018 
02019     <span class="comment">/*</span>
02020 <span class="comment">     * Animate the caption to the minimized state.</span>
02021 <span class="comment">     */</span>
02022     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a636">PUDF_ANIMATE</a>)) {
02023         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(&amp;rcMin);
02024         <a class="code" href="../../d4/d1/userk_8h.html#a1866">xxxSendMinRectMessages</a>(pwnd, &amp;rcMin);
02025         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a4">IsRectEmpty</a>(&amp;rcMin)) {
02026             <a class="code" href="../../d4/d1/userk_8h.html#a1043">xxxDrawAnimatedRects</a>(pwnd, IDANI_CAPTION, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>, &amp;rcMin);
02027         }
02028     }
02029 
02030     <span class="comment">/*</span>
02031 <span class="comment">     * Reset the visible bit on the window itself and ownees. At the same</span>
02032 <span class="comment">     * time calculate how much needs to be repainted. We must invalidate</span>
02033 <span class="comment">     * the DC cache to make sure that the visible regions get recalculated.</span>
02034 <span class="comment">     */</span>
02035     <a class="code" href="../../d4/d1/userk_8h.html#a1626">SetVisible</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a750">SV_UNSET</a>);
02036     hrgnHung = GreCreateRectRgnIndirect(&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
02037     <a class="code" href="../../d4/d1/userk_8h.html#a1509">xxxShowOwnedWindows</a>(pwnd, SW_PARENTCLOSING, hrgnHung);
02038     <a class="code" href="../../d4/d1/userk_8h.html#a1004">zzzInvalidateDCCache</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a232">IDC_DEFAULT</a>);
02039     <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hrgnHung, RDW_INVALIDATE | RDW_ERASE | RDW_ALLCHILDREN);
02040     GreDeleteObject(hrgnHung);
02041 
02042     <span class="comment">/*</span>
02043 <span class="comment">     * Deal with activating some other window for top-level windows.</span>
02044 <span class="comment">     */</span>
02045     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
02046         <a class="code" href="../../d4/d9/minmax_8c.html#a9">xxxActivateOnMinimize</a>(pwnd);
02047     }
02048     <a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq, <a class="code" href="../../d4/d1/userk_8h.html#a345">QEVENT_HUNGTHREAD</a>, pwnd, 0, 0, 0);
02049 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
