<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dlgmgr.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dlgmgr.c</h1><a href="../../d4/d9/nt6_2dlgmgr_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/***************************************************************************\</span>
00002 <span class="comment">*</span>
00003 <span class="comment">*  DLGMGR.C -</span>
00004 <span class="comment">*</span>
00005 <span class="comment">*      Dialog Box Manager Routines</span>
00006 <span class="comment">*</span>
00007 <span class="comment">* ??-???-???? mikeke    Ported from Win 3.0 sources</span>
00008 <span class="comment">* 12-Feb-1991 mikeke    Added Revalidation code</span>
00009 <span class="comment">* 19-Feb-1991 JimA      Added access checks</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d3/d4/w32_2ntuser_2tools_2usrbench_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a0">00015</a> <span class="preprocessor">#define UNICODE_MINUS_SIGN 0x2212</span>
00016 <span class="preprocessor"></span>
00017 <span class="comment">// FA</span>
00018 LRESULT <a class="code" href="../../d5/d8/resizedlg_8cpp.html#a7">ResizeDlgMessage</a>( LPVOID pObject, 
00019     HWND hwnd,
00020     UINT message,
00021     WPARAM wParam,
00022     LPARAM lParam
00023         );
00024 
00025 
<a name="l00026"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a3">00026</a> <a class="code" href="../../d2/d4/struct__LOOKASIDE.html">LOOKASIDE</a> <a class="code" href="../../d3/d9/dlgmgr_8c.html#a3">DialogLookaside</a>;
00027 
00028 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a6">ValidateCallback</a>(HANDLE h);
00029 
<a name="l00030"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a1">00030</a> <span class="preprocessor">#define IsInForegroundQueue(hwnd) \</span>
00031 <span class="preprocessor">    (NtUserQueryWindow(hwnd, WindowIsForegroundThread) != NULL)</span>
<a name="l00032"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a2">00032</a> <span class="preprocessor"></span><span class="preprocessor">#define IsCurrentThreadForeground() \</span>
00033 <span class="preprocessor">    ((BOOL)NtUserGetThreadState(UserThreadStateIsForeground))</span>
00034 <span class="preprocessor"></span>
00035 <span class="comment">/***************************************************************************\</span>
00036 <span class="comment">*</span>
00037 <span class="comment">* GetParentDialog()</span>
00038 <span class="comment">*</span>
00039 <span class="comment">* Gets top level window, not a control parent.  If not a dialog, then use</span>
00040 <span class="comment">* "highest" control parent guy.</span>
00041 <span class="comment">*</span>
00042 <span class="comment">* BOGUS</span>
00043 <span class="comment">* Need a way to mark a window as a dialog.  If it ever comes into</span>
00044 <span class="comment">* DefDlgProc(), set an internal flag.  Will be used by thunking and</span>
00045 <span class="comment">* CallDlgProc() optimizations also!</span>
00046 <span class="comment">*</span>
00047 <span class="comment">\***************************************************************************/</span>
00048 
<a name="l00049"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a7">00049</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d6/d0/usercli_8h.html#a755">GetParentDialog</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDialog)
00050 {
00051     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndParent;
00052 
00053     pwndParent = pwndDialog;
00054 
00055     <span class="comment">//</span>
00056     <span class="comment">// Walk up the parent chain.  We're looking for the top-most dialog</span>
00057     <span class="comment">// window.  Most cases, the window is a top level one.  But in case of</span>
00058     <span class="comment">// backup app, the window will be a child of some other window.</span>
00059     <span class="comment">//</span>
00060     <span class="keywordflow">for</span> (; pwndDialog; pwndDialog = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwndDialog, spwndParent))
00061     {
00062         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndDialog, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a567">WFDIALOGWINDOW</a>))
00063         {
00064             <span class="comment">//</span>
00065             <span class="comment">// For old guys:  If not DS_RECURSE, then stop here.</span>
00066             <span class="comment">// that way old apps which try to do the nested dialog</span>
00067             <span class="comment">// stuff in their old limited way don't die.</span>
00068             <span class="comment">//</span>
00069             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndDialog, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a627">WEFCONTROLPARENT</a>))
00070                 pwndParent = pwndDialog;
00071             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndDialog, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a700">DFCONTROL</a>))
00072                 <span class="keywordflow">break</span>;
00073         }
00074 
00075         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndDialog, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>))
00076             <span class="keywordflow">break</span>;
00077     }
00078 
00079     <span class="keywordflow">return</span>(pwndParent);
00080 }
00081 
00082 <span class="comment">/***************************************************************************\</span>
00083 <span class="comment">* xxxSaveDlgFocus</span>
00084 <span class="comment">*</span>
00085 <span class="comment">* History:</span>
00086 <span class="comment">* 02-18-92 JimA             Ported from Win31 sources</span>
00087 <span class="comment">\***************************************************************************/</span>
00088 
<a name="l00089"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a8">00089</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a8">xxxSaveDlgFocus</a>(
00090     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00091 {
00092     HWND hwndFocus = <a class="code" href="../../d3/d8/winmgrc_8c.html#a11">GetFocus</a>();
00093 
00094     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00095 
00096     <span class="keywordflow">if</span> (hwndFocus != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d3/d9/client_2wow_8c.html#a18">IsChild</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd), hwndFocus) &amp;&amp;
00097             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;hwndFocusSave == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00098         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;hwndFocusSave = hwndFocus;
00099         <a class="code" href="../../d6/d0/usercli_8h.html#a756">xxxRemoveDefaultButton</a>(pwnd, <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwndFocus));
00100         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00101     }
00102     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00103 }
00104 
00105 <span class="comment">/***************************************************************************\</span>
00106 <span class="comment">* xxxRestoreDlgFocus</span>
00107 <span class="comment">*</span>
00108 <span class="comment">* History:</span>
00109 <span class="comment">* 02-18-92 JimA             Ported from Win31 sources</span>
00110 <span class="comment">\***************************************************************************/</span>
00111 
00112 <span class="comment">// LATER</span>
00113 <span class="comment">// 21-Mar-1992 mikeke</span>
00114 <span class="comment">// does pwndFocusSave need to be unlocked when the dialog is destroyed?</span>
00115 
<a name="l00116"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a9">00116</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a9">xxxRestoreDlgFocus</a>(
00117     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00118 {
00119     HWND hwndFocus;
00120     HWND hwndFocusSave;
00121     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRestored = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00122 
00123     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00124 
00125     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;hwndFocusSave &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00126 
00127         hwndFocus = <a class="code" href="../../d3/d8/winmgrc_8c.html#a11">GetFocus</a>();
00128         hwndFocusSave = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;hwndFocusSave;
00129 
00130         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwndFocusSave)) {
00131             <a class="code" href="../../d6/d0/usercli_8h.html#a757">xxxCheckDefPushButton</a>(pwnd, hwndFocus, hwndFocusSave);
00132             fRestored = (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a225">NtUserSetFocus</a>(hwndFocusSave) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00133 <span class="preprocessor">#ifdef FE_IME</span>
00134 <span class="preprocessor"></span>            <span class="comment">//</span>
00135             <span class="comment">// after calling SetFocus(), we need to re-validate</span>
00136             <span class="comment">// the window. PDLG(pwnd) might be NULL. This can</span>
00137             <span class="comment">// be happened in FE environment where IME window</span>
00138             <span class="comment">// exist. (kkntbug #12613)</span>
00139             <span class="comment">//</span>
00140             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>() &amp;&amp; !<a class="code" href="../../d6/d0/usercli_8h.html#a761">ValidateDialogPwnd</a>(pwnd)) {
00141                 <span class="keywordflow">return</span> fRestored;
00142         }
00143 <span class="preprocessor">#endif</span>
00144 <span class="preprocessor"></span>        }
00145         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;hwndFocusSave = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00146     }
00147 
00148     <span class="keywordflow">return</span> fRestored;
00149 }
00150 
00151 
00152 <span class="comment">/***************************************************************************\</span>
00153 <span class="comment">* DlgSetFocus</span>
00154 <span class="comment">*</span>
00155 <span class="comment">* History:</span>
00156 <span class="comment">\***************************************************************************/</span>
00157 
<a name="l00158"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a10">00158</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a759">DlgSetFocus</a>(
00159     HWND hwnd)
00160 {
00161     <span class="keywordflow">if</span> (((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwnd, WM_GETDLGCODE, 0, 0)) &amp; DLGC_HASSETSEL) {
00162         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwnd, EM_SETSEL, 0, MAXLONG);
00163     }
00164 
00165     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a225">NtUserSetFocus</a>(hwnd);
00166 }
00167 
00168 
<a name="l00169"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a11">00169</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a11">GetDlgCtrlID</a>(
00170     HWND hwnd)
00171 {
00172     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00173 
00174     pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
00175     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00176         <span class="keywordflow">return</span> 0;
00177 
00178     <span class="keywordflow">return</span> PtrToLong(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>);
00179 }
00180 
00181 
00182 
00183 <span class="comment">/***************************************************************************\</span>
00184 <span class="comment">* ValidateDialogPwnd</span>
00185 <span class="comment">*</span>
00186 <span class="comment">* Under Win3, DLGWINDOWEXTRA is 30 bytes. We cannot change that for 16 bit</span>
00187 <span class="comment">* compatibility reasons. Problem is there is no way to tell if a given</span>
00188 <span class="comment">* 16 bit window depends on byte count. If there was, this would be easy.</span>
00189 <span class="comment">* The only way to tell is when a window is about to be used as a dialog</span>
00190 <span class="comment">* window. This window may be of the class DIALOGCLASS, but again it may</span>
00191 <span class="comment">* not!! So we keep dialog window words at 30 bytes, and allocate another</span>
00192 <span class="comment">* structure for the real dialog structure fields. Problem is that this</span>
00193 <span class="comment">* structure has to be created lazily! And that's what we're doing here.</span>
00194 <span class="comment">*</span>
00195 <span class="comment">* 05-21-91 ScottLu      Created.</span>
00196 <span class="comment">\***************************************************************************/</span>
00197 
<a name="l00198"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a12">00198</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a761">ValidateDialogPwnd</a>(
00199     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00200 {
00201     <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> sfInit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00202     <a class="code" href="../../d2/d6/struct__DLG.html">PDLG</a> pdlg;
00203 
00204     <span class="comment">/*</span>
00205 <span class="comment">     * This bit is set if we've already run through this initialization and</span>
00206 <span class="comment">     * have identified this window as a dialog window (able to withstand</span>
00207 <span class="comment">     * peeks into window words at random moments in time).</span>
00208 <span class="comment">     */</span>
00209     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a567">WFDIALOGWINDOW</a>))
00210         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00211 
00212     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o10">cbwndExtra</a> &lt; DLGWINDOWEXTRA) {
00213         RIPERR0(ERROR_WINDOW_NOT_DIALOG, RIP_VERBOSE, <span class="stringliteral">""</span>);
00214         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00215     }
00216 
00217     <span class="comment">/*</span>
00218 <span class="comment">     * See if the pdlg was destroyed and this is a rogue message to be ignored</span>
00219 <span class="comment">     */</span>
00220     <span class="keywordflow">if</span> (pwnd-&gt;fnid &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a228">FNID_STATUS_BITS</a>) {
00221         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00222     }
00223 
00224     <span class="comment">/*</span>
00225 <span class="comment">     * If the lookaside buffer has not been initialized, do it now.</span>
00226 <span class="comment">     */</span>
00227     <span class="keywordflow">if</span> (sfInit) {
00228         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a406">InitLookaside</a>(&amp;<a class="code" href="../../d3/d9/dlgmgr_8c.html#a3">DialogLookaside</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__DLG.html">DLG</a>), 2))) {
00229             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00230         }
00231         sfInit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00232     }
00233 
00234     <span class="keywordflow">if</span> ((pdlg = (<a class="code" href="../../d2/d6/struct__DLG.html">PDLG</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a407">AllocLookasideEntry</a>(&amp;<a class="code" href="../../d3/d9/dlgmgr_8c.html#a3">DialogLookaside</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00235         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00236     }
00237 
00238     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a178">NtUserCallHwndParam</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd), (ULONG_PTR)pdlg, SFI_SETDIALOGPOINTER);
00239 
00240     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00241 }
00242 
00243 
00244 <span class="comment">/***************************************************************************\</span>
00245 <span class="comment">* CvtDec</span>
00246 <span class="comment">*</span>
00247 <span class="comment">* LATER!!! convert to itoa?</span>
00248 <span class="comment">*</span>
00249 <span class="comment">* History:</span>
00250 <span class="comment">\***************************************************************************/</span>
00251 
<a name="l00252"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a13">00252</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a13">CvtDec</a>(
00253     <span class="keywordtype">int</span> u,
00254     LPWSTR *lplpch)
00255 {
00256     <span class="keywordflow">if</span> (u &gt;= 10) {
00257         <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a13">CvtDec</a>(u / 10, lplpch);
00258         u %= 10;
00259     }
00260 
00261     *(*lplpch)++ = (WCHAR)(u + <span class="charliteral">'0'</span>);
00262 }
00263 
00264 
00265 <span class="comment">/***************************************************************************\</span>
00266 <span class="comment">* SetDlgItemInt</span>
00267 <span class="comment">*</span>
00268 <span class="comment">* History:</span>
00269 <span class="comment">\***************************************************************************/</span>
00270 
<a name="l00271"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a14">00271</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a14">SetDlgItemInt</a>(
00272     HWND hwnd,
00273     <span class="keywordtype">int</span> item,
00274     UINT u,
00275     BOOL fSigned)
00276 {
00277     LPWSTR lpch;
00278     WCHAR rgch[16];
00279 
00280     lpch = rgch;
00281     <span class="keywordflow">if</span> (fSigned) {
00282         <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)u &lt; 0) {
00283             *lpch++ = TEXT(<span class="charliteral">'-'</span>);
00284             u = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(-(<span class="keywordtype">int</span>)u);
00285         }
00286     } <span class="keywordflow">else</span> {
00287         <span class="keywordflow">if</span> (u &amp; 0x80000000) {
00288             <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a13">CvtDec</a>(u / 10, (LPWSTR <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)&amp;lpch);
00289             u = u % 10;
00290         }
00291     }
00292 
00293     <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a13">CvtDec</a>(u, (LPWSTR <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)&amp;lpch);
00294     *lpch = 0;
00295 
00296     <span class="keywordflow">return</span> SetDlgItemTextW(hwnd, item, rgch);
00297 }
00298 
00299 
00300 <span class="comment">/***************************************************************************\</span>
00301 <span class="comment">* CheckDlgButton</span>
00302 <span class="comment">*</span>
00303 <span class="comment">* History:</span>
00304 <span class="comment">\***************************************************************************/</span>
00305 
<a name="l00306"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a15">00306</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a15">CheckDlgButton</a>(
00307     HWND hwnd,
00308     <span class="keywordtype">int</span> <span class="keywordtype">id</span>,
00309     UINT cmdCheck)
00310 {
00311     <span class="keywordflow">if</span> ((hwnd = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(hwnd, <span class="keywordtype">id</span>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00312         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00313     }
00314 
00315     <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwnd, BM_SETCHECK, cmdCheck, 0);
00316 
00317     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00318 }
00319 
00320 
00321 <span class="comment">/***************************************************************************\</span>
00322 <span class="comment">* GetDlgItemInt</span>
00323 <span class="comment">*</span>
00324 <span class="comment">* History:</span>
00325 <span class="comment">\***************************************************************************/</span>
00326 
<a name="l00327"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a16">00327</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a16">GetDlgItemInt</a>(
00328     HWND hwnd,
00329     <span class="keywordtype">int</span> item,
00330     BOOL FAR *lpfValOK,
00331     BOOL fSigned)
00332 {
00333     <span class="keywordtype">int</span> i, digit, ch;
00334     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fOk, fNeg;
00335     LPWSTR lpch;
00336     WCHAR rgch[48];
00337     WCHAR rgchDigits[48];
00338 
00339     fOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00340     <span class="keywordflow">if</span> (lpfValOK != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00341         *lpfValOK = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00342 
00343     <span class="keywordflow">if</span> (!GetDlgItemTextW(hwnd, item, rgch, <span class="keyword">sizeof</span>(rgch)/<span class="keyword">sizeof</span>(WCHAR) - 1))
00344         <span class="keywordflow">return</span> 0;
00345 
00346     lpch = rgch;
00347 
00348     <span class="comment">/*</span>
00349 <span class="comment">     * Skip leading white space.</span>
00350 <span class="comment">     */</span>
00351     <span class="keywordflow">while</span> (*lpch == TEXT(<span class="charliteral">' '</span>))
00352         lpch++;
00353 
00354     fNeg = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00355     <span class="keywordflow">while</span> (fSigned &amp;&amp; ((*lpch == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'-'</span>) || (*lpch == <a class="code" href="../../d3/d9/dlgmgr_8c.html#a0">UNICODE_MINUS_SIGN</a>))) {
00356         lpch++;
00357         fNeg ^= <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00358     }
00359 
00360     <span class="comment">/*</span>
00361 <span class="comment">     * Convert all decimal digits to ASCII Unicode digits 0x0030 - 0x0039</span>
00362 <span class="comment">     */</span>
00363     FoldStringW(MAP_FOLDDIGITS, lpch, -1, rgchDigits,
00364             <span class="keyword">sizeof</span>(rgchDigits)/<span class="keyword">sizeof</span>(rgchDigits[0]));
00365     lpch = rgchDigits;
00366 
00367     i = 0;
00368     <span class="keywordflow">while</span> (ch = *lpch++) {
00369         digit = ch - TEXT(<span class="charliteral">'0'</span>);
00370         <span class="keywordflow">if</span> (digit &lt; 0 || digit &gt; 9) {
00371             <span class="keywordflow">break</span>;
00372         }
00373         <span class="keywordflow">if</span> (fSigned) {
00374             <span class="keywordflow">if</span> (i &gt; (INT_MAX - digit) / 10) {
00375                 <span class="keywordflow">return</span>(0);
00376             }
00377         } <span class="keywordflow">else</span> {
00378             <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)i &gt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((UINT_MAX - digit) / 10)) {
00379                 <span class="keywordflow">return</span>(0);
00380             }
00381         }
00382 
00383         fOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00384         i = ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)i * 10) + digit;
00385     }
00386 
00387     <span class="keywordflow">if</span> (fNeg)
00388         i = -i;
00389 
00390     <span class="keywordflow">if</span> (lpfValOK != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00391         *lpfValOK = ((ch == 0) &amp;&amp; fOk);
00392 
00393     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)i;
00394 }
00395 
00396 <span class="comment">/***************************************************************************\</span>
00397 <span class="comment">* CheckRadioButton</span>
00398 <span class="comment">*</span>
00399 <span class="comment">* History:</span>
00400 <span class="comment">\***************************************************************************/</span>
00401 
<a name="l00402"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a17">00402</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a17">CheckRadioButton</a>(
00403     HWND hwnd,
00404     <span class="keywordtype">int</span> idFirst,
00405     <span class="keywordtype">int</span> idLast,
00406     <span class="keywordtype">int</span> <span class="keywordtype">id</span>)
00407 {
00408     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, pwndDialog;
00409     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fCheckOn;
00410 
00411     pwndDialog = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
00412     <span class="keywordflow">if</span> (pwndDialog == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00413         <span class="keywordflow">return</span> 0;
00414 
00415     <span class="keywordflow">for</span> (pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a26">REBASE</a>(pwndDialog, spwndChild); pwnd; pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a26">REBASE</a>(pwnd, spwndNext)) {
00416 
00417         <span class="keywordflow">if</span> ((PtrToLong(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>) &gt;= idFirst) &amp;&amp;
00418             (PtrToLong(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>) &lt;= idLast)) {
00419 
00420             fCheckOn = (PtrToLong(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>) == <span class="keywordtype">id</span>);
00421             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwnd), BM_SETCHECK, fCheckOn, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00422         }
00423     }
00424 
00425     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00426 }
00427 
00428 
00429 <span class="comment">/***************************************************************************\</span>
00430 <span class="comment">* IsDlgButtonChecked</span>
00431 <span class="comment">*</span>
00432 <span class="comment">* History:</span>
00433 <span class="comment">\***************************************************************************/</span>
00434 
<a name="l00435"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a18">00435</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a18">IsDlgButtonChecked</a>(
00436     HWND hwnd,
00437     <span class="keywordtype">int</span> <span class="keywordtype">id</span>)
00438 {
00439     <span class="keywordflow">if</span> ((hwnd = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(hwnd, <span class="keywordtype">id</span>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00440         <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwnd, BM_GETCHECK, 0, 0);
00441     }
00442 
00443     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00444 }
00445 
00446 
00447 <span class="comment">/***************************************************************************\</span>
00448 <span class="comment">* DefDlgProc</span>
00449 <span class="comment">*</span>
00450 <span class="comment">* History:</span>
00451 <span class="comment">\***************************************************************************/</span>
00452 
<a name="l00453"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a19">00453</a> LRESULT <a class="code" href="../../d6/d0/usercli_8h.html#a618">DefDlgProcWorker</a>(
00454     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00455     UINT message,
00456     WPARAM wParam,
00457     LPARAM lParam,
00458     DWORD fAnsi)
00459 {
00460     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00461     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT1, tlpwndT2, tlpwndT3, tlpwndTop;
00462     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00463     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT1, pwndT2, pwndT3, pwndTop;
00464     HWND hwndT1;
00465     LRESULT result;
00466     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSetBit;
00467     DLGPROC pfn;
00468 
00469     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00470 
00471     <span class="comment">/*</span>
00472 <span class="comment">     * use the Win 3.1 documented size</span>
00473 <span class="comment">     */</span>
00474     <a class="code" href="../../d6/d0/usercli_8h.html#a28">VALIDATECLASSANDSIZE</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a203">FNID_DIALOG</a>);
00475 
00476     <span class="comment">/*</span>
00477 <span class="comment">     * Must do special validation here to make sure pwnd is a dialog window.</span>
00478 <span class="comment">     */</span>
00479     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a761">ValidateDialogPwnd</a>(pwnd))
00480         <span class="keywordflow">return</span> 0;
00481 
00482     <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d5/struct__DIALOG.html">PDIALOG</a>)pwnd)-&gt;resultWP != 0)
00483         <a class="code" href="../../d0/d0/ntuser_8h.html#a3">NtUserSetWindowLongPtr</a>(hwnd, DWLP_MSGRESULT, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00484     result = 0;   <span class="comment">// no dialog proc</span>
00485 
00486     <span class="keywordflow">if</span> (message == WM_FINALDESTROY) {
00487         <span class="keywordflow">goto</span> DoCleanup;
00488     }
00489 
00490     <span class="keywordflow">if</span> ((pfn = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;lpfnDlg) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00491         <span class="keywordflow">if</span> (IsWOWProc(pfn)) {
00492             result = (*pfnWowDlgProcEx)(hwnd, message, wParam, lParam, (ULONG_PTR)pfn, &amp;(pwnd-&gt;state));
00493         } <span class="keywordflow">else</span> {
00494             result = (pfn)(hwnd, message, wParam, lParam);
00495         }
00496 
00497         <span class="comment">/*</span>
00498 <span class="comment">         * Get out if the window was destroyed in the dialog proc.</span>
00499 <span class="comment">         */</span>
00500         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwnd)==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pwnd-&gt;fnid &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a228">FNID_STATUS_BITS</a>))
00501             <span class="keywordflow">return</span> result;
00502     }
00503 
00504     <span class="comment">/*</span>
00505 <span class="comment">     * SPECIAL CASED ... and DOCUMENTED that way !!!</span>
00506 <span class="comment">     * These 6, and ONLY these 6, should be hacked in this fashion.</span>
00507 <span class="comment">     * Anybody who needs the REAL return value to a message should</span>
00508 <span class="comment">     * use SetDlgMsgResult in WINDOWSX.H</span>
00509 <span class="comment">     */</span>
00510 
00511     <span class="keywordflow">switch</span> (message)
00512     {
00513         <span class="keywordflow">case</span> WM_INITDIALOG:
00514                         <span class="comment">//</span>
00515                         <span class="comment">// FA</span>
00516                         <span class="comment">//</span>
00517                         <span class="keywordflow">if</span>( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;pDlgResize != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
00518                                 <a class="code" href="../../d5/d8/resizedlg_8cpp.html#a7">ResizeDlgMessage</a>( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;pDlgResize, hwnd, message, wParam, lParam );
00519                         <span class="comment">// fall through</span>
00520         <span class="keywordflow">case</span> WM_COMPAREITEM:
00521         <span class="keywordflow">case</span> WM_VKEYTOITEM:
00522         <span class="keywordflow">case</span> WM_CHARTOITEM:
00523         <span class="keywordflow">case</span> WM_QUERYDRAGICON:
00524             <span class="keywordflow">return</span> ((LRESULT)(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)result);
00525 
00526         <span class="keywordflow">case</span> WM_CTLCOLOR:
00527         <span class="keywordflow">case</span> WM_CTLCOLORMSGBOX:
00528         <span class="keywordflow">case</span> WM_CTLCOLOREDIT:
00529         <span class="keywordflow">case</span> WM_CTLCOLORLISTBOX:
00530         <span class="keywordflow">case</span> WM_CTLCOLORBTN:
00531         <span class="keywordflow">case</span> WM_CTLCOLORDLG:
00532         <span class="keywordflow">case</span> WM_CTLCOLORSCROLLBAR:
00533         <span class="keywordflow">case</span> WM_CTLCOLORSTATIC:
00534             <span class="comment">// QuarkXPress doesn't like finding the WM_CTLCOLOR result in</span>
00535             <span class="comment">// resultWP -- we should never be setting resultWP -- that's meant</span>
00536             <span class="comment">// as a pass-thru return value -- so let's go back to doing it the</span>
00537             <span class="comment">// old way -- Win95B B#21269 -- 03/13/95 -- tracysh (cr: jeffbog)</span>
00538             <span class="keywordflow">if</span> (result)
00539                 <span class="keywordflow">return</span> ((LRESULT)(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)result);
00540             <span class="keywordflow">break</span>;
00541     }
00542 
00543     <span class="keywordflow">if</span> (!result) {
00544 
00545         <span class="comment">/*</span>
00546 <span class="comment">         * Save the result value in case our private memory is freed</span>
00547 <span class="comment">         * before we return</span>
00548 <span class="comment">         */</span>
00549 <span class="comment">//        result = PDLG(pwnd)-&gt;resultWP;</span>
00550 
00551         <span class="keywordflow">switch</span> (message) {
00552         <span class="keywordflow">case</span> WM_CTLCOLOR:
00553         <span class="keywordflow">case</span> WM_CTLCOLORMSGBOX:
00554         <span class="keywordflow">case</span> WM_CTLCOLOREDIT:
00555         <span class="keywordflow">case</span> WM_CTLCOLORLISTBOX:
00556         <span class="keywordflow">case</span> WM_CTLCOLORBTN:
00557         <span class="keywordflow">case</span> WM_CTLCOLORDLG:
00558         <span class="keywordflow">case</span> WM_CTLCOLORSCROLLBAR:
00559         <span class="keywordflow">case</span> WM_CTLCOLORSTATIC:
00560         {
00561             <span class="comment">//</span>
00562             <span class="comment">// HACK OF DEATH:</span>
00563             <span class="comment">// To get 3D colors for non 4.0 apps who use 3DLOOK,</span>
00564             <span class="comment">// we temporarily add on the 4.0 compat bit, pass this</span>
00565             <span class="comment">// down to DWP, and clear it.</span>
00566             <span class="comment">//</span>
00567             <span class="comment">// Use "result" var for bool saying we have to add/clear 4.0</span>
00568             <span class="comment">// compat bit.</span>
00569 
00570             fSetBit = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a696">DF3DLOOK</a>)!= 0) &amp;&amp;
00571                      (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>) == 0);
00572 
00573             <span class="keywordflow">if</span> (fSetBit)
00574                 <a class="code" href="../../d4/d1/userk_8h.html#a1628">SetWindowState</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>);
00575 
00576             result = <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message,
00577                     wParam, lParam, fAnsi);
00578 
00579             <span class="keywordflow">if</span> (fSetBit)
00580                 <a class="code" href="../../d4/d1/userk_8h.html#a1629">ClearWindowState</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>);
00581             <span class="keywordflow">return</span>((LRESULT)(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) result);
00582         }
00583 
00584         <span class="keywordflow">case</span> WM_ERASEBKGND:
00585             <a class="code" href="../../d6/d0/usercli_8h.html#a234">FillWindow</a>(hwnd, hwnd, (HDC)wParam, (HBRUSH)CTLCOLOR_DLG);
00586 
00587                         <span class="comment">//</span>
00588                         <span class="comment">// FA</span>
00589                         <span class="keywordflow">if</span>( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;pDlgResize != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
00590                                 <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/resizedlg_8cpp.html#a7">ResizeDlgMessage</a>( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;pDlgResize, hwnd, message, wParam, lParam );
00591             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00592 
00593         <span class="keywordflow">case</span> WM_SHOWWINDOW:
00594 
00595             <span class="comment">/*</span>
00596 <span class="comment">             * If hiding the window, save the focus.  If showing the window</span>
00597 <span class="comment">             * by means of a SW_* command and the fEnd bit is set, do not</span>
00598 <span class="comment">             * pass to DWP so it won't get shown.</span>
00599 <span class="comment">             */</span>
00600             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a755">GetParentDialog</a>(pwnd) == pwnd) {
00601                 <span class="keywordflow">if</span> (!wParam) {
00602                     <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a8">xxxSaveDlgFocus</a>(pwnd);
00603                 } <span class="keywordflow">else</span> {
00604 
00605                     <span class="keywordflow">if</span> (LOWORD(lParam) != 0 &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;fEnd)
00606                         <span class="keywordflow">break</span>;
00607 
00608                     <span class="comment">/*</span>
00609 <span class="comment">                     * Snap the cursor to the center of the default button.</span>
00610 <span class="comment">                     * Only do this if the current thread is in the foreground.</span>
00611 <span class="comment">                     * The _ShowCursor() code is added to work around a</span>
00612 <span class="comment">                     * problem with hardware cursors.  If change is done</span>
00613 <span class="comment">                     * in the same refresh cycle, the display of the cursor</span>
00614 <span class="comment">                     * would not reflect the new position.</span>
00615 <span class="comment">                     */</span>
00616                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a368">TEST_PUSIF</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a365">PUSIF_SNAPTO</a>) &amp;&amp;
00617                             <a class="code" href="../../d3/d9/dlgmgr_8c.html#a1">IsInForegroundQueue</a>(hwnd)) {
00618                         hwndT1 = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;result);
00619                         <span class="keywordflow">if</span> (hwndT1) {
00620                             RECT rc;
00621 
00622                             <a class="code" href="../../d6/d0/usercli_8h.html#a231">NtUserShowCursor</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00623 
00624                             <a class="code" href="../../d3/d9/client_2wow_8c.html#a26">GetWindowRect</a>(hwndT1, &amp;rc);
00625                             <a class="code" href="../../d6/d0/usercli_8h.html#a227">NtUserSetCursorPos</a>(rc.left + ((rc.right - rc.left)/2),
00626                                          rc.top + ((rc.bottom - rc.top)/2));
00627 
00628                             <a class="code" href="../../d6/d0/usercli_8h.html#a231">NtUserShowCursor</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00629                         }
00630                     }
00631                 }
00632             }
00633             <span class="keywordflow">goto</span> CallDWP;
00634 
00635         <span class="keywordflow">case</span> WM_SYSCOMMAND:
00636             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a755">GetParentDialog</a>(pwnd) == pwnd) {
00637                 <span class="comment">/*</span>
00638 <span class="comment">                 * If hiding the window, save the focus.  If showing the window</span>
00639 <span class="comment">                 * by means of a SW_* command and the fEnd bit is set, do not</span>
00640 <span class="comment">                 * pass to DWP so it won't get shown.</span>
00641 <span class="comment">                 */</span>
00642                 <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)wParam == SC_MINIMIZE)
00643                     <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a8">xxxSaveDlgFocus</a>(pwnd);
00644             }
00645             <span class="keywordflow">goto</span> CallDWP;
00646 
00647         <span class="keywordflow">case</span> WM_ACTIVATE:
00648             pwndT1 = <a class="code" href="../../d6/d0/usercli_8h.html#a755">GetParentDialog</a>(pwnd);
00649             <span class="keywordflow">if</span> ( pwndT1 != pwnd) {
00650 
00651                 <span class="comment">/*</span>
00652 <span class="comment">                 * This random bit is used during key processing - bit</span>
00653 <span class="comment">                 * 08000000 of WM_CHAR messages is set if a dialog is currently</span>
00654 <span class="comment">                 * active.</span>
00655 <span class="comment">                 */</span>
00656                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a286">NtUserSetThreadState</a>(wParam ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a867">QF_DIALOGACTIVE</a> : 0, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a867">QF_DIALOGACTIVE</a>);
00657             }
00658             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndT1, &amp;tlpwndT1);
00659             <span class="keywordflow">if</span> (wParam != 0)
00660                 <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a9">xxxRestoreDlgFocus</a>(pwndT1);
00661             <span class="keywordflow">else</span>
00662                 <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a8">xxxSaveDlgFocus</a>(pwndT1);
00663 
00664             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT1);
00665             <span class="keywordflow">break</span>;
00666 
00667         <span class="keywordflow">case</span> WM_SETFOCUS:
00668             pwndT1 = <a class="code" href="../../d6/d0/usercli_8h.html#a755">GetParentDialog</a>(pwnd);
00669             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwndT1)-&gt;fEnd &amp;&amp; !<a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a9">xxxRestoreDlgFocus</a>(pwndT1)) {
00670 
00671                 pwndT = <a class="code" href="../../d6/d0/usercli_8h.html#a642">_GetNextDlgTabItem</a>(pwndT1, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00672                 <a class="code" href="../../d6/d0/usercli_8h.html#a759">DlgSetFocus</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT));
00673             }
00674             <span class="keywordflow">break</span>;
00675 
00676         <span class="keywordflow">case</span> WM_CLOSE:
00677             <span class="comment">/*</span>
00678 <span class="comment">             * Make sure cancel button is not disabled before sending the</span>
00679 <span class="comment">             * IDCANCEL.  Note that we need to do this as a message instead</span>
00680 <span class="comment">             * of directly calling the dlg proc so that any dialog box</span>
00681 <span class="comment">             * filters get this.</span>
00682 <span class="comment">             */</span>
00683             pwndT1 = <a class="code" href="../../d3/d9/client_2wow_8c.html#a5">_GetDlgItem</a>(pwnd, IDCANCEL);
00684             <span class="keywordflow">if</span> (pwndT1 &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT1, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>))
00685                 <a class="code" href="../../d6/d0/usercli_8h.html#a219">NtUserMessageBeep</a>(0);
00686             <span class="keywordflow">else</span>
00687                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(hwnd, WM_COMMAND, MAKELONG(IDCANCEL, BN_CLICKED),
00688                         (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT1));
00689             <span class="keywordflow">break</span>;
00690 
00691         <span class="keywordflow">case</span> WM_NCDESTROY:
00692         <span class="keywordflow">case</span> WM_FINALDESTROY:
00693 DoCleanup:
00694             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a286">NtUserSetThreadState</a>(0, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a867">QF_DIALOGACTIVE</a>);
00695             <span class="keywordflow">if</span> (!(pwnd-&gt;style &amp; DS_LOCALEDIT)) {
00696                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;hData) {
00697                     <a class="code" href="../../d6/d0/usercli_8h.html#a764">ReleaseEditDS</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;hData);
00698                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;hData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00699                 }
00700             }
00701 
00702             <span class="comment">/*</span>
00703 <span class="comment">             * Delete the user defined font if any</span>
00704 <span class="comment">             */</span>
00705             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;hUserFont) {
00706                 DeleteObject(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;hUserFont);
00707                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;hUserFont = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00708             }
00709 
00710             <span class="comment">/*</span>
00711 <span class="comment">             * Free the dialog memory and mark this as a non-dialog window</span>
00712 <span class="comment">             */</span>
00713             <a class="code" href="../../d6/d0/usercli_8h.html#a408">FreeLookasideEntry</a>(&amp;<a class="code" href="../../d3/d9/dlgmgr_8c.html#a3">DialogLookaside</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd));
00714             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a178">NtUserCallHwndParam</a>(hwnd, 0, SFI_SETDIALOGPOINTER);
00715             <span class="keywordflow">break</span>;
00716 
00717         <span class="keywordflow">case</span> DM_REPOSITION:
00718             {
00719                 RECT        rc;
00720                 <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor;
00721 
00722                 <span class="comment">// DAT recorder APP sends it's own private message 0x402</span>
00723                 <span class="comment">// through and we mistake it to be DM_REPOSITION. To avoid</span>
00724                 <span class="comment">// this confusion, we do the following check.</span>
00725                 <span class="comment">// Fix for Bug#25747 -- 9/29/94 --</span>
00726                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a627">WEFCONTROLPARENT</a>) ||
00727                     (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a> &amp;&amp;
00728                      <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndParent)) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>)) {
00729 
00730                     <span class="keywordflow">goto</span> CallDWP;
00731                 }
00732 
00733                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
00734                 pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(&amp;rc, MONITOR_DEFAULTTOPRIMARY);
00735                 <a class="code" href="../../d6/d0/usercli_8h.html#a760">RepositionRect</a>(pMonitor, &amp;rc, pwnd-&gt;style, pwnd-&gt;ExStyle);
00736                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a115">NtUserSetWindowPos</a>(hwnd, HWND_TOP, rc.left, rc.top,
00737                              rc.right-rc.left, rc.bottom-rc.top,
00738                              SWP_NOZORDER | SWP_NOSIZE | SWP_NOACTIVATE);
00739             }
00740             <span class="keywordflow">break</span>;
00741 
00742         <span class="keywordflow">case</span> DM_SETDEFID:
00743             pwndT1 = <a class="code" href="../../d6/d0/usercli_8h.html#a755">GetParentDialog</a>(pwnd);
00744             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndT1, &amp;tlpwndT1);
00745 
00746             <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwndT1)-&gt;fEnd)) {
00747 
00748                 pwndT2 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00749                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwndT1)-&gt;result != 0)
00750                     pwndT2 = <a class="code" href="../../d6/d0/usercli_8h.html#a752">_FindDlgItem</a>(pwndT1, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwndT1)-&gt;result);
00751 
00752                 pwndT3 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00753                 <span class="keywordflow">if</span> (wParam != 0) {
00754                     pwndT3 = <a class="code" href="../../d3/d9/client_2wow_8c.html#a5">_GetDlgItem</a>(pwnd, wParam);
00755                 }
00756 
00757                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndT2, &amp;tlpwndT2);
00758                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndT3, &amp;tlpwndT3);
00759 
00760                 <a class="code" href="../../d6/d0/usercli_8h.html#a757">xxxCheckDefPushButton</a>(pwndT1, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT2), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT3));
00761 
00762                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT3);
00763                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT2);
00764 
00765                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwndT1)-&gt;result = wParam;
00766 <span class="comment">//                if (PDLG(pwnd)-&gt;spwndFocusSave) {</span>
00767 <span class="comment">//                    Lock(&amp;(PDLG(pwnd)-&gt;spwndFocusSave), pwndT2);</span>
00768 <span class="comment">//                }</span>
00769 
00770                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00771                     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a12">NotifyWinEvent</a>(EVENT_OBJECT_DEFACTIONCHANGE, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT1), OBJID_CLIENT, INDEXID_CONTAINER);
00772                 }
00773             }
00774             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT1);
00775             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00776 
00777         <span class="keywordflow">case</span> DM_GETDEFID:
00778             pwndT1 = <a class="code" href="../../d6/d0/usercli_8h.html#a755">GetParentDialog</a>(pwnd);
00779 
00780             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwndT1)-&gt;fEnd &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwndT1)-&gt;result)
00781                 <span class="keywordflow">return</span>(MAKELONG(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwndT1)-&gt;result, DC_HASDEFID));
00782             <span class="keywordflow">else</span>
00783                 <span class="keywordflow">return</span> 0;
00784             <span class="keywordflow">break</span>;
00785 
00786         <span class="comment">/*</span>
00787 <span class="comment">         * This message was added so that user defined controls that want</span>
00788 <span class="comment">         * tab keys can pass the tab off to the next/previous control in the</span>
00789 <span class="comment">         * dialog box.  Without this, all they could do was set the focus</span>
00790 <span class="comment">         * which didn't do the default button stuff.</span>
00791 <span class="comment">         */</span>
00792         <span class="keywordflow">case</span> WM_NEXTDLGCTL:
00793             pwndTop = <a class="code" href="../../d6/d0/usercli_8h.html#a755">GetParentDialog</a>(pwnd);
00794             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndTop, &amp;tlpwndTop);
00795 
00796             hwndT1 = <a class="code" href="../../d3/d8/winmgrc_8c.html#a11">GetFocus</a>();
00797             pwndT2 = <a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(hwndT1);
00798             <span class="keywordflow">if</span> (LOWORD(lParam)) {
00799                 <span class="keywordflow">if</span> (pwndT2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00800                     pwndT2 = pwndTop;
00801 
00802                 <span class="comment">/*</span>
00803 <span class="comment">                 * wParam contains the pwnd of the ctl to set focus to.</span>
00804 <span class="comment">                 */</span>
00805                 <span class="keywordflow">if</span> ((pwndT1 = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>((HWND)wParam)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00806                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndTop);
00807                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00808                 }
00809             } <span class="keywordflow">else</span> {
00810                 <span class="keywordflow">if</span> (pwndT2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00811 
00812                     <span class="comment">/*</span>
00813 <span class="comment">                     * Set focus to the first tab item.</span>
00814 <span class="comment">                     */</span>
00815                     pwndT1 = <a class="code" href="../../d6/d0/usercli_8h.html#a642">_GetNextDlgTabItem</a>(pwndTop, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00816                     pwndT2 = pwndTop;
00817                 } <span class="keywordflow">else</span> {
00818 
00819                     <span class="comment">/*</span>
00820 <span class="comment">                     * If window with focus not a dlg ctl, ignore message.</span>
00821 <span class="comment">                     */</span>
00822                     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a16">_IsChild</a>(pwndTop, pwndT2)) {
00823                         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndTop);
00824                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00825                     }
00826                     <span class="comment">/*</span>
00827 <span class="comment">                     * wParam = TRUE for previous, FALSE for next</span>
00828 <span class="comment">                     */</span>
00829                     pwndT1 = <a class="code" href="../../d6/d0/usercli_8h.html#a642">_GetNextDlgTabItem</a>(pwndTop, pwndT2, wParam);
00830 
00831                     <span class="comment">/*</span>
00832 <span class="comment">                     * If there is no next item, ignore the message.</span>
00833 <span class="comment">                     */</span>
00834                     <span class="keywordflow">if</span> (pwndT1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00835                         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndTop);
00836                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00837                     }
00838                 }
00839             }
00840 
00841             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndT1, &amp;tlpwndT1);
00842             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndT2, &amp;tlpwndT2);
00843 
00844             <a class="code" href="../../d6/d0/usercli_8h.html#a759">DlgSetFocus</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT1));
00845             <a class="code" href="../../d6/d0/usercli_8h.html#a757">xxxCheckDefPushButton</a>(pwndTop, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT2), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT1));
00846 
00847             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT2);
00848             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT1);
00849             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndTop);
00850 
00851             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00852 
00853         <span class="keywordflow">case</span> WM_ENTERMENULOOP:
00854 
00855             <span class="comment">/*</span>
00856 <span class="comment">             * We need to pop up the combo box window if the user brings</span>
00857 <span class="comment">             * down a menu.</span>
00858 <span class="comment">             *</span>
00859 <span class="comment">             * ...  FALL THROUGH...</span>
00860 <span class="comment">             */</span>
00861 
00862         <span class="keywordflow">case</span> WM_LBUTTONDOWN:
00863         <span class="keywordflow">case</span> WM_NCLBUTTONDOWN:
00864             hwndT1 = <a class="code" href="../../d3/d8/winmgrc_8c.html#a11">GetFocus</a>();
00865             <span class="keywordflow">if</span> (hwndT1 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00866                 pwndT1 = <a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(hwndT1);
00867 
00868                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwndT1) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a201">FNID_COMBOBOX</a>) {
00869 
00870                     <span class="comment">/*</span>
00871 <span class="comment">                     * If user clicks anywhere in dialog box and a combo box (or</span>
00872 <span class="comment">                     * the editcontrol of a combo box) has the focus, then hide</span>
00873 <span class="comment">                     * it's listbox.</span>
00874 <span class="comment">                     */</span>
00875                     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndT1, &amp;tlpwndT1);
00876                     <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndT1), CB_SHOWDROPDOWN, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0);
00877                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT1);
00878 
00879                 } <span class="keywordflow">else</span> {
00880                     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent;
00881 
00882                     <span class="comment">/*</span>
00883 <span class="comment">                     * It's a subclassed combo box.  See if the listbox and edit</span>
00884 <span class="comment">                     * boxes exist (this is a very cheezy evaluation - what if</span>
00885 <span class="comment">                     * these controls are subclassed too? NOTE: Not checking</span>
00886 <span class="comment">                     * for EditWndProc: it's a client proc address.</span>
00887 <span class="comment">                     */</span>
00888                     pwndParent = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwndT1, spwndParent);
00889                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwndParent) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a201">FNID_COMBOBOX</a>) {
00890                         pwndT1 = pwndParent;
00891                         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndT1, &amp;tlpwndT1);
00892                         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndT1), CB_SHOWDROPDOWN, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0);
00893                         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT1);
00894                     }
00895                 }
00896             }
00897 
00898             <span class="comment">/*</span>
00899 <span class="comment">             * Always send the message off to DefWndProc</span>
00900 <span class="comment">             */</span>
00901             <span class="keywordflow">goto</span> CallDWP;
00902 
00903         <span class="keywordflow">case</span> WM_GETFONT:
00904             <span class="keywordflow">return</span> (LRESULT)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;hUserFont;
00905 
00906         <span class="keywordflow">case</span> WM_VKEYTOITEM:
00907         <span class="keywordflow">case</span> WM_COMPAREITEM:
00908         <span class="keywordflow">case</span> WM_CHARTOITEM:
00909         <span class="keywordflow">case</span> WM_INITDIALOG:
00910 
00911             <span class="comment">/*</span>
00912 <span class="comment">             * We need to return the 0 the app may have returned for these</span>
00913 <span class="comment">             * items instead of calling defwindow proc.</span>
00914 <span class="comment">             */</span>
00915             <span class="keywordflow">return</span> result;
00916 
00917                         <span class="comment">// FA</span>
00918                         <span class="comment">//</span>
00919                 <span class="keywordflow">case</span> WM_NCHITTEST:
00920                                 <span class="keywordflow">if</span>( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;pDlgResize != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
00921                                 {
00922                                         LRESULT lres=<a class="code" href="../../d5/d8/resizedlg_8cpp.html#a7">ResizeDlgMessage</a>( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;pDlgResize, hwnd, message, wParam, lParam );
00923                                         <span class="keywordflow">if</span>( lres ) <span class="comment">// &amp;&amp; (((PDIALOG)pwnd)-&gt;resultWP != 0) )</span>
00924                                                 <span class="keywordflow">return</span> ((<a class="code" href="../../d4/d5/struct__DIALOG.html">PDIALOG</a>)pwnd)-&gt;resultWP;
00925                                         <span class="keywordflow">goto</span> CallDWP;
00926                                 }
00927                                 
00928                 <span class="keywordflow">case</span> WM_SIZE:
00929                 <span class="keywordflow">case</span> WM_WINDOWPOSCHANGING:
00930                         <span class="keywordflow">if</span>( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;pDlgResize != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
00931                                 <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/resizedlg_8cpp.html#a7">ResizeDlgMessage</a>( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;pDlgResize, hwnd, message, wParam, lParam );
00932                         <span class="keywordflow">goto</span> CallDWP;
00933                 <span class="keywordflow">break</span>;
00934                 <span class="comment">//</span>
00935                 <span class="comment">// FA</span>
00936 
00937         <span class="keywordflow">case</span> WM_NOTIFYFORMAT:
00938             <span class="keywordflow">if</span> (lParam == NF_QUERY)
00939                 <span class="keywordflow">return</span>((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a794">DLGF_ANSI</a> ) ? NFR_ANSI : NFR_UNICODE);
00940             <span class="keywordflow">return</span> result;
00941 
00942         <span class="keywordflow">default</span>:
00943 CallDWP:
00944             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, fAnsi);
00945         }
00946     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((message == WM_SHOWWINDOW) &amp;&amp; result) {
00947 
00948         <span class="comment">/*</span>
00949 <span class="comment">         * For a visible-case we want to snap the cursor regardless of</span>
00950 <span class="comment">         * what was returned from the dialog-handler on the client.  If</span>
00951 <span class="comment">         * we're going visible, snap the cursor to the dialog-button.</span>
00952 <span class="comment">         */</span>
00953         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a755">GetParentDialog</a>(pwnd) == pwnd) {
00954 
00955             <span class="keywordflow">if</span> (wParam &amp;&amp; ((LOWORD(lParam) == 0) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;fEnd)) {
00956 
00957                 <span class="comment">/*</span>
00958 <span class="comment">                 * Snap the cursor to the center of the default button.</span>
00959 <span class="comment">                 * Only do this if the current thread is in the foreground.</span>
00960 <span class="comment">                 * The _ShowCursor() code is added to work around a</span>
00961 <span class="comment">                 * problem with hardware cursors.  If change is done</span>
00962 <span class="comment">                 * in the same refresh cycle, the display of the cursor</span>
00963 <span class="comment">                 * would not reflect the new position.</span>
00964 <span class="comment">                 */</span>
00965                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a368">TEST_PUSIF</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a365">PUSIF_SNAPTO</a>) &amp;&amp;
00966                         <a class="code" href="../../d3/d9/dlgmgr_8c.html#a1">IsInForegroundQueue</a>(hwnd)) {
00967                     hwndT1 = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;result);
00968                     <span class="keywordflow">if</span> (hwndT1) {
00969                         RECT rc;
00970 
00971                         <a class="code" href="../../d6/d0/usercli_8h.html#a231">NtUserShowCursor</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00972 
00973                         <a class="code" href="../../d3/d9/client_2wow_8c.html#a26">GetWindowRect</a>(hwndT1, &amp;rc);
00974                         <a class="code" href="../../d6/d0/usercli_8h.html#a227">NtUserSetCursorPos</a>(rc.left + ((rc.right - rc.left)/2),
00975                                      rc.top + ((rc.bottom - rc.top)/2));
00976 
00977                         <a class="code" href="../../d6/d0/usercli_8h.html#a231">NtUserShowCursor</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00978                     }
00979                 }
00980             }
00981         }
00982     }
00983 
00984 
00985     <span class="comment">/*</span>
00986 <span class="comment">     * If this is still marked as a dialog window then return the real</span>
00987 <span class="comment">     * result. Otherwise, we've already processed the WM_NCDESTROY message</span>
00988 <span class="comment">     * and freed our private memory so return the stored value.</span>
00989 <span class="comment">     */</span>
00990     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a567">WFDIALOGWINDOW</a>))
00991         <span class="keywordflow">return</span> ((<a class="code" href="../../d4/d5/struct__DIALOG.html">PDIALOG</a>)pwnd)-&gt;resultWP;
00992     <span class="keywordflow">else</span>
00993         <span class="keywordflow">return</span> result;
00994 }
00995 
00996 
00997 <span class="comment">/***************************************************************************\</span>
00998 <span class="comment">* DefDlgProc</span>
00999 <span class="comment">*</span>
01000 <span class="comment">* Translates the message, calls DefDlgProc on server side.  DefDlgProc</span>
01001 <span class="comment">* is the default WindowProc for dialogs (NOT the dialog's dialog proc)</span>
01002 <span class="comment">*</span>
01003 <span class="comment">* 04-11-91 ScottLu Created.</span>
01004 <span class="comment">\***************************************************************************/</span>
01005 
<a name="l01006"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a20">01006</a> LRESULT WINAPI <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a20">DefDlgProcW</a>(
01007     HWND hwnd,
01008     UINT message,
01009     WPARAM wParam,
01010     LPARAM lParam)
01011 {
01012     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01013 
01014     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01015         <span class="keywordflow">return</span> (0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01016     }
01017 
01018     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a618">DefDlgProcWorker</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01019 }
01020 
<a name="l01021"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a21">01021</a> LRESULT WINAPI <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a21">DefDlgProcA</a>(
01022     HWND hwnd,
01023     UINT message,
01024     WPARAM wParam,
01025     LPARAM lParam)
01026 {
01027     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01028 
01029     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01030         <span class="keywordflow">return</span> (0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01031     }
01032 
01033     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a618">DefDlgProcWorker</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01034 }
01035 
01036 
01037 <span class="comment">/***************************************************************************\</span>
01038 <span class="comment">* DialogBox2</span>
01039 <span class="comment">*</span>
01040 <span class="comment">* History:</span>
01041 <span class="comment">\***************************************************************************/</span>
01042 
<a name="l01043"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a22">01043</a> <span class="keywordtype">int</span> PASCAL <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a22">DialogBox2</a>(
01044     HWND hwnd,
01045     HWND hwndOwner,
01046     BOOL fDisabled,
01047     BOOL fOwnerIsActiveWindow)
01048 {
01049     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
01050     <span class="keywordtype">int</span> result;
01051     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fShown;
01052     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fWantIdleMsgs;
01053     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSentIdleMessage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01054     HWND hwndCapture;
01055     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01056 
01057     <span class="keywordflow">if</span> (hwnd) {
01058         pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
01059     } <span class="keywordflow">else</span> {
01060         pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01061     }
01062 
01063     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01064 
01065     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01066         <span class="keywordflow">if</span> ((hwndOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !fDisabled &amp;&amp; <a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwndOwner)) {
01067             <a class="code" href="../../d6/d0/usercli_8h.html#a216">NtUserEnableWindow</a>(hwndOwner, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01068             <span class="keywordflow">if</span> (fOwnerIsActiveWindow) {
01069 
01070                 <span class="comment">/*</span>
01071 <span class="comment">                 * The dialog box failed but we disabled the owner in</span>
01072 <span class="comment">                 * xxxDialogBoxIndirectParam and if it had the focus, the</span>
01073 <span class="comment">                 * focus was set to NULL.  Now, when we enable the window, it</span>
01074 <span class="comment">                 * doesn't get the focus back if it had it previously so we</span>
01075 <span class="comment">                 * need to correct this.</span>
01076 <span class="comment">                 */</span>
01077                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a225">NtUserSetFocus</a>(hwndOwner);
01078             }
01079         }
01080         <span class="keywordflow">return</span> -1;
01081     }
01082 
01083     hwndCapture = <a class="code" href="../../d3/d8/winmgrc_8c.html#a12">GetCapture</a>();
01084     <span class="keywordflow">if</span> (hwndCapture != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01085         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndCapture, WM_CANCELMODE, 0, 0);
01086     }
01087 
01088     <span class="comment">/*</span>
01089 <span class="comment">     * Set the 'parent disabled' flag for EndDialog().</span>
01090 <span class="comment">     * convert BOOL to definite bit 0 or 1</span>
01091 <span class="comment">     */</span>
01092     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;fDisabled = !!fDisabled;
01093 
01094     fShown = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>);
01095 
01096     <span class="comment">/*</span>
01097 <span class="comment">     * Should the WM_ENTERIDLE messages be sent?</span>
01098 <span class="comment">     */</span>
01099     fWantIdleMsgs = !(pwnd-&gt;style &amp; DS_NOIDLEMSG);
01100 
01101     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(SLOWMACHINE) &amp; 1) &amp;&amp; !fShown &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;fEnd)
01102         <span class="keywordflow">goto</span> ShowIt;
01103 
01104     <span class="keywordflow">while</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd) &amp;&amp; (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;fEnd)) {
01105         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d9/cltxt_8h.html#a14">PeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, PM_REMOVE)) {
01106 ShowIt:
01107             <span class="keywordflow">if</span> (!fShown) {
01108                 fShown = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01109 
01110 <span class="preprocessor">#ifdef SYSMODALWINDOWS</span>
01111 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (pwnd == gspwndSysModal) {
01112                     <span class="comment">/*</span>
01113 <span class="comment">                     * Make this a topmost window</span>
01114 <span class="comment">                     */</span>
01115                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a115">NtUserSetWindowPos</a>(hwnd, HWND_TOPMOST, 0, 0, 0, 0,
01116                                SWP_NOSIZE | SWP_NOMOVE |
01117                                SWP_NOREDRAW | SWP_NOACTIVATE);
01118                 }
01119 <span class="preprocessor">#endif</span>
01120 <span class="preprocessor"></span>
01121                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a237">NtUserShowWindow</a>(hwnd, SHOW_OPENWINDOW);
01122                 <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>(hwnd);
01123 
01124                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
01125                     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a12">NotifyWinEvent</a>(EVENT_SYSTEM_DIALOGSTART, hwnd, OBJID_WINDOW, INDEXID_CONTAINER);
01126                 }
01127             } <span class="keywordflow">else</span> {
01128                 <span class="comment">/*</span>
01129 <span class="comment">                 * Make sure window still exists</span>
01130 <span class="comment">                 */</span>
01131                 <span class="keywordflow">if</span> (hwndOwner &amp;&amp; !<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwndOwner))
01132                     hwndOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01133 
01134                 <span class="keywordflow">if</span> (hwndOwner &amp;&amp; fWantIdleMsgs &amp;&amp; !fSentIdleMessage) {
01135                     fSentIdleMessage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01136 
01137                     <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndOwner, WM_ENTERIDLE, MSGF_DIALOGBOX, (LPARAM)hwnd);
01138                 } <span class="keywordflow">else</span> {
01139                     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwnd)==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pwnd-&gt;fnid &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a228">FNID_STATUS_BITS</a>))
01140                         <span class="keywordflow">break</span>;
01141 
01142                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a262">NtUserWaitMessage</a>();
01143                 }
01144             }
01145 
01146         } <span class="keywordflow">else</span> {
01147             <span class="comment">/*</span>
01148 <span class="comment">             * We got a real message.  Reset fSentIdleMessage so that we send</span>
01149 <span class="comment">             * one next time things are calm.</span>
01150 <span class="comment">             */</span>
01151             fSentIdleMessage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01152 
01153             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_QUIT) {
01154                 <a class="code" href="../../d3/d8/client_8c.html#a122">PostQuitMessage</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam);
01155                 <span class="keywordflow">break</span>;
01156             }
01157 
01158             <span class="comment">/*</span>
01159 <span class="comment">             * If pwnd is a message box, allow Ctrl-C and Ctrl-Ins</span>
01160 <span class="comment">             * to copy its content to the clipboard.</span>
01161 <span class="comment">             * Fall through in case hooking apps look for these keys.</span>
01162 <span class="comment">             */</span>
01163             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a556">WFMSGBOX</a>)) {
01164                 <span class="keywordflow">if</span> ( (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_CHAR &amp;&amp; <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam) == 3) ||
01165                      (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_KEYDOWN &amp;&amp; <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam) == VK_INSERT &amp;&amp; <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_CONTROL) &lt; 0)) {
01166                         <span class="comment">/*</span>
01167 <span class="comment">                         * Send the WM_COPY message and let the original message fall through</span>
01168 <span class="comment">                         * as some apps might want it</span>
01169 <span class="comment">                         */</span>
01170                         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwnd, WM_COPY, 0, 0);
01171                 }
01172             }
01173 
01174             <span class="comment">/*</span>
01175 <span class="comment">             * Moved the msg filter hook call to IsDialogMessage to allow</span>
01176 <span class="comment">             * messages to be hooked for both modal and modeless dialog</span>
01177 <span class="comment">             * boxes.</span>
01178 <span class="comment">             */</span>
01179             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d0/user32_8def.html#a39">IsDialogMessage</a>(hwnd, &amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>)) {
01180                 <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a21">TranslateMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
01181                 <a class="code" href="../../d5/d9/cltxt_8h.html#a24">DispatchMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
01182             }
01183 
01184             <span class="comment">/*</span>
01185 <span class="comment">             * If we get a timer message, go ahead and show the window.</span>
01186 <span class="comment">             * We may continuously get timer msgs if there are zillions of</span>
01187 <span class="comment">             * apps running.</span>
01188 <span class="comment">             *</span>
01189 <span class="comment">             * If we get a syskeydown message, show the dialog box because</span>
01190 <span class="comment">             * the user may be bringing down a menu and we want the dialog</span>
01191 <span class="comment">             * box to become visible.</span>
01192 <span class="comment">             */</span>
01193             <span class="keywordflow">if</span> (!fShown &amp;&amp; (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_TIMER ||
01194                     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == <a class="code" href="../../d1/d1/bench_8c.html#a4">WM_SYSTIMER</a> || <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_SYSKEYDOWN))
01195                 <span class="keywordflow">goto</span> ShowIt;
01196         }
01197 
01198 <span class="preprocessor">#if DBG</span>
01199 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwnd)) {
01200             <span class="comment">/*</span>
01201 <span class="comment">             * Bogus case - we've already been destroyed somehow (by app,</span>
01202 <span class="comment">             * GP, etc.)</span>
01203 <span class="comment">             */</span>
01204             RIPMSG0(RIP_WARNING,
01205                <span class="stringliteral">"Dialog should be dismissed with EndDialog, not DestroyWindow"</span>);
01206         }
01207 <span class="preprocessor">#endif</span>
01208 <span class="preprocessor"></span>    }
01209 
01210     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
01211         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a12">NotifyWinEvent</a>(EVENT_SYSTEM_DIALOGEND, hwnd, OBJID_WINDOW, INDEXID_CONTAINER);
01212     }
01213 
01214     <span class="comment">/*</span>
01215 <span class="comment">     * Make sure the window still exists</span>
01216 <span class="comment">     */</span>
01217     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwnd)) {
01218         <span class="keywordflow">return</span> 0;
01219     }
01220 
01221     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd))
01222         result = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;result;
01223     <span class="keywordflow">else</span>
01224         result = 0;
01225 
01226     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a159">NtUserDestroyWindow</a>(hwnd);
01227 
01228     <span class="comment">/*</span>
01229 <span class="comment">     * If the owner window belongs to another thread, the reactivation</span>
01230 <span class="comment">     * of the owner may have failed within DestroyWindow().  Therefore,</span>
01231 <span class="comment">     * if the current thread is in the foreground and the owner is not</span>
01232 <span class="comment">     * in the foreground we can safely set the foreground back</span>
01233 <span class="comment">     * to the owner.</span>
01234 <span class="comment">     */</span>
01235     <span class="keywordflow">if</span> (hwndOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01236         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/dlgmgr_8c.html#a2">IsCurrentThreadForeground</a>() &amp;&amp;
01237             !<a class="code" href="../../d3/d9/dlgmgr_8c.html#a1">IsInForegroundQueue</a>(hwndOwner)) {
01238             <a class="code" href="../../d6/d0/usercli_8h.html#a228">NtUserSetForegroundWindow</a>(hwndOwner);
01239         }
01240     }
01241 
01242     <span class="keywordflow">return</span> result;
01243 }
01244 
01245 
01246 <span class="comment">/***************************************************************************\</span>
01247 <span class="comment">* InternalDialogBox</span>
01248 <span class="comment">*</span>
01249 <span class="comment">* Server portion of DialogBoxIndirectParam.</span>
01250 <span class="comment">*</span>
01251 <span class="comment">* 04-05-91 ScottLu      Created.</span>
01252 <span class="comment">\***************************************************************************/</span>
01253 
<a name="l01254"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a4">01254</a> <span class="keyword">extern</span> HCURSOR <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a4">hCurCursor</a>;
01255 
<a name="l01256"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a23">01256</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d0/usercli_8h.html#a751">InternalDialogBox</a>(
01257     HANDLE hModule,
01258     LPDLGTEMPLATE lpdt,
01259     HWND hwndOwner,
01260     DLGPROC pfnDialog,
01261     LPARAM lParam,
01262     UINT fSCDLGFlags)
01263 {
01264     <span class="keywordtype">int</span> i;
01265     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDisabled;
01266     HWND hwnd;
01267     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOwner;
01268     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fOwnerIsActiveWindow = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01269     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndOwner;
01270     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fUnlockOwner;
01271 
01272     UserAssert(!(fSCDLGFlags &amp; ~(SCDLG_CLIENT|SCDLG_ANSI|SCDLG_16BIT)));    <span class="comment">// These are the only valid flags</span>
01273 
01274     <span class="comment">/*</span>
01275 <span class="comment">     * If hwndOwner == HWNDESKTOP, change it to NULL.  This way the desktop</span>
01276 <span class="comment">     * (and all its children) won't be disabled if the dialog is modal.</span>
01277 <span class="comment">     */</span>
01278     <span class="keywordflow">if</span> (hwndOwner &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a15">SAMEWOWHANDLE</a>(hwndOwner, <a class="code" href="../../d3/d9/client_2wow_8c.html#a4">GetDesktopWindow</a>()))
01279         hwndOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01280 
01281     <span class="comment">/*</span>
01282 <span class="comment">     * We return 0 if the ValidateHwnd fails in order to match Win 3.1</span>
01283 <span class="comment">     * validation layer which always returns 0 for invalid hwnds even</span>
01284 <span class="comment">     * if the function is spec'ed to return -1.  Autocad setup bug #3615</span>
01285 <span class="comment">     */</span>
01286     <span class="keywordflow">if</span> (hwndOwner) {
01287         <span class="keywordflow">if</span> ((pwndOwner = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwndOwner)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01288             <span class="keywordflow">return</span> (0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01289         }
01290     } <span class="keywordflow">else</span> {
01291         pwndOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01292     }
01293 
01294     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndOwner);
01295 
01296     fUnlockOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01297     <span class="keywordflow">if</span> (pwndOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01298 
01299         <span class="comment">/* The following fixes an AV in Corel Photo-Paint 6.0.  It passes a</span>
01300 <span class="comment">         * 16-bit HWND in, and croaks at some point when it gets 16-bit hwnds</span>
01301 <span class="comment">         * back in send messages. FritzS -- fixing bug 12531</span>
01302 <span class="comment">         */</span>
01303         hwndOwner = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwndOwner);
01304 
01305         <span class="comment">/*</span>
01306 <span class="comment">         * Make sure the owner is a top level window.</span>
01307 <span class="comment">         */</span>
01308         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwndOwner)) {
01309             pwndOwner = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pwndOwner);
01310             hwndOwner = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndOwner);
01311             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndOwner, &amp;tlpwndOwner);
01312             fUnlockOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01313         }
01314 
01315         <span class="comment">/*</span>
01316 <span class="comment">         * Remember if window was originally disabled (so we can set</span>
01317 <span class="comment">         * the correct state when the dialog goes away.</span>
01318 <span class="comment">         */</span>
01319         fDisabled = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOwner, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>);
01320         fOwnerIsActiveWindow = (<a class="code" href="../../d6/d0/usercli_8h.html#a15">SAMEWOWHANDLE</a>(hwndOwner, <a class="code" href="../../d3/d8/winmgrc_8c.html#a22">GetActiveWindow</a>()));
01321 
01322         <span class="comment">/*</span>
01323 <span class="comment">         * Disable the window.</span>
01324 <span class="comment">         */</span>
01325         <a class="code" href="../../d6/d0/usercli_8h.html#a216">NtUserEnableWindow</a>(hwndOwner, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01326     }
01327 
01328     <span class="comment">/*</span>
01329 <span class="comment">     * Don't show cursors on a mouseless system. Put up an hour glass while</span>
01330 <span class="comment">     * the dialog comes up.</span>
01331 <span class="comment">     */</span>
01332     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(MOUSEPRESENT)) {
01333         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a224">NtUserSetCursor</a>(LoadCursor(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, IDC_WAIT));
01334     }
01335 
01336     <span class="comment">/*</span>
01337 <span class="comment">     * Creates the dialog.  Frees the menu if this routine fails.</span>
01338 <span class="comment">     */</span>
01339     hwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a750">InternalCreateDialog</a>(hModule, lpdt, 0, hwndOwner,
01340             pfnDialog, lParam, fSCDLGFlags);
01341 
01342     <span class="keywordflow">if</span> (hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01343 
01344         <span class="comment">/*</span>
01345 <span class="comment">         * The dialog creation failed.  Re-enable the window, destroy the</span>
01346 <span class="comment">         * menu, ie., fail gracefully.</span>
01347 <span class="comment">         */</span>
01348         <span class="keywordflow">if</span> (!fDisabled &amp;&amp; hwndOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01349             <a class="code" href="../../d6/d0/usercli_8h.html#a216">NtUserEnableWindow</a>(hwndOwner, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01350 
01351         <span class="keywordflow">if</span> (fUnlockOwner)
01352             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndOwner);
01353         <span class="keywordflow">return</span> -1;
01354     }
01355 
01356     i = <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a22">DialogBox2</a>(hwnd, hwndOwner, fDisabled, fOwnerIsActiveWindow);
01357 
01358     <span class="keywordflow">if</span> (fUnlockOwner)
01359         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndOwner);
01360     <span class="keywordflow">return</span> i;
01361 }
01362 
01363 <span class="comment">/***************************************************************************\</span>
01364 <span class="comment">**</span>
01365 <span class="comment">**  RepositionRect()</span>
01366 <span class="comment">**</span>
01367 <span class="comment">**  Used to ensure that toplevel dialogs are still visible within the</span>
01368 <span class="comment">**  desktop area after they've resized.</span>
01369 <span class="comment">**</span>
01370 <span class="comment">\***************************************************************************/</span>
01371 
01372 <span class="keywordtype">void</span>
<a name="l01373"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a24">01373</a> <a class="code" href="../../d6/d0/usercli_8h.html#a760">RepositionRect</a>(
01374         <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor,
01375         LPRECT      lprc,
01376         DWORD       dwStyle,
01377         DWORD       dwExStyle)
01378 {
01379     LPRECT      lprcClip;
01380     <span class="keywordtype">int</span>         y;
01381 
01382     UserAssert(lprc);
01383     UserAssert(pMonitor);
01384 
01385     <span class="keywordflow">if</span> (dwStyle &amp; WS_CHILD) {
01386         <span class="keywordflow">if</span> (dwExStyle &amp; WS_EX_CONTROLPARENT)
01387             <span class="keywordflow">return</span>;
01388 
01389         <span class="comment">/*</span>
01390 <span class="comment">         * Old style 3.1 child dialogs--do this nonsense anyway.  Keeps</span>
01391 <span class="comment">         * FedEx happy.</span>
01392 <span class="comment">         */</span>
01393         pMonitor = <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
01394         lprcClip = &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>;
01395     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwExStyle &amp; WS_EX_TOOLWINDOW) {
01396         lprcClip = &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>;
01397     } <span class="keywordflow">else</span> {
01398         lprcClip = &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>;
01399     }
01400 
01401     UserAssert(lprc);
01402 
01403     y = lprcClip-&gt;bottom - (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE) * 2 + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYKANJIWINDOW));
01404 
01405     <span class="keywordflow">if</span> (lprc-&gt;bottom &gt; y) {
01406         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(lprc, 0, y - lprc-&gt;bottom);
01407     }
01408 
01409     <span class="keywordflow">if</span> (lprc-&gt;top &lt; lprcClip-&gt;top) {
01410         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(lprc, 0, lprcClip-&gt;top - lprc-&gt;top);
01411     }
01412 
01413     <span class="keywordflow">if</span> (lprc-&gt;right &gt; lprcClip-&gt;right) {
01414         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(lprc, lprcClip-&gt;right - lprc-&gt;right, 0);
01415     }
01416 
01417     <span class="keywordflow">if</span> (lprc-&gt;left &lt; lprcClip-&gt;left) {
01418         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(lprc, lprcClip-&gt;left - lprc-&gt;left, 0);
01419     }
01420 }
01421 
01422 <span class="comment">/***************************************************************************\</span>
01423 <span class="comment">* MapDialogRect</span>
01424 <span class="comment">*</span>
01425 <span class="comment">* History:</span>
01426 <span class="comment">\***************************************************************************/</span>
01427 
<a name="l01428"></a><a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a25">01428</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d9/nt6_2dlgmgr_8c.html#a25">MapDialogRect</a>(
01429     HWND hwnd,
01430     LPRECT lprc)
01431 {
01432     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01433 
01434     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01435         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01436     }
01437 
01438     <span class="comment">/*</span>
01439 <span class="comment">     * Must do special validation here to make sure pwnd is a dialog window.</span>
01440 <span class="comment">     */</span>
01441     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a761">ValidateDialogPwnd</a>(pwnd))
01442         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01443 
01444     lprc-&gt;left = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a852">XPixFromXDU</a>(lprc-&gt;left, <a class="code" href="../../d2/d6/struct__DLG.html">PDLG</a>(pwnd)-&gt;cxChar);
01445     lprc-&gt;right = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a852">XPixFromXDU</a>(lprc-&gt;right, <a class="code" href="../../d2/d6/struct__DLG.html">PDLG</a>(pwnd)-&gt;cxChar);
01446     lprc-&gt;top = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a853">YPixFromYDU</a>(lprc-&gt;top, <a class="code" href="../../d2/d6/struct__DLG.html">PDLG</a>(pwnd)-&gt;cyChar);
01447     lprc-&gt;bottom = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a853">YPixFromYDU</a>(lprc-&gt;bottom, <a class="code" href="../../d2/d6/struct__DLG.html">PDLG</a>(pwnd)-&gt;cyChar);
01448 
01449     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01450 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:45 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
