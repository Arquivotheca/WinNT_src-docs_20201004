<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: smbtrsup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>smbtrsup.c</h1><a href="../../d4/d9/smbtrsup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    smbtrsup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the code to implement the kernel mode SmbTrace</span>
00012 <span class="comment">    component within the LanMan server and redirector.</span>
00013 <span class="comment">    The interface between the kernel mode component and the</span>
00014 <span class="comment">    server/redirector is found in nt\private\inc\smbtrsup.h</span>
00015 <span class="comment">    The interface providing user-level access to SmbTrace is found in</span>
00016 <span class="comment">    nt\private\inc\smbtrace.h</span>
00017 <span class="comment"></span>
00018 <span class="comment">Author:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Peter Gray (w-peterg)   23-March-1992</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">    Stephan Mueller (t-stephm)   21-July-1992</span>
00025 <span class="comment"></span>
00026 <span class="comment">        Completed, fixed bugs, moved all associated declarations here</span>
00027 <span class="comment">        from various places in the server, ported to the redirector</span>
00028 <span class="comment">        and converted to a kernel DLL.</span>
00029 <span class="comment"></span>
00030 <span class="comment">--*/</span>
00031 
00032 <span class="preprocessor">#include &lt;ntsrv.h&gt;</span>
00033 <span class="preprocessor">#include &lt;smbtrace.h&gt;</span>     <span class="comment">// for names and structs shared with user-mode app</span>
00034 
<a name="l00035"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a0">00035</a> <span class="preprocessor">#define _SMBTRSUP_SYS_ 1  // to get correct definitions for exported variables</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#include &lt;smbtrsup.h&gt;</span>     <span class="comment">// for functions exported to server/redirector</span>
00037 
00038 <span class="preprocessor">#if DBG</span>
00039 <span class="preprocessor"></span>ULONG SmbtrsupDebug = 0;
00040 <span class="preprocessor">#define TrPrint(x) if (SmbtrsupDebug) KdPrint(x)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00042"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define TrPrint(x)</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00044 <span class="preprocessor"></span>
00045 <span class="comment">//</span>
00046 <span class="comment">// we assume all well-known names are #defined in Unicode, and require</span>
00047 <span class="comment">// them to be so: in the SmbTrace application and the smbtrsup.sys package</span>
00048 <span class="comment">//</span>
00049 <span class="preprocessor">#ifndef UNICODE</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#error "UNICODE build required"</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00052 <span class="preprocessor"></span>
00053 
00054 <span class="preprocessor">#if DBG</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#define PAGED_DBG 1</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#ifdef PAGED_DBG</span>
00058 <span class="preprocessor"></span><span class="preprocessor">#undef PAGED_CODE</span>
00059 <span class="preprocessor"></span><span class="preprocessor">#define PAGED_CODE() \</span>
00060 <span class="preprocessor">    struct { ULONG bogus; } ThisCodeCantBePaged; \</span>
00061 <span class="preprocessor">    ThisCodeCantBePaged; \</span>
00062 <span class="preprocessor">    if (KeGetCurrentIrql() &gt; APC_LEVEL) { \</span>
00063 <span class="preprocessor">        KdPrint(( "SMBTRSUP: Pageable code called at IRQL %d.  File %s, Line %d\n", KeGetCurrentIrql(), __FILE__, __LINE__ )); \</span>
00064 <span class="preprocessor">        ASSERT(FALSE); \</span>
00065 <span class="preprocessor">        }</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#define PAGED_CODE_CHECK() if (ThisCodeCantBePaged) ;</span>
00067 <span class="preprocessor"></span>ULONG ThisCodeCantBePaged;
00068 <span class="preprocessor">#else</span>
<a name="l00069"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a2">00069</a> <span class="preprocessor"></span><span class="preprocessor">#define PAGED_CODE_CHECK()</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00071 <span class="preprocessor"></span>
00072 
00073 <span class="preprocessor">#if PAGED_DBG</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#define ACQUIRE_SPIN_LOCK(a, b) {               \</span>
00075 <span class="preprocessor">    PAGED_CODE_CHECK();                         \</span>
00076 <span class="preprocessor">    KeAcquireSpinLock(a, b);                    \</span>
00077 <span class="preprocessor">    }</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#define RELEASE_SPIN_LOCK(a, b) {               \</span>
00079 <span class="preprocessor">    PAGED_CODE_CHECK();                         \</span>
00080 <span class="preprocessor">    KeReleaseSpinLock(a, b);                    \</span>
00081 <span class="preprocessor">    }</span>
00082 <span class="preprocessor"></span>
00083 <span class="preprocessor">#else</span>
<a name="l00084"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a3">00084</a> <span class="preprocessor"></span><span class="preprocessor">#define ACQUIRE_SPIN_LOCK(a, b) KeAcquireSpinLock(a, b)</span>
<a name="l00085"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a4">00085</a> <span class="preprocessor"></span><span class="preprocessor">#define RELEASE_SPIN_LOCK(a, b) KeReleaseSpinLock(a, b)</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00087 <span class="preprocessor"></span>
00088 <span class="comment">//</span>
00089 <span class="comment">// Increment shared variable in instance data using appropriate interlock</span>
00090 <span class="comment">//</span>
<a name="l00091"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a5">00091</a> <span class="preprocessor">#define LOCK_INC_ID(var)                                     \</span>
00092 <span class="preprocessor">     ExInterlockedAddUlong( (PULONG)&amp;ID(var),                \</span>
00093 <span class="preprocessor">                            1, &amp;ID(var##Interlock) )</span>
00094 <span class="preprocessor"></span>
00095 <span class="comment">//</span>
00096 <span class="comment">// Zero shared variable in instance data using appropriate interlock</span>
00097 <span class="comment">//</span>
<a name="l00098"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a6">00098</a> <span class="preprocessor">#define LOCK_ZERO_ID(var) {                                  \</span>
00099 <span class="preprocessor">     ID(var) = 0;                                            \</span>
00100 <span class="preprocessor">     }</span>
00101 <span class="preprocessor"></span>
00102 
00103 <span class="comment">//</span>
00104 <span class="comment">// The various states SmbTrace can be in.  These states are internal</span>
00105 <span class="comment">// only.  The external SmbTraceActive variable contains much less</span>
00106 <span class="comment">// detailed information:  it is TRUE when TraceRunning, FALSE in any other</span>
00107 <span class="comment">// state.</span>
00108 <span class="comment">//</span>
<a name="l00109"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a52">00109</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52">_SMBTRACE_STATE</a> {
00110     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a>,          <span class="comment">// not running</span>
00111     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a30">TraceStarting</a>,         <span class="comment">// preparing to run</span>
00112     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a31">TraceStartStopFile</a>,    <span class="comment">// starting, but want to shut down immediately</span>
00113                            <span class="comment">// because the FileObject closed</span>
00114     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a32">TraceStartStopNull</a>,    <span class="comment">// starting, but want to shut down immediately</span>
00115                            <span class="comment">// because a new fsctl came in</span>
00116     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a33">TraceAppWaiting</a>,       <span class="comment">// waiting for application to die</span>
00117     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a>,          <span class="comment">// processing SMBs</span>
00118     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a35">TraceStopping</a>          <span class="comment">// waiting for smbtrace thread to stop</span>
00119 } <a class="code" href="../../d4/d9/smbtrsup_8c.html#a18">SMBTRACE_STATE</a>;
00120 
00121 
00122 <span class="comment">//</span>
00123 <span class="comment">// Structure used to hold information regarding an SMB which is put into</span>
00124 <span class="comment">// the SmbTrace thread queue.</span>
00125 <span class="comment">//</span>
<a name="l00126"></a><a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">00126</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">_SMBTRACE_QUEUE_ENTRY</a> {
<a name="l00127"></a><a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o0">00127</a>     LIST_ENTRY  <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o0">ListEntry</a>;      <span class="comment">// usual doubly-linked list</span>
<a name="l00128"></a><a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o1">00128</a>     ULONG       <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o1">SmbLength</a>;      <span class="comment">// the length of this SMB</span>
<a name="l00129"></a><a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o2">00129</a>     PVOID       <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o2">Buffer</a>;         <span class="comment">// pointer into SmbTracePortMemoryHeap</span>
00130                                 <span class="comment">// or non-paged pool</span>
<a name="l00131"></a><a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o3">00131</a>     PVOID       <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o3">SmbAddress</a>;     <span class="comment">// address of real SMB, if SMB still</span>
00132                                 <span class="comment">// available (i.e. if slow mode)</span>
<a name="l00133"></a><a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o4">00133</a>     BOOLEAN     <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o4">BufferNonPaged</a>; <span class="comment">// TRUE if Buffer in non-paged pool, FALSE if</span>
00134                                 <span class="comment">// Buffer in SmbTracePortMemoryHeap</span>
00135                                 <span class="comment">// Redirector-specific</span>
<a name="l00136"></a><a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o5">00136</a>     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>     <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o5">WaitEvent</a>;      <span class="comment">// pointer to worker thread event to be</span>
00137                                 <span class="comment">// signalled when SMB has been processed</span>
00138                                 <span class="comment">// slow mode specific</span>
00139 } <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">SMBTRACE_QUEUE_ENTRY</a>, *<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">PSMBTRACE_QUEUE_ENTRY</a>;
00140 
00141 
00142 <span class="comment">//</span>
00143 <span class="comment">// Instance data is specific to the component being traced.  In order</span>
00144 <span class="comment">// to unclutter the source code, use the following macro to access</span>
00145 <span class="comment">// instance specific data.</span>
00146 <span class="comment">// Every exported function either has an explicit parameter (named</span>
00147 <span class="comment">// Component) which the caller provides, or is implicitly applicable</span>
00148 <span class="comment">// only to one component, and has a local variable named Component</span>
00149 <span class="comment">// which is always set to the appropriate value.</span>
00150 <span class="comment">//</span>
<a name="l00151"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">00151</a> <span class="preprocessor">#define ID(field) (SmbTraceData[Component].field)</span>
00152 <span class="preprocessor"></span>
00153 <span class="comment">//</span>
00154 <span class="comment">// Instance data.  The fields which need to be statically initialized</span>
00155 <span class="comment">// are declared before those that we don't care to initialize.</span>
00156 <span class="comment">//</span>
<a name="l00157"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html">00157</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html">_INSTANCE_DATA</a> {
00158 
00159     <span class="comment">//</span>
00160     <span class="comment">// Statically initialized fields.</span>
00161     <span class="comment">//</span>
00162 
00163     <span class="comment">//</span>
00164     <span class="comment">// Names for identifying the component being traced in KdPrint messages,</span>
00165     <span class="comment">// and global objects</span>
00166     <span class="comment">//</span>
<a name="l00167"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o0">00167</a>     PCHAR <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o0">ComponentName</a>;
<a name="l00168"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o1">00168</a>     PWSTR <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o1">SharedMemoryName</a>;
<a name="l00169"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o2">00169</a>     PWSTR <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o2">NewSmbEventName</a>;
<a name="l00170"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o3">00170</a>     PWSTR <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o3">DoneSmbEventName</a>;
00171 
00172     <span class="comment">//</span>
00173     <span class="comment">//  Prevent reinitializing resources if rdr/srv reloaded</span>
00174     <span class="comment">//</span>
<a name="l00175"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o4">00175</a>     BOOLEAN <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o4">InstanceInitialized</a>;
00176 
00177     <span class="comment">//</span>
00178     <span class="comment">// some tracing parameters, from SmbTrace application</span>
00179     <span class="comment">//</span>
<a name="l00180"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o5">00180</a>     BOOLEAN <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o5">SingleSmbMode</a>;
<a name="l00181"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o6">00181</a>     CLONG   <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o6">Verbosity</a>;
00182 
00183     <span class="comment">//</span>
00184     <span class="comment">// State of the current trace.</span>
00185     <span class="comment">//</span>
<a name="l00186"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o7">00186</a>     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a18">SMBTRACE_STATE</a> <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o7">TraceState</a>;
00187 
00188     <span class="comment">//</span>
00189     <span class="comment">// Pointer to file object of client who started the current trace.</span>
00190     <span class="comment">//</span>
<a name="l00191"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o8">00191</a>     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o8">StartersFileObject</a>;
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">// Fsp process of the component we're tracing in.</span>
00195     <span class="comment">//</span>
<a name="l00196"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o9">00196</a>     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o9">FspProcess</a>;
00197 
00198     <span class="comment">//</span>
00199     <span class="comment">// All subsequent fields are not expliticly statically initiliazed.</span>
00200     <span class="comment">//</span>
00201 
00202     <span class="comment">//</span>
00203     <span class="comment">// Current count of number of SMBs lost since last one output.</span>
00204     <span class="comment">// Use an interlock to access, cleared when an SMB is sent to</span>
00205     <span class="comment">// the client successfully.  This lock is used with ExInterlockedXxx</span>
00206     <span class="comment">// routines, so it cannot be treated as a real spin lock (i.e.</span>
00207     <span class="comment">// don't use KeAcquireSpinLock.)</span>
00208     <span class="comment">//</span>
<a name="l00209"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o10">00209</a>     KSPIN_LOCK <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o10">SmbsLostInterlock</a>;
<a name="l00210"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o11">00210</a>     ULONG      <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o11">SmbsLost</a>;
00211 
00212     <span class="comment">//</span>
00213     <span class="comment">// some events, only accessed within the kernel</span>
00214     <span class="comment">//</span>
<a name="l00215"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o12">00215</a>     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o12">ActiveEvent</a>;
<a name="l00216"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o13">00216</a>     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o13">TerminatedEvent</a>;
<a name="l00217"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o14">00217</a>     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o14">TerminationEvent</a>;
<a name="l00218"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o15">00218</a>     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o15">AppTerminationEvent</a>;
<a name="l00219"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o16">00219</a>     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o16">NeedMemoryEvent</a>;
00220 
00221     <span class="comment">//</span>
00222     <span class="comment">// some events, shared with the outside world</span>
00223     <span class="comment">//</span>
<a name="l00224"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o17">00224</a>     HANDLE <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o17">NewSmbEvent</a>;
<a name="l00225"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o18">00225</a>     HANDLE <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o18">DoneSmbEvent</a>;
00226 
00227     <span class="comment">//</span>
00228     <span class="comment">// Handle to the shared memory used for communication between</span>
00229     <span class="comment">// the server/redirector and SmbTrace.</span>
00230     <span class="comment">//</span>
<a name="l00231"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o19">00231</a>     HANDLE <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o19">SectionHandle</a>;
00232 
00233     <span class="comment">//</span>
00234     <span class="comment">// Pointers to control the shared memory for the SmbTrace application.</span>
00235     <span class="comment">// The port memory heap handle is initialized to NULL to indicate that</span>
00236     <span class="comment">// there is no connection with SmbTrace yet.</span>
00237     <span class="comment">//</span>
<a name="l00238"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o20">00238</a>     PVOID <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o20">PortMemoryBase</a>;
<a name="l00239"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o21">00239</a>     ULONG_PTR <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o21">PortMemorySize</a>;
<a name="l00240"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o22">00240</a>     ULONG <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o22">TableSize</a>;
<a name="l00241"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o23">00241</a>     PVOID <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o23">PortMemoryHeap</a>;
00242 
00243     <span class="comment">//</span>
00244     <span class="comment">// serialized access to the heap,</span>
00245     <span class="comment">// to allow clean shutdown (StateInterlock)</span>
00246     <span class="comment">//</span>
<a name="l00247"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o24">00247</a>     KSPIN_LOCK  <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o24">HeapReferenceCountLock</a>;
<a name="l00248"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o25">00248</a>     <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o25">StateInterlock</a>;
<a name="l00249"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o26">00249</a>     <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o26">HeapInterlock</a>;
<a name="l00250"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o27">00250</a>     ULONG     <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o27">HeapReferenceCount</a>;
00251 
00252     <span class="comment">//</span>
00253     <span class="comment">// Pointers to the structured data, located in the shared memory.</span>
00254     <span class="comment">//</span>
<a name="l00255"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o28">00255</a>     PSMBTRACE_TABLE_HEADER  <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o28">TableHeader</a>;
<a name="l00256"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o29">00256</a>     PSMBTRACE_TABLE_ENTRY   <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o29">Table</a>;
00257 
00258     <span class="comment">//</span>
00259     <span class="comment">// Fields for the SmbTrace queue.  The server/redirector puts</span>
00260     <span class="comment">// incoming and outgoing SMBs into this queue (when</span>
00261     <span class="comment">// SmbTraceActive[Component] is TRUE and they are processed</span>
00262     <span class="comment">// by the SmbTrace thread.</span>
00263     <span class="comment">//</span>
<a name="l00264"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o30">00264</a>     LIST_ENTRY <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o30">Queue</a>;            <span class="comment">// The queue itself</span>
<a name="l00265"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o31">00265</a>     KSPIN_LOCK <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o31">QueueInterlock</a>;   <span class="comment">// Synchronizes access to queue</span>
<a name="l00266"></a><a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o32">00266</a>     <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a> <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html#o32">QueueSemaphore</a>;   <span class="comment">// Counts elements in queue</span>
00267 
00268 } <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html">INSTANCE_DATA</a>;
00269 
00270 
00271 <span class="preprocessor">#ifdef  ALLOC_DATA_PRAGMA</span>
00272 <span class="preprocessor"></span><span class="preprocessor">#pragma data_seg("PAGESMBD")</span>
00273 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00274 <span class="preprocessor"></span><span class="comment">//</span>
00275 <span class="comment">// Global variables for SmbTrace support</span>
00276 <span class="comment">//</span>
00277 
<a name="l00278"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a22">00278</a> <a class="code" href="../../d4/d3/struct__INSTANCE__DATA.html">INSTANCE_DATA</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a22">SmbTraceData</a>[] = {
00279 
00280     <span class="comment">//</span>
00281     <span class="comment">// Server data</span>
00282     <span class="comment">//</span>
00283 
00284     {
00285         <span class="stringliteral">"Srv"</span>,                                 <span class="comment">// ComponentName</span>
00286         SMBTRACE_SRV_SHARED_MEMORY_NAME,       <span class="comment">// SharedMemoryName</span>
00287         SMBTRACE_SRV_NEW_SMB_EVENT_NAME,       <span class="comment">// NewSmbEventName</span>
00288         SMBTRACE_SRV_DONE_SMB_EVENT_NAME,      <span class="comment">// DoneSmbEventName</span>
00289 
00290         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                                 <span class="comment">// InstanceInitialized</span>
00291 
00292         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                                 <span class="comment">// SingleSmbMode</span>
00293         SMBTRACE_VERBOSITY_ERROR,              <span class="comment">// Verbosity</span>
00294 
00295         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a>,                          <span class="comment">// TraceState</span>
00296 
00297         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                                  <span class="comment">// StartersFileObject</span>
00298         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                                   <span class="comment">// FspProcess</span>
00299 
00300         <span class="comment">// rest of fields expected to get 'all-zeroes'</span>
00301     },
00302 
00303     <span class="comment">//</span>
00304     <span class="comment">// Redirector data</span>
00305     <span class="comment">//</span>
00306 
00307     {
00308         <span class="stringliteral">"Rdr"</span>,                                 <span class="comment">// ComponentName</span>
00309         SMBTRACE_LMR_SHARED_MEMORY_NAME,       <span class="comment">// SharedMemoryName</span>
00310         SMBTRACE_LMR_NEW_SMB_EVENT_NAME,       <span class="comment">// NewSmbEventName</span>
00311         SMBTRACE_LMR_DONE_SMB_EVENT_NAME,      <span class="comment">// DoneSmbEventName</span>
00312 
00313         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                                 <span class="comment">// InstanceInitialized</span>
00314 
00315         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                                 <span class="comment">// SingleSmbMode</span>
00316         SMBTRACE_VERBOSITY_ERROR,              <span class="comment">// Verbosity</span>
00317 
00318         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a>,                          <span class="comment">// TraceState</span>
00319 
00320         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                                  <span class="comment">// StartersFileObject</span>
00321         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                                   <span class="comment">// FspProcess</span>
00322 
00323         <span class="comment">// rest of fields expected to get 'all-zeroes'</span>
00324     }
00325 };
00326 
00327 
00328 <span class="comment">//</span>
00329 <span class="comment">// some state booleans, exported to clients.  For this reason,</span>
00330 <span class="comment">// they're stored separately from the rest of the instance data.</span>
00331 <span class="comment">// Initially, SmbTrace is neither active nor transitioning.</span>
00332 <span class="comment">//</span>
<a name="l00333"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a23">00333</a> BOOLEAN <a class="code" href="../../d4/d9/smbtrsup_8c.html#a23">SmbTraceActive</a>[] = {<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>};
<a name="l00334"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a24">00334</a> BOOLEAN <a class="code" href="../../d4/d9/smbtrsup_8c.html#a24">SmbTraceTransitioning</a>[] = {<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>};
00335 
00336 HANDLE
<a name="l00337"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a25">00337</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a25">SmbTraceDiscardableCodeHandle</a> = 0;
00338 
00339 HANDLE
<a name="l00340"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a26">00340</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a26">SmbTraceDiscardableDataHandle</a> = 0;
00341 
00342 <span class="preprocessor">#ifdef  ALLOC_DATA_PRAGMA</span>
00343 <span class="preprocessor"></span><span class="preprocessor">#pragma data_seg()</span>
00344 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00345 <span class="preprocessor"></span>
00346 <span class="comment">//</span>
00347 <span class="comment">// Forward declarations of internal routines</span>
00348 <span class="comment">//</span>
00349 
00350 BOOLEAN
00351 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a36">SmbTraceReferenceHeap</a>(
00352     IN SMBTRACE_COMPONENT Component
00353     );
00354 
00355 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00356 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>(
00357     IN SMBTRACE_COMPONENT Component
00358     );
00359 
00360 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00361 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a38">SmbTraceDisconnect</a>(
00362     IN SMBTRACE_COMPONENT Component
00363     );
00364 
00365 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00366 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a39">SmbTraceEmptyQueue</a> (
00367     IN SMBTRACE_COMPONENT Component
00368     );
00369 
00370 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00371 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a40">SmbTraceThreadEntry</a>(
00372     IN PVOID Context
00373     );
00374 
00375 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00376 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a41">SmbTraceFreeMemory</a> (
00377     IN SMBTRACE_COMPONENT Component
00378     );
00379 
00380 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00381 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a42">SmbTraceToClient</a>(
00382     IN PVOID Smb,
00383     IN CLONG SmbLength,
00384     IN PVOID SmbAddress,
00385     IN SMBTRACE_COMPONENT Component
00386     );
00387 
00388 ULONG
00389 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a43">SmbTraceMdlLength</a>(
00390     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl
00391     );
00392 
00393 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00394 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a44">SmbTraceCopyMdlContiguous</a>(
00395     OUT PVOID Destination,
00396     IN  <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
00397     IN  ULONG Length
00398     );
00399 
00400 <span class="comment">//NTSTATUS</span>
00401 <span class="comment">//DriverEntry(</span>
00402 <span class="comment">//    IN PDRIVER_OBJECT DriverObject,</span>
00403 <span class="comment">//    IN PUNICODE_STRING RegistryPath</span>
00404 <span class="comment">//    );</span>
00405 
00406 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00407 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a45">SmbTraceDeferredDereferenceHeap</a>(
00408     IN PVOID Context
00409     );
00410 
00411 <span class="preprocessor">#ifdef  ALLOC_PRAGMA</span>
00412 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, SmbTraceInitialize)</span>
00413 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, SmbTraceTerminate)</span>
00414 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, SmbTraceStart)</span>
00415 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, SmbTraceStop)</span>
00416 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, SmbTraceCompleteSrv)</span>
00417 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, SmbTraceDisconnect)</span>
00418 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, SmbTraceEmptyQueue)</span>
00419 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, SmbTraceThreadEntry)</span>
00420 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, SmbTraceFreeMemory)</span>
00421 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, SmbTraceToClient)</span>
00422 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, SmbTraceDeferredDereferenceHeap)</span>
00423 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGESMBC, SmbTraceCompleteRdr)</span>
00424 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGESMBC, SmbTraceReferenceHeap)</span>
00425 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGESMBC, SmbTraceDereferenceHeap)</span>
00426 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGESMBC, SmbTraceMdlLength)</span>
00427 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGESMBC, SmbTraceCopyMdlContiguous)</span>
00428 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00429 <span class="preprocessor"></span>
00430 
00431 
00432 <span class="comment">//</span>
00433 <span class="comment">// Exported routines</span>
00434 <span class="comment">//</span>
00435 
00436 
00437 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00438"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a46">00438</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a46">SmbTraceInitialize</a> (
00439     IN SMBTRACE_COMPONENT Component
00440     )
00441 
00442 <span class="comment">/*++</span>
00443 <span class="comment"></span>
00444 <span class="comment">Routine Description:</span>
00445 <span class="comment"></span>
00446 <span class="comment">    This routine initializes the SmbTrace component-specific instance</span>
00447 <span class="comment">    globals.  On first-ever invocation, it performs truly global</span>
00448 <span class="comment">    initialization.</span>
00449 <span class="comment"></span>
00450 <span class="comment">Arguments:</span>
00451 <span class="comment"></span>
00452 <span class="comment">    Component - Context from which we're called: server or redirector</span>
00453 <span class="comment"></span>
00454 <span class="comment">Return Value:</span>
00455 <span class="comment"></span>
00456 <span class="comment">    NTSTATUS - Indicates failure if unable to allocate resources</span>
00457 <span class="comment"></span>
00458 <span class="comment">--*/</span>
00459 
00460 {
00461     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00462 
00463     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(InstanceInitialized) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00464         <span class="comment">//</span>
00465         <span class="comment">// Component specific initialization -- events and locks.</span>
00466         <span class="comment">//</span>
00467 
00468         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ActiveEvent), NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00469         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminatedEvent), NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00470         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminationEvent), NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00471         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(AppTerminationEvent), NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00472         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NeedMemoryEvent), NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00473 
00474         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SmbsLostInterlock) );
00475         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock) );
00476 
00477         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00478                                 <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00479                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>),
00480                                 'tbmS'
00481                                 );
00482         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00483             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00484         }
00485         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
00486 
00487         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapInterlock) = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00488                                 <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00489                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/ex_8h.html#a125">ERESOURCE</a>),
00490                                 'tbmS'
00491                                 );
00492         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapInterlock) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00493             <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
00494             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
00495             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00496             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00497         }
00498         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapInterlock) );
00499 
00500         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(InstanceInitialized) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00501     }
00502 
00503     <span class="keywordflow">return</span> STATUS_SUCCESS;
00504 
00505 } <span class="comment">// SmbTraceInitialize</span>
00506 
00507 
00508 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00509"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a47">00509</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a47">SmbTraceTerminate</a> (
00510     IN SMBTRACE_COMPONENT Component
00511     )
00512 
00513 <span class="comment">/*++</span>
00514 <span class="comment"></span>
00515 <span class="comment">Routine Description:</span>
00516 <span class="comment"></span>
00517 <span class="comment">    This routine cleans up the SmbTrace component-specific instance</span>
00518 <span class="comment">    globals.  It should be called by the component when the component</span>
00519 <span class="comment">    is unloaded.</span>
00520 <span class="comment"></span>
00521 <span class="comment">Arguments:</span>
00522 <span class="comment"></span>
00523 <span class="comment">    Component - Context from which we're called: server or redirector</span>
00524 <span class="comment"></span>
00525 <span class="comment">Return Value:</span>
00526 <span class="comment"></span>
00527 <span class="comment">    None</span>
00528 <span class="comment"></span>
00529 <span class="comment">--*/</span>
00530 
00531 {
00532     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00533 
00534     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(InstanceInitialized) ) {
00535 
00536         <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
00537         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
00538 
00539         <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapInterlock) );
00540         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapInterlock) );
00541 
00542         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(InstanceInitialized) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00543     }
00544 
00545     <span class="keywordflow">return</span>;
00546 
00547 } <span class="comment">// SmbTraceTerminate</span>
00548 
00549 
00550 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00551"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a48">00551</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a48">SmbTraceStart</a> (
00552     IN ULONG InputBufferLength,
00553     IN ULONG OutputBufferLength,
00554     IN OUT PVOID ConfigInOut,
00555     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
00556     IN SMBTRACE_COMPONENT Component
00557     )
00558 
00559 <span class="comment">/*++</span>
00560 <span class="comment"></span>
00561 <span class="comment">Routine Description:</span>
00562 <span class="comment"></span>
00563 <span class="comment">    This routine performs all the work necessary to connect the server/</span>
00564 <span class="comment">    redirector to SmbTrace.  It creates the section of shared memory to</span>
00565 <span class="comment">    be used, then creates the events needed. All these objects are then</span>
00566 <span class="comment">    opened by the client (smbtrace) program. This code initializes the</span>
00567 <span class="comment">    table, the heap stored in the section and table header.  This routine</span>
00568 <span class="comment">    must be called from an Fsp process.</span>
00569 <span class="comment"></span>
00570 <span class="comment">Arguments:</span>
00571 <span class="comment"></span>
00572 <span class="comment">    InputBufferLength - Length of the ConfigInOut packet</span>
00573 <span class="comment"></span>
00574 <span class="comment">    OutputBufferLength - Length expected for the ConfigInOut packet returned</span>
00575 <span class="comment"></span>
00576 <span class="comment">    ConfigInOut - A structure that has configuration information.</span>
00577 <span class="comment"></span>
00578 <span class="comment">    FileObject - FileObject of the process requesting that SmbTrace be started,</span>
00579 <span class="comment">                 used to automatically shut down when the app dies.</span>
00580 <span class="comment"></span>
00581 <span class="comment">    Component - Context from which we're called: server or redirector</span>
00582 <span class="comment"></span>
00583 <span class="comment">Return Value:</span>
00584 <span class="comment"></span>
00585 <span class="comment">    NTSTATUS - result of operation.</span>
00586 <span class="comment"></span>
00587 <span class="comment">--*/</span>
00588 
00589 <span class="comment">// size of our one, particular, ACL</span>
00590 #define <a class="code" href="../../d4/d9/smbtrsup_8c.html#a8">ACL_LENGTH</a>  (ULONG)sizeof(ACL) +                 \
00591                     (ULONG)sizeof(ACCESS_ALLOWED_ACE) +  \
00592                     sizeof(LUID) +                       \
00593                     8
00594 
00595 {
00596     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00597     UNICODE_STRING memoryNameU;
00598 
00599     SID_IDENTIFIER_AUTHORITY NtAuthority = SECURITY_NT_AUTHORITY;
00600     UCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d4/d9/smbtrsup_8c.html#a8">ACL_LENGTH</a>];
00601     PACL AdminAcl = (PACL)(&amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0]);
00602     SECURITY_DESCRIPTOR securityDescriptor;
00603 
00604     UNICODE_STRING eventNameU;
00605     OBJECT_ATTRIBUTES objectAttributes;
00606     ULONG i;
00607     LARGE_INTEGER sectionSize;
00608     PSMBTRACE_CONFIG_PACKET_REQ  ConfigPacket;
00609     PSMBTRACE_CONFIG_PACKET_RESP ConfigPacketResp;
00610     HANDLE threadHandle;
00611 
00612     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00613 
00614     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(InstanceInitialized) );
00615 
00616     <span class="comment">//</span>
00617     <span class="comment">// Validate the buffer lengths passed in.</span>
00618     <span class="comment">//</span>
00619 
00620     <span class="keywordflow">if</span> ( ( InputBufferLength  != <span class="keyword">sizeof</span>( SMBTRACE_CONFIG_PACKET_REQ ) )
00621       || ( OutputBufferLength != <span class="keyword">sizeof</span>( SMBTRACE_CONFIG_PACKET_RESP ) )
00622     ) {
00623 
00624         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStart: config packet(s) of wrong size!\n"</span>,
00625                   <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
00626 
00627         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00628 
00629     }
00630 
00631     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00632 
00633     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) != <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a> ) {
00634         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
00635         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_STATE;
00636     }
00637 
00638     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d4/d9/smbtrsup_8c.html#a23">SmbTraceActive</a>[Component]);
00639 
00640     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d9/smbtrsup_8c.html#a26">SmbTraceDiscardableDataHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00641 
00642     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d9/smbtrsup_8c.html#a25">SmbTraceDiscardableCodeHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00643 
00644     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a25">SmbTraceDiscardableCodeHandle</a> = MmLockPagableCodeSection(<a class="code" href="../../d4/d9/smbtrsup_8c.html#a36">SmbTraceReferenceHeap</a>);
00645 
00646     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a26">SmbTraceDiscardableDataHandle</a> = <a class="code" href="../../d5/d6/iosup_8c.html#a79">MmLockPagableDataSection</a>(<a class="code" href="../../d4/d9/smbtrsup_8c.html#a22">SmbTraceData</a>);
00647 
00648     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a30">TraceStarting</a>;
00649 
00650     <span class="comment">//</span>
00651     <span class="comment">// Initialize global variables so that we know what to close on errexit</span>
00652     <span class="comment">//</span>
00653 
00654     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SectionHandle) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00655     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00656     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NewSmbEvent) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00657     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00658 
00659     <span class="comment">//</span>
00660     <span class="comment">// Caution! Both input and output packets are the same, we must</span>
00661     <span class="comment">// read all of the input before we write any output.</span>
00662     <span class="comment">//</span>
00663 
00664     ConfigPacket = (PSMBTRACE_CONFIG_PACKET_REQ) ConfigInOut;
00665     ConfigPacketResp = (PSMBTRACE_CONFIG_PACKET_RESP) ConfigInOut;
00666 
00667     <span class="comment">//</span>
00668     <span class="comment">// Set the mode of operation (read all values).</span>
00669     <span class="comment">//</span>
00670 
00671     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode)  = ConfigPacket-&gt;SingleSmbMode;
00672     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Verbosity)      = ConfigPacket-&gt;Verbosity;
00673     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemorySize) = ConfigPacket-&gt;BufferSize;
00674     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableSize)      = ConfigPacket-&gt;TableSize;
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">// Create a security descriptor containing a discretionary Acl</span>
00678     <span class="comment">// allowing administrator access.  This SD will be used to allow</span>
00679     <span class="comment">// Smbtrace access to the shared memory and the notification events.</span>
00680     <span class="comment">//</span>
00681 
00682     <span class="comment">// Create Acl allowing administrator access using well-known Sid.</span>
00683 
00684     status = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( AdminAcl, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a8">ACL_LENGTH</a>, ACL_REVISION2 );
00685     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00686         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
00687             <span class="stringliteral">"%s!SmbTraceStart: RtlCreateAcl failed: %X\n"</span>,
00688             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00689         <span class="keywordflow">goto</span> errexit;
00690     }
00691 
00692     status = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>(
00693              AdminAcl,
00694              ACL_REVISION2,
00695              GENERIC_ALL,
00696              <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o34">SeAliasAdminsSid</a>
00697              );
00698     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00699         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
00700             <span class="stringliteral">"%s!SmbTraceStart: RtlAddAccessAllowedAce failed: %X\n"</span>,
00701             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00702         <span class="keywordflow">goto</span> errexit;
00703     }
00704 
00705     <span class="comment">// Create SecurityDescriptor containing AdminAcl as a discrectionary ACL.</span>
00706 
00707     <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(
00708              &amp;securityDescriptor,
00709              SECURITY_DESCRIPTOR_REVISION1
00710              );
00711     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00712         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
00713             <span class="stringliteral">"%s!SmbTraceStart: RtlCreateSecurityDescriptor failed: %X\n"</span>,
00714             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00715         <span class="keywordflow">goto</span> errexit;
00716     }
00717 
00718     status = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>(
00719              &amp;securityDescriptor,
00720              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00721              AdminAcl,
00722              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00723              );
00724     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00725         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
00726             <span class="stringliteral">"%s!SmbTraceStart: "</span>
00727             <span class="stringliteral">"RtlSetDAclAllowedSecurityDescriptor failed: %X\n"</span>,
00728             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00729         <span class="keywordflow">goto</span> errexit;
00730     }
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">// Create the section to be used for communication between the</span>
00734     <span class="comment">// server/redirector and SmbTrace.</span>
00735     <span class="comment">//</span>
00736 
00737     <span class="comment">// Define the object name.</span>
00738 
00739     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;memoryNameU, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SharedMemoryName) );
00740 
00741     <span class="comment">// Define the object information, including security descriptor and name.</span>
00742 
00743     InitializeObjectAttributes(
00744         &amp;objectAttributes,
00745         &amp;memoryNameU,
00746         OBJ_CASE_INSENSITIVE,
00747         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00748         &amp;securityDescriptor
00749         );
00750 
00751     <span class="comment">// Setup the section size.</span>
00752 
00753     sectionSize.QuadPart = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemorySize);
00754 
00755     <span class="comment">// Create the named section of memory with all of our attributes.</span>
00756 
00757     status = ZwCreateSection(
00758                 &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SectionHandle),
00759                 SECTION_MAP_READ | SECTION_MAP_WRITE,
00760                 &amp;objectAttributes,
00761                 &amp;sectionSize,
00762                 PAGE_READWRITE,
00763                 SEC_RESERVE,
00764                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                        <span class="comment">// file handle</span>
00765                 );
00766 
00767     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00768         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStart: ZwCreateSection failed: %X\n"</span>,
00769                   <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00770         <span class="keywordflow">goto</span> errexit;
00771     }
00772 
00773     <span class="comment">// Now, map it into our address space.</span>
00774 
00775     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00776 
00777     status = ZwMapViewOfSection(
00778                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SectionHandle),
00779                     NtCurrentProcess(),
00780                     &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase),
00781                     0,                        <span class="comment">// zero bits (don't care)</span>
00782                     0,                        <span class="comment">// commit size</span>
00783                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                     <span class="comment">// SectionOffset</span>
00784                     &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemorySize),      <span class="comment">// viewSize</span>
00785                     ViewUnmap,                <span class="comment">// inheritDisposition</span>
00786                     0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,                       <span class="comment">// allocation type</span>
00787                     PAGE_READWRITE            <span class="comment">// protection</span>
00788                     );
00789 
00790     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00791         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStart: NtMapViewOfSection failed: %X\n"</span>,
00792                   <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00793         <span class="keywordflow">goto</span> errexit;
00794     }
00795 
00796     <span class="comment">//</span>
00797     <span class="comment">// Set up the shared section memory as a heap.</span>
00798     <span class="comment">//</span>
00799     <span class="comment">// *** Note that the HeapInterlock for the client instance is passed</span>
00800     <span class="comment">//     to the heap manager to be used for serialization of</span>
00801     <span class="comment">//     allocation and deallocation.  It is necessary for the</span>
00802     <span class="comment">//     resource to be allocated FROM NONPAGED POOL externally to the</span>
00803     <span class="comment">//     heap manager, because if we let the heap manager allocate</span>
00804     <span class="comment">//     the resource, if would allocate it from process virtual</span>
00805     <span class="comment">//     memory.</span>
00806     <span class="comment">//</span>
00807 
00808     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap) = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a15">RtlCreateHeap</a>(
00809                               0,                            <span class="comment">// Flags</span>
00810                               <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase),           <span class="comment">// HeapBase</span>
00811                               <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemorySize),           <span class="comment">// ReserveSize</span>
00812                               <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,                    <span class="comment">// CommitSize</span>
00813                               <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapInterlock),            <span class="comment">// Lock</span>
00814                               0                             <span class="comment">// Reserved</span>
00815                               );
00816 
00817     <span class="comment">//</span>
00818     <span class="comment">// Allocate and initialize the table and its header.</span>
00819     <span class="comment">//</span>
00820 
00821     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader) = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
00822                                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0,
00823                                     <span class="keyword">sizeof</span>( SMBTRACE_TABLE_HEADER )
00824                                     );
00825 
00826     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Table) = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
00827                         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0,
00828                         <span class="keyword">sizeof</span>( SMBTRACE_TABLE_ENTRY ) * <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableSize)
00829                         );
00830 
00831     <span class="keywordflow">if</span> ( (<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Table) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00832         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
00833             <span class="stringliteral">"%s!SmbTraceStart: Not enough memory!\n"</span>,
00834             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
00835 
00836         status = STATUS_NO_MEMORY;
00837 
00838         <span class="keywordflow">goto</span> errexit;
00839     }
00840 
00841     <span class="comment">// Initialize the values inside.</span>
00842 
00843     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;HighestConsumed = 0;
00844     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;NextFree = 1;
00845     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;ApplicationStop = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00846 
00847     <span class="keywordflow">for</span> ( i = 0; i &lt; <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableSize); i++) {
00848         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Table)[i].BufferOffset = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00849         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Table)[i].SmbLength = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00850     }
00851 
00852     <span class="comment">//</span>
00853     <span class="comment">// Create the required event handles.</span>
00854     <span class="comment">//</span>
00855 
00856     <span class="comment">// Define the object information.</span>
00857 
00858     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;eventNameU, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NewSmbEventName) );
00859 
00860     InitializeObjectAttributes(
00861         &amp;objectAttributes,
00862         &amp;eventNameU,
00863         OBJ_CASE_INSENSITIVE,
00864         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00865         &amp;securityDescriptor
00866         );
00867 
00868     <span class="comment">// Open the named object.</span>
00869 
00870     status = ZwCreateEvent(
00871                 &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NewSmbEvent),
00872                 EVENT_ALL_ACCESS,
00873                 &amp;objectAttributes,
00874                 NotificationEvent,
00875                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>                        <span class="comment">// initial state</span>
00876                 );
00877 
00878     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00879         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStart: ZwCreateEvent (1st) failed: %X\n"</span>,
00880                   <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00881 
00882         <span class="keywordflow">goto</span> errexit;
00883     }
00884 
00885     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) {    <span class="comment">// this event may not be required.</span>
00886 
00887         <span class="comment">// Define the object information.</span>
00888 
00889         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;eventNameU, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEventName) );
00890 
00891         InitializeObjectAttributes(
00892             &amp;objectAttributes,
00893             &amp;eventNameU,
00894             OBJ_CASE_INSENSITIVE,
00895             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00896             &amp;securityDescriptor
00897             );
00898 
00899         <span class="comment">// Create the named object.</span>
00900 
00901         status = ZwCreateEvent(
00902                     &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent),
00903                     EVENT_ALL_ACCESS,
00904                     &amp;objectAttributes,
00905                     NotificationEvent,
00906                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>                    <span class="comment">// initial state</span>
00907                     );
00908 
00909         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00910             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
00911                 <span class="stringliteral">"%s!SmbTraceStart: NtCreateEvent (2nd) failed: %X\n"</span>,
00912                  <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00913             <span class="keywordflow">goto</span> errexit;
00914         }
00915         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStart: DoneSmbEvent handle %x in process %x\n"</span>,
00916                 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()));
00917 
00918     }
00919 
00920     <span class="comment">//</span>
00921     <span class="comment">//  Reset any events that may be in the wrong state from a previous run.</span>
00922     <span class="comment">//</span>
00923 
00924     <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>(&amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminationEvent));
00925     <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>(&amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminatedEvent));
00926 
00927     <span class="comment">//</span>
00928     <span class="comment">// Connection was successful, now start the SmbTrace thread.</span>
00929     <span class="comment">//</span>
00930 
00931     <span class="comment">//</span>
00932     <span class="comment">// Create the SmbTrace thread and wait for it to finish</span>
00933     <span class="comment">// initializing (at which point SmbTraceActiveEvent is set)</span>
00934     <span class="comment">//</span>
00935 
00936     status = <a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(
00937         &amp;threadHandle,
00938         THREAD_ALL_ACCESS,
00939         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00940         NtCurrentProcess(),
00941         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00942         (<a class="code" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a>) <a class="code" href="../../d4/d9/smbtrsup_8c.html#a40">SmbTraceThreadEntry</a>,
00943         (PVOID)Component
00944         );
00945 
00946     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00947 
00948         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
00949             <span class="stringliteral">"%s!SmbTraceStart: PsCreateSystemThread failed: %X\n"</span>,
00950             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00951 
00952         <span class="keywordflow">goto</span> errexit;
00953     }
00954 
00955     <span class="comment">//</span>
00956     <span class="comment">// Wait until SmbTraceThreadEntry has finished initializing</span>
00957     <span class="comment">//</span>
00958 
00959     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
00960             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ActiveEvent),
00961             <a class="code" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>,
00962             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00963             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00964             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00965             );
00966 
00967     <span class="comment">//</span>
00968     <span class="comment">// Close the handle to the process so the object will be</span>
00969     <span class="comment">// destroyed when the thread dies.</span>
00970     <span class="comment">//</span>
00971 
00972     ZwClose( threadHandle );
00973 
00974 
00975     <span class="comment">//</span>
00976     <span class="comment">// Record who started SmbTrace so we can stop if he dies or otherwise</span>
00977     <span class="comment">// closes this handle to us.</span>
00978     <span class="comment">//</span>
00979 
00980     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StartersFileObject) = FileObject;
00981 
00982     <span class="comment">//</span>
00983     <span class="comment">// Record caller's process; which is always the appropriate Fsp</span>
00984     <span class="comment">// process.</span>
00985     <span class="comment">//</span>
00986 
00987     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess) = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00988 
00989 
00990     <span class="comment">//</span>
00991     <span class="comment">// Setup the response packet, since everything worked (write all values).</span>
00992     <span class="comment">//</span>
00993 
00994     ConfigPacketResp-&gt;HeaderOffset = (ULONG)
00995                                 ( (ULONG_PTR)<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)
00996                                 - (ULONG_PTR)<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase) );
00997 
00998     ConfigPacketResp-&gt;TableOffset = (ULONG)
00999                                 ( (ULONG_PTR)<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Table)
01000                                 - (ULONG_PTR)<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase) );
01001 
01002     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStart: SmbTrace started.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01003 
01004     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01005 
01006     <span class="comment">//</span>
01007     <span class="comment">// if someone wanted it shut down while it was starting, shut it down</span>
01008     <span class="comment">//</span>
01009 
01010     <span class="keywordflow">switch</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) ) {
01011 
01012     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a31">TraceStartStopFile</a> :
01013         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a49">SmbTraceStop</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StartersFileObject), Component );
01014         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;  <span class="comment">// app closed, so we should shut down</span>
01015         <span class="keywordflow">break</span>;
01016 
01017     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a32">TraceStartStopNull</a> :
01018         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a49">SmbTraceStop</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, Component );
01019         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;  <span class="comment">// someone requested a shut down</span>
01020         <span class="keywordflow">break</span>;
01021 
01022     <span class="keywordflow">default</span> :
01023         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a>;
01024         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a23">SmbTraceActive</a>[Component] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01025         <span class="keywordflow">return</span> STATUS_SUCCESS;
01026     }
01027 
01028 errexit:
01029 
01030     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a38">SmbTraceDisconnect</a>( Component );
01031 
01032     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a>;
01033 
01034     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01035 
01036     <span class="comment">//</span>
01037     <span class="comment">// return original failure status code, not success of cleanup</span>
01038     <span class="comment">//</span>
01039 
01040     <span class="keywordflow">return</span> status;
01041 
01042 } <span class="comment">// SmbTraceStart</span>
01043 
01044 <span class="comment">// constant only of interest while constructing the particular Acl</span>
01045 <span class="comment">// in SmbTraceStart</span>
01046 <span class="preprocessor">#undef ACL_LENGTH</span>
01047 <span class="preprocessor"></span>
01048 
01049 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01050"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a49">01050</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a49">SmbTraceStop</a>(
01051     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject OPTIONAL,
01052     IN SMBTRACE_COMPONENT Component
01053     )
01054 
01055 <span class="comment">/*++</span>
01056 <span class="comment"></span>
01057 <span class="comment">Routine Description:</span>
01058 <span class="comment"></span>
01059 <span class="comment">    This routine stops tracing in the server/redirector.  If no</span>
01060 <span class="comment">    FileObject is provided, the SmbTrace application is stopped.</span>
01061 <span class="comment">    If a FileObject is provided, SmbTrace is stopped if the</span>
01062 <span class="comment">    FileObject refers to the one who started it.</span>
01063 <span class="comment"></span>
01064 <span class="comment">Arguments:</span>
01065 <span class="comment"></span>
01066 <span class="comment">    FileObject - FileObject of a process that terminated.  If it's the process</span>
01067 <span class="comment">                 that requested SmbTracing, we shut down automatically.</span>
01068 <span class="comment"></span>
01069 <span class="comment">    Component - Context from which we're called: server or redirector</span>
01070 <span class="comment"></span>
01071 <span class="comment">Return Value:</span>
01072 <span class="comment"></span>
01073 <span class="comment">    NTSTATUS - result of operation.  Possible results are:</span>
01074 <span class="comment">        STATUS_SUCCESS - SmbTrace was stopped</span>
01075 <span class="comment">        STATUS_UNSUCCESSFUL - SmbTrace was not stopped because the</span>
01076 <span class="comment">            provided FileObject did not refer to the SmbTrace starter</span>
01077 <span class="comment">            or because SmbTrace was not running.</span>
01078 <span class="comment"></span>
01079 <span class="comment">--*/</span>
01080 
01081 {
01082     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01083 
01084     <span class="comment">//</span>
01085     <span class="comment">// If we haven't been initialized, there's nothing to stop.  (And no</span>
01086     <span class="comment">// resource to acquire!)</span>
01087     <span class="comment">//</span>
01088 
01089     <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(InstanceInitialized) ) {
01090         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01091     }
01092 
01093     <span class="comment">//</span>
01094     <span class="comment">// If it's not the FileObject that started SmbTrace, we don't care.</span>
01095     <span class="comment">// From then on, if ARGUMENT_PRESENT(FileObject) it's the right one.</span>
01096     <span class="comment">//</span>
01097 
01098     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(FileObject) &amp;&amp;
01099          FileObject != <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StartersFileObject)
01100     ) {
01101        <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01102     }
01103 
01104     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01105 
01106     <span class="comment">//</span>
01107     <span class="comment">// Depending on the current state of SmbTrace and whether this is</span>
01108     <span class="comment">// a FileObject or unconditional shutdown request, we do different</span>
01109     <span class="comment">// things.  It is always clear at this point, though, that</span>
01110     <span class="comment">// SmbTraceActive should be set to FALSE.</span>
01111     <span class="comment">//</span>
01112 
01113     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a23">SmbTraceActive</a>[Component] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01114 
01115     <span class="keywordflow">switch</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) ) {
01116     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a> :
01117     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a35">TraceStopping</a> :
01118     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a31">TraceStartStopFile</a> :
01119     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a32">TraceStartStopNull</a> :
01120 
01121         <span class="comment">// if we're not running or already in a mode where we know we'll</span>
01122         <span class="comment">// soon be shut down, ignore the request.</span>
01123         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01124         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01125         <span class="keywordflow">break</span>;
01126 
01127     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a30">TraceStarting</a> :
01128 
01129         <span class="comment">// inform starting SmbTrace that it should shut down immediately</span>
01130         <span class="comment">// upon finishing initialization.  It needs to know whether this</span>
01131         <span class="comment">// is a FileObject or unconditional shutdown request.</span>
01132 
01133         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) = ARGUMENT_PRESENT(FileObject)
01134                        ? <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a31">TraceStartStopFile</a>
01135                        : <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a32">TraceStartStopNull</a>;
01136         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01137         <span class="keywordflow">return</span> STATUS_SUCCESS;
01138         <span class="keywordflow">break</span>;
01139 
01140     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a33">TraceAppWaiting</a> :
01141 
01142         <span class="comment">// we're waiting for the application to die already, so ignore</span>
01143         <span class="comment">// new unconditional requests.  But FileObject requests are</span>
01144         <span class="comment">// welcomed.  We cause the SmbTrace thread to kill itself.</span>
01145         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(FileObject) ) {
01146             <span class="keywordflow">break</span>;  <span class="comment">// thread kill code follows switch</span>
01147         } <span class="keywordflow">else</span> {
01148             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01149             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01150         }
01151         <span class="keywordflow">break</span>;
01152 
01153     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a> :
01154 
01155         <span class="comment">// if it's a FileObject request, the app is dead, so we cause</span>
01156         <span class="comment">// the SmbTrace thread to kill itself.  Otherwise, we need to</span>
01157         <span class="comment">// signal the app to stop and return.  When the app is gone, we</span>
01158         <span class="comment">// will be called again; this time with a FileObject.</span>
01159 
01160         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(FileObject) ) {
01161             <span class="keywordflow">break</span>;  <span class="comment">// thread kill code follows switch</span>
01162         } <span class="keywordflow">else</span> {
01163             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(AppTerminationEvent), 2, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01164             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a33">TraceAppWaiting</a>;
01165             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01166             <span class="keywordflow">return</span> STATUS_SUCCESS;
01167         }
01168 
01169         <span class="keywordflow">break</span>;
01170 
01171     <span class="keywordflow">default</span> :
01172         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<span class="stringliteral">"SmbTraceStop: invalid TraceState"</span>);
01173         <span class="keywordflow">break</span>;
01174     }
01175 
01176     <span class="comment">//</span>
01177     <span class="comment">// We reach here from within the switch only in the case where</span>
01178     <span class="comment">// we actually want to kill the SmbTrace thread.  Signal it to</span>
01179     <span class="comment">// wake up, and wait until it terminates.  Signal DoneSmbEvent</span>
01180     <span class="comment">// in case it is currently waiting for the application to signal</span>
01181     <span class="comment">// it in slow mode.</span>
01182     <span class="comment">//</span>
01183 
01184     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StartersFileObject) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01185 
01186     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode)) {
01187 
01188         BOOLEAN ProcessAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01189 
01190         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess)) {
01191             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess));
01192             ProcessAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01193         }
01194 
01195         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStop: Signal DoneSmbEvent, handle %x, process %x.\n"</span>,
01196                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()));
01197         ZwSetEvent( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01198 
01199         <span class="keywordflow">if</span> (ProcessAttached) {
01200             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01201         }
01202 
01203     }
01204 
01205     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStop: Signal Termination Event.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01206     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a35">TraceStopping</a>;
01207     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminationEvent), 2, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01208 
01209     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01210 
01211     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
01212         &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminatedEvent),
01213         <a class="code" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>,
01214         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01215         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01216         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01217         );
01218 
01219     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStop: Terminated Event is set.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01220     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01221 
01222     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a>;
01223 
01224     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01225 
01226     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStop: SmbTrace stopped.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01227 
01228     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d4/d9/smbtrsup_8c.html#a25">SmbTraceDiscardableCodeHandle</a>);
01229 
01230     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a25">SmbTraceDiscardableCodeHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01231 
01232     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d4/d9/smbtrsup_8c.html#a26">SmbTraceDiscardableDataHandle</a>);
01233 
01234     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a26">SmbTraceDiscardableDataHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01235 
01236     <span class="keywordflow">return</span> STATUS_SUCCESS;
01237 
01238 } <span class="comment">// SmbTraceStop</span>
01239 
01240 
01241 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01242"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a50">01242</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a50">SmbTraceCompleteSrv</a> (
01243     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> SmbMdl,
01244     IN PVOID Smb,
01245     IN CLONG SmbLength
01246     )
01247 
01248 <span class="comment">/*++</span>
01249 <span class="comment"></span>
01250 <span class="comment">Routine Description:</span>
01251 <span class="comment"></span>
01252 <span class="comment">    Server version.</span>
01253 <span class="comment"></span>
01254 <span class="comment">    Snapshot an SMB and export it to the SmbTrace application.  How</span>
01255 <span class="comment">    this happens is determined by which mode (fast or slow) SmbTracing</span>
01256 <span class="comment">    was requested in.  In the server, it is easy to guarantee that when</span>
01257 <span class="comment">    tracing, a thread is always executing in the Fsp.</span>
01258 <span class="comment"></span>
01259 <span class="comment">    Fast mode: the SMB is copied into shared memory and an entry for it</span>
01260 <span class="comment">    is queued to the server SmbTrace thread, which asynchronously</span>
01261 <span class="comment">    passes SMBs to the app.  If there is insufficient memory</span>
01262 <span class="comment">    for anything (SMB, queue entry, etc.) the SMB is lost.</span>
01263 <span class="comment"></span>
01264 <span class="comment">    Slow mode: identical to Fast mode except that this thread waits</span>
01265 <span class="comment">    until the server SmbTrace thread signals that the app has finished</span>
01266 <span class="comment">    processing the SMB.  Because each thread waits until its SMB has</span>
01267 <span class="comment">    been completely processed, there is much less chance of running</span>
01268 <span class="comment">    out of any resources.</span>
01269 <span class="comment"></span>
01270 <span class="comment">    The SMB is either contained in SmbMdl, or at address Smb with length</span>
01271 <span class="comment">    SmbLength.</span>
01272 <span class="comment"></span>
01273 <span class="comment">Arguments:</span>
01274 <span class="comment"></span>
01275 <span class="comment">    SmbMdl - an Mdl containing the SMB.</span>
01276 <span class="comment"></span>
01277 <span class="comment">    Smb - a pointer to the SMB.</span>
01278 <span class="comment"></span>
01279 <span class="comment">    SmbLength - the length of the SMB.</span>
01280 <span class="comment"></span>
01281 <span class="comment">Return Value:</span>
01282 <span class="comment"></span>
01283 <span class="comment">    None</span>
01284 <span class="comment"></span>
01285 <span class="comment">--*/</span>
01286 
01287 {
01288     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a20">PSMBTRACE_QUEUE_ENTRY</a>  queueEntry;
01289     PVOID  buffer;
01290     SMBTRACE_COMPONENT Component = SMBTRACE_SERVER;
01291     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> WaitEvent;
01292 
01293     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01294 
01295     <span class="comment">//</span>
01296     <span class="comment">// This routine is server specific.</span>
01297     <span class="comment">//</span>
01298 
01299     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) == <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a> );
01300     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a23">SmbTraceActive</a>[SMBTRACE_SERVER] );
01301 
01302     <span class="comment">//</span>
01303     <span class="comment">// We want either an Mdl, or a pointer and a length, or occasionally,</span>
01304     <span class="comment">// a completely NULL response.</span>
01305     <span class="comment">//</span>
01306 
01307     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ( SmbMdl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  &amp;&amp;  Smb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  &amp;&amp;  SmbLength != 0 )
01308          || ( SmbMdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  &amp;&amp;  Smb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  &amp;&amp;  SmbLength == 0 )
01309          || ( SmbMdl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  &amp;&amp;  Smb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  &amp;&amp;  SmbLength == 0 ) );
01310 
01311     <span class="comment">//</span>
01312     <span class="comment">// We've taken pains not to be at DPC level and to be in</span>
01313     <span class="comment">// the Fsp context too, for that matter.</span>
01314     <span class="comment">//</span>
01315 
01316     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeGetCurrentIrql() &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01317     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() == <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess) );
01318 
01319     <span class="comment">//</span>
01320     <span class="comment">// Ensure that SmbTrace really is still active and hence, the</span>
01321     <span class="comment">// shared memory is still around.</span>
01322     <span class="comment">//</span>
01323 
01324     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a36">SmbTraceReferenceHeap</a>( Component ) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
01325         <span class="keywordflow">return</span>;
01326     }
01327 
01328     <span class="comment">//</span>
01329     <span class="comment">// If the SMB is currently in an MDL, we don't yet have the length,</span>
01330     <span class="comment">// which we need, to know how much memory to allocate.</span>
01331     <span class="comment">//</span>
01332 
01333     <span class="keywordflow">if</span> ( SmbMdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01334         SmbLength = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a43">SmbTraceMdlLength</a>(SmbMdl);
01335     }
01336 
01337     <span class="comment">//</span>
01338     <span class="comment">// If we are in slow mode, then we wait after queuing the SMB</span>
01339     <span class="comment">// to the SmbTrace thread.  If we are set for fast mode we</span>
01340     <span class="comment">// garbage collect in case of no memory.</span>
01341     <span class="comment">//</span>
01342 
01343     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) {
01344         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;WaitEvent, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01345     }
01346 
01347     queueEntry = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01348                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">SMBTRACE_QUEUE_ENTRY</a>),
01349                                         'tbmS'
01350                                         );
01351 
01352     <span class="keywordflow">if</span> ( queueEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01353         <span class="comment">// No free memory, this SMB is lost.  Record its loss.</span>
01354         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a5">LOCK_INC_ID</a>(SmbsLost);
01355         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>( Component );
01356         <span class="keywordflow">return</span>;
01357     }
01358 
01359     <span class="comment">//</span>
01360     <span class="comment">// Allocate the required amount of memory in our heap</span>
01361     <span class="comment">// in the shared memory.</span>
01362     <span class="comment">//</span>
01363 
01364     buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0, SmbLength );
01365 
01366     <span class="keywordflow">if</span> ( buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01367         <span class="comment">// No free memory, this SMB is lost.  Record its loss.</span>
01368         <span class="comment">// Very unlikely in slow mode.</span>
01369         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a5">LOCK_INC_ID</a>(SmbsLost);
01370         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry );
01371 
01372         <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) {
01373             <span class="comment">//</span>
01374             <span class="comment">// Encourage some garbage collection.</span>
01375             <span class="comment">//</span>
01376             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NeedMemoryEvent), 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01377         }
01378 
01379         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>( Component );
01380         <span class="keywordflow">return</span>;
01381     }
01382 
01383     <span class="comment">//</span>
01384     <span class="comment">// Copy the SMB to shared memory pointed to by the queue entry,</span>
01385     <span class="comment">// keeping in mind whether it's in an Mdl or contiguous to begin</span>
01386     <span class="comment">// with, and also preserving the address of the real SMB...</span>
01387     <span class="comment">//</span>
01388 
01389     <span class="keywordflow">if</span> ( SmbMdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01390         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a44">SmbTraceCopyMdlContiguous</a>( buffer, SmbMdl, SmbLength );
01391         queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o3">SmbAddress</a> = SmbMdl;
01392     } <span class="keywordflow">else</span> {
01393         RtlCopyMemory( buffer, Smb, SmbLength );
01394         queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o3">SmbAddress</a> = Smb;
01395     }
01396 
01397     queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o1">SmbLength</a> = SmbLength;
01398     queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o2">Buffer</a> = buffer;
01399     queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o4">BufferNonPaged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01400 
01401     <span class="comment">//</span>
01402     <span class="comment">// In slow mode, we want to wait until the SMB has been eaten,</span>
01403     <span class="comment">// in fast mode, we don't want to pass the address of the real</span>
01404     <span class="comment">// SMB along, since the SMB is long gone by the time it gets</span>
01405     <span class="comment">// decoded and printed.</span>
01406     <span class="comment">//</span>
01407 
01408     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) {
01409         queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o5">WaitEvent</a> = &amp;WaitEvent;
01410     } <span class="keywordflow">else</span> {
01411         queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o5">WaitEvent</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01412         queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o3">SmbAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01413     }
01414 
01415     <span class="comment">//</span>
01416     <span class="comment">// ...queue the entry to the SmbTrace thread...</span>
01417     <span class="comment">//</span>
01418 
01419     <a class="code" href="../../d5/d8/ex_8h.html#a238">ExInterlockedInsertTailList</a>(
01420             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Queue),
01421             &amp;queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o0">ListEntry</a>,
01422             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueInterlock)
01423             );
01424 
01425     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(
01426             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueSemaphore),
01427             <a class="code" href="../../d7/d8/exboosts_8h.html#a16">SEMAPHORE_INCREMENT</a>,
01428             1,
01429             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01430             );
01431 
01432     <span class="comment">//</span>
01433     <span class="comment">// ...and wait for the SMB to be eaten, in slow mode.</span>
01434     <span class="comment">//</span>
01435 
01436     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) {
01437         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceCompleteSrv: Slow mode wait\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01438         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
01439             &amp;WaitEvent,
01440             <a class="code" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>,
01441             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01442             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01443             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01444             );
01445         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceCompleteSrv: Slow mode wait done\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01446     }
01447 
01448     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>( Component );
01449 
01450     <span class="keywordflow">return</span>;
01451 
01452 } <span class="comment">// SmbTraceCompleteSrv</span>
01453 
01454 
01455 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01456"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a51">01456</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a51">SmbTraceCompleteRdr</a> (
01457     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> SmbMdl,
01458     IN PVOID Smb,
01459     IN CLONG SmbLength
01460     )
01461 
01462 <span class="comment">/*++</span>
01463 <span class="comment"></span>
01464 <span class="comment">Routine Description:</span>
01465 <span class="comment"></span>
01466 <span class="comment">    Redirector version</span>
01467 <span class="comment"></span>
01468 <span class="comment">    Snapshot an SMB and export it to the SmbTrace application.  How</span>
01469 <span class="comment">    this happens is determined by which mode (fast or slow) SmbTracing</span>
01470 <span class="comment">    was requested in, and which context (DPC, Fsp or Fsd) the current</span>
01471 <span class="comment">    thread is executing in.</span>
01472 <span class="comment"></span>
01473 <span class="comment">    Fast mode: the SMB is copied into shared memory and an entry for it</span>
01474 <span class="comment">    is queued to the redirector SmbTrace thread, which asynchronously</span>
01475 <span class="comment">    passes SMBs to the app.  (When in DPC, the SMB is copied to non-paged</span>
01476 <span class="comment">    pool instead of shared memory, and the SmbTrace thread deals with</span>
01477 <span class="comment">    moving it to shared memory later.)  If there is insufficient memory</span>
01478 <span class="comment">    for anything (SMB, queue entry, etc.) the SMB is lost.</span>
01479 <span class="comment"></span>
01480 <span class="comment">    Slow mode: identical to Fast mode except that this thread waits</span>
01481 <span class="comment">    until the server SmbTrace thread signals that the app has finished</span>
01482 <span class="comment">    processing the SMB.  Because each thread waits until its SMB has</span>
01483 <span class="comment">    been completely processed, there is much less chance of running</span>
01484 <span class="comment">    out of any resources. If at DPC level, we behave exactly as in the</span>
01485 <span class="comment">    fast mode case, because it would be a Bad Thing to block this thread</span>
01486 <span class="comment">    at DPC level.</span>
01487 <span class="comment"></span>
01488 <span class="comment">    The SMB is either contained in SmbMdl, or at address Smb with length</span>
01489 <span class="comment">    SmbLength.</span>
01490 <span class="comment"></span>
01491 <span class="comment">Arguments:</span>
01492 <span class="comment"></span>
01493 <span class="comment">    SmbMdl - an Mdl containing the SMB.</span>
01494 <span class="comment"></span>
01495 <span class="comment">    Smb - a pointer to the SMB.</span>
01496 <span class="comment"></span>
01497 <span class="comment">    SmbLength - the length of the SMB.</span>
01498 <span class="comment"></span>
01499 <span class="comment">Return Value:</span>
01500 <span class="comment"></span>
01501 <span class="comment">    None</span>
01502 <span class="comment"></span>
01503 <span class="comment">--*/</span>
01504 
01505 {
01506     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a20">PSMBTRACE_QUEUE_ENTRY</a>  queueEntry;
01507     PVOID  buffer;
01508     BOOLEAN ProcessAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01509     BOOLEAN AtDpcLevel;
01510     SMBTRACE_COMPONENT Component = SMBTRACE_REDIRECTOR;
01511     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> WaitEvent;
01512 
01513     <span class="comment">//</span>
01514     <span class="comment">// This routine is redirector specific.</span>
01515     <span class="comment">//</span>
01516 
01517     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) == <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a> );
01518     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a23">SmbTraceActive</a>[SMBTRACE_REDIRECTOR] );
01519 
01520     <span class="comment">//</span>
01521     <span class="comment">// We want either an Mdl, or a pointer and a length, or occasionally,</span>
01522     <span class="comment">// a completely NULL response</span>
01523     <span class="comment">//</span>
01524 
01525     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ( SmbMdl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  &amp;&amp;  Smb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  &amp;&amp;  SmbLength != 0 )
01526          || ( SmbMdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  &amp;&amp;  Smb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  &amp;&amp;  SmbLength == 0 )
01527          || ( SmbMdl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  &amp;&amp;  Smb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  &amp;&amp;  SmbLength == 0 ) );
01528 
01529     <span class="comment">//</span>
01530     <span class="comment">// Ensure that SmbTrace really is still active and hence, the</span>
01531     <span class="comment">// shared memory is still around.</span>
01532     <span class="comment">//</span>
01533 
01534     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a36">SmbTraceReferenceHeap</a>( Component ) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
01535         <span class="keywordflow">return</span>;
01536     }
01537 
01538     <span class="comment">//</span>
01539     <span class="comment">// To avoid multiple system calls, we find out once and for all.</span>
01540     <span class="comment">//</span>
01541 
01542     AtDpcLevel = (BOOLEAN)(KeGetCurrentIrql() &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01543 
01544     <span class="comment">//</span>
01545     <span class="comment">// If the SMB is currently in an MDL, we don't yet have the length,</span>
01546     <span class="comment">// which we need to know how much memory to allocate.</span>
01547     <span class="comment">//</span>
01548 
01549     <span class="keywordflow">if</span> ( SmbMdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01550         SmbLength = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a43">SmbTraceMdlLength</a>(SmbMdl);
01551     }
01552 
01553     <span class="comment">//</span>
01554     <span class="comment">// If we are in slow mode, then we wait after queuing the SMB</span>
01555     <span class="comment">// to the SmbTrace thread.  If we are set for fast mode we</span>
01556     <span class="comment">// garbage collect in case of no memory.  If we're at DPC level,</span>
01557     <span class="comment">// we store the SMB in non-paged pool.</span>
01558     <span class="comment">//</span>
01559 
01560     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) {
01561         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;WaitEvent, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01562     }
01563 
01564     <span class="comment">//</span>
01565     <span class="comment">// allocate queue entry</span>
01566     <span class="comment">//</span>
01567 
01568     queueEntry = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
01569                      <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01570                      <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">SMBTRACE_QUEUE_ENTRY</a>),
01571                      'tbmS'
01572                      );
01573 
01574     <span class="keywordflow">if</span> ( queueEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01575         <span class="comment">// No free memory, this SMB is lost.  Record its loss.</span>
01576         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a5">LOCK_INC_ID</a>(SmbsLost);
01577         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>( Component );
01578         <span class="keywordflow">return</span>;
01579     }
01580 
01581     <span class="comment">//</span>
01582     <span class="comment">// allocate buffer for SMB, in non-paged pool or shared heap as</span>
01583     <span class="comment">// appropriate</span>
01584     <span class="comment">//</span>
01585 
01586     <span class="keywordflow">if</span> ( AtDpcLevel ) {
01587 
01588         buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, SmbLength, 'tbmS' );
01589         queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o4">BufferNonPaged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01590 
01591     } <span class="keywordflow">else</span> {
01592 
01593         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess) ) {
01594             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess));
01595             ProcessAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01596         }
01597 
01598         buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0, SmbLength );
01599         queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o4">BufferNonPaged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01600 
01601     }
01602 
01603     <span class="keywordflow">if</span> ( buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01604 
01605         <span class="keywordflow">if</span> ( ProcessAttached ) {
01606             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01607         }
01608 
01609         <span class="comment">// No free memory, this SMB is lost.  Record its loss.</span>
01610         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a5">LOCK_INC_ID</a>(SmbsLost);
01611 
01612         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode)) {
01613 
01614             <span class="comment">//</span>
01615             <span class="comment">// If it was shared memory we ran out of, encourage</span>
01616             <span class="comment">// some garbage collection.</span>
01617             <span class="comment">//</span>
01618             <span class="keywordflow">if</span> ( !queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o4">BufferNonPaged</a> ) {
01619                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NeedMemoryEvent), 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01620             }
01621         }
01622 
01623         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry );
01624         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>( Component );
01625         <span class="keywordflow">return</span>;
01626     }
01627 
01628     <span class="comment">//</span>
01629     <span class="comment">// Copy the SMB to shared or non-paged memory pointed to by the</span>
01630     <span class="comment">// queue entry, keeping in mind whether it's in an Mdl or contiguous</span>
01631     <span class="comment">// to begin with, and also preserving the address of the real SMB...</span>
01632     <span class="comment">//</span>
01633 
01634     <span class="keywordflow">if</span> ( SmbMdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01635         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a44">SmbTraceCopyMdlContiguous</a>( buffer, SmbMdl, SmbLength );
01636         queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o3">SmbAddress</a> = SmbMdl;
01637     } <span class="keywordflow">else</span> {
01638         RtlCopyMemory( buffer, Smb, SmbLength );
01639         queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o3">SmbAddress</a> = Smb;
01640     }
01641 
01642     <span class="keywordflow">if</span> ( ProcessAttached ) {
01643         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01644     }
01645 
01646     queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o1">SmbLength</a> = SmbLength;
01647     queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o2">Buffer</a> = buffer;
01648 
01649     <span class="comment">//</span>
01650     <span class="comment">// In slow mode, we want to wait until the SMB has been eaten,</span>
01651     <span class="comment">// in fast mode, we don't want to pass the address of the real</span>
01652     <span class="comment">// SMB along, since the SMB is long gone by the time it gets</span>
01653     <span class="comment">// decoded and printed.</span>
01654     <span class="comment">//</span>
01655 
01656     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) &amp;&amp; !AtDpcLevel ) {
01657         queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o5">WaitEvent</a> = &amp;WaitEvent;
01658     } <span class="keywordflow">else</span> {
01659         queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o5">WaitEvent</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01660         queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o3">SmbAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01661     }
01662 
01663     <span class="comment">//</span>
01664     <span class="comment">// ...queue the entry to the SmbTrace thread...</span>
01665     <span class="comment">//</span>
01666 
01667     <a class="code" href="../../d5/d8/ex_8h.html#a238">ExInterlockedInsertTailList</a>(
01668             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Queue),
01669             &amp;queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o0">ListEntry</a>,
01670             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueInterlock)
01671             );
01672 
01673     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(
01674             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueSemaphore),
01675             <a class="code" href="../../d7/d8/exboosts_8h.html#a16">SEMAPHORE_INCREMENT</a>,
01676             1,
01677             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01678             );
01679 
01680     <span class="comment">//</span>
01681     <span class="comment">// ...and wait for the SMB to be eaten, in slow mode.</span>
01682     <span class="comment">//</span>
01683 
01684     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) &amp;&amp; !AtDpcLevel ) {
01685         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceCompleteRdr: Slow mode wait\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01686         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
01687             &amp;WaitEvent,
01688             <a class="code" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>,
01689             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01690             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01691             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01692             );
01693         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceCompleteRdr: Slow mode wait done\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01694     }
01695 
01696     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>( Component );
01697 
01698     <span class="keywordflow">return</span>;
01699 
01700 } <span class="comment">// SmbTraceCompleteRdr</span>
01701 
01702 
01703 <span class="comment">//</span>
01704 <span class="comment">// Internal routines</span>
01705 <span class="comment">//</span>
01706 
01707 
01708 BOOLEAN
<a name="l01709"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a36">01709</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a36">SmbTraceReferenceHeap</a>(
01710     IN SMBTRACE_COMPONENT Component
01711     )
01712 
01713 <span class="comment">/*++</span>
01714 <span class="comment"></span>
01715 <span class="comment">Routine Description:</span>
01716 <span class="comment"></span>
01717 <span class="comment">    This routine references the SmbTrace shared memory heap,</span>
01718 <span class="comment">    ensuring it isn't disposed of while caller is using it.</span>
01719 <span class="comment"></span>
01720 <span class="comment">Arguments:</span>
01721 <span class="comment"></span>
01722 <span class="comment">    Component - Context from which we're called: server or redirector</span>
01723 <span class="comment"></span>
01724 <span class="comment">Return Value:</span>
01725 <span class="comment"></span>
01726 <span class="comment">    BOOLEAN - TRUE if SmbTrace is still active, and hence</span>
01727 <span class="comment">              heap exists and was successfully referenced.</span>
01728 <span class="comment">              FALSE otherwise.</span>
01729 <span class="comment"></span>
01730 <span class="comment">--*/</span>
01731 
01732 {
01733     BOOLEAN retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  <span class="comment">// assume we'll get it</span>
01734     KIRQL OldIrql;
01735 
01736     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a3">ACQUIRE_SPIN_LOCK</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock), &amp;OldIrql );
01737 
01738     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) != <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a> ) {
01739         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01740     } <span class="keywordflow">else</span> {
01741         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount) &gt; 0 );
01742         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount)++;
01743         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceReferenceHeap: Count now %lx\n"</span>,
01744             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName),
01745             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount) ));
01746     }
01747 
01748     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a4">RELEASE_SPIN_LOCK</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock), OldIrql );
01749 
01750     <span class="keywordflow">return</span> retval;
01751 
01752 } <span class="comment">// SmbTraceReferenceHeap</span>
01753 
<a name="l01754"></a><a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">01754</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">_TRACE_DEREFERENCE_ITEM</a> {
<a name="l01755"></a><a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html#o0">01755</a>     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> <a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html#o0">WorkItem</a>;
<a name="l01756"></a><a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html#o1">01756</a>     SMBTRACE_COMPONENT <a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html#o1">Component</a>;
01757 } <a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">TRACE_DEREFERENCE_ITEM</a>, *<a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">PTRACE_DEREFERENCE_ITEM</a>;
01758 
01759 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01760"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a45">01760</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a45">SmbTraceDeferredDereferenceHeap</a>(
01761     IN PVOID Context
01762     )
01763 <span class="comment">/*++</span>
01764 <span class="comment"></span>
01765 <span class="comment">Routine Description:</span>
01766 <span class="comment"></span>
01767 <span class="comment">    If a caller dereferences a heap to 0 from DPC_LEVEL, this routine will</span>
01768 <span class="comment">    be called in a system thread to complete the dereference at task time.</span>
01769 <span class="comment"></span>
01770 <span class="comment">Arguments:</span>
01771 <span class="comment"></span>
01772 <span class="comment">    Component - Context from which we're called: server or redirector</span>
01773 <span class="comment"></span>
01774 <span class="comment">Return Value:</span>
01775 <span class="comment"></span>
01776 <span class="comment">    None</span>
01777 <span class="comment"></span>
01778 <span class="comment">--*/</span>
01779 
01780 {
01781     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a28">PTRACE_DEREFERENCE_ITEM</a> WorkItem = Context;
01782     SMBTRACE_COMPONENT Component = WorkItem-&gt;<a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html#o1">Component</a>;
01783 
01784     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01785 
01786     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WorkItem);
01787 
01788     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>(Component);
01789 
01790 }
01791 
01792 
01793 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01794"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">01794</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>(
01795     IN SMBTRACE_COMPONENT Component
01796     )
01797 
01798 <span class="comment">/*++</span>
01799 <span class="comment"></span>
01800 <span class="comment">Routine Description:</span>
01801 <span class="comment"></span>
01802 <span class="comment">    This routine dereferences the SmbTrace shared memory heap,</span>
01803 <span class="comment">    disposing of it when the reference count is zero.</span>
01804 <span class="comment"></span>
01805 <span class="comment">Arguments:</span>
01806 <span class="comment"></span>
01807 <span class="comment">    Component - Context from which we're called: server or redirector</span>
01808 <span class="comment"></span>
01809 <span class="comment">Return Value:</span>
01810 <span class="comment"></span>
01811 <span class="comment">    None</span>
01812 <span class="comment"></span>
01813 <span class="comment">--*/</span>
01814 
01815 {
01816     ULONG oldCount;
01817     KIRQL OldIrql;
01818 
01819     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a3">ACQUIRE_SPIN_LOCK</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock), &amp;OldIrql );
01820 
01821     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount) &gt; 1) {
01822         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount) --;
01823 
01824         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceDereferenceHeap: Count now %lx\n"</span>,
01825             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName),
01826             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount) ));
01827 
01828         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a4">RELEASE_SPIN_LOCK</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock), OldIrql );
01829 
01830         <span class="keywordflow">return</span>;
01831     }
01832 
01833     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a4">RELEASE_SPIN_LOCK</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock), OldIrql );
01834 
01835     <span class="comment">//</span>
01836     <span class="comment">//  If we are executing at DPC_LEVEL, we cannot dereference the heap</span>
01837     <span class="comment">//  to 0.</span>
01838     <span class="comment">//</span>
01839 
01840     <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
01841         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a28">PTRACE_DEREFERENCE_ITEM</a> WorkItem;
01842 
01843         WorkItem = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">TRACE_DEREFERENCE_ITEM</a>), 'tbmS');
01844 
01845         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(&amp;WorkItem-&gt;<a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html#o0">WorkItem</a>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a45">SmbTraceDeferredDereferenceHeap</a>, WorkItem);
01846         WorkItem-&gt;<a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html#o1">Component</a> = Component;
01847 
01848         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(&amp;WorkItem-&gt;<a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html#o0">WorkItem</a>, <a class="code" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>);
01849 
01850         <span class="keywordflow">return</span>;
01851 
01852     }
01853 
01854     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a3">ACQUIRE_SPIN_LOCK</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock), &amp;OldIrql );
01855 
01856     oldCount = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount)--;
01857 
01858     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceDereferenceHeap: Count now %lx\n"</span>,
01859         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName),
01860         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount) ));
01861 
01862     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a4">RELEASE_SPIN_LOCK</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock), OldIrql );
01863 
01864     <span class="keywordflow">if</span> ( oldCount == 1 ) {
01865 
01866         <span class="comment">//</span>
01867         <span class="comment">// Free the section, release the handles and such.</span>
01868         <span class="comment">//</span>
01869 
01870         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a38">SmbTraceDisconnect</a>( Component );
01871     }
01872 
01873     <span class="keywordflow">return</span>;
01874 
01875 } <span class="comment">// SmbTraceDereferenceHeap</span>
01876 
01877 
01878 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01879"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a38">01879</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a38">SmbTraceDisconnect</a> (
01880     IN SMBTRACE_COMPONENT Component
01881     )
01882 
01883 <span class="comment">/*++</span>
01884 <span class="comment"></span>
01885 <span class="comment">Routine Description:</span>
01886 <span class="comment"></span>
01887 <span class="comment">    This routine reverses all the effects of SmbTraceStart. Mostly,</span>
01888 <span class="comment">    it just needs to close certain handles to do this.</span>
01889 <span class="comment"></span>
01890 <span class="comment">Arguments:</span>
01891 <span class="comment"></span>
01892 <span class="comment">    Component - Context from which we're called: server or redirector</span>
01893 <span class="comment"></span>
01894 <span class="comment">Return Value:</span>
01895 <span class="comment"></span>
01896 <span class="comment">    None - always works</span>
01897 <span class="comment"></span>
01898 <span class="comment">--*/</span>
01899 
01900 {
01901     BOOLEAN ProcessAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01902 
01903     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01904 
01905     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess)) {
01906         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess));
01907         ProcessAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01908 
01909     }
01910 
01911 
01912     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01913         <span class="comment">// Worker thread may be blocked on this, so we set it first</span>
01914         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceDisconnect: Signal DoneSmbEvent, handle %x, process %x.\n"</span>,
01915                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()));
01916         ZwSetEvent( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01917 
01918         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceDisconnect: Close DoneSmbEvent, handle %x, process %x.\n"</span>,
01919                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()));
01920         ZwClose( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent) );
01921         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01922     }
01923 
01924     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NewSmbEvent) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01925         ZwClose( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NewSmbEvent) );
01926         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NewSmbEvent) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01927     }
01928 
01929     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01930         <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a16">RtlDestroyHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap) );
01931         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01932     }
01933 
01934     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SectionHandle) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01935         ZwClose( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SectionHandle) );
01936         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SectionHandle) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01937     }
01938 
01939     <span class="keywordflow">if</span> (ProcessAttached) {
01940         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01941     }
01942 
01943     <span class="keywordflow">return</span>;
01944 
01945 } <span class="comment">// SmbTraceDisconnect</span>
01946 
01947 
01948 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01949"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a39">01949</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a39">SmbTraceEmptyQueue</a> (
01950     IN SMBTRACE_COMPONENT Component
01951     )
01952 
01953 <span class="comment">/*++</span>
01954 <span class="comment"></span>
01955 <span class="comment">Routine Description:</span>
01956 <span class="comment"></span>
01957 <span class="comment">    This routine empties the queue of unprocessed SMBs.</span>
01958 <span class="comment"></span>
01959 <span class="comment">Arguments:</span>
01960 <span class="comment"></span>
01961 <span class="comment">    Component - Context from which we're called: server or redirector</span>
01962 <span class="comment"></span>
01963 <span class="comment">Return Value:</span>
01964 <span class="comment"></span>
01965 <span class="comment">    None - always works</span>
01966 <span class="comment"></span>
01967 <span class="comment">--*/</span>
01968 
01969 {
01970     PLIST_ENTRY            listEntry;
01971     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a20">PSMBTRACE_QUEUE_ENTRY</a>  queueEntry;
01972 
01973     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01974 
01975     <span class="keywordflow">while</span> ( ( listEntry = <a class="code" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList</a>(
01976                               &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Queue),
01977                               &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueInterlock)
01978                               )
01979             ) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01980     ) {
01981         queueEntry = CONTAINING_RECORD(
01982                           listEntry,
01983                           <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">SMBTRACE_QUEUE_ENTRY</a>,
01984                           ListEntry
01985                           );
01986 
01987         <span class="comment">//</span>
01988         <span class="comment">// If data for this entry is in non-paged pool, free it too.</span>
01989         <span class="comment">// This only ever happens in the redirector.</span>
01990         <span class="comment">//</span>
01991 
01992         <span class="keywordflow">if</span> ( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o4">BufferNonPaged</a> ) {
01993 
01994             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Component == SMBTRACE_REDIRECTOR );
01995 
01996             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o2">Buffer</a> );
01997         }
01998 
01999         <span class="comment">//</span>
02000         <span class="comment">// If a worker thread is waiting on this event, let it go.</span>
02001         <span class="comment">// This only ever happens in slow mode.</span>
02002         <span class="comment">//</span>
02003 
02004         <span class="keywordflow">if</span> ( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o5">WaitEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02005 
02006             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
02007 
02008             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o5">WaitEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02009         }
02010 
02011         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry );
02012     }
02013 
02014     <span class="keywordflow">return</span>;
02015 
02016 } <span class="comment">// SmbTraceEmptyQueue</span>
02017 
02018 
02019 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02020"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a40">02020</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a40">SmbTraceThreadEntry</a> (
02021     IN PVOID Context
02022     )
02023 
02024 <span class="comment">/*++</span>
02025 <span class="comment"></span>
02026 <span class="comment">Routine Description:</span>
02027 <span class="comment"></span>
02028 <span class="comment">    This routine is the entry point of the SmbTrace thread for the server/</span>
02029 <span class="comment">    redirector.  It is started by SmbTraceStart. This thread loops</span>
02030 <span class="comment">    continuously until the client SmbTrace dies or another SmbTrace sends</span>
02031 <span class="comment">    an FsCtl to stop the trace.</span>
02032 <span class="comment"></span>
02033 <span class="comment">Arguments:</span>
02034 <span class="comment"></span>
02035 <span class="comment">    Context - pointer to context block containing component from which</span>
02036 <span class="comment">              we're called: server or redirector</span>
02037 <span class="comment"></span>
02038 <span class="comment">Return Value:</span>
02039 <span class="comment"></span>
02040 <span class="comment">    None</span>
02041 <span class="comment"></span>
02042 <span class="comment">--*/</span>
02043 
02044 <span class="comment">// we wait for termination, work-to-do and need-memory events</span>
02045 #define <a class="code" href="../../d4/d9/smbtrsup_8c.html#a9">NUMBER_OF_BLOCKING_OBJECTS</a> 4
02046 
02047 <span class="comment">// keep these definitions in sync</span>
02048 
02049 <span class="preprocessor">#define INDEX_WAIT_TERMINATIONEVENT     0</span>
02050 <span class="preprocessor"></span><span class="preprocessor">#define INDEX_WAIT_APPTERMINATIONEVENT  1</span>
02051 <span class="preprocessor"></span><span class="preprocessor">#define INDEX_WAIT_NEEDMEMORYEVENT      2</span>
02052 <span class="preprocessor"></span><span class="preprocessor">#define INDEX_WAIT_QUEUESEMAPHORE       3</span>
02053 <span class="preprocessor"></span>
02054 <span class="preprocessor">#define STATUS_WAIT_TERMINATIONEVENT    STATUS_WAIT_0</span>
02055 <span class="preprocessor"></span><span class="preprocessor">#define STATUS_WAIT_APPTERMINATIONEVENT STATUS_WAIT_1</span>
02056 <span class="preprocessor"></span><span class="preprocessor">#define STATUS_WAIT_NEEDMEMORYEVENT     STATUS_WAIT_2</span>
02057 <span class="preprocessor"></span><span class="preprocessor">#define STATUS_WAIT_QUEUESEMAPHORE      STATUS_WAIT_3</span>
02058 <span class="preprocessor"></span>
02059 {
02060     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02061     PLIST_ENTRY listEntry;
02062     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a20">PSMBTRACE_QUEUE_ENTRY</a>    queueEntry;
02063     PVOID buffer;
02064     PVOID waitObjects[<a class="code" href="../../d4/d9/smbtrsup_8c.html#a9">NUMBER_OF_BLOCKING_OBJECTS</a>];
02065     SMBTRACE_COMPONENT Component;
02066     BOOLEAN Looping;
02067 
02068 <span class="preprocessor">#if NUMBER_OF_BLOCKING_OBJECTS &gt; THREAD_WAIT_OBJECTS</span>
02069 <span class="preprocessor"></span>    <span class="comment">//</span>
02070     <span class="comment">// If we try to wait on too many objects, we need to allocate</span>
02071     <span class="comment">// our own wait blocks.</span>
02072     <span class="comment">//</span>
02073 
02074     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a> waitBlocks[<a class="code" href="../../d4/d9/smbtrsup_8c.html#a9">NUMBER_OF_BLOCKING_OBJECTS</a>];
02075 <span class="preprocessor">#endif</span>
02076 <span class="preprocessor"></span>
02077     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02078 
02079     <span class="comment">//</span>
02080     <span class="comment">// Context is really just the component</span>
02081     <span class="comment">//</span>
02082     Component = (SMBTRACE_COMPONENT)(UINT_PTR)Context;
02083 
02084     <span class="comment">//</span>
02085     <span class="comment">// Initialize the queue.</span>
02086     <span class="comment">//</span>
02087 
02088     InitializeListHead(    &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Queue) );
02089     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(  &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueInterlock) );
02090     <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueSemaphore), 0, 0x7FFFFFFF );
02091 
02092     <span class="comment">//</span>
02093     <span class="comment">// Set up the array of objects to wait on.  We wait (in order)</span>
02094     <span class="comment">// for our termination event, the appliction termination event,</span>
02095     <span class="comment">// a no shared memory event or an SMB request to show up in the</span>
02096     <span class="comment">// SmbTrace queue.</span>
02097     <span class="comment">//</span>
02098 
02099     waitObjects[<a class="code" href="../../d4/d9/smbtrsup_8c.html#a10">INDEX_WAIT_TERMINATIONEVENT</a>]    = &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminationEvent);
02100     waitObjects[<a class="code" href="../../d4/d9/smbtrsup_8c.html#a11">INDEX_WAIT_APPTERMINATIONEVENT</a>] = &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(AppTerminationEvent);
02101     waitObjects[<a class="code" href="../../d4/d9/smbtrsup_8c.html#a12">INDEX_WAIT_NEEDMEMORYEVENT</a>]     = &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NeedMemoryEvent);
02102     waitObjects[<a class="code" href="../../d4/d9/smbtrsup_8c.html#a13">INDEX_WAIT_QUEUESEMAPHORE</a>]      = &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueSemaphore);
02103 
02104     <span class="comment">//</span>
02105     <span class="comment">// No SMBs have been lost yet, and this thread is the first user</span>
02106     <span class="comment">// of the shared memory.  It's also a special user in that it gets</span>
02107     <span class="comment">// access before TraceState == TraceRunning, a requirement for all</span>
02108     <span class="comment">// subsequent referencers.</span>
02109     <span class="comment">//</span>
02110 
02111     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SmbsLost) = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02112     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount) = 1;
02113 
02114     <span class="comment">//</span>
02115     <span class="comment">// Signal to the FSP that we are ready to start capturing SMBs.</span>
02116     <span class="comment">//</span>
02117 
02118     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ActiveEvent), 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02119 
02120     <span class="comment">//</span>
02121     <span class="comment">// Main loop, executed until the thread is terminated.</span>
02122     <span class="comment">//</span>
02123 
02124     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceThread: Tracing started.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
02125 
02126     Looping = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02127     <span class="keywordflow">while</span>( Looping ) {
02128 
02129         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceThread: WaitForMultiple.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
02130         status = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(
02131                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a9">NUMBER_OF_BLOCKING_OBJECTS</a>,
02132                     &amp;waitObjects[0],
02133                     WaitAny,
02134                     <a class="code" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>,
02135                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02136                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02137                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02138 #<span class="keywordflow">if</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a9">NUMBER_OF_BLOCKING_OBJECTS</a> &gt; <a class="code" href="../../d4/d9/ke_8h.html#a6">THREAD_WAIT_OBJECTS</a>
02139                     &amp;waitBlocks[0]
02140 #<span class="keywordflow">else</span>
02141                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02142 #endif
02143                     );
02144 
02145         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
02146             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
02147                 <span class="stringliteral">"%s!SmbTraceThreadEntry: KeWaitForMultipleObjectsfailed: %X\n"</span>,
02148                 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
02149         } <span class="keywordflow">else</span> {
02150             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
02151                 <span class="stringliteral">"%s!SmbTraceThreadEntry: %lx\n"</span>,
02152                 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
02153         }
02154 
02155         <span class="keywordflow">switch</span>( status ) {
02156 
02157         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a14">STATUS_WAIT_TERMINATIONEVENT</a>:
02158 
02159             <span class="comment">//</span>
02160             <span class="comment">// Stop looping, and then proceed to clean up and die.</span>
02161             <span class="comment">//</span>
02162 
02163             Looping = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02164             <span class="keywordflow">break</span>;
02165 
02166         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a15">STATUS_WAIT_APPTERMINATIONEVENT</a>:
02167 
02168             <span class="comment">//  Turn off the event so we don't go in a tight loop</span>
02169             <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>(&amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(AppTerminationEvent));
02170 
02171             <span class="comment">//</span>
02172             <span class="comment">// Inform the app that it is time to die.  The NULL SMB</span>
02173             <span class="comment">// sent here may not be the next to be processed by the</span>
02174             <span class="comment">// app, but the ApplicationStop bit will be detected</span>
02175             <span class="comment">// immediately.</span>
02176             <span class="comment">//</span>
02177 
02178             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;ApplicationStop = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02179             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a42">SmbTraceToClient</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, Component );
02180 
02181             <span class="keywordflow">break</span>;
02182 
02183         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a16">STATUS_WAIT_NEEDMEMORYEVENT</a>:
02184 
02185             <span class="comment">//  Turn off the event so we don't go in a loop.</span>
02186             <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>(&amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NeedMemoryEvent));
02187             <span class="comment">//</span>
02188             <span class="comment">// Do a garbage collection, freeing all memory that is</span>
02189             <span class="comment">// allocated in the shared memory but that has been read</span>
02190             <span class="comment">// by the client.</span>
02191             <span class="comment">//</span>
02192 
02193             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a41">SmbTraceFreeMemory</a>( Component );
02194 
02195             <span class="keywordflow">break</span>;
02196 
02197         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a17">STATUS_WAIT_QUEUESEMAPHORE</a>:
02198 
02199             <span class="comment">//</span>
02200             <span class="comment">// If any get through once we've gone into AppWaiting</span>
02201             <span class="comment">// state, don't bother sending them on, they're not</span>
02202             <span class="comment">// going to get processed.</span>
02203             <span class="comment">//</span>
02204 
02205             <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) == <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a33">TraceAppWaiting</a> ) {
02206                 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a39">SmbTraceEmptyQueue</a>( Component );
02207                 <span class="keywordflow">break</span>;
02208             }
02209 
02210             <span class="comment">//</span>
02211             <span class="comment">// Remove the first element in the our queue.  A</span>
02212             <span class="comment">// work item is represented by our header followed by</span>
02213             <span class="comment">// an SMB. We must free the entry after we are done</span>
02214             <span class="comment">// with it.</span>
02215             <span class="comment">//</span>
02216 
02217             listEntry = <a class="code" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList</a>(
02218                             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Queue),
02219                             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueInterlock)
02220                             );
02221 
02222             <span class="keywordflow">if</span> ( listEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02223 
02224                 <span class="comment">//</span>
02225                 <span class="comment">// Get the address of the queue entry.</span>
02226                 <span class="comment">//</span>
02227 
02228                 queueEntry = CONTAINING_RECORD(
02229                                   listEntry,
02230                                   <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">SMBTRACE_QUEUE_ENTRY</a>,
02231                                   ListEntry
02232                                   );
02233 
02234                 <span class="comment">//</span>
02235                 <span class="comment">// If the data is in non-paged pool, move it to shared</span>
02236                 <span class="comment">// memory and free the non-paged pool before passing</span>
02237                 <span class="comment">// the SMB to the client.  Note that in this case,</span>
02238                 <span class="comment">// there's no need to signal anyone.  They ain't waiting.</span>
02239                 <span class="comment">//</span>
02240 
02241                 <span class="keywordflow">if</span> ( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o4">BufferNonPaged</a> ) {
02242 
02243                     <span class="comment">//</span>
02244                     <span class="comment">// Server never uses non-paged pool.</span>
02245                     <span class="comment">//</span>
02246 
02247                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Component != SMBTRACE_SERVER );
02248 
02249                     buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0,
02250                                               queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o1">SmbLength</a> );
02251 
02252                     <span class="keywordflow">if</span> ( buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02253 
02254                         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a5">LOCK_INC_ID</a>(SmbsLost);
02255 
02256                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o2">Buffer</a> );
02257                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry );
02258 
02259                         <span class="keywordflow">break</span>;
02260 
02261                     }
02262 
02263                     RtlCopyMemory( buffer, queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o2">Buffer</a>,
02264                                    queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o1">SmbLength</a> );
02265 
02266                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o2">Buffer</a> );
02267 
02268                     <span class="comment">//</span>
02269                     <span class="comment">// Send it off.  Because the original SMB is long</span>
02270                     <span class="comment">// dead, we don't pass its real address along (not</span>
02271                     <span class="comment">// that we have it, anyway.)</span>
02272                     <span class="comment">//</span>
02273 
02274                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o3">SmbAddress</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02275 
02276                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a42">SmbTraceToClient</a>(
02277                             buffer,
02278                             queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o1">SmbLength</a>,
02279                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02280                             Component
02281                             );
02282 
02283                 } <span class="keywordflow">else</span> {
02284 
02285                     <span class="comment">//</span>
02286                     <span class="comment">// Enter the SMB into the table and send it to the</span>
02287                     <span class="comment">// client. Can block in slow mode.  When it does so, we'll</span>
02288                     <span class="comment">// signal the applicable thread.</span>
02289                     <span class="comment">//</span>
02290 
02291                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a42">SmbTraceToClient</a>(
02292                             queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o2">Buffer</a>,
02293                             queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o1">SmbLength</a>,
02294                             queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o3">SmbAddress</a>,
02295                             Component
02296                             );
02297 
02298                     <span class="keywordflow">if</span> ( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o5">WaitEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02299                         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o5">WaitEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02300                     }
02301                 }
02302 
02303                 <span class="comment">//</span>
02304                 <span class="comment">// Now, we must free the queue entry.</span>
02305                 <span class="comment">//</span>
02306 
02307                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry );
02308 
02309             }
02310 
02311             <span class="keywordflow">break</span>;
02312 
02313         <span class="keywordflow">default</span>:
02314             <span class="keywordflow">break</span>;
02315         }
02316 
02317     }
02318 
02319     <span class="comment">//</span>
02320     <span class="comment">// Clean up!</span>
02321     <span class="comment">//</span>
02322     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceThread: Tracing clean up.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
02323 
02324     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>( Component );
02325 
02326     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a39">SmbTraceEmptyQueue</a>( Component );
02327 
02328     <span class="comment">//</span>
02329     <span class="comment">// Signal to SmbTraceStop that we're dying.</span>
02330     <span class="comment">//</span>
02331 
02332     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceThread: Tracing terminated.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
02333 
02334     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminatedEvent), 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02335 
02336     <span class="comment">//</span>
02337     <span class="comment">// Kill this thread.</span>
02338     <span class="comment">//</span>
02339 
02340     status = <a class="code" href="../../d8/d0/psdelete_8c.html#a7">PsTerminateSystemThread</a>( STATUS_SUCCESS );
02341 
02342     <span class="comment">// Shouldn't get here</span>
02343     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
02344         <span class="stringliteral">"%s!SmbTraceThreadEntry: PsTerminateSystemThread() failed: %X\n"</span>,
02345         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
02346 
02347 } <span class="comment">// SmbTraceThreadEntry</span>
02348 
02349 <span class="comment">// constant only of interest while constructing waitObject arrays</span>
02350 <span class="comment">// in SmbTraceThreadEntry</span>
02351 <span class="preprocessor">#undef NUMBER_OF_BLOCKING_OBJECTS</span>
02352 <span class="preprocessor"></span>
02353 
02354 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02355"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a41">02355</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a41">SmbTraceFreeMemory</a> (
02356     IN SMBTRACE_COMPONENT Component
02357     )
02358 
02359 <span class="comment">/*++</span>
02360 <span class="comment"></span>
02361 <span class="comment">Routine Description:</span>
02362 <span class="comment"></span>
02363 <span class="comment">    This procedure frees any memory that may have been allocated to an</span>
02364 <span class="comment">    SMB that the client has already consumed. It does not alter table</span>
02365 <span class="comment">    entries, except to record that the memory buffer has been cleared.</span>
02366 <span class="comment">    This routinue is not espectally fast, it should not be called often,</span>
02367 <span class="comment">    only when needed.</span>
02368 <span class="comment"></span>
02369 <span class="comment">Arguments:</span>
02370 <span class="comment"></span>
02371 <span class="comment">    Component - Context from which we're called: server or redirector</span>
02372 <span class="comment"></span>
02373 <span class="comment">Return Value:</span>
02374 <span class="comment"></span>
02375 <span class="comment">    NTSTATUS - result of operation.</span>
02376 <span class="comment"></span>
02377 <span class="comment">--*/</span>
02378 
02379 {
02380     PVOID    buffer;
02381     PSMBTRACE_TABLE_ENTRY    tableEntry;
02382     ULONG    tableIndex;
02383 
02384     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02385 
02386     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceFreeMemory: Called for garbage collection.\n"</span>,
02387               <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
02388 
02389     <span class="comment">//</span>
02390     <span class="comment">// No free memory in the heap, perhaps we can free some by freeing</span>
02391     <span class="comment">// memory in old table entries. This is expensive for time.</span>
02392     <span class="comment">//</span>
02393 
02394     tableIndex = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;NextFree;
02395 
02396     <span class="keywordflow">while</span>( tableIndex != <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;HighestConsumed ) {
02397 
02398         tableEntry = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Table) + tableIndex;
02399 
02400         <span class="comment">//</span>
02401         <span class="comment">// Check if this table entry has been used but its memory has not</span>
02402         <span class="comment">// been freed yet. If so, free it.</span>
02403         <span class="comment">//</span>
02404 
02405         <span class="keywordflow">if</span> ( tableEntry-&gt;BufferOffset != 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> ) {
02406 
02407             buffer = (PVOID)( (ULONG_PTR)tableEntry-&gt;BufferOffset
02408                         + (ULONG_PTR)<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase) );
02409 
02410             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0, buffer);
02411 
02412             tableEntry-&gt;BufferOffset = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02413         }
02414 
02415 
02416         tableIndex = (tableIndex + 1) % <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableSize);
02417     }
02418 
02419     <span class="keywordflow">return</span>( STATUS_SUCCESS );
02420 
02421 } <span class="comment">// SmbTraceFreeMemory</span>
02422 
02423 
02424 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02425"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a42">02425</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a42">SmbTraceToClient</a>(
02426     IN PVOID Smb,
02427     IN CLONG SmbLength,
02428     IN PVOID SmbAddress,
02429     IN SMBTRACE_COMPONENT Component
02430     )
02431 
02432 <span class="comment">/*++</span>
02433 <span class="comment"></span>
02434 <span class="comment">Routine Description:</span>
02435 <span class="comment"></span>
02436 <span class="comment">    Enter an SMB already found in shared memory into the table.  Set</span>
02437 <span class="comment">    an event for the client.  If there is no table space, the SMB is</span>
02438 <span class="comment">    not saved.  If in slow mode, wait for the client to finish with</span>
02439 <span class="comment">    and then free the memory occupied by the SMB.</span>
02440 <span class="comment"></span>
02441 <span class="comment">Arguments:</span>
02442 <span class="comment"></span>
02443 <span class="comment">    Smb - a pointer to the SMB (which is ALREADY in shared memory).</span>
02444 <span class="comment">          Can be NULL, indicating no new SMB is to be added, but the</span>
02445 <span class="comment">          application is to be signalled anyway.</span>
02446 <span class="comment"></span>
02447 <span class="comment">    SmbLength - the length of the SMB.</span>
02448 <span class="comment"></span>
02449 <span class="comment">    SmbAddress - the address of the real SMB, not in shared memory.</span>
02450 <span class="comment"></span>
02451 <span class="comment">    Component - Context from which we're called: server or redirector</span>
02452 <span class="comment"></span>
02453 <span class="comment">Return Value:</span>
02454 <span class="comment"></span>
02455 <span class="comment">    None</span>
02456 <span class="comment"></span>
02457 <span class="comment">--*/</span>
02458 
02459 {
02460     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02461     PVOID    buffer;
02462     PSMBTRACE_TABLE_ENTRY    tableEntry;
02463     ULONG    tableIndex;
02464 
02465     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02466 
02467     <span class="comment">//</span>
02468     <span class="comment">//  Reset DoneSmbEvent so we can determine when the request has been processed</span>
02469     <span class="comment">//</span>
02470 
02471     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) {
02472         <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> DoneEvent;
02473 
02474         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceToClient: Reset DoneSmbEvent, handle %x, process %x.\n"</span>,
02475                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()));
02476 
02477         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent),
02478                                             EVENT_MODIFY_STATE,
02479                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02480                                             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02481                                             (PVOID *)&amp;DoneEvent,
02482                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02483                                             );
02484 
02485         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) );
02486 
02487         <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>(DoneEvent);
02488 
02489         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DoneEvent);
02490     }
02491 
02492     <span class="keywordflow">if</span> (Smb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02493 
02494         <span class="comment">//</span>
02495         <span class="comment">// See if there is room in the table for a pointer to our SMB.</span>
02496         <span class="comment">//</span>
02497 
02498         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;NextFree == <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;HighestConsumed ) {
02499             <span class="comment">// Tough luck. No memory in the table, this SMB is lost.</span>
02500             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a5">LOCK_INC_ID</a>( SmbsLost );
02501             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0, Smb );
02502             <span class="keywordflow">return</span>;
02503         }
02504 
02505         tableIndex = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;NextFree;
02506 
02507         tableEntry = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Table) + tableIndex;
02508 
02509         <span class="comment">//</span>
02510         <span class="comment">// Record the number of SMBs that were lost before this one and</span>
02511         <span class="comment">// (maybe) zero the count for the next one.</span>
02512         <span class="comment">//</span>
02513 
02514         tableEntry-&gt;NumberMissed = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SmbsLost);
02515 
02516         <span class="keywordflow">if</span> ( tableEntry-&gt;NumberMissed != 0 ) {
02517             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a6">LOCK_ZERO_ID</a>(SmbsLost);
02518         }
02519 
02520         <span class="comment">//</span>
02521         <span class="comment">// Check if this table entry has been used but its memory has not</span>
02522         <span class="comment">// been freed yet. If so, free it.</span>
02523         <span class="comment">//</span>
02524         <span class="keywordflow">if</span> ( tableEntry-&gt;BufferOffset != 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> ) {
02525 
02526             buffer = (PVOID)( (ULONG_PTR)tableEntry-&gt;BufferOffset
02527                         + (ULONG_PTR)<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase) );
02528 
02529             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0, buffer);
02530             tableEntry-&gt;BufferOffset = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02531         }
02532 
02533         <span class="comment">//</span>
02534         <span class="comment">// Record the location and size of this SMB in the table.</span>
02535         <span class="comment">//</span>
02536 
02537         tableEntry-&gt;BufferOffset = (ULONG)((ULONG_PTR)Smb - (ULONG_PTR)<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase));
02538         tableEntry-&gt;SmbLength = SmbLength;
02539 
02540         <span class="comment">//</span>
02541         <span class="comment">// Record the real address of the actual SMB (i.e. not the shared</span>
02542         <span class="comment">// memory copy) if it's available.</span>
02543         <span class="comment">//</span>
02544 
02545         tableEntry-&gt;SmbAddress = SmbAddress;
02546 
02547         <span class="comment">//</span>
02548         <span class="comment">// Increment the Next Free counter.</span>
02549         <span class="comment">//</span>
02550 
02551         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;NextFree = (tableIndex + 1) % <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableSize);
02552 
02553     }
02554 
02555 
02556     <span class="comment">//</span>
02557     <span class="comment">// Unlock the client so it will process this new SMB.</span>
02558     <span class="comment">//</span>
02559 
02560     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceToClient: Set NewSmbEvent.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
02561     status = ZwSetEvent( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NewSmbEvent), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02562 
02563     <span class="comment">//</span>
02564     <span class="comment">//  When stopping the trace we set TraceState to TraceStopping and then</span>
02565     <span class="comment">//  DoneSmbEvent. This prevents this routine from blocking indefinitely</span>
02566     <span class="comment">//  because it Resets DoneSmbEvent processes the Smb and then checks TraceState</span>
02567     <span class="comment">//  before blocking.</span>
02568     <span class="comment">//</span>
02569     <span class="keywordflow">if</span> (( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) &amp;&amp;
02570         ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) == <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a> )) {
02571 
02572         <span class="comment">//</span>
02573         <span class="comment">// Wait for the app to acknowledge that the SMB has been</span>
02574         <span class="comment">// processed.</span>
02575         <span class="comment">//</span>
02576 
02577         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceToClient: Waiting for DoneSmbEvent, handle %x, process %x.\n"</span>,
02578                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()));
02579         status = ZwWaitForSingleObject(
02580                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent),
02581                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02582                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02583                     );
02584 
02585         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceToClient: DoneSmbEvent is set, handle %x, process %x.\n"</span>,
02586                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()));
02587         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) );
02588 
02589         <span class="keywordflow">if</span> (Smb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02590 
02591             tableEntry-&gt;BufferOffset = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02592             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0, Smb);
02593         }
02594 
02595     }
02596 
02597     <span class="keywordflow">return</span>;
02598 
02599 } <span class="comment">// SmbTraceToClient</span>
02600 
02601 
02602 ULONG
<a name="l02603"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a43">02603</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a43">SmbTraceMdlLength</a>(
02604     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl
02605     )
02606 
02607 <span class="comment">/*++</span>
02608 <span class="comment"></span>
02609 <span class="comment">Routine Description:</span>
02610 <span class="comment"></span>
02611 <span class="comment">    Determine the total number of bytes of data found in an Mdl.</span>
02612 <span class="comment"></span>
02613 <span class="comment">Arguments:</span>
02614 <span class="comment"></span>
02615 <span class="comment">    Mdl - a pointer to an Mdl whose length is to be calculated</span>
02616 <span class="comment"></span>
02617 <span class="comment">Return Value:</span>
02618 <span class="comment"></span>
02619 <span class="comment">    ULONG - total number of data bytes in Mdl</span>
02620 <span class="comment"></span>
02621 <span class="comment">--*/</span>
02622 
02623 {
02624     ULONG Bytes = 0;
02625 
02626     <span class="keywordflow">while</span> (Mdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02627         Bytes += <a class="code" href="../../d2/d1/mm_8h.html#a13">MmGetMdlByteCount</a>(Mdl);
02628         Mdl = Mdl-&gt;Next;
02629     }
02630 
02631     <span class="keywordflow">return</span> Bytes;
02632 } <span class="comment">// SmbTraceMdlLength</span>
02633 
02634 
02635 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02636"></a><a class="code" href="../../d4/d9/smbtrsup_8c.html#a44">02636</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a44">SmbTraceCopyMdlContiguous</a>(
02637     OUT PVOID Destination,
02638     IN  <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
02639     IN  ULONG Length
02640     )
02641 
02642 <span class="comment">/*++</span>
02643 <span class="comment"></span>
02644 <span class="comment">Routine Description:</span>
02645 <span class="comment"></span>
02646 <span class="comment">    Copy the data stored in Mdl into the contiguous memory at</span>
02647 <span class="comment">    Destination.  Length is present to keep the same interface</span>
02648 <span class="comment">    as RtlCopyMemory.</span>
02649 <span class="comment"></span>
02650 <span class="comment">Arguments:</span>
02651 <span class="comment"></span>
02652 <span class="comment">    Destination - a pointer to previously allocated memory into which</span>
02653 <span class="comment">                  the Mdl is to be copied.</span>
02654 <span class="comment"></span>
02655 <span class="comment">    Mdl - a pointer to an Mdl which is to be copied to Destination</span>
02656 <span class="comment"></span>
02657 <span class="comment">    Length - number of data bytes expected in Mdl</span>
02658 <span class="comment"></span>
02659 <span class="comment">Return Value:</span>
02660 <span class="comment"></span>
02661 <span class="comment">    None</span>
02662 <span class="comment"></span>
02663 <span class="comment">--*/</span>
02664 
02665 {
02666     PCHAR Dest = Destination;
02667 
02668     UNREFERENCED_PARAMETER(Length);
02669 
02670     <span class="keywordflow">while</span> (Mdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02671 
02672         RtlCopyMemory(
02673             Dest,
02674             <a class="code" href="../../d2/d1/mm_8h.html#a26">MmGetSystemAddressForMdl</a>(Mdl),
02675             <a class="code" href="../../d2/d1/mm_8h.html#a13">MmGetMdlByteCount</a>(Mdl)
02676             );
02677 
02678         Dest += <a class="code" href="../../d2/d1/mm_8h.html#a13">MmGetMdlByteCount</a>(Mdl);
02679         Mdl = Mdl-&gt;Next;
02680     }
02681 
02682     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ULONG)(Dest - (PCHAR)Destination) == Length);
02683 
02684     <span class="keywordflow">return</span>;
02685 
02686 } <span class="comment">// SmbTraceCopyMdlContiguous</span>
02687 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:50 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
