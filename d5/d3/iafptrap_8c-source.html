<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: iafptrap.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>iafptrap.c</h1><a href="../../d4/d4/iafptrap_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    iafptrap.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This is based on the i386 trapc.c module with very minor changes.</span>
00012 <span class="comment">    It would be nice if there wasn't so much duplicate code so that</span>
00013 <span class="comment">    fixes to that file would carry over to this one...</span>
00014 <span class="comment">    </span>
00015 <span class="comment">    This module contains some trap handling code written in C.</span>
00016 <span class="comment">    Only by the kernel.</span>
00017 <span class="comment"></span>
00018 <span class="comment">Author:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Ken Reneris     6-9-93</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include    "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00027 <span class="preprocessor">#include    "<a class="code" href="../../d8/d3/ia32def_8h.html">ia32def.h</a>"</span>
00028 
00029 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00030 <a class="code" href="../../d4/d4/iafptrap_8c.html#a11">Ki386CheckDivideByZeroTrap</a> (
00031     IN  PKTRAP_FRAME    UserFrame
00032     );
00033 
00034 
00035 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, Ki386CheckDivideByZeroTrap)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span>
00039 
<a name="l00040"></a><a class="code" href="../../d4/d4/iafptrap_8c.html#a0">00040</a> <span class="preprocessor">#define REG(field)          ((ULONG_PTR)(&amp;((KTRAP_FRAME *)0)-&gt;field))</span>
<a name="l00041"></a><a class="code" href="../../d4/d4/iafptrap_8c.html#a1">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define GETREG(frame,reg)   ((PULONG) (((ULONG_PTR) frame)+reg))[0]</span>
00042 <span class="preprocessor"></span>
00043 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00044"></a><a class="code" href="../../d1/d8/structKMOD.html#o0">00044</a>     UCHAR   RmDisplaceOnly;     <span class="comment">// RM of displacment only, no base reg</span>
<a name="l00045"></a><a class="code" href="../../d1/d8/structKMOD.html#o1">00045</a>     UCHAR   RmSib;              <span class="comment">// RM of SIB</span>
<a name="l00046"></a><a class="code" href="../../d1/d8/structKMOD.html#o2">00046</a>     UCHAR   RmDisplace;         <span class="comment">// bit mask of RMs which have a displacement</span>
<a name="l00047"></a><a class="code" href="../../d1/d8/structKMOD.html#o3">00047</a>     UCHAR   Disp;               <span class="comment">// sizeof displacement (in bytes)</span>
00048 } <a class="code" href="../../d1/d8/structKMOD.html">KMOD</a>, *<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a2">PKMOD</a>;
00049 
<a name="l00050"></a><a class="code" href="../../d4/d4/iafptrap_8c.html#a3">00050</a> <span class="keyword">static</span> ULONG_PTR <a class="code" href="../../d4/d4/iafptrap_8c.html#a3">RM32</a>[] = {
00051     <span class="comment">/* 000 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntV0),         <span class="comment">// EAX</span>
00052     <span class="comment">/* 001 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntT2),         <span class="comment">// ECX</span>
00053     <span class="comment">/* 010 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntT3),         <span class="comment">// EDX</span>
00054     <span class="comment">/* 011 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntT4),         <span class="comment">// EBX</span>
00055     <span class="comment">/* 100 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntSp),         <span class="comment">// ESP</span>
00056     <span class="comment">/* 101 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntTeb),        <span class="comment">// EBP</span>
00057     <span class="comment">/* 110 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntT5),         <span class="comment">// ESI</span>
00058     <span class="comment">/* 111 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntT6)          <span class="comment">// EDI</span>
00059 };
00060 
<a name="l00061"></a><a class="code" href="../../d4/d4/iafptrap_8c.html#a4">00061</a> <span class="keyword">static</span> ULONG_PTR <a class="code" href="../../d4/d4/iafptrap_8c.html#a4">RM8</a>[] = {
00062     <span class="comment">/* 000 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntV0),       <span class="comment">// al</span>
00063     <span class="comment">/* 001 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntT2),       <span class="comment">// cl</span>
00064     <span class="comment">/* 010 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntT3),       <span class="comment">// dl</span>
00065     <span class="comment">/* 011 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntT4),       <span class="comment">// bl</span>
00066     <span class="comment">/* 100 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntV0) + 1,   <span class="comment">// ah</span>
00067     <span class="comment">/* 101 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntT2) + 1,   <span class="comment">// ch</span>
00068     <span class="comment">/* 110 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntT3) + 1,   <span class="comment">// dh</span>
00069     <span class="comment">/* 111 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(IntT4) + 1    <span class="comment">// bh</span>
00070 };
00071 
<a name="l00072"></a><a class="code" href="../../d4/d4/iafptrap_8c.html#a5">00072</a> <span class="keyword">static</span> <a class="code" href="../../d1/d8/structKMOD.html">KMOD</a> <a class="code" href="../../d4/d4/iafptrap_8c.html#a5">MOD32</a>[] = {
00073     <span class="comment">/* 00 */</span>     5,     4,   0x20,   4,
00074     <span class="comment">/* 01 */</span>  0xff,     4,   0xff,   1,
00075     <span class="comment">/* 10 */</span>  0xff,     4,   0xff,   4,
00076     <span class="comment">/* 11 */</span>  0xff,  0xff,   0x00,   0
00077 } ;
00078 
00079 <span class="keyword">static</span> <span class="keyword">struct </span>{
<a name="l00080"></a><a class="code" href="../../d4/d4/iafptrap_8c.html#a7">00080</a>     UCHAR   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a6">Opcode1</a>, <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a7">Opcode2</a>;   <span class="comment">// instruction opcode</span>
<a name="l00081"></a><a class="code" href="../../d4/d4/iafptrap_8c.html#a9">00081</a>     UCHAR   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a8">ModRm</a>, <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>;        <span class="comment">// if 2nd part of opcode is encoded in ModRm</span>
00082 } <a class="code" href="../../d4/d4/iafptrap_8c.html#a10">NoWaitNpxInstructions</a>[] = {
00083     <span class="comment">/* FNINIT   */</span>  0xDB, 0xE3, 0,  1,
00084     <span class="comment">/* FNCLEX   */</span>  0xDB, 0xE2, 0,  1,
00085     <span class="comment">/* FNSTENV  */</span>  0xD9, 0x06, 1,  1,
00086     <span class="comment">/* FNSAVE   */</span>  0xDD, 0x06, 1,  1,
00087     <span class="comment">/* FNSTCW   */</span>  0xD9, 0x07, 1,  2,
00088     <span class="comment">/* FNSTSW   */</span>  0xDD, 0x07, 1,  3,
00089     <span class="comment">/* FNSTSW AX*/</span>  0xDF, 0xE0, 0,  4,
00090                     0x00, 0x00, 0,  1
00091 };
00092 
00093 
00094 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00095 <a class="code" href="../../d4/d4/iafptrap_8c.html#a11">Ki386CheckDivideByZeroTrap</a> (
00096     IN  PKTRAP_FRAME    UserFrame
00097     )
00098 <span class="comment">/*++</span>
00099 <span class="comment"></span>
00100 <span class="comment">Routine Description:</span>
00101 <span class="comment"></span>
00102 <span class="comment">    This function gains control when the x86 processor generates a</span>
00103 <span class="comment">    divide by zero trap.  The x86 design generates such a trap on</span>
00104 <span class="comment">    divide by zero and on division overflows.  In order to determine</span>
00105 <span class="comment">    which expection code to dispatch, the divisor of the "div" or "idiv"</span>
00106 <span class="comment">    instruction needs to be inspected.</span>
00107 <span class="comment"></span>
00108 <span class="comment">Arguments:</span>
00109 <span class="comment"></span>
00110 <span class="comment">    UserFrame - Trap frame of the divide by zero trap</span>
00111 <span class="comment"></span>
00112 <span class="comment">Return Value:</span>
00113 <span class="comment"></span>
00114 <span class="comment">    exception code dispatch</span>
00115 <span class="comment"></span>
00116 <span class="comment">--*/</span>
00117 {
00118     ULONG       operandsize, operandmask, i;
00119     ULONG_PTR   accum;
00120     PUCHAR      istream;
00121     ULONG_PTR   *pRM;
00122     UCHAR       ibyte, rm;
00123     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a2">PKMOD</a>       Mod;
00124     BOOLEAN     fPrefix;
00125     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00126 
00127     status = STATUS_INTEGER_DIVIDE_BY_ZERO;
00128 
00129     <span class="keywordflow">try</span> {
00130 
00131         <span class="comment">//</span>
00132         <span class="comment">// read instruction prefixes</span>
00133         <span class="comment">//</span>
00134 
00135         fPrefix = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00136         pRM = <a class="code" href="../../d4/d4/iafptrap_8c.html#a3">RM32</a>;
00137         operandsize = 4;
00138         operandmask = 0xffffffff;
00139         istream = (PUCHAR) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(UserFrame);
00140         <span class="keywordflow">while</span> (fPrefix) {
00141             ibyte = <a class="code" href="../../d5/d8/ex_8h.html#a14">ProbeAndReadUchar</a>(istream);
00142             istream++;
00143             <span class="keywordflow">switch</span> (ibyte) {
00144                 <span class="keywordflow">case</span> 0x2e:  <span class="comment">// cs override</span>
00145                 <span class="keywordflow">case</span> 0x36:  <span class="comment">// ss override</span>
00146                 <span class="keywordflow">case</span> 0x3e:  <span class="comment">// ds override</span>
00147                 <span class="keywordflow">case</span> 0x26:  <span class="comment">// es override</span>
00148                 <span class="keywordflow">case</span> 0x64:  <span class="comment">// fs override</span>
00149                 <span class="keywordflow">case</span> 0x65:  <span class="comment">// gs override</span>
00150                 <span class="keywordflow">case</span> 0xF3:  <span class="comment">// rep</span>
00151                 <span class="keywordflow">case</span> 0xF2:  <span class="comment">// rep</span>
00152                 <span class="keywordflow">case</span> 0xF0:  <span class="comment">// lock</span>
00153                     <span class="keywordflow">break</span>;
00154 
00155                 <span class="keywordflow">case</span> 0x66:
00156                     <span class="comment">// 16 bit operand override</span>
00157                     operandsize = 2;
00158                     operandmask = 0xffff;
00159                     <span class="keywordflow">break</span>;
00160 
00161                 <span class="keywordflow">case</span> 0x67:
00162                     <span class="comment">// 16 bit address size override</span>
00163                     <span class="comment">// this is some non-flat code</span>
00164                     <span class="keywordflow">goto</span> try_exit;
00165 
00166                 <span class="keywordflow">default</span>:
00167                     fPrefix = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00168                     <span class="keywordflow">break</span>;
00169             }
00170         }
00171 
00172         <span class="comment">//</span>
00173         <span class="comment">// Check instruction opcode</span>
00174         <span class="comment">//</span>
00175 
00176         <span class="keywordflow">if</span> (ibyte != 0xf7  &amp;&amp;  ibyte != 0xf6) {
00177             <span class="comment">// this is not a DIV or IDIV opcode</span>
00178             <span class="keywordflow">goto</span> try_exit;
00179         }
00180 
00181         <span class="keywordflow">if</span> (ibyte == 0xf6) {
00182             <span class="comment">// this is a byte div or idiv</span>
00183             operandsize = 1;
00184             operandmask = 0xff;
00185         }
00186 
00187         <span class="comment">//</span>
00188         <span class="comment">// Get Mod R/M</span>
00189         <span class="comment">//</span>
00190 
00191         ibyte = <a class="code" href="../../d5/d8/ex_8h.html#a14">ProbeAndReadUchar</a> (istream);
00192         istream++;
00193         Mod = <a class="code" href="../../d4/d4/iafptrap_8c.html#a5">MOD32</a> + (ibyte &gt;&gt; 6);
00194         rm  = ibyte &amp; 7;
00195 
00196         <span class="comment">//</span>
00197         <span class="comment">// put register values into accum</span>
00198         <span class="comment">//</span>
00199 
00200         <span class="keywordflow">if</span> (operandsize == 1  &amp;&amp;  (ibyte &amp; 0xc0) == 0xc0) {
00201             pRM = <a class="code" href="../../d4/d4/iafptrap_8c.html#a4">RM8</a>;
00202         }
00203 
00204         accum = 0;
00205         <span class="keywordflow">if</span> (rm != Mod-&gt;RmDisplaceOnly) {
00206             <span class="keywordflow">if</span> (rm == Mod-&gt;RmSib) {
00207                 <span class="comment">// get SIB</span>
00208                 ibyte = <a class="code" href="../../d5/d8/ex_8h.html#a14">ProbeAndReadUchar</a>(istream);
00209                 istream++;
00210                 i = (ibyte &gt;&gt; 3) &amp; 7;
00211                 <span class="keywordflow">if</span> (i != 4) {
00212                     accum = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a1">GETREG</a>(UserFrame, RM32[i]);
00213                     accum = accum &lt;&lt; (ibyte &gt;&gt; 6);    <span class="comment">// apply scaler</span>
00214                 }
00215                 i = ibyte &amp; 7;
00216                 accum = accum + <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a1">GETREG</a>(UserFrame, RM32[i]);
00217             } <span class="keywordflow">else</span> {
00218                 <span class="comment">// get register's value</span>
00219                 <span class="comment">//</span>
00220                 <span class="comment">// BUGBUG: Seems like this could be a problem if rm points</span>
00221                 <span class="comment">// to the 8 bit registers (see line 200 above (pRm = RM8))</span>
00222                 <span class="comment">// since the GETREG routine gets a ULONG's worth of data</span>
00223                 <span class="comment">// 1) The rm8 means there is only 8 significant bits, not 32</span>
00224                 <span class="comment">// 2) If grabbing from the high half, pointer is to an odd</span>
00225                 <span class="comment">//    address when grab 32-bits - a misalign fault...</span>
00226                 <span class="comment">// </span>
00227                 accum = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a1">GETREG</a>(UserFrame, pRM[rm]);
00228             }
00229         }
00230 
00231         <span class="comment">//</span>
00232         <span class="comment">// apply displacement to accum</span>
00233         <span class="comment">//</span>
00234 
00235         <span class="keywordflow">if</span> (Mod-&gt;RmDisplace &amp; (1 &lt;&lt; rm)) {
00236             <span class="keywordflow">if</span> (Mod-&gt;Disp == 4) {
00237                 i = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a> ((PULONG) istream);
00238             } <span class="keywordflow">else</span> {
00239                 ibyte = <a class="code" href="../../d5/d8/ex_8h.html#a13">ProbeAndReadChar</a> (istream);
00240                 i = (<span class="keywordtype">signed</span> <span class="keywordtype">long</span>) ((<span class="keywordtype">signed</span> <span class="keywordtype">char</span>) ibyte);    <span class="comment">// sign extend</span>
00241             }
00242             accum += i;
00243         }
00244 
00245         <span class="comment">//</span>
00246         <span class="comment">// if this is an effective address, go get the data value</span>
00247         <span class="comment">//</span>
00248 
00249         <span class="keywordflow">if</span> (Mod-&gt;Disp) {
00250             <span class="keywordflow">switch</span> (operandsize) {
00251                 <span class="keywordflow">case</span> 1:  accum = <a class="code" href="../../d5/d8/ex_8h.html#a14">ProbeAndReadUchar</a>((PUCHAR) accum);    <span class="keywordflow">break</span>;
00252                 <span class="keywordflow">case</span> 2:  accum = <a class="code" href="../../d5/d8/ex_8h.html#a16">ProbeAndReadUshort</a>((PUSHORT) accum);  <span class="keywordflow">break</span>;
00253                 <span class="keywordflow">case</span> 4:  accum = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>((PULONG) accum);    <span class="keywordflow">break</span>;
00254             }
00255         }
00256 
00257         <span class="comment">//</span>
00258         <span class="comment">// accum now contains the instruction operand, see if the</span>
00259         <span class="comment">// operand was really a zero</span>
00260         <span class="comment">//</span>
00261 
00262         <span class="keywordflow">if</span> (accum &amp; operandmask) {
00263             <span class="comment">// operand was non-zero, must be an overflow</span>
00264             status = STATUS_INTEGER_OVERFLOW;
00265         }
00266 
00267 try_exit: ;
00268     } except (EXCEPTION_EXECUTE_HANDLER) {
00269         <span class="comment">// do nothing...</span>
00270     }
00271 
00272     <span class="keywordflow">return</span> status;
00273 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:19 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
