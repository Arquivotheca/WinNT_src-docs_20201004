<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: tokenadj.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>tokenadj.c File Reference</h1><code>#include "<a class="el" href="../../d7/d5/sep_8h-source.html">sep.h</a>"</code><br>
<code>#include "sertlp.h"</code><br>
<code>#include "<a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>"</code><br>

<p>
<a href="../../d6/d2/tokenadj_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a> (IN HANDLE TokenHandle, IN BOOLEAN DisableAllPrivileges, IN PTOKEN_PRIVILEGES NewState OPTIONAL, IN ULONG BufferLength OPTIONAL, OUT PTOKEN_PRIVILEGES PreviousState OPTIONAL, OUT PULONG ReturnLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a> (IN HANDLE TokenHandle, IN BOOLEAN ResetToDefault, IN PTOKEN_GROUPS NewState OPTIONAL, IN ULONG BufferLength OPTIONAL, OUT PTOKEN_GROUPS PreviousState OPTIONAL, OUT PULONG ReturnLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/tokenadj_8c.html#a2">SepAdjustPrivileges</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN BOOLEAN MakeChanges, IN BOOLEAN DisableAllPrivileges, IN ULONG PrivilegeCount OPTIONAL, IN PLUID_AND_ATTRIBUTES NewState OPTIONAL, OUT PTOKEN_PRIVILEGES PreviousState OPTIONAL, OUT PULONG ReturnLength, OUT PULONG ChangeCount, OUT PBOOLEAN <a class="el" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/tokenadj_8c.html#a3">SepAdjustGroups</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN BOOLEAN MakeChanges, IN BOOLEAN ResetToDefault, IN ULONG GroupCount, IN PSID_AND_ATTRIBUTES NewState OPTIONAL, OUT PTOKEN_GROUPS PreviousState OPTIONAL, OUT PSID SidBuffer OPTIONAL, OUT PULONG ReturnLength, OUT PULONG ChangeCount, OUT PBOOLEAN <a class="el" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="tokenadj.c::NtAdjustGroupsToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtAdjustGroupsToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ResetToDefault</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_GROUPS NewState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG BufferLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PTOKEN_GROUPS PreviousState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00432">432</a> of file <a class="el" href="../../d6/d2/tokenadj_8c-source.html">tokenadj.c</a>.
<p>
References <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00226">ANYSIZE_ARRAY</a>, <a class="el" href="../../d9/d0/fdengine_8c-source.html#l00048">ChangesMade</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00167">LongAlignPtr</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01850">SeCaptureSidAndAttributesArray()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00416">SepAcquireTokenWriteLock</a>, <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l01099">SepAdjustGroups()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00444">SepReleaseTokenWriteLock</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l02297">SeReleaseSidAndAttributesArray()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/cttoken_8c-source.html#l04885">TestTokenAdjustGroups()</a>.
<p>
<pre class="fragment"><div>00444                    :
00445 
00446     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to disable or enable groups in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00447     token.  The absence of some of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> groups listed to be changed
00448     won'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> effect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> successful modification of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> groups that are in
00449     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.  The previous enabled/disabled state of changed groups
00450     may optionally be capture (<span class="keywordflow">for</span> resetting later).
00451 
00452     TOKEN_ADJUST_GROUPS access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required to enable or disable groups
00453     in a token
00454 
00455     Note that mandatory groups can not be disabled.  An attempt
00456     disable any mandatory groups will cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call to fail, leaving
00457     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of all groups unchanged.
00458 
00459 
00460 Arguments:
00461 
00462     TokenHandle - Provides a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to operate on.
00463 
00464     ResetToDefault - The parameter indicates whether all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> groups
00465         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token are to be reset to their <span class="keywordflow">default</span> enabled/disabled
00466         state.
00467 
00468     NewState - This parameter points to a TOKEN_GROUPS data structure
00469         containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> groups whose states are to be adjusted
00470         (disabled or enabled).  Only <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Enabled flag of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00471         attributes associated with each group <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  It provides
00472         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00473         token.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ResetToDefault argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00474         then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.  Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be passed.
00475 
00476     BufferLength - This optional parameter indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length (in
00477         bytes) of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PreviousState buffer.  This value must be
00478         provided <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PreviousState parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> provided.
00479 
00480     PreviousState - This (optional) parameter points to a buffer to
00481         receive the state of any groups actually changed by this
00482         request.  This information is formated as a TOKEN_GROUPS data
00483         structure which may be passed as the NewState parameter in a
00484         subsequent call to NtAdjustGroups to restore the original state
00485         of those groups.  TOKEN_QUERY access is needed to use this
00486         parameter.
00487 
00488         If this buffer does not contain enough space to receive the
00489         complete list of modified groups, then no group states are
00490         changed and STATUS_BUFFER_TOO_SMALL is returned.  In this
00491         case, the ReturnLength return parameter will contain the
00492         actual number of bytes needed to hold the information.
00493 
00494     ReturnLength - Indicates the actual number of bytes needed to
00495         contain the previous group state information.
00496         This parameter is ignored if the PreviousState argument is not
00497         passed.
00498 
00499 
00500 Return Value:
00501 
00502     STATUS_SUCCESS - The service successfully completed the requested
00503         operation.
00504 
00505     STATUS_NOT_ALL_ASSIGNED - This NT_SUCCESS severity return status
00506         indicates that not all the specified groups are currently
00507         assigned to the caller.  All specified groups that are
00508         currently assigned have been successfully adjusted.
00509 
00510     STATUS_CANT_DISABLE_MANDATORY - Indicates an attempt was made to
00511         disable a mandatory group.  The states of all groups remains
00512         unchanged.
00513 
00514     STATUS_BUFFER_TOO_SMALL - Indicates the optional buffer provided
00515         to receive the previous states of changed group wasn't large
00516         enough to receive that information.  No changes to group
00517         states has been made.  The number of bytes needed to hold the
00518         state change information is returned via the ReturnLength
00519         parameter.
00520 
00521     STATUS_INVALID_PARAMETER - Indicates neither the ResetToDefault
00522         parameter was specified as true, nor was an explicit NewState
00523         provided.
00524 
00525 --*/
00526 {
00527 
00528     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00529     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00530 
00531     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00532 
00533     ACCESS_MASK DesiredAccess;
00534 
00535     ULONG CapturedGroupCount;
00536     PSID_AND_ATTRIBUTES CapturedGroups = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00537     ULONG CapturedGroupsLength;
00538 
00539     ULONG LocalReturnLength;
00540     ULONG ChangeCount;
00541     BOOLEAN <a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>;
00542     PSID SidBuffer;
00543 
00544     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00545 
00546     <span class="comment">//</span>
00547     <span class="comment">//  The semantics of the PreviousState parameter and the</span>
00548     <span class="comment">//  STATUS_CANT_DISABLE_MANDATORY completion status leads to a two-pass</span>
00549     <span class="comment">//  approach to adjusting groups.  The first pass simply checks</span>
00550     <span class="comment">//  to see which groups will change and counts them.  This allows</span>
00551     <span class="comment">//  the amount of space needed to be calculated and returned.  If</span>
00552     <span class="comment">//  the caller's PreviousState return buffer is not large enough, or</span>
00553     <span class="comment">//  one of the specified groups is a mandatory group, then an error</span>
00554     <span class="comment">//  is returned without making any modifications.  Otherwise, a second</span>
00555     <span class="comment">//  pass is made to actually make the changes.</span>
00556     <span class="comment">//</span>
00557 
00558     <span class="keywordflow">if</span> (!ResetToDefault &amp;&amp; !ARGUMENT_PRESENT(NewState)) {
00559         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00560     }
00561 
00562     <span class="comment">//</span>
00563     <span class="comment">// Get previous processor mode and probe parameters if necessary.</span>
00564     <span class="comment">//</span>
00565 
00566     PreviousMode = KeGetPreviousMode();
00567     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00568         <span class="keywordflow">try</span> {
00569 
00570             <span class="keywordflow">if</span> (!ResetToDefault) {
00571                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00572                     NewState,
00573                     <span class="keyword">sizeof</span>(TOKEN_GROUPS),
00574                     <span class="keyword">sizeof</span>(ULONG)
00575                     );
00576             }
00577 
00578             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00579 
00580                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00581                     PreviousState,
00582                     BufferLength,
00583                     <span class="keyword">sizeof</span>(ULONG)
00584                     );
00585 
00586                 <span class="comment">//</span>
00587                 <span class="comment">// This parameter is only used if PreviousState</span>
00588                 <span class="comment">// is present</span>
00589                 <span class="comment">//</span>
00590 
00591                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
00592 
00593             }
00594 
00595 
00596         } except(EXCEPTION_EXECUTE_HANDLER) {
00597             <span class="keywordflow">return</span> GetExceptionCode();
00598         }
00599     }
00600 
00601     <span class="comment">//</span>
00602     <span class="comment">// Capture NewState.</span>
00603     <span class="comment">//</span>
00604 
00605     <span class="keywordflow">if</span> (!ResetToDefault) {
00606 
00607         <span class="keywordflow">try</span> {
00608 
00609             CapturedGroupCount = NewState-&gt;GroupCount;
00610             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a14">SeCaptureSidAndAttributesArray</a>(
00611                          &amp;(NewState-&gt;Groups[0]),
00612                          CapturedGroupCount,
00613                          PreviousMode,
00614                          NULL, 0,
00615                          PagedPool,
00616                          TRUE,
00617                          &amp;CapturedGroups,
00618                          &amp;CapturedGroupsLength
00619                          );
00620 
00621             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00622 
00623                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00624 
00625             }
00626 
00627         } except(EXCEPTION_EXECUTE_HANDLER) {
00628 
00629             <span class="keywordflow">return</span> GetExceptionCode();
00630 
00631         } <span class="comment">// endtry</span>
00632     } <span class="comment">// endif !ResetToDefault</span>
00633 
00634 
00635     <span class="comment">//</span>
00636     <span class="comment">// Reference the token object and validate the caller's right</span>
00637     <span class="comment">// to adjust the groups.</span>
00638     <span class="comment">//</span>
00639 
00640     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00641         DesiredAccess = (TOKEN_ADJUST_GROUPS | TOKEN_QUERY);
00642     } <span class="keywordflow">else</span> {
00643         DesiredAccess = TOKEN_ADJUST_GROUPS;
00644     }
00645 
00646     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00647              TokenHandle,             <span class="comment">// Handle</span>
00648              DesiredAccess,           <span class="comment">// DesiredAccess</span>
00649              SepTokenObjectType,      <span class="comment">// ObjectType</span>
00650              PreviousMode,            <span class="comment">// AccessMode</span>
00651              (PVOID *)&amp;Token,         <span class="comment">// Object</span>
00652              NULL                     <span class="comment">// GrantedAccess</span>
00653              );
00654 
00655     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00656 
00657         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedGroups)) {
00658             <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>( CapturedGroups, PreviousMode, TRUE );
00659         }
00660 
00661         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00662     }
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">//  Gain exclusive access to the token.</span>
00666     <span class="comment">//</span>
00667 
00668     <a class="code" href="../../d8/d3/tokenp_8h.html#a7">SepAcquireTokenWriteLock</a>( Token );
00669 
00670     <span class="comment">//</span>
00671     <span class="comment">// First pass through the groups list.</span>
00672     <span class="comment">//</span>
00673     <span class="comment">// This pass is always necessary for groups to make sure the caller</span>
00674     <span class="comment">// isn't trying to do anything illegal to mandatory groups.</span>
00675     <span class="comment">//</span>
00676 
00677     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a23">SepAdjustGroups</a>(
00678                  Token,
00679                  FALSE,                <span class="comment">// Don't make changes this pass</span>
00680                  ResetToDefault,
00681                  CapturedGroupCount,
00682                  CapturedGroups,
00683                  PreviousState,
00684                  NULL,                <span class="comment">// Not returning SIDs this call</span>
00685                  &amp;LocalReturnLength,
00686                  &amp;ChangeCount,
00687                  &amp;ChangesMade
00688                  );
00689 
00690     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00691 
00692         <span class="keywordflow">try</span> {
00693 
00694             (*ReturnLength) = LocalReturnLength;
00695 
00696         } except(EXCEPTION_EXECUTE_HANDLER) {
00697 
00698             <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, FALSE );
00699             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00700 
00701             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedGroups)) {
00702                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>(
00703                     CapturedGroups,
00704                     PreviousMode,
00705                     TRUE
00706                     );
00707             }
00708 
00709             <span class="keywordflow">return</span> GetExceptionCode();
00710         }
00711     }
00712 
00713     <span class="comment">//</span>
00714     <span class="comment">// Make sure we didn't encounter an error</span>
00715     <span class="comment">//</span>
00716 
00717     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00718 
00719         <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, FALSE );
00720         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00721 
00722         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedGroups)) {
00723             <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>(
00724                 CapturedGroups,
00725                 PreviousMode,
00726                 TRUE
00727                 );
00728         }
00729 
00730         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00731 
00732     }
00733 
00734     <span class="comment">//</span>
00735     <span class="comment">// Make sure there is enough room to return requested information.</span>
00736     <span class="comment">// Also go on to calculate where the SID values go.</span>
00737     <span class="comment">//</span>
00738 
00739     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00740         <span class="keywordflow">if</span> (LocalReturnLength &gt; BufferLength) {
00741 
00742             <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, FALSE );
00743             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00744 
00745             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedGroups)) {
00746                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>(
00747                     CapturedGroups,
00748                     PreviousMode,
00749                     TRUE
00750                     );
00751             }
00752 
00753 
00754             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00755         }
00756 
00757         <span class="comment">//</span>
00758         <span class="comment">// Calculate where the SIDs can be placed in the PreviousState</span>
00759         <span class="comment">// buffer.</span>
00760         <span class="comment">//</span>
00761 
00762         SidBuffer = (PSID)(<a class="code" href="../../d3/d8/udfprocs_8h.html#a27">LongAlignPtr</a>(
00763                             (PCHAR)PreviousState + (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
00764                             (ChangeCount * (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES)) -
00765                             (ANYSIZE_ARRAY * (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES))
00766                             ) );
00767 
00768     }
00769 
00770     <span class="comment">//</span>
00771     <span class="comment">// Second pass through the groups list.</span>
00772     <span class="comment">//</span>
00773 
00774     <span class="keywordflow">try</span> {
00775 
00776         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a23">SepAdjustGroups</a>(
00777                      Token,
00778                      TRUE,                 <span class="comment">// Make changes in this pass</span>
00779                      ResetToDefault,
00780                      CapturedGroupCount,
00781                      CapturedGroups,
00782                      PreviousState,
00783                      SidBuffer,
00784                      &amp;LocalReturnLength,
00785                      &amp;ChangeCount,
00786                      &amp;ChangesMade
00787                      );
00788 
00789         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00790 
00791             PreviousState-&gt;GroupCount = ChangeCount;
00792         }
00793 
00794     } except(EXCEPTION_EXECUTE_HANDLER) {
00795 
00796         <span class="comment">//SepFreeToken( Token, TRUE );</span>
00797         <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, TRUE );
00798         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00799         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedGroups)) {
00800             <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>( CapturedGroups, PreviousMode, TRUE );
00801         }
00802         <span class="keywordflow">return</span> GetExceptionCode();
00803 
00804     }
00805 
00806     <span class="comment">//SepFreeToken( Token, ChangesMade );</span>
00807     <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, ChangesMade );
00808     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00809 
00810     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedGroups)) {
00811         <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>( CapturedGroups, PreviousMode, TRUE );
00812     }
00813 
00814     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00815 
00816 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="tokenadj.c::NtAdjustPrivilegesToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtAdjustPrivilegesToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DisableAllPrivileges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_PRIVILEGES NewState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG BufferLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PTOKEN_PRIVILEGES PreviousState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00046">46</a> of file <a class="el" href="../../d6/d2/tokenadj_8c-source.html">tokenadj.c</a>.
<p>
References <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00226">ANYSIZE_ARRAY</a>, <a class="el" href="../../d9/d0/fdengine_8c-source.html#l00048">ChangesMade</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00432">DisableAllPrivileges()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01608">SeCaptureLuidAndAttributesArray()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00416">SepAcquireTokenWriteLock</a>, <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00819">SepAdjustPrivileges()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00444">SepReleaseTokenWriteLock</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01797">SeReleaseLuidAndAttributesArray()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00432">DisableAllPrivileges()</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00225">EnableAllPrivileges()</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00322">ResetAllPrivileges()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00639">RtlAdjustPrivilege()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l03929">TestTokenAdjustPrivileges()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00167">TestTokenInitialize()</a>.
<p>
<pre class="fragment"><div>00059                    :
00060 
00061     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to disable or enable privileges in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00062     specified token.  The absence of some of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privileges listed to
00063     be changed won'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> effect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> successful modification of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00064     privileges that are in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.  The previous enabled/disabled
00065     state of changed privileges may optionally be capture (<span class="keywordflow">for</span>
00066     resetting later).
00067 
00068     TOKEN_ADJUST_PRIVILEGES access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required to enable or disable
00069     privileges in a token.
00070 
00071 
00072 Arguments:
00073 
00074     TokenHandle - Provides a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to operate on.
00075 
00076     <a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a> - This <span class="keywordtype">boolean</span> parameter may be
00077         used to disable all privileges assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.  If
00078         <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NewState parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00079         ignored.
00080 
00081     NewState - This (optional) parameter points to a TOKEN_PRIVILEGES
00082         data structure containing the privileges whose states are to
00083         be adjusted (disabled or enabled).  Only the Enabled flag of
00084         the attributes associated with each privilege is used.  It
00085         provides the new value that is to be assigned to the
00086         privilege in the token.
00087 
00088     BufferLength - This optional parameter indicates the length (in
00089         bytes) of the PreviousState buffer.  This value must be
00090         provided if the PreviousState parameter is provided.
00091 
00092     PreviousState - This (optional) parameter points to a buffer to
00093         receive the state of any privileges actually changed by this
00094         request.  This information is formated as a TOKEN_PRIVILEGES
00095         data structure which may be passed as the NewState parameter
00096         in a subsequent call to this routine to restore the original
00097         state of those privilges.  TOKEN_QUERY access is needed to
00098         use this parameter.
00099 
00100         If this buffer does not contain enough space to receive the
00101         complete list of modified privileges, then no privilege
00102         states are changed and STATUS_BUFFER_TOO_SMALL is returned.
00103         In this case, the ReturnLength OUT parameter will
00104         contain the actual number of bytes needed to hold the
00105         information.
00106 
00107     ReturnLength - Indicates the actual number of bytes needed to
00108         contain the previous privilege state information.
00109         This parameter is ignored if the PreviousState argument is not
00110         passed.
00111 
00112 Return Value:
00113 
00114     STATUS_SUCCESS - The service successfully completed the requested
00115         operation.
00116 
00117     STATUS_NOT_ALL_ASSIGNED - This NT_SUCCESS severity return status
00118         indicates that not all the specified privileges are currently
00119         assigned to the caller.  All specified privileges that are
00120         currently assigned have been successfully adjusted.
00121 
00122     STATUS_BUFFER_TOO_SMALL - Indicates the optional buffer provided
00123         to receive the previous states of changed privileges wasn't
00124         large enough to receive that information.  No changes to
00125         privilege states has been made.  The number of bytes needed
00126         to hold the state change information is returned via the
00127         ReturnLength parameter.
00128 
00129     STATUS_INVALID_PARAMETER - Indicates neither the DisableAllPrivileges
00130         parameter was specified as true, nor was an explicit NewState
00131         provided.
00132 
00133 --*/
00134 
00135 {
00136     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00137     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00138 
00139     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00140 
00141     ACCESS_MASK DesiredAccess;
00142 
00143     ULONG CapturedPrivilegeCount;
00144     PLUID_AND_ATTRIBUTES CapturedPrivileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00145     ULONG CapturedPrivilegesLength;
00146 
00147     ULONG LocalReturnLength;
00148     ULONG ChangeCount;
00149     BOOLEAN <a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>;
00150 
00151     ULONG ParameterLength;
00152 
00153     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">//  The semantics of the PreviousState parameter leads to a two-pass</span>
00157     <span class="comment">//  approach to adjusting privileges.  The first pass simply checks</span>
00158     <span class="comment">//  to see which privileges will change and counts them.  This allows</span>
00159     <span class="comment">//  the amount of space needed to be calculated and returned.  If</span>
00160     <span class="comment">//  the caller's PreviousState return buffer is not large enough, then</span>
00161     <span class="comment">//  an error is returned without making any modifications.  Otherwise,</span>
00162     <span class="comment">//  a second pass is made to actually make the changes.</span>
00163     <span class="comment">//</span>
00164     <span class="comment">//</span>
00165 
00166     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a> &amp;&amp; !ARGUMENT_PRESENT(NewState)) {
00167         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00168     }
00169 
00170     <span class="comment">//</span>
00171     <span class="comment">// Get previous processor mode and probe parameters if necessary.</span>
00172     <span class="comment">//</span>
00173 
00174     PreviousMode = KeGetPreviousMode();
00175     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00176         <span class="keywordflow">try</span> {
00177 
00178             <span class="comment">//</span>
00179             <span class="comment">// Make sure we can see all of the new state</span>
00180             <span class="comment">//</span>
00181 
00182             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
00183 
00184                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00185                     NewState,
00186                     <span class="keyword">sizeof</span>(TOKEN_PRIVILEGES),
00187                     <span class="keyword">sizeof</span>(ULONG)
00188                     );
00189 
00190                 CapturedPrivilegeCount = NewState-&gt;PrivilegeCount;
00191                 ParameterLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIVILEGES) +
00192                                   ( (CapturedPrivilegeCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>) *
00193                                   (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)  );
00194 
00195                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00196                     NewState,
00197                     ParameterLength,
00198                     <span class="keyword">sizeof</span>(ULONG)
00199                     );
00200 
00201             }
00202 
00203 
00204             <span class="comment">//</span>
00205             <span class="comment">// Check the PreviousState buffer for writeability</span>
00206             <span class="comment">//</span>
00207 
00208             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00209 
00210                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00211                     PreviousState,
00212                     BufferLength,
00213                     <span class="keyword">sizeof</span>(ULONG)
00214                     );
00215 
00216                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
00217             }
00218 
00219 
00220         } except(EXCEPTION_EXECUTE_HANDLER) {
00221             <span class="keywordflow">return</span> GetExceptionCode();
00222         }
00223 
00224     } <span class="keywordflow">else</span> {
00225 
00226         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
00227 
00228             CapturedPrivilegeCount = NewState-&gt;PrivilegeCount;
00229         }
00230     }
00231 
00232 
00233 
00234     <span class="comment">//</span>
00235     <span class="comment">// Capture NewState if passed.</span>
00236     <span class="comment">//</span>
00237 
00238     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
00239 
00240         <span class="keywordflow">try</span> {
00241 
00242 
00243             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a12">SeCaptureLuidAndAttributesArray</a>(
00244                          (NewState-&gt;Privileges),
00245                          CapturedPrivilegeCount,
00246                          PreviousMode,
00247                          NULL, 0,
00248                          PagedPool,
00249                          TRUE,
00250                          &amp;CapturedPrivileges,
00251                          &amp;CapturedPrivilegesLength
00252                          );
00253 
00254         } except(EXCEPTION_EXECUTE_HANDLER) {
00255 
00256             <span class="keywordflow">return</span> GetExceptionCode();
00257 
00258         }
00259 
00260         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00261 
00262             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00263 
00264         }
00265 
00266     }
00267 
00268 
00269     <span class="comment">//</span>
00270     <span class="comment">// Reference the token object and validate the caller's right</span>
00271     <span class="comment">// to adjust the privileges.</span>
00272     <span class="comment">//</span>
00273 
00274     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00275         DesiredAccess = (TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY);
00276     } <span class="keywordflow">else</span> {
00277         DesiredAccess = TOKEN_ADJUST_PRIVILEGES;
00278     }
00279 
00280     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00281              TokenHandle,             <span class="comment">// Handle</span>
00282              DesiredAccess,           <span class="comment">// DesiredAccess</span>
00283              SepTokenObjectType,      <span class="comment">// ObjectType</span>
00284              PreviousMode,            <span class="comment">// AccessMode</span>
00285              (PVOID *)&amp;Token,         <span class="comment">// Object</span>
00286              NULL                     <span class="comment">// GrantedAccess</span>
00287              );
00288 
00289     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00290 
00291         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00292             <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>(
00293                 CapturedPrivileges,
00294                 PreviousMode,
00295                 TRUE
00296                 );
00297         }
00298 
00299         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00300     }
00301 
00302     <span class="comment">//</span>
00303     <span class="comment">//  Gain exclusive access to the token.</span>
00304     <span class="comment">//</span>
00305 
00306     <a class="code" href="../../d8/d3/tokenp_8h.html#a7">SepAcquireTokenWriteLock</a>( Token );
00307 
00308     <span class="comment">//</span>
00309     <span class="comment">// First pass through the privileges list - just count the changes</span>
00310     <span class="comment">//</span>
00311 
00312 
00313     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a24">SepAdjustPrivileges</a>(
00314                 Token,
00315                 FALSE,                <span class="comment">// Don't make changes this pass</span>
00316                 DisableAllPrivileges,
00317                 CapturedPrivilegeCount,
00318                 CapturedPrivileges,
00319                 PreviousState,
00320                 &amp;LocalReturnLength,
00321                 &amp;ChangeCount,
00322                 &amp;ChangesMade
00323                 );
00324 
00325     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00326 
00327         <span class="keywordflow">try</span> {
00328 
00329             (*ReturnLength) = LocalReturnLength;
00330 
00331         } except(EXCEPTION_EXECUTE_HANDLER) {
00332 
00333             <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, FALSE );
00334             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00335 
00336             <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00337                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>(
00338                     CapturedPrivileges,
00339                     PreviousMode,
00340                     TRUE
00341                     );
00342             }
00343 
00344             <span class="keywordflow">return</span> GetExceptionCode();
00345         }
00346 
00347     }
00348 
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">// Make sure there is enough room to return any  requested</span>
00352     <span class="comment">// information.</span>
00353     <span class="comment">//</span>
00354 
00355     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00356         <span class="keywordflow">if</span> (LocalReturnLength &gt; BufferLength) {
00357 
00358             <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, FALSE );
00359             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00360 
00361             <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00362                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>(
00363                     CapturedPrivileges,
00364                     PreviousMode,
00365                     TRUE
00366                     );
00367             }
00368 
00369             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00370         }
00371     }
00372 
00373     <span class="comment">//</span>
00374     <span class="comment">// Second pass through the privileges list - Make the changes.</span>
00375     <span class="comment">//</span>
00376     <span class="comment">// Note that the internal routine attempts to write the previous</span>
00377     <span class="comment">// state directly to the caller's buffer - and so may get an exception.</span>
00378     <span class="comment">//</span>
00379 
00380     <span class="keywordflow">try</span> {
00381 
00382         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a24">SepAdjustPrivileges</a>(
00383                     Token,
00384                     TRUE,                 <span class="comment">// Make the changes this pass</span>
00385                     DisableAllPrivileges,
00386                     CapturedPrivilegeCount,
00387                     CapturedPrivileges,
00388                     PreviousState,
00389                     &amp;LocalReturnLength,
00390                     &amp;ChangeCount,
00391                     &amp;ChangesMade
00392                     );
00393 
00394 
00395         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00396 
00397             PreviousState-&gt;PrivilegeCount = ChangeCount;
00398         }
00399 
00400     } except(EXCEPTION_EXECUTE_HANDLER) {
00401 
00402         <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, TRUE );
00403         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00404         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00405             <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>(
00406                 CapturedPrivileges,
00407                 PreviousMode,
00408                 TRUE
00409                 );
00410         }
00411         <span class="keywordflow">return</span> GetExceptionCode();
00412 
00413     }
00414 
00415 
00416     <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( Token, ChangesMade );
00417     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00418     <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00419         <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>(
00420             CapturedPrivileges,
00421             PreviousMode,
00422             TRUE
00423             );
00424     }
00425 
00426     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00427 
00428 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="tokenadj.c::SepAdjustGroups" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepAdjustGroups           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MakeChanges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ResetToDefault</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID_AND_ATTRIBUTES NewState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PTOKEN_GROUPS PreviousState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSID SidBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ChangeCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ChangesMade</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l01099">1099</a> of file <a class="el" href="../../d6/d2/tokenadj_8c-source.html">tokenadj.c</a>.
<p>
References <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00226">ANYSIZE_ARRAY</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00479">SepArrayGroupAttributes</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00489">SepTokenGroupAttributes</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00432">NtAdjustGroupsToken()</a>.
<p>
<pre class="fragment"><div>01115                    :
01116 
01117     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to walk <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> groups array in a token as a
01118     result of a request to adjust groups.
01119 
01120     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MakeChanges parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="keyword">this</span> routine simply determines
01121     what changes are needed and how much space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary to save <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01122     current state of changed groups.
01123 
01124     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MakeChanges parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <span class="keyword">this</span> routine will not <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
01125     calculate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space necessary to save <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state, but will
01126     actually make <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> changes.
01127 
01128     This routine makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following assumptions:
01129 
01130       1) The token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked <span class="keywordflow">for</span> exclusive access.
01131 
01132       2) The NewState parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> captured and accesses
01133          to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will not result in access violations.
01134 
01135       4) Any access violations encountered may leave <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request
01136          partially completed.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling routine's responsibility
01137          to <span class="keywordflow">catch</span> exceptions.
01138 
01139       5) The calling routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> inrementing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token's
01140          ModifiedId field.
01141 
01142 Arguments:
01143 
01144     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to act upon.
01145 
01146     MakeChanges - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> value indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> changes should
01147         actually be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>, or just evaluated.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates
01148         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> changes should be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>.
01149 
01150     ResetToDefault - Indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> groups are to be reset to their
01151         <span class="keywordflow">default</span> enabled/disabled state.
01152 
01153     GroupCount - This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NewState parameter
01154         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  In that <span class="keywordflow">case</span>, <span class="keyword">this</span> parameter indicates how many entries are
01155         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NewState parameter.
01156 
01157     NewState - This parameter points to a SID_AND_ATTRIBUTES array
01158         containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> groups whose states are to be adjusted
01159         (disabled or enabled).  Only <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Enabled flag of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01160         attributes associated with each group <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  It provides
01161         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01162         token.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ResetToDefault argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01163         then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.  Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be passed.
01164 
01165     PreviousState - This (optional) parameter points to a buffer to
01166         receive the state of any groups actually changed by this
01167         request.  This information is formated as a TOKEN_GROUPS data
01168         structure which may be passed as the NewState parameter in a
01169         subsequent call to NtAdjustGroups to restore the original state
01170         of those groups.  It is the caller's responsibility to make
01171         sure this buffer is large enough to receive all the state
01172         information.
01173 
01174     SidBuffer - Pointer to buffer to receive the SID values corresponding
01175         to the groups returned in the PreviousState argument.
01176 
01177     ReturnLength - Points to a buffer to receive the number of bytes needed
01178         to retrieve the previous state information of changed privileges.
01179         This parameter is ignored if the PreviousState argument is not
01180         passed.
01181 
01182     ChangeCount - Points to a ULONG to receive the number of groups
01183         which were adjusted (or would be adjusted, if changes are made).
01184 
01185     ChangesMade - Points to a <span class="keywordtype">boolean</span> flag which is to receive an indication
01186         as to whether any changes were made as a result of this call.  This
01187         is expected to be used to decide whether or not to increment the
01188         token's ModifiedId field.
01189 
01190 Return Value:
01191 
01192     STATUS_SUCCESS - Call completed sccessfully.
01193 
01194     STATUS_NOT_ALL_ASSIGNED - Indicates not all the specified adjustments
01195         have been made (or could be made, if update wasn't requested).
01196 
01197     STATUS_CANT_DISABLE_MANDATORY - Not all adjustments were made (or could
01198         be made, if update not requested) because an attempt was made to
01199         disable a mandatory group.  The state of the groups is left
01200         in an underterministic state if update was requested.
01201 
01202 
01203 --*/
01204 {
01205 
01206     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> CompletionStatus = STATUS_SUCCESS;
01207 
01208     ULONG OldIndex;
01209     ULONG NewIndex;
01210     ULONG SidLength;
01211     ULONG LocalReturnLength = 0;
01212     PSID NextSid;
01213     BOOLEAN Found;
01214     ULONG MatchCount = 0;
01215     BOOLEAN EnableGroup;
01216     BOOLEAN DisableGroup;
01217     ULONG TokenGroupAttributes;
01218 
01219     SID_AND_ATTRIBUTES CurrentGroup;
01220 
01221     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01222 
01223     <span class="comment">//</span>
01224     <span class="comment">// NextSid is used to copy group SID values if asked for previous state.</span>
01225     <span class="comment">//</span>
01226 
01227     NextSid = SidBuffer;
01228 
01229 
01230     <span class="comment">//</span>
01231     <span class="comment">//  Walk through the groups array to determine which need to be</span>
01232     <span class="comment">//  adjusted.</span>
01233     <span class="comment">//</span>
01234 
01235     OldIndex = 1;             <span class="comment">// Don't evaluate the 0th entry (user ID)</span>
01236     (*ChangeCount) = 0;
01237 
01238     <span class="keywordflow">while</span> (OldIndex &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount) {
01239 
01240         CurrentGroup = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[OldIndex];
01241 
01242         <span class="keywordflow">if</span> (ResetToDefault) {
01243 
01244             TokenGroupAttributes = <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex);
01245 
01246             <span class="comment">//</span>
01247             <span class="comment">// If the group is enabled by default and currently disabled,</span>
01248             <span class="comment">// then we must enable it.</span>
01249             <span class="comment">//</span>
01250 
01251             EnableGroup = (BOOLEAN)( (TokenGroupAttributes &amp; SE_GROUP_ENABLED_BY_DEFAULT)
01252                 &amp;&amp; !(TokenGroupAttributes &amp; SE_GROUP_ENABLED));
01253 
01254             <span class="comment">//</span>
01255             <span class="comment">// If the group is disabled by default and currently enabled,</span>
01256             <span class="comment">// then we must disable it.</span>
01257             <span class="comment">//</span>
01258 
01259             DisableGroup = (BOOLEAN)( !(TokenGroupAttributes &amp; SE_GROUP_ENABLED_BY_DEFAULT)
01260                 &amp;&amp; (TokenGroupAttributes &amp; SE_GROUP_ENABLED));
01261 
01262             <span class="comment">//</span>
01263             <span class="comment">// Blow up if it's a mandatory group that is not both</span>
01264             <span class="comment">// enabled by default and enabled (SepCreateToken should</span>
01265             <span class="comment">// make sure that this never happens).</span>
01266             <span class="comment">//</span>
01267 
01268             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(TokenGroupAttributes &amp; SE_GROUP_MANDATORY)
01269                    || (TokenGroupAttributes &amp; (SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_ENABLED)
01270                        == (SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_ENABLED)));
01271 
01272             <span class="keywordflow">if</span> ( EnableGroup || DisableGroup ) {
01273 
01274                 SidLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( CurrentGroup.Sid );
01275                 SidLength = (ULONG)LongAlignSize(SidLength);
01276                 LocalReturnLength += SidLength;
01277 
01278                 <span class="comment">//</span>
01279                 <span class="comment">// Change, if necessary (saving previous state if</span>
01280                 <span class="comment">// appropriate).</span>
01281                 <span class="comment">//</span>
01282 
01283                 <span class="keywordflow">if</span> (MakeChanges) {
01284 
01285                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01286 
01287                         (*(PreviousState)).Groups[(*ChangeCount)].Attributes =
01288                             CurrentGroup.Attributes;
01289 
01290                         (*(PreviousState)).Groups[(*ChangeCount)].Sid =
01291                             NextSid;
01292 
01293                         <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( SidLength, NextSid, CurrentGroup.Sid );
01294                         NextSid = (PSID)((ULONG_PTR)NextSid + SidLength);
01295                     }
01296 
01297                     <span class="keywordflow">if</span> (EnableGroup) {
01298                         <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex) |= SE_GROUP_ENABLED;
01299                     } <span class="keywordflow">else</span> {
01300                         <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex) &amp;= ~SE_GROUP_ENABLED;
01301                     }
01302 
01303 
01304 
01305                 } <span class="comment">//endif make changes</span>
01306 
01307                 <span class="comment">//</span>
01308                 <span class="comment">// increment the number of changes</span>
01309                 <span class="comment">//</span>
01310 
01311                 (*ChangeCount) += 1;
01312 
01313             } <span class="comment">// endif group enabled</span>
01314 
01315         } <span class="keywordflow">else</span> {
01316 
01317             <span class="comment">//</span>
01318             <span class="comment">//  Selective adjustments - this is a little trickier</span>
01319             <span class="comment">//  Compare the current group to each of those in</span>
01320             <span class="comment">//  the NewState array.  If a match is found, then adjust</span>
01321             <span class="comment">//  the current group appropriately.</span>
01322             <span class="comment">//</span>
01323 
01324             NewIndex = 0;
01325             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01326 
01327             <span class="keywordflow">while</span> ( (NewIndex &lt; GroupCount) &amp;&amp; !Found)  {
01328 
01329                 <span class="comment">//</span>
01330                 <span class="comment">// Look for a comparison</span>
01331                 <span class="comment">//</span>
01332 
01333                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(
01334                         CurrentGroup.Sid,
01335                         NewState[NewIndex].Sid
01336                         ) ) {
01337 
01338                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01339                     MatchCount += 1;
01340 
01341 
01342                     <span class="comment">//</span>
01343                     <span class="comment">// See if it needs to be changed</span>
01344                     <span class="comment">//</span>
01345 
01346                     <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d3/tokenp_8h.html#a12">SepArrayGroupAttributes</a>( NewState, NewIndex ) &amp;
01347                             SE_GROUP_ENABLED ) !=
01348                          (<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex) &amp;
01349                             SE_GROUP_ENABLED ) ) {
01350 
01351                         <span class="comment">//</span>
01352                         <span class="comment">// Make sure group is not mandatory</span>
01353                         <span class="comment">//</span>
01354 
01355                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex) &amp;
01356                               SE_GROUP_MANDATORY ) {
01357                             <span class="keywordflow">return</span> STATUS_CANT_DISABLE_MANDATORY;
01358                         }
01359 
01360                         <span class="comment">//</span>
01361                         <span class="comment">// Make sure group is not deny-only</span>
01362                         <span class="comment">//</span>
01363 
01364 
01365                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex) &amp;
01366                               SE_GROUP_USE_FOR_DENY_ONLY ) {
01367                             <span class="keywordflow">return</span> STATUS_CANT_ENABLE_DENY_ONLY;
01368                         }
01369 
01370                         SidLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( CurrentGroup.Sid );
01371                         SidLength = (ULONG)LongAlignSize(SidLength);
01372                         LocalReturnLength += SidLength;
01373 
01374                         <span class="comment">//</span>
01375                         <span class="comment">// Change, if necessary (saving previous state if</span>
01376                         <span class="comment">// appropriate).</span>
01377                         <span class="comment">//</span>
01378 
01379                         <span class="keywordflow">if</span> (MakeChanges) {
01380 
01381                             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01382 
01383                                 PreviousState-&gt;Groups[(*ChangeCount)].Attributes =
01384                                     CurrentGroup.Attributes;
01385 
01386                                 PreviousState-&gt;Groups[(*ChangeCount)].Sid =
01387                                     NextSid;
01388 
01389                                 <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( SidLength, NextSid, CurrentGroup.Sid );
01390 
01391                                 NextSid = (PSID)((ULONG_PTR)NextSid + SidLength);
01392                             }
01393 
01394                             <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex) &amp;=
01395                                 ~(<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex)
01396                                   &amp; SE_GROUP_ENABLED);
01397                             <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex) |=
01398                                  (<a class="code" href="../../d8/d3/tokenp_8h.html#a12">SepArrayGroupAttributes</a>(NewState,NewIndex)
01399                                   &amp; SE_GROUP_ENABLED);
01400 
01401 
01402 
01403                         } <span class="comment">//endif make changes</span>
01404 
01405                         <span class="comment">//</span>
01406                         <span class="comment">// increment the number of changes</span>
01407                         <span class="comment">//</span>
01408 
01409                         (*ChangeCount) += 1;
01410 
01411 
01412                     } <span class="comment">// endif change needed</span>
01413 
01414                 } <span class="comment">// endif found</span>
01415 
01416                 NewIndex += 1;
01417 
01418             } <span class="comment">// endwhile searching NewState</span>
01419 
01420         } <span class="comment">// endelse</span>
01421 
01422         OldIndex += 1;
01423 
01424     } <span class="comment">// endwhile more groups in token</span>
01425 
01426     <span class="comment">//</span>
01427     <span class="comment">// Set completion status appropriately if some not assigned</span>
01428     <span class="comment">//</span>
01429 
01430     <span class="keywordflow">if</span> (!ResetToDefault) {
01431 
01432         <span class="keywordflow">if</span> (MatchCount &lt; GroupCount) {
01433             CompletionStatus = STATUS_NOT_ALL_ASSIGNED;
01434         }
01435     }
01436 
01437     <span class="comment">//</span>
01438     <span class="comment">//  Indicate whether changes were made</span>
01439     <span class="comment">//</span>
01440 
01441     <span class="keywordflow">if</span> ((*ChangeCount) &gt; 0  &amp;&amp;  MakeChanges) {
01442         (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01443     } <span class="keywordflow">else</span> {
01444         (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01445     }
01446 
01447     <span class="comment">//</span>
01448     <span class="comment">// Calculate the space needed to return previous state information</span>
01449     <span class="comment">// (The SID lengths have already been added up in LocalReturnLength).</span>
01450     <span class="comment">//</span>
01451 
01452     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01453 
01454         (*ReturnLength) = LocalReturnLength +
01455                           (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
01456                           ((*ChangeCount) *  (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES)) -
01457                           (<a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> * (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES));
01458     }
01459 
01460    <span class="keywordflow">return</span> CompletionStatus;
01461 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="tokenadj.c::SepAdjustPrivileges" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepAdjustPrivileges           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MakeChanges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DisableAllPrivileges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG PrivilegeCount&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID_AND_ATTRIBUTES NewState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PTOKEN_PRIVILEGES PreviousState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ChangeCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ChangesMade</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00819">819</a> of file <a class="el" href="../../d6/d2/tokenadj_8c-source.html">tokenadj.c</a>.
<p>
References <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00226">ANYSIZE_ARRAY</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00432">DisableAllPrivileges()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01691">SeChangeNotifyPrivilege</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00460">SepArrayPrivilegeAttributes</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00470">SepTokenPrivilegeAttributes</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00072">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00046">NtAdjustPrivilegesToken()</a>.
<p>
<pre class="fragment"><div>00834                    :
00835 
00836     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to walk <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privileges array in a token as a
00837     result of a request to adjust privileges.
00838 
00839     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MakeChanges parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="keyword">this</span> routine simply determines
00840     what changes are needed and how much space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary to save <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00841     current state of changed privileges.
00842 
00843     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MakeChanges parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <span class="keyword">this</span> routine will not <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
00844     calculate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space necessary to save <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state, but will
00845     actually make <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> changes.
00846 
00847     This routine makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following assumptions:
00848 
00849       1) The token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked <span class="keywordflow">for</span> exclusive access.
00850 
00851       2) The PrivilegeCount and NewState parameters (<span class="keywordflow">if</span> passed) are captured
00852          and accesses to them will not result in access violations.
00853 
00854       4) Any access violations encountered may leave <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request
00855          partially completed.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling routine's responsibility
00856          to <span class="keywordflow">catch</span> exceptions.
00857 
00858       5) The calling routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> inrementing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token's
00859          ModifiedId field.
00860 
00861 Arguments:
00862 
00863     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to act upon.
00864 
00865     MakeChanges - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> value indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> changes should
00866         actually be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>, or just evaluated.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates
00867         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> changes should be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>.
00868 
00869     DisableAllPrivilegs - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> value indicating whether all privileges
00870         are to be disabled, or <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> select, specified privileges.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value
00871         of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates all privileges are to be disabled.
00872 
00873     PrivilegeCount - This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NewState parameter
00874         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  In that <span class="keywordflow">case</span>, <span class="keyword">this</span> parameter indicates how many entries are
00875         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NewState parameter.
00876 
00877     NewState - This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>
00878         argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00879         then <span class="keyword">this</span> parameter must be provided and specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> state
00880         to set privileges to (enabled or disabled).
00881 
00882     PreviousState - This (optional) parameter points to a buffer to
00883         receive the state of any privileges actually changed by this
00884         request.  This information is formated as a TOKEN_PRIVILEGES data
00885         structure which may be passed as the NewState parameter in a
00886         subsequent call to NtAdjustPrivileges to restore the original state
00887         of those privileges.  It is the caller's responsibility to make
00888         sure this buffer is large enough to receive all the state
00889         information.
00890 
00891     ReturnLength - Points to a buffer to receive the number of bytes needed
00892         to retrieve the previous state information of changed privileges.
00893         This parameter is ignored if the PreviousState argument is not
00894         passed.
00895 
00896     ChangeCount - Points to a ULONG to receive the number of privileges
00897         which were adjusted (or would be adjusted, if changes are made).
00898 
00899     ChangesMade - Points to a <span class="keywordtype">boolean</span> flag which is to receive an indication
00900         as to whether any changes were made as a result of this call.  This
00901         is expected to be used to decide whether or not to increment the
00902         token's ModifiedId field.
00903 
00904 Return Value:
00905 
00906     STATUS_SUCCESS - Call completed sccessfully.
00907 
00908     STATUS_NOT_ALL_ASSIGNED - Indicates not all the specified adjustments
00909         have been made (or could be made, if update wasn't requested).
00910 
00911 --*/
00912 {
00913     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> CompletionStatus = STATUS_SUCCESS;
00914 
00915     ULONG OldIndex;
00916     ULONG NewIndex;
00917     BOOLEAN Found;
00918     ULONG MatchCount = 0;
00919 
00920     LUID_AND_ATTRIBUTES CurrentPrivilege;
00921 
00922     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00923 
00924     <span class="comment">//</span>
00925     <span class="comment">//  Walk through the privileges array to determine which need to be</span>
00926     <span class="comment">//  adjusted.</span>
00927     <span class="comment">//</span>
00928 
00929     OldIndex = 0;
00930     (*ChangeCount) = 0;
00931 
00932     <span class="keywordflow">while</span> (OldIndex &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount) {
00933 
00934         CurrentPrivilege = (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[OldIndex];
00935 
00936         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
00937 
00938             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(Token,OldIndex) &amp;
00939                SE_PRIVILEGE_ENABLED ) {
00940 
00941                 <span class="comment">//</span>
00942                 <span class="comment">// Change, if necessary (saving previous state if</span>
00943                 <span class="comment">// appropriate).</span>
00944                 <span class="comment">//</span>
00945 
00946                 <span class="keywordflow">if</span> (MakeChanges) {
00947 
00948                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00949 
00950                         PreviousState-&gt;Privileges[(*ChangeCount)] =
00951                             CurrentPrivilege;
00952                     }
00953 
00954                     <a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(Token,OldIndex) &amp;=
00955                         ~SE_PRIVILEGE_ENABLED;
00956 
00957 
00958 
00959                 } <span class="comment">//endif make changes</span>
00960 
00961                 <span class="comment">//</span>
00962                 <span class="comment">// increment the number of changes</span>
00963                 <span class="comment">//</span>
00964 
00965                 (*ChangeCount) += 1;
00966 
00967             } <span class="comment">// endif privilege enabled</span>
00968 
00969         } <span class="keywordflow">else</span> {
00970 
00971             <span class="comment">//</span>
00972             <span class="comment">//  Selective adjustments - this is a little trickier</span>
00973             <span class="comment">//  Compare the current privilege to each of those in</span>
00974             <span class="comment">//  the NewState array.  If a match is found, then adjust</span>
00975             <span class="comment">//  the current privilege appropriately.</span>
00976             <span class="comment">//</span>
00977 
00978             NewIndex = 0;
00979             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00980 
00981             <span class="keywordflow">while</span> ( (NewIndex &lt; PrivilegeCount) &amp;&amp; !Found)  {
00982 
00983                 <span class="comment">//</span>
00984                 <span class="comment">// Look for a comparison</span>
00985                 <span class="comment">//</span>
00986 
00987                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;CurrentPrivilege.Luid,&amp;NewState[NewIndex].Luid)) {
00988 
00989                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00990                     MatchCount += 1;
00991 
00992                     <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d3/tokenp_8h.html#a10">SepArrayPrivilegeAttributes</a>( NewState, NewIndex ) &amp;
00993                           SE_PRIVILEGE_ENABLED)
00994                         !=
00995                          (<a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(Token,OldIndex) &amp;
00996                           SE_PRIVILEGE_ENABLED)  ) {
00997 
00998                         <span class="comment">//</span>
00999                         <span class="comment">// Change, if necessary (saving previous state if</span>
01000                         <span class="comment">// appropriate).</span>
01001                         <span class="comment">//</span>
01002 
01003                         <span class="keywordflow">if</span> (MakeChanges) {
01004 
01005                             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01006 
01007                                 PreviousState-&gt;Privileges[(*ChangeCount)] =
01008                                     CurrentPrivilege;
01009                             }
01010 
01011                             <a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(Token,OldIndex) &amp;=
01012                                 ~(<a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(Token,OldIndex)
01013                                   &amp; SE_PRIVILEGE_ENABLED);
01014                             <a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(Token,OldIndex) |=
01015                                  (<a class="code" href="../../d8/d3/tokenp_8h.html#a10">SepArrayPrivilegeAttributes</a>(NewState,NewIndex)
01016                                   &amp; SE_PRIVILEGE_ENABLED);
01017 
01018                             <span class="comment">//</span>
01019                             <span class="comment">// if this is SeChangeNotifyPrivilege, then</span>
01020                             <span class="comment">// change its corresponding bit in TokenFlags</span>
01021                             <span class="comment">//</span>
01022 
01023                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;CurrentPrivilege.Luid,
01024                                               &amp;SeChangeNotifyPrivilege)) {
01025                                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags ^= <a class="code" href="../../d0/d5/se_8h.html#a1">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>;
01026                             }
01027 
01028 
01029 
01030                         } <span class="comment">//endif make changes</span>
01031 
01032                         <span class="comment">//</span>
01033                         <span class="comment">// increment the number of changes</span>
01034                         <span class="comment">//</span>
01035 
01036                         (*ChangeCount) += 1;
01037 
01038 
01039                     } <span class="comment">// endif change needed</span>
01040 
01041                 } <span class="comment">// endif found</span>
01042 
01043                 NewIndex += 1;
01044 
01045             } <span class="comment">// endwhile searching NewState</span>
01046 
01047         } <span class="comment">// endelse</span>
01048 
01049         OldIndex += 1;
01050 
01051     } <span class="comment">// endwhile privileges in token</span>
01052 
01053     <span class="comment">//</span>
01054     <span class="comment">// If we disabled all privileges, then clear the TokenFlags flag</span>
01055     <span class="comment">// corresponding to the SeChangeNotifyPrivilege privilege.</span>
01056     <span class="comment">//</span>
01057 
01058 
01059     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
01060         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags &amp;= ~<a class="code" href="../../d0/d5/se_8h.html#a1">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>;
01061     }
01062 
01063     <span class="comment">//</span>
01064     <span class="comment">// Set completion status appropriately if some not assigned</span>
01065     <span class="comment">//</span>
01066 
01067     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
01068 
01069         <span class="keywordflow">if</span> (MatchCount &lt; PrivilegeCount) {
01070             CompletionStatus = STATUS_NOT_ALL_ASSIGNED;
01071         }
01072     }
01073 
01074     <span class="comment">//</span>
01075     <span class="comment">//  Indicate whether changes were made</span>
01076     <span class="comment">//</span>
01077 
01078     <span class="keywordflow">if</span> ((*ChangeCount) &gt; 0  &amp;&amp;  MakeChanges) {
01079         (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01080     } <span class="keywordflow">else</span> {
01081         (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01082     }
01083 
01084     <span class="comment">//</span>
01085     <span class="comment">// Calculate the space needed to return previous state information</span>
01086     <span class="comment">//</span>
01087 
01088     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01089 
01090         (*ReturnLength) = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIVILEGES) +
01091                           ((*ChangeCount) *  (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)) -
01092                           (<a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> * (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES));
01093     }
01094 
01095    <span class="keywordflow">return</span> CompletionStatus;
01096 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:47 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
