<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: acons.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>acons.c</h1><a href="../../d4/d4/kernel_2acons_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: acons.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains code for dealing with animated icons/cursors.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 10-02-91 DarrinM      Created.</span>
00010 <span class="comment">* 07-30-92 DarrinM      Unicodized.</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="comment">/***************************************************************************\</span>
00017 <span class="comment">* _SetSystemCursor (API)</span>
00018 <span class="comment">*</span>
00019 <span class="comment">* Replace a system (aka 'public') cursor with a user provided one.  The new</span>
00020 <span class="comment">* cursor is pulled from a file (.CUR, .ICO, or .ANI) specified in WIN.INI.</span>
00021 <span class="comment">*</span>
00022 <span class="comment">* History:</span>
00023 <span class="comment">* 12-26-91 DarrinM      Created.</span>
00024 <span class="comment">* 08-04-92 DarrinM      Recreated.</span>
00025 <span class="comment">* 10/14/1995 SanfordS   Win95 support.</span>
00026 <span class="comment">\***************************************************************************/</span>
00027 
<a name="l00028"></a><a class="code" href="../../d4/d1/userk_8h.html#a1110">00028</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1110">zzzSetSystemCursor</a>(
00029     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur,
00030     DWORD <span class="keywordtype">id</span>)
00031 {
00032     <span class="keywordtype">int</span> i;
00033 
00034     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a9">CheckWinstaWriteAttributesAccess</a>()) {
00035         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00036     }
00037 
00038     UserAssert(pcur);
00039 
00040     <span class="comment">/*</span>
00041 <span class="comment">     * Check if this cursor is one of the replaceable ones.</span>
00042 <span class="comment">     */</span>
00043     <span class="keywordflow">for</span> (i = 0; i &lt; COCR_CONFIGURABLE; i++)
00044         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a156">gasyscur</a>[i].<a class="code" href="../../d9/d7/structtagSYSCFGICO.html#o0">Id</a> == (WORD)<span class="keywordtype">id</span>)
00045             <span class="keywordflow">break</span>;
00046 
00047     <span class="comment">/*</span>
00048 <span class="comment">     * Not replaceable, bail out.</span>
00049 <span class="comment">     */</span>
00050     <span class="keywordflow">if</span> (i == COCR_CONFIGURABLE) {
00051         RIPMSG1(RIP_WARNING, <span class="stringliteral">"_SetSystemCursor: called with bad id %x.\n"</span>, <span class="keywordtype">id</span>);
00052         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00053     }
00054 
00055     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1111">zzzSetSystemImage</a>(pcur, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a156">gasyscur</a>[i].spcur);
00056 }
00057 
00058 
00059 <span class="comment">/***********************************************************************\</span>
00060 <span class="comment">* SetSystemImage</span>
00061 <span class="comment">*</span>
00062 <span class="comment">* Places the contents of pcur into pcurSys and destroys pcur.</span>
00063 <span class="comment">*</span>
00064 <span class="comment">* Returns: fSuccess</span>
00065 <span class="comment">*</span>
00066 <span class="comment">* 10/14/1995 Created SanfordS</span>
00067 <span class="comment">\***********************************************************************/</span>
00068 
<a name="l00069"></a><a class="code" href="../../d4/d1/userk_8h.html#a1111">00069</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1111">zzzSetSystemImage</a>(
00070     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur,
00071     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcurSys)
00072 {
00073 <span class="preprocessor">#define CBCOPY (max(sizeof(CURSOR), sizeof(ACON)) - FIELD_OFFSET(CURSOR, CI_COPYSTART))</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#define pacon ((PACON)pcur)</span>
00075 <span class="preprocessor"></span>
00076     <span class="keywordtype">char</span> cbT[<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a0">CBCOPY</a>];
00077     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> CURSORF_flags;
00078 
00079     UserAssert(pcurSys);
00080 
00081     <span class="keywordflow">if</span> (pcurSys == pcur)
00082         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00083 
00084     <span class="comment">/*</span>
00085 <span class="comment">     * All ssytem images being replaced should have ordinal names</span>
00086 <span class="comment">     * and reference the USER module and be unowned.</span>
00087 <span class="comment">     */</span>
00088     UserAssert(!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pcurSys-&gt;strName.Buffer));
00089     UserAssert(pcurSys-&gt;atomModName == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a297">atomUSER32</a>);
00090 
00091     <span class="comment">/*</span>
00092 <span class="comment">     * if pcur was an acon, transfer frame ownerships to pcurSys.</span>
00093 <span class="comment">     */</span>
00094     UserAssert(pcurSys-&gt;head.ppi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00095     <span class="keywordflow">if</span> (pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a> &amp;&amp;
00096             pcur-&gt;head.ppi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00097 
00098         <span class="keywordtype">int</span> i;
00099         <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> phe = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a446">HMPheFromObject</a>(pcurSys);
00100         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiOwner = ((<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>)-&gt;ptiList;
00101 
00102         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;cpcur; i++) {
00103             <a class="code" href="../../d4/d1/userk_8h.html#a111">HMChangeOwnerProcess</a>(<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[i], ptiOwner);
00104             <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[i]-&gt;head.ppi = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00105         }
00106     }
00107 
00108     <span class="comment">/*</span>
00109 <span class="comment">     * If this assert fails, the CURSOR and ACON structures were changed</span>
00110 <span class="comment">     * incorrectly - read the comments in user.h and wingdi.w around</span>
00111 <span class="comment">     * tagCURSOR, tagACON, and CURSINFO.</span>
00112 <span class="comment">     */</span>
00113     UserAssert(FIELD_OFFSET(<a class="code" href="../../d6/d1/structtagCURSOR.html">CURSOR</a>, CI_FIRST) == FIELD_OFFSET(<a class="code" href="../../d1/d8/structtagACON.html">ACON</a>, CI_FIRST));
00114 
00115     <span class="comment">/*</span>
00116 <span class="comment">     * swap everything starting from CI_COPYSTART.</span>
00117 <span class="comment">     */</span>
00118     RtlCopyMemory(&amp;cbT, &amp;pcur-&gt;CI_COPYSTART, <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a0">CBCOPY</a>);
00119     RtlCopyMemory(&amp;pcur-&gt;CI_COPYSTART, &amp;pcurSys-&gt;CI_COPYSTART, <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a0">CBCOPY</a>);
00120     RtlCopyMemory(&amp;pcurSys-&gt;CI_COPYSTART, &amp;cbT, <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a0">CBCOPY</a>);
00121     <span class="comment">/*</span>
00122 <span class="comment">     * Swap the CURSORF_ACON flags since they go with the swapped data.</span>
00123 <span class="comment">     */</span>
00124     CURSORF_flags = pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>;
00125     pcur-&gt;CURSORF_flags =
00126             (pcur-&gt;CURSORF_flags    &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>) |
00127             (pcurSys-&gt;CURSORF_flags &amp;  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>);
00128     pcurSys-&gt;CURSORF_flags =
00129             (pcurSys-&gt;CURSORF_flags &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>) | CURSORF_flags;
00130 
00131     <span class="comment">/*</span>
00132 <span class="comment">     * If we swapped acons into pcur, then we need to change the ownerhsip to</span>
00133 <span class="comment">     *  make sure they can get destroyed</span>
00134 <span class="comment">     */</span>
00135     <span class="keywordflow">if</span> (pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>) {
00136         <span class="keywordtype">int</span> i;
00137         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00138         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;cpcur; i++) {
00139             <a class="code" href="../../d4/d1/userk_8h.html#a111">HMChangeOwnerProcess</a>(<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[i], ptiCurrent);
00140         }
00141     }
00142 
00143     <span class="comment">/*</span>
00144 <span class="comment">     * Use THREADCLEANUP so system cursors are not destroyed.</span>
00145 <span class="comment">     */</span>
00146     <a class="code" href="../../d4/d1/userk_8h.html#a1782">_DestroyCursor</a>(pcur, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a533">CURSOR_THREADCLEANUP</a>);
00147 
00148 
00149     <span class="comment">/*</span>
00150 <span class="comment">     * If the current logical current is changing the force the current physical</span>
00151 <span class="comment">     * cursor to change.</span>
00152 <span class="comment">     */</span>
00153     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a83">gpcurLogCurrent</a> == pcurSys) {
00154         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a83">gpcurLogCurrent</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00155         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a84">gpcurPhysCurrent</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00156         <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a11">zzzUpdateCursorImage</a>();
00157     }
00158 
00159     <span class="comment">/*</span>
00160 <span class="comment">     * Mark the cursor as a system cursor that can be shadowed by GDI.</span>
00161 <span class="comment">     */</span>
00162     pcurSys-&gt;CURSORF_flags |= CURSORF_SYSTEM;
00163 
00164     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00165 <span class="preprocessor">#undef pacon</span>
00166 <span class="preprocessor"></span><span class="preprocessor">#undef CBCOPY</span>
00167 <span class="preprocessor"></span>}
00168 
00169 
00170 
00171 <span class="comment">/***************************************************************************\</span>
00172 <span class="comment">* _GetCursorFrameInfo (API)</span>
00173 <span class="comment">*</span>
00174 <span class="comment">* Example usage:</span>
00175 <span class="comment">*</span>
00176 <span class="comment">* hcur = _GetCursorFrameInfo(hacon, NULL, 4, &amp;ccur);</span>
00177 <span class="comment">* hcur = _GetCursorFrameInfo(NULL, IDC_NORMAL, 0, &amp;ccur); // get device's arrow</span>
00178 <span class="comment">*</span>
00179 <span class="comment">* History:</span>
00180 <span class="comment">* 08-05-92 DarrinM      Created.</span>
00181 <span class="comment">\***************************************************************************/</span>
00182 
<a name="l00183"></a><a class="code" href="../../d4/d1/userk_8h.html#a1115">00183</a> <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> <a class="code" href="../../d4/d1/userk_8h.html#a1115">_GetCursorFrameInfo</a>(
00184     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur,
00185     <span class="keywordtype">int</span>     iFrame,
00186     PJIF    pjifRate,
00187     LPINT   pccur)
00188 {
00189     <span class="comment">/*</span>
00190 <span class="comment">     * If this is only a single cursor (not an ACON) just return it and</span>
00191 <span class="comment">     * a frame count of 1.</span>
00192 <span class="comment">     */</span>
00193     <span class="keywordflow">if</span> (!(pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>)) {
00194         *pccur = 1;
00195         *pjifRate = 0;
00196         <span class="keywordflow">return</span> pcur;
00197     }
00198 
00199     <span class="comment">/*</span>
00200 <span class="comment">     * Return the useful cursor information for the specified frame</span>
00201 <span class="comment">     * of the ACON.</span>
00202 <span class="comment">     */</span>
00203 <span class="preprocessor">#define pacon ((PACON)pcur)</span>
00204 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (iFrame &lt; 0 || iFrame &gt;= <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;cicur)
00205         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00206 
00207     *pccur = <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;cicur;
00208     *pjifRate = <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;ajifRate[iFrame];
00209 
00210     <span class="keywordflow">return</span> <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aicur[iFrame]];
00211 <span class="preprocessor">#undef pacon</span>
00212 <span class="preprocessor"></span>}
00213 
00214 
00215 <span class="comment">/***************************************************************************\</span>
00216 <span class="comment">* DestroyAniIcon</span>
00217 <span class="comment">*</span>
00218 <span class="comment">* Free all the individual cursors that make up the frames of an animated</span>
00219 <span class="comment">* icon.</span>
00220 <span class="comment">*</span>
00221 <span class="comment">* WARNING: DestroyAniIcon assumes that all fields that an ACON shares with</span>
00222 <span class="comment">* a cursor will be freed by some cursor code (probably the cursor function</span>
00223 <span class="comment">* that calls this one).</span>
00224 <span class="comment">*</span>
00225 <span class="comment">* History:</span>
00226 <span class="comment">* 08-04-92 DarrinM      Created.</span>
00227 <span class="comment">\***************************************************************************/</span>
00228 
<a name="l00229"></a><a class="code" href="../../d4/d4/kernel_2acons_8c.html#a7">00229</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a7">DestroyAniIcon</a>(
00230     <a class="code" href="../../d1/d8/structtagACON.html">PACON</a> pacon)
00231 {
00232     <span class="keywordtype">int</span> i;
00233     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur;
00234 
00235     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;cpcur; i++) {
00236         UserAssert(<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[i]-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a539">CURSORF_ACONFRAME</a>);
00237         <span class="comment">/*</span>
00238 <span class="comment">         * This should not be a public acon; if it is, unlock won't be able</span>
00239 <span class="comment">         *  to destroy it. If destroy a public icon, ownership must be called</span>
00240 <span class="comment">         *  before calling this function (see zzzSetSystemImage)</span>
00241 <span class="comment">         */</span>
00242         UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a457">GETPPI</a>(<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[i]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00243         pcur = <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[i]);
00244         <span class="keywordflow">if</span> (pcur != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00245             <a class="code" href="../../d4/d1/userk_8h.html#a1782">_DestroyCursor</a>(pcur, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a531">CURSOR_ALWAYSDESTROY</a>);
00246         }
00247     }
00248 
00249     UserFreePool(<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur);
00250 
00251     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00252 }
00253 
00254 
00255 <span class="comment">/***********************************************************************\</span>
00256 <span class="comment">* LinkCursor</span>
00257 <span class="comment">*</span>
00258 <span class="comment">* Links unlinked cursor into the apropriate icon cache IFF its the</span>
00259 <span class="comment">* type of cursor that needs to be in the cache.</span>
00260 <span class="comment">*</span>
00261 <span class="comment">* Note that changing ownership if cursor objects needs to keep this</span>
00262 <span class="comment">* cache linking in mind.  The unlink routine in</span>
00263 <span class="comment">* DestroyEmptyCursorObject() will handle public cursor objects made</span>
00264 <span class="comment">* local but that is all.</span>
00265 <span class="comment">*</span>
00266 <span class="comment">* 10/18/1995 Created SanfordS</span>
00267 <span class="comment">\***********************************************************************/</span>
00268 
<a name="l00269"></a><a class="code" href="../../d4/d1/userk_8h.html#a1113">00269</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1113">LinkCursor</a>(
00270     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur)
00271 {
00272     <span class="comment">/*</span>
00273 <span class="comment">     * Should never try to link twice!</span>
00274 <span class="comment">     */</span>
00275     UserAssert(!(pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a541">CURSORF_LINKED</a>));
00276     <span class="comment">/*</span>
00277 <span class="comment">     * We don't cache acon frames because they all belong to the</span>
00278 <span class="comment">     * root acon object.</span>
00279 <span class="comment">     *</span>
00280 <span class="comment">     * We don't cache process owned objects that are not LRSHARED</span>
00281 <span class="comment">     * either.</span>
00282 <span class="comment">     */</span>
00283     <span class="keywordflow">if</span> (!(pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a539">CURSORF_ACONFRAME</a>)) {
00284         <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi = pcur-&gt;head.ppi;
00285         <span class="keywordflow">if</span> (ppi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00286             <span class="comment">/*</span>
00287 <span class="comment">             * Public cache object.</span>
00288 <span class="comment">             */</span>
00289             pcur-&gt;pcurNext    = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a155">gpcurFirst</a>;
00290             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a155">gpcurFirst</a>        = pcur;
00291             pcur-&gt;CURSORF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a541">CURSORF_LINKED</a>;
00292         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a536">CURSORF_LRSHARED</a>) {
00293             <span class="comment">/*</span>
00294 <span class="comment">             * Private cache LR_SHARED object.</span>
00295 <span class="comment">             */</span>
00296             pcur-&gt;pcurNext    = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o22">pCursorCache</a>;
00297             ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o22">pCursorCache</a> = pcur;
00298             pcur-&gt;CURSORF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a541">CURSORF_LINKED</a>;
00299         }
00300     }
00301 }
00302 
00303 
00304 
00305 
00306 <span class="comment">/***************************************************************************\</span>
00307 <span class="comment">*</span>
00308 <span class="comment">* Initializes empty cursor/icons.  Note that the string buffers and</span>
00309 <span class="comment">* pcurData are not captured.  If a fault occurs in this routine,</span>
00310 <span class="comment">* all allocated memory will be freed when the cursors are destroyed.</span>
00311 <span class="comment">*</span>
00312 <span class="comment">* Critical side effect:  If this function fails, the bitmaps must NOT</span>
00313 <span class="comment">* have been made public.  (See CreateIconIndirect()).</span>
00314 <span class="comment">*</span>
00315 <span class="comment">* History:</span>
00316 <span class="comment">* 12-01-94 JimA         Created.</span>
00317 <span class="comment">\***************************************************************************/</span>
00318 
<a name="l00319"></a><a class="code" href="../../d4/d1/userk_8h.html#a1114">00319</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1114">_SetCursorIconData</a>(
00320     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur,
00321     PUNICODE_STRING cczpstrModName,
00322     PUNICODE_STRING cczpstrName,
00323     <a class="code" href="../../d8/d1/structtagCURSORDATA.html">PCURSORDATA</a> pcurData,
00324     DWORD cbData)
00325 {
00326 <span class="preprocessor">#define pacon ((PACON)pcur)</span>
00327 <span class="preprocessor"></span>    <span class="keywordtype">int</span> i;
00328 <span class="preprocessor">#if DBG</span>
00329 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess;
00330 <span class="preprocessor">#endif</span>
00331 <span class="preprocessor"></span>
00332     pcur-&gt;CURSORF_flags |= pcurData-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o0">CURSORF_flags</a>;
00333     pcur-&gt;rt = pcurData-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o3">rt</a>;
00334 
00335     <span class="keywordflow">if</span> (pcurData-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o0">CURSORF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>) {
00336         UserAssert(<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00337         RtlCopyMemory(&amp;<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;cpcur,
00338                       &amp;pcurData-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o12">cpcur</a>,
00339                       <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/structtagACON.html">ACON</a>) - FIELD_OFFSET(<a class="code" href="../../d1/d0/inc_2user_8h.html#a1037">ACON</a>, cpcur));
00340     } <span class="keywordflow">else</span> {
00341         RtlCopyMemory(&amp;pcur-&gt;CI_COPYSTART,
00342                       &amp;pcurData-&gt;CI_COPYSTART,
00343                       <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d1/structtagCURSOR.html">CURSOR</a>) - FIELD_OFFSET(<a class="code" href="../../d1/d0/inc_2user_8h.html#a1036">CURSOR</a>, CI_COPYSTART));
00344     }
00345 
00346     <span class="comment">/*</span>
00347 <span class="comment">     * Save name of the cursor resource</span>
00348 <span class="comment">     */</span>
00349     <span class="keywordflow">if</span> (cczpstrName-&gt;Length != 0){
00350         <span class="comment">/*</span>
00351 <span class="comment">         * AllocateUnicodeString guards access to src Buffer with</span>
00352 <span class="comment">         * a try block.</span>
00353 <span class="comment">         */</span>
00354 
00355         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1533">AllocateUnicodeString</a>(&amp;pcur-&gt;strName, cczpstrName))
00356             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00357     } <span class="keywordflow">else</span> {
00358         pcur-&gt;strName = *cczpstrName;
00359     }
00360 
00361     <span class="comment">/*</span>
00362 <span class="comment">     * Save the module name</span>
00363 <span class="comment">     */</span>
00364     <span class="keywordflow">if</span> (cczpstrModName-&gt;Buffer) {
00365         <span class="comment">/*</span>
00366 <span class="comment">         * UserAddAtom guards access to the string with a try block.</span>
00367 <span class="comment">         */</span>
00368         pcur-&gt;atomModName = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(cczpstrModName-&gt;Buffer, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00369         <span class="keywordflow">if</span> (pcur-&gt;atomModName == 0) {
00370             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00371         }
00372     }
00373 
00374     <span class="keywordflow">if</span> (pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>) {
00375 
00376         <span class="comment">/*</span>
00377 <span class="comment">         * Stash away animated icon info.</span>
00378 <span class="comment">         */</span>
00379         <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a> = (<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)pcur;
00380         <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur = UserAllocPool(cbData, TAG_CURSOR);
00381         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00382             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00383 
00384         <span class="comment">/*</span>
00385 <span class="comment">         * Copy the handle array.  Do this in a try/except so the</span>
00386 <span class="comment">         * buffer will be freed if pcurData goes away.  Even though</span>
00387 <span class="comment">         * cursor destruction would free the array, a fault will</span>
00388 <span class="comment">         * leave the contents in an undetermined state and cause</span>
00389 <span class="comment">         * problems during cursor destruction.</span>
00390 <span class="comment">         */</span>
00391         <span class="keywordflow">try</span> {
00392             RtlCopyMemory(<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur, pcurData-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o14">aspcur</a>, cbData);
00393             <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aicur = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur + (ULONG_PTR)pcurData-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o15">aicur</a>);
00394             <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;ajifRate = (PJIF)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur + (ULONG_PTR)pcurData-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o16">ajifRate</a>);
00395         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00396             UserFreePool(<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur);
00397             <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00398             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00399         }
00400 
00401         <span class="comment">/*</span>
00402 <span class="comment">         * Convert handles into pointers and lock them in.</span>
00403 <span class="comment">         */</span>
00404         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;cpcur; i++) {
00405             <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcurT;
00406 
00407             pcurT = (<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>) <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>(<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[i], <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a239">TYPE_CURSOR</a>);
00408             <span class="keywordflow">if</span> (pcurT) {
00409                 <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00410                 <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[i], pcurT);
00411             } <span class="keywordflow">else</span> {
00412                 <span class="keywordflow">while</span> (--i &gt;= 0) {
00413                     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[i]);
00414                 }
00415 
00416                 UserFreePool(<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur);
00417                 <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00418                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetCursorIconData: invalid cursor handle for animated cursor"</span>);
00419                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00420             }
00421         }
00422     } <span class="keywordflow">else</span> {
00423 
00424         PW32PROCESS W32Process = W32GetCurrentProcess();
00425 
00426         <span class="comment">/*</span>
00427 <span class="comment">         * Make the cursor and its bitmaps public - LAST THING!</span>
00428 <span class="comment">         */</span>
00429         UserAssert(pcur-&gt;hbmMask);
00430         UserAssert(pcur-&gt;cx);
00431         UserAssert(pcur-&gt;cy);
00432 
00433         <span class="comment">/*</span>
00434 <span class="comment">         * Make the cursor public so that it can be shared across processes.</span>
00435 <span class="comment">         * Charge the curson to this very process GDI quota even if it's public.</span>
00436 <span class="comment">         */</span>
00437 <span class="preprocessor">#if DBG</span>
00438 <span class="preprocessor"></span>        fSuccess =
00439 <span class="preprocessor">#endif</span>
00440 <span class="preprocessor"></span>        GreSetBitmapOwner(pcur-&gt;hbmMask, OBJECT_OWNER_PUBLIC);
00441         UserAssert(fSuccess);
00442         GreIncQuotaCount(W32Process);
00443         <span class="keywordflow">if</span> (pcur-&gt;hbmColor) {
00444 <span class="preprocessor">#if DBG</span>
00445 <span class="preprocessor"></span>            fSuccess =
00446 <span class="preprocessor">#endif</span>
00447 <span class="preprocessor"></span>            GreSetBitmapOwner(pcur-&gt;hbmColor, OBJECT_OWNER_PUBLIC);
00448             UserAssert(fSuccess);
00449             GreIncQuotaCount(W32Process);
00450         }
00451     }
00452 
00453     <a class="code" href="../../d4/d1/userk_8h.html#a1113">LinkCursor</a>(pcur);
00454 
00455     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00456 <span class="preprocessor">#undef pacon</span>
00457 <span class="preprocessor"></span>}
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:13 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
