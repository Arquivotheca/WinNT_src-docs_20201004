<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: filelock.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>filelock.c File Reference</h1><code>#include "FsRtlP.h"</code><br>

<p>
<a href="../../d6/d2/filelock_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">_LOCKTREE_NODE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/struct__SH__LOCK.html">_SH_LOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/struct__EX__LOCK.html">_EX_LOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/struct__WAITING__LOCK.html">_WAITING_LOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">_LOCK_QUEUE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/struct__LOCK__INFO.html">_LOCK_INFO</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a0">Dbg</a>&nbsp;&nbsp;&nbsp;(0x20000000)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a1">INLINE</a>&nbsp;&nbsp;&nbsp;__inline</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a2">TAG_EXCLUSIVE_LOCK</a>&nbsp;&nbsp;&nbsp;'xeLF'</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a3">TAG_FILE_LOCK</a>&nbsp;&nbsp;&nbsp;'lfLF'</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a4">TAG_LOCK_INFO</a>&nbsp;&nbsp;&nbsp;'ilLF'</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a5">TAG_LOCKTREE_NODE</a>&nbsp;&nbsp;&nbsp;'nlLF'</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a6">TAG_SHARED_LOCK</a>&nbsp;&nbsp;&nbsp;'hsLF'</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a7">TAG_WAITING_LOCK</a>&nbsp;&nbsp;&nbsp;'lwLF'</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a8">FsRtlAcquireLockQueue</a>(a, b)&nbsp;&nbsp;&nbsp;ExAcquireSpinLock(&amp;(a)-&gt;QueueSpinLock, b);</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a9">FsRtlReacquireLockQueue</a>(a, b, <a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>)&nbsp;&nbsp;&nbsp;ExAcquireSpinLock(&amp;(b)-&gt;QueueSpinLock, <a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>);</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(a, b)&nbsp;&nbsp;&nbsp;ExReleaseSpinLock(&amp;(a)-&gt;QueueSpinLock, b);</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a11">FsRtlCompleteLockIrp</a>(A, B, C, D, E, F)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">_LOCKTREE_NODE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a19">LOCKTREE_NODE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">_LOCKTREE_NODE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a20">PLOCKTREE_NODE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d2/struct__SH__LOCK.html">_SH_LOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a21">SH_LOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d2/struct__SH__LOCK.html">_SH_LOCK</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d7/struct__EX__LOCK.html">_EX_LOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a23">EX_LOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d7/struct__EX__LOCK.html">_EX_LOCK</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a24">PEX_LOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d8/struct__WAITING__LOCK.html">_WAITING_LOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a25">WAITING_LOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d8/struct__WAITING__LOCK.html">_WAITING_LOCK</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a26">PWAITING_LOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">_LOCK_QUEUE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a27">LOCK_QUEUE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">_LOCK_QUEUE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a28">PLOCK_QUEUE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">_LOCK_INFO</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a29">LOCK_INFO</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">_LOCK_INFO</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE <a class="el" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a31">FsRtlAllocateSharedLock</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE <a class="el" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a32">FsRtlAllocateExclusiveLock</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE <a class="el" href="../../d1/d8/struct__WAITING__LOCK.html">PWAITING_LOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a33">FsRtlAllocateWaitingLock</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a34">FsRtlAllocateLockTreeNode</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a35">FsRtlAllocateLockInfo</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a36">FsRtlFreeSharedLock</a> (IN <a class="el" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a> C)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a37">FsRtlFreeExclusiveLock</a> (IN <a class="el" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a> C)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a38">FsRtlFreeWaitingLock</a> (IN <a class="el" href="../../d1/d8/struct__WAITING__LOCK.html">PWAITING_LOCK</a> C)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a39">FsRtlFreeLockTreeNode</a> (IN <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a> C)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a40">FsRtlFreeLockInfo</a> (IN <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a> C)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a41">FsRtlCompleteLockIrpReal</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a65">PCOMPLETE_LOCK_IRP_ROUTINE</a> CompleteLockIrpRoutine, IN PVOID Context, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, IN PNTSTATUS NewStatus, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a42">FsRtlSplitLocks</a> (IN <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a> ParentNode, IN PSINGLE_LIST_ENTRY *pStartLink, IN PLARGE_INTEGER LastShadowedByte, IN PLARGE_INTEGER GlueOffset)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PRTL_SPLAY_LINKS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a43">FsRtlFindFirstOverlappingSharedNode</a> (IN PRTL_SPLAY_LINKS Tree, IN PLARGE_INTEGER StartingByte, IN PLARGE_INTEGER EndingByte, IN OUT PRTL_SPLAY_LINKS *LastEdgeNode, IN OUT PBOOLEAN GreaterThan)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PRTL_SPLAY_LINKS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a44">FsRtlFindFirstOverlappingExclusiveNode</a> (IN PRTL_SPLAY_LINKS Tree, IN PLARGE_INTEGER StartingByte, IN PLARGE_INTEGER EndingByte, IN OUT PRTL_SPLAY_LINKS *LastEdgeNode, IN OUT PBOOLEAN GreaterThan)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a45">FsRtlFindFirstOverlapInNode</a> (IN <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a> Node, IN PLARGE_INTEGER StartingByte, IN PLARGE_INTEGER EndingByte)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a46">FsRtlPrivateInsertLock</a> (IN <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a> LockInfo, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a> FileLockInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a47">FsRtlPrivateInsertSharedLock</a> (IN <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a> LockQueue, IN <a class="el" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a> NewLock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a48">FsRtlPrivateInsertExclusiveLock</a> (IN <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a> LockQueue, IN <a class="el" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a> NewLock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a49">FsRtlPrivateCheckWaitingLocks</a> (IN <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a> LockInfo, IN <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a> LockQueue, IN KIRQL OldIrql)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a50">FsRtlPrivateCancelFileLockIrp</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a51">FsRtlPrivateCheckForExclusiveLockAccess</a> (IN <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a> LockInfo, IN <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a> FileLockInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a52">FsRtlPrivateCheckForSharedLockAccess</a> (IN <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a> LockInfo, IN <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a> FileLockInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a53">FsRtlPrivateFastUnlockAll</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessId, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN BOOLEAN MatchKey, IN PVOID Context OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a54">FsRtlPrivateInitializeFileLock</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN BOOLEAN ViaFastCall)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a55">FsRtlPrivateRemoveLock</a> (IN <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a> LockInfo, IN <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>, IN BOOLEAN CheckForWaiters)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a56">FsRtlCheckNoSharedConflict</a> (IN <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a> LockQueue, IN PLARGE_INTEGER Starting, IN PLARGE_INTEGER Ending)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a57">FsRtlCheckNoExclusiveConflict</a> (IN <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a> LockQueue, IN PLARGE_INTEGER Starting, IN PLARGE_INTEGER Ending, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PVOID ProcessId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a58">FsRtlPrivateResetLowestLockOffset</a> (<a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a> LockInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a59">FsRtlFastUnlockSingleShared</a> (IN <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a> LockInfo, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN LARGE_INTEGER UNALIGNED *FileOffset, IN PLARGE_INTEGER Length, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessId, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN PVOID Context OPTIONAL, IN BOOLEAN IgnoreUnlockRoutine, IN BOOLEAN CheckForWaiters)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a60">FsRtlFastUnlockSingleExclusive</a> (IN <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a> LockInfo, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN LARGE_INTEGER UNALIGNED *FileOffset, IN PLARGE_INTEGER Length, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessId, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN PVOID Context OPTIONAL, IN BOOLEAN IgnoreUnlockRoutine, IN BOOLEAN CheckForWaiters)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a61">FsRtlInitializeFileLocks</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a62">FsRtlInitializeFileLock</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a65">PCOMPLETE_LOCK_IRP_ROUTINE</a> CompleteLockIrpRoutine OPTIONAL, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a66">PUNLOCK_ROUTINE</a> UnlockRoutine OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a63">FsRtlUninitializeFileLock</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a64">FsRtlAllocateFileLock</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a65">PCOMPLETE_LOCK_IRP_ROUTINE</a> CompleteLockIrpRoutine OPTIONAL, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a66">PUNLOCK_ROUTINE</a> UnlockRoutine OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a65">FsRtlFreeFileLock</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a66">FsRtlProcessFileLock</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a67">FsRtlCheckLockForReadAccess</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a68">FsRtlCheckLockForWriteAccess</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a69">FsRtlGetNextFileLock</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN BOOLEAN Restart)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a70">FsRtlFastCheckLockForRead</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN PLARGE_INTEGER StartingByte, IN PLARGE_INTEGER Length, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PVOID ProcessId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a71">FsRtlFastCheckLockForWrite</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN PLARGE_INTEGER StartingByte, IN PLARGE_INTEGER Length, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN PVOID FileObject, IN PVOID ProcessId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a72">FsRtlSplitLocks</a> (IN <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a> ParentNode, IN PSINGLE_LIST_ENTRY *pStartLink OPTIONAL, IN PLARGE_INTEGER LastShadowedByte OPTIONAL, IN PLARGE_INTEGER GlueOffset OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a73">FsRtlFastUnlockSingle</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN LARGE_INTEGER UNALIGNED *FileOffset, IN PLARGE_INTEGER Length, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessId, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN PVOID Context OPTIONAL, IN BOOLEAN AlreadySynchronized)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a74">FsRtlFastUnlockAll</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessId, IN PVOID Context OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a75">FsRtlFastUnlockAllByKey</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessId, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN PVOID Context OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a76">FsRtlPrivateLock</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN PLARGE_INTEGER Length, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessId, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN BOOLEAN FailImmediately, IN BOOLEAN ExclusiveLock, OUT PIO_STATUS_BLOCK Iosb, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a> OPTIONAL, IN PVOID Context, IN BOOLEAN AlreadySynchronized)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a12">FsRtlCreateLockInfo</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a13">FsRtlSharedLockLookasideList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a14">FsRtlExclusiveLockLookasideList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a15">FsRtlWaitingLockLookasideList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a16">FsRtlLockTreeNodeLookasideList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a17">FsRtlLockInfoLookasideList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/filelock_8c.html#a18">FsRtlFileLockLookasideList</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="filelock.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(0x20000000)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00094">94</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="filelock.c::FsRtlAcquireLockQueue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlAcquireLockQueue          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAcquireSpinLock(&amp;(a)-&gt;QueueSpinLock, b);</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00481">481</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l03589">FsRtlFastUnlockSingleExclusive()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01951">FsRtlGetNextFileLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="filelock.c::FsRtlCompleteLockIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlCompleteLockIrp          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">A,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>B,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>C,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>D,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>E,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>F&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d5/d3/filelock_8c.html#a41">FsRtlCompleteLockIrpReal</a>( (A)-&gt;CompleteLockIrpRoutine,  \
                                  B,                            \
                                  C,                            \
                                  D,                            \
                                  E,                            \
                                  F )
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00497">497</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l05721">FsRtlPrivateCancelFileLockIrp()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">FsRtlPrivateCheckWaitingLocks()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">FsRtlProcessFileLock()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="filelock.c::FsRtlReacquireLockQueue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlReacquireLockQueue          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAcquireSpinLock(&amp;(b)-&gt;QueueSpinLock, <a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>);</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00484">484</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l02582">FsRtlFastCheckLockForRead()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02718">FsRtlFastCheckLockForWrite()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03589">FsRtlFastUnlockSingleExclusive()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05721">FsRtlPrivateCancelFileLockIrp()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">FsRtlPrivateCheckWaitingLocks()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="filelock.c::FsRtlReleaseLockQueue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlReleaseLockQueue          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExReleaseSpinLock(&amp;(a)-&gt;QueueSpinLock, b);</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">487</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l02582">FsRtlFastCheckLockForRead()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02718">FsRtlFastCheckLockForWrite()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03589">FsRtlFastUnlockSingleExclusive()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01951">FsRtlGetNextFileLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05721">FsRtlPrivateCancelFileLockIrp()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">FsRtlPrivateCheckWaitingLocks()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="filelock.c::INLINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define INLINE&nbsp;&nbsp;&nbsp;__inline          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00101">101</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="filelock.c::TAG_EXCLUSIVE_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TAG_EXCLUSIVE_LOCK&nbsp;&nbsp;&nbsp;'xeLF'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00104">104</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="filelock.c::TAG_FILE_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TAG_FILE_LOCK&nbsp;&nbsp;&nbsp;'lfLF'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00105">105</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="filelock.c::TAG_LOCK_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TAG_LOCK_INFO&nbsp;&nbsp;&nbsp;'ilLF'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00106">106</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="filelock.c::TAG_LOCKTREE_NODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TAG_LOCKTREE_NODE&nbsp;&nbsp;&nbsp;'nlLF'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00107">107</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="filelock.c::TAG_SHARED_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TAG_SHARED_LOCK&nbsp;&nbsp;&nbsp;'hsLF'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00108">108</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="filelock.c::TAG_WAITING_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TAG_WAITING_LOCK&nbsp;&nbsp;&nbsp;'lwLF'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00109">109</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a23" doxytag="filelock.c::EX_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d7/struct__EX__LOCK.html">_EX_LOCK</a>  <a class="el" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="filelock.c::LOCK_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">_LOCK_INFO</a>  <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">LOCK_INFO</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="filelock.c::LOCK_QUEUE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">_LOCK_QUEUE</a>  <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">LOCK_QUEUE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="filelock.c::LOCKTREE_NODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">_LOCKTREE_NODE</a>  <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="filelock.c::PEX_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d7/struct__EX__LOCK.html">_EX_LOCK</a> * <a class="el" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00400">FsRtlAllocateExclusiveLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02469">FsRtlCheckNoExclusiveConflict()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03589">FsRtlFastUnlockSingleExclusive()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01687">FsRtlFindFirstOverlappingExclusiveNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01951">FsRtlGetNextFileLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04934">FsRtlPrivateCheckForExclusiveLockAccess()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05046">FsRtlPrivateCheckForSharedLockAccess()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04253">FsRtlPrivateInsertLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05150">FsRtlPrivateResetLowestLockOffset()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="filelock.c::PLOCK_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">_LOCK_INFO</a> * <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00427">FsRtlAllocateLockInfo()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01315">FsRtlCheckLockForReadAccess()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01416">FsRtlCheckLockForWriteAccess()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02582">FsRtlFastCheckLockForRead()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02718">FsRtlFastCheckLockForWrite()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01951">FsRtlGetNextFileLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05721">FsRtlPrivateCancelFileLockIrp()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00888">FsRtlPrivateInitializeFileLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="filelock.c::PLOCK_QUEUE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">_LOCK_QUEUE</a> * <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l02582">FsRtlFastCheckLockForRead()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02718">FsRtlFastCheckLockForWrite()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03589">FsRtlFastUnlockSingleExclusive()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05721">FsRtlPrivateCancelFileLockIrp()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="filelock.c::PLOCKTREE_NODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">_LOCKTREE_NODE</a> * <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00418">FsRtlAllocateLockTreeNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02392">FsRtlCheckNoSharedConflict()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01517">FsRtlFindFirstOverlappingSharedNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01951">FsRtlGetNextFileLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04934">FsRtlPrivateCheckForExclusiveLockAccess()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04343">FsRtlPrivateInsertSharedLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05150">FsRtlPrivateResetLowestLockOffset()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02865">FsRtlSplitLocks()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="filelock.c::PSH_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d2/struct__SH__LOCK.html">_SH_LOCK</a> * <a class="el" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00391">FsRtlAllocateSharedLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01856">FsRtlFindFirstOverlapInNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01517">FsRtlFindFirstOverlappingSharedNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01951">FsRtlGetNextFileLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04934">FsRtlPrivateCheckForExclusiveLockAccess()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04253">FsRtlPrivateInsertLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04343">FsRtlPrivateInsertSharedLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05150">FsRtlPrivateResetLowestLockOffset()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02865">FsRtlSplitLocks()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="filelock.c::PWAITING_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d8/struct__WAITING__LOCK.html">_WAITING_LOCK</a> * <a class="el" href="../../d1/d8/struct__WAITING__LOCK.html">PWAITING_LOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00409">FsRtlAllocateWaitingLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05721">FsRtlPrivateCancelFileLockIrp()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">FsRtlPrivateCheckWaitingLocks()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="filelock.c::SH_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d2/struct__SH__LOCK.html">_SH_LOCK</a>  <a class="el" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="filelock.c::WAITING_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d8/struct__WAITING__LOCK.html">_WAITING_LOCK</a>  <a class="el" href="../../d1/d8/struct__WAITING__LOCK.html">WAITING_LOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a32" doxytag="filelock.c::FsRtlAllocateExclusiveLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE <a class="el" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a> FsRtlAllocateExclusiveLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00400">400</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00780">ExAllocateFromNPagedLookasideList()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00132">FsRtlExclusiveLockLookasideList</a>, and <a class="el" href="../../d5/d3/filelock_8c.html#a24">PEX_LOCK</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l04253">FsRtlPrivateInsertLock()</a>.
<p>
<pre class="fragment"><div>00403 {
00404     <span class="keywordflow">return</span> (<a class="code" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a>) <a class="code" href="../../d5/d8/ex_8h.html#a248">ExAllocateFromNPagedLookasideList</a>( &amp;FsRtlExclusiveLockLookasideList );
00405 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="filelock.c::FsRtlAllocateFileLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FsRtlAllocateFileLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a65">PCOMPLETE_LOCK_IRP_ROUTINE</a> CompleteLockIrpRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a66">PUNLOCK_ROUTINE</a> UnlockRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01141">1141</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00906">ExAllocateFromPagedLookasideList()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00137">FsRtlFileLockLookasideList</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00829">FsRtlInitializeFileLock()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03713">UdfCreateFileLock()</a>.
<p>
<pre class="fragment"><div>01146 {
01147     <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock;
01148 
01149     FileLock = <a class="code" href="../../d5/d8/ex_8h.html#a252">ExAllocateFromPagedLookasideList</a>( &amp;FsRtlFileLockLookasideList );
01150 
01151     <span class="keywordflow">if</span> (FileLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01152 
01153         <a class="code" href="../../d1/d8/fsrtl_8h.html#a114">FsRtlInitializeFileLock</a>( FileLock,
01154                                  CompleteLockIrpRoutine,
01155                                  UnlockRoutine );
01156     }
01157 
01158     <span class="keywordflow">return</span> FileLock;
01159 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="filelock.c::FsRtlAllocateLockInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a> FsRtlAllocateLockInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00427">427</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00780">ExAllocateFromNPagedLookasideList()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00135">FsRtlLockInfoLookasideList</a>, and <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00888">FsRtlPrivateInitializeFileLock()</a>.
<p>
<pre class="fragment"><div>00430 {
00431     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) <a class="code" href="../../d5/d8/ex_8h.html#a248">ExAllocateFromNPagedLookasideList</a>( &amp;FsRtlLockInfoLookasideList );
00432 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="filelock.c::FsRtlAllocateLockTreeNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a> FsRtlAllocateLockTreeNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00418">418</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00780">ExAllocateFromNPagedLookasideList()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00134">FsRtlLockTreeNodeLookasideList</a>, and <a class="el" href="../../d5/d3/filelock_8c.html#a20">PLOCKTREE_NODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l04343">FsRtlPrivateInsertSharedLock()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l02865">FsRtlSplitLocks()</a>.
<p>
<pre class="fragment"><div>00421 {
00422     <span class="keywordflow">return</span> (<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>) <a class="code" href="../../d5/d8/ex_8h.html#a248">ExAllocateFromNPagedLookasideList</a>( &amp;FsRtlLockTreeNodeLookasideList );
00423 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="filelock.c::FsRtlAllocateSharedLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE <a class="el" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a> FsRtlAllocateSharedLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00391">391</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00780">ExAllocateFromNPagedLookasideList()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00131">FsRtlSharedLockLookasideList</a>, and <a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l04253">FsRtlPrivateInsertLock()</a>.
<p>
<pre class="fragment"><div>00394 {
00395     <span class="keywordflow">return</span> (<a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a>) <a class="code" href="../../d5/d8/ex_8h.html#a248">ExAllocateFromNPagedLookasideList</a>( &amp;FsRtlSharedLockLookasideList );
00396 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="filelock.c::FsRtlAllocateWaitingLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE <a class="el" href="../../d1/d8/struct__WAITING__LOCK.html">PWAITING_LOCK</a> FsRtlAllocateWaitingLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00409">409</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00780">ExAllocateFromNPagedLookasideList()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00133">FsRtlWaitingLockLookasideList</a>, and <a class="el" href="../../d5/d3/filelock_8c.html#a26">PWAITING_LOCK</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>.
<p>
<pre class="fragment"><div>00412 {
00413     <span class="keywordflow">return</span> (<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html">PWAITING_LOCK</a>) <a class="code" href="../../d5/d8/ex_8h.html#a248">ExAllocateFromNPagedLookasideList</a>( &amp;FsRtlWaitingLockLookasideList );
00414 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="filelock.c::FsRtlCheckLockForReadAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlCheckLockForReadAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01315">1315</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02582">FsRtlFastCheckLockForRead()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07374">IoGetRequestorProcess()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00166">_LOCK_INFO::LowestLockOffset</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>.
<p>
<pre class="fragment"><div>01322                    :
01323 
01324     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has read access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01325     range indicated in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> due to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> locks.  This call does not
01326     complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> uses <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock information and read
01327     information.  The <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> must be <span class="keywordflow">for</span> a read operation.
01328 
01329 Arguments:
01330 
01331     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> to check.
01332 
01333     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> being processed.
01334 
01335 Return Value:
01336 
01337     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated user/request has read access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01338         entire specified byte range, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
01339 
01340 --*/
01341 
01342 {
01343     BOOLEAN Result;
01344 
01345     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
01346 
01347     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>     LockInfo;
01348     LARGE_INTEGER  StartingByte;
01349     LARGE_INTEGER  Length;
01350     ULONG          <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
01351     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>   FileObject;
01352     PVOID          ProcessId;
01353     LARGE_INTEGER  BeyondLastByte;
01354 
01355     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlCheckLockForReadAccess, FileLock = %08lx\n"</span>, FileLock);
01356 
01357     <span class="keywordflow">if</span> ((LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01358         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForReadAccess (No current lock info) -&gt; TRUE\n"</span>, 0);
01359         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01360     }
01361 
01362     <span class="comment">//</span>
01363     <span class="comment">//  Do a really fast test to see if there are any exclusive locks to start with</span>
01364     <span class="comment">//</span>
01365 
01366     <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01367         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForReadAccess (No current locks) -&gt; TRUE\n"</span>, 0);
01368         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01369     }
01370 
01371     <span class="comment">//</span>
01372     <span class="comment">//  Get the read offset and compare it to the lowest existing lock.</span>
01373     <span class="comment">//</span>
01374 
01375     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
01376 
01377     StartingByte  = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.ByteOffset;
01378     (ULONGLONG)Length.QuadPart = (ULONGLONG)IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Length;
01379 
01380     (ULONGLONG)BeyondLastByte.QuadPart = (ULONGLONG)StartingByte.QuadPart + Length.LowPart;
01381     <span class="keywordflow">if</span> ( (ULONGLONG)BeyondLastByte.QuadPart &lt;= (ULONGLONG)LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o0">LowestLockOffset</a> ) {
01382         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForReadAccess (Below lowest lock) -&gt; TRUE\n"</span>, 0);
01383         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01384     }
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">//  Get remaining parameters.</span>
01388     <span class="comment">//</span>
01389 
01390     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>           = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Key;
01391     FileObject    = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>;
01392     ProcessId     = <a class="code" href="../../d4/d6/iosubs_8c.html#a78">IoGetRequestorProcess</a>( Irp );
01393 
01394     <span class="comment">//</span>
01395     <span class="comment">//  Call our private work routine to do the real check</span>
01396     <span class="comment">//</span>
01397 
01398     Result = <a class="code" href="../../d1/d8/fsrtl_8h.html#a119">FsRtlFastCheckLockForRead</a>( FileLock,
01399                                         &amp;StartingByte,
01400                                         &amp;Length,
01401                                         Key,
01402                                         FileObject,
01403                                         ProcessId );
01404 
01405     <span class="comment">//</span>
01406     <span class="comment">//  And return to our caller</span>
01407     <span class="comment">//</span>
01408 
01409     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForReadAccess -&gt; %08lx\n"</span>, Result);
01410 
01411     <span class="keywordflow">return</span> Result;
01412 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="filelock.c::FsRtlCheckLockForWriteAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlCheckLockForWriteAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01416">1416</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02718">FsRtlFastCheckLockForWrite()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07374">IoGetRequestorProcess()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00166">_LOCK_INFO::LowestLockOffset</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00140">_LOCK_QUEUE::SharedLockTree</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01423                    :
01424 
01425     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has write access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01426     indicated range due to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> locks.  This call does not complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01427     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> uses <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock information and write information.
01428     The <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> must be <span class="keywordflow">for</span> a write operation.
01429 
01430 Arguments:
01431 
01432     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> to check.
01433 
01434     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> being processed.
01435 
01436 Return Value:
01437 
01438     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated user/request has write access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01439         entire specified byte range, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
01440 
01441 --*/
01442 
01443 {
01444     BOOLEAN Result;
01445 
01446     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
01447 
01448     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>      LockInfo;
01449     LARGE_INTEGER   StartingByte;
01450     LARGE_INTEGER   Length;
01451     ULONG           <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
01452     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>    FileObject;
01453     PVOID           ProcessId;
01454     LARGE_INTEGER   BeyondLastByte;
01455 
01456     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlCheckLockForWriteAccess, FileLock = %08lx\n"</span>, FileLock);
01457 
01458     <span class="keywordflow">if</span> ((LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01459         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForWriteAccess (No current lock info) -&gt; TRUE\n"</span>, 0);
01460         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01461     }
01462 
01463     <span class="comment">//</span>
01464     <span class="comment">//  Do a really fast test to see if there are any locks to start with</span>
01465     <span class="comment">//</span>
01466 
01467     <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01468         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForWriteAccess (No current locks) -&gt; TRUE\n"</span>, 0);
01469         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01470     }
01471 
01472     <span class="comment">//</span>
01473     <span class="comment">//  Get the write offset and compare it to the lowest existing lock.</span>
01474     <span class="comment">//</span>
01475 
01476     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
01477 
01478     StartingByte  = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Write.ByteOffset;
01479     (ULONGLONG)Length.QuadPart = (ULONGLONG)IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Write.Length;
01480 
01481     (ULONGLONG)BeyondLastByte.QuadPart = (ULONGLONG)StartingByte.QuadPart + Length.LowPart;
01482     <span class="keywordflow">if</span> ( (ULONGLONG)BeyondLastByte.QuadPart &lt;= (ULONGLONG)LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o0">LowestLockOffset</a> ) {
01483         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForWriteAccess (Below lowest lock) -&gt; TRUE\n"</span>, 0);
01484         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01485     }
01486 
01487     <span class="comment">//</span>
01488     <span class="comment">//  Get remaining parameters.</span>
01489     <span class="comment">//</span>
01490 
01491     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>           = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Write.Key;
01492     FileObject    = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>;
01493     ProcessId     = <a class="code" href="../../d4/d6/iosubs_8c.html#a78">IoGetRequestorProcess</a>( Irp );
01494 
01495     <span class="comment">//</span>
01496     <span class="comment">//  Call our private work routine to do the real work</span>
01497     <span class="comment">//</span>
01498 
01499     Result = <a class="code" href="../../d1/d8/fsrtl_8h.html#a120">FsRtlFastCheckLockForWrite</a>( FileLock,
01500                                          &amp;StartingByte,
01501                                          &amp;Length,
01502                                          Key,
01503                                          FileObject,
01504                                          ProcessId );
01505 
01506     <span class="comment">//</span>
01507     <span class="comment">//  And return to our caller</span>
01508     <span class="comment">//</span>
01509 
01510     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForWriteAccess -&gt; %08lx\n"</span>, Result);
01511 
01512     <span class="keywordflow">return</span> Result;
01513 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="filelock.c::FsRtlCheckNoExclusiveConflict" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlCheckNoExclusiveConflict           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LockQueue</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Starting</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Ending</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l02469">2469</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01687">FsRtlFindFirstOverlappingExclusiveNode()</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a24">PEX_LOCK</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00759">RtlRealSuccessor()</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00051">RtlSplay()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l02582">FsRtlFastCheckLockForRead()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l02718">FsRtlFastCheckLockForWrite()</a>.
<p>
<pre class="fragment"><div>02479                    :
02480 
02481     This routine checks to see <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> conflict in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exclusive locks with
02482     a given range and identifying tuple of key, fileobject and process. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02483     <span class="keywordflow">for</span> part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> read access <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
02484 
02485 Arguments:
02486 
02487     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> to check
02488 
02489     StartingByte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first byte (zero based) to check
02490 
02491     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, to check
02492 
02493     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02494 
02495     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02496 
02497     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Process Id to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02498 
02499 Return Value:
02500 
02501     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated user/request doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> conflict in
02502         entire specified byte range, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
02503 
02504 --*/
02505 {
02506     PRTL_SPLAY_LINKS SplayLinks, BeginLinks;
02507     <a class="code" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
02508     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02509 
02510     <span class="comment">//</span>
02511     <span class="comment">//  Find the node to begin the search at and go</span>
02512     <span class="comment">//</span>
02513 
02514     <span class="keywordflow">for</span> (SplayLinks = <a class="code" href="../../d5/d3/filelock_8c.html#a44">FsRtlFindFirstOverlappingExclusiveNode</a>( LockQueue-&gt;ExclusiveLockTree,
02515                                                               Starting,
02516                                                               Ending,
02517                                                               &amp;BeginLinks,
02518                                                               NULL);
02519          SplayLinks;
02520          SplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(SplayLinks)) {
02521 
02522         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links );
02523 
02524         <span class="comment">//</span>
02525         <span class="comment">//  If the current lock is greater than the end of the range we're</span>
02526         <span class="comment">//  looking for then the the user doesn't conflict</span>
02527         <span class="comment">//</span>
02528         <span class="comment">//  if (Ending &lt; Lock-&gt;StartingByte) ...</span>
02529         <span class="comment">//</span>
02530 
02531         <span class="keywordflow">if</span> ((ULONGLONG)Ending-&gt;QuadPart &lt; (ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart) {
02532 
02533             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlCheckForExclusiveConflict, Ending &lt; Lock-&gt;StartingByte\n"</span>, 0);
02534 
02535             <span class="keywordflow">break</span>;
02536         }
02537 
02538         <span class="comment">//</span>
02539         <span class="comment">//  Check for any overlap with the request. The test for</span>
02540         <span class="comment">//  overlap is that starting byte is less than or equal to the locks</span>
02541         <span class="comment">//  ending byte, and the ending byte is greater than or equal to the</span>
02542         <span class="comment">//  locks starting byte.  We already tested for this latter case in</span>
02543         <span class="comment">//  the preceding statement.</span>
02544         <span class="comment">//</span>
02545         <span class="comment">//  if (Starting &lt;= Lock-&gt;StartingByte + Lock-&gt;Length - 1) ...</span>
02546         <span class="comment">//</span>
02547 
02548         <span class="keywordflow">if</span> ((ULONGLONG)Starting-&gt;QuadPart &lt;= (ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.EndingByte.QuadPart) {
02549 
02550             <span class="comment">//</span>
02551             <span class="comment">//  This request overlaps the lock. We cannot grant the request</span>
02552             <span class="comment">//  if the file object, process id, and key do not match. Otherwise</span>
02553             <span class="comment">//  we'll continue looping looking at locks</span>
02554             <span class="comment">//</span>
02555 
02556             <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.FileObject != FileObject) ||
02557                 (<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.ProcessId != ProcessId) ||
02558                 (<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.Key != <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)) {
02559 
02560                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlCheckForExclusiveConflict, Range locked already\n"</span>, 0);
02561 
02562                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02563                 <span class="keywordflow">break</span>;
02564             }
02565         }
02566     }
02567 
02568     <span class="keywordflow">if</span> (BeginLinks) {
02569 
02570         LockQueue-&gt;ExclusiveLockTree = <a class="code" href="../../d3/d4/splay_8c.html#a3">RtlSplay</a>(BeginLinks);
02571     }
02572 
02573     <span class="comment">//</span>
02574     <span class="comment">//  We searched the entire range without a conflict so we'll note no conflict</span>
02575     <span class="comment">//</span>
02576 
02577     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02578 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="filelock.c::FsRtlCheckNoSharedConflict" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlCheckNoSharedConflict           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LockQueue</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Starting</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Ending</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l02392">2392</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01856">FsRtlFindFirstOverlapInNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01517">FsRtlFindFirstOverlappingSharedNode()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00021">_LOCKTREE_NODE::HoleyNode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a20">PLOCKTREE_NODE</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00051">RtlSplay()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l02718">FsRtlFastCheckLockForWrite()</a>.
<p>
<pre class="fragment"><div>02399                    :
02400 
02401     This routine checks to see <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> overlap in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> shared locks with
02402     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given range. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> intended <span class="keywordflow">for</span> use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> write access check <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>
02403     so that a rebalance will occur.
02404 
02405 Arguments:
02406 
02407     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> to check
02408 
02409     StartingByte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first byte (zero based) to check
02410 
02411     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, to check
02412 
02413     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02414 
02415     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02416 
02417     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Process Id to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02418 
02419 Return Value:
02420 
02421     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated user/request doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> conflict in
02422         entire specified byte range, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
02423 
02424 --*/
02425 {
02426     PRTL_SPLAY_LINKS SplayLinks, BeginLinks;
02427     <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a> Node;
02428 
02429     SplayLinks = <a class="code" href="../../d5/d3/filelock_8c.html#a43">FsRtlFindFirstOverlappingSharedNode</a>( LockQueue-&gt;SharedLockTree,
02430                                                       Starting,
02431                                                       Ending,
02432                                                       &amp;BeginLinks,
02433                                                       NULL);
02434 
02435     <span class="keywordflow">if</span> (BeginLinks) {
02436 
02437         LockQueue-&gt;SharedLockTree = <a class="code" href="../../d3/d4/splay_8c.html#a3">RtlSplay</a>(BeginLinks);
02438     }
02439 
02440     <span class="comment">//</span>
02441     <span class="comment">//  If this node is holey, we'll have to walk the whole thing.</span>
02442     <span class="comment">//</span>
02443 
02444     <span class="keywordflow">if</span> (SplayLinks) {
02445 
02446         Node = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
02447 
02448         <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o1">HoleyNode</a>) {
02449 
02450             <span class="keywordflow">return</span> (BOOLEAN)(<a class="code" href="../../d5/d3/filelock_8c.html#a45">FsRtlFindFirstOverlapInNode</a>( Node, Starting, Ending ) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02451         }
02452 
02453         <span class="comment">//</span>
02454         <span class="comment">//  Overlapping non-holey node, so we do have shared lock conflict.</span>
02455         <span class="comment">//</span>
02456 
02457         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02458     }
02459 
02460     <span class="comment">//</span>
02461     <span class="comment">//  No node overlaps.</span>
02462     <span class="comment">//</span>
02463 
02464     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02465 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="filelock.c::FsRtlCompleteLockIrpReal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE VOID FsRtlCompleteLockIrpReal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a65">PCOMPLETE_LOCK_IRP_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CompleteLockIrpRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>NewStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00507">507</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00591">PCOMPLETE_LOCK_IRP_ROUTINE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00515 {
00516     <span class="comment">//</span>
00517     <span class="comment">//  This fools the compiler into generating the Status only once</span>
00518     <span class="comment">//  if it is calculated from an expression.</span>
00519     <span class="comment">//</span>
00520 
00521     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> LocalStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00522 
00523     <span class="keywordflow">if</span> (CompleteLockIrpRoutine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00524 
00525         <span class="keywordflow">if</span> (FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00526 
00527             FileObject-&gt;LastLock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00528         }
00529 
00530         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = LocalStatus;
00531         *NewStatus = CompleteLockIrpRoutine( Context, Irp );
00532 
00533     } <span class="keywordflow">else</span> {
00534 
00535         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, LocalStatus );
00536         *NewStatus = LocalStatus;
00537     }
00538 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="filelock.c::FsRtlFastCheckLockForRead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlFastCheckLockForRead           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingByte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l02582">2582</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00576">_FILE_LOCK_INFO::EndingByte</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02469">FsRtlCheckNoExclusiveConflict()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00484">FsRtlReacquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00568">_FILE_LOCK_INFO::Key</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00166">_LOCK_INFO::LowestLockOffset</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a28">PLOCK_QUEUE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00570">_FILE_LOCK_INFO::ProcessId</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00560">_FILE_LOCK_INFO::StartingByte</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01315">FsRtlCheckLockForReadAccess()</a>.
<p>
<pre class="fragment"><div>02593                    :
02594 
02595     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has read access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02596     indicated range due to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> locks.
02597 
02598 Arguments:
02599 
02600     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> to check
02601 
02602     StartingByte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first byte (zero based) to check
02603 
02604     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, to check
02605 
02606     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02607 
02608     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02609 
02610     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Process Id to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02611 
02612 Return Value:
02613 
02614     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated user/request has read access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02615         entire specified byte range, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
02616 
02617 --*/
02618 
02619 {
02620     LARGE_INTEGER Starting;
02621     LARGE_INTEGER Ending;
02622 
02623     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>            LockInfo;
02624     <a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>           LockQueue;
02625     KIRQL                 OldIrql;
02626     <a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>       LastLock;
02627     BOOLEAN               <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02628 
02629     <span class="keywordflow">if</span> ((LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02630 
02631         <span class="comment">//</span>
02632         <span class="comment">// No lock information on this FileLock</span>
02633         <span class="comment">//</span>
02634 
02635         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForRead, No lock info\n"</span>, 0);
02636         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02637     }
02638 
02639     <span class="comment">//</span>
02640     <span class="comment">// If there isn't an exclusive lock then we can immediately grant access</span>
02641     <span class="comment">//</span>
02642 
02643     <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02644         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForRead, No exlocks present\n"</span>, 0);
02645         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02646     }
02647 
02648     <span class="comment">//</span>
02649     <span class="comment">// If length is zero then automatically give grant access</span>
02650     <span class="comment">//</span>
02651 
02652     <span class="keywordflow">if</span> ((ULONGLONG)Length-&gt;QuadPart == 0) {
02653 
02654         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForRead, Length == 0\n"</span>, 0);
02655         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02656     }
02657 
02658     <span class="comment">//</span>
02659     <span class="comment">//  Get our starting and ending byte position</span>
02660     <span class="comment">//</span>
02661 
02662     Starting = *StartingByte;
02663     (ULONGLONG)Ending.QuadPart = (ULONGLONG)Starting.QuadPart + (ULONGLONG)Length-&gt;QuadPart - 1;
02664 
02665     <span class="comment">//</span>
02666     <span class="comment">// Now check lock queue</span>
02667     <span class="comment">//</span>
02668 
02669     LockQueue = &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>;
02670 
02671     <span class="comment">//</span>
02672     <span class="comment">//  Grab the waiting lock queue spinlock to exclude anyone from messing</span>
02673     <span class="comment">//  with the queue while we're using it</span>
02674     <span class="comment">//</span>
02675 
02676     <a class="code" href="../../d5/d3/filelock_8c.html#a9">FsRtlReacquireLockQueue</a>(LockInfo, LockQueue, &amp;OldIrql);
02677 
02678     <span class="comment">//</span>
02679     <span class="comment">//  If the range ends below the lowest existing lock, this read is OK.</span>
02680     <span class="comment">//</span>
02681 
02682     <span class="keywordflow">if</span> ( ((ULONGLONG)Ending.QuadPart &lt; (ULONGLONG)LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o0">LowestLockOffset</a>) ) {
02683         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForRead (below lowest lock)\n"</span>, 0);
02684 
02685         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
02686         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02687     }
02688 
02689     <span class="comment">//</span>
02690     <span class="comment">//  If the caller just locked this range, he can read it.</span>
02691     <span class="comment">//</span>
02692 
02693     LastLock = (<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>)FileObject-&gt;LastLock;
02694     <span class="keywordflow">if</span> ((LastLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02695         ((ULONGLONG)Starting.QuadPart &gt;= (ULONGLONG)LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart) &amp;&amp;
02696         ((ULONGLONG)Ending.QuadPart &lt;= (ULONGLONG)LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>.QuadPart) &amp;&amp;
02697         (LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>) &amp;&amp;
02698         (LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a> == ProcessId)) {
02699 
02700         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
02701         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02702     }
02703 
02704     <span class="comment">//</span>
02705     <span class="comment">//  Check the exclusive locks for a conflict. It is impossible to have</span>
02706     <span class="comment">//  a read conflict with any shared lock.</span>
02707     <span class="comment">//</span>
02708 
02709     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/filelock_8c.html#a57">FsRtlCheckNoExclusiveConflict</a>(LockQueue, &amp;Starting, &amp;Ending, Key, FileObject, ProcessId);
02710 
02711     <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
02712 
02713     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02714 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="filelock.c::FsRtlFastCheckLockForWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlFastCheckLockForWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingByte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l02718">2718</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00576">_FILE_LOCK_INFO::EndingByte</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00562">_FILE_LOCK_INFO::ExclusiveLock</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02469">FsRtlCheckNoExclusiveConflict()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02392">FsRtlCheckNoSharedConflict()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00484">FsRtlReacquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00568">_FILE_LOCK_INFO::Key</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00166">_LOCK_INFO::LowestLockOffset</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a28">PLOCK_QUEUE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00570">_FILE_LOCK_INFO::ProcessId</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00140">_LOCK_QUEUE::SharedLockTree</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00560">_FILE_LOCK_INFO::StartingByte</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01416">FsRtlCheckLockForWriteAccess()</a>.
<p>
<pre class="fragment"><div>02729                    :
02730 
02731     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has write access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02732     indicated range due to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> locks
02733 
02734 Arguments:
02735 
02736     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> to check
02737 
02738     StartingByte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first byte (zero based) to check
02739 
02740     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, to check
02741 
02742     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02743 
02744     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02745 
02746     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Process Id to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02747 
02748 Return Value:
02749 
02750     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated user/request has write access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02751         entire specified byte range, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
02752 
02753 --*/
02754 
02755 {
02756     LARGE_INTEGER Starting;
02757     LARGE_INTEGER Ending;
02758 
02759     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>              LockInfo;
02760     <a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>             LockQueue;
02761     KIRQL                   OldIrql;
02762     <a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>         LastLock;
02763     BOOLEAN                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02764 
02765     <span class="keywordflow">if</span> ((LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02766 
02767         <span class="comment">//</span>
02768         <span class="comment">// No lock information on this FileLock</span>
02769         <span class="comment">//</span>
02770 
02771         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForRead, No lock info\n"</span>, 0);
02772         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02773     }
02774 
02775     <span class="comment">//</span>
02776     <span class="comment">//  If there isn't a lock then we can immediately grant access</span>
02777     <span class="comment">//</span>
02778 
02779     <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02780 
02781         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForWrite, No locks present\n"</span>, 0);
02782         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02783     }
02784 
02785     <span class="comment">//</span>
02786     <span class="comment">//  If length is zero then automatically grant access</span>
02787     <span class="comment">//</span>
02788 
02789     <span class="keywordflow">if</span> ((ULONGLONG)Length-&gt;QuadPart == 0) {
02790 
02791         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForWrite, Length == 0\n"</span>, 0);
02792         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02793     }
02794 
02795     <span class="comment">//</span>
02796     <span class="comment">//  Get our starting and ending byte position</span>
02797     <span class="comment">//</span>
02798 
02799     Starting = *StartingByte;
02800     (ULONGLONG)Ending.QuadPart = (ULONGLONG)Starting.QuadPart + (ULONGLONG)Length-&gt;QuadPart - 1;
02801 
02802     <span class="comment">//</span>
02803     <span class="comment">//  Now check lock queue</span>
02804     <span class="comment">//</span>
02805 
02806     LockQueue = &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>;
02807 
02808     <span class="comment">//</span>
02809     <span class="comment">//  Grab the waiting lock queue spinlock to exclude anyone from messing</span>
02810     <span class="comment">//  with the queue while we're using it</span>
02811     <span class="comment">//</span>
02812 
02813     <a class="code" href="../../d5/d3/filelock_8c.html#a9">FsRtlReacquireLockQueue</a>(LockInfo, LockQueue, &amp;OldIrql);
02814 
02815     <span class="comment">//</span>
02816     <span class="comment">//  If the range ends below the lowest existing lock, this write is OK.</span>
02817     <span class="comment">//</span>
02818 
02819     <span class="keywordflow">if</span> ( ((ULONGLONG)Ending.QuadPart &lt; (ULONGLONG)LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o0">LowestLockOffset</a>) ) {
02820 
02821         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForWrite (below lowest lock)\n"</span>, 0);
02822 
02823         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
02824         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02825     }
02826 
02827     <span class="comment">//</span>
02828     <span class="comment">//  If the caller just locked this range exclusively, he can write it.</span>
02829     <span class="comment">//</span>
02830 
02831     LastLock = (<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>)((<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>)FileObject)-&gt;LastLock;
02832     <span class="keywordflow">if</span> ((LastLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02833         ((ULONGLONG)Starting.QuadPart &gt;= (ULONGLONG)LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart) &amp;&amp;
02834         ((ULONGLONG)Ending.QuadPart &lt;= (ULONGLONG)LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>.QuadPart) &amp;&amp;
02835         (LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>) &amp;&amp;
02836         (LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a> == ProcessId) &amp;&amp;
02837         LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o2">ExclusiveLock</a>) {
02838 
02839         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
02840         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02841     }
02842 
02843     <span class="comment">//</span>
02844     <span class="comment">//  Check the shared locks for overlap. Any overlap in the shared locks is fatal.</span>
02845     <span class="comment">//</span>
02846 
02847     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/filelock_8c.html#a56">FsRtlCheckNoSharedConflict</a>(LockQueue, &amp;Starting, &amp;Ending);
02848 
02849     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02850 
02851         <span class="comment">//</span>
02852         <span class="comment">//  No overlap in the shared locks, so check the exclusive locks for overlap.</span>
02853         <span class="comment">//</span>
02854 
02855         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/filelock_8c.html#a57">FsRtlCheckNoExclusiveConflict</a>(LockQueue, &amp;Starting, &amp;Ending, Key, FileObject, ProcessId);
02856     }
02857 
02858     <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
02859 
02860     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02861 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="filelock.c::FsRtlFastUnlockAll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlFastUnlockAll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l03770">3770</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">FsRtlProcessFileLock()</a>, <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, and <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>.
<p>
<pre class="fragment"><div>03779                    :
03780 
03781     This routine performs an <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> all operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current locks
03782     associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock.  Only those locks with
03783     a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object and process <span class="keywordtype">id</span> are freed.
03784 
03785 Arguments:
03786 
03787     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock being freed.
03788 
03789     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock
03790 
03791     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Process Id assoicated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locks to be
03792         freed
03793 
03794     Context - Supplies an optional context to use when completing waiting
03795         lock irps.
03796 
03797 Return Value:
03798 
03799     None
03800 
03801 --*/
03802 
03803 {
03804     <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/filelock_8c.html#a53">FsRtlPrivateFastUnlockAll</a>(
03805                 FileLock,
03806                 FileObject,
03807                 ProcessId,
03808                 0, FALSE,           <span class="comment">// No Key</span>
03809                 Context );
03810 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="filelock.c::FsRtlFastUnlockAllByKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlFastUnlockAllByKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l03814">3814</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">FsRtlProcessFileLock()</a>, and <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>.
<p>
<pre class="fragment"><div>03824                    :
03825 
03826     This routine performs an <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> All by <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current locks
03827     associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock.  Only those locks with
03828     a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object, process <span class="keywordtype">id</span>, and key are freed.  The input <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>
03829     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> completed by <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>
03830 
03831 Arguments:
03832 
03833     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock being freed.
03834 
03835     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock
03836 
03837     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Process Id assoicated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locks to be
03838         freed
03839 
03840     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> to use in <span class="keyword">this</span> operation
03841 
03842     Context - Supplies an optional context to use when completing waiting
03843         lock irps.
03844 
03845 Return Value:
03846 
03847     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
03848 
03849 --*/
03850 
03851 {
03852     <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/filelock_8c.html#a53">FsRtlPrivateFastUnlockAll</a>(
03853                 FileLock,
03854                 FileObject,
03855                 ProcessId,
03856                 Key, TRUE,
03857                 Context );
03858 
03859 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="filelock.c::FsRtlFastUnlockSingle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlFastUnlockSingle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LARGE_INTEGER UNALIGNED *&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AlreadySynchronized</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l03241">3241</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03589">FsRtlFastUnlockSingleExclusive()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">FsRtlProcessFileLock()</a>, and <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>.
<p>
<pre class="fragment"><div>03254                    :
03255 
03256     This routine performs an <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> Single operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current locks
03257     associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock.  Only <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock with a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a>
03258     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object, process <span class="keywordtype">id</span>, key, and range <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
03259 
03260 Arguments:
03261 
03262     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock being freed.
03263 
03264     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locks
03265 
03266     FileOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset to be unlocked
03267 
03268     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length in bytes to be unlocked
03269 
03270     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process Id to use in <span class="keyword">this</span> operation
03271 
03272     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key to use in <span class="keyword">this</span> operation
03273 
03274     Context - Optionally supplies context to use when completing Irps
03275 
03276     AlreadySynchronized - Indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has already <span class="keyword">synchronized</span>
03277         access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fields in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock and
03278         be updated without further locking, but not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queues.
03279 
03280 Return Value:
03281 
03282     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The completion status <span class="keywordflow">for</span> <span class="keyword">this</span> operation
03283 
03284 --*/
03285 
03286 {
03287     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03288 
03289     <span class="comment">//</span>
03290     <span class="comment">//  XXX AlreadySynchronized is obsolete. It was apparently added for the dead</span>
03291     <span class="comment">//  XXX SoloLock code.</span>
03292     <span class="comment">//</span>
03293 
03294     <span class="keywordflow">if</span> (FileLock-&gt;LockInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03295 
03296         <span class="comment">//</span>
03297         <span class="comment">//  Fast exit - no locks are applied</span>
03298         <span class="comment">//</span>
03299 
03300         <span class="keywordflow">return</span> STATUS_RANGE_NOT_LOCKED;
03301     }
03302 
03303     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/filelock_8c.html#a60">FsRtlFastUnlockSingleExclusive</a>( FileLock-&gt;LockInformation,
03304                                              FileObject,
03305                                              FileOffset,
03306                                              Length,
03307                                              ProcessId,
03308                                              Key,
03309                                              Context,
03310                                              FALSE,
03311                                              TRUE );
03312 
03313     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
03314 
03315         <span class="comment">//</span>
03316         <span class="comment">//  Found and unlocked in the exclusive tree, so we're done</span>
03317         <span class="comment">//</span>
03318 
03319         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03320     }
03321 
03322     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/filelock_8c.html#a59">FsRtlFastUnlockSingleShared</a>( FileLock-&gt;LockInformation,
03323                                           FileObject,
03324                                           FileOffset,
03325                                           Length,
03326                                           ProcessId,
03327                                           Key,
03328                                           Context,
03329                                           FALSE,
03330                                           TRUE );
03331 
03332     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03333 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="filelock.c::FsRtlFastUnlockSingleExclusive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlFastUnlockSingleExclusive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LockInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LARGE_INTEGER UNALIGNED *&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreUnlockRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CheckForWaiters</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l03589">3589</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00481">FsRtlAcquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01687">FsRtlFindFirstOverlappingExclusiveNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00446">FsRtlFreeExclusiveLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">FsRtlPrivateCheckWaitingLocks()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05150">FsRtlPrivateResetLowestLockOffset()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00484">FsRtlReacquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a24">PEX_LOCK</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a28">PLOCK_QUEUE</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00385">RtlDelete()</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00759">RtlRealSuccessor()</a>, and <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00142">_LOCK_QUEUE::WaitingLocks</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l03241">FsRtlFastUnlockSingle()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l03162">FsRtlPrivateRemoveLock()</a>.
<p>
<pre class="fragment"><div>03603                    :
03604 
03605     This routine performs an <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> Single operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exclusive locks
03606     associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified lock data.  Only <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock with a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a>
03607     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object, process <span class="keywordtype">id</span>, key, and range <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
03608 
03609 Arguments:
03610 
03611     LockInfo - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock data being operated on
03612 
03613     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locks
03614 
03615     FileOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset to be unlocked
03616 
03617     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length in bytes to be unlocked
03618 
03619     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process Id to use in <span class="keyword">this</span> operation
03620 
03621     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key to use in <span class="keyword">this</span> operation
03622 
03623     Context - Optionally supplies context to use when completing Irps
03624 
03625     IgnoreUnlockRoutine - inidicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filelock's unlock routine
03626         should not be called on lock removal (<span class="keywordflow">for</span> removal of aborted
03627         locks)
03628 
03629     CheckForWaiters - If <span class="keyword">true</span> check <span class="keywordflow">for</span> possible waiting locks, caused
03630         by freeing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locked range
03631 
03632 Return Value:
03633 
03634     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The completion status <span class="keywordflow">for</span> <span class="keyword">this</span> operation
03635 
03636 --*/
03637 
03638 {
03639     KIRQL                   OldIrql;
03640     <a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>             LockQueue;
03641     PRTL_SPLAY_LINKS        SplayLinks;
03642     LARGE_INTEGER           EndingOffset;
03643     <a class="code" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a>                <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
03644     LARGE_INTEGER           AlignedFileOffset;
03645 
03646     <span class="comment">//</span>
03647     <span class="comment">//  General case - search the outstanding lock queue for this lock</span>
03648     <span class="comment">//</span>
03649 
03650     AlignedFileOffset = *FileOffset;
03651 
03652     LockQueue = &amp;LockInfo-&gt;LockQueue;
03653 
03654     <a class="code" href="../../d5/d3/filelock_8c.html#a8">FsRtlAcquireLockQueue</a>(LockQueue, &amp;OldIrql);
03655 
03656     <span class="comment">//</span>
03657     <span class="comment">//  Check for the no locks currently held</span>
03658     <span class="comment">//</span>
03659 
03660     <span class="keywordflow">if</span> (LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03661 
03662         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>( LockQueue, OldIrql );
03663 
03664         <span class="keywordflow">return</span> STATUS_RANGE_NOT_LOCKED;
03665     }
03666 
03667     <span class="comment">//</span>
03668     <span class="comment">//  Find the overlapping lock, if it exists. Note that this is usually</span>
03669     <span class="comment">//  the only lock we need to check since we are assuming this is an</span>
03670     <span class="comment">//  existing lock. However, if the lock is a zero length lock we will</span>
03671     <span class="comment">//  have a run of locks to check.</span>
03672     <span class="comment">//</span>
03673 
03674     EndingOffset.QuadPart = (ULONGLONG)AlignedFileOffset.QuadPart + (ULONGLONG)Length-&gt;QuadPart - 1;
03675 
03676     <span class="keywordflow">for</span> (SplayLinks = <a class="code" href="../../d5/d3/filelock_8c.html#a44">FsRtlFindFirstOverlappingExclusiveNode</a>( LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>,
03677                                                               &amp;AlignedFileOffset,
03678                                                               &amp;EndingOffset,
03679                                                               NULL,
03680                                                               NULL );
03681          SplayLinks;
03682          SplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(SplayLinks)) {
03683 
03684         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links );
03685 
03686         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.FileObject == FileObject) &amp;&amp;
03687             (<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.ProcessId == ProcessId) &amp;&amp;
03688             (<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.Key == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>) &amp;&amp;
03689             ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart == (ULONGLONG)AlignedFileOffset.QuadPart) &amp;&amp;
03690             ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.Length.QuadPart == (ULONGLONG)Length-&gt;QuadPart)) {
03691 
03692             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"Ex Found one to unlock\n"</span>, 0);
03693 
03694             <span class="comment">//</span>
03695             <span class="comment">//  We have an exact match so now is the time to delete this</span>
03696             <span class="comment">//  lock.  Remove the lock from the list, then call the</span>
03697             <span class="comment">//  optional unlock routine, then delete the lock.</span>
03698             <span class="comment">//</span>
03699 
03700             <span class="keywordflow">if</span> (FileObject-&gt;LastLock == &amp;<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo) {
03701 
03702                 FileObject-&gt;LastLock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03703             }
03704 
03705             <span class="comment">//</span>
03706             <span class="comment">//  Snip the deleted lock</span>
03707             <span class="comment">//</span>
03708 
03709             LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> = <a class="code" href="../../d3/d4/splay_8c.html#a4">RtlDelete</a>(&amp;<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;Links);
03710 
03711             <span class="keywordflow">if</span> (LockInfo-&gt;LowestLockOffset != 0xffffffff &amp;&amp;
03712                 LockInfo-&gt;LowestLockOffset == <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.LowPart) {
03713 
03714                 <span class="comment">//</span>
03715                 <span class="comment">//  This was the lowest lock in the tree, so reset the lowest lock</span>
03716                 <span class="comment">//  offset</span>
03717                 <span class="comment">//</span>
03718 
03719                 <a class="code" href="../../d5/d3/filelock_8c.html#a58">FsRtlPrivateResetLowestLockOffset</a>(LockInfo);
03720             }
03721 
03722             <span class="keywordflow">if</span> (!IgnoreUnlockRoutine &amp;&amp; LockInfo-&gt;UnlockRoutine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03723 
03724                 <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>( LockQueue, OldIrql );
03725 
03726                 LockInfo-&gt;UnlockRoutine( Context, &amp;<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo );
03727 
03728                 <a class="code" href="../../d5/d3/filelock_8c.html#a9">FsRtlReacquireLockQueue</a>( LockInfo, LockQueue, &amp;OldIrql );
03729 
03730             }
03731 
03732             <a class="code" href="../../d5/d3/filelock_8c.html#a37">FsRtlFreeExclusiveLock</a>( Lock );
03733 
03734             <span class="comment">//</span>
03735             <span class="comment">//  See if there are additional waiting locks that we can</span>
03736             <span class="comment">//  now release.</span>
03737             <span class="comment">//</span>
03738 
03739             <span class="keywordflow">if</span> (CheckForWaiters &amp;&amp; LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o3">WaitingLocks</a>.Next) {
03740 
03741                 <a class="code" href="../../d5/d3/filelock_8c.html#a49">FsRtlPrivateCheckWaitingLocks</a>( LockInfo, LockQueue, OldIrql );
03742             }
03743 
03744             <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>( LockQueue, OldIrql );
03745 
03746             <span class="keywordflow">return</span> STATUS_SUCCESS;
03747         }
03748 
03749         <span class="keywordflow">if</span> ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart &gt; (ULONGLONG)AlignedFileOffset.QuadPart) {
03750 
03751             <span class="comment">//</span>
03752             <span class="comment">//  The current lock begins at a byte offset greater than the range we are seeking</span>
03753             <span class="comment">//  to unlock. This range must therefore not be locked.</span>
03754             <span class="comment">//</span>
03755 
03756             <span class="keywordflow">break</span>;
03757         }
03758     }
03759 
03760     <span class="comment">//</span>
03761     <span class="comment">//  Lock was not found, return to our caller</span>
03762     <span class="comment">//</span>
03763 
03764     <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
03765     <span class="keywordflow">return</span> STATUS_RANGE_NOT_LOCKED;
03766 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="filelock.c::FsRtlFastUnlockSingleShared" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlFastUnlockSingleShared           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LockInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LARGE_INTEGER UNALIGNED *&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreUnlockRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CheckForWaiters</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">3337</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00481">FsRtlAcquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01517">FsRtlFindFirstOverlappingSharedNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00464">FsRtlFreeLockTreeNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00437">FsRtlFreeSharedLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">FsRtlPrivateCheckWaitingLocks()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05150">FsRtlPrivateResetLowestLockOffset()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00484">FsRtlReacquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02865">FsRtlSplitLocks()</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00008">_LOCKTREE_NODE::Locks</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a28">PLOCK_QUEUE</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a20">PLOCKTREE_NODE</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00385">RtlDelete()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00140">_LOCK_QUEUE::SharedLockTree</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00042">_LOCKTREE_NODE::Tail</a>, and <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00142">_LOCK_QUEUE::WaitingLocks</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l03241">FsRtlFastUnlockSingle()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l03162">FsRtlPrivateRemoveLock()</a>.
<p>
<pre class="fragment"><div>03351                    :
03352 
03353     This routine performs an <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> Single operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current locks
03354     associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock.  Only <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock with a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a>
03355     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object, process <span class="keywordtype">id</span>, key, and range <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
03356 
03357 Arguments:
03358 
03359     LockInfo - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock data being operated on
03360 
03361     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locks
03362 
03363     FileOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset to be unlocked
03364 
03365     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length in bytes to be unlocked
03366 
03367     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process Id to use in <span class="keyword">this</span> operation
03368 
03369     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key to use in <span class="keyword">this</span> operation
03370 
03371     Context - Optionally supplies context to use when completing Irps
03372 
03373     IgnoreUnlockRoutine - inidicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filelock's unlock routine
03374         should not be called on lock removal (<span class="keywordflow">for</span> removal of aborted
03375         locks)
03376 
03377     CheckForWaiters - If <span class="keyword">true</span> check <span class="keywordflow">for</span> possible waiting locks, caused
03378         by freeing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locked range
03379 
03380 Return Value:
03381 
03382     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The completion status <span class="keywordflow">for</span> <span class="keyword">this</span> operation
03383 
03384 --*/
03385 
03386 {
03387     PSINGLE_LIST_ENTRY      *pLink, Link;
03388     KIRQL                   OldIrql;
03389 
03390     <a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>             LockQueue;
03391     PRTL_SPLAY_LINKS        SplayLinks;
03392     LARGE_INTEGER           EndingOffset, MaxOffset;
03393     <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>          Node;
03394     LARGE_INTEGER           AlignedFileOffset;
03395 
03396     <span class="comment">//</span>
03397     <span class="comment">//  General case - search the outstanding lock queue for this lock</span>
03398     <span class="comment">//</span>
03399 
03400     AlignedFileOffset = *FileOffset;
03401 
03402     LockQueue = &amp;LockInfo-&gt;LockQueue;
03403 
03404     <a class="code" href="../../d5/d3/filelock_8c.html#a8">FsRtlAcquireLockQueue</a>(LockQueue, &amp;OldIrql);
03405 
03406     <span class="comment">//</span>
03407     <span class="comment">//  Check for the no locks currently held</span>
03408     <span class="comment">//</span>
03409 
03410     <span class="keywordflow">if</span> (LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03411 
03412         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>( LockQueue, OldIrql );
03413 
03414         <span class="keywordflow">return</span> STATUS_RANGE_NOT_LOCKED;
03415     }
03416 
03417     <span class="comment">//</span>
03418     <span class="comment">//  Find the overlapping node, if it exists, to search. Note that</span>
03419     <span class="comment">//  we don't have to go through more than one node in the tree</span>
03420     <span class="comment">//  since we are assuming this is an existing lock.</span>
03421     <span class="comment">//</span>
03422 
03423     EndingOffset.QuadPart = (ULONGLONG)AlignedFileOffset.QuadPart + (ULONGLONG)Length-&gt;QuadPart - 1;
03424 
03425     SplayLinks = <a class="code" href="../../d5/d3/filelock_8c.html#a43">FsRtlFindFirstOverlappingSharedNode</a>( LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>,
03426                                                       &amp;AlignedFileOffset,
03427                                                       &amp;EndingOffset,
03428                                                       NULL,
03429                                                       NULL );
03430 
03431     <span class="keywordflow">if</span> (SplayLinks == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03432 
03433         <span class="comment">//</span>
03434         <span class="comment">//  No node in the tree overlaps this range, so we're done</span>
03435         <span class="comment">//</span>
03436 
03437         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
03438 
03439         <span class="keywordflow">return</span> STATUS_RANGE_NOT_LOCKED;
03440     }
03441 
03442     Node = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
03443     MaxOffset.QuadPart = 0;
03444 
03445     <span class="keywordflow">for</span> (pLink = &amp;Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next;
03446          (Link = *pLink) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03447          pLink = &amp;Link-&gt;Next) {
03448 
03449         <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
03450 
03451         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = CONTAINING_RECORD( Link, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
03452 
03453         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"Sh Top of Loop, Lock = %08lx\n"</span>, Lock );
03454 
03455         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.FileObject == FileObject) &amp;&amp;
03456             (<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.ProcessId == ProcessId) &amp;&amp;
03457             (<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.Key == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>) &amp;&amp;
03458             ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart == (ULONGLONG)AlignedFileOffset.QuadPart) &amp;&amp;
03459             ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.Length.QuadPart == (ULONGLONG)Length-&gt;QuadPart)) {
03460 
03461             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"Sh Found one to unlock\n"</span>, 0);
03462 
03463             <span class="comment">//</span>
03464             <span class="comment">//  We have an exact match so now is the time to delete this</span>
03465             <span class="comment">//  lock.  Remove the lock from the list, then call the</span>
03466             <span class="comment">//  optional unlock routine, then delete the lock.</span>
03467             <span class="comment">//</span>
03468 
03469             <span class="keywordflow">if</span> (FileObject-&gt;LastLock == &amp;<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo) {
03470 
03471                 FileObject-&gt;LastLock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03472             }
03473 
03474             <span class="keywordflow">if</span> (*pLink == Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o4">Tail</a>.Next) {
03475 
03476                 <span class="comment">//</span>
03477                 <span class="comment">//  Deleting the tail node of the list. Safe even if deleting the</span>
03478                 <span class="comment">//  first node since this implies we're also deleting the last node</span>
03479                 <span class="comment">//  in the node which means we'll delete the node ...</span>
03480                 <span class="comment">//</span>
03481 
03482                 Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o4">Tail</a>.Next = CONTAINING_RECORD( pLink, SINGLE_LIST_ENTRY, Next );
03483             }
03484 
03485             <span class="comment">//</span>
03486             <span class="comment">//  Snip the deleted lock</span>
03487             <span class="comment">//</span>
03488 
03489             *pLink = Link-&gt;Next;
03490 
03491             <span class="keywordflow">if</span> (pLink == &amp;Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next) {
03492 
03493                 <span class="comment">//</span>
03494                 <span class="comment">//  Deleted first lock in node</span>
03495                 <span class="comment">//</span>
03496 
03497                 <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03498 
03499                     <span class="comment">//</span>
03500                     <span class="comment">// Just deleted last lock on this node, so free it</span>
03501                     <span class="comment">//</span>
03502 
03503                     LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a> = <a class="code" href="../../d3/d4/splay_8c.html#a4">RtlDelete</a>(SplayLinks);
03504 
03505                     <a class="code" href="../../d5/d3/filelock_8c.html#a39">FsRtlFreeLockTreeNode</a>(Node);
03506 
03507                     Node = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03508                 }
03509 
03510                 <span class="keywordflow">if</span> (LockInfo-&gt;LowestLockOffset != 0xffffffff &amp;&amp;
03511                     LockInfo-&gt;LowestLockOffset == <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.LowPart) {
03512 
03513                     <span class="comment">//</span>
03514                     <span class="comment">//  This was the lowest lock in the trees, reset the lowest lock offset</span>
03515                     <span class="comment">//</span>
03516 
03517                     <a class="code" href="../../d5/d3/filelock_8c.html#a58">FsRtlPrivateResetLowestLockOffset</a>(LockInfo);
03518                 }
03519             }
03520 
03521             <span class="comment">//</span>
03522             <span class="comment">//  Now the fun begins. It may be the case that the lock just snipped from</span>
03523             <span class="comment">//  the chain was gluing locks at this node together, so we need to</span>
03524             <span class="comment">//  inspect the chain.</span>
03525             <span class="comment">//</span>
03526 
03527             <span class="keywordflow">if</span> (Node) {
03528 
03529                 <a class="code" href="../../d5/d3/filelock_8c.html#a72">FsRtlSplitLocks</a>(Node, pLink, &amp;<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.EndingByte, &amp;MaxOffset);
03530             }
03531 
03532             <span class="keywordflow">if</span> (!IgnoreUnlockRoutine &amp;&amp; LockInfo-&gt;UnlockRoutine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03533 
03534                 <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>( LockQueue, OldIrql );
03535 
03536                 LockInfo-&gt;UnlockRoutine( Context, &amp;<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo );
03537 
03538                 <a class="code" href="../../d5/d3/filelock_8c.html#a9">FsRtlReacquireLockQueue</a>( LockInfo, LockQueue, &amp;OldIrql );
03539 
03540             }
03541 
03542             <a class="code" href="../../d5/d3/filelock_8c.html#a36">FsRtlFreeSharedLock</a>( Lock );
03543 
03544             <span class="comment">//</span>
03545             <span class="comment">//  See if there are additional waiting locks that we can</span>
03546             <span class="comment">//  now release.</span>
03547             <span class="comment">//</span>
03548 
03549             <span class="keywordflow">if</span> (CheckForWaiters &amp;&amp; LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o3">WaitingLocks</a>.Next) {
03550 
03551                 <a class="code" href="../../d5/d3/filelock_8c.html#a49">FsRtlPrivateCheckWaitingLocks</a>( LockInfo, LockQueue, OldIrql );
03552             }
03553 
03554             <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>( LockQueue, OldIrql );
03555 
03556             <span class="keywordflow">return</span> STATUS_SUCCESS;
03557         }
03558 
03559         <span class="keywordflow">if</span> ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart &gt; (ULONGLONG)AlignedFileOffset.QuadPart) {
03560 
03561             <span class="comment">//</span>
03562             <span class="comment">//  The current lock begins at a byte offset greater than the range we are seeking</span>
03563             <span class="comment">//  to unlock. This range must therefore not be locked.</span>
03564             <span class="comment">//</span>
03565 
03566             <span class="keywordflow">break</span>;
03567         }
03568 
03569         <span class="keywordflow">if</span> ((ULONGLONG)MaxOffset.QuadPart &lt; (ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.EndingByte.QuadPart) {
03570 
03571             <span class="comment">//</span>
03572             <span class="comment">// Maintain the maximum offset affected by locks up to this point.</span>
03573             <span class="comment">//</span>
03574 
03575             MaxOffset.QuadPart = <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.EndingByte.QuadPart;
03576         }
03577     }
03578 
03579     <span class="comment">//</span>
03580     <span class="comment">//  Lock was not found, return to our caller</span>
03581     <span class="comment">//</span>
03582 
03583     <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
03584     <span class="keywordflow">return</span> STATUS_RANGE_NOT_LOCKED;
03585 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="filelock.c::FsRtlFindFirstOverlapInNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a> FsRtlFindFirstOverlapInNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingByte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>EndingByte</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01856">1856</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l02392">FsRtlCheckNoSharedConflict()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l04934">FsRtlPrivateCheckForExclusiveLockAccess()</a>.
<p>
<pre class="fragment"><div>01864                    :
01865 
01866     This routine examines a shared lock node, usually a node which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> known to be composed
01867     of several non-overlapping lock segments (holey), <span class="keywordflow">for</span> <span class="keyword">true</span> overlap with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated
01868     range.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not handled in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal overlap check (..FindFirstOverlappingSharedLock)
01869     since the needs for holey checks are rather different than the full node check.
01870 
01871 Arguments:
01872 
01873     Node - the lock tree node to be examined for overlap
01874 
01875     StartingByte - supplies the first byte offset of the range to check
01876 
01877     EndingByte - supplies the last byte offset of the range to check
01878 
01879 Return Value:
01880 
01881     <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a> - the first lock which overlaps with the specified range.
01882 
01883 --*/
01884 {
01885     <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
01886     PSINGLE_LIST_ENTRY Link;
01887 
01888     <span class="keywordflow">for</span> (Link = Node-&gt;Locks.Next;
01889          Link;
01890          Link = Link-&gt;Next) {
01891 
01892         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = CONTAINING_RECORD( Link, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
01893 
01894         <span class="comment">//</span>
01895         <span class="comment">//  Logic is the same as above checkers.  If the ending byte of the lock is less than the</span>
01896         <span class="comment">//  starting byte of the range, OR we have the weird [0, 0) case, then the lock is almost</span>
01897         <span class="comment">//  certainly less than the range.</span>
01898         <span class="comment">//</span>
01899 
01900         <span class="keywordflow">if</span> ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.EndingByte.QuadPart &lt; (ULONGLONG)StartingByte-&gt;QuadPart ||
01901             (<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart == 0 &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.Length.QuadPart == 0)) {
01902 
01903             <span class="comment">//</span>
01904             <span class="comment">//  ... except if the lock and range are equivalent, in which case we have discovered</span>
01905             <span class="comment">//  zero lock/range overlap.</span>
01906             <span class="comment">//</span>
01907 
01908             <span class="keywordflow">if</span> ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.EndingByte.QuadPart == (ULONGLONG)EndingByte-&gt;QuadPart &amp;&amp;
01909                 (ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart == (ULONGLONG)StartingByte-&gt;QuadPart) {
01910 
01911                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
01912             }
01913 
01914             <span class="comment">//</span>
01915             <span class="comment">//  Look forward in the node.</span>
01916             <span class="comment">//</span>
01917 
01918             <span class="keywordflow">continue</span>;
01919         }
01920 
01921         <span class="comment">//</span>
01922         <span class="comment">//  No overlap at all if the lock begins at a higher byte than the last of the range.</span>
01923         <span class="comment">//  We already covered zero length locks (where this is true, and overlap could still</span>
01924         <span class="comment">//  occur).</span>
01925         <span class="comment">//</span>
01926 
01927         <span class="keywordflow">if</span> ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart &gt; (ULONGLONG)EndingByte-&gt;QuadPart) {
01928 
01929             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01930         }
01931 
01932         <span class="comment">//</span>
01933         <span class="comment">//  Regular overlap has occured.  Return this lock.</span>
01934         <span class="comment">//</span>
01935 
01936         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
01937     }
01938 
01939     <span class="comment">//</span>
01940     <span class="comment">//  If we invoke this check and wander off the end of the node without determining what is</span>
01941     <span class="comment">//  going on, something is terribly wrong.</span>
01942     <span class="comment">//</span>
01943 
01944     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FALSE );
01945 
01946     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01947 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="filelock.c::FsRtlFindFirstOverlappingExclusiveNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PRTL_SPLAY_LINKS FsRtlFindFirstOverlappingExclusiveNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_SPLAY_LINKS&nbsp;</td>
          <td class="mdname" nowrap> <em>Tree</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingByte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>EndingByte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PRTL_SPLAY_LINKS *&nbsp;</td>
          <td class="mdname" nowrap> <em>LastEdgeNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GreaterThan</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01687">1687</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a24">PEX_LOCK</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l02469">FsRtlCheckNoExclusiveConflict()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03589">FsRtlFastUnlockSingleExclusive()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01951">FsRtlGetNextFileLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04934">FsRtlPrivateCheckForExclusiveLockAccess()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05046">FsRtlPrivateCheckForSharedLockAccess()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l04605">FsRtlPrivateInsertExclusiveLock()</a>.
<p>
<pre class="fragment"><div>01696                    :
01697 
01698     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exclusive lock tree which
01699     overlaps with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range given. No nodes given by <a class="code" href="../../d3/d4/splay_8c.html#a9">RtlRealPredecessor</a>()
01700     on the result overlap the range.
01701 
01702 Arguments:
01703 
01704     Tree - supplies the splay links of the root node of the exclusive tree
01705         to search
01706 
01707     StartingByte - supplies the first byte offset of the range to check
01708 
01709     EndingByte - supplies the last byte offset of the range to check
01710 
01711     LastEdgeNode - optional, will be set to the last node searched
01712         not including returned node (presumeably where a new node will
01713         be inserted if return is NULL).
01714 
01715     GreaterThan - optional, set according to whether LastEdgeNode is covering
01716         a range greater than the queried range. !GreaterThan == LessThan, since
01717         we would have returned this node in the "Equals" (overlap) case.
01718 
01719 Return Value:
01720 
01721     The splay links of the node, if such a node exists, NULL otherwise
01722 
01723 --*/
01724 {
01725     PRTL_SPLAY_LINKS    SplayLinks;
01726     <a class="code" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a>            <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>, LastOverlapNode;
01727 
01728     <span class="keywordflow">if</span> (LastEdgeNode) *LastEdgeNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01729     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) *<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01730 
01731     LastOverlapNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01732     SplayLinks = Tree;
01733 
01734     <span class="keywordflow">while</span> (SplayLinks) {
01735 
01736         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links );
01737 
01738         <span class="comment">//</span>
01739         <span class="comment">//  We may have to go right in the tree if this lock covers a range before the start of this</span>
01740         <span class="comment">//  range we are looking for overlap on or this lock is [0, 0).  This is important since a lock</span>
01741         <span class="comment">//  on [0, 0) will look like the extent is from [0, ~0], which is the only case where the zero</span>
01742         <span class="comment">//  length lock relation of End &lt; Start does not hold.</span>
01743         <span class="comment">//</span>
01744 
01745         <span class="keywordflow">if</span> ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.EndingByte.QuadPart &lt; (ULONGLONG)StartingByte-&gt;QuadPart ||
01746             (<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart == 0 &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.Length.QuadPart == 0)) {
01747 
01748             <span class="keywordflow">if</span> ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.EndingByte.QuadPart == (ULONGLONG)EndingByte-&gt;QuadPart &amp;&amp;
01749                 (ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart == (ULONGLONG)StartingByte-&gt;QuadPart) {
01750 
01751                 <span class="comment">//</span>
01752                 <span class="comment">//  The extent of the lock is less than the starting position of the</span>
01753                 <span class="comment">//  range we are checking and the lock is equal to the range, which</span>
01754                 <span class="comment">//  implies that the range and the lock are zero length.</span>
01755                 <span class="comment">//</span>
01756                 <span class="comment">//  This is a zero length lock node and we are searching for zero</span>
01757                 <span class="comment">//  length overlap. Since the exclusive tree is one lock per node,</span>
01758                 <span class="comment">//  we are in the potential middle of a run of zero length locks in</span>
01759                 <span class="comment">//  the tree. Go left to find the first zero length lock.</span>
01760                 <span class="comment">//</span>
01761                 <span class="comment">//  This is actually the same logic we'd use for equivalent locks,</span>
01762                 <span class="comment">//  but the only time that can happen in this tree is for zero length</span>
01763                 <span class="comment">//  locks.</span>
01764                 <span class="comment">//</span>
01765 
01766                 LastOverlapNode = <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
01767 
01768                 <span class="keywordflow">if</span> (LastEdgeNode) *LastEdgeNode = SplayLinks;
01769                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) *<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01770 
01771                 SplayLinks = RtlLeftChild(SplayLinks);
01772                 <span class="keywordflow">continue</span>;
01773             }
01774 
01775             <span class="comment">//</span>
01776             <span class="comment">//  This lock is strictly less than this byterange, so go</span>
01777             <span class="comment">//  right in the tree.</span>
01778             <span class="comment">//</span>
01779 
01780             <span class="keywordflow">if</span> (LastEdgeNode) *LastEdgeNode = SplayLinks;
01781             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) *<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01782 
01783             SplayLinks = RtlRightChild(SplayLinks);
01784             <span class="keywordflow">continue</span>;
01785         }
01786 
01787         <span class="keywordflow">if</span> ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart &lt;= (ULONGLONG)EndingByte-&gt;QuadPart) {
01788 
01789             <span class="comment">//</span>
01790             <span class="comment">//  We have an overlap, but we need to see if the byterange starts</span>
01791             <span class="comment">//  before this node so that there is the guarantee that we start</span>
01792             <span class="comment">//  the search at the correct point. There may be still be predecessor</span>
01793             <span class="comment">//  nodes covering the byterange.</span>
01794             <span class="comment">//</span>
01795 
01796             <span class="keywordflow">if</span> ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart &lt;= (ULONGLONG)StartingByte-&gt;QuadPart) {
01797 
01798                 <span class="comment">//</span>
01799                 <span class="comment">//  This node begins at a byte offset prior to the byterange we</span>
01800                 <span class="comment">//  are checking, so it must be the correct starting position.</span>
01801                 <span class="comment">//</span>
01802 
01803                 <span class="keywordflow">break</span>;
01804             }
01805 
01806             <span class="comment">//</span>
01807             <span class="comment">//  Drop a marker at this node so that we can come back if it turns out</span>
01808             <span class="comment">//  that the left subtree does not cover the range of bytes before this</span>
01809             <span class="comment">//  node in the byterange.</span>
01810             <span class="comment">//</span>
01811 
01812             LastOverlapNode = <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
01813         }
01814 
01815         <span class="comment">//</span>
01816         <span class="comment">//  It must now be the case this lock is strictly greater than the byterange,</span>
01817         <span class="comment">//  or we have the candidate overlap case above, so go left in the tree.</span>
01818         <span class="comment">//</span>
01819 
01820         <span class="keywordflow">if</span> (LastEdgeNode) *LastEdgeNode = SplayLinks;
01821         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) *<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01822 
01823         SplayLinks = RtlLeftChild(SplayLinks);
01824     }
01825 
01826     <span class="keywordflow">if</span> (SplayLinks == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01827 
01828         <span class="comment">//</span>
01829         <span class="comment">//  We hit the edge of the tree. If the LastOverlapNode is set, it means that</span>
01830         <span class="comment">//  we had kept searching left in the tree for a node that covered the starting</span>
01831         <span class="comment">//  byte of the byterange, but didn't find it. If it isn't set, we'll do the</span>
01832         <span class="comment">//  right thing anyway since Node &lt;- NULL.</span>
01833         <span class="comment">//</span>
01834 
01835         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = LastOverlapNode;
01836     }
01837 
01838     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01839 
01840         <span class="comment">//</span>
01841         <span class="comment">// No overlapping lock existed</span>
01842         <span class="comment">//</span>
01843 
01844         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01845     }
01846 
01847     <span class="comment">//</span>
01848     <span class="comment">// Return the splay links of the first overlapping lock</span>
01849     <span class="comment">//</span>
01850 
01851     <span class="keywordflow">return</span> &amp;<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;Links;
01852 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="filelock.c::FsRtlFindFirstOverlappingSharedNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PRTL_SPLAY_LINKS FsRtlFindFirstOverlappingSharedNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_SPLAY_LINKS&nbsp;</td>
          <td class="mdname" nowrap> <em>Tree</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingByte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>EndingByte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PRTL_SPLAY_LINKS *&nbsp;</td>
          <td class="mdname" nowrap> <em>LastEdgeNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GreaterThan</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01517">1517</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00029">_LOCKTREE_NODE::Extent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00036">_LOCKTREE_NODE::Links</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00008">_LOCKTREE_NODE::Locks</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a20">PLOCKTREE_NODE</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l02392">FsRtlCheckNoSharedConflict()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01951">FsRtlGetNextFileLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04934">FsRtlPrivateCheckForExclusiveLockAccess()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l04343">FsRtlPrivateInsertSharedLock()</a>.
<p>
<pre class="fragment"><div>01526                    :
01527 
01528     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> shared lock tree which
01529     overlaps with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range given. No nodes given by <a class="code" href="../../d3/d4/splay_8c.html#a9">RtlRealPredecessor</a>()
01530     on the result overlap the range.
01531 
01532 Arguments:
01533 
01534     Tree - supplies the splay links of the root node of the shared tree
01535         to search
01536 
01537     StartingByte - supplies the first byte offset of the range to check
01538 
01539     EndingByte - supplies the last byte offset of the range to check
01540 
01541     LastEdgeNode - optional, will be set to the last node searched in the
01542         not including returned node (presumeably where a new node will
01543         be inserted if return is NULL).
01544 
01545     GreaterThan - optional, set according to whether LastEdgeNode is covering
01546         a range greater than the queried range. !GreaterThan == LessThan, since
01547         we would have returned this node in the "Equals" (overlap) case.
01548 
01549 Return Value:
01550 
01551     The splay links of the node, if such a node exists, NULL otherwise
01552 
01553 --*/
01554 {
01555     <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>        Node, LastOverlapNode;
01556     PRTL_SPLAY_LINKS      SplayLinks;
01557     <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a>              <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
01558 
01559     <span class="keywordflow">if</span> (LastEdgeNode) *LastEdgeNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01560     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) *<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01561 
01562     LastOverlapNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01563     SplayLinks = Tree;
01564 
01565     <span class="keywordflow">while</span> (SplayLinks) {
01566 
01567         Node = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
01568 
01569         <span class="comment">//</span>
01570         <span class="comment">//  Pull up the first lock on the chain at this node to check</span>
01571         <span class="comment">//  the starting byte offset of locks at this node</span>
01572         <span class="comment">//</span>
01573 
01574         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = CONTAINING_RECORD( Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
01575 
01576         <span class="comment">//</span>
01577         <span class="comment">//  We may have to go right in the tree if this lock covers a range before the start of this</span>
01578         <span class="comment">//  range we are looking for overlap on or this lock is [0, 0).  This is important since a lock</span>
01579         <span class="comment">//  on [0, 0) will look like the extent is from [0, ~0], which is the only case where the zero</span>
01580         <span class="comment">//  length lock relation of End &lt; Start does not hold.</span>
01581         <span class="comment">//</span>
01582 
01583         <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o2">Extent</a> &lt; (ULONGLONG)StartingByte-&gt;QuadPart ||
01584             (<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart == 0 &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.Length.QuadPart == 0)) {
01585 
01586             <span class="keywordflow">if</span> ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.EndingByte.QuadPart == (ULONGLONG)EndingByte-&gt;QuadPart &amp;&amp;
01587                 (ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart == (ULONGLONG)StartingByte-&gt;QuadPart) {
01588 
01589                 <span class="comment">//</span>
01590                 <span class="comment">//  The extent of the node is less than the starting position of the</span>
01591                 <span class="comment">//  range we are checking and the first lock on this node is equal to</span>
01592                 <span class="comment">//  the range, which implies that the range and the lock are zero</span>
01593                 <span class="comment">//  length.</span>
01594                 <span class="comment">//</span>
01595                 <span class="comment">//  This is a zero length lock node and we are searching for zero</span>
01596                 <span class="comment">//  length overlap. This makes multiple zero length shared locks</span>
01597                 <span class="comment">//  occupy the same node, which is a win, but makes application of</span>
01598                 <span class="comment">//  zero length exclusive locks check the length of the overlapping</span>
01599                 <span class="comment">//  lock to see if they really conflict.</span>
01600                 <span class="comment">//</span>
01601 
01602                 <span class="keywordflow">break</span>;
01603             }
01604 
01605             <span class="comment">//</span>
01606             <span class="comment">//  All locks at this node are strictly less than this</span>
01607             <span class="comment">//  byterange, so go right in the tree.</span>
01608             <span class="comment">//</span>
01609 
01610             <span class="keywordflow">if</span> (LastEdgeNode) *LastEdgeNode = SplayLinks;
01611             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) *<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01612 
01613             SplayLinks = RtlRightChild(SplayLinks);
01614             <span class="keywordflow">continue</span>;
01615         }
01616 
01617         <span class="keywordflow">if</span> ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart &lt;= (ULONGLONG)EndingByte-&gt;QuadPart) {
01618 
01619             <span class="comment">//</span>
01620             <span class="comment">//  We have an overlap, but we need to see if the byterange starts</span>
01621             <span class="comment">//  before this node so that there is the guarantee that we start</span>
01622             <span class="comment">//  the search at the correct point. There may be still be predecessor</span>
01623             <span class="comment">//  nodes covering the byterange.</span>
01624             <span class="comment">//</span>
01625 
01626             <span class="keywordflow">if</span> ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart &lt;= (ULONGLONG)StartingByte-&gt;QuadPart) {
01627 
01628                 <span class="comment">//</span>
01629                 <span class="comment">//  This node begins at a byte offset prior to the byterange we</span>
01630                 <span class="comment">//  are checking, so it must be the correct starting position.</span>
01631                 <span class="comment">//</span>
01632 
01633                 <span class="keywordflow">break</span>;
01634             }
01635 
01636             <span class="comment">//</span>
01637             <span class="comment">//  Drop a marker at this node so that we can come back if it turns out</span>
01638             <span class="comment">//  that the left subtree does not cover the range of bytes before this</span>
01639             <span class="comment">//  node in the byterange.</span>
01640             <span class="comment">//</span>
01641 
01642             LastOverlapNode = Node;
01643         }
01644 
01645         <span class="comment">//</span>
01646         <span class="comment">//  It must now be the case that all locks at this node are strictly greater</span>
01647         <span class="comment">//  than the byterange, or we have the candidate overlap case above,</span>
01648         <span class="comment">//  so go left in the tree.</span>
01649         <span class="comment">//</span>
01650 
01651         <span class="keywordflow">if</span> (LastEdgeNode) *LastEdgeNode = SplayLinks;
01652         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) *<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01653 
01654         SplayLinks = RtlLeftChild(SplayLinks);
01655     }
01656 
01657     <span class="keywordflow">if</span> (SplayLinks == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01658 
01659         <span class="comment">//</span>
01660         <span class="comment">//  We hit the edge of the tree. If the LastOverlapNode is set, it means that</span>
01661         <span class="comment">//  we had kept searching left in the tree for a node that covered the starting</span>
01662         <span class="comment">//  byte of the byterange, but didn't find it. If it isn't set, we'll do the</span>
01663         <span class="comment">//  right thing anyway since Node &lt;- NULL.</span>
01664         <span class="comment">//</span>
01665 
01666         Node = LastOverlapNode;
01667     }
01668 
01669     <span class="keywordflow">if</span> (Node == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01670 
01671         <span class="comment">//</span>
01672         <span class="comment">// No overlapping node existed</span>
01673         <span class="comment">//</span>
01674 
01675         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01676     }
01677 
01678     <span class="comment">//</span>
01679     <span class="comment">// Return the splay links of the first overlapping node</span>
01680     <span class="comment">//</span>
01681 
01682     <span class="keywordflow">return</span> &amp;Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o3">Links</a>;
01683 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="filelock.c::FsRtlFreeExclusiveLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE VOID FsRtlFreeExclusiveLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>C</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00446">446</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00821">ExFreeToNPagedLookasideList()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00132">FsRtlExclusiveLockLookasideList</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l03589">FsRtlFastUnlockSingleExclusive()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.
<p>
<pre class="fragment"><div>00449 {
00450     <a class="code" href="../../d5/d8/ex_8h.html#a249">ExFreeToNPagedLookasideList</a>( &amp;FsRtlExclusiveLockLookasideList, (PVOID)C );
00451 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="filelock.c::FsRtlFreeFileLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlFreeFileLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileLock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01162">1162</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00947">ExFreeToPagedLookasideList()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00137">FsRtlFileLockLookasideList</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02178">UdfDeleteFcb()</a>.
<p>
<pre class="fragment"><div>01165 {
01166     <a class="code" href="../../d1/d8/fsrtl_8h.html#a115">FsRtlUninitializeFileLock</a>( FileLock );
01167 
01168     <a class="code" href="../../d5/d8/ex_8h.html#a253">ExFreeToPagedLookasideList</a>( &amp;FsRtlFileLockLookasideList, FileLock );
01169 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="filelock.c::FsRtlFreeLockInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE VOID FsRtlFreeLockInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>C</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00473">473</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00821">ExFreeToNPagedLookasideList()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00135">FsRtlLockInfoLookasideList</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.
<p>
<pre class="fragment"><div>00476 {
00477     <a class="code" href="../../d5/d8/ex_8h.html#a249">ExFreeToNPagedLookasideList</a>( &amp;FsRtlLockInfoLookasideList, (PVOID)C );
00478 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="filelock.c::FsRtlFreeLockTreeNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE VOID FsRtlFreeLockTreeNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>C</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00464">464</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00821">ExFreeToNPagedLookasideList()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00134">FsRtlLockTreeNodeLookasideList</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04343">FsRtlPrivateInsertSharedLock()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.
<p>
<pre class="fragment"><div>00467 {
00468     <a class="code" href="../../d5/d8/ex_8h.html#a249">ExFreeToNPagedLookasideList</a>( &amp;FsRtlLockTreeNodeLookasideList, (PVOID)C );
00469 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="filelock.c::FsRtlFreeSharedLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE VOID FsRtlFreeSharedLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>C</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00437">437</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00821">ExFreeToNPagedLookasideList()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00131">FsRtlSharedLockLookasideList</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.
<p>
<pre class="fragment"><div>00440 {
00441     <a class="code" href="../../d5/d8/ex_8h.html#a249">ExFreeToNPagedLookasideList</a>( &amp;FsRtlSharedLockLookasideList, (PVOID)C );
00442 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="filelock.c::FsRtlFreeWaitingLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE VOID FsRtlFreeWaitingLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__WAITING__LOCK.html">PWAITING_LOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>C</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00455">455</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00821">ExFreeToNPagedLookasideList()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00133">FsRtlWaitingLockLookasideList</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l05721">FsRtlPrivateCancelFileLockIrp()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">FsRtlPrivateCheckWaitingLocks()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.
<p>
<pre class="fragment"><div>00458 {
00459     <a class="code" href="../../d5/d8/ex_8h.html#a249">ExFreeToNPagedLookasideList</a>( &amp;FsRtlWaitingLockLookasideList, (PVOID)C );
00460 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="filelock.c::FsRtlGetNextFileLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a> FsRtlGetNextFileLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Restart</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01951">1951</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00576">_FILE_LOCK_INFO::EndingByte</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00562">_FILE_LOCK_INFO::ExclusiveLock</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00569">_FILE_LOCK_INFO::FileObject</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00481">FsRtlAcquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01687">FsRtlFindFirstOverlappingExclusiveNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01517">FsRtlFindFirstOverlappingSharedNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00568">_FILE_LOCK_INFO::Key</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00561">_FILE_LOCK_INFO::Length</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00089">_EX_LOCK::LockInfo</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00068">_SH_LOCK::LockInfo</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00008">_LOCKTREE_NODE::Locks</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a24">PEX_LOCK</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a20">PLOCKTREE_NODE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00570">_FILE_LOCK_INFO::ProcessId</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00759">RtlRealSuccessor()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00140">_LOCK_QUEUE::SharedLockTree</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00560">_FILE_LOCK_INFO::StartingByte</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01958                    :
01959 
01960     This routine enumerates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> individual <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> locks denoted by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock
01961     variable. It returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock information stored <span class="keywordflow">for</span> each lock.
01962     The caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> synchronizing call to <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> and <span class="keywordflow">for</span> not
01963     altering any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data returned by <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller does not
01964     synchronize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration will not be reliably complete.
01965 
01966     The way a programmer will use <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> to enumerate all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locks
01967     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> as follows:
01968 
01969     <span class="keywordflow">for</span> (p = <a class="code" href="../../d1/d8/fsrtl_8h.html#a121">FsRtlGetNextFileLock</a>( FileLock, TRUE );
01970          p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01971          p = <a class="code" href="../../d1/d8/fsrtl_8h.html#a121">FsRtlGetNextFileLock</a>( FileLock, FALSE )) {
01972 
01973             <span class="comment">// Process the lock information referenced by p</span>
01974     }
01975 
01976     Order <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> *not* guaranteed.
01977 
01978 Arguments:
01979 
01980     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> to enumerate.  The current
01981         enumeration state <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock variable so <span class="keywordflow">if</span> multiple
01982         threads are enumerating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same time <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> results will
01983         be unpredictable.
01984 
01985     Restart - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to start at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01986         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock tree or <span class="keywordflow">if</span> we are continuing from a previous call.
01987 
01988 Return Value:
01989 
01990     <a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a> - Either <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock
01991         record <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock or <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> there
01992         are not more locks.
01993 
01994 --*/
01995 
01996 {
01997     <a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">FILE_LOCK_INFO</a>      FileLockInfo;
01998     PVOID               ContinuationPointer;
01999     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>          LockInfo;
02000     <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>      Node;
02001     PSINGLE_LIST_ENTRY  Link;
02002     PRTL_SPLAY_LINKS    SplayLinks, LastSplayLinks;
02003     <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a>            ShLock;
02004     <a class="code" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a>            ExLock;
02005     BOOLEAN             FoundReturnable, <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>;
02006     KIRQL               OldIrql;
02007 
02008     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlGetNextFileLock, FileLock = %08lx\n"</span>, FileLock);
02009 
02010     <span class="keywordflow">if</span> ((LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02011         <span class="comment">//</span>
02012         <span class="comment">//  No lock information on this FileLock</span>
02013         <span class="comment">//</span>
02014 
02015         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02016     }
02017 
02018     FoundReturnable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02019 
02020     <span class="comment">//</span>
02021     <span class="comment">//  Before getting the spinlock, copy pagable info onto stack</span>
02022     <span class="comment">//</span>
02023 
02024     FileLockInfo = FileLock-&gt;LastReturnedLockInfo;
02025     ContinuationPointer = FileLock-&gt;LastReturnedLock;
02026 
02027     <a class="code" href="../../d5/d3/filelock_8c.html#a8">FsRtlAcquireLockQueue</a> (&amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>, &amp;OldIrql);
02028 
02029     <span class="keywordflow">if</span> (!Restart) {
02030         <span class="comment">//</span>
02031         <span class="comment">//  Given the last returned lock, find its current successor in the tree.</span>
02032         <span class="comment">//  Previous implementations would reset the enumeration if the last returned</span>
02033         <span class="comment">//  lock had been removed from the tree but I think we can be better in that</span>
02034         <span class="comment">//  case since every other structure modifying event (add new locks, delete</span>
02035         <span class="comment">//  other locks) would *not* have caused the reset. Possible minor performance</span>
02036         <span class="comment">//  enhancement.</span>
02037         <span class="comment">//</span>
02038 
02039         <span class="comment">//</span>
02040         <span class="comment">//  Find the node which could contain the last returned lock. We enumerate the</span>
02041         <span class="comment">//  exclusive lock tree, then the shared lock tree. Find the one we're enumerating.</span>
02042         <span class="comment">//</span>
02043 
02044         <span class="keywordflow">if</span> (FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o2">ExclusiveLock</a>) {
02045 
02046             <span class="comment">//</span>
02047             <span class="comment">//  Continue enumeration in the exclusive lock tree</span>
02048             <span class="comment">//</span>
02049 
02050             ExLock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02051 
02052             SplayLinks = <a class="code" href="../../d5/d3/filelock_8c.html#a44">FsRtlFindFirstOverlappingExclusiveNode</a>( LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>,
02053                                                                  &amp;FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>,
02054                                                                  &amp;FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>,
02055                                                                  &amp;LastSplayLinks,
02056                                                                  &amp;GreaterThan );
02057 
02058             <span class="keywordflow">if</span> (SplayLinks == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02059 
02060                 <span class="comment">//</span>
02061                 <span class="comment">//  No overlapping nodes were found, try to find successor</span>
02062                 <span class="comment">//</span>
02063 
02064                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) {
02065 
02066                     <span class="comment">//</span>
02067                     <span class="comment">//  Last node looked at was greater than the lock so it is</span>
02068                     <span class="comment">//  the place to pick up the enumeration</span>
02069                     <span class="comment">//</span>
02070 
02071                     SplayLinks = LastSplayLinks;
02072 
02073                 } <span class="keywordflow">else</span> {
02074 
02075                     <span class="comment">//</span>
02076                     <span class="comment">// Last node looked at was less than the lock so grab its successor</span>
02077                     <span class="comment">//</span>
02078 
02079                     <span class="keywordflow">if</span> (LastSplayLinks) {
02080 
02081                         SplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(LastSplayLinks);
02082                     }
02083                 }
02084 
02085             } <span class="keywordflow">else</span> {
02086 
02087                 <span class="comment">//</span>
02088                 <span class="comment">//  Found an overlapping lock, see if it is the last returned</span>
02089                 <span class="comment">//</span>
02090 
02091                 <span class="keywordflow">for</span> (;
02092                     SplayLinks;
02093                     SplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(SplayLinks)) {
02094 
02095                     ExLock = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links );
02096 
02097                     <span class="keywordflow">if</span> (ContinuationPointer == ExLock &amp;&amp;
02098                         (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart == (ULONGLONG)ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart &amp;&amp;
02099                         (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart == (ULONGLONG)ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart &amp;&amp;
02100                         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> == ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> &amp;&amp;
02101                         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> == ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> &amp;&amp;
02102                         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a> == ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a>) {
02103 
02104                         <span class="comment">//</span>
02105                         <span class="comment">//  Found last returned, dig up its successor</span>
02106                         <span class="comment">//</span>
02107 
02108                         SplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(SplayLinks);
02109 
02110                         <span class="comment">//</span>
02111                         <span class="comment">//  Got the node cold, so we're done</span>
02112                         <span class="comment">//</span>
02113 
02114                         <span class="keywordflow">break</span>;
02115                     }
02116 
02117                     <span class="comment">//</span>
02118                     <span class="comment">//  This lock overlapped and was not the last returned. In fact, since this lock would</span>
02119                     <span class="comment">//  have conflicted with the last returned we know it could not have been returned</span>
02120                     <span class="comment">//  before, so this should be returned to the caller.</span>
02121                     <span class="comment">//</span>
02122                     <span class="comment">//  However, if it is a zero length lock we are looking for and a zero length lock we hit,</span>
02123                     <span class="comment">//  we are at the beginning of a run we need to inspect. If we cannot find the last lock</span>
02124                     <span class="comment">//  we returned, resume the enumeration at the beginning of the run.</span>
02125                     <span class="comment">//</span>
02126 
02127                     <span class="keywordflow">if</span> (ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart != 0 || FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart != 0) {
02128 
02129                         <span class="keywordflow">break</span>;
02130                     }
02131 
02132                     <span class="comment">//</span>
02133                     <span class="comment">//  Keep wandering down the run</span>
02134                     <span class="comment">//</span>
02135                 }
02136             }
02137 
02138             <span class="comment">//</span>
02139             <span class="comment">//  Were we able to find a lock to return?</span>
02140             <span class="comment">//</span>
02141 
02142             <span class="keywordflow">if</span> (SplayLinks == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02143 
02144                 <span class="comment">//</span>
02145                 <span class="comment">//  There aren't any more exclusive locks, fall over to the shared tree</span>
02146                 <span class="comment">//</span>
02147 
02148                 SplayLinks = LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>;
02149 
02150                 <span class="keywordflow">if</span> (SplayLinks) {
02151 
02152                     <span class="keywordflow">while</span> (RtlLeftChild(SplayLinks)) {
02153 
02154                         SplayLinks = RtlLeftChild(SplayLinks);
02155                     }
02156 
02157                     Node = CONTAINING_RECORD(SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links);
02158                     ShLock = CONTAINING_RECORD(Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link);
02159 
02160                     FileLockInfo = ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>;
02161                     ContinuationPointer = ShLock;
02162                     FoundReturnable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02163                 }
02164 
02165             } <span class="keywordflow">else</span> {
02166 
02167                 <span class="comment">//</span>
02168                 <span class="comment">//  This is the lock to return</span>
02169                 <span class="comment">//</span>
02170 
02171                 ExLock = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links );
02172 
02173                 FileLockInfo = ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>;
02174                 ContinuationPointer = ExLock;
02175                 FoundReturnable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02176             }
02177 
02178         } <span class="keywordflow">else</span> {
02179 
02180             <span class="comment">//</span>
02181             <span class="comment">//  Continue enumeration in the shared lock tree</span>
02182             <span class="comment">//</span>
02183 
02184             Node = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02185 
02186             SplayLinks = <a class="code" href="../../d5/d3/filelock_8c.html#a43">FsRtlFindFirstOverlappingSharedNode</a>( LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>,
02187                                                               &amp;FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>,
02188                                                               &amp;FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>,
02189                                                               &amp;LastSplayLinks,
02190                                                               &amp;GreaterThan );
02191 
02192             <span class="keywordflow">if</span> (SplayLinks == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02193 
02194                 <span class="comment">//</span>
02195                 <span class="comment">//  No overlapping nodes were found</span>
02196                 <span class="comment">//</span>
02197 
02198                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) {
02199 
02200                     <span class="comment">//</span>
02201                     <span class="comment">//  Last node looked at was greater than the lock so it is</span>
02202                     <span class="comment">//  the place to pick up the enumeration</span>
02203                     <span class="comment">//</span>
02204 
02205                     <span class="keywordflow">if</span> (LastSplayLinks) {
02206 
02207                         SplayLinks = LastSplayLinks;
02208                         Node = CONTAINING_RECORD( LastSplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
02209                     }
02210 
02211                 } <span class="keywordflow">else</span> {
02212 
02213                     <span class="comment">//</span>
02214                     <span class="comment">// Last node looked at was less than the lock so grab its successor</span>
02215                     <span class="comment">//</span>
02216 
02217                     <span class="keywordflow">if</span> (LastSplayLinks) {
02218 
02219                         SplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(LastSplayLinks);
02220 
02221                         <span class="keywordflow">if</span> (SplayLinks) {
02222 
02223                             Node = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
02224                         }
02225                     }
02226                 }
02227 
02228             } <span class="keywordflow">else</span> {
02229 
02230                 <span class="comment">//</span>
02231                 <span class="comment">//  Grab the node we found</span>
02232                 <span class="comment">//</span>
02233 
02234                 Node = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
02235             }
02236 
02237             <span class="comment">//</span>
02238             <span class="comment">//  If we have a node to look at, it may still not contain the the last returned lock</span>
02239             <span class="comment">//  if this isn't synchronized.</span>
02240             <span class="comment">//</span>
02241 
02242             <span class="keywordflow">if</span> (Node != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02243 
02244                 <span class="comment">//</span>
02245                 <span class="comment">//    Walk down the locks at this node looking for the last returned lock</span>
02246                 <span class="comment">//</span>
02247 
02248                 <span class="keywordflow">for</span> (Link = Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next;
02249                      Link;
02250                      Link = Link-&gt;Next) {
02251 
02252                     <span class="comment">//</span>
02253                     <span class="comment">//  Get a pointer to the current lock record</span>
02254                     <span class="comment">//</span>
02255 
02256                     ShLock = CONTAINING_RECORD( Link, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
02257 
02258                     <span class="comment">//</span>
02259                     <span class="comment">// See if it's a match</span>
02260                     <span class="comment">//</span>
02261 
02262                     <span class="keywordflow">if</span> (ContinuationPointer == ShLock &amp;&amp;
02263                         (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart == (ULONGLONG)ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart &amp;&amp;
02264                         (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart == (ULONGLONG)ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart &amp;&amp;
02265                         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> == ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> &amp;&amp;
02266                         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> == ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> &amp;&amp;
02267                         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a> == ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a>) {
02268 
02269                         Link = Link-&gt;Next;
02270                         <span class="keywordflow">break</span>;
02271                     }
02272 
02273                     <span class="comment">//</span>
02274                     <span class="comment">// See if we passed by its slot</span>
02275                     <span class="comment">//</span>
02276 
02277                     <span class="keywordflow">if</span> ((ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart &lt; (ULONGLONG)ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart) {
02278 
02279                         <span class="keywordflow">break</span>;
02280                     }
02281                 }
02282 
02283                 <span class="keywordflow">if</span> (Link == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02284 
02285                     <span class="comment">//</span>
02286                     <span class="comment">//  This node doesn't contain the successor, so move</span>
02287                     <span class="comment">//  up to the successor node in the tree and return the</span>
02288                     <span class="comment">//  first lock. If we're actually at the end of the tree</span>
02289                     <span class="comment">//  we just fall off the end correctly.</span>
02290                     <span class="comment">//</span>
02291 
02292                     SplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(SplayLinks);
02293 
02294                     <span class="keywordflow">if</span> (SplayLinks) {
02295 
02296                         Node = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
02297 
02298                         Link = Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next;
02299                     }
02300                 }
02301 
02302                 <span class="keywordflow">if</span> (Link) {
02303 
02304                     <span class="comment">//</span>
02305                     <span class="comment">//  Found a Lock to return, copy it to the stack</span>
02306                     <span class="comment">//</span>
02307 
02308                     ShLock = CONTAINING_RECORD( Link, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
02309 
02310                     FileLockInfo = ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>;
02311                     ContinuationPointer = ShLock;
02312                     FoundReturnable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02313                 }
02314 
02315             }
02316         }
02317 
02318     } <span class="keywordflow">else</span> {
02319 
02320         <span class="comment">//</span>
02321         <span class="comment">//  Restarting the enumeration. Find leftmost node in the exclusive tree and hand back</span>
02322         <span class="comment">//  the first lock, falling over to the shared if no exlcusive locks are applied</span>
02323         <span class="comment">//</span>
02324 
02325         <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>) {
02326 
02327             SplayLinks = LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>;
02328 
02329             <span class="keywordflow">while</span> (RtlLeftChild(SplayLinks) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02330 
02331                 SplayLinks = RtlLeftChild(SplayLinks);
02332             }
02333 
02334             ExLock = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links );
02335 
02336             FileLockInfo = ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>;
02337             ContinuationPointer = ExLock;
02338             FoundReturnable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02339 
02340         } <span class="keywordflow">else</span> {
02341 
02342             <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>) {
02343 
02344                 SplayLinks = LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>;
02345 
02346                 <span class="keywordflow">while</span> (RtlLeftChild(SplayLinks) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02347 
02348                     SplayLinks = RtlLeftChild(SplayLinks);
02349                 }
02350 
02351                 Node = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
02352                 ShLock = CONTAINING_RECORD( Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
02353 
02354                 FileLockInfo = ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>;
02355                 ContinuationPointer = ShLock;
02356                 FoundReturnable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02357             }
02358         }
02359     }
02360 
02361     <span class="comment">//</span>
02362     <span class="comment">//  Release all the lock queues</span>
02363     <span class="comment">//</span>
02364 
02365     <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a> (&amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>, OldIrql);
02366 
02367     <span class="keywordflow">if</span> (!FoundReturnable) {
02368 
02369         <span class="comment">//</span>
02370         <span class="comment">//  No returnable lock was found, end of list</span>
02371         <span class="comment">//</span>
02372 
02373         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02374     }
02375 
02376     <span class="comment">//</span>
02377     <span class="comment">// Update current enum location information</span>
02378     <span class="comment">//</span>
02379 
02380     FileLock-&gt;LastReturnedLockInfo = FileLockInfo;
02381     FileLock-&gt;LastReturnedLock = ContinuationPointer;
02382 
02383     <span class="comment">//</span>
02384     <span class="comment">// Return lock record to caller</span>
02385     <span class="comment">//</span>
02386 
02387     <span class="keywordflow">return</span> &amp;FileLock-&gt;LastReturnedLockInfo;
02388 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="filelock.c::FsRtlInitializeFileLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlInitializeFileLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a65">PCOMPLETE_LOCK_IRP_ROUTINE</a> CompleteLockIrpRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a66">PUNLOCK_ROUTINE</a> UnlockRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00829">829</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00596">PUNLOCK_ROUTINE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01141">FsRtlAllocateFileLock()</a>.
<p>
<pre class="fragment"><div>00837                    :
00838 
00839     This routine initializes a <span class="keyword">new</span> <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a> structure.  The caller must
00840     supply <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure.  This call must precede all other
00841     calls that utilize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a> variable.
00842 
00843 Arguments:
00844 
00845     FileLock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a> structure to
00846         initialize.
00847 
00848     CompleteLockIrpRoutine - Optionally supplies an alternate routine to
00849         call <span class="keywordflow">for</span> completing IRPs.  <a class="code" href="../../d5/d3/filelock_8c.html#a66">FsRtlProcessFileLock</a> by <span class="keywordflow">default</span> will
00850         call <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a> to finish up an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>; however <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00851         want to process <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion itself then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> needs to specify
00852         a completion routine here.  This routine will then be called in
00853         place of <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>.
00854 
00855     UnlockRoutine - Optionally supplies a routine to call when removing
00856         a lock.
00857 
00858 Return Value:
00859 
00860     None.
00861 
00862 --*/
00863 
00864 {
00865     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlInitializeFileLock, FileLock = %08lx\n"</span>, FileLock);
00866 
00867     <span class="comment">//</span>
00868     <span class="comment">// Clear non-paged pool pointer</span>
00869     <span class="comment">//</span>
00870 
00871     FileLock-&gt;LockInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00872     FileLock-&gt;CompleteLockIrpRoutine = CompleteLockIrpRoutine;
00873     FileLock-&gt;UnlockRoutine = UnlockRoutine;
00874 
00875     FileLock-&gt;FastIoIsQuestionable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00876 
00877     <span class="comment">//</span>
00878     <span class="comment">//  and return to our caller</span>
00879     <span class="comment">//</span>
00880 
00881     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlInitializeFileLock -&gt; VOID\n"</span>, 0 );
00882 
00883     <span class="keywordflow">return</span>;
00884 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="filelock.c::FsRtlInitializeFileLocks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlInitializeFileLocks           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">744</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d0/d5/ex_2lookasid_8c-source.html#l00408">ExInitializeNPagedLookasideList()</a>, <a class="el" href="../../d0/d5/ex_2lookasid_8c-source.html#l00543">ExInitializePagedLookasideList()</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a67">FILE_LOCK</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00119">FsRtlCreateLockInfo</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00132">FsRtlExclusiveLockLookasideList</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00137">FsRtlFileLockLookasideList</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00135">FsRtlLockInfoLookasideList</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00134">FsRtlLockTreeNodeLookasideList</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00131">FsRtlSharedLockLookasideList</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00133">FsRtlWaitingLockLookasideList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00104">TAG_EXCLUSIVE_LOCK</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00105">TAG_FILE_LOCK</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00106">TAG_LOCK_INFO</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00107">TAG_LOCKTREE_NODE</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00108">TAG_SHARED_LOCK</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00109">TAG_WAITING_LOCK</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html#l00215">FsRtlInitSystem()</a>.
<p>
<pre class="fragment"><div>00749                    :
00750 
00751     Initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> global portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filelock package.
00752 
00753 Arguments:
00754 
00755     None
00756 
00757 Return Value:
00758 
00759     None.
00760 
00761 --*/
00762 {
00763 <span class="preprocessor">#ifndef USERTEST</span>
00764 <span class="preprocessor"></span>
00765     <span class="comment">//</span>
00766     <span class="comment">//  Build the lookaside lists for our internal structures.</span>
00767     <span class="comment">//</span>
00768 
00769     <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;FsRtlSharedLockLookasideList,
00770                                      NULL,
00771                                      NULL,
00772                                      0,
00773                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>),
00774                                      TAG_SHARED_LOCK,
00775                                      16 );
00776 
00777     <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;FsRtlExclusiveLockLookasideList,
00778                                      NULL,
00779                                      NULL,
00780                                      0,
00781                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>),
00782                                      TAG_EXCLUSIVE_LOCK,
00783                                      16 );
00784 
00785     <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;FsRtlWaitingLockLookasideList,
00786                                      NULL,
00787                                      NULL,
00788                                      0,
00789                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html">WAITING_LOCK</a>),
00790                                      TAG_WAITING_LOCK,
00791                                      16 );
00792 
00793     <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;FsRtlLockTreeNodeLookasideList,
00794                                      NULL,
00795                                      NULL,
00796                                      0,
00797                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>),
00798                                      TAG_LOCKTREE_NODE,
00799                                      16 );
00800 
00801     <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;FsRtlLockInfoLookasideList,
00802                                      NULL,
00803                                      NULL,
00804                                      0,
00805                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">LOCK_INFO</a>),
00806                                      TAG_LOCK_INFO,
00807                                      8 );
00808 
00809     <a class="code" href="../../d5/d8/ex_8h.html#a250">ExInitializePagedLookasideList</a>( &amp;FsRtlFileLockLookasideList,
00810                                     NULL,
00811                                     NULL,
00812                                     0,
00813                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a>),
00814                                     TAG_FILE_LOCK,
00815                                     8 );
00816 
00817     <span class="comment">//</span>
00818     <span class="comment">//  Initialize the LockInfo creation mutex</span>
00819     <span class="comment">//</span>
00820 
00821     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;FsRtlCreateLockInfo);
00822 
00823 
00824 <span class="preprocessor">#endif</span>
00825 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="filelock.c::FsRtlPrivateCancelFileLockIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlPrivateCancelFileLockIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l05721">5721</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00112">_WAITING_LOCK::Context</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00497">FsRtlCompleteLockIrp</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00455">FsRtlFreeWaitingLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00484">FsRtlReacquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00118">_WAITING_LOCK::Irp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a28">PLOCK_QUEUE</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a26">PWAITING_LOCK</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00142">_LOCK_QUEUE::WaitingLocks</a>, and <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00143">_LOCK_QUEUE::WaitingLocksTail</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>.
<p>
<pre class="fragment"><div>05728                    :
05729 
05730     This routine implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cancel function <span class="keywordflow">for</span> an irp saved in a
05731     waiting lock queue
05732 
05733 Arguments:
05734 
05735     DeviceObject - Ignored
05736 
05737     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> being cancelled.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileLock
05738         structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05739         irp's iosb.
05740 
05741 Return Value:
05742 
05743     none.
05744 
05745 --*/
05746 
05747 {
05748     PSINGLE_LIST_ENTRY *pLink, Link;
05749     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>  LockInfo;
05750     <a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a> LockQueue;
05751     KIRQL       OldIrql;
05752     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    NewStatus;
05753 
05754 
05755     UNREFERENCED_PARAMETER( DeviceObject );
05756 
05757     <span class="comment">//</span>
05758     <span class="comment">//  The information field is used to store a pointer to the file lock</span>
05759     <span class="comment">//  containing the irp</span>
05760     <span class="comment">//</span>
05761 
05762     LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information);
05763 
05764     <span class="comment">//</span>
05765     <span class="comment">// Iterate through the lock queue.</span>
05766     <span class="comment">//</span>
05767 
05768     LockQueue = &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>;
05769 
05770     <span class="comment">//</span>
05771     <span class="comment">// Release the cancel spinlock and lock the waiting queue if this</span>
05772     <span class="comment">// is initiated by Io. We already have the lock queue if this is</span>
05773     <span class="comment">// the race fixup.</span>
05774     <span class="comment">//</span>
05775     <span class="comment">// If this is from ourselves, we have the cancel Irql in the Irp.</span>
05776     <span class="comment">//</span>
05777 
05778     <span class="keywordflow">if</span> (DeviceObject) {
05779         
05780         <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
05781         <a class="code" href="../../d5/d3/filelock_8c.html#a9">FsRtlReacquireLockQueue</a>(LockInfo, LockQueue, &amp;OldIrql);
05782     
05783     } <span class="keywordflow">else</span> {
05784 
05785         OldIrql = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a>;
05786     }
05787 
05788     <span class="comment">//</span>
05789     <span class="comment">// Iterate through all of the waiting locks looking for a canceled one.</span>
05790     
05791     pLink = &amp;LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o3">WaitingLocks</a>.Next;
05792     <span class="keywordflow">while</span> ((Link = *pLink) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05793 
05794         <a class="code" href="../../d1/d8/struct__WAITING__LOCK.html">PWAITING_LOCK</a> WaitingLock;
05795 
05796         <span class="comment">//</span>
05797         <span class="comment">//  Get a pointer to the waiting lock record</span>
05798         <span class="comment">//</span>
05799 
05800         WaitingLock = CONTAINING_RECORD( Link, <a class="code" href="../../d1/d8/struct__WAITING__LOCK.html">WAITING_LOCK</a>, Link );
05801 
05802         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlPrivateCancelFileLockIrp, Loop top, WaitingLock = %08lx\n"</span>, WaitingLock);
05803 
05804         <span class="keywordflow">if</span>( WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o2">Irp</a> != <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> ) {
05805 
05806             pLink = &amp;Link-&gt;Next;
05807             <span class="keywordflow">continue</span>;
05808         }
05809 
05810         <span class="comment">//</span>
05811         <span class="comment">//  We've found it -- remove it from the list</span>
05812         <span class="comment">//</span>
05813 
05814         *pLink = Link-&gt;Next;
05815         <span class="keywordflow">if</span> (Link == LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o4">WaitingLocksTail</a>.Next) {
05816 
05817             LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o4">WaitingLocksTail</a>.Next = (PSINGLE_LIST_ENTRY) pLink;
05818         }
05819 
05820         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
05821 
05822         <span class="comment">//</span>
05823         <span class="comment">// Release LockQueue and complete this waiter</span>
05824         <span class="comment">//</span>
05825 
05826         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
05827 
05828         <span class="comment">//</span>
05829         <span class="comment">// Complete this waiter</span>
05830         <span class="comment">//</span>
05831 
05832         <a class="code" href="../../d5/d3/filelock_8c.html#a11">FsRtlCompleteLockIrp</a>( LockInfo,
05833                               WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o1">Context</a>,
05834                               Irp,
05835                               STATUS_CANCELLED,
05836                               &amp;NewStatus,
05837                               NULL );
05838 
05839         <span class="comment">//</span>
05840         <span class="comment">//  Free up pool</span>
05841         <span class="comment">//</span>
05842 
05843         <a class="code" href="../../d5/d3/filelock_8c.html#a38">FsRtlFreeWaitingLock</a>( WaitingLock );
05844 
05845         <span class="comment">//</span>
05846         <span class="comment">// Our job is done!</span>
05847         <span class="comment">//</span>
05848 
05849         <span class="keywordflow">return</span>;
05850     }
05851 
05852     <span class="comment">//</span>
05853     <span class="comment">// Release lock queue</span>
05854     <span class="comment">//</span>
05855 
05856     <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
05857 
05858     <span class="keywordflow">return</span>;
05859 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="filelock.c::FsRtlPrivateCheckForExclusiveLockAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlPrivateCheckForExclusiveLockAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LockInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLockInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l04934">4934</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01856">FsRtlFindFirstOverlapInNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01687">FsRtlFindFirstOverlappingExclusiveNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01517">FsRtlFindFirstOverlappingSharedNode()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00021">_LOCKTREE_NODE::HoleyNode</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00561">_FILE_LOCK_INFO::Length</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00089">_EX_LOCK::LockInfo</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00068">_SH_LOCK::LockInfo</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00008">_LOCKTREE_NODE::Locks</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a24">PEX_LOCK</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a20">PLOCKTREE_NODE</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00051">RtlSplay()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">FsRtlPrivateCheckWaitingLocks()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>.
<p>
<pre class="fragment"><div>04940                    :
04941 
04942     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller can get an exclusive lock on
04943     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated range due to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> locks in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed in lock queue.
04944 
04945     Assumes <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> queue <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held by caller
04946 
04947 Arguments:
04948 
04949     LockQueue - Queue which needs to be checked <span class="keywordflow">for</span> collision
04950 
04951     FileLockInfo - <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being checked
04952 
04953 
04954 Return Value:
04955 
04956     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated user can place <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exclusive lock over <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04957         entire specified byte range, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
04958 
04959 --*/
04960 
04961 {
04962     PRTL_SPLAY_LINKS SplayLinks, LastSplayLinks = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04963     <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a> Node;
04964     <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a> ShLock;
04965     <a class="code" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a> ExLock;
04966 
04967     <span class="keywordflow">if</span> (LockQueue-&gt;SharedLockTree &amp;&amp;
04968         (SplayLinks = <a class="code" href="../../d5/d3/filelock_8c.html#a43">FsRtlFindFirstOverlappingSharedNode</a>( LockQueue-&gt;SharedLockTree,
04969                                                            &amp;FileLockInfo-&gt;StartingByte,
04970                                                            &amp;FileLockInfo-&gt;EndingByte,
04971                                                            &amp;LastSplayLinks, NULL))) {
04972 
04973         Node = CONTAINING_RECORD(SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links);
04974 
04975         <span class="comment">//</span>
04976         <span class="comment">//  If this node is holey, we'll have to walk the whole thing.</span>
04977         <span class="comment">//</span>
04978 
04979         <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o1">HoleyNode</a>) {
04980 
04981             ShLock = <a class="code" href="../../d5/d3/filelock_8c.html#a45">FsRtlFindFirstOverlapInNode</a>( Node,
04982                                                   &amp;FileLockInfo-&gt;StartingByte,
04983                                                   &amp;FileLockInfo-&gt;EndingByte );
04984 
04985         } <span class="keywordflow">else</span> {
04986 
04987             ShLock = CONTAINING_RECORD(Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link);
04988         }
04989 
04990         <span class="comment">//</span>
04991         <span class="comment">//  Look for overlap that we care about.  Perhaps no overlap existed in the holey case.</span>
04992         <span class="comment">//</span>
04993 
04994         <span class="keywordflow">if</span> (ShLock &amp;&amp;
04995             (FileLockInfo-&gt;Length.QuadPart || ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart)) {
04996 
04997             <span class="comment">//</span>
04998             <span class="comment">//  If we are checking a nonzero extent and overlapped, it is fatal. If we</span>
04999             <span class="comment">//  are checking a zero extent and overlapped a nonzero extent, it is fatal.</span>
05000             <span class="comment">//</span>
05001 
05002             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05003         }
05004     }
05005 
05006     <span class="keywordflow">if</span> (LastSplayLinks) {
05007 
05008         LockQueue-&gt;SharedLockTree = <a class="code" href="../../d3/d4/splay_8c.html#a3">RtlSplay</a>(LastSplayLinks);
05009         LastSplayLinks = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05010     }
05011 
05012     <span class="keywordflow">if</span> (LockQueue-&gt;ExclusiveLockTree &amp;&amp;
05013         (SplayLinks = <a class="code" href="../../d5/d3/filelock_8c.html#a44">FsRtlFindFirstOverlappingExclusiveNode</a>( LockQueue-&gt;ExclusiveLockTree,
05014                                                               &amp;FileLockInfo-&gt;StartingByte,
05015                                                               &amp;FileLockInfo-&gt;EndingByte,
05016                                                               &amp;LastSplayLinks, NULL))) {
05017 
05018         ExLock = CONTAINING_RECORD(SplayLinks, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links);
05019 
05020         <span class="keywordflow">if</span> (FileLockInfo-&gt;Length.QuadPart || ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart) {
05021 
05022             <span class="comment">//</span>
05023             <span class="comment">//  If we are checking a nonzero extent and overlapped, it is fatal. If we</span>
05024             <span class="comment">//  are checking a zero extent and overlapped a nonzero extent, it is fatal.</span>
05025             <span class="comment">//</span>
05026 
05027             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05028         }
05029     }
05030 
05031     <span class="keywordflow">if</span> (LastSplayLinks) {
05032 
05033         LockQueue-&gt;ExclusiveLockTree = <a class="code" href="../../d3/d4/splay_8c.html#a3">RtlSplay</a>(LastSplayLinks);
05034     }
05035 
05036     <span class="comment">//</span>
05037     <span class="comment">//  We searched the entire range without a conflict so we can grant</span>
05038     <span class="comment">//  the exclusive lock</span>
05039     <span class="comment">//</span>
05040 
05041     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05042 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="filelock.c::FsRtlPrivateCheckForSharedLockAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlPrivateCheckForSharedLockAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LockInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLockInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l05046">5046</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01687">FsRtlFindFirstOverlappingExclusiveNode()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a24">PEX_LOCK</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00759">RtlRealSuccessor()</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00051">RtlSplay()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">FsRtlPrivateCheckWaitingLocks()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>.
<p>
<pre class="fragment"><div>05052                    :
05053 
05054     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller can get a shared lock on
05055     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated range due to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> locks in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed in lock queue.
05056 
05057     Assumes <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> queue <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held by caller
05058 
05059 Arguments:
05060 
05061     LockQueue - Queue which needs to be checked <span class="keywordflow">for</span> collision
05062 
05063     FileLockInfo - <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being checked
05064 
05065 Arguments:
05066 
05067 Return Value:
05068 
05069     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated user can place <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> shared lock over
05070         entire specified byte range, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
05071 
05072 --*/
05073 
05074 {
05075     <a class="code" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
05076     PRTL_SPLAY_LINKS SplayLinks, LastSplayLinks;
05077     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05078 
05079     <span class="comment">//</span>
05080     <span class="comment">// If there are no exclusive locks, this is quick ...</span>
05081     <span class="comment">//</span>
05082 
05083     <span class="keywordflow">if</span> (LockQueue-&gt;ExclusiveLockTree == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05084 
05085         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05086     }
05087 
05088     <span class="comment">//</span>
05089     <span class="comment">//  No lock in the shared lock tree can prevent access, so just search the exclusive</span>
05090     <span class="comment">//  tree for conflict.</span>
05091     <span class="comment">//</span>
05092 
05093     <span class="keywordflow">for</span> (SplayLinks = <a class="code" href="../../d5/d3/filelock_8c.html#a44">FsRtlFindFirstOverlappingExclusiveNode</a>( LockQueue-&gt;ExclusiveLockTree,
05094                                                               &amp;FileLockInfo-&gt;StartingByte,
05095                                                               &amp;FileLockInfo-&gt;EndingByte,
05096                                                               &amp;LastSplayLinks, NULL);
05097          SplayLinks;
05098          SplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(SplayLinks)) {
05099 
05100         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links );
05101 
05102         <span class="keywordflow">if</span> ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart &gt; (ULONGLONG)FileLockInfo-&gt;EndingByte.QuadPart) {
05103 
05104             <span class="comment">//</span>
05105             <span class="comment">//  This node is covering a range greater than the range we care about,</span>
05106             <span class="comment">//  so we're done</span>
05107             <span class="comment">//</span>
05108 
05109             <span class="keywordflow">break</span>;
05110         }
05111 
05112         <span class="comment">//</span>
05113         <span class="comment">//  We may not be able to grant the request if the fileobject, processid,</span>
05114         <span class="comment">//  and key do not match.</span>
05115         <span class="comment">//</span>
05116 
05117         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.FileObject != FileLockInfo-&gt;FileObject) ||
05118              (<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.ProcessId != FileLockInfo-&gt;ProcessId) ||
05119              (<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.Key != FileLockInfo-&gt;Key)) {
05120 
05121             <span class="comment">//</span>
05122             <span class="comment">//  We have a mismatch between caller and owner. It is ok not to conflict</span>
05123             <span class="comment">//  if the caller and owner will have/have zero length locks (zero length</span>
05124             <span class="comment">//  locks cannot conflict).</span>
05125             <span class="comment">//</span>
05126 
05127             <span class="keywordflow">if</span> (FileLockInfo-&gt;Length.QuadPart || <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.Length.QuadPart) {
05128 
05129                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05130                 <span class="keywordflow">break</span>;
05131             }
05132         }
05133     }
05134 
05135     <span class="keywordflow">if</span> (LastSplayLinks) {
05136 
05137         LockQueue-&gt;ExclusiveLockTree = <a class="code" href="../../d3/d4/splay_8c.html#a3">RtlSplay</a>(LastSplayLinks);
05138     }
05139 
05140     <span class="comment">//</span>
05141     <span class="comment">//  We searched the entire range without a conflict so we can grant</span>
05142     <span class="comment">//  the shared lock</span>
05143     <span class="comment">//</span>
05144 
05145     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05146 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="filelock.c::FsRtlPrivateCheckWaitingLocks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlPrivateCheckWaitingLocks           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LockInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LockQueue</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KIRQL&nbsp;</td>
          <td class="mdname" nowrap> <em>OldIrql</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">4722</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00501">BooleanFlagOn</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00112">_WAITING_LOCK::Context</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00576">_FILE_LOCK_INFO::EndingByte</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00562">_FILE_LOCK_INFO::ExclusiveLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00569">_FILE_LOCK_INFO::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02030">_IO_STACK_LOCATION::Flags</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00497">FsRtlCompleteLockIrp</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00455">FsRtlFreeWaitingLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04934">FsRtlPrivateCheckForExclusiveLockAccess()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05046">FsRtlPrivateCheckForSharedLockAccess()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04253">FsRtlPrivateInsertLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03162">FsRtlPrivateRemoveLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00484">FsRtlReacquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07374">IoGetRequestorProcess()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00118">_WAITING_LOCK::Irp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00568">_FILE_LOCK_INFO::Key</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00561">_FILE_LOCK_INFO::Length</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00570">_FILE_LOCK_INFO::ProcessId</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a26">PWAITING_LOCK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01890">SL_EXCLUSIVE_LOCK</a>, and <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00560">_FILE_LOCK_INFO::StartingByte</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l03589">FsRtlFastUnlockSingleExclusive()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>.
<p>
<pre class="fragment"><div>04730                    :
04731 
04732     This routine checks to see <span class="keywordflow">if</span> any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current waiting locks are now
04733     be satisfied, and <span class="keywordflow">if</span> so <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> completes their IRPs.
04734 
04735 Arguments:
04736 
04737     LockInfo - LockInfo which LockQueue <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> member of
04738 
04739     LockQueue - Supplies queue which needs to be checked
04740 
04741     OldIrql - Irql to restore when LockQueue <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> released
04742 
04743 Return Value:
04744 
04745     None.
04746 
04747 --*/
04748 
04749 {
04750     PSINGLE_LIST_ENTRY *pLink, Link;
04751     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NewStatus;
04752     BOOLEAN Result;
04753 
04754     pLink = &amp;LockQueue-&gt;WaitingLocks.Next;
04755     <span class="keywordflow">while</span> ((Link = *pLink) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04756 
04757         <a class="code" href="../../d1/d8/struct__WAITING__LOCK.html">PWAITING_LOCK</a> WaitingLock;
04758 
04759         <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
04760         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
04761 
04762         BOOLEAN AccessGranted;
04763 
04764         <a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">FILE_LOCK_INFO</a> FileLockInfo;
04765 
04766         <span class="comment">//</span>
04767         <span class="comment">//  Get a pointer to the waiting lock record</span>
04768         <span class="comment">//</span>
04769 
04770         WaitingLock = CONTAINING_RECORD( Link, <a class="code" href="../../d1/d8/struct__WAITING__LOCK.html">WAITING_LOCK</a>, Link );
04771 
04772         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlCheckWaitingLocks, Loop top, WaitingLock = %08lx\n"</span>, WaitingLock);
04773 
04774         <span class="comment">//</span>
04775         <span class="comment">//  Get a local copy of the necessary fields we'll need to use</span>
04776         <span class="comment">//</span>
04777 
04778         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o2">Irp</a>;
04779         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
04780 
04781         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>  = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.ByteOffset;
04782         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>        = *IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.Length;
04783         (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>.QuadPart =
04784             (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart + (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart - 1;
04785 
04786         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a>    = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>;
04787         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a>     = <a class="code" href="../../d4/d6/iosubs_8c.html#a78">IoGetRequestorProcess</a>( Irp );
04788         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a>           = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.Key;
04789         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o2">ExclusiveLock</a> = <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>(IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a>, SL_EXCLUSIVE_LOCK);
04790 
04791         <span class="comment">//</span>
04792         <span class="comment">//  Now case on whether we're trying to take out an exclusive lock or</span>
04793         <span class="comment">//  a shared lock.  And in both cases try to get the appropriate access</span>
04794         <span class="comment">//  For the exclusive case we send in a NULL file object and process</span>
04795         <span class="comment">//  id, this will ensure that the lookup does not give us write</span>
04796         <span class="comment">//  access through an exclusive lock.</span>
04797         <span class="comment">//</span>
04798 
04799         <span class="keywordflow">if</span> (FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o2">ExclusiveLock</a>) {
04800 
04801             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlCheckWaitingLocks do we have write access?\n"</span>, 0);
04802 
04803             AccessGranted = <a class="code" href="../../d5/d3/filelock_8c.html#a51">FsRtlPrivateCheckForExclusiveLockAccess</a>(
04804                                 LockQueue,
04805                                 &amp;FileLockInfo );
04806         } <span class="keywordflow">else</span> {
04807 
04808             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlCheckWaitingLocks do we have read access?\n"</span>, 0);
04809 
04810             AccessGranted = <a class="code" href="../../d5/d3/filelock_8c.html#a52">FsRtlPrivateCheckForSharedLockAccess</a>(
04811                                 LockQueue,
04812                                 &amp;FileLockInfo );
04813 
04814         }
04815 
04816         <span class="comment">//</span>
04817         <span class="comment">//  Now AccessGranted tells us whether we can really get the access for</span>
04818         <span class="comment">//  the range we want.</span>
04819         <span class="comment">//</span>
04820         <span class="comment">//  No matter what happens, this Irp must be completed now - even if we</span>
04821         <span class="comment">//  are resource starved.  User mode deadlock could be induced since there</span>
04822         <span class="comment">//  may no longer be a pending unlock to cause a rescan of the waiting</span>
04823         <span class="comment">//  list.</span>
04824         <span class="comment">//</span>
04825 
04826         <span class="keywordflow">if</span> (AccessGranted) {
04827 
04828             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlCheckWaitingLocks now has access\n"</span>, 0);
04829 
04830             <span class="comment">//</span>
04831             <span class="comment">//  Clear the cancel routine</span>
04832             <span class="comment">//</span>
04833 
04834             <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, NULL );
04835 
04836             Result = <a class="code" href="../../d5/d3/filelock_8c.html#a46">FsRtlPrivateInsertLock</a>( LockInfo, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;FileLockInfo );
04837 
04838             <span class="comment">//</span>
04839             <span class="comment">//  Now we need to remove this granted waiter and complete</span>
04840             <span class="comment">//  it's irp.</span>
04841             <span class="comment">//</span>
04842 
04843             *pLink = Link-&gt;Next;
04844             <span class="keywordflow">if</span> (Link == LockQueue-&gt;WaitingLocksTail.Next) {
04845                 LockQueue-&gt;WaitingLocksTail.Next = (PSINGLE_LIST_ENTRY) pLink;
04846             }
04847 
04848             <span class="comment">//</span>
04849             <span class="comment">// Release LockQueue and complete this waiter</span>
04850             <span class="comment">//</span>
04851 
04852             <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
04853 
04854             <span class="comment">//</span>
04855             <span class="comment">//  Reference the fileobject over the completion attempt so we can have a</span>
04856             <span class="comment">//  chance to cleanup safely if we fail</span>
04857             <span class="comment">//</span>
04858 
04859             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> );
04860 
04861             <span class="comment">//</span>
04862             <span class="comment">//  Now we can complete the IRP, if we don't get back success</span>
04863             <span class="comment">//  from the completion routine then we remove the lock we just</span>
04864             <span class="comment">//  inserted.</span>
04865             <span class="comment">//</span>
04866 
04867             <a class="code" href="../../d5/d3/filelock_8c.html#a11">FsRtlCompleteLockIrp</a>( LockInfo,
04868                                   WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o1">Context</a>,
04869                                   Irp,
04870                                   (Result? STATUS_SUCCESS : STATUS_INSUFFICIENT_RESOURCES),
04871                                   &amp;NewStatus,
04872                                   FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> );
04873 
04874             <span class="keywordflow">if</span> (Result &amp;&amp; !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NewStatus)) {
04875 
04876                 <span class="comment">//</span>
04877                 <span class="comment">// Irp was not sucessfull, remove lock if it was added.</span>
04878                 <span class="comment">//</span>
04879 
04880                 <a class="code" href="../../d5/d3/filelock_8c.html#a55">FsRtlPrivateRemoveLock</a> (
04881                     LockInfo,
04882                     &amp;FileLockInfo,
04883                     FALSE );
04884             }
04885 
04886             <span class="comment">//</span>
04887             <span class="comment">//  Drop our private reference to the fileobject</span>
04888             <span class="comment">//</span>
04889 
04890             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> );
04891 
04892             <span class="comment">//</span>
04893             <span class="comment">// Re-acquire queue lock</span>
04894             <span class="comment">//</span>
04895 
04896             <a class="code" href="../../d5/d3/filelock_8c.html#a9">FsRtlReacquireLockQueue</a>(LockInfo, LockQueue, &amp;OldIrql);
04897 
04898             <span class="comment">//</span>
04899             <span class="comment">// Start scan over from begining</span>
04900             <span class="comment">//</span>
04901 
04902             pLink = &amp;LockQueue-&gt;WaitingLocks.Next;
04903 
04904 
04905             <span class="comment">//</span>
04906             <span class="comment">//  Free up pool</span>
04907             <span class="comment">//</span>
04908 
04909             <a class="code" href="../../d5/d3/filelock_8c.html#a38">FsRtlFreeWaitingLock</a>( WaitingLock );
04910 
04911 
04912         } <span class="keywordflow">else</span> {
04913 
04914             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"FsRtlCheckWaitingLocks still no access\n"</span>, 0);
04915 
04916             <span class="comment">//</span>
04917             <span class="comment">// Move to next lock</span>
04918             <span class="comment">//</span>
04919 
04920             pLink = &amp;Link-&gt;Next;
04921         }
04922 
04923     }
04924 
04925     <span class="comment">//</span>
04926     <span class="comment">//  And return to our caller</span>
04927     <span class="comment">//</span>
04928 
04929     <span class="keywordflow">return</span>;
04930 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="filelock.c::FsRtlPrivateFastUnlockAll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlPrivateFastUnlockAll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MatchKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">5254</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00112">_WAITING_LOCK::Context</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00576">_FILE_LOCK_INFO::EndingByte</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00569">_FILE_LOCK_INFO::FileObject</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00497">FsRtlCompleteLockIrp</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00446">FsRtlFreeExclusiveLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00464">FsRtlFreeLockTreeNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00437">FsRtlFreeSharedLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00455">FsRtlFreeWaitingLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">FsRtlPrivateCheckWaitingLocks()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05150">FsRtlPrivateResetLowestLockOffset()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00484">FsRtlReacquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02865">FsRtlSplitLocks()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07374">IoGetRequestorProcess()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00118">_WAITING_LOCK::Irp</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00568">_FILE_LOCK_INFO::Key</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00083">_EX_LOCK::Links</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00089">_EX_LOCK::LockInfo</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00068">_SH_LOCK::LockInfo</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00008">_LOCKTREE_NODE::Locks</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a24">PEX_LOCK</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a28">PLOCK_QUEUE</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a20">PLOCKTREE_NODE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00570">_FILE_LOCK_INFO::ProcessId</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a26">PWAITING_LOCK</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00385">RtlDelete()</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00759">RtlRealSuccessor()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00140">_LOCK_QUEUE::SharedLockTree</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00042">_LOCKTREE_NODE::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00178">_LOCK_INFO::UnlockRoutine</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00142">_LOCK_QUEUE::WaitingLocks</a>, and <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00143">_LOCK_QUEUE::WaitingLocksTail</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l03770">FsRtlFastUnlockAll()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l03814">FsRtlFastUnlockAllByKey()</a>.
<p>
<pre class="fragment"><div>05265                    :
05266 
05267     This routine performs an <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> all operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current locks
05268     associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock.  Only those locks with
05269     a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object and process <span class="keywordtype">id</span> are freed.  Additionally,
05270     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> possible to free <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> those locks which also match a given
05271     key.
05272 
05273 Arguments:
05274 
05275     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock being freed.
05276 
05277     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock
05278 
05279     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Process Id assoicated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locks to be
05280         freed
05281 
05282     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> to use in <span class="keyword">this</span> operation
05283 
05284     MatchKey - Whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> must also match <span class="keywordflow">for</span> lock to be freed.
05285 
05286     Context - Supplies an optional context to use when completing waiting
05287         lock irps.
05288 
05289 Return Value:
05290 
05291     None
05292 
05293 --*/
05294 
05295 {
05296     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>              LockInfo;
05297     <a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>             LockQueue;
05298     PSINGLE_LIST_ENTRY      *pLink, *SavepLink, Link;
05299     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                NewStatus;
05300     KIRQL                   OldIrql;
05301     LARGE_INTEGER           MaxOffset, SaveEndingByte;
05302     BOOLEAN                 UnlockRoutine;
05303     <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a>                ShLock;
05304     <a class="code" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a>                ExLock;
05305     PRTL_SPLAY_LINKS        SplayLinks, SuccessorLinks;
05306     <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>          Node;
05307 
05308 
05309     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlPrivateFastUnlockAll, FileLock = %08lx\n"</span>, FileLock);
05310 
05311     <span class="keywordflow">if</span> ((LockInfo = FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05312 
05313         <span class="comment">//</span>
05314         <span class="comment">// No lock information on this FileLock</span>
05315         <span class="comment">//</span>
05316 
05317         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlPrivateFastUnlockAll, No LockInfo\n"</span>, FileLock);
05318         <span class="keywordflow">return</span> STATUS_RANGE_NOT_LOCKED;
05319     }
05320 
05321     FileObject-&gt;LastLock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05322 
05323     LockQueue = &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>;
05324 
05325     <span class="comment">//</span>
05326     <span class="comment">//  Grab the waiting lock queue spinlock to exclude anyone from messing</span>
05327     <span class="comment">//  with the queue while we're using it</span>
05328     <span class="comment">//</span>
05329 
05330     <a class="code" href="../../d5/d3/filelock_8c.html#a9">FsRtlReacquireLockQueue</a>(LockInfo, LockQueue, &amp;OldIrql);
05331 
05332     <span class="keywordflow">if</span> (LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05333 
05334         <span class="comment">//</span>
05335         <span class="comment">// No locks on this FileLock</span>
05336         <span class="comment">//</span>
05337 
05338         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlPrivateFastUnlockAll, No LockTrees\n"</span>, FileLock);
05339         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
05340 
05341         <span class="keywordflow">return</span> STATUS_RANGE_NOT_LOCKED;
05342     }
05343 
05344     <span class="comment">//</span>
05345     <span class="comment">//  Remove all matching locks in the shared lock tree</span>
05346     <span class="comment">//</span>
05347 
05348     <span class="keywordflow">if</span> (LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05349 
05350         <span class="comment">//</span>
05351         <span class="comment">//  Grab the lowest node in the tree</span>
05352         <span class="comment">//</span>
05353 
05354         SplayLinks = LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>;
05355 
05356         <span class="keywordflow">while</span> (RtlLeftChild(SplayLinks) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05357 
05358             SplayLinks = RtlLeftChild(SplayLinks);
05359         }
05360 
05361         <span class="comment">//</span>
05362         <span class="comment">//  Walk all nodes in the tree</span>
05363         <span class="comment">//</span>
05364 
05365         UnlockRoutine = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05366 
05367         <span class="keywordflow">for</span> (;
05368              SplayLinks;
05369              SplayLinks = SuccessorLinks) {
05370 
05371             Node = CONTAINING_RECORD(SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
05372 
05373             <span class="comment">//</span>
05374             <span class="comment">//  Save the next node because we may split this node apart in the process</span>
05375             <span class="comment">//  of deleting locks. It would be a waste of time to traverse those split</span>
05376             <span class="comment">//  nodes. The only case in which we will not have traversed the entire list</span>
05377             <span class="comment">//  before doing the split will be if there is an unlock routine attached</span>
05378             <span class="comment">//  to this FileLock in which case we will be restarting the entire scan</span>
05379             <span class="comment">//  anyway.</span>
05380             <span class="comment">//</span>
05381 
05382             SuccessorLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(SplayLinks);
05383 
05384             <span class="comment">//</span>
05385             <span class="comment">//  Search down the current lock queue looking for a match on</span>
05386             <span class="comment">//  the file object and process id</span>
05387             <span class="comment">//</span>
05388 
05389             SavepLink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05390             SaveEndingByte.QuadPart = 0;
05391 
05392             pLink = &amp;Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next;
05393             <span class="keywordflow">while</span> ((Link = *pLink) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05394 
05395                 ShLock = CONTAINING_RECORD( Link, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
05396 
05397                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"Top of ShLock Loop, Lock = %08lx\n"</span>, ShLock );
05398 
05399                 <span class="keywordflow">if</span> ((ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> == FileObject) &amp;&amp;
05400                     (ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a> == ProcessId) &amp;&amp;
05401                     (!MatchKey || ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)) {
05402 
05403                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"Found one to unlock\n"</span>, 0);
05404 
05405                     <span class="comment">//</span>
05406                     <span class="comment">//  We have a match so now is the time to delete this lock.</span>
05407                     <span class="comment">//  Save the neccesary information to do the split node check.</span>
05408                     <span class="comment">//  Remove the lock from the list, then call the</span>
05409                     <span class="comment">//  optional unlock routine, then delete the lock.</span>
05410                     <span class="comment">//</span>
05411 
05412                     <span class="keywordflow">if</span> (SavepLink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05413 
05414                         <span class="comment">//</span>
05415                         <span class="comment">//  Need to remember where the first lock was deleted</span>
05416                         <span class="comment">//</span>
05417 
05418                         SavepLink = pLink;
05419                     }
05420 
05421                     <span class="keywordflow">if</span> ((ULONGLONG)ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>.QuadPart &gt; (ULONGLONG)SaveEndingByte.QuadPart) {
05422 
05423                         <span class="comment">//</span>
05424                         <span class="comment">//  Need to remember where the last offset affected by deleted locks is</span>
05425                         <span class="comment">//</span>
05426 
05427                         SaveEndingByte.QuadPart = ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>.QuadPart;
05428                     }
05429 
05430                     <span class="keywordflow">if</span> (*pLink == Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o4">Tail</a>.Next) {
05431 
05432                         <span class="comment">//</span>
05433                         <span class="comment">//  Deleting the tail node of the list. Safe even if deleting the</span>
05434                         <span class="comment">//  first node since this implies we're also deleting the last node</span>
05435                         <span class="comment">//  in the node which means we'll delete the node ...</span>
05436                         <span class="comment">//</span>
05437 
05438                         Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o4">Tail</a>.Next = CONTAINING_RECORD( pLink, SINGLE_LIST_ENTRY, Next );
05439                     }
05440 
05441                     *pLink = Link-&gt;Next;
05442 
05443                     <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o2">UnlockRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05444 
05445                         <span class="comment">//</span>
05446                         <span class="comment">//  Signal a lock that needs to have a special unlock routine</span>
05447                         <span class="comment">//  called on it. This is complex to deal with since we'll have</span>
05448                         <span class="comment">//  to release the queue, call it, and reacquire - meaning we</span>
05449                         <span class="comment">//  also have to restart. But we still need to reorder the node</span>
05450                         <span class="comment">//  first ...</span>
05451                         <span class="comment">//</span>
05452 
05453                         UnlockRoutine = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05454 
05455                         <span class="keywordflow">break</span>;
05456                     }
05457 
05458                     <a class="code" href="../../d5/d3/filelock_8c.html#a36">FsRtlFreeSharedLock</a>( ShLock );
05459 
05460                 } <span class="keywordflow">else</span> {
05461 
05462                     <span class="comment">//</span>
05463                     <span class="comment">// Move to next lock</span>
05464                     <span class="comment">//</span>
05465 
05466                     pLink = &amp;Link-&gt;Next;
05467                 }
05468 
05469                 <span class="keywordflow">if</span> (SavepLink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (ULONGLONG)ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>.QuadPart &gt; (ULONGLONG)MaxOffset.QuadPart) {
05470 
05471                     <span class="comment">//</span>
05472                     <span class="comment">//  Save the max offset until we have deleted our first node</span>
05473                     <span class="comment">//</span>
05474 
05475                     MaxOffset.QuadPart = ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>.QuadPart;
05476                 }
05477             }
05478 
05479             <span class="keywordflow">if</span> (SavepLink) {
05480 
05481                 <span class="comment">//</span>
05482                 <span class="comment">//  Locks were actually deleted here, so we have to check the state of the node</span>
05483                 <span class="comment">//</span>
05484 
05485                 <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05486 
05487                     <span class="comment">//</span>
05488                     <span class="comment">//  We have just deleted everything at this node</span>
05489                     <span class="comment">//</span>
05490 
05491                     LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a> = <a class="code" href="../../d3/d4/splay_8c.html#a4">RtlDelete</a>(SplayLinks);
05492 
05493                     <a class="code" href="../../d5/d3/filelock_8c.html#a39">FsRtlFreeLockTreeNode</a>(Node);
05494 
05495                 } <span class="keywordflow">else</span> {
05496 
05497                     <span class="comment">//</span>
05498                     <span class="comment">//  Now that we have deleted all matching locks in this node, we do the</span>
05499                     <span class="comment">//  check on the node to split out any now non-overlapping locks. Conceptually,</span>
05500                     <span class="comment">//  we have deleted just one big lock that starts at the starting byte of the</span>
05501                     <span class="comment">//  first deleted lock and extends to the last byte of the last deleted lock.</span>
05502                     <span class="comment">//</span>
05503 
05504                     <a class="code" href="../../d5/d3/filelock_8c.html#a72">FsRtlSplitLocks</a>(Node, SavepLink, &amp;SaveEndingByte, &amp;MaxOffset);
05505                 }
05506             }
05507 
05508             <span class="keywordflow">if</span> (UnlockRoutine) {
05509 
05510                 <span class="comment">//</span>
05511                 <span class="comment">//  We dropped out of the node scan because we had a lock that needs extra</span>
05512                 <span class="comment">//  processing during unlock. Do it.</span>
05513                 <span class="comment">//</span>
05514 
05515                 <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
05516 
05517                 LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o2">UnlockRoutine</a>(Context, &amp;ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>);
05518 
05519                 <a class="code" href="../../d5/d3/filelock_8c.html#a9">FsRtlReacquireLockQueue</a>(LockInfo, LockQueue, &amp;OldIrql);
05520 
05521                 <a class="code" href="../../d5/d3/filelock_8c.html#a36">FsRtlFreeSharedLock</a>(ShLock);
05522 
05523                 UnlockRoutine = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05524 
05525                 <span class="comment">//</span>
05526                 <span class="comment">//  We have to restart the scan, because the list may have changed while</span>
05527                 <span class="comment">//  we were in the unlock routine. Careful, because the tree may be empty.</span>
05528                 <span class="comment">//</span>
05529 
05530                 <span class="keywordflow">if</span> (SuccessorLinks = LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>) {
05531 
05532                     <span class="keywordflow">while</span> (RtlLeftChild(SuccessorLinks) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05533 
05534                         SuccessorLinks = RtlLeftChild(SuccessorLinks);
05535                     }
05536                 }
05537             }
05538         }
05539     }
05540 
05541     <span class="comment">//</span>
05542     <span class="comment">//  Remove all matching locks in the exclusive lock tree</span>
05543     <span class="comment">//</span>
05544 
05545     <span class="keywordflow">if</span> (LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05546 
05547         SplayLinks = LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>;
05548 
05549         <span class="keywordflow">while</span> (RtlLeftChild(SplayLinks) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05550 
05551             SplayLinks = RtlLeftChild(SplayLinks);
05552         }
05553 
05554         <span class="comment">//</span>
05555         <span class="comment">//  Walk all nodes in the tree</span>
05556         <span class="comment">//</span>
05557 
05558         UnlockRoutine = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05559 
05560         <span class="keywordflow">for</span> (; SplayLinks;
05561                SplayLinks = SuccessorLinks ) {
05562 
05563             SuccessorLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(SplayLinks);
05564 
05565             ExLock = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links );
05566 
05567             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"Top of ExLock Loop, Lock = %08lx\n"</span>, ExLock );
05568 
05569             <span class="keywordflow">if</span> ((ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> == FileObject) &amp;&amp;
05570                 (ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a> == ProcessId) &amp;&amp;
05571                 (!MatchKey || ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)) {
05572 
05573                 LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> = <a class="code" href="../../d3/d4/splay_8c.html#a4">RtlDelete</a>(&amp;ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o0">Links</a>);
05574 
05575                 <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o2">UnlockRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05576 
05577                     <span class="comment">//</span>
05578                     <span class="comment">//  We're dropping out of the node scan because we have a lock</span>
05579                     <span class="comment">//  that needs extra processing during unlock. Do it.</span>
05580                     <span class="comment">//</span>
05581 
05582                     <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
05583 
05584                     LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o2">UnlockRoutine</a>(Context, &amp;ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>);
05585 
05586                     <a class="code" href="../../d5/d3/filelock_8c.html#a9">FsRtlReacquireLockQueue</a>(LockInfo, LockQueue, &amp;OldIrql);
05587 
05588                     <span class="comment">//</span>
05589                     <span class="comment">//  We have to restart the scan, because the list may have changed while</span>
05590                     <span class="comment">//  we were in the unlock routine. Careful, because the tree may be empty.</span>
05591                     <span class="comment">//</span>
05592 
05593                     <span class="keywordflow">if</span> (SuccessorLinks = LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>) {
05594 
05595                         <span class="keywordflow">while</span> (RtlLeftChild(SuccessorLinks) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05596 
05597                             SuccessorLinks = RtlLeftChild(SuccessorLinks);
05598                         }
05599                     }
05600                 }
05601 
05602                 <a class="code" href="../../d5/d3/filelock_8c.html#a37">FsRtlFreeExclusiveLock</a>(ExLock);
05603             }
05604         }
05605     }
05606 
05607     <span class="comment">//</span>
05608     <span class="comment">//  Search down the waiting lock queue looking for a match on the</span>
05609     <span class="comment">//  file object and process id.</span>
05610     <span class="comment">//</span>
05611 
05612     pLink = &amp;LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o3">WaitingLocks</a>.Next;
05613     <span class="keywordflow">while</span> ((Link = *pLink) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05614 
05615         <a class="code" href="../../d1/d8/struct__WAITING__LOCK.html">PWAITING_LOCK</a> WaitingLock;
05616         <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> WaitingIrp;
05617         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> WaitingIrpSp;
05618 
05619         WaitingLock = CONTAINING_RECORD( Link, <a class="code" href="../../d1/d8/struct__WAITING__LOCK.html">WAITING_LOCK</a>, Link );
05620 
05621         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"Top of Waiting Loop, WaitingLock = %08lx\n"</span>, WaitingLock);
05622 
05623         <span class="comment">//</span>
05624         <span class="comment">//  Get a copy of the necessary fields we'll need to use</span>
05625         <span class="comment">//</span>
05626 
05627         WaitingIrp = WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o2">Irp</a>;
05628         WaitingIrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( WaitingIrp );
05629 
05630         <span class="keywordflow">if</span> ((FileObject == WaitingIrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>) &amp;&amp;
05631             (ProcessId == <a class="code" href="../../d4/d6/iosubs_8c.html#a78">IoGetRequestorProcess</a>( WaitingIrp )) &amp;&amp;
05632             (!MatchKey || <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> == WaitingIrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.Key)) {
05633 
05634             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"Found a waiting lock to abort\n"</span>, 0);
05635 
05636             <span class="comment">//</span>
05637             <span class="comment">//  We now void the cancel routine in the irp</span>
05638             <span class="comment">//</span>
05639 
05640             <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( WaitingIrp, NULL );
05641             WaitingIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
05642 
05643             <span class="comment">//</span>
05644             <span class="comment">//  We have a match so now is the time to delete this waiter</span>
05645             <span class="comment">//  But we must not mess up our link iteration variable.  We</span>
05646             <span class="comment">//  do this by simply starting the iteration over again,</span>
05647             <span class="comment">//  after we delete ourselves.  We also will deallocate the</span>
05648             <span class="comment">//  lock after we delete it.</span>
05649             <span class="comment">//</span>
05650 
05651             *pLink = Link-&gt;Next;
05652             <span class="keywordflow">if</span> (Link == LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o4">WaitingLocksTail</a>.Next) {
05653                 LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o4">WaitingLocksTail</a>.Next = (PSINGLE_LIST_ENTRY) pLink;
05654             }
05655 
05656             <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
05657 
05658             <span class="comment">//</span>
05659             <span class="comment">//  And complete this lock request Irp</span>
05660             <span class="comment">//</span>
05661 
05662             <a class="code" href="../../d5/d3/filelock_8c.html#a11">FsRtlCompleteLockIrp</a>( LockInfo,
05663                                     WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o1">Context</a>,
05664                                     WaitingIrp,
05665                                     STATUS_SUCCESS,
05666                                     &amp;NewStatus,
05667                                     NULL );
05668 
05669             <span class="comment">//</span>
05670             <span class="comment">// Reaqcuire lock queue spinlock and start over</span>
05671             <span class="comment">//</span>
05672 
05673             <a class="code" href="../../d5/d3/filelock_8c.html#a9">FsRtlReacquireLockQueue</a>(LockInfo, LockQueue, &amp;OldIrql);
05674 
05675             <span class="comment">//</span>
05676             <span class="comment">// Start over</span>
05677             <span class="comment">//</span>
05678 
05679             pLink = &amp;LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o3">WaitingLocks</a>.Next;
05680 
05681             <span class="comment">//</span>
05682             <span class="comment">// Put memory onto free list</span>
05683             <span class="comment">//</span>
05684 
05685             <a class="code" href="../../d5/d3/filelock_8c.html#a38">FsRtlFreeWaitingLock</a>( WaitingLock );
05686             <span class="keywordflow">continue</span>;
05687         }
05688 
05689         <span class="comment">//</span>
05690         <span class="comment">// Move to next lock</span>
05691         <span class="comment">//</span>
05692 
05693         pLink = &amp;Link-&gt;Next;
05694     }
05695 
05696     <span class="comment">//</span>
05697     <span class="comment">//  At this point we've gone through unlocking everything. So</span>
05698     <span class="comment">//  now try and release any waiting locks.</span>
05699     <span class="comment">//</span>
05700 
05701     <a class="code" href="../../d5/d3/filelock_8c.html#a49">FsRtlPrivateCheckWaitingLocks</a>( LockInfo, LockQueue, OldIrql );
05702 
05703     <span class="comment">//</span>
05704     <span class="comment">//  We deleted a (possible) bunch of locks, go repair the lowest lock offset</span>
05705     <span class="comment">//</span>
05706 
05707     <a class="code" href="../../d5/d3/filelock_8c.html#a58">FsRtlPrivateResetLowestLockOffset</a>( LockInfo );
05708 
05709     <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>( LockQueue, OldIrql );
05710 
05711     <span class="comment">//</span>
05712     <span class="comment">//  and return to our caller</span>
05713     <span class="comment">//</span>
05714 
05715     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlFastUnlockAll -&gt; VOID\n"</span>, 0);
05716     <span class="keywordflow">return</span> STATUS_SUCCESS;
05717 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="filelock.c::FsRtlPrivateInitializeFileLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlPrivateInitializeFileLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ViaFastCall</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00888">888</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00172">_LOCK_INFO::CompleteLockIrpRoutine</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00427">FsRtlAllocateLockInfo()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00119">FsRtlCreateLockInfo</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00166">_LOCK_INFO::LowestLockOffset</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00133">_LOCK_QUEUE::QueueSpinLock</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00140">_LOCK_QUEUE::SharedLockTree</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00178">_LOCK_INFO::UnlockRoutine</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00142">_LOCK_QUEUE::WaitingLocks</a>, and <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00143">_LOCK_QUEUE::WaitingLocksTail</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>.
<p>
<pre class="fragment"><div>00894                    :
00895 
00896     This routine initializes a <span class="keyword">new</span> <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">LOCK_INFO</a> structure in non-paged
00897     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a>.  This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> occurs once <span class="keywordflow">for</span> a given
00898     <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a> and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> occurs <span class="keywordflow">if</span> any locks are applied to that <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00899 
00900 Arguments:
00901 
00902     FileLock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a> structure to
00903         initialize.
00904 
00905     ViaFastCall - Indicates <span class="keywordflow">if</span> we are being invoked via a fast call or
00906         via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> slow irp based method.
00907 
00908 Return Value:
00909 
00910     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - If LockInfo structure was allocated and initialized
00911 
00912 --*/
00913 {
00914     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>  LockInfo;
00915     BOOLEAN     Results = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00916 
00917     ExAcquireFastMutex( &amp;FsRtlCreateLockInfo );
00918 
00919     <span class="keywordflow">try</span> {
00920 
00921         <span class="keywordflow">if</span> (FileLock-&gt;LockInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00922 
00923             <span class="comment">//</span>
00924             <span class="comment">// Structure is already allocated, just return</span>
00925             <span class="comment">//</span>
00926 
00927             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Results = TRUE );
00928         }
00929 
00930         <span class="comment">//</span>
00931         <span class="comment">//  Allocate pool for lock structures.  If we fail then we will either return false or</span>
00932         <span class="comment">//  raise based on if we know the caller has an try-except to handle a raise.</span>
00933         <span class="comment">//</span>
00934 
00935         LockInfo = <a class="code" href="../../d5/d3/filelock_8c.html#a35">FsRtlAllocateLockInfo</a>();
00936 
00937         <span class="keywordflow">if</span> (LockInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00938 
00939             <span class="keywordflow">if</span> (ViaFastCall) {
00940 
00941                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Results = FALSE );
00942 
00943             } <span class="keywordflow">else</span> {
00944 
00945                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00946             }
00947         }
00948 
00949         <span class="comment">//</span>
00950         <span class="comment">//  Allocate and initialize the waiting lock queue</span>
00951         <span class="comment">//  spinlock, and initialize the queues</span>
00952         <span class="comment">//</span>
00953 
00954         LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o0">LowestLockOffset</a> = 0xffffffff;
00955 
00956         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o0">QueueSpinLock</a> );
00957         LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00958         LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00959         LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o3">WaitingLocks</a>.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00960         LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o4">WaitingLocksTail</a>.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00961 
00962         <span class="comment">//</span>
00963         <span class="comment">// Copy Irp &amp; Unlock routines from pagable FileLock structure</span>
00964         <span class="comment">// to non-pagable LockInfo structure</span>
00965         <span class="comment">//</span>
00966 
00967         LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o1">CompleteLockIrpRoutine</a> = FileLock-&gt;CompleteLockIrpRoutine;
00968         LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o2">UnlockRoutine</a> = FileLock-&gt;UnlockRoutine;
00969 
00970         <span class="comment">//</span>
00971         <span class="comment">// Clear continuation info for enum routine</span>
00972         <span class="comment">//</span>
00973 
00974         FileLock-&gt;LastReturnedLockInfo.FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00975         FileLock-&gt;LastReturnedLock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00976 
00977         <span class="comment">//</span>
00978         <span class="comment">// Link LockInfo into FileLock</span>
00979         <span class="comment">//</span>
00980 
00981         FileLock-&gt;LockInformation = (PVOID) LockInfo;
00982         Results = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00983 
00984     try_exit: NOTHING;
00985     } finally {
00986 
00987         ExReleaseFastMutex( &amp;FsRtlCreateLockInfo );
00988     }
00989 
00990     <span class="keywordflow">return</span> Results;
00991 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="filelock.c::FsRtlPrivateInsertExclusiveLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlPrivateInsertExclusiveLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LockQueue</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewLock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l04605">4605</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01687">FsRtlFindFirstOverlappingExclusiveNode()</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d4/d3/splay_8c-source.html#l00759">RtlRealSuccessor()</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l04253">FsRtlPrivateInsertLock()</a>.
<p>
<pre class="fragment"><div>04612                    :
04613 
04614     This routine adds a <span class="keyword">new</span> exclusive lock record to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> lock's current
04615     lock queue.
04616 
04617 Arguments:
04618 
04619     LockQueue - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock queue being modified
04620 
04621     NewLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> exclusive lock to add to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock queue
04622 
04623 Return Value:
04624 
04625     None.
04626 
04627 --*/
04628 
04629 {
04630     PRTL_SPLAY_LINKS OverlappedSplayLinks, ParentSplayLinks;
04631     BOOLEAN <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>;
04632 
04633     OverlappedSplayLinks = <a class="code" href="../../d5/d3/filelock_8c.html#a44">FsRtlFindFirstOverlappingExclusiveNode</a>( LockQueue-&gt;ExclusiveLockTree,
04634                                                                    &amp;NewLock-&gt;LockInfo.StartingByte,
04635                                                                    &amp;NewLock-&gt;LockInfo.EndingByte,
04636                                                                    &amp;ParentSplayLinks,
04637                                                                    &amp;GreaterThan );
04638 
04639     <span class="comment">//</span>
04640     <span class="comment">//  This is the exclusive tree. Nothing can overlap (caller is supposed to insure this) unless</span>
04641     <span class="comment">//  the lock is a zero length lock, in which case we just insert it - still.</span>
04642     <span class="comment">//</span>
04643 
04644     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!OverlappedSplayLinks || NewLock-&gt;LockInfo.Length.QuadPart == 0);
04645 
04646     <span class="comment">//</span>
04647     <span class="comment">//  Simple insert ...</span>
04648     <span class="comment">//</span>
04649 
04650     RtlInitializeSplayLinks(&amp;NewLock-&gt;Links);
04651 
04652     <span class="keywordflow">if</span> (OverlappedSplayLinks) {
04653 
04654         <span class="comment">//</span>
04655         <span class="comment">//  With zero length locks we have OverlappedSplayLinks at the starting point</span>
04656         <span class="comment">//  of a run of zero length locks, so we have to e flexible about where the new</span>
04657         <span class="comment">//  node is inserted.</span>
04658         <span class="comment">//</span>
04659 
04660         <span class="keywordflow">if</span> (RtlRightChild(OverlappedSplayLinks)) {
04661 
04662             <span class="comment">//</span>
04663             <span class="comment">//  Right slot taken. We can use the left slot or go to the sucessor's left slot</span>
04664             <span class="comment">//</span>
04665 
04666             <span class="keywordflow">if</span> (RtlLeftChild(OverlappedSplayLinks)) {
04667 
04668                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RtlLeftChild(<a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(OverlappedSplayLinks)) == NULL);
04669                 RtlInsertAsLeftChild(<a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(OverlappedSplayLinks), &amp;NewLock-&gt;Links);
04670 
04671             } <span class="keywordflow">else</span> {
04672 
04673                 RtlInsertAsLeftChild(OverlappedSplayLinks, &amp;NewLock-&gt;Links);
04674             }
04675 
04676 
04677         } <span class="keywordflow">else</span> {
04678 
04679             RtlInsertAsRightChild(OverlappedSplayLinks, &amp;NewLock-&gt;Links);
04680         }
04681 
04682     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ParentSplayLinks) {
04683 
04684         <span class="comment">//</span>
04685         <span class="comment">//  We have a real parent node in the tree, and must be at a leaf since</span>
04686         <span class="comment">//  there was no overlap</span>
04687         <span class="comment">//</span>
04688 
04689         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) {
04690 
04691             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RtlLeftChild(ParentSplayLinks) == NULL);
04692             RtlInsertAsLeftChild(ParentSplayLinks, &amp;NewLock-&gt;Links);
04693 
04694         } <span class="keywordflow">else</span> {
04695 
04696             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RtlRightChild(ParentSplayLinks) == NULL);
04697             RtlInsertAsRightChild(ParentSplayLinks, &amp;NewLock-&gt;Links);
04698         }
04699 
04700     } <span class="keywordflow">else</span> {
04701 
04702         <span class="comment">//</span>
04703         <span class="comment">//  First node in the tree</span>
04704         <span class="comment">//</span>
04705 
04706         LockQueue-&gt;ExclusiveLockTree = &amp;NewLock-&gt;Links;
04707     }
04708 
04709     <span class="comment">//</span>
04710     <span class="comment">//  And return to our caller</span>
04711     <span class="comment">//</span>
04712 
04713     <span class="keywordflow">return</span>;
04714 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="filelock.c::FsRtlPrivateInsertLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlPrivateInsertLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LockInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLockInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l04253">4253</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00400">FsRtlAllocateExclusiveLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00391">FsRtlAllocateSharedLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04605">FsRtlPrivateInsertExclusiveLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04343">FsRtlPrivateInsertSharedLock()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00068">_SH_LOCK::LockInfo</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00089">_EX_LOCK::LockInfo</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a24">PEX_LOCK</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">FsRtlPrivateCheckWaitingLocks()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>.
<p>
<pre class="fragment"><div>04261                    :
04262 
04263     This routine fills in a <span class="keyword">new</span> lock record of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> and inserts
04264     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock information.
04265 
04266 Arguments:
04267 
04268     LockInfo - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock being modified
04269 
04270     FileObject - The associated <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object to update hints in
04271 
04272     FileLockInfo - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> lock data to add to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock queue
04273 
04274 Return Value:
04275 
04276     BOOLEAN - True <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> insert was successful, False <span class="keywordflow">if</span> no resources were avaliable
04277         to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
04278 
04279 --*/
04280 
04281 {
04282     <span class="comment">//</span>
04283     <span class="comment">//  Now add the lock to the appropriate tree.</span>
04284     <span class="comment">//</span>
04285 
04286     <span class="keywordflow">if</span> (FileLockInfo-&gt;ExclusiveLock) {
04287 
04288         <a class="code" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a> ExLock;
04289 
04290         ExLock = <a class="code" href="../../d5/d3/filelock_8c.html#a32">FsRtlAllocateExclusiveLock</a>();
04291 
04292         <span class="keywordflow">if</span> (ExLock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04293 
04294             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04295         }
04296 
04297         ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a> = *FileLockInfo;
04298 
04299         <a class="code" href="../../d5/d3/filelock_8c.html#a48">FsRtlPrivateInsertExclusiveLock</a>( &amp;LockInfo-&gt;LockQueue, ExLock );
04300 
04301         FileObject-&gt;LastLock = &amp;ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>;
04302 
04303     } <span class="keywordflow">else</span> {
04304 
04305         <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a> ShLock;
04306 
04307         ShLock = <a class="code" href="../../d5/d3/filelock_8c.html#a31">FsRtlAllocateSharedLock</a>();
04308 
04309         <span class="keywordflow">if</span> (ShLock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04310 
04311             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04312         }
04313 
04314         ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a> = *FileLockInfo;
04315 
04316         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/filelock_8c.html#a47">FsRtlPrivateInsertSharedLock</a>( &amp;LockInfo-&gt;LockQueue, ShLock )) {
04317 
04318             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04319         }
04320 
04321         FileObject-&gt;LastLock = &amp;ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>;
04322     }
04323 
04324     <span class="comment">//</span>
04325     <span class="comment">//  Fix up the lowest lock offset if need be</span>
04326     <span class="comment">//</span>
04327 
04328     <span class="keywordflow">if</span> ((ULONGLONG)FileLockInfo-&gt;StartingByte.QuadPart &lt; (ULONGLONG)LockInfo-&gt;LowestLockOffset) {
04329 
04330         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FileLockInfo-&gt;StartingByte.HighPart == 0 );
04331         LockInfo-&gt;LowestLockOffset = FileLockInfo-&gt;StartingByte.LowPart;
04332     }
04333 
04334     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04335 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="filelock.c::FsRtlPrivateInsertSharedLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlPrivateInsertSharedLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LockQueue</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewLock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l04343">4343</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00029">_LOCKTREE_NODE::Extent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00418">FsRtlAllocateLockTreeNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01517">FsRtlFindFirstOverlappingSharedNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00464">FsRtlFreeLockTreeNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02865">FsRtlSplitLocks()</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00021">_LOCKTREE_NODE::HoleyNode</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00036">_LOCKTREE_NODE::Links</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00068">_SH_LOCK::LockInfo</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00008">_LOCKTREE_NODE::Locks</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a20">PLOCKTREE_NODE</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00502">RtlDeleteNoSplay()</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00759">RtlRealSuccessor()</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00051">RtlSplay()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00560">_FILE_LOCK_INFO::StartingByte</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00042">_LOCKTREE_NODE::Tail</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l04253">FsRtlPrivateInsertLock()</a>.
<p>
<pre class="fragment"><div>04350                    :
04351 
04352     This routine adds a <span class="keyword">new</span> shared lock record to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> lock's current
04353     lock queue. Locks are inserted into nodes ordered by their starting byte.
04354 
04355 Arguments:
04356 
04357     LockQueue - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock queue being modified
04358 
04359     NewLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> shared lock to add to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock queue
04360 
04361 Return Value:
04362 
04363     BOOLEAN - True <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> insert was successful, False <span class="keywordflow">if</span> no resources were avaliable
04364         to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
04365 
04366 --*/
04367 {
04368     PSINGLE_LIST_ENTRY pLink, Link;
04369     PRTL_SPLAY_LINKS OverlappedSplayLinks, ParentSplayLinks;
04370     <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a> Node, NextNode;
04371     <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a> NextLock;
04372     BOOLEAN <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>;
04373 
04374     OverlappedSplayLinks = <a class="code" href="../../d5/d3/filelock_8c.html#a43">FsRtlFindFirstOverlappingSharedNode</a>( LockQueue-&gt;SharedLockTree,
04375                                                                 &amp;NewLock-&gt;LockInfo.StartingByte,
04376                                                                 &amp;NewLock-&gt;LockInfo.EndingByte,
04377                                                                 &amp;ParentSplayLinks,
04378                                                                 &amp;GreaterThan );
04379 
04380     <span class="keywordflow">if</span> (OverlappedSplayLinks == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04381 
04382         <span class="comment">//</span>
04383         <span class="comment">//  Simple insert case, build a new node</span>
04384         <span class="comment">//</span>
04385 
04386         NextNode = <a class="code" href="../../d5/d3/filelock_8c.html#a34">FsRtlAllocateLockTreeNode</a>();
04387 
04388         <span class="comment">//</span>
04389         <span class="comment">//  If no resources are avaliable, simply fail now.</span>
04390         <span class="comment">//</span>
04391 
04392         <span class="keywordflow">if</span> (NextNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04393 
04394             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04395         }
04396 
04397         RtlInitializeSplayLinks(&amp;NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o3">Links</a>);
04398         NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o1">HoleyNode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04399 
04400         NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next = NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o4">Tail</a>.Next = &amp;NewLock-&gt;Link;
04401         NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o2">Extent</a> = (ULONGLONG)NewLock-&gt;LockInfo.EndingByte.QuadPart;
04402         NewLock-&gt;Link.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04403 
04404         <span class="keywordflow">if</span> (ParentSplayLinks) {
04405 
04406             <span class="comment">//</span>
04407             <span class="comment">//  We have a real parent node in the tree</span>
04408             <span class="comment">//</span>
04409 
04410             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) {
04411 
04412                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RtlLeftChild(ParentSplayLinks) == NULL);
04413                 RtlInsertAsLeftChild(ParentSplayLinks, &amp;NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o3">Links</a>);
04414 
04415             } <span class="keywordflow">else</span> {
04416 
04417                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RtlRightChild(ParentSplayLinks) == NULL);
04418                 RtlInsertAsRightChild(ParentSplayLinks, &amp;NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o3">Links</a>);
04419             }
04420 
04421             <span class="comment">//</span>
04422             <span class="comment">//  Splay all new nodes in the tree</span>
04423             <span class="comment">//</span>
04424 
04425             LockQueue-&gt;SharedLockTree = <a class="code" href="../../d3/d4/splay_8c.html#a3">RtlSplay</a>(&amp;NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o3">Links</a>);
04426 
04427         } <span class="keywordflow">else</span> {
04428 
04429             <span class="comment">//</span>
04430             <span class="comment">//  First node in the tree</span>
04431             <span class="comment">//</span>
04432 
04433             LockQueue-&gt;SharedLockTree = &amp;NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o3">Links</a>;
04434         }
04435 
04436         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04437     }
04438 
04439     <span class="comment">//</span>
04440     <span class="comment">//  Now we examine the node to see if it is holey as a result of a resource-failed split.</span>
04441     <span class="comment">//  If it is, we must complete the split before adding the new lock.</span>
04442     <span class="comment">//</span>
04443 
04444     Node = CONTAINING_RECORD( OverlappedSplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
04445 
04446     <span class="comment">//</span>
04447     <span class="comment">//  Search down the overlapped node finding the position for the new lock</span>
04448     <span class="comment">//</span>
04449 
04450     <span class="keywordflow">for</span> (pLink = &amp;Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>;
04451          (Link = pLink-&gt;Next) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04452          pLink = Link) {
04453 
04454         <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
04455 
04456         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = CONTAINING_RECORD( Link, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
04457 
04458         <span class="comment">//</span>
04459         <span class="comment">//  We sort locks on this list first by starting byte, then by whether the length is zero or not.</span>
04460         <span class="comment">//  This is important so that zero length locks appear prior to non-zero length locks, so that</span>
04461         <span class="comment">//  they are split out of nodes into the tree in the correct order.</span>
04462         <span class="comment">//</span>
04463         <span class="comment">//  if (NewLock-&gt;StartingByte &lt;= Lock-&gt;StartingByte) ...</span>
04464         <span class="comment">//</span>
04465 
04466         <span class="keywordflow">if</span> (((ULONGLONG)NewLock-&gt;LockInfo.StartingByte.QuadPart &lt; (ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart) ||
04467 
04468             ((ULONGLONG)NewLock-&gt;LockInfo.StartingByte.QuadPart == (ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart &amp;&amp;
04469              (NewLock-&gt;LockInfo.Length.QuadPart == 0 || <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.Length.QuadPart != 0))) {
04470 
04471             <span class="keywordflow">break</span>;
04472         }
04473     }
04474 
04475     <span class="comment">//</span>
04476     <span class="comment">//  At this point pLink points to the record that comes right after</span>
04477     <span class="comment">//  the new lock that we're inserting so we can simply push the</span>
04478     <span class="comment">//  newlock into the entrylist</span>
04479     <span class="comment">//</span>
04480 
04481     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"InsertSharedLock, Insert Before = %08lx\n"</span>, Link);
04482 
04483     <span class="keywordflow">if</span> (pLink-&gt;Next == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04484 
04485         <span class="comment">//</span>
04486         <span class="comment">//    Adding onto the tail of the list</span>
04487         <span class="comment">//</span>
04488 
04489         Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o4">Tail</a>.Next = &amp;NewLock-&gt;Link;
04490     }
04491 
04492     NewLock-&gt;Link.Next = pLink-&gt;Next;
04493     pLink-&gt;Next = &amp;NewLock-&gt;Link;
04494 
04495     <span class="comment">//</span>
04496     <span class="comment">//  And splay the node we inserted into</span>
04497     <span class="comment">//</span>
04498 
04499     LockQueue-&gt;SharedLockTree = <a class="code" href="../../d3/d4/splay_8c.html#a3">RtlSplay</a>(OverlappedSplayLinks);
04500 
04501     <span class="keywordflow">if</span> ((ULONGLONG)NewLock-&gt;LockInfo.EndingByte.QuadPart &gt; Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o2">Extent</a>) {
04502 
04503         <span class="comment">//</span>
04504         <span class="comment">//  The new lock extends the range of this node, so fix up the extent</span>
04505         <span class="comment">//</span>
04506 
04507         Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o2">Extent</a> = NewLock-&gt;LockInfo.EndingByte.QuadPart;
04508 
04509         <span class="comment">//</span>
04510         <span class="comment">//  Walk across the remainder of the tree integrating newly overlapping</span>
04511         <span class="comment">//  nodes into the node we just inserted the new lock into.  Note that</span>
04512         <span class="comment">//  this isn't so much a walk as a repeated examination of our successor's</span>
04513         <span class="comment">//  until one does not overlap (or we hit the end).</span>
04514         <span class="comment">//</span>
04515 
04516         ParentSplayLinks = OverlappedSplayLinks;
04517 
04518         <span class="keywordflow">for</span> (OverlappedSplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(ParentSplayLinks);
04519              OverlappedSplayLinks;
04520              OverlappedSplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(ParentSplayLinks)) {
04521 
04522             NextNode = CONTAINING_RECORD( OverlappedSplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
04523             NextLock = CONTAINING_RECORD( NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
04524 
04525             <span class="keywordflow">if</span> ((ULONGLONG)NextLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart &gt; Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o2">Extent</a>) {
04526 
04527                 <span class="comment">//</span>
04528                 <span class="comment">//  This node is not overlapped, so stop</span>
04529                 <span class="comment">//</span>
04530 
04531                 <span class="keywordflow">break</span>;
04532             }
04533 
04534             <span class="comment">//</span>
04535             <span class="comment">//  If we are intergrating a holey node into a non-holey node, try to split</span>
04536             <span class="comment">//  the node first.  It will be better to get this done with a smaller node</span>
04537             <span class="comment">//  than a big, fully integrated one.  Note that we are guaranteed that the</span>
04538             <span class="comment">//  node will remain a candidate for integration since the first lock on the</span>
04539             <span class="comment">//  node will still be there, and overlaps.</span>
04540             <span class="comment">//</span>
04541 
04542             <span class="keywordflow">if</span> (!Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o1">HoleyNode</a> &amp;&amp; NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o1">HoleyNode</a>) {
04543 
04544                 <a class="code" href="../../d5/d3/filelock_8c.html#a72">FsRtlSplitLocks</a>( NextNode, NULL, NULL, NULL );
04545             }
04546 
04547             <span class="comment">//</span>
04548             <span class="comment">//  Integrate the locks in this node into our list</span>
04549             <span class="comment">//</span>
04550 
04551             Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o4">Tail</a>.Next-&gt;Next = NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next;
04552             Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o4">Tail</a>.Next = NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o4">Tail</a>.Next;
04553 
04554             <span class="keywordflow">if</span> (NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o2">Extent</a> &gt; Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o2">Extent</a>) {
04555 
04556                 <span class="comment">//</span>
04557                 <span class="comment">//  If the node we just swallowed was (still!) holey, we perhaps made this</span>
04558                 <span class="comment">//  node holey too.  The resolution of this is left to the lock split we will</span>
04559                 <span class="comment">//  perform after integration is complete.</span>
04560                 <span class="comment">//</span>
04561                 <span class="comment">//  Note that if the extent of the node we are swallowing is interior</span>
04562                 <span class="comment">//  to the current node, we just covered whatever holes it contained.</span>
04563                 <span class="comment">//</span>
04564 
04565                 <span class="keywordflow">if</span> (NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o1">HoleyNode</a>) {
04566 
04567                     Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o1">HoleyNode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04568                 }
04569 
04570                 Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o2">Extent</a> = NextNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o2">Extent</a>;
04571             }
04572 
04573             <span class="comment">//</span>
04574             <span class="comment">//  Free the now empty node.</span>
04575             <span class="comment">//</span>
04576 
04577             <a class="code" href="../../d3/d4/splay_8c.html#a5">RtlDeleteNoSplay</a>( OverlappedSplayLinks, &amp;LockQueue-&gt;SharedLockTree );
04578             <a class="code" href="../../d5/d3/filelock_8c.html#a39">FsRtlFreeLockTreeNode</a>( NextNode );
04579         }
04580     }
04581 
04582     <span class="comment">//</span>
04583     <span class="comment">//  Now, perhaps this node is still holey.  For grins lets try one more time to split</span>
04584     <span class="comment">//  this thing apart.</span>
04585     <span class="comment">//</span>
04586 
04587     <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o1">HoleyNode</a>) {
04588 
04589         <a class="code" href="../../d5/d3/filelock_8c.html#a72">FsRtlSplitLocks</a>( Node, NULL, NULL, NULL );
04590     }
04591 
04592     <span class="comment">//</span>
04593     <span class="comment">//  And return to our caller</span>
04594     <span class="comment">//</span>
04595 
04596     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04597 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a76" doxytag="filelock.c::FsRtlPrivateLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlPrivateLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FailImmediately</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ExclusiveLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>Iosb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AlreadySynchronized</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">3867</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00112">_WAITING_LOCK::Context</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00576">_FILE_LOCK_INFO::EndingByte</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00562">_FILE_LOCK_INFO::ExclusiveLock</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00569">_FILE_LOCK_INFO::FileObject</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00481">FsRtlAcquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00409">FsRtlAllocateWaitingLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00497">FsRtlCompleteLockIrp</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05721">FsRtlPrivateCancelFileLockIrp()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04934">FsRtlPrivateCheckForExclusiveLockAccess()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05046">FsRtlPrivateCheckForSharedLockAccess()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00888">FsRtlPrivateInitializeFileLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04253">FsRtlPrivateInsertLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03162">FsRtlPrivateRemoveLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00118">_WAITING_LOCK::Irp</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00568">_FILE_LOCK_INFO::Key</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00561">_FILE_LOCK_INFO::Length</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00105">_WAITING_LOCK::Link</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a28">PLOCK_QUEUE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00570">_FILE_LOCK_INFO::ProcessId</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a26">PWAITING_LOCK</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00560">_FILE_LOCK_INFO::StartingByte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00142">_LOCK_QUEUE::WaitingLocks</a>, and <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00143">_LOCK_QUEUE::WaitingLocksTail</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">FsRtlProcessFileLock()</a>.
<p>
<pre class="fragment"><div>03884                    :
03885 
03886     This routine preforms a lock operation request.  This handles both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast
03887     get lock and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> based get lock.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied then
03888     <span class="keyword">this</span> routine will either complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> or enqueue <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> as a waiting
03889     lock request.
03890 
03891 Arguments:
03892 
03893     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> to work against
03894 
03895     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object used in <span class="keyword">this</span> operation
03896 
03897     FileOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset used in <span class="keyword">this</span> operation
03898 
03899     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length used in <span class="keyword">this</span> operation
03900 
03901     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> used in <span class="keyword">this</span> operation
03902 
03903     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key used in <span class="keyword">this</span> operation
03904 
03905     FailImmediately - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request should fail immediately
03906         <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock cannot be granted.
03907 
03908     ExclusiveLock - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a request <span class="keywordflow">for</span> an exclusive or
03909         shared lock
03910 
03911     Iosb - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> <span class="keywordflow">if</span> <span class="keyword">this</span> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful
03912 
03913     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context with which to complete <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> with
03914 
03915     AlreadySynchronized - Indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has already <span class="keyword">synchronized</span>
03916         access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fields in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock and
03917         be updated without further locking, but not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queues.
03918 
03919 Return Value:
03920 
03921     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> operation completed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
03922 
03923 --*/
03924 
03925 {
03926     BOOLEAN Results;
03927     BOOLEAN AccessGranted;
03928     BOOLEAN ViaFastCall;
03929     BOOLEAN ReleaseQueue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03930 
03931     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>  LockInfo;
03932     <a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a> LockQueue;
03933     KIRQL       OldIrql;
03934     <a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">FILE_LOCK_INFO</a> FileLockInfo;
03935 
03936     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlPrivateLock, FileLock = %08lx\n"</span>, FileLock);
03937 
03938     <span class="comment">//</span>
03939     <span class="comment">//  If the irp is null then this is being called via the fast call method.</span>
03940     <span class="comment">//</span>
03941 
03942     ViaFastCall = (BOOLEAN) !ARGUMENT_PRESENT( Irp );
03943 
03944     <span class="keywordflow">if</span> ((LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03945         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+2, Dbg, <span class="stringliteral">"FsRtlPrivateLock, New LockInfo required\n"</span>, 0);
03946 
03947         <span class="comment">//</span>
03948         <span class="comment">// No lock information on this FileLock, create the structure.</span>
03949         <span class="comment">//</span>
03950         <span class="comment">//</span>
03951 
03952         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/filelock_8c.html#a54">FsRtlPrivateInitializeFileLock</a> (FileLock, ViaFastCall)) {
03953 
03954             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03955         }
03956 
03957         <span class="comment">//</span>
03958         <span class="comment">// Set flag so file locks will be checked on the fast io</span>
03959         <span class="comment">// code paths</span>
03960         <span class="comment">//</span>
03961 
03962         FileLock-&gt;FastIoIsQuestionable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03963 
03964         <span class="comment">//</span>
03965         <span class="comment">// Pickup allocated lockinfo structure</span>
03966         <span class="comment">//</span>
03967 
03968         LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation;
03969     }
03970 
03971     <span class="comment">//</span>
03972     <span class="comment">// Assume success and build LockData structure prior to acquiring</span>
03973     <span class="comment">// the lock queue spinlock.  (mp perf enhancement)</span>
03974     <span class="comment">//</span>
03975 
03976     FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a> = *FileOffset;
03977     FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a> = *Length;
03978     (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>.QuadPart =
03979             (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart + (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart - 1;
03980 
03981     FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
03982     FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> = FileObject;
03983     FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a> = ProcessId;
03984     FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o2">ExclusiveLock</a> = ExclusiveLock;
03985 
03986     LockQueue = &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>;
03987 
03988     <span class="comment">//</span>
03989     <span class="comment">//  Now we need to actually run through our current lock queue.</span>
03990     <span class="comment">//</span>
03991 
03992     <a class="code" href="../../d5/d3/filelock_8c.html#a8">FsRtlAcquireLockQueue</a>(LockQueue, &amp;OldIrql);
03993     ReleaseQueue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03994 
03995     <span class="keywordflow">try</span> {
03996 
03997         <span class="comment">//</span>
03998         <span class="comment">//  Case on whether we're trying to take out an exclusive lock or</span>
03999         <span class="comment">//  a shared lock.  And in both cases try to get appropriate access.</span>
04000         <span class="comment">//</span>
04001 
04002         <span class="keywordflow">if</span> (ExclusiveLock) {
04003 
04004             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"Check for write access\n"</span>, 0);
04005 
04006             AccessGranted = <a class="code" href="../../d5/d3/filelock_8c.html#a51">FsRtlPrivateCheckForExclusiveLockAccess</a>(
04007                                 LockQueue,
04008                                 &amp;FileLockInfo );
04009 
04010         } <span class="keywordflow">else</span> {
04011 
04012             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"Check for read access\n"</span>, 0);
04013 
04014             AccessGranted = <a class="code" href="../../d5/d3/filelock_8c.html#a52">FsRtlPrivateCheckForSharedLockAccess</a>(
04015                                 LockQueue,
04016                                 &amp;FileLockInfo );
04017         }
04018 
04019         <span class="comment">//</span>
04020         <span class="comment">//  Now AccessGranted tells us whether we can really get the access</span>
04021         <span class="comment">//  for the range we want</span>
04022         <span class="comment">//</span>
04023 
04024         <span class="keywordflow">if</span> (!AccessGranted) {
04025 
04026             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"We do not have access\n"</span>, 0);
04027 
04028             <span class="comment">//</span>
04029             <span class="comment">//  We cannot read/write to the range, so we cannot take out</span>
04030             <span class="comment">//  the lock.  Now if the user wanted to fail immediately then</span>
04031             <span class="comment">//  we'll complete the Irp, otherwise we'll enqueue this Irp</span>
04032             <span class="comment">//  to the waiting lock queue</span>
04033             <span class="comment">//</span>
04034 
04035             <span class="keywordflow">if</span> (FailImmediately) {
04036 
04037                 <span class="comment">//</span>
04038                 <span class="comment">//  Set our status and return, the finally clause will</span>
04039                 <span class="comment">//  complete the request</span>
04040                 <span class="comment">//</span>
04041 
04042                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"And we fail immediately\n"</span>, 0);
04043 
04044                 Iosb-&gt;Status = STATUS_LOCK_NOT_GRANTED;
04045                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Results = TRUE );
04046 
04047             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Irp)) {
04048 
04049                 <a class="code" href="../../d1/d8/struct__WAITING__LOCK.html">PWAITING_LOCK</a> WaitingLock;
04050 
04051                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"And we enqueue the Irp for later\n"</span>, 0);
04052 
04053                 <span class="comment">//</span>
04054                 <span class="comment">//  Allocate a new waiting record, set it to point to the</span>
04055                 <span class="comment">//  waiting Irp, and insert it in the tail of the waiting</span>
04056                 <span class="comment">//  locks queue</span>
04057                 <span class="comment">//</span>
04058 
04059                 WaitingLock = <a class="code" href="../../d5/d3/filelock_8c.html#a33">FsRtlAllocateWaitingLock</a>();
04060 
04061                 <span class="comment">//</span>
04062                 <span class="comment">//  Simply raise out if we can't allocate.</span>
04063                 <span class="comment">//</span>
04064 
04065                 <span class="keywordflow">if</span> (WaitingLock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04066 
04067                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
04068                 }
04069 
04070                 WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o2">Irp</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
04071                 WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o1">Context</a> = Context;
04072                 <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp );
04073 
04074                 <span class="comment">//</span>
04075                 <span class="comment">// Add WaitingLock WaitingLockQueue</span>
04076                 <span class="comment">//</span>
04077 
04078                 WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o0">Link</a>.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04079                 <span class="keywordflow">if</span> (LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o3">WaitingLocks</a>.Next == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04080 
04081                     <span class="comment">//</span>
04082                     <span class="comment">// Create new list</span>
04083                     <span class="comment">//</span>
04084 
04085                     LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o3">WaitingLocks</a>.Next = &amp;WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o0">Link</a>;
04086                     LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o4">WaitingLocksTail</a>.Next = &amp;WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o0">Link</a>;
04087 
04088                 } <span class="keywordflow">else</span> {
04089 
04090                     <span class="comment">//</span>
04091                     <span class="comment">// Add waiter to tail of list</span>
04092                     <span class="comment">//</span>
04093 
04094                     LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o4">WaitingLocksTail</a>.Next-&gt;Next = &amp;WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o0">Link</a>;
04095                     LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o4">WaitingLocksTail</a>.Next = &amp;WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o0">Link</a>;
04096                 }
04097 
04098 
04099                 <span class="comment">//</span>
04100                 <span class="comment">//  Setup IRP in case it's canceled - then set the</span>
04101                 <span class="comment">//  IRP's cancel routine</span>
04102                 <span class="comment">//</span>
04103 
04104                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = (ULONG_PTR)LockInfo;
04105                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, FsRtlPrivateCancelFileLockIrp );
04106 
04107                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
04108 
04109                     <span class="comment">//</span>
04110                     <span class="comment">// Pull the cancel routine off of the IRP - if it is not</span>
04111                     <span class="comment">// NULL, this means we won the race with IoCancelIrp and</span>
04112                     <span class="comment">// will be responsible for cancelling the IRP synchronously.</span>
04113                     <span class="comment">// If NULL, we lost and our cancel routine is already being</span>
04114                     <span class="comment">// called for us.</span>
04115                     <span class="comment">//</span>
04116                     <span class="comment">// This must be done while holding the lock queue down since</span>
04117                     <span class="comment">// this is how we synchronize with the cancel.</span>
04118                     <span class="comment">//</span>
04119 
04120                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, NULL )) {
04121 
04122                         <span class="comment">//</span>
04123                         <span class="comment">// Irp's cancel routine was not called, do it ourselves.</span>
04124                         <span class="comment">// Indicate to the cancel routine that he does not need</span>
04125                         <span class="comment">// to release the cancel spinlock by passing a NULL DO.</span>
04126                         <span class="comment">//</span>
04127                         <span class="comment">// The queue will be dropped in order to complete the Irp.</span>
04128                         <span class="comment">// We communicate the previous IRQL through the Irp itself.</span>
04129                         <span class="comment">//</span>
04130 
04131                         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> = OldIrql;
04132                         <a class="code" href="../../d5/d3/filelock_8c.html#a50">FsRtlPrivateCancelFileLockIrp</a>( NULL, Irp );
04133                         ReleaseQueue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04134                     }
04135                 }
04136 
04137                 Iosb-&gt;Status = STATUS_PENDING;
04138                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Results = TRUE );
04139 
04140             } <span class="keywordflow">else</span> {
04141 
04142                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Results = FALSE );
04143             }
04144         }
04145 
04146         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"We have access\n"</span>, 0);
04147 
04148         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/filelock_8c.html#a46">FsRtlPrivateInsertLock</a>( LockInfo, FileObject, &amp;FileLockInfo )) {
04149 
04150             <span class="comment">//</span>
04151             <span class="comment">//  Resource exhaustion will cause us to fail here.  Via the fast call, indicate</span>
04152             <span class="comment">//  that it may be worthwhile to go around again via the Irp based path.  If we</span>
04153             <span class="comment">//  are already there, simply raise out.</span>
04154             <span class="comment">//</span>
04155 
04156             <span class="keywordflow">if</span> (ViaFastCall) {
04157 
04158                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Results = FALSE );
04159 
04160             } <span class="keywordflow">else</span> {
04161 
04162                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
04163             }
04164 
04165         } <span class="keywordflow">else</span> {
04166 
04167             Iosb-&gt;Status = STATUS_SUCCESS;
04168         }
04169 
04170         <span class="comment">//</span>
04171         <span class="comment">//  At long last, we're done.</span>
04172         <span class="comment">//</span>
04173 
04174         Results = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04175 
04176     try_exit: NOTHING;
04177     } finally {
04178 
04179         <span class="keywordflow">if</span> (ReleaseQueue) {
04180             
04181             <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
04182         }
04183 
04184         <span class="comment">//</span>
04185         <span class="comment">//  Complete the request provided we were given one and it is not a pending status</span>
04186         <span class="comment">//</span>
04187 
04188         <span class="keywordflow">if</span> (!AbnormalTermination() &amp;&amp; ARGUMENT_PRESENT(Irp) &amp;&amp; (Iosb-&gt;Status != STATUS_PENDING)) {
04189 
04190             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NewStatus;
04191 
04192             <span class="comment">//</span>
04193             <span class="comment">//  We must reference the fileobject for the case that the IRP completion</span>
04194             <span class="comment">//  fails and we need to lift the lock.  Although the only reason we have</span>
04195             <span class="comment">//  to touch the fileobject in the remove case is to unset the LastLock field,</span>
04196             <span class="comment">//  we have no way of knowing if we will race with a reference count drop</span>
04197             <span class="comment">//  and lose.</span>
04198             <span class="comment">//</span>
04199 
04200             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileObject );
04201 
04202             <span class="comment">//</span>
04203             <span class="comment">//  Complete the request, if the don't get back success then</span>
04204             <span class="comment">//  we need to possibly remove the lock that we just</span>
04205             <span class="comment">//  inserted.</span>
04206             <span class="comment">//</span>
04207 
04208             <a class="code" href="../../d5/d3/filelock_8c.html#a11">FsRtlCompleteLockIrp</a>(
04209                 LockInfo,
04210                 Context,
04211                 Irp,
04212                 Iosb-&gt;Status,
04213                 &amp;NewStatus,
04214                 FileObject );
04215 
04216             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NewStatus) &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Iosb-&gt;Status) ) {
04217 
04218                 <span class="comment">//</span>
04219                 <span class="comment">// Irp failed, remove the lock which was added</span>
04220                 <span class="comment">//</span>
04221 
04222                 <a class="code" href="../../d5/d3/filelock_8c.html#a55">FsRtlPrivateRemoveLock</a> (
04223                     LockInfo,
04224                     &amp;FileLockInfo,
04225                     TRUE );
04226             }
04227 
04228             <span class="comment">//</span>
04229             <span class="comment">//  Lift our private reference to the fileobject. This may induce deletion.</span>
04230             <span class="comment">//</span>
04231 
04232             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
04233 
04234             Iosb-&gt;Status = NewStatus;
04235         }
04236 
04237         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlPrivateLock -&gt; %08lx\n"</span>, Results);
04238     }
04239 
04240     <span class="comment">//</span>
04241     <span class="comment">//  and return to our caller</span>
04242     <span class="comment">//</span>
04243 
04244     <span class="keywordflow">return</span> Results;
04245 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="filelock.c::FsRtlPrivateRemoveLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlPrivateRemoveLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LockInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN&nbsp;</td>
          <td class="mdname" nowrap> <em>PFILE_LOCK_INFO</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CheckForWaiters</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l03162">3162</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03589">FsRtlFastUnlockSingleExclusive()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l04722">FsRtlPrivateCheckWaitingLocks()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>.
<p>
<pre class="fragment"><div>03170                    :
03171 
03172     General purpose cleanup routine.  Finds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given lock structure
03173     and removes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock list. Differs from UnlockSingle
03174     <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> in that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> disables <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UnlockRoutine of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileLock and
03175     optionalizes walking <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> waiting locks list.
03176 
03177 Arguments:
03178 
03179     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>'s lock structure supposedly containing a stale lock
03180 
03181     FileLockInfo - Supplies <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock data being freed
03182 
03183     CheckForWaiters - If <span class="keyword">true</span> check <span class="keywordflow">for</span> possible waiting locks, caused
03184         by freeing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locked range
03185 
03186 Return Value:
03187 
03188     None.
03189 
03190 --*/
03191 
03192 {
03193     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03194 
03195     <span class="keywordflow">if</span> (FileLockInfo-&gt;ExclusiveLock) {
03196 
03197         <span class="comment">//</span>
03198         <span class="comment">//  We must find it in the exclusive lock tree</span>
03199         <span class="comment">//</span>
03200 
03201         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/filelock_8c.html#a60">FsRtlFastUnlockSingleExclusive</a>( LockInfo,
03202 
03203                                                  FileLockInfo-&gt;FileObject,
03204                                                  &amp;FileLockInfo-&gt;StartingByte,
03205                                                  &amp;FileLockInfo-&gt;Length,
03206                                                  FileLockInfo-&gt;ProcessId,
03207                                                  FileLockInfo-&gt;Key,
03208 
03209                                                  NULL,
03210                                                  TRUE,
03211                                                  CheckForWaiters );
03212 
03213         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Status == STATUS_SUCCESS);
03214 
03215     } <span class="keywordflow">else</span> {
03216 
03217         <span class="comment">//</span>
03218         <span class="comment">//  We must find it in the shared lock tree</span>
03219         <span class="comment">//</span>
03220 
03221         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/filelock_8c.html#a59">FsRtlFastUnlockSingleShared</a>( LockInfo,
03222 
03223                                               FileLockInfo-&gt;FileObject,
03224                                               &amp;FileLockInfo-&gt;StartingByte,
03225                                               &amp;FileLockInfo-&gt;Length,
03226                                               FileLockInfo-&gt;ProcessId,
03227                                               FileLockInfo-&gt;Key,
03228 
03229                                               NULL,
03230                                               TRUE,
03231                                               CheckForWaiters );
03232 
03233         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Status == STATUS_SUCCESS);
03234     }
03235 
03236     <span class="keywordflow">return</span>;
03237 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="filelock.c::FsRtlPrivateResetLowestLockOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlPrivateResetLowestLockOffset           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LockInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l05150">5150</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00068">_SH_LOCK::LockInfo</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00089">_EX_LOCK::LockInfo</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00008">_LOCKTREE_NODE::Locks</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00166">_LOCK_INFO::LowestLockOffset</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a24">PEX_LOCK</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a20">PLOCKTREE_NODE</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00140">_LOCK_QUEUE::SharedLockTree</a>, and <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00560">_FILE_LOCK_INFO::StartingByte</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l03589">FsRtlFastUnlockSingleExclusive()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>.
<p>
<pre class="fragment"><div>05156                    :
05157 
05158     This routine resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest lock offset hint in a <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">LOCK_INFO</a> to
05159     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest lock offset currently held by a lock inside of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">LOCK_INFO</a>.
05160 
05161 Arguments:
05162 
05163     LockInfo - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock data to operate on
05164 
05165 Return Value:
05166 
05167     None
05168 
05169 --*/
05170 
05171 {
05172     <a class="code" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a> ExLock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05173     <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a> ShLock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05174     <a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a> LowestLockInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05175     PRTL_SPLAY_LINKS SplayLinks;
05176     <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a> Node;
05177 
05178     <span class="comment">//</span>
05179     <span class="comment">//  Fix up the lowest lock offset if we have non-empty trees and there was</span>
05180     <span class="comment">//  a lock in the low 32 bit region</span>
05181     <span class="comment">//</span>
05182 
05183     <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o0">LowestLockOffset</a> != 0xffffffff &amp;&amp;
05184         (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
05185          LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
05186 
05187         <span class="comment">//</span>
05188         <span class="comment">//  Grab the lowest nodes in the trees</span>
05189         <span class="comment">//</span>
05190 
05191         <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>) {
05192 
05193             SplayLinks = LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>;
05194 
05195             <span class="keywordflow">while</span> (RtlLeftChild(SplayLinks) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05196 
05197                 SplayLinks = RtlLeftChild(SplayLinks);
05198             }
05199 
05200             Node = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
05201             ShLock = CONTAINING_RECORD( Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
05202         }
05203 
05204         <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>) {
05205 
05206             SplayLinks = LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>;
05207 
05208             <span class="keywordflow">while</span> (RtlLeftChild(SplayLinks) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05209 
05210                 SplayLinks = RtlLeftChild(SplayLinks);
05211             }
05212 
05213             ExLock = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links );
05214         }
05215 
05216         <span class="comment">//</span>
05217         <span class="comment">//  Figure out which of the lowest locks is actually lowest. We know that one of the lock</span>
05218         <span class="comment">//  trees at least has a lock, so if we have don't have exclusive locks then we do know</span>
05219         <span class="comment">//  we have shared locks ...</span>
05220         <span class="comment">//</span>
05221 
05222         <span class="keywordflow">if</span> (ExLock &amp;&amp;
05223             (!ShLock ||
05224              (ULONGLONG)ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart &lt; (ULONGLONG)ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart)) {
05225 
05226             LowestLockInfo = &amp;ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>;
05227 
05228         } <span class="keywordflow">else</span> {
05229 
05230             LowestLockInfo = &amp;ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>;
05231         }
05232 
05233         <span class="keywordflow">if</span> (LowestLockInfo-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.HighPart == 0) {
05234 
05235             LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o0">LowestLockOffset</a> = LowestLockInfo-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.LowPart;
05236 
05237         } <span class="keywordflow">else</span> {
05238 
05239             LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o0">LowestLockOffset</a> = 0xffffffff;
05240         }
05241 
05242     } <span class="keywordflow">else</span> {
05243 
05244         <span class="comment">//</span>
05245         <span class="comment">//  If there are no locks, set the lock offset high</span>
05246         <span class="comment">//</span>
05247 
05248         LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o0">LowestLockOffset</a> = 0xffffffff;
05249     }
05250 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="filelock.c::FsRtlProcessFileLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlProcessFileLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">1173</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00501">BooleanFlagOn</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02030">_IO_STACK_LOCATION::Flags</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00497">FsRtlCompleteLockIrp</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03770">FsRtlFastUnlockAll()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03814">FsRtlFastUnlockAllByKey()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03241">FsRtlFastUnlockSingle()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07374">IoGetRequestorProcess()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00072">IRP_MJ_LOCK_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00123">IRP_MN_LOCK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00125">IRP_MN_UNLOCK_ALL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00126">IRP_MN_UNLOCK_ALL_BY_KEY</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00124">IRP_MN_UNLOCK_SINGLE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01890">SL_EXCLUSIVE_LOCK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01889">SL_FAIL_IMMEDIATELY</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>.
<p>
<pre class="fragment"><div>01181                    :
01182 
01183     This routine processes a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does either a lock request,
01184     or an unlock request.  It also completes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.  Once called <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user
01185     (i.e., <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> System) has relinquished <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
01186 
01187     If <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not available to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information <span class="keyword">this</span> routine will raise a
01188     status value indicating insufficient resources.
01189 
01190 Arguments:
01191 
01192     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> lock being modified/queried.
01193 
01194     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> being processed.
01195 
01196     Context - Optionally supplies a context to use when calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user
01197         alternate <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> completion routine.
01198 
01199 Return Value:
01200 
01201     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
01202 
01203 --*/
01204 
01205 {
01206     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
01207 
01208     IO_STATUS_BLOCK Iosb;
01209     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01210     LARGE_INTEGER   ByteOffset;
01211 
01212     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlProcessFileLock, FileLock = %08lx\n"</span>, FileLock);
01213 
01214     Iosb.Information = 0;
01215 
01216     <span class="comment">//</span>
01217     <span class="comment">//  Get a pointer to the current Irp stack location and assert that</span>
01218     <span class="comment">//  the major function code is for a lock operation</span>
01219     <span class="comment">//</span>
01220 
01221     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
01222 
01223     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == IRP_MJ_LOCK_CONTROL );
01224 
01225     <span class="comment">//</span>
01226     <span class="comment">//  Now process the different minor lock operations</span>
01227     <span class="comment">//</span>
01228 
01229     <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>) {
01230 
01231     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a52">IRP_MN_LOCK</a>:
01232 
01233         ByteOffset = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.ByteOffset;
01234 
01235         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d8/fsrtl_8h.html#a125">FsRtlPrivateLock</a>( FileLock,
01236                                  IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
01237                                  &amp;ByteOffset,
01238                                  IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.Length,
01239                                  <a class="code" href="../../d0/d5/io_8h.html#a512">IoGetRequestorProcess</a>(Irp),
01240                                  IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.Key,
01241                                  <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>(IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a>, SL_FAIL_IMMEDIATELY),
01242                                  <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>(IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a>, SL_EXCLUSIVE_LOCK),
01243                                  &amp;Iosb,
01244                                  Irp,
01245                                  Context,
01246                                  FALSE );
01247 
01248         <span class="keywordflow">break</span>;
01249 
01250     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a53">IRP_MN_UNLOCK_SINGLE</a>:
01251 
01252         ByteOffset = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.ByteOffset;
01253 
01254         Iosb.Status = <a class="code" href="../../d1/d8/fsrtl_8h.html#a122">FsRtlFastUnlockSingle</a>( FileLock,
01255                                              IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
01256                                              &amp;ByteOffset,
01257                                              IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.Length,
01258                                              <a class="code" href="../../d0/d5/io_8h.html#a512">IoGetRequestorProcess</a>(Irp),
01259                                              IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.Key,
01260                                              Context,
01261                                              FALSE );
01262 
01263         <a class="code" href="../../d5/d3/filelock_8c.html#a11">FsRtlCompleteLockIrp</a>( FileLock, Context, Irp, Iosb.Status, &amp;Status, NULL );
01264         <span class="keywordflow">break</span>;
01265 
01266     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a54">IRP_MN_UNLOCK_ALL</a>:
01267 
01268         Iosb.Status = <a class="code" href="../../d1/d8/fsrtl_8h.html#a123">FsRtlFastUnlockAll</a>( FileLock,
01269                                           IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
01270                                           <a class="code" href="../../d0/d5/io_8h.html#a512">IoGetRequestorProcess</a>(Irp),
01271                                           Context );
01272 
01273         <a class="code" href="../../d5/d3/filelock_8c.html#a11">FsRtlCompleteLockIrp</a>( FileLock, Context, Irp, Iosb.Status, &amp;Status, NULL );
01274         <span class="keywordflow">break</span>;
01275 
01276     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a55">IRP_MN_UNLOCK_ALL_BY_KEY</a>:
01277 
01278         Iosb.Status = <a class="code" href="../../d1/d8/fsrtl_8h.html#a124">FsRtlFastUnlockAllByKey</a>( FileLock,
01279                                                IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
01280                                                <a class="code" href="../../d0/d5/io_8h.html#a512">IoGetRequestorProcess</a>(Irp),
01281                                                IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.Key,
01282                                                Context );
01283 
01284         <a class="code" href="../../d5/d3/filelock_8c.html#a11">FsRtlCompleteLockIrp</a>( FileLock, Context, Irp, Iosb.Status, &amp;Status, NULL );
01285         <span class="keywordflow">break</span>;
01286 
01287     <span class="keywordflow">default</span>:
01288 
01289         <span class="comment">//</span>
01290         <span class="comment">//  For all other minor function codes we say they're invalid and</span>
01291         <span class="comment">//  complete the request.  Note that the IRP has not been marked</span>
01292         <span class="comment">//  pending so this error will be returned directly to the caller.</span>
01293         <span class="comment">//</span>
01294 
01295         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, 1, <span class="stringliteral">"Invalid LockFile Minor Function Code %08lx\n"</span>, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>);
01296 
01297 
01298         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_INVALID_DEVICE_REQUEST );
01299 
01300         Iosb.Status = STATUS_INVALID_DEVICE_REQUEST;
01301         <span class="keywordflow">break</span>;
01302     }
01303 
01304     <span class="comment">//</span>
01305     <span class="comment">//  And return to our caller</span>
01306     <span class="comment">//</span>
01307 
01308     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlProcessFileLock -&gt; %08lx\n"</span>, Iosb.Status);
01309 
01310     <span class="keywordflow">return</span> Iosb.Status;
01311 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="filelock.c::FsRtlSplitLocks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlSplitLocks           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSINGLE_LIST_ENTRY *pStartLink&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER LastShadowedByte&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER GlueOffset&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l02865">2865</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00029">_LOCKTREE_NODE::Extent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00418">FsRtlAllocateLockTreeNode()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00021">_LOCKTREE_NODE::HoleyNode</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00036">_LOCKTREE_NODE::Links</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00008">_LOCKTREE_NODE::Locks</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a20">PLOCKTREE_NODE</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00759">RtlRealSuccessor()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00042">_LOCKTREE_NODE::Tail</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l04343">FsRtlPrivateInsertSharedLock()</a>.
<p>
<pre class="fragment"><div>02873                    :
02874 
02875     This routine examines and possibly splits off shared locks associated
02876     with a node into <span class="keyword">new</span> nodes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock tree. Called from <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> that
02877     have just deleted locks.
02878 
02879     The arguments that supply <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial conditions <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation are
02880     optional <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> known to be holey.
02881 
02882 Arguments:
02883 
02884     ParentNode- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locks are coming from
02885 
02886     pStartLink - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> link address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02887         range of locks in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ParentNode's locklist that need to be checked
02888 
02889     LastShadowedByte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last byte offset that needs to be checked
02890 
02891     GlueOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum offset affected by locks prior to <span class="keyword">this</span>
02892         point in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list
02893 
02894 Return Value:
02895 
02896     BOOLEAN - True <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> split was successful, False otherwise.  The node will
02897         be marked as Holey <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> split could not occur.
02898 
02899 --*/
02900 {
02901     <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a>                <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
02902     <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>          NewNode;
02903     PSINGLE_LIST_ENTRY      Link, *pLink, *NextpLink;
02904     LARGE_INTEGER           MaxOffset, StartOffset, HaltOffset;
02905 
02906     BOOLEAN                 ExtentValid;
02907     BOOLEAN                 FailedHoleySplit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02908 
02909     <span class="comment">//</span>
02910     <span class="comment">//  There are two cases: the node is holey or not.  If the node is holey, at some</span>
02911     <span class="comment">//  point we failed to get resources to complete a split, so despite our caller's</span>
02912     <span class="comment">//  good intentions we need to go over the entire node.</span>
02913     <span class="comment">//</span>
02914 
02915     <span class="keywordflow">if</span> (ParentNode-&gt;HoleyNode) {
02916 
02917         <span class="comment">//</span>
02918         <span class="comment">//  Just move the starting link back to the front.  The maximum offset and</span>
02919         <span class="comment">//  starting offset of the node will be initialized in the loop.  We also turn</span>
02920         <span class="comment">//  off the holey flag, which will be turned on again as appropriate.</span>
02921         <span class="comment">//</span>
02922 
02923         pStartLink = &amp;ParentNode-&gt;Locks.Next;
02924         ParentNode-&gt;HoleyNode = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02925 
02926         HaltOffset.QuadPart = ParentNode-&gt;Extent;
02927 
02928     } <span class="keywordflow">else</span> {
02929 
02930         HaltOffset = *LastShadowedByte;
02931         MaxOffset = *GlueOffset;
02932         StartOffset.QuadPart = 0;
02933 
02934         <span class="keywordflow">if</span> (!ParentNode-&gt;Locks.Next ||
02935             (ULONGLONG)HaltOffset.QuadPart &lt;= (ULONGLONG)MaxOffset.QuadPart) {
02936 
02937             <span class="comment">//</span>
02938             <span class="comment">//  The parent node is not there, doesn't have links associated, or the</span>
02939             <span class="comment">//  last possible byte that is affected by the operation our caller made</span>
02940             <span class="comment">//  is interior to the max extent of all locks still in this node - in</span>
02941             <span class="comment">//  which case there is nothing that needs to be done.</span>
02942             <span class="comment">//</span>
02943 
02944             <span class="keywordflow">return</span>;
02945         }
02946     }
02947 
02948     <span class="comment">//</span>
02949     <span class="comment">//  If the extent of the node is past the last byte affected by whatever</span>
02950     <span class="comment">//  operations were done to this node, we can avoid the linear scan of</span>
02951     <span class="comment">//  the list past that last affected byte since we already know the</span>
02952     <span class="comment">//  extent of the entire list! If it is not (note that it would have to</span>
02953     <span class="comment">//  be equal - by defintion) then we need to recalculate the extents of</span>
02954     <span class="comment">//  all nodes we touch in this operation.</span>
02955     <span class="comment">//</span>
02956 
02957     ExtentValid = (ParentNode-&gt;Extent &gt; (ULONGLONG)HaltOffset.QuadPart);
02958 
02959     <span class="keywordflow">for</span> (pLink = pStartLink;
02960          (Link = *pLink) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02961          pLink = NextpLink) {
02962 
02963         NextpLink = &amp;Link-&gt;Next;
02964 
02965         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = CONTAINING_RECORD( Link, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
02966 
02967         <span class="keywordflow">if</span> (ParentNode-&gt;Locks.Next == *pLink) {
02968 
02969             <span class="comment">//</span>
02970             <span class="comment">//  We're at the first lock in the node, and we know that we're going to leave</span>
02971             <span class="comment">//  at least one lock here. Skip over that lock. We also know that the max</span>
02972             <span class="comment">//  offset must be that locks's ending byte - make sure it is. Note that this</span>
02973             <span class="comment">//  code is *exactly* the same as the update MaxOffset code at the bottom of</span>
02974             <span class="comment">//  the loop.</span>
02975             <span class="comment">//</span>
02976 
02977             MaxOffset.QuadPart = <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.EndingByte.QuadPart;
02978 
02979             <span class="comment">//</span>
02980             <span class="comment">//  Set the starting offset of the node.  This is only an issue for zero length</span>
02981             <span class="comment">//  locks, so that we can figure out what is going on if we split a node and wind</span>
02982             <span class="comment">//  up with some number of "overlapped" zero length locks at the front of the new</span>
02983             <span class="comment">//  node.  We must be able to notice this case, and not think that each needs to</span>
02984             <span class="comment">//  be in a seperate node.</span>
02985             <span class="comment">//</span>
02986 
02987             StartOffset.QuadPart = <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart;
02988 
02989             <span class="comment">//</span>
02990             <span class="comment">//  If extents are invalid we also need to set it in case this turns out to</span>
02991             <span class="comment">//  be the only lock at this node.</span>
02992             <span class="comment">//</span>
02993 
02994             <span class="keywordflow">if</span> (!ExtentValid) {
02995 
02996                 ParentNode-&gt;Extent = (ULONGLONG)MaxOffset.QuadPart;
02997             }
02998 
02999             <span class="keywordflow">continue</span>;
03000         }
03001 
03002         <span class="comment">//</span>
03003         <span class="comment">//  If the lock begins at a byte offset greater than the maximum offset seen to this</span>
03004         <span class="comment">//  point, AND this is not a zero length node starting at the beginning of this node,</span>
03005         <span class="comment">//  break the node.  The second half of the test keeps co-incident zero length locks</span>
03006         <span class="comment">//  in the same node. (zero length lock ---&gt; starting = ending + 1).</span>
03007         <span class="comment">//</span>
03008 
03009         <span class="keywordflow">if</span> ((ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart &gt; (ULONGLONG)MaxOffset.QuadPart &amp;&amp;
03010             !(<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.Length.QuadPart == 0 &amp;&amp;
03011               <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart == StartOffset.QuadPart)) {
03012 
03013             <span class="comment">//</span>
03014             <span class="comment">//  Break the node up here</span>
03015             <span class="comment">//</span>
03016 
03017             NewNode = <a class="code" href="../../d5/d3/filelock_8c.html#a34">FsRtlAllocateLockTreeNode</a>();
03018 
03019             <span class="keywordflow">if</span> (NewNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03020 
03021                 <span class="comment">//</span>
03022                 <span class="comment">//  If we are out of resources, this node is now holey - we know that the locks at</span>
03023                 <span class="comment">//  this node do not completely cover the indicated range.  Keep splitting for two</span>
03024                 <span class="comment">//  reasons: more resources may become avaliable, and we must keep updating the</span>
03025                 <span class="comment">//  node's extent if it is known to be invalid.</span>
03026                 <span class="comment">//</span>
03027 
03028                 <span class="comment">//</span>
03029                 <span class="comment">//  Now if this node was already holey it is not possible to state that, if we</span>
03030                 <span class="comment">//  manage to split if further as we keep walking, that the resulting "left" node</span>
03031                 <span class="comment">//  is not holey.  See below.</span>
03032                 <span class="comment">//</span>
03033 
03034                 <span class="keywordflow">if</span> (ParentNode-&gt;HoleyNode) {
03035 
03036                     FailedHoleySplit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03037                 }
03038 
03039                 ParentNode-&gt;HoleyNode = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03040 
03041             } <span class="keywordflow">else</span> {
03042 
03043                 <span class="comment">//</span>
03044                 <span class="comment">//  Initialize the node.</span>
03045                 <span class="comment">//</span>
03046 
03047                 RtlInitializeSplayLinks(&amp;NewNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o3">Links</a>);
03048                 NewNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o1">HoleyNode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03049 
03050                 <span class="comment">//</span>
03051                 <span class="comment">//  Find the spot in the tree to take the new node(s). If the current node has</span>
03052                 <span class="comment">//  a free right child, we use it, else find the successor node and use its</span>
03053                 <span class="comment">//  left child. One of these cases must be avaliable since we know there are</span>
03054                 <span class="comment">//  no nodes between this node and its successor.</span>
03055                 <span class="comment">//</span>
03056 
03057                 <span class="keywordflow">if</span> (RtlRightChild(&amp;ParentNode-&gt;Links) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03058 
03059                     RtlInsertAsRightChild(&amp;ParentNode-&gt;Links, &amp;NewNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o3">Links</a>);
03060 
03061                 } <span class="keywordflow">else</span> {
03062 
03063                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RtlLeftChild(<a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(&amp;ParentNode-&gt;Links)) == NULL);
03064                     RtlInsertAsLeftChild(<a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(&amp;ParentNode-&gt;Links), &amp;NewNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o3">Links</a>);
03065                 }
03066 
03067                 <span class="comment">//</span>
03068                 <span class="comment">//  Move the remaining locks over to the new node and fix up extents</span>
03069                 <span class="comment">//</span>
03070 
03071                 NewNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next = *pLink;
03072                 *pLink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03073 
03074                 NewNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o4">Tail</a>.Next = ParentNode-&gt;Tail.Next;
03075                 ParentNode-&gt;Tail.Next = CONTAINING_RECORD( pLink, SINGLE_LIST_ENTRY, Next );
03076 
03077                 <span class="comment">//</span>
03078                 <span class="comment">//  This will cause us to fall into the first-lock clause above on the next pass</span>
03079                 <span class="comment">//</span>
03080 
03081                 NextpLink = &amp;NewNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next;
03082 
03083                 <span class="comment">//</span>
03084                 <span class="comment">// The new node's extent is now copied from the parent. The old node's extent must be</span>
03085                 <span class="comment">// the maximum offset we have seen to this point.</span>
03086                 <span class="comment">//</span>
03087                 <span class="comment">// Note that if ExtentValid is true, that must mean that the lock ending at that extent</span>
03088                 <span class="comment">// is in the new node since if it was in the old node we wouldn't have been able to split.</span>
03089                 <span class="comment">//</span>
03090 
03091                 NewNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o2">Extent</a> = ParentNode-&gt;Extent;
03092                 ParentNode-&gt;Extent = (ULONGLONG)MaxOffset.QuadPart;
03093 
03094                 <span class="comment">//</span>
03095                 <span class="comment">//  The parent node can no longer be holey if we have not failed a split in this node.</span>
03096                 <span class="comment">//</span>
03097 
03098                 <span class="keywordflow">if</span> (!FailedHoleySplit) {
03099 
03100                     ParentNode-&gt;HoleyNode = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03101 
03102                 } <span class="keywordflow">else</span> {
03103 
03104                     <span class="comment">//</span>
03105                     <span class="comment">//  So reset the failure flag for the new node.</span>
03106                     <span class="comment">//</span>
03107 
03108                     FailedHoleySplit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03109                 }
03110 
03111                 <span class="comment">//</span>
03112                 <span class="comment">//  Move over to the new node.</span>
03113                 <span class="comment">//</span>
03114 
03115                 ParentNode = NewNode;
03116 
03117                 <span class="keywordflow">continue</span>;
03118             }
03119         }
03120 
03121         <span class="keywordflow">if</span> (ExtentValid &amp;&amp;
03122             (ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.StartingByte.QuadPart &gt; (ULONGLONG)HaltOffset.QuadPart) {
03123 
03124             <span class="comment">//</span>
03125             <span class="comment">//  Our extents are good and this lock is past the shadow, so we can stop</span>
03126             <span class="comment">//</span>
03127 
03128             <span class="keywordflow">return</span>;
03129         }
03130 
03131         <span class="keywordflow">if</span> ((ULONGLONG)MaxOffset.QuadPart &lt; (ULONGLONG)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.EndingByte.QuadPart) {
03132 
03133             <span class="comment">//</span>
03134             <span class="comment">//  Update maximum offset</span>
03135             <span class="comment">//</span>
03136 
03137             MaxOffset.QuadPart = <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>-&gt;LockInfo.EndingByte.QuadPart;
03138 
03139             <span class="keywordflow">if</span> (!ExtentValid) {
03140 
03141                 <span class="comment">//</span>
03142                 <span class="comment">//  Extents are not good so we must update the extent</span>
03143                 <span class="comment">//</span>
03144 
03145                 ParentNode-&gt;Extent = (ULONGLONG)MaxOffset.QuadPart;
03146             }
03147         }
03148     }
03149 
03150     <span class="comment">//</span>
03151     <span class="comment">//  Reached the end of the list, so update the extent (case of all subsequent locks</span>
03152     <span class="comment">//  having been interior to GlueOffset)</span>
03153     <span class="comment">//</span>
03154 
03155     ParentNode-&gt;Extent = (ULONGLONG)MaxOffset.QuadPart;
03156 
03157     <span class="keywordflow">return</span>;
03158 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="filelock.c::FsRtlSplitLocks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlSplitLocks           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSINGLE_LIST_ENTRY *&nbsp;</td>
          <td class="mdname" nowrap> <em>pStartLink</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>LastShadowedByte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>GlueOffset</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="filelock.c::FsRtlUninitializeFileLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlUninitializeFileLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileLock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">995</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00112">_WAITING_LOCK::Context</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00481">FsRtlAcquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00497">FsRtlCompleteLockIrp</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00446">FsRtlFreeExclusiveLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00473">FsRtlFreeLockInfo()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00464">FsRtlFreeLockTreeNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00437">FsRtlFreeSharedLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00455">FsRtlFreeWaitingLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00100">IoAcquireCancelSpinLock()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00118">_WAITING_LOCK::Irp</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00036">_LOCKTREE_NODE::Links</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00083">_EX_LOCK::Links</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00008">_LOCKTREE_NODE::Locks</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a24">PEX_LOCK</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a20">PLOCKTREE_NODE</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a26">PWAITING_LOCK</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00502">RtlDeleteNoSplay()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00140">_LOCK_QUEUE::SharedLockTree</a>, and <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00142">_LOCK_QUEUE::WaitingLocks</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01162">FsRtlFreeFileLock()</a>.
<p>
<pre class="fragment"><div>01001                    :
01002 
01003     This routine uninitializes a <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a> structure.  After calling <span class="keyword">this</span>
01004     routine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> lock must be reinitialized before being used again.
01005 
01006     This routine will free all files locks and completes any outstanding
01007     lock requests as a result of cleaning itself up.
01008 
01009 Arguments:
01010 
01011     FileLock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a> struture being
01012         decommissioned.
01013 
01014 Return Value:
01015 
01016     None.
01017 
01018 --*/
01019 
01020 {
01021     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>          LockInfo;
01022     <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a>            ShLock;
01023     <a class="code" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a>            ExLock;
01024     PSINGLE_LIST_ENTRY  Link;
01025     <a class="code" href="../../d1/d8/struct__WAITING__LOCK.html">PWAITING_LOCK</a>       WaitingLock;
01026     <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>      LockTreeNode;
01027     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>                <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
01028     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            NewStatus;
01029     KIRQL               OldIrql;
01030     PKPRCB              Prcb;
01031 
01032     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlUninitializeFileLock, FileLock = %08lx\n"</span>, FileLock);
01033 
01034     <span class="keywordflow">if</span> ((LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01035         <span class="keywordflow">return</span> ;
01036     }
01037 
01038     <span class="comment">//</span>
01039     <span class="comment">//  Lock the queue</span>
01040     <span class="comment">//</span>
01041 
01042     <a class="code" href="../../d5/d3/filelock_8c.html#a8">FsRtlAcquireLockQueue</a>(&amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>, &amp;OldIrql);
01043 
01044     <span class="comment">//</span>
01045     <span class="comment">//  Free lock trees</span>
01046     <span class="comment">//</span>
01047 
01048     <span class="keywordflow">while</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01049 
01050         LockTreeNode = CONTAINING_RECORD(LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links);
01051 
01052         <span class="comment">//</span>
01053         <span class="comment">//  Remove all locks associated with the root node</span>
01054         <span class="comment">//</span>
01055 
01056         <span class="keywordflow">while</span> (LockTreeNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01057             Link = PopEntryList (&amp;LockTreeNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>);
01058             ShLock = CONTAINING_RECORD( Link, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
01059 
01060             <a class="code" href="../../d5/d3/filelock_8c.html#a36">FsRtlFreeSharedLock</a>(ShLock);
01061         }
01062 
01063         <span class="comment">//</span>
01064         <span class="comment">//  Slice off the root node of the tree</span>
01065         <span class="comment">//</span>
01066 
01067         <a class="code" href="../../d3/d4/splay_8c.html#a5">RtlDeleteNoSplay</a>(&amp;LockTreeNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o3">Links</a>, &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>);
01068 
01069         <a class="code" href="../../d5/d3/filelock_8c.html#a39">FsRtlFreeLockTreeNode</a>(LockTreeNode);
01070     }
01071 
01072     <span class="keywordflow">while</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01073 
01074         ExLock = CONTAINING_RECORD(LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links);
01075 
01076         <a class="code" href="../../d3/d4/splay_8c.html#a5">RtlDeleteNoSplay</a>(&amp;ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o0">Links</a>, &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>);
01077 
01078         <a class="code" href="../../d5/d3/filelock_8c.html#a37">FsRtlFreeExclusiveLock</a>(ExLock);
01079     }
01080 
01081     <span class="comment">//</span>
01082     <span class="comment">//  Free WaitingLockQueue</span>
01083     <span class="comment">//</span>
01084 
01085     <span class="keywordflow">while</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o3">WaitingLocks</a>.Next != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01086 
01087         Link = PopEntryList( &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o3">WaitingLocks</a> );
01088         WaitingLock = CONTAINING_RECORD( Link, <a class="code" href="../../d1/d8/struct__WAITING__LOCK.html">WAITING_LOCK</a>, Link );
01089 
01090         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o2">Irp</a>;
01091 
01092         <span class="comment">//</span>
01093         <span class="comment">//  To complete an irp in the waiting queue we need to</span>
01094         <span class="comment">//  void the cancel routine (protected by a spinlock) before</span>
01095         <span class="comment">//  we can complete the irp</span>
01096         <span class="comment">//</span>
01097 
01098         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a> (&amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>, OldIrql);
01099 
01100         <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01101         <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, NULL );
01102         <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01103 
01104         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
01105 
01106         <a class="code" href="../../d5/d3/filelock_8c.html#a11">FsRtlCompleteLockIrp</a>(
01107              LockInfo,
01108              WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o1">Context</a>,
01109              Irp,
01110              STATUS_RANGE_NOT_LOCKED,
01111              &amp;NewStatus,
01112              NULL );
01113 
01114         <a class="code" href="../../d5/d3/filelock_8c.html#a8">FsRtlAcquireLockQueue</a>(&amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>, &amp;OldIrql);
01115         <a class="code" href="../../d5/d3/filelock_8c.html#a38">FsRtlFreeWaitingLock</a>( WaitingLock );
01116     }
01117 
01118     <span class="comment">//</span>
01119     <span class="comment">// Free pool used to track the lock info on this file</span>
01120     <span class="comment">//</span>
01121 
01122     <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>( &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>, OldIrql );
01123     <a class="code" href="../../d5/d3/filelock_8c.html#a40">FsRtlFreeLockInfo</a>( LockInfo );
01124 
01125     <span class="comment">//</span>
01126     <span class="comment">// Unlink LockInfo from FileLock</span>
01127     <span class="comment">//</span>
01128 
01129     FileLock-&gt;LockInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01130 
01131     <span class="comment">//</span>
01132     <span class="comment">//  And return to our caller</span>
01133     <span class="comment">//</span>
01134 
01135     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlUninitializeFileLock -&gt; VOID\n"</span>, 0 );
01136     <span class="keywordflow">return</span>;
01137 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a12" doxytag="filelock.c::FsRtlCreateLockInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d5/d3/filelock_8c.html#a12">FsRtlCreateLockInfo</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00119">119</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00888">FsRtlPrivateInitializeFileLock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="filelock.c::FsRtlExclusiveLockLookasideList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d5/d3/filelock_8c.html#a14">FsRtlExclusiveLockLookasideList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00132">132</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00400">FsRtlAllocateExclusiveLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00446">FsRtlFreeExclusiveLock()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="filelock.c::FsRtlFileLockLookasideList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d5/d3/filelock_8c.html#a18">FsRtlFileLockLookasideList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00137">137</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01141">FsRtlAllocateFileLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01162">FsRtlFreeFileLock()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="filelock.c::FsRtlLockInfoLookasideList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d5/d3/filelock_8c.html#a17">FsRtlLockInfoLookasideList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00135">135</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00427">FsRtlAllocateLockInfo()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00473">FsRtlFreeLockInfo()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="filelock.c::FsRtlLockTreeNodeLookasideList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d5/d3/filelock_8c.html#a16">FsRtlLockTreeNodeLookasideList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00134">134</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00418">FsRtlAllocateLockTreeNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00464">FsRtlFreeLockTreeNode()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="filelock.c::FsRtlSharedLockLookasideList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d5/d3/filelock_8c.html#a13">FsRtlSharedLockLookasideList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00131">131</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00391">FsRtlAllocateSharedLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00437">FsRtlFreeSharedLock()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="filelock.c::FsRtlWaitingLockLookasideList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d5/d3/filelock_8c.html#a15">FsRtlWaitingLockLookasideList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00133">133</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00409">FsRtlAllocateWaitingLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00455">FsRtlFreeWaitingLock()</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
