<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: acceschk.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>acceschk.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d6/d2/acceschk_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/acceschk_8c.html#a1">MiAccessCheck</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN BOOLEAN WriteOperation, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, IN ULONG Protection, IN BOOLEAN CallerHoldsPfnLock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/acceschk_8c.html#a2">MiCheckForUserStackOverflow</a> (IN PVOID FaultingAddress)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>CCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/acceschk_8c.html#a0">MmReadWrite</a> [32]</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="acceschk.c::MiAccessCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiAccessCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteOperation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Protection</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CallerHoldsPfnLock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/acceschk_8c-source.html#l00042">42</a> of file <a class="el" href="../../d6/d2/acceschk_8c-source.html">acceschk.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01302">KeIsAttachedProcess</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05700">MiHighestUserPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00143">MM_GUARD_PAGE</a>, <a class="el" href="../../d6/d2/acceschk_8c-source.html#l00035">MmReadWrite</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d4/d8/mi_8h.html#a439">PMMPFN</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01446">MiResolveProtoPteFault()</a>, and <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>.
<p>
<pre class="fragment"><div>00052                    :
00053 
00054 
00055 
00056 Arguments:
00057 
00058     PointerPte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE which caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00059                  page fault.
00060 
00061     WriteOperation - Supplies 1 <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a write, 0 <span class="keywordflow">if</span>
00062                      <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a read.
00063 
00064     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous mode, one of <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> or <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>.
00065 
00066     Protection - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection mask to check.
00067 
00068     CallerHoldsPfnLock - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00069 
00070 Return Value:
00071 
00072     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00073 
00074 Environment:
00075 
00076     Kernel mode, APCs disabled.
00077 
00078 --*/
00079 
00080 {
00081     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00082     KIRQL OldIrql;
00083     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00084 
00085     <span class="comment">//</span>
00086     <span class="comment">// Check to see if the owner bit allows access to the previous mode.</span>
00087     <span class="comment">// Access is not allowed if the owner is kernel and the previous</span>
00088     <span class="comment">// mode is user.  Access is also disallowed if the write operation</span>
00089     <span class="comment">// is true and the write field in the PTE is false.</span>
00090     <span class="comment">//</span>
00091 
00092     <span class="comment">//</span>
00093     <span class="comment">// If both an access violation and a guard page violation could</span>
00094     <span class="comment">// occur for the page, the access violation must be returned.</span>
00095     <span class="comment">//</span>
00096 
00097     <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00098         <span class="keywordflow">if</span> (PointerPte &gt; <a class="code" href="../../d4/d8/mi_8h.html#a755">MiHighestUserPte</a>) {
00099             <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00100         }
00101     }
00102 
00103     PteContents = *PointerPte;
00104 
00105     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00106 
00107         <span class="comment">//</span>
00108         <span class="comment">// Valid pages cannot be guard page violations.</span>
00109         <span class="comment">//</span>
00110 
00111         <span class="keywordflow">if</span> (WriteOperation) {
00112             <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 1) ||
00113                 (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite == 1)) {
00114                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00115             } <span class="keywordflow">else</span> {
00116                 <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00117             }
00118         } <span class="keywordflow">else</span> {
00119             <span class="keywordflow">return</span> STATUS_SUCCESS;
00120         }
00121 
00122     } <span class="keywordflow">else</span> {
00123 
00124         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d3/acceschk_8c.html#a0">MmReadWrite</a>[Protection] - (CCHAR)WriteOperation) &lt; 10) {
00125             <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00126         } <span class="keywordflow">else</span> {
00127 
00128             <span class="comment">//</span>
00129             <span class="comment">// Check for a guard page fault.</span>
00130             <span class="comment">//</span>
00131 
00132             <span class="keywordflow">if</span> (Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>) {
00133 
00134                 <span class="comment">//</span>
00135                 <span class="comment">// If this thread is attached to a different process,</span>
00136                 <span class="comment">// return an access violation rather than a guard</span>
00137                 <span class="comment">// page exception.  The prevents problems with unwanted</span>
00138                 <span class="comment">// stack expansion and unexpected guard page behavior</span>
00139                 <span class="comment">// from debuggers.</span>
00140 
00141                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a25">KeIsAttachedProcess</a>()) {
00142                     <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00143                 }
00144 
00145                 <span class="comment">//</span>
00146                 <span class="comment">// Check to see if this is a transition PTE, if so,</span>
00147                 <span class="comment">// the PFN database original contents field needs to be</span>
00148                 <span class="comment">// updated.</span>
00149                 <span class="comment">//</span>
00150 
00151                 <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) &amp;&amp;
00152                     (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0)) {
00153 
00154                     <span class="comment">//</span>
00155                     <span class="comment">// Acquire the PFN mutex and check to see if the</span>
00156                     <span class="comment">// PTE is still in the transition state, and, if so</span>
00157                     <span class="comment">// update the original PTE in the pfn database.</span>
00158                     <span class="comment">//</span>
00159 
00160                     <span class="keywordflow">if</span> (CallerHoldsPfnLock == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00161                         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00162                     }
00163                     PteContents = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
00164                     <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) &amp;&amp;
00165                         (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0)) {
00166 
00167                         <span class="comment">//</span>
00168                         <span class="comment">// Still in transition, update the PFN database.</span>
00169                         <span class="comment">//</span>
00170 
00171                         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (
00172                                     PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
00173 
00174                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 0);
00175                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection =
00176                                                   Protection &amp; ~<a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>;
00177                     }
00178                     <span class="keywordflow">if</span> (CallerHoldsPfnLock == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00179                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00180                     }
00181                 }
00182 
00183                 PointerPte-&gt;u.Soft.Protection = Protection &amp; ~<a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>;
00184 
00185                 <span class="keywordflow">return</span> STATUS_GUARD_PAGE_VIOLATION;
00186             }
00187             <span class="keywordflow">return</span> STATUS_SUCCESS;
00188         }
00189     }
00190 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="acceschk.c::MiCheckForUserStackOverflow" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FASTCALL MiCheckForUserStackOverflow           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FaultingAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/acceschk_8c-source.html#l00194">194</a> of file <a class="el" href="../../d6/d2/acceschk_8c-source.html">acceschk.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00057">ExpDefaultErrorPortProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02598">_MMLOCK_CONFLICT::List</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00078">MmExtendedCommit</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00995">MmLockConflictList</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d4/d8/mi_8h.html#a516">PMMLOCK_CONFLICT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02599">_MMLOCK_CONFLICT::Thread</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>.
<p>
<pre class="fragment"><div>00200                    :
00201 
00202     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> faulting address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within
00203     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack limits and <span class="keywordflow">if</span> so tries to create another guard
00204     page on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> stack over flow <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00205     creation of a <span class="keyword">new</span> guard page fails or <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in
00206     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following form:
00207 
00208 
00209     stack   +----------------+
00210     growth  |                |  StackBase
00211       |     +----------------+
00212       v     |                |
00213             |   allocated    |
00214             |                |
00215             |    ...         |
00216             |                |
00217             +----------------+
00218             | old guard page | &lt;- faulting address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <span class="keyword">this</span> page.
00219             +----------------+
00220             |                |
00221             +----------------+
00222             |                | last page of stack (always no access)
00223             +----------------+
00224 
00225     In <span class="keyword">this</span> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> committed, but
00226     not as a guard page and a STACK_OVERFLOW condition <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00227 
00228 Arguments:
00229 
00230     FaultingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page which
00231                       was a guard page.
00232 
00233 Return Value:
00234 
00235     None.
00236 
00237 Environment:
00238 
00239     Kernel mode. No mutexes held.
00240 
00241 --*/
00242 
00243 {
00244     PTEB Teb;
00245     ULONG_PTR NextPage;
00246     SIZE_T RegionSize;
00247     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00248     KIRQL OldIrql;
00249     <a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html">PMMLOCK_CONFLICT</a> Next;
00250     PVOID DeallocationStack;
00251     PVOID *StackLimit;
00252 
00253 <span class="preprocessor">#if defined(WX86) || defined(_AXP64_)</span>
00254 <span class="preprocessor"></span>    PWX86TIB  Wx86Tib;
00255 <span class="preprocessor">#endif</span>
00256 <span class="preprocessor"></span><span class="preprocessor">#if defined(_WIN64)</span>
00257 <span class="preprocessor"></span>    PTEB32 Teb32;
00258 <span class="preprocessor">#endif</span>
00259 <span class="preprocessor"></span>
00260     <span class="comment">//</span>
00261     <span class="comment">// Make sure we are not recursing with the address space or</span>
00262     <span class="comment">// working set lock held.</span>
00263     <span class="comment">//</span>
00264 
00265     <span class="keywordflow">if</span> (!IsListEmpty (&amp;MmLockConflictList)) {
00266         ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
00267         Next = (<a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html">PMMLOCK_CONFLICT</a>)<a class="code" href="../../d4/d8/mi_8h.html#a433">MmLockConflictList</a>.Flink;
00268 
00269         <span class="keywordflow">while</span> ((PVOID)Next != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a433">MmLockConflictList</a>) {
00270 
00271             <span class="keywordflow">if</span> (Next-&gt;<a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html#o1">Thread</a> == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()) {
00272                 ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
00273                 <span class="keywordflow">return</span> STATUS_GUARD_PAGE_VIOLATION;
00274             }
00275             Next = (<a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html">PMMLOCK_CONFLICT</a>)Next-&gt;<a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html#o0">List</a>.Flink;
00276         }
00277         ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
00278     }
00279 
00280     <span class="comment">//</span>
00281     <span class="comment">// Create an exception handler as the TEB is within the user's</span>
00282     <span class="comment">// address space.</span>
00283     <span class="comment">//</span>
00284 
00285     <span class="keywordflow">try</span> {
00286 
00287         Teb = NtCurrentTeb();
00288 
00289 <span class="preprocessor">#if defined(_IA64_)</span>
00290 <span class="preprocessor"></span>
00291       <span class="keywordflow">if</span> ((Teb-&gt;NtTib.StackBase &lt;= FaultingAddress) &amp;&amp;
00292           (Teb-&gt;DeallocationBStore &gt; FaultingAddress)) {
00293 
00294         <span class="comment">//</span>
00295         <span class="comment">// check to see if the faulting address is within</span>
00296         <span class="comment">// the bstore limits and if so tries to create another guard</span>
00297         <span class="comment">// page on the bstore.</span>
00298         <span class="comment">//</span>
00299         <span class="comment">//</span>
00300         <span class="comment">//          +----------------+</span>
00301         <span class="comment">//          |                | last page of stack (always no access)</span>
00302         <span class="comment">//          +----------------+</span>
00303         <span class="comment">//          |                |</span>
00304         <span class="comment">//          |                |</span>
00305         <span class="comment">//          |                |</span>
00306         <span class="comment">//          +----------------+</span>
00307         <span class="comment">//          | old guard page | &lt;- faulting address is in this page.               |</span>
00308         <span class="comment">//          +----------------+</span>
00309         <span class="comment">//  bstore  |                |</span>
00310         <span class="comment">//  growth  |    ......      |</span>
00311         <span class="comment">//          |                |</span>
00312         <span class="comment">//    ^     |   allocated    |</span>
00313         <span class="comment">//    |     |                |  StackBase</span>
00314         <span class="comment">//          +----------------+</span>
00315         <span class="comment">//</span>
00316         <span class="comment">//</span>
00317 
00318         NextPage = (ULONG_PTR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(FaultingAddress) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00319 
00320         RegionSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00321 
00322         <span class="keywordflow">if</span> ((NextPage + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &gt;= (ULONG_PTR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Teb-&gt;DeallocationBStore)) {
00323 
00324             <span class="comment">//</span>
00325             <span class="comment">// There is no more room for expansion, attempt to</span>
00326             <span class="comment">// commit the page before the last page of the</span>
00327             <span class="comment">// stack.</span>
00328             <span class="comment">//</span>
00329 
00330             NextPage = (ULONG_PTR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Teb-&gt;DeallocationBStore) - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00331 
00332             status = ZwAllocateVirtualMemory (NtCurrentProcess(),
00333                                               (PVOID *)&amp;NextPage,
00334                                               0,
00335                                               &amp;RegionSize,
00336                                               MEM_COMMIT,
00337                                               PAGE_READWRITE);
00338             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00339                 Teb-&gt;BStoreLimit = (PVOID)( (PUCHAR)NextPage);
00340             }
00341 
00342             <span class="keywordflow">return</span> STATUS_STACK_OVERFLOW;
00343         }
00344 
00345         Teb-&gt;BStoreLimit = (PVOID)((PUCHAR)(NextPage));
00346 
00347       } <span class="keywordflow">else</span> {
00348 
00349 <span class="preprocessor">#endif</span>
00350 <span class="preprocessor"></span>
00351         DeallocationStack = Teb-&gt;DeallocationStack;
00352         StackLimit = &amp;Teb-&gt;NtTib.StackLimit;
00353 
00354         <span class="comment">//</span>
00355         <span class="comment">// The stack base and the stack limit are both within the stack.</span>
00356         <span class="comment">//</span>
00357 
00358         <span class="keywordflow">if</span> ((Teb-&gt;NtTib.StackBase &lt;= FaultingAddress) ||
00359             (DeallocationStack &gt; FaultingAddress)) {
00360 
00361 <span class="preprocessor">#if defined(WX86)</span>
00362 <span class="preprocessor"></span>            <span class="comment">//</span>
00363             <span class="comment">// Also check the Wx86 i386 stack on risc.</span>
00364             <span class="comment">//</span>
00365             Wx86Tib = Teb-&gt;Vdm;
00366             <span class="keywordflow">if</span> (Wx86Tib) {
00367                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Wx86Tib, <span class="keyword">sizeof</span>(WX86TIB), <span class="keyword">sizeof</span>(ULONG));
00368                 <span class="keywordflow">if</span> (Wx86Tib-&gt;Size == <span class="keyword">sizeof</span>(WX86TIB) &amp;&amp;
00369                     Wx86Tib-&gt;StackBase &gt; FaultingAddress &amp;&amp;
00370                     Wx86Tib-&gt;DeallocationStack &lt;= FaultingAddress) {
00371 
00372                     DeallocationStack = Wx86Tib-&gt;DeallocationStack;
00373                     StackLimit = &amp;Wx86Tib-&gt;StackLimit;
00374                 } <span class="keywordflow">else</span> {
00375                     <span class="comment">//</span>
00376                     <span class="comment">// Not within the stack.</span>
00377                     <span class="comment">//</span>
00378 
00379                     <span class="keywordflow">return</span> STATUS_GUARD_PAGE_VIOLATION;
00380                 }
00381             } <span class="keywordflow">else</span>
00382 <span class="preprocessor">#endif</span>
00383 <span class="preprocessor"></span><span class="preprocessor">#if defined(_WIN64)</span>
00384 <span class="preprocessor"></span>            <span class="comment">//</span>
00385             <span class="comment">// Also check for the 32-bit native stack on NT64</span>
00386             <span class="comment">//</span>
00387             <span class="keywordflow">if</span> ((Teb32 = (PTEB32)Teb-&gt;NtTib.ExceptionList) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00388                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Teb32, <span class="keyword">sizeof</span>(TEB32), <span class="keyword">sizeof</span>(ULONG));
00389                 <span class="keywordflow">if</span> ((ULONG_PTR)Teb32-&gt;NtTib.StackBase &gt; (ULONG_PTR)FaultingAddress &amp;&amp;
00390                     (ULONG_PTR)Teb32-&gt;DeallocationStack &lt;= (ULONG_PTR)FaultingAddress) {
00391                     DeallocationStack = (PVOID)ULongToPtr(Teb32-&gt;DeallocationStack);
00392 
00393                     StackLimit = (PVOID *)&amp;Teb32-&gt;NtTib.StackLimit;
00394                 } <span class="keywordflow">else</span>
00395 <span class="preprocessor">#if defined(_AXP64_)</span>
00396 <span class="preprocessor"></span>                <span class="comment">//</span>
00397                 <span class="comment">// Also check the Wx86 i386 stack on risc.</span>
00398                 <span class="comment">//</span>
00399                 <span class="keywordflow">if</span> (Wx86Tib = (PWX86TIB)ULongToPtr(Teb32-&gt;Vdm)) {
00400                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Wx86Tib, <span class="keyword">sizeof</span>(WX86TIB), <span class="keyword">sizeof</span>(ULONG));
00401                     <span class="keywordflow">if</span> (Wx86Tib-&gt;Size == <span class="keyword">sizeof</span>(WX86TIB) &amp;&amp;
00402                         (ULONG_PTR)Wx86Tib-&gt;StackBase &gt; (ULONG_PTR)FaultingAddress &amp;&amp;
00403                         (ULONG_PTR)Wx86Tib-&gt;DeallocationStack &lt;= (ULONG_PTR)FaultingAddress) {
00404 
00405                         DeallocationStack = Wx86Tib-&gt;DeallocationStack;
00406                         StackLimit = (PVOID *)(&amp;Wx86Tib-&gt;StackLimit);
00407                     } <span class="keywordflow">else</span> {
00408                         <span class="comment">//</span>
00409                         <span class="comment">// Not within the stack.</span>
00410                         <span class="comment">//</span>
00411 
00412                         <span class="keywordflow">return</span> STATUS_GUARD_PAGE_VIOLATION;
00413                     }
00414                 } <span class="keywordflow">else</span>
00415 <span class="preprocessor">#endif</span>
00416 <span class="preprocessor"></span>                {
00417                     <span class="comment">//</span>
00418                     <span class="comment">// Not within the stack.</span>
00419                     <span class="comment">//</span>
00420 
00421                     <span class="keywordflow">return</span> STATUS_GUARD_PAGE_VIOLATION;
00422                 }
00423             } <span class="keywordflow">else</span>
00424 <span class="preprocessor">#endif</span>
00425 <span class="preprocessor"></span>              {
00426                 <span class="comment">//</span>
00427                 <span class="comment">// Not within the stack.</span>
00428                 <span class="comment">//</span>
00429 
00430                 <span class="keywordflow">return</span> STATUS_GUARD_PAGE_VIOLATION;
00431             }
00432         }
00433 
00434         <span class="comment">//</span>
00435         <span class="comment">// This address is within the current stack, check to see</span>
00436         <span class="comment">// if there is ample room for another guard page and</span>
00437         <span class="comment">// if so attempt to commit a new guard page.</span>
00438         <span class="comment">//</span>
00439 
00440         NextPage = ((ULONG_PTR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(FaultingAddress) - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00441 
00442         RegionSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00443 
00444         <span class="keywordflow">if</span> ((NextPage - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &lt;= (ULONG_PTR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(DeallocationStack)) {
00445 
00446             <span class="comment">//</span>
00447             <span class="comment">// There is no more room for expansion, attempt to</span>
00448             <span class="comment">// commit the page before the last page of the</span>
00449             <span class="comment">// stack.</span>
00450             <span class="comment">//</span>
00451 
00452             NextPage = (ULONG_PTR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(DeallocationStack) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00453 
00454             status = ZwAllocateVirtualMemory (NtCurrentProcess(),
00455                                               (PVOID *)&amp;NextPage,
00456                                               0,
00457                                               &amp;RegionSize,
00458                                               MEM_COMMIT,
00459                                               PAGE_READWRITE);
00460             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00461 
00462 <span class="preprocessor">#if defined(_WIN64)</span>
00463 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Teb32) {
00464                     <span class="comment">// update the 32-bit stacklimit</span>
00465                     *(ULONG *)StackLimit = PtrToUlong((PUCHAR)NextPage);
00466                 } <span class="keywordflow">else</span> {
00467                     *StackLimit = (PVOID)( (PUCHAR)NextPage);
00468                 }
00469 <span class="preprocessor">#else</span>
00470 <span class="preprocessor"></span>                *StackLimit = (PVOID)( (PUCHAR)NextPage);
00471 <span class="preprocessor">#endif</span>
00472 <span class="preprocessor"></span>
00473             }
00474 
00475             <span class="keywordflow">return</span> STATUS_STACK_OVERFLOW;
00476         }
00477 <span class="preprocessor">#if defined(_WIN64)</span>
00478 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Teb32) {
00479             <span class="comment">// Update the 32-bit stacklimit</span>
00480             *(ULONG *)StackLimit = PtrToUlong((PUCHAR)(NextPage + PAGE_SIZE));
00481         } <span class="keywordflow">else</span> {
00482             *StackLimit = (PVOID)((PUCHAR)(NextPage + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>));
00483         }
00484 <span class="preprocessor">#else</span>
00485 <span class="preprocessor"></span>        *StackLimit = (PVOID)((PUCHAR)(NextPage + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>));
00486 <span class="preprocessor">#endif</span>
00487 <span class="preprocessor"></span>
00488 <span class="preprocessor">#if defined(_IA64_)</span>
00489 <span class="preprocessor"></span>      }
00490 <span class="preprocessor">#endif // _IA64_</span>
00491 <span class="preprocessor"></span>
00492 retry:
00493         status = ZwAllocateVirtualMemory (NtCurrentProcess(),
00494                                           (PVOID *)&amp;NextPage,
00495                                           0,
00496                                           &amp;RegionSize,
00497                                           MEM_COMMIT,
00498                                           PAGE_READWRITE | PAGE_GUARD);
00499 
00500 
00501         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || (status == STATUS_ALREADY_COMMITTED)) {
00502 
00503             <span class="comment">//</span>
00504             <span class="comment">// The guard page is now committed or stack space is</span>
00505             <span class="comment">// already present, return success.</span>
00506             <span class="comment">//</span>
00507 
00508             <span class="keywordflow">return</span> STATUS_PAGE_FAULT_GUARD_PAGE;
00509         }
00510 
00511         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() == <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a4">ExpDefaultErrorPortProcess</a>) {
00512 
00513             <span class="comment">//</span>
00514             <span class="comment">// Don't let CSRSS process get any stack overflows due to</span>
00515             <span class="comment">// commitment.  Increase the commitment by a page and</span>
00516             <span class="comment">// try again.</span>
00517             <span class="comment">//</span>
00518 
00519             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (status == STATUS_COMMITMENT_LIMIT);
00520 
00521             ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
00522             <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> += 1;
00523             <a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a> += 1;
00524             ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
00525             <span class="keywordflow">goto</span> retry;
00526         }
00527 
00528         <span class="keywordflow">return</span> STATUS_STACK_OVERFLOW;
00529 
00530     } except (EXCEPTION_EXECUTE_HANDLER) {
00531 
00532         <span class="comment">//</span>
00533         <span class="comment">// An exception has occurred during the referencing of the</span>
00534         <span class="comment">// TEB or TIB, just return a guard page violation and</span>
00535         <span class="comment">// don't deal with the stack overflow.</span>
00536         <span class="comment">//</span>
00537 
00538         <span class="keywordflow">return</span> STATUS_GUARD_PAGE_VIOLATION;
00539     }
00540 }
}
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="acceschk.c::MmReadWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CCHAR <a class="el" href="../../d0/d9/protect_8c.html#a0">MmReadWrite</a>[32]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {1, 10, 10, 10, 11, 11, 11, 11,
                         1, 10, 10, 10, 11, 11, 11, 11,
                         1, 10, 10, 10, 11, 11, 11, 11,
                         1, 10, 10, 10, 11, 11, 11, 11 }
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d2/acceschk_8c-source.html#l00035">35</a> of file <a class="el" href="../../d6/d2/acceschk_8c-source.html">acceschk.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/acceschk_8c-source.html#l00042">MiAccessCheck()</a>, and <a class="el" href="../../d1/d8/protect_8c-source.html#l02244">MiCheckSecuredVad()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
