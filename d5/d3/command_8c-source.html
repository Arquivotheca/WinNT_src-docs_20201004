<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: command.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>command.c</h1><a href="../../d4/d4/command_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*************************************************************************</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* command.c</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* WinStation command channel handler</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* $Author:</span>
00011 <span class="comment">*************************************************************************/</span>
00012 
00013 <span class="comment">/*</span>
00014 <span class="comment"> *  Includes</span>
00015 <span class="comment"> */</span>
00016 <span class="preprocessor">#include "<a class="code" href="../../d2/d4/w32_2ntuser_2server_2precomp_8h.html">precomp.h</a>"</span>
00017 <span class="preprocessor">#pragma hdrstop</span>
00018 <span class="preprocessor"></span>
00019 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ntuser_8h.html">ntuser.h</a>"</span>
00020 
00021 <span class="preprocessor">#include &lt;winsta.h&gt;</span>
00022 <span class="preprocessor">#include &lt;wstmsg.h&gt;</span>
00023 
00024 <span class="preprocessor">#include &lt;icadd.h&gt;</span>
00025 
<a name="l00026"></a><a class="code" href="../../d4/d4/command_8c.html#a0">00026</a> <span class="keyword">extern</span> HANDLE <a class="code" href="../../d2/d8/api_8c.html#a9">G_IcaVideoChannel</a>;
<a name="l00027"></a><a class="code" href="../../d4/d4/command_8c.html#a1">00027</a> <span class="keyword">extern</span> HANDLE <a class="code" href="../../d2/d8/api_8c.html#a13">G_IcaCommandChannel</a>;
<a name="l00028"></a><a class="code" href="../../d4/d4/command_8c.html#a2">00028</a> <span class="keyword">extern</span> HANDLE <a class="code" href="../../d4/d4/command_8c.html#a2">WinStationIcaApiPort</a>;
00029 
00030 
00031 <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d5/d4/icadis_8c.html#a2">BrokenConnection</a>(BROKENCLASS, BROKENSOURCECLASS);
00032 <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d5/d4/icadis_8c.html#a4">ShadowHotkey</a>(VOID);
00033 
00034 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00035"></a><a class="code" href="../../d4/d4/command_8c.html#a5">00035</a> <a class="code" href="../../d4/d4/command_8c.html#a5">Win32CommandChannelThread</a>(
00036     IN PVOID ThreadParameter)
00037 {
00038     ICA_CHANNEL_COMMAND Command;
00039     PTEB                Teb;
00040     ULONG               ActualLength;
00041     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00042     ULONG               <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
00043     OVERLAPPED          Overlapped;
00044 
00045     <span class="comment">/*</span>
00046 <span class="comment">     * Initialize GDI accelerators.  Identify this thread as a server thread.</span>
00047 <span class="comment">     */</span>
00048     Teb = NtCurrentTeb();
00049     Teb-&gt;GdiClientPID = 4; <span class="comment">// PID_SERVERLPC</span>
00050     Teb-&gt;GdiClientTID = HandleToUlong(Teb-&gt;ClientId.UniqueThread);
00051 
00052     <span class="keywordflow">for</span> ( ; ; ) {
00053 
00054         memset(&amp;Overlapped, 0, <span class="keyword">sizeof</span>(Overlapped));
00055 
00056         <span class="keywordflow">if</span> (!ReadFile(<a class="code" href="../../d2/d8/api_8c.html#a13">G_IcaCommandChannel</a>,
00057                       &amp;Command,
00058                       <span class="keyword">sizeof</span>(Command),
00059                       &amp;ActualLength,
00060                       &amp;Overlapped)) {
00061 
00062             <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> = GetLastError();
00063 
00064             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> == ERROR_IO_PENDING) {
00065                 
00066                 <span class="comment">/*</span>
00067 <span class="comment">                 * check on the results of the asynchronous read</span>
00068 <span class="comment">                 */</span>
00069                 <span class="keywordflow">if</span> (!GetOverlappedResult(<a class="code" href="../../d2/d8/api_8c.html#a13">G_IcaCommandChannel</a>, &amp;Overlapped,
00070                                          &amp;ActualLength, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00071                     <span class="comment">// wait for result</span>
00072 
00073                     <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"Command Channel: Error 0x%x from GetOverlappedResult\n"</span>,
00074                            GetLastError()));
00075                     <span class="keywordflow">break</span>;
00076                 }
00077             } <span class="keywordflow">else</span> {
00078                 <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"Command Channel: Error 0x%x from ReadFile\n"</span>,
00079                        <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>));
00080                 <span class="keywordflow">break</span>;
00081             }
00082         }
00083 
00084         <span class="keywordflow">if</span> (ActualLength &lt; <span class="keyword">sizeof</span>(ICA_COMMAND_HEADER)) {
00085             
00086             <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"Command Channel Thread bad length 0x%x\n"</span>,
00087                    ActualLength));
00088             <span class="keywordflow">continue</span>;
00089         }
00090         
00091         <span class="keywordflow">switch</span> (Command.Header.Command) {
00092 
00093         <span class="keywordflow">case</span> ICA_COMMAND_BROKEN_CONNECTION:
00094             <span class="comment">/*</span>
00095 <span class="comment">             * broken procedure</span>
00096 <span class="comment">             */</span>
00097             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/icadis_8c.html#a2">BrokenConnection</a>(
00098                         Command.BrokenConnection.Reason,
00099                         Command.BrokenConnection.Source);
00100             
00101             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00102                 <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"BrokenConnection failed with Status 0x%x\n"</span>,
00103                        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00104             }
00105             <span class="keywordflow">break</span>;
00106 
00107         <span class="keywordflow">case</span> ICA_COMMAND_REDRAW_RECTANGLE:
00108             <span class="comment">/*</span>
00109 <span class="comment">             * setfocus ???</span>
00110 <span class="comment">             */</span>
00111             <span class="keywordflow">if</span> (ActualLength &lt; <span class="keyword">sizeof</span>(ICA_COMMAND_HEADER) + <span class="keyword">sizeof</span>(ICA_REDRAW_RECTANGLE)) {
00112                 
00113                 <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"Command Channel: redraw rect bad length %d\n"</span>,
00114                        ActualLength));
00115                 <span class="keywordflow">break</span>;
00116             }
00117             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a78">NtUserRemoteRedrawRectangle</a>(
00118                          Command.RedrawRectangle.Rect.Left,
00119                          Command.RedrawRectangle.Rect.Top,
00120                          Command.RedrawRectangle.Rect.Right,
00121                          Command.RedrawRectangle.Rect.Bottom);
00122 
00123             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00124                 <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"NtUserRemoteRedrawRectangle failed with Status 0x%x\n"</span>,
00125                        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00126             }
00127             <span class="keywordflow">break</span>;
00128 
00129         <span class="keywordflow">case</span> ICA_COMMAND_REDRAW_SCREEN: <span class="comment">// setfocus</span>
00130             
00131             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a79">NtUserRemoteRedrawScreen</a>();
00132             
00133             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00134                 <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"NtUserRemoteRedrawScreen failed with Status 0x%x\n"</span>,
00135                        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00136             }
00137             <span class="keywordflow">break</span>;
00138 
00139         <span class="keywordflow">case</span> ICA_COMMAND_STOP_SCREEN_UPDATES: <span class="comment">// killfocus</span>
00140             
00141             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a80">NtUserRemoteStopScreenUpdates</a>();
00142             
00143             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00144                 <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"NtUserRemoteStopScreenUpdates failed with Status 0x%x\n"</span>,
00145                        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00146             } <span class="keywordflow">else</span> {
00147                 IO_STATUS_BLOCK IoStatus;
00148 
00149                 <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>( <a class="code" href="../../d2/d8/api_8c.html#a9">G_IcaVideoChannel</a>,
00150                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00151                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00152                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00153                                        &amp;IoStatus,
00154                                        IOCTL_VIDEO_ICA_STOP_OK,
00155                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00156                                        0,
00157                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00158                                        0);
00159             }
00160             <span class="keywordflow">break</span>;
00161 
00162         <span class="keywordflow">case</span> ICA_COMMAND_SHADOW_HOTKEY: <span class="comment">// shadow hotkey</span>
00163             
00164             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/icadis_8c.html#a4">ShadowHotkey</a>();
00165             
00166             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00167                 <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"ShadowHotkey failed with Status 0x%x\n"</span>,
00168                        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00169             }
00170             <span class="keywordflow">break</span>;
00171 
00172         <span class="keywordflow">case</span> ICA_COMMAND_DISPLAY_IOCTL:
00173             
00174             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a81">NtUserCtxDisplayIOCtl</a>(
00175                          Command.DisplayIOCtl.DisplayIOCtlFlags,
00176                          &amp;Command.DisplayIOCtl.DisplayIOCtlData[0],
00177                          Command.DisplayIOCtl.cbDisplayIOCtlData);
00178             
00179             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00180                 <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"NtUserCtxDisplayIOCtl failed with Status 0x%x\n"</span>,
00181                        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00182             }
00183             <span class="keywordflow">break</span>;
00184 
00185         <span class="keywordflow">default</span>:
00186             
00187             <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"Command Channel: Bad Command 0x%x\n"</span>,
00188                      Command.Header.Command));
00189             <span class="keywordflow">break</span>;
00190         }
00191 
00192     }
00193 
00194     <span class="comment">/*</span>
00195 <span class="comment">     * Close command channel LPC port if there is one.</span>
00196 <span class="comment">     */</span>
00197     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d4/command_8c.html#a2">WinStationIcaApiPort</a>) {
00198         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d4/d4/command_8c.html#a2">WinStationIcaApiPort</a>);
00199         <a class="code" href="../../d4/d4/command_8c.html#a2">WinStationIcaApiPort</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00200 
00201     }
00202 
00203 
00204     ExitThread(0);
00205     <span class="comment">/*</span>
00206 <span class="comment">     * Make the compiler happy</span>
00207 <span class="comment">     */</span>
00208     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00209     UNREFERENCED_PARAMETER(ThreadParameter);
00210 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:32 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
