<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: channel.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>channel.c</h1><a href="../../d4/d6/channel_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1995  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    channel.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">   This module implements the executive channel object. Channel obects</span>
00012 <span class="comment">   provide a very high speed local interprocess communication mechanism.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    David N. Cutler (davec) 26-Mar-1995</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00027 
00028 <span class="comment">//</span>
00029 <span class="comment">// Define local function prototypes.</span>
00030 <span class="comment">//</span>
00031 
00032 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00033 <a class="code" href="../../d4/d6/channel_8c.html#a2">KiAllocateReceiveBufferChannel</a> (
00034     VOID
00035     );
00036 
00037 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00038 <a class="code" href="../../d4/d6/channel_8c.html#a3">KiCloseChannel</a> (
00039     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00040     IN PVOID Object,
00041     IN ACCESS_MASK GrantedAccess,
00042     IN ULONG ProcessHandleCount,
00043     IN ULONG SystemHandleCount
00044     );
00045 
00046 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00047 <a class="code" href="../../d4/d6/channel_8c.html#a4">KiDeleteChannel</a> (
00048     IN PVOID Object
00049     );
00050 
00051 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00052 <a class="code" href="../../d4/d6/channel_8c.html#a5">KiListenChannel</a> (
00053     IN <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> ServerChannel,
00054     IN KPROCESSOR_MODE WaitMode,
00055     OUT PCHANNEL_MESSAGE *Message
00056     );
00057 
00058 <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>
00059 <a class="code" href="../../d4/d6/channel_8c.html#a6">KiRendezvousWithThread</a> (
00060     IN <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> WaitChannel,
00061     IN ULONG WaitMode
00062     );
00063 
00064 <span class="comment">//</span>
00065 <span class="comment">// Address of event object type descriptor.</span>
00066 <span class="comment">//</span>
00067 
<a name="l00068"></a><a class="code" href="../../d4/d6/channel_8c.html#a0">00068</a> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d4/d6/channel_8c.html#a0">KeChannelType</a>;
00069 
00070 <span class="comment">//</span>
00071 <span class="comment">// Structure that describes the mapping of generic access rights to object</span>
00072 <span class="comment">// specific access rights for event objects.</span>
00073 <span class="comment">//</span>
00074 
<a name="l00075"></a><a class="code" href="../../d4/d6/channel_8c.html#a1">00075</a> GENERIC_MAPPING <a class="code" href="../../d4/d6/channel_8c.html#a1">KiChannelMapping</a> = {
00076     STANDARD_RIGHTS_READ |
00077         CHANNEL_READ_MESSAGE,
00078     STANDARD_RIGHTS_WRITE |
00079         CHANNEL_WRITE_MESSAGE,
00080     STANDARD_RIGHTS_EXECUTE |
00081         SYNCHRONIZE,
00082     CHANNEL_ALL_ACCESS
00083 };
00084 
00085 <span class="comment">//</span>
00086 <span class="comment">// Define function sections.</span>
00087 <span class="comment">//</span>
00088 
00089 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00090 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, KiAllocateReceiveBufferChannel)</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, KiChannelInitialization)</span>
00092 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, KiDeleteChannel)</span>
00093 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, KiRundownChannel)</span>
00094 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtCreateChannel)</span>
00095 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtListenChannel)</span>
00096 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtOpenChannel)</span>
00097 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtSetContextChannel)</span>
00098 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00099 <span class="preprocessor"></span>
00100 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00101"></a><a class="code" href="../../d4/d6/channel_8c.html#a7">00101</a> <a class="code" href="../../d4/d6/channel_8c.html#a7">NtCreateChannel</a> (
00102     OUT PHANDLE ChannelHandle,
00103     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL
00104     )
00105 
00106 <span class="comment">/*++</span>
00107 <span class="comment"></span>
00108 <span class="comment">Routine Description:</span>
00109 <span class="comment"></span>
00110 <span class="comment">    This function creates a server listen channel object and opens a handle</span>
00111 <span class="comment">    to the object with the specified desired access.</span>
00112 <span class="comment"></span>
00113 <span class="comment">Arguments:</span>
00114 <span class="comment"></span>
00115 <span class="comment">    ChannelHandle - Supplies a pointer to a variable that will receive the</span>
00116 <span class="comment">        channel object handle.</span>
00117 <span class="comment"></span>
00118 <span class="comment">    ObjectAttributes - Supplies a pointer to an object attributes structure.</span>
00119 <span class="comment"></span>
00120 <span class="comment">Return Value:</span>
00121 <span class="comment"></span>
00122 <span class="comment">    If the channel object is created, then a success status is returned.</span>
00123 <span class="comment">    Otherwise, a failure status is returned.</span>
00124 <span class="comment"></span>
00125 <span class="comment">--*/</span>
00126 
00127 {
00128 
00129 <span class="preprocessor">#if 0</span>
00130 <span class="preprocessor"></span>
00131     PVOID ChannelObject;
00132     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00133     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> ServerChannel;
00134     HANDLE ServerHandle;
00135     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00136 
00137     <span class="comment">//</span>
00138     <span class="comment">// Establish an exception handler, probe and zero the output handle</span>
00139     <span class="comment">// address, and attempt to create a channel object. If the probe fails</span>
00140     <span class="comment">// or access to the object attributes fails, then return the exception</span>
00141     <span class="comment">// code as the service status.</span>
00142     <span class="comment">//</span>
00143 
00144     PreviousMode = KeGetPreviousMode();
00145     <span class="keywordflow">try</span> {
00146 
00147         <span class="comment">//</span>
00148         <span class="comment">// Get previous processor mode and probe output handle address if</span>
00149         <span class="comment">// necessary.</span>
00150         <span class="comment">//</span>
00151 
00152         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00153             <a class="code" href="../../d5/d8/ex_8h.html#a36">ProbeAndZeroHandle</a>(ChannelHandle);
00154         }
00155 
00156         <span class="comment">//</span>
00157         <span class="comment">// Allocate channel object.</span>
00158         <span class="comment">//</span>
00159 
00160         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(PreviousMode,
00161                                 <a class="code" href="../../d4/d6/channel_8c.html#a0">KeChannelType</a>,
00162                                 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00163                                 PreviousMode,
00164                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00165                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d1/struct__ECHANNEL.html">ECHANNEL</a>),
00166                                 0,
00167                                 0,
00168                                 &amp;ChannelObject);
00169 
00170     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00171         <span class="keywordflow">return</span> GetExceptionCode();
00172     }
00173 
00174     <span class="comment">//</span>
00175     <span class="comment">// If the channel object was successfully created, then initialize the</span>
00176     <span class="comment">// channel object and insert the channel object in the process handle</span>
00177     <span class="comment">// table.</span>
00178     <span class="comment">//</span>
00179 
00180     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00181         ServerChannel = (<a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a>)ChannelObject;
00182         ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o0">Type</a> = <a class="code" href="../../d4/d9/ke_8h.html#a18">LISTEN_CHANNEL</a>;
00183         ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o1">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a409a233">ServerIdle</a>;
00184         ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o2">OwnerProcess</a> = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb;
00185         ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o3">ClientThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00186         ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o4">ServerThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00187         ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o5">ServerContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00188         ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o6">ServerChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00189         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o7">ReceiveEvent</a>,
00190                           SynchronizationEvent,
00191                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00192 
00193         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o8">ClearToSendEvent</a>,
00194                           SynchronizationEvent,
00195                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00196 
00197         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(ServerChannel,
00198                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00199                                 CHANNEL_ALL_ACCESS,
00200                                 0,
00201                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00202                                 &amp;ServerHandle);
00203 
00204         <span class="comment">//</span>
00205         <span class="comment">// If the channel object was successfully inserted in the process</span>
00206         <span class="comment">// handle table, then attempt to write the channel object handle</span>
00207         <span class="comment">// value. If the write attempt fails, then do not report an error.</span>
00208         <span class="comment">// When the caller attempts to access the handle value, an access</span>
00209         <span class="comment">// violation will occur.</span>
00210         <span class="comment">//</span>
00211 
00212         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00213             <span class="keywordflow">try</span> {
00214                 *ChannelHandle = ServerHandle;
00215 
00216             } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00217             }
00218         }
00219     }
00220 
00221     <span class="comment">//</span>
00222     <span class="comment">// Return service status.</span>
00223     <span class="comment">//</span>
00224 
00225     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00226 
00227 <span class="preprocessor">#else</span>
00228 <span class="preprocessor"></span>
00229     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00230 
00231 <span class="preprocessor">#endif</span>
00232 <span class="preprocessor"></span>
00233 }
00234 
00235 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00236"></a><a class="code" href="../../d4/d6/channel_8c.html#a8">00236</a> <a class="code" href="../../d4/d6/channel_8c.html#a8">NtListenChannel</a> (
00237     IN HANDLE ChannelHandle,
00238     OUT PCHANNEL_MESSAGE *Message
00239     )
00240 
00241 <span class="comment">/*++</span>
00242 <span class="comment"></span>
00243 <span class="comment">Routine Description:</span>
00244 <span class="comment"></span>
00245 <span class="comment">    This function listens for a client message.</span>
00246 <span class="comment"></span>
00247 <span class="comment">    N.B. This function can only be executed from a server thread.</span>
00248 <span class="comment"></span>
00249 <span class="comment">Arguments:</span>
00250 <span class="comment"></span>
00251 <span class="comment">    ChannelHandle - Supplies a handle to a listen channel on which the</span>
00252 <span class="comment">        server thread listens.</span>
00253 <span class="comment"></span>
00254 <span class="comment">    Message - Supplies a pointer to a variable that receives a pointer</span>
00255 <span class="comment">        to the client message header.</span>
00256 <span class="comment"></span>
00257 <span class="comment">Return Value:</span>
00258 <span class="comment"></span>
00259 <span class="comment">    If the function is successfully completed, then a success status is</span>
00260 <span class="comment">    returned. Otherwise, a failure status is returned.</span>
00261 <span class="comment"></span>
00262 <span class="comment">--*/</span>
00263 
00264 {
00265 
00266 <span class="preprocessor">#if 0</span>
00267 <span class="preprocessor"></span>
00268     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00269     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> ServerChannel;
00270     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>;
00271     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00272 
00273     <span class="comment">//</span>
00274     <span class="comment">// Establish an exception handler, probe the output message address,</span>
00275     <span class="comment">// and allocate a receive buffer if necessary. If the probe fails or</span>
00276     <span class="comment">// the receive buffer allocation is not successful, then return the</span>
00277     <span class="comment">// exception code as the service status.</span>
00278     <span class="comment">//</span>
00279 
00280     <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00281     <span class="keywordflow">try</span> {
00282 
00283         <span class="comment">//</span>
00284         <span class="comment">// Get previous processor mode and probe output message address.</span>
00285         <span class="comment">//</span>
00286 
00287         PreviousMode = KeGetPreviousMode();
00288         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00289             <a class="code" href="../../d5/d8/ex_8h.html#a38">ProbeAndNullPointer</a>(Message);
00290         }
00291 
00292         <span class="comment">//</span>
00293         <span class="comment">// If the current thread does not have an associated receive buffer,</span>
00294         <span class="comment">// then attempt to allocate one now. If the allocation fails, then</span>
00295         <span class="comment">// an exception is raised.</span>
00296         <span class="comment">//</span>
00297 
00298         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;Section == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00299             <a class="code" href="../../d4/d6/channel_8c.html#a2">KiAllocateReceiveBufferChannel</a>();
00300         }
00301 
00302     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00303         <span class="keywordflow">return</span> GetExceptionCode();
00304     }
00305 
00306     <span class="comment">//</span>
00307     <span class="comment">// Reference channel object by handle.</span>
00308     <span class="comment">//</span>
00309 
00310     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(ChannelHandle,
00311                                        CHANNEL_ALL_ACCESS,
00312                                        <a class="code" href="../../d4/d6/channel_8c.html#a0">KeChannelType</a>,
00313                                        PreviousMode,
00314                                        &amp;ServerChannel,
00315                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00316 
00317     <span class="comment">//</span>
00318     <span class="comment">// If the reference was successful and the channel is a listen channel,</span>
00319     <span class="comment">// then wait for a client message to arrive.</span>
00320     <span class="comment">//</span>
00321 
00322     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00323         <span class="keywordflow">if</span> (ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o6">ServerChannel</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00324             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER; <span class="comment">// **** fix ****</span>
00325 
00326         } <span class="keywordflow">else</span> {
00327             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/channel_8c.html#a5">KiListenChannel</a>(ServerChannel, PreviousMode, Message);
00328         }
00329 
00330         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ServerChannel);
00331     }
00332 
00333     <span class="comment">//</span>
00334     <span class="comment">// Return service status.</span>
00335     <span class="comment">//</span>
00336 
00337     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00338 
00339 <span class="preprocessor">#else</span>
00340 <span class="preprocessor"></span>
00341     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00342 
00343 <span class="preprocessor">#endif</span>
00344 <span class="preprocessor"></span>
00345 }
00346 
00347 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00348"></a><a class="code" href="../../d4/d6/channel_8c.html#a9">00348</a> <a class="code" href="../../d4/d6/channel_8c.html#a9">NtOpenChannel</a> (
00349     OUT PHANDLE ChannelHandle,
00350     IN POBJECT_ATTRIBUTES ObjectAttributes
00351     )
00352 
00353 <span class="comment">/*++</span>
00354 <span class="comment"></span>
00355 <span class="comment">Routine Description:</span>
00356 <span class="comment"></span>
00357 <span class="comment">    This function opens a handle to a server channel by creating a message</span>
00358 <span class="comment">    channel that is connected to the specified server channel.</span>
00359 <span class="comment"></span>
00360 <span class="comment">Arguments:</span>
00361 <span class="comment"></span>
00362 <span class="comment">    ChannelHandle - Supplies a pointer to a variable that will receive the</span>
00363 <span class="comment">        channel object handle.</span>
00364 <span class="comment"></span>
00365 <span class="comment">    ObjectAttributes - Supplies a pointer to an object attributes structure.</span>
00366 <span class="comment"></span>
00367 <span class="comment">Return Value:</span>
00368 <span class="comment"></span>
00369 <span class="comment">    If the channel object is opened, then a success status is returned.</span>
00370 <span class="comment">    Otherwise, a failure status is returned.</span>
00371 <span class="comment"></span>
00372 <span class="comment">--*/</span>
00373 
00374 {
00375 
00376 <span class="preprocessor">#if 0</span>
00377 <span class="preprocessor"></span>
00378     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> ClientChannel;
00379     HANDLE ClientHandle;
00380     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00381     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00382     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> ServerChannel;
00383     PVOID ServerObject;
00384     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00385 
00386     <span class="comment">//</span>
00387     <span class="comment">// Establish an exception handler, probe and zero the output handle</span>
00388     <span class="comment">// address, and attempt to open the server channel object. If the</span>
00389     <span class="comment">// probe fails, then return the exception code as the service status.</span>
00390     <span class="comment">//</span>
00391 
00392     <span class="keywordflow">try</span> {
00393 
00394         <span class="comment">//</span>
00395         <span class="comment">// Get previous processor mode and probe output handle address</span>
00396         <span class="comment">// if necessary.</span>
00397         <span class="comment">//</span>
00398 
00399         PreviousMode = KeGetPreviousMode();
00400         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00401             <a class="code" href="../../d5/d8/ex_8h.html#a36">ProbeAndZeroHandle</a>(ChannelHandle);
00402         }
00403 
00404         <span class="comment">//</span>
00405         <span class="comment">// Reference the server channel object with the specified desired</span>
00406         <span class="comment">// access.</span>
00407         <span class="comment">//</span>
00408 
00409         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a5">ObReferenceObjectByName</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName,
00410                                         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;Attributes,
00411                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00412                                         CHANNEL_ALL_ACCESS,
00413                                         <a class="code" href="../../d4/d6/channel_8c.html#a0">KeChannelType</a>,
00414                                         PreviousMode,
00415                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00416                                         (PVOID *)&amp;ServerObject);
00417 
00418     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00419         <span class="keywordflow">return</span> GetExceptionCode();
00420     }
00421 
00422     <span class="comment">//</span>
00423     <span class="comment">// If the reference was successful, then attempt to create a client</span>
00424     <span class="comment">// channel object.</span>
00425     <span class="comment">//</span>
00426 
00427     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00428 
00429         <span class="comment">//</span>
00430         <span class="comment">// If the owner process of the server channel is the same as</span>
00431         <span class="comment">// the current process, then a server thread is attempting to</span>
00432         <span class="comment">// open a client handle. This is not allowed since it would</span>
00433         <span class="comment">// not be possible to distinguish the server from the cient.</span>
00434         <span class="comment">//</span>
00435 
00436         <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00437         ServerChannel = (<a class="code" href="../../d9/d1/struct__ECHANNEL.html">PECHANNEL</a>)ServerObject;
00438         <span class="keywordflow">if</span> (ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o2">OwnerProcess</a> == <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;ApcState.Process) {
00439             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER; <span class="comment">// **** fix ***</span>
00440 
00441         } <span class="keywordflow">else</span> {
00442             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(PreviousMode,
00443                                     <a class="code" href="../../d4/d6/channel_8c.html#a0">KeChannelType</a>,
00444                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00445                                     PreviousMode,
00446                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00447                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d1/struct__ECHANNEL.html">ECHANNEL</a>),
00448                                     0,
00449                                     0,
00450                                     (PVOID *)&amp;ClientChannel);
00451 
00452             <span class="comment">//</span>
00453             <span class="comment">// If the channel object was successfully created, then</span>
00454             <span class="comment">// initialize the channel object and attempt to insert the</span>
00455             <span class="comment">// channel object in the server process channel table.</span>
00456             <span class="comment">//</span>
00457 
00458             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00459                 ClientChannel-&gt;Type = <a class="code" href="../../d4/d9/ke_8h.html#a19">MESSAGE_CHANNEL</a>;
00460                 ClientChannel-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a409a230">ClientIdle</a>;
00461                 ClientChannel-&gt;OwnerProcess = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb;
00462                 ClientChannel-&gt;ClientThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00463                 ClientChannel-&gt;ServerThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00464                 ClientChannel-&gt;ServerContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00465                 ClientChannel-&gt;ServerChannel = ServerChannel;
00466                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;ClientChannel-&gt;ReceiveEvent,
00467                                   SynchronizationEvent,
00468                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00469 
00470                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;ClientChannel-&gt;ClearToSendEvent,
00471                                   SynchronizationEvent,
00472                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00473 
00474                 <span class="comment">//</span>
00475                 <span class="comment">// Create a handle to the message channel object.</span>
00476                 <span class="comment">//</span>
00477 
00478                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(ClientChannel,
00479                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00480                                         CHANNEL_ALL_ACCESS,
00481                                         0,
00482                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00483                                         &amp;ClientHandle);
00484 
00485                 <span class="comment">//</span>
00486                 <span class="comment">// If the channel object was successfully inserted in the</span>
00487                 <span class="comment">// client process handle table, then attempt to write the</span>
00488                 <span class="comment">// client channel object handle value. If the write attempt</span>
00489                 <span class="comment">// fails, then do not report an error. When the caller</span>
00490                 <span class="comment">// attempts to access the handle value, an access violation</span>
00491                 <span class="comment">// will occur.</span>
00492                 <span class="comment">//</span>
00493 
00494                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00495                     <span class="keywordflow">try</span> {
00496                         *ChannelHandle = ClientHandle;
00497 
00498                     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00499                     }
00500 
00501                 }
00502 
00503                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00504             }
00505         }
00506 
00507         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ServerChannel);
00508     }
00509 
00510     <span class="comment">//</span>
00511     <span class="comment">// Return service status.</span>
00512     <span class="comment">//</span>
00513 
00514     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00515 
00516 <span class="preprocessor">#else</span>
00517 <span class="preprocessor"></span>
00518     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00519 
00520 <span class="preprocessor">#endif</span>
00521 <span class="preprocessor"></span>
00522 }
00523 
00524 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00525"></a><a class="code" href="../../d4/d6/channel_8c.html#a10">00525</a> <a class="code" href="../../d4/d6/channel_8c.html#a10">NtReplyWaitSendChannel</a> (
00526     IN PVOID Text,
00527     IN ULONG Length,
00528     OUT PCHANNEL_MESSAGE *Message
00529     )
00530 
00531 <span class="comment">/*++</span>
00532 <span class="comment"></span>
00533 <span class="comment">Routine Description:</span>
00534 <span class="comment"></span>
00535 <span class="comment">    This function sends a reply message to a client and waits for a send.</span>
00536 <span class="comment"></span>
00537 <span class="comment">    N.B. This function can only be executed from a server thread that</span>
00538 <span class="comment">        has an assoicated message channel.</span>
00539 <span class="comment"></span>
00540 <span class="comment">Arguments:</span>
00541 <span class="comment"></span>
00542 <span class="comment">    Text - Supplies a pointer to the message text.</span>
00543 <span class="comment"></span>
00544 <span class="comment">    Length - Supplies the length of the message text.</span>
00545 <span class="comment"></span>
00546 <span class="comment">    Message - Supplies a pointer to a variable that receives the send</span>
00547 <span class="comment">        message header.</span>
00548 <span class="comment"></span>
00549 <span class="comment">Return Value:</span>
00550 <span class="comment"></span>
00551 <span class="comment">    If the function is successfully completed, then a succes status is</span>
00552 <span class="comment">    returned. Otherwise, a failure status is returned.</span>
00553 <span class="comment"></span>
00554 <span class="comment">--*/</span>
00555 
00556 {
00557 
00558 <span class="preprocessor">#if 0</span>
00559 <span class="preprocessor"></span>
00560     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00561     PCHANNEL_MESSAGE ClientView;
00562     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> MessageChannel;
00563     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00564     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PECHANNEL</a> ServerChannel;
00565     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>;
00566     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00567 
00568     <span class="comment">//</span>
00569     <span class="comment">// Establish an exception handler, probe the output message address,</span>
00570     <span class="comment">// probe the message text, and allocate a receive buffer if necessary.</span>
00571     <span class="comment">// If either of the probes fail or the receive buffer allocation is</span>
00572     <span class="comment">// not successful, then return the exception code as the service</span>
00573     <span class="comment">// status.</span>
00574     <span class="comment">//</span>
00575 
00576     <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00577     <span class="keywordflow">try</span> {
00578 
00579         <span class="comment">//</span>
00580         <span class="comment">// Get previous processor mode and probe output message address and</span>
00581         <span class="comment">// the message text if necessary.</span>
00582         <span class="comment">//</span>
00583 
00584         PreviousMode = KeGetPreviousMode();
00585         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00586             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Text, Length, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
00587             <a class="code" href="../../d5/d8/ex_8h.html#a38">ProbeAndNullPointer</a>(Message);
00588         }
00589 
00590         <span class="comment">//</span>
00591         <span class="comment">// If the current thread does not have an associated receive buffer,</span>
00592         <span class="comment">// then attempt to allocate one now. If the allocation fails, then</span>
00593         <span class="comment">// an exception is raised.</span>
00594         <span class="comment">//</span>
00595 
00596         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;Section == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00597             <a class="code" href="../../d4/d6/channel_8c.html#a2">KiAllocateReceiveBufferChannel</a>();
00598         }
00599 
00600     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00601         <span class="keywordflow">return</span> GetExceptionCode();
00602     }
00603 
00604     <span class="comment">//</span>
00605     <span class="comment">// If the message length is greater than the host page size minus</span>
00606     <span class="comment">// the message header length, then return an error.</span>
00607     <span class="comment">//</span>
00608 
00609     <span class="keywordflow">if</span> (Length &gt;= (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(CHANNEL_MESSAGE))) {
00610         <span class="keywordflow">return</span>  STATUS_BUFFER_OVERFLOW;
00611     }
00612 
00613     <span class="comment">//</span>
00614     <span class="comment">// If the server thread has an associated message channel, the channel</span>
00615     <span class="comment">// is in server receive message state, and the channel server thread</span>
00616     <span class="comment">// matches the current thread.</span>
00617     <span class="comment">//</span>
00618     <span class="comment">// This implies that:</span>
00619     <span class="comment">//</span>
00620     <span class="comment">// 1. The channel is a message channel.</span>
00621     <span class="comment">//</span>
00622     <span class="comment">// 2. The channel is being accessed by the server thread.</span>
00623     <span class="comment">//</span>
00624     <span class="comment">// 3. The channel is associated with a listen channel.</span>
00625     <span class="comment">//</span>
00626     <span class="comment">// 4. There is currently a server channel owner.</span>
00627     <span class="comment">//</span>
00628     <span class="comment">// 5. There is currently a client channel owner.</span>
00629     <span class="comment">//</span>
00630 
00631     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql);
00632     MessageChannel = <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;Channel;
00633     <span class="keywordflow">if</span> ((MessageChannel == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00634         (MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o1">State</a> != <a class="code" href="../../d4/d9/ke_8h.html#a409a234">ServerReceiveMessage</a>) ||
00635         (MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o4">ServerThread</a> != <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>)) {
00636 
00637         <span class="comment">//</span>
00638         <span class="comment">// A message is not associated with the current thread,</span>
00639         <span class="comment">// the message channel is in the wrong state, or the</span>
00640         <span class="comment">// current thread is not the owner of the channel.</span>
00641         <span class="comment">//</span>
00642 
00643         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql);
00644         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER; <span class="comment">// **** fix ****</span>
00645 
00646     } <span class="keywordflow">else</span> {
00647 
00648         <span class="comment">//</span>
00649         <span class="comment">// Rendezvous with the client thread so a transfer of the</span>
00650         <span class="comment">// reply text to the client thread can occur.</span>
00651         <span class="comment">//</span>
00652 
00653         <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> = <a class="code" href="../../d4/d6/channel_8c.html#a6">KiRendezvousWithThread</a>(MessageChannel, PreviousMode);
00654 
00655         <span class="comment">//</span>
00656         <span class="comment">// Control is returned when:</span>
00657         <span class="comment">//</span>
00658         <span class="comment">// 1. The server thread is being terminated (USER_APC).</span>
00659         <span class="comment">//</span>
00660         <span class="comment">// 2. A rendezvous with a client thread has occured.</span>
00661         <span class="comment">//</span>
00662         <span class="comment">// N.B. If the status value is less than zero, then it</span>
00663         <span class="comment">//      is the address of the client thread.</span>
00664         <span class="comment">//</span>
00665 
00666         <span class="keywordflow">if</span> ((LONG)<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> &lt; 0) {
00667 
00668             <span class="comment">//</span>
00669             <span class="comment">// The client thread is returned as the rendezvous status</span>
00670             <span class="comment">// with the thread in the transition state. Get the address</span>
00671             <span class="comment">// of the client thread system view, establish an exception</span>
00672             <span class="comment">// handler, and transfer the  message text from the server's</span>
00673             <span class="comment">// buffer to the client's receive buffer. If an exception</span>
00674             <span class="comment">// occurs during the copy, then return the exception code</span>
00675             <span class="comment">// as the service status.</span>
00676             <span class="comment">//</span>
00677 
00678             ClientView = <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;SystemView;
00679             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00680             <span class="keywordflow">if</span> (Length != 0) {
00681                 <span class="keywordflow">try</span> {
00682                     RtlCopyMemory(ClientView + 1, Text, Length);
00683 
00684                 } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00685                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00686                 }
00687             }
00688 
00689             <span class="comment">//</span>
00690             <span class="comment">// Set the channel message parameters.</span>
00691             <span class="comment">//</span>
00692 
00693             ClientView-&gt;Text = (PVOID)(<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;ThreadView + 1);
00694             ClientView-&gt;Length = Length;
00695             ClientView-&gt;Context = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00696             ClientView-&gt;Base = Text;
00697             ClientView-&gt;Close = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00698 
00699             <span class="comment">//</span>
00700             <span class="comment">// Raise IRQL to dispatch level, lock the dispatcher</span>
00701             <span class="comment">// database, and check if the message was successfully</span>
00702             <span class="comment">// transfered to the client's receive buffer. If the</span>
00703             <span class="comment">// message was successfully transfered to the client's</span>
00704             <span class="comment">// receive buffer. then reset the channel state, fill</span>
00705             <span class="comment">// in the message parameters, ready the client thread,</span>
00706             <span class="comment">// and listen for the next message. Otherwise, set the</span>
00707             <span class="comment">// client wait status and ready the client thread for</span>
00708             <span class="comment">// execution.</span>
00709             <span class="comment">//</span>
00710 
00711             <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql);
00712             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00713                 MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o1">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a409a230">ClientIdle</a>;
00714                 MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o3">ClientThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00715                 MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o4">ServerThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00716                 <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;WaitStatus = STATUS_SUCCESS;
00717 
00718                 <span class="comment">//</span>
00719                 <span class="comment">// Reference the server channel and dereference the</span>
00720                 <span class="comment">// message channel.</span>
00721                 <span class="comment">//</span>
00722 
00723                 ServerChannel = MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o6">ServerChannel</a>;
00724                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(ServerChannel);
00725                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MessageChannel);
00726 
00727                 <span class="comment">//</span>
00728                 <span class="comment">// If there are no clients waiting to send to the server,</span>
00729                 <span class="comment">// then switch directly to the client thread. Otherwise,</span>
00730                 <span class="comment">// ready the client thread, then listen for the next</span>
00731                 <span class="comment">// message.</span>
00732                 <span class="comment">//</span>
00733 
00734                 <span class="keywordflow">if</span> (IsListEmpty(&amp;ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o8">ClearToSendEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00735                     <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>);
00736                     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql);
00737                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/channel_8c.html#a5">KiListenChannel</a>(ServerChannel,
00738                                              PreviousMode,
00739                                              Message);
00740 
00741                 } <span class="keywordflow">else</span> {
00742                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = KiSwitchToThread(<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>,
00743                                               <a class="code" href="../../d4/d9/ke_8h.html#a407a218">WrRendezvous</a>,
00744                                               PreviousMode,
00745                                               &amp;ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o7">ReceiveEvent</a>);
00746 
00747                     <span class="comment">//</span>
00748                     <span class="comment">// If a client message was successfully received, then</span>
00749                     <span class="comment">// attempt to write the address of the send message</span>
00750                     <span class="comment">// address. If the write attempt fails, then do not</span>
00751                     <span class="comment">// report an error. When the caller attempts to access</span>
00752                     <span class="comment">// the message address, an access violation will occur.</span>
00753                     <span class="comment">//</span>
00754 
00755                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00756                         <span class="keywordflow">try</span> {
00757                             *Message = <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;ThreadView;
00758 
00759                         } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00760                         }
00761                     }
00762                 }
00763 
00764                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ServerChannel);
00765 
00766             } <span class="keywordflow">else</span> {
00767 
00768                 <span class="comment">//</span>
00769                 <span class="comment">// The reply message was not successfully transfered</span>
00770                 <span class="comment">// to the client receive buffer because of an access</span>
00771                 <span class="comment">// violation encountered durring the access to the</span>
00772                 <span class="comment">// server buffer.</span>
00773                 <span class="comment">//</span>
00774 
00775                 <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;WaitStatus = STATUS_KERNEL_APC;
00776                 <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>);
00777                 <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql);
00778             }
00779 
00780         } <span class="keywordflow">else</span> {
00781 
00782             <span class="comment">//</span>
00783             <span class="comment">// The server thread is terminating and the channel</span>
00784             <span class="comment">// structures will be cleaned up by the termiantion</span>
00785             <span class="comment">// code.</span>
00786             <span class="comment">//</span>
00787 
00788             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00789         }
00790     }
00791 
00792     <span class="comment">//</span>
00793     <span class="comment">// Return service status.</span>
00794     <span class="comment">//</span>
00795 
00796     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00797 
00798 <span class="preprocessor">#else</span>
00799 <span class="preprocessor"></span>
00800     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00801 
00802 <span class="preprocessor">#endif</span>
00803 <span class="preprocessor"></span>
00804 }
00805 
00806 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00807"></a><a class="code" href="../../d4/d6/channel_8c.html#a11">00807</a> <a class="code" href="../../d4/d6/channel_8c.html#a11">NtSendWaitReplyChannel</a> (
00808     IN HANDLE ChannelHandle,
00809     IN PVOID Text,
00810     IN ULONG Length,
00811     OUT PCHANNEL_MESSAGE *Message
00812     )
00813 
00814 <span class="comment">/*++</span>
00815 <span class="comment"></span>
00816 <span class="comment">Routine Description:</span>
00817 <span class="comment"></span>
00818 <span class="comment">    This function sends a message to a server and waits for a reply.</span>
00819 <span class="comment"></span>
00820 <span class="comment">    N.B. This function can only be executed from a client thread.</span>
00821 <span class="comment"></span>
00822 <span class="comment">Arguments:</span>
00823 <span class="comment"></span>
00824 <span class="comment">    ChannelHandle - Supplies a handle to a message channel over which the</span>
00825 <span class="comment">        specified message text is sent.</span>
00826 <span class="comment"></span>
00827 <span class="comment">    Text - Supplies a pointer to the message text.</span>
00828 <span class="comment"></span>
00829 <span class="comment">    Length - Supplies the length of the message text.</span>
00830 <span class="comment"></span>
00831 <span class="comment">    Message - Supplies a pointer to a variable that receives a pointer</span>
00832 <span class="comment">        to the reply message header.</span>
00833 <span class="comment"></span>
00834 <span class="comment">Return Value:</span>
00835 <span class="comment"></span>
00836 <span class="comment">    If the function is successfully completed, then a success status is</span>
00837 <span class="comment">    returned. Otherwise, a failure status is returned.</span>
00838 <span class="comment"></span>
00839 <span class="comment">--*/</span>
00840 
00841 {
00842 
00843 <span class="preprocessor">#if 0</span>
00844 <span class="preprocessor"></span>
00845     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00846     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> MessageChannel;
00847     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00848     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> ServerChannel;
00849     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>;
00850     PCHANNEL_MESSAGE ServerView;
00851     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00852 
00853     <span class="comment">//</span>
00854     <span class="comment">// Establish an exception handler, probe the output message address,</span>
00855     <span class="comment">// probe the message text, and allocate a receive buffer if necessary.</span>
00856     <span class="comment">// If either of the probes fail or the receive buffer allocation is</span>
00857     <span class="comment">// not successful, then return the exception code as the service</span>
00858     <span class="comment">// status.</span>
00859     <span class="comment">//</span>
00860 
00861     <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00862     <span class="keywordflow">try</span> {
00863 
00864         <span class="comment">//</span>
00865         <span class="comment">// Get previous processor mode and probe output message address</span>
00866         <span class="comment">// and the message text.</span>
00867         <span class="comment">//</span>
00868 
00869         PreviousMode = KeGetPreviousMode();
00870         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00871             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Text, Length, <span class="keyword">sizeof</span>(UCHAR));
00872             <a class="code" href="../../d5/d8/ex_8h.html#a38">ProbeAndNullPointer</a>(Message);
00873         }
00874 
00875         <span class="comment">//</span>
00876         <span class="comment">// If the current thread does not have an associated receive buffer,</span>
00877         <span class="comment">// then attempt to allocate one now. If the allocation fails, then</span>
00878         <span class="comment">// an exception is raised.</span>
00879         <span class="comment">//</span>
00880 
00881         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;Section == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00882             <a class="code" href="../../d4/d6/channel_8c.html#a2">KiAllocateReceiveBufferChannel</a>();
00883         }
00884 
00885     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00886         <span class="keywordflow">return</span> GetExceptionCode();
00887     }
00888 
00889     <span class="comment">//</span>
00890     <span class="comment">// If the message length is greater than the host page size minus</span>
00891     <span class="comment">// the message header length, then return an error.</span>
00892     <span class="comment">//</span>
00893 
00894     <span class="keywordflow">if</span> (Length &gt;= (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(CHANNEL_MESSAGE))) {
00895         <span class="keywordflow">return</span> STATUS_BUFFER_OVERFLOW;
00896     }
00897 
00898     <span class="comment">//</span>
00899     <span class="comment">// Reference channel object by handle.</span>
00900     <span class="comment">//</span>
00901 
00902     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(ChannelHandle,
00903                                        CHANNEL_ALL_ACCESS,
00904                                        <a class="code" href="../../d4/d6/channel_8c.html#a0">KeChannelType</a>,
00905                                        PreviousMode,
00906                                        (PVOID *)&amp;MessageChannel,
00907                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00908 
00909     <span class="comment">//</span>
00910     <span class="comment">// If the reference was successful, then check if the channel is in</span>
00911     <span class="comment">// the client idle state.</span>
00912     <span class="comment">//</span>
00913     <span class="comment">// This implies that:</span>
00914     <span class="comment">//</span>
00915     <span class="comment">// 1. The channel is a message channel.</span>
00916     <span class="comment">//</span>
00917     <span class="comment">// 2. The channel is being accessed by a client thread.</span>
00918     <span class="comment">//</span>
00919     <span class="comment">// 3. The channel is connected to a listen channel.</span>
00920     <span class="comment">//</span>
00921     <span class="comment">// 4. There is currently no client thread channel owner.</span>
00922     <span class="comment">//</span>
00923     <span class="comment">// 5. There is currently no server thread channel owner.</span>
00924     <span class="comment">//</span>
00925 
00926     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00927         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;WaitIrql);
00928         <span class="keywordflow">if</span> (MessageChannel-&gt;State != <a class="code" href="../../d4/d9/ke_8h.html#a409a230">ClientIdle</a>) {
00929 
00930             <span class="comment">//</span>
00931             <span class="comment">// The message channel is in the wrong state.</span>
00932             <span class="comment">//</span>
00933 
00934             <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;WaitIrql);
00935             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER; <span class="comment">// **** fix ****</span>
00936 
00937         } <span class="keywordflow">else</span> {
00938 
00939             <span class="comment">//</span>
00940             <span class="comment">// Set the channel state, set the client owner thread, and</span>
00941             <span class="comment">// rendezvous with a server thread.</span>
00942             <span class="comment">//</span>
00943 
00944             MessageChannel-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a409a231">ClientSendWaitReply</a>;
00945             MessageChannel-&gt;ClientThread = <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00946             <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;Channel = MessageChannel;
00947             ServerChannel = MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o6">ServerChannel</a>;
00948             <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a> = <a class="code" href="../../d4/d6/channel_8c.html#a6">KiRendezvousWithThread</a>(ServerChannel, PreviousMode);
00949 
00950             <span class="comment">//</span>
00951             <span class="comment">// Control is returned when:</span>
00952             <span class="comment">//</span>
00953             <span class="comment">// 1. The client thread is being terminated (USER_APC).</span>
00954             <span class="comment">//</span>
00955             <span class="comment">// 2. A rendezvous with a server thread has occured.</span>
00956             <span class="comment">//</span>
00957             <span class="comment">// N.B. If the status value is less than zero, then it</span>
00958             <span class="comment">//      is the address of the server thread.</span>
00959             <span class="comment">//</span>
00960 
00961             <span class="keywordflow">if</span> ((LONG)<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a> &lt; 0) {
00962 
00963                 <span class="comment">//</span>
00964                 <span class="comment">// The server thread is returned as the rendezvous status</span>
00965                 <span class="comment">// with the thread in the transition state. Get the address</span>
00966                 <span class="comment">// of the server thread system view, establish an exception</span>
00967                 <span class="comment">// handler, and transfer the message text from the client's</span>
00968                 <span class="comment">// buffer to the server's receive buffer. If an exception</span>
00969                 <span class="comment">// occurs during the copy, then return the exception code</span>
00970                 <span class="comment">// as the service status.</span>
00971                 <span class="comment">//</span>
00972 
00973                 ServerView = <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;SystemView;
00974                 <span class="keywordflow">if</span> (Length != 0) {
00975                     <span class="keywordflow">try</span> {
00976                         RtlCopyMemory(ServerView + 1, Text, Length);
00977 
00978                     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00979                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00980                     }
00981                 }
00982 
00983                 <span class="comment">//</span>
00984                 <span class="comment">// Set the channel message parameters.</span>
00985                 <span class="comment">//</span>
00986 
00987                 ServerView-&gt;Text = (PVOID)(<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;ThreadView + 1);
00988                 ServerView-&gt;Length = Length;
00989                 ServerView-&gt;Context = MessageChannel-&gt;ServerContext;
00990                 ServerView-&gt;Base = Text;
00991                 ServerView-&gt;Close = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00992 
00993                 <span class="comment">//</span>
00994                 <span class="comment">// Raise IRQL to dispatch level, lock the dispatcher</span>
00995                 <span class="comment">// database and check if the message was successfully</span>
00996                 <span class="comment">// transfered to the server's receive buffer. If the</span>
00997                 <span class="comment">// message was successfully transfered, then set the</span>
00998                 <span class="comment">// channel state, set the server thread address, set</span>
00999                 <span class="comment">// the address of the message channel in the server</span>
01000                 <span class="comment">// thread, increment the message channel reference</span>
01001                 <span class="comment">// count, fill in the message parameters, and switch</span>
01002                 <span class="comment">// directly to the server thread. Otherwise, set the</span>
01003                 <span class="comment">// channel state, and reready the server thread for</span>
01004                 <span class="comment">// execution.</span>
01005                 <span class="comment">//</span>
01006 
01007                 <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;WaitIrql);
01008                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01009                     MessageChannel-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a409a234">ServerReceiveMessage</a>;
01010                     MessageChannel-&gt;ServerThread = <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>;
01011                     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(MessageChannel);
01012                     <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;Channel = MessageChannel;
01013                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = KiSwitchToThread(<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>,
01014                                               <a class="code" href="../../d4/d9/ke_8h.html#a407a218">WrRendezvous</a>,
01015                                               PreviousMode,
01016                                               &amp;MessageChannel-&gt;ReceiveEvent);
01017 
01018                     <span class="comment">//</span>
01019                     <span class="comment">// If the send and subsequent reply from the server</span>
01020                     <span class="comment">// thread is successful, then attempt to write the</span>
01021                     <span class="comment">// address of the reply message address. If the write</span>
01022                     <span class="comment">// attempt fails, then do not report an error. When</span>
01023                     <span class="comment">// the caller attempts to access the message address,</span>
01024                     <span class="comment">// an access violation will occur.</span>
01025                     <span class="comment">//</span>
01026 
01027                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01028                         <span class="keywordflow">try</span> {
01029                             *Message = <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;ThreadView;
01030 
01031                         } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
01032                         }
01033                     }
01034 
01035                 } <span class="keywordflow">else</span> {
01036 
01037                     <span class="comment">//</span>
01038                     <span class="comment">// The send message was not successfully transfered</span>
01039                     <span class="comment">// to the server receive buffer because of an access</span>
01040                     <span class="comment">// violation encountered durring the access to the</span>
01041                     <span class="comment">// client buffer.</span>
01042                     <span class="comment">//</span>
01043 
01044                     MessageChannel-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a409a230">ClientIdle</a>;
01045                     MessageChannel-&gt;ClientThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01046                     <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;Channel = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01047                     <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitStatus = STATUS_KERNEL_APC;
01048                     <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>);
01049                     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;WaitIrql);
01050                 }
01051 
01052             } <span class="keywordflow">else</span> {
01053 
01054                 <span class="comment">//</span>
01055                 <span class="comment">// The client thread is terminating and the channel</span>
01056                 <span class="comment">// structures will be cleaned up by the termination</span>
01057                 <span class="comment">// code.</span>
01058                 <span class="comment">//</span>
01059 
01060                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>;
01061             }
01062         }
01063 
01064         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MessageChannel);
01065     }
01066 
01067     <span class="comment">//</span>
01068     <span class="comment">// Return service status.</span>
01069     <span class="comment">//</span>
01070 
01071     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01072 
01073 <span class="preprocessor">#else</span>
01074 <span class="preprocessor"></span>
01075     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
01076 
01077 <span class="preprocessor">#endif</span>
01078 <span class="preprocessor"></span>
01079 }
01080 
01081 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01082"></a><a class="code" href="../../d4/d6/channel_8c.html#a12">01082</a> <a class="code" href="../../d4/d6/channel_8c.html#a12">NtSetContextChannel</a> (
01083     IN PVOID Context
01084     )
01085 
01086 <span class="comment">/*++</span>
01087 <span class="comment"></span>
01088 <span class="comment">Routine Description:</span>
01089 <span class="comment"></span>
01090 <span class="comment">    This function stores a context value for the current associated</span>
01091 <span class="comment">    message channel.</span>
01092 <span class="comment"></span>
01093 <span class="comment">    N.B. This function can only be executed from a server thread that</span>
01094 <span class="comment">        has an associated message channel.</span>
01095 <span class="comment"></span>
01096 <span class="comment">Arguments:</span>
01097 <span class="comment"></span>
01098 <span class="comment">    Context - Supplies a context value that is to be stored in the</span>
01099 <span class="comment">        associated message channel.</span>
01100 <span class="comment"></span>
01101 <span class="comment">Return Value:</span>
01102 <span class="comment"></span>
01103 <span class="comment">    If the channel information is set, then a success status is returned.</span>
01104 <span class="comment">    Otherwise, a failure status is returned.</span>
01105 <span class="comment"></span>
01106 <span class="comment">--*/</span>
01107 
01108 {
01109 
01110 <span class="preprocessor">#if 0</span>
01111 <span class="preprocessor"></span>
01112     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> MessageChannel;
01113     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> CurrentThread;
01114     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01115 
01116     <span class="comment">//</span>
01117     <span class="comment">// If the thread has an assoicated channel and the server thread for</span>
01118     <span class="comment">// the channel is the current thread, then store the channel context.</span>
01119     <span class="comment">//</span>
01120 
01121     CurrentThread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
01122     MessageChannel = CurrentThread-&gt;Channel;
01123     <span class="keywordflow">if</span> ((MessageChannel == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01124         (CurrentThread != MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o4">ServerThread</a>)) {
01125         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER; <span class="comment">// ****** FIX *****</span>
01126 
01127     } <span class="keywordflow">else</span> {
01128         MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o5">ServerContext</a> = Context;
01129         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01130     }
01131 
01132     <span class="comment">//</span>
01133     <span class="comment">// Return service status.</span>
01134     <span class="comment">//</span>
01135 
01136     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01137 
01138 <span class="preprocessor">#else</span>
01139 <span class="preprocessor"></span>
01140     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
01141 
01142 <span class="preprocessor">#endif</span>
01143 <span class="preprocessor"></span>
01144 }
01145 
01146 <span class="preprocessor">#if 0</span>
01147 <span class="preprocessor"></span>
01148 
01149 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01150 <a class="code" href="../../d4/d6/channel_8c.html#a2">KiAllocateReceiveBufferChannel</a> (
01151     VOID
01152     )
01153 
01154 <span class="comment">/*++</span>
01155 <span class="comment"></span>
01156 <span class="comment">Routine Description:</span>
01157 <span class="comment"></span>
01158 <span class="comment">    This function creates an unnamed section with a single page, maps</span>
01159 <span class="comment">    a view of the section into the current process and into the system</span>
01160 <span class="comment">    address space, and associates the view with the current thread.</span>
01161 <span class="comment"></span>
01162 <span class="comment">Arguments:</span>
01163 <span class="comment"></span>
01164 <span class="comment">    None.</span>
01165 <span class="comment"></span>
01166 <span class="comment">Return Value:</span>
01167 <span class="comment"></span>
01168 <span class="comment">    If a channel receive buffer is not allocated, then raise an exception.</span>
01169 <span class="comment"></span>
01170 <span class="comment">--*/</span>
01171 
01172 {
01173 
01174     LARGE_INTEGER MaximumSize;
01175     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01176     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01177     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
01178     LARGE_INTEGER ViewOffset;
01179     ULONG ViewSize;
01180 
01181     <span class="comment">//</span>
01182     <span class="comment">// Create an unnamed section object.</span>
01183     <span class="comment">//</span>
01184 
01185     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
01186 
01187     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Thread-&gt;Section == NULL);
01188 
01189     MaximumSize.QuadPart = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01190     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a20">MmCreateSection</a>(&amp;Thread-&gt;Section,
01191                              0,
01192                              NULL,
01193                              &amp;MaximumSize,
01194                              PAGE_READWRITE,
01195                              SEC_COMMIT,
01196                              NULL,
01197                              NULL);
01198 
01199     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01200 
01201         <span class="comment">//</span>
01202         <span class="comment">// Map a view of the section into the current process.</span>
01203         <span class="comment">//</span>
01204 
01205         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01206         ViewOffset.QuadPart = 0;
01207         ViewSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01208         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a>(Thread-&gt;Section,
01209                                     Process,
01210                                     &amp;Thread-&gt;ThreadView,
01211                                     0,
01212                                     ViewSize,
01213                                     &amp;ViewOffset,
01214                                     &amp;ViewSize,
01215                                     ViewUnmap,
01216                                     0,
01217                                     PAGE_READWRITE);
01218 
01219         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01220 
01221             <span class="comment">//</span>
01222             <span class="comment">// Map a view of the section into the system address</span>
01223             <span class="comment">// space.</span>
01224             <span class="comment">//</span>
01225 
01226             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a27">MmMapViewInSystemSpace</a>(Thread-&gt;Section,
01227                                             &amp;Thread-&gt;SystemView,
01228                                             &amp;ViewSize);
01229 
01230             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01231                 <span class="keywordflow">return</span>;
01232             }
01233 
01234             <a class="code" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a>(Process, Thread-&gt;ThreadView);
01235         }
01236 
01237         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread-&gt;Section);
01238     }
01239 
01240     <span class="comment">//</span>
01241     <span class="comment">// The allocation of a receive buffer was not successful. Raise an</span>
01242     <span class="comment">// exception that will be caught by the caller.</span>
01243     <span class="comment">//</span>
01244 
01245     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(Status);
01246     <span class="keywordflow">return</span>;
01247 }
01248 
01249 BOOLEAN
01250 <a class="code" href="../../d0/d0/ki_8h.html#a87">KiChannelInitialization</a> (
01251     VOID
01252     )
01253 
01254 <span class="comment">/*++</span>
01255 <span class="comment"></span>
01256 <span class="comment">Routine Description:</span>
01257 <span class="comment"></span>
01258 <span class="comment">    This function creates the channel object type descriptor at system</span>
01259 <span class="comment">    initialization and stores the address of the object type descriptor</span>
01260 <span class="comment">    in global storage.</span>
01261 <span class="comment"></span>
01262 <span class="comment">Arguments:</span>
01263 <span class="comment"></span>
01264 <span class="comment">    None.</span>
01265 <span class="comment"></span>
01266 <span class="comment">Return Value:</span>
01267 <span class="comment"></span>
01268 <span class="comment">    A value of TRUE is returned if the channel object type descriptor is</span>
01269 <span class="comment">    successfully initialized. Otherwise a value of FALSE is returned.</span>
01270 <span class="comment"></span>
01271 <span class="comment">--*/</span>
01272 
01273 {
01274 
01275     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
01276     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01277     UNICODE_STRING TypeName;
01278 
01279     <span class="comment">//</span>
01280     <span class="comment">// Initialize string descriptor.</span>
01281     <span class="comment">//</span>
01282 
01283     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;TypeName, L<span class="stringliteral">"Channel"</span>);
01284 
01285     <span class="comment">//</span>
01286     <span class="comment">// Create channel object type descriptor.</span>
01287     <span class="comment">//</span>
01288 
01289     RtlZeroMemory(&amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>(ObjectTypeInitializer));
01290     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o0">Length</a> = <span class="keyword">sizeof</span>(ObjectTypeInitializer);
01291     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d4/d6/channel_8c.html#a1">KiChannelMapping</a>;
01292     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
01293     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d1/struct__ECHANNEL.html">ECHANNEL</a>);
01294     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = CHANNEL_ALL_ACCESS;
01295     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = OBJ_EXCLUSIVE | OBJ_INHERIT | OBJ_PERMANENT;
01296     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a> = <a class="code" href="../../d4/d6/channel_8c.html#a3">KiCloseChannel</a>;
01297     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d4/d6/channel_8c.html#a4">KiDeleteChannel</a>;
01298     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;TypeName,
01299                                 &amp;ObjectTypeInitializer,
01300                                 NULL,
01301                                 &amp;KeChannelType);
01302 
01303     <span class="comment">//</span>
01304     <span class="comment">// If the channel object type descriptor was successfully created, then</span>
01305     <span class="comment">// return a value of TRUE. Otherwise return a value of FALSE.</span>
01306     <span class="comment">//</span>
01307 
01308     <span class="keywordflow">return</span> (BOOLEAN)(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01309 }
01310 
01311 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01312 <a class="code" href="../../d4/d6/channel_8c.html#a3">KiCloseChannel</a> (
01313     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01314     IN PVOID Object,
01315     IN ACCESS_MASK GrantedAccess,
01316     IN ULONG ProcessHandleCount,
01317     IN ULONG SystemHandleCount
01318     )
01319 
01320 <span class="comment">/*++</span>
01321 <span class="comment"></span>
01322 <span class="comment">Routine Description:</span>
01323 <span class="comment"></span>
01324 <span class="comment">    This function is called when a handle to a channel is closed. If the</span>
01325 <span class="comment">    hanlde is the last handle in the process to the channel object and</span>
01326 <span class="comment">    the channel object is a message channel, then send a message to the</span>
01327 <span class="comment">    server indicating that the client handle is being closed.</span>
01328 <span class="comment"></span>
01329 <span class="comment">Arguments:</span>
01330 <span class="comment"></span>
01331 <span class="comment">    Object - Supplies a pointer to an executive channel.</span>
01332 <span class="comment"></span>
01333 <span class="comment">Return Value:</span>
01334 <span class="comment"></span>
01335 <span class="comment">    None.</span>
01336 <span class="comment"></span>
01337 <span class="comment">--*/</span>
01338 
01339 {
01340     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PECHANNEL</a> MessageChannel = (<a class="code" href="../../d9/d1/struct__ECHANNEL.html">PECHANNEL</a>)Object;
01341 
01342     <span class="comment">//</span>
01343     <span class="comment">// If the object is a message channel and hte last handle is being</span>
01344     <span class="comment">// closed, then send a message to the server indicating that the</span>
01345     <span class="comment">// channel is being closed.</span>
01346     <span class="comment">//</span>
01347 
01348     <span class="keywordflow">if</span> ((MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o6">ServerChannel</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01349         (ProcessHandleCount == 1)) {
01350     }
01351 
01352     <span class="keywordflow">return</span>;
01353 }
01354 
01355 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01356 <a class="code" href="../../d4/d6/channel_8c.html#a4">KiDeleteChannel</a> (
01357     IN PVOID Object
01358     )
01359 
01360 <span class="comment">/*++</span>
01361 <span class="comment"></span>
01362 <span class="comment">Routine Description:</span>
01363 <span class="comment"></span>
01364 <span class="comment">    This function is the delete routine for channel objects. Its function</span>
01365 <span class="comment">    is to ...</span>
01366 <span class="comment"></span>
01367 <span class="comment">Arguments:</span>
01368 <span class="comment"></span>
01369 <span class="comment">    Object - Supplies a pointer to an executive channel.</span>
01370 <span class="comment"></span>
01371 <span class="comment">Return Value:</span>
01372 <span class="comment"></span>
01373 <span class="comment">    None.</span>
01374 <span class="comment"></span>
01375 <span class="comment">--*/</span>
01376 
01377 {
01378 
01379     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> ChannelObject = (<a class="code" href="../../d9/d1/struct__ECHANNEL.html">PECHANNEL</a>)Object;
01380 
01381     <span class="comment">//</span>
01382     <span class="comment">// If the channel is a message channel, then dereference the connnected</span>
01383     <span class="comment">// server channel.</span>
01384     <span class="comment">//</span>
01385 
01386     <span class="keywordflow">if</span> (ChannelObject-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o6">ServerChannel</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01387         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ChannelObject-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o6">ServerChannel</a>);
01388     }
01389 
01390     <span class="keywordflow">return</span>;
01391 }
01392 
01393 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01394 <a class="code" href="../../d0/d0/ki_8h.html#a88">KiRundownChannel</a> (
01395     VOID
01396     )
01397 
01398 <span class="comment">/*++</span>
01399 <span class="comment"></span>
01400 <span class="comment">Routine Description:</span>
01401 <span class="comment"></span>
01402 <span class="comment">    This function runs down associated channel object and receive buffers</span>
01403 <span class="comment">    when the a thread is terminated.</span>
01404 <span class="comment"></span>
01405 <span class="comment">Arguments:</span>
01406 <span class="comment"></span>
01407 <span class="comment">    None.</span>
01408 <span class="comment"></span>
01409 <span class="comment">Return Value:</span>
01410 <span class="comment"></span>
01411 <span class="comment">    None.</span>
01412 <span class="comment"></span>
01413 <span class="comment">--*/</span>
01414 
01415 {
01416 
01417     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
01418 
01419     <span class="comment">//</span>
01420     <span class="comment">// If the current thread has an associated receive buffer, then unmap</span>
01421     <span class="comment">// the receive buffer and dereference the underlying section.</span>
01422     <span class="comment">//</span>
01423 
01424     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
01425     <span class="keywordflow">if</span> (Thread-&gt;Section != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01426         <a class="code" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a>(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(), Thread-&gt;ThreadView);
01427         <a class="code" href="../../d3/d5/mapview_8c.html#a29">MmUnmapViewInSystemSpace</a>(Thread-&gt;SystemView);
01428         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread-&gt;Section);
01429         Thread-&gt;Section = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01430     }
01431 
01432     <span class="comment">//</span>
01433     <span class="comment">// If the current thread has an associated channel, then ...</span>
01434     <span class="comment">//</span>
01435 
01436     <span class="keywordflow">return</span>;
01437 }
01438 
01439 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01440 <a class="code" href="../../d4/d6/channel_8c.html#a5">KiListenChannel</a> (
01441     IN <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> ServerChannel,
01442     IN KPROCESSOR_MODE WaitMode,
01443     OUT PCHANNEL_MESSAGE *Message
01444     )
01445 
01446 <span class="comment">/*++</span>
01447 <span class="comment"></span>
01448 <span class="comment">Routine Description:</span>
01449 <span class="comment"></span>
01450 <span class="comment">    This function listens for a client message to arrive.</span>
01451 <span class="comment"></span>
01452 <span class="comment">    N.B. This function can only be executed from a server thread.</span>
01453 <span class="comment"></span>
01454 <span class="comment">Arguments:</span>
01455 <span class="comment"></span>
01456 <span class="comment">    ServerChannel - Supplies a pointer to a litent channel on which the</span>
01457 <span class="comment">        server thread listens.</span>
01458 <span class="comment"></span>
01459 <span class="comment">    WaitMode - Supplies the processor wait mode.</span>
01460 <span class="comment"></span>
01461 <span class="comment">    Message - Supplies a pointer to a variable that receives a pointer</span>
01462 <span class="comment">        to the client message header.</span>
01463 <span class="comment"></span>
01464 <span class="comment">Return Value:</span>
01465 <span class="comment"></span>
01466 <span class="comment">    If the function is successfully completed, then a success status is</span>
01467 <span class="comment">    returned. Otherwise, a failure status is returned.</span>
01468 <span class="comment"></span>
01469 <span class="comment">--*/</span>
01470 
01471 {
01472 
01473     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> ClearToSendEvent;
01474     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
01475     <a class="code" href="../../d7/d7/struct__KQUEUE.html">PKQUEUE</a> Queue;
01476     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>;
01477     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a> WaitBlock;
01478     PLIST_ENTRY WaitEntry;
01479     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> WaitStatus;
01480 
01481     <span class="comment">//</span>
01482     <span class="comment">// Raise IRQL to dispatch level and lock the dispatcher database.</span>
01483     <span class="comment">//</span>
01484 
01485     <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
01486     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql);
01487 
01488     <span class="comment">//</span>
01489     <span class="comment">// Start of wait loop.</span>
01490     <span class="comment">//</span>
01491     <span class="comment">// Note this loop is repeated if a kernel APC is delivered in the</span>
01492     <span class="comment">// middle of the wait or a kernel APC is pending on the first attempt</span>
01493     <span class="comment">// through the loop.</span>
01494     <span class="comment">//</span>
01495 
01496     <span class="keywordflow">do</span> {
01497 
01498         <span class="comment">//</span>
01499         <span class="comment">// Check if there is a thread waiting on the clear to send event.</span>
01500         <span class="comment">//</span>
01501 
01502         ClearToSendEvent = &amp;ServerChannel-&gt;ClearToSendEvent;
01503         WaitEntry = ClearToSendEvent-&gt;<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>.Flink;
01504         <span class="keywordflow">if</span> (WaitEntry != &amp;ClearToSendEvent-&gt;<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>) {
01505             WaitBlock = CONTAINING_RECORD(WaitEntry, <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a>, WaitListEntry);
01506             <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> = WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o1">Thread</a>;
01507 
01508             <span class="comment">//</span>
01509             <span class="comment">// Remove the wait block from the wait list of the receive event,</span>
01510             <span class="comment">// and remove the client thread from the wait list.</span>
01511             <span class="comment">//</span>
01512 
01513             RemoveEntryList(&amp;WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o0">WaitListEntry</a>);
01514             RemoveEntryList(&amp;<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;WaitListEntry);
01515 
01516             <span class="comment">//</span>
01517             <span class="comment">// If the client thread is processing a queue entry, then increment the</span>
01518             <span class="comment">// count of currently active threads.</span>
01519             <span class="comment">//</span>
01520 
01521             Queue = <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;Queue;
01522             <span class="keywordflow">if</span> (Queue != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01523                 Queue-&gt;<a class="code" href="../../d7/d7/struct__KQUEUE.html#o2">CurrentCount</a> += 1;
01524             }
01525 
01526             <span class="comment">//</span>
01527             <span class="comment">// Set the wait completion status to kernel APC so the client</span>
01528             <span class="comment">// will attempt another rendezvous and ready the client thread</span>
01529             <span class="comment">// for execution.</span>
01530             <span class="comment">//</span>
01531 
01532             <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;WaitStatus = STATUS_KERNEL_APC;
01533             <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(ClientThread);
01534         }
01535 
01536         <span class="comment">//</span>
01537         <span class="comment">// Test to determine if a kernel APC is pending.</span>
01538         <span class="comment">//</span>
01539         <span class="comment">// If a kernel APC is pending and the previous IRQL was less than</span>
01540         <span class="comment">// APC_LEVEL, then a kernel APC was queued by another processor</span>
01541         <span class="comment">// just after IRQL was raised to DISPATCH_LEVEL, but before the</span>
01542         <span class="comment">// dispatcher database was locked.</span>
01543         <span class="comment">//</span>
01544         <span class="comment">// N.B. that this can only happen in a multiprocessor system.</span>
01545         <span class="comment">//</span>
01546 
01547         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;ApcState.KernelApcPending &amp;&amp;
01548             (<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>)) {
01549 
01550             <span class="comment">//</span>
01551             <span class="comment">// Unlock the dispatcher database and lower IRQL to its</span>
01552             <span class="comment">// previous value. An APC interrupt will immediately occur</span>
01553             <span class="comment">// which will result in the delivery of the kernel APC if</span>
01554             <span class="comment">// possible.</span>
01555             <span class="comment">//</span>
01556 
01557             <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql);
01558 
01559         } <span class="keywordflow">else</span> {
01560 
01561             <span class="comment">//</span>
01562             <span class="comment">// Test if a user APC is pending.</span>
01563             <span class="comment">//</span>
01564 
01565             <span class="keywordflow">if</span> ((WaitMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
01566                 (<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;ApcState.UserApcPending)) {
01567                 WaitStatus = STATUS_USER_APC;
01568                 <span class="keywordflow">break</span>;
01569             }
01570 
01571             <span class="comment">//</span>
01572             <span class="comment">// Construct a wait block for the clear to send event object.</span>
01573             <span class="comment">//</span>
01574 
01575             WaitBlock = &amp;<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitBlock[0];
01576             <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitBlockList = WaitBlock;
01577             <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)0;
01578             WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o2">Object</a> = (PVOID)&amp;ServerChannel-&gt;ReceiveEvent;
01579             WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a> = WaitBlock;
01580             WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o4">WaitKey</a> = (CSHORT)STATUS_SUCCESS;
01581             WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o5">WaitType</a> = WaitAny;
01582             InsertTailList(&amp;ServerChannel-&gt;ReceiveEvent.Header.WaitListHead,
01583                            &amp;WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o0">WaitListEntry</a>);
01584 
01585             <span class="comment">//</span>
01586             <span class="comment">// If the current thread is processing a queue entry, then</span>
01587             <span class="comment">// attempt to activate another thread that is blocked on the</span>
01588             <span class="comment">// queue object.</span>
01589             <span class="comment">//</span>
01590 
01591             Queue = <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;Queue;
01592             <span class="keywordflow">if</span> (Queue != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01593                 <a class="code" href="../../d8/d3/queueobj_8c.html#a7">KiActivateWaiterQueue</a>(Queue);
01594             }
01595 
01596             <span class="comment">//</span>
01597             <span class="comment">// Set the thread wait parameters, set the thread dispatcher</span>
01598             <span class="comment">// state to Waiting, and insert the thread in the wait list.</span>
01599             <span class="comment">//</span>
01600 
01601             <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;Alertable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01602             <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitMode = WaitMode;
01603             <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitReason = <a class="code" href="../../d4/d9/ke_8h.html#a407a218">WrRendezvous</a>;
01604             <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitTime = KiQueryLowTickCount();
01605             <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>;
01606             <a class="code" href="../../d0/d0/ki_8h.html#a15">KiInsertWaitList</a>(WaitMode, ServerThread);
01607 
01608             <span class="comment">//</span>
01609             <span class="comment">// Switch context to selected thread.</span>
01610             <span class="comment">//</span>
01611             <span class="comment">// Control is returned at the original IRQL.</span>
01612             <span class="comment">//</span>
01613 
01614             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == FALSE);
01615             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql &lt;= DISPATCH_LEVEL);
01616 
01617             WaitStatus = <a class="code" href="../../d0/d0/ki_8h.html#a138">KiSwapThread</a>();
01618 
01619             <span class="comment">//</span>
01620             <span class="comment">// If the thread was not awakened to deliver a kernel mode APC,</span>
01621             <span class="comment">// then return wait status.</span>
01622             <span class="comment">//</span>
01623 
01624             <span class="keywordflow">if</span> (WaitStatus != STATUS_KERNEL_APC) {
01625 
01626                 <span class="comment">//</span>
01627                 <span class="comment">// If a client message was successfully received, then</span>
01628                 <span class="comment">// attempt to write the address of the send message</span>
01629                 <span class="comment">// address. If the write attempt fails, then do not</span>
01630                 <span class="comment">// report an error. When the caller attempts to access</span>
01631                 <span class="comment">// the message address, an access violation will occur.</span>
01632                 <span class="comment">//</span>
01633 
01634                   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(WaitStatus)) {
01635                       <span class="keywordflow">try</span> {
01636                           *Message = <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;ThreadView;
01637 
01638                       } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
01639                       }
01640                   }
01641 
01642                 <span class="keywordflow">return</span> WaitStatus;
01643             }
01644         }
01645 
01646         <span class="comment">//</span>
01647         <span class="comment">// Raise IRQL to DISPATCH_LEVEL and lock the dispatcher database.</span>
01648         <span class="comment">//</span>
01649 
01650         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql);
01651     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01652 
01653     <span class="comment">//</span>
01654     <span class="comment">// Unlock the dispatcher database and return the target thread.</span>
01655     <span class="comment">//</span>
01656 
01657     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql);
01658     <span class="keywordflow">return</span> WaitStatus;
01659 }
01660 
01661 <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>
01662 <a class="code" href="../../d4/d6/channel_8c.html#a6">KiRendezvousWithThread</a> (
01663     IN <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> WaitChannel,
01664     IN ULONG WaitMode
01665     )
01666 
01667 <span class="comment">/*++</span>
01668 <span class="comment"></span>
01669 <span class="comment">Routine Description:</span>
01670 <span class="comment"></span>
01671 <span class="comment">    This function performs a rendezvous with a thread waiting on the</span>
01672 <span class="comment">    channel receive event.</span>
01673 <span class="comment"></span>
01674 <span class="comment">    N.B. This routine is called with the dispatcher database locked.</span>
01675 <span class="comment"></span>
01676 <span class="comment">    N.B. The wait IRQL is assumed to be set for the current thread.</span>
01677 <span class="comment"></span>
01678 <span class="comment">    N.B. Control is returned from this function with the dispatcher</span>
01679 <span class="comment">        database unlocked.</span>
01680 <span class="comment"></span>
01681 <span class="comment">Arguments:</span>
01682 <span class="comment"></span>
01683 <span class="comment">    WaitChannel - Supplies a pointer to a channel whose receive event</span>
01684 <span class="comment">        is the target of the rendezvous operation.</span>
01685 <span class="comment"></span>
01686 <span class="comment">    WaitMode - Supplies the processor wait mode.</span>
01687 <span class="comment"></span>
01688 <span class="comment">Return Value:</span>
01689 <span class="comment"></span>
01690 <span class="comment">    If a thread rendezvous is successfully performed, then the address</span>
01691 <span class="comment">    of the thread object is returned as the completion status. Otherwise,</span>
01692 <span class="comment">    if the wait completes because of a timeout or because the thread is</span>
01693 <span class="comment">    being terminated, then the appropriate status is returned.</span>
01694 <span class="comment"></span>
01695 <span class="comment">--*/</span>
01696 
01697 {
01698 
01699     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> CurrentThread;
01700     <a class="code" href="../../d7/d7/struct__KQUEUE.html">PKQUEUE</a> Queue;
01701     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> TargetThread;
01702     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a> WaitBlock;
01703     PLIST_ENTRY WaitEntry;
01704     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> WaitStatus;
01705 
01706     <span class="comment">//</span>
01707     <span class="comment">// Start of wait loop.</span>
01708     <span class="comment">//</span>
01709     <span class="comment">// Note this loop is repeated if a kernel APC is delivered in the</span>
01710     <span class="comment">// middle of the wait or a kernel APC is pending on the first attempt</span>
01711     <span class="comment">// through the loop.</span>
01712     <span class="comment">//</span>
01713     <span class="comment">// If the rendezvous event wait list is not empty, then remove the first</span>
01714     <span class="comment">// entry from the list, compute the address of the respective thread,</span>
01715     <span class="comment">// cancel the thread timer if appropraite, and return the thread address.</span>
01716     <span class="comment">// Otherwise, wait for a thread to rendezvous with.</span>
01717     <span class="comment">//</span>
01718 
01719     CurrentThread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
01720     <span class="keywordflow">do</span> {
01721 
01722         <span class="comment">//</span>
01723         <span class="comment">// Check if there is a thread waiting on the rendezvous event.</span>
01724         <span class="comment">//</span>
01725 
01726         WaitEntry = WaitChannel-&gt;ReceiveEvent.Header.WaitListHead.Flink;
01727         <span class="keywordflow">if</span> (WaitEntry != &amp;WaitChannel-&gt;ReceiveEvent.Header.WaitListHead) {
01728             WaitBlock = CONTAINING_RECORD(WaitEntry, <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a>, WaitListEntry);
01729             TargetThread = WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o1">Thread</a>;
01730 
01731             <span class="comment">//</span>
01732             <span class="comment">// Remove the wait block from the wait list of the receive event,</span>
01733             <span class="comment">// and remove the target thread from the wait list.</span>
01734             <span class="comment">//</span>
01735 
01736             RemoveEntryList(&amp;WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o0">WaitListEntry</a>);
01737             RemoveEntryList(&amp;TargetThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o22">WaitListEntry</a>);
01738 
01739             <span class="comment">//</span>
01740             <span class="comment">// If the target thread is processing a queue entry, then increment the</span>
01741             <span class="comment">// count of currently active threads.</span>
01742             <span class="comment">//</span>
01743 
01744             Queue = TargetThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o37">Queue</a>;
01745             <span class="keywordflow">if</span> (Queue != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01746                 Queue-&gt;<a class="code" href="../../d7/d7/struct__KQUEUE.html#o2">CurrentCount</a> += 1;
01747             }
01748 
01749             <span class="comment">//</span>
01750             <span class="comment">// Set the thread state to transistion.</span>
01751             <span class="comment">//</span>
01752 
01753             TargetThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a406a197">Transition</a>;
01754             <span class="keywordflow">break</span>;
01755 
01756         } <span class="keywordflow">else</span> {
01757 
01758             <span class="comment">//</span>
01759             <span class="comment">// Test to determine if a kernel APC is pending.</span>
01760             <span class="comment">//</span>
01761             <span class="comment">// If a kernel APC is pending and the previous IRQL was less than</span>
01762             <span class="comment">// APC_LEVEL, then a kernel APC was queued by another processor</span>
01763             <span class="comment">// just after IRQL was raised to DISPATCH_LEVEL, but before the</span>
01764             <span class="comment">// dispatcher database was locked.</span>
01765             <span class="comment">//</span>
01766             <span class="comment">// N.B. that this can only happen in a multiprocessor system.</span>
01767             <span class="comment">//</span>
01768 
01769             <span class="keywordflow">if</span> (CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o3">KernelApcPending</a> &amp;&amp;
01770                 (CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a> &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>)) {
01771 
01772                 <span class="comment">//</span>
01773                 <span class="comment">// Unlock the dispatcher database and lower IRQL to its</span>
01774                 <span class="comment">// previous value. An APC interrupt will immediately occur</span>
01775                 <span class="comment">// which will result in the delivery of the kernel APC if</span>
01776                 <span class="comment">// possible.</span>
01777                 <span class="comment">//</span>
01778 
01779                 <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
01780 
01781             } <span class="keywordflow">else</span> {
01782 
01783                 <span class="comment">//</span>
01784                 <span class="comment">// Test if a user APC is pending.</span>
01785                 <span class="comment">//</span>
01786 
01787                 <span class="keywordflow">if</span> ((WaitMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
01788                     (CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o4">UserApcPending</a>)) {
01789                     TargetThread = (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)STATUS_USER_APC;
01790                     <span class="keywordflow">break</span>;
01791                 }
01792 
01793                 <span class="comment">//</span>
01794                 <span class="comment">// Construct a wait block for the clear to send event object.</span>
01795                 <span class="comment">//</span>
01796 
01797                 WaitBlock = &amp;CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o28">WaitBlock</a>[0];
01798                 CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o21">WaitBlockList</a> = WaitBlock;
01799                 CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o16">WaitStatus</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)0;
01800                 WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o2">Object</a> = (PVOID)&amp;WaitChannel-&gt;ClearToSendEvent;
01801                 WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a> = WaitBlock;
01802                 WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o4">WaitKey</a> = (CSHORT)STATUS_SUCCESS;
01803                 WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o5">WaitType</a> = WaitAny;
01804                 InsertTailList(&amp;WaitChannel-&gt;ClearToSendEvent.Header.WaitListHead,
01805                                &amp;WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o0">WaitListEntry</a>);
01806 
01807                 <span class="comment">//</span>
01808                 <span class="comment">// If the current thread is processing a queue entry, then</span>
01809                 <span class="comment">// attempt to activate another thread that is blocked on the</span>
01810                 <span class="comment">// queue object.</span>
01811                 <span class="comment">//</span>
01812 
01813                 Queue = CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o37">Queue</a>;
01814                 <span class="keywordflow">if</span> (Queue != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01815                     <a class="code" href="../../d8/d3/queueobj_8c.html#a7">KiActivateWaiterQueue</a>(Queue);
01816                 }
01817 
01818                 <span class="comment">//</span>
01819                 <span class="comment">// Set the thread wait parameters, set the thread dispatcher</span>
01820                 <span class="comment">// state to Waiting, and insert the thread in the wait list.</span>
01821                 <span class="comment">//</span>
01822 
01823                 CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o57">Alertable</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01824                 CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o18">WaitMode</a> = (<a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>)WaitMode;
01825                 CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o20">WaitReason</a> = <a class="code" href="../../d4/d9/ke_8h.html#a407a218">WrRendezvous</a>;
01826                 CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o23">WaitTime</a> = KiQueryLowTickCount();
01827                 CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>;
01828                 <a class="code" href="../../d0/d0/ki_8h.html#a15">KiInsertWaitList</a>(WaitMode, CurrentThread);
01829 
01830                 <span class="comment">//</span>
01831                 <span class="comment">// Switch context to selected thread.</span>
01832                 <span class="comment">//</span>
01833                 <span class="comment">// Control is returned at the original IRQL.</span>
01834                 <span class="comment">//</span>
01835 
01836                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == FALSE);
01837                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a> &lt;= DISPATCH_LEVEL);
01838 
01839                 WaitStatus = <a class="code" href="../../d0/d0/ki_8h.html#a138">KiSwapThread</a>();
01840 
01841                 <span class="comment">//</span>
01842                 <span class="comment">// If the thread was not awakened to deliver a kernel mode APC,</span>
01843                 <span class="comment">// then return wait status.</span>
01844                 <span class="comment">//</span>
01845 
01846                 <span class="keywordflow">if</span> (WaitStatus != STATUS_KERNEL_APC) {
01847                     <span class="keywordflow">return</span> (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)WaitStatus;
01848                 }
01849             }
01850 
01851             <span class="comment">//</span>
01852             <span class="comment">// Raise IRQL to DISPATCH_LEVEL and lock the dispatcher database.</span>
01853             <span class="comment">//</span>
01854 
01855             <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
01856         }
01857 
01858     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01859 
01860     <span class="comment">//</span>
01861     <span class="comment">// Unlock the dispatcher database and return the target thread.</span>
01862     <span class="comment">//</span>
01863 
01864     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
01865     <span class="keywordflow">return</span> TargetThread;
01866 }
01867 
01868 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:23 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
