<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: debugsup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>debugsup.c</h1><a href="../../d4/d6/ppc_2debugsup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment">Copyright (c) 1993  IBM Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">   debugsup.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module contains routines which provide support for the</span>
00013 <span class="comment">    kernel debugger.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Lou Perazzoli (loup) 02-Aug-90</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Modified for PowerPC by Mark Mergen (mergen@watson.ibm.com) 6-Oct-93</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00026 
00027 PVOID
<a name="l00028"></a><a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a0">00028</a> <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a0">MmDbgReadCheck</a> (
00029     IN PVOID VirtualAddress
00030     )
00031 
00032 <span class="comment">/*++</span>
00033 <span class="comment"></span>
00034 <span class="comment">Routine Description:</span>
00035 <span class="comment"></span>
00036 <span class="comment">    PowerPC implementation specific:</span>
00037 <span class="comment"></span>
00038 <span class="comment">    This routine returns the virtual address which is valid (mapped)</span>
00039 <span class="comment">    for read access.</span>
00040 <span class="comment"></span>
00041 <span class="comment">    The address may be within the PowerPC kernel BAT or may be</span>
00042 <span class="comment">    otherwise valid and readable.</span>
00043 <span class="comment"></span>
00044 <span class="comment">Arguments:</span>
00045 <span class="comment"></span>
00046 <span class="comment">    VirtualAddress - Supplies the virtual address to check.</span>
00047 <span class="comment"></span>
00048 <span class="comment">Return Value:</span>
00049 <span class="comment"></span>
00050 <span class="comment">    Returns NULL if the address is not valid or readable, otherwise</span>
00051 <span class="comment">    returns the virtual address.</span>
00052 <span class="comment"></span>
00053 <span class="comment">Environment:</span>
00054 <span class="comment"></span>
00055 <span class="comment">    Kernel mode IRQL at DISPATCH_LEVEL or greater.</span>
00056 <span class="comment"></span>
00057 <span class="comment">--*/</span>
00058 
00059 {
00060     <span class="keywordflow">if</span> ((VirtualAddress &gt;= (PVOID)<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a>) &amp;&amp;
00061         (VirtualAddress &lt; (PVOID)<a class="code" href="../../d6/d7/halmips_8h.html#a445">KSEG2_BASE</a>)) {
00062         <span class="keywordflow">return</span> VirtualAddress;
00063     }
00064 
00065     <span class="keywordflow">if</span> ((VirtualAddress &gt;= (PVOID)KIPCR) &amp;&amp;
00066             (VirtualAddress &lt; (PVOID)(KIPCR2 + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>))) {
00067         <span class="keywordflow">return</span> VirtualAddress;
00068     }
00069 
00070     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (VirtualAddress)) {
00071         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00072     }
00073 
00074     <span class="keywordflow">return</span> VirtualAddress;
00075 }
00076 
00077 PVOID
<a name="l00078"></a><a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a1">00078</a> <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a1">MmDbgWriteCheck</a> (
00079     IN PVOID VirtualAddress
00080     )
00081 
00082 <span class="comment">/*++</span>
00083 <span class="comment"></span>
00084 <span class="comment">Routine Description:</span>
00085 <span class="comment"></span>
00086 <span class="comment">    PowerPC implementation specific:</span>
00087 <span class="comment"></span>
00088 <span class="comment">    This routine returns the virtual address which is valid (mapped)</span>
00089 <span class="comment">    for write access.</span>
00090 <span class="comment"></span>
00091 <span class="comment">    The address may be within the PowerPC kernel BAT or may be</span>
00092 <span class="comment">    otherwise valid and writable.</span>
00093 <span class="comment"></span>
00094 <span class="comment">Arguments:</span>
00095 <span class="comment"></span>
00096 <span class="comment">    VirtualAddress - Supplies the virtual address to check.</span>
00097 <span class="comment"></span>
00098 <span class="comment">Return Value:</span>
00099 <span class="comment"></span>
00100 <span class="comment">    Returns NULL if the address is not valid or writable, otherwise</span>
00101 <span class="comment">    returns the virtual address.</span>
00102 <span class="comment"></span>
00103 <span class="comment">Environment:</span>
00104 <span class="comment"></span>
00105 <span class="comment">    Kernel mode IRQL at DISPATCH_LEVEL or greater.</span>
00106 <span class="comment"></span>
00107 <span class="comment">--*/</span>
00108 
00109 {
00110     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00111 
00112     <span class="keywordflow">if</span> ((VirtualAddress &gt;= (PVOID)<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a>) &amp;&amp;
00113         (VirtualAddress &lt; (PVOID)<a class="code" href="../../d6/d7/halmips_8h.html#a445">KSEG2_BASE</a>)) {
00114         <span class="keywordflow">return</span> VirtualAddress;
00115     }
00116 
00117     <span class="keywordflow">if</span> ((VirtualAddress &gt;= (PVOID)KIPCR) &amp;&amp;
00118         (VirtualAddress &lt; (PVOID)(KIPCR2 + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>))) {
00119         <span class="keywordflow">return</span> VirtualAddress;
00120     }
00121 
00122     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (VirtualAddress)) {
00123         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00124     }
00125 
00126     <span class="comment">//</span>
00127     <span class="comment">// This is being added back in permanently since the PowerPC</span>
00128     <span class="comment">// hardware debug registers break in before the instruction</span>
00129     <span class="comment">// is executed. This will generally allow the kernel debugger</span>
00130     <span class="comment">// to step over the instruction that triggered the hardware</span>
00131     <span class="comment">// debug register breakpoint.</span>
00132     <span class="comment">//</span>
00133 
00134     <span class="keywordflow">if</span> (VirtualAddress &lt;= MM_HIGHEST_USER_ADDRESS) {
00135 
00136         <span class="comment">// This code is similar in spirit to that in the MIPS version.</span>
00137         <span class="comment">// It returns a writable alias for breakpoints in user pages.</span>
00138         <span class="comment">// However, it uses the virtual address reserved for the debugger,</span>
00139         <span class="comment">// rather than the wired-in KSEG0 translation available in MIPS.</span>
00140         <span class="comment">//</span>
00141         <span class="comment">// N.B. Microsoft says kernel debugger can't do user code at all.</span>
00142 
00143         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a4">MmDbgTranslatePhysicalAddress</a> (
00144                    <a class="code" href="../../d2/d1/mm_8h.html#a291">MmGetPhysicalAddress</a> (VirtualAddress) );
00145     }
00146 
00147     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
00148     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 0) {
00149         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00150     }
00151 
00152     <span class="keywordflow">return</span> VirtualAddress;
00153 }
00154 
00155 PVOID64
<a name="l00156"></a><a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a2">00156</a> <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a2">MmDbgReadCheck64</a> (
00157     IN PVOID64 VirtualAddress
00158     )
00159 
00160 <span class="comment">/*++</span>
00161 <span class="comment"></span>
00162 <span class="comment">Routine Description:</span>
00163 <span class="comment"></span>
00164 <span class="comment">    PowerPC implementation specific:</span>
00165 <span class="comment"></span>
00166 <span class="comment">    This routine returns the virtual address which is valid (mapped)</span>
00167 <span class="comment">    for read access.</span>
00168 <span class="comment"></span>
00169 <span class="comment">    The address may be within the PowerPC kernel BAT or may be</span>
00170 <span class="comment">    otherwise valid and readable.</span>
00171 <span class="comment"></span>
00172 <span class="comment">    NO 64-bit suport, return NULL.</span>
00173 <span class="comment"></span>
00174 <span class="comment">Arguments:</span>
00175 <span class="comment"></span>
00176 <span class="comment">    VirtualAddress - Supplies the virtual address to check.</span>
00177 <span class="comment"></span>
00178 <span class="comment">Return Value:</span>
00179 <span class="comment"></span>
00180 <span class="comment">    Returns NULL if the address is not valid or readable, otherwise</span>
00181 <span class="comment">    returns the virtual address.</span>
00182 <span class="comment"></span>
00183 <span class="comment">Environment:</span>
00184 <span class="comment"></span>
00185 <span class="comment">    Kernel mode IRQL at DISPATCH_LEVEL or greater.</span>
00186 <span class="comment"></span>
00187 <span class="comment">--*/</span>
00188 
00189 {
00190     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00191 }
00192 
00193 PVOID64
<a name="l00194"></a><a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a3">00194</a> <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a3">MmDbgWriteCheck64</a> (
00195     IN PVOID64 VirtualAddress
00196     )
00197 
00198 <span class="comment">/*++</span>
00199 <span class="comment"></span>
00200 <span class="comment">Routine Description:</span>
00201 <span class="comment"></span>
00202 <span class="comment">    PowerPC implementation specific:</span>
00203 <span class="comment"></span>
00204 <span class="comment">    This routine returns the virtual address which is valid (mapped)</span>
00205 <span class="comment">    for write access.</span>
00206 <span class="comment"></span>
00207 <span class="comment">    The address may be within the PowerPC kernel BAT or may be</span>
00208 <span class="comment">    otherwise valid and writable.</span>
00209 <span class="comment"></span>
00210 <span class="comment">    NO 64-bit suport, return NULL.</span>
00211 <span class="comment"></span>
00212 <span class="comment">Arguments:</span>
00213 <span class="comment"></span>
00214 <span class="comment">    VirtualAddress - Supplies the virtual address to check.</span>
00215 <span class="comment"></span>
00216 <span class="comment">Return Value:</span>
00217 <span class="comment"></span>
00218 <span class="comment">    Returns NULL if the address is not valid or writable, otherwise</span>
00219 <span class="comment">    returns the virtual address.</span>
00220 <span class="comment"></span>
00221 <span class="comment">Environment:</span>
00222 <span class="comment"></span>
00223 <span class="comment">    Kernel mode IRQL at DISPATCH_LEVEL or greater.</span>
00224 <span class="comment"></span>
00225 <span class="comment">--*/</span>
00226 
00227 {
00228 
00229     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00230 }
00231 
00232 PVOID
<a name="l00233"></a><a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a4">00233</a> <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a4">MmDbgTranslatePhysicalAddress</a> (
00234     IN PHYSICAL_ADDRESS PhysicalAddress
00235     )
00236 
00237 <span class="comment">/*++</span>
00238 <span class="comment"></span>
00239 <span class="comment">Routine Description:</span>
00240 <span class="comment"></span>
00241 <span class="comment">    PowerPC implementation specific:</span>
00242 <span class="comment"></span>
00243 <span class="comment">    This routine maps the specified physical address and returns</span>
00244 <span class="comment">    the virtual address which maps the physical address.</span>
00245 <span class="comment"></span>
00246 <span class="comment">    The next call to MmDbgTranslatePhyiscalAddress removes the</span>
00247 <span class="comment">    previous phyiscal address translation, hence on a single</span>
00248 <span class="comment">    physical address can be examined at a time (can't cross page</span>
00249 <span class="comment">    boundaries).</span>
00250 <span class="comment"></span>
00251 <span class="comment">Arguments:</span>
00252 <span class="comment"></span>
00253 <span class="comment">    PhysicalAddress - Supplies the phyiscal address to map and translate.</span>
00254 <span class="comment"></span>
00255 <span class="comment">Return Value:</span>
00256 <span class="comment"></span>
00257 <span class="comment">    The virtual address which corresponds to the phyiscal address.</span>
00258 <span class="comment"></span>
00259 <span class="comment">Environment:</span>
00260 <span class="comment"></span>
00261 <span class="comment">    Kernel mode IRQL at DISPATCH_LEVEL or greater.</span>
00262 <span class="comment"></span>
00263 <span class="comment">--*/</span>
00264 
00265 {
00266     PVOID BaseAddress;
00267 
00268     BaseAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (<a class="code" href="../../d4/d2/datalpha_8c.html#a18">MmDebugPte</a>);
00269 
00270     <a class="code" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, BaseAddress);
00271 
00272     *<a class="code" href="../../d4/d2/datalpha_8c.html#a18">MmDebugPte</a> = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
00273     <a class="code" href="../../d4/d2/datalpha_8c.html#a18">MmDebugPte</a>-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PhysicalAddress.LowPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00274 
00275     <span class="keywordflow">return</span> (PVOID)((ULONG)BaseAddress + <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(PhysicalAddress.LowPart));
00276 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
