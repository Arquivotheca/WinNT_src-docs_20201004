<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: regext.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>regext.c</h1><a href="../../d4/d6/regext_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    regext.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Kernel debugger extensions useful for the registry</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    John Vert (jvert) 7-Sep-1993</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Loaded as a kernel debugger extension</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">    John Vert (jvert) 7-Sep-1993</span>
00024 <span class="comment">        created</span>
00025 <span class="comment"></span>
00026 <span class="comment">--*/</span>
00027 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00028 <span class="preprocessor">#include &lt;windef.h&gt;</span>
00029 <span class="preprocessor">#include &lt;ntkdexts.h&gt;</span>
00030 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00031 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00032 
<a name="l00033"></a><a class="code" href="../../d4/d6/regext_8c.html#a0">00033</a> <a class="code" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html">HIVE_LIST_ENTRY</a> <a class="code" href="../../d4/d6/regext_8c.html#a0">HiveList</a>[8];
00034 
<a name="l00035"></a><a class="code" href="../../d4/d6/regext_8c.html#a1">00035</a> ULONG <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a>;
<a name="l00036"></a><a class="code" href="../../d4/d6/regext_8c.html#a2">00036</a> ULONG <a class="code" href="../../d4/d6/regext_8c.html#a2">TotalPresentPages</a>;
00037 
<a name="l00038"></a><a class="code" href="../../d4/d6/regext_8c.html#a3">00038</a> ULONG <a class="code" href="../../d4/d6/regext_8c.html#a3">TotalKcbs</a>;
<a name="l00039"></a><a class="code" href="../../d4/d6/regext_8c.html#a4">00039</a> ULONG <a class="code" href="../../d4/d6/regext_8c.html#a4">TotalKcbName</a>;
00040 
<a name="l00041"></a><a class="code" href="../../d4/d6/regext_8c.html#a5">00041</a> BOOLEAN <a class="code" href="../../d4/d6/regext_8c.html#a5">SavePages</a>;
<a name="l00042"></a><a class="code" href="../../d4/d6/regext_8c.html#a6">00042</a> BOOLEAN <a class="code" href="../../d4/d6/regext_8c.html#a6">RestorePages</a>;
<a name="l00043"></a><a class="code" href="../../d4/d6/regext_8c.html#a7">00043</a> FILE *<a class="code" href="../../d4/d6/regext_8c.html#a7">TempFile</a>;
00044 
<a name="l00045"></a><a class="code" href="../../d4/d6/regext_8c.html#a8">00045</a> PNTKD_OUTPUT_ROUTINE <a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>;
<a name="l00046"></a><a class="code" href="../../d4/d6/regext_8c.html#a9">00046</a> PNTKD_GET_EXPRESSION <a class="code" href="../../d4/d6/regext_8c.html#a9">lpGetExpressionRoutine</a>;
<a name="l00047"></a><a class="code" href="../../d4/d6/regext_8c.html#a10">00047</a> PNTKD_GET_SYMBOL <a class="code" href="../../d4/d6/regext_8c.html#a10">lpGetSymbolRoutine</a>;
<a name="l00048"></a><a class="code" href="../../d4/d6/regext_8c.html#a11">00048</a> PNTKD_CHECK_CONTROL_C <a class="code" href="../../d4/d6/regext_8c.html#a11">lpCheckControlCRoutine</a>;
<a name="l00049"></a><a class="code" href="../../d4/d6/regext_8c.html#a12">00049</a> PNTKD_READ_VIRTUAL_MEMORY <a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a>;
00050 
00051 <span class="keywordtype">void</span>
00052 <a class="code" href="../../d4/d6/regext_8c.html#a13">poolDumpHive</a>(
00053     IN <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> Hive
00054     );
00055 
00056 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00057 <a class="code" href="../../d4/d6/regext_8c.html#a14">poolDumpMap</a>(
00058     IN ULONG Length,
00059     IN <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Map
00060     );
00061 
00062 <span class="keywordtype">void</span>
00063 <a class="code" href="../../d4/d6/regext_8c.html#a15">dumpHiveFromFile</a>(
00064     IN FILE *File
00065     );
00066 
00067 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00068 <a class="code" href="../../d4/d6/regext_8c.html#a16">kcbWorker</a>(
00069     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> pKcb
00070     );
00071 
00072 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00073"></a><a class="code" href="../../d4/d6/regext_8c.html#a17">00073</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>(
00074     DWORD dwCurrentPc,
00075     PNTKD_EXTENSION_APIS lpExtensionApis,
00076     LPSTR lpArgumentString
00077     )
00078 
00079 <span class="comment">/*++</span>
00080 <span class="comment"></span>
00081 <span class="comment">Routine Description:</span>
00082 <span class="comment"></span>
00083 <span class="comment">    Goes through all the paged pool allocated to registry space and</span>
00084 <span class="comment">    determines which pages are present and which are not.</span>
00085 <span class="comment"></span>
00086 <span class="comment">    Called as:</span>
00087 <span class="comment"></span>
00088 <span class="comment">        !regext.pool [s|r]</span>
00089 <span class="comment"></span>
00090 <span class="comment">        s Save list of registry pages to temporary file</span>
00091 <span class="comment">        r Restore list of registry pages from temp. file</span>
00092 <span class="comment"></span>
00093 <span class="comment">Arguments:</span>
00094 <span class="comment"></span>
00095 <span class="comment">    CurrentPc - Supplies the current pc at the time the extension is</span>
00096 <span class="comment">        called.</span>
00097 <span class="comment"></span>
00098 <span class="comment">    lpExtensionApis - Supplies the address of the functions callable</span>
00099 <span class="comment">        by this extension.</span>
00100 <span class="comment"></span>
00101 <span class="comment">    lpArgumentString - Supplies the pattern and expression for this</span>
00102 <span class="comment">        command.</span>
00103 <span class="comment"></span>
00104 <span class="comment">Return Value:</span>
00105 <span class="comment"></span>
00106 <span class="comment">    None.</span>
00107 <span class="comment"></span>
00108 <span class="comment">--*/</span>
00109 
00110 {
00111     PLIST_ENTRY pCmpHiveListHead;
00112     PLIST_ENTRY pNextHiveList;
00113     <a class="code" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html">HIVE_LIST_ENTRY</a> *pHiveListEntry;
00114     ULONG BytesRead;
00115     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00116 
00117     <a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a> = lpExtensionApis-&gt;lpOutputRoutine;
00118     <a class="code" href="../../d4/d6/regext_8c.html#a9">lpGetExpressionRoutine</a> = lpExtensionApis-&gt;lpGetExpressionRoutine;
00119     <a class="code" href="../../d4/d6/regext_8c.html#a10">lpGetSymbolRoutine</a> = lpExtensionApis-&gt;lpGetSymbolRoutine;
00120     <a class="code" href="../../d4/d6/regext_8c.html#a11">lpCheckControlCRoutine</a> = lpExtensionApis-&gt;lpCheckControlCRoutine;
00121     <a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a> = lpExtensionApis-&gt;lpReadVirtualMemRoutine;
00122 
00123     <span class="keywordflow">if</span> (toupper(lpArgumentString[0])==<span class="charliteral">'S'</span>) {
00124         <a class="code" href="../../d4/d6/regext_8c.html#a5">SavePages</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00125     } <span class="keywordflow">else</span> {
00126         <a class="code" href="../../d4/d6/regext_8c.html#a5">SavePages</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00127     }
00128     <span class="keywordflow">if</span> (toupper(lpArgumentString[0])==<span class="charliteral">'R'</span>) {
00129         <a class="code" href="../../d4/d6/regext_8c.html#a6">RestorePages</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00130     } <span class="keywordflow">else</span> {
00131         <a class="code" href="../../d4/d6/regext_8c.html#a6">RestorePages</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00132     }
00133 
00134     <span class="comment">//</span>
00135     <span class="comment">// Go get the hivelist.</span>
00136     <span class="comment">//</span>
00137     memset(<a class="code" href="../../d4/d6/regext_8c.html#a0">HiveList</a>,0,<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d6/regext_8c.html#a0">HiveList</a>));
00138     pHiveListEntry = (<a class="code" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html">PHIVE_LIST_ENTRY</a>)(<a class="code" href="../../d4/d6/regext_8c.html#a9">lpGetExpressionRoutine</a>)(<span class="stringliteral">"CmpMachineHiveList"</span>);
00139     <span class="keywordflow">if</span> (pHiveListEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00140         (<a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a>)(pHiveListEntry,
00141                     <a class="code" href="../../d4/d6/regext_8c.html#a0">HiveList</a>,
00142                     <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d6/regext_8c.html#a0">HiveList</a>),
00143                     &amp;BytesRead);
00144     }
00145 
00146     <span class="comment">//</span>
00147     <span class="comment">// First go and get the hivelisthead</span>
00148     <span class="comment">//</span>
00149     pCmpHiveListHead = (PLIST_ENTRY)(<a class="code" href="../../d4/d6/regext_8c.html#a9">lpGetExpressionRoutine</a>)(<span class="stringliteral">"CmpHiveListHead"</span>);
00150     <span class="keywordflow">if</span> (pCmpHiveListHead==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00151         (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"CmpHiveListHead couldn't be read\n"</span>);
00152         <span class="keywordflow">return</span>;
00153     }
00154 
00155     (<a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a>)(&amp;pCmpHiveListHead-&gt;Flink,
00156                 &amp;pNextHiveList,
00157                 <span class="keyword">sizeof</span>(pNextHiveList),
00158                 &amp;BytesRead);
00159     <span class="keywordflow">if</span> (BytesRead != <span class="keyword">sizeof</span>(pNextHiveList)) {
00160         (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"Couldn't read first Flink (%lx) of CmpHiveList\n"</span>,
00161                   &amp;pCmpHiveListHead-&gt;Flink);
00162         <span class="keywordflow">return</span>;
00163     }
00164 
00165     <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a> = <a class="code" href="../../d4/d6/regext_8c.html#a2">TotalPresentPages</a> = 0;
00166 
00167     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a5">SavePages</a>) {
00168         <a class="code" href="../../d4/d6/regext_8c.html#a7">TempFile</a> = fopen(<span class="stringliteral">"regext.dat"</span>,<span class="stringliteral">"w+"</span>);
00169         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a7">TempFile</a>==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00170             (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"Couldn't create regext.dat for write\n"</span>);
00171             <span class="keywordflow">return</span>;
00172         }
00173     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a6">RestorePages</a>) {
00174         <a class="code" href="../../d4/d6/regext_8c.html#a7">TempFile</a> = fopen(<span class="stringliteral">"regext.dat"</span>,<span class="stringliteral">"r"</span>);
00175         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a7">TempFile</a>==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00176             (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"Couldn't open regext.dat for read\n"</span>);
00177             <span class="keywordflow">return</span>;
00178         }
00179     }
00180 
00181     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a6">RestorePages</a>) {
00182         <a class="code" href="../../d4/d6/regext_8c.html#a15">dumpHiveFromFile</a>(<a class="code" href="../../d4/d6/regext_8c.html#a7">TempFile</a>);
00183     } <span class="keywordflow">else</span> {
00184         <span class="keywordflow">while</span> (pNextHiveList != pCmpHiveListHead) {
00185             CmHive = CONTAINING_RECORD(pNextHiveList, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d4/d6/regext_8c.html#a0">HiveList</a>);
00186             <a class="code" href="../../d4/d6/regext_8c.html#a13">poolDumpHive</a>(CmHive);
00187 
00188             (<a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a>)(&amp;pNextHiveList-&gt;Flink,
00189                         &amp;pNextHiveList,
00190                         <span class="keyword">sizeof</span>(pNextHiveList),
00191                         &amp;BytesRead);
00192             <span class="keywordflow">if</span> (BytesRead != <span class="keyword">sizeof</span>(pNextHiveList)) {
00193                 (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"Couldn't read Flink (%lx) of %lx\n"</span>,
00194                           &amp;pCmpHiveListHead-&gt;Flink,pNextHiveList);
00195                 <span class="keywordflow">break</span>;
00196             }
00197 
00198         }
00199     }
00200 
00201     (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"Total pages present = %d / %d\n"</span>,
00202               <a class="code" href="../../d4/d6/regext_8c.html#a2">TotalPresentPages</a>,
00203               <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a>);
00204 
00205     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a5">SavePages</a> || <a class="code" href="../../d4/d6/regext_8c.html#a6">RestorePages</a>) {
00206         fclose(<a class="code" href="../../d4/d6/regext_8c.html#a7">TempFile</a>);
00207     }
00208 }
00209 
00210 <span class="keywordtype">void</span>
<a name="l00211"></a><a class="code" href="../../d4/d6/regext_8c.html#a13">00211</a> <a class="code" href="../../d4/d6/regext_8c.html#a13">poolDumpHive</a>(
00212     IN <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> pHive
00213     )
00214 {
00215     <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a> CmHive;
00216     ULONG BytesRead;
00217     WCHAR <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a30">HBASE_NAME_ALLOC</a>/2 + 1];
00218     ULONG i;
00219 
00220     (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"\ndumping hive at %lx "</span>,pHive);
00221     (<a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a>)(pHive,
00222                 &amp;CmHive,
00223                 <span class="keyword">sizeof</span>(CmHive),
00224                 &amp;BytesRead);
00225 
00226     <span class="keywordflow">if</span> (BytesRead &lt; <span class="keyword">sizeof</span>(CmHive)) {
00227         (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"\tRead %lx bytes from %lx\n"</span>,BytesRead,pHive);
00228         <span class="keywordflow">return</span>;
00229     }
00230 
00231     (<a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a>)(&amp;CmHive.Hive.BaseBlock-&gt;FileName,
00232                 <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
00233                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>),
00234                 &amp;BytesRead);
00235 
00236     <span class="keywordflow">if</span> (BytesRead &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>)) {
00237         wcscpy(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"UNKNOWN"</span>);
00238     } <span class="keywordflow">else</span> {
00239         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>[0]==<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) {
00240             wcscpy(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"NONAME"</span>);
00241         } <span class="keywordflow">else</span> {
00242             <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a30">HBASE_NAME_ALLOC</a>/2]=<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00243         }
00244     }
00245 
00246     (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"(%ws)\n"</span>,<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>);
00247 
00248     (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"  %d KCBs open\n"</span>,CmHive.KcbCount);
00249     (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"  Stable Length = %lx\n"</span>,CmHive.Hive.Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length);
00250     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a5">SavePages</a>) {
00251         fprintf(<a class="code" href="../../d4/d6/regext_8c.html#a7">TempFile</a>,
00252                 <span class="stringliteral">"%ws %d %d\n"</span>,
00253                 <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
00254                 CmHive.Hive.Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length,
00255                 CmHive.Hive.Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Length);
00256     }
00257     <a class="code" href="../../d4/d6/regext_8c.html#a14">poolDumpMap</a>(CmHive.Hive.Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length,
00258                 CmHive.Hive.Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map);
00259 
00260     (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"  Volatile Length = %lx\n"</span>,CmHive.Hive.Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Length);
00261     <a class="code" href="../../d4/d6/regext_8c.html#a14">poolDumpMap</a>(CmHive.Hive.Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Length,
00262                 CmHive.Hive.Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Map);
00263 
00264 }
00265 
00266 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00267"></a><a class="code" href="../../d4/d6/regext_8c.html#a14">00267</a> <a class="code" href="../../d4/d6/regext_8c.html#a14">poolDumpMap</a>(
00268     IN ULONG Length,
00269     IN <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Map
00270     )
00271 {
00272     ULONG Tables;
00273     ULONG MapSlots;
00274     ULONG i;
00275     ULONG BytesRead;
00276     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a> MapDirectory;
00277     <a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a> MapTable;
00278     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">HMAP_ENTRY</a> MapEntry;
00279     ULONG Garbage;
00280     ULONG Present=0;
00281 
00282     <span class="keywordflow">if</span> (Length==0) {
00283         <span class="keywordflow">return</span>;
00284     }
00285 
00286     MapSlots = Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00287     Tables = 1+ ((MapSlots-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>);
00288 
00289     <span class="comment">//</span>
00290     <span class="comment">// read in map directory</span>
00291     <span class="comment">//</span>
00292     (<a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a>)(Map,
00293              &amp;MapDirectory,
00294              Tables * <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>),
00295              &amp;BytesRead);
00296     <span class="keywordflow">if</span> (BytesRead &lt; (Tables * <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>))) {
00297         (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"Only read %lx/%lx bytes from %lx\n"</span>,
00298                   BytesRead,
00299                   Tables * <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>),
00300                   Map);
00301         <span class="keywordflow">return</span>;
00302 
00303     }
00304 
00305     <span class="comment">//</span>
00306     <span class="comment">// check out each map entry</span>
00307     <span class="comment">//</span>
00308     <span class="keywordflow">for</span> (i=0; i&lt;MapSlots; i++) {
00309 
00310         MapTable = MapDirectory.Directory[i/<a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>];
00311 
00312         (<a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a>)(&amp;(MapTable-&gt;<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html#o0">Table</a>[i%<a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>]),
00313                     &amp;MapEntry,
00314                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">HMAP_ENTRY</a>),
00315                     &amp;BytesRead);
00316         <span class="keywordflow">if</span> (BytesRead &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">HMAP_ENTRY</a>)) {
00317             (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"  can't read HMAP_ENTRY at %lx\n"</span>,
00318                       &amp;(MapTable-&gt;<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html#o0">Table</a>[i%<a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>]));
00319         }
00320 
00321         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a5">SavePages</a>) {
00322             fprintf(<a class="code" href="../../d4/d6/regext_8c.html#a7">TempFile</a>, <span class="stringliteral">"%lx\n"</span>,MapEntry.<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>);
00323 
00324         }
00325 
00326         <span class="comment">//</span>
00327         <span class="comment">// probe the HBLOCK</span>
00328         <span class="comment">//</span>
00329         (<a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a>)(MapEntry.<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>,
00330                     &amp;Garbage,
00331                     <span class="keyword">sizeof</span>(ULONG),
00332                     &amp;BytesRead);
00333         <span class="keywordflow">if</span> (BytesRead &gt; 0) {
00334             ++Present;
00335         }
00336     }
00337     (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"  %d/%d pages present\n"</span>,
00338               Present,
00339               MapSlots);
00340 
00341     <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a> += MapSlots;
00342     <a class="code" href="../../d4/d6/regext_8c.html#a2">TotalPresentPages</a> += Present;
00343 
00344 }
00345 
00346 <span class="keywordtype">void</span>
<a name="l00347"></a><a class="code" href="../../d4/d6/regext_8c.html#a15">00347</a> <a class="code" href="../../d4/d6/regext_8c.html#a15">dumpHiveFromFile</a>(
00348     IN FILE *File
00349     )
00350 
00351 <span class="comment">/*++</span>
00352 <span class="comment"></span>
00353 <span class="comment">Routine Description:</span>
00354 <span class="comment"></span>
00355 <span class="comment">    Takes a list of the registry hives and pages from a file and</span>
00356 <span class="comment">    checks to see how many of the pages are in memory.</span>
00357 <span class="comment"></span>
00358 <span class="comment">    The format of the file is as follows</span>
00359 <span class="comment">       hivename stablelength volatilelength</span>
00360 <span class="comment">       stable page address</span>
00361 <span class="comment">       stable page address</span>
00362 <span class="comment">            .</span>
00363 <span class="comment">            .</span>
00364 <span class="comment">            .</span>
00365 <span class="comment">       volatile page address</span>
00366 <span class="comment">       volatile page address</span>
00367 <span class="comment">            .</span>
00368 <span class="comment">            .</span>
00369 <span class="comment">            .</span>
00370 <span class="comment">       hivename stablelength volatilelength</span>
00371 <span class="comment">            .</span>
00372 <span class="comment">            .</span>
00373 <span class="comment">            .</span>
00374 <span class="comment"></span>
00375 <span class="comment"></span>
00376 <span class="comment">Arguments:</span>
00377 <span class="comment"></span>
00378 <span class="comment">    File - Supplies a file.</span>
00379 <span class="comment"></span>
00380 <span class="comment">Return Value:</span>
00381 <span class="comment"></span>
00382 <span class="comment">    None.</span>
00383 <span class="comment"></span>
00384 <span class="comment">--*/</span>
00385 
00386 {
00387     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> Hivename[33];
00388     ULONG StableLength;
00389     ULONG VolatileLength;
00390     ULONG Page;
00391     ULONG i;
00392     ULONG NumFields;
00393     ULONG Garbage;
00394     ULONG Present;
00395     ULONG Total;
00396     ULONG BytesRead;
00397 
00398     <span class="keywordflow">while</span> (!feof(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>)) {
00399         NumFields = fscanf(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,<span class="stringliteral">"%s %d %d\n"</span>,
00400                             Hivename,
00401                             &amp;StableLength,
00402                             &amp;VolatileLength);
00403         <span class="keywordflow">if</span> (NumFields != 3) {
00404             (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"fscanf returned %d\n"</span>,NumFields);
00405             <span class="keywordflow">return</span>;
00406         }
00407 
00408         (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"\ndumping hive %s\n"</span>,Hivename);
00409         (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"  Stable Length = %lx\n"</span>,StableLength);
00410         Present = 0;
00411         Total = 0;
00412         <span class="keywordflow">while</span> (StableLength &gt; 0) {
00413             fscanf(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>, <span class="stringliteral">"%lx\n"</span>,&amp;Page);
00414             (<a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a>)(Page,
00415                         &amp;Garbage,
00416                         <span class="keyword">sizeof</span>(ULONG),
00417                         &amp;BytesRead);
00418             <span class="keywordflow">if</span> (BytesRead &gt; 0) {
00419                 ++Present;
00420             }
00421             ++Total;
00422             StableLength -= <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00423         }
00424         <span class="keywordflow">if</span> (Total &gt; 0) {
00425             (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"  %d/%d stable pages present\n"</span>,
00426                       Present,Total);
00427         }
00428         <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a> += Total;
00429         <a class="code" href="../../d4/d6/regext_8c.html#a2">TotalPresentPages</a> += Present;
00430 
00431         (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"  Volatile Length = %lx\n"</span>,VolatileLength);
00432         Present = 0;
00433         Total = 0;
00434         <span class="keywordflow">while</span> (VolatileLength &gt; 0) {
00435             fscanf(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>, <span class="stringliteral">"%lx\n"</span>,&amp;Page);
00436             (<a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a>)(Page,
00437                         &amp;Garbage,
00438                         <span class="keyword">sizeof</span>(ULONG),
00439                         &amp;BytesRead);
00440             <span class="keywordflow">if</span> (BytesRead &gt; 0) {
00441                 ++Present;
00442             }
00443             ++Total;
00444             VolatileLength -= <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00445         }
00446         <span class="keywordflow">if</span> (Total &gt; 0) {
00447             (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"  %d/%d volatile pages present\n"</span>,
00448                       Present,Total);
00449         }
00450 
00451         <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a> += Total;
00452         <a class="code" href="../../d4/d6/regext_8c.html#a2">TotalPresentPages</a> += Present;
00453     }
00454 
00455 }
00456 
00457 <span class="keywordtype">void</span>
<a name="l00458"></a><a class="code" href="../../d4/d6/regext_8c.html#a18">00458</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>(
00459     DWORD dwCurrentPc,
00460     PNTKD_EXTENSION_APIS lpExtensionApis,
00461     LPSTR lpArgumentString
00462     )
00463 
00464 <span class="comment">/*++</span>
00465 <span class="comment"></span>
00466 <span class="comment">Routine Description:</span>
00467 <span class="comment"></span>
00468 <span class="comment">    Walks the kcb tree and prints the names of keys which have</span>
00469 <span class="comment">    outstanding kcbs</span>
00470 <span class="comment"></span>
00471 <span class="comment">    Called as:</span>
00472 <span class="comment"></span>
00473 <span class="comment">        !regext.kcb</span>
00474 <span class="comment"></span>
00475 <span class="comment">Arguments:</span>
00476 <span class="comment"></span>
00477 <span class="comment">    CurrentPc - Supplies the current pc at the time the extension is</span>
00478 <span class="comment">        called.</span>
00479 <span class="comment"></span>
00480 <span class="comment">    lpExtensionApis - Supplies the address of the functions callable</span>
00481 <span class="comment">        by this extension.</span>
00482 <span class="comment"></span>
00483 <span class="comment">    lpArgumentString - Supplies the pattern and expression for this</span>
00484 <span class="comment">        command.</span>
00485 <span class="comment"></span>
00486 <span class="comment">Return Value:</span>
00487 <span class="comment"></span>
00488 <span class="comment">    None.</span>
00489 <span class="comment"></span>
00490 <span class="comment">--*/</span>
00491 
00492 {
00493     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> pKCB;
00494     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Root;
00495     ULONG BytesRead;
00496 
00497     <a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a> = lpExtensionApis-&gt;lpOutputRoutine;
00498     <a class="code" href="../../d4/d6/regext_8c.html#a9">lpGetExpressionRoutine</a> = lpExtensionApis-&gt;lpGetExpressionRoutine;
00499     <a class="code" href="../../d4/d6/regext_8c.html#a10">lpGetSymbolRoutine</a> = lpExtensionApis-&gt;lpGetSymbolRoutine;
00500     <a class="code" href="../../d4/d6/regext_8c.html#a11">lpCheckControlCRoutine</a> = lpExtensionApis-&gt;lpCheckControlCRoutine;
00501     <a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a> = lpExtensionApis-&gt;lpReadVirtualMemRoutine;
00502 
00503     Root = (<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>)(<a class="code" href="../../d4/d6/regext_8c.html#a9">lpGetExpressionRoutine</a>)(<span class="stringliteral">"CmpKeyControlBlockRoot"</span>);
00504     <span class="keywordflow">if</span> (Root == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00505         (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"Couldn't find address of CmpKeyControlBlockRoot\n"</span>);
00506         <span class="keywordflow">return</span>;
00507     }
00508     (<a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a>)(Root,
00509                 &amp;pKCB,
00510                 <span class="keyword">sizeof</span>(pKCB),
00511                 &amp;BytesRead);
00512 
00513     <span class="keywordflow">if</span> (BytesRead &lt; <span class="keyword">sizeof</span>(pKCB)) {
00514         (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"Couldn't get pKCB from CmpKeyControlBlockRoot\n"</span>);
00515     }
00516 
00517     <a class="code" href="../../d4/d6/regext_8c.html#a3">TotalKcbs</a> = 0;
00518     <a class="code" href="../../d4/d6/regext_8c.html#a4">TotalKcbName</a> = 0;
00519     <a class="code" href="../../d4/d6/regext_8c.html#a16">kcbWorker</a>(pKCB);
00520 
00521     (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"%d KCBs\n"</span>,<a class="code" href="../../d4/d6/regext_8c.html#a3">TotalKcbs</a>);
00522     (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"%d total bytes of FullNames\n"</span>,<a class="code" href="../../d4/d6/regext_8c.html#a4">TotalKcbName</a>);
00523 
00524 }
00525 
00526 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00527"></a><a class="code" href="../../d4/d6/regext_8c.html#a16">00527</a> <a class="code" href="../../d4/d6/regext_8c.html#a16">kcbWorker</a>(
00528     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> pKcb
00529     )
00530 
00531 <span class="comment">/*++</span>
00532 <span class="comment"></span>
00533 <span class="comment">Routine Description:</span>
00534 <span class="comment"></span>
00535 <span class="comment">    recursive worker for walking the kcb tree.</span>
00536 <span class="comment"></span>
00537 <span class="comment">Arguments:</span>
00538 <span class="comment"></span>
00539 <span class="comment">    pKcb - Supplies pointer to kcb.</span>
00540 <span class="comment"></span>
00541 <span class="comment">Return Value:</span>
00542 <span class="comment"></span>
00543 <span class="comment">    None.</span>
00544 <span class="comment"></span>
00545 <span class="comment">--*/</span>
00546 
00547 {
00548     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00549     ULONG BytesRead;
00550     WCHAR *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00551 
00552     ++<a class="code" href="../../d4/d6/regext_8c.html#a3">TotalKcbs</a>;
00553     (<a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a>)(pKcb,
00554                 &amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00555                 <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>),
00556                 &amp;BytesRead);
00557     <span class="keywordflow">if</span> (BytesRead &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>)) {
00558         (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"Can't read kcb at %lx\n"</span>,pKcb);
00559         <span class="keywordflow">return</span>;
00560     }
00561     <a class="code" href="../../d4/d6/regext_8c.html#a4">TotalKcbName</a> += <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.Length;
00562 
00563     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.Left != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00564         <a class="code" href="../../d4/d6/regext_8c.html#a16">kcbWorker</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.Left);
00565     }
00566 
00567     (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">"%d - "</span>,<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.RefCount);
00568 
00569     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = malloc(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.Length);
00570     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00571         (<a class="code" href="../../d4/d6/regext_8c.html#a12">lpReadMem</a>)(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.Buffer,
00572                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00573                     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.Length,
00574                     &amp;BytesRead);
00575 
00576         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.Length = BytesRead;
00577         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName.Buffer = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00578 
00579         (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">" %wZ\n"</span>,&amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.FullName);
00580         free(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00581 
00582     } <span class="keywordflow">else</span> {
00583         (<a class="code" href="../../d4/d6/regext_8c.html#a8">lpPrint</a>)(<span class="stringliteral">" ??? \n"</span>);
00584     }
00585 
00586     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.Right != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00587         <a class="code" href="../../d4/d6/regext_8c.html#a16">kcbWorker</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.Right);
00588     }
00589 
00590 
00591 }
00592 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
