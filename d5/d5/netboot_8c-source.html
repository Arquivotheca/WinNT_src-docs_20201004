<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: netboot.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>netboot.c</h1><a href="../../d4/d6/netboot_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1997  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    netboot.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the code to initialize network boot.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Chuck Lenzmeier (chuckl) December 27, 1996</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode, system initialization code</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">    Colin Watson (colinw) November 1997 Add CSC support</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00028 <span class="preprocessor">#pragma hdrstop</span>
00029 <span class="preprocessor"></span>
00030 <span class="preprocessor">#include &lt;ntddip.h&gt;</span>
00031 <span class="preprocessor">#include &lt;nbtioctl.h&gt;</span>
00032 <span class="preprocessor">#include &lt;ntddnfs.h&gt;</span>
00033 <span class="preprocessor">#include &lt;ntddbrow.h&gt;</span>
00034 <span class="preprocessor">#include &lt;ntddtcp.h&gt;</span>
00035 <span class="preprocessor">#include &lt;<a class="code" href="../../d3/d8/setupblk_8h.html">setupblk.h</a>&gt;</span>
00036 <span class="preprocessor">#include &lt;remboot.h&gt;</span>
00037 <span class="preprocessor">#include &lt;oscpkt.h&gt;</span>
00038 <span class="preprocessor">#include &lt;windef.h&gt;</span>
00039 <span class="preprocessor">#include &lt;tdiinfo.h&gt;</span>
00040 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#include &lt;ntddndis.h&gt;</span>
00042 <span class="preprocessor">#include &lt;ipsec.h&gt;</span>
00043 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00044 <span class="preprocessor"></span>
00045 <span class="preprocessor">#ifndef NT</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#define NT</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#include &lt;ipinfo.h&gt;</span>
00048 <span class="preprocessor">#undef NT</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#include &lt;ipinfo.h&gt;</span>
00051 <span class="preprocessor">#endif</span>
00052 <span class="preprocessor"></span>
<a name="l00053"></a><a class="code" href="../../d4/d6/netboot_8c.html#a3">00053</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d4/d6/netboot_8c.html#a3">ExpInTextModeSetup</a>;
00054 
00055 <span class="comment">//</span>
00056 <span class="comment">// TCP/IP definitions</span>
00057 <span class="comment">//</span>
00058 
<a name="l00059"></a><a class="code" href="../../d4/d6/netboot_8c.html#a0">00059</a> <span class="preprocessor">#define DEFAULT_DEST                    0</span>
<a name="l00060"></a><a class="code" href="../../d4/d6/netboot_8c.html#a1">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_DEST_MASK               0</span>
<a name="l00061"></a><a class="code" href="../../d4/d6/netboot_8c.html#a2">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_METRIC                  1</span>
00062 <span class="preprocessor"></span>
00063 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00064 <a class="code" href="../../d4/d6/netboot_8c.html#a4">IopWriteIpAddressToRegistry</a>(
00065         HANDLE handle,
00066         PWCHAR regkey,
00067         PUCHAR value
00068         );
00069 
00070 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00071 <a class="code" href="../../d4/d6/netboot_8c.html#a5">IopTCPQueryInformationEx</a>(
00072     IN HANDLE                 TCPHandle,
00073     IN TDIObjectID FAR       *ID,
00074     OUT <span class="keywordtype">void</span> FAR             *Buffer,
00075     IN OUT DWORD FAR         *BufferSize,
00076     IN OUT BYTE FAR          *Context
00077     );
00078 
00079 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00080 <a class="code" href="../../d4/d6/netboot_8c.html#a6">IopTCPSetInformationEx</a>(
00081     IN HANDLE             TCPHandle,
00082     IN TDIObjectID FAR   *ID,
00083     IN <span class="keywordtype">void</span> FAR          *Buffer,
00084     IN DWORD FAR          BufferSize
00085     );
00086 
00087 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00088 <a class="code" href="../../d4/d6/netboot_8c.html#a7">IopSetDefaultGateway</a>(
00089     IN ULONG GatewayAddress
00090     );
00091 
00092 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00093 <a class="code" href="../../d4/d6/netboot_8c.html#a8">IopCacheNetbiosNameForIpAddress</a>(
00094     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00095     );
00096 
00097 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00098 <a class="code" href="../../d4/d6/netboot_8c.html#a12">IopAssignNetworkDriveLetter</a> (
00099     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00100     );
00101 
00102 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00103 <span class="preprocessor"></span>
00104 <span class="preprocessor">#if DBG</span>
00105 <span class="preprocessor"></span>BOOLEAN DebugReset = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00106 <span class="preprocessor">#endif</span>
00107 <span class="preprocessor"></span>
00108 <span class="comment">//</span>
00109 <span class="comment">// The following variable is used by IoStartCscForTextmodeSetup.</span>
00110 <span class="comment">//</span>
00111 
00112 BOOLEAN TextmodeSetupHasStartedCsc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00113 
00114 <span class="comment">//</span>
00115 <span class="comment">// CSC definitions</span>
00116 <span class="comment">//</span>
00117 
00118 <span class="keyword">typedef</span> <span class="keyword">struct </span>_FILETIME {
00119     ULONG dwLowDateTime;
00120     ULONG dwHighDateTime;
00121 } FILETIME, *LPFILETIME;
00122 
00123 <span class="keyword">typedef</span> <span class="keyword">struct </span>_WIN32_FIND_DATAA {
00124     ULONG dwFileAttributes;
00125     FILETIME ftCreationTime;
00126     FILETIME ftLastAccessTime;
00127     FILETIME ftLastWriteTime;
00128     ULONG nFileSizeHigh;
00129     ULONG nFileSizeLow;
00130     ULONG dwReserved0;
00131     ULONG dwReserved1;
00132     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>   cFileName[ <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> ];
00133     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>   cAlternateFileName[ 14 ];
00134 } WIN32_FIND_DATAA;
00135 
00136 <span class="keyword">typedef</span> <span class="keyword">struct </span>_WIN32_FIND_DATAW {
00137     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwFileAttributes;
00138     FILETIME ftCreationTime;
00139     FILETIME ftLastAccessTime;
00140     FILETIME ftLastWriteTime;
00141     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nFileSizeHigh;
00142     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nFileSizeLow;
00143     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwReserved0;
00144     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwReserved1;
00145     WCHAR  cFileName[ <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> ];
00146     WCHAR  cAlternateFileName[ 14 ];
00147 } WIN32_FIND_DATAW, *PWIN32_FIND_DATAW, *LPWIN32_FIND_DATAW;
00148 
00149 
00150 LIST_ENTRY DirectoryList;
00151 
00152 HANDLE RdrHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00153 <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> RdrHandleProcess = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00154 
00155 <span class="keyword">typedef</span> <span class="keyword">enum</span> _START_CSC {
00156     INIT_CSC,
00157     FLUSH_CSC
00158 } START_CSC;
00159 
00160 START_CSC StartCsc;
00161 
00162 <span class="keyword">typedef</span> <span class="keyword">enum</span> _CSC_CONTROL {
00163     READ_CSC,
00164     SET_FLUSH_CSC,
00165     SET_FLUSHED_CSC
00166 } CSC_CONTROL;
00167 
00168 <span class="preprocessor">#include &lt;shdcom.h&gt;</span>
00169 
00170 <span class="comment">//</span>
00171 <span class="comment">// Structure for holding discovered directories until we can process them.</span>
00172 <span class="comment">//</span>
00173 
00174 <span class="keyword">typedef</span> <span class="keyword">struct </span>_DIRENT {
00175     LIST_ENTRY Next;
00176     UNICODE_STRING <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>;
00177     PWCHAR LastToken;
00178     HSHADOW CSCHandle;
00179     WCHAR <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>[1];
00180 } DIRENT, *PDIRENT;
00181 
00182 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00183 IopInitCsc(
00184     IN PUCHAR CscPath
00185     );
00186 
00187 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00188 IopResetCsc(
00189     IN PUCHAR CscPath
00190     );
00191 
00192 PWSTR
00193 IopBreakPath(
00194     IN PWSTR* Path
00195     );
00196 
00197 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00198 IopMarkRoot(
00199     IN PUNICODE_STRING FileName,
00200     OUT PHSHADOW RootHandle
00201     );
00202 
00203 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00204 IopSetFlushCSC(
00205     IN CSC_CONTROL Command
00206     );
00207 
00208 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00209 IopWalkDirectoryHelper (
00210     IN PUNICODE_STRING Directory,
00211     IN HSHADOW CSCHandle,
00212     IN PUCHAR Buffer,
00213     IN ULONG BufferSize
00214     );
00215 
00216 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00217 IopWalkDirectoryTree (
00218     IN PUNICODE_STRING Directory,
00219     IN HSHADOW CSCHandle
00220     );
00221 
00222 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00223 IopGetShadowExW(
00224     HSHADOW hDir,
00225     LPWIN32_FIND_DATAW lpFind32,
00226     LPSHADOWINFO lpSI
00227     );
00228 
00229 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00230 IopAddHintFromInode(
00231     HSHADOW hDir,
00232     HSHADOW hShadow,
00233     ULONG *lpulHintPri,
00234     ULONG *lpulHintFlags,
00235     ULONG HintFlagsToSet
00236     );
00237 
00238 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00239 IopSetShadowInfoW(
00240     HSHADOW hDir,
00241     HSHADOW hShadow,
00242     ULONG uStatus,
00243     ULONG uOp
00244     );
00245 
00246 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00247 IopCreateShadowW(
00248     HSHADOW hDir,
00249     LPWIN32_FIND_DATAW lpFind32,
00250     ULONG uStatus,
00251     PHSHADOW lphShadow
00252     );
00253 
00254 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00255 IopCopyServerAcl(
00256     HANDLE ParentHandle,
00257     PWCHAR FileName,
00258     HSHADOW ShadowHandle,
00259     BOOLEAN IsDirectory,
00260     PUCHAR Buffer,
00261     ULONG BufferSize
00262     );
00263 
00264 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00265 IopGetShadowPathW(
00266     HSHADOW hShadow,
00267     PWCHAR lpLocalPath,
00268     LPCOPYPARAMSW lpCP
00269     );
00270 
00271 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00272 IopEnableRemoteBootSecurity (
00273     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00274     );
00275 
00276 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00277 IopGetHarddiskInfo(
00278     OUT PWSTR NetHDCSCPartition
00279     );
00280 
00281 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00282 <span class="preprocessor"></span>
00283 <span class="comment">//</span>
00284 <span class="comment">// The following allows the I/O system's initialization routines to be</span>
00285 <span class="comment">// paged out of memory.</span>
00286 <span class="comment">//</span>
00287 
00288 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00289 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopAddRemoteBootValuesToRegistry)</span>
00290 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopStartNetworkForRemoteBoot)</span>
00291 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopStartTcpIpForRemoteBoot)</span>
00292 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopIsRemoteBootCard)</span>
00293 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopSetupRemoteBootCard)</span>
00294 <span class="preprocessor"></span><span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00295 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopAssignNetworkDriveLetter)</span>
00296 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopInitCsc)</span>
00297 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopResetCsc)</span>
00298 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopBreakPath)</span>
00299 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopMarkRoot)</span>
00300 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopSetFlushCSC)</span>
00301 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopWalkDirectoryHelper)</span>
00302 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopWalkDirectoryTree)</span>
00303 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopGetShadowExW)</span>
00304 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopAddHintFromInode)</span>
00305 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopCreateShadowW)</span>
00306 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopCopyServerAcl)</span>
00307 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopGetShadowPathW)</span>
00308 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,IopGetHarddiskInfo)</span>
00309 <span class="preprocessor"></span><span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00310 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00311 <span class="preprocessor"></span>
00312 
00313 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00314"></a><a class="code" href="../../d4/d6/netboot_8c.html#a10">00314</a> <a class="code" href="../../d4/d6/netboot_8c.html#a10">IopAddRemoteBootValuesToRegistry</a> (
00315     <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00316     )
00317 {
00318     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00319     HANDLE handle;
00320     HANDLE serviceHandle;
00321     OBJECT_ATTRIBUTES objectAttributes;
00322     UNICODE_STRING string;
00323     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> addressA[16];
00324     WCHAR addressW[16];
00325     STRING addressStringA;
00326     UNICODE_STRING addressStringW;
00327     PUCHAR addressPointer;
00328     PUCHAR p;
00329     PUCHAR q;
00330     UCHAR ntName[128];
00331     WCHAR imagePath[128];
00332     STRING ansiString;
00333     UNICODE_STRING unicodeString;
00334     UNICODE_STRING dnsNameString;
00335     UNICODE_STRING netbiosNameString;
00336     ULONG tmpValue;
00337 
00338     <span class="keywordflow">if</span> (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a>[0] != 0) {
00339 
00340         <span class="comment">//</span>
00341         <span class="comment">// Convert the name to a Netbios name.</span>
00342         <span class="comment">//</span>
00343 
00344         _wcsupr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a> );
00345 
00346         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;dnsNameString, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a> );
00347 
00348         status = <a class="code" href="../../d6/d6/nls_8c.html#a51">RtlDnsHostNameToComputerName</a>(
00349                      &amp;netbiosNameString,
00350                      &amp;dnsNameString,
00351                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);            <span class="comment">// allocate netbiosNameString</span>
00352 
00353         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00354             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Failed RtlDnsHostNameToComputerName: %x\n"</span>, status ));
00355             <span class="keywordflow">goto</span> cleanup;
00356         }
00357 
00358         <span class="comment">//</span>
00359         <span class="comment">// Add a value for the computername.</span>
00360         <span class="comment">//</span>
00361 
00362         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\ComputerName\\ComputerName"</span> );
00363 
00364         InitializeObjectAttributes(
00365             &amp;objectAttributes,
00366             &amp;string,
00367             OBJ_CASE_INSENSITIVE,
00368             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00369             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00370             );
00371 
00372         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00373         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00374             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open ComputerName key: %x\n"</span>, status ));
00375             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;netbiosNameString );
00376             <span class="keywordflow">goto</span> cleanup;
00377         }
00378 
00379         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ComputerName"</span> );
00380 
00381         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00382                     handle,
00383                     &amp;string,
00384                     0,
00385                     REG_SZ,
00386                     netbiosNameString.Buffer,
00387                     netbiosNameString.Length + <span class="keyword">sizeof</span>(WCHAR)
00388                     );
00389         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00390         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;netbiosNameString );
00391 
00392         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00393             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set ComputerName value: %x\n"</span>, status ));
00394             <span class="keywordflow">goto</span> cleanup;
00395         }
00396 
00397         <span class="comment">//</span>
00398         <span class="comment">// Add a value for the host name.</span>
00399         <span class="comment">//</span>
00400 
00401         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters"</span> );
00402 
00403         InitializeObjectAttributes(
00404             &amp;objectAttributes,
00405             &amp;string,
00406             OBJ_CASE_INSENSITIVE,
00407             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00408             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00409             );
00410 
00411         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00412         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00413             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open Tcpip\\Parameters key: %x\n"</span>, status ));
00414             <span class="keywordflow">goto</span> cleanup;
00415         }
00416 
00417         _wcslwr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a> );
00418 
00419         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Hostname"</span> );
00420 
00421         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00422                     handle,
00423                     &amp;string,
00424                     0,
00425                     REG_SZ,
00426                     LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a>,
00427                     (wcslen(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a>) + 1) * <span class="keyword">sizeof</span>(WCHAR)
00428                     );
00429         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00430         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00431             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set Hostname value: %x\n"</span>, status ));
00432             <span class="keywordflow">goto</span> cleanup;
00433         }
00434     }
00435 
00436     <span class="comment">//</span>
00437     <span class="comment">//  If the UNC path to the system files is supplied then store it in the registry.</span>
00438     <span class="comment">//</span>
00439 
00440     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( _stricmp(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o10">ArcBootDeviceName</a>,<span class="stringliteral">"net(0)"</span>) == 0 );
00441 
00442     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control"</span> );
00443 
00444     InitializeObjectAttributes(
00445         &amp;objectAttributes,
00446         &amp;string,
00447         OBJ_CASE_INSENSITIVE,
00448         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00449         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00450         );
00451 
00452     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00453     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00454         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open Control key: %x\n"</span>, status ));
00455         <span class="keywordflow">goto</span> skiproot;
00456     }
00457 
00458     p = strrchr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a>, <span class="charliteral">'\\'</span> );   <span class="comment">// find last separator</span>
00459     <span class="keywordflow">if</span> ( (p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (*(p+1) == 0) ) {
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">// NtBootPathName ends with a backslash, so we need to back up</span>
00463         <span class="comment">// to the previous backslash.</span>
00464         <span class="comment">//</span>
00465 
00466         q = p;
00467         *q = 0;
00468         p = strrchr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a>, <span class="charliteral">'\\'</span> );   <span class="comment">// find last separator</span>
00469         *q = <span class="charliteral">'\\'</span>;
00470     }
00471     <span class="keywordflow">if</span> ( p == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00472         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: malformed NtBootPathName: %s\n"</span>, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a> ));
00473         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00474         <span class="keywordflow">goto</span> skiproot;
00475     }
00476     *p = 0;                                 <span class="comment">// terminate \server\share\images\machine</span>
00477 
00478 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00479 <span class="preprocessor"></span>    <span class="comment">//</span>
00480     <span class="comment">// Store the server path in the shared user data area. Note that we need</span>
00481     <span class="comment">// to add an extra \ at the beginning of this path to make it a UNC name.</span>
00482     <span class="comment">//</span>
00483 
00484     SharedUserData-&gt;RemoteBootServerPath[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
00485     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;ansiString, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a> );
00486     unicodeString.MaximumLength = <span class="keyword">sizeof</span>(SharedUserData-&gt;RemoteBootServerPath) - (2 * <span class="keyword">sizeof</span>(WCHAR));
00487     unicodeString.Buffer = &amp;SharedUserData-&gt;RemoteBootServerPath[1];
00488     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;unicodeString, &amp;ansiString, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00489     SharedUserData-&gt;RemoteBootServerPath[1 + (unicodeString.Length/<span class="keyword">sizeof</span>(WCHAR))] = 0;
00490 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00491 <span class="preprocessor"></span>
00492     strcpy( ntName, <span class="stringliteral">"\\Device\\LanmanRedirector"</span>);
00493     strcat( ntName, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a> );  <span class="comment">// append \server\share\images\machine</span>
00494     *p = <span class="charliteral">'\\'</span>;
00495 
00496     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;ansiString, ntName );
00497     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;unicodeString, &amp;ansiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00498 
00499     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"RemoteBootRoot"</span> );
00500 
00501     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00502                 handle,
00503                 &amp;string,
00504                 0,
00505                 REG_SZ,
00506                 unicodeString.Buffer,
00507                 unicodeString.Length + <span class="keyword">sizeof</span>(WCHAR)
00508                 );
00509 
00510     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;unicodeString );
00511     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00512         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set RemoteBootRoot value: %x\n"</span>, status ));
00513     }
00514 
00515     <span class="keywordflow">if</span> ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; <a class="code" href="../../d3/d8/setupblk_8h.html#a26">SETUPBLK_FLAGS_IS_TEXTMODE</a>) != 0) {
00516 
00517         strcpy( ntName, <span class="stringliteral">"\\Device\\LanmanRedirector"</span>);
00518         strcat( ntName, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o34">MachineDirectoryPath</a> );
00519         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;ansiString, ntName );
00520         <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;unicodeString, &amp;ansiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00521 
00522         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"RemoteBootMachineDirectory"</span> );
00523 
00524         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00525                     handle,
00526                     &amp;string,
00527                     0,
00528                     REG_SZ,
00529                     unicodeString.Buffer,
00530                     unicodeString.Length + <span class="keyword">sizeof</span>(WCHAR)
00531                     );
00532 
00533         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;unicodeString );
00534         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00535             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set RemoteBootMachineDirectory value: %x\n"</span>, status ));
00536         }
00537     }
00538 
00539     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00540 
00541 skiproot:
00542 
00543 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00544 <span class="preprocessor"></span>    StartCsc = INIT_CSC;
00545     IopSetFlushCSC(READ_CSC);
00546 
00547     <span class="keywordflow">if</span> ( (StartCsc != FLUSH_CSC) &amp;&amp;
00548          ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_REPIN) != 0) ) {
00549         StartCsc = FLUSH_CSC;
00550         IopSetFlushCSC(SET_FLUSH_CSC);
00551     }
00552 
00553 <span class="preprocessor">#if 0</span>
00554 <span class="preprocessor"></span>    <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\Software\\Microsoft\\Windows\\CSCSettings"</span> );
00555 
00556     InitializeObjectAttributes(
00557         &amp;objectAttributes,
00558         &amp;string,
00559         OBJ_CASE_INSENSITIVE,
00560         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00561         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00562         );
00563 
00564     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00565 
00566     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00567 
00568         PKEY_VALUE_PARTIAL_INFORMATION keyValue;
00569         UCHAR buffer[FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)];
00570         ULONG length;
00571         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> disabled;
00572 
00573 <span class="preprocessor">#define ONE_BOOT 2</span>
00574 <span class="preprocessor"></span>
00575         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DisableAgent"</span> );
00576 
00577         <span class="keywordflow">if</span> ( (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_DISABLE_CSC) == 0 ) {
00578 
00579             <span class="comment">//</span>
00580             <span class="comment">// Disable CSC for this boot.</span>
00581             <span class="comment">//</span>
00582 
00583             disabled = ONE_BOOT;
00584             status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00585                         handle,
00586                         &amp;string,
00587                         0,
00588                         REG_DWORD,
00589                         &amp;disabled,
00590                         <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
00591 
00592         } <span class="keywordflow">else</span> {
00593 
00594             keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)buffer;
00595             status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00596                          handle,
00597                          &amp;string,
00598                          KeyValuePartialInformation,
00599                          keyValue,
00600                          <span class="keyword">sizeof</span>(buffer),
00601                          &amp;length);
00602             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00603                 disabled = *((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(&amp;keyValue-&gt;Data[0]));
00604 
00605                 <span class="keywordflow">if</span> (disabled == ONE_BOOT) {
00606                     <span class="comment">//  Only disabled for last boot so re-enable now.</span>
00607                     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>( handle, &amp;string);
00608                     <span class="comment">//  BUGBUG should we repin?</span>
00609                 }
00610             }
00611         }
00612 
00613         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00614         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00615             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set CSCSettings: %x\n"</span>, status ));
00616             <span class="keywordflow">goto</span> cleanup;
00617         }
00618     }
00619 <span class="preprocessor">#endif</span>
00620 <span class="preprocessor"></span><span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00621 <span class="preprocessor"></span>
00622     <span class="comment">//</span>
00623     <span class="comment">// Add registry values for the IP address and subnet mask received</span>
00624     <span class="comment">// from DHCP. These are stored under the Tcpip service key and are</span>
00625     <span class="comment">// read by both Tcpip and Netbt. The adapter name used is the known</span>
00626     <span class="comment">// GUID for the NetbootCard.</span>
00627     <span class="comment">//</span>
00628 
00629     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters\\Interfaces\\{54C7D140-09EF-11D1-B25A-F5FE627ED95E}"</span> );
00630 
00631     InitializeObjectAttributes(
00632         &amp;objectAttributes,
00633         &amp;string,
00634         OBJ_CASE_INSENSITIVE,
00635         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00636         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00637         );
00638 
00639     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00640     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00641         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open Tcpip\\Parameters\\Interfaces\\{54C7D140-09EF-11D1-B25A-F5FE627ED95E} key: %x\n"</span>, status ));
00642         <span class="keywordflow">goto</span> cleanup;
00643     }
00644 
00645     status = <a class="code" href="../../d4/d6/netboot_8c.html#a4">IopWriteIpAddressToRegistry</a>(handle,
00646                                          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DhcpIPAddress"</span>,
00647                                          (PUCHAR)&amp;(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o21">IpAddress</a>)
00648                                         );
00649 
00650     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00651         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00652         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write DhcpIPAddress: %x\n"</span>, status ));
00653         <span class="keywordflow">goto</span> cleanup;
00654     }
00655 
00656     status = <a class="code" href="../../d4/d6/netboot_8c.html#a4">IopWriteIpAddressToRegistry</a>(handle,
00657                                          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DhcpSubnetMask"</span>,
00658                                          (PUCHAR)&amp;(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o22">SubnetMask</a>)
00659                                         );
00660 
00661     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00662         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00663         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write DhcpSubnetMask: %x\n"</span>, status ));
00664         <span class="keywordflow">goto</span> cleanup;
00665     }
00666 
00667     status = <a class="code" href="../../d4/d6/netboot_8c.html#a4">IopWriteIpAddressToRegistry</a>(handle,
00668                                          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DhcpDefaultGateway"</span>,
00669                                          (PUCHAR)&amp;(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o24">DefaultRouter</a>)
00670                                         );
00671 
00672     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00673 
00674     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00675         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write DhcpDefaultGateway: %x\n"</span>, status ));
00676         <span class="keywordflow">goto</span> cleanup;
00677     }
00678 
00679     <span class="comment">//</span>
00680     <span class="comment">// Create the service key for the netboot card. We need to have</span>
00681     <span class="comment">// the Type value there or the card won't be initialized.</span>
00682     <span class="comment">//</span>
00683 
00684     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
00685                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00686                                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>,
00687                                 KEY_ALL_ACCESS,
00688                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00689                                 );
00690 
00691     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00692         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open CurrentControlSet\\Services: %x\n"</span>, status ));
00693         <span class="keywordflow">goto</span> cleanup;
00694     }
00695 
00696     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;string, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o28">NetbootCardServiceName</a>);
00697 
00698     InitializeObjectAttributes(&amp;objectAttributes,
00699                                &amp;string,
00700                                OBJ_CASE_INSENSITIVE,
00701                                handle,
00702                                (PSECURITY_DESCRIPTOR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00703                                );
00704 
00705     status = ZwCreateKey(&amp;serviceHandle,
00706                          KEY_ALL_ACCESS,
00707                          &amp;objectAttributes,
00708                          0,
00709                          (PUNICODE_STRING)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00710                          0,
00711                          &amp;tmpValue     <span class="comment">// disposition</span>
00712                          );
00713 
00714     ZwClose(handle);
00715 
00716     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00717         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open/create netboot card service key: %x\n"</span>, status ));
00718         <span class="keywordflow">goto</span> cleanup;
00719     }
00720 
00721     <span class="comment">//</span>
00722     <span class="comment">// Store the image path.</span>
00723     <span class="comment">//</span>
00724 
00725     PiWstrToUnicodeString(&amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ImagePath"</span>);
00726     wcscpy(imagePath, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"system32\\drivers\\"</span>);
00727     wcscat(imagePath, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o27">NetbootCardDriverName</a>);
00728 
00729     status = ZwSetValueKey(serviceHandle,
00730                            &amp;string,
00731                            <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00732                            REG_SZ,
00733                            imagePath,
00734                            (wcslen(imagePath) + 1) * <span class="keyword">sizeof</span>(WCHAR)
00735                            );
00736 
00737     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00738         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(serviceHandle);
00739         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write ImagePath: %x\n"</span>, status ));
00740         <span class="keywordflow">goto</span> cleanup;
00741     }
00742 
00743     <span class="comment">//</span>
00744     <span class="comment">// Store the type.</span>
00745     <span class="comment">//</span>
00746 
00747     PiWstrToUnicodeString(&amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Type"</span>);
00748     tmpValue = 1;
00749 
00750     ZwSetValueKey(serviceHandle,
00751                   &amp;string,
00752                   <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00753                   REG_DWORD,
00754                   &amp;tmpValue,
00755                   <span class="keyword">sizeof</span>(tmpValue)
00756                   );
00757 
00758     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(serviceHandle);
00759 
00760     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00761         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write Type: %x\n"</span>, status ));
00762     }
00763 
00764 cleanup:
00765 
00766     <span class="keywordflow">return</span> status;
00767 }
00768 
00769 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00770"></a><a class="code" href="../../d4/d6/netboot_8c.html#a11">00770</a> <a class="code" href="../../d4/d6/netboot_8c.html#a11">IopStartNetworkForRemoteBoot</a> (
00771     <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00772     )
00773 {
00774     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00775     HANDLE dgHandle;
00776     HANDLE keyHandle;
00777     OBJECT_ATTRIBUTES objectAttributes;
00778     IO_STATUS_BLOCK ioStatusBlock;
00779     UNICODE_STRING string;
00780     UNICODE_STRING computerName;
00781     UNICODE_STRING domainName;
00782     PUCHAR buffer;
00783     ULONG bufferLength;
00784     PLMR_REQUEST_PACKET rrp;
00785     PLMDR_REQUEST_PACKET drrp;
00786     WKSTA_INFO_502 wkstaConfig;
00787     WKSTA_TRANSPORT_INFO_0 wkstaTransportInfo;
00788     LARGE_INTEGER interval;
00789     ULONG length;
00790     PKEY_VALUE_PARTIAL_INFORMATION keyValue;
00791     BOOLEAN startDatagramReceiver;
00792     ULONG enumerateAttempts;
00793 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00794 <span class="preprocessor"></span>    PWSTR NetHDCSCPartition;
00795     BOOLEAN leaveRdrHandleOpen;
00796     BOOLEAN pinNetDriver;
00797 <span class="preprocessor">#else</span>
00798 <span class="preprocessor"></span>    HANDLE RdrHandle;
00799 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00800 <span class="preprocessor"></span>
00801     <span class="comment">//</span>
00802     <span class="comment">// Initialize for cleanup.</span>
00803     <span class="comment">//</span>
00804 
00805     buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00806     computerName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00807     domainName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00808     dgHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00809     RdrHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00810 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00811 <span class="preprocessor"></span>    NetHDCSCPartition = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00812     leaveRdrHandleOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00813     pinNetDriver = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00814 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00815 <span class="preprocessor"></span>
00816     <span class="comment">//</span>
00817     <span class="comment">// Allocate a temporary buffer. It has to be big enough for all the</span>
00818     <span class="comment">// various FSCTLs we send down.</span>
00819     <span class="comment">//</span>
00820 
00821     bufferLength = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<span class="keyword">sizeof</span>(LMR_REQUEST_PACKET) + (<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> + 1) * <span class="keyword">sizeof</span>(WCHAR) +
00822                                                  (DNLEN + 1) * <span class="keyword">sizeof</span>(WCHAR),
00823                        <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<span class="keyword">sizeof</span>(LMDR_REQUEST_PACKET),
00824                            FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>));
00825     bufferLength = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(bufferLength, <span class="keyword">sizeof</span>(LMMR_RI_INITIALIZE_SECRET));
00826 
00827 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00828 <span class="preprocessor"></span>    NetHDCSCPartition = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00829                             <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00830                             (80 * <span class="keyword">sizeof</span>(WCHAR)) + bufferLength,
00831                             'bRoI'
00832                             );
00833     <span class="keywordflow">if</span> (NetHDCSCPartition == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00834         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to allocate buffer\n"</span>));
00835         status = STATUS_INSUFFICIENT_RESOURCES;
00836         <span class="keywordflow">goto</span> cleanup;
00837     }
00838     buffer = (PUCHAR)(NetHDCSCPartition + 80);
00839 <span class="preprocessor">#else</span>
00840 <span class="preprocessor"></span>    buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, bufferLength, 'bRoI' );
00841     <span class="keywordflow">if</span> (buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00842         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to allocate buffer\n"</span>));
00843         status = STATUS_INSUFFICIENT_RESOURCES;
00844         <span class="keywordflow">goto</span> cleanup;
00845     }
00846 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00847 <span class="preprocessor"></span>
00848     rrp = (PLMR_REQUEST_PACKET)buffer;
00849     drrp = (PLMDR_REQUEST_PACKET)buffer;
00850 
00851     <span class="comment">//</span>
00852     <span class="comment">// Open the redirector and the datagram receiver.</span>
00853     <span class="comment">//</span>
00854 
00855     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Device\\LanmanRedirector"</span> );
00856 
00857     InitializeObjectAttributes(
00858         &amp;objectAttributes,
00859         &amp;string,
00860         OBJ_CASE_INSENSITIVE,
00861         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00862         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00863         );
00864 
00865     status = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
00866                 &amp;RdrHandle,
00867                 GENERIC_READ | GENERIC_WRITE,
00868                 &amp;objectAttributes,
00869                 &amp;ioStatusBlock,
00870                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00871                 0,
00872                 FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
00873                 FILE_OPEN,
00874                 FILE_SYNCHRONOUS_IO_NONALERT,
00875                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00876                 0
00877                 );
00878     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00879         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open redirector: %x\n"</span>, status ));
00880         <span class="keywordflow">goto</span> cleanup;
00881     }
00882 
00883 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00884 <span class="preprocessor"></span>    RdrHandleProcess = &amp;<a class="code" href="../../d4/d6/iosubs_8c.html#a70">IoGetCurrentProcess</a>()-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>;
00885 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00886 <span class="preprocessor"></span>
00887     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, DD_BROWSER_DEVICE_NAME_U );
00888 
00889     InitializeObjectAttributes(
00890         &amp;objectAttributes,
00891         &amp;string,
00892         OBJ_CASE_INSENSITIVE,
00893         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00894         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00895         );
00896 
00897     status = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
00898                 &amp;dgHandle,
00899                 GENERIC_READ | GENERIC_WRITE,
00900                 &amp;objectAttributes,
00901                 &amp;ioStatusBlock,
00902                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00903                 0,
00904                 FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
00905                 FILE_OPEN,
00906                 FILE_SYNCHRONOUS_IO_NONALERT,
00907                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00908                 0
00909                 );
00910     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00911         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open datagram receiver: %x\n"</span>, status ));
00912         <span class="keywordflow">goto</span> cleanup;
00913     }
00914 
00915     <span class="comment">//</span>
00916     <span class="comment">// If the setup loader block has a disk secret in it provided by the</span>
00917     <span class="comment">// loader, pass this down to the redirector (do this before sending</span>
00918     <span class="comment">// the LMR_START, since that uses this information).</span>
00919     <span class="comment">//</span>
00920 
00921 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00922 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o36">NetBootSecret</a>)
00923 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00924 <span class="preprocessor"></span>    {
00925         PLMMR_RI_INITIALIZE_SECRET RbInit = (PLMMR_RI_INITIALIZE_SECRET)buffer;
00926 
00927         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o36">NetBootSecret</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00928         RtlCopyMemory(
00929             &amp;RbInit-&gt;Secret,
00930             LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o36">NetBootSecret</a>,
00931             <span class="keyword">sizeof</span>(RI_SECRET));
00932 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00933 <span class="preprocessor"></span>        RbInit-&gt;UsePassword2 = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;NetBootUsePassword2;
00934 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00935 <span class="preprocessor"></span>
00936         status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
00937                     RdrHandle,
00938                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00939                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00940                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00941                     &amp;ioStatusBlock,
00942                     FSCTL_LMMR_RI_INITIALIZE_SECRET,
00943                     buffer,
00944                     <span class="keyword">sizeof</span>(LMMR_RI_INITIALIZE_SECRET),
00945                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00946                     0
00947                     );
00948 
00949         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00950             status = ioStatusBlock.Status;
00951         }
00952         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00953             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to FSCTL(RB initialize) redirector: %x\n"</span>, status ));
00954             <span class="keywordflow">goto</span> cleanup;
00955         }
00956     }
00957 
00958     <span class="comment">//</span>
00959     <span class="comment">// Read the computer name and domain name from the registry so we</span>
00960     <span class="comment">// can give them to the datagram receiver. During textmode setup</span>
00961     <span class="comment">// the domain name will not be there, so we won't start the datagram</span>
00962     <span class="comment">// receiver, which is fine.</span>
00963     <span class="comment">//</span>
00964     <span class="comment">// BUGBUG: Figure out the correct location to read the domain name</span>
00965     <span class="comment">// from -- this one is a special hack in winnt.sif just for this.</span>
00966     <span class="comment">//</span>
00967 
00968     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\ComputerName\\ComputerName"</span> );
00969 
00970     InitializeObjectAttributes(
00971         &amp;objectAttributes,
00972         &amp;string,
00973         OBJ_CASE_INSENSITIVE,
00974         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00975         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00976         );
00977 
00978     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;keyHandle, KEY_ALL_ACCESS, &amp;objectAttributes );
00979     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00980         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open ComputerName key: %x\n"</span>, status ));
00981         <span class="keywordflow">goto</span> cleanup;
00982     }
00983 
00984     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ComputerName"</span> );
00985 
00986     keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)buffer;
00987     RtlZeroMemory(buffer, bufferLength);
00988 
00989     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00990                  keyHandle,
00991                  &amp;string,
00992                  KeyValuePartialInformation,
00993                  keyValue,
00994                  bufferLength,
00995                  &amp;length);
00996 
00997     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( keyHandle );
00998     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00999         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to query ComputerName value: %x\n"</span>, status ));
01000         <span class="keywordflow">goto</span> cleanup;
01001     }
01002 
01003     <span class="keywordflow">if</span> ( !<a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;computerName, (PWSTR)keyValue-&gt;Data) ) {
01004         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to create ComputerName string\n"</span> ));
01005         status = STATUS_INSUFFICIENT_RESOURCES;
01006         <span class="keywordflow">goto</span> cleanup;
01007     }
01008 
01009     domainName.Length = 0;
01010 
01011     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\ComputerName\\DomainName"</span> );
01012 
01013     InitializeObjectAttributes(
01014         &amp;objectAttributes,
01015         &amp;string,
01016         OBJ_CASE_INSENSITIVE,
01017         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01018         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01019         );
01020 
01021     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;keyHandle, KEY_ALL_ACCESS, &amp;objectAttributes );
01022     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01023         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open DomainName key: %x\n"</span>, status ));
01024         startDatagramReceiver = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01025     } <span class="keywordflow">else</span> {
01026 
01027         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DomainName"</span> );
01028 
01029         keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)buffer;
01030         RtlZeroMemory(buffer, bufferLength);
01031 
01032         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
01033                      keyHandle,
01034                      &amp;string,
01035                      KeyValuePartialInformation,
01036                      keyValue,
01037                      bufferLength,
01038                      &amp;length);
01039 
01040         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( keyHandle );
01041         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01042             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to query Domain value: %x\n"</span>, status ));
01043             startDatagramReceiver = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01044         } <span class="keywordflow">else</span> {
01045             <span class="keywordflow">if</span> ( !<a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;domainName, (PWSTR)keyValue-&gt;Data) ) {
01046                 KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to create DomainName string\n"</span> ));
01047                 status = STATUS_INSUFFICIENT_RESOURCES;
01048                 <span class="keywordflow">goto</span> cleanup;
01049             }
01050             startDatagramReceiver = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01051         }
01052     }
01053 
01054     <span class="comment">//</span>
01055     <span class="comment">// Tell the redir to start.</span>
01056     <span class="comment">//</span>
01057 
01058     rrp-&gt;Type = ConfigInformation;
01059     rrp-&gt;Version = REQUEST_PACKET_VERSION;
01060 
01061     rrp-&gt;Parameters.Start.RedirectorNameLength = computerName.Length;
01062     RtlCopyMemory(rrp-&gt;Parameters.Start.RedirectorName,
01063                   computerName.Buffer,
01064                   computerName.Length);
01065 
01066     rrp-&gt;Parameters.Start.DomainNameLength = domainName.Length;
01067     RtlCopyMemory(((PUCHAR)rrp-&gt;Parameters.Start.RedirectorName) + computerName.Length,
01068                   domainName.Buffer,
01069                   domainName.Length);
01070 
01071     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;computerName);
01072     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;domainName);
01073 
01074     wkstaConfig.wki502_char_wait = 3600;
01075     wkstaConfig.wki502_maximum_collection_count = 16;
01076     wkstaConfig.wki502_collection_time = 250;
01077     wkstaConfig.wki502_keep_conn = 600;
01078     wkstaConfig.wki502_max_cmds = 5;
01079     wkstaConfig.wki502_sess_timeout = 45;
01080     wkstaConfig.wki502_siz_char_buf = 512;
01081     wkstaConfig.wki502_max_threads = 17;
01082     wkstaConfig.wki502_lock_quota = 6144;
01083     wkstaConfig.wki502_lock_increment = 10;
01084     wkstaConfig.wki502_lock_maximum = 500;
01085     wkstaConfig.wki502_pipe_increment = 10;
01086     wkstaConfig.wki502_pipe_maximum = 500;
01087     wkstaConfig.wki502_cache_file_timeout = 40;
01088     wkstaConfig.wki502_dormant_file_limit = 45;
01089     wkstaConfig.wki502_read_ahead_throughput = MAXULONG;
01090     wkstaConfig.wki502_num_mailslot_buffers = 3;
01091     wkstaConfig.wki502_num_srv_announce_buffers = 20;
01092     wkstaConfig.wki502_max_illegal_datagram_events = 5;
01093     wkstaConfig.wki502_illegal_datagram_event_reset_frequency = 60;
01094     wkstaConfig.wki502_log_election_packets = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01095     wkstaConfig.wki502_use_opportunistic_locking = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01096     wkstaConfig.wki502_use_unlock_behind = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01097     wkstaConfig.wki502_use_close_behind = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01098     wkstaConfig.wki502_buf_named_pipes = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01099     wkstaConfig.wki502_use_lock_read_unlock = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01100     wkstaConfig.wki502_utilize_nt_caching = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01101     wkstaConfig.wki502_use_raw_read = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01102     wkstaConfig.wki502_use_raw_write = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01103     wkstaConfig.wki502_use_write_raw_data = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01104     wkstaConfig.wki502_use_encryption = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01105     wkstaConfig.wki502_buf_files_deny_write = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01106     wkstaConfig.wki502_buf_read_only_files = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01107     wkstaConfig.wki502_force_core_create_mode = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01108     wkstaConfig.wki502_use_512_byte_max_transfer = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01109 
01110     status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01111                 RdrHandle,
01112                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01113                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01114                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01115                 &amp;ioStatusBlock,
01116                 FSCTL_LMR_START | 0x80000000,
01117                 rrp,
01118                 <span class="keyword">sizeof</span>(LMR_REQUEST_PACKET) +
01119                     rrp-&gt;Parameters.Start.RedirectorNameLength +
01120                     rrp-&gt;Parameters.Start.DomainNameLength,
01121                 &amp;wkstaConfig,
01122                 <span class="keyword">sizeof</span>(wkstaConfig)
01123                 );
01124 
01125     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01126         status = ioStatusBlock.Status;
01127     }
01128     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01129         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to FSCTL(start) redirector: %x\n"</span>, status ));
01130         <span class="keywordflow">goto</span> cleanup;
01131     }
01132 
01133     <span class="keywordflow">if</span> (startDatagramReceiver) {
01134 
01135         <span class="comment">//</span>
01136         <span class="comment">// Tell the datagram receiver to start.</span>
01137         <span class="comment">//</span>
01138 
01139         drrp-&gt;Version = LMDR_REQUEST_PACKET_VERSION;
01140 
01141         drrp-&gt;Parameters.Start.NumberOfMailslotBuffers = 16;
01142         drrp-&gt;Parameters.Start.NumberOfServerAnnounceBuffers = 20;
01143         drrp-&gt;Parameters.Start.IllegalDatagramThreshold = 5;
01144         drrp-&gt;Parameters.Start.EventLogResetFrequency = 60;
01145         drrp-&gt;Parameters.Start.LogElectionPackets = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01146 
01147         drrp-&gt;Parameters.Start.IsLanManNt = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01148 
01149         status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
01150                     dgHandle,
01151                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01152                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01153                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01154                     &amp;ioStatusBlock,
01155                     IOCTL_LMDR_START,
01156                     drrp,
01157                     <span class="keyword">sizeof</span>(LMDR_REQUEST_PACKET),
01158                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01159                     0
01160                     );
01161 
01162         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01163             status = ioStatusBlock.Status;
01164         }
01165 
01166         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( dgHandle );
01167         dgHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01168 
01169         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01170             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to IOCTL(start) datagram receiver: %x\n"</span>, status ));
01171             <span class="keywordflow">goto</span> cleanup;
01172         }
01173 
01174     } <span class="keywordflow">else</span> {
01175 
01176         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( dgHandle );
01177         dgHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01178 
01179         <span class="comment">//</span>
01180         <span class="comment">// Tell the redir to bind to the transports.</span>
01181         <span class="comment">//</span>
01182         <span class="comment">// Note: In the current redirector implementation, this call just</span>
01183         <span class="comment">// tells the redirector to register for TDI PnP notifications.</span>
01184         <span class="comment">// Starting the datagram receiver also does this, so we only issue</span>
01185         <span class="comment">// this FSCTL if we're not starting the datagram receiver.</span>
01186         <span class="comment">//</span>
01187 
01188         status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01189                     RdrHandle,
01190                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01191                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01192                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01193                     &amp;ioStatusBlock,
01194                     FSCTL_LMR_BIND_TO_TRANSPORT | 0x80000000,
01195                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01196                     0,
01197                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01198                     0
01199                     );
01200 
01201         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01202             status = ioStatusBlock.Status;
01203         }
01204 
01205         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01206             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to FSCTL(bind) redirector: %x\n"</span>, status ));
01207             <span class="keywordflow">goto</span> cleanup;
01208         }
01209     }
01210 
01211 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01212 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; <a class="code" href="../../d3/d8/setupblk_8h.html#a26">SETUPBLK_FLAGS_IS_TEXTMODE</a>) == 0) &amp;&amp;
01213         ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_FORMAT_NEEDED) == 0)) {
01214 
01215         <span class="comment">//</span>
01216         <span class="comment">// Get the path to the boot partition on the disk for CSC and redirection</span>
01217         <span class="comment">// Note: On failure, this defaults to \Device\Harddisk0\Partition1</span>
01218         <span class="comment">//</span>
01219 
01220         IopGetHarddiskInfo(NetHDCSCPartition);
01221 
01222         <span class="comment">//</span>
01223         <span class="comment">// Tell the redirector to initialize remote boot redirection (back</span>
01224         <span class="comment">// to the local disk). Note that we only do this if we're NOT doing</span>
01225         <span class="comment">// textmode setup. During textmode, we let Setup do this so that it</span>
01226         <span class="comment">// can do so AFTER it has reformatted the local disk.</span>
01227         <span class="comment">//</span>
01228 
01229         status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01230                     RdrHandle,
01231                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01232                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01233                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01234                     &amp;ioStatusBlock,
01235                     FSCTL_LMR_START_RBR,
01236                     NetHDCSCPartition,
01237                     wcslen(NetHDCSCPartition) * <span class="keyword">sizeof</span>(WCHAR),
01238                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01239                     0
01240                     );
01241 
01242         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01243             status = ioStatusBlock.Status;
01244         }
01245 
01246         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01247             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to FSCTL(RBR) redirector: %x\n"</span>, status ));
01248         }
01249     }
01250 
01251     <span class="keywordflow">if</span> ( (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_DISCONNECTED) == 0 )
01252 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01253 <span class="preprocessor"></span>    {
01254 
01255         <span class="comment">//</span>
01256         <span class="comment">// Loop until the redirector is bound to the transport. It may take a</span>
01257         <span class="comment">// while because TDI defers notification of binding to a worker thread.</span>
01258         <span class="comment">// We start with a half a second wait and double it each time, trying</span>
01259         <span class="comment">// five times total.</span>
01260         <span class="comment">//</span>
01261 
01262         interval.QuadPart = -500 * 1000 * 10;    <span class="comment">// 1/2 second, relative</span>
01263         enumerateAttempts = 0;
01264 
01265         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01266 
01267             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;interval);
01268 
01269             RtlZeroMemory(rrp, <span class="keyword">sizeof</span>(LMR_REQUEST_PACKET));
01270 
01271             rrp-&gt;Type = EnumerateTransports;
01272             rrp-&gt;Version = REQUEST_PACKET_VERSION;
01273 
01274             status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01275                         RdrHandle,
01276                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01277                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01278                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01279                         &amp;ioStatusBlock,
01280                         FSCTL_LMR_ENUMERATE_TRANSPORTS,
01281                         rrp,
01282                         <span class="keyword">sizeof</span>(LMR_REQUEST_PACKET),
01283                         &amp;wkstaTransportInfo,
01284                         <span class="keyword">sizeof</span>(wkstaTransportInfo)
01285                         );
01286 
01287             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01288                 status = ioStatusBlock.Status;
01289             }
01290             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01291                 <span class="comment">//KdPrint(( "IopStartNetworkForRemoteBoot: Unable to FSCTL(enumerate) redirector: %x\n", status ));</span>
01292             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rrp-&gt;Parameters.Get.TotalBytesNeeded == 0) {
01293                 <span class="comment">//KdPrint(( "IopStartNetworkForRemoteBoot: FSCTL(enumerate) returned 0 entries\n" ));</span>
01294             } <span class="keywordflow">else</span> {
01295                 <span class="keywordflow">break</span>;
01296             }
01297 
01298             ++enumerateAttempts;
01299 
01300             <span class="keywordflow">if</span> (enumerateAttempts == 5) {
01301                 KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Redirector didn't start\n"</span> ));
01302                 status = STATUS_REDIRECTOR_NOT_STARTED;
01303                 <span class="keywordflow">goto</span> cleanup;
01304             }
01305 
01306             interval.QuadPart *= 2;
01307 
01308         }
01309     }
01310 
01311     <span class="comment">//</span>
01312     <span class="comment">// Prime the transport.</span>
01313     <span class="comment">//</span>
01314 
01315 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01316 <span class="preprocessor"></span>    IopEnableRemoteBootSecurity(LoaderBlock);
01317 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01318 <span class="preprocessor"></span>    <a class="code" href="../../d4/d6/netboot_8c.html#a7">IopSetDefaultGateway</a>(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o24">DefaultRouter</a>);
01319     <a class="code" href="../../d4/d6/netboot_8c.html#a8">IopCacheNetbiosNameForIpAddress</a>(LoaderBlock);
01320 
01321 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01322 <span class="preprocessor"></span>    <span class="comment">//</span>
01323     <span class="comment">// CSC needs to be initialized after binding to the transport because ResetCSC</span>
01324     <span class="comment">// (if needed) will try to enumerate the files and directories on the server.</span>
01325     <span class="comment">//</span>
01326 
01327     <span class="keywordflow">if</span> (((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; <a class="code" href="../../d3/d8/setupblk_8h.html#a26">SETUPBLK_FLAGS_IS_TEXTMODE</a>) == 0) &amp;&amp;
01328         ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_FORMAT_NEEDED) == 0)
01329 <span class="preprocessor">#if 0</span>
01330 <span class="preprocessor"></span>        &amp;&amp; ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_DISABLE_CSC) != 0)
01331 <span class="preprocessor">#endif</span>
01332 <span class="preprocessor"></span>        ) {
01333 
01334         wcstombs(buffer, NetHDCSCPartition, wcslen(NetHDCSCPartition) + 1);
01335         strcat(buffer, REMOTE_BOOT_IMIRROR_PATH_A REMOTE_BOOT_CSC_SUBDIR_A);
01336 
01337         status = IopInitCsc( buffer );
01338 
01339         <span class="comment">//</span>
01340         <span class="comment">//  If we are connected and either we are part way through a reset of</span>
01341         <span class="comment">//  the csc or the init failed then reset the csc.</span>
01342         <span class="comment">//</span>
01343 
01344         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01345 
01346             <span class="keywordflow">if</span> (StartCsc == FLUSH_CSC ) {
01347 
01348                 <span class="keywordflow">if</span> ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_DISCONNECTED) == 0) {
01349 
01350                     <span class="comment">//</span>
01351                     <span class="comment">// CSC may have lost the pin information.</span>
01352                     <span class="comment">//</span>
01353 
01354                     status = IopResetCsc( buffer );
01355 
01356                     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01357                         KdPrint((<span class="stringliteral">"IopStartNetworkForRemoteBoot: reset of Csc failed %x\n"</span>, status));
01358                     }
01359                 } <span class="keywordflow">else</span> {
01360                     IoCscInitializationFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01361                 }
01362             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_PIN_NET_DRIVER) &amp;&amp;
01363                        (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o27">NetbootCardDriverName</a>[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>)) {
01364 
01365                 <span class="comment">//</span>
01366                 <span class="comment">// if we are connected and we're not repinning all files and</span>
01367                 <span class="comment">// we have a new net card driver to pin, then pin it below</span>
01368                 <span class="comment">// after we've created called IopAssignNetworkDriveLetter</span>
01369                 <span class="comment">//</span>
01370 
01371                 pinNetDriver = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01372             }
01373         }
01374 
01375         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01376             KdPrint((<span class="stringliteral">"IopStartNetworkForRemoteBoot: initialization of Csc failed %x\n"</span>, status));
01377             IoCscInitializationFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01378             SharedUserData-&gt;SystemFlags |= SYSTEM_FLAG_DISKLESS_CLIENT;
01379         }
01380 
01381     } <span class="keywordflow">else</span> {
01382         IoCscInitializationFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01383         SharedUserData-&gt;SystemFlags |= SYSTEM_FLAG_DISKLESS_CLIENT;
01384     }
01385 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01386 <span class="preprocessor"></span>
01387     <a class="code" href="../../d4/d6/netboot_8c.html#a12">IopAssignNetworkDriveLetter</a>(LoaderBlock);
01388 
01389 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01390 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pinNetDriver) {
01391 
01392         <span class="comment">//</span>
01393         <span class="comment">//  Pin the new net card driver simply by opening it.  if it</span>
01394         <span class="comment">//  fails, it's not fatal, as we'll eventually pin it since</span>
01395         <span class="comment">//  the directory it's in is marked as system/inherit.</span>
01396         <span class="comment">//</span>
01397 
01398         HANDLE driverHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01399         PWCHAR fullDriverName;
01400 
01401         fullDriverName = (PWCHAR) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
01402                             <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01403                             <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\SystemRoot\\System32\\Drivers\\"</span> ) +
01404                             <span class="keyword">sizeof</span>( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o27">NetbootCardDriverName</a> ),
01405                             'bRoI'
01406                             );
01407 
01408         <span class="keywordflow">if</span> (fullDriverName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01409 
01410             wcscpy(fullDriverName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\SystemRoot\\System32\\Drivers\\"</span>);
01411             wcscat(fullDriverName, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o27">NetbootCardDriverName</a>);
01412 
01413             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, fullDriverName );
01414 
01415             InitializeObjectAttributes(
01416                 &amp;objectAttributes,
01417                 &amp;string,
01418                 OBJ_CASE_INSENSITIVE,
01419                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01420                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01421                 );
01422 
01423             status = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
01424                         &amp;driverHandle,
01425                         GENERIC_READ,
01426                         &amp;objectAttributes,
01427                         &amp;ioStatusBlock,
01428                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01429                         FILE_ATTRIBUTE_NORMAL,
01430                         FILE_SHARE_READ,
01431                         FILE_OPEN,
01432                         FILE_SYNCHRONOUS_IO_NONALERT,
01433                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01434                         0
01435                         );
01436             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01437 
01438                 <span class="comment">//</span>
01439                 <span class="comment">//  this is not a fatal error, the redir should pin it eventually</span>
01440                 <span class="comment">//</span>
01441 
01442                 KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open new net driver: 0x%x\n"</span>, status ));
01443             }
01444             <span class="keywordflow">if</span> (driverHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01445                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( driverHandle );
01446             }
01447 
01448             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( fullDriverName );
01449 
01450         } <span class="keywordflow">else</span> {
01451 
01452             <span class="comment">//</span>
01453             <span class="comment">//  this is not a fatal error, the redir should pin it eventually</span>
01454             <span class="comment">//</span>
01455 
01456             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to allocate buffer to pin netcard driver\n"</span> ));
01457         }
01458     }
01459 
01460     leaveRdrHandleOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01461 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01462 <span class="preprocessor"></span>
01463 cleanup:
01464 
01465     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;computerName );
01466     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;domainName );
01467 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01468 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( NetHDCSCPartition != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01469         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NetHDCSCPartition );
01470     }
01471 <span class="preprocessor">#else</span>
01472 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01473         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( buffer );
01474     }
01475 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01476 <span class="preprocessor"></span>
01477     <span class="keywordflow">if</span> ( dgHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01478         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( dgHandle );
01479     }
01480 
01481 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01482 <span class="preprocessor"></span>    <span class="comment">//</span>
01483     <span class="comment">// If requested, exit with RdrHandle still set so that we can close CSC quickly.</span>
01484     <span class="comment">//</span>
01485 
01486     <span class="keywordflow">if</span> ( !leaveRdrHandleOpen &amp;&amp; (RdrHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
01487         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( RdrHandle );
01488         RdrHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01489     }
01490 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01491 <span class="preprocessor"></span>
01492     <span class="keywordflow">return</span> status;
01493 }
01494 
01495 
01496 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01497 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01498 IopShutdownCsc(
01499     )
01500 {
01501     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01502     IO_STATUS_BLOCK ioStatusBlock;
01503     SHADOWINFO shadowInfo;
01504 
01505     <span class="keywordflow">if</span> ( RdrHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01506 
01507         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( RdrHandleProcess );
01508 
01509         RtlZeroMemory( &amp;shadowInfo, <span class="keyword">sizeof</span>(shadowInfo) );
01510         shadowInfo.uStatus = 0x0001; <span class="comment">// SHADOW_SWITCH_SHADOWING</span>
01511         shadowInfo.uOp = 1; <span class="comment">// SHADOW_SWITCH_OFF</span>
01512 
01513         status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
01514                     RdrHandle,
01515                     NULL,
01516                     NULL,
01517                     NULL,
01518                     &amp;ioStatusBlock,
01519                     IOCTL_SWITCHES,
01520                     &amp;shadowInfo,
01521                     0,
01522                     NULL,
01523                     0
01524                     );
01525 <span class="preprocessor">#if DBG</span>
01526 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01527             status = ioStatusBlock.Status;
01528         }
01529 
01530         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01531             KdPrint(( <span class="stringliteral">"IopShutdownCsc: %x\n"</span>, status ));
01532         }
01533 <span class="preprocessor">#endif</span>
01534 <span class="preprocessor"></span>        <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( RdrHandle );
01535         RdrHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01536 
01537         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01538     }
01539 
01540     <span class="keywordflow">return</span>;
01541 }
01542 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01543 <span class="preprocessor"></span>
01544 
01545 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01546"></a><a class="code" href="../../d4/d6/netboot_8c.html#a12">01546</a> <a class="code" href="../../d4/d6/netboot_8c.html#a12">IopAssignNetworkDriveLetter</a> (
01547     <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
01548     )
01549 {
01550     PUCHAR p;
01551     PUCHAR q;
01552     UCHAR ntName[128];
01553     STRING ansiString;
01554     UNICODE_STRING unicodeString;
01555     UNICODE_STRING unicodeString2;
01556     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01557 
01558     <span class="comment">//</span>
01559     <span class="comment">// Create the symbolic link of X: to the redirector. We do this</span>
01560     <span class="comment">// after the redirector has loaded, but before AssignDriveLetters</span>
01561     <span class="comment">// is called the first time in textmode setup (once that has</span>
01562     <span class="comment">// happened, the drive letters will stick).</span>
01563     <span class="comment">//</span>
01564     <span class="comment">// Note that we use X: for the textmode setup phase of a remote</span>
01565     <span class="comment">// installation. But for a true remote boot, we use C:.</span>
01566     <span class="comment">//</span>
01567 
01568     <span class="keywordflow">if</span> ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; (<a class="code" href="../../d3/d8/setupblk_8h.html#a28">SETUPBLK_FLAGS_REMOTE_INSTALL</a> |
01569                                                  <a class="code" href="../../d3/d8/setupblk_8h.html#a29">SETUPBLK_FLAGS_SYSPREP_INSTALL</a>)) != 0) {
01570         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString2, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\DosDevices\\X:"</span>);
01571     } <span class="keywordflow">else</span> {
01572         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString2, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\DosDevices\\C:"</span>);
01573     }
01574 
01575     <span class="comment">//</span>
01576     <span class="comment">// If this is a remote boot setup boot, NtBootPathName is of the</span>
01577     <span class="comment">// form &lt;server&gt;&lt;share&gt;\setup&lt;install-directory&gt;&lt;platform&gt;.</span>
01578     <span class="comment">// We want the root of the X: drive to be the root of the install</span>
01579     <span class="comment">// directory.</span>
01580     <span class="comment">//</span>
01581     <span class="comment">// If this is a normal remote boot, NtBootPathName is of the form</span>
01582     <span class="comment">// &lt;server&gt;&lt;share&gt;\images&lt;machine&gt;\winnt. We want the root of</span>
01583     <span class="comment">// the X: drive to be the root of the machine directory.</span>
01584     <span class="comment">//</span>
01585     <span class="comment">// Thus in either case, we need to remove the last element of the</span>
01586     <span class="comment">// path.</span>
01587     <span class="comment">//</span>
01588 
01589     p = strrchr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a>, <span class="charliteral">'\\'</span> );   <span class="comment">// find last separator</span>
01590     <span class="keywordflow">if</span> ( (p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (*(p+1) == 0) ) {
01591 
01592         <span class="comment">//</span>
01593         <span class="comment">// NtBootPathName ends with a backslash, so we need to back up</span>
01594         <span class="comment">// to the previous backslash.</span>
01595         <span class="comment">//</span>
01596 
01597         q = p;
01598         *q = 0;
01599         p = strrchr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a>, <span class="charliteral">'\\'</span> );   <span class="comment">// find last separator</span>
01600         *q = <span class="charliteral">'\\'</span>;
01601     }
01602     <span class="keywordflow">if</span> ( p == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01603         KdPrint(( <span class="stringliteral">"IopAssignNetworkDriveLetter: malformed NtBootPathName: %s\n"</span>, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a> ));
01604         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>( ASSIGN_DRIVE_LETTERS_FAILED );
01605     }
01606     *p = 0;                                 <span class="comment">// terminate \server\share\images\machine</span>
01607 
01608     strcpy( ntName, <span class="stringliteral">"\\Device\\LanmanRedirector"</span>);
01609     strcat( ntName, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a> );  <span class="comment">// append \server\share\images\machine</span>
01610 
01611     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;ansiString, ntName );
01612     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;unicodeString, &amp;ansiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01613 
01614     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a50">IoCreateSymbolicLink</a>(&amp;unicodeString2, &amp;unicodeString);
01615     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01616         KdPrint(( <span class="stringliteral">"IopAssignNetworkDriveLetter: unable to create DOS link for redirected boot drive: %x\n"</span>, status ));
01617         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>( ASSIGN_DRIVE_LETTERS_FAILED );
01618     }
01619     <span class="comment">// DbgPrint("IopAssignNetworkDriveLetter: assigned %wZ to %wZ\n", &amp;unicodeString2, &amp;unicodeString);</span>
01620 
01621     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;unicodeString );
01622 
01623     *p = <span class="charliteral">'\\'</span>;                              <span class="comment">// restore string</span>
01624 
01625     <span class="keywordflow">return</span>;
01626 }
01627 
01628 
01629 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01630 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01631 IopEnableRemoteBootSecurity (
01632     <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
01633     )
01634 {
01635     UNICODE_STRING IpsecString;
01636     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01637     HANDLE handle;
01638     OBJECT_ATTRIBUTES objectAttributes;
01639     IO_STATUS_BLOCK ioStatusBlock;
01640     UCHAR policyBuffer[<span class="keyword">sizeof</span>(IPSEC_SET_POLICY) + <span class="keyword">sizeof</span>(IPSEC_POLICY_INFO)];
01641     PIPSEC_SET_POLICY setPolicy = (PIPSEC_SET_POLICY)policyBuffer;
01642     IPSEC_FILTER outboundFilter;
01643     IPSEC_FILTER inboundFilter;
01644     IPSEC_SET_SPI setSpi;
01645     UCHAR saBuffer[<span class="keyword">sizeof</span>(IPSEC_ADD_UPDATE_SA) + (6 * <span class="keyword">sizeof</span>(ULONG))];
01646     PIPSEC_ADD_UPDATE_SA addUpdateSa;
01647 
01648 
01649     <span class="keywordflow">if</span> ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_IPSEC_ENABLED) == 0) {
01650         <span class="keywordflow">return</span>;
01651     }
01652 
01653     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;IpsecString, DD_IPSEC_DEVICE_NAME );
01654 
01655     InitializeObjectAttributes(
01656         &amp;objectAttributes,
01657         &amp;IpsecString,
01658         OBJ_CASE_INSENSITIVE,
01659         NULL,
01660         NULL
01661         );
01662 
01663     status = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
01664                 &amp;handle,
01665                 GENERIC_READ | GENERIC_WRITE,
01666                 &amp;objectAttributes,
01667                 &amp;ioStatusBlock,
01668                 NULL,
01669                 0,
01670                 FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
01671                 FILE_OPEN,
01672                 FILE_SYNCHRONOUS_IO_NONALERT,
01673                 NULL,
01674                 0
01675                 );
01676     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01677         KdPrint(( <span class="stringliteral">"IopEnableRemoteBootSecurity: Unable to open IPSEC: %x\n"</span>, status ));
01678         <span class="keywordflow">return</span>;
01679     }
01680 
01681     <span class="comment">//</span>
01682     <span class="comment">// Set the policy. We need two filters, one for outbound and</span>
01683     <span class="comment">// one for inbound.</span>
01684     <span class="comment">//</span>
01685 
01686     RtlZeroMemory(&amp;outboundFilter, <span class="keyword">sizeof</span>(IPSEC_FILTER));
01687     RtlZeroMemory(&amp;inboundFilter, <span class="keyword">sizeof</span>(IPSEC_FILTER));
01688 
01689     outboundFilter.SrcAddr = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o21">IpAddress</a>;
01690     outboundFilter.SrcMask = 0xffffffff;
01691     outboundFilter.DestAddr = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o23">ServerIpAddress</a>;
01692     outboundFilter.DestMask = 0xffffffff;
01693     <span class="comment">// outboundFilter.DestPort = 0x8B;  // netbios session port</span>
01694     outboundFilter.Protocol = 0x6;   <span class="comment">// TCP</span>
01695 
01696     inboundFilter.SrcAddr = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o23">ServerIpAddress</a>;
01697     inboundFilter.SrcMask = 0xffffffff;
01698     <span class="comment">// inboundFilter.SrcPort = 0x8B;  // netbios session port</span>
01699     inboundFilter.DestAddr = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o21">IpAddress</a>;
01700     inboundFilter.DestMask = 0xffffffff;
01701     inboundFilter.Protocol = 0x6;   <span class="comment">// TCP</span>
01702 
01703     RtlZeroMemory(setPolicy, <span class="keyword">sizeof</span>(policyBuffer));
01704 
01705     setPolicy-&gt;NumEntries = 2;
01706     setPolicy-&gt;pInfo[0].Index = 1;
01707     setPolicy-&gt;pInfo[0].AssociatedFilter = outboundFilter;
01708     setPolicy-&gt;pInfo[1].Index = 2;
01709     setPolicy-&gt;pInfo[1].AssociatedFilter = inboundFilter;
01710 
01711     status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
01712                 handle,
01713                 NULL,
01714                 NULL,
01715                 NULL,
01716                 &amp;ioStatusBlock,
01717                 IOCTL_IPSEC_SET_POLICY,
01718                 setPolicy,
01719                 <span class="keyword">sizeof</span>(policyBuffer),
01720                 NULL,
01721                 0
01722                 );
01723 
01724     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01725         KdPrint(( <span class="stringliteral">"IopEnableRemoteBootSecurity: Unable to IOCTL_IPSEC_SET_POLICY: %x\n"</span>, status ));
01726         <span class="keywordflow">return</span>;
01727     }
01728 
01729     <span class="comment">//</span>
01730     <span class="comment">// Now set the SPI we made up in the loader.</span>
01731     <span class="comment">//</span>
01732 
01733     setSpi.Context = 0;
01734     setSpi.InstantiatedFilter = inboundFilter;
01735     setSpi.SPI = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;IpsecInboundSpi;
01736 
01737     status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
01738                 handle,
01739                 NULL,
01740                 NULL,
01741                 NULL,
01742                 &amp;ioStatusBlock,
01743                 IOCTL_IPSEC_SET_SPI,
01744                 &amp;setSpi,
01745                 <span class="keyword">sizeof</span>(IPSEC_SET_SPI),
01746                 &amp;setSpi,
01747                 <span class="keyword">sizeof</span>(IPSEC_SET_SPI)
01748                 );
01749 
01750     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01751         KdPrint(( <span class="stringliteral">"IopEnableRemoteBootSecurity: Unable to IOCTL_IPSEC_SET_SPI: %x\n"</span>, status ));
01752         <span class="keywordflow">return</span>;
01753     }
01754 
01755     <span class="comment">//</span>
01756     <span class="comment">// Set up the security association for the outbound</span>
01757     <span class="comment">// connection.</span>
01758     <span class="comment">//</span>
01759 
01760     addUpdateSa = (PIPSEC_ADD_UPDATE_SA)saBuffer;
01761     memset(addUpdateSa, 0, <span class="keyword">sizeof</span>(saBuffer));
01762 
01763     addUpdateSa-&gt;SAInfo.Context = setSpi.Context;
01764     addUpdateSa-&gt;SAInfo.NumSAs = 1;
01765     addUpdateSa-&gt;SAInfo.InstantiatedFilter = outboundFilter;
01766     addUpdateSa-&gt;SAInfo.SecAssoc[0].Operation = Encrypt;
01767     addUpdateSa-&gt;SAInfo.SecAssoc[0].SPI = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;IpsecOutboundSpi;
01768     addUpdateSa-&gt;SAInfo.SecAssoc[0].IntegrityAlgo.algoIdentifier = IPSEC_AH_MD5;
01769     addUpdateSa-&gt;SAInfo.SecAssoc[0].IntegrityAlgo.algoKeylen = 4 * <span class="keyword">sizeof</span>(ULONG);
01770     addUpdateSa-&gt;SAInfo.SecAssoc[0].ConfAlgo.algoIdentifier = IPSEC_ESP_DES;
01771     addUpdateSa-&gt;SAInfo.SecAssoc[0].ConfAlgo.algoKeylen = 2 * <span class="keyword">sizeof</span>(ULONG);
01772 
01773     addUpdateSa-&gt;SAInfo.KeyLen = 6 * <span class="keyword">sizeof</span>(ULONG);
01774     memcpy(addUpdateSa-&gt;SAInfo.KeyMat, &amp;LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;IpsecSessionKey, <span class="keyword">sizeof</span>(ULONG));
01775     memcpy(addUpdateSa-&gt;SAInfo.KeyMat+<span class="keyword">sizeof</span>(ULONG), &amp;LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;IpsecSessionKey, <span class="keyword">sizeof</span>(ULONG));
01776     memcpy(addUpdateSa-&gt;SAInfo.KeyMat+(2*<span class="keyword">sizeof</span>(ULONG)), &amp;LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;IpsecSessionKey, <span class="keyword">sizeof</span>(ULONG));
01777     memcpy(addUpdateSa-&gt;SAInfo.KeyMat+(3*<span class="keyword">sizeof</span>(ULONG)), &amp;LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;IpsecSessionKey, <span class="keyword">sizeof</span>(ULONG));
01778     memcpy(addUpdateSa-&gt;SAInfo.KeyMat+(4*<span class="keyword">sizeof</span>(ULONG)), &amp;LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;IpsecSessionKey, <span class="keyword">sizeof</span>(ULONG));
01779     memcpy(addUpdateSa-&gt;SAInfo.KeyMat+(5*<span class="keyword">sizeof</span>(ULONG)), &amp;LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;IpsecSessionKey, <span class="keyword">sizeof</span>(ULONG));
01780 
01781     status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
01782                 handle,
01783                 NULL,
01784                 NULL,
01785                 NULL,
01786                 &amp;ioStatusBlock,
01787                 IOCTL_IPSEC_ADD_SA,
01788                 addUpdateSa,
01789                 FIELD_OFFSET(IPSEC_ADD_UPDATE_SA, SAInfo.KeyMat[0]) + addUpdateSa-&gt;SAInfo.KeyLen,
01790                 NULL,
01791                 0
01792                 );
01793 
01794     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01795         KdPrint(( <span class="stringliteral">"IopEnableRemoteBootSecurity: Unable to IOCTL_IPSEC_ADD_SA: %x\n"</span>, status ));
01796         <span class="keywordflow">return</span>;
01797     }
01798 
01799     <span class="comment">//</span>
01800     <span class="comment">// Set up the security association for the inbound connection.</span>
01801     <span class="comment">// If our Operation is "None", IPSEC does this for us.</span>
01802     <span class="comment">//</span>
01803 
01804     <span class="keywordflow">if</span> (addUpdateSa-&gt;SAInfo.SecAssoc[0].Operation != None) {
01805 
01806         addUpdateSa-&gt;SAInfo.SecAssoc[0].SPI = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;IpsecInboundSpi;
01807         addUpdateSa-&gt;SAInfo.InstantiatedFilter = inboundFilter;
01808 
01809         status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
01810                     handle,
01811                     NULL,
01812                     NULL,
01813                     NULL,
01814                     &amp;ioStatusBlock,
01815                     IOCTL_IPSEC_UPDATE_SA,
01816                     addUpdateSa,
01817                     FIELD_OFFSET(IPSEC_ADD_UPDATE_SA, SAInfo.KeyMat[0]) + addUpdateSa-&gt;SAInfo.KeyLen,
01818                     NULL,
01819                     0
01820                     );
01821 
01822         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01823             KdPrint(( <span class="stringliteral">"IopEnableRemoteBootSecurity: Unable to IOCTL_IPSEC_UPDATE_SA: %x\n"</span>, status ));
01824             <span class="keywordflow">return</span>;
01825         }
01826     }
01827 
01828     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
01829 
01830 }
01831 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01832 <span class="preprocessor"></span>
01833 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01834"></a><a class="code" href="../../d4/d6/netboot_8c.html#a13">01834</a> <a class="code" href="../../d4/d6/netboot_8c.html#a13">IopStartTcpIpForRemoteBoot</a> (
01835     <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
01836     )
01837 {
01838     UNICODE_STRING IpString;
01839     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01840     HANDLE handle;
01841     OBJECT_ATTRIBUTES objectAttributes;
01842     IO_STATUS_BLOCK ioStatusBlock;
01843     IP_SET_ADDRESS_REQUEST IpRequest;
01844 
01845     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;IpString, DD_IP_DEVICE_NAME );
01846 
01847     InitializeObjectAttributes(
01848         &amp;objectAttributes,
01849         &amp;IpString,
01850         OBJ_CASE_INSENSITIVE,
01851         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01852         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01853         );
01854 
01855     IpRequest.Context = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)2;
01856     IpRequest.Address = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o21">IpAddress</a>;
01857     IpRequest.SubnetMask = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o22">SubnetMask</a>;
01858 
01859     status = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
01860                 &amp;handle,
01861                 GENERIC_READ | GENERIC_WRITE,
01862                 &amp;objectAttributes,
01863                 &amp;ioStatusBlock,
01864                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01865                 0,
01866                 FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
01867                 FILE_OPEN,
01868                 FILE_SYNCHRONOUS_IO_NONALERT,
01869                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01870                 0
01871                 );
01872     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01873         KdPrint(( <span class="stringliteral">"IopStartTcpIpForRemoteBoot: Unable to open IP: %x\n"</span>, status ));
01874         <span class="keywordflow">goto</span> cleanup;
01875     }
01876 
01877     status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
01878                 handle,
01879                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01880                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01881                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01882                 &amp;ioStatusBlock,
01883                 IOCTL_IP_SET_ADDRESS_DUP,
01884                 &amp;IpRequest,
01885                 <span class="keyword">sizeof</span>(IP_SET_ADDRESS_REQUEST),
01886                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01887                 0
01888                 );
01889 
01890     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
01891 
01892     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01893         KdPrint(( <span class="stringliteral">"IopStartTcpIpForRemoteBoot: Unable to IOCTL IP: %x\n"</span>, status ));
01894         <span class="keywordflow">goto</span> cleanup;
01895     }
01896 
01897 cleanup:
01898 
01899     <span class="keywordflow">return</span> status;
01900 }
01901 
01902 BOOLEAN
<a name="l01903"></a><a class="code" href="../../d4/d6/netboot_8c.html#a14">01903</a> <a class="code" href="../../d4/d6/netboot_8c.html#a14">IopIsRemoteBootCard</a>(
01904     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
01905     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock,
01906     IN PWCHAR HwIds
01907     )
01908 
01909 <span class="comment">/*++</span>
01910 <span class="comment"></span>
01911 <span class="comment">Routine Description:</span>
01912 <span class="comment"></span>
01913 <span class="comment">    This function determines if the card described by the hwIds is the</span>
01914 <span class="comment">    remote boot network card. It checks against the hardware ID for the</span>
01915 <span class="comment">    card that is stored in the setup loader block.</span>
01916 <span class="comment"></span>
01917 <span class="comment">    THIS ASSUMES THAT IOREMOTEBOOTCLIENT IS TRUE AND THAT LOADERBLOCK</span>
01918 <span class="comment">    IS VALID.</span>
01919 <span class="comment"></span>
01920 <span class="comment">Arguments:</span>
01921 <span class="comment"></span>
01922 <span class="comment">    DeviceNode - Device node for the card in question.</span>
01923 <span class="comment"></span>
01924 <span class="comment">    LoaderBlock - Supplies a pointer to the loader parameter block that was</span>
01925 <span class="comment">        created by the OS Loader.</span>
01926 <span class="comment"></span>
01927 <span class="comment">    HwIds - The hardware IDs for the device in question.</span>
01928 <span class="comment"></span>
01929 <span class="comment">Return Value:</span>
01930 <span class="comment"></span>
01931 <span class="comment">    TRUE or FALSE.</span>
01932 <span class="comment"></span>
01933 <span class="comment">--*/</span>
01934 
01935 {
01936     <a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html">PSETUP_LOADER_BLOCK</a> setupLoaderBlock;
01937     PWCHAR curHwId;
01938 
01939     <span class="comment">//</span>
01940     <span class="comment">// setupLoaderBlock will always be non-NULL if we are</span>
01941     <span class="comment">// remote booting, even if we are not in setup.</span>
01942     <span class="comment">//</span>
01943 
01944     setupLoaderBlock = LoaderBlock-&gt;SetupLoaderBlock;
01945 
01946     <span class="comment">//</span>
01947     <span class="comment">// Scan through the HwIds for a match.</span>
01948     <span class="comment">//</span>
01949 
01950     curHwId = HwIds;
01951 
01952     <span class="keywordflow">while</span> (*curHwId != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) {
01953         <span class="keywordflow">if</span> (wcscmp(curHwId, setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o26">NetbootCardHardwareId</a>) == 0) {
01954 
01955             ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>, SlotNumber;
01956 
01957             <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = (ULONG)((((PNET_CARD_INFO)setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o31">NetbootCardInfo</a>)-&gt;pci.BusDevFunc) &gt;&gt; 8);
01958             SlotNumber = (ULONG)(((((PNET_CARD_INFO)setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o31">NetbootCardInfo</a>)-&gt;pci.BusDevFunc) &amp; 0xf8) &gt;&gt; 3);
01959             
01960             KdPrint((<span class="stringliteral">"IopIsRemoteBootCard: FOUND %ws\n"</span>, setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o26">NetbootCardHardwareId</a>));
01961             <span class="keywordflow">if</span> ((DeviceNode-&gt;ResourceRequirements-&gt;BusNumber != <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>) ||
01962                 (DeviceNode-&gt;ResourceRequirements-&gt;SlotNumber != SlotNumber)) {
01963                 KdPrint((<span class="stringliteral">"IopIsRemoteBootCard: ignoring non-matching card:\n"</span>));
01964                 KdPrint((<span class="stringliteral">"  devnode bus %d, busdevfunc bus %d\n"</span>,
01965                     DeviceNode-&gt;ResourceRequirements-&gt;BusNumber,
01966                     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>));
01967                 KdPrint((<span class="stringliteral">"  devnode slot %d, busdevfunc slot %d\n"</span>,
01968                     DeviceNode-&gt;ResourceRequirements-&gt;SlotNumber,
01969                     SlotNumber));
01970                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01971             } <span class="keywordflow">else</span> {
01972                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01973             }
01974         }
01975         curHwId += (wcslen(curHwId) + 1);
01976     }
01977 
01978     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01979 }
01980 
01981 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01982"></a><a class="code" href="../../d4/d6/netboot_8c.html#a15">01982</a> <a class="code" href="../../d4/d6/netboot_8c.html#a15">IopSetupRemoteBootCard</a>(
01983     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock,
01984     IN HANDLE UniqueIdHandle,
01985     IN PUNICODE_STRING UnicodeDeviceInstance
01986     )
01987 
01988 <span class="comment">/*++</span>
01989 <span class="comment"></span>
01990 <span class="comment">Routine Description:</span>
01991 <span class="comment"></span>
01992 <span class="comment">    This function modifies the registry to set up the netboot card.</span>
01993 <span class="comment">    We must do this here since the card is needed to boot, we can't</span>
01994 <span class="comment">    wait for the class installer to run.</span>
01995 <span class="comment"></span>
01996 <span class="comment">    THIS ASSUMES THAT IOREMOTEBOOTCLIENT IS TRUE.</span>
01997 <span class="comment"></span>
01998 <span class="comment">Arguments:</span>
01999 <span class="comment"></span>
02000 <span class="comment">    LoaderBlock - Supplies a pointer to the loader parameter block that was</span>
02001 <span class="comment">        created by the OS Loader.</span>
02002 <span class="comment"></span>
02003 <span class="comment">    UniqueIdHandle - A handle to the device's unique node under the</span>
02004 <span class="comment">        Enum key.</span>
02005 <span class="comment"></span>
02006 <span class="comment">    UnicodeDeviceInstance - The device instance assigned to the device.</span>
02007 <span class="comment"></span>
02008 <span class="comment">Return Value:</span>
02009 <span class="comment"></span>
02010 <span class="comment">    Status of the operation.</span>
02011 <span class="comment"></span>
02012 <span class="comment">--*/</span>
02013 
02014 {
02015     <a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html">PSETUP_LOADER_BLOCK</a> setupLoaderBlock;
02016     UNICODE_STRING unicodeName, pnpInstanceId, keyName;
02017     HANDLE tmpHandle;
02018     HANDLE parametersHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02019     HANDLE currentControlSetHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02020     HANDLE remoteBootHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02021     HANDLE instanceHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02022     PWCHAR componentIdBuffer, curComponentIdLoc;
02023     PCHAR registryList;
02024     ULONG componentIdLength;
02025     WCHAR tempNameBuffer[32];
02026     WCHAR tempValueBuffer[128];
02027     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02028     ULONG tmpValue, length;
02029     PKEY_VALUE_PARTIAL_INFORMATION keyValue;
02030     PKEY_VALUE_BASIC_INFORMATION keyValueBasic;
02031     UCHAR dataBuffer[FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + 128];
02032     ULONG enumerateIndex;
02033     OBJECT_ATTRIBUTES objectAttributes;
02034     ULONG disposition;
02035 
02036     <span class="comment">//</span>
02037     <span class="comment">// If we already think we have initialized a remote boot card, then</span>
02038     <span class="comment">// exit (should not really happen once we identify cards using the</span>
02039     <span class="comment">// bus/slot.</span>
02040     <span class="comment">//</span>
02041 
02042     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a74">IopRemoteBootCardInitialized</a>) {
02043         <span class="keywordflow">return</span> STATUS_SUCCESS;
02044     }
02045 
02046     <span class="comment">//</span>
02047     <span class="comment">// setupLoaderBlock will always be non-NULL if we are</span>
02048     <span class="comment">// remote booting, even if we are not in setup.</span>
02049     <span class="comment">//</span>
02050 
02051     setupLoaderBlock = LoaderBlock-&gt;SetupLoaderBlock;
02052 
02053     <span class="comment">//</span>
02054     <span class="comment">// Open the current control set.</span>
02055     <span class="comment">//</span>
02056 
02057     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;currentControlSetHandle,
02058                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02059                                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a22">CmRegistryMachineSystemCurrentControlSet</a>,
02060                                 KEY_ALL_ACCESS,
02061                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02062                                 );
02063 
02064     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02065         <span class="keywordflow">goto</span> cleanup;
02066     }
02067 
02068     <span class="comment">//</span>
02069     <span class="comment">// Open the Control\RemoteBoot key, which may not exist.</span>
02070     <span class="comment">//</span>
02071 
02072     PiWstrToUnicodeString(&amp;unicodeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Control\\RemoteBoot"</span>);
02073 
02074     InitializeObjectAttributes(&amp;objectAttributes,
02075                                &amp;unicodeName,
02076                                OBJ_CASE_INSENSITIVE,
02077                                currentControlSetHandle,
02078                                (PSECURITY_DESCRIPTOR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02079                                );
02080 
02081     status = ZwCreateKey(&amp;remoteBootHandle,
02082                          KEY_ALL_ACCESS,
02083                          &amp;objectAttributes,
02084                          0,
02085                          (PUNICODE_STRING)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02086                          0,
02087                          &amp;disposition
02088                          );
02089 
02090     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02091         <span class="keywordflow">goto</span> cleanup;
02092     }
02093 
02094     <span class="comment">//</span>
02095     <span class="comment">// Open the key where the netui code stores information about the cards.</span>
02096     <span class="comment">// During textmode setup this will fail because the Control\Network</span>
02097     <span class="comment">// key is not there. After that it should work, although we may need</span>
02098     <span class="comment">// to create the last node in the path.</span>
02099     <span class="comment">//</span>
02100 
02101     PiWstrToUnicodeString(&amp;unicodeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Control\\Network\\{4D36E972-E325-11CE-BFC1-08002BE10318}\\{54C7D140-09EF-11D1-B25A-F5FE627ED95E}"</span>);
02102 
02103     InitializeObjectAttributes(&amp;objectAttributes,
02104                                &amp;unicodeName,
02105                                OBJ_CASE_INSENSITIVE,
02106                                currentControlSetHandle,
02107                                (PSECURITY_DESCRIPTOR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02108                                );
02109 
02110     status = ZwCreateKey(&amp;instanceHandle,
02111                          KEY_ALL_ACCESS,
02112                          &amp;objectAttributes,
02113                          0,
02114                          (PUNICODE_STRING)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02115                          0,
02116                          &amp;disposition
02117                          );
02118 
02119     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02120 
02121         <span class="comment">//</span>
02122         <span class="comment">// If the PnpInstanceID of the first netboot card matches the one</span>
02123         <span class="comment">// for this device node, and the NET_CARD_INFO that the loader</span>
02124         <span class="comment">// found is the same as the one we saved, then this is the same</span>
02125         <span class="comment">// card with the same instance ID as before, so we don't need to</span>
02126         <span class="comment">// do anything.</span>
02127         <span class="comment">//</span>
02128 
02129         PiWstrToUnicodeString(&amp;unicodeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PnPInstanceID"</span>);
02130         keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)dataBuffer;
02131         RtlZeroMemory(dataBuffer, <span class="keyword">sizeof</span>(dataBuffer));
02132 
02133         status = ZwQueryValueKey(
02134                      instanceHandle,
02135                      &amp;unicodeName,
02136                      KeyValuePartialInformation,
02137                      keyValue,
02138                      <span class="keyword">sizeof</span>(dataBuffer),
02139                      &amp;length);
02140 
02141         <span class="comment">//</span>
02142         <span class="comment">// Check that it matches. We can init the string because we zeroed</span>
02143         <span class="comment">// the dataBuffer before reading the key, so even if the</span>
02144         <span class="comment">// registry value had no NULL at the end that is OK.</span>
02145         <span class="comment">//</span>
02146 
02147         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) &amp;&amp;
02148             (keyValue-&gt;Type == REG_SZ)) {
02149 
02150             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;pnpInstanceId, (PWSTR)(keyValue-&gt;Data));
02151 
02152             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(UnicodeDeviceInstance, &amp;pnpInstanceId, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
02153 
02154                 <span class="comment">//</span>
02155                 <span class="comment">// Instance ID matched, see if the NET_CARD_INFO matches.</span>
02156                 <span class="comment">//</span>
02157 
02158                 PiWstrToUnicodeString(&amp;unicodeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"NetCardInfo"</span>);
02159                 RtlZeroMemory(dataBuffer, <span class="keyword">sizeof</span>(dataBuffer));
02160 
02161                 status = ZwQueryValueKey(
02162                              remoteBootHandle,
02163                              &amp;unicodeName,
02164                              KeyValuePartialInformation,
02165                              keyValue,
02166                              <span class="keyword">sizeof</span>(dataBuffer),
02167                              &amp;length);
02168 
02169                 <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) &amp;&amp;
02170                     (keyValue-&gt;Type == REG_BINARY) &amp;&amp;
02171                     (keyValue-&gt;DataLength == <span class="keyword">sizeof</span>(NET_CARD_INFO)) &amp;&amp;
02172                     (memcmp(keyValue-&gt;Data, setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o31">NetbootCardInfo</a>, <span class="keyword">sizeof</span>(NET_CARD_INFO)) == 0)) {
02173 
02174                     <span class="comment">//</span>
02175                     <span class="comment">// Everything matched, so no need to do any setup.</span>
02176                     <span class="comment">//</span>
02177 
02178                     status = STATUS_SUCCESS;
02179                     <span class="keywordflow">goto</span> cleanup;
02180 
02181                 }
02182             }
02183         }
02184     }
02185 
02186 
02187     <span class="comment">//</span>
02188     <span class="comment">// We come through here if the saved registry data was missing or</span>
02189     <span class="comment">// not correct. Write all the relevant values to the registry.</span>
02190     <span class="comment">//</span>
02191 
02192 
02193     <span class="comment">//</span>
02194     <span class="comment">// Service name is in the loader block.</span>
02195     <span class="comment">//</span>
02196 
02197     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_SERVICE);
02198     ZwSetValueKey(UniqueIdHandle,
02199                   &amp;unicodeName,
02200                   <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02201                   REG_SZ,
02202                   setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o28">NetbootCardServiceName</a>,
02203                   (wcslen(setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o28">NetbootCardServiceName</a>) + 1) * <span class="keyword">sizeof</span>(WCHAR)
02204                   );
02205 
02206     <span class="comment">//</span>
02207     <span class="comment">// ClassGUID is the known net card GUID.</span>
02208     <span class="comment">//</span>
02209 
02210     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_CLASSGUID);
02211     ZwSetValueKey(UniqueIdHandle,
02212                   &amp;unicodeName,
02213                   <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02214                   REG_SZ,
02215                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}"</span>,
02216                   <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}"</span>)
02217                   );
02218 
02219     <span class="comment">//</span>
02220     <span class="comment">// Driver is the first net card.</span>
02221     <span class="comment">//</span>
02222 
02223     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_DRIVER);
02224     ZwSetValueKey(UniqueIdHandle,
02225                   &amp;unicodeName,
02226                   <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02227                   REG_SZ,
02228                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}\\0000"</span>,
02229                   <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}\\0000"</span>)
02230                   );
02231 
02232 <span class="preprocessor">#ifdef REMOTE_BOOT</span>
02233 <span class="preprocessor"></span>    <span class="comment">//</span>
02234     <span class="comment">// Identify this as the netboot card so the network class</span>
02235     <span class="comment">// installer knows to assign the reserved GUID.</span>
02236     <span class="comment">//</span>
02237 
02238     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_CONFIG_FLAGS);
02239 
02240     keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)dataBuffer;
02241     RtlZeroMemory(dataBuffer, <span class="keyword">sizeof</span>(dataBuffer));
02242 
02243     status = ZwQueryValueKey(UniqueIdHandle,
02244                              &amp;unicodeName,
02245                              KeyValuePartialInformation,
02246                              keyValue,
02247                              <span class="keyword">sizeof</span>(dataBuffer),
02248                              &amp;length);
02249 
02250     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) &amp;&amp;
02251         (keyValue-&gt;Type == REG_DWORD)) {
02252         <span class="comment">//</span>
02253         <span class="comment">// The ConfigFlags value exists in the registry</span>
02254         <span class="comment">//</span>
02255         tmpValue = (*(PULONG)keyValue-&gt;Data) | CONFIGFLAG_NETBOOT_CARD;
02256     } <span class="keywordflow">else</span> {
02257         tmpValue = CONFIGFLAG_NETBOOT_CARD;
02258     }
02259 
02260     ZwSetValueKey(UniqueIdHandle,
02261                   &amp;unicodeName,
02262                   <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02263                   REG_DWORD,
02264                   &amp;tmpValue,
02265                   <span class="keyword">sizeof</span>(tmpValue)
02266                   );
02267 <span class="preprocessor">#endif</span>
02268 <span class="preprocessor"></span>
02269 
02270     <span class="comment">//</span>
02271     <span class="comment">// Open a handle for card parameters. We write RemoteBootCard plus</span>
02272     <span class="comment">// whatever the BINL server told us to write.</span>
02273     <span class="comment">//</span>
02274 
02275     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;tmpHandle,
02276                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02277                                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a27">CmRegistryMachineSystemCurrentControlSetControlClass</a>,
02278                                 KEY_ALL_ACCESS,
02279                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02280                                 );
02281 
02282     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02283         <span class="keywordflow">goto</span> cleanup;
02284     }
02285 
02286     PiWstrToUnicodeString(&amp;unicodeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}\\0000"</span>);
02287 
02288     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;parametersHandle,
02289                                 tmpHandle,
02290                                 &amp;unicodeName,
02291                                 KEY_ALL_ACCESS,
02292                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02293                                 );
02294 
02295     ZwClose(tmpHandle);
02296 
02297     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02298         <span class="keywordflow">goto</span> cleanup;
02299     }
02300 
02301     <span class="comment">//</span>
02302     <span class="comment">// We know that this is a different NIC, so remove all the old parameters.</span>
02303     <span class="comment">//</span>
02304 
02305     keyValueBasic = (PKEY_VALUE_BASIC_INFORMATION)dataBuffer;
02306     enumerateIndex = 0;
02307 
02308     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02309 
02310         RtlZeroMemory(dataBuffer, <span class="keyword">sizeof</span>(dataBuffer));
02311 
02312         status = ZwEnumerateValueKey(
02313                     parametersHandle,
02314                     enumerateIndex,
02315                     KeyValueBasicInformation,
02316                     keyValueBasic,
02317                     <span class="keyword">sizeof</span>(dataBuffer),
02318                     &amp;length
02319                     );
02320         <span class="keywordflow">if</span> (status == STATUS_NO_MORE_ENTRIES) {
02321             status = STATUS_SUCCESS;
02322             <span class="keywordflow">break</span>;
02323         }
02324 
02325         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02326             <span class="keywordflow">goto</span> cleanup;
02327         }
02328 
02329         <span class="comment">//</span>
02330         <span class="comment">// We don't delete "NetCfgInstanceID", it won't change and</span>
02331         <span class="comment">// its presence signifies to the net class installer that</span>
02332         <span class="comment">// this is a replacement not a clean install.</span>
02333         <span class="comment">//</span>
02334 
02335         <span class="keywordflow">if</span> (_wcsicmp(keyValueBasic-&gt;Name, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"NetCfgInstanceID"</span>) != 0) {
02336 
02337             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;keyName, keyValueBasic-&gt;Name);
02338             status = ZwDeleteValueKey(
02339                         parametersHandle,
02340                         &amp;keyName
02341                         );
02342 
02343             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02344                 <span class="keywordflow">goto</span> cleanup;
02345             }
02346 
02347         } <span class="keywordflow">else</span> {
02348 
02349             enumerateIndex = 1;   <span class="comment">// leave NetCfgInstanceID at index 0</span>
02350         }
02351 
02352     }
02353 
02354     <span class="comment">//</span>
02355     <span class="comment">// Write a parameter called RemoteBootCard set to TRUE, this</span>
02356     <span class="comment">// is primarily so NDIS can recognize this as such.</span>
02357     <span class="comment">//</span>
02358 
02359     PiWstrToUnicodeString(&amp;unicodeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"RemoteBootCard"</span>);
02360     tmpValue = 1;
02361     ZwSetValueKey(parametersHandle,
02362                   &amp;unicodeName,
02363                   <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02364                   REG_DWORD,
02365                   &amp;tmpValue,
02366                   <span class="keyword">sizeof</span>(tmpValue)
02367                   );
02368 
02369 
02370     <span class="comment">//</span>
02371     <span class="comment">// Store any other parameters sent from the server.</span>
02372     <span class="comment">//</span>
02373 
02374     registryList = setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o29">NetbootCardRegistry</a>;
02375 
02376     <span class="keywordflow">if</span> (registryList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02377 
02378         STRING aString;
02379         UNICODE_STRING uString, uString2;
02380 
02381         <span class="comment">//</span>
02382         <span class="comment">// The registry list is a series of name\0type\0value\0, with</span>
02383         <span class="comment">// a final \0 at the end. It is in ANSI, not UNICODE.</span>
02384         <span class="comment">//</span>
02385         <span class="comment">// All values are stored under parametersHandle. Type is 1 for</span>
02386         <span class="comment">// DWORD and 2 for SZ.</span>
02387         <span class="comment">//</span>
02388 
02389         uString.Buffer = tempNameBuffer;
02390         uString.MaximumLength = <span class="keyword">sizeof</span>(tempNameBuffer);
02391 
02392         <span class="keywordflow">while</span> (*registryList != <span class="charliteral">'\0'</span>) {
02393 
02394             <span class="comment">//</span>
02395             <span class="comment">// First the name.</span>
02396             <span class="comment">//</span>
02397 
02398             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>(&amp;aString, registryList);
02399             <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;uString, &amp;aString, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02400 
02401             <span class="comment">//</span>
02402             <span class="comment">// Now the type.</span>
02403             <span class="comment">//</span>
02404 
02405             registryList += (<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(registryList) + 1);
02406 
02407             <span class="keywordflow">if</span> (*registryList == <span class="charliteral">'1'</span>) {
02408 
02409                 <span class="comment">//</span>
02410                 <span class="comment">// A DWORD, parse it.</span>
02411                 <span class="comment">//</span>
02412 
02413                 registryList += 2;   <span class="comment">// skip "1\0"</span>
02414                 tmpValue = 0;
02415 
02416                 <span class="keywordflow">while</span> (*registryList != <span class="charliteral">'\0'</span>) {
02417                     tmpValue = (tmpValue * 10) + (*registryList - <span class="charliteral">'0'</span>);
02418                     ++registryList;
02419                 }
02420 
02421                 ZwSetValueKey(parametersHandle,
02422                               &amp;uString,
02423                               <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02424                               REG_DWORD,
02425                               &amp;tmpValue,
02426                               <span class="keyword">sizeof</span>(tmpValue)
02427                               );
02428 
02429                 registryList += (<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(registryList) + 1);
02430 
02431             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*registryList == <span class="charliteral">'2'</span>) {
02432 
02433                 <span class="comment">//</span>
02434                 <span class="comment">// An SZ, convert to Unicode.</span>
02435                 <span class="comment">//</span>
02436 
02437                 registryList += 2;   <span class="comment">// skip "2\0"</span>
02438 
02439                 uString2.Buffer = tempValueBuffer;
02440                 uString2.MaximumLength = <span class="keyword">sizeof</span>(tempValueBuffer);
02441                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;aString, registryList);
02442                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;uString2, &amp;aString, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02443 
02444                 ZwSetValueKey(parametersHandle,
02445                               &amp;uString,
02446                               <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02447                               REG_SZ,
02448                               uString2.Buffer,
02449                               uString2.Length + <span class="keyword">sizeof</span>(WCHAR)
02450                               );
02451 
02452                 registryList += (<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(registryList) + 1);
02453 
02454             } <span class="keywordflow">else</span> {
02455 
02456                 <span class="comment">//</span>
02457                 <span class="comment">// Not "1" or "2", so stop processing registryList.</span>
02458                 <span class="comment">//</span>
02459 
02460                 <span class="keywordflow">break</span>;
02461 
02462             }
02463 
02464         }
02465 
02466     }
02467 
02468     <span class="comment">//</span>
02469     <span class="comment">// Save the NET_CARD_INFO so we can check it next time.</span>
02470     <span class="comment">//</span>
02471 
02472     PiWstrToUnicodeString(&amp;unicodeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"NetCardInfo"</span>);
02473 
02474     ZwSetValueKey(remoteBootHandle,
02475                   &amp;unicodeName,
02476                   <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02477                   REG_BINARY,
02478                   setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o31">NetbootCardInfo</a>,
02479                   <span class="keyword">sizeof</span>(NET_CARD_INFO)
02480                   );
02481 
02482 
02483     <span class="comment">//</span>
02484     <span class="comment">// Save the hardware ID, driver name, and service name,</span>
02485     <span class="comment">// so the loader can read  those if the server is down</span>
02486     <span class="comment">// on subsequent boots.</span>
02487     <span class="comment">//</span>
02488 
02489     PiWstrToUnicodeString(&amp;unicodeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"HardwareId"</span>);
02490 
02491     ZwSetValueKey(remoteBootHandle,
02492                   &amp;unicodeName,
02493                   <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02494                   REG_SZ,
02495                   setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o26">NetbootCardHardwareId</a>,
02496                   (wcslen(setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o26">NetbootCardHardwareId</a>) + 1) * <span class="keyword">sizeof</span>(WCHAR)
02497                   );
02498 
02499     PiWstrToUnicodeString(&amp;unicodeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DriverName"</span>);
02500 
02501     ZwSetValueKey(remoteBootHandle,
02502                   &amp;unicodeName,
02503                   <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02504                   REG_SZ,
02505                   setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o27">NetbootCardDriverName</a>,
02506                   (wcslen(setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o27">NetbootCardDriverName</a>) + 1) * <span class="keyword">sizeof</span>(WCHAR)
02507                   );
02508 
02509     PiWstrToUnicodeString(&amp;unicodeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ServiceName"</span>);
02510 
02511     ZwSetValueKey(remoteBootHandle,
02512                   &amp;unicodeName,
02513                   <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02514                   REG_SZ,
02515                   setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o28">NetbootCardServiceName</a>,
02516                   (wcslen(setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o28">NetbootCardServiceName</a>) + 1) * <span class="keyword">sizeof</span>(WCHAR)
02517                   );
02518 
02519     <span class="comment">//</span>
02520     <span class="comment">// Save the device instance, in case we need to ID the card later.</span>
02521     <span class="comment">//</span>
02522 
02523     PiWstrToUnicodeString(&amp;unicodeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DeviceInstance"</span>);
02524 
02525     ZwSetValueKey(remoteBootHandle,
02526                   &amp;unicodeName,
02527                   <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02528                   REG_SZ,
02529                   UnicodeDeviceInstance-&gt;Buffer,
02530                   UnicodeDeviceInstance-&gt;Length + <span class="keyword">sizeof</span>(WCHAR)
02531                   );
02532 
02533     <span class="comment">//</span>
02534     <span class="comment">// Make sure we only pick one card to setup this way!</span>
02535     <span class="comment">//</span>
02536 
02537     <a class="code" href="../../d3/d5/iodata_8c.html#a74">IopRemoteBootCardInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02538 
02539 
02540 cleanup:
02541     <span class="keywordflow">if</span> (instanceHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02542         ZwClose(instanceHandle);
02543     }
02544     <span class="keywordflow">if</span> (remoteBootHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02545         ZwClose(remoteBootHandle);
02546     }
02547     <span class="keywordflow">if</span> (parametersHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02548         ZwClose(parametersHandle);
02549     }
02550     <span class="keywordflow">if</span> (currentControlSetHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02551         ZwClose(currentControlSetHandle);
02552     }
02553 
02554     <span class="keywordflow">return</span> status;
02555 
02556 }
02557 
02558 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
02559 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02560 IopInitCsc(
02561     IN PUCHAR CscPath
02562     )
02563 <span class="comment">/*++</span>
02564 <span class="comment"></span>
02565 <span class="comment">Routine Description:</span>
02566 <span class="comment"></span>
02567 <span class="comment">    This function informs the Rdr2 Client Side Cache where to put the CSC database.</span>
02568 <span class="comment">    If the database is not there or is corrupt then an error is returned.</span>
02569 <span class="comment"></span>
02570 <span class="comment">Arguments:</span>
02571 <span class="comment"></span>
02572 <span class="comment">    CscPath - supplies the Nt path with no trailing backslash to the csc directory.</span>
02573 <span class="comment"></span>
02574 <span class="comment">Return Value:</span>
02575 <span class="comment"></span>
02576 <span class="comment">    Status of the operation. STATUS_MEDIA_CHECK if database may have lost pin information.</span>
02577 <span class="comment"></span>
02578 <span class="comment">--*/</span>
02579 
02580 {
02581     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02582     IO_STATUS_BLOCK ioStatusBlock;
02583     SHADOWINFO shadowInfo;
02584     WIN32_FIND_DATAA * find32;
02585 
02586     find32 = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool, <span class="keyword">sizeof</span>(WIN32_FIND_DATAA), 'bRoI');
02587     <span class="keywordflow">if</span> (find32 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02588         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02589     }
02590 
02591     RtlZeroMemory( find32, <span class="keyword">sizeof</span>(WIN32_FIND_DATAA) );
02592     find32-&gt;nFileSizeHigh = 0;
02593     find32-&gt;nFileSizeLow = 0xccab348;
02594     find32-&gt;dwReserved1 = 0x8000;
02595     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(CscPath) &lt; MAX_PATH);
02596     strcpy( find32-&gt;cFileName, CscPath );
02597 
02598     RtlZeroMemory( &amp;shadowInfo, <span class="keyword">sizeof</span>(shadowInfo) );
02599     shadowInfo.uStatus = 0x0001; <span class="comment">// SHADOW_SWITCH_SHADOWING</span>
02600     shadowInfo.uOp = 2; <span class="comment">// SHADOW_SWITCH_ON</span>
02601     shadowInfo.lpFind32 = (WIN32_FIND_DATAW *)find32;
02602 
02603     status = ZwDeviceIoControlFile(
02604                 RdrHandle,
02605                 NULL,
02606                 NULL,
02607                 NULL,
02608                 &amp;ioStatusBlock,
02609                 IOCTL_SWITCHES,
02610                 &amp;shadowInfo,
02611                 0,
02612                 NULL,
02613                 0
02614                 );
02615 
02616     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
02617         status = ioStatusBlock.Status;
02618     }
02619 
02620     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; shadowInfo.uOp ) {
02621 
02622         <span class="comment">//</span>
02623         <span class="comment">// Database was recreated.</span>
02624         <span class="comment">//</span>
02625 
02626         StartCsc = FLUSH_CSC;
02627         IopSetFlushCSC(SET_FLUSH_CSC);
02628     }
02629 
02630     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(find32);
02631 
02632     <span class="keywordflow">return</span> status;
02633 }
02634 
02635 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02636 IopResetCsc(
02637     IN PUCHAR CscPath
02638     )
02639 <span class="comment">/*++</span>
02640 <span class="comment"></span>
02641 <span class="comment">Routine Description:</span>
02642 <span class="comment"></span>
02643 <span class="comment">    This function walks the servers directories creating CSC database entries for each</span>
02644 <span class="comment">    file and directory on the server. The entries are marked as SPARSE so that the local</span>
02645 <span class="comment">    copies of all files are discarded.</span>
02646 <span class="comment"></span>
02647 <span class="comment">    There is a potential problem when a file is in the CSC database and is deleted on the</span>
02648 <span class="comment">    server by an admin local to the server. Should this happen, go to the workstation with</span>
02649 <span class="comment">    the CSC and delete the file or directory.</span>
02650 <span class="comment"></span>
02651 <span class="comment">Arguments:</span>
02652 <span class="comment"></span>
02653 <span class="comment">    CscPath - supplies the Nt path with no trailing backslash to the csc directory.</span>
02654 <span class="comment"></span>
02655 <span class="comment">Return Value:</span>
02656 <span class="comment"></span>
02657 <span class="comment">    Status of the operation.</span>
02658 <span class="comment"></span>
02659 <span class="comment">--*/</span>
02660 
02661 {
02662     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02663     UNICODE_STRING root;
02664     HSHADOW rootHandle;
02665 
02666     PUCHAR nameBuffer;
02667     ULONG nameBufferLength;
02668     ULONG length;
02669     HANDLE handle;
02670     UNICODE_STRING string;
02671     OBJECT_ATTRIBUTES objectAttributes;
02672     PKEY_VALUE_PARTIAL_INFORMATION keyValue;
02673 
02674     KdPrint(( <span class="stringliteral">"IopResetCsc Start\n"</span> ));
02675 
02676 <span class="preprocessor">#if 0</span>
02677 <span class="preprocessor"></span>   <span class="comment">//  We don't think we want to re-initialize the database since this will</span>
02678     <span class="comment">//  delete the information for user pinned files. If this functionality</span>
02679     <span class="comment">//  is required then CSC probably needs to implement it for all CSC machines.</span>
02680 
02681     IO_STATUS_BLOCK ioStatusBlock;
02682     SHADOWINFO shadowInfo;
02683     WIN32_FIND_DATAA   sFind32;
02684 
02685     memset(&amp;shadowInfo, 0, <span class="keyword">sizeof</span>(SHADOWINFO));
02686     memset(&amp;sFind32, 0, <span class="keyword">sizeof</span>(sFind32));
02687     sFind32.nFileSizeHigh = 0;
02688     sFind32.nFileSizeLow = 0xccab348;
02689     sFind32.dwReserved1 = 0x8000;
02690 
02691     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(CscPath) &lt; MAX_PATH);
02692     strcpy(sFind32.cFileName, CscPath);
02693 
02694     shadowInfo.uOp = 9; <span class="comment">// SHADOW_REINIT_DATABASE;</span>
02695     shadowInfo.lpFind32 = (WIN32_FIND_DATAW *)&amp;sFind32;
02696 
02697     status = ZwDeviceIoControlFile(
02698                 RdrHandle,
02699                 NULL,
02700                 NULL,
02701                 NULL,
02702                 &amp;ioStatusBlock,
02703                 IOCTL_DO_SHADOW_MAINTENANCE,
02704                 &amp;shadowInfo,
02705                 0,
02706                 NULL,
02707                 0
02708                 );
02709 
02710     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
02711         status = ioStatusBlock.Status;
02712     }
02713 
02714     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
02715         <span class="keywordflow">return</span> status;
02716     }
02717 
02718 <span class="preprocessor">#endif</span>
02719 <span class="preprocessor"></span>
02720     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control"</span> );
02721     InitializeObjectAttributes(
02722         &amp;objectAttributes,
02723         &amp;string,
02724         OBJ_CASE_INSENSITIVE,
02725         NULL,
02726         NULL
02727         );
02728 
02729     status = ZwOpenKey( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
02730     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
02731         KdPrint(( <span class="stringliteral">"IopResetCsc: Unable to open Control key: %x\n"</span>, status ));
02732         <span class="keywordflow">return</span> status;
02733     }
02734 
02735     <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d6/netboot_8c.html#a3">ExpInTextModeSetup</a> ) {
02736         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"RemoteBootRoot"</span> );
02737     } <span class="keywordflow">else</span> {
02738         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"RemoteBootMachineDirectory"</span> );
02739     }
02740 
02741     nameBufferLength = FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + (128 * <span class="keyword">sizeof</span>(WCHAR));
02742     nameBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool, nameBufferLength, 'bRoI');
02743     <span class="keywordflow">if</span> (nameBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02744         KdPrint(( <span class="stringliteral">"IopResetCsc: Unable to allocate nameBuffer\n"</span>));
02745         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02746     }
02747 
02748     keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)nameBuffer;
02749     RtlZeroMemory(nameBuffer, nameBufferLength);
02750 
02751     status = ZwQueryValueKey(
02752                  handle,
02753                  &amp;string,
02754                  KeyValuePartialInformation,
02755                  keyValue,
02756                  nameBufferLength,
02757                  &amp;length);
02758 
02759     ZwClose(handle);
02760 
02761     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
02762         KdPrint(( <span class="stringliteral">"IopResetCsc: Unable to read RemoteBootRoot value: %x\n"</span>, status ));
02763         KdPrint(( <span class="stringliteral">"IopResetCsc: returning: %x\n"</span>, status ));
02764         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(nameBuffer);
02765         <span class="keywordflow">return</span> status;
02766     }
02767     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;root, (PWSTR)keyValue-&gt;Data);
02768     status = IopMarkRoot( &amp;root, &amp;rootHandle );
02769     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02770         status = IopWalkDirectoryTree( &amp;root, rootHandle );
02771     }
02772 
02773     KdPrint(( <span class="stringliteral">"IopResetCsc: returning: %x\n"</span>, status ));
02774 
02775     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(nameBuffer);
02776     <span class="keywordflow">return</span> status;
02777 }
02778 
02779 PWSTR
02780 IopBreakPath(
02781     IN PWSTR* Path
02782     )
02783 
02784 <span class="comment">/*++</span>
02785 <span class="comment"></span>
02786 <span class="comment">Routine Description:</span>
02787 <span class="comment"></span>
02788 <span class="comment">    Break Path by skipping any leading backslashes, skip over filename and then</span>
02789 <span class="comment">    null out the nextbackslash or null.</span>
02790 <span class="comment"></span>
02791 <span class="comment">    NOTE the Path must not end in a backslash.</span>
02792 <span class="comment"></span>
02793 <span class="comment"></span>
02794 <span class="comment">Arguments:</span>
02795 <span class="comment"></span>
02796 <span class="comment">    Path - Supplies the start of the next token. On return supplies the terminator</span>
02797 <span class="comment">    of the current token or NULL if we return the last element in the Path.</span>
02798 <span class="comment"></span>
02799 <span class="comment">Return Value:</span>
02800 <span class="comment"></span>
02801 <span class="comment">    Start of the current token skipping any leading backslashes.</span>
02802 <span class="comment"></span>
02803 <span class="comment">--*/</span>
02804 {
02805     PWSTR start = *Path;
02806 
02807     <span class="comment">//  skip leading backslashes</span>
02808     <span class="keywordflow">while</span> (*start == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
02809         start++;
02810     }
02811 
02812     <span class="comment">//  Scan along token to find the terminator.</span>
02813 
02814     *Path = start;
02815     <span class="keywordflow">while</span> ((**Path != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) &amp;&amp; (**Path) ) {
02816         (*Path)++;
02817     }
02818 
02819     <span class="keywordflow">if</span> (**Path) {
02820         <span class="comment">//  Found backslash, NULL terminate token</span>
02821         **Path = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
02822     } <span class="keywordflow">else</span> {
02823         *Path = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">//  Flag end of token string.</span>
02824     }
02825 
02826     <span class="keywordflow">return</span> start;
02827 }
02828 
02829 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02830 IopMarkRoot(
02831     IN PUNICODE_STRING Root,
02832     OUT PHSHADOW RootHandle
02833     )
02834 
02835 <span class="comment">/*++</span>
02836 <span class="comment"></span>
02837 <span class="comment">Routine Description:</span>
02838 <span class="comment"></span>
02839 <span class="comment">    Tells CSC to pin all files created beneath the Root.</span>
02840 <span class="comment"></span>
02841 <span class="comment">    RootHandle - Supplies where to put the CSC handle corresponding to Root.</span>
02842 <span class="comment"></span>
02843 <span class="comment">Arguments:</span>
02844 <span class="comment"></span>
02845 <span class="comment">    Root - Supplies the NT fully qualified name to the root. e.g.:</span>
02846 <span class="comment">            L"\Device\LanmanRedirector\colinw3\remoteboot\images\cwcompaq"</span>
02847 <span class="comment"></span>
02848 <span class="comment">Return Value:</span>
02849 <span class="comment"></span>
02850 <span class="comment">    NTSTATUS - status of the operation.</span>
02851 <span class="comment"></span>
02852 <span class="comment">--*/</span>
02853 
02854 {
02855 
02856     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02857     PWSTR  current, next;
02858     HSHADOW hDir=0;
02859     HSHADOW hShadow;
02860     BOOLEAN first = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02861     BOOLEAN done;
02862 
02863     PWIN32_FIND_DATAW sFind32;
02864     SHADOWINFO sSI;
02865 
02866     sFind32 = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool, <span class="keyword">sizeof</span>(WIN32_FIND_DATAW), 'bRoI');
02867     <span class="keywordflow">if</span> (sFind32 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02868         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02869     }
02870 
02871     <span class="comment">//  Walk the CSC datastructures down to the Root directory</span>
02872 
02873 
02874     <span class="keywordflow">if</span> (Root-&gt;Length &gt;= (<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> * <span class="keyword">sizeof</span>(WCHAR))) {
02875         <span class="comment">//  Simplifies some checking filling in FIND32 structures later.</span>
02876         KdPrint((<span class="stringliteral">"IopMarkRoot: %ws is invalid\n"</span>, Root-&gt;Buffer));
02877         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02878         <span class="keywordflow">goto</span> cleanup;
02879     }
02880 
02881     <span class="comment">//</span>
02882     <span class="comment">//  Process the server component of the name. This is automatically in the</span>
02883     <span class="comment">//  database, magically created by CSC.</span>
02884     <span class="comment">//</span>
02885 
02886     next = Root-&gt;Buffer + (<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Device\\LanmanRedirector"</span>)/<span class="keyword">sizeof</span>(WCHAR));;
02887     current = IopBreakPath(&amp;next);
02888 
02889     RtlZeroMemory(sFind32, <span class="keyword">sizeof</span>(WIN32_FIND_DATAW));
02890     sFind32-&gt;dwFileAttributes = FILE_ATTRIBUTE_DIRECTORY;
02891     <span class="comment">//  Build \\Server\Share</span>
02892     wcscpy(sFind32-&gt;cFileName, L<span class="stringliteral">"\\\\"</span>);
02893     wcscat(sFind32-&gt;cFileName, current);
02894 
02895     <span class="comment">//  Restore separator that IopBreakPath removed</span>
02896     <span class="keywordflow">if</span> (next) {
02897         *next = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
02898     } <span class="keywordflow">else</span> {
02899         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02900         <span class="keywordflow">goto</span> cleanup;
02901     }
02902     current = IopBreakPath(&amp;next);
02903 
02904     wcscat(sFind32-&gt;cFileName, L<span class="stringliteral">"\\"</span>);
02905     wcscat(sFind32-&gt;cFileName, current);
02906 
02907     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IopGetShadowExW(hDir, sFind32, &amp;sSI);
02908     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02909         KdPrint((<span class="stringliteral">"IopMarkRoot: IopGetShadowExW (%ws) failed %lx\n"</span>, sFind32-&gt;cFileName, Status));
02910         <span class="keywordflow">goto</span> cleanup;
02911     }
02912 
02913     <span class="keywordflow">if</span> (!sSI.hShadow) {
02914         <span class="comment">//</span>
02915         <span class="comment">//  Directory is not already known to CSC. Make it so.</span>
02916         <span class="comment">//</span>
02917         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IopCreateShadowW( hDir, sFind32, SHADOW_SPARSE, &amp;hShadow );
02918 
02919         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02920             KdPrint((<span class="stringliteral">"IopMarkRoot: IopCreateShadowW (%ws) failed %lx\n"</span>, sFind32-&gt;cFileName, Status));
02921             <span class="keywordflow">goto</span> cleanup;
02922         }
02923     } <span class="keywordflow">else</span> {
02924         hShadow = sSI.hShadow;
02925     }
02926 
02927     <span class="comment">//  Pinning the share means that the files are available without a LAN connection.</span>
02928     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IopAddHintFromInode(
02929                 hDir,
02930                 hShadow,
02931                 &amp;sSI.ulHintPri,
02932                 &amp;sSI.ulHintFlags,
02933                 FLAG_CSC_HINT_PIN_SYSTEM);
02934 
02935 <span class="preprocessor">#if DBG</span>
02936 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_PENDING) {
02937         <span class="keywordflow">if</span> (DebugReset) KdPrint(( <span class="stringliteral">"IopAddHintFromInode: modified hint flags for %ws\n"</span>, next ));
02938     }
02939 <span class="preprocessor">#endif</span>
02940 <span class="preprocessor"></span>
02941     <span class="comment">//  Restore separator that IopBreakPath removed</span>
02942     <span class="keywordflow">if</span> (next) {
02943         *next = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
02944     } <span class="keywordflow">else</span> {
02945         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02946         <span class="keywordflow">goto</span> cleanup;
02947     }
02948 
02949     <span class="keywordflow">do</span> {
02950         current = IopBreakPath(&amp;next);
02951 
02952         RtlZeroMemory(sFind32, <span class="keyword">sizeof</span>(WIN32_FIND_DATAW));
02953         sFind32-&gt;dwFileAttributes = FILE_ATTRIBUTE_DIRECTORY;
02954         wcscpy(sFind32-&gt;cFileName, current);
02955 
02956         hDir = hShadow;
02957 
02958         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IopGetShadowExW(hDir, sFind32, &amp;sSI);
02959         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02960             KdPrint((<span class="stringliteral">"IopMarkRoot: IopGetShadowExW (%ws) failed %lx\n"</span>, sFind32-&gt;cFileName, Status));
02961             <span class="keywordflow">goto</span> cleanup;
02962         }
02963 
02964 
02965         <span class="keywordflow">if</span> (!sSI.hShadow) {
02966             <span class="comment">//</span>
02967             <span class="comment">//  Directory is not already known to CSC. Make it so.</span>
02968             <span class="comment">//</span>
02969             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IopCreateShadowW( hDir, sFind32, SHADOW_SPARSE, &amp;hShadow );
02970 
02971             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02972                 KdPrint((<span class="stringliteral">"IopMarkRoot: IopCreateShadowW (%ws) failed %lx\n"</span>, sFind32-&gt;cFileName, Status));
02973                 <span class="keywordflow">goto</span> cleanup;
02974             }
02975 
02976         } <span class="keywordflow">else</span> {
02977             hShadow = sSI.hShadow;
02978         }
02979 
02980         <span class="keywordflow">if</span> (next) {
02981 
02982             <span class="comment">//  Pinning the share means that the files are available without a LAN connection.</span>
02983             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IopAddHintFromInode(
02984                         hDir,
02985                         hShadow,
02986                         &amp;sSI.ulHintPri,
02987                         &amp;sSI.ulHintFlags,
02988                         FLAG_CSC_HINT_PIN_SYSTEM);
02989 
02990 <span class="preprocessor">#if DBG</span>
02991 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_PENDING) {
02992                 <span class="keywordflow">if</span> (DebugReset) KdPrint(( <span class="stringliteral">"IopAddHintFromInode: modified hint flags for %ws\n"</span>, next ));
02993             }
02994 <span class="preprocessor">#endif</span>
02995 <span class="preprocessor"></span>
02996             <span class="comment">//  Restore separator that IopBreakPath removed</span>
02997             *next = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
02998 
02999         } <span class="keywordflow">else</span> {
03000 
03001             <span class="comment">//</span>
03002             <span class="comment">//  WE HAVE FOUND THE ROOT. MARK IT</span>
03003             <span class="comment">//</span>
03004             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IopAddHintFromInode(
03005                         hDir,
03006                         hShadow,
03007                         &amp;sSI.ulHintPri,
03008                         &amp;sSI.ulHintFlags,
03009                         (FLAG_CSC_HINT_PIN_SYSTEM | FLAG_CSC_HINT_PIN_INHERIT_SYSTEM));
03010 
03011 <span class="preprocessor">#if DBG</span>
03012 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_PENDING) {
03013                 <span class="keywordflow">if</span> (DebugReset) KdPrint(( <span class="stringliteral">"IopAddHintFromInode: modified hint flags for %ws\n"</span>, next ));
03014             }
03015 <span class="preprocessor">#endif</span>
03016 <span class="preprocessor"></span>
03017             *RootHandle = hShadow;
03018 
03019             <span class="keywordflow">break</span>;
03020         }
03021 
03022     } <span class="keywordflow">while</span> ( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03023 
03024 cleanup:
03025 
03026     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(sFind32);
03027 
03028     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03029 }
03030 
03031 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03032 IopSetFlushCSC(
03033     IN CSC_CONTROL Command
03034     )
03035 <span class="comment">/*++</span>
03036 <span class="comment"></span>
03037 <span class="comment">Routine Description:</span>
03038 <span class="comment"></span>
03039 <span class="comment">    Accesses the registry key that controls when to walk the server directory,</span>
03040 <span class="comment">    discard all local copies of files and repin.</span>
03041 <span class="comment"></span>
03042 <span class="comment">Arguments:</span>
03043 <span class="comment"></span>
03044 <span class="comment">    Command - Supplies the intentions of the caller.</span>
03045 <span class="comment"></span>
03046 <span class="comment">Return Value:</span>
03047 <span class="comment"></span>
03048 <span class="comment">    TRUE if repin is required.</span>
03049 <span class="comment"></span>
03050 <span class="comment">--*/</span>
03051 
03052 {
03053 
03054     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03055     HANDLE handle;
03056     OBJECT_ATTRIBUTES objectAttributes;
03057     UNICODE_STRING string;
03058     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dword = Command;
03059 
03060     PKEY_VALUE_PARTIAL_INFORMATION keyValue;
03061     UCHAR buffer[FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)];
03062     ULONG length;
03063 
03064     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control"</span> );
03065 
03066     InitializeObjectAttributes(
03067         &amp;objectAttributes,
03068         &amp;string,
03069         OBJ_CASE_INSENSITIVE,
03070         NULL,
03071         NULL
03072         );
03073 
03074     status = ZwOpenKey( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
03075     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
03076         <span class="keywordflow">return</span>;
03077     }
03078 
03079     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"ControlCSC"</span> );
03080 
03081     <span class="keywordflow">if</span> (Command == READ_CSC) {
03082 
03083         keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)buffer;
03084         status = ZwQueryValueKey(
03085                      handle,
03086                      &amp;string,
03087                      KeyValuePartialInformation,
03088                      keyValue,
03089                      <span class="keyword">sizeof</span>(buffer),
03090                      &amp;length);
03091 
03092         dword = *((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(&amp;keyValue-&gt;Data[0]));
03093 
03094         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (dword == SET_FLUSH_CSC)) {
03095             StartCsc = FLUSH_CSC;
03096         }
03097 
03098     } <span class="keywordflow">else</span> {
03099         status = ZwSetValueKey(
03100                     handle,
03101                     &amp;string,
03102                     0,
03103                     REG_DWORD,
03104                     &amp;dword,
03105                     <span class="keyword">sizeof</span>(DWORD)
03106                     );
03107         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
03108             KdPrint(( <span class="stringliteral">"IopSetFlushCSC: Unable to set ControlCSC value: %x\n"</span>, status ));
03109         }
03110     }
03111 
03112     ZwClose( handle );
03113 
03114     <span class="keywordflow">return</span>;
03115 }
03116 
03117 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03118 IopWalkDirectoryHelper(
03119     IN PUNICODE_STRING Directory,
03120     IN HSHADOW CSCHandle,
03121     IN PUCHAR Buffer,
03122     IN ULONG BufferSize
03123     )
03124 
03125 <span class="comment">/*++</span>
03126 <span class="comment"></span>
03127 <span class="comment">Routine Description:</span>
03128 <span class="comment"></span>
03129 <span class="comment">    This is a helper function for IopWalkDirectoryTree. Each file found is</span>
03130 <span class="comment">    pinned. Each directory is added to the list for later processing.</span>
03131 <span class="comment"></span>
03132 <span class="comment">Arguments:</span>
03133 <span class="comment"></span>
03134 <span class="comment">    Directory - Supplies the NT Path to the directory to walk.</span>
03135 <span class="comment"></span>
03136 <span class="comment">    CSCHandle - Supplies the handle passed to CSC that describes</span>
03137 <span class="comment">                the Directory when pinning individual files.</span>
03138 <span class="comment"></span>
03139 <span class="comment">    Buffer    - A scratch buffer to use.</span>
03140 <span class="comment"></span>
03141 <span class="comment">    BufferSize - The length of Buffer.</span>
03142 <span class="comment"></span>
03143 <span class="comment">Return Value:</span>
03144 <span class="comment"></span>
03145 <span class="comment">    NTSTATUS - status of the operation.</span>
03146 <span class="comment"></span>
03147 <span class="comment">--*/</span>
03148 
03149 {
03150 
03151     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03152 
03153     HANDLE FileHandle;
03154     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
03155     IO_STATUS_BLOCK IoStatus;
03156     PUCHAR CopyAclBuffer;
03157 
03158     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NtStatus;
03159 
03160     PFILE_BOTH_DIR_INFORMATION FileInfo;
03161     ULONG i;
03162     PWIN32_FIND_DATAW sFind32;
03163 
03164     PWCHAR SkipNames[] = {<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"."</span>,
03165                             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">".."</span>,
03166                             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"pagefile.sys"</span>,
03167                             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"csc"</span>,
03168                             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"RECYCLER"</span>,
03169                             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"TEMP"</span>,
03170                             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"TMP"</span>,
03171                             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>};
03172     BOOLEAN skip;
03173 
03174 
03175     sFind32 = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool, <span class="keyword">sizeof</span>(WIN32_FIND_DATAW), 'bRoI');
03176     <span class="keywordflow">if</span> (sFind32 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03177         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03178     }
03179 
03180     CopyAclBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool, 512, 'bRoI');
03181     <span class="keywordflow">if</span> (CopyAclBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03182         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(sFind32);
03183         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03184     }
03185 
03186     <span class="comment">//</span>
03187     <span class="comment">//  Open the file for list directory access</span>
03188     <span class="comment">//</span>
03189 
03190     InitializeObjectAttributes(
03191         &amp;ObjectAttributes,
03192         Directory,
03193         OBJ_CASE_INSENSITIVE,
03194         NULL,
03195         NULL
03196         );
03197 
03198     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>( &amp;FileHandle,
03199                                FILE_LIST_DIRECTORY | SYNCHRONIZE,
03200                                &amp;ObjectAttributes,
03201                                &amp;IoStatus,
03202                                FILE_SHARE_READ,
03203                                FILE_DIRECTORY_FILE ))) {
03204         <span class="keywordflow">goto</span> cleanup;
03205     }
03206 
03207     <span class="comment">//</span>
03208     <span class="comment">//  Do the directory loop</span>
03209     <span class="comment">//</span>
03210 
03211     <span class="keywordflow">for</span> (NtStatus = ZwQueryDirectoryFile( FileHandle,
03212                                           (HANDLE)NULL,
03213                                           (PIO_APC_ROUTINE)NULL,
03214                                           (PVOID)NULL,
03215                                           &amp;IoStatus,
03216                                           Buffer,
03217                                           BufferSize,
03218                                           FileBothDirectoryInformation,
03219                                           FALSE,
03220                                           (PUNICODE_STRING)NULL,
03221                                           TRUE);
03222          <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus);
03223          NtStatus = ZwQueryDirectoryFile( FileHandle,
03224                                           (HANDLE)NULL,
03225                                           (PIO_APC_ROUTINE)NULL,
03226                                           (PVOID)NULL,
03227                                           &amp;IoStatus,
03228                                           Buffer,
03229                                           BufferSize,
03230                                           FileBothDirectoryInformation,
03231                                           FALSE,
03232                                           (PUNICODE_STRING)NULL,
03233                                           FALSE) ) {
03234 
03235         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status = ZwWaitForSingleObject(FileHandle, TRUE, NULL))) {
03236             <span class="keywordflow">goto</span> cleanup;
03237         }
03238 
03239         <span class="comment">//</span>
03240         <span class="comment">//  Check the Irp for success</span>
03241         <span class="comment">//</span>
03242 
03243         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus.Status)) {
03244             <span class="keywordflow">break</span>;
03245         }
03246 
03247         <span class="comment">//</span>
03248         <span class="comment">//  For every record in the buffer type out the directory information</span>
03249         <span class="comment">//</span>
03250 
03251         <span class="comment">//</span>
03252         <span class="comment">//  Point to the first record in the buffer, we are guaranteed to have</span>
03253         <span class="comment">//  one otherwise IoStatus would have been No More Files</span>
03254         <span class="comment">//</span>
03255 
03256         FileInfo = (PFILE_BOTH_DIR_INFORMATION)&amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0];
03257 
03258         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03259 
03260             {
03261                 WCHAR Saved;
03262                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
03263 
03264                 Saved = FileInfo-&gt;FileName[FileInfo-&gt;FileNameLength/2];
03265                 FileInfo-&gt;FileName[FileInfo-&gt;FileNameLength/2] = 0;
03266 
03267                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
03268                 skip = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03269                 <span class="keywordflow">while</span> (SkipNames[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>][0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) {
03270                     <span class="keywordflow">if</span> (_wcsicmp( FileInfo-&gt;FileName,SkipNames[Index])) {
03271                         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++;
03272                     } <span class="keywordflow">else</span> {
03273                         skip = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03274                         <span class="keywordflow">break</span>;
03275                     }
03276                 }
03277 
03278                 <span class="keywordflow">if</span> (!skip) {
03279                     UNICODE_STRING Entry;
03280                     SHADOWINFO sSI;
03281                     PDIRENT pDE;
03282 
03283                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Entry,NULL);
03284 
03285                     <span class="keywordflow">if</span> (FileInfo-&gt;FileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY) {
03286                         <span class="comment">//</span>
03287                         <span class="comment">//  Allocate an entry in the directory list. We will process</span>
03288                         <span class="comment">//  the directory at a later time.</span>
03289                         <span class="comment">//</span>
03290                         UNICODE_STRING DirName;
03291                         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NewNameLength;
03292 
03293                         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;DirName, FileInfo-&gt;FileName);
03294 
03295                         NewNameLength =
03296                             (<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;Length + DirName.Length + 1) * <span class="keyword">sizeof</span>(WCHAR);
03297 
03298                         pDE = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool, <span class="keyword">sizeof</span>(DIRENT) + NewNameLength, 'bRoI');
03299 
03300                         <span class="keywordflow">if</span> (pDE == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03301                             KdPrint((<span class="stringliteral">"Couldn't allocate space for directory\n"</span>));
03302                             KdPrint((<span class="stringliteral">"\\%ws\\%ws\n"</span>, <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;Buffer, FileInfo-&gt;FileName));
03303                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
03304                             <span class="keywordflow">goto</span> cleanup;
03305                         }
03306 
03307                         InsertHeadList( &amp;DirectoryList , &amp;pDE-&gt;Next );
03308                         pDE-&gt;Directory.Length=0;
03309                         pDE-&gt;Directory.MaximumLength=NewNameLength;
03310                         pDE-&gt;Directory.Buffer = &amp;pDE-&gt;Name[0];
03311                         <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;pDE-&gt;Directory, Directory);
03312                         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;pDE-&gt;Directory, L<span class="stringliteral">"\\"</span>);
03313                         pDE-&gt;LastToken = pDE-&gt;Directory.Buffer + (pDE-&gt;Directory.Length/<span class="keyword">sizeof</span>(WCHAR));
03314                         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;pDE-&gt;Directory, &amp;DirName);
03315                     }
03316 
03317                     RtlZeroMemory(sFind32, <span class="keyword">sizeof</span>(WIN32_FIND_DATAW));
03318                     wcscpy(sFind32-&gt;cFileName, FileInfo-&gt;FileName);
03319 
03320                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IopGetShadowExW(CSCHandle, sFind32, &amp;sSI);
03321                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03322                         KdPrint(( <span class="stringliteral">"IopGetShadowExW: returned: %x for %wZ\\%ws\n"</span>, Status, Directory, FileInfo-&gt;FileName ));
03323                         <span class="keywordflow">goto</span> cleanup;
03324                     }
03325 
03326                     <span class="keywordflow">if</span> (!sSI.hShadow) {
03327                         <span class="comment">//  Need to create CSC database entry.</span>
03328                         sFind32-&gt;dwFileAttributes = FileInfo-&gt;FileAttributes;
03329                         sFind32-&gt;ftCreationTime = *(LPFILETIME)&amp;FileInfo-&gt;CreationTime;
03330                         sFind32-&gt;ftLastAccessTime = *(LPFILETIME)&amp;FileInfo-&gt;LastAccessTime;
03331                         sFind32-&gt;ftLastWriteTime = *(LPFILETIME)&amp;FileInfo-&gt;LastWriteTime;
03332                         sFind32-&gt;nFileSizeLow = FileInfo-&gt;EndOfFile.LowPart;
03333                         sFind32-&gt;nFileSizeHigh = FileInfo-&gt;EndOfFile.HighPart;
03334                         memcpy(
03335                             sFind32-&gt;cAlternateFileName,
03336                             FileInfo-&gt;ShortName,
03337                             FileInfo-&gt;ShortNameLength );
03338                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IopCreateShadowW( CSCHandle, sFind32, SHADOW_SPARSE, &amp;sSI.hShadow);
03339 
03340                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03341                             KdPrint(( <span class="stringliteral">"IopCreateShadowW: returned: %x for %wZ\\%ws\n"</span>, Status, Directory, FileInfo-&gt;FileName ));
03342                             <span class="keywordflow">goto</span> cleanup;
03343                         }
03344                         <span class="comment">// Copy the ACL from the server.</span>
03345                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IopCopyServerAcl(
03346                                      FileHandle,         <span class="comment">// parent directory</span>
03347                                      FileInfo-&gt;FileName, <span class="comment">// this directory</span>
03348                                      sSI.hShadow,        <span class="comment">// shadow handle</span>
03349                                      TRUE,               <span class="comment">// it is a directory</span>
03350                                      CopyAclBuffer,      <span class="comment">// scratch buffer</span>
03351                                      512);               <span class="comment">// buffer size</span>
03352 <span class="preprocessor">#if 0</span>
03353 <span class="preprocessor"></span>                        <span class="comment">//</span>
03354                         <span class="comment">// We may get ACCESS_DENIED errors from dirs that</span>
03355                         <span class="comment">// have been created on the server by hand, so don't</span>
03356                         <span class="comment">// treat this as fatal.</span>
03357                         <span class="comment">//</span>
03358                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03359                             <span class="keywordflow">goto</span> cleanup;
03360                         }
03361 <span class="preprocessor">#endif</span>
03362 <span class="preprocessor"></span>                    }
03363                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CSCHandle == sSI.hDir);
03364 
03365                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IopAddHintFromInode(
03366                                 sSI.hDir,
03367                                 sSI.hShadow,
03368                                 &amp;sSI.ulHintPri,
03369                                 &amp;sSI.ulHintFlags,
03370                                 (FLAG_CSC_HINT_PIN_SYSTEM | FLAG_CSC_HINT_PIN_INHERIT_SYSTEM));
03371 
03372 <span class="preprocessor">#if DBG</span>
03373 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_PENDING) {
03374                         <span class="keywordflow">if</span> (DebugReset) KdPrint(( <span class="stringliteral">"IopAddHintFromInode: modified hint flags for %wZ\\%ws\n"</span>, Directory, FileInfo-&gt;FileName ));
03375                     }
03376 <span class="preprocessor">#endif</span>
03377 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03378                         KdPrint(( <span class="stringliteral">"IopAddHintFromInode: returned: %x for %wZ\\%ws\n"</span>, Status, Directory, FileInfo-&gt;FileName ));
03379                         <span class="keywordflow">goto</span> cleanup;
03380                     }
03381 
03382                     <span class="keywordflow">if</span> (FileInfo-&gt;FileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY) {
03383                         pDE-&gt;CSCHandle = sSI.hShadow;
03384                     } <span class="keywordflow">else</span> {
03385                         <span class="keywordflow">if</span> ((sSI.uStatus &amp; SHADOW_SPARSE) == 0) {
03386                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IopSetShadowInfoW(
03387                                         sSI.hDir,
03388                                         sSI.hShadow,
03389                                         SHADOW_SPARSE,
03390                                         SHADOW_FLAGS_ASSIGN | SHADOW_FLAGS_TRUNCATE_DATA);
03391 <span class="preprocessor">#if DBG</span>
03392 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> (DebugReset) KdPrint(( <span class="stringliteral">"IopSetShadowInfoW: truncated %wZ\\%ws\n"</span>, Directory, FileInfo-&gt;FileName ));
03393 <span class="preprocessor">#endif</span>
03394 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03395                                 KdPrint(( <span class="stringliteral">"IopSetShadowInfoW: returned: %x for %wZ\\%ws\n"</span>, Status, Directory, FileInfo-&gt;FileName ));
03396                                 <span class="keywordflow">goto</span> cleanup;
03397                             }
03398                         }
03399                     }
03400                 }
03401 
03402                 FileInfo-&gt;FileName[FileInfo-&gt;FileNameLength/2] = Saved;
03403             }
03404 
03405 
03406             <span class="comment">//</span>
03407             <span class="comment">//  Check if there is another record, if there isn't then we</span>
03408             <span class="comment">//  simply get out of this loop</span>
03409             <span class="comment">//</span>
03410 
03411             <span class="keywordflow">if</span> (FileInfo-&gt;NextEntryOffset == 0) {
03412                 <span class="keywordflow">break</span>;
03413             }
03414 
03415             <span class="comment">//</span>
03416             <span class="comment">//  There is another record so advance FileInfo to the next</span>
03417             <span class="comment">//  record</span>
03418             <span class="comment">//</span>
03419 
03420 
03421             FileInfo = (PFILE_BOTH_DIR_INFORMATION)(((PUCHAR)FileInfo) + FileInfo-&gt;NextEntryOffset);
03422 
03423         }
03424     }
03425 
03426     ZwClose( FileHandle );
03427 
03428     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03429 
03430 cleanup:
03431 
03432     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(sFind32);
03433     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CopyAclBuffer);
03434 
03435     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03436 
03437 } <span class="comment">// IopWalkDirectoryHelper</span>
03438 
03439 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03440 IopWalkDirectoryTree(
03441     IN PUNICODE_STRING Directory,
03442     IN HSHADOW CSCHandle
03443     )
03444 
03445 <span class="comment">/*++</span>
03446 <span class="comment"></span>
03447 <span class="comment">Routine Description:</span>
03448 <span class="comment"></span>
03449 <span class="comment">Arguments:</span>
03450 <span class="comment"></span>
03451 <span class="comment">    Directory - Supplies the NT Path to the directory to walk.</span>
03452 <span class="comment"></span>
03453 <span class="comment">    CSCHandle - Supplies the handle passed to CSC that describes</span>
03454 <span class="comment">                the Directory when pinning individual files.</span>
03455 <span class="comment"></span>
03456 <span class="comment">Return Value:</span>
03457 <span class="comment"></span>
03458 <span class="comment">    NTSTATUS - status of the operation.</span>
03459 <span class="comment"></span>
03460 <span class="comment">--*/</span>
03461 
03462 {
03463 
03464     PDIRENT Next;
03465     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03466 
03467 <span class="preprocessor">    #define BUFFERSIZE 1024</span>
03468 <span class="preprocessor"></span>    PUCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
03469 
03470 
03471     <span class="comment">// Make 2 bytes larger so that when we null terminate filename we can't run off the end.</span>
03472     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool, BUFFERSIZE+2, 'bRoI');
03473 
03474     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03475         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03476     }
03477 
03478     InitializeListHead(&amp;DirectoryList);
03479 
03480     status = IopWalkDirectoryHelper(Directory, CSCHandle, Buffer, BUFFERSIZE); <span class="comment">// Process first level</span>
03481 
03482     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03483         <span class="keywordflow">while</span> (!IsListEmpty(&amp;DirectoryList)) {
03484             Next = (PDIRENT)RemoveHeadList(&amp;DirectoryList);
03485             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Next);
03486         }
03487         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Buffer);
03488         <span class="keywordflow">return</span> status;
03489     }
03490 
03491     <span class="comment">//</span>
03492     <span class="comment">//  Each directory that WalkDirectory finds gets added to the list.</span>
03493     <span class="comment">//  process the list until we have no more directories.</span>
03494     <span class="comment">//</span>
03495 
03496     <span class="keywordflow">while</span> (!IsListEmpty(&amp;DirectoryList)) {
03497 
03498         Next = (PDIRENT)RemoveHeadList(&amp;DirectoryList);
03499 
03500         status = IopWalkDirectoryHelper(&amp;Next-&gt;Directory, Next-&gt;CSCHandle, Buffer, BUFFERSIZE);
03501 
03502         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Next);
03503 
03504         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03505             <span class="keywordflow">while</span> (!IsListEmpty(&amp;DirectoryList)) {
03506                 Next = (PDIRENT)RemoveHeadList(&amp;DirectoryList);
03507                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Next);
03508             }
03509             <span class="comment">//  We will try to repin next reboot</span>
03510             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Buffer);
03511             <span class="keywordflow">return</span> status;
03512         }
03513     }
03514 
03515     IopSetFlushCSC(SET_FLUSHED_CSC);
03516     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Buffer);
03517     <span class="keywordflow">return</span> status;
03518 
03519 } <span class="comment">// IopWalkDirectoryTree</span>
03520 
03521 <span class="comment">/*****************************************************************************</span>
03522 <span class="comment"> *      Given an hDir and filename, get SHADOWINFO if it exists</span>
03523 <span class="comment"> */</span>
03524 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03525 IopGetShadowExW(
03526     HSHADOW hDir,
03527     LPWIN32_FIND_DATAW lpFind32,
03528     LPSHADOWINFO lpSI
03529     )
03530 {
03531     IO_STATUS_BLOCK Iosb;
03532     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03533 
03534     RtlZeroMemory((PUCHAR)lpSI, <span class="keyword">sizeof</span>(SHADOWINFO));
03535     lpSI-&gt;hDir = hDir;
03536     lpSI-&gt;lpFind32 = lpFind32;
03537 
03538     status = ZwDeviceIoControlFile(
03539                 RdrHandle,
03540                 NULL,
03541                 NULL,               <span class="comment">// APC routine</span>
03542                 NULL,               <span class="comment">// APC Context</span>
03543                 &amp;Iosb,
03544                 IOCTL_GETSHADOW,    <span class="comment">// IoControlCode</span>
03545                 (LPVOID)(lpSI),     <span class="comment">// Buffer for data to the FS</span>
03546                 0,
03547                 NULL,               <span class="comment">// OutputBuffer for data from the FS</span>
03548                 0                   <span class="comment">// OutputBuffer Length</span>
03549                 );
03550 
03551     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( status != STATUS_PENDING );
03552     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
03553         status = Iosb.Status;
03554     }
03555 
03556     <span class="keywordflow">return</span> status;
03557 }
03558 
03559 <span class="comment">/*****************************************************************************</span>
03560 <span class="comment"> *      Call down to the VxD to add a hint on the inode.</span>
03561 <span class="comment"> *  This ioctl does the right thing for user and system hints</span>
03562 <span class="comment"> *  If successful, there is an additional pincount on the inode entry</span>
03563 <span class="comment"> *  and the flags that are passed in are ORed with the original entry</span>
03564 <span class="comment"> */</span>
03565 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03566 IopAddHintFromInode(
03567     HSHADOW  hDir,
03568     HSHADOW  hShadow,
03569     ULONG    *lpulHintPri,
03570     ULONG    *lpulHintFlags,
03571     ULONG    HintFlagsToSet
03572     )
03573 {
03574 
03575     IO_STATUS_BLOCK Iosb;
03576     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03577     SHADOWINFO      sSI;
03578 
03579     HintFlagsToSet |= FLAG_CSC_HINT_CONSERVE_BANDWIDTH;
03580 
03581     <span class="keywordflow">if</span> ((*lpulHintFlags &amp; HintFlagsToSet) != HintFlagsToSet) {
03582 
03583         RtlZeroMemory(&amp;sSI, <span class="keyword">sizeof</span>(SHADOWINFO));
03584         sSI.hDir = hDir;
03585         sSI.hShadow = hShadow;
03586         sSI.ulHintFlags = *lpulHintFlags | HintFlagsToSet;
03587         sSI.uOp = SHADOW_ADDHINT_FROM_INODE;
03588 
03589         status = ZwDeviceIoControlFile(
03590                     RdrHandle,
03591                     NULL,
03592                     NULL,               <span class="comment">// APC routine</span>
03593                     NULL,               <span class="comment">// APC Context</span>
03594                     &amp;Iosb,
03595                     IOCTL_DO_SHADOW_MAINTENANCE,    <span class="comment">// IoControlCode</span>
03596                     (LPVOID)(&amp;sSI),     <span class="comment">// Buffer for data to the FS</span>
03597                     0,
03598                     NULL,               <span class="comment">// OutputBuffer for data from the FS</span>
03599                     0                   <span class="comment">// OutputBuffer Length</span>
03600                     );
03601 
03602         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( status != STATUS_PENDING );
03603         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
03604             status = Iosb.Status;
03605         }
03606 
03607         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03608             *lpulHintFlags = sSI.ulHintFlags;
03609             *lpulHintPri = sSI.ulHintPri;
03610         }
03611     } <span class="keywordflow">else</span> {
03612         status = STATUS_PENDING;
03613     }
03614 
03615     <span class="keywordflow">return</span> status;
03616 }
03617 
03618 <span class="comment">/*****************************************************************************</span>
03619 <span class="comment"> *  given an hDir and hShadow, set uStatus about the file.</span>
03620 <span class="comment"> *  Operation depends on uOp given.</span>
03621 <span class="comment"> */</span>
03622 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03623 IopSetShadowInfoW(
03624     HSHADOW hDir,
03625     HSHADOW hShadow,
03626     ULONG uStatus,
03627     ULONG uOp
03628     )
03629 {
03630 
03631     IO_STATUS_BLOCK Iosb;
03632     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03633     SHADOWINFO      sSI;
03634 
03635     RtlZeroMemory(&amp;sSI, <span class="keyword">sizeof</span>(SHADOWINFO));
03636     sSI.hDir = hDir;
03637     sSI.hShadow = hShadow;
03638     sSI.uStatus = uStatus;
03639     sSI.uOp = uOp;
03640 
03641     status = ZwDeviceIoControlFile(
03642                 RdrHandle,
03643                 NULL,
03644                 NULL,               <span class="comment">// APC routine</span>
03645                 NULL,               <span class="comment">// APC Context</span>
03646                 &amp;Iosb,
03647                 IOCTL_SHADOW_SET_SHADOW_INFO,    <span class="comment">// IoControlCode</span>
03648                 (LPVOID)(&amp;sSI),     <span class="comment">// Buffer for data to the FS</span>
03649                 0,
03650                 NULL,               <span class="comment">// OutputBuffer for data from the FS</span>
03651                 0                   <span class="comment">// OutputBuffer Length</span>
03652                 );
03653 
03654     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( status != STATUS_PENDING );
03655     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
03656         status = Iosb.Status;
03657     }
03658 
03659     <span class="keywordflow">return</span> status;
03660 }
03661 
03662 <span class="comment">/*****************************************************************************</span>
03663 <span class="comment"> *      Call down to the VxD to add a file to the shadow.</span>
03664 <span class="comment"> *      lphShadow is filled in with the new HSHADOW.</span>
03665 <span class="comment"> *      Set uStatus as necessary (ie: SPARSE or whatever...)</span>
03666 <span class="comment"> */</span>
03667 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03668 IopCreateShadowW(
03669     HSHADOW hDir,
03670     LPWIN32_FIND_DATAW lpFind32,
03671     ULONG uStatus,
03672     PHSHADOW lphShadow
03673     )
03674 {
03675     IO_STATUS_BLOCK Iosb;
03676     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03677     SHADOWINFO sSI;
03678 
03679     RtlZeroMemory(&amp;sSI, <span class="keyword">sizeof</span>(SHADOWINFO));
03680     sSI.hDir = hDir;
03681     sSI.uStatus = uStatus;
03682     sSI.lpFind32 = lpFind32;
03683 
03684 
03685     status = ZwDeviceIoControlFile(
03686                 RdrHandle,
03687                 NULL,
03688                 NULL,               <span class="comment">// APC routine</span>
03689                 NULL,               <span class="comment">// APC Context</span>
03690                 &amp;Iosb,
03691                 IOCTL_SHADOW_CREATE,    <span class="comment">// IoControlCode</span>
03692                 (LPVOID)(&amp;sSI),     <span class="comment">// Buffer for data to the FS</span>
03693                 0,
03694                 NULL,               <span class="comment">// OutputBuffer for data from the FS</span>
03695                 0                   <span class="comment">// OutputBuffer Length</span>
03696                 );
03697 
03698     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( status != STATUS_PENDING );
03699     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
03700         status = Iosb.Status;
03701     }
03702 
03703     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03704         *lphShadow = sSI.hShadow;
03705     }
03706 
03707     <span class="keywordflow">return</span> status;
03708 }
03709 
03710 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03711 IopCopyServerAcl(
03712     HANDLE ParentHandle,
03713     PWCHAR FileName,
03714     HSHADOW ShadowHandle,
03715     BOOLEAN IsDirectory,
03716     PUCHAR Buffer,
03717     ULONG BufferSize
03718     )
03719 
03720 <span class="comment">/*++</span>
03721 <span class="comment"></span>
03722 <span class="comment">Routine Description:</span>
03723 <span class="comment"></span>
03724 <span class="comment">    This routines takes a file/directory on the server and a shadow</span>
03725 <span class="comment">    file handle and copies the security descriptor from the server</span>
03726 <span class="comment">    to the shadow file.</span>
03727 <span class="comment"></span>
03728 <span class="comment">Arguments:</span>
03729 <span class="comment"></span>
03730 <span class="comment">    ParentHandle - The open handle to the parent of the file on the server.</span>
03731 <span class="comment"></span>
03732 <span class="comment">    FileName - The name of the file/directory on the server.</span>
03733 <span class="comment"></span>
03734 <span class="comment">    ShadowHandle - A CSC handle to the shadow file.</span>
03735 <span class="comment"></span>
03736 <span class="comment">    IsDirectory - Does FileName refer to a directory.</span>
03737 <span class="comment"></span>
03738 <span class="comment">    Buffer - A temporary buffer used to query security descriptors.</span>
03739 <span class="comment"></span>
03740 <span class="comment">    BufferSize - The number of bytes of Buffer.</span>
03741 <span class="comment"></span>
03742 <span class="comment">Return Value:</span>
03743 <span class="comment"></span>
03744 <span class="comment">    NTSTATUS - status of the operation.</span>
03745 <span class="comment"></span>
03746 <span class="comment">--*/</span>
03747 
03748 {
03749     PWCHAR ShadowFileName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03750     UNICODE_STRING ShadowFileString;
03751     UNICODE_STRING FileNameString;
03752     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
03753     IO_STATUS_BLOCK IoStatusBlock;
03754     COPYPARAMSW CopyParams;
03755     HANDLE ShadowFileHandle;
03756     HANDLE ServerFileHandle;
03757     ULONG LengthNeeded;
03758     PSECURITY_DESCRIPTOR SecurityDescriptor;
03759     BOOLEAN AllocatedSecurityDescriptor = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03760     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
03761     BOOLEAN DaclPresent, DaclDefaulted;
03762     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03763 
03764     <span class="comment">//</span>
03765     <span class="comment">// Open the server file with "read contol" permission.</span>
03766     <span class="comment">//</span>
03767 
03768     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;FileNameString, FileName);
03769 
03770     InitializeObjectAttributes(
03771         &amp;ObjectAttributes,
03772         &amp;FileNameString,
03773         OBJ_CASE_INSENSITIVE,
03774         ParentHandle,
03775         NULL);
03776 
03777     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(
03778                  &amp;ServerFileHandle,
03779                  READ_CONTROL,
03780                  &amp;ObjectAttributes,
03781                  &amp;IoStatusBlock,
03782                  FILE_SHARE_READ | FILE_SHARE_WRITE,
03783                  0);
03784 
03785     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) || !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatusBlock.Status)) {
03786         KdPrint((<span class="stringliteral">"IopCopyServerAcl: ZwOpenFile on %wZ failed %lx %lx\n"</span>, &amp;FileNameString, Status, IoStatusBlock.Status));
03787         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03788             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatusBlock.Status;
03789         }
03790         <span class="keywordflow">goto</span> cleanup;
03791     }
03792 
03793     <span class="comment">//</span>
03794     <span class="comment">// Now read the DACL from the server file.</span>
03795     <span class="comment">//</span>
03796 
03797     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQuerySecurityObject(
03798                  ServerFileHandle,
03799                  DACL_SECURITY_INFORMATION,
03800                  Buffer,
03801                  BufferSize,
03802                  &amp;LengthNeeded);
03803 
03804     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03805         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
03806 
03807             <span class="comment">//</span>
03808             <span class="comment">// Allocate a buffer and query again.</span>
03809             <span class="comment">//</span>
03810 
03811             SecurityDescriptor = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool, LengthNeeded, 'bRoI');
03812             <span class="keywordflow">if</span> (SecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03813                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
03814             } <span class="keywordflow">else</span> {
03815                 AllocatedSecurityDescriptor = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03816 
03817                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQuerySecurityObject(
03818                              ServerFileHandle,
03819                              DACL_SECURITY_INFORMATION,
03820                              SecurityDescriptor,
03821                              LengthNeeded,
03822                              &amp;LengthNeeded);
03823 
03824             }
03825         }
03826         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03827             KdPrint((<span class="stringliteral">"IopCopyServerAcl: Could not ZwQuerySecurityObject on %wZ %lx\n"</span>, &amp;FileNameString, Status));
03828             ZwClose(ServerFileHandle);
03829             <span class="keywordflow">goto</span> cleanup;
03830         }
03831 
03832     } <span class="keywordflow">else</span> {
03833 
03834         SecurityDescriptor = (PSECURITY_DESCRIPTOR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
03835     }
03836 
03837     ZwClose(ServerFileHandle);   <span class="comment">// don't need this any more.</span>
03838 
03839 
03840     <span class="comment">//</span>
03841     <span class="comment">// If there is no DACL, return.</span>
03842     <span class="comment">//</span>
03843 
03844     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a61">RtlGetDaclSecurityDescriptor</a>(
03845                  SecurityDescriptor,
03846                  &amp;DaclPresent,
03847                  &amp;Dacl,
03848                  &amp;DaclDefaulted);
03849 
03850     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) || !DaclPresent || (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03851         <span class="comment">// DbgPrint("IopCopyServerAcl: No DACL for %wZ\n", &amp;FileNameString);</span>
03852         <span class="keywordflow">goto</span> cleanup;
03853     }
03854 
03855     <span class="comment">//</span>
03856     <span class="comment">// Get the shadow file name.</span>
03857     <span class="comment">//</span>
03858 
03859     ShadowFileName = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool, <span class="keyword">sizeof</span>(WCHAR) * MAX_PATH, 'bRoI');
03860     <span class="keywordflow">if</span> (ShadowFileName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03861         KdPrint((<span class="stringliteral">"IopCopyServerAcl: Could not allocate ShadowFileName\n"</span>));
03862         <span class="keywordflow">goto</span> cleanup;
03863     }
03864 
03865     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IopGetShadowPathW(
03866                  ShadowHandle,
03867                  ShadowFileName,
03868                  &amp;CopyParams);
03869 
03870     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03871         KdPrint((<span class="stringliteral">"IopCopyServerAcl: IopGetShadowPathW failed on %wZ %lx\n"</span>, &amp;FileNameString, Status));
03872         <span class="keywordflow">goto</span> cleanup;
03873     }
03874 
03875     <span class="comment">//</span>
03876     <span class="comment">// Open the file with "write DACL" permission.</span>
03877     <span class="comment">//</span>
03878 
03879     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ShadowFileString, ShadowFileName);
03880 
03881     InitializeObjectAttributes(
03882         &amp;ObjectAttributes,
03883         &amp;ShadowFileString,
03884         OBJ_CASE_INSENSITIVE,
03885         NULL,
03886         NULL);
03887 
03888     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(
03889                  &amp;ShadowFileHandle,
03890                  WRITE_DAC,
03891                  &amp;ObjectAttributes,
03892                  &amp;IoStatusBlock,
03893                  FILE_SHARE_READ | FILE_SHARE_WRITE,
03894                  0);
03895 
03896     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) || !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatusBlock.Status)) {
03897         KdPrint((<span class="stringliteral">"IopCopyServerAcl: ZwOpenFile on %wZ (%wZ) failed %lx %lx\n"</span>, &amp;FileNameString, &amp;ShadowFileString, Status, IoStatusBlock.Status));
03898         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03899             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatusBlock.Status;
03900         }
03901         <span class="keywordflow">goto</span> cleanup;
03902     }
03903 
03904     <span class="comment">//</span>
03905     <span class="comment">// Write the security descriptor to the shadow file.</span>
03906     <span class="comment">//</span>
03907 
03908     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwSetSecurityObject(
03909                  ShadowFileHandle,
03910                  DACL_SECURITY_INFORMATION,
03911                  SecurityDescriptor);
03912 
03913     ZwClose(ShadowFileHandle);
03914 
03915     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03916         KdPrint((<span class="stringliteral">"IopCopyServerAcl: Could not ZwSetSecurityObject on %wZ %lx\n"</span>, &amp;FileNameString, Status));
03917     }
03918 
03919 cleanup:
03920 
03921     <span class="keywordflow">if</span> (AllocatedSecurityDescriptor) {
03922         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
03923     }
03924     <span class="keywordflow">if</span> (ShadowFileName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03925         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ShadowFileName);
03926     }
03927 
03928     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03929 
03930 }
03931 
03932 
03933 <span class="comment">/*****************************************************************************</span>
03934 <span class="comment"> *      Given an hShadow, get the shadow path if it exists</span>
03935 <span class="comment"> */</span>
03936 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03937 IopGetShadowPathW(
03938     HSHADOW hShadow,
03939     PWCHAR lpLocalPath,
03940     LPCOPYPARAMSW lpCP
03941     )
03942 {
03943     IO_STATUS_BLOCK Iosb;
03944     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03945 
03946     RtlZeroMemory((PUCHAR)lpCP, <span class="keyword">sizeof</span>(COPYPARAMSW));
03947     lpCP-&gt;hShadow = hShadow;
03948     lpCP-&gt;lpLocalPath = lpLocalPath;
03949     lpCP-&gt;uOp = 1;     <span class="comment">// return full \Device\... name</span>
03950 
03951     status = ZwDeviceIoControlFile(
03952                 RdrHandle,
03953                 NULL,
03954                 NULL,               <span class="comment">// APC routine</span>
03955                 NULL,               <span class="comment">// APC Context</span>
03956                 &amp;Iosb,
03957                 IOCTL_SHADOW_GET_UNC_PATH, <span class="comment">// IoControlCode</span>
03958                 (LPVOID)(lpCP),     <span class="comment">// Buffer for data to the FS</span>
03959                 0,
03960                 NULL,               <span class="comment">// OutputBuffer for data from the FS</span>
03961                 0                   <span class="comment">// OutputBuffer Length</span>
03962                 );
03963 
03964     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( status != STATUS_PENDING );
03965     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
03966         status = Iosb.Status;
03967     }
03968 
03969     <span class="keywordflow">return</span> status;
03970 }
03971 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
03972 <span class="preprocessor"></span>
03973 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03974"></a><a class="code" href="../../d4/d6/netboot_8c.html#a4">03974</a> <a class="code" href="../../d4/d6/netboot_8c.html#a4">IopWriteIpAddressToRegistry</a>(
03975         HANDLE handle,
03976         PWCHAR regkey,
03977         PUCHAR value
03978         )
03979 {
03980     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03981     UNICODE_STRING string;
03982     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> addressA[16];
03983     WCHAR addressW[16];
03984     STRING addressStringA;
03985     UNICODE_STRING addressStringW;
03986 
03987     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, regkey );
03988 
03989     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(addressA, <span class="stringliteral">"%d.%d.%d.%d"</span>,
03990              value[0],
03991              value[1],
03992              value[2],
03993              value[3]);
03994 
03995     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;addressStringA, addressA);
03996     addressStringW.Buffer = addressW;
03997     addressStringW.MaximumLength = <span class="keyword">sizeof</span>(addressW);
03998 
03999     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;addressStringW, &amp;addressStringA, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04000 
04001     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
04002                 handle,
04003                 &amp;string,
04004                 0,
04005                 REG_MULTI_SZ,
04006                 addressW,
04007                 addressStringW.Length + <span class="keyword">sizeof</span>(WCHAR)
04008                 );
04009     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
04010         KdPrint(( <span class="stringliteral">"IopWriteIpAddressToRegistry: Unable to set %ws value: %x\n"</span>, regkey, status ));
04011     }
04012     <span class="keywordflow">return</span> status;
04013 }
04014 
04015 
04016 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04017"></a><a class="code" href="../../d4/d6/netboot_8c.html#a7">04017</a> <a class="code" href="../../d4/d6/netboot_8c.html#a7">IopSetDefaultGateway</a>(
04018     IN ULONG GatewayAddress
04019     )
04020 <span class="comment">/*++</span>
04021 <span class="comment"></span>
04022 <span class="comment">Routine Description:</span>
04023 <span class="comment"></span>
04024 <span class="comment">    This function adds a default gateway entry from the router table.</span>
04025 <span class="comment"></span>
04026 <span class="comment">Arguments:</span>
04027 <span class="comment"></span>
04028 <span class="comment">    GatewayAddress - Address of the default gateway.</span>
04029 <span class="comment"></span>
04030 <span class="comment">Return Value:</span>
04031 <span class="comment"></span>
04032 <span class="comment">    Error Code.</span>
04033 <span class="comment"></span>
04034 <span class="comment">--*/</span>
04035 {
04036     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04037 
04038     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04039     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Context[CONTEXT_SIZE];
04040     TDIObjectID <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>;
04041     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
04042     IPSNMPInfo IPStats;
04043     IPAddrEntry *AddrTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04044     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> NumReturned;
04045     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Type;
04046     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
04047     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> MatchIndex;
04048     IPRouteEntry RouteEntry;
04049     OBJECT_ATTRIBUTES objectAttributes;
04050     UNICODE_STRING NameString;
04051     IO_STATUS_BLOCK ioStatusBlock;
04052 
04053     <span class="keywordflow">if</span> (GatewayAddress == 0) {
04054         <span class="keywordflow">return</span> STATUS_SUCCESS;
04055     }
04056 
04057     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;NameString, DD_TCP_DEVICE_NAME );
04058 
04059     InitializeObjectAttributes(
04060         &amp;objectAttributes,
04061         &amp;NameString,
04062         OBJ_CASE_INSENSITIVE,
04063         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04064         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04065         );
04066 
04067     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
04068                 &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
04069                 GENERIC_READ | GENERIC_WRITE,
04070                 &amp;objectAttributes,
04071                 &amp;ioStatusBlock,
04072                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04073                 0,
04074                 FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
04075                 FILE_OPEN,
04076                 FILE_SYNCHRONOUS_IO_NONALERT,
04077                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04078                 0
04079                 );
04080     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
04081         KdPrint(( <span class="stringliteral">"IopSetDefaultGateway: Unable to open TCPIP: %x\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
04082         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04083     }
04084 
04085     <span class="comment">//</span>
04086     <span class="comment">// Get the NetAddr info, to find an interface index for the gateway.</span>
04087     <span class="comment">//</span>
04088 
04089     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.toi_entity.tei_entity   = CL_NL_ENTITY;
04090     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.toi_entity.tei_instance = 0;
04091     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.toi_class               = INFO_CLASS_PROTOCOL;
04092     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.toi_type                = INFO_TYPE_PROVIDER;
04093     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.toi_id                  = IP_MIB_STATS_ID;
04094 
04095     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <span class="keyword">sizeof</span>(IPStats);
04096     memset(&amp;IPStats, 0x0, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04097     memset(Context, 0x0, CONTEXT_SIZE);
04098 
04099     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/netboot_8c.html#a5">IopTCPQueryInformationEx</a>(
04100                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
04101                 &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>,
04102                 &amp;IPStats,
04103                 &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
04104                 Context);
04105 
04106     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04107         KdPrint(( <span class="stringliteral">"IopSetDefaultGateway: Unable to query TCPIP(1): %x\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
04108         <span class="keywordflow">goto</span> Cleanup;
04109     }
04110 
04111     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = IPStats.ipsi_numaddr * <span class="keyword">sizeof</span>(IPAddrEntry);
04112     AddrTable = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, 'bRoI');
04113 
04114     <span class="keywordflow">if</span> (AddrTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04115         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
04116         <span class="keywordflow">goto</span> Cleanup;
04117     }
04118 
04119     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.toi_id = IP_MIB_ADDRTABLE_ENTRY_ID;
04120     memset(Context, 0x0, CONTEXT_SIZE);
04121 
04122     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/netboot_8c.html#a5">IopTCPQueryInformationEx</a>(
04123                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
04124                 &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>,
04125                 AddrTable,
04126                 &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
04127                 Context);
04128 
04129     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04130         KdPrint(( <span class="stringliteral">"IopSetDefaultGateway: Unable to query TCPIP(2): %x\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
04131         <span class="keywordflow">goto</span> Cleanup;
04132     }
04133 
04134     NumReturned = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>/<span class="keyword">sizeof</span>(IPAddrEntry);
04135 
04136     <span class="comment">//</span>
04137     <span class="comment">// We've got the address table. Loop through it. If we find an exact</span>
04138     <span class="comment">// match for the gateway, then we're adding or deleting a direct route</span>
04139     <span class="comment">// and we're done. Otherwise try to find a match on the subnet mask,</span>
04140     <span class="comment">// and remember the first one we find.</span>
04141     <span class="comment">//</span>
04142 
04143     Type = IRE_TYPE_INDIRECT;
04144     <span class="keywordflow">for</span> (i = 0, MatchIndex = 0xffff; i &lt; NumReturned; i++) {
04145 
04146         <span class="keywordflow">if</span>( AddrTable[i].iae_addr == GatewayAddress ) {
04147 
04148             <span class="comment">//</span>
04149             <span class="comment">// Found an exact match.</span>
04150             <span class="comment">//</span>
04151 
04152             MatchIndex = i;
04153             Type = IRE_TYPE_DIRECT;
04154             <span class="keywordflow">break</span>;
04155         }
04156 
04157         <span class="comment">//</span>
04158         <span class="comment">// The next hop is on the same subnet as this address. If</span>
04159         <span class="comment">// we haven't already found a match, remember this one.</span>
04160         <span class="comment">//</span>
04161 
04162         <span class="keywordflow">if</span> ( (MatchIndex == 0xffff) &amp;&amp;
04163              (AddrTable[i].iae_addr != 0) &amp;&amp;
04164              (AddrTable[i].iae_mask != 0) &amp;&amp;
04165              ((AddrTable[i].iae_addr &amp; AddrTable[i].iae_mask) ==
04166                 (GatewayAddress  &amp; AddrTable[i].iae_mask)) ) {
04167 
04168             MatchIndex = i;
04169         }
04170     }
04171 
04172     <span class="comment">//</span>
04173     <span class="comment">// We've looked at all of the entries. See if we found a match.</span>
04174     <span class="comment">//</span>
04175 
04176     <span class="keywordflow">if</span> (MatchIndex == 0xffff) {
04177         <span class="comment">//</span>
04178         <span class="comment">// Didn't find a match.</span>
04179         <span class="comment">//</span>
04180 
04181         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
04182         KdPrint(( <span class="stringliteral">"IopSetDefaultGateway: Unable to find match for gateway\n"</span> ));
04183         <span class="keywordflow">goto</span> Cleanup;
04184     }
04185 
04186     <span class="comment">//</span>
04187     <span class="comment">// We've found a match. Fill in the route entry, and call the</span>
04188     <span class="comment">// Set API.</span>
04189     <span class="comment">//</span>
04190 
04191     RouteEntry.ire_dest = <a class="code" href="../../d4/d6/netboot_8c.html#a0">DEFAULT_DEST</a>;
04192     RouteEntry.ire_index = AddrTable[MatchIndex].iae_index;
04193     RouteEntry.ire_metric1 = <a class="code" href="../../d4/d6/netboot_8c.html#a2">DEFAULT_METRIC</a>;
04194     RouteEntry.ire_metric2 = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(-1);
04195     RouteEntry.ire_metric3 = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(-1);
04196     RouteEntry.ire_metric4 = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(-1);
04197     RouteEntry.ire_nexthop = GatewayAddress;
04198     RouteEntry.ire_type = Type;
04199     RouteEntry.ire_proto = IRE_PROTO_LOCAL;
04200     RouteEntry.ire_age = 0;
04201     RouteEntry.ire_mask = <a class="code" href="../../d4/d6/netboot_8c.html#a1">DEFAULT_DEST_MASK</a>;
04202     RouteEntry.ire_metric5 = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(-1);
04203     RouteEntry.ire_context = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04204 
04205     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <span class="keyword">sizeof</span>(RouteEntry);
04206 
04207     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.toi_id = IP_MIB_RTTABLE_ENTRY_ID;
04208 
04209     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/netboot_8c.html#a6">IopTCPSetInformationEx</a>(
04210                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
04211                 &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>,
04212                 &amp;RouteEntry,
04213                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
04214 
04215     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04216         KdPrint(( <span class="stringliteral">"IopSetDefaultGateway: Unable to set default gateway: %x\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
04217     }
04218 
04219     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
04220 
04221     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04222 
04223 Cleanup:
04224 
04225     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04226         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
04227     }
04228 
04229     <span class="keywordflow">if</span>( AddrTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04230         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AddrTable );
04231     }
04232 
04233     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04234 }
04235 
04236 
04237 __inline <span class="keywordtype">long</span>
<a name="l04238"></a><a class="code" href="../../d4/d6/netboot_8c.html#a16">04238</a> <a class="code" href="../../d4/d6/netboot_8c.html#a16">htonl</a>(<span class="keywordtype">long</span> x)
04239 {
04240         <span class="keywordflow">return</span>((((x) &gt;&gt; 24) &amp; 0x000000FF<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) |
04241            (((x) &gt;&gt;  8) &amp; 0x0000FF00<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) |
04242            (((x) &lt;&lt;  8) &amp; 0x00FF0000<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) |
04243            (((x) &lt;&lt; 24) &amp; 0xFF000000<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
04244 }
04245 
04246 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04247"></a><a class="code" href="../../d4/d6/netboot_8c.html#a8">04247</a> <a class="code" href="../../d4/d6/netboot_8c.html#a8">IopCacheNetbiosNameForIpAddress</a>(
04248     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
04249     )
04250 <span class="comment">/*++</span>
04251 <span class="comment"></span>
04252 <span class="comment">Routine Description:</span>
04253 <span class="comment"></span>
04254 <span class="comment">    This function takes an IP address, and submits it to NetBt for name resolution.</span>
04255 <span class="comment"></span>
04256 <span class="comment">Arguments:</span>
04257 <span class="comment"></span>
04258 <span class="comment">    IpAddress - Address to resolve</span>
04259 <span class="comment"></span>
04260 <span class="comment">Return Value:</span>
04261 <span class="comment"></span>
04262 <span class="comment">    Error Code.</span>
04263 <span class="comment"></span>
04264 <span class="comment">--*/</span>
04265 {
04266     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04267     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04268     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Context[CONTEXT_SIZE];
04269     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
04270     OBJECT_ATTRIBUTES objectAttributes;
04271     UNICODE_STRING NameString;
04272     IO_STATUS_BLOCK ioStatusBlock;
04273     tREMOTE_CACHE cacheInfo;
04274     PCHAR serverName;
04275     PCHAR endOfServerName;
04276 
04277     <span class="comment">//</span>
04278     <span class="comment">// Open NetBT.</span>
04279     <span class="comment">//</span>
04280 
04281     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
04282         &amp;NameString,
04283         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Device\\NetBT_Tcpip_{54C7D140-09EF-11D1-B25A-F5FE627ED95E}"</span>
04284         );
04285 
04286     InitializeObjectAttributes(
04287         &amp;objectAttributes,
04288         &amp;NameString,
04289         OBJ_CASE_INSENSITIVE,
04290         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04291         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04292         );
04293 
04294     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
04295                 &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
04296                 GENERIC_READ | GENERIC_WRITE,
04297                 &amp;objectAttributes,
04298                 &amp;ioStatusBlock,
04299                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04300                 0,
04301                 FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
04302                 FILE_OPEN,
04303                 FILE_SYNCHRONOUS_IO_NONALERT,
04304                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04305                 0
04306                 );
04307     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
04308         KdPrint(( <span class="stringliteral">"IopCacheNetbiosNameForIpAddress: Unable to open NETBT: %x\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
04309         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04310     }
04311 
04312     <span class="comment">//</span>
04313     <span class="comment">// Get the server's name.</span>
04314     <span class="comment">//</span>
04315     <span class="comment">// If this is a remote boot setup boot, NtBootPathName is of the</span>
04316     <span class="comment">// form &lt;server&gt;&lt;share&gt;\setup&lt;install-directory&gt;&lt;platform&gt;.</span>
04317     <span class="comment">// If this is a normal remote boot, NtBootPathName is of the form</span>
04318     <span class="comment">// &lt;server&gt;&lt;share&gt;\images&lt;machine&gt;\winnt.</span>
04319     <span class="comment">//</span>
04320     <span class="comment">// Thus in either case, we need to isolate the first element of the</span>
04321     <span class="comment">// path.</span>
04322     <span class="comment">//</span>
04323 
04324     serverName = LoaderBlock-&gt;NtBootPathName;
04325     <span class="keywordflow">if</span> ( *serverName == <span class="charliteral">'\\'</span> ) {
04326         serverName++;
04327     }
04328     endOfServerName = strchr( serverName, <span class="charliteral">'\\'</span> );
04329     <span class="keywordflow">if</span> ( endOfServerName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04330         endOfServerName = strchr( serverName, <span class="charliteral">'\0'</span> );
04331     }
04332 
04333     <span class="comment">//</span>
04334     <span class="comment">// Fill in the tREMOTE_CACHE structure.</span>
04335     <span class="comment">//</span>
04336 
04337     memset(&amp;cacheInfo, 0x0, <span class="keyword">sizeof</span>(cacheInfo));
04338 
04339     memset(cacheInfo.name, <span class="charliteral">' '</span>, NETBIOS_NAMESIZE);
04340     memcpy(cacheInfo.name, serverName, (ULONG)(endOfServerName - serverName));
04341     cacheInfo.IpAddress = <a class="code" href="../../d4/d6/netboot_8c.html#a16">htonl</a>(LoaderBlock-&gt;SetupLoaderBlock-&gt;ServerIpAddress);
04342     cacheInfo.Ttl = MAXULONG;
04343 
04344     <span class="comment">//</span>
04345     <span class="comment">// Submit the IOCTL.</span>
04346     <span class="comment">//</span>
04347 
04348     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
04349                <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
04350                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04351                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04352                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04353                &amp;ioStatusBlock,
04354                IOCTL_NETBT_ADD_TO_REMOTE_TABLE,
04355                &amp;cacheInfo,
04356                <span class="keyword">sizeof</span>(cacheInfo),
04357                Context,
04358                <span class="keyword">sizeof</span>(Context)
04359                );
04360 
04361     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_PENDING );
04362     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
04363         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ioStatusBlock.Status;
04364     }
04365 
04366     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
04367         KdPrint(( <span class="stringliteral">"IopCacheNetbiosNameForIpAddress: Adapter status failed: %x\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
04368     }
04369 
04370     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
04371 
04372     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04373 }
04374 
04375 
04376 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04377"></a><a class="code" href="../../d4/d6/netboot_8c.html#a5">04377</a> <a class="code" href="../../d4/d6/netboot_8c.html#a5">IopTCPQueryInformationEx</a>(
04378     IN HANDLE                 TCPHandle,
04379     IN TDIObjectID FAR       *ID,
04380     OUT <span class="keywordtype">void</span> FAR             *Buffer,
04381     IN OUT DWORD FAR         *BufferSize,
04382     IN OUT BYTE FAR          *Context
04383     )
04384 <span class="comment">/*++</span>
04385 <span class="comment"></span>
04386 <span class="comment">Routine Description:</span>
04387 <span class="comment"></span>
04388 <span class="comment">    This routine provides the interface to the TDI QueryInformationEx</span>
04389 <span class="comment">    facility of the TCP/IP stack on NT. Someday, this facility will be</span>
04390 <span class="comment">    part of TDI.</span>
04391 <span class="comment"></span>
04392 <span class="comment">Arguments:</span>
04393 <span class="comment"></span>
04394 <span class="comment">    TCPHandle     - Open handle to the TCP driver</span>
04395 <span class="comment">    ID            - The TDI Object ID to query</span>
04396 <span class="comment">    Buffer        - Data buffer to contain the query results</span>
04397 <span class="comment">    BufferSize    - Pointer to the size of the results buffer. Filled in</span>
04398 <span class="comment">                    with the amount of results data on return.</span>
04399 <span class="comment">    Context       - Context value for the query. Should be zeroed for a</span>
04400 <span class="comment">                    new query. It will be filled with context</span>
04401 <span class="comment">                    information for linked enumeration queries.</span>
04402 <span class="comment"></span>
04403 <span class="comment">Return Value:</span>
04404 <span class="comment"></span>
04405 <span class="comment">    An NTSTATUS value.</span>
04406 <span class="comment"></span>
04407 <span class="comment">--*/</span>
04408 
04409 {
04410     TCP_REQUEST_QUERY_INFORMATION_EX   queryBuffer;
04411     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                              queryBufferSize;
04412     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                           status;
04413     IO_STATUS_BLOCK                    ioStatusBlock;
04414 
04415 
04416     <span class="keywordflow">if</span> (TCPHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04417         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
04418     }
04419 
04420     queryBufferSize = <span class="keyword">sizeof</span>(TCP_REQUEST_QUERY_INFORMATION_EX);
04421     memcpy(&amp;(queryBuffer.ID), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>, <span class="keyword">sizeof</span>(TDIObjectID));
04422     memcpy(&amp;(queryBuffer.Context), Context, CONTEXT_SIZE);
04423 
04424     status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
04425                  TCPHandle,                       <span class="comment">// Driver handle</span>
04426                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                            <span class="comment">// Event</span>
04427                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                            <span class="comment">// APC Routine</span>
04428                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                            <span class="comment">// APC context</span>
04429                  &amp;ioStatusBlock,                  <span class="comment">// Status block</span>
04430                  IOCTL_TCP_QUERY_INFORMATION_EX,  <span class="comment">// Control code</span>
04431                  &amp;queryBuffer,                    <span class="comment">// Input buffer</span>
04432                  queryBufferSize,                 <span class="comment">// Input buffer size</span>
04433                  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,                          <span class="comment">// Output buffer</span>
04434                  *<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>                      <span class="comment">// Output buffer size</span>
04435                  );
04436 
04437     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( status != STATUS_PENDING );
04438     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
04439         status = ioStatusBlock.Status;
04440     }
04441 
04442     <span class="keywordflow">if</span> (status == STATUS_SUCCESS) {
04443         <span class="comment">//</span>
04444         <span class="comment">// Copy the return context to the caller's context buffer</span>
04445         <span class="comment">//</span>
04446         memcpy(Context, &amp;(queryBuffer.Context), CONTEXT_SIZE);
04447         *<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = (ULONG)ioStatusBlock.Information;
04448         status = ioStatusBlock.Status;
04449     } <span class="keywordflow">else</span> {
04450         *<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = 0;
04451     }
04452 
04453     <span class="keywordflow">return</span>(status);
04454 }
04455 
04456 
04457 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04458"></a><a class="code" href="../../d4/d6/netboot_8c.html#a6">04458</a> <a class="code" href="../../d4/d6/netboot_8c.html#a6">IopTCPSetInformationEx</a>(
04459     IN HANDLE             TCPHandle,
04460     IN TDIObjectID FAR   *ID,
04461     IN <span class="keywordtype">void</span> FAR          *Buffer,
04462     IN DWORD FAR          BufferSize
04463     )
04464 <span class="comment">/*++</span>
04465 <span class="comment"></span>
04466 <span class="comment">Routine Description:</span>
04467 <span class="comment"></span>
04468 <span class="comment">    This routine provides the interface to the TDI SetInformationEx</span>
04469 <span class="comment">    facility of the TCP/IP stack on NT. Someday, this facility will be</span>
04470 <span class="comment">    part of TDI.</span>
04471 <span class="comment"></span>
04472 <span class="comment">Arguments:</span>
04473 <span class="comment"></span>
04474 <span class="comment">    TCPHandle     - Open handle to the TCP driver</span>
04475 <span class="comment">    ID            - The TDI Object ID to set</span>
04476 <span class="comment">    Buffer        - Data buffer containing the information to be set</span>
04477 <span class="comment">    BufferSize    - The size of the set data buffer.</span>
04478 <span class="comment"></span>
04479 <span class="comment">Return Value:</span>
04480 <span class="comment"></span>
04481 <span class="comment">    An NTSTATUS value.</span>
04482 <span class="comment"></span>
04483 <span class="comment">--*/</span>
04484 
04485 {
04486     PTCP_REQUEST_SET_INFORMATION_EX    setBuffer;
04487     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                           status;
04488     IO_STATUS_BLOCK                    ioStatusBlock;
04489     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                              setBufferSize;
04490 
04491 
04492     <span class="keywordflow">if</span> (TCPHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04493         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
04494     }
04495 
04496     setBufferSize = FIELD_OFFSET(TCP_REQUEST_SET_INFORMATION_EX, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
04497 
04498     setBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, setBufferSize, 'bRoI');
04499 
04500     <span class="keywordflow">if</span> (setBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04501         <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
04502     }
04503 
04504     setBuffer-&gt;BufferSize = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
04505 
04506     memcpy(&amp;(setBuffer-&gt;ID), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>, <span class="keyword">sizeof</span>(TDIObjectID));
04507 
04508     memcpy(&amp;(setBuffer-&gt;Buffer[0]), <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
04509 
04510     status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
04511                  TCPHandle,                       <span class="comment">// Driver handle</span>
04512                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                            <span class="comment">// Event</span>
04513                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                            <span class="comment">// APC Routine</span>
04514                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                            <span class="comment">// APC context</span>
04515                  &amp;ioStatusBlock,                  <span class="comment">// Status block</span>
04516                  IOCTL_TCP_SET_INFORMATION_EX,    <span class="comment">// Control code</span>
04517                  setBuffer,                       <span class="comment">// Input buffer</span>
04518                  setBufferSize,                   <span class="comment">// Input buffer size</span>
04519                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                            <span class="comment">// Output buffer</span>
04520                  0                                <span class="comment">// Output buffer size</span>
04521                  );
04522 
04523     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( status != STATUS_PENDING );
04524     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
04525         status = ioStatusBlock.Status;
04526     }
04527 
04528     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(setBuffer);
04529 
04530     <span class="keywordflow">return</span>(status);
04531 }
04532 
04533 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
04534 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04535 IopGetHarddiskInfo(
04536     OUT PWSTR NetHDCSCPartition
04537     )
04538 <span class="comment">/*++</span>
04539 <span class="comment"></span>
04540 <span class="comment">Routine Description:</span>
04541 <span class="comment"></span>
04542 <span class="comment">    This routine searches the each partition on each hard disk for</span>
04543 <span class="comment">    one which has the active bit set, returning the first one encountered.</span>
04544 <span class="comment"></span>
04545 <span class="comment">Arguments:</span>
04546 <span class="comment"></span>
04547 <span class="comment">    LoaderBlock - The loader parameter block.</span>
04548 <span class="comment"></span>
04549 <span class="comment">    NetHDCSCPartition - Either an arcname or string of type \Device\HarddiskX\PartitionY.</span>
04550 <span class="comment">        Defaults to \Device\Harddisk0\Partition1</span>
04551 <span class="comment"></span>
04552 <span class="comment">Return Value:</span>
04553 <span class="comment"></span>
04554 <span class="comment">    None</span>
04555 <span class="comment"></span>
04556 <span class="comment">--*/</span>
04557 
04558 {
04559     PARTITION_INFORMATION PartitionInfo;
04560     FILE_FS_SIZE_INFORMATION SizeInfo;
04561     PWSTR NameBuffer;
04562     PWSTR DiskNameBuffer;
04563     PWSTR NetHDBootPartition;
04564     ULONG DiskNumber;
04565     ULONG PartitionNumber;
04566     ULONG DestPartitionNumber;
04567     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
04568     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04569     IO_STATUS_BLOCK IoStatus;
04570     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
04571     UNICODE_STRING UnicodeString;
04572     LARGE_INTEGER LargestFreeSpace;
04573     LARGE_INTEGER FreeSpace;
04574 
04575     wcscpy(NetHDCSCPartition, L<span class="stringliteral">"\\Device\\Harddisk0\\Partition1"</span>);
04576 
04577     NameBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool, 80 * 3 * <span class="keyword">sizeof</span>(WCHAR), 'bRoI');
04578     <span class="keywordflow">if</span> ( NameBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04579         KdPrint(( <span class="stringliteral">"IopGetHarddiskInfo: unable to allocate buffer\n"</span> ));
04580         <span class="keywordflow">return</span>;
04581     }
04582 
04583     DiskNameBuffer = NameBuffer + 80;
04584     NetHDBootPartition = DiskNameBuffer + 80;
04585 
04586     wcscpy(DiskNameBuffer, L<span class="stringliteral">"\\Device\\Harddisk0"</span>);
04587     wcscpy(NetHDBootPartition, DiskNameBuffer);
04588     wcscpy(NetHDBootPartition, L<span class="stringliteral">"\\Partition1"</span>);
04589     wcscpy(NetHDCSCPartition, NetHDBootPartition);
04590 
04591     <span class="comment">//</span>
04592     <span class="comment">// We find the first bootable harddisk-slash-partition and call that the boot partition.</span>
04593     <span class="comment">//</span>
04594 
04595     DiskNumber = 0;
04596     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04597 
04598         <span class="comment">//</span>
04599         <span class="comment">// First check if there is any disk there at all by opening partition 0</span>
04600         <span class="comment">//</span>
04601         PartitionNumber = 0;
04602 
04603         swprintf(NameBuffer, L<span class="stringliteral">"\\Device\\Harddisk%d\\Partition%d"</span>, DiskNumber, PartitionNumber);
04604 
04605         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, NameBuffer);
04606 
04607         InitializeObjectAttributes(
04608             &amp;ObjectAttributes,
04609             &amp;UnicodeString,
04610             OBJ_CASE_INSENSITIVE,
04611             NULL,
04612             NULL
04613             );
04614 
04615         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>( &amp;Handle,
04616                                (ACCESS_MASK)FILE_GENERIC_READ,
04617                                &amp;ObjectAttributes,
04618                                &amp;IoStatus,
04619                                NULL,
04620                                FILE_ATTRIBUTE_NORMAL,
04621                                FILE_SHARE_READ,
04622                                FILE_OPEN,
04623                                FILE_SYNCHRONOUS_IO_NONALERT,
04624                                NULL,
04625                                0
04626                              );
04627 
04628         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04629             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
04630             <span class="keywordflow">return</span>;
04631         }
04632 
04633         ZwClose(Handle);
04634 
04635         <span class="comment">//</span>
04636         <span class="comment">// Now, for each partition, check if it is marked 'active'</span>
04637         <span class="comment">//</span>
04638         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04639 
04640             PartitionNumber++;
04641 
04642             swprintf(NameBuffer, L<span class="stringliteral">"\\Device\\Harddisk%d\\Partition%d"</span>, DiskNumber, PartitionNumber);
04643 
04644             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, NameBuffer);
04645 
04646             InitializeObjectAttributes(
04647                 &amp;ObjectAttributes,
04648                 &amp;UnicodeString,
04649                 OBJ_CASE_INSENSITIVE,
04650                 NULL,
04651                 NULL
04652                 );
04653 
04654 
04655             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>( &amp;Handle,
04656                                    (ACCESS_MASK)FILE_GENERIC_READ,
04657                                    &amp;ObjectAttributes,
04658                                    &amp;IoStatus,
04659                                    NULL,
04660                                    FILE_ATTRIBUTE_NORMAL,
04661                                    FILE_SHARE_READ,
04662                                    FILE_OPEN,
04663                                    FILE_SYNCHRONOUS_IO_NONALERT,
04664                                    NULL,
04665                                    0
04666                                  );
04667 
04668             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04669                 <span class="keywordflow">break</span>;
04670             }
04671 
04672             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeviceIoControlFile(Handle,
04673                                            NULL,
04674                                            NULL,
04675                                            NULL,
04676                                            &amp;IoStatus,
04677                                            IOCTL_DISK_GET_PARTITION_INFO,
04678                                            NULL,
04679                                            0,
04680                                            &amp;PartitionInfo,
04681                                            <span class="keyword">sizeof</span>(PARTITION_INFORMATION)
04682                                           );
04683 
04684             ZwClose(Handle);
04685 
04686             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04687                 <span class="keywordflow">break</span>;
04688             }
04689 
04690             <span class="keywordflow">if</span> (PartitionInfo.BootIndicator) {
04691                 wcscpy(NetHDBootPartition, NameBuffer);
04692                 swprintf(DiskNameBuffer, L<span class="stringliteral">"\\Device\\Harddisk%d"</span>, DiskNumber);
04693                 <span class="keywordflow">goto</span> FoundDisk;
04694             }
04695 
04696         }
04697 
04698         DiskNumber++;
04699     }
04700 
04701     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0); <span class="comment">// We only exit the loop with a return (no boot disk found), or jump to the label</span>
04702 
04703 FoundDisk:
04704 
04705     <span class="comment">//</span>
04706     <span class="comment">// Check each partition for the CSC directory, and find largest free space partition in</span>
04707     <span class="comment">// case no CSC directory exists.</span>
04708     <span class="comment">//</span>
04709 
04710     wcscpy(NetHDCSCPartition, NetHDBootPartition);
04711 
04712     PartitionNumber = 0;
04713     DestPartitionNumber = 0;
04714     LargestFreeSpace = RtlConvertUlongToLargeInteger(0);
04715 
04716     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04717 
04718         PartitionNumber++;
04719 
04720         <span class="comment">//</span>
04721         <span class="comment">// Check for CSC directory first</span>
04722         <span class="comment">//</span>
04723         swprintf(NameBuffer,
04724                  L<span class="stringliteral">"%ws\\Partition%d%ws"</span>,
04725                  DiskNameBuffer,
04726                  PartitionNumber,
04727                  REMOTE_BOOT_IMIRROR_PATH_W REMOTE_BOOT_CSC_SUBDIR_W);
04728 
04729         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, NameBuffer);
04730 
04731         InitializeObjectAttributes(
04732             &amp;ObjectAttributes,
04733             &amp;UnicodeString,
04734             OBJ_CASE_INSENSITIVE,
04735             NULL,
04736             NULL
04737             );
04738 
04739 
04740         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>( &amp;Handle,
04741                              FILE_GENERIC_READ,
04742                              &amp;ObjectAttributes,
04743                              &amp;IoStatus,
04744                              FILE_SHARE_READ,
04745                              FILE_DIRECTORY_FILE
04746                            );
04747 
04748         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04749             ZwClose(Handle);
04750             DestPartitionNumber = PartitionNumber;
04751             <span class="keywordflow">break</span>;
04752         }
04753 
04754         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_UNRECOGNIZED_VOLUME) {
04755             <span class="comment">//</span>
04756             <span class="comment">// Skip this one</span>
04757             <span class="comment">//</span>
04758             <span class="keywordflow">continue</span>;
04759         }
04760 
04761         <span class="comment">//</span>
04762         <span class="comment">// Now get this partition's free space, if it is an NTFS partition.</span>
04763         <span class="comment">//</span>
04764         swprintf(NameBuffer, L<span class="stringliteral">"%ws\\Partition%d"</span>, DiskNameBuffer, PartitionNumber);
04765 
04766         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, NameBuffer);
04767 
04768         InitializeObjectAttributes(
04769             &amp;ObjectAttributes,
04770             &amp;UnicodeString,
04771             OBJ_CASE_INSENSITIVE,
04772             NULL,
04773             NULL
04774             );
04775 
04776         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>( &amp;Handle,
04777                                FILE_GENERIC_READ,
04778                                &amp;ObjectAttributes,
04779                                &amp;IoStatus,
04780                                NULL,
04781                                FILE_ATTRIBUTE_NORMAL,
04782                                FILE_SHARE_READ,
04783                                FILE_OPEN,
04784                                FILE_SYNCHRONOUS_IO_NONALERT | FILE_OPEN_FOR_FREE_SPACE_QUERY,
04785                                NULL,
04786                                0
04787                              );
04788 
04789         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04790             <span class="keywordflow">break</span>;
04791         }
04792 
04793         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeviceIoControlFile(Handle,
04794                                        NULL,
04795                                        NULL,
04796                                        NULL,
04797                                        &amp;IoStatus,
04798                                        IOCTL_DISK_GET_PARTITION_INFO,
04799                                        NULL,
04800                                        0,
04801                                        &amp;PartitionInfo,
04802                                        <span class="keyword">sizeof</span>(PARTITION_INFORMATION)
04803                                       );
04804 
04805         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) || (PartitionInfo.PartitionType != PARTITION_IFS)) {
04806             ZwClose(Handle);
04807             <span class="keywordflow">continue</span>;
04808         }
04809 
04810 
04811         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryVolumeInformationFile(
04812                     Handle,
04813                     &amp;IoStatus,
04814                     &amp;SizeInfo,
04815                     <span class="keyword">sizeof</span>(SizeInfo),
04816                     FileFsSizeInformation
04817                     );
04818 
04819         ZwClose(Handle);
04820 
04821         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04822 
04823             <span class="comment">//</span>
04824             <span class="comment">// Calculate the amount of free space on the drive.</span>
04825             <span class="comment">//</span>
04826             FreeSpace = <a class="code" href="../../d0/d1/largeic_8c.html#a2">RtlExtendedIntegerMultiply</a>(
04827                             SizeInfo.AvailableAllocationUnits,
04828                             SizeInfo.SectorsPerAllocationUnit * SizeInfo.BytesPerSector
04829                             );
04830 
04831             <span class="keywordflow">if</span> (RtlLargeIntegerGreaterThan(FreeSpace, LargestFreeSpace)) {
04832                 LargestFreeSpace = FreeSpace;
04833                 DestPartitionNumber = PartitionNumber;
04834             }
04835 
04836         }
04837 
04838     }
04839 
04840     <span class="keywordflow">if</span> (DestPartitionNumber != 0) {
04841         swprintf(NetHDCSCPartition, L<span class="stringliteral">"%ws\\Partition%d"</span>, DiskNameBuffer, DestPartitionNumber);
04842     }
04843 
04844     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
04845 
04846     <span class="keywordflow">return</span>;
04847 }
04848 
04849 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04850 IoStartCscForTextmodeSetup (
04851     IN BOOLEAN Upgrade
04852     )
04853 {
04854     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04855     PWSTR NetHDCSCPartition;
04856     PUCHAR buffer;
04857     IO_STATUS_BLOCK ioStatusBlock;
04858 
04859     <span class="keywordflow">if</span> (RdrHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04860         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
04861         <span class="keywordflow">return</span>;
04862     }
04863     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d6/netboot_8c.html#a3">ExpInTextModeSetup</a>) {
04864         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
04865         <span class="keywordflow">return</span>;
04866     }
04867     <span class="keywordflow">if</span> (TextmodeSetupHasStartedCsc) {
04868         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
04869         <span class="keywordflow">return</span>;
04870     }
04871 
04872     NetHDCSCPartition = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
04873                             NonPagedPool,
04874                             (80 + MAX_PATH) * <span class="keyword">sizeof</span>(WCHAR),
04875                             'bRoI'
04876                             );
04877     <span class="keywordflow">if</span> (NetHDCSCPartition == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04878         KdPrint(( <span class="stringliteral">"IoStartCscForTextmodeSetup: Unable to allocate buffer\n"</span>));
04879         <span class="keywordflow">return</span>;
04880     }
04881     buffer = (PUCHAR)(NetHDCSCPartition + 80);
04882 
04883     <span class="comment">//</span>
04884     <span class="comment">// Get the path to the boot partition on the disk for CSC and redirection</span>
04885     <span class="comment">// Note: On failure, this defaults to \Device\Harddisk0\Partition1</span>
04886     <span class="comment">//</span>
04887 
04888     IopGetHarddiskInfo(NetHDCSCPartition);
04889 
04890     <span class="comment">//</span>
04891     <span class="comment">// Tell the redirector to initialize remote boot redirection (back</span>
04892     <span class="comment">// to the local disk).</span>
04893     <span class="comment">//</span>
04894 
04895     <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( RdrHandleProcess );
04896 
04897     status = ZwFsControlFile(
04898                 RdrHandle,
04899                 NULL,
04900                 NULL,
04901                 NULL,
04902                 &amp;ioStatusBlock,
04903                 FSCTL_LMR_START_RBR,
04904                 NetHDCSCPartition,
04905                 wcslen(NetHDCSCPartition) * <span class="keyword">sizeof</span>(WCHAR),
04906                 NULL,
04907                 0
04908                 );
04909 
04910     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
04911         status = ioStatusBlock.Status;
04912     }
04913 
04914     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
04915         KdPrint(( <span class="stringliteral">"IoStartCscForTextmodeSetup: Unable to FSCTL(RBR) redirector: %x\n"</span>, status ));
04916     }
04917 
04918     wcstombs(buffer, NetHDCSCPartition, wcslen(NetHDCSCPartition) + 1);
04919     strcat(buffer, REMOTE_BOOT_IMIRROR_PATH_A REMOTE_BOOT_CSC_SUBDIR_A);
04920 
04921     StartCsc = INIT_CSC;
04922     status = IopInitCsc( buffer );
04923 
04924     <span class="comment">//</span>
04925     <span class="comment">// If this is not an upgrade, or if initialization of CSC failed,</span>
04926     <span class="comment">// reset the cache.</span>
04927     <span class="comment">//</span>
04928 
04929     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (!Upgrade || (StartCsc == FLUSH_CSC)) ) {
04930 
04931         status = IopResetCsc( buffer );
04932 
04933         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
04934             KdPrint((<span class="stringliteral">"IoStartCscForTextmodeSetup: reset of Csc failed %x\n"</span>, status));
04935         }
04936     }
04937 
04938     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
04939         KdPrint((<span class="stringliteral">"IoStartCscForTextmodeSetup: initialization of Csc failed %x\n"</span>, status));
04940         IoCscInitializationFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04941         SharedUserData-&gt;SystemFlags |= SYSTEM_FLAG_DISKLESS_CLIENT;
04942     } <span class="keywordflow">else</span> {
04943         IoCscInitializationFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04944         SharedUserData-&gt;SystemFlags &amp;= ~SYSTEM_FLAG_DISKLESS_CLIENT;
04945     }
04946 
04947     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
04948 
04949     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NetHDCSCPartition );
04950 
04951     <span class="keywordflow">return</span>;
04952 
04953 } <span class="comment">// IoStartCscForTextModeSetup</span>
04954 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
04955 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
