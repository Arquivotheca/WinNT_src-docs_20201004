<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: allproc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>allproc.c</h1><a href="../../d4/d6/alpha_2allproc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment">Copyright (c) 1993  Digital Equipment Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    allproc.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module allocates and initializes kernel resources required</span>
00013 <span class="comment">    to start a new processor, and passes a complete processor state</span>
00014 <span class="comment">    structure to the HAL to obtain a new processor.</span>
00015 <span class="comment"></span>
00016 <span class="comment">Author:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    David N. Cutler 29-Apr-1993</span>
00019 <span class="comment">    Joe Notarangelo 30-Nov-1993</span>
00020 <span class="comment"></span>
00021 <span class="comment">Environment:</span>
00022 <span class="comment"></span>
00023 <span class="comment">    Kernel mode only.</span>
00024 <span class="comment"></span>
00025 <span class="comment">Revision History:</span>
00026 <span class="comment"></span>
00027 <span class="comment">--*/</span>
00028 
00029 
00030 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00031 
00032 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00033 <span class="preprocessor"></span>
00034 <span class="preprocessor">#pragma alloc_text(INIT, KeStartAllProcessors)</span>
00035 <span class="preprocessor"></span>
00036 <span class="preprocessor">#endif</span>
00037 <span class="preprocessor"></span>
00038 <span class="comment">//</span>
00039 <span class="comment">// Define macro to round up to 64-byte boundary and define block sizes.</span>
00040 <span class="comment">//</span>
00041 
<a name="l00042"></a><a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a0">00042</a> <span class="preprocessor">#define ROUND_UP(x) ((sizeof(x) + 64) &amp; (~64))</span>
<a name="l00043"></a><a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a1">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define BLOCK1_SIZE ((3 * KERNEL_STACK_SIZE) + PAGE_SIZE)</span>
<a name="l00044"></a><a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a2">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define BLOCK2_SIZE (ROUND_UP(KPRCB) + ROUND_UP(ETHREAD) + 64)</span>
00045 <span class="preprocessor"></span>
00046 <span class="comment">//</span>
00047 <span class="comment">// Macros to compute whether an address is physically addressable.</span>
00048 <span class="comment">//</span>
00049 
00050 <span class="preprocessor">#if defined(_AXP64_)</span>
00051 <span class="preprocessor"></span>
00052 <span class="preprocessor">#define IS_KSEG_ADDRESS(v)                                      \</span>
00053 <span class="preprocessor">    (((v) &gt;= KSEG43_BASE) &amp;&amp;                                    \</span>
00054 <span class="preprocessor">     ((v) &lt; KSEG43_LIMIT) &amp;&amp;                                    \</span>
00055 <span class="preprocessor">     (KSEG_PFN(v) &lt; ((KSEG2_BASE - KSEG0_BASE) &gt;&gt; PAGE_SHIFT)))</span>
00056 <span class="preprocessor"></span>
00057 <span class="preprocessor">#define KSEG_PFN(v) ((ULONG)(((v) - KSEG43_BASE) &gt;&gt; PAGE_SHIFT))</span>
00058 <span class="preprocessor"></span><span class="preprocessor">#define KSEG0_ADDRESS(v) (KSEG0_BASE | ((v) - KSEG43_BASE))</span>
00059 <span class="preprocessor"></span>
00060 <span class="preprocessor">#else</span>
00061 <span class="preprocessor"></span>
<a name="l00062"></a><a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a3">00062</a> <span class="preprocessor">#define IS_KSEG_ADDRESS(v) (((v) &gt;= KSEG0_BASE) &amp;&amp; ((v) &lt; KSEG2_BASE))</span>
<a name="l00063"></a><a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a4">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define KSEG_PFN(v) ((ULONG)(((v) - KSEG0_BASE) &gt;&gt; PAGE_SHIFT))</span>
<a name="l00064"></a><a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a5">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define KSEG0_ADDRESS(v) (v)</span>
00065 <span class="preprocessor"></span>
00066 <span class="preprocessor">#endif</span>
00067 <span class="preprocessor"></span>
00068 <span class="comment">//</span>
00069 <span class="comment">// Define forward referenced prototypes.</span>
00070 <span class="comment">//</span>
00071 
00072 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00073 <a class="code" href="../../d8/d6/ppc_2allproc_8c.html#a5">KiStartProcessor</a> (
00074     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> Loaderblock
00075     );
00076 
00077 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00078"></a><a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a7">00078</a> <a class="code" href="../../d8/d6/ppc_2allproc_8c.html#a6">KeStartAllProcessors</a>(
00079     VOID
00080     )
00081 
00082 <span class="comment">/*++</span>
00083 <span class="comment"></span>
00084 <span class="comment">Routine Description:</span>
00085 <span class="comment"></span>
00086 <span class="comment">    This function is called during phase 1 initialization on the master boot</span>
00087 <span class="comment">    processor to start all of the other registered processors.</span>
00088 <span class="comment"></span>
00089 <span class="comment">Arguments:</span>
00090 <span class="comment"></span>
00091 <span class="comment">    None.</span>
00092 <span class="comment"></span>
00093 <span class="comment">Return Value:</span>
00094 <span class="comment"></span>
00095 <span class="comment">    None.</span>
00096 <span class="comment"></span>
00097 <span class="comment">--*/</span>
00098 
00099 {
00100 
00101     ULONG_PTR MemoryBlock1;
00102     ULONG_PTR MemoryBlock2;
00103     ULONG Number;
00104     ULONG PcrPage;
00105     PKPRCB Prcb;
00106     KPROCESSOR_STATE ProcessorState;
00107     <span class="keyword">struct </span><a class="code" href="../../d5/d4/struct__RESTART__BLOCK.html">_RESTART_BLOCK</a> *RestartBlock;
00108     BOOLEAN Started;
00109     LOGICAL SpecialPoolState;
00110 
00111 <span class="preprocessor">#if !defined(NT_UP)</span>
00112 <span class="preprocessor"></span>
00113     <span class="comment">//</span>
00114     <span class="comment">// If the registered number of processors is greater than the maximum</span>
00115     <span class="comment">// number of processors supported, then only allow the maximum number</span>
00116     <span class="comment">// of supported processors.</span>
00117     <span class="comment">//</span>
00118 
00119     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a142">KeRegisteredProcessors</a> &gt; <a class="code" href="../../d9/d5/ndismain_8h.html#a183">MAXIMUM_PROCESSORS</a>) {
00120         <a class="code" href="../../d4/d9/ke_8h.html#a142">KeRegisteredProcessors</a> = <a class="code" href="../../d9/d5/ndismain_8h.html#a183">MAXIMUM_PROCESSORS</a>;
00121     }
00122 
00123     <span class="comment">//</span>
00124     <span class="comment">// Initialize the processor state that will be used to start each of</span>
00125     <span class="comment">// processors. Each processor starts in the system initialization code</span>
00126     <span class="comment">// with address of the loader parameter block as an argument.</span>
00127     <span class="comment">//</span>
00128 
00129     RtlZeroMemory(&amp;ProcessorState, <span class="keyword">sizeof</span>(KPROCESSOR_STATE));
00130     ProcessorState.ContextFrame.IntA0 = (ULONGLONG)(LONG_PTR)<a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>;
00131     ProcessorState.ContextFrame.Fir = (ULONGLONG)(LONG_PTR)<a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a6">KiStartProcessor</a>;
00132     Number = 1;
00133     <span class="keywordflow">while</span> (Number &lt; <a class="code" href="../../d4/d9/ke_8h.html#a142">KeRegisteredProcessors</a>) {
00134 
00135         <span class="comment">//</span>
00136         <span class="comment">// Allocate a DPC stack, an idle thread kernel stack, a panic</span>
00137         <span class="comment">// stack, a PCR page, a processor block, and an executive thread</span>
00138         <span class="comment">// object. If the allocation fails or the allocation cannot be</span>
00139         <span class="comment">// made from unmapped nonpaged pool, then stop starting processors.</span>
00140         <span class="comment">//</span>
00141         <span class="comment">// Disable any special pooling that the user may have set in the</span>
00142         <span class="comment">// registry as the next couple of allocations must come from KSEG0.</span>
00143         <span class="comment">//</span>
00144 
00145         SpecialPoolState = <a class="code" href="../../d1/d6/allocpag_8c.html#a39">MmSetSpecialPool</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00146         MemoryBlock1 = (ULONG_PTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a1">BLOCK1_SIZE</a>);
00147         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a3">IS_KSEG_ADDRESS</a>(MemoryBlock1) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00148             <a class="code" href="../../d1/d6/allocpag_8c.html#a39">MmSetSpecialPool</a>(SpecialPoolState);
00149             <span class="keywordflow">if</span> ((PVOID)MemoryBlock1 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00150                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)MemoryBlock1);
00151             }
00152 
00153             <span class="keywordflow">break</span>;
00154         }
00155 
00156         MemoryBlock2 = (ULONG_PTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a2">BLOCK2_SIZE</a>);
00157         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a3">IS_KSEG_ADDRESS</a>(MemoryBlock2) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00158             <a class="code" href="../../d1/d6/allocpag_8c.html#a39">MmSetSpecialPool</a>(SpecialPoolState);
00159             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)MemoryBlock1);
00160             <span class="keywordflow">if</span> ((PVOID)MemoryBlock2 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00161                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)MemoryBlock2);
00162             }
00163 
00164             <span class="keywordflow">break</span>;
00165         }
00166 
00167         <a class="code" href="../../d1/d6/allocpag_8c.html#a39">MmSetSpecialPool</a>(SpecialPoolState);
00168 
00169         <span class="comment">//</span>
00170         <span class="comment">// Zero both blocks of allocated memory.</span>
00171         <span class="comment">//</span>
00172 
00173         RtlZeroMemory((PVOID)MemoryBlock1, <a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a1">BLOCK1_SIZE</a>);
00174         RtlZeroMemory((PVOID)MemoryBlock2, <a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a2">BLOCK2_SIZE</a>);
00175 
00176         <span class="comment">//</span>
00177         <span class="comment">// Set address of interrupt stack in loader parameter block.</span>
00178         <span class="comment">//</span>
00179 
00180         <a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o23">u</a>.Alpha.PanicStack =
00181                         <a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a5">KSEG0_ADDRESS</a>(MemoryBlock1 + (1 * KERNEL_STACK_SIZE));
00182 
00183         <span class="comment">//</span>
00184         <span class="comment">// Set address of idle thread kernel stack in loader parameter block.</span>
00185         <span class="comment">//</span>
00186 
00187         <a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o3">KernelStack</a> =
00188                         <a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a5">KSEG0_ADDRESS</a>(MemoryBlock1 + (2 * KERNEL_STACK_SIZE));
00189 
00190         ProcessorState.ContextFrame.IntSp =
00191                             (ULONGLONG)(LONG_PTR)<a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o3">KernelStack</a>;
00192 
00193         <span class="comment">//</span>
00194         <span class="comment">// Set address of panic stack in loader parameter block.</span>
00195         <span class="comment">//</span>
00196 
00197         <a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o23">u</a>.Alpha.DpcStack =
00198                         <a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a5">KSEG0_ADDRESS</a>(MemoryBlock1 + (3 * KERNEL_STACK_SIZE));
00199 
00200         <span class="comment">//</span>
00201         <span class="comment">// Set the page frame of the PCR page in the loader parameter block.</span>
00202         <span class="comment">//</span>
00203 
00204         PcrPage = <a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a4">KSEG_PFN</a>(MemoryBlock1 + (3 * KERNEL_STACK_SIZE));
00205         <a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o23">u</a>.Alpha.PcrPage = PcrPage;
00206 
00207         <span class="comment">//</span>
00208         <span class="comment">// Set the address of the processor block and executive thread in the</span>
00209         <span class="comment">// loader parameter block.</span>
00210         <span class="comment">//</span>
00211 
00212         <a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o4">Prcb</a> = <a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a5">KSEG0_ADDRESS</a>((MemoryBlock2  + 63) &amp; ~63);
00213         <a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o6">Thread</a> = <a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o4">Prcb</a> + <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(KPRCB);
00214 
00215         <span class="comment">//</span>
00216         <span class="comment">// Attempt to start the next processor. If attempt is successful,</span>
00217         <span class="comment">// then wait for the processor to get initialized. Otherwise,</span>
00218         <span class="comment">// deallocate the processor resources and terminate the loop.</span>
00219         <span class="comment">//</span>
00220 
00221         Started = <a class="code" href="../../d2/d7/hal_8h.html#a197">HalStartNextProcessor</a>(<a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>, &amp;ProcessorState);
00222         <span class="keywordflow">if</span> (Started == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00223             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)MemoryBlock1);
00224             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)MemoryBlock2);
00225             <span class="keywordflow">break</span>;
00226 
00227         } <span class="keywordflow">else</span> {
00228 
00229             <span class="comment">//</span>
00230             <span class="comment">// Wait until boot is finished on the target processor before</span>
00231             <span class="comment">// starting the next processor. Booting is considered to be</span>
00232             <span class="comment">// finished when a processor completes its initialization and</span>
00233             <span class="comment">// drops into the idle loop.</span>
00234             <span class="comment">//</span>
00235 
00236             Prcb = (PKPRCB)(<a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o4">Prcb</a>);
00237             RestartBlock = Prcb-&gt;RestartBlock;
00238             <span class="keywordflow">while</span> (RestartBlock-&gt;BootStatus.BootFinished == 0) {
00239                 KiMb();
00240             }
00241         }
00242 
00243         Number += 1;
00244     }
00245 
00246 <span class="preprocessor">#endif</span>
00247 <span class="preprocessor"></span>
00248     <span class="comment">//</span>
00249     <span class="comment">// Reset and synchronize the performance counters of all processors, by</span>
00250     <span class="comment">// applying a null adjustment to the interrupt time</span>
00251     <span class="comment">//</span>
00252 
00253     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a8">KiAdjustInterruptTime</a>(0);
00254     <span class="keywordflow">return</span>;
00255 }
00256 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:14 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
