<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: context.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>context.c</h1><a href="../../d4/d6/rtl_2ia64_2context_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Module Name:</span>
00004 <span class="comment"></span>
00005 <span class="comment">    context.c</span>
00006 <span class="comment"></span>
00007 <span class="comment">Abstract:</span>
00008 <span class="comment"></span>
00009 <span class="comment">    This module implements user-mode callable context manipulation routines.</span>
00010 <span class="comment">    The interfaces exported from this module are portable, but they must</span>
00011 <span class="comment">    be re-implemented for each architecture.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment"></span>
00016 <span class="comment">Revision History:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    Ported to the IA64</span>
00019 <span class="comment"></span>
00020 <span class="comment">    27-Feb-1996   Revised to pass arguments to target thread by injecting</span>
00021 <span class="comment">                  arguments into the backing store.</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00026 <span class="preprocessor">#include "kxia64.h"</span>
00027 
00028 <span class="preprocessor">#if defined(ALLOC_PRAGMA) &amp;&amp; defined(NTOS_KERNEL_RUNTIME)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlInitializeContext)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlRemoteCall)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlSetIaToEmDebugReg)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlIaToEmDebugContext)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlEmToIaDebugContext)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00035 <span class="preprocessor"></span>
00036 
00037 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00038"></a><a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a0">00038</a> <a class="code" href="../../d6/d6/rtl_2ppc_2context_8c.html#a1">RtlInitializeContext</a>(
00039     IN HANDLE Process,
00040     OUT PCONTEXT Context,
00041     IN PVOID Parameter OPTIONAL,
00042     IN PVOID InitialPc OPTIONAL,
00043     IN PVOID InitialSp OPTIONAL
00044     )
00045 
00046 <span class="comment">/*++</span>
00047 <span class="comment"></span>
00048 <span class="comment">Routine Description:</span>
00049 <span class="comment"></span>
00050 <span class="comment">    This function initializes a context structure so that it can</span>
00051 <span class="comment">    be used in a subsequent call to NtCreateThread.</span>
00052 <span class="comment"></span>
00053 <span class="comment">Arguments:</span>
00054 <span class="comment"></span>
00055 <span class="comment">    Context - Supplies a context buffer to be initialized by this routine.</span>
00056 <span class="comment"></span>
00057 <span class="comment">    InitialPc - Supplies an initial program counter value.</span>
00058 <span class="comment"></span>
00059 <span class="comment">    InitialSp - Supplies an initial stack pointer value.</span>
00060 <span class="comment"></span>
00061 <span class="comment">Return Value:</span>
00062 <span class="comment"></span>
00063 <span class="comment">    Raises STATUS_BAD_INITIAL_STACK if the value of InitialSp is not properly</span>
00064 <span class="comment">           aligned.</span>
00065 <span class="comment"></span>
00066 <span class="comment">    Raises STATUS_BAD_INITIAL_PC if the value of InitialPc is not properly</span>
00067 <span class="comment">           aligned.</span>
00068 <span class="comment"></span>
00069 <span class="comment">--*/</span>
00070 
00071 {
00072     ULONGLONG Argument;
00073 
00074     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00075 
00076     <span class="comment">//</span>
00077     <span class="comment">// Check for proper initial stack (0 mod 16).</span>
00078     <span class="comment">//</span>
00079 
00080     <span class="keywordflow">if</span> (((ULONG_PTR)InitialSp &amp; 0xf) != 0) {
00081         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_BAD_INITIAL_STACK);
00082     }
00083 
00084     <span class="comment">//</span>
00085     <span class="comment">// Check for proper plabel address alignment.</span>
00086     <span class="comment">// Assumes InitialPc points to a plabel that must be 8-byte aligned.</span>
00087     <span class="comment">//</span>
00088 
00089     <span class="keywordflow">if</span> (((ULONG_PTR)InitialPc &amp; 0x7) != 0) {
00090         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_BAD_INITIAL_PC);
00091     }
00092 
00093     <span class="comment">//</span>
00094     <span class="comment">// Initialize the integer and floating registers to contain zeroes.</span>
00095     <span class="comment">//</span>
00096 
00097     RtlZeroMemory(Context, <span class="keyword">sizeof</span>(CONTEXT));
00098 
00099     <span class="comment">//</span>
00100     <span class="comment">// Setup integer and control context.</span>
00101     <span class="comment">//</span>
00102 
00103     Context-&gt;ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a> | <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>;
00104 
00105     Context-&gt;RsBSPSTORE = Context-&gt;IntSp = (ULONG_PTR)InitialSp;
00106     Context-&gt;IntSp -= STACK_SCRATCH_AREA;
00107 
00108     <span class="comment">//</span>
00109     <span class="comment">// InitialPc is the module entry point which is a function pointer</span>
00110     <span class="comment">// in IA64. StIIP and IntGp are initiailized with actual IP and GP</span>
00111     <span class="comment">// from the plabel in LdrInitializeThunk after the loader runs.</span>
00112     <span class="comment">//</span>
00113 
00114     Context-&gt;IntS0 = Context-&gt;StIIP = (ULONG_PTR)InitialPc;
00115     Context-&gt;IntGp = 0;
00116 
00117     <span class="comment">//</span>
00118     <span class="comment">// Setup FPSR, PSR, and DCR</span>
00119     <span class="comment">// N.B. Values to be determined.</span>
00120     <span class="comment">//</span>
00121 
00122     Context-&gt;StFPSR = USER_FPSR_INITIAL;
00123     Context-&gt;StIPSR = USER_PSR_INITIAL;
00124     Context-&gt;ApDCR = USER_DCR_INITIAL;
00125 
00126     <span class="comment">//</span>
00127     <span class="comment">// Set the initial context of the thread in a machine specific way.</span>
00128     <span class="comment">// ie, pass the initial parameter to the RSE by saving it at the</span>
00129     <span class="comment">// bottom of the backing store.</span>
00130     <span class="comment">//</span>
00131     <span class="comment">//  Setup Frame Marker after RFI</span>
00132     <span class="comment">//  And other RSE states.</span>
00133     <span class="comment">//</span>
00134 
00135     Argument = (ULONGLONG)Parameter;
00136     ZwWriteVirtualMemory(Process,
00137              (PVOID)((ULONG_PTR)Context-&gt;RsBSPSTORE),
00138              (PVOID)&amp;Argument,
00139              <span class="keyword">sizeof</span>(Argument),
00140              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00141 <span class="comment">//</span>
00142 <span class="comment">// N.b. The IFS must be reinitialized in LdrInitializeThunk</span>
00143 <span class="comment">//</span>
00144 
00145     Context-&gt;StIFS = 0x8000000000000081ULL;            <span class="comment">// Valid, 1 local register, 0 output register</span>
00146     Context-&gt;RsBSP = Context-&gt;RsBSPSTORE;
00147     Context-&gt;RsRSC = USER_RSC_INITIAL;
00148     Context-&gt;ApUNAT = 0xFFFFFFFFFFFFFFFF;
00149 }
00150 
00151 
00152 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00153"></a><a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a1">00153</a> <a class="code" href="../../d6/d6/rtl_2ppc_2context_8c.html#a2">RtlRemoteCall</a>(
00154     HANDLE Process,
00155     HANDLE Thread,
00156     PVOID CallSite,
00157     ULONG ArgumentCount,
00158     PULONG_PTR Arguments,
00159     BOOLEAN PassContext,
00160     BOOLEAN AlreadySuspended
00161     )
00162 
00163 <span class="comment">/*++</span>
00164 <span class="comment"></span>
00165 <span class="comment">Routine Description:</span>
00166 <span class="comment"></span>
00167 <span class="comment">    This function calls a procedure in another thread/process, using</span>
00168 <span class="comment">    NtGetContext and NtSetContext.  Parameters are passed to the</span>
00169 <span class="comment">    target procedure via its stack.</span>
00170 <span class="comment"></span>
00171 <span class="comment">Arguments:</span>
00172 <span class="comment"></span>
00173 <span class="comment">    Process - Handle of the target process</span>
00174 <span class="comment"></span>
00175 <span class="comment">    Thread - Handle of the target thread within that process</span>
00176 <span class="comment"></span>
00177 <span class="comment">    CallSite - Address of the procedure to call in the target process.</span>
00178 <span class="comment"></span>
00179 <span class="comment">    ArgumentCount - Number of parameters to pass to the target</span>
00180 <span class="comment">                    procedure.</span>
00181 <span class="comment"></span>
00182 <span class="comment">    Arguments - Pointer to the array of parameters to pass.</span>
00183 <span class="comment"></span>
00184 <span class="comment">    PassContext - TRUE if an additional parameter is to be passed that</span>
00185 <span class="comment">        points to a context record.</span>
00186 <span class="comment"></span>
00187 <span class="comment">    AlreadySuspended - TRUE if the target thread is already in a suspended</span>
00188 <span class="comment">                       or waiting state.</span>
00189 <span class="comment"></span>
00190 <span class="comment">Return Value:</span>
00191 <span class="comment"></span>
00192 <span class="comment">    Status - Status value</span>
00193 <span class="comment"></span>
00194 <span class="comment">--*/</span>
00195 
00196 {
00197     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00198     CONTEXT Context;
00199     ULONG_PTR ContextAddress;
00200     ULONG_PTR NewSp;
00201     ULONG_PTR NewBspStore;
00202     ULONGLONG ArgumentsCopy[10];
00203     PVOID ptr;
00204     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00205     ULONG ShiftCount;
00206     BOOLEAN RnatSaved = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00207 
00208 
00209     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00210 
00211     <span class="keywordflow">if</span> (ArgumentCount &gt; 8)
00212         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00213 
00214     <span class="comment">//</span>
00215     <span class="comment">// If necessary, suspend the guy before with we mess with his stack.</span>
00216     <span class="comment">//</span>
00217 
00218     <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00219         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/psspnd_8c.html#a0">NtSuspendThread</a>(Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00220         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00221             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00222         }
00223     }
00224 
00225     <span class="comment">//</span>
00226     <span class="comment">// Get the context record of the target thread.</span>
00227     <span class="comment">//</span>
00228 
00229     Context.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00230     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a2">NtGetContextThread</a>(Thread, &amp;Context);
00231     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00232         <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00233             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00234         }
00235         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00236     }
00237 
00238     <span class="keywordflow">if</span> (AlreadySuspended) {
00239         Context.IntV0 = STATUS_ALERTED;
00240     }
00241 
00242     <span class="comment">//</span>
00243     <span class="comment">// Pass the parameters to the other thread via the backing store (r32-r39).</span>
00244     <span class="comment">// The context record is passed on the stack of the target thread.</span>
00245     <span class="comment">// N.B. Align the context record address, stack pointer, and allocate</span>
00246     <span class="comment">//      stack scratch area.</span>
00247     <span class="comment">//</span>
00248 
00249     ContextAddress = (((ULONG_PTR)Context.IntSp + 0xf) &amp; 0xf) - <span class="keyword">sizeof</span>(CONTEXT);
00250     NewSp = ContextAddress - STACK_SCRATCH_AREA;
00251     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a>(Process, (PVOID)ContextAddress, &amp;Context,
00252                   <span class="keyword">sizeof</span>(CONTEXT), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00253 
00254     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00255         <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00256             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00257         }
00258         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00259     }
00260 
00261     RtlZeroMemory((PVOID)ArgumentsCopy, <span class="keyword">sizeof</span>(ArgumentsCopy));
00262     NewBspStore = (ULONG_PTR) Context.RsBSPSTORE;
00263 
00264     <span class="keywordflow">if</span> (PassContext) {
00265         <span class="keywordflow">if</span> ( (NewBspStore &amp; 0x1F8) == 0x1F8 ) {
00266             ArgumentsCopy[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++] = Context.RsRNAT;
00267             NewBspStore += <span class="keyword">sizeof</span>(ULONGLONG);
00268             RnatSaved = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00269         }
00270         ShiftCount = (ULONG) (NewBspStore &amp; 0x1F8) &gt;&gt; 3;
00271         Context.RsRNAT &amp;= ~(0x1 &lt;&lt; ShiftCount);
00272         ArgumentsCopy[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++] = ContextAddress;
00273         NewBspStore += <span class="keyword">sizeof</span>(ULONGLONG);
00274     }
00275 
00276     <span class="keywordflow">for</span> (; ArgumentCount != 0 ; ArgumentCount--) {
00277         <span class="keywordflow">if</span> ( (RnatSaved == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; ((NewBspStore &amp; 0x1F8) == 0x1F8) ) {
00278             ArgumentsCopy[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++] = Context.RsRNAT;
00279             NewBspStore += <span class="keyword">sizeof</span>(ULONGLONG);
00280             RnatSaved = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00281         }
00282         ShiftCount = (ULONG)(NewBspStore &amp; 0x1F8) &gt;&gt; 3;
00283         Context.RsRNAT &amp;= ~(0x1 &lt;&lt; ShiftCount);
00284         ArgumentsCopy[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++] = (ULONGLONG)(*Arguments++);
00285         NewBspStore += <span class="keyword">sizeof</span>(ULONGLONG);
00286     }
00287 
00288     <span class="keywordflow">if</span> ( (RnatSaved == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; ((NewBspStore &amp; 0x1F8) == 0x1F8) ) {
00289         ArgumentsCopy[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++] = Context.RsRNAT;
00290         NewBspStore += <span class="keyword">sizeof</span>(ULONGLONG);
00291     }
00292 
00293     <span class="comment">//</span>
00294     <span class="comment">//  Copy the arguments onto the target backing store.</span>
00295     <span class="comment">//</span>
00296 
00297     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>) {
00298         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a>(Process,
00299                                       (PVOID)Context.RsBSPSTORE,
00300                                       ArgumentsCopy,
00301                                       <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> * <span class="keyword">sizeof</span>(ULONGLONG),
00302                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00303                                       );
00304 
00305         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00306             <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00307                 <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00308             }
00309             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00310         }
00311     }
00312 
00313     <span class="comment">//</span>
00314     <span class="comment">// zero out loadrs, adjust RseStack</span>
00315     <span class="comment">//</span>
00316 
00317     Context.RsRSC = (RSC_MODE_LY&lt;&lt;RSC_MODE)
00318                    | (RSC_BE_LITTLE&lt;&lt;RSC_BE)
00319                    | (0x3&lt;&lt;RSC_PL);
00320 
00321     <span class="comment">//</span>
00322     <span class="comment">//  Setup argument numbers</span>
00323     <span class="comment">//</span>
00324 
00325     Context.StIFS = (ULONGLONG)<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;       <span class="comment">// # of arguments/size of frame</span>
00326     Context.RsBSP = Context.RsBSPSTORE;
00327 
00328     <span class="comment">//</span>
00329     <span class="comment">// Set the address of the target code into IIP, the new target stack</span>
00330     <span class="comment">// into sp, setup ap, and reload context to make it happen.</span>
00331     <span class="comment">//</span>
00332 
00333     Context.IntSp = (ULONG_PTR)NewSp;
00334 
00335     <span class="comment">//</span>
00336     <span class="comment">// We expect NtSetContext to get the real IP and GP for us</span>
00337     <span class="comment">//</span>
00338 
00339     Context.StIIP = (ULONG_PTR)CallSite;
00340 
00341     <span class="comment">//</span>
00342     <span class="comment">// sanitize the floating pointer status register</span>
00343     <span class="comment">//</span>
00344 
00345     SANITIZE_FSR(Context.StFPSR, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00346 
00347     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a3">NtSetContextThread</a>(Thread, &amp;Context);
00348     <span class="keywordflow">if</span> (!AlreadySuspended) {
00349         <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00350     }
00351 
00352     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00353 }
00354 
00355 
00356 <span class="keyword">static</span> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00357"></a><a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a2">00357</a> <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a2">RtlSetIaToEmDebugReg</a>(
00358     IN ULONG          Dr7_RW,
00359     IN ULONG          Dr7_Len,
00360     IN ULONG          Addr,
00361     IN OUT ULONGLONG *DbrAddr1,
00362     IN OUT ULONGLONG *DbrAddr2,
00363     IN OUT ULONGLONG *IbrAddr1,
00364     IN OUT ULONGLONG *IbrAddr2
00365     )
00366 
00367 <span class="comment">/*++</span>
00368 <span class="comment"></span>
00369 <span class="comment">Routine Description:</span>
00370 <span class="comment"></span>
00371 <span class="comment">    This function constructs the EM mode Debug Register Context</span>
00372 <span class="comment">    given iA mode debug Context as input.</span>
00373 <span class="comment"></span>
00374 <span class="comment">Arguments:</span>
00375 <span class="comment"></span>
00376 <span class="comment">    Dr7_RW     - Supplies iA mode context buffer including iA mode debug registers.</span>
00377 <span class="comment"></span>
00378 <span class="comment">    Dr7_Len    - Supplies the value of the iA mode CR4.</span>
00379 <span class="comment"></span>
00380 <span class="comment">    Addr       - Supplies a context buffer to be initialized by this routine.</span>
00381 <span class="comment"></span>
00382 <span class="comment">    DbrAddr1   - Address of first associated data        breakpoint register in set.</span>
00383 <span class="comment"></span>
00384 <span class="comment">    IbrAddr1   - Address of first associated instruction breakpoint register in set.</span>
00385 <span class="comment"></span>
00386 <span class="comment">Return Value:</span>
00387 <span class="comment"></span>
00388 <span class="comment">    None.</span>
00389 <span class="comment"></span>
00390 <span class="comment">    N.B. Currently EM Debug Registers are only stored on a thread switch. Activating the</span>
00391 <span class="comment">         EM debug context generated by this routine requires the EM debug registers to</span>
00392 <span class="comment">         be loaded in the context of the target thread.</span>
00393 <span class="comment"></span>
00394 <span class="comment">--*/</span>
00395 
00396 {
00397     ULONGLONG  mask;
00398 
00399     <span class="comment">// If length is undefined value, set it to zero.</span>
00400     <span class="keywordflow">if</span> (Dr7_Len == 2)
00401         Dr7_Len = 0;
00402 
00403     mask = (ULONGLONG) DBG_REG_MASK(Dr7_Len);
00404 
00405     <span class="keywordflow">switch</span>(Dr7_RW) {
00406         <span class="keywordflow">case</span> DR7_RW_IX:
00407             *DbrAddr1 = 0;
00408             *IbrAddr1 = (ULONGLONG)Addr;
00409             *DbrAddr2 = 0;
00410             *IbrAddr2 = (IBR_EX | DBG_REG_PLM_USER | DBG_REG_MASK(0));
00411             <span class="keywordflow">break</span>;
00412         <span class="keywordflow">case</span> DR7_RW_DW:
00413             *DbrAddr1 = (ULONGLONG)Addr;
00414             *IbrAddr1 = 0;
00415             *DbrAddr2 = (DBR_WR | DBG_REG_PLM_USER | mask);
00416             *IbrAddr2 = 0;
00417             <span class="keywordflow">break</span>;
00418         <span class="keywordflow">case</span> DR7_RW_IORW:
00419             *DbrAddr1 = (ULONGLONG)Addr;
00420             *IbrAddr1 = 0;
00421             *DbrAddr2 = (DBR_RDWR | DBG_REG_PLM_USER | mask);
00422             *IbrAddr2 = 0;
00423             <span class="keywordflow">break</span>;
00424         <span class="keywordflow">case</span> DR7_RW_DWR:
00425             *DbrAddr1 = (ULONGLONG)Addr;
00426             *IbrAddr1 = 0;
00427             *DbrAddr2 = (DBR_RDWR | DBG_REG_PLM_USER | mask);
00428             *IbrAddr2 = 0;
00429             <span class="keywordflow">break</span>;
00430         <span class="keywordflow">case</span> DR7_RW_DISABLE:
00431         <span class="keywordflow">default</span>:
00432             *DbrAddr1 = 0;
00433             *IbrAddr1 = 0;
00434             *DbrAddr2 = 0;
00435             *IbrAddr2 = 0;
00436     }
00437 
00438     <span class="keywordflow">return</span>;
00439 }
00440 
00441 
00442 BOOLEAN
<a name="l00443"></a><a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a3">00443</a> <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a3">RtlIaToEmDebugContext</a>(
00444     IN PCONTEXT86   ContextX86,
00445     IN OUT PCONTEXT ContextEM
00446     )
00447 
00448 <span class="comment">/*++</span>
00449 <span class="comment"></span>
00450 <span class="comment">Routine Description:</span>
00451 <span class="comment"></span>
00452 <span class="comment">    This function constructs the EM mode Debug Register Context given iA mode</span>
00453 <span class="comment">    debug Context as input. The EM debug control bits in the PSR are set based</span>
00454 <span class="comment">    on the iA mode context.</span>
00455 <span class="comment"></span>
00456 <span class="comment">Arguments:</span>
00457 <span class="comment"></span>
00458 <span class="comment">    ContextX86 - Supplies iA mode context buffer including iA mode debug registers.</span>
00459 <span class="comment"></span>
00460 <span class="comment">    ContextEM  - Supplies a EM mode context buffer to be initialized by this routine.</span>
00461 <span class="comment"></span>
00462 <span class="comment">Return Value:</span>
00463 <span class="comment"></span>
00464 <span class="comment">    FALSE   - No context returned, based on input debugging is not active.</span>
00465 <span class="comment">    TRUE    - EM Debug Context returned.</span>
00466 <span class="comment"></span>
00467 <span class="comment">    N.B. Currently EM Debug Registers are only stored on a thread switch. Activating the</span>
00468 <span class="comment">         EM debug context generated by this routine requires the EM debug registers to</span>
00469 <span class="comment">         be loaded in the context of the target thread.</span>
00470 <span class="comment"></span>
00471 <span class="comment">--*/</span>
00472 
00473 {
00474     ULONG Dr7 = ContextX86-&gt;Dr7;
00475 
00476     <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a2">RtlSetIaToEmDebugReg</a>(DR7_DB0_RW(Dr7), 
00477                          DR7_DB0_LEN(Dr7), 
00478                          DR_ADDR_L0(ContextX86-&gt;Dr0),
00479                          &amp;ContextEM-&gt;DbD0, 
00480                          &amp;ContextEM-&gt;DbD1, 
00481                          &amp;ContextEM-&gt;DbI0, 
00482                          &amp;ContextEM-&gt;DbI1);
00483 
00484     <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a2">RtlSetIaToEmDebugReg</a>(DR7_DB1_RW(Dr7), 
00485                          DR7_DB1_LEN(Dr7), 
00486                          DR_ADDR_L1(ContextX86-&gt;Dr1),
00487                          &amp;ContextEM-&gt;DbD2, 
00488                          &amp;ContextEM-&gt;DbD3, 
00489                          &amp;ContextEM-&gt;DbI2, 
00490                          &amp;ContextEM-&gt;DbI3);
00491 
00492     <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a2">RtlSetIaToEmDebugReg</a>(DR7_DB2_RW(Dr7), 
00493                          DR7_DB2_LEN(Dr7), 
00494                          DR_ADDR_L2(ContextX86-&gt;Dr2),
00495                          &amp;ContextEM-&gt;DbD4, 
00496                          &amp;ContextEM-&gt;DbD5, 
00497                          &amp;ContextEM-&gt;DbI4, 
00498                          &amp;ContextEM-&gt;DbI5);
00499 
00500     <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a2">RtlSetIaToEmDebugReg</a>(DR7_DB3_RW(Dr7), 
00501                          DR7_DB3_LEN(Dr7), 
00502                          DR_ADDR_L3(ContextX86-&gt;Dr3),
00503                          &amp;ContextEM-&gt;DbD6, 
00504                          &amp;ContextEM-&gt;DbD7, 
00505                          &amp;ContextEM-&gt;DbI6, 
00506                          &amp;ContextEM-&gt;DbI7);
00507 
00508     <span class="comment">//</span>
00509     <span class="comment">// Check to see if Debugging is enabled or disabled.</span>
00510     <span class="comment">//</span>
00511     <span class="keywordflow">if</span> (DR7_L0(Dr7) || DR7_L1(Dr7) || DR7_L2(Dr7) || DR7_L3(Dr7))
00512     {
00513         ContextEM-&gt;StIPSR &amp;= ~(PSR_DEBUG_SET);
00514         ContextEM-&gt;StIPSR |=  (1 &lt;&lt; PSR_DB);
00515     } <span class="keywordflow">else</span> {
00516         ContextEM-&gt;StIPSR &amp;= ~(PSR_DEBUG_SET);
00517         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00518     }
00519 
00520     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00521 }
00522 
00523 
00524 BOOLEAN
<a name="l00525"></a><a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a4">00525</a> <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a4">RtlEmToIaDebugContext</a>(
00526     IN PCONTEXT       ContextEM,
00527     IN OUT PCONTEXT86 ContextX86
00528     )
00529 
00530 <span class="comment">/*++</span>
00531 <span class="comment"></span>
00532 <span class="comment">Routine Description:</span>
00533 <span class="comment"></span>
00534 <span class="comment">    This function constructs the iA mode Debug Register Context</span>
00535 <span class="comment">    given EM mode debug Context as input.</span>
00536 <span class="comment"></span>
00537 <span class="comment">Arguments:</span>
00538 <span class="comment"></span>
00539 <span class="comment">    ContextEM  - Supplies EM mode context buffer including EM mode debug registers.</span>
00540 <span class="comment"></span>
00541 <span class="comment">    ContextX86 - Supplies a iA mode context buffer to be initialized by this routine.</span>
00542 <span class="comment"></span>
00543 <span class="comment">Return Value:</span>
00544 <span class="comment"></span>
00545 <span class="comment"></span>
00546 <span class="comment">    FALSE   - No context returned, based on input debugging is not active.</span>
00547 <span class="comment">    TRUE    - EM Debug Context returned.</span>
00548 <span class="comment"></span>
00549 <span class="comment">    N.B. Assumes that the thread's virtual iA mode Debug Registers reflects</span>
00550 <span class="comment">         the current debug context. The kernel must keep the field DebugIaDr6 and</span>
00551 <span class="comment">         DebugIaDr7 up to date.</span>
00552 <span class="comment"></span>
00553 <span class="comment">    TBD How do we set DR6? From Status, what status? Probably should be set by exception</span>
00554 <span class="comment">        handler.</span>
00555 <span class="comment"></span>
00556 <span class="comment">--*/</span>
00557 
00558 {
00559     <span class="comment">//</span>
00560     <span class="comment">// Check to see if Debugging is enabled or disabled.</span>
00561     <span class="comment">//</span>
00562 
00563     <span class="comment">// Translate Dr0 from either DbD0-1 or DbI0-1</span>
00564     SET_DR7_L0(ContextX86-&gt;Dr7);
00565 
00566     SET_DR7_DB0_RW(ContextX86-&gt;Dr7, DBG_EM_ENABLE_TO_IA_RW(ContextEM-&gt;DbD1, ContextEM-&gt;DbI1));
00567     SET_DR7_DB0_LEN(ContextX86-&gt;Dr7, DBG_EM_MASK_TO_IA_LEN(ContextEM-&gt;DbD1, ContextEM-&gt;DbI1));
00568     ContextX86-&gt;Dr0 = DBG_EM_ADDR_TO_IA_ADDR(ContextEM-&gt;DbD0, ContextEM-&gt;DbI0);
00569 
00570     <span class="comment">// Translate Dr1 from either DbD2-3 or DbI2-3</span>
00571     SET_DR7_L1(ContextX86-&gt;Dr7);
00572     SET_DR7_DB1_RW(ContextX86-&gt;Dr7, DBG_EM_ENABLE_TO_IA_RW(ContextEM-&gt;DbD3, ContextEM-&gt;DbI3));
00573     SET_DR7_DB1_LEN(ContextX86-&gt;Dr7, DBG_EM_MASK_TO_IA_LEN(ContextEM-&gt;DbD3, ContextEM-&gt;DbI3));
00574     ContextX86-&gt;Dr1 = DBG_EM_ADDR_TO_IA_ADDR(ContextEM-&gt;DbD2, ContextEM-&gt;DbI2);
00575 
00576     <span class="comment">// Translate Dr2 from either DbD4-5 or DbI4-5</span>
00577     SET_DR7_L2(ContextX86-&gt;Dr7);
00578     SET_DR7_DB2_RW(ContextX86-&gt;Dr7, DBG_EM_ENABLE_TO_IA_RW(ContextEM-&gt;DbD5, ContextEM-&gt;DbI5));
00579     SET_DR7_DB2_LEN(ContextX86-&gt;Dr7, DBG_EM_MASK_TO_IA_LEN(ContextEM-&gt;DbD5, ContextEM-&gt;DbI5));
00580     ContextX86-&gt;Dr2 = DBG_EM_ADDR_TO_IA_ADDR(ContextEM-&gt;DbD4, ContextEM-&gt;DbI4);
00581 
00582     <span class="comment">// Translate Dr3 from either DbD6-7 or DbI6-7</span>
00583     SET_DR7_L3(ContextX86-&gt;Dr7);
00584     SET_DR7_DB3_RW(ContextX86-&gt;Dr7, DBG_EM_ENABLE_TO_IA_RW(ContextEM-&gt;DbD7, ContextEM-&gt;DbI7));
00585     SET_DR7_DB3_LEN(ContextX86-&gt;Dr7, DBG_EM_MASK_TO_IA_LEN(ContextEM-&gt;DbD7, ContextEM-&gt;DbI7));
00586     ContextX86-&gt;Dr3 = DBG_EM_ADDR_TO_IA_ADDR(ContextEM-&gt;DbD6, ContextEM-&gt;DbI6);
00587 
00588     <span class="keywordflow">if</span> (!(DR7_L0(ContextX86-&gt;Dr7) || DR7_L1(ContextX86-&gt;Dr7) 
00589             || DR7_L2(ContextX86-&gt;Dr7) || DR7_L3(ContextX86-&gt;Dr7)))
00590         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00591     <span class="keywordflow">else</span>
00592         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00593 }
00594 
00595 
00596 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00597"></a><a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a5">00597</a> <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a5">RtlEmToX86Context</a>(
00598     IN PCONTEXT ContextEm,
00599     IN OUT PCONTEXT86 ContextX86
00600     )
00601 {
00602     ContextX86-&gt;ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a> | CONTEXT_X86;
00603 
00604     <span class="comment">//</span>
00605     <span class="comment">// TBD: How to transfer the remaining floating point states from EM</span>
00606     <span class="comment">//      context record to the floating save area in iA context record.</span>
00607     <span class="comment">//</span>
00608 
00609     RtlEmFpToIaFpContext(&amp;ContextEm-&gt;FltT2, &amp;ContextX86-&gt;FloatSave);
00610     <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a4">RtlEmToIaDebugContext</a>(ContextEm, ContextX86);
00611 
00612     ContextX86-&gt;SegGs = (ULONG)ContextEm-&gt;IntT20;
00613     ContextX86-&gt;SegFs = (ULONG)ContextEm-&gt;IntT19;
00614     ContextX86-&gt;SegEs = (ULONG)ContextEm-&gt;IntT15;
00615     ContextX86-&gt;SegDs = (ULONG)ContextEm-&gt;IntT18;
00616     ContextX86-&gt;Edi = (ULONG)ContextEm-&gt;IntT6;
00617     ContextX86-&gt;Esi = (ULONG)ContextEm-&gt;IntT5;
00618     ContextX86-&gt;Ebx = (ULONG)ContextEm-&gt;IntT4;
00619     ContextX86-&gt;Edx = (ULONG)ContextEm-&gt;IntT3;
00620     ContextX86-&gt;Ecx = (ULONG)ContextEm-&gt;IntT2;
00621     ContextX86-&gt;Eax = (ULONG)ContextEm-&gt;IntV0;
00622     ContextX86-&gt;Ebp = (ULONG)ContextEm-&gt;IntTeb;
00623     ContextX86-&gt;Eip = (ULONG)ContextEm-&gt;StIIP;
00624     ContextX86-&gt;SegCs = (ULONG)ContextEm-&gt;SegCSD;      <span class="comment">// ContextEm-&gt;IntT16;</span>
00625     ContextX86-&gt;EFlags = (ULONG)ContextEm-&gt;Eflag;
00626     ContextX86-&gt;Esp = (ULONG)ContextEm-&gt;IntSp;
00627     ContextX86-&gt;SegSs = (ULONG)ContextEm-&gt;SegSSD;      <span class="comment">// ContextEm-&gt;IntT17;</span>
00628 }
00629 
00630 
00631 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00632"></a><a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a6">00632</a> <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a6">RtlX86ToEmContext</a>(
00633     IN PCONTEXT86 ContextX86,
00634     IN OUT PCONTEXT ContextEm
00635     )
00636 {
00637     FLOAT128 FpWorkArea;
00638 
00639     ContextEm-&gt;ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a> | CONTEXT_IA64;
00640 
00641     RtlIaFpToEmFpContext((PVOID)&amp;ContextX86-&gt;FloatSave,
00642                          &amp;ContextEm-&gt;FltT2,
00643                          &amp;FpWorkArea);
00644     <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a3">RtlIaToEmDebugContext</a>(ContextX86, ContextEm);
00645 
00646     ContextEm-&gt;IntT20 = ContextX86-&gt;SegGs;
00647     ContextEm-&gt;IntT19 = ContextX86-&gt;SegFs;
00648     ContextEm-&gt;IntT15 = ContextX86-&gt;SegEs;
00649     ContextEm-&gt;IntT18 = ContextX86-&gt;SegDs;
00650     ContextEm-&gt;IntT6 = ContextX86-&gt;Edi;
00651     ContextEm-&gt;IntT5 = ContextX86-&gt;Esi;
00652     ContextEm-&gt;IntT4 = ContextX86-&gt;Ebx;
00653     ContextEm-&gt;IntT3 = ContextX86-&gt;Edx;
00654     ContextEm-&gt;IntT2 = ContextX86-&gt;Ecx;
00655     ContextEm-&gt;IntV0 = ContextX86-&gt;Eax;
00656     ContextEm-&gt;IntTeb = ContextX86-&gt;Ebp;
00657     ContextEm-&gt;StIIP = ContextX86-&gt;Eip;
00658     ContextEm-&gt;SegCSD = ContextX86-&gt;SegCs;
00659     ContextEm-&gt;Eflag = ContextX86-&gt;EFlags;
00660     ContextEm-&gt;IntSp = ContextX86-&gt;Esp;
00661     ContextEm-&gt;SegSSD = ContextX86-&gt;SegSs;
00662 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
