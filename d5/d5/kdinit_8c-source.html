<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kdinit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdinit.c</h1><a href="../../d4/d6/kdinit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    kdinit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the initialization for the portable kernel debgger.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    David N. Cutler 27-July-1990</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d0/d7/kdp_8h.html">kdp.h</a>"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">// Miscellaneous data from all over the kernel</span>
00025 <span class="comment">//</span>
00026 
<a name="l00027"></a><a class="code" href="../../d4/d6/kdinit_8c.html#a0">00027</a> <span class="preprocessor">#define BAUD_OPTION "BAUDRATE"</span>
<a name="l00028"></a><a class="code" href="../../d4/d6/kdinit_8c.html#a1">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define PORT_OPTION "DEBUGPORT"</span>
00029 <span class="preprocessor"></span>
00030 
00031 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdInitSystem)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00034 <span class="preprocessor"></span>
00035 BOOLEAN
<a name="l00036"></a><a class="code" href="../../d4/d6/kdinit_8c.html#a2">00036</a> <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a4">KdInitSystem</a>(
00037     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock OPTIONAL,
00038     BOOLEAN StopInDebugger
00039     )
00040 
00041 <span class="comment">/*++</span>
00042 <span class="comment"></span>
00043 <span class="comment">Routine Description:</span>
00044 <span class="comment"></span>
00045 <span class="comment">    This routine initializes the portable kernel debugger.</span>
00046 <span class="comment"></span>
00047 <span class="comment">Arguments:</span>
00048 <span class="comment"></span>
00049 <span class="comment">    LoaderBlock - Supplies a pointer to the LOADER_PARAMETER_BLOCK passed</span>
00050 <span class="comment">        in from the OS Loader.</span>
00051 <span class="comment"></span>
00052 <span class="comment">    StopInDebugger - Supplies a boolean value that determines whether a</span>
00053 <span class="comment">        debug message and breakpoint are generated.</span>
00054 <span class="comment"></span>
00055 <span class="comment">Return Value:</span>
00056 <span class="comment"></span>
00057 <span class="comment">    None.</span>
00058 <span class="comment"></span>
00059 <span class="comment">--*/</span>
00060 
00061 {
00062 
00063     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00064     BOOLEAN Initialize;
00065     PCHAR Options;
00066     PCHAR BaudOption;
00067     PCHAR PortOption;
00068 
00069     <span class="comment">//</span>
00070     <span class="comment">// If kernel debugger is already initialized, then return.</span>
00071     <span class="comment">//</span>
00072 
00073     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00074         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00075     }
00076 
00077     <a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> = <a class="code" href="../../d7/d8/alpha_2kdtrap_8c.html#a2">KdpStub</a>;
00078 
00079     <span class="comment">//</span>
00080     <span class="comment">// Determine whether or not the debugger should be enabled.</span>
00081     <span class="comment">//</span>
00082     <span class="comment">// Note that if LoaderBlock == NULL, then KdInitSystem was called</span>
00083     <span class="comment">// from BugCheck code. For this case the debugger is always enabled</span>
00084     <span class="comment">// to report the bugcheck if possible.</span>
00085     <span class="comment">//</span>
00086 
00087     <span class="keywordflow">if</span> (LoaderBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00088 
00089         <a class="code" href="../../d8/d5/kddata_8c.html#a94">KdpNtosImageBase</a> =  CONTAINING_RECORD(
00090                                     (LoaderBlock-&gt;LoadOrderListHead.Flink),
00091                                     LDR_DATA_TABLE_ENTRY,
00092                                     InLoadOrderLinks)-&gt;DllBase;
00093 
00094         <span class="comment">//</span>
00095         <span class="comment">// Initialize the debugger data block list when called at startup time.</span>
00096         <span class="comment">//</span>
00097 
00098         InitializeListHead(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>);
00099 
00100         <span class="comment">//</span>
00101         <span class="comment">// Fill in and register the debugger's debugger data block.</span>
00102         <span class="comment">// Most fields are already initialized, some fields will not be</span>
00103         <span class="comment">// filled in until later.</span>
00104         <span class="comment">//</span>
00105 
00106         <a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>.KernBase = (ULONG_PTR) <a class="code" href="../../d8/d5/kddata_8c.html#a94">KdpNtosImageBase</a>;
00107         <a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>.KeUserCallbackDispatcher = (ULONG_PTR) <a class="code" href="../../d4/d9/ke_8h.html#a149">KeUserCallbackDispatcher</a>;
00108 
00109         <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a5">KdRegisterDebuggerDataBlock</a>(KDBG_TAG,
00110                                     &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>.Header,
00111                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>));
00112 
00113         <span class="keywordflow">if</span> (LoaderBlock-&gt;LoadOptions != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00114             Options = LoaderBlock-&gt;LoadOptions;
00115             _strupr(Options);
00116 
00117             <span class="comment">//</span>
00118             <span class="comment">// If any of the port option, baud option, or debug is specified,</span>
00119             <span class="comment">// then enable the debugger unless it is explictly disabled.</span>
00120             <span class="comment">//</span>
00121 
00122             Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00123             PortOption = strstr(Options, <a class="code" href="../../d4/d6/kdinit_8c.html#a1">PORT_OPTION</a>);
00124             BaudOption = strstr(Options, <a class="code" href="../../d4/d6/kdinit_8c.html#a0">BAUD_OPTION</a>);
00125             <span class="keywordflow">if</span> ((PortOption == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (BaudOption == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00126                 <span class="keywordflow">if</span> (strstr(Options, <span class="stringliteral">"DEBUG"</span>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00127                     Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00128                 }
00129 
00130             } <span class="keywordflow">else</span> {
00131                 <span class="keywordflow">if</span> (PortOption) {
00132                     PortOption = strstr(PortOption, <span class="stringliteral">"COM"</span>);
00133                     <span class="keywordflow">if</span> (PortOption) {
00134                         <a class="code" href="../../d7/d3/kd_8h.html#a14">KdDebugParameters</a>.<a class="code" href="../../d0/d2/struct__DEBUG__PARAMETERS.html#o0">CommunicationPort</a> =
00135                                                      atol(PortOption + 3);
00136                     }
00137                 }
00138 
00139                 <span class="keywordflow">if</span> (BaudOption) {
00140                     BaudOption += <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(<a class="code" href="../../d4/d6/kdinit_8c.html#a0">BAUD_OPTION</a>);
00141                     <span class="keywordflow">while</span> (*BaudOption == <span class="charliteral">' '</span>) {
00142                         BaudOption++;
00143                     }
00144 
00145                     <span class="keywordflow">if</span> (*BaudOption != <span class="charliteral">'\0'</span>) {
00146                         <a class="code" href="../../d7/d3/kd_8h.html#a14">KdDebugParameters</a>.<a class="code" href="../../d0/d2/struct__DEBUG__PARAMETERS.html#o1">BaudRate</a> = atol(BaudOption + 1);
00147                     }
00148                 }
00149             }
00150 
00151             <span class="comment">//</span>
00152             <span class="comment">// If the debugger is explicitly disabled, then set to NODEBUG.</span>
00153             <span class="comment">//</span>
00154 
00155             <span class="keywordflow">if</span> (strstr(Options, <span class="stringliteral">"NODEBUG"</span>)) {
00156                 Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00157                 <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00158             }
00159 
00160             <span class="keywordflow">if</span> (strstr(Options, <span class="stringliteral">"CRASHDEBUG"</span>)) {
00161                 Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00162                 <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00163             }
00164 
00165         } <span class="keywordflow">else</span> {
00166 
00167             <span class="comment">//</span>
00168             <span class="comment">// If the load options are not specified, then set to NODEBUG.</span>
00169             <span class="comment">//</span>
00170 
00171             <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00172             Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00173         }
00174 
00175     } <span class="keywordflow">else</span> {
00176         Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00177     }
00178 
00179     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d7/hal_8h.html#a199">KdPortInitialize</a>(&amp;<a class="code" href="../../d7/d3/kd_8h.html#a14">KdDebugParameters</a>, LoaderBlock, Initialize) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00180         (Initialize == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00181         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00182     }
00183 
00184     <span class="comment">//</span>
00185     <span class="comment">// Set address of kernel debugger trap routine.</span>
00186     <span class="comment">//</span>
00187 
00188     <a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> = <a class="code" href="../../d7/d8/alpha_2kdtrap_8c.html#a0">KdpTrap</a>;
00189 
00190     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d5/kddata_8c.html#a107">KdpDebuggerStructuresInitialized</a>) {
00191 
00192         <a class="code" href="../../d0/d7/kdp_8h.html#a25">KiDebugSwitchRoutine</a> = <a class="code" href="../../d8/d3/kdapi_8c.html#a30">KdpSwitchProcessor</a>;
00193         <a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a6">KDP_BREAKPOINT_VALUE</a>;
00194         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00195 
00196         <span class="comment">//</span>
00197         <span class="comment">// Initialize the breakpoint table.</span>
00198         <span class="comment">//</span>
00199 
00200         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00201             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = 0;
00202             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00203             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o1">DirectoryTableBase</a> = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00204         }
00205 
00206         <span class="comment">//</span>
00207         <span class="comment">// Initialize TimeSlip</span>
00208         <span class="comment">//</span>
00209         <a class="code" href="../../d4/d1/dpcobj_8c.html#a1">KeInitializeDpc</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a100">KdpTimeSlipDpc</a>, <a class="code" href="../../d8/d3/kdapi_8c.html#a19">KdpTimeSlipDpcRoutine</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00210         <a class="code" href="../../d3/d2/timerobj_8c.html#a1">KeInitializeTimer</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a102">KdpTimeSlipTimer</a>);
00211         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a101">KdpTimeSlipWorkItem</a>, <a class="code" href="../../d8/d3/kdapi_8c.html#a20">KdpTimeSlipWork</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00212 
00213         <a class="code" href="../../d8/d5/kddata_8c.html#a107">KdpDebuggerStructuresInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
00214     }
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">//  Initialize timer facility - HACKHACK</span>
00218     <span class="comment">//</span>
00219 
00220     <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a55">KdPerformanceCounterRate</a>);
00221     <a class="code" href="../../d8/d5/kddata_8c.html#a56">KdTimerStart</a>.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00222     <a class="code" href="../../d8/d5/kddata_8c.html#a56">KdTimerStart</a>.LowPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00223 
00224     <span class="comment">//</span>
00225     <span class="comment">// Initialize ID for NEXT packet to send and Expect ID of next incoming</span>
00226     <span class="comment">// packet.</span>
00227     <span class="comment">//</span>
00228 
00229     <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> = INITIAL_PACKET_ID | SYNC_PACKET_ID;
00230     <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> = INITIAL_PACKET_ID;
00231 
00232     <span class="comment">//</span>
00233     <span class="comment">// Mark debugger enabled.</span>
00234     <span class="comment">//</span>
00235     <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00236     <a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00237     SharedUserData-&gt;KdDebuggerEnabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00238 
00239     <span class="comment">//</span>
00240     <span class="comment">// If requested, stop in the kernel debugger.</span>
00241     <span class="comment">//</span>
00242 
00243     <span class="keywordflow">if</span> (StopInDebugger) {
00244         DbgBreakPoint();
00245     }
00246 
00247     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00248 }
00249 
00250 
00251 BOOLEAN
<a name="l00252"></a><a class="code" href="../../d4/d6/kdinit_8c.html#a3">00252</a> <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a5">KdRegisterDebuggerDataBlock</a>(
00253     IN ULONG Tag,
00254     IN PDBGKD_DEBUG_DATA_HEADER DataHeader,
00255     IN ULONG Size
00256     )
00257 <span class="comment">/*++</span>
00258 <span class="comment"></span>
00259 <span class="comment">Routine Description:</span>
00260 <span class="comment"></span>
00261 <span class="comment">    This routine is called by a component or driver to register a</span>
00262 <span class="comment">    debugger data block.  The data block is made accessible to the</span>
00263 <span class="comment">    kernel debugger, thus providing a reliable method of exposing</span>
00264 <span class="comment">    random data to debugger extensions.</span>
00265 <span class="comment"></span>
00266 <span class="comment">Arguments:</span>
00267 <span class="comment"></span>
00268 <span class="comment">    Tag - Supplies a unique 4 byte tag which is used to identify the</span>
00269 <span class="comment">            data block.</span>
00270 <span class="comment"></span>
00271 <span class="comment">    DataHeader - Supplies the address of the debugger data block header.</span>
00272 <span class="comment">            The OwnerTag field must contain a unique value, and the Size</span>
00273 <span class="comment">            field must contain the size of the data block, including the</span>
00274 <span class="comment">            header.  If this block is already present, or there is</span>
00275 <span class="comment">            already a block with the same value for OwnerTag, this one</span>
00276 <span class="comment">            will not be inserted.  If Size is incorrect, this code will</span>
00277 <span class="comment">            not notice, but the usermode side of the debugger might not</span>
00278 <span class="comment">            function correctly.</span>
00279 <span class="comment"></span>
00280 <span class="comment">    Size - Supplies the size of the data block, including the header.</span>
00281 <span class="comment"></span>
00282 <span class="comment">Return Value:</span>
00283 <span class="comment"></span>
00284 <span class="comment">    TRUE if the block was added to the list, FALSE if not.</span>
00285 <span class="comment"></span>
00286 <span class="comment">--*/</span>
00287 {
00288     KIRQL OldIrql;
00289     PLIST_ENTRY <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00290     PDBGKD_DEBUG_DATA_HEADER <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00291 
00292     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a96">KdpDataSpinLock</a>, &amp;OldIrql);
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">// Look for a record with the same tag or address</span>
00296     <span class="comment">//</span>
00297 
00298     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>.Flink;
00299 
00300     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> != &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>) {
00301 
00302         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>, DBGKD_DEBUG_DATA_HEADER, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
00303 
00304         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Flink;
00305 
00306         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> == DataHeader) || (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;OwnerTag == Tag)) {
00307             <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a96">KdpDataSpinLock</a>, OldIrql);
00308             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00309         }
00310     }
00311 
00312     <span class="comment">//</span>
00313     <span class="comment">// It wasn't already there, so add it.</span>
00314     <span class="comment">//</span>
00315 
00316     DataHeader-&gt;OwnerTag = Tag;
00317     DataHeader-&gt;Size = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00318 
00319     InsertTailList(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>, &amp;DataHeader-&gt;List);
00320 
00321     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a96">KdpDataSpinLock</a>, OldIrql);
00322 
00323     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00324 }
00325 
00326 
00327 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00328"></a><a class="code" href="../../d4/d6/kdinit_8c.html#a4">00328</a> <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a6">KdDeregisterDebuggerDataBlock</a>(
00329     IN PDBGKD_DEBUG_DATA_HEADER DataHeader
00330     )
00331 <span class="comment">/*++</span>
00332 <span class="comment"></span>
00333 <span class="comment">Routine Description:</span>
00334 <span class="comment"></span>
00335 <span class="comment">    This routine is called to deregister a data block previously</span>
00336 <span class="comment">    registered with KdRegisterDebuggerDataBlock.  If the block is</span>
00337 <span class="comment">    found in the list, it is removed.</span>
00338 <span class="comment"></span>
00339 <span class="comment">Arguments:</span>
00340 <span class="comment"></span>
00341 <span class="comment">    DataHeader - Supplies the address of the data block which is</span>
00342 <span class="comment">                to be removed from the list.</span>
00343 <span class="comment"></span>
00344 <span class="comment">Return Value:</span>
00345 <span class="comment"></span>
00346 <span class="comment">    None</span>
00347 <span class="comment"></span>
00348 <span class="comment">--*/</span>
00349 
00350 {
00351     KIRQL OldIrql;
00352     PLIST_ENTRY <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00353     PDBGKD_DEBUG_DATA_HEADER <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00354 
00355     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a96">KdpDataSpinLock</a>, &amp;OldIrql);
00356 
00357     <span class="comment">//</span>
00358     <span class="comment">// Make sure the data block is on our list before removing it.</span>
00359     <span class="comment">//</span>
00360 
00361     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>.Flink;
00362 
00363     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> != &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>) {
00364 
00365         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>, DBGKD_DEBUG_DATA_HEADER, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
00366         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Flink;
00367 
00368         <span class="keywordflow">if</span> (DataHeader == <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>) {
00369             RemoveEntryList(&amp;DataHeader-&gt;List);
00370             <span class="keywordflow">break</span>;
00371         }
00372     }
00373 
00374     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a96">KdpDataSpinLock</a>, OldIrql);
00375 }
00376 
00377 
00378 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00379"></a><a class="code" href="../../d4/d6/kdinit_8c.html#a5">00379</a> <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a7">KdLogDbgPrint</a>(
00380     IN PSTRING String
00381     )
00382 {
00383     KIRQL OldIrql;
00384     ULONG Length;
00385     ULONG LengthCopied;
00386 
00387     <span class="keywordflow">for</span> (; ;) {
00388         <span class="keywordflow">if</span> (KeTestSpinLock (&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a49">KdpPrintSpinLock</a>)) {
00389             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a57">HIGH_LEVEL</a>, &amp;OldIrql);
00390             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/ki_8h.html#a155">KiTryToAcquireSpinLock</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a49">KdpPrintSpinLock</a>)) {
00391                 <span class="keywordflow">break</span>;          <span class="comment">// got the lock</span>
00392             }
00393             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00394         }
00395     }
00396 
00397     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>) {
00398         Length = <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length;
00399         <span class="comment">//</span>
00400         <span class="comment">// truncate ridiculous strings</span>
00401         <span class="comment">//</span>
00402         <span class="keywordflow">if</span> (Length &gt; <a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>) {
00403             Length = <a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>;
00404         }
00405 
00406         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> + Length &lt;= <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>+<a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>) {
00407             LengthCopied = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a>, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer, Length);
00408             <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> += LengthCopied;
00409             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> &gt;= <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>+<a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>) {
00410                 <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>;
00411                 <a class="code" href="../../d8/d5/kddata_8c.html#a48">KdPrintRolloverCount</a>++;
00412             }
00413         } <span class="keywordflow">else</span> {
00414             ULONG First = (ULONG)(<a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a> + <a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a> - <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a>);
00415             LengthCopied = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a>,
00416                                          <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer,
00417                                          First);
00418             <span class="keywordflow">if</span> (LengthCopied == First) {
00419                 LengthCopied += <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>,
00420                                               <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer + First,
00421                                               Length - First);
00422             }
00423             <span class="keywordflow">if</span> (LengthCopied &gt; First) {
00424                 <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a> + LengthCopied - First;
00425                 <a class="code" href="../../d8/d5/kddata_8c.html#a48">KdPrintRolloverCount</a>++;
00426             } <span class="keywordflow">else</span> {
00427                 <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> += LengthCopied;
00428                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> &gt;= <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>+<a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>) {
00429                     <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>;
00430                     <a class="code" href="../../d8/d5/kddata_8c.html#a48">KdPrintRolloverCount</a>++;
00431                 }
00432             }
00433         }
00434     }
00435 
00436     KiReleaseSpinLock(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a49">KdpPrintSpinLock</a>);
00437     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00438 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
