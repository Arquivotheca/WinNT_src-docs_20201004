<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: 4/alpha/kdcpuapi.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdcpuapi.c File Reference</h1><code>#include "<a class="el" href="../../d2/d6/4_2kdp_8h-source.html">kdp.h</a>"</code><br>
<code>#include "kxalpha.h"</code><br>

<p>
<a href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a0">HEADER_FILE</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a1">KdpSetLoadState</a> (IN PDBGKD_WAIT_STATE_CHANGE64 WaitStateChange, IN PCONTEXT ContextRecord)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a2">KdpSetStateChange</a> (IN PDBGKD_WAIT_STATE_CHANGE64 WaitStateChange, IN PEXCEPTION_RECORD ExceptionRecord, IN PCONTEXT ContextRecord, IN BOOLEAN SecondChance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a3">KdpGetStateChange</a> (IN PDBGKD_MANIPULATE_STATE64 ManipulateState, IN PCONTEXT ContextRecord)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a4">KdpReadControlSpace</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a5">KdpWriteControlSpace</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a6">KdpReadIoSpace</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a7">KdpReadIoSpaceExtended</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a8">KdpWriteIoSpace</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a9">KdpWriteIoSpaceExtended</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a10">KdpGetBusData</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d5/4_2alpha_2kdcpuapi_8c.html#a11">KdpSetBusData</a> (IN PDBGKD_MANIPULATE_STATE64 m, IN PSTRING AdditionalData, IN PCONTEXT Context)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="4/alpha/kdcpuapi.c::HEADER_FILE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HEADER_FILE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00032">32</a> of file <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html">4/alpha/kdcpuapi.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a10" doxytag="4/alpha/kdcpuapi.c::KdpGetBusData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpGetBusData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l01057">1057</a> of file <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html">4/alpha/kdcpuapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/hal_8h.html#a187">HalGetBusDataByOffset()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00821">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>01065                    :
01066 
01067     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response to a get bus data state
01068     manipulation message.  Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to read I/O configuration
01069     space.
01070 
01071 Arguments:
01072 
01073     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
01074 
01075     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
01076 
01077     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
01078 
01079 Return Value:
01080 
01081     None.
01082 
01083 --*/
01084 
01085 {
01086     PDBGKD_GET_SET_BUS_DATA a = &amp;m-&gt;u.GetSetBusData;
01087     ULONG Length;
01088     STRING MessageHeader;
01089 
01090     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
01091     MessageHeader.Buffer = (PCHAR)m;
01092 
01093     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
01094 
01095     m-&gt;ReturnStatus = STATUS_SUCCESS;
01096 
01097     <span class="comment">//</span>
01098     <span class="comment">// Trim length to fit in a single message</span>
01099     <span class="comment">//</span>
01100 
01101     <span class="keywordflow">if</span> (a-&gt;Length &gt; (PACKET_MAX_SIZE - <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64))) {
01102         Length = PACKET_MAX_SIZE - <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64);
01103     } <span class="keywordflow">else</span> {
01104         Length = a-&gt;Length;
01105     }
01106 
01107     <span class="comment">//</span>
01108     <span class="comment">// Get the bus data.</span>
01109     <span class="comment">//</span>
01110 
01111     Length = <a class="code" href="../../d2/d7/hal_8h.html#a187">HalGetBusDataByOffset</a>(
01112                  a-&gt;BusDataType,
01113                  a-&gt;BusNumber,
01114                  a-&gt;SlotNumber,
01115                  AdditionalData-&gt;Buffer,
01116                  a-&gt;Offset,
01117                  Length
01118              );
01119 
01120     <span class="comment">//</span>
01121     <span class="comment">// Update the data length.</span>
01122     <span class="comment">//</span>
01123 
01124     a-&gt;Length = Length;
01125 
01126     AdditionalData-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
01127 
01128     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
01129         PACKET_TYPE_KD_STATE_MANIPULATE,
01130         &amp;MessageHeader,
01131         AdditionalData
01132         );
01133 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="4/alpha/kdcpuapi.c::KdpGetStateChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpGetStateChange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>ManipulateState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00189">189</a> of file <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html">4/alpha/kdcpuapi.c</a>.
<p>
<pre class="fragment"><div>00196                    :
00197 
00198     Extract continuation <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> data from Manipulate_State message
00199 
00200     N.B. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a noop <span class="keywordflow">for</span> MIPS.
00201 
00202 Arguments:
00203 
00204     ManipulateState - supplies pointer to Manipulate_State packet
00205 
00206     ContextRecord - Supplies a pointer to a context record.
00207 
00208 Return Value:
00209 
00210     None.
00211 
00212 --*/
00213 
00214 {
00215 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="4/alpha/kdcpuapi.c::KdpReadControlSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpReadControlSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00218">218</a> of file <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html">4/alpha/kdcpuapi.c</a>.
<p>
<pre class="fragment"><div>00226                    :
00227 
00228     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response of a read <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> space state
00229     manipulation message.  Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to read implementation
00230     specific system data.
00231 
00232 Arguments:
00233 
00234     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
00235 
00236     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
00237 
00238     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
00239 
00240 Return Value:
00241 
00242     None.
00243 
00244 --*/
00245 
00246 {
00247 
00248     PDBGKD_READ_MEMORY64 a = &amp;m-&gt;u.ReadMemory;
00249     ULONG Length;
00250     STRING MessageHeader;
00251     PVOID <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = AdditionalData-&gt;Buffer;
00252 
00253     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00254     MessageHeader.Buffer = (PCHAR)m;
00255 
00256     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00257 
00258     <span class="keywordflow">if</span> (a-&gt;TransferCount &gt; (PACKET_MAX_SIZE - <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64))) {
00259         Length = PACKET_MAX_SIZE - <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE64);
00260     } <span class="keywordflow">else</span> {
00261         Length = a-&gt;TransferCount;
00262     }
00263 
00264     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(PVOID) == <span class="keyword">sizeof</span>(ULONG_PTR));
00265 
00266 <span class="comment">//NOTENOTE</span>
00267 <span class="comment">//  This code will in fact only work on a uni-processor as the</span>
00268 <span class="comment">//  m-&gt;Processor field is ignored for now</span>
00269 
00270     <span class="comment">//</span>
00271     <span class="comment">// Case on address to determine what part of Control</span>
00272     <span class="comment">// space is being read</span>
00273     <span class="comment">//</span>
00274 
00275     <span class="keywordflow">switch</span>( (ULONG_PTR)a-&gt;TargetBaseAddress ){
00276 
00277         <span class="comment">//</span>
00278         <span class="comment">// Return the pcr address for the current processor.</span>
00279         <span class="comment">//</span>
00280 
00281     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_PCR:
00282 
00283         *(PKPCR *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a7">KdpGetPcr</a>();
00284         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( PKPCR );
00285         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00286         m-&gt;ReturnStatus = STATUS_SUCCESS;
00287         <span class="keywordflow">break</span>;
00288 
00289         <span class="comment">//</span>
00290         <span class="comment">// Return the prcb address for the current processor.</span>
00291         <span class="comment">//</span>
00292 
00293     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_PRCB:
00294 
00295         *(PKPRCB *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a12">KdpGetCurrentPrcb</a>();
00296         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( PKPRCB );
00297         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00298         m-&gt;ReturnStatus = STATUS_SUCCESS;
00299         <span class="keywordflow">break</span>;
00300 
00301         <span class="comment">//</span>
00302         <span class="comment">// Return the pointer to the current thread address for the</span>
00303         <span class="comment">// current processor.</span>
00304         <span class="comment">//</span>
00305 
00306     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_THREAD:
00307 
00308         *(<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a13">KdpGetCurrentThread</a>();
00309         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> );
00310         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00311         m-&gt;ReturnStatus = STATUS_SUCCESS;
00312         <span class="keywordflow">break</span>;
00313 
00314         <span class="comment">//</span>
00315         <span class="comment">// Return the current Thread Environment Block pointer for the</span>
00316         <span class="comment">// current thread on the current processor.</span>
00317         <span class="comment">//</span>
00318 
00319     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_TEB:
00320 
00321         *(PVOID *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PVOID)NtCurrentTeb();
00322         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( <span class="keyword">struct </span>_TEB * );
00323         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00324         m-&gt;ReturnStatus = STATUS_SUCCESS;
00325         <span class="keywordflow">break</span>;
00326 
00327         <span class="comment">//</span>
00328         <span class="comment">// Return the dpc active flag for the current processor.</span>
00329         <span class="comment">//</span>
00330 
00331     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_DPCACTIVE:
00332 
00333         *(BOOLEAN *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = KeIsExecutingDpc();
00334         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( ULONG );
00335         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00336         m-&gt;ReturnStatus = STATUS_SUCCESS;
00337         <span class="keywordflow">break</span>;
00338 
00339         <span class="comment">//</span>
00340         <span class="comment">// Return the internal processor register state.</span>
00341         <span class="comment">//</span>
00342         <span class="comment">// N.B. - the kernel debugger buffer is expected to be allocated</span>
00343         <span class="comment">//        in the 32-bit superpage</span>
00344         <span class="comment">//</span>
00345         <span class="comment">// N.B. - the size of the internal state cannot exceed the size of</span>
00346         <span class="comment">//        the buffer allocated to the kernel debugger via</span>
00347         <span class="comment">//        KDP_MESSAGE_BUFFER_SIZE</span>
00348         <span class="comment">//</span>
00349 
00350     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_IPRSTATE:
00351 
00352         <span class="comment">//</span>
00353         <span class="comment">// Guarantee that Buffer is quadword-aligned, and adjust the</span>
00354         <span class="comment">// size of the available buffer accordingly.</span>
00355         <span class="comment">//</span>
00356 
00357         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PVOID)( ((ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + 7) &amp; ~7);
00358 
00359         Length = (ULONG)((ULONG_PTR)&amp;AdditionalData-&gt;Buffer[<a class="code" href="../../d0/d7/kdp_8h.html#a14">KDP_MESSAGE_BUFFER_SIZE</a>] -
00360                  (ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00361 
00362         AdditionalData-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d7/d7/4_2axp64_2kdpcpu_8h.html#a8">KdpReadInternalProcessorState</a>(
00363                                              Buffer,
00364                                              Length );
00365 
00366         <span class="comment">//</span>
00367         <span class="comment">// Check the returned size, if greater than the buffer size than</span>
00368         <span class="comment">// we didn't have a sufficient buffer.  If zero then the call</span>
00369         <span class="comment">// failed otherwise.</span>
00370         <span class="comment">//</span>
00371 
00372         <span class="keywordflow">if</span>( (AdditionalData-&gt;Length &gt; <a class="code" href="../../d0/d7/kdp_8h.html#a14">KDP_MESSAGE_BUFFER_SIZE</a>) ||
00373             (AdditionalData-&gt;Length == 0) ){
00374 
00375             AdditionalData-&gt;Length = 0;
00376             m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
00377             a-&gt;ActualBytesRead = 0;
00378 
00379         } <span class="keywordflow">else</span> {
00380 
00381             m-&gt;ReturnStatus = STATUS_SUCCESS;
00382             a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00383 
00384         }
00385 
00386         <span class="keywordflow">break</span>;
00387 
00388         <span class="comment">//</span>
00389         <span class="comment">// Return the internal processor counter values.</span>
00390         <span class="comment">//</span>
00391         <span class="comment">// N.B. - the kernel debugger buffer is expected to be allocated</span>
00392         <span class="comment">//        in the 32-bit superpage</span>
00393         <span class="comment">//</span>
00394         <span class="comment">// N.B. - the size of the counters structure cannot exceed the size of</span>
00395         <span class="comment">//        the buffer allocated to the kernel debugger via</span>
00396         <span class="comment">//        KDP_MESSAGE_BUFFER_SIZE</span>
00397         <span class="comment">//</span>
00398 
00399     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_COUNTERS:
00400 
00401         <span class="comment">//</span>
00402         <span class="comment">// Guarantee that Buffer is quadword-aligned, and adjust the</span>
00403         <span class="comment">// size of the available buffer accordingly.</span>
00404         <span class="comment">//</span>
00405 
00406         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PVOID)( ((ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + 7) &amp; ~7);
00407 
00408         Length = (ULONG)((ULONG_PTR)&amp;AdditionalData-&gt;Buffer[<a class="code" href="../../d0/d7/kdp_8h.html#a14">KDP_MESSAGE_BUFFER_SIZE</a>] -
00409                  (ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00410 
00411         AdditionalData-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d7/d7/4_2axp64_2kdpcpu_8h.html#a9">KdpReadInternalProcessorCounters</a>(
00412                                              Buffer,
00413                                              Length );
00414 
00415         <span class="comment">//</span>
00416         <span class="comment">// Check the returned size, if greater than the buffer size than</span>
00417         <span class="comment">// we didn't have a sufficient buffer.  If zero then the call</span>
00418         <span class="comment">// failed otherwise.</span>
00419         <span class="comment">//</span>
00420 
00421         <span class="keywordflow">if</span>( (AdditionalData-&gt;Length &gt; <a class="code" href="../../d0/d7/kdp_8h.html#a14">KDP_MESSAGE_BUFFER_SIZE</a>) ||
00422             (AdditionalData-&gt;Length == 0) ){
00423 
00424             AdditionalData-&gt;Length = 0;
00425             m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
00426             a-&gt;ActualBytesRead = 0;
00427 
00428         } <span class="keywordflow">else</span> {
00429 
00430             m-&gt;ReturnStatus = STATUS_SUCCESS;
00431             a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00432 
00433         }
00434 
00435         <span class="keywordflow">break</span>;
00436 
00437         <span class="comment">//</span>
00438         <span class="comment">// Uninterpreted Special Space</span>
00439         <span class="comment">//</span>
00440 
00441     <span class="keywordflow">default</span>:
00442 
00443         AdditionalData-&gt;Length = 0;
00444         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
00445         a-&gt;ActualBytesRead = 0;
00446 
00447     }
00448 
00449     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00450         PACKET_TYPE_KD_STATE_MANIPULATE,
00451         &amp;MessageHeader,
00452         AdditionalData
00453         );
00454 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="4/alpha/kdcpuapi.c::KdpReadIoSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpReadIoSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00505">505</a> of file <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html">4/alpha/kdcpuapi.c</a>.
<p>
<pre class="fragment"><div>00513                    :
00514 
00515     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response of a read io space state
00516     manipulation message.  Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to read system io
00517     locations.
00518 
00519 Arguments:
00520 
00521     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
00522 
00523     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
00524 
00525     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
00526 
00527 Return Value:
00528 
00529     None.
00530 
00531 --*/
00532 
00533 {
00534     PDBGKD_READ_WRITE_IO64 a = &amp;m-&gt;u.ReadWriteIo;
00535     STRING MessageHeader;
00536     INTERFACE_TYPE <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00537     ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00538     PHYSICAL_ADDRESS IoAddress;
00539     PHYSICAL_ADDRESS TranslatedAddress;
00540     ULONG AddressSpace;
00541     ULONG DataSize;
00542 
00543     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00544     MessageHeader.Buffer = (PCHAR)m;
00545 
00546     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00547 
00548     m-&gt;ReturnStatus = STATUS_SUCCESS;
00549 
00550     <span class="comment">//</span>
00551     <span class="comment">// Capture the input parameters and use the default values for those</span>
00552     <span class="comment">// parameters not specified in the Api.</span>
00553     <span class="comment">//</span>
00554 
00555     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> = Isa;
00556     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = 0;
00557     AddressSpace = 1;
00558     IoAddress.QuadPart = (ULONG_PTR)a-&gt;IoAddress;
00559     DataSize = a-&gt;DataSize;
00560 
00561     <span class="comment">//</span>
00562     <span class="comment">// Zero the return data value.</span>
00563     <span class="comment">//</span>
00564 
00565     a-&gt;DataValue = 0;
00566 
00567     <span class="comment">//</span>
00568     <span class="comment">// Translate the bus address to the physical system address</span>
00569     <span class="comment">// or QVA.</span>
00570     <span class="comment">//</span>
00571 
00572     <span class="keywordflow">if</span>( !<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>( InterfaceType,
00573                                  BusNumber,
00574                                  IoAddress,
00575                                  &amp;AddressSpace,
00576                                  &amp;TranslatedAddress ) ){
00577         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00578         <span class="keywordflow">goto</span> SendReadIoSpaceResponse;
00579     }
00580 
00581     <span class="comment">//</span>
00582     <span class="comment">// N.B. - for the moment we will only support QVAs ie. when AddressSpace</span>
00583     <span class="comment">//        is one.  It may be in later systems that we will have to</span>
00584     <span class="comment">//        check the address space, map it, perform the virtual read</span>
00585     <span class="comment">//        unmap, and then return the data - only we will have to be</span>
00586     <span class="comment">//        careful about what Irql we are to make sure the memory mgmt</span>
00587     <span class="comment">//        stuff will all work</span>
00588     <span class="comment">//</span>
00589 
00590     <span class="keywordflow">if</span>( !AddressSpace ){
00591         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00592         <span class="keywordflow">goto</span> SendReadIoSpaceResponse;
00593     }
00594 
00595     <span class="comment">//</span>
00596     <span class="comment">// Do the IO space read using the appropriate HAL routines based upon</span>
00597     <span class="comment">// the default address space (io) and the data size requested.</span>
00598     <span class="comment">//</span>
00599 
00600     <span class="keywordflow">switch</span>( DataSize ){
00601 
00602     <span class="keywordflow">case</span> 1:
00603         a-&gt;DataValue = READ_PORT_UCHAR( (PUCHAR)(ULONG_PTR) TranslatedAddress.QuadPart );
00604         <span class="keywordflow">break</span>;
00605 
00606     <span class="keywordflow">case</span> 2:
00607         a-&gt;DataValue = READ_PORT_USHORT( (PUSHORT)(ULONG_PTR) TranslatedAddress.QuadPart );
00608         <span class="keywordflow">break</span>;
00609 
00610     <span class="keywordflow">case</span> 4:
00611         a-&gt;DataValue = READ_PORT_ULONG((PULONG)(ULONG_PTR) TranslatedAddress.QuadPart );
00612         <span class="keywordflow">break</span>;
00613 
00614     <span class="keywordflow">default</span>:
00615         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00616     }
00617 
00618 
00619 SendReadIoSpaceResponse:
00620 
00621     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00622         PACKET_TYPE_KD_STATE_MANIPULATE,
00623         &amp;MessageHeader,
00624         NULL
00625         );
00626 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="4/alpha/kdcpuapi.c::KdpReadIoSpaceExtended" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpReadIoSpaceExtended           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00629">629</a> of file <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html">4/alpha/kdcpuapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00050">InterfaceType</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>.
<p>
<pre class="fragment"><div>00637                    :
00638 
00639     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response of a read io space extended state
00640     manipulation message.  Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to read system io
00641     locations.
00642 
00643 Arguments:
00644 
00645     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
00646 
00647     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
00648 
00649     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
00650 
00651 Return Value:
00652 
00653     None.
00654 
00655 --*/
00656 
00657 {
00658     PDBGKD_READ_WRITE_IO_EXTENDED64 a = &amp;m-&gt;u.ReadWriteIoExtended;
00659     ULONG Length;
00660     STRING MessageHeader;
00661     PUCHAR b;
00662     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> s;
00663     PULONG l;
00664     ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00665     ULONG AddressSpace;
00666     ULONG SavedAddressSpace;
00667     PHYSICAL_ADDRESS IoAddress;
00668     ULONG DataSize;
00669     PHYSICAL_ADDRESS TranslatedAddress;
00670     INTERFACE_TYPE <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00671 
00672     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00673     MessageHeader.Buffer = (PCHAR)m;
00674 
00675     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00676 
00677     m-&gt;ReturnStatus = STATUS_SUCCESS;
00678 
00679     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> = a-&gt;InterfaceType;
00680     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = a-&gt;BusNumber;
00681     AddressSpace = SavedAddressSpace = a-&gt;AddressSpace;
00682     IoAddress.QuadPart = (ULONG_PTR)a-&gt;IoAddress;
00683     DataSize = a-&gt;DataSize;
00684 
00685     <span class="comment">//</span>
00686     <span class="comment">// Zero the return data value.</span>
00687     <span class="comment">//</span>
00688 
00689     a-&gt;DataValue = 0;
00690 
00691     <span class="comment">//</span>
00692     <span class="comment">// Translate the bus address to the physical system address</span>
00693     <span class="comment">// or QVA.</span>
00694     <span class="comment">//</span>
00695 
00696     <span class="keywordflow">if</span>( !<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>( InterfaceType,
00697                                  BusNumber,
00698                                  IoAddress,
00699                                  &amp;AddressSpace,
00700                                  &amp;TranslatedAddress ) ){
00701         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00702         <span class="keywordflow">goto</span> SendReadIoSpaceExtendedResponse;
00703     }
00704 
00705     <span class="comment">//</span>
00706     <span class="comment">// N.B. - for the moment we will only support QVAs ie. when AddressSpace</span>
00707     <span class="comment">//        is one.  It may be in later systems that we will have to</span>
00708     <span class="comment">//        check the address space, map it, perform the virtual read</span>
00709     <span class="comment">//        unmap, and then return the data - only we will have to be</span>
00710     <span class="comment">//        careful about what Irql we are to make sure the memory mgmt</span>
00711     <span class="comment">//        stuff will all work</span>
00712     <span class="comment">//</span>
00713 
00714     <span class="keywordflow">if</span>( !AddressSpace ){
00715         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00716         <span class="keywordflow">goto</span> SendReadIoSpaceExtendedResponse;
00717     }
00718 
00719     <span class="comment">//</span>
00720     <span class="comment">// Do the IO space read using the appropriate HAL routines based upon</span>
00721     <span class="comment">// the original address space and the data size requested.</span>
00722     <span class="comment">//</span>
00723 
00724     <span class="keywordflow">if</span>( !SavedAddressSpace ){
00725 
00726         <span class="comment">//</span>
00727         <span class="comment">// Memory (buffer) space on the bus</span>
00728         <span class="comment">//</span>
00729 
00730         <span class="keywordflow">switch</span>( DataSize ){
00731 
00732         <span class="keywordflow">case</span> 1:
00733             a-&gt;DataValue = READ_REGISTER_UCHAR( (PUCHAR)(ULONG_PTR) TranslatedAddress.QuadPart );
00734             <span class="keywordflow">break</span>;
00735 
00736         <span class="keywordflow">case</span> 2:
00737             a-&gt;DataValue = READ_REGISTER_USHORT((PUSHORT)(ULONG_PTR) TranslatedAddress.QuadPart );
00738             <span class="keywordflow">break</span>;
00739 
00740         <span class="keywordflow">case</span> 4:
00741             a-&gt;DataValue = READ_REGISTER_ULONG((PULONG)(ULONG_PTR) TranslatedAddress.QuadPart );
00742             <span class="keywordflow">break</span>;
00743 
00744         <span class="keywordflow">default</span>:
00745             m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00746         }
00747 
00748     } <span class="keywordflow">else</span> {
00749 
00750         <span class="comment">//</span>
00751         <span class="comment">// I/O space on the bus</span>
00752         <span class="comment">//</span>
00753 
00754         <span class="keywordflow">switch</span>( DataSize ){
00755 
00756         <span class="keywordflow">case</span> 1:
00757             a-&gt;DataValue = READ_PORT_UCHAR( (PUCHAR)(ULONG_PTR) TranslatedAddress.QuadPart );
00758             <span class="keywordflow">break</span>;
00759 
00760         <span class="keywordflow">case</span> 2:
00761             a-&gt;DataValue = READ_PORT_USHORT( (PUSHORT)(ULONG_PTR) TranslatedAddress.QuadPart );
00762             <span class="keywordflow">break</span>;
00763 
00764         <span class="keywordflow">case</span> 4:
00765             a-&gt;DataValue = READ_PORT_ULONG( (PULONG)(ULONG_PTR) TranslatedAddress.QuadPart );
00766             <span class="keywordflow">break</span>;
00767 
00768         <span class="keywordflow">default</span>:
00769             m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00770         }
00771     }
00772 
00773 
00774 
00775 SendReadIoSpaceExtendedResponse:
00776 
00777     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00778         PACKET_TYPE_KD_STATE_MANIPULATE,
00779         &amp;MessageHeader,
00780         NULL
00781         );
00782 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="4/alpha/kdcpuapi.c::KdpSetBusData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpSetBusData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l01136">1136</a> of file <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html">4/alpha/kdcpuapi.c</a>.
<p>
References <a class="el" href="../../d2/d7/hal_8h.html#a183">HalSetBusDataByOffset()</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00821">KdpSendWaitContinue()</a>.
<p>
<pre class="fragment"><div>01144                    :
01145 
01146     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response to a set bus data state
01147     manipulation message.  Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to write I/O configuration
01148     space.
01149 
01150 Arguments:
01151 
01152     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
01153 
01154     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
01155 
01156     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
01157 
01158 Return Value:
01159 
01160     None.
01161 
01162 --*/
01163 
01164 {
01165     PDBGKD_GET_SET_BUS_DATA a = &amp;m-&gt;u.GetSetBusData;
01166     ULONG Length;
01167     STRING MessageHeader;
01168 
01169     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
01170     MessageHeader.Buffer = (PCHAR)m;
01171 
01172     m-&gt;ReturnStatus = STATUS_SUCCESS;
01173 
01174     <span class="comment">//</span>
01175     <span class="comment">// Get the bus data.</span>
01176     <span class="comment">//</span>
01177 
01178     Length = <a class="code" href="../../d2/d7/hal_8h.html#a183">HalSetBusDataByOffset</a>(
01179                  a-&gt;BusDataType,
01180                  a-&gt;BusNumber,
01181                  a-&gt;SlotNumber,
01182                  AdditionalData-&gt;Buffer,
01183                  a-&gt;Offset,
01184                  a-&gt;Length
01185              );
01186 
01187     <span class="comment">//</span>
01188     <span class="comment">// Update the data length.</span>
01189     <span class="comment">//</span>
01190 
01191     a-&gt;Length = Length;
01192 
01193     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
01194         PACKET_TYPE_KD_STATE_MANIPULATE,
01195         &amp;MessageHeader,
01196         NULL
01197         );
01198 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="4/alpha/kdcpuapi.c::KdpSetLoadState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpSetLoadState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_WAIT_STATE_CHANGE64&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitStateChange</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00036">36</a> of file <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html">4/alpha/kdcpuapi.c</a>.
<p>
<pre class="fragment"><div>00043                    :
00044 
00045     Fill in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Wait_State_Change message record <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> load symbol <span class="keywordflow">case</span>.
00046 
00047 Arguments:
00048 
00049     WaitStateChange - Supplies pointer to record to fill in
00050 
00051     ContextRecord - Supplies a pointer to a context record.
00052 
00053 Return Value:
00054 
00055     None.
00056 
00057 --*/
00058 
00059 {
00060 
00061     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00062     PVOID <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00063 
00064     <span class="comment">//</span>
00065     <span class="comment">// Copy the immediate instruction stream into the control report structure.</span>
00066     <span class="comment">//</span>
00067 
00068     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> =  <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(&amp;WaitStateChange-&gt;ControlReport.InstructionStream[0],
00069                            (PCHAR)WaitStateChange-&gt;ProgramCounter,
00070                            DBGKD_MAXSTREAM);
00071 
00072     WaitStateChange-&gt;ControlReport.InstructionCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00073 
00074     <span class="comment">//</span>
00075     <span class="comment">// Clear breakpoints in the copied instruction stream. If any breakpoints</span>
00076     <span class="comment">// are clear, then recopy the instruction strasm.</span>
00077     <span class="comment">//</span>
00078 
00079     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = (PVOID)((PUCHAR)(WaitStateChange-&gt;ProgramCounter) + <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - 1);
00080     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a106">KdpDeleteBreakpointRange</a>((PVOID)WaitStateChange-&gt;ProgramCounter, End) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00081         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(&amp;WaitStateChange-&gt;ControlReport.InstructionStream[0],
00082                       (PVOID)WaitStateChange-&gt;ProgramCounter,
00083                       Count);
00084     }
00085 
00086     <span class="comment">//</span>
00087     <span class="comment">// Copy the context record into the wait state structure.</span>
00088     <span class="comment">//</span>
00089 
00090     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>((PCHAR)&amp;WaitStateChange-&gt;Context,
00091                   (PCHAR)ContextRecord,
00092                   <span class="keyword">sizeof</span>(*ContextRecord));
00093 
00094     <span class="keywordflow">return</span>;
00095 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="4/alpha/kdcpuapi.c::KdpSetStateChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpSetStateChange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_WAIT_STATE_CHANGE64&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitStateChange</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SecondChance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00098">98</a> of file <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html">4/alpha/kdcpuapi.c</a>.
<p>
<pre class="fragment"><div>00107                    :
00108 
00109     Fill in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Wait_State_Change message record.
00110 
00111 Arguments:
00112 
00113     WaitStateChange - Supplies pointer to record to fill in
00114 
00115     ExceptionRecord - Supplies a pointer to an exception record.
00116 
00117     ContextRecord - Supplies a pointer to a context record.
00118 
00119     SecondChance - Supplies a <span class="keywordtype">boolean</span> value that determines whether <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00120         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first or second chance <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00121 
00122 Return Value:
00123 
00124     None.
00125 
00126 --*/
00127 
00128 {
00129 
00130     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00131     PVOID <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00132 
00133     <span class="comment">//</span>
00134     <span class="comment">// Set up description of event, including exception record</span>
00135     <span class="comment">//</span>
00136 
00137     WaitStateChange-&gt;NewState = DbgKdExceptionStateChange;
00138     WaitStateChange-&gt;ProcessorLevel = <a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a>;
00139     WaitStateChange-&gt;Processor = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a12">KdpGetCurrentPrcb</a>()-&gt;Number;
00140     WaitStateChange-&gt;NumberProcessors = (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
00141     WaitStateChange-&gt;Thread = (ULONG_PTR)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a13">KdpGetCurrentThread</a>();
00142     WaitStateChange-&gt;ProgramCounter = (ULONG_PTR)CONTEXT_TO_PROGRAM_COUNTER(ContextRecord);
00143     <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(EXCEPTION_RECORD) == <span class="keyword">sizeof</span>(WaitStateChange-&gt;u.Exception.ExceptionRecord)) {
00144         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a111">KdpQuickMoveMemory</a>((PCHAR)&amp;WaitStateChange-&gt;u.Exception.ExceptionRecord,
00145                            (PCHAR)ExceptionRecord,
00146                            <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00147     } <span class="keywordflow">else</span> {
00148         ExceptionRecord32To64((PEXCEPTION_RECORD32)ExceptionRecord,
00149                               &amp;WaitStateChange-&gt;u.Exception.ExceptionRecord
00150                               );
00151     }
00152 
00153     WaitStateChange-&gt;u.Exception.FirstChance = !SecondChance;
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">// Copy the immediate instruction stream into the control report structure.</span>
00157     <span class="comment">//</span>
00158 
00159     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> =  <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(&amp;WaitStateChange-&gt;ControlReport.InstructionStream[0],
00160                            (PVOID)WaitStateChange-&gt;ProgramCounter,
00161                            DBGKD_MAXSTREAM);
00162 
00163     WaitStateChange-&gt;ControlReport.InstructionCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00164 
00165     <span class="comment">//</span>
00166     <span class="comment">// Clear breakpoints in the copied instruction stream. If any breakpoints</span>
00167     <span class="comment">// are clear, then recopy the instruction strasm.</span>
00168     <span class="comment">//</span>
00169 
00170     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = (PVOID)((PUCHAR)(WaitStateChange-&gt;ProgramCounter) + <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - 1);
00171     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a106">KdpDeleteBreakpointRange</a>((PVOID)WaitStateChange-&gt;ProgramCounter, End) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00172         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(&amp;WaitStateChange-&gt;ControlReport.InstructionStream[0],
00173                       (PVOID)WaitStateChange-&gt;ProgramCounter,
00174                       Count);
00175     }
00176 
00177     <span class="comment">//</span>
00178     <span class="comment">// Copy the context record into the wait state structure.</span>
00179     <span class="comment">//</span>
00180 
00181     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>((PCHAR)&amp;WaitStateChange-&gt;Context,
00182                   (PCHAR)ContextRecord,
00183                   <span class="keyword">sizeof</span>(*ContextRecord));
00184 
00185     <span class="keywordflow">return</span>;
00186 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="4/alpha/kdcpuapi.c::KdpWriteControlSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpWriteControlSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00457">457</a> of file <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html">4/alpha/kdcpuapi.c</a>.
<p>
<pre class="fragment"><div>00465                    :
00466 
00467     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response of a write <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> space state
00468     manipulation message.  Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to write implementation
00469     specific system data.
00470 
00471 Arguments:
00472 
00473     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
00474 
00475     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
00476 
00477     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
00478 
00479 Return Value:
00480 
00481     None.
00482 
00483 --*/
00484 
00485 {
00486     PDBGKD_WRITE_MEMORY64 a = &amp;m-&gt;u.WriteMemory;
00487     ULONG Length;
00488     STRING MessageHeader;
00489 
00490     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00491     MessageHeader.Buffer = (PCHAR)m;
00492 
00493     AdditionalData-&gt;Length = 0;
00494     m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
00495     a-&gt;ActualBytesWritten = 0;
00496 
00497     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00498         PACKET_TYPE_KD_STATE_MANIPULATE,
00499         &amp;MessageHeader,
00500         AdditionalData
00501         );
00502 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="4/alpha/kdcpuapi.c::KdpWriteIoSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpWriteIoSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00785">785</a> of file <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html">4/alpha/kdcpuapi.c</a>.
<p>
<pre class="fragment"><div>00793                    :
00794 
00795     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response of a read io space state
00796     manipulation message.  Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to read system io
00797     locations.
00798 
00799 Arguments:
00800 
00801     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
00802 
00803     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
00804 
00805     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
00806 
00807 Return Value:
00808 
00809     None.
00810 
00811 --*/
00812 
00813 {
00814     PDBGKD_READ_WRITE_IO64 a = &amp;m-&gt;u.ReadWriteIo;
00815     STRING MessageHeader;
00816     INTERFACE_TYPE <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00817     ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00818     PHYSICAL_ADDRESS IoAddress;
00819     PHYSICAL_ADDRESS TranslatedAddress;
00820     ULONG AddressSpace;
00821     ULONG DataSize;
00822     ULONG Value;
00823 
00824     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00825     MessageHeader.Buffer = (PCHAR)m;
00826 
00827     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00828 
00829     m-&gt;ReturnStatus = STATUS_SUCCESS;
00830 
00831     <span class="comment">//</span>
00832     <span class="comment">// Capture the input parameters and use the default values for those</span>
00833     <span class="comment">// parameters not specified in the Api.</span>
00834     <span class="comment">//</span>
00835 
00836     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> = Isa;
00837     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = 0;
00838     AddressSpace = 1;
00839     IoAddress.QuadPart = (ULONG_PTR)a-&gt;IoAddress;
00840     DataSize = a-&gt;DataSize;
00841     Value = a-&gt;DataValue;
00842 
00843     <span class="comment">//</span>
00844     <span class="comment">// Translate the bus address to the physical system address</span>
00845     <span class="comment">// or QVA.</span>
00846     <span class="comment">//</span>
00847 
00848     <span class="keywordflow">if</span>( !<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>( InterfaceType,
00849                                  BusNumber,
00850                                  IoAddress,
00851                                  &amp;AddressSpace,
00852                                  &amp;TranslatedAddress ) ){
00853         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00854         <span class="keywordflow">goto</span> SendWriteIoSpaceResponse;
00855     }
00856 
00857     <span class="comment">//</span>
00858     <span class="comment">// N.B. - for the moment we will only support QVAs ie. when AddressSpace</span>
00859     <span class="comment">//        is one.  It may be in later systems that we will have to</span>
00860     <span class="comment">//        check the address space, map it, perform the virtual read</span>
00861     <span class="comment">//        unmap, and then return the data - only we will have to be</span>
00862     <span class="comment">//        careful about what Irql we are to make sure the memory mgmt</span>
00863     <span class="comment">//        stuff will all work</span>
00864     <span class="comment">//</span>
00865 
00866     <span class="keywordflow">if</span>( !AddressSpace ){
00867         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00868         <span class="keywordflow">goto</span> SendWriteIoSpaceResponse;
00869     }
00870 
00871     <span class="comment">//</span>
00872     <span class="comment">// Do the IO space read using the appropriate HAL routines based upon</span>
00873     <span class="comment">// the default address space (io) and the data size requested.</span>
00874     <span class="comment">//</span>
00875 
00876     <span class="keywordflow">switch</span>( DataSize ){
00877 
00878     <span class="keywordflow">case</span> 1:
00879         WRITE_PORT_UCHAR( (PUCHAR)TranslatedAddress.QuadPart, (UCHAR)Value );
00880         <span class="keywordflow">break</span>;
00881 
00882     <span class="keywordflow">case</span> 2:
00883         WRITE_PORT_USHORT( (PUSHORT)TranslatedAddress.QuadPart, (USHORT)Value );
00884         <span class="keywordflow">break</span>;
00885 
00886     <span class="keywordflow">case</span> 4:
00887         WRITE_PORT_ULONG( (PULONG)TranslatedAddress.QuadPart, Value );
00888         <span class="keywordflow">break</span>;
00889 
00890     <span class="keywordflow">default</span>:
00891         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00892     }
00893 
00894 
00895 SendWriteIoSpaceResponse:
00896 
00897     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00898         PACKET_TYPE_KD_STATE_MANIPULATE,
00899         &amp;MessageHeader,
00900         NULL
00901         );
00902 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="4/alpha/kdcpuapi.c::KdpWriteIoSpaceExtended" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpWriteIoSpaceExtended           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PDBGKD_MANIPULATE_STATE64&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html#l00905">905</a> of file <a class="el" href="../../d6/d4/4_2alpha_2kdcpuapi_8c-source.html">4/alpha/kdcpuapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00050">InterfaceType</a>, <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">KdpSendPacket()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00913                    :
00914 
00915     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in response of a read io space extended state
00916     manipulation message.  Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to read system io
00917     locations.
00918 
00919 Arguments:
00920 
00921     m - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state manipulation message.
00922 
00923     AdditionalData - Supplies any additional data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
00924 
00925     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current context.
00926 
00927 Return Value:
00928 
00929     None.
00930 
00931 --*/
00932 
00933 {
00934     PDBGKD_READ_WRITE_IO_EXTENDED64 a = &amp;m-&gt;u.ReadWriteIoExtended;
00935     ULONG Length;
00936     STRING MessageHeader;
00937     PUCHAR b;
00938     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> s;
00939     PULONG l;
00940     ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00941     ULONG AddressSpace;
00942     ULONG SavedAddressSpace;
00943     PHYSICAL_ADDRESS IoAddress;
00944     ULONG DataSize;
00945     PHYSICAL_ADDRESS TranslatedAddress;
00946     INTERFACE_TYPE <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00947     ULONG Value;
00948 
00949     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00950     MessageHeader.Buffer = (PCHAR)m;
00951 
00952     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00953 
00954     m-&gt;ReturnStatus = STATUS_SUCCESS;
00955 
00956     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> = a-&gt;InterfaceType;
00957     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = a-&gt;BusNumber;
00958     AddressSpace = SavedAddressSpace = a-&gt;AddressSpace;
00959     IoAddress.QuadPart = (ULONG_PTR)a-&gt;IoAddress;
00960     DataSize = a-&gt;DataSize;
00961     Value = a-&gt;DataValue;
00962 
00963     <span class="comment">//</span>
00964     <span class="comment">// Translate the bus address to the physical system address</span>
00965     <span class="comment">// or QVA.</span>
00966     <span class="comment">//</span>
00967 
00968     <span class="keywordflow">if</span>( !<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>( InterfaceType,
00969                                  BusNumber,
00970                                  IoAddress,
00971                                  &amp;AddressSpace,
00972                                  &amp;TranslatedAddress ) ){
00973         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00974         <span class="keywordflow">goto</span> SendWriteIoSpaceExtendedResponse;
00975     }
00976 
00977     <span class="comment">//</span>
00978     <span class="comment">// N.B. - for the moment we will only support QVAs ie. when AddressSpace</span>
00979     <span class="comment">//        is one.  It may be in later systems that we will have to</span>
00980     <span class="comment">//        check the address space, map it, perform the virtual read</span>
00981     <span class="comment">//        unmap, and then return the data - only we will have to be</span>
00982     <span class="comment">//        careful about what Irql we are to make sure the memory mgmt</span>
00983     <span class="comment">//        stuff will all work</span>
00984     <span class="comment">//</span>
00985 
00986     <span class="keywordflow">if</span>( !AddressSpace ){
00987         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00988         <span class="keywordflow">goto</span> SendWriteIoSpaceExtendedResponse;
00989     }
00990 
00991     <span class="comment">//</span>
00992     <span class="comment">// Do the IO space read using the appropriate HAL routines based upon</span>
00993     <span class="comment">// the original address space and the data size requested.</span>
00994     <span class="comment">//</span>
00995 
00996     <span class="keywordflow">if</span>( !SavedAddressSpace ){
00997 
00998         <span class="comment">//</span>
00999         <span class="comment">// Memory (buffer) space on the bus</span>
01000         <span class="comment">//</span>
01001 
01002         <span class="keywordflow">switch</span>( DataSize ){
01003 
01004         <span class="keywordflow">case</span> 1:
01005             WRITE_REGISTER_UCHAR( (PUCHAR)TranslatedAddress.QuadPart, (UCHAR)Value );
01006             <span class="keywordflow">break</span>;
01007 
01008         <span class="keywordflow">case</span> 2:
01009             WRITE_REGISTER_USHORT( (PUSHORT)TranslatedAddress.QuadPart, (USHORT)Value );
01010             <span class="keywordflow">break</span>;
01011 
01012         <span class="keywordflow">case</span> 4:
01013             WRITE_REGISTER_ULONG( (PULONG)TranslatedAddress.QuadPart, Value );
01014             <span class="keywordflow">break</span>;
01015 
01016         <span class="keywordflow">default</span>:
01017             m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
01018         }
01019 
01020     } <span class="keywordflow">else</span> {
01021 
01022         <span class="comment">//</span>
01023         <span class="comment">// I/O space on the bus</span>
01024         <span class="comment">//</span>
01025 
01026         <span class="keywordflow">switch</span>( DataSize ){
01027 
01028         <span class="keywordflow">case</span> 1:
01029             WRITE_PORT_UCHAR( (PUCHAR)TranslatedAddress.QuadPart, (UCHAR)Value );
01030             <span class="keywordflow">break</span>;
01031 
01032         <span class="keywordflow">case</span> 2:
01033             WRITE_PORT_USHORT( (PUSHORT)TranslatedAddress.QuadPart, (USHORT)Value);
01034             <span class="keywordflow">break</span>;
01035 
01036         <span class="keywordflow">case</span> 4:
01037             WRITE_PORT_ULONG( (PULONG)TranslatedAddress.QuadPart, Value );
01038             <span class="keywordflow">break</span>;
01039 
01040         <span class="keywordflow">default</span>:
01041             m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
01042         }
01043     }
01044 
01045 
01046 
01047 SendWriteIoSpaceExtendedResponse:
01048 
01049     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
01050         PACKET_TYPE_KD_STATE_MANIPULATE,
01051         &amp;MessageHeader,
01052         NULL
01053         );
01054 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:25 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
