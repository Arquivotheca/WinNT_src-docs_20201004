<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: logger.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>logger.c</h1><a href="../../d4/d5/logger_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    logger.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This file contains the code for the debug logging facility.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 20-Jun-1992</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    kernel mode callable only.</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">    20-Jun-1992 Steve Wood (stevewo) Created.</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00028 
00029 <a class="code" href="../../d4/d7/struct__EX__DEBUG__LOG.html">PEX_DEBUG_LOG</a>
<a name="l00030"></a><a class="code" href="../../d5/d8/ex_8h.html#a308">00030</a> <a class="code" href="../../d5/d8/ex_8h.html#a308">ExCreateDebugLog</a>(
00031     IN UCHAR MaximumNumberOfTags,
00032     IN ULONG MaximumNumberOfEvents
00033     )
00034 {
00035     <a class="code" href="../../d4/d7/struct__EX__DEBUG__LOG.html">PEX_DEBUG_LOG</a> Log;
00036     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00037 
00038     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d7/struct__EX__DEBUG__LOG.html">EX_DEBUG_LOG</a> ) +
00039             (MaximumNumberOfTags *
00040              <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d7/struct__EX__DEBUG__LOG__TAG.html">EX_DEBUG_LOG_TAG</a> )
00041             ) +
00042             (MaximumNumberOfEvents *
00043              <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d7/struct__EX__DEBUG__LOG__EVENT.html">EX_DEBUG_LOG_EVENT</a> )
00044             );
00045 
00046 
00047     Log = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, 'oLbD' );
00048     <span class="keywordflow">if</span> (Log != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00049         RtlZeroMemory( Log, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
00050         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;Log-&gt;<a class="code" href="../../d4/d7/struct__EX__DEBUG__LOG.html#o0">Lock</a> );
00051         Log-&gt;<a class="code" href="../../d4/d7/struct__EX__DEBUG__LOG.html#o2">MaximumNumberOfTags</a> = MaximumNumberOfTags;
00052         Log-&gt;<a class="code" href="../../d4/d7/struct__EX__DEBUG__LOG.html#o3">Tags</a> = (<a class="code" href="../../d6/d7/struct__EX__DEBUG__LOG__TAG.html">PEX_DEBUG_LOG_TAG</a>)(Log + 1);
00053         Log-&gt;<a class="code" href="../../d4/d7/struct__EX__DEBUG__LOG.html#o5">First</a> = (<a class="code" href="../../d5/d7/struct__EX__DEBUG__LOG__EVENT.html">PEX_DEBUG_LOG_EVENT</a>)(Log-&gt;<a class="code" href="../../d4/d7/struct__EX__DEBUG__LOG.html#o3">Tags</a> + MaximumNumberOfTags);
00054         Log-&gt;<a class="code" href="../../d4/d7/struct__EX__DEBUG__LOG.html#o6">Last</a> = Log-&gt;<a class="code" href="../../d4/d7/struct__EX__DEBUG__LOG.html#o5">First</a> + MaximumNumberOfEvents;
00055         Log-&gt;<a class="code" href="../../d4/d7/struct__EX__DEBUG__LOG.html#o7">Next</a> = Log-&gt;<a class="code" href="../../d4/d7/struct__EX__DEBUG__LOG.html#o5">First</a>;
00056         }
00057 
00058     <span class="keywordflow">return</span> Log;
00059 }
00060 
00061 UCHAR
<a name="l00062"></a><a class="code" href="../../d5/d8/ex_8h.html#a309">00062</a> <a class="code" href="../../d5/d8/ex_8h.html#a309">ExCreateDebugLogTag</a>(
00063     IN <a class="code" href="../../d4/d7/struct__EX__DEBUG__LOG.html">PEX_DEBUG_LOG</a> Log,
00064     IN PCHAR Name,
00065     IN UCHAR Format1,
00066     IN UCHAR Format2,
00067     IN UCHAR Format3,
00068     IN UCHAR Format4
00069     )
00070 {
00071     KIRQL OldIrql;
00072     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00073     <a class="code" href="../../d6/d7/struct__EX__DEBUG__LOG__TAG.html">PEX_DEBUG_LOG_TAG</a> Tag;
00074     UCHAR TagIndex;
00075     PCHAR CapturedName;
00076 
00077     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> );
00078     CapturedName = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, 'oLbD' );
00079     RtlMoveMemory( CapturedName, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> + 1 );
00080 
00081     ExAcquireSpinLock( &amp;Log-&gt;Lock, &amp;OldIrql );
00082 
00083     <span class="keywordflow">if</span> (Log-&gt;NumberOfTags &lt; Log-&gt;MaximumNumberOfTags) {
00084         TagIndex = (UCHAR)(Log-&gt;NumberOfTags++);
00085         Tag = &amp;Log-&gt;Tags[ TagIndex ];
00086         Tag-&gt;<a class="code" href="../../d6/d7/struct__EX__DEBUG__LOG__TAG.html#o1">Name</a> = CapturedName;
00087         Tag-&gt;<a class="code" href="../../d6/d7/struct__EX__DEBUG__LOG__TAG.html#o0">Format</a>[ 0 ] = Format1;
00088         Tag-&gt;<a class="code" href="../../d6/d7/struct__EX__DEBUG__LOG__TAG.html#o0">Format</a>[ 1 ] = Format2;
00089         Tag-&gt;<a class="code" href="../../d6/d7/struct__EX__DEBUG__LOG__TAG.html#o0">Format</a>[ 2 ] = Format3;
00090         Tag-&gt;<a class="code" href="../../d6/d7/struct__EX__DEBUG__LOG__TAG.html#o0">Format</a>[ 3 ] = Format4;
00091         CapturedName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00092         }
00093     <span class="keywordflow">else</span> {
00094         TagIndex = (UCHAR)0xFF;
00095         }
00096 
00097     ExReleaseSpinLock( &amp;Log-&gt;Lock, OldIrql );
00098 
00099     <span class="keywordflow">if</span> (CapturedName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00100         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedName );
00101         }
00102     <span class="keywordflow">return</span> TagIndex;
00103 }
00104 
00105 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00106"></a><a class="code" href="../../d5/d8/ex_8h.html#a310">00106</a> <a class="code" href="../../d5/d8/ex_8h.html#a310">ExDebugLogEvent</a>(
00107     IN <a class="code" href="../../d4/d7/struct__EX__DEBUG__LOG.html">PEX_DEBUG_LOG</a> Log,
00108     IN UCHAR Tag,
00109     IN ULONG Data1,
00110     IN ULONG Data2,
00111     IN ULONG Data3,
00112     IN ULONG Data4
00113     )
00114 {
00115     KIRQL OldIrql;
00116     <a class="code" href="../../d5/d7/struct__EX__DEBUG__LOG__EVENT.html">PEX_DEBUG_LOG_EVENT</a> p;
00117     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00118     LARGE_INTEGER CurrentTime;
00119 
00120     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>( &amp;CurrentTime );
00121 
00122     ExAcquireSpinLock( &amp;Log-&gt;Lock, &amp;OldIrql );
00123 
00124     p = Log-&gt;Next;
00125     <span class="keywordflow">if</span> (p == Log-&gt;Last) {
00126         p = Log-&gt;First;
00127         }
00128     Log-&gt;Next = p + 1;
00129 
00130     p-&gt;<a class="code" href="../../d5/d7/struct__EX__DEBUG__LOG__EVENT.html#o0">ThreadId</a> = Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread;
00131     p-&gt;<a class="code" href="../../d5/d7/struct__EX__DEBUG__LOG__EVENT.html#o1">ProcessId</a> = Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueProcess;
00132     p-&gt;<a class="code" href="../../d5/d7/struct__EX__DEBUG__LOG__EVENT.html#o2">Time</a> = CurrentTime.LowPart;
00133     p-&gt;<a class="code" href="../../d5/d7/struct__EX__DEBUG__LOG__EVENT.html#o3">Tag</a> = Tag;
00134     p-&gt;<a class="code" href="../../d5/d7/struct__EX__DEBUG__LOG__EVENT.html#o5">Data</a>[ 0 ] = Data1;
00135     p-&gt;<a class="code" href="../../d5/d7/struct__EX__DEBUG__LOG__EVENT.html#o5">Data</a>[ 1 ] = Data2;
00136     p-&gt;<a class="code" href="../../d5/d7/struct__EX__DEBUG__LOG__EVENT.html#o5">Data</a>[ 2 ] = Data3;
00137     p-&gt;<a class="code" href="../../d5/d7/struct__EX__DEBUG__LOG__EVENT.html#o5">Data</a>[ 3 ] = Data4;
00138 
00139     ExReleaseSpinLock( &amp;Log-&gt;Lock, OldIrql );
00140 
00141     <span class="keywordflow">return</span>;
00142 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
