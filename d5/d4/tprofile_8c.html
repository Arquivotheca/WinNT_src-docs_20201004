<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: tprofile.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>tprofile.c File Reference</h1><code>#include &lt;nt.h&gt;</code><br>

<p>
<a href="../../d6/d3/tprofile_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/tprofile_8c.html#a0">main</a> ()</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="tprofile.c::main" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> main           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/tprofile_8c-source.html#l00024">24</a> of file <a class="el" href="../../d6/d3/tprofile_8c-source.html">tprofile.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00199">NtCreateProfile()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00680">NtStopProfile()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
<pre class="fragment"><div>00025 {
00026     HANDLE Profile, Profile2;
00027     ULONG Hack;
00028     PULONG <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00029     HANDLE CurrentProcessHandle;
00030     ULONG Size1;
00031     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00032 
00033     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = &amp;Hack;
00034 
00035     CurrentProcessHandle = NtCurrentProcess();
00036 
00037     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a9">NtCreateProfile</a> (&amp;Profile,
00038                               CurrentProcessHandle,
00039                               NULL,
00040                               0xFFFFFFFF,
00041                               16,
00042                               Buffer,
00043                               (ULONG)64*1024,
00044                               ProfileTime,
00045                               (KAFFINITY)-1);
00046 
00047     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00048         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Expected) create profile #1 failed - status %lx\n"</span>, status);
00049     }
00050 
00051     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a10">NtStartProfile</a> (Profile);
00052     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00053         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Expected) start profile #1 failed - status %lx\n"</span>, status);
00054     }
00055 
00056     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a11">NtStopProfile</a> (Profile);
00057     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00058         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Expected) stop profile #1 failed - status %lx\n"</span>, status);
00059     }
00060 
00061     Size1 = 1024*64;
00062     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00063 
00064     status = <a class="code" href="../../d3/d6/allocvm_8c.html#a7">NtAllocateVirtualMemory</a> (CurrentProcessHandle, (PVOID *)&amp;Buffer,
00065                         0, &amp;Size1, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
00066 
00067     <span class="comment">//</span>
00068     <span class="comment">// This should fail as buffersize is too small.</span>
00069     <span class="comment">//</span>
00070 
00071     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a9">NtCreateProfile</a> (&amp;Profile,
00072                               NtCurrentProcess(),
00073                               NULL,
00074                               0xFFFFFFFF,
00075                               16,
00076                               Buffer,
00077                               (ULONG)64*1024,
00078                               ProfileTime,
00079                               (KAFFINITY)-1);
00080 
00081     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00082         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Expected) create profile #2 failed - status %lx\n"</span>, status);
00083     }
00084 
00085     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a10">NtStartProfile</a> (Profile);
00086     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00087         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Expected) start profile #2 failed - status %lx\n"</span>, status);
00088     }
00089 
00090     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a11">NtStopProfile</a> (Profile);
00091     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00092         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Expected) stop profile #2 failed - status %lx\n"</span>, status);
00093     }
00094 
00095     status = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (Profile);
00096 
00097     <span class="comment">//</span>
00098     <span class="comment">// This should succeed.</span>
00099     <span class="comment">//</span>
00100 
00101     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a9">NtCreateProfile</a> (&amp;Profile,
00102                               NtCurrentProcess(),
00103                               NULL,
00104                               0xFFFFFFFF,
00105                               18,
00106                               Buffer,
00107                               (ULONG)64*1024,
00108                               ProfileTime,
00109                               (KAFFINITY)-1);
00110 
00111     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00112         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Unexpected) create profile #3 failed - status %lx\n"</span>, status);
00113     }
00114 
00115     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a10">NtStartProfile</a> (Profile);
00116     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00117         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Unexpected) start profile #3 failed - status %lx\n"</span>, status);
00118     }
00119 
00120     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a11">NtStopProfile</a> (Profile);
00121     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00122         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Unexpected) stop profile #3 failed - status %lx\n"</span>, status);
00123     }
00124 
00125     status = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (Profile);
00126 
00127     <span class="comment">//</span>
00128     <span class="comment">// Attempt to create a profile that can't work because the</span>
00129     <span class="comment">// address range is too big.</span>
00130     <span class="comment">//</span>
00131 
00132     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a9">NtCreateProfile</a> (&amp;Profile,
00133                               NtCurrentProcess(),
00134                               (PVOID)0x203030,
00135                               0xffffffff,
00136                               6,
00137                               Buffer,
00138                               (ULONG)64*1024,
00139                               ProfileTime,
00140                               (KAFFINITY)-1);
00141 
00142     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00143         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Expected) create profile #4 failed - status %lx\n"</span>, status);
00144     }
00145 
00146     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a10">NtStartProfile</a> (Profile);
00147     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00148         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Expected) start profile #4 failed - status %lx\n"</span>, status);
00149     }
00150 
00151     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a11">NtStopProfile</a> (Profile);
00152     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00153         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Expected) stop profile #4 failed - status %lx\n"</span>, status);
00154     }
00155 
00156     status = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (Profile);
00157 
00158     <span class="comment">//</span>
00159     <span class="comment">// Attempt to create a sucessful profile.</span>
00160     <span class="comment">//</span>
00161 
00162     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a9">NtCreateProfile</a> (&amp;Profile,
00163                               NtCurrentProcess(),
00164                               (PVOID)0x80000000,
00165                               0x7fffffff,
00166                               17,
00167                               Buffer,
00168                               (ULONG)64*1024,
00169                               ProfileTime,
00170                               (KAFFINITY)-1);
00171 
00172     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00173         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Unexpected) create profile #5 failed - status %lx\n"</span>, status);
00174     }
00175 
00176     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a10">NtStartProfile</a> (Profile);
00177     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00178         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Unexpected) start profile #5 failed - status %lx\n"</span>, status);
00179     }
00180 
00181     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a11">NtStopProfile</a> (Profile);
00182     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00183         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Unexpected) stop profile #5 failed - status %lx\n"</span>, status);
00184     }
00185 
00186     <span class="comment">//</span>
00187     <span class="comment">// now start it again.</span>
00188     <span class="comment">//</span>
00189 
00190     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a10">NtStartProfile</a> (Profile);
00191     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00192         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Unexpected) start profile #6.1 failed - status %lx\n"</span>, status);
00193     }
00194 
00195     <span class="comment">//</span>
00196     <span class="comment">// now start it again, should fail.</span>
00197     <span class="comment">//</span>
00198 
00199     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a10">NtStartProfile</a> (Profile);
00200     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00201         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Expected) start profile #6.2 failed - status %lx\n"</span>, status);
00202     }
00203 
00204     <span class="comment">//</span>
00205     <span class="comment">// now create another one (using the same buffer).</span>
00206     <span class="comment">//</span>
00207 
00208     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a9">NtCreateProfile</a> (&amp;Profile2,
00209                               NtCurrentProcess(),
00210                               NULL,
00211                               0x3000000,
00212                               15,
00213                               Buffer,
00214                               (ULONG)64*1024,
00215                               ProfileTime,
00216                               (KAFFINITY)-1);
00217 
00218 
00219     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00220         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"create profile #7 failed - status %lx\n"</span>, status);
00221     }
00222 
00223     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a10">NtStartProfile</a> (Profile2);
00224     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00225         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"start profile #7.1 failed - status %lx\n"</span>, status);
00226     }
00227 
00228     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a11">NtStopProfile</a> (Profile2);
00229     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00230         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"stop profile #7.2 failed - status %lx\n"</span>, status);
00231     }
00232 
00233     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a11">NtStopProfile</a> (Profile2);
00234     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00235         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"(Expected) stop profile #7.3 failed - status %lx\n"</span>, status);
00236     }
00237 
00238     status = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a10">NtStartProfile</a> (Profile2);
00239     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00240         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"start profile #7.4 failed - status %lx\n"</span>, status);
00241     }
00242 
00243     status = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (Profile);
00244     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00245         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"close profile #7.5 failed - status %lx\n"</span>, status);
00246     }
00247 
00248     <span class="keywordflow">return</span> status;
00249 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
