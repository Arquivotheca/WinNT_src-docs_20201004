<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ioeapi.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ioeapi.c</h1><a href="../../d4/d5/ioeapi_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1998  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    ioeapi.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the code for the exported IoErr APIs</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Michael Tsang (MikeTs) 2-Sep-1998</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d2/d4/ioe_2pch_8h.html">pch.h</a>"</span>
00027 
00028 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, IoErrInitSystem)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoErrMatchErrCase)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoErrFindErrCaseByID)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoErrHandleErrCase)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoErrGetLongErrMessage)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoErrGetShortErrMessage)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00036 <span class="preprocessor"></span>
00037 BOOLEAN
<a name="l00038"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a0">00038</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a0">IoErrInitSystem</a>(
00039     VOID
00040     )
00041 <span class="comment">/*++</span>
00042 <span class="comment"></span>
00043 <span class="comment">Routine Description:</span>
00044 <span class="comment">    This routine initializes the whole error logging/handling system.</span>
00045 <span class="comment"></span>
00046 <span class="comment">Arguments:</span>
00047 <span class="comment">    None</span>
00048 <span class="comment"></span>
00049 <span class="comment">Return Value:</span>
00050 <span class="comment">    Success - returns TRUE</span>
00051 <span class="comment">    Failure - returns FALSE</span>
00052 <span class="comment"></span>
00053 <span class="comment">--*/</span>
00054 {
00055     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrInitSystem"</span>);
00056     BOOLEAN rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00057 
00058     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"()\n"</span>));
00059 
00060     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>);
00061     InitializeListHead(&amp;<a class="code" href="../../d0/d2/data_8c.html#a2">IoepErrThreadListHead</a>);
00062     InitializeListHead(&amp;<a class="code" href="../../d0/d2/data_8c.html#a3">IoepErrModuleListHead</a>);
00063     InitializeListHead(&amp;<a class="code" href="../../d0/d2/data_8c.html#a4">IoepSaveDataListHead</a>);
00064     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00065         &amp;<a class="code" href="../../d0/d2/data_8c.html#a5">IoepRegKeyStrIoErr</a>,
00066         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\REGISTRY\\MACHINE\\SYSTEM\\CURRENTCONTROLSET\\SERVICES\\IOERR"</span>);
00067 
00068     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"=%x\n"</span>, rc));
00069     <span class="keywordflow">return</span> rc;
00070 }       <span class="comment">//IoErrInitSystem</span>
00071 
00072 HANDLE
<a name="l00073"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a1">00073</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a1">IoErrInitErrLogByIrp</a>(
00074     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>  Irp,
00075     IN ULONG ulFlags
00076     )
00077 <span class="comment">/*++</span>
00078 <span class="comment"></span>
00079 <span class="comment">Routine Description:</span>
00080 <span class="comment">    This routine initializes an error logging session that is keyed by an Irp.</span>
00081 <span class="comment"></span>
00082 <span class="comment">Arguments:</span>
00083 <span class="comment">    Irp - points to the Irp that is used as the key to the logging session.</span>
00084 <span class="comment">    ulFlags - log session flags</span>
00085 <span class="comment"></span>
00086 <span class="comment">Return Value:</span>
00087 <span class="comment">    Success - returns the newly created error log handle.</span>
00088 <span class="comment">    Failure - returns NULL.</span>
00089 <span class="comment"></span>
00090 <span class="comment">--*/</span>
00091 {
00092     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrInitErrLogByIrp"</span>);
00093     <a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a> ErrLog;
00094 
00095     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(Irp=%p,ulFlags=%x)\n"</span>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, ulFlags));
00096 
00097     ErrLog = <a class="code" href="../../d7/d5/ioerr_8c.html#a0">IoepInitErrLog</a>(<a class="code" href="../../d6/d5/ioep_8h.html#a12">THREADKEY_IRP</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, ulFlags);
00098 
00099     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"=%p\n"</span>, ErrLog));
00100     <span class="keywordflow">return</span> ErrLog;
00101 }       <span class="comment">//IoErrInitErrLogByIrp</span>
00102 
00103 HANDLE
<a name="l00104"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a2">00104</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a2">IoErrInitErrLogByThreadID</a>(
00105     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> ThreadID,
00106     IN ULONG    ulFlags
00107     )
00108 <span class="comment">/*++</span>
00109 <span class="comment"></span>
00110 <span class="comment">Routine Description:</span>
00111 <span class="comment">    This routine initializes an error logging session that is keyed by thread.</span>
00112 <span class="comment"></span>
00113 <span class="comment">Arguments:</span>
00114 <span class="comment">    ThreadID - thread ID</span>
00115 <span class="comment">    ulFlags - log session flags</span>
00116 <span class="comment"></span>
00117 <span class="comment">Return Value:</span>
00118 <span class="comment">    Success - returns the newly created error log handle.</span>
00119 <span class="comment">    Failure - returns NULL.</span>
00120 <span class="comment"></span>
00121 <span class="comment">--*/</span>
00122 {
00123     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrInitErrLogByThreadID"</span>);
00124     <a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a> ErrLog;
00125 
00126     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(ThreadID=%p,ulFlags=%x)\n"</span>, ThreadID, ulFlags));
00127 
00128     ErrLog = <a class="code" href="../../d7/d5/ioerr_8c.html#a0">IoepInitErrLog</a>(<a class="code" href="../../d6/d5/ioep_8h.html#a13">THREADKEY_THREADID</a>, ThreadID, ulFlags);
00129 
00130     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"=%p\n"</span>, ErrLog));
00131     <span class="keywordflow">return</span> ErrLog;
00132 }       <span class="comment">//IoErrInitErrLogByThreadID</span>
00133 
00134 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00135"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a3">00135</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a3">IoErrLogErrByIrp</a>(
00136     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>        Irp,
00137     IN CONST GUID *ComponentGuid,
00138     IN ULONG       ErrCode,
00139     IN PWSTR       TextData OPTIONAL,
00140     IN ULONG       DataBlkType,
00141     IN ULONG       DataBlkLen OPTIONAL,
00142     IN PVOID       DataBlock OPTIONAL,
00143     IN CONST GUID *MofGuid OPTIONAL
00144     )
00145 <span class="comment">/*++</span>
00146 <span class="comment"></span>
00147 <span class="comment">Routine Description:</span>
00148 <span class="comment">    This routine logs the error data to the error log session identified by</span>
00149 <span class="comment">    the given Irp.</span>
00150 <span class="comment"></span>
00151 <span class="comment">Arguments:</span>
00152 <span class="comment">    Irp - points to the Irp that is used as the key to the logging session.</span>
00153 <span class="comment">    ComponentGuid - points to the component GUID of the caller</span>
00154 <span class="comment">    ErrCode - unique error code</span>
00155 <span class="comment">    TextData - points to an optional WSTR of text data</span>
00156 <span class="comment">    DataBlkType - data type of the data block</span>
00157 <span class="comment">    DataBlkLen - length of the data block</span>
00158 <span class="comment">    DataBlock - points to the data block</span>
00159 <span class="comment">    MofGuid - points to the MOF GUID of the data block if applicable</span>
00160 <span class="comment"></span>
00161 <span class="comment">Return Value:</span>
00162 <span class="comment">    None</span>
00163 <span class="comment"></span>
00164 <span class="comment">--*/</span>
00165 {
00166     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrLogErrByIrp"</span>);
00167 
00168     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(Irp=%p,pGuid=%p,ErrCode=%x,Text=%S,Type=%x,Len=%d,DataBlk=%p,MofGuid=%p)\n"</span>,
00169               <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, ComponentGuid, ErrCode, TextData? TextData: <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>, DataBlkType,
00170               DataBlkLen, DataBlock, MofGuid));
00171 
00172     <a class="code" href="../../d7/d5/ioerr_8c.html#a3">IoepLogErr</a>(<a class="code" href="../../d6/d5/ioep_8h.html#a12">THREADKEY_IRP</a>,
00173                <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
00174                ComponentGuid,
00175                ErrCode,
00176                TextData,
00177                DataBlkType,
00178                DataBlkLen,
00179                DataBlock,
00180                MofGuid);
00181 
00182     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"!\n"</span>));
00183 }       <span class="comment">//IoErrLogErrByIrp</span>
00184 
00185 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00186"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a4">00186</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a4">IoErrLogErrByThreadID</a>(
00187     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>    ThreadID,
00188     IN CONST GUID *ComponentGuid,
00189     IN ULONG       ErrCode,
00190     IN PWSTR       TextData OPTIONAL,
00191     IN ULONG       DataBlkType,
00192     IN ULONG       DataBlkLen OPTIONAL,
00193     IN PVOID       DataBlock OPTIONAL,
00194     IN CONST GUID *MofGuid OPTIONAL
00195     )
00196 <span class="comment">/*++</span>
00197 <span class="comment"></span>
00198 <span class="comment">Routine Description:</span>
00199 <span class="comment">    This routine logs the error data to the error log session identified by</span>
00200 <span class="comment">    the given ThreadID.</span>
00201 <span class="comment"></span>
00202 <span class="comment">Arguments:</span>
00203 <span class="comment">    ThreadID - points to the ThreadID that is used as the key to the logging</span>
00204 <span class="comment">               session.</span>
00205 <span class="comment">    ComponentGuid - points to the component GUID of the caller</span>
00206 <span class="comment">    ErrCode - unique error code</span>
00207 <span class="comment">    TextData - points to an optional WSTR of text data</span>
00208 <span class="comment">    DataBlkType - data type of the data block</span>
00209 <span class="comment">    DataBlkLen - length of the data block</span>
00210 <span class="comment">    DataBlock - points to the data block</span>
00211 <span class="comment">    MofGuid - points to the MOF GUID of the data block if applicable</span>
00212 <span class="comment"></span>
00213 <span class="comment">Return Value:</span>
00214 <span class="comment">    None</span>
00215 <span class="comment"></span>
00216 <span class="comment">--*/</span>
00217 {
00218     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrLogErrByThreadID"</span>);
00219 
00220     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(ThreadID=%p,pGuid=%p,ErrCode=%x,Text=%S,Type=%x,Len=%d,DataBlk=%p,MofGuid=%p)\n"</span>,
00221               ThreadID, ComponentGuid, ErrCode, TextData? TextData: <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>,
00222               DataBlkType, DataBlkLen, DataBlock, MofGuid));
00223 
00224     <a class="code" href="../../d7/d5/ioerr_8c.html#a3">IoepLogErr</a>(<a class="code" href="../../d6/d5/ioep_8h.html#a13">THREADKEY_THREADID</a>,
00225                ThreadID,
00226                ComponentGuid,
00227                ErrCode,
00228                TextData,
00229                DataBlkType,
00230                DataBlkLen,
00231                DataBlock,
00232                MofGuid);
00233 
00234     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"!\n"</span>));
00235 }       <span class="comment">//IoErrLogErrByThreadID</span>
00236 
00237 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00238"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a5">00238</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a5">IoErrPropagateErrLog</a>(
00239     IN HANDLE ErrLogHandle
00240     )
00241 <span class="comment">/*++</span>
00242 <span class="comment"></span>
00243 <span class="comment">Routine Description:</span>
00244 <span class="comment">    This routine propagates the error log stack from the current error log</span>
00245 <span class="comment">    session to the next nested error log session.</span>
00246 <span class="comment"></span>
00247 <span class="comment">Arguments:</span>
00248 <span class="comment">    ErrLogHandle - points to the error log session</span>
00249 <span class="comment"></span>
00250 <span class="comment">Return Value:</span>
00251 <span class="comment">    None</span>
00252 <span class="comment"></span>
00253 <span class="comment">--*/</span>
00254 {
00255     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrPropagateErrLog"</span>);
00256     <a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a> ErrLog = (<a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a>)ErrLogHandle;
00257 
00258     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrLogHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00259     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((<a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a>)ErrLogHandle)-&gt;Signature == <a class="code" href="../../d6/d5/ioep_8h.html#a22">SIG_ERRLOG</a>);
00260     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(ErrLog=%p)\n"</span>, ErrLogHandle));
00261 
00262     <span class="keywordflow">if</span> ((ErrLog != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o0">Signature</a> == <a class="code" href="../../d6/d5/ioep_8h.html#a22">SIG_ERRLOG</a>))
00263     {
00264         <a class="code" href="../../d1/d5/struct__errentry.html">PERRENTRY</a> ErrStack;
00265         KIRQL Irql;
00266 
00267         ExAcquireSpinLock(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>, &amp;Irql);
00268         ErrStack = <a class="code" href="../../d6/d5/ioep_8h.html#a25">IoepGetErrStack</a>((<a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a>)ErrLogHandle);
00269         <span class="keywordflow">if</span> (ErrStack != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00270         {
00271             <a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a> ErrLogNext;
00272 
00273             ErrLogNext = CONTAINING_RECORD(ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o2">list</a>.Flink, <a class="code" href="../../d4/d5/struct__errlog.html">ERRLOG</a>, list);
00274             <span class="keywordflow">if</span> (&amp;ErrLogNext-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o2">list</a> != &amp;ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o4">ErrThread</a>-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o1">ErrLogListHead</a>)
00275             {
00276                 PSINGLE_LIST_ENTRY ErrTail;
00277 
00278                 <span class="keywordflow">for</span> (ErrTail = &amp;ErrStack-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o0">slist</a>;
00279                      ErrTail-&gt;Next != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00280                      ErrTail = ErrTail-&gt;Next)
00281                     ;
00282 
00283                 ErrTail-&gt;Next = ErrLogNext-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o3">ErrStack</a>.Next;
00284                 ErrLogNext-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o3">ErrStack</a>.Next = ErrStack-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o0">slist</a>.Next;
00285                 ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o3">ErrStack</a>.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00286                 <span class="keywordflow">if</span> (ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o5">ErrInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00287                 {
00288                     ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o5">ErrInfo</a>-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o0">Signature</a> = 0;
00289                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o5">ErrInfo</a>);
00290                     ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o5">ErrInfo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00291                 }
00292             }
00293         }
00294         ExReleaseSpinLock(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>, Irql);
00295     }
00296     <span class="keywordflow">else</span>
00297     {
00298         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"invalid handle\n"</span>))
00299     }
00300 
00301     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"!\n"</span>));
00302 }       <span class="comment">//IoErrPropagateErrLog</span>
00303 
00304 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00305"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a6">00305</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a6">IoErrTerminateErrLog</a>(
00306     IN HANDLE ErrLogHandle
00307     )
00308 <span class="comment">/*++</span>
00309 <span class="comment"></span>
00310 <span class="comment">Routine Description:</span>
00311 <span class="comment">    This routine terminates an error log session.</span>
00312 <span class="comment"></span>
00313 <span class="comment">Arguments:</span>
00314 <span class="comment">    ErrLogHandle - points to the error log session</span>
00315 <span class="comment"></span>
00316 <span class="comment">Return Value:</span>
00317 <span class="comment">    None</span>
00318 <span class="comment"></span>
00319 <span class="comment">--*/</span>
00320 {
00321     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrTerminateErrLog"</span>);
00322     <a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a> ErrLog = (<a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a>)ErrLogHandle;
00323 
00324     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrLogHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00325     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((<a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a>)ErrLogHandle)-&gt;Signature == <a class="code" href="../../d6/d5/ioep_8h.html#a22">SIG_ERRLOG</a>);
00326     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(ErrLog=%p)\n"</span>, ErrLogHandle));
00327 
00328     <span class="keywordflow">if</span> ((ErrLog != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o0">Signature</a> == <a class="code" href="../../d6/d5/ioep_8h.html#a22">SIG_ERRLOG</a>))
00329     {
00330         <a class="code" href="../../d1/d5/struct__errentry.html">PERRENTRY</a> ErrStack;
00331         KIRQL Irql;
00332 
00333         ErrStack = <a class="code" href="../../d6/d5/ioep_8h.html#a25">IoepGetErrStack</a>(ErrLog);
00334         <span class="keywordflow">if</span> (ErrStack != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00335         {
00336             <span class="comment">//</span>
00337             <span class="comment">// If we are at the top level log session by Irp and we have an</span>
00338             <span class="comment">// error, we fire a WMI event.</span>
00339             <span class="comment">//</span>
00340             <span class="keywordflow">if</span> ((ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o4">ErrThread</a>-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o2">ThreadKeyType</a> == <a class="code" href="../../d6/d5/ioep_8h.html#a12">THREADKEY_IRP</a>) &amp;&amp;
00341                 (ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o2">list</a>.Flink == &amp;ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o4">ErrThread</a>-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o1">ErrLogListHead</a>))
00342             {
00343                 <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DevNode;
00344 
00345                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a4">ASSERT_PDO</a>(ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o4">ErrThread</a>-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.TargetDevice);
00346                 DevNode = ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o4">ErrThread</a>-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.TargetDevice-&gt;DeviceObjectExtension-&gt;DeviceNode;
00347                 <a class="code" href="../../d7/d5/ioerr_8c.html#a7">IoepFireWMIEvent</a>(<a class="code" href="../../d4/d5/ioeapi_8c.html#a8">IoErrGetErrData</a>(ErrLogHandle),
00348                                  DevNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer);
00349             }
00350 
00351             ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o3">ErrStack</a>.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00352             <a class="code" href="../../d7/d5/ioerr_8c.html#a4">IoepFreeErrStack</a>(ErrStack);
00353         }
00354 
00355         ExAcquireSpinLock(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>, &amp;Irql);
00356         <span class="keywordflow">if</span> (ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o5">ErrInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00357         {
00358             ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o5">ErrInfo</a>-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o0">Signature</a> = 0;
00359             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o5">ErrInfo</a>);
00360             ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o5">ErrInfo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00361         }
00362 
00363         RemoveEntryList(&amp;ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o2">list</a>);
00364         <span class="keywordflow">if</span> (IsListEmpty(&amp;ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o4">ErrThread</a>-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o1">ErrLogListHead</a>))
00365         {
00366             RemoveEntryList(&amp;ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o4">ErrThread</a>-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o0">list</a>);
00367             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o4">ErrThread</a>);
00368             ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o4">ErrThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00369         }
00370         ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o0">Signature</a> = 0;
00371         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ErrLog);
00372         ExReleaseSpinLock(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>, Irql);
00373     }
00374     <span class="keywordflow">else</span>
00375     {
00376         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"invalid handle\n"</span>))
00377     }
00378 
00379     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"!\n"</span>));
00380 }       <span class="comment">//IoErrTerminateErrLog</span>
00381 
00382 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00383"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a7">00383</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a7">IoErrRegisterErrHandlers</a>(
00384     IN CONST GUID  *ComponentGuid,
00385     IN ULONG        NumErrHandlers,
00386     IN <a class="code" href="../../d5/d5/ioeapi_8h.html#a22">PERRHANDLER</a> *HandlerTable
00387     )
00388 <span class="comment">/*++</span>
00389 <span class="comment"></span>
00390 <span class="comment">Routine Description:</span>
00391 <span class="comment">    This routine registers error handlers for the caller module.</span>
00392 <span class="comment"></span>
00393 <span class="comment">Arguments:</span>
00394 <span class="comment">    ComponentGuid - points to the GUID of the caller component</span>
00395 <span class="comment">    NumErrHandlers - number of error handlers in the table</span>
00396 <span class="comment">    HandlerTable - points to the error handler table</span>
00397 <span class="comment"></span>
00398 <span class="comment">Return Value:</span>
00399 <span class="comment">    Success - returns STATUS_SUCCESS</span>
00400 <span class="comment">    Failure - returns NT status code</span>
00401 <span class="comment"></span>
00402 <span class="comment">--*/</span>
00403 {
00404     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrRegisterErrHandlers"</span>);
00405     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00406     <a class="code" href="../../d5/d5/struct__errmodule.html">PERRMODULE</a> ErrModule;
00407 
00408     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ComponentGuid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00409     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NumErrHandlers &gt; 0);
00410     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(HandlerTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00411     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(pGuid=%p,NumHandlers=%d,HandleTable=%p)\n"</span>,
00412               ComponentGuid, NumErrHandlers, HandlerTable));
00413 
00414     ErrModule = <a class="code" href="../../d7/d5/ioerr_8c.html#a5">IoepFindErrModule</a>(ComponentGuid);
00415     <span class="keywordflow">if</span> (ErrModule == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00416     {
00417         ErrModule = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00418                         <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00419                         <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__errmodule.html">ERRMODULE</a>) +
00420                         <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/ioeapi_8h.html#a22">PERRHANDLER</a>)*(NumErrHandlers - 1),
00421                         <a class="code" href="../../d6/d5/ioep_8h.html#a4">IOETAG_ERRMODULE</a>);
00422 
00423         <span class="keywordflow">if</span> (ErrModule != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00424         {
00425             ErrModule-&gt;<a class="code" href="../../d5/d5/struct__errmodule.html#o1">ComponentGuid</a> = *ComponentGuid;
00426             ErrModule-&gt;<a class="code" href="../../d5/d5/struct__errmodule.html#o2">NumErrHandlers</a> = NumErrHandlers;
00427             RtlCopyMemory(ErrModule-&gt;<a class="code" href="../../d5/d5/struct__errmodule.html#o3">HandlerTable</a>,
00428                           HandlerTable,
00429                           <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/ioeapi_8h.html#a22">PERRHANDLER</a>)*NumErrHandlers);
00430             <a class="code" href="../../d5/d8/ex_8h.html#a238">ExInterlockedInsertTailList</a>(&amp;<a class="code" href="../../d0/d2/data_8c.html#a3">IoepErrModuleListHead</a>,
00431                                         &amp;ErrModule-&gt;<a class="code" href="../../d5/d5/struct__errmodule.html#o0">list</a>,
00432                                         &amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>);
00433             status = STATUS_SUCCESS;
00434         }
00435         <span class="keywordflow">else</span>
00436         {
00437             status = STATUS_INSUFFICIENT_RESOURCES;
00438             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate error module\n"</span>));
00439         }
00440     }
00441     <span class="keywordflow">else</span>
00442     {
00443         status = <a class="code" href="../../d5/d5/ioeapi_8h.html#a1">STATUS_IOE_MODULE_ALREADY_REGISTERED</a>;
00444         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"error module already registered\n"</span>));
00445     }
00446 
00447     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"=%x\n"</span>, status));
00448     <span class="keywordflow">return</span> status;
00449 }       <span class="comment">//IoErrRegisterErrHandlers</span>
00450 
00451 <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a>
<a name="l00452"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a8">00452</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a8">IoErrGetErrData</a>(
00453     IN HANDLE ErrLogHandle
00454     )
00455 <span class="comment">/*++</span>
00456 <span class="comment"></span>
00457 <span class="comment">Routine Description:</span>
00458 <span class="comment">    This routine returns the error data from the error log session.</span>
00459 <span class="comment"></span>
00460 <span class="comment">Arguments:</span>
00461 <span class="comment">    ErrLogHandle - points to the error log session</span>
00462 <span class="comment"></span>
00463 <span class="comment">Return Value:</span>
00464 <span class="comment">    Success - returns pointer to the error info structure</span>
00465 <span class="comment">    Failure - returns NULL</span>
00466 <span class="comment"></span>
00467 <span class="comment">--*/</span>
00468 {
00469     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrGetErrData"</span>);
00470     <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00471     <a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a> ErrLog = (<a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a>)ErrLogHandle;
00472 
00473     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrLogHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00474     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((<a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a>)ErrLogHandle)-&gt;Signature == <a class="code" href="../../d6/d5/ioep_8h.html#a22">SIG_ERRLOG</a>);
00475     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(ErrLog=%p)\n"</span>, ErrLogHandle));
00476 
00477     <span class="keywordflow">if</span> ((ErrLog != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o0">Signature</a> == <a class="code" href="../../d6/d5/ioep_8h.html#a22">SIG_ERRLOG</a>))
00478     {
00479         <span class="keywordflow">if</span> (ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o5">ErrInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00480         {
00481             ErrInfo = ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o5">ErrInfo</a>;
00482         }
00483         <span class="keywordflow">else</span>
00484         {
00485             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00486             ULONG len;
00487 
00488             status = <a class="code" href="../../d7/d5/ioerr_8c.html#a6">IoepExtractErrData</a>(<a class="code" href="../../d6/d5/ioep_8h.html#a25">IoepGetErrStack</a>(ErrLog),
00489                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00490                                         0,
00491                                         &amp;len);
00492             <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL)
00493             {
00494                 ErrInfo = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00495                                                 len,
00496                                                 <a class="code" href="../../d6/d5/ioep_8h.html#a9">IOETAG_ERRINFO</a>);
00497                 <span class="keywordflow">if</span> (ErrInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00498                 {
00499                     status = <a class="code" href="../../d7/d5/ioerr_8c.html#a6">IoepExtractErrData</a>(
00500                                     <a class="code" href="../../d6/d5/ioep_8h.html#a25">IoepGetErrStack</a>(ErrLog),
00501                                     ErrInfo,
00502                                     len,
00503                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00504                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00505                     {
00506                         ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o5">ErrInfo</a> = ErrInfo;
00507                     }
00508                     <span class="keywordflow">else</span>
00509                     {
00510                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ErrInfo);
00511                         ErrInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00512                         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to get error data (rc=%x)\n"</span>,
00513                                   status));
00514                     }
00515                 }
00516                 <span class="keywordflow">else</span>
00517                 {
00518                     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate error info buffer (len=%d)\n"</span>,
00519                               len));
00520                 }
00521             }
00522             <span class="keywordflow">else</span>
00523             {
00524                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to determine error data size (rc=%x)\n"</span>, status));
00525             }
00526         }
00527     }
00528     <span class="keywordflow">else</span>
00529     {
00530         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"invalid handle\n"</span>))
00531     }
00532 
00533     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"=%p\n"</span>, ErrInfo));
00534     <span class="keywordflow">return</span> ErrInfo;
00535 }       <span class="comment">//IoErrGetErrData</span>
00536 
00537 HANDLE
<a name="l00538"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a9">00538</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a9">IoErrSaveErrData</a>(
00539     IN HANDLE ErrLogHandle,
00540     IN PVOID  DataTag OPTIONAL,
00541     IN ULONG  TagFlags OPTIONAL
00542     )
00543 <span class="comment">/*++</span>
00544 <span class="comment"></span>
00545 <span class="comment">Routine Description:</span>
00546 <span class="comment">    This routine saves the error data and returns a handle to the saved data.</span>
00547 <span class="comment"></span>
00548 <span class="comment">Arguments:</span>
00549 <span class="comment">    ErrLogHandle - points to the error log session</span>
00550 <span class="comment">    DataTag - tag to be associated with for the saved error data</span>
00551 <span class="comment">    KeyFlags - flags about the DataTag:</span>
00552 <span class="comment">        IOEDATATAG_TYPE_DEVNODE - DataTag is a DevNode pointer</span>
00553 <span class="comment"></span>
00554 <span class="comment">Return Value:</span>
00555 <span class="comment">    Success - returns the detached error log handle</span>
00556 <span class="comment">    Failure - returns NULL</span>
00557 <span class="comment"></span>
00558 <span class="comment">--*/</span>
00559 {
00560     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrSaveErrData"</span>);
00561     <a class="code" href="../../d8/d7/struct__savedata.html">PSAVEDATA</a> SaveData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00562 
00563     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrLogHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00564     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((<a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a>)ErrLogHandle)-&gt;Signature == <a class="code" href="../../d6/d5/ioep_8h.html#a22">SIG_ERRLOG</a>);
00565     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((TagFlags &amp; ~<a class="code" href="../../d5/d5/ioeapi_8h.html#a11">IOEDATATAG_BITS</a>) == 0);
00566     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(ErrLog=%p,DataTag=%p,TagFlags=%x)\n"</span>,
00567               ErrLogHandle, DataTag, TagFlags));
00568 
00569     <span class="keywordflow">if</span> ((ErrLogHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00570         (((<a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a>)ErrLogHandle)-&gt;Signature == <a class="code" href="../../d6/d5/ioep_8h.html#a22">SIG_ERRLOG</a>))
00571     {
00572         <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo;
00573 
00574         ErrInfo = <a class="code" href="../../d4/d5/ioeapi_8c.html#a8">IoErrGetErrData</a>(ErrLogHandle);
00575         <span class="keywordflow">if</span> (ErrInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00576         {
00577             SaveData = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00578                                              <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__savedata.html">SAVEDATA</a>),
00579                                              <a class="code" href="../../d6/d5/ioep_8h.html#a10">IOETAG_SAVEDATA</a>);
00580             <span class="keywordflow">if</span> (SaveData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00581             {
00582                 ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o3">DataTag</a> = DataTag;
00583                 ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o4">TagFlags</a> = TagFlags &amp; <a class="code" href="../../d5/d5/ioeapi_8h.html#a9">IOEDATATAG_TYPE_MASK</a>;
00584                 SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o0">Signature</a> = <a class="code" href="../../d6/d5/ioep_8h.html#a24">SIG_SAVEDATA</a>;
00585                 SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o2">ErrInfo</a> = ErrInfo;
00586                 ((<a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a>)ErrLogHandle)-&gt;ErrInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00587                 <a class="code" href="../../d5/d8/ex_8h.html#a237">ExInterlockedInsertHeadList</a>(&amp;<a class="code" href="../../d0/d2/data_8c.html#a4">IoepSaveDataListHead</a>,
00588                                             &amp;SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o1">list</a>,
00589                                             &amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>);
00590             }
00591             <span class="keywordflow">else</span>
00592             {
00593                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate save data block\n"</span>));
00594             }
00595         }
00596     }
00597     <span class="keywordflow">else</span>
00598     {
00599         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"invalid handle\n"</span>))
00600     }
00601 
00602     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"=%p\n"</span>, SaveData));
00603     <span class="keywordflow">return</span> SaveData;
00604 }       <span class="comment">//IoErrSaveErrData</span>
00605 
00606 <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a>
<a name="l00607"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a10">00607</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a10">IoErrGetSavedData</a>(
00608     IN HANDLE SaveDataHandle
00609     )
00610 <span class="comment">/*++</span>
00611 <span class="comment"></span>
00612 <span class="comment">Routine Description:</span>
00613 <span class="comment">    This routine returns the error info. from the saved error data.</span>
00614 <span class="comment"></span>
00615 <span class="comment">Arguments:</span>
00616 <span class="comment">    SaveDataHandle - points to the saved error data</span>
00617 <span class="comment"></span>
00618 <span class="comment">Return Value:</span>
00619 <span class="comment">    Success - returns a pointer to the saved error info.</span>
00620 <span class="comment">    Failure - returns NULL</span>
00621 <span class="comment"></span>
00622 <span class="comment">--*/</span>
00623 {
00624     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrGetSavedData"</span>);
00625     <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo;
00626 
00627     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(SaveDataHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00628     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((<a class="code" href="../../d8/d7/struct__savedata.html">PSAVEDATA</a>)SaveDataHandle)-&gt;Signature == <a class="code" href="../../d6/d5/ioep_8h.html#a24">SIG_SAVEDATA</a>);
00629     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(SaveData=%p)\n"</span>, SaveDataHandle));
00630 
00631     <span class="keywordflow">if</span> ((SaveDataHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00632         (((<a class="code" href="../../d8/d7/struct__savedata.html">PSAVEDATA</a>)SaveDataHandle)-&gt;Signature == <a class="code" href="../../d6/d5/ioep_8h.html#a24">SIG_SAVEDATA</a>))
00633     {
00634         ErrInfo = ((<a class="code" href="../../d8/d7/struct__savedata.html">PSAVEDATA</a>)SaveDataHandle)-&gt;ErrInfo;
00635     }
00636     <span class="keywordflow">else</span>
00637     {
00638         ErrInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00639         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"invalid handle\n"</span>))
00640     }
00641 
00642     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"=%p\n"</span>, ErrInfo));
00643     <span class="keywordflow">return</span> ErrInfo;
00644 }       <span class="comment">//IoErrGetSavedData</span>
00645 
00646 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00647"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a11">00647</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a11">IoErrFreeSavedData</a>(
00648     IN HANDLE SaveDataHandle
00649     )
00650 <span class="comment">/*++</span>
00651 <span class="comment"></span>
00652 <span class="comment">Routine Description:</span>
00653 <span class="comment">    This routine frees the storage associated with the saved error data.</span>
00654 <span class="comment">    This function should only be call if the error data has been previously</span>
00655 <span class="comment">    saved via IoErrSaveErrData.</span>
00656 <span class="comment"></span>
00657 <span class="comment">Arguments:</span>
00658 <span class="comment">    SaveDataHandle - points to the save data</span>
00659 <span class="comment"></span>
00660 <span class="comment">Return Value:</span>
00661 <span class="comment">    None</span>
00662 <span class="comment"></span>
00663 <span class="comment">--*/</span>
00664 {
00665     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrFreeSavedData"</span>);
00666     <a class="code" href="../../d8/d7/struct__savedata.html">PSAVEDATA</a> SaveData = (<a class="code" href="../../d8/d7/struct__savedata.html">PSAVEDATA</a>)SaveDataHandle;
00667 
00668     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(SaveDataHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00669     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((<a class="code" href="../../d8/d7/struct__savedata.html">PSAVEDATA</a>)SaveDataHandle)-&gt;Signature == <a class="code" href="../../d6/d5/ioep_8h.html#a24">SIG_SAVEDATA</a>);
00670     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(SaveData=%p)\n"</span>, SaveDataHandle));
00671 
00672     <span class="keywordflow">if</span> ((SaveDataHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00673         (((<a class="code" href="../../d8/d7/struct__savedata.html">PSAVEDATA</a>)SaveDataHandle)-&gt;Signature == <a class="code" href="../../d6/d5/ioep_8h.html#a24">SIG_SAVEDATA</a>))
00674     {
00675         KIRQL Irql;
00676 
00677         ExAcquireSpinLock(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>, &amp;Irql);
00678         RemoveEntryList(&amp;SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o1">list</a>);
00679         <span class="keywordflow">if</span> (SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o2">ErrInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00680         {
00681             SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o2">ErrInfo</a>-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o0">Signature</a> = 0;
00682             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o2">ErrInfo</a>);
00683             SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o2">ErrInfo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00684         }
00685         SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o0">Signature</a> = 0;
00686         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SaveData);
00687         ExReleaseSpinLock(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>, Irql);
00688     }
00689     <span class="keywordflow">else</span>
00690     {
00691         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"invalid handle\n"</span>))
00692     }
00693 
00694     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"!\n"</span>));
00695 }       <span class="comment">//IoErrFreeSavedData</span>
00696 
00697 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00698"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a12">00698</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a12">IoErrRetrieveSavedData</a>(
00699     OUT <a class="code" href="../../d1/d2/struct__infoblk.html">PINFOBLK</a> InfoBlk,
00700     IN  ULONG    BuffSize,
00701     OUT PULONG   DataSize OPTIONAL,
00702     IN  PVOID    DataTag OPTIONAL,
00703     IN  ULONG    TagFlags OPTIONAL
00704     )
00705 <span class="comment">/*++</span>
00706 <span class="comment"></span>
00707 <span class="comment">Routine Description:</span>
00708 <span class="comment">    This routine returns the saved error info. in the given buffer.  If no</span>
00709 <span class="comment">    DataTag is given, data of all saved error info. are returned.  Otherwise,</span>
00710 <span class="comment">    only the data of the error info. which matches the data tag is returned.</span>
00711 <span class="comment"></span>
00712 <span class="comment">Arguments:</span>
00713 <span class="comment">    InfoBlk - points to the buffer to receive the data</span>
00714 <span class="comment">    BuffSize - specifies the size of the buffer</span>
00715 <span class="comment">    DataSize - points to the variable to receive the actual data size</span>
00716 <span class="comment">    DataTag - tag associated with the data info.</span>
00717 <span class="comment">    TagFlags - tag flags</span>
00718 <span class="comment"></span>
00719 <span class="comment">Return Value:</span>
00720 <span class="comment">    Success - returns STATUS_SUCCESS</span>
00721 <span class="comment">    Failure - returns NT status code</span>
00722 <span class="comment"></span>
00723 <span class="comment">--*/</span>
00724 {
00725     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrRetrieveSavedData"</span>);
00726     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00727     PLIST_ENTRY list;
00728     ULONG len, i;
00729     <a class="code" href="../../d8/d7/struct__savedata.html">PSAVEDATA</a> SaveData;
00730 
00731     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((InfoBlk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (BuffSize &gt; 0) || (DataSize != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
00732     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(Buff=%p,BuffSize=%d,pDataSize=%p,DataTag=%p,TagFlags=%x)\n"</span>,
00733               InfoBlk, BuffSize, DataSize, DataTag, TagFlags));
00734 
00735     <span class="keywordflow">for</span> (list = <a class="code" href="../../d0/d2/data_8c.html#a4">IoepSaveDataListHead</a>.Flink,
00736          len = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d2/struct__infoblk.html">INFOBLK</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__errinfo.html">ERRINFO</a>),
00737          i = 0;
00738          list != &amp;<a class="code" href="../../d0/d2/data_8c.html#a4">IoepSaveDataListHead</a>;
00739          list = list-&gt;Flink)
00740     {
00741         SaveData = CONTAINING_RECORD(list, <a class="code" href="../../d8/d7/struct__savedata.html">SAVEDATA</a>, list);
00742         <span class="keywordflow">if</span> ((DataTag == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00743             (DataTag == SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o2">ErrInfo</a>-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o3">DataTag</a>) &amp;&amp;
00744             (TagFlags == SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o2">ErrInfo</a>-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o4">TagFlags</a> &amp; <a class="code" href="../../d5/d5/ioeapi_8h.html#a9">IOEDATATAG_TYPE_MASK</a>))
00745         {
00746             i++;
00747             len += SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o2">ErrInfo</a>-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o2">Size</a>;
00748         }
00749     }
00750 
00751     <span class="keywordflow">if</span> (len &lt;= BuffSize)
00752     {
00753         <span class="keywordflow">if</span> ((InfoBlk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (BuffSize &gt; 0))
00754         {
00755             <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo;
00756 
00757             InfoBlk-&gt;Signature = <a class="code" href="../../d5/d5/ioeapi_8h.html#a13">SIG_INFOBLK</a>;
00758             InfoBlk-&gt;Version = <a class="code" href="../../d6/d5/ioep_8h.html#a19">IOE_INFOBLK_VERSION</a>;
00759             InfoBlk-&gt;Size = len;
00760             InfoBlk-&gt;NumErrInfos = i;
00761 
00762             <span class="keywordflow">for</span> (list = <a class="code" href="../../d0/d2/data_8c.html#a4">IoepSaveDataListHead</a>.Flink,
00763                  ErrInfo = &amp;InfoBlk-&gt;ErrInfos[0];
00764                  list != &amp;<a class="code" href="../../d0/d2/data_8c.html#a4">IoepSaveDataListHead</a>;
00765                  list = list-&gt;Flink)
00766             {
00767                 SaveData = CONTAINING_RECORD(list, <a class="code" href="../../d8/d7/struct__savedata.html">SAVEDATA</a>, list);
00768                 <span class="keywordflow">if</span> ((DataTag == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00769                     (DataTag == SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o2">ErrInfo</a>-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o3">DataTag</a>) &amp;&amp;
00770                     (TagFlags == SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o2">ErrInfo</a>-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o4">TagFlags</a> &amp;
00771                      <a class="code" href="../../d5/d5/ioeapi_8h.html#a9">IOEDATATAG_TYPE_MASK</a>))
00772                 {
00773                     RtlCopyMemory(ErrInfo,
00774                                   SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o2">ErrInfo</a>,
00775                                   SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o2">ErrInfo</a>-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o2">Size</a>);
00776                     ErrInfo = (<a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a>)((PUCHAR)ErrInfo +
00777                                          SaveData-&gt;<a class="code" href="../../d8/d7/struct__savedata.html#o2">ErrInfo</a>-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o2">Size</a>);
00778                 }
00779             }
00780         }
00781 
00782         status = STATUS_SUCCESS;
00783     }
00784     <span class="keywordflow">else</span>
00785     {
00786         status = STATUS_BUFFER_TOO_SMALL;
00787         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"buffer too small (size=%d,need=%d)\n"</span>, BuffSize, len));
00788     }
00789 
00790     <span class="keywordflow">if</span> (DataSize != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00791     {
00792         *DataSize = len;
00793     }
00794 
00795     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"=%x(len=%d)\n"</span>, status, len));
00796     <span class="keywordflow">return</span> status;
00797 }       <span class="comment">//IoErrRetrievedSavedData</span>
00798 
00799 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00800"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a13">00800</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a13">IoErrMatchErrCase</a>(
00801     IN  <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo,
00802     OUT PULONG   ErrCaseID,
00803     OUT PHANDLE  ErrCaseHandle OPTIONAL
00804     )
00805 <span class="comment">/*++</span>
00806 <span class="comment"></span>
00807 <span class="comment">Routine Description:</span>
00808 <span class="comment">    This routine gets the indexed error entry from the error stack.</span>
00809 <span class="comment"></span>
00810 <span class="comment">Arguments:</span>
00811 <span class="comment">    ErrInfo - points to the error info.</span>
00812 <span class="comment">    ErrCaseID - points to the variable to receive the error case ID</span>
00813 <span class="comment">    ErrCaseHandle - points to the variable to receive the error case handle</span>
00814 <span class="comment"></span>
00815 <span class="comment">Return Value:</span>
00816 <span class="comment">    Success - returns STATUS_SUCCESS</span>
00817 <span class="comment">    Failure - returns NT status code</span>
00818 <span class="comment"></span>
00819 <span class="comment">--*/</span>
00820 {
00821     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrMatchErrCase"</span>);
00822     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00823 
00824     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00825     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrInfo-&gt;Signature == <a class="code" href="../../d5/d5/ioeapi_8h.html#a12">SIG_ERRINFO</a>);
00826     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrCaseID != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00827     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00828     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(ErrInfo=%p,pErrCaseID=%p,pErrCaseHandle=%p)\n"</span>,
00829               ErrInfo, ErrCaseID, ErrCaseHandle));
00830 
00831     <span class="keywordflow">if</span> ((ErrInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ErrInfo-&gt;Signature == <a class="code" href="../../d5/d5/ioeapi_8h.html#a12">SIG_ERRINFO</a>))
00832     {
00833         <a class="code" href="../../d9/d4/struct__errcasedb.html">PERRCASEDB</a> ErrCaseDB = <a class="code" href="../../d7/d5/ioerr_8c.html#a14">IoepGetErrCaseDB</a>();
00834 
00835         <span class="keywordflow">if</span> (ErrCaseDB != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00836         {
00837             <a class="code" href="../../d8/d4/struct__errcase.html">PERRCASE</a> ErrCaseTable;
00838             <a class="code" href="../../d2/d5/struct__errid.html">PERRID</a> ErrIDPath;
00839             ULONG i;
00840 
00841             ErrCaseTable = (<a class="code" href="../../d8/d4/struct__errcase.html">PERRCASE</a>)((ULONG_PTR)ErrCaseDB +
00842                                       ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o4">ErrCaseOffset</a>);
00843 
00844             <span class="keywordflow">for</span> (i = 0, status = STATUS_NOT_FOUND; i &lt; ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o5">NumErrCases</a>; ++i)
00845             {
00846                 ErrIDPath = (<a class="code" href="../../d2/d5/struct__errid.html">PERRID</a>)((ULONG_PTR)ErrCaseDB +
00847                                      ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o6">ErrIDPathBlkOffset</a> +
00848                                      ErrCaseTable[i].<a class="code" href="../../d8/d4/struct__errcase.html#o1">ErrIDPathOffset</a>);
00849 
00850                 <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5/ioerr_8c.html#a10">IoepMatchErrIDPath</a>(ErrInfo,
00851                                        ErrIDPath,
00852                                        ErrCaseTable[i].NumErrIDs))
00853                 {
00854                     *ErrCaseID = ErrCaseTable[i].<a class="code" href="../../d8/d4/struct__errcase.html#o0">ErrCaseID</a>;
00855                     <span class="keywordflow">if</span> (ErrCaseHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00856                     {
00857                         *ErrCaseHandle = &amp;ErrCaseTable[i];
00858                     }
00859                     status = STATUS_SUCCESS;
00860                     <span class="keywordflow">break</span>;
00861                 }
00862             }
00863         }
00864         <span class="keywordflow">else</span>
00865         {
00866             status = <a class="code" href="../../d5/d5/ioeapi_8h.html#a2">STATUS_IOE_DATABASE_NOT_READY</a>;
00867             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"error case database not ready\n"</span>));
00868         }
00869     }
00870     <span class="keywordflow">else</span>
00871     {
00872         status = STATUS_INVALID_PARAMETER;
00873         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"invalid handle\n"</span>))
00874     }
00875 
00876     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"=%x(ErrCaseID=%x,ErrCase=%p)\n"</span>,
00877              status, *ErrCaseID, ErrCaseHandle? *ErrCaseHandle: 0));
00878     <span class="keywordflow">return</span> status;
00879 }       <span class="comment">//IoErrMatchErrCase</span>
00880 
00881 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00882"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a14">00882</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a14">IoErrFindErrCaseByID</a>(
00883     IN  ULONG   ErrCaseID,
00884     OUT PHANDLE ErrCaseHandle
00885     )
00886 <span class="comment">/*++</span>
00887 <span class="comment"></span>
00888 <span class="comment">Routine Description:</span>
00889 <span class="comment">    This routine finds an error case by the error case ID and returns the</span>
00890 <span class="comment">    handle to the error case.</span>
00891 <span class="comment"></span>
00892 <span class="comment">Arguments:</span>
00893 <span class="comment">    ErrCaseID - unique error case ID</span>
00894 <span class="comment">    ErrCaseHandle - points to the variable to receive the error case handle</span>
00895 <span class="comment"></span>
00896 <span class="comment">Return Value:</span>
00897 <span class="comment">    Success - returns STATUS_SUCCESS</span>
00898 <span class="comment">    Failure - returns NT status code</span>
00899 <span class="comment"></span>
00900 <span class="comment">--*/</span>
00901 {
00902     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrFindErrCaseByID"</span>);
00903     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00904     <a class="code" href="../../d9/d4/struct__errcasedb.html">PERRCASEDB</a> ErrCaseDB;
00905 
00906     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00907     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(ErrCaseID=%x,pErrCaseHandle=%p)\n"</span>, ErrCaseID, ErrCaseHandle));
00908 
00909     ErrCaseDB = <a class="code" href="../../d7/d5/ioerr_8c.html#a14">IoepGetErrCaseDB</a>();
00910     <span class="keywordflow">if</span> (ErrCaseDB != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00911     {
00912         <a class="code" href="../../d8/d4/struct__errcase.html">PERRCASE</a> ErrCaseTable;
00913         ULONG i;
00914 
00915         ErrCaseTable = (<a class="code" href="../../d8/d4/struct__errcase.html">PERRCASE</a>)((ULONG_PTR)ErrCaseDB +
00916                                   ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o4">ErrCaseOffset</a>);
00917 
00918         <span class="keywordflow">for</span> (i = 0, status = STATUS_NOT_FOUND; i &lt; ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o5">NumErrCases</a>; ++i)
00919         {
00920             <span class="keywordflow">if</span> (ErrCaseTable[i].<a class="code" href="../../d8/d4/struct__errcase.html#o0">ErrCaseID</a> == ErrCaseID)
00921             {
00922                 *ErrCaseHandle = &amp;ErrCaseTable[i];
00923                 status = STATUS_SUCCESS;
00924                 <span class="keywordflow">break</span>;
00925             }
00926         }
00927     }
00928     <span class="keywordflow">else</span>
00929     {
00930         status = <a class="code" href="../../d5/d5/ioeapi_8h.html#a2">STATUS_IOE_DATABASE_NOT_READY</a>;
00931         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"error case database not ready\n"</span>));
00932     }
00933 
00934     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"=%x(ErrCase=%p)\n"</span>, status, *ErrCaseHandle));
00935     <span class="keywordflow">return</span> status;
00936 }       <span class="comment">//IoErrFindErrCaseByID</span>
00937 
00938 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00939"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a15">00939</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a15">IoErrHandleErrCase</a>(
00940     IN <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo,
00941     IN HANDLE   ErrCaseHandle
00942     )
00943 <span class="comment">/*++</span>
00944 <span class="comment"></span>
00945 <span class="comment">Routine Description:</span>
00946 <span class="comment">    This routine handles an error case by executing the resolution method.</span>
00947 <span class="comment"></span>
00948 <span class="comment">Arguments:</span>
00949 <span class="comment">    ErrInfo - points to the error info.</span>
00950 <span class="comment">    ErrCaseHandle - points to the error case handle</span>
00951 <span class="comment"></span>
00952 <span class="comment">Return Value:</span>
00953 <span class="comment">    Success - returns STATUS_SUCCESS</span>
00954 <span class="comment">    Failure - returns NT status code</span>
00955 <span class="comment"></span>
00956 <span class="comment">--*/</span>
00957 {
00958     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrHandleErrCase"</span>);
00959     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00960 
00961     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00962     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrInfo-&gt;Signature == <a class="code" href="../../d5/d5/ioeapi_8h.html#a12">SIG_ERRINFO</a>);
00963     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrCaseHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00964     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00965     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(ErrInfo=%p,ErrCase=%p)\n"</span>, ErrInfo, ErrCaseHandle));
00966 
00967     <span class="keywordflow">if</span> ((ErrInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ErrInfo-&gt;Signature == <a class="code" href="../../d5/d5/ioeapi_8h.html#a12">SIG_ERRINFO</a>))
00968     {
00969         status = <a class="code" href="../../d7/d5/ioerr_8c.html#a8">IoepHandleErrCase</a>(ErrInfo,
00970                                    (<a class="code" href="../../d8/d4/struct__errcase.html">PERRCASE</a>)ErrCaseHandle,
00971                                    <a class="code" href="../../d6/d5/ioep_8h.html#a14">IOEMETHOD_ANY</a>,
00972                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00973     }
00974     <span class="keywordflow">else</span>
00975     {
00976         status = STATUS_INVALID_PARAMETER;
00977         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"invalid handle\n"</span>))
00978     }
00979 
00980     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"=%x\n"</span>, status));
00981     <span class="keywordflow">return</span> status;
00982 }       <span class="comment">//IoErrHandleErrCase</span>
00983 
00984 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00985"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a16">00985</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a16">IoErrGetLongErrMessage</a>(
00986     IN  <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo,
00987     IN  HANDLE   ErrCaseHandle,
00988     OUT PUNICODE_STRING unicodeMsg
00989     )
00990 <span class="comment">/*++</span>
00991 <span class="comment"></span>
00992 <span class="comment">Routine Description:</span>
00993 <span class="comment">    This routine handles the error case by executing the long message method</span>
00994 <span class="comment">    and returns the resulting message.</span>
00995 <span class="comment"></span>
00996 <span class="comment">Arguments:</span>
00997 <span class="comment">    ErrInfo - points to the error info.</span>
00998 <span class="comment">    ErrCaseHandle - points to the error case handle</span>
00999 <span class="comment">    unicodeMsg - points to the uninitialized unicode string message buffer</span>
01000 <span class="comment"></span>
01001 <span class="comment">Return Value:</span>
01002 <span class="comment">    Success - returns STATUS_SUCCESS</span>
01003 <span class="comment">    Failure - returns NT status code</span>
01004 <span class="comment"></span>
01005 <span class="comment">Note:</span>
01006 <span class="comment">    This routine will allocate the actual string buffer of the unicode message.</span>
01007 <span class="comment">    Therefore, it is the caller's responsibility to free the message buffer</span>
01008 <span class="comment">    via RtlFreeUnicodeString.</span>
01009 <span class="comment"></span>
01010 <span class="comment">--*/</span>
01011 {
01012     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrGetLongErrMessage"</span>);
01013     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01014 
01015     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01016     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrInfo-&gt;Signature == <a class="code" href="../../d5/d5/ioeapi_8h.html#a12">SIG_ERRINFO</a>);
01017     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrCaseHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01018     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(unicodeMsg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01019     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01020     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(ErrInfo=%p,ErrCase=%p,pMsg=%p)\n"</span>,
01021               ErrInfo, ErrCaseHandle, unicodeMsg));
01022 
01023     <span class="keywordflow">if</span> ((ErrInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ErrInfo-&gt;Signature == <a class="code" href="../../d5/d5/ioeapi_8h.html#a12">SIG_ERRINFO</a>))
01024     {
01025         status = <a class="code" href="../../d7/d5/ioerr_8c.html#a8">IoepHandleErrCase</a>(ErrInfo,
01026                                    (<a class="code" href="../../d8/d4/struct__errcase.html">PERRCASE</a>)ErrCaseHandle,
01027                                    <a class="code" href="../../d6/d5/ioep_8h.html#a15">IOEMETHOD_LONGMSG</a>,
01028                                    unicodeMsg);
01029     }
01030     <span class="keywordflow">else</span>
01031     {
01032         status = STATUS_INVALID_PARAMETER;
01033         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"invalid handle\n"</span>))
01034     }
01035 
01036     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"=%x(Msg=%S)\n"</span>, status, unicodeMsg-&gt;Buffer));
01037     <span class="keywordflow">return</span> status;
01038 }       <span class="comment">//IoErrGetLongErrMessage</span>
01039 
01040 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01041"></a><a class="code" href="../../d4/d5/ioeapi_8c.html#a17">01041</a> <a class="code" href="../../d4/d5/ioeapi_8c.html#a17">IoErrGetShortErrMessage</a>(
01042     IN  <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo,
01043     IN  HANDLE   ErrCaseHandle,
01044     OUT PUNICODE_STRING unicodeMsg
01045     )
01046 <span class="comment">/*++</span>
01047 <span class="comment"></span>
01048 <span class="comment">Routine Description:</span>
01049 <span class="comment">    This routine handles the error case by executing the short message method</span>
01050 <span class="comment">    and returns the resulting message.</span>
01051 <span class="comment"></span>
01052 <span class="comment">Arguments:</span>
01053 <span class="comment">    ErrInfo - points to the error info.</span>
01054 <span class="comment">    ErrCaseHandle - points to the error case handle</span>
01055 <span class="comment">    unicodeMsg - points to the uninitialized unicode string message buffer</span>
01056 <span class="comment"></span>
01057 <span class="comment">Return Value:</span>
01058 <span class="comment">    Success - returns STATUS_SUCCESS</span>
01059 <span class="comment">    Failure - returns NT status code</span>
01060 <span class="comment"></span>
01061 <span class="comment">Note:</span>
01062 <span class="comment">    This routine will allocate the actual string buffer of the unicode message.</span>
01063 <span class="comment">    Therefore, it is the caller's responsibility to free the message buffer</span>
01064 <span class="comment">    via RtlFreeUnicodeString.</span>
01065 <span class="comment"></span>
01066 <span class="comment">--*/</span>
01067 {
01068     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoErrGetShortErrMessage"</span>);
01069     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01070 
01071     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01072     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrInfo-&gt;Signature == <a class="code" href="../../d5/d5/ioeapi_8h.html#a12">SIG_ERRINFO</a>);
01073     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrCaseHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01074     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(unicodeMsg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01075     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01076     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(1, (<span class="stringliteral">"(ErrInfo=%p,ErrCase=%p,pMsg=%p)\n"</span>,
01077               ErrInfo, ErrCaseHandle, unicodeMsg));
01078 
01079     <span class="keywordflow">if</span> ((ErrInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ErrInfo-&gt;Signature == <a class="code" href="../../d5/d5/ioeapi_8h.html#a12">SIG_ERRINFO</a>))
01080     {
01081         status = <a class="code" href="../../d7/d5/ioerr_8c.html#a8">IoepHandleErrCase</a>(ErrInfo,
01082                                    (<a class="code" href="../../d8/d4/struct__errcase.html">PERRCASE</a>)ErrCaseHandle,
01083                                    <a class="code" href="../../d6/d5/ioep_8h.html#a16">IOEMETHOD_SHORTMSG</a>,
01084                                    unicodeMsg);
01085     }
01086     <span class="keywordflow">else</span>
01087     {
01088         status = STATUS_INVALID_PARAMETER;
01089         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"invalid handle\n"</span>))
01090     }
01091 
01092     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(1, (<span class="stringliteral">"=%x(Msg=%S)\n"</span>, status, unicodeMsg-&gt;Buffer));
01093     <span class="keywordflow">return</span> status;
01094 }       <span class="comment">//IoErrGetShortErrMessage</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
