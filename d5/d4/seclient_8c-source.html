<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: seclient.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>seclient.c</h1><a href="../../d4/d5/seclient_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*++</span>
00003 <span class="comment"></span>
00004 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    seclient.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">   This module implements routines providing client impersonation to</span>
00013 <span class="comment">   communication session layers (such as LPC Ports).</span>
00014 <span class="comment"></span>
00015 <span class="comment">        WARNING: The following notes apply to the use of these services:</span>
00016 <span class="comment"></span>
00017 <span class="comment">        (1)  No synchronization of operations to a security context block are</span>
00018 <span class="comment">             performed by these services.  The caller of these services must</span>
00019 <span class="comment">             ensure that use of an individual security context block is</span>
00020 <span class="comment">             serialized to prevent simultaneous, incompatible updates.</span>
00021 <span class="comment"></span>
00022 <span class="comment">        (2)  Any or all of these services may create, open, or operate on a</span>
00023 <span class="comment">             token object.  This may result in a mutex being acquired at</span>
00024 <span class="comment">             MUTEXT_LEVEL_SE_TOKEN level.  The caller must ensure that no</span>
00025 <span class="comment">             mutexes are held at levels that conflict with this action.</span>
00026 <span class="comment"></span>
00027 <span class="comment"></span>
00028 <span class="comment">Author:</span>
00029 <span class="comment"></span>
00030 <span class="comment">    Jim Kelly (JimK) 1-August-1990</span>
00031 <span class="comment"></span>
00032 <span class="comment">Environment:</span>
00033 <span class="comment"></span>
00034 <span class="comment">    Kernel mode only.</span>
00035 <span class="comment"></span>
00036 <span class="comment">Revision History:</span>
00037 <span class="comment"></span>
00038 <span class="comment">--*/</span>
00039 
00040 
00041 <span class="preprocessor">#include "<a class="code" href="../../d6/d6/sep_8h.html">sep.h</a>"</span>
00042 <span class="preprocessor">#include "seopaque.h"</span>
00043 
00044 
00045 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeCreateClientSecurity)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeUpdateClientSecurity)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeImpersonateClient)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeImpersonateClientEx)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeCreateClientSecurityFromSubjectContext)</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00052 <span class="preprocessor"></span>
00053 
00055 <span class="comment">//                                                                    //</span>
00056 <span class="comment">//           Routines                                                 //</span>
00057 <span class="comment">//                                                                    //</span>
00059 <span class="comment"></span>
00060 
00061 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00062"></a><a class="code" href="../../d4/d5/seclient_8c.html#a0">00062</a> <a class="code" href="../../d4/d5/seclient_8c.html#a0">SepCreateClientSecurity</a>(
00063     IN PACCESS_TOKEN Token,
00064     IN PSECURITY_QUALITY_OF_SERVICE ClientSecurityQos,
00065     IN BOOLEAN ServerIsRemote,
00066     TOKEN_TYPE TokenType,
00067     BOOLEAN ThreadEffectiveOnly,
00068     SECURITY_IMPERSONATION_LEVEL ImpersonationLevel,
00069     OUT <a class="code" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a> ClientContext
00070     )
00071 {
00072     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00073     PACCESS_TOKEN DuplicateToken;
00074 
00075     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00076 
00077 
00078     <span class="comment">//</span>
00079     <span class="comment">// Make sure the client is not trying to abuse use of a</span>
00080     <span class="comment">// client of its own by attempting an invalid impersonation.</span>
00081     <span class="comment">// Also set the ClientContext-&gt;DirectAccessEffectiveOnly flag</span>
00082     <span class="comment">// appropriately if the impersonation is legitimate.  The</span>
00083     <span class="comment">// DirectAccessEffectiveOnly flag value will end up being ignored</span>
00084     <span class="comment">// if STATIC mode is requested, but this is the most efficient</span>
00085     <span class="comment">// place to calculate it, and we are optimizing for DYNAMIC mode.</span>
00086     <span class="comment">//</span>
00087 
00088     <span class="keywordflow">if</span> (TokenType == TokenImpersonation) {
00089 
00090         <span class="keywordflow">if</span> ( ClientSecurityQos-&gt;ImpersonationLevel &gt; ImpersonationLevel) {
00091 
00092             <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00093             <span class="keywordflow">return</span> STATUS_BAD_IMPERSONATION_LEVEL;
00094 
00095         }
00096 
00097 
00098         <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a10">SepBadImpersonationLevel</a>(ImpersonationLevel,ServerIsRemote)) {
00099 
00100             <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00101             <span class="keywordflow">return</span> STATUS_BAD_IMPERSONATION_LEVEL;
00102 
00103         } <span class="keywordflow">else</span> {
00104 
00105             <span class="comment">//</span>
00106             <span class="comment">// TokenType is TokenImpersonation and the impersonation is legit.</span>
00107             <span class="comment">// Set the DirectAccessEffectiveOnly flag to be the minimum of</span>
00108             <span class="comment">// the current thread value and the caller specified value.</span>
00109             <span class="comment">//</span>
00110 
00111             ClientContext-&gt;DirectAccessEffectiveOnly =
00112                 ( (ThreadEffectiveOnly || (ClientSecurityQos-&gt;EffectiveOnly)) ?
00113                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00114         }
00115 
00116     } <span class="keywordflow">else</span> {
00117 
00118         <span class="comment">//</span>
00119         <span class="comment">// TokenType is TokenPrimary.  In this case, the client specified</span>
00120         <span class="comment">// EffectiveOnly value is always used.</span>
00121         <span class="comment">//</span>
00122 
00123         ClientContext-&gt;DirectAccessEffectiveOnly =
00124             ClientSecurityQos-&gt;EffectiveOnly;
00125     }
00126 
00127 
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// Copy the token if necessary (i.e., static tracking requested)</span>
00131     <span class="comment">//</span>
00132 
00133     <span class="keywordflow">if</span> (ClientSecurityQos-&gt;ContextTrackingMode == SECURITY_STATIC_TRACKING) {
00134 
00135         ClientContext-&gt;DirectlyAccessClientToken = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00136 
00137         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a6">SeCopyClientToken</a>(
00138                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00139                      ClientSecurityQos-&gt;ImpersonationLevel,
00140                      <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00141                      &amp;DuplicateToken
00142                      );
00143 
00144 
00145         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00146             <a class="code" href="../../d6/d0/obcreate_8c.html#a10">ObDeleteCapturedInsertInfo</a>(DuplicateToken);
00147             }
00148         <span class="comment">//</span>
00149         <span class="comment">// No longer need the pointer to the client's token</span>
00150         <span class="comment">//</span>
00151 
00152         <span class="keywordflow">if</span> (TokenType == TokenPrimary) {
00153             <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00154         } <span class="keywordflow">else</span> {
00155             <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00156         }
00157 
00158         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = DuplicateToken;
00159 
00160 
00161         <span class="comment">//</span>
00162         <span class="comment">// If there was an error, we're done.</span>
00163         <span class="comment">//</span>
00164         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00165             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00166         }
00167 
00168     } <span class="keywordflow">else</span> {
00169 
00170         ClientContext-&gt;DirectlyAccessClientToken = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00171 
00172         <span class="keywordflow">if</span> (ServerIsRemote) {
00173             <span class="comment">//</span>
00174             <span class="comment">// Get a copy of the client token's control information</span>
00175             <span class="comment">// so that we can tell if it changes in the future.</span>
00176             <span class="comment">//</span>
00177 
00178             <a class="code" href="../../d4/d3/token_8c.html#a10">SeGetTokenControlInformation</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00179                                           &amp;ClientContext-&gt;ClientTokenControl
00180                                           );
00181 
00182         }
00183 
00184     }
00185 
00186 
00187 
00188     ClientContext-&gt;SecurityQos.Length =
00189         (ULONG)<span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE);
00190 
00191     ClientContext-&gt;SecurityQos.ImpersonationLevel =
00192         ClientSecurityQos-&gt;ImpersonationLevel;
00193 
00194     ClientContext-&gt;SecurityQos.ContextTrackingMode =
00195         ClientSecurityQos-&gt;ContextTrackingMode;
00196 
00197     ClientContext-&gt;SecurityQos.EffectiveOnly =
00198         ClientSecurityQos-&gt;EffectiveOnly;
00199 
00200     ClientContext-&gt;ServerIsRemote = ServerIsRemote;
00201 
00202     ClientContext-&gt;ClientToken = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00203 
00204     <span class="keywordflow">return</span> STATUS_SUCCESS;
00205 
00206 }
00207 
00208 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00209"></a><a class="code" href="../../d4/d5/seclient_8c.html#a1">00209</a> <a class="code" href="../../d4/d5/seclient_8c.html#a1">SeCreateClientSecurity</a> (
00210     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ClientThread,
00211     IN PSECURITY_QUALITY_OF_SERVICE ClientSecurityQos,
00212     IN BOOLEAN ServerIsRemote,
00213     OUT <a class="code" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a> ClientContext
00214     )
00215 
00216 <span class="comment">/*++</span>
00217 <span class="comment"></span>
00218 <span class="comment">Routine Description:</span>
00219 <span class="comment"></span>
00220 <span class="comment">    This service initializes a context block to represent a client's</span>
00221 <span class="comment">    security context.  This may simply result in a reference to the</span>
00222 <span class="comment">    client's token, or may cause the client's token to be duplicated,</span>
00223 <span class="comment">    depending upon the security quality of service information specified.</span>
00224 <span class="comment"></span>
00225 <span class="comment">                               NOTE</span>
00226 <span class="comment"></span>
00227 <span class="comment">        The code in this routine is optimized for DYNAMIC context</span>
00228 <span class="comment">        tracking.  This is only mode in which direct access to a</span>
00229 <span class="comment">        caller's token is allowed, and the mode expected to be used</span>
00230 <span class="comment">        most often.  STATIC context tracking always requires the</span>
00231 <span class="comment">        caller's token to be copied.</span>
00232 <span class="comment"></span>
00233 <span class="comment"></span>
00234 <span class="comment">Arguments:</span>
00235 <span class="comment"></span>
00236 <span class="comment">    ClientThread - Points to the client's thread.  This is used to</span>
00237 <span class="comment">        locate the client's security context (token).</span>
00238 <span class="comment"></span>
00239 <span class="comment">    ClientSecurityQos - Points to the security quality of service</span>
00240 <span class="comment">        parameters specified by the client for this communication</span>
00241 <span class="comment">        session.</span>
00242 <span class="comment"></span>
00243 <span class="comment">    ServerIsRemote - Provides an indication as to whether the session</span>
00244 <span class="comment">        this context block is being used for is an inter-system</span>
00245 <span class="comment">        session or intra-system session.  This is reconciled with the</span>
00246 <span class="comment">        impersonation level of the client thread's token (in case the</span>
00247 <span class="comment">        client has a client of his own that didn't specify delegation).</span>
00248 <span class="comment"></span>
00249 <span class="comment">    ClientContext - Points to the client security context block to be</span>
00250 <span class="comment">        initialized.</span>
00251 <span class="comment"></span>
00252 <span class="comment"></span>
00253 <span class="comment">Return Value:</span>
00254 <span class="comment"></span>
00255 <span class="comment">    STATUS_SUCCESS - The service completed successfully.</span>
00256 <span class="comment"></span>
00257 <span class="comment">    STATUS_BAD_IMPERSONATION_LEVEL - The client is currently</span>
00258 <span class="comment">        impersonating either an Anonymous or Identification level</span>
00259 <span class="comment">        token, which can not be passed on for use by another server.</span>
00260 <span class="comment">        This status may also be returned if the security context</span>
00261 <span class="comment">        block is for an inter-system communication session and the</span>
00262 <span class="comment">        client thread is impersonating a client of its own using</span>
00263 <span class="comment">        other than delegation impersonation level.</span>
00264 <span class="comment"></span>
00265 <span class="comment"></span>
00266 <span class="comment">--*/</span>
00267 
00268 {
00269     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00270     PACCESS_TOKEN <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00271     TOKEN_TYPE TokenType;
00272     BOOLEAN ThreadEffectiveOnly;
00273     SECURITY_IMPERSONATION_LEVEL ImpersonationLevel;
00274     PACCESS_TOKEN DuplicateToken;
00275 
00276     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00277 
00278     <span class="comment">//</span>
00279     <span class="comment">// Gain access to the client thread's effective token</span>
00280     <span class="comment">//</span>
00281 
00282     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a2">PsReferenceEffectiveToken</a>(
00283                 <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>,
00284                 &amp;TokenType,
00285                 &amp;ThreadEffectiveOnly,
00286                 &amp;ImpersonationLevel
00287                 );
00288 
00289 
00290     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d5/seclient_8c.html#a0">SepCreateClientSecurity</a>(
00291                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00292                 ClientSecurityQos,
00293                 ServerIsRemote,
00294                 TokenType,
00295                 ThreadEffectiveOnly,
00296                 ImpersonationLevel,
00297                 ClientContext );
00298 
00299     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00300 }
00301 
00302 
00303 
00304 <span class="preprocessor">#if SAVE_FOR_PRODUCT_2</span>
00305 <span class="preprocessor"></span>
00306 
00307 
00308 
00309 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00310 <a class="code" href="../../d0/d5/se_8h.html#a175">SeUpdateClientSecurity</a>(
00311     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ClientThread,
00312     IN OUT <a class="code" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a> ClientContext,
00313     OUT PBOOLEAN ChangesMade,
00314     OUT PBOOLEAN NewToken
00315     )
00316 
00317 <span class="comment">/*++</span>
00318 <span class="comment"></span>
00319 <span class="comment">Routine Description:</span>
00320 <span class="comment"></span>
00321 <span class="comment">    This service is used to update a client security context block</span>
00322 <span class="comment">    based upon the client's current security context and the security</span>
00323 <span class="comment">    quality of service parameters specified when the security block</span>
00324 <span class="comment">    was created.  If the SecurityContextTracking specified when the</span>
00325 <span class="comment">    context block was created indicated static tracking, then no</span>
00326 <span class="comment">    change will be made to the context block.  Otherwise, a change may</span>
00327 <span class="comment">    be made.</span>
00328 <span class="comment"></span>
00329 <span class="comment"></span>
00330 <span class="comment">    An indication of whether any changes were made is returned to the</span>
00331 <span class="comment">    caller.  This may be used by communication session layers</span>
00332 <span class="comment">    providing remote communications to decide whether or not to send</span>
00333 <span class="comment">    an updated security context to the remote server's node.  It may</span>
00334 <span class="comment">    also be used by a server session layer to decide whether or not to</span>
00335 <span class="comment">    inform a server that a previously obtained handle to a token no</span>
00336 <span class="comment">    longer represents the current security context.</span>
00337 <span class="comment"></span>
00338 <span class="comment"></span>
00339 <span class="comment">Arguments:</span>
00340 <span class="comment"></span>
00341 <span class="comment">    ClientThread - Points to the client's thread.  This is used to</span>
00342 <span class="comment">        locate the security context to synchronize with.</span>
00343 <span class="comment"></span>
00344 <span class="comment">    ClientContext - Points to client security context block to be</span>
00345 <span class="comment">        updated.</span>
00346 <span class="comment"></span>
00347 <span class="comment">    ChangesMade - Receives an indication as to whether any changes to</span>
00348 <span class="comment">        the client's security context had been made since the last</span>
00349 <span class="comment">        time the security context block was synchronized.  This will</span>
00350 <span class="comment">        always be FALSE if static security tracking is in effect.</span>
00351 <span class="comment"></span>
00352 <span class="comment">    NewToken - Receives an indication as to whether the same token</span>
00353 <span class="comment">        is used to represent the client's current context, or whether</span>
00354 <span class="comment">        the context now points to a new token.  If the client's token</span>
00355 <span class="comment">        is directly referenced, then this indicates the client changed</span>
00356 <span class="comment">        tokens (and the new one is now referenced).  If the client's token</span>
00357 <span class="comment">        isn't directly referenced, then this indicates it was necessary</span>
00358 <span class="comment">        to delete one token and create another one.  This will always be</span>
00359 <span class="comment">        FALSE if static security tracking is in effect.</span>
00360 <span class="comment"></span>
00361 <span class="comment"></span>
00362 <span class="comment">Return Value:</span>
00363 <span class="comment"></span>
00364 <span class="comment">    STATUS_SUCCESS - The service completed successfully.</span>
00365 <span class="comment"></span>
00366 <span class="comment">    STATUS_BAD_IMPERSONATION_LEVEL - The client is currently</span>
00367 <span class="comment">        impersonating either an Anonymous or Identification level</span>
00368 <span class="comment">        token, which can not be passed on for use by another server.</span>
00369 <span class="comment">        This status may also be returned if the security context</span>
00370 <span class="comment">        block is for an inter-system communication session and the</span>
00371 <span class="comment">        client thread is impersonating a client of its own using</span>
00372 <span class="comment">        other than delegation impersonation level.</span>
00373 <span class="comment"></span>
00374 <span class="comment"></span>
00375 <span class="comment">--*/</span>
00376 
00377 {
00378     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00379     PACCESS_TOKEN <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00380     TOKEN_TYPE TokenType;
00381     BOOLEAN ThreadEffectiveOnly;
00382     SECURITY_IMPERSONATION_LEVEL ImpersonationLevel;
00383     PACCESS_TOKEN DuplicateToken;
00384     TOKEN_CONTROL TokenControl;
00385 
00386     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00387 
00388     <span class="keywordflow">if</span> (ClientContext-&gt;SecurityQos.ContextTrackingMode ==
00389         SECURITY_STATIC_TRACKING) {
00390 
00391         (*NewToken) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00392         (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00393         <span class="keywordflow">return</span> STATUS_SUCCESS;
00394 
00395     }
00396 
00397 
00399     <span class="comment">//                                          //</span>
00400     <span class="comment">// Optimize for the directly accessed token //</span>
00401     <span class="comment">//                                          //</span>
00403 <span class="comment"></span>
00404 
00405 
00406     <span class="comment">//</span>
00407     <span class="comment">// Gain access to the client thread's effective token</span>
00408     <span class="comment">//</span>
00409 
00410     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a2">PsReferenceEffectiveToken</a>(
00411                 ClientThread,
00412                 &amp;TokenType,
00413                 &amp;ThreadEffectiveOnly,
00414                 &amp;ImpersonationLevel
00415                 );
00416 
00417 
00418 
00419     <span class="comment">//</span>
00420     <span class="comment">//  See if the token is the same.</span>
00421     <span class="comment">//</span>
00422 
00423 
00424     <a class="code" href="../../d4/d3/token_8c.html#a10">SeGetTokenControlInformation</a>( Token, &amp;TokenControl );
00425 
00426     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d5/se_8h.html#a11">SeSameToken</a>( &amp;TokenControl,
00427                       &amp;ClientContext-&gt;ClientTokenControl) ) {
00428 
00429         (*NewToken = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00430 
00431 
00432         <span class="comment">//</span>
00433         <span class="comment">// Same token.</span>
00434         <span class="comment">// Is it unmodified?</span>
00435         <span class="comment">//</span>
00436 
00437         <span class="keywordflow">if</span> ( (TokenControl.ModifiedId.HighPart ==
00438               ClientContext-&gt;ClientTokenControl.ModifiedId.HighPart) &amp;&amp;
00439              (TokenControl.ModifiedId.LowPart  ==
00440               ClientContext-&gt;ClientTokenControl.ModifiedId.LowPart) )   {
00441 
00442             <span class="comment">//</span>
00443             <span class="comment">// Yup.  No changes necessary.</span>
00444             <span class="comment">//</span>
00445 
00446             <span class="keywordflow">if</span> (TokenType == TokenPrimary) {
00447                 <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>( Token );
00448             } <span class="keywordflow">else</span> {
00449                 <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( Token );
00450             }
00451 
00452             (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00453             <span class="keywordflow">return</span> STATUS_SUCCESS;
00454 
00455         } <span class="keywordflow">else</span> {
00456 
00457             <span class="comment">//</span>
00458             <span class="comment">// Same token, but it has been modified.</span>
00459             <span class="comment">// If we are directly accessing the token, then we can</span>
00460             <span class="comment">// just indicate it has changed and return.  Otherwise</span>
00461             <span class="comment">// we have to actually update our copy of the token.</span>
00462             <span class="comment">//</span>
00463 
00464             (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00465             <span class="keywordflow">if</span> (ClientContext-&gt;DirectlyAccessClientToken) {
00466 
00467                 <span class="keywordflow">if</span> (TokenType == TokenPrimary) {
00468                     <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>( Token );
00469                 } <span class="keywordflow">else</span> {
00470                     <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( Token );
00471                 }
00472 
00473                 <span class="comment">//</span>
00474                 <span class="comment">// Save the new modified count and whether or not</span>
00475                 <span class="comment">// the token is for effective use only</span>
00476                 <span class="comment">//</span>
00477 
00478                 ClientContext-&gt;ClientTokenControl.ModifiedId =
00479                     TokenControl.ModifiedId;
00480                 ClientContext-&gt;DirectAccessEffectiveOnly =
00481                 ( (ThreadEffectiveOnly || (ClientContext-&gt;SecurityQos.EffectiveOnly)) ?
00482                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00483 
00484                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00485             } <span class="keywordflow">else</span> {
00486 
00487                 <span class="comment">//</span>
00488                 <span class="comment">//  There is a possibility for a fair performance gain here</span>
00489                 <span class="comment">//  by just updating the existing token to match its origin.</span>
00490                 <span class="comment">//  However, it isn't clear that this case is ever really</span>
00491                 <span class="comment">//  used, so the effort and complexity is avoided at this time.</span>
00492                 <span class="comment">//  If it is found that this case is used, then this code</span>
00493                 <span class="comment">//  can be added.</span>
00494                 <span class="comment">//</span>
00495                 <span class="comment">//  Instead, we just fall through to the case of completely</span>
00496                 <span class="comment">//  different tokens below.</span>
00497                 <span class="comment">//</span>
00498             }
00499         }
00500     }
00501 
00502 
00503     <span class="comment">//</span>
00504     <span class="comment">// Not the same token, or the same token has changed.</span>
00505     <span class="comment">// In either case, we're going to create a new copy of the token</span>
00506     <span class="comment">// and dump the old copy.</span>
00507     <span class="comment">//</span>
00508     <span class="comment">// Make sure the current impersonation situation is legitimate.</span>
00509     <span class="comment">//</span>
00510 
00511     (*NewToken) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00512     (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00513     <span class="keywordflow">if</span> (TokenType == TokenImpersonation) {
00514         <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a10">SepBadImpersonationLevel</a>(ImpersonationLevel,
00515                                       ClientContext-&gt;ServerIsRemote)) {
00516 
00517             <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( Token );
00518             <span class="keywordflow">return</span> STATUS_BAD_IMPERSONATION_LEVEL;
00519         }
00520     }
00521 
00522 
00523     <span class="comment">//</span>
00524     <span class="comment">// Copy the token</span>
00525     <span class="comment">//</span>
00526 
00527 
00528 
00529     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a6">SeCopyClientToken</a>(
00530                  Token,
00531                  ClientContext-&gt;SecurityQos.ImpersonationLevel,
00532                  KernelMode,
00533                  &amp;DuplicateToken
00534                  );
00535 
00536 
00537     <span class="comment">//</span>
00538     <span class="comment">// No longer need the pointer to the client's effective token</span>
00539     <span class="comment">//</span>
00540 
00541     <span class="keywordflow">if</span> (TokenType == TokenPrimary) {
00542         <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>( Token );
00543     } <span class="keywordflow">else</span> {
00544         <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( Token );
00545     }
00546 
00547 
00548 
00549     <span class="comment">//</span>
00550     <span class="comment">// If there was an error, we're done.</span>
00551     <span class="comment">//</span>
00552     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00553         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00554     }
00555 
00556 
00557     <span class="comment">//</span>
00558     <span class="comment">// Otherwise, replace the current token with the new one.</span>
00559     <span class="comment">//</span>
00560 
00561     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = ClientContext-&gt;ClientToken;
00562     ClientContext-&gt;ClientToken = DuplicateToken;
00563     ClientContext-&gt;DirectlyAccessClientToken = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00564 
00565     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/token_8c.html#a3">SeTokenType</a>( Token ) == TokenPrimary) {
00566         <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>( Token );
00567     } <span class="keywordflow">else</span> {
00568         <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( Token );
00569     }
00570 
00571 
00572     <span class="comment">//</span>
00573     <span class="comment">// Get a copy of the current token's control information</span>
00574     <span class="comment">// so that we can tell if it changes in the future.</span>
00575     <span class="comment">//</span>
00576 
00577     <a class="code" href="../../d4/d3/token_8c.html#a10">SeGetTokenControlInformation</a>( DuplicateToken,
00578                                   &amp;ClientContext-&gt;ClientTokenControl
00579                                   );
00580 
00581 
00582     <span class="keywordflow">return</span> STATUS_SUCCESS;
00583 
00584 }
00585 
00586 
00587 <span class="preprocessor">#endif</span>
00588 <span class="preprocessor"></span>
00589 
00590 
00591 
00592 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00593"></a><a class="code" href="../../d4/d5/seclient_8c.html#a2">00593</a> <a class="code" href="../../d4/d5/seclient_8c.html#a2">SeImpersonateClient</a>(
00594     IN <a class="code" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a> ClientContext,
00595     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ServerThread OPTIONAL
00596     )
00597 <span class="comment">/*++</span>
00598 <span class="comment"></span>
00599 <span class="comment">Routine Description:</span>
00600 <span class="comment"></span>
00601 <span class="comment">    This service is used to cause the calling thread to impersonate a</span>
00602 <span class="comment">    client.  The client security context in ClientContext is assumed to</span>
00603 <span class="comment">    be up to date.</span>
00604 <span class="comment"></span>
00605 <span class="comment"></span>
00606 <span class="comment">Arguments:</span>
00607 <span class="comment"></span>
00608 <span class="comment">    ClientContext - Points to client security context block.</span>
00609 <span class="comment"></span>
00610 <span class="comment">    ServerThread - (Optional) Specifies the thread which is to be made to</span>
00611 <span class="comment">        impersonate the client.  If not specified, the calling thread is</span>
00612 <span class="comment">        used.</span>
00613 <span class="comment"></span>
00614 <span class="comment"></span>
00615 <span class="comment">Return Value:</span>
00616 <span class="comment"></span>
00617 <span class="comment">    None.</span>
00618 <span class="comment"></span>
00619 <span class="comment"></span>
00620 <span class="comment">--*/</span>
00621 
00622 
00623 {
00624 
00625     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00626 
00627 <span class="preprocessor">#if DBG</span>
00628 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SE:  Obsolete call:  SeImpersonateClient\n"</span>);
00629 <span class="preprocessor">#endif</span>
00630 <span class="preprocessor"></span>
00631     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d4/d5/seclient_8c.html#a3">SeImpersonateClientEx</a>( ClientContext, <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a> );
00632 }
00633 
00634 
00635 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00636"></a><a class="code" href="../../d4/d5/seclient_8c.html#a3">00636</a> <a class="code" href="../../d4/d5/seclient_8c.html#a3">SeImpersonateClientEx</a>(
00637     IN <a class="code" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a> ClientContext,
00638     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ServerThread OPTIONAL
00639     )
00640 <span class="comment">/*++</span>
00641 <span class="comment"></span>
00642 <span class="comment">Routine Description:</span>
00643 <span class="comment"></span>
00644 <span class="comment">    This service is used to cause the calling thread to impersonate a</span>
00645 <span class="comment">    client.  The client security context in ClientContext is assumed to</span>
00646 <span class="comment">    be up to date.</span>
00647 <span class="comment"></span>
00648 <span class="comment"></span>
00649 <span class="comment">Arguments:</span>
00650 <span class="comment"></span>
00651 <span class="comment">    ClientContext - Points to client security context block.</span>
00652 <span class="comment"></span>
00653 <span class="comment">    ServerThread - (Optional) Specifies the thread which is to be made to</span>
00654 <span class="comment">        impersonate the client.  If not specified, the calling thread is</span>
00655 <span class="comment">        used.</span>
00656 <span class="comment"></span>
00657 <span class="comment"></span>
00658 <span class="comment">Return Value:</span>
00659 <span class="comment"></span>
00660 <span class="comment">    None.</span>
00661 <span class="comment"></span>
00662 <span class="comment"></span>
00663 <span class="comment">--*/</span>
00664 
00665 
00666 {
00667 
00668     BOOLEAN EffectiveValueToUse;
00669     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00670     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00671 
00672     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00673 
00674     <span class="keywordflow">if</span> (ClientContext-&gt;DirectlyAccessClientToken) {
00675         EffectiveValueToUse = ClientContext-&gt;DirectAccessEffectiveOnly;
00676     } <span class="keywordflow">else</span> {
00677         EffectiveValueToUse = ClientContext-&gt;SecurityQos.EffectiveOnly;
00678     }
00679 
00680 
00681 
00682     <span class="comment">//</span>
00683     <span class="comment">// if a ServerThread wasn't specified, then default to the current</span>
00684     <span class="comment">// thread.</span>
00685     <span class="comment">//</span>
00686 
00687     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>)) {
00688         Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00689     } <span class="keywordflow">else</span> {
00690         Thread = <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>;
00691     }
00692 
00693 
00694 
00695     <span class="comment">//</span>
00696     <span class="comment">// Assign the context to the calling thread</span>
00697     <span class="comment">//</span>
00698 
00699     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a6">PsImpersonateClient</a>( Thread,
00700                          ClientContext-&gt;ClientToken,
00701                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00702                          EffectiveValueToUse,
00703                          ClientContext-&gt;SecurityQos.ImpersonationLevel
00704                          );
00705 
00706     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00707 
00708 }
00709 
00710 
00711 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00712"></a><a class="code" href="../../d4/d5/seclient_8c.html#a4">00712</a> <a class="code" href="../../d4/d5/seclient_8c.html#a4">SeCreateClientSecurityFromSubjectContext</a> (
00713     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext,
00714     IN PSECURITY_QUALITY_OF_SERVICE ClientSecurityQos,
00715     IN BOOLEAN ServerIsRemote,
00716     OUT <a class="code" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a> ClientContext
00717     )                              
00718 <span class="comment">/*++</span>
00719 <span class="comment"></span>
00720 <span class="comment">Routine Description:</span>
00721 <span class="comment"></span>
00722 <span class="comment">    This service initializes a context block to represent a client's</span>
00723 <span class="comment">    security context.  This may simply result in a reference to the</span>
00724 <span class="comment">    client's token, or may cause the client's token to be duplicated,</span>
00725 <span class="comment">    depending upon the security quality of service information specified.</span>
00726 <span class="comment"></span>
00727 <span class="comment">                               NOTE</span>
00728 <span class="comment"></span>
00729 <span class="comment">        The code in this routine is optimized for DYNAMIC context</span>
00730 <span class="comment">        tracking.  This is only mode in which direct access to a</span>
00731 <span class="comment">        caller's token is allowed, and the mode expected to be used</span>
00732 <span class="comment">        most often.  STATIC context tracking always requires the</span>
00733 <span class="comment">        caller's token to be copied.</span>
00734 <span class="comment"></span>
00735 <span class="comment"></span>
00736 <span class="comment">Arguments:</span>
00737 <span class="comment"></span>
00738 <span class="comment">    SubjectContext - Points to the SubjectContext that should serve</span>
00739 <span class="comment">        as the basis for this client context.</span>
00740 <span class="comment"></span>
00741 <span class="comment">    ClientSecurityQos - Points to the security quality of service</span>
00742 <span class="comment">        parameters specified by the client for this communication</span>
00743 <span class="comment">        session.</span>
00744 <span class="comment"></span>
00745 <span class="comment">    ServerIsRemote - Provides an indication as to whether the session</span>
00746 <span class="comment">        this context block is being used for is an inter-system</span>
00747 <span class="comment">        session or intra-system session.  This is reconciled with the</span>
00748 <span class="comment">        impersonation level of the client thread's token (in case the</span>
00749 <span class="comment">        client has a client of his own that didn't specify delegation).</span>
00750 <span class="comment"></span>
00751 <span class="comment">    ClientContext - Points to the client security context block to be</span>
00752 <span class="comment">        initialized.</span>
00753 <span class="comment"></span>
00754 <span class="comment"></span>
00755 <span class="comment">Return Value:</span>
00756 <span class="comment"></span>
00757 <span class="comment">    STATUS_SUCCESS - The service completed successfully.</span>
00758 <span class="comment"></span>
00759 <span class="comment">    STATUS_BAD_IMPERSONATION_LEVEL - The client is currently</span>
00760 <span class="comment">        impersonating either an Anonymous or Identification level</span>
00761 <span class="comment">        token, which can not be passed on for use by another server.</span>
00762 <span class="comment">        This status may also be returned if the security context</span>
00763 <span class="comment">        block is for an inter-system communication session and the</span>
00764 <span class="comment">        client thread is impersonating a client of its own using</span>
00765 <span class="comment">        other than delegation impersonation level.</span>
00766 <span class="comment"></span>
00767 <span class="comment"></span>
00768 <span class="comment">--*/</span>
00769 
00770 {
00771     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00772     PACCESS_TOKEN <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00773     TOKEN_TYPE Type;
00774     BOOLEAN ThreadEffectiveOnly;
00775     SECURITY_IMPERSONATION_LEVEL ImpersonationLevel;
00776     PACCESS_TOKEN DuplicateToken;
00777 
00778     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00779 
00780     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d0/d5/se_8h.html#a16">SeQuerySubjectContextToken</a>(
00781                 SubjectContext
00782                 );
00783 
00784     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00785 
00786     <span class="keywordflow">if</span> ( SubjectContext-&gt;ClientToken )
00787     {
00788         Type = TokenImpersonation ;
00789     }
00790     <span class="keywordflow">else</span> 
00791     {
00792         Type = TokenPrimary ;
00793     }
00794 
00795     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d5/seclient_8c.html#a0">SepCreateClientSecurity</a>(
00796                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00797                 ClientSecurityQos,
00798                 ServerIsRemote,
00799                 Type,
00800                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00801                 SubjectContext-&gt;ImpersonationLevel,
00802                 ClientContext
00803                 );
00804 
00805     
00806     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00807 }
00808 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:44 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
