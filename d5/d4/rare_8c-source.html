<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rare.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rare.c</h1><a href="../../d4/d5/rare_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: rare.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* History:</span>
00007 <span class="comment">* 06-28-91 MikeHar      Created.</span>
00008 <span class="comment">\***************************************************************************/</span>
00009 
00010 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00011 <span class="preprocessor">#pragma hdrstop</span>
00012 <span class="preprocessor"></span>
00013 <span class="comment">/*</span>
00014 <span class="comment"> * MetricsRecalc flags</span>
00015 <span class="comment"> */</span>
<a name="l00016"></a><a class="code" href="../../d4/d5/rare_8c.html#a0">00016</a> <span class="preprocessor">#define CALC_RESIZE         0x0001</span>
<a name="l00017"></a><a class="code" href="../../d4/d5/rare_8c.html#a1">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define CALC_FRAME          0x0002</span>
<a name="l00018"></a><a class="code" href="../../d4/d5/rare_8c.html#a2">00018</a> <span class="preprocessor"></span><span class="preprocessor">#define CALC_MINIMIZE       0x0004</span>
00019 <span class="preprocessor"></span>
00020 <span class="comment">/*</span>
00021 <span class="comment"> * NormalizeRect flags</span>
00022 <span class="comment"> */</span>
<a name="l00023"></a><a class="code" href="../../d4/d5/rare_8c.html#a3">00023</a> <span class="preprocessor">#define NORMALIZERECT_NORMAL        0</span>
<a name="l00024"></a><a class="code" href="../../d4/d5/rare_8c.html#a4">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define NORMALIZERECT_MAXIMIZED     1</span>
<a name="l00025"></a><a class="code" href="../../d4/d5/rare_8c.html#a5">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define NORMALIZERECT_FULLSCREEN    2</span>
00026 <span class="preprocessor"></span>
00027 <span class="comment">/***************************************************************************\</span>
00028 <span class="comment">* SnapshotMonitorRects</span>
00029 <span class="comment">*</span>
00030 <span class="comment">*   This is called from ResetDisplay to memorize the monitor positions so</span>
00031 <span class="comment">* DesktopRecalcEx will know where to move stuff.</span>
00032 <span class="comment">*</span>
00033 <span class="comment">* Returns the MONITORRECTS if succeeded, NULL otherwise.</span>
00034 <span class="comment">*</span>
00035 <span class="comment">* History:</span>
00036 <span class="comment">* 09-Dec-1996 adams     Created.</span>
00037 <span class="comment">\***************************************************************************/</span>
00038 
00039 <a class="code" href="../../d3/d2/structtagMONITORRECTS.html">PMONITORRECTS</a>
<a name="l00040"></a><a class="code" href="../../d4/d1/userk_8h.html#a1881">00040</a> <a class="code" href="../../d4/d5/rare_8c.html#a9">SnapshotMonitorRects</a>(<span class="keywordtype">void</span>)
00041 {
00042     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>        pMonitor;
00043     <a class="code" href="../../d3/d2/structtagMONITORRECTS.html">PMONITORRECTS</a>   pmr;
00044     <a class="code" href="../../d2/d2/structtagMONITORPOS.html">PMONITORPOS</a>     pmp;
00045 <span class="preprocessor">#if DBG</span>
00046 <span class="preprocessor"></span>    ULONG           cVisMon = 0;
00047 <span class="preprocessor">#endif</span>
00048 <span class="preprocessor"></span>
00049     pmr = UserAllocPool(
00050             <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d2/structtagMONITORRECTS.html">MONITORRECTS</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2/structtagMONITORPOS.html">MONITORPOS</a>) * (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o11">cMonitors</a> - 1),
00051             TAG_MONITORRECTS);
00052 
00053     <span class="keywordflow">if</span> (!pmr) {
00054         RIPERR0(ERROR_OUTOFMEMORY, RIP_WARNING, <span class="stringliteral">"Out of memory in SnapshotMonitorRects"</span>);
00055         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00056     }
00057 
00058     pmp = pmr-&gt;<a class="code" href="../../d3/d2/structtagMONITORRECTS.html#o1">amp</a>;
00059     <span class="keywordflow">for</span> (   pMonitor = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o13">pMonitorFirst</a>;
00060             pMonitor;
00061             pMonitor = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o1">pMonitorNext</a>) {
00062 
00063         <span class="keywordflow">if</span> (!(pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o2">dwMONFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a525">MONF_VISIBLE</a>))
00064             <span class="keywordflow">continue</span>;
00065 <span class="preprocessor">#if DBG</span>
00066 <span class="preprocessor"></span>        cVisMon++;
00067 <span class="preprocessor">#endif</span>
00068 <span class="preprocessor"></span>
00069         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pmp-&gt;<a class="code" href="../../d2/d2/structtagMONITORPOS.html#o0">rcMonitor</a>, &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>);
00070         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pmp-&gt;<a class="code" href="../../d2/d2/structtagMONITORPOS.html#o1">rcWork</a>,    &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>);
00071 
00072         <span class="comment">/*</span>
00073 <span class="comment">         * If the device for this monitor object is not active, don't store</span>
00074 <span class="comment">         * the pointer to it in the list.  This way the windows on the inactive</span>
00075 <span class="comment">         * monitor will be later moved to the default one.</span>
00076 <span class="comment">         */</span>
00077         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2081">HdevFromMonitor</a>(pMonitor) == -1) {
00078             pmp-&gt;<a class="code" href="../../d2/d2/structtagMONITORPOS.html#o2">pMonitor</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00079         } <span class="keywordflow">else</span> {
00080             pmp-&gt;<a class="code" href="../../d2/d2/structtagMONITORPOS.html#o2">pMonitor</a> = pMonitor;
00081         }
00082 
00083         pmp++;
00084     }
00085     UserAssert(cVisMon == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o11">cMonitors</a>);
00086 
00087     pmr-&gt;<a class="code" href="../../d3/d2/structtagMONITORRECTS.html#o0">cMonitor</a> = (<span class="keywordtype">int</span>)(pmp - pmr-&gt;<a class="code" href="../../d3/d2/structtagMONITORRECTS.html#o1">amp</a>);
00088 
00089     <span class="keywordflow">return</span> pmr;
00090 }
00091 
00092 <span class="comment">/***************************************************************************\</span>
00093 <span class="comment">* NormalizeRect</span>
00094 <span class="comment">*</span>
00095 <span class="comment">* Adjusts a window rectangle when the working area changes.  This can be</span>
00096 <span class="comment">* because of a tray move, with the resolution staying the same, or</span>
00097 <span class="comment">* because of a dynamic resolution change, with the tray staying the same</span>
00098 <span class="comment">* relatively.</span>
00099 <span class="comment">*</span>
00100 <span class="comment">* History:</span>
00101 <span class="comment">\***************************************************************************/</span>
00102 
<a name="l00103"></a><a class="code" href="../../d4/d5/rare_8c.html#a10">00103</a> <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> <a class="code" href="../../d4/d5/rare_8c.html#a10">NormalizeRect</a>(
00104     LPRECT          lprcDest,
00105     LPRECT          lprcSrc,
00106     <a class="code" href="../../d3/d2/structtagMONITORRECTS.html">PMONITORRECTS</a>   pmrOld,
00107     <span class="keywordtype">int</span>             iOldMonitor,
00108     <span class="keywordtype">int</span>             codeFullScreen,
00109     DWORD           style)
00110 {
00111     LPCRECT     lprcOldMonitor;
00112     LPCRECT     lprcOldWork;
00113     LPRECT      lprcNewWork;
00114     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor;
00115     <span class="keywordtype">int</span>         cxOldMonitor;
00116     <span class="keywordtype">int</span>         cyOldMonitor;
00117     <span class="keywordtype">int</span>         cxNewMonitor;
00118     <span class="keywordtype">int</span>         cyNewMonitor;
00119     <span class="keywordtype">int</span>         dxOrg, dyOrg;
00120 
00121     <span class="comment">/*</span>
00122 <span class="comment">     * Track the window so it stays in the same place on the same monitor.</span>
00123 <span class="comment">     * If the old monitor is no longer active then pick a default.</span>
00124 <span class="comment">     */</span>
00125     <span class="keywordflow">if</span> ((pMonitor = pmrOld-&gt;<a class="code" href="../../d3/d2/structtagMONITORRECTS.html#o1">amp</a>[iOldMonitor].<a class="code" href="../../d2/d2/structtagMONITORPOS.html#o2">pMonitor</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00126         pMonitor = <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
00127     }
00128 
00129     lprcOldMonitor = &amp;pmrOld-&gt;<a class="code" href="../../d3/d2/structtagMONITORRECTS.html#o1">amp</a>[iOldMonitor].<a class="code" href="../../d2/d2/structtagMONITORPOS.html#o0">rcMonitor</a>;
00130     lprcOldWork = &amp;pmrOld-&gt;<a class="code" href="../../d3/d2/structtagMONITORRECTS.html#o1">amp</a>[iOldMonitor].<a class="code" href="../../d2/d2/structtagMONITORPOS.html#o1">rcWork</a>;
00131 
00132     <span class="comment">/*</span>
00133 <span class="comment">     * If is a fullscreen app just make it fullscreen at the new location.</span>
00134 <span class="comment">     */</span>
00135     <span class="keywordflow">if</span> (codeFullScreen != <a class="code" href="../../d4/d5/rare_8c.html#a3">NORMALIZERECT_NORMAL</a>) {
00136         LPCRECT lprcOldSnap, lprcNewSnap;
00137 
00138         <span class="comment">/*</span>
00139 <span class="comment">         * If it is a maximized window snap it to the work area.</span>
00140 <span class="comment">         * Otherwise it is a rude app so snap it to the screen.</span>
00141 <span class="comment">         */</span>
00142         <span class="keywordflow">if</span> (codeFullScreen == <a class="code" href="../../d4/d5/rare_8c.html#a4">NORMALIZERECT_MAXIMIZED</a>) {
00143             lprcOldSnap = lprcOldWork;
00144             lprcNewSnap = &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>;
00145         } <span class="keywordflow">else</span> {
00146             lprcOldSnap = lprcOldMonitor;
00147             lprcNewSnap = &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>;
00148         }
00149 
00150         lprcDest-&gt;left = lprcSrc-&gt;left +
00151             lprcNewSnap-&gt;left - lprcOldSnap-&gt;left;
00152 
00153         lprcDest-&gt;top = lprcSrc-&gt;top +
00154             lprcNewSnap-&gt;top - lprcOldSnap-&gt;top;
00155 
00156         lprcDest-&gt;right = lprcSrc-&gt;right +
00157             lprcNewSnap-&gt;right - lprcOldSnap-&gt;right;
00158 
00159         lprcDest-&gt;bottom = lprcSrc-&gt;bottom +
00160             lprcNewSnap-&gt;bottom - lprcOldSnap-&gt;bottom;
00161 
00162         <span class="keywordflow">goto</span> AllDone;
00163     }
00164 
00165     <span class="comment">/*</span>
00166 <span class="comment">     * Offset the window by the change in desktop origin.</span>
00167 <span class="comment">     */</span>
00168     dxOrg = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left - lprcOldMonitor-&gt;left;
00169     dyOrg = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top - lprcOldMonitor-&gt;top;
00170 
00171     <span class="comment">/*</span>
00172 <span class="comment">     * Calculate the change in screen size (we need it in more than one place).</span>
00173 <span class="comment">     */</span>
00174     cxOldMonitor = lprcOldMonitor-&gt;right - lprcOldMonitor-&gt;left;
00175     cyOldMonitor = lprcOldMonitor-&gt;bottom - lprcOldMonitor-&gt;top;
00176     cxNewMonitor = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left;
00177     cyNewMonitor = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top;
00178 
00179     <span class="comment">/*</span>
00180 <span class="comment">     * If the monitor resolution has changed (or we moved to a new monitor)</span>
00181 <span class="comment">     * then factor in the size change.</span>
00182 <span class="comment">     */</span>
00183     <span class="keywordflow">if</span> (cxNewMonitor != cxOldMonitor || cyNewMonitor != cyOldMonitor) {
00184         <span class="keywordtype">int</span> xWnd = lprcSrc-&gt;left - lprcOldMonitor-&gt;left;
00185         <span class="keywordtype">int</span> yWnd = lprcSrc-&gt;top - lprcOldMonitor-&gt;top;
00186 
00187         dxOrg += <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(xWnd, cxNewMonitor - cxOldMonitor, cxOldMonitor);
00188         dyOrg += <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(yWnd, cyNewMonitor - cyOldMonitor, cyOldMonitor);
00189     }
00190 
00191     <span class="comment">/*</span>
00192 <span class="comment">     * Compute the initial new position.</span>
00193 <span class="comment">     */</span>
00194     <a class="code" href="../../d3/d6/rect_8c.html#a3">CopyOffsetRect</a>(lprcDest, lprcSrc, dxOrg, dyOrg);
00195     lprcNewWork = &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>;
00196 
00197     <span class="comment">/*</span>
00198 <span class="comment">     * Fit horizontally.  Try to fit so that the window isn't out of the</span>
00199 <span class="comment">     * working area horizontally.  Keep left edge visible always.</span>
00200 <span class="comment">     */</span>
00201     <span class="keywordflow">if</span> (lprcDest-&gt;right &gt; lprcNewWork-&gt;right) {
00202         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(lprcDest, lprcNewWork-&gt;right - lprcDest-&gt;right, 0);
00203     }
00204 
00205     <span class="keywordflow">if</span> (lprcDest-&gt;left &lt; lprcNewWork-&gt;left) {
00206         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(lprcDest, lprcNewWork-&gt;left - lprcDest-&gt;left, 0);
00207     }
00208 
00209     <span class="comment">/*</span>
00210 <span class="comment">     * Fit vertically.  Try to fit so that the window isn't out of the</span>
00211 <span class="comment">     * working area vertically.  Keep top edge visible always.</span>
00212 <span class="comment">     */</span>
00213     <span class="keywordflow">if</span> (lprcDest-&gt;bottom &gt; lprcNewWork-&gt;bottom) {
00214         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(lprcDest, 0, lprcNewWork-&gt;bottom - lprcDest-&gt;bottom);
00215     }
00216 
00217     <span class="keywordflow">if</span> (lprcDest-&gt;top &lt; lprcNewWork-&gt;top) {
00218         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(lprcDest, 0, lprcNewWork-&gt;top - lprcDest-&gt;top);
00219     }
00220 
00221     <span class="comment">/*</span>
00222 <span class="comment">     * If the window is sizeable then shrink it if necessary.</span>
00223 <span class="comment">     */</span>
00224     <span class="keywordflow">if</span> (style &amp; WS_THICKFRAME)
00225     {
00226         <span class="keywordtype">int</span> cSnap = 0;
00227 
00228         <span class="keywordflow">if</span> (lprcDest-&gt;right &gt; lprcNewWork-&gt;right) {
00229             lprcDest-&gt;right = lprcNewWork-&gt;right;
00230             cSnap++;
00231         }
00232 
00233         <span class="keywordflow">if</span> (lprcDest-&gt;bottom &gt; lprcNewWork-&gt;bottom) {
00234             lprcDest-&gt;bottom = lprcNewWork-&gt;bottom;
00235             cSnap++;
00236         }
00237 
00238 
00239         <span class="comment">/*</span>
00240 <span class="comment">         * Now make sure we didn't turn this normal window into a</span>
00241 <span class="comment">         * fullscreen window.  This is a complete hack but it is much</span>
00242 <span class="comment">         * better than changing from 800x600 to 640x480 and ending up with</span>
00243 <span class="comment">         * a bunch of fullscreen apps...</span>
00244 <span class="comment">         */</span>
00245         <span class="keywordflow">if</span> (cSnap == 2) {
00246             <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(lprcDest, -1, -1);
00247         }
00248     }
00249 
00250 AllDone:
00251     <span class="keywordflow">return</span> pMonitor;
00252 }
00253 
00254 
00255 <span class="comment">/***************************************************************************\</span>
00256 <span class="comment">* _SetRipFlags</span>
00257 <span class="comment">*</span>
00258 <span class="comment">* Sets the debug rip flags</span>
00259 <span class="comment">*</span>
00260 <span class="comment">* History:</span>
00261 <span class="comment">* 16-Aug-1996 adams     Created.</span>
00262 <span class="comment">\***************************************************************************/</span>
00263 
<a name="l00264"></a><a class="code" href="../../d4/d1/userk_8h.html#a1015">00264</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1015">_SetRipFlags</a>(
00265     DWORD dwRipFlags, DWORD dwPID)
00266 {
00267     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>) {
00268         <span class="keywordflow">if</span> ((dwRipFlags != (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1) &amp;&amp; !(dwRipFlags &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a398">RIPF_VALIDUSERFLAGS</a>)) {
00269             <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o0">wRIPFlags</a> = (WORD)((<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o0">wRIPFlags</a> &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a398">RIPF_VALIDUSERFLAGS</a>) | dwRipFlags);
00270         }
00271         <span class="keywordflow">if</span> (dwPID != (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1) {
00272             <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o2">wRIPPID</a> = (WORD)dwPID;
00273         }
00274     }
00275 }
00276 
00277 <span class="comment">/***************************************************************************\</span>
00278 <span class="comment">* _SetDbgTag</span>
00279 <span class="comment">*</span>
00280 <span class="comment">* Sets debugging level for a tag.</span>
00281 <span class="comment">*</span>
00282 <span class="comment">* History:</span>
00283 <span class="comment">* 16-Aug-1996 adams     Created.</span>
00284 <span class="comment">\***************************************************************************/</span>
00285 
00286 <span class="keywordtype">void</span>
<a name="l00287"></a><a class="code" href="../../d4/d1/userk_8h.html#a1016">00287</a> <a class="code" href="../../d4/d1/userk_8h.html#a1016">_SetDbgTag</a>(<span class="keywordtype">int</span> tag, DWORD dwDBGTAGFlags)
00288 {
00289 <span class="preprocessor">#if DEBUGTAGS</span>
00290 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> &amp;&amp; tag &lt; DBGTAG_Max &amp;&amp; !(dwDBGTAGFlags &amp; ~DBGTAG_VALIDUSERFLAGS)) {
00291         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a14">COPY_FLAG</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;adwDBGTAGFlags[tag], dwDBGTAGFlags, DBGTAG_VALIDUSERFLAGS);
00292     }
00293 <span class="preprocessor">#else</span>
00294 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(tag);
00295     UNREFERENCED_PARAMETER(dwDBGTAGFlags);
00296 <span class="preprocessor">#endif</span>
00297 <span class="preprocessor"></span>}
00298 
00299 
00300 <span class="comment">/***************************************************************************\</span>
00301 <span class="comment">* UpdateWinIniInt</span>
00302 <span class="comment">*</span>
00303 <span class="comment">* History:</span>
00304 <span class="comment">* 18-Apr-1994 mikeke     Created</span>
00305 <span class="comment">\***************************************************************************/</span>
<a name="l00306"></a><a class="code" href="../../d4/d1/userk_8h.html#a1861">00306</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(PUNICODE_STRING pProfileUserName,
00307     UINT         idSection,
00308     UINT         wKeyNameId,
00309     <span class="keywordtype">int</span>          value
00310     )
00311 {
00312     WCHAR szTemp[40];
00313     WCHAR            szKeyName[40];
00314     swprintf(szTemp, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%d"</span>, value);
00315 
00316     <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>,
00317                          wKeyNameId,
00318                          szKeyName,
00319                          <span class="keyword">sizeof</span>(szKeyName) / <span class="keyword">sizeof</span>(WCHAR));
00320 
00321     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
00322                                    idSection,
00323                                    szKeyName,
00324                                    szTemp);
00325 
00326 
00327 }
00328 
00329 <span class="comment">/***************************************************************************\</span>
00330 <span class="comment">* SetDesktopMetrics</span>
00331 <span class="comment">*</span>
00332 <span class="comment">* History:</span>
00333 <span class="comment">* 31-Jan-1994 mikeke    Ported</span>
00334 <span class="comment">\***************************************************************************/</span>
00335 
<a name="l00336"></a><a class="code" href="../../d4/d1/userk_8h.html#a1862">00336</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5/rare_8c.html#a14">SetDesktopMetrics</a>()
00337 {
00338     LPRECT      lprcWork;
00339 
00340     lprcWork = &amp;<a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>()-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>;
00341 
00342     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFULLSCREEN)      = lprcWork-&gt;right - lprcWork-&gt;left;
00343     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMAXIMIZED)       = lprcWork-&gt;right - lprcWork-&gt;left + 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSIZEFRAME);
00344 
00345     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFULLSCREEN)      = lprcWork-&gt;bottom - lprcWork-&gt;top - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCAPTION);
00346     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMAXIMIZED)       = lprcWork-&gt;bottom - lprcWork-&gt;top + 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSIZEFRAME);
00347 }
00348 
00349 <span class="comment">/***************************************************************************\</span>
00350 <span class="comment">* xxxMetricsRecalc (Win95: MetricsRecalc)</span>
00351 <span class="comment">*</span>
00352 <span class="comment">* Does work to size/position all minimized or nonminimized</span>
00353 <span class="comment">* windows.  Called when frame metrics or min metrics are changed.</span>
00354 <span class="comment">*</span>
00355 <span class="comment">* Note that you can NOT do DeferWindowPos() with this function.  SWP doesn't</span>
00356 <span class="comment">* work when you do parents and children at the same time--it's only for</span>
00357 <span class="comment">* peer windows.  Thus we must do SetWindowPos() for each window.</span>
00358 <span class="comment">*</span>
00359 <span class="comment">* History:</span>
00360 <span class="comment">* 06-28-91 MikeHar      Ported.</span>
00361 <span class="comment">\***************************************************************************/</span>
<a name="l00362"></a><a class="code" href="../../d4/d1/userk_8h.html#a1536">00362</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1536">xxxMetricsRecalc</a>(
00363     UINT wFlags,
00364     <span class="keywordtype">int</span>  dx,
00365     <span class="keywordtype">int</span>  dy,
00366     <span class="keywordtype">int</span>  dyCaption,
00367     <span class="keywordtype">int</span>  dyMenu)
00368 {
00369     <a class="code" href="../../d4/d1/userk_8h.html#a944">PHWND</a>       phwnd;
00370     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwnd;
00371     RECT        rc;
00372     <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">PCHECKPOINT</a> pcp;
00373     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwnd;
00374     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fResized;
00375     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a>        pbwl;
00376     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00377     <span class="keywordtype">int</span>         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00378 
00379     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00380     pbwl = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(
00381             <a class="code" href="../../d4/d1/userk_8h.html#a256">GETDESKINFO</a>(ptiCurrent)-&gt;spwnd-&gt;spwndChild,
00382             <a class="code" href="../../d4/d1/userk_8h.html#a410">BWL_ENUMLIST</a> | <a class="code" href="../../d4/d1/userk_8h.html#a409">BWL_ENUMCHILDREN</a>,
00383             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00384 
00385     <span class="keywordflow">if</span> (!pbwl)
00386         <span class="keywordflow">return</span>;
00387 
00388     UserAssert(*pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> == (HWND) 1);
00389     <span class="keywordflow">for</span> (   <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = (<span class="keywordtype">int</span>)(pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> - pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>), phwnd = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>;
00390             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &gt; 0;
00391             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>--, phwnd++) {
00392 
00393         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(*phwnd);
00394         <span class="keywordflow">if</span> (!pwnd)
00395             <span class="keywordflow">continue</span>;
00396 
00397         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
00398 
00399         fResized = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00400 
00401         <span class="keywordflow">if</span> ((wFlags &amp; <a class="code" href="../../d4/d5/rare_8c.html#a2">CALC_MINIMIZE</a>) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00402             <span class="comment">/*</span>
00403 <span class="comment">             * We're changing the minimized window dimensions.  We need to</span>
00404 <span class="comment">             * resize.  Note that we do NOT move.</span>
00405 <span class="comment">             */</span>
00406             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, (&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>));
00407             rc.right += dx;
00408             rc.bottom += dy;
00409 
00410             <span class="keywordflow">goto</span> PositionWnd;
00411         }
00412 
00413         <span class="comment">/*</span>
00414 <span class="comment">         * We're changing the size of the window because the sizing border</span>
00415 <span class="comment">         * changed.</span>
00416 <span class="comment">         */</span>
00417         <span class="keywordflow">if</span> ((wFlags &amp; <a class="code" href="../../d4/d5/rare_8c.html#a0">CALC_RESIZE</a>) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a638">WFSIZEBOX</a>)) {
00418 
00419             pcp = (<a class="code" href="../../d0/d0/structtagCHECKPOINT.html">CHECKPOINT</a> *)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a475">PROP_CHECKPOINT</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
00420 
00421             <span class="comment">/*</span>
00422 <span class="comment">             * Update maximized position to account for sizing border</span>
00423 <span class="comment">             * We do this for DOS box also.  This way client of max'ed windows</span>
00424 <span class="comment">             * stays in same relative position.</span>
00425 <span class="comment">             */</span>
00426             <span class="keywordflow">if</span> (pcp &amp;&amp; (pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o7">fMaxInitialized</a>)) {
00427                 pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o2">ptMax</a>.x -= dx;
00428                 pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o2">ptMax</a>.y -= dy;
00429             }
00430 
00431             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00432                 <span class="keywordflow">if</span> (pcp)
00433                     <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o0">rcNormal</a>, dx, dy);
00434             } <span class="keywordflow">else</span> {
00435                 <a class="code" href="../../d3/d6/rect_8c.html#a2">CopyInflateRect</a>(&amp;rc, (&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>), dx, dy);
00436                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a553">WFCPRESENT</a>))
00437                     rc.bottom += dyCaption;
00438                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a550">WFMPRESENT</a>))
00439                     rc.bottom += dyMenu;
00440 
00441 PositionWnd:
00442                 fResized = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00443 
00444                 <span class="comment">/*</span>
00445 <span class="comment">                 * Remember SWP expects values in PARENT CLIENT coordinates.</span>
00446 <span class="comment">                 */</span>
00447                 <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00448                     <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rc,
00449                         -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left,
00450                         -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
00451                 }
00452 
00453                 <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd,
00454                                 <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>,
00455                                 rc.left,
00456                                 rc.top,
00457                                 rc.right-rc.left,
00458                                 rc.bottom-rc.top,
00459 
00460 #<span class="keywordflow">if</span> 0 <span class="comment">// Win95 flags</span>
00461                                 SWP_NOZORDER | SWP_NOACTIVATE | SWP_DEFERDRAWING | SWP_FRAMECHANGED);
00462 <span class="preprocessor">#else</span>
00463 <span class="preprocessor"></span>                                SWP_NOZORDER | SWP_NOACTIVATE | SWP_NOCOPYBITS | SWP_FRAMECHANGED | SWP_NOREDRAW);
00464 <span class="preprocessor">#endif</span>
00465 <span class="preprocessor"></span>            }
00466         }
00467 
00468         <span class="comment">/*</span>
00469 <span class="comment">         * We're changing the nonclient widgets, so recalculate the</span>
00470 <span class="comment">         * client.</span>
00471 <span class="comment">         */</span>
00472         <span class="keywordflow">if</span> (wFlags &amp; <a class="code" href="../../d4/d5/rare_8c.html#a1">CALC_FRAME</a>) {
00473 
00474             <span class="comment">/*</span>
00475 <span class="comment">             * Delete any cached small icons...</span>
00476 <span class="comment">             */</span>
00477             <span class="keywordflow">if</span> (dyCaption)
00478                  <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_SETICON, ICON_RECREATE, 0);
00479 
00480             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) &amp;&amp; !fResized) {
00481 
00482                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>));
00483                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a550">WFMPRESENT</a>))
00484                     rc.bottom += dyMenu;
00485 
00486                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a553">WFCPRESENT</a>)) {
00487                     rc.bottom += dyCaption;
00488                     <span class="comment">/*</span>
00489 <span class="comment">                     * Maximized MDI child windows position their caption</span>
00490 <span class="comment">                     *  outside their parent's client area (negative y).</span>
00491 <span class="comment">                     *  If the caption has changed, they need to be</span>
00492 <span class="comment">                     *  repositioned.</span>
00493 <span class="comment">                     */</span>
00494                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>)
00495                             &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>)
00496                             &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a206">FNID_MDICLIENT</a>)) {
00497 
00498                         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd,
00499                                         <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>,
00500                                         rc.left  - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left,
00501                                         rc.top   - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top - dyCaption,
00502                                         rc.right - rc.left,
00503                                         rc.bottom- rc.top, SWP_NOZORDER | SWP_NOACTIVATE | SWP_FRAMECHANGED | SWP_NOREDRAW);
00504                         <span class="keywordflow">goto</span> LoopCleanup;
00505                     }
00506                 }
00507 
00508                 <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd,
00509                                 <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>,
00510                                 0,
00511                                 0,
00512                                 rc.right-rc.left,
00513                                 rc.bottom-rc.top,
00514 #<span class="keywordflow">if</span> 0 <span class="comment">// Win95 flags</span>
00515                                 SWP_NOMOVE | SWP_NOZORDER | SWP_NOACTIVATE | SWP_FRAMECHANGED | SWP_NOREDRAW);
00516 <span class="preprocessor">#else</span>
00517 <span class="preprocessor"></span>                                SWP_NOMOVE | SWP_NOZORDER | SWP_NOACTIVATE | SWP_FRAMECHANGED | SWP_NOCOPYBITS | SWP_NOREDRAW);
00518 <span class="preprocessor">#endif</span>
00519 <span class="preprocessor"></span>            }
00520         }
00521 
00522 LoopCleanup:
00523         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00524     }
00525 
00526     <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(pbwl);
00527 }
00528 
00529 <span class="comment">/***************************************************************************\</span>
00530 <span class="comment">* FindOldMonitor</span>
00531 <span class="comment">*</span>
00532 <span class="comment">* Returns the index of the monitor in "pmr" which has the greatest</span>
00533 <span class="comment">* overlap with a rectangle. This function is used to determine which</span>
00534 <span class="comment">* monitor a window was on after one or more monitor rectangles have</span>
00535 <span class="comment">* changed.</span>
00536 <span class="comment">*</span>
00537 <span class="comment">* History:</span>
00538 <span class="comment">* 11-Sep-1996 adams     Created.</span>
00539 <span class="comment">\***************************************************************************/</span>
00540 
00541 <span class="keywordtype">int</span>
<a name="l00542"></a><a class="code" href="../../d4/d5/rare_8c.html#a16">00542</a> <a class="code" href="../../d4/d5/rare_8c.html#a16">FindOldMonitor</a>(LPCRECT lprc, <a class="code" href="../../d3/d2/structtagMONITORRECTS.html">PMONITORRECTS</a> pmr)
00543 {
00544     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwClosest;
00545     <span class="keywordtype">int</span>         iClosest, i;
00546     <span class="keywordtype">int</span>         cxRect, cyRect;
00547     <a class="code" href="../../d2/d2/structtagMONITORPOS.html">PMONITORPOS</a> pmp;
00548 
00549     iClosest = -1;
00550     dwClosest = 0;
00551 
00552     cxRect = (lprc-&gt;right - lprc-&gt;left);
00553     cyRect = (lprc-&gt;bottom - lprc-&gt;top);
00554 
00555     <span class="keywordflow">for</span> (i = 0, pmp = pmr-&gt;<a class="code" href="../../d3/d2/structtagMONITORRECTS.html#o1">amp</a>; i &lt; pmr-&gt;<a class="code" href="../../d3/d2/structtagMONITORRECTS.html#o0">cMonitor</a>; pmp++, i++)
00556     {
00557         RECT rcT;
00558 
00559         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcT, lprc, &amp;pmp-&gt;rcMonitor))
00560         {
00561             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwT;
00562 
00563             <span class="comment">//</span>
00564             <span class="comment">// convert to width/height</span>
00565             <span class="comment">//</span>
00566             rcT.right -= rcT.left;
00567             rcT.bottom -= rcT.top;
00568 
00569             <span class="comment">//</span>
00570             <span class="comment">// if fully enclosed, we're done</span>
00571             <span class="comment">//</span>
00572             <span class="keywordflow">if</span> ((rcT.right == cxRect) &amp;&amp; (rcT.bottom == cyRect))
00573                 <span class="keywordflow">return</span> i;
00574 
00575             <span class="comment">//</span>
00576             <span class="comment">// use largest area</span>
00577             <span class="comment">//</span>
00578             dwT = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)rcT.right * (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)rcT.bottom;
00579             <span class="keywordflow">if</span> (dwT &gt; dwClosest)
00580             {
00581                 dwClosest = dwT;
00582                 iClosest = i;
00583             }
00584         }
00585     }
00586 
00587     <span class="keywordflow">return</span> iClosest;
00588 }
00589 
00590 
00591 
00592 <span class="comment">/***************************************************************************\</span>
00593 <span class="comment">* xxxDesktopRecalc</span>
00594 <span class="comment">*</span>
00595 <span class="comment">* Moves all top-level nonpopup windows into free desktop area,</span>
00596 <span class="comment">* attempting to keep them in the same position relative to the monitor</span>
00597 <span class="comment">* they were on.  Also resets minimized info (so that when a window is</span>
00598 <span class="comment">* subsequently minimized it will go to the correct location).</span>
00599 <span class="comment">*</span>
00600 <span class="comment">* History:</span>
00601 <span class="comment">* 11-Sep-1996 adams     Created.</span>
00602 <span class="comment">\***************************************************************************/</span>
00603 
00604 <span class="keywordtype">void</span>
<a name="l00605"></a><a class="code" href="../../d4/d1/userk_8h.html#a1882">00605</a> <a class="code" href="../../d4/d1/userk_8h.html#a1882">xxxDesktopRecalc</a>(<a class="code" href="../../d3/d2/structtagMONITORRECTS.html">PMONITORRECTS</a> pmrOld)
00606 {
00607     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwndDesktop;
00608     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a>           psmwp;
00609     <a class="code" href="../../d4/d1/userk_8h.html#a944">PHWND</a>           phwnd;
00610     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a>            pbwl;
00611     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwnd;
00612     <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">CHECKPOINT</a> *    pcp;
00613     <span class="keywordtype">int</span>             iOldMonitor;
00614     <span class="keywordtype">int</span>             codeFullScreen;
00615 
00616     UserVerify(pwndDesktop = <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>());
00617     <span class="keywordflow">if</span> ((pbwl = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(pwndDesktop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>, <a class="code" href="../../d4/d1/userk_8h.html#a410">BWL_ENUMLIST</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00618         <span class="keywordflow">return</span>;
00619 
00620     <span class="keywordflow">if</span> ((psmwp = <a class="code" href="../../d4/d1/userk_8h.html#a1616">InternalBeginDeferWindowPos</a>(4)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00621         <span class="keywordflow">for</span> (phwnd = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>; *phwnd != (HWND)1 &amp;&amp; psmwp; phwnd++) {
00622             <span class="comment">/*</span>
00623 <span class="comment">             * Make sure this hwnd is still around.</span>
00624 <span class="comment">             */</span>
00625             <span class="keywordflow">if</span> (    (pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(*phwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00626                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>)) {
00627 
00628                 <span class="keywordflow">continue</span>;
00629             }
00630 
00631             codeFullScreen = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a590">WFFULLSCREEN</a>) ?
00632                 <a class="code" href="../../d4/d5/rare_8c.html#a5">NORMALIZERECT_FULLSCREEN</a> : <a class="code" href="../../d4/d5/rare_8c.html#a3">NORMALIZERECT_NORMAL</a>;
00633 
00634             pcp = (<a class="code" href="../../d0/d0/structtagCHECKPOINT.html">CHECKPOINT</a> *)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a475">PROP_CHECKPOINT</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
00635             <span class="keywordflow">if</span> (pcp) {
00636 
00637                 <span class="comment">/*</span>
00638 <span class="comment">                 * We don't need to blow away saved maximized positions</span>
00639 <span class="comment">                 * anymore, since the max position is always (for top level</span>
00640 <span class="comment">                 * windows) relative to the origin of the monitor's working</span>
00641 <span class="comment">                 * area.  And for child windows, we shouldn't do it period</span>
00642 <span class="comment">                 * anyway.</span>
00643 <span class="comment">                 */</span>
00644                 pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o6">fMinInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00645 
00646                 <span class="comment">/*</span>
00647 <span class="comment">                 * Figure out which monitor the position was on before things</span>
00648 <span class="comment">                 * got shuffled around and try to keep it on that monitor.  If</span>
00649 <span class="comment">                 * it was never visible on a monitor then leave it alone.</span>
00650 <span class="comment">                 */</span>
00651                 iOldMonitor = <a class="code" href="../../d4/d5/rare_8c.html#a16">FindOldMonitor</a>(&amp;pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o0">rcNormal</a>, pmrOld);
00652                 <span class="keywordflow">if</span> (iOldMonitor != (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1) {
00653                     <a class="code" href="../../d4/d5/rare_8c.html#a10">NormalizeRect</a>(
00654                             &amp;pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o0">rcNormal</a>,
00655                             &amp;pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o0">rcNormal</a>,
00656                             pmrOld,
00657                             iOldMonitor,
00658                             codeFullScreen,
00659                             pwnd-&gt;style);
00660                 }
00661             }
00662 
00663             <span class="comment">/*</span>
00664 <span class="comment">             * Figure out which monitor the position was on before things got</span>
00665 <span class="comment">             * shuffled around and try to keep it on that monitor.  If it</span>
00666 <span class="comment">             * was never visible on a monitor then leave it alone.</span>
00667 <span class="comment">             */</span>
00668 
00669             iOldMonitor = <a class="code" href="../../d4/d5/rare_8c.html#a16">FindOldMonitor</a>(&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>, pmrOld);
00670             <span class="keywordflow">if</span> (iOldMonitor != -1) {
00671 
00672                 <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitorDst;
00673                 RECT rc;
00674 
00675                 <span class="comment">/*</span>
00676 <span class="comment">                 * Check for maximized apps that are truly maximized.</span>
00677 <span class="comment">                 * (As opposed to apps that manage their owm maximized rect.)</span>
00678 <span class="comment">                 */</span>
00679                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>)) {
00680                     LPRECT lprcOldWork = &amp;pmrOld-&gt;<a class="code" href="../../d3/d2/structtagMONITORRECTS.html#o1">amp</a>[iOldMonitor].<a class="code" href="../../d2/d2/structtagMONITORPOS.html#o1">rcWork</a>;
00681 
00682                     <span class="keywordflow">if</span> (    (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left &gt;=
00683                                 lprcOldWork-&gt;right - lprcOldWork-&gt;left)
00684                             &amp;&amp;
00685                             (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top &gt;=
00686                                 lprcOldWork-&gt;bottom - lprcOldWork-&gt;top)) {
00687 
00688                         codeFullScreen = <a class="code" href="../../d4/d5/rare_8c.html#a4">NORMALIZERECT_MAXIMIZED</a>;
00689                     }
00690                 }
00691 
00692                 pMonitorDst = <a class="code" href="../../d4/d5/rare_8c.html#a10">NormalizeRect</a>(
00693                         &amp;rc,
00694                         &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>,
00695                         pmrOld,
00696                         iOldMonitor,
00697                         codeFullScreen,
00698                         pwnd-&gt;style);
00699 
00700                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a596">WFMAXFAKEREGIONAL</a>)) {
00701                     UserAssert(pMonitorDst-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o5">hrgnMonitor</a>);
00702                     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> = pMonitorDst-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o5">hrgnMonitor</a>;
00703                 }
00704 
00705                 psmwp = <a class="code" href="../../d4/d1/userk_8h.html#a1619">_DeferWindowPos</a>(
00706                         psmwp,
00707                         pwnd,
00708                         (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)HWND_TOP,
00709                         rc.left,
00710                         rc.top,
00711                         rc.right - rc.left,
00712                         rc.bottom - rc.top,
00713                         SWP_NOACTIVATE | SWP_NOZORDER);
00714             }
00715         }
00716 
00717         <span class="keywordflow">if</span> (psmwp) {
00718             <a class="code" href="../../d4/d1/userk_8h.html#a1620">xxxEndDeferWindowPosEx</a>(psmwp, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00719         }
00720     }
00721 
00722     <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(pbwl);
00723 }
00724 
00725 
00726 
00727 <span class="comment">/***************************************************************************\</span>
00728 <span class="comment">* SetWindowMetricInt</span>
00729 <span class="comment">*</span>
00730 <span class="comment">* History:</span>
00731 <span class="comment">* 25-Feb-96 BradG       Added Pixel -&gt; TWIPS conversion</span>
00732 <span class="comment">\***************************************************************************/</span>
00733 
<a name="l00734"></a><a class="code" href="../../d4/d5/rare_8c.html#a18">00734</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(PUNICODE_STRING pProfileUserName,
00735         WORD wKeyNameId,
00736         <span class="keywordtype">int</span> iIniValue
00737         )
00738 {
00739     <span class="comment">/*</span>
00740 <span class="comment">     * If you change the below list of STR_* make sure you make a corresponding</span>
00741 <span class="comment">     * change in FastGetProfileIntFromID (profile.c)</span>
00742 <span class="comment">     */</span>
00743     <span class="keywordflow">switch</span> (wKeyNameId) {
00744     <span class="keywordflow">case</span> STR_BORDERWIDTH:
00745     <span class="keywordflow">case</span> STR_SCROLLWIDTH:
00746     <span class="keywordflow">case</span> STR_SCROLLHEIGHT:
00747     <span class="keywordflow">case</span> STR_CAPTIONWIDTH:
00748     <span class="keywordflow">case</span> STR_CAPTIONHEIGHT:
00749     <span class="keywordflow">case</span> STR_SMCAPTIONWIDTH:
00750     <span class="keywordflow">case</span> STR_SMCAPTIONHEIGHT:
00751     <span class="keywordflow">case</span> STR_MENUWIDTH:
00752     <span class="keywordflow">case</span> STR_MENUHEIGHT:
00753     <span class="keywordflow">case</span> STR_ICONHORZSPACING:
00754     <span class="keywordflow">case</span> STR_ICONVERTSPACING:
00755     <span class="keywordflow">case</span> STR_MINWIDTH:
00756     <span class="keywordflow">case</span> STR_MINHORZGAP:
00757     <span class="keywordflow">case</span> STR_MINVERTGAP:
00758       <span class="comment">/*</span>
00759 <span class="comment">       * Always store window metrics in TWIPS</span>
00760 <span class="comment">       */</span>
00761         iIniValue = -<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(iIniValue, 72*20, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dmLogPixels);
00762         <span class="keywordflow">break</span>;
00763     }
00764 
00765       <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(pProfileUserName,
00766                              <a class="code" href="../../d4/d1/userk_8h.html#a718">PMAP_METRICS</a>,
00767                              wKeyNameId,
00768                              iIniValue);
00769 }
00770 
00771 <span class="comment">/***************************************************************************\</span>
00772 <span class="comment">* SetWindowMetricFont</span>
00773 <span class="comment">*</span>
00774 <span class="comment">* History:</span>
00775 <span class="comment">\***************************************************************************/</span>
00776 
<a name="l00777"></a><a class="code" href="../../d4/d5/rare_8c.html#a19">00777</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d5/rare_8c.html#a19">SetWindowMetricFont</a>(PUNICODE_STRING pProfileUserName,
00778     UINT idKey,
00779     LPLOGFONT lplf
00780     )
00781 {
00782     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a2012">FastWriteProfileValue</a>(
00783             pProfileUserName,
00784             <a class="code" href="../../d4/d1/userk_8h.html#a718">PMAP_METRICS</a>,
00785             (LPWSTR)UIntToPtr( idKey ),
00786             REG_BINARY,
00787             (LPBYTE)lplf,
00788             <span class="keyword">sizeof</span>(LOGFONTW)
00789             );
00790 }
00791 
00792 
00793 <span class="comment">/***************************************************************************\</span>
00794 <span class="comment">* SetAndDrawNCMetrics</span>
00795 <span class="comment">*</span>
00796 <span class="comment">* History:</span>
00797 <span class="comment">\***************************************************************************/</span>
00798 
<a name="l00799"></a><a class="code" href="../../d4/d5/rare_8c.html#a20">00799</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d5/rare_8c.html#a20">xxxSetAndDrawNCMetrics</a>(PUNICODE_STRING pProfileUserName,
00800     <span class="keywordtype">int</span> clNewBorder,
00801     LPNONCLIENTMETRICS lpnc)
00802 {
00803     <span class="keywordtype">int</span> dl;
00804     <span class="keywordtype">int</span> dxMinOld;
00805     <span class="keywordtype">int</span> dyMinOld;
00806     <span class="keywordtype">int</span> cxBorder;
00807     <span class="keywordtype">int</span> cyBorder;
00808     <span class="keywordtype">int</span> dyCaption;
00809     <span class="keywordtype">int</span> dyMenu;
00810 
00811     dl = clNewBorder - <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;gclBorder;
00812     dxMinOld = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINIMIZED);
00813     dyMinOld = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINIMIZED);
00814     cxBorder = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER);
00815     cyBorder = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER);
00816 
00817 
00818     <span class="comment">/*</span>
00819 <span class="comment">     * Do we need to recalculate?</span>
00820 <span class="comment">     */</span>
00821     <span class="keywordflow">if</span> ((lpnc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !dl)
00822         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00823 
00824     <span class="keywordflow">if</span> (lpnc) {
00825         dyCaption = (<span class="keywordtype">int</span>)lpnc-&gt;iCaptionHeight - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSIZE);
00826         dyMenu = (<span class="keywordtype">int</span>)lpnc-&gt;iMenuHeight - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMENUSIZE);
00827     } <span class="keywordflow">else</span> {
00828         dyCaption = dyMenu = 0;
00829     }
00830 
00831 
00832     <span class="comment">/*</span>
00833 <span class="comment">     * Recalculate the system metrics</span>
00834 <span class="comment">     */</span>
00835     <a class="code" href="../../d4/d1/userk_8h.html#a1857">xxxSetWindowNCMetrics</a>(pProfileUserName, lpnc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, clNewBorder);
00836 
00837     <span class="comment">/*</span>
00838 <span class="comment">     * Reset our saved menu size/position info</span>
00839 <span class="comment">     */</span>
00840     <a class="code" href="../../d2/d8/metrics_8c.html#a0">MenuRecalc</a>();
00841 
00842     <span class="comment">/*</span>
00843 <span class="comment">     * Reset window sized, positions, frames</span>
00844 <span class="comment">     */</span>
00845     <a class="code" href="../../d4/d1/userk_8h.html#a1536">xxxMetricsRecalc</a>(
00846             <a class="code" href="../../d4/d5/rare_8c.html#a1">CALC_FRAME</a> | (dl ? <a class="code" href="../../d4/d5/rare_8c.html#a0">CALC_RESIZE</a> : 0),
00847             dl*cxBorder,
00848             dl*cyBorder,
00849             dyCaption,
00850             dyMenu);
00851 
00852     dxMinOld = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINIMIZED) - dxMinOld;
00853     dyMinOld = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINIMIZED) - dyMinOld;
00854     <span class="keywordflow">if</span> (dxMinOld || dyMinOld) {
00855         <a class="code" href="../../d4/d1/userk_8h.html#a1536">xxxMetricsRecalc</a>(<a class="code" href="../../d4/d5/rare_8c.html#a2">CALC_MINIMIZE</a>, dxMinOld, dyMinOld, 0, 0);
00856     }
00857 
00858     <a class="code" href="../../d4/d1/userk_8h.html#a470">xxxRedrawScreen</a>();
00859 
00860 
00861     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00862 }
00863 
00864 <span class="comment">/***************************************************************************\</span>
00865 <span class="comment">* xxxSetAndDrawMinMetrics</span>
00866 <span class="comment">*</span>
00867 <span class="comment">* History:</span>
00868 <span class="comment">* 13-May-1994 mikeke     mikeke     Ported</span>
00869 <span class="comment">\***************************************************************************/</span>
<a name="l00870"></a><a class="code" href="../../d4/d5/rare_8c.html#a21">00870</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d5/rare_8c.html#a21">xxxSetAndDrawMinMetrics</a>(PUNICODE_STRING pProfileUserName,
00871         LPMINIMIZEDMETRICS lpmin
00872         )
00873 {
00874     <span class="comment">/*</span>
00875 <span class="comment">     * Save minimized window dimensions</span>
00876 <span class="comment">     */</span>
00877     <span class="keywordtype">int</span> dxMinOld = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINIMIZED);
00878     <span class="keywordtype">int</span> dyMinOld = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINIMIZED);
00879 
00880 
00881     <a class="code" href="../../d4/d1/userk_8h.html#a1856">SetMinMetrics</a>(pProfileUserName,lpmin);
00882 
00883     <span class="comment">/*</span>
00884 <span class="comment">     * Do we need to adjust minimized size?</span>
00885 <span class="comment">     */</span>
00886     dxMinOld = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINIMIZED) - dxMinOld;
00887     dyMinOld = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINIMIZED) - dyMinOld;
00888 
00889     <span class="keywordflow">if</span> (dxMinOld || dyMinOld) {
00890         <a class="code" href="../../d4/d1/userk_8h.html#a1536">xxxMetricsRecalc</a>(<a class="code" href="../../d4/d5/rare_8c.html#a2">CALC_MINIMIZE</a>, dxMinOld, dyMinOld, 0, 0);
00891     }
00892 
00893     <a class="code" href="../../d4/d1/userk_8h.html#a470">xxxRedrawScreen</a>();
00894 
00895 
00896     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00897 }
00898 
00899 
00900 <span class="comment">/***************************************************************************\</span>
00901 <span class="comment">* xxxSPISetNCMetrics</span>
00902 <span class="comment">*</span>
00903 <span class="comment">* History:</span>
00904 <span class="comment">* 13-May-1994 mikeke     mikeke     Ported</span>
00905 <span class="comment">\***************************************************************************/</span>
00906 
<a name="l00907"></a><a class="code" href="../../d4/d5/rare_8c.html#a22">00907</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d5/rare_8c.html#a22">xxxSPISetNCMetrics</a>(PUNICODE_STRING pProfileUserName,
00908         LPNONCLIENTMETRICS lpnc,
00909         BOOL fAlterWinIni
00910         )
00911 {
00912     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fWriteAllowed = !fAlterWinIni;
00913     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00914 
00915     <span class="keywordflow">if</span> (fAlterWinIni) {
00916         fChanged  = <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_BORDERWIDTH,     (<span class="keywordtype">int</span>) lpnc-&gt;iBorderWidth        );
00917         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_SCROLLWIDTH,     (<span class="keywordtype">int</span>) lpnc-&gt;iScrollWidth        );
00918         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_SCROLLHEIGHT,    (<span class="keywordtype">int</span>) lpnc-&gt;iScrollHeight       );
00919         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_CAPTIONWIDTH,    (<span class="keywordtype">int</span>) lpnc-&gt;iCaptionWidth       );
00920         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_CAPTIONHEIGHT,   (<span class="keywordtype">int</span>) lpnc-&gt;iCaptionHeight      );
00921         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_SMCAPTIONWIDTH,  (<span class="keywordtype">int</span>) lpnc-&gt;iSmCaptionWidth     );
00922         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_SMCAPTIONHEIGHT, (<span class="keywordtype">int</span>) lpnc-&gt;iSmCaptionHeight    );
00923         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_MENUWIDTH,       (<span class="keywordtype">int</span>) lpnc-&gt;iMenuWidth          );
00924         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_MENUHEIGHT,      (<span class="keywordtype">int</span>) lpnc-&gt;iMenuHeight         );
00925 
00926         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a19">SetWindowMetricFont</a>(pProfileUserName,STR_CAPTIONFONT,    &amp;lpnc-&gt;lfCaptionFont            );
00927         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a19">SetWindowMetricFont</a>(pProfileUserName,STR_SMCAPTIONFONT,  &amp;lpnc-&gt;lfSmCaptionFont          );
00928         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a19">SetWindowMetricFont</a>(pProfileUserName,STR_MENUFONT,       &amp;lpnc-&gt;lfMenuFont               );
00929         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a19">SetWindowMetricFont</a>(pProfileUserName,STR_STATUSFONT,     &amp;lpnc-&gt;lfStatusFont             );
00930         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a19">SetWindowMetricFont</a>(pProfileUserName,STR_MESSAGEFONT,    &amp;lpnc-&gt;lfMessageFont            );
00931 
00932         fWriteAllowed = fChanged;
00933     }
00934 
00935     <span class="keywordflow">if</span> (fWriteAllowed)
00936         <a class="code" href="../../d4/d5/rare_8c.html#a20">xxxSetAndDrawNCMetrics</a>(pProfileUserName,(<span class="keywordtype">int</span>) lpnc-&gt;iBorderWidth, lpnc);
00937 
00938     <span class="keywordflow">return</span> fChanged;
00939 }
00940 
00941 <span class="comment">/***************************************************************************\</span>
00942 <span class="comment">* xxxSPISetMinMetrics</span>
00943 <span class="comment">*</span>
00944 <span class="comment">* History:</span>
00945 <span class="comment">* 13-May-1994 mikeke     mikeke     Ported</span>
00946 <span class="comment">\***************************************************************************/</span>
00947 
<a name="l00948"></a><a class="code" href="../../d4/d5/rare_8c.html#a23">00948</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d5/rare_8c.html#a23">xxxSPISetMinMetrics</a>(PUNICODE_STRING pProfileUserName,
00949     LPMINIMIZEDMETRICS lpmin,
00950     BOOL fAlterWinIni
00951     )
00952 {
00953     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fWriteAllowed = !fAlterWinIni;
00954     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00955 
00956     <span class="keywordflow">if</span> (fAlterWinIni) {
00957         fChanged  = <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_MINWIDTH,   (<span class="keywordtype">int</span>) lpmin-&gt;iWidth      );
00958         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_MINHORZGAP, (<span class="keywordtype">int</span>) lpmin-&gt;iHorzGap    );
00959         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_MINVERTGAP, (<span class="keywordtype">int</span>) lpmin-&gt;iVertGap    );
00960         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_MINARRANGE, (<span class="keywordtype">int</span>) lpmin-&gt;iArrange    );
00961 
00962         fWriteAllowed = fChanged;
00963     }
00964 
00965     <span class="keywordflow">if</span> (fWriteAllowed) {
00966         <a class="code" href="../../d4/d5/rare_8c.html#a21">xxxSetAndDrawMinMetrics</a>(pProfileUserName,lpmin);
00967     }
00968 
00969     <span class="keywordflow">return</span> fChanged;
00970 }
00971 
00972 
00973 <span class="comment">/***************************************************************************\</span>
00974 <span class="comment">* SPISetIconMetrics</span>
00975 <span class="comment">*</span>
00976 <span class="comment">* History:</span>
00977 <span class="comment">* 13-May-1994 mikeke     mikeke     Ported</span>
00978 <span class="comment">\***************************************************************************/</span>
<a name="l00979"></a><a class="code" href="../../d4/d5/rare_8c.html#a24">00979</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d5/rare_8c.html#a24">SPISetIconMetrics</a>(PUNICODE_STRING pProfileUserName,
00980     LPICONMETRICS lpicon,
00981     BOOL          fAlterWinIni
00982     )
00983 {
00984     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fWriteAllowed = !fAlterWinIni;
00985     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00986 
00987     <span class="keywordflow">if</span> (fAlterWinIni) {
00988         fChanged  = <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_ICONHORZSPACING, (<span class="keywordtype">int</span>) lpicon-&gt;iHorzSpacing);
00989         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_ICONVERTSPACING, (<span class="keywordtype">int</span>) lpicon-&gt;iVertSpacing);
00990         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,STR_ICONTITLEWRAP,   (<span class="keywordtype">int</span>) lpicon-&gt;iTitleWrap);
00991         fChanged &amp;= <a class="code" href="../../d4/d5/rare_8c.html#a19">SetWindowMetricFont</a>(pProfileUserName,STR_ICONFONT,             &amp;lpicon-&gt;lfFont);
00992 
00993         fWriteAllowed = fChanged;
00994     }
00995 
00996     <span class="keywordflow">if</span> (fWriteAllowed) {
00997 
00998         <a class="code" href="../../d4/d1/userk_8h.html#a1858">SetIconMetrics</a>(pProfileUserName,lpicon);
00999 
01000         <a class="code" href="../../d4/d1/userk_8h.html#a470">xxxRedrawScreen</a>();
01001     }
01002 
01003     <span class="keywordflow">return</span> fChanged;
01004 }
01005 
01006 
01007 <span class="comment">/***************************************************************************\</span>
01008 <span class="comment">* SPISetIconTitleFont</span>
01009 <span class="comment">*</span>
01010 <span class="comment">* History:</span>
01011 <span class="comment">* 13-May-1994 mikeke     mikeke     Ported</span>
01012 <span class="comment">\***************************************************************************/</span>
01013 
<a name="l01014"></a><a class="code" href="../../d4/d5/rare_8c.html#a25">01014</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d5/rare_8c.html#a25">SPISetIconTitleFont</a>(PUNICODE_STRING pProfileUserName,
01015     LPLOGFONT lplf,
01016     BOOL      fAlterWinIni
01017     )
01018 {
01019     HFONT hfnT;
01020     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fWriteAllowed = !fAlterWinIni;
01021     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fWinIniChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01022 
01023     <span class="keywordflow">if</span> (hfnT = <a class="code" href="../../d4/d1/userk_8h.html#a1855">CreateFontFromWinIni</a>(pProfileUserName,lplf, STR_ICONFONT)) {
01024         <span class="keywordflow">if</span> (fAlterWinIni) {
01025 
01026             <span class="keywordflow">if</span> (lplf) {
01027                 LOGFONT <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a18">lf</a>;
01028 
01029                 GreExtGetObjectW(hfnT, <span class="keyword">sizeof</span>(LOGFONTW), &amp;<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a18">lf</a>);
01030                 fWinIniChanged = <a class="code" href="../../d4/d5/rare_8c.html#a19">SetWindowMetricFont</a>(pProfileUserName,STR_ICONFONT, &amp;<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a18">lf</a>);
01031             } <span class="keywordflow">else</span> {
01032                 <span class="comment">/*</span>
01033 <span class="comment">                 * !lParam so go back to current win.ini settings so</span>
01034 <span class="comment">                 */</span>
01035                 fWinIniChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01036             }
01037 
01038             fWriteAllowed = fWinIniChanged;
01039         }
01040 
01041         <span class="keywordflow">if</span> (fWriteAllowed) {
01042 
01043             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a148">ghIconFont</a>) {
01044                 GreMarkDeletableFont(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a148">ghIconFont</a>);
01045                 GreDeleteObject(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a148">ghIconFont</a>);
01046             }
01047 
01048             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a148">ghIconFont</a> = hfnT;
01049 
01050         } <span class="keywordflow">else</span> {
01051             GreMarkDeletableFont(hfnT);
01052             GreDeleteObject(hfnT);
01053         }
01054     }
01055 
01056     <span class="keywordflow">return</span> fWinIniChanged;
01057 }
01058 
01059 <span class="comment">/***************************************************************************\</span>
01060 <span class="comment">* xxxSetSPIMetrics</span>
01061 <span class="comment">*</span>
01062 <span class="comment">* History:</span>
01063 <span class="comment">* 13-May-1994 mikeke     mikeke     Ported</span>
01064 <span class="comment">\***************************************************************************/</span>
01065 
01066 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01067"></a><a class="code" href="../../d4/d5/rare_8c.html#a26">01067</a> <a class="code" href="../../d4/d5/rare_8c.html#a26">xxxSetSPIMetrics</a>(PUNICODE_STRING pProfileUserName,
01068         DWORD wFlag,
01069         LPVOID lParam,
01070         BOOL fAlterWinIni
01071         )
01072 {
01073     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fWinIniChanged;
01074 
01075     <span class="keywordflow">switch</span> (wFlag) {
01076     <span class="keywordflow">case</span> SPI_SETANIMATION:
01077         <span class="keywordflow">if</span> (fAlterWinIni) {
01078             fWinIniChanged = <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName,
01079                     STR_MINANIMATE,
01080                     (<span class="keywordtype">int</span>) ((LPANIMATIONINFO) lParam)-&gt;iMinAnimate
01081                     );
01082 
01083             <span class="keywordflow">if</span> (!fWinIniChanged) {
01084                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01085             }
01086         } <span class="keywordflow">else</span> {
01087             fWinIniChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01088         }
01089 
01090         <a class="code" href="../../d4/d1/userk_8h.html#a661">SET_OR_CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a636">PUDF_ANIMATE</a>, ((LPANIMATIONINFO) lParam)-&gt;iMinAnimate);
01091         <span class="keywordflow">return</span> fWinIniChanged;
01092 
01093     <span class="keywordflow">case</span> SPI_SETNONCLIENTMETRICS:
01094         <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/rare_8c.html#a22">xxxSPISetNCMetrics</a>(pProfileUserName,(LPNONCLIENTMETRICS) lParam, fAlterWinIni);
01095 
01096     <span class="keywordflow">case</span> SPI_SETICONMETRICS:
01097         <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/rare_8c.html#a24">SPISetIconMetrics</a>(pProfileUserName,(LPICONMETRICS) lParam, fAlterWinIni);
01098 
01099     <span class="keywordflow">case</span> SPI_SETMINIMIZEDMETRICS:
01100         <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/rare_8c.html#a23">xxxSPISetMinMetrics</a>(pProfileUserName,(LPMINIMIZEDMETRICS) lParam, fAlterWinIni);
01101 
01102     <span class="keywordflow">case</span> SPI_SETICONTITLELOGFONT:
01103         <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/rare_8c.html#a25">SPISetIconTitleFont</a>(pProfileUserName,(LPLOGFONT) lParam, fAlterWinIni);
01104 
01105     <span class="keywordflow">default</span>:
01106         RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"SetSPIMetrics. Invalid wFlag: %#lx"</span>, wFlag);
01107         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01108     }
01109 }
01110 
01111 <span class="comment">/***************************************************************************\</span>
01112 <span class="comment">* SetFilterKeys</span>
01113 <span class="comment">*</span>
01114 <span class="comment">* History:</span>
01115 <span class="comment">* 10-12-94 JimA         Created.</span>
01116 <span class="comment">\***************************************************************************/</span>
01117 
<a name="l01118"></a><a class="code" href="../../d4/d5/rare_8c.html#a27">01118</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d5/rare_8c.html#a27">SetFilterKeys</a>(PUNICODE_STRING pProfileUserName,
01119     LPFILTERKEYS pFilterKeys)
01120 {
01121     LPWSTR           pwszd = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%d"</span>;
01122     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>             fWinIniChanged;
01123     WCHAR            szTemp[40];
01124 
01125     swprintf(szTemp, pwszd, pFilterKeys-&gt;dwFlags);
01126     fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
01127             <a class="code" href="../../d4/d1/userk_8h.html#a710">PMAP_KEYBOARDRESPONSE</a>,
01128             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Flags"</span>,
01129             szTemp
01130             );
01131 
01132     swprintf(szTemp, pwszd, pFilterKeys-&gt;iWaitMSec);
01133     fWinIniChanged &amp;= <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
01134             <a class="code" href="../../d4/d1/userk_8h.html#a710">PMAP_KEYBOARDRESPONSE</a>,
01135             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DelayBeforeAcceptance"</span>,
01136             szTemp
01137             );
01138 
01139     swprintf(szTemp, pwszd, pFilterKeys-&gt;iDelayMSec);
01140     fWinIniChanged &amp;= <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
01141             <a class="code" href="../../d4/d1/userk_8h.html#a710">PMAP_KEYBOARDRESPONSE</a>,
01142             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"AutoRepeatDelay"</span>,
01143             szTemp
01144             );
01145 
01146     swprintf(szTemp, pwszd, pFilterKeys-&gt;iRepeatMSec);
01147     fWinIniChanged &amp;= <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
01148             <a class="code" href="../../d4/d1/userk_8h.html#a710">PMAP_KEYBOARDRESPONSE</a>,
01149             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"AutoRepeatRate"</span>,
01150             szTemp
01151             );
01152 
01153     swprintf(szTemp, pwszd, pFilterKeys-&gt;iBounceMSec);
01154     fWinIniChanged &amp;= <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
01155             <a class="code" href="../../d4/d1/userk_8h.html#a710">PMAP_KEYBOARDRESPONSE</a>,
01156             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"BounceTime"</span>,
01157             szTemp
01158             );
01159 
01160     <span class="keywordflow">return</span> fWinIniChanged;
01161 }
01162 
01163 <span class="comment">/***************************************************************************\</span>
01164 <span class="comment">* SetMouseKeys</span>
01165 <span class="comment">*</span>
01166 <span class="comment">* History:</span>
01167 <span class="comment">* 10-12-94 JimA         Created.</span>
01168 <span class="comment">\***************************************************************************/</span>
01169 
<a name="l01170"></a><a class="code" href="../../d4/d5/rare_8c.html#a28">01170</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d5/rare_8c.html#a28">SetMouseKeys</a>(PUNICODE_STRING pProfileUserName,
01171     LPMOUSEKEYS  pMK)
01172 {
01173     LPWSTR           pwszd = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%d"</span>;
01174     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>             fWinIniChanged;
01175     WCHAR            szTemp[40];
01176 
01177     swprintf(szTemp, pwszd, pMK-&gt;dwFlags);
01178     fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
01179             <a class="code" href="../../d4/d1/userk_8h.html#a711">PMAP_MOUSEKEYS</a>,
01180             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Flags"</span>,
01181             szTemp
01182             );
01183 
01184     swprintf(szTemp, pwszd, pMK-&gt;iMaxSpeed);
01185     fWinIniChanged &amp;= <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
01186             <a class="code" href="../../d4/d1/userk_8h.html#a711">PMAP_MOUSEKEYS</a>,
01187             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MaximumSpeed"</span>,
01188             szTemp
01189             );
01190 
01191     swprintf(szTemp, pwszd, pMK-&gt;iTimeToMaxSpeed);
01192     fWinIniChanged &amp;= <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
01193             <a class="code" href="../../d4/d1/userk_8h.html#a711">PMAP_MOUSEKEYS</a>,
01194             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"TimeToMaximumSpeed"</span>,
01195             szTemp
01196             );
01197 
01198     <span class="keywordflow">return</span> fWinIniChanged;
01199 }
01200 
01201 <span class="comment">/***************************************************************************\</span>
01202 <span class="comment">* SetSoundSentry</span>
01203 <span class="comment">*</span>
01204 <span class="comment">* History:</span>
01205 <span class="comment">* 10-12-94 JimA         Created.</span>
01206 <span class="comment">\***************************************************************************/</span>
01207 
<a name="l01208"></a><a class="code" href="../../d4/d5/rare_8c.html#a29">01208</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d5/rare_8c.html#a29">SetSoundSentry</a>(PUNICODE_STRING pProfileUserName,
01209     LPSOUNDSENTRY pSS)
01210 {
01211     LPWSTR           pwszd = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%d"</span>;
01212     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>             fWinIniChanged;
01213     WCHAR            szTemp[40];
01214 
01215     swprintf(szTemp, pwszd, pSS-&gt;dwFlags);
01216     fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
01217             <a class="code" href="../../d4/d1/userk_8h.html#a714">PMAP_SOUNDSENTRY</a>,
01218             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Flags"</span>,
01219             szTemp
01220             );
01221 
01222     swprintf(szTemp, pwszd, pSS-&gt;iFSTextEffect);
01223     fWinIniChanged &amp;= <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
01224             <a class="code" href="../../d4/d1/userk_8h.html#a714">PMAP_SOUNDSENTRY</a>,
01225             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"TextEffect"</span>,
01226             szTemp
01227             );
01228 
01229     swprintf(szTemp, pwszd, pSS-&gt;iWindowsEffect);
01230     fWinIniChanged &amp;= <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
01231             <a class="code" href="../../d4/d1/userk_8h.html#a714">PMAP_SOUNDSENTRY</a>,
01232             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"WindowsEffect"</span>,
01233             szTemp
01234             );
01235 
01236     <span class="keywordflow">return</span> fWinIniChanged;
01237 }
01238 
01239 
01240 <span class="comment">/***************************************************************************\</span>
01241 <span class="comment">* CalculateMouseSensitivity</span>
01242 <span class="comment">*</span>
01243 <span class="comment">* History:</span>
01244 <span class="comment">* 09-27-96 jparsons     Created.</span>
01245 <span class="comment">\***************************************************************************/</span>
01246 
<a name="l01247"></a><a class="code" href="../../d4/d1/userk_8h.html#a1031">01247</a> LONG <a class="code" href="../../d4/d1/userk_8h.html#a1031">CalculateMouseSensitivity</a>(LONG lSens)
01248 <span class="comment">/*</span>
01249 <span class="comment"> *      The resultant table looks like this...</span>
01250 <span class="comment"> *</span>
01251 <span class="comment"> *      Sens |  Sensitivity Adjustment</span>
01252 <span class="comment"> *       0   |  0           * SENS_SCALAR  ALGORITHM 0&lt;=NUM&lt;=2</span>
01253 <span class="comment"> *       1   |  1/32        * SENS_SCALAR   (NUM/32)*SENS_SCALAR</span>
01254 <span class="comment"> *       2   |  1/16        * SENS_SCALAR</span>
01255 <span class="comment"> *       3   |  1/8         * SENS_SCALAR  ALGORITHM 3&lt;=NUM&lt;=10</span>
01256 <span class="comment"> *       4   |  1/4  (2/8)  * SENS_SCALAR   ((NUM-2)/8)*SENS_SCALAR</span>
01257 <span class="comment"> *       5   |  3/8         * SENS_SCALAR</span>
01258 <span class="comment"> *       6   |  1/2  (4/8)  * SENS_SCALAR</span>
01259 <span class="comment"> *       7   |  5/8         * SENS_SCALAR</span>
01260 <span class="comment"> *       8   |  3/4  (6/8)  * SENS_SCALAR</span>
01261 <span class="comment"> *       9   |  7/8         * SENS_SCALAR</span>
01262 <span class="comment"> *       10  |  1           * SENS_SCALAR</span>
01263 <span class="comment"> *       11  |  5/4         * SENS_SCALAR  ALGORITHM NUM&gt;=11</span>
01264 <span class="comment"> *       12  |  3/2  (6/4)  * SENS_SCALAR   ((NUM-6)/4)*SENS_SCALAR</span>
01265 <span class="comment"> *       13  |  7/4         * SENS_SCALAR</span>
01266 <span class="comment"> *       14  |  2    (8/4)  * SENS_SCALAR</span>
01267 <span class="comment"> *       15  |  9/4         * SENS_SCALAR</span>
01268 <span class="comment"> *       16  |  5/2  (10/4) * SENS_SCALAR</span>
01269 <span class="comment"> *       17  |  11/4        * SENS_SCALAR</span>
01270 <span class="comment"> *       18  |  3    (12/4) * SENS_SCALAR</span>
01271 <span class="comment"> *       19  |  13/4        * SENS_SCALAR</span>
01272 <span class="comment"> *       20  |  7/2  (14/4) * SENS_SCALAR</span>
01273 <span class="comment"> *</span>
01274 <span class="comment"> *     COMMENTS:  Sensitivities are constrained to be between 1 and 20.</span>
01275 <span class="comment"> */</span>
01276 {
01277     LONG lSenFactor ;
01278 
01279     <span class="keywordflow">if</span>(lSens &lt;= 2)
01280        lSenFactor=lSens*256/32 ;
01281     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(lSens &gt;= 3 &amp;&amp; lSens &lt;= 10 )
01282        lSenFactor=(lSens-2)*256/8 ;
01283     <span class="keywordflow">else</span>
01284        lSenFactor=(lSens-6)*256/4 ;
01285 
01286     <span class="keywordflow">return</span> lSenFactor ;
01287 }
01288 
01289 
01290 <span class="comment">/***************************************************************************\</span>
01291 <span class="comment">* xxxSystemParametersInfo</span>
01292 <span class="comment">*</span>
01293 <span class="comment">* SPI_GETBEEP:   wParam is not used. lParam is long pointer to a boolean which</span>
01294 <span class="comment">*                gets true if beep on, false if beep off.</span>
01295 <span class="comment">*</span>
01296 <span class="comment">* SPI_SETBEEP:   wParam is a bool which sets beep on (true) or off (false).</span>
01297 <span class="comment">*                lParam is not used.</span>
01298 <span class="comment">*</span>
01299 <span class="comment">* SPI_GETMOUSE:  wParam is not used. lParam is long pointer to an integer</span>
01300 <span class="comment">*                array where rgw[0] gets xMouseThreshold, rgw[1] gets</span>
01301 <span class="comment">*                yMouseThreshold, and rgw[2] gets gMouseSpeed.</span>
01302 <span class="comment">*</span>
01303 <span class="comment">* SPI_SETMOUSE:  wParam is not used. lParam is long pointer to an integer</span>
01304 <span class="comment">*                array as described above.  User's values are set to values</span>
01305 <span class="comment">*                in array.</span>
01306 <span class="comment">*</span>
01307 <span class="comment">* SPI_GETBORDER: wParam is not used. lParam is long pointer to an integer</span>
01308 <span class="comment">*                which gets the value of clBorder (border multiplier factor).</span>
01309 <span class="comment">*</span>
01310 <span class="comment">* SPI_SETBORDER: wParam is an integer which sets gpsi-&gt;gclBorder.</span>
01311 <span class="comment">*                lParam is not used.</span>
01312 <span class="comment">*</span>
01313 <span class="comment">* SPI_GETKEYBOARDDELAY: wParam is not used. lParam is a long pointer to an int</span>
01314 <span class="comment">*                which gets the current keyboard repeat delay setting.</span>
01315 <span class="comment">*</span>
01316 <span class="comment">* SPI_SETKEYBOARDDELAY: wParam is the new keyboard delay setting.</span>
01317 <span class="comment">*                lParam is not used.</span>
01318 <span class="comment">*</span>
01319 <span class="comment">* SPI_GETKEYBOARDSPEED: wParam is not used.  lParam is a long pointer</span>
01320 <span class="comment">*                to an int which gets the current keyboard repeat</span>
01321 <span class="comment">*                speed setting.</span>
01322 <span class="comment">*</span>
01323 <span class="comment">* SPI_SETKEYBOARDSPEED: wParam is the new keyboard speed setting.</span>
01324 <span class="comment">*                lParam is not used.</span>
01325 <span class="comment">*</span>
01326 <span class="comment">* SPI_KANJIMENU: wParam contains:</span>
01327 <span class="comment">*                    1 - Mouse accelerator</span>
01328 <span class="comment">*                    2 - ASCII accelerator</span>
01329 <span class="comment">*                    3 - Kana accelerator</span>
01330 <span class="comment">*                lParam is not used.  The wParam value is stored in the global</span>
01331 <span class="comment">*                KanjiMenu for use in accelerator displaying &amp; searching.</span>
01332 <span class="comment">*</span>
01333 <span class="comment">* SPI_LANGDRIVER: wParam is not used.</span>
01334 <span class="comment">*                 lParam contains a LPSTR to the new language driver filename.</span>
01335 <span class="comment">*</span>
01336 <span class="comment">* SPI_ICONHORIZONTALSPACING: wParam is the width in pixels of an icon cell.</span>
01337 <span class="comment">*</span>
01338 <span class="comment">* SPI_ICONVERTICALSPACING: wParam is the height in pixels of an icon cell.</span>
01339 <span class="comment">*</span>
01340 <span class="comment">* SPI_GETSCREENSAVETIMEOUT: wParam is not used</span>
01341 <span class="comment">*                lParam is a pointer to an int which gets the screen saver</span>
01342 <span class="comment">*                timeout value.</span>
01343 <span class="comment">*</span>
01344 <span class="comment">* SPI_SETSCREENSAVETIMEOUT: wParam is the time in seconds for the system</span>
01345 <span class="comment">*                to be idle before screensaving.</span>
01346 <span class="comment">*</span>
01347 <span class="comment">* SPI_GETSCREENSAVEACTIVE: lParam is a pointer to a BOOL which gets TRUE</span>
01348 <span class="comment">*                if the screensaver is active else gets false.</span>
01349 <span class="comment">*</span>
01350 <span class="comment">* SPI_SETSCREENSAVEACTIVE: if wParam is TRUE, screensaving is activated</span>
01351 <span class="comment">*                else it is deactivated.</span>
01352 <span class="comment">*</span>
01353 <span class="comment">* SPI_GETLOWPOWERTIMEOUT:</span>
01354 <span class="comment">* SPI_GETPOWEROFFTIMEOUT: wParam is not used</span>
01355 <span class="comment">*                lParam is a pointer to an int which gets the appropriate</span>
01356 <span class="comment">*                power saving screen blanker timeout value.</span>
01357 <span class="comment">*</span>
01358 <span class="comment">* SPI_SETLOWPOWERTIMEOUT:</span>
01359 <span class="comment">* SPI_SETPOWEROFFTIMEOUT: wParam is the time in seconds for the system</span>
01360 <span class="comment">*                to be idle before power saving screen blanking.</span>
01361 <span class="comment">*</span>
01362 <span class="comment">* SPI_GETLOWPOWERACTIVE:</span>
01363 <span class="comment">* SPI_GETPOWEROFFACTIVE: lParam is a pointer to a BOOL which gets TRUE</span>
01364 <span class="comment">*                if the power saving screen blanker is active else gets false.</span>
01365 <span class="comment">*</span>
01366 <span class="comment">* SPI_SETLOWPOWERACTIVE:</span>
01367 <span class="comment">* SPI_SETPOWEROFFACTIVE: if wParam is TRUE, power saving screen blanking is</span>
01368 <span class="comment">*                activated else it is deactivated.</span>
01369 <span class="comment">*</span>
01370 <span class="comment">* SPI_GETGRIDGRANULARITY: Obsolete. Returns 1 always.</span>
01371 <span class="comment">*</span>
01372 <span class="comment">* SPI_SETGRIDGRANULARITY: Obsolete.  Does nothing.</span>
01373 <span class="comment">*</span>
01374 <span class="comment">* SPI_SETDESKWALLPAPER: wParam is not used; lParam is a long ptr to a string</span>
01375 <span class="comment">*                that holds the name of the bitmap file to be used as the</span>
01376 <span class="comment">*                desktop wall paper.</span>
01377 <span class="comment">*</span>
01378 <span class="comment">* SPI_SETDESKPATTERN: Both wParam and lParam are not used; USER will read the</span>
01379 <span class="comment">*                "pattern=" from WIN.INI and make it as the current desktop</span>
01380 <span class="comment">*                 pattern;</span>
01381 <span class="comment">*</span>
01382 <span class="comment">* SPI_GETICONTITLEWRAP: lParam is LPINT which gets 0 if wrapping if off</span>
01383 <span class="comment">*                       else gets 1.</span>
01384 <span class="comment">*</span>
01385 <span class="comment">* SPI_SETICONTITLEWRAP: wParam specifies TRUE to turn wrapping on else false</span>
01386 <span class="comment">*</span>
01387 <span class="comment">* SPI_GETMENUDROPALIGNMENT: lParam is LPINT which gets 0 specifies if menus</span>
01388 <span class="comment">*                 drop left aligned else 1 if drop right aligned.</span>
01389 <span class="comment">*</span>
01390 <span class="comment">* SPI_SETMENUDROPALIGNMENT: wParam 0 specifies if menus drop left aligned else</span>
01391 <span class="comment">*                 the drop right aligned.</span>
01392 <span class="comment">*</span>
01393 <span class="comment">* SPI_SETDOUBLECLKWIDTH: wParam specifies the width of the rectangle</span>
01394 <span class="comment">*                 within which the second click of a double click must fall</span>
01395 <span class="comment">*                 for it to be registered as a double click.</span>
01396 <span class="comment">*</span>
01397 <span class="comment">* SPI_SETDOUBLECLKHEIGHT: wParam specifies the height of the rectangle</span>
01398 <span class="comment">*                 within which the second click of a double click must fall</span>
01399 <span class="comment">*                 for it to be registered as a double click.</span>
01400 <span class="comment">*</span>
01401 <span class="comment">* SPI_GETICONTITLELOGFONT: lParam is a pointer to a LOGFONT struct which</span>
01402 <span class="comment">*                 gets the logfont for the current icon title font. wParam</span>
01403 <span class="comment">*                 specifies the size of the logfont struct.</span>
01404 <span class="comment">*</span>
01405 <span class="comment">* SPI_SETDOUBLECLICKTIME: wParm specifies the double click time</span>
01406 <span class="comment">*</span>
01407 <span class="comment">* SPI_SETMOUSEBUTTONSWAP: if wParam is 1, swap mouse buttons else if wParam</span>
01408 <span class="comment">*                 is 0, don't swap buttons</span>
01409 <span class="comment">* SPI_SETDRAGFULLWINDOWS: wParam = fSet.</span>
01410 <span class="comment">* SPI_GETDRAGFULLWINDOWS: returns fSet.</span>
01411 <span class="comment">*</span>
01412 <span class="comment">* SPI_GETFILTERKEYS: lParam is a pointer to a FILTERKEYS struct.  wParam</span>
01413 <span class="comment">*                 specifies the size of the filterkeys struct.</span>
01414 <span class="comment">*</span>
01415 <span class="comment">* SPI_SETFILTERKEYS: lParam is a pointer to a FILTERKEYS struct.  wParam</span>
01416 <span class="comment">*                 is not used.</span>
01417 <span class="comment">*</span>
01418 <span class="comment">* SPI_GETSTICKYKEYS: lParam is a pointer to a STICKYKEYS struct.  wParam</span>
01419 <span class="comment">*                 specifies the size of the stickykeys struct.</span>
01420 <span class="comment">*</span>
01421 <span class="comment">* SPI_SETSTICKYKEYS: lParam is a pointer to a STICKYKEYS struct.  wParam</span>
01422 <span class="comment">*                 is not used.</span>
01423 <span class="comment">*</span>
01424 <span class="comment">* SPI_GETMOUSEKEYS: lParam is a pointer to a MOUSEKEYS struct.  wParam</span>
01425 <span class="comment">*                 specifies the size of the mousekeys struct.</span>
01426 <span class="comment">*</span>
01427 <span class="comment">* SPI_SETMOUSEKEYS: lParam is a pointer to a MOUSEKEYS struct.  wParam</span>
01428 <span class="comment">*                 is not used.</span>
01429 <span class="comment">*</span>
01430 <span class="comment">* SPI_GETACCESSTIMEOUT: lParam is a pointer to an ACCESSTIMEOUT struct.</span>
01431 <span class="comment">*                 wParam specifies the size of the accesstimeout struct.</span>
01432 <span class="comment">*</span>
01433 <span class="comment">* SPI_SETACCESSTIMEOUT: lParam is a pointer to a ACCESSTIMEOUT struct.</span>
01434 <span class="comment">*                 wParam is not used.</span>
01435 <span class="comment">*</span>
01436 <span class="comment">* SPI_GETTOGGLEKEYS: lParam is a pointer to a TOGGLEKEYS struct.  wParam</span>
01437 <span class="comment">*                 specifies the size of the togglekeys struct.</span>
01438 <span class="comment">*</span>
01439 <span class="comment">* SPI_SETTOGGLEKEYS: lParam is a pointer to a TOGGLEKEYS struct.  wParam</span>
01440 <span class="comment">*                 is not used.</span>
01441 <span class="comment">*</span>
01442 <span class="comment">* SPI_GETKEYBOARDPREF: lParam is a pointer to a BOOL.</span>
01443 <span class="comment">*                 wParam is not used.</span>
01444 <span class="comment">*</span>
01445 <span class="comment">* SPI_SETKEYBOARDPREF: wParam is a BOOL.</span>
01446 <span class="comment">*                 lParam is not used.</span>
01447 <span class="comment">*</span>
01448 <span class="comment">* SPI_GETSCREENREADER: lParam is a pointer to a BOOL.</span>
01449 <span class="comment">*                 wParam is not used.</span>
01450 <span class="comment">*</span>
01451 <span class="comment">* SPI_SETSCREENREADER: wParam is a BOOL.</span>
01452 <span class="comment">*                 lParam is not used.</span>
01453 <span class="comment">*</span>
01454 <span class="comment">* SPI_GETSHOWSOUNDS: lParam is a pointer to a SHOWSOUNDS struct.  wParam</span>
01455 <span class="comment">*                 specifies the size of the showsounds struct.</span>
01456 <span class="comment">*</span>
01457 <span class="comment">* SPI_SETSHOWSOUNDS: lParam is a pointer to a SHOWSOUNDS struct.  wParam</span>
01458 <span class="comment">*                 is not used.</span>
01459 <span class="comment">*</span>
01460 <span class="comment">* SPI_GETNONCLIENTMETRICS: lParam is a pointer to a NONCLIENTMETRICSW struct.</span>
01461 <span class="comment">*                 wPAram is not used.</span>
01462 <span class="comment">*</span>
01463 <span class="comment">* SPI_GETSNAPTODEFBUTTON: lParam is a pointer to a BOOL which gets TRUE</span>
01464 <span class="comment">*                if the snap to default push button is active else gets false.</span>
01465 <span class="comment">*</span>
01466 <span class="comment">* SPI_SETSNAPTODEFBUTTON: if wParam is TRUE, dialog boxes will snap the mouse</span>
01467 <span class="comment">*                pointer to the default push button when created.</span>
01468 <span class="comment">*</span>
01469 <span class="comment">* SPI_GETFONTSMOOTHING:</span>
01470 <span class="comment">*     wParam is unused</span>
01471 <span class="comment">*     lParam is LPINT for boolean fFontSmoothing</span>
01472 <span class="comment">*</span>
01473 <span class="comment">* SPI_SETFONTSMOOTHING:</span>
01474 <span class="comment">*     wParam is INT for boolean fFontSmoothing</span>
01475 <span class="comment">*</span>
01476 <span class="comment">* SPI_GETWHEELSCROLLLINES: lParam is a pointer to a ULONG to receive the</span>
01477 <span class="comment">*                 suggested number of lines to scroll when the wheel is</span>
01478 <span class="comment">*                 rotated. wParam is unused.</span>
01479 <span class="comment">*</span>
01480 <span class="comment">* SPI_SETWHEELSCROLLLINES: wParam is a ULONG containing the suggested number</span>
01481 <span class="comment">*                 of lines to scroll when the wheel is rotated. lParam is</span>
01482 <span class="comment">*                 unused.</span>
01483 <span class="comment">*</span>
01484 <span class="comment">* SPI_SETSCREENSAVERRUNNING / SPI_SCREENSAVERRUNNING: not supported on NT.</span>
01485 <span class="comment">* SPI_GETSCREENSAVERRUNNING: wParam - Not used. lParam a pointer to a BOOL which</span>
01486 <span class="comment">*                 will receive TRUE is a screen saver is running or FALSE otherwise.</span>
01487 <span class="comment">*</span>
01488 <span class="comment">* SPI_SETSHOWIMEUI wParam is TRUE or FALSE</span>
01489 <span class="comment">* SPI_GETSHOWIMEUI neither wParam or lParam used</span>
01490 <span class="comment">*</span>
01491 <span class="comment">* History:</span>
01492 <span class="comment">* 06-28-91      MikeHar     Ported.</span>
01493 <span class="comment">* 12-8-93       SanfordS    Added SPI_SET/GETDRAGFULLWINDOWS</span>
01494 <span class="comment">* 20-May-1996   adams       Added SPI_SET/GETWHEELSCROLLLINES</span>
01495 <span class="comment">\***************************************************************************/</span>
01496 
<a name="l01497"></a><a class="code" href="../../d4/d5/rare_8c.html#a31">01497</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1493">xxxSystemParametersInfo</a>(
01498         UINT         wFlag,     <span class="comment">// Item to change</span>
01499         DWORD        wParam,
01500         PVOID        lParam,
01501         UINT         flags
01502         )
01503 {
01504     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>         ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
01505     <span class="keywordtype">int</span>                  clBorderOld;
01506     <span class="keywordtype">int</span>                  clBorderNew;
01507     LPWSTR               pwszd = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%d"</span>;
01508     WCHAR                szSection[40];
01509     WCHAR                szTemp[40];
01510     WCHAR                szPat[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
01511     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                 fWinIniChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01512     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                 fAlterWinIni = ((flags &amp; SPIF_UPDATEINIFILE) != 0);
01513     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                 fSendWinIniChange = ((flags &amp; SPIF_SENDCHANGE) != 0);
01514     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                 fWriteAllowed = !fAlterWinIni;
01515     ACCESS_MASK          amRequest;
01516     <a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">LARGE_UNICODE_STRING</a> strSection;
01517     <span class="keywordtype">int</span>                  *piTimeOut;
01518     <span class="keywordtype">int</span>                  iResID;
01519     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlName;
01520     PUNICODE_STRING pProfileUserName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01521 
01522     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
01523 
01524     <span class="comment">/*</span>
01525 <span class="comment">     * CONSIDER(adams) : Many of the SPI_GET* could be implemented</span>
01526 <span class="comment">     * on the client side (SnapTo, WheelScrollLines, etc.).</span>
01527 <span class="comment">     */</span>
01528 
01529     <span class="comment">/*</span>
01530 <span class="comment">     * Features not implemented</span>
01531 <span class="comment">     */</span>
01532 
01533     <span class="keywordflow">switch</span> (wFlag)
01534     {
01535         <span class="keywordflow">case</span> SPI_TIMEOUTS:
01536         <span class="keywordflow">case</span> SPI_KANJIMENU:
01537         <span class="keywordflow">case</span> SPI_LANGDRIVER:
01538         <span class="keywordflow">case</span> SPI_UNUSED39:
01539         <span class="keywordflow">case</span> SPI_UNUSED40:
01540         <span class="keywordflow">case</span> SPI_SETPENWINDOWS:
01541 
01542         <span class="keywordflow">case</span> SPI_GETWINDOWSEXTENSION:
01543         <span class="keywordflow">case</span> SPI_SETSCREENSAVERRUNNING:     <span class="comment">// same as SPI_SCREENSAVERRUNNING</span>
01544 
01545         <span class="keywordflow">case</span> SPI_GETSERIALKEYS:
01546         <span class="keywordflow">case</span> SPI_SETSERIALKEYS:
01547 
01548         <span class="keywordflow">case</span> SPI_SETMOUSETRAILS:
01549         <span class="keywordflow">case</span> SPI_GETMOUSETRAILS:
01550             RIPERR1(ERROR_INVALID_PARAMETER,
01551                     RIP_WARNING,
01552                     <span class="stringliteral">"SPI_ 0x%lx parameter not supported"</span>, wFlag );
01553 
01554             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01555     }
01556 
01557 
01558     <span class="comment">/*</span>
01559 <span class="comment">     * Perform access check.  Always grant access to CSR.</span>
01560 <span class="comment">     */</span>
01561     <span class="keywordflow">if</span> (ppi-&gt;Process != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>) {
01562         <span class="keywordflow">switch</span> (wFlag) {
01563         <span class="keywordflow">case</span> SPI_SETBEEP:
01564         <span class="keywordflow">case</span> SPI_SETMOUSE:
01565         <span class="keywordflow">case</span> SPI_SETBORDER:
01566         <span class="keywordflow">case</span> SPI_SETKEYBOARDSPEED:
01567         <span class="keywordflow">case</span> SPI_SETDEFAULTINPUTLANG:
01568         <span class="keywordflow">case</span> SPI_SETSCREENSAVETIMEOUT:
01569         <span class="keywordflow">case</span> SPI_SETSCREENSAVEACTIVE:
01570         <span class="keywordflow">case</span> SPI_SETLOWPOWERTIMEOUT:
01571         <span class="keywordflow">case</span> SPI_SETPOWEROFFTIMEOUT:
01572         <span class="keywordflow">case</span> SPI_SETLOWPOWERACTIVE:
01573         <span class="keywordflow">case</span> SPI_SETPOWEROFFACTIVE:
01574         <span class="keywordflow">case</span> SPI_SETGRIDGRANULARITY:
01575         <span class="keywordflow">case</span> SPI_SETDESKWALLPAPER:
01576         <span class="keywordflow">case</span> SPI_SETDESKPATTERN:
01577         <span class="keywordflow">case</span> SPI_SETKEYBOARDDELAY:
01578         <span class="keywordflow">case</span> SPI_SETICONTITLEWRAP:
01579         <span class="keywordflow">case</span> SPI_SETMENUDROPALIGNMENT:
01580         <span class="keywordflow">case</span> SPI_SETDOUBLECLKWIDTH:
01581         <span class="keywordflow">case</span> SPI_SETDOUBLECLKHEIGHT:
01582         <span class="keywordflow">case</span> SPI_SETDOUBLECLICKTIME:
01583         <span class="keywordflow">case</span> SPI_SETMOUSEBUTTONSWAP:
01584         <span class="keywordflow">case</span> SPI_SETICONTITLELOGFONT:
01585         <span class="keywordflow">case</span> SPI_SETFASTTASKSWITCH:
01586         <span class="keywordflow">case</span> SPI_SETFILTERKEYS:
01587         <span class="keywordflow">case</span> SPI_SETTOGGLEKEYS:
01588         <span class="keywordflow">case</span> SPI_SETMOUSEKEYS:
01589         <span class="keywordflow">case</span> SPI_SETSHOWSOUNDS:
01590         <span class="keywordflow">case</span> SPI_SETSTICKYKEYS:
01591         <span class="keywordflow">case</span> SPI_SETACCESSTIMEOUT:
01592         <span class="keywordflow">case</span> SPI_SETSOUNDSENTRY:
01593         <span class="keywordflow">case</span> SPI_SETKEYBOARDPREF:
01594         <span class="keywordflow">case</span> SPI_SETSCREENREADER:
01595         <span class="keywordflow">case</span> SPI_SETSNAPTODEFBUTTON:
01596         <span class="keywordflow">case</span> SPI_SETANIMATION:
01597         <span class="keywordflow">case</span> SPI_SETNONCLIENTMETRICS:
01598         <span class="keywordflow">case</span> SPI_SETICONMETRICS:
01599         <span class="keywordflow">case</span> SPI_SETMINIMIZEDMETRICS:
01600         <span class="keywordflow">case</span> SPI_SETWORKAREA:
01601         <span class="keywordflow">case</span> SPI_SETFONTSMOOTHING:
01602         <span class="keywordflow">case</span> SPI_SETMOUSEHOVERWIDTH:
01603         <span class="keywordflow">case</span> SPI_SETMOUSEHOVERHEIGHT:
01604         <span class="keywordflow">case</span> SPI_SETMOUSEHOVERTIME:
01605         <span class="keywordflow">case</span> SPI_SETWHEELSCROLLLINES:
01606         <span class="keywordflow">case</span> SPI_SETMENUSHOWDELAY:
01607         <span class="keywordflow">case</span> SPI_SETHIGHCONTRAST:
01608         <span class="keywordflow">case</span> SPI_SETDRAGFULLWINDOWS:
01609         <span class="keywordflow">case</span> SPI_SETDRAGWIDTH:
01610         <span class="keywordflow">case</span> SPI_SETDRAGHEIGHT:
01611         <span class="keywordflow">case</span> SPI_SETCURSORS:
01612         <span class="keywordflow">case</span> SPI_SETICONS:
01613         <span class="keywordflow">case</span> SPI_SETLANGTOGGLE:
01614             amRequest = WINSTA_WRITEATTRIBUTES;
01615             <span class="keywordflow">break</span>;
01616 
01617         <span class="keywordflow">case</span> SPI_ICONHORIZONTALSPACING:
01618         <span class="keywordflow">case</span> SPI_ICONVERTICALSPACING:
01619             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(lParam)) {
01620                 amRequest = WINSTA_READATTRIBUTES;
01621             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam) {
01622                 amRequest = WINSTA_WRITEATTRIBUTES;
01623             } <span class="keywordflow">else</span>
01624                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01625             <span class="keywordflow">break</span>;
01626 
01627         <span class="keywordflow">default</span>:
01628             <span class="keywordflow">if</span> ((wFlag &amp; SPIF_RANGETYPEMASK) &amp;&amp; (wFlag &amp; SPIF_SET)) {
01629                 amRequest = WINSTA_WRITEATTRIBUTES;
01630             } <span class="keywordflow">else</span> {
01631                 amRequest = WINSTA_READATTRIBUTES;
01632             }
01633             <span class="keywordflow">break</span>;
01634         }
01635 
01636         <span class="keywordflow">if</span> (amRequest == WINSTA_READATTRIBUTES) {
01637             <a class="code" href="../../d4/d1/userk_8h.html#a263">RETURN_IF_ACCESS_DENIED</a>(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o16">amwinsta</a>, amRequest, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01638         } <span class="keywordflow">else</span> {
01639             UserAssert(amRequest == WINSTA_WRITEATTRIBUTES);
01640             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a9">CheckWinstaWriteAttributesAccess</a>()) {
01641                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01642             }
01643         }
01644 
01645         <span class="comment">/*</span>
01646 <span class="comment">         * If we're reading, then set the write flag to ensure that</span>
01647 <span class="comment">         * the return value will be TRUE.</span>
01648 <span class="comment">         */</span>
01649         <span class="keywordflow">if</span> (amRequest == WINSTA_READATTRIBUTES)
01650             fWriteAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01651     } <span class="keywordflow">else</span> {
01652         fWriteAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01653     }
01654 
01655     <span class="comment">/*</span>
01656 <span class="comment">     * Make sure the section buffer is terminated.</span>
01657 <span class="comment">     */</span>
01658     szSection[0] = 0;
01659 
01660     <span class="keywordflow">switch</span> (wFlag) {
01661     <span class="keywordflow">case</span> SPI_GETBEEP:
01662         (*(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> *)lParam) = <a class="code" href="../../d4/d1/userk_8h.html#a658">TEST_BOOL_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a639">PUDF_BEEP</a>);
01663         <span class="keywordflow">break</span>;
01664 
01665     <span class="keywordflow">case</span> SPI_SETBEEP:
01666         <span class="keywordflow">if</span> (fAlterWinIni) {
01667             <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(
01668                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>,
01669                     (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(wParam ? STR_BEEPYES : STR_BEEPNO),
01670                     (LPWSTR)szTemp, 10);
01671 
01672             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2015">FastUpdateWinIni</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01673                     <a class="code" href="../../d4/d1/userk_8h.html#a706">PMAP_BEEP</a>,
01674                     (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>) STR_BEEP,
01675                     szTemp
01676                     );
01677 
01678             fWriteAllowed = fWinIniChanged;
01679         }
01680 
01681         <span class="keywordflow">if</span> (fWriteAllowed) {
01682             <a class="code" href="../../d4/d1/userk_8h.html#a661">SET_OR_CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a639">PUDF_BEEP</a>, wParam);
01683         }
01684 
01685         <span class="keywordflow">break</span>;
01686 
01687 
01688     <span class="keywordflow">case</span> SPI_SETMOUSESPEED:
01689         <span class="keywordflow">if</span> (((LONG_PTR) lParam &lt; MOUSE_SENSITIVITY_MIN) || ((LONG_PTR) lParam &gt; <a class="code" href="../../d4/d1/userk_8h.html#a485">MOUSE_SENSITIVITY_MAX</a>)) {
01690             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01691         }
01692 
01693         <span class="keywordflow">if</span> (fAlterWinIni) {
01694             swprintf(szTemp, pwszd, lParam) ;
01695             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2015">FastUpdateWinIni</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01696                     <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>,
01697                     STR_MOUSESENSITIVITY,
01698                     szTemp
01699                     );
01700 
01701             fWriteAllowed = fWinIniChanged;
01702         }
01703 
01704         <span class="keywordflow">if</span> (fWriteAllowed) {
01705             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a124">gMouseSensitivity</a> = PtrToLong(lParam);
01706             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a123">gMouseSensitivityFactor</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1031">CalculateMouseSensitivity</a>(PtrToLong(lParam)) ;
01707         }
01708         <span class="keywordflow">break</span>;
01709 
01710     <span class="keywordflow">case</span> SPI_GETMOUSESPEED:
01711         *((LPINT)lParam) = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a124">gMouseSensitivity</a> ;
01712         <span class="keywordflow">break</span>;
01713 
01714     <span class="keywordflow">case</span> SPI_GETMOUSE:
01715         ((LPINT)lParam)[0] = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a121">gMouseThresh1</a>;
01716         ((LPINT)lParam)[1] = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a122">gMouseThresh2</a>;
01717         ((LPINT)lParam)[2] = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a120">gMouseSpeed</a>;
01718         <span class="keywordflow">break</span>;
01719 
01720     <span class="keywordflow">case</span> SPI_SETMOUSE:
01721         <span class="keywordflow">if</span> (fAlterWinIni) {
01722             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bWritten1, bWritten2, bWritten3;
01723 
01724             pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
01725             bWritten1 = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(pProfileUserName, <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_MOUSETHRESH1, ((LPINT)lParam)[0]);
01726             bWritten2 = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(pProfileUserName, <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_MOUSETHRESH2, ((LPINT)lParam)[1]);
01727             bWritten3 = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(pProfileUserName, <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_MOUSESPEED,   ((LPINT)lParam)[2]);
01728             <span class="keywordflow">if</span> (bWritten1 &amp;&amp; bWritten2 &amp;&amp; bWritten3)
01729                 fWinIniChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01730             <span class="keywordflow">else</span> {
01731 
01732                 <span class="comment">/*</span>
01733 <span class="comment">                 * Attempt to backout any changes.</span>
01734 <span class="comment">                 */</span>
01735                 <span class="keywordflow">if</span> (bWritten1) {
01736                     <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(pProfileUserName, <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_MOUSETHRESH1, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a121">gMouseThresh1</a>);
01737                 }
01738                 <span class="keywordflow">if</span> (bWritten2) {
01739                     <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(pProfileUserName, <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_MOUSETHRESH2, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a122">gMouseThresh2</a>);
01740                 }
01741                 <span class="keywordflow">if</span> (bWritten3) {
01742                     <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(pProfileUserName, <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_MOUSESPEED,   <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a120">gMouseSpeed</a>);
01743                 }
01744             }
01745             fWriteAllowed = fWinIniChanged;
01746             <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
01747         }
01748         <span class="keywordflow">if</span> (fWriteAllowed) {
01749             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a121">gMouseThresh1</a> = ((LPINT)lParam)[0];
01750             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a122">gMouseThresh2</a> = ((LPINT)lParam)[1];
01751             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a120">gMouseSpeed</a> = ((LPINT)lParam)[2];
01752         }
01753         <span class="keywordflow">break</span>;
01754 
01755     <span class="keywordflow">case</span> SPI_GETSNAPTODEFBUTTON:
01756         (*(LPBOOL)lParam) = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a369">TEST_BOOL_PUSIF</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a365">PUSIF_SNAPTO</a>);
01757         <span class="keywordflow">break</span>;
01758 
01759     <span class="keywordflow">case</span> SPI_SETSNAPTODEFBUTTON:
01760         wParam = (wParam != 0);
01761 
01762         <span class="keywordflow">if</span> (fAlterWinIni) {
01763             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_SNAPTO, wParam);
01764             fWriteAllowed = fWinIniChanged;
01765         }
01766 
01767         <span class="keywordflow">if</span> (fWriteAllowed) {
01768             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a372">SET_OR_CLEAR_PUSIF</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a365">PUSIF_SNAPTO</a>, wParam);
01769         }
01770 
01771         <span class="keywordflow">break</span>;
01772 
01773     <span class="keywordflow">case</span> SPI_GETBORDER:
01774         (*(LPINT)lParam) = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;gclBorder;
01775         <span class="keywordflow">break</span>;
01776 
01777     <span class="keywordflow">case</span> SPI_SETBORDER:
01778         pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
01779         <span class="keywordflow">if</span> (fAlterWinIni) {
01780             fWinIniChanged = <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(pProfileUserName, STR_BORDERWIDTH, wParam);
01781             fWriteAllowed = fWinIniChanged;
01782         }
01783         <span class="keywordflow">if</span> (fWriteAllowed) {
01784             clBorderOld = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;gclBorder;
01785             clBorderNew = wParam;
01786 
01787             <span class="keywordflow">if</span> (clBorderNew &lt; 1)
01788                 clBorderNew = 1;
01789             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (clBorderNew &gt; 50)
01790                 clBorderNew = 50;
01791 
01792             <span class="keywordflow">if</span> (clBorderOld == clBorderNew) {
01793 
01794                 <span class="comment">/*</span>
01795 <span class="comment">                 * If border size doesn't change, don't waste time.</span>
01796 <span class="comment">                 */</span>
01797                 <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
01798                 <span class="keywordflow">break</span>;
01799             }
01800 
01801             <a class="code" href="../../d4/d5/rare_8c.html#a20">xxxSetAndDrawNCMetrics</a>(pProfileUserName, clBorderNew, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01802 
01803             <span class="comment">/*</span>
01804 <span class="comment">             * Nice magic number of 3.  So if the border is set to 1, there are actualy</span>
01805 <span class="comment">             * 4 pixels in the border</span>
01806 <span class="comment">             */</span>
01807 
01808             bSetDevDragWidth(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;gclBorder + <a class="code" href="../../d4/d1/userk_8h.html#a740">BORDER_EXTRA</a>);
01809         }
01810         <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
01811         <span class="keywordflow">break</span>;
01812 
01813     <span class="keywordflow">case</span> SPI_GETFONTSMOOTHING:
01814         (*(LPINT)lParam) = !!(GreGetFontEnumeration() &amp; FE_AA_ON);
01815         <span class="keywordflow">break</span>;
01816 
01817     <span class="keywordflow">case</span> SPI_SETFONTSMOOTHING:
01818         wParam = (wParam ? FE_AA_ON : 0);
01819         <span class="keywordflow">if</span> (fAlterWinIni) {
01820             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, STR_FONTSMOOTHING, wParam);
01821             fWriteAllowed = fWinIniChanged;
01822         }
01823         <span class="keywordflow">if</span> (fWriteAllowed) {
01824             GreSetFontEnumeration(wParam | FE_SET_AA);
01825         }
01826         <span class="keywordflow">break</span>;
01827 
01828     <span class="keywordflow">case</span> SPI_GETKEYBOARDSPEED:
01829         (*(<span class="keywordtype">int</span> *)lParam) = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a97">gnKeyboardSpeed</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a472">KSPEED_MASK</a>);
01830         <span class="keywordflow">break</span>;
01831 
01832     <span class="keywordflow">case</span> SPI_SETKEYBOARDSPEED:
01833         <span class="comment">/*</span>
01834 <span class="comment">         * Limit the range to max value; SetKeyboardRate takes both speed and delay</span>
01835 <span class="comment">         */</span>
01836         <span class="keywordflow">if</span> (wParam &gt; <a class="code" href="../../d4/d1/userk_8h.html#a472">KSPEED_MASK</a>)           <span class="comment">// KSPEED_MASK == KSPEED_MAX</span>
01837             wParam = <a class="code" href="../../d4/d1/userk_8h.html#a472">KSPEED_MASK</a>;
01838         <span class="keywordflow">if</span> (fAlterWinIni) {
01839             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d1/userk_8h.html#a708">PMAP_KEYBOARD</a>, STR_KEYSPEED, wParam);
01840             fWriteAllowed = fWinIniChanged;
01841         }
01842         <span class="keywordflow">if</span> (fWriteAllowed) {
01843             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a97">gnKeyboardSpeed</a> = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a97">gnKeyboardSpeed</a> &amp; ~<a class="code" href="../../d4/d1/userk_8h.html#a472">KSPEED_MASK</a>) | wParam;
01844             <a class="code" href="../../d4/d1/userk_8h.html#a1176">SetKeyboardRate</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a97">gnKeyboardSpeed</a> );
01845         }
01846         <span class="keywordflow">break</span>;
01847 
01848     <span class="keywordflow">case</span> SPI_GETKEYBOARDDELAY:
01849         (*(<span class="keywordtype">int</span> *)lParam) = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a97">gnKeyboardSpeed</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a473">KDELAY_MASK</a>) &gt;&gt; <a class="code" href="../../d4/d1/userk_8h.html#a474">KDELAY_SHIFT</a>;
01850         <span class="keywordflow">break</span>;
01851 
01852     <span class="keywordflow">case</span> SPI_SETKEYBOARDDELAY:
01853         <span class="keywordflow">if</span> (fAlterWinIni) {
01854             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d1/userk_8h.html#a708">PMAP_KEYBOARD</a>, STR_KEYDELAY, wParam);
01855             fWriteAllowed = fWinIniChanged;
01856         }
01857         <span class="keywordflow">if</span> (fWriteAllowed) {
01858             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a97">gnKeyboardSpeed</a> = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a97">gnKeyboardSpeed</a> &amp; ~<a class="code" href="../../d4/d1/userk_8h.html#a473">KDELAY_MASK</a>) | (wParam &lt;&lt; <a class="code" href="../../d4/d1/userk_8h.html#a474">KDELAY_SHIFT</a>);
01859             <a class="code" href="../../d4/d1/userk_8h.html#a1176">SetKeyboardRate</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a97">gnKeyboardSpeed</a>);
01860         }
01861         <span class="keywordflow">break</span>;
01862 
01863     <span class="keywordflow">case</span> SPI_SETLANGTOGGLE:
01864 
01865         <span class="comment">/*</span>
01866 <span class="comment">         * wParam unused, lParam unused.  Simply reread the registry setting.</span>
01867 <span class="comment">         */</span>
01868 
01869         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1305">GetKbdLangSwitch</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01870 
01871         <span class="keywordflow">break</span>;
01872 
01873     <span class="keywordflow">case</span> SPI_GETDEFAULTINPUTLANG:
01874         <span class="comment">/*</span>
01875 <span class="comment">         * wParam unused.  lParam is a pointer to buffer to store hkl.</span>
01876 <span class="comment">         */</span>
01877         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01878         (*(HKL *)lParam) = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
01879         <span class="keywordflow">break</span>;
01880 
01881     <span class="keywordflow">case</span> SPI_SETDEFAULTINPUTLANG: {
01882         <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl;
01883         <span class="comment">/*</span>
01884 <span class="comment">         * wParam unused.  lParam is new language of hkl (depending on whether the</span>
01885 <span class="comment">         * hiword is set.</span>
01886 <span class="comment">         */</span>
01887         pkl = <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), *(HKL *)lParam);
01888         <span class="keywordflow">if</span> (pkl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01889             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01890         }
01891         <span class="keywordflow">if</span> (fWriteAllowed) {
01892             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a>, pkl);
01893         }
01894         <span class="keywordflow">break</span>;
01895     }
01896 
01897     <span class="keywordflow">case</span> SPI_ICONHORIZONTALSPACING:
01898         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(lParam)) {
01899             *(LPINT)lParam = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXICONSPACING);
01900         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam) {
01901 
01902             <span class="comment">/*</span>
01903 <span class="comment">             * Make sure icon spacing is reasonable.</span>
01904 <span class="comment">             */</span>
01905             wParam = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(wParam, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXICON));
01906 
01907             <span class="keywordflow">if</span> (fAlterWinIni) {
01908                 fWinIniChanged = <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, STR_ICONHORZSPACING, wParam );
01909                 fWriteAllowed = fWinIniChanged;
01910             }
01911             <span class="keywordflow">if</span> (fWriteAllowed) {
01912                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXICONSPACING) = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam;
01913             }
01914         }
01915         <span class="keywordflow">break</span>;
01916 
01917     <span class="keywordflow">case</span> SPI_ICONVERTICALSPACING:
01918         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(lParam)) {
01919             *(LPINT)lParam = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYICONSPACING);
01920         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam) {
01921             wParam = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(wParam, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYICON));
01922 
01923             <span class="keywordflow">if</span> (fAlterWinIni) {
01924                 fWinIniChanged = <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, STR_ICONVERTSPACING, wParam);
01925                 fWriteAllowed = fWinIniChanged;
01926             }
01927             <span class="keywordflow">if</span> (fWriteAllowed) {
01928                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYICONSPACING) = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam;
01929             }
01930         }
01931         <span class="keywordflow">break</span>;
01932 
01933     <span class="keywordflow">case</span> SPI_GETSCREENSAVETIMEOUT:
01934         piTimeOut = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a98">giScreenSaveTimeOutMs</a>;
01935         <span class="keywordflow">goto</span> HandleGetTimeouts;
01936 
01937     <span class="keywordflow">case</span> SPI_GETLOWPOWERTIMEOUT:
01938         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(DrvGetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, PowerDeviceD1))) {
01939             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01940         }
01941         piTimeOut = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a301">giLowPowerTimeOutMs</a>;
01942         <span class="keywordflow">goto</span> HandleGetTimeouts;
01943 
01944     <span class="keywordflow">case</span> SPI_GETPOWEROFFTIMEOUT:
01945         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(DrvGetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, PowerDeviceD3))) {
01946             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01947         }
01948         piTimeOut = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a302">giPowerOffTimeOutMs</a>;
01949 
01950 HandleGetTimeouts:
01951         <span class="comment">/*</span>
01952 <span class="comment">         * If the screen saver is disabled, I store this fact as a negative</span>
01953 <span class="comment">         * time out value.  So, we give the Control Panel the absolute value</span>
01954 <span class="comment">         * of the screen save time out. We store this in milliseconds.</span>
01955 <span class="comment">         */</span>
01956         <span class="keywordflow">if</span> (*piTimeOut &lt; 0)
01957             (*(<span class="keywordtype">int</span> *)lParam) = -*piTimeOut / 1000;
01958         <span class="keywordflow">else</span>
01959             (*(<span class="keywordtype">int</span> *)lParam) = *piTimeOut / 1000;
01960         <span class="keywordflow">break</span>;
01961 
01962     <span class="keywordflow">case</span> SPI_SETSCREENSAVETIMEOUT:
01963         piTimeOut = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a98">giScreenSaveTimeOutMs</a>;
01964         iResID = STR_SCREENSAVETIMEOUT;
01965         <span class="keywordflow">goto</span> HandleSetTimeouts;
01966 
01967     <span class="keywordflow">case</span> SPI_SETLOWPOWERTIMEOUT:
01968         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(DrvGetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, PowerDeviceD1))) {
01969             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01970         }
01971         piTimeOut = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a301">giLowPowerTimeOutMs</a>;
01972         iResID = STR_LOWPOWERTIMEOUT;
01973         <span class="keywordflow">goto</span> HandleSetTimeouts;
01974 
01975     <span class="keywordflow">case</span> SPI_SETPOWEROFFTIMEOUT:
01976         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(DrvGetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, PowerDeviceD3))) {
01977             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01978         }
01979         piTimeOut = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a302">giPowerOffTimeOutMs</a>;
01980         iResID = STR_POWEROFFTIMEOUT;
01981 
01982 HandleSetTimeouts:
01983         <span class="comment">/*</span>
01984 <span class="comment">         * Maintain the screen save active/inactive state when setting the</span>
01985 <span class="comment">         * time out value.  Timeout value is given in seconds but stored</span>
01986 <span class="comment">         * in milliseconds</span>
01987 <span class="comment">         */</span>
01988         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2003">CheckDesktopPolicy</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (PCWSTR)iResID)) {
01989             fAlterWinIni = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01990             fWriteAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01991         }
01992         <span class="keywordflow">if</span> (fAlterWinIni) {
01993             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, iResID, wParam);
01994             fWriteAllowed = fWinIniChanged;
01995         }
01996         <span class="keywordflow">if</span> (fWriteAllowed) {
01997             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a380">LINP_POWERTIMEOUTS</a>) {
01998                 <span class="comment">// Call video driver here to exit power down mode.</span>
01999                 KdPrint((<span class="stringliteral">"Exit video power down mode\n"</span>));
02000                 DrvSetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, PowerDeviceD0);
02001             }
02002             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a381">LINP_INPUTTIMEOUTS</a>;
02003             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o0">timeLastInputMessage</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
02004             <span class="keywordflow">if</span> (*piTimeOut &lt; 0) {
02005                 *piTimeOut = -((<span class="keywordtype">int</span>)wParam);
02006             } <span class="keywordflow">else</span> {
02007                 *piTimeOut = wParam;
02008             }
02009             *piTimeOut *= 1000;
02010         }
02011         <span class="keywordflow">break</span>;
02012 
02013     <span class="keywordflow">case</span> SPI_GETSCREENSAVEACTIVE:
02014         (*(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> *)lParam) = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a98">giScreenSaveTimeOutMs</a> &gt; 0);
02015         <span class="keywordflow">break</span>;
02016 
02017     <span class="keywordflow">case</span> SPI_GETLOWPOWERACTIVE:
02018         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(DrvGetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, PowerDeviceD1))) {
02019             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02020         }
02021         (*(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> *)lParam) = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a301">giLowPowerTimeOutMs</a> &gt; 0);
02022         <span class="keywordflow">break</span>;
02023 
02024     <span class="keywordflow">case</span> SPI_GETPOWEROFFACTIVE:
02025         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(DrvGetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, PowerDeviceD3))) {
02026             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02027         }
02028         (*(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> *)lParam) = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a302">giPowerOffTimeOutMs</a> &gt; 0);
02029         <span class="keywordflow">break</span>;
02030 
02031     <span class="keywordflow">case</span> SPI_SETSCREENSAVEACTIVE:
02032         piTimeOut = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a98">giScreenSaveTimeOutMs</a>;
02033         iResID = STR_SCREENSAVEACTIVE;
02034         <span class="keywordflow">goto</span> HandleSetActive;
02035 
02036     <span class="keywordflow">case</span> SPI_SETLOWPOWERACTIVE:
02037         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(DrvGetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, PowerDeviceD1))) {
02038             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02039         }
02040         piTimeOut = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a301">giLowPowerTimeOutMs</a>;
02041         iResID = STR_LOWPOWERACTIVE;
02042         <span class="keywordflow">goto</span> HandleSetActive;
02043 
02044     <span class="keywordflow">case</span> SPI_SETPOWEROFFACTIVE:
02045         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(DrvGetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, PowerDeviceD3))) {
02046             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02047         }
02048         piTimeOut = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a302">giPowerOffTimeOutMs</a>;
02049         iResID = STR_POWEROFFACTIVE;
02050 
02051 HandleSetActive:
02052         wParam = (wParam != 0);
02053 
02054         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2003">CheckDesktopPolicy</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (PCWSTR)iResID)) {
02055             fAlterWinIni = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02056             fWriteAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02057         }
02058         <span class="keywordflow">if</span> (fAlterWinIni) {
02059             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, iResID, wParam);
02060             fWriteAllowed = fWinIniChanged;
02061         }
02062         <span class="keywordflow">if</span> (fWriteAllowed) {
02063             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a380">LINP_POWERTIMEOUTS</a>) {
02064                 <span class="comment">// Call video driver here to exit power down mode.</span>
02065                 KdPrint((<span class="stringliteral">"Exit video power down mode\n"</span>));
02066                 DrvSetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, PowerDeviceD0);
02067             }
02068             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a381">LINP_INPUTTIMEOUTS</a>;
02069             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o0">timeLastInputMessage</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
02070             <span class="keywordflow">if</span> ((*piTimeOut &lt; 0 &amp;&amp; wParam) ||
02071                 (*piTimeOut &gt;= 0 &amp;&amp; !wParam)) {
02072                 *piTimeOut = -*piTimeOut;
02073             }
02074         }
02075         <span class="keywordflow">break</span>;
02076 
02077 
02078     <span class="keywordflow">case</span> SPI_SETDESKWALLPAPER:
02079         pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
02080         <span class="keywordflow">if</span> (fAlterWinIni) {
02081 
02082             <span class="keywordflow">if</span> (wParam != (WPARAM)-1) {
02083 
02084                 <span class="comment">/*</span>
02085 <span class="comment">                 * Save current wallpaper in case of failure.</span>
02086 <span class="comment">                 */</span>
02087                 <a class="code" href="../../d4/d1/userk_8h.html#a2011">FastGetProfileStringFromIDW</a>(pProfileUserName,
02088                        <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,
02089                        STR_DTBITMAP,
02090                        TEXT(<span class="stringliteral">""</span>),
02091                        szPat,
02092                        <span class="keyword">sizeof</span>(szPat) / <span class="keyword">sizeof</span>(WCHAR)
02093                        );
02094 
02095                 fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2015">FastUpdateWinIni</a>(pProfileUserName,
02096                        <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,
02097                        STR_DTBITMAP,
02098                        (LPWSTR)lParam
02099                        );
02100 
02101                 fWriteAllowed = fWinIniChanged;
02102 
02103             } <span class="keywordflow">else</span> {
02104                 fWriteAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02105             }
02106         }
02107 
02108         <span class="keywordflow">if</span> (fWriteAllowed) {
02109 
02110             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1186">xxxSetDeskWallpaper</a>(pProfileUserName,(LPWSTR)lParam)) {
02111 
02112                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) {
02113 
02114                     <a class="code" href="../../d4/d1/userk_8h.html#a1681">xxxInternalInvalidate</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>,
02115                                           <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>,
02116                                           RDW_INVALIDATE |
02117                                               RDW_ERASE |
02118                                               RDW_FRAME |
02119                                               RDW_ALLCHILDREN);
02120                 }
02121 
02122             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fAlterWinIni &amp;&amp; (wParam != 0xFFFFFFFF)) {
02123 
02124                 <span class="comment">/*</span>
02125 <span class="comment">                 * Backout any change to win.ini.</span>
02126 <span class="comment">                 */</span>
02127                 <a class="code" href="../../d4/d1/userk_8h.html#a2015">FastUpdateWinIni</a>(pProfileUserName,<a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, STR_DTBITMAP, szPat);
02128                 fWinIniChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02129                 fWriteAllowed = fWinIniChanged;
02130             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fAlterWinIni) {
02131                 <span class="comment">/*</span>
02132 <span class="comment">                 * Bug 304109 - joejo</span>
02133 <span class="comment">                 * Make sure we return a 0 retval if we didn't do anything!</span>
02134 <span class="comment">                 */</span>
02135                 fWinIniChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02136                 fWriteAllowed = fWinIniChanged;
02137             }
02138         }
02139         <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
02140         <span class="keywordflow">break</span>;
02141 
02142     <span class="comment">/*</span>
02143 <span class="comment">     * Bug 257718 - joejo</span>
02144 <span class="comment">     * Add SPI_GETDESKWALLPAPER to SystemParametersInfo</span>
02145 <span class="comment">     */</span>
02146     <span class="keywordflow">case</span> SPI_GETDESKWALLPAPER:
02147         <span class="comment">/*</span>
02148 <span class="comment">         * Bug 283318 - jojeo</span>
02149 <span class="comment">         *</span>
02150 <span class="comment">         * Get the string from the gobal var, not the registry,</span>
02151 <span class="comment">         * as it's more current.</span>
02152 <span class="comment">         */</span>
02153         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a6">gpszWall</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02154             <span class="comment">/*</span>
02155 <span class="comment">             * Copy the global wallpaper name ONLY if nun null</span>
02156 <span class="comment">             */</span>
02157             wcscpy(lParam, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a6">gpszWall</a>);
02158         } <span class="keywordflow">else</span> {
02159             <span class="comment">/*</span>
02160 <span class="comment">             * Null out the string so no garbage can corrupt the user's</span>
02161 <span class="comment">             * buffer.</span>
02162 <span class="comment">             */</span>
02163             (*(LPWSTR)lParam) = (WCHAR)0;
02164         }
02165         <span class="keywordflow">break</span>;
02166 
02167     <span class="keywordflow">case</span> SPI_SETDESKPATTERN: {
02168             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
02169 
02170             <span class="keywordflow">if</span> (wParam == -1 &amp;&amp; lParam != 0)
02171                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02172 
02173             pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
02174             <span class="keywordflow">if</span> (fAlterWinIni &amp;&amp; wParam != -1) {
02175 
02176                 <span class="comment">/*</span>
02177 <span class="comment">                 * Save the current pattern in case of failure.</span>
02178 <span class="comment">                 */</span>
02179                 <a class="code" href="../../d4/d1/userk_8h.html#a2011">FastGetProfileStringFromIDW</a>(pProfileUserName,
02180                         <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,
02181                         STR_DESKPATTERN,
02182                         TEXT(<span class="stringliteral">""</span>),
02183                         szPat,
02184                         <span class="keyword">sizeof</span>(szPat) / <span class="keyword">sizeof</span>(WCHAR)
02185                         );
02186 
02187                 fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2015">FastUpdateWinIni</a>(pProfileUserName,
02188                         <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,
02189                         STR_DESKPATTERN,
02190                         (LPWSTR)lParam
02191                         );
02192 
02193                 fWriteAllowed = fWinIniChanged;
02194             }
02195 
02196             <span class="keywordflow">if</span> (fWriteAllowed) {
02197 
02198                 fRet = <a class="code" href="../../d4/d1/userk_8h.html#a1185">xxxSetDeskPattern</a>(pProfileUserName,
02199                         wParam == -1 ? (LPWSTR)-1 : (LPWSTR)lParam,
02200                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02201 
02202                 <span class="keywordflow">if</span> (!fRet) {
02203 
02204                     <span class="comment">/*</span>
02205 <span class="comment">                     * Back out any change to win.ini</span>
02206 <span class="comment">                     */</span>
02207                     <span class="keywordflow">if</span> (fAlterWinIni &amp;&amp; wParam != -1) {
02208 
02209                         <a class="code" href="../../d4/d1/userk_8h.html#a2015">FastUpdateWinIni</a>(pProfileUserName,
02210                                 <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,
02211                                 STR_DESKPATTERN,
02212                                 szPat
02213                                 );
02214                     }
02215 
02216                     <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
02217                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02218                 }
02219             }
02220         }
02221         <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
02222         <span class="keywordflow">break</span>;
02223 
02224     <span class="keywordflow">case</span> SPI_GETICONTITLEWRAP:
02225         *((<span class="keywordtype">int</span> *)lParam) = <a class="code" href="../../d4/d1/userk_8h.html#a658">TEST_BOOL_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a642">PUDF_ICONTITLEWRAP</a>);
02226         <span class="keywordflow">break</span>;
02227 
02228     <span class="keywordflow">case</span> SPI_SETICONTITLEWRAP:
02229         wParam = (wParam != 0);
02230         <span class="keywordflow">if</span> (fAlterWinIni) {
02231             fWinIniChanged = <a class="code" href="../../d4/d5/rare_8c.html#a18">SetWindowMetricInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, STR_ICONTITLEWRAP, wParam);
02232             fWriteAllowed = fWinIniChanged;
02233         }
02234         <span class="keywordflow">if</span> (fWriteAllowed) {
02235             <a class="code" href="../../d4/d1/userk_8h.html#a661">SET_OR_CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a642">PUDF_ICONTITLEWRAP</a>, wParam);
02236             <a class="code" href="../../d4/d1/userk_8h.html#a1536">xxxMetricsRecalc</a>(<a class="code" href="../../d4/d5/rare_8c.html#a1">CALC_FRAME</a>, 0, 0, 0, 0);
02237         }
02238         <span class="keywordflow">break</span>;
02239 
02240     <span class="keywordflow">case</span> SPI_SETDRAGWIDTH:
02241         <span class="keywordflow">if</span> (fAlterWinIni) {
02242             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, STR_DRAGWIDTH, wParam);
02243             fWriteAllowed = fWinIniChanged;
02244         }
02245         <span class="keywordflow">if</span> (fWriteAllowed) {
02246             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXDRAG) = wParam;
02247         }
02248         <span class="keywordflow">break</span>;
02249 
02250     <span class="keywordflow">case</span> SPI_SETDRAGHEIGHT:
02251         <span class="keywordflow">if</span> (fAlterWinIni) {
02252             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, STR_DRAGHEIGHT, wParam);
02253             fWriteAllowed = fWinIniChanged;
02254         }
02255         <span class="keywordflow">if</span> (fWriteAllowed) {
02256             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYDRAG) = wParam;
02257         }
02258         <span class="keywordflow">break</span>;
02259 
02260     <span class="keywordflow">case</span> SPI_GETMENUDROPALIGNMENT:
02261         (*(<span class="keywordtype">int</span> *)lParam) = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(MENUDROPALIGNMENT));
02262         <span class="keywordflow">break</span>;
02263 
02264     <span class="keywordflow">case</span> SPI_SETMENUDROPALIGNMENT:
02265         <span class="keywordflow">if</span> (fAlterWinIni) {
02266             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a697">PMAP_WINDOWSU</a>, STR_MENUDROPALIGNMENT, wParam);
02267             fWriteAllowed = fWinIniChanged;
02268         }
02269         <span class="keywordflow">if</span> (fWriteAllowed) {
02270             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(MENUDROPALIGNMENT) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(wParam != 0);
02271         }
02272         <span class="keywordflow">break</span>;
02273 
02274     <span class="keywordflow">case</span> SPI_SETDOUBLECLKWIDTH:
02275         <span class="keywordflow">if</span> (fAlterWinIni) {
02276             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_DOUBLECLICKWIDTH, wParam);
02277             fWriteAllowed = fWinIniChanged;
02278         }
02279         <span class="keywordflow">if</span> (fWriteAllowed) {
02280             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXDOUBLECLK) = wParam;
02281         }
02282         <span class="keywordflow">break</span>;
02283 
02284     <span class="keywordflow">case</span> SPI_SETDOUBLECLKHEIGHT:
02285         <span class="keywordflow">if</span> (fAlterWinIni) {
02286             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_DOUBLECLICKHEIGHT, wParam);
02287             fWriteAllowed = fWinIniChanged;
02288         }
02289         <span class="keywordflow">if</span> (fWriteAllowed) {
02290             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYDOUBLECLK) = wParam;
02291         }
02292         <span class="keywordflow">break</span>;
02293 
02294     <span class="keywordflow">case</span> SPI_GETICONTITLELOGFONT:
02295         GreExtGetObjectW(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a148">ghIconFont</a>, <span class="keyword">sizeof</span>(LOGFONTW), lParam);
02296         <span class="keywordflow">break</span>;
02297 
02298     <span class="keywordflow">case</span> SPI_SETICONTITLELOGFONT:
02299     {
02300         <span class="keywordflow">if</span> (lParam != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02301             <span class="keywordflow">if</span> (wParam != <span class="keyword">sizeof</span>(LOGFONTW))
02302                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02303         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam) {
02304             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02305         }
02306 
02307         pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
02308         fWinIniChanged = <a class="code" href="../../d4/d5/rare_8c.html#a26">xxxSetSPIMetrics</a>(pProfileUserName, wFlag, lParam, fAlterWinIni);
02309         <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
02310         <span class="keywordflow">if</span> (fAlterWinIni) {
02311             fWriteAllowed = fWinIniChanged;
02312         }
02313         <span class="keywordflow">break</span>;
02314     }
02315 
02316     <span class="keywordflow">case</span> SPI_SETDOUBLECLICKTIME:
02317         <span class="keywordflow">if</span> (fAlterWinIni) {
02318             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_DBLCLKSPEED, wParam);
02319             fWriteAllowed = fWinIniChanged;
02320         }
02321         <span class="keywordflow">if</span> (fWriteAllowed) {
02322             <a class="code" href="../../d4/d1/userk_8h.html#a1883">_SetDoubleClickTime</a>((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam);
02323         }
02324         <span class="keywordflow">break</span>;
02325 
02326     <span class="keywordflow">case</span> SPI_GETANIMATION: {
02327         LPANIMATIONINFO lpai = (LPANIMATIONINFO) lParam;
02328 
02329         <span class="keywordflow">if</span> (lpai == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || (wParam != <span class="keyword">sizeof</span>(ANIMATIONINFO)))
02330             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02331 
02332         lpai-&gt;cbSize        = <span class="keyword">sizeof</span>(ANIMATIONINFO);
02333         lpai-&gt;iMinAnimate   = <a class="code" href="../../d4/d1/userk_8h.html#a658">TEST_BOOL_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a636">PUDF_ANIMATE</a>);
02334 
02335         <span class="keywordflow">break</span>;
02336     }
02337 
02338     <span class="keywordflow">case</span> SPI_GETNONCLIENTMETRICS: {
02339         LPNONCLIENTMETRICS lpnc = (LPNONCLIENTMETRICS) lParam;
02340         <span class="keywordflow">if</span> (lpnc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02341             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02342 
02343         <a class="code" href="../../d4/d1/userk_8h.html#a1854">GetWindowNCMetrics</a>(lpnc);
02344         <span class="keywordflow">break</span>;
02345     }
02346 
02347     <span class="keywordflow">case</span> SPI_GETMINIMIZEDMETRICS: {
02348         LPMINIMIZEDMETRICS lpmin = (LPMINIMIZEDMETRICS)lParam;
02349 
02350         lpmin-&gt;cbSize        = <span class="keyword">sizeof</span>(MINIMIZEDMETRICS);
02351 
02352             lpmin-&gt;iWidth    = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINIMIZED) - 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFIXEDFRAME);
02353             lpmin-&gt;iHorzGap  = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINSPACING) - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINIMIZED);
02354             lpmin-&gt;iVertGap  = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINSPACING) - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINIMIZED);
02355             lpmin-&gt;iArrange  = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(ARRANGE);
02356 
02357         <span class="keywordflow">break</span>;
02358     }
02359 
02360     <span class="keywordflow">case</span> SPI_GETICONMETRICS: {
02361         LPICONMETRICS lpicon = (LPICONMETRICS)lParam;
02362 
02363         lpicon-&gt;cbSize          = <span class="keyword">sizeof</span>(ICONMETRICS);
02364 
02365         lpicon-&gt;iHorzSpacing    = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXICONSPACING);
02366         lpicon-&gt;iVertSpacing    = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYICONSPACING);
02367         lpicon-&gt;iTitleWrap      = <a class="code" href="../../d4/d1/userk_8h.html#a658">TEST_BOOL_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a642">PUDF_ICONTITLEWRAP</a>);
02368         GreExtGetObjectW(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a148">ghIconFont</a>, <span class="keyword">sizeof</span>(LOGFONTW), &amp;(lpicon-&gt;lfFont));
02369 
02370         <span class="keywordflow">break</span>;
02371     }
02372 
02373     <span class="keywordflow">case</span> SPI_SETANIMATION:
02374     <span class="keywordflow">case</span> SPI_SETNONCLIENTMETRICS:
02375     <span class="keywordflow">case</span> SPI_SETICONMETRICS:
02376     <span class="keywordflow">case</span> SPI_SETMINIMIZEDMETRICS:
02377     {
02378         fWinIniChanged = <a class="code" href="../../d4/d5/rare_8c.html#a26">xxxSetSPIMetrics</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, wFlag, lParam, fAlterWinIni);
02379         <span class="keywordflow">if</span> (fAlterWinIni) {
02380             fWriteAllowed = fWinIniChanged;
02381         }
02382         <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_METRICS, szSection, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(szSection));
02383         <span class="keywordflow">break</span>;
02384     }
02385     <span class="keywordflow">case</span> SPI_SETMOUSEBUTTONSWAP:
02386         <span class="keywordflow">if</span> (fAlterWinIni) {
02387             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_SWAPBUTTONS, wParam);
02388             fWriteAllowed = fWinIniChanged;
02389         }
02390         <span class="keywordflow">if</span> (fWriteAllowed) {
02391             <a class="code" href="../../d4/d1/userk_8h.html#a1884">_SwapMouseButton</a>((wParam != 0));
02392         }
02393         <span class="keywordflow">break</span>;
02394 
02395     <span class="keywordflow">case</span> SPI_GETFASTTASKSWITCH:
02396         *((<a class="code" href="../../d9/d5/ndismain_8h.html#a264">PINT</a>)lParam) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    <span class="comment">// do the work so we don't screw anybody</span>
02397 
02398     <span class="keywordflow">case</span> SPI_SETFASTTASKSWITCH:
02399         RIPMSG0(RIP_WARNING,<span class="stringliteral">"SPI_SETFASTTASKSWITCH and SPI_GETFASTTASKSWITCH are obsolete actions."</span>);
02400         <span class="keywordflow">break</span>;
02401 
02402     <span class="keywordflow">case</span> SPI_GETWORKAREA:
02403         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>((LPRECT)lParam, &amp;<a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>()-&gt;rcWork);
02404         <span class="keywordflow">break</span>;
02405 
02406     <span class="keywordflow">case</span> SPI_SETWORKAREA:
02407     {
02408         RECT        rcNewWork;
02409         LPRECT      lprcNewWork;
02410         <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitorWork;
02411 
02412         lprcNewWork = (LPRECT)lParam;
02413 
02414         <span class="comment">/*</span>
02415 <span class="comment">         * Validate Rectangle</span>
02416 <span class="comment">         */</span>
02417         <span class="keywordflow">if</span> ((lprcNewWork != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02418             ((lprcNewWork-&gt;right &lt; lprcNewWork-&gt;left) ||
02419              (lprcNewWork-&gt;bottom &lt; lprcNewWork-&gt;top))) {
02420 
02421             RIPMSG0(RIP_WARNING, <span class="stringliteral">"Bad work rectangle passed to SystemParametersInfo(SPI_SETWORKAREA, ...)\n"</span>);
02422             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02423         }
02424 
02425         <span class="comment">/*</span>
02426 <span class="comment">         * Figure out which monitor has the working area.</span>
02427 <span class="comment">         */</span>
02428         <span class="keywordflow">if</span> (!lprcNewWork) {
02429             pMonitorWork = <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
02430             lprcNewWork = &amp;pMonitorWork-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>;
02431         } <span class="keywordflow">else</span> {
02432             pMonitorWork = <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(lprcNewWork, MONITOR_DEFAULTTOPRIMARY);
02433         }
02434 
02435         <span class="comment">/*</span>
02436 <span class="comment">         * Get new working area, clipped to monitor of course.</span>
02437 <span class="comment">         */</span>
02438         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcNewWork, lprcNewWork, &amp;pMonitorWork-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>) ||
02439             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a34">EqualRect</a>(&amp;rcNewWork, lprcNewWork))
02440         {
02441             <span class="comment">/*</span>
02442 <span class="comment">             * Complain.</span>
02443 <span class="comment">             */</span>
02444             RIPERR4(
02445                     ERROR_INVALID_PARAMETER,
02446                     RIP_WARNING,
02447                     <span class="stringliteral">"Bad work rectangle passed to SystemParametersInfo(SPI_SETWORKAREA, ...) %d, %d, %d, %d"</span>,
02448                     lprcNewWork-&gt;left, lprcNewWork-&gt;top, lprcNewWork-&gt;right, lprcNewWork-&gt;bottom);
02449             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02450         }
02451 
02452         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a34">EqualRect</a>(&amp;pMonitorWork-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>, &amp;rcNewWork))
02453         {
02454             <a class="code" href="../../d3/d2/structtagMONITORRECTS.html">PMONITORRECTS</a>   pmr;
02455 
02456             <span class="comment">/*</span>
02457 <span class="comment">             * If we are going to reposition windows, remember the old</span>
02458 <span class="comment">             * monitor positions for xxxDesktopRecalc.</span>
02459 <span class="comment">             */</span>
02460             <span class="keywordflow">if</span> (wParam) {
02461                 pmr = <a class="code" href="../../d4/d5/rare_8c.html#a9">SnapshotMonitorRects</a>();
02462                 <span class="keywordflow">if</span> (!pmr) {
02463                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02464                 }
02465             }
02466 
02467             pMonitorWork-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a> = rcNewWork;
02468             <span class="keywordflow">if</span> (pMonitorWork == <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>()) {
02469                 <a class="code" href="../../d4/d5/rare_8c.html#a14">SetDesktopMetrics</a>();
02470             }
02471 
02472             <span class="comment">/*</span>
02473 <span class="comment">             * Reposition windows</span>
02474 <span class="comment">             */</span>
02475 
02476             <span class="keywordflow">if</span> (wParam) {
02477 
02478                 <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlPool;
02479 
02480                 <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), pmr, &amp;tlPool);
02481                 <a class="code" href="../../d4/d1/userk_8h.html#a1882">xxxDesktopRecalc</a>(pmr);
02482                 <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), &amp;tlPool);
02483             }
02484 
02485             fWinIniChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02486         }
02487 
02488         fWriteAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02489         <span class="keywordflow">break</span>;
02490     }
02491 
02492     <span class="keywordflow">case</span> SPI_SETDRAGFULLWINDOWS:
02493         wParam = (wParam == 1);
02494         <span class="keywordflow">if</span> (fAlterWinIni) {
02495             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, STR_DRAGFULLWINDOWS, wParam);
02496             fWriteAllowed = fWinIniChanged;
02497         }
02498         <span class="keywordflow">if</span> (fWriteAllowed) {
02499             <a class="code" href="../../d4/d1/userk_8h.html#a661">SET_OR_CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a641">PUDF_DRAGFULLWINDOWS</a>, wParam);
02500         }
02501         <span class="keywordflow">break</span>;
02502 
02503     <span class="keywordflow">case</span> SPI_GETDRAGFULLWINDOWS:
02504         *((<a class="code" href="../../d9/d5/ndismain_8h.html#a264">PINT</a>)lParam) = <a class="code" href="../../d4/d1/userk_8h.html#a658">TEST_BOOL_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a641">PUDF_DRAGFULLWINDOWS</a>);
02505         <span class="keywordflow">break</span>;
02506 
02507     <span class="keywordflow">case</span> SPI_GETFILTERKEYS:
02508         {
02509             LPFILTERKEYS pFK = (LPFILTERKEYS)lParam;
02510             <span class="keywordtype">int</span> cbSkip = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.cbSize);
02511 
02512             <span class="keywordflow">if</span> ((wParam != 0) &amp;&amp; (wParam != <span class="keyword">sizeof</span>(FILTERKEYS))) {
02513                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02514             }
02515             <span class="keywordflow">if</span> (!pFK || (pFK-&gt;cbSize != <span class="keyword">sizeof</span>(FILTERKEYS))) {
02516                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02517             }
02518             <span class="comment">/*</span>
02519 <span class="comment">             * In the future we may support multiple sizes of this data structure.  Don't</span>
02520 <span class="comment">             * change the cbSize field of the data structure passed in.</span>
02521 <span class="comment">             */</span>
02522             RtlCopyMemory((<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)((LPBYTE)pFK + cbSkip),
02523                           (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)((LPBYTE)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a> + cbSkip),
02524                           pFK-&gt;cbSize - cbSkip);
02525         }
02526         <span class="keywordflow">break</span>;
02527 
02528     <span class="keywordflow">case</span> SPI_SETFILTERKEYS:
02529         {
02530             LPFILTERKEYS pFK = (LPFILTERKEYS)lParam;
02531 
02532             <span class="keywordflow">if</span> ((wParam != 0) &amp;&amp; (wParam != <span class="keyword">sizeof</span>(FILTERKEYS))) {
02533                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02534             }
02535             <span class="keywordflow">if</span> (!pFK || (pFK-&gt;cbSize != <span class="keyword">sizeof</span>(FILTERKEYS)))
02536                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02537 
02538             <span class="comment">/*</span>
02539 <span class="comment">             * SlowKeys and BounceKeys cannot both be active simultaneously</span>
02540 <span class="comment">             */</span>
02541             <span class="keywordflow">if</span> (pFK-&gt;iWaitMSec &amp;&amp; pFK-&gt;iBounceMSec) {
02542                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02543             }
02544 
02545             <span class="comment">/*</span>
02546 <span class="comment">             * Do some parameter validation.  We will fail on unsupported and</span>
02547 <span class="comment">             * undefined bits being set.</span>
02548 <span class="comment">             */</span>
02549             <span class="keywordflow">if</span> ((pFK-&gt;dwFlags &amp; FKF_VALID) != pFK-&gt;dwFlags) {
02550                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02551             }
02552             <span class="comment">/*</span>
02553 <span class="comment">             * FKF_AVAILABLE can't be set via API.  Use registry value.</span>
02554 <span class="comment">             */</span>
02555             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_AVAILABLE)) {
02556                 pFK-&gt;dwFlags |= FKF_AVAILABLE;
02557             } <span class="keywordflow">else</span> {
02558                 pFK-&gt;dwFlags &amp;= ~FKF_AVAILABLE;
02559             }
02560             <span class="keywordflow">if</span> ((pFK-&gt;iWaitMSec &gt; 2000) ||
02561                 (pFK-&gt;iDelayMSec &gt; 2000) ||
02562                 (pFK-&gt;iRepeatMSec &gt; 2000) ||
02563                 (pFK-&gt;iBounceMSec &gt; 2000)) {
02564                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02565             }
02566 
02567             <span class="keywordflow">if</span> (fAlterWinIni) {
02568                 pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
02569                 fWinIniChanged = <a class="code" href="../../d4/d5/rare_8c.html#a27">SetFilterKeys</a>(pProfileUserName, pFK);
02570                 fWriteAllowed = fWinIniChanged;
02571                 <span class="keywordflow">if</span> (!fWinIniChanged) {
02572 
02573                     <span class="comment">/*</span>
02574 <span class="comment">                     * Back out any changes to win.ini</span>
02575 <span class="comment">                     */</span>
02576                     <a class="code" href="../../d4/d5/rare_8c.html#a27">SetFilterKeys</a>(pProfileUserName, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>);
02577                 }
02578                 <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
02579             }
02580             <span class="keywordflow">if</span> (fWriteAllowed) {
02581                 RtlCopyMemory(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>, pFK, pFK-&gt;cbSize);
02582 
02583                 <span class="comment">/*</span>
02584 <span class="comment">                 * Don't allow user to change cbSize field</span>
02585 <span class="comment">                 */</span>
02586                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.cbSize = <span class="keyword">sizeof</span>(FILTERKEYS);
02587 
02588                 <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_FILTERKEYSON)) {
02589                     <a class="code" href="../../d9/d3/access_8h.html#a50">StopFilterKeysTimers</a>();
02590                 }
02591                 <a class="code" href="../../d9/d3/access_8h.html#a49">SetAccessEnabledFlag</a>();
02592                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a593">FCallHookTray</a>())
02593                     <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_ACCESSIBILITYSTATE,
02594                                 ACCESS_FILTERKEYS,
02595                                 (LONG)0,
02596                                 WH_SHELL);
02597                 <a class="code" href="../../d4/d1/userk_8h.html#a1867">PostShellHookMessages</a>(HSHELL_ACCESSIBILITYSTATE, ACCESS_FILTERKEYS);
02598             }
02599         }
02600         <span class="keywordflow">break</span>;
02601 
02602     <span class="keywordflow">case</span> SPI_GETSTICKYKEYS:
02603         {
02604             LPSTICKYKEYS pSK = (LPSTICKYKEYS)lParam;
02605             <span class="keywordtype">int</span> cbSkip = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a33">gStickyKeys</a>.cbSize);
02606 
02607             <span class="keywordflow">if</span> ((wParam != 0) &amp;&amp; (wParam != <span class="keyword">sizeof</span>(STICKYKEYS))) {
02608                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02609             }
02610             <span class="keywordflow">if</span> (!pSK || (pSK-&gt;cbSize != <span class="keyword">sizeof</span>(STICKYKEYS))) {
02611                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02612             }
02613             <span class="comment">/*</span>
02614 <span class="comment">             * In the future we may support multiple sizes of this data structure.  Don't</span>
02615 <span class="comment">             * change the cbSize field of the data structure passed in.</span>
02616 <span class="comment">             */</span>
02617             RtlCopyMemory((<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)((LPBYTE)pSK + cbSkip),
02618                           (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)((LPBYTE)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a33">gStickyKeys</a> + cbSkip),
02619                           pSK-&gt;cbSize - cbSkip);
02620 
02621             pSK-&gt;dwFlags &amp;= ~SKF_STATEINFO;
02622             pSK-&gt;dwFlags |= (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a>&amp;0xff) &lt;&lt;24;
02623 
02624 <span class="preprocessor">#if SKF_LALTLATCHED != 0x10000000</span>
02625 <span class="preprocessor"></span><span class="preprocessor">#error SKF_LALTLATCHED value is incorrect</span>
02626 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02627 <span class="preprocessor"></span><span class="preprocessor">#if SKF_LCTLLATCHED != 0x04000000</span>
02628 <span class="preprocessor"></span><span class="preprocessor">#error SKF_LCTLLATCHED value is incorrect</span>
02629 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02630 <span class="preprocessor"></span><span class="preprocessor">#if SKF_LSHIFTLATCHED != 0x01000000</span>
02631 <span class="preprocessor"></span><span class="preprocessor">#error SKF_LSHIFTLATCHED value is incorrect</span>
02632 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02633 <span class="preprocessor"></span><span class="preprocessor">#if SKF_RALTLATCHED  !=  0x20000000</span>
02634 <span class="preprocessor"></span><span class="preprocessor">#error SKF_RALTLATCHED value is incorrect</span>
02635 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02636 <span class="preprocessor"></span><span class="preprocessor">#if  SKF_RCTLLATCHED != 0x08000000</span>
02637 <span class="preprocessor"></span><span class="preprocessor">#error SKF_RCTLLATCHED value is incorrect</span>
02638 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02639 <span class="preprocessor"></span><span class="preprocessor">#if SKF_RSHIFTLATCHED != 0x02000000</span>
02640 <span class="preprocessor"></span><span class="preprocessor">#error SKF_RSHIFTLATCHED value is incorrect</span>
02641 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02642 <span class="preprocessor"></span>            pSK-&gt;dwFlags |= (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a>&amp;0xff) &lt;&lt;16;
02643 <span class="preprocessor">#if SKF_LALTLOCKED != 0x00100000</span>
02644 <span class="preprocessor"></span><span class="preprocessor">#error SKF_LALTLOCKED value is incorrect</span>
02645 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02646 <span class="preprocessor"></span><span class="preprocessor">#if SKF_LCTLLOCKED != 0x00040000</span>
02647 <span class="preprocessor"></span><span class="preprocessor">#error SKF_LCTLLOCKED value is incorrect</span>
02648 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02649 <span class="preprocessor"></span><span class="preprocessor">#if SKF_LSHIFTLOCKED != 0x00010000</span>
02650 <span class="preprocessor"></span><span class="preprocessor">#error SKF_LSHIFTLOCKED value is incorrect</span>
02651 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02652 <span class="preprocessor"></span><span class="preprocessor">#if SKF_RALTLOCKED  != 0x00200000</span>
02653 <span class="preprocessor"></span><span class="preprocessor">#error SKF_RALTLOCKED value is incorrect</span>
02654 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02655 <span class="preprocessor"></span><span class="preprocessor">#if SKF_RCTLLOCKED != 0x00080000</span>
02656 <span class="preprocessor"></span><span class="preprocessor">#error SKF_RCTLLOCKED value is incorrect</span>
02657 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02658 <span class="preprocessor"></span><span class="preprocessor">#if SKF_RSHIFTLOCKED != 0x00020000</span>
02659 <span class="preprocessor"></span><span class="preprocessor">#error SKF_RSHIFTLOCKED value is incorrect</span>
02660 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02661 <span class="preprocessor"></span>
02662         }
02663 
02664         <span class="keywordflow">break</span>;
02665 
02666     <span class="keywordflow">case</span> SPI_SETSTICKYKEYS:
02667         {
02668             LPSTICKYKEYS pSK = (LPSTICKYKEYS)lParam;
02669             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fWasOn;
02670 
02671             fWasOn = <a class="code" href="../../d9/d3/access_8h.html#a1">TEST_BOOL_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON);
02672             <span class="keywordflow">if</span> ((wParam != 0) &amp;&amp; (wParam != <span class="keyword">sizeof</span>(STICKYKEYS))) {
02673                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02674             }
02675             <span class="keywordflow">if</span> (!pSK || (pSK-&gt;cbSize != <span class="keyword">sizeof</span>(STICKYKEYS)))
02676                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02677 
02678             pSK-&gt;dwFlags &amp;= ~SKF_STATEINFO;  <span class="comment">/* Don't penalize them for using</span>
02679 <span class="comment">                                              * data from SPI_GETSTICKYKEYS.</span>
02680 <span class="comment">                                              */</span>
02681 
02682             <span class="comment">/*</span>
02683 <span class="comment">             * Do some parameter validation.  We will fail on unsupported and</span>
02684 <span class="comment">             * undefined bits being set.</span>
02685 <span class="comment">             */</span>
02686             <span class="keywordflow">if</span> ((pSK-&gt;dwFlags &amp; SKF_VALID) != pSK-&gt;dwFlags) {
02687                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02688             }
02689             <span class="comment">/*</span>
02690 <span class="comment">             * SKF_AVAILABLE can't be set via API.  Use registry value.</span>
02691 <span class="comment">             */</span>
02692             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_AVAILABLE)) {
02693                 pSK-&gt;dwFlags |= SKF_AVAILABLE;
02694             } <span class="keywordflow">else</span> {
02695                 pSK-&gt;dwFlags &amp;= ~SKF_AVAILABLE;
02696             }
02697 
02698             <span class="keywordflow">if</span> (fAlterWinIni) {
02699                 swprintf(szTemp, pwszd, pSK-&gt;dwFlags);
02700                 fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02701                         <a class="code" href="../../d4/d1/userk_8h.html#a709">PMAP_STICKYKEYS</a>,
02702                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Flags"</span>,
02703                         szTemp
02704                         );
02705                 fWriteAllowed = fWinIniChanged;
02706             }
02707             <span class="keywordflow">if</span> (fWriteAllowed) {
02708                 RtlCopyMemory(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a33">gStickyKeys</a>, pSK, pSK-&gt;cbSize);
02709 
02710                 <span class="comment">/*</span>
02711 <span class="comment">                 * Don't allow user to change cbSize field</span>
02712 <span class="comment">                 */</span>
02713                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a33">gStickyKeys</a>.cbSize = <span class="keyword">sizeof</span>(STICKYKEYS);
02714                 <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON) &amp;&amp; fWasOn) {
02715                     <a class="code" href="../../d9/d3/access_8h.html#a60">xxxTurnOffStickyKeys</a>();
02716                 }
02717 
02718                 <a class="code" href="../../d9/d3/access_8h.html#a49">SetAccessEnabledFlag</a>();
02719                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a593">FCallHookTray</a>())
02720                     <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_ACCESSIBILITYSTATE,
02721                                 ACCESS_STICKYKEYS,
02722                                 (LONG)0,
02723                                 WH_SHELL);
02724                 <a class="code" href="../../d4/d1/userk_8h.html#a1867">PostShellHookMessages</a>(HSHELL_ACCESSIBILITYSTATE, ACCESS_STICKYKEYS);
02725             }
02726         }
02727         <span class="keywordflow">break</span>;
02728 
02729     <span class="keywordflow">case</span> SPI_GETTOGGLEKEYS:
02730         {
02731             LPTOGGLEKEYS pTK = (LPTOGGLEKEYS)lParam;
02732             <span class="keywordtype">int</span> cbSkip = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a36">gToggleKeys</a>.cbSize);
02733 
02734             <span class="keywordflow">if</span> ((wParam != 0) &amp;&amp; (wParam != <span class="keyword">sizeof</span>(TOGGLEKEYS))) {
02735                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02736             }
02737             <span class="keywordflow">if</span> (!pTK || (pTK-&gt;cbSize != <span class="keyword">sizeof</span>(TOGGLEKEYS))) {
02738                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02739             }
02740             <span class="comment">/*</span>
02741 <span class="comment">             * In the future we may support multiple sizes of this data structure.  Don't</span>
02742 <span class="comment">             * change the cbSize field of the data structure passed in.</span>
02743 <span class="comment">             */</span>
02744             RtlCopyMemory((<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)((LPBYTE)pTK + cbSkip),
02745                           (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)((LPBYTE)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a36">gToggleKeys</a> + cbSkip),
02746                           pTK-&gt;cbSize - cbSkip);
02747         }
02748         <span class="keywordflow">break</span>;
02749 
02750     <span class="keywordflow">case</span> SPI_SETTOGGLEKEYS:
02751         {
02752             LPTOGGLEKEYS pTK = (LPTOGGLEKEYS)lParam;
02753 
02754             <span class="keywordflow">if</span> ((wParam != 0) &amp;&amp; (wParam != <span class="keyword">sizeof</span>(TOGGLEKEYS))) {
02755                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02756             }
02757             <span class="keywordflow">if</span> (!pTK || (pTK-&gt;cbSize != <span class="keyword">sizeof</span>(TOGGLEKEYS)))
02758                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02759 
02760             <span class="comment">/*</span>
02761 <span class="comment">             * Do some parameter validation.  We will fail on unsupported and</span>
02762 <span class="comment">             * undefined bits being set.</span>
02763 <span class="comment">             */</span>
02764             <span class="keywordflow">if</span> ((pTK-&gt;dwFlags &amp; TKF_VALID) != pTK-&gt;dwFlags) {
02765                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02766             }
02767             <span class="comment">/*</span>
02768 <span class="comment">             * TKF_AVAILABLE can't be set via API.  Use registry value.</span>
02769 <span class="comment">             */</span>
02770             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_AVAILABLE)) {
02771                 pTK-&gt;dwFlags |= TKF_AVAILABLE;
02772             } <span class="keywordflow">else</span> {
02773                 pTK-&gt;dwFlags &amp;= ~TKF_AVAILABLE;
02774             }
02775 
02776             <span class="keywordflow">if</span> (fAlterWinIni) {
02777                 swprintf(szTemp, pwszd, pTK-&gt;dwFlags);
02778                 fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02779                         <a class="code" href="../../d4/d1/userk_8h.html#a712">PMAP_TOGGLEKEYS</a>,
02780                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Flags"</span>,
02781                         szTemp
02782                         );
02783                 fWriteAllowed = fWinIniChanged;
02784             }
02785             <span class="keywordflow">if</span> (fWriteAllowed) {
02786                 RtlCopyMemory(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a36">gToggleKeys</a>, pTK, pTK-&gt;cbSize);
02787 
02788                 <span class="comment">/*</span>
02789 <span class="comment">                 * Don't allow user to change cbSize field</span>
02790 <span class="comment">                 */</span>
02791                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a36">gToggleKeys</a>.cbSize = <span class="keyword">sizeof</span>(TOGGLEKEYS);
02792 
02793                 <a class="code" href="../../d9/d3/access_8h.html#a49">SetAccessEnabledFlag</a>();
02794             }
02795         }
02796         <span class="keywordflow">break</span>;
02797 
02798     <span class="keywordflow">case</span> SPI_GETMOUSEKEYS:
02799         {
02800             LPMOUSEKEYS pMK = (LPMOUSEKEYS)lParam;
02801             <span class="keywordtype">int</span> cbSkip = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a34">gMouseKeys</a>.cbSize);
02802 
02803             <span class="keywordflow">if</span> ((wParam != 0) &amp;&amp; (wParam != <span class="keyword">sizeof</span>(MOUSEKEYS))) {
02804                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02805             }
02806             <span class="keywordflow">if</span> (!pMK || (pMK-&gt;cbSize != <span class="keyword">sizeof</span>(MOUSEKEYS))) {
02807                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02808             }
02809             <span class="comment">/*</span>
02810 <span class="comment">             * In the future we may support multiple sizes of this data structure.  Don't</span>
02811 <span class="comment">             * change the cbSize field of the data structure passed in.</span>
02812 <span class="comment">             */</span>
02813             RtlCopyMemory((<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)((LPBYTE)pMK + cbSkip),
02814                           (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)((LPBYTE)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a34">gMouseKeys</a> + cbSkip),
02815                           pMK-&gt;cbSize - cbSkip);
02816 
02817 
02818             pMK-&gt;dwFlags &amp;= ~MKF_STATEINFO;
02819 
02820             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a170">gbMKMouseMode</a>) pMK-&gt;dwFlags |= MKF_MOUSEMODE;
02821 
02822             pMK-&gt;dwFlags |= (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a53">gwMKButtonState</a> &amp; 3) &lt;&lt; 24;
02823 <span class="preprocessor">#if MOUSE_BUTTON_LEFT != 0x01</span>
02824 <span class="preprocessor"></span><span class="preprocessor">#error MOUSE_BUTTON_LEFT value is incorrect</span>
02825 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02826 <span class="preprocessor"></span><span class="preprocessor">#if MOUSE_BUTTON_RIGHT != 0x02</span>
02827 <span class="preprocessor"></span><span class="preprocessor">#error MOUSE_BUTTON_RIGHT value is incorrect</span>
02828 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02829 <span class="preprocessor"></span><span class="preprocessor">#if MKF_LEFTBUTTONDOWN != 0x01000000</span>
02830 <span class="preprocessor"></span><span class="preprocessor">#error MKF_LEFTBUTTONDOWN value is incorrect</span>
02831 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02832 <span class="preprocessor"></span><span class="preprocessor">#if MKF_RIGHTBUTTONDOWN != 0x02000000</span>
02833 <span class="preprocessor"></span><span class="preprocessor">#error MKF_RIGHTBUTTONDOWN value is incorrect</span>
02834 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02835 <span class="preprocessor"></span>
02836             pMK-&gt;dwFlags |= (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a54">gwMKCurrentButton</a> &amp; 3)&lt;&lt; 28;
02837 <span class="preprocessor">#if MKF_LEFTBUTTONSEL != 0x10000000</span>
02838 <span class="preprocessor"></span><span class="preprocessor">#error MKF_LEFTBUTTONSEL value is incorrect</span>
02839 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02840 <span class="preprocessor"></span><span class="preprocessor">#if MKF_RIGHTBUTTONSEL != 0x20000000</span>
02841 <span class="preprocessor"></span><span class="preprocessor">#error MKF_RIGHTBUTTONSEL value is incorrect</span>
02842 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02843 <span class="preprocessor"></span>        }
02844         <span class="keywordflow">break</span>;
02845 
02846     <span class="keywordflow">case</span> SPI_SETMOUSEKEYS: {
02847             LPMOUSEKEYS pMK = (LPMOUSEKEYS)lParam;
02848 
02849             <span class="keywordflow">if</span> ((wParam != 0) &amp;&amp; (wParam != <span class="keyword">sizeof</span>(MOUSEKEYS))) {
02850                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02851             }
02852             <span class="keywordflow">if</span> (!pMK || (pMK-&gt;cbSize != <span class="keyword">sizeof</span>(MOUSEKEYS)))
02853                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02854 
02855             <span class="comment">/*</span>
02856 <span class="comment">             * Do some parameter validation.  We will fail on unsupported and</span>
02857 <span class="comment">             * undefined bits being set.</span>
02858 <span class="comment">             */</span>
02859             pMK-&gt;dwFlags &amp;= ~MKF_STATEINFO;  <span class="comment">/* Don't penalize them for using</span>
02860 <span class="comment">                                              * data from SPI_GETMOUSEKEYS.</span>
02861 <span class="comment">                                              */</span>
02862 
02863             <span class="keywordflow">if</span> ((pMK-&gt;dwFlags &amp; MKF_VALID) != pMK-&gt;dwFlags) {
02864                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02865             }
02866             <span class="comment">/*</span>
02867 <span class="comment">             * MKF_AVAILABLE can't be set via API.  Use registry value.</span>
02868 <span class="comment">             */</span>
02869             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_AVAILABLE)) {
02870                 pMK-&gt;dwFlags |= MKF_AVAILABLE;
02871             } <span class="keywordflow">else</span> {
02872                 pMK-&gt;dwFlags &amp;= ~MKF_AVAILABLE;
02873             }
02874             <span class="keywordflow">if</span> ((pMK-&gt;iMaxSpeed &lt; 10) || (pMK-&gt;iMaxSpeed &gt; 360)) {
02875                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02876             }
02877             <span class="keywordflow">if</span> ((pMK-&gt;iTimeToMaxSpeed &lt; 1000) || (pMK-&gt;iTimeToMaxSpeed &gt; 5000)) {
02878                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02879             }
02880 
02881             <span class="keywordflow">if</span> (fAlterWinIni) {
02882                 pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
02883                 fWinIniChanged = <a class="code" href="../../d4/d5/rare_8c.html#a28">SetMouseKeys</a>(pProfileUserName, pMK);
02884                 fWriteAllowed = fWinIniChanged;
02885                 <span class="keywordflow">if</span> (!fWinIniChanged) {
02886 
02887                     <span class="comment">/*</span>
02888 <span class="comment">                     * Back out any changes to win.ini</span>
02889 <span class="comment">                     */</span>
02890                     <a class="code" href="../../d4/d5/rare_8c.html#a28">SetMouseKeys</a>(pProfileUserName, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a34">gMouseKeys</a>);
02891                 }
02892                 <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
02893             }
02894             <span class="keywordflow">if</span> (fWriteAllowed) {
02895                 RtlCopyMemory(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a34">gMouseKeys</a>, pMK, pMK-&gt;cbSize);
02896 
02897                 <span class="comment">/*</span>
02898 <span class="comment">                 * Don't allow user to change cbSize field</span>
02899 <span class="comment">                 */</span>
02900                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a34">gMouseKeys</a>.cbSize = <span class="keyword">sizeof</span>(MOUSEKEYS);
02901 
02902                 <a class="code" href="../../d9/d3/access_8h.html#a71">CalculateMouseTable</a>();
02903 
02904                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON)) {
02905                     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a846">TestAsyncKeyStateToggle</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a262">gNumLockVk</a>) != 0) ^
02906                         (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_REPLACENUMBERS) != 0))
02907                         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a170">gbMKMouseMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02908                     <span class="keywordflow">else</span>
02909                         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a170">gbMKMouseMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02910                     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a25">MKShowMouseCursor</a>();
02911                 } <span class="keywordflow">else</span> {
02912                     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a26">MKHideMouseCursor</a>();
02913                 }
02914 
02915                 <a class="code" href="../../d9/d3/access_8h.html#a49">SetAccessEnabledFlag</a>();
02916 
02917                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a593">FCallHookTray</a>())
02918                     <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_ACCESSIBILITYSTATE,
02919                                 ACCESS_MOUSEKEYS,
02920                                 (LONG)0,
02921                                 WH_SHELL);
02922                 <a class="code" href="../../d4/d1/userk_8h.html#a1867">PostShellHookMessages</a>(HSHELL_ACCESSIBILITYSTATE, ACCESS_MOUSEKEYS);
02923             }
02924         }
02925         <span class="keywordflow">break</span>;
02926 
02927     <span class="keywordflow">case</span> SPI_GETHIGHCONTRAST:
02928         {
02929             LPHIGHCONTRAST pHC = (LPHIGHCONTRAST)lParam;
02930 
02931             <span class="comment">/*</span>
02932 <span class="comment">             * In the future we may support multiple sizes of this data structure.  Don't</span>
02933 <span class="comment">             * change the cbSize field of the data structure passed in.</span>
02934 <span class="comment">             */</span>
02935 
02936             pHC-&gt;dwFlags = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a38">gHighContrast</a>.dwFlags;
02937 
02938             <span class="comment">/*</span>
02939 <span class="comment">             * A hostile app could deallocate the memory using a second thread,</span>
02940 <span class="comment">             * so shelter the copy with a try.</span>
02941 <span class="comment">             */</span>
02942             <span class="keywordflow">try</span> {
02943                 RtlCopyMemory(pHC-&gt;lpszDefaultScheme, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a39">gHighContrastDefaultScheme</a>, MAX_SCHEME_NAME_SIZE * <span class="keyword">sizeof</span>(WCHAR));
02944             } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
02945             }
02946         }
02947 
02948         <span class="keywordflow">break</span>;
02949 
02950     <span class="keywordflow">case</span> SPI_SETHIGHCONTRAST:
02951         {
02952             <a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html">LPINTERNALSETHIGHCONTRAST</a> pHC = (<a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html">LPINTERNALSETHIGHCONTRAST</a>)lParam;
02953             WCHAR wcDefaultScheme[MAX_SCHEME_NAME_SIZE];
02954 
02955             <span class="keywordflow">if</span> (pHC-&gt;<a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html#o2">usDefaultScheme</a>.Length &gt;= MAX_SCHEME_NAME_SIZE*<span class="keyword">sizeof</span>(WCHAR) )
02956                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02957 
02958             <span class="keywordflow">if</span> (pHC-&gt;<a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html#o2">usDefaultScheme</a>.Buffer) {
02959                 <span class="comment">/*</span>
02960 <span class="comment">                 * Only set the scheme if the user specifies a scheme.  An empty</span>
02961 <span class="comment">                 * buffer is ignored.  We do the copy here so that we don't need to</span>
02962 <span class="comment">                 * put a try/except around the WriteProfileString code.</span>
02963 <span class="comment">                 */</span>
02964 
02965                 <span class="keywordflow">try</span> {
02966                     RtlCopyMemory(wcDefaultScheme, pHC-&gt;<a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html#o2">usDefaultScheme</a>.Buffer, pHC-&gt;<a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html#o2">usDefaultScheme</a>.Length);
02967                 } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, RIP_WARNING)) {
02968                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02969                 }
02970             }
02971             wcDefaultScheme[pHC-&gt;<a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html#o2">usDefaultScheme</a>.Length / <span class="keyword">sizeof</span>(WCHAR)] = 0;
02972 
02973             <span class="keywordflow">if</span> (fAlterWinIni) {
02974                 pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
02975                 swprintf(szTemp, pwszd, pHC-&gt;<a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html#o1">dwFlags</a>);
02976                 fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
02977                         <a class="code" href="../../d4/d1/userk_8h.html#a724">PMAP_HIGHCONTRAST</a>,
02978                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Flags"</span>,
02979                         szTemp
02980                         );
02981 
02982                 fWriteAllowed = fWinIniChanged;
02983                 <span class="comment">/*</span>
02984 <span class="comment">                 * Note -- we do not write anything if there is no default scheme</span>
02985 <span class="comment">                 * from the app.  This is consistent with Win95/Win98 behavior.</span>
02986 <span class="comment">                 */</span>
02987 
02988                 <span class="keywordflow">if</span> (pHC-&gt;<a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html#o2">usDefaultScheme</a>.Buffer) {
02989                     fWinIniChanged |= <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
02990                         <a class="code" href="../../d4/d1/userk_8h.html#a724">PMAP_HIGHCONTRAST</a>,
02991                         TEXT(<span class="stringliteral">"High Contrast Scheme"</span>),
02992                         wcDefaultScheme
02993                         );
02994                 }
02995                 <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
02996 
02997             }
02998             <span class="keywordflow">if</span> (fWriteAllowed) {
02999                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwFlagsOld = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a38">gHighContrast</a>.dwFlags;
03000                 LPARAM lp = fAlterWinIni?0:ACCESS_HIGHCONTRASTNOREG;
03001 
03002 <span class="preprocessor">#if (ACCESS_HIGHCONTRASTNOREG | ACCESS_HIGHCONTRASTOFF) != ACCESS_HIGHCONTRASTOFFNOREG</span>
03003 <span class="preprocessor"></span><span class="preprocessor">#error ACCESS_HIGHCONTRASTOFF value is incorrect</span>
03004 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03005 <span class="preprocessor"></span><span class="preprocessor">#if (ACCESS_HIGHCONTRASTNOREG | ACCESS_HIGHCONTRASTON) != ACCESS_HIGHCONTRASTONNOREG</span>
03006 <span class="preprocessor"></span><span class="preprocessor">#error ACCESS_HIGHCONTRASTON value is incorrect</span>
03007 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03008 <span class="preprocessor"></span><span class="preprocessor">#if (ACCESS_HIGHCONTRASTNOREG | ACCESS_HIGHCONTRASTCHANGE) != ACCESS_HIGHCONTRASTCHANGENOREG</span>
03009 <span class="preprocessor"></span><span class="preprocessor">#error ACCESS_HIGHCONTRASTCHANGE value is incorrect</span>
03010 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03011 <span class="preprocessor"></span>
03012                 <span class="comment">/*</span>
03013 <span class="comment">                 * If a NULL is specified in the lpszDefaultScheme, then it is</span>
03014 <span class="comment">                 * not changed.  This is consistent with Win95/Win98 behavior.</span>
03015 <span class="comment">                 */</span>
03016 
03017                 <span class="keywordflow">if</span> (pHC-&gt;<a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html#o2">usDefaultScheme</a>.Buffer)
03018                     wcscpy(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a39">gHighContrastDefaultScheme</a>, wcDefaultScheme);
03019 
03020                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a38">gHighContrast</a>.dwFlags = pHC-&gt;<a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html#o1">dwFlags</a>;
03021 
03022                 <span class="comment">/*</span>
03023 <span class="comment">                 * now, post message to turn high contrast on or off</span>
03024 <span class="comment">                 */</span>
03025 
03026                 <span class="keywordflow">if</span> (pHC-&gt;<a class="code" href="../../d8/d8/structtagINTERNALSETHIGHCONTRAST.html#o1">dwFlags</a> &amp; HCF_HIGHCONTRASTON) {
03027                     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>, WM_LOGONNOTIFY, LOGON_ACCESSNOTIFY,
03028                         (dwFlagsOld &amp; HCF_HIGHCONTRASTON)? (ACCESS_HIGHCONTRASTCHANGE | lp):
03029                                                            (ACCESS_HIGHCONTRASTON | lp));
03030                 } <span class="keywordflow">else</span> {
03031                     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>, WM_LOGONNOTIFY, LOGON_ACCESSNOTIFY, ACCESS_HIGHCONTRASTOFF | lp);
03032                 }
03033 
03034             }
03035         <span class="keywordflow">break</span>;
03036         }
03037 
03038     <span class="keywordflow">case</span> SPI_GETACCESSTIMEOUT:
03039         {
03040             LPACCESSTIMEOUT pTO = (LPACCESSTIMEOUT)lParam;
03041             <span class="keywordtype">int</span> cbSkip = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a35">gAccessTimeOut</a>.cbSize);
03042 
03043             <span class="keywordflow">if</span> ((wParam != 0) &amp;&amp; (wParam != <span class="keyword">sizeof</span>(ACCESSTIMEOUT))) {
03044                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03045             }
03046             <span class="keywordflow">if</span> (!pTO || (pTO-&gt;cbSize != <span class="keyword">sizeof</span>(ACCESSTIMEOUT))) {
03047                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03048             }
03049             <span class="comment">/*</span>
03050 <span class="comment">             * In the future we may support multiple sizes of this data structure.  Don't</span>
03051 <span class="comment">             * change the cbSize field of the data structure passed in.</span>
03052 <span class="comment">             */</span>
03053             RtlCopyMemory((<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)((LPBYTE)pTO + cbSkip),
03054                           (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)((LPBYTE)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a35">gAccessTimeOut</a> + cbSkip),
03055                           pTO-&gt;cbSize - cbSkip);
03056         }
03057         <span class="keywordflow">break</span>;
03058 
03059     <span class="keywordflow">case</span> SPI_SETACCESSTIMEOUT:
03060         {
03061             LPACCESSTIMEOUT pTO = (LPACCESSTIMEOUT)lParam;
03062 
03063             <span class="keywordflow">if</span> ((wParam != 0) &amp;&amp; (wParam != <span class="keyword">sizeof</span>(ACCESSTIMEOUT))) {
03064                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03065             }
03066             <span class="keywordflow">if</span> (!pTO || (pTO-&gt;cbSize != <span class="keyword">sizeof</span>(ACCESSTIMEOUT)))
03067                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03068 
03069             <span class="comment">/*</span>
03070 <span class="comment">             * Do some parameter validation.  We will fail on unsupported and</span>
03071 <span class="comment">             * undefined bits being set.</span>
03072 <span class="comment">             */</span>
03073             <span class="keywordflow">if</span> ((pTO-&gt;dwFlags &amp; ATF_VALID) != pTO-&gt;dwFlags) {
03074                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03075             }
03076             <span class="keywordflow">if</span> (pTO-&gt;iTimeOutMSec &gt; 3600000) {
03077                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03078             }
03079 
03080             <span class="keywordflow">if</span> (fAlterWinIni) {
03081                 pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
03082                 swprintf(szTemp, pwszd, pTO-&gt;dwFlags);
03083                 fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
03084                         <a class="code" href="../../d4/d1/userk_8h.html#a713">PMAP_TIMEOUT</a>,
03085                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Flags"</span>,
03086                         szTemp
03087                         );
03088 
03089                 swprintf(szTemp, pwszd, pTO-&gt;iTimeOutMSec);
03090                 fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
03091                         <a class="code" href="../../d4/d1/userk_8h.html#a713">PMAP_TIMEOUT</a>,
03092                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"TimeToWait"</span>,
03093                         szTemp
03094                         );
03095 
03096                 fWriteAllowed = fWinIniChanged;
03097                 <span class="keywordflow">if</span> (!fWinIniChanged) {
03098 
03099                     <span class="comment">/*</span>
03100 <span class="comment">                     * Back out any changes to win.ini</span>
03101 <span class="comment">                     */</span>
03102                     swprintf(szTemp, pwszd, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a35">gAccessTimeOut</a>.dwFlags);
03103                     fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
03104                             <a class="code" href="../../d4/d1/userk_8h.html#a713">PMAP_TIMEOUT</a>,
03105                             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Flags"</span>,
03106                             szTemp
03107                             );
03108 
03109                     swprintf(szTemp, pwszd, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a35">gAccessTimeOut</a>.iTimeOutMSec);
03110                     fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
03111                             <a class="code" href="../../d4/d1/userk_8h.html#a713">PMAP_TIMEOUT</a>,
03112                             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"TimeToWait"</span>,
03113                             szTemp
03114                             );
03115                 }
03116                 <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
03117             }
03118             <span class="keywordflow">if</span> (fWriteAllowed) {
03119                 RtlCopyMemory(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a35">gAccessTimeOut</a>, pTO, pTO-&gt;cbSize);
03120 
03121                 <span class="comment">/*</span>
03122 <span class="comment">                 * Don't allow user to change cbSize field</span>
03123 <span class="comment">                 */</span>
03124                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a35">gAccessTimeOut</a>.cbSize = <span class="keyword">sizeof</span>(ACCESSTIMEOUT);
03125 
03126                 <a class="code" href="../../d9/d3/access_8h.html#a49">SetAccessEnabledFlag</a>();
03127 
03128                 <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a42">AccessTimeOutReset</a>();
03129             }
03130         }
03131         <span class="keywordflow">break</span>;
03132 
03133     <span class="keywordflow">case</span> SPI_SETSHOWSOUNDS:
03134         <span class="keywordflow">if</span> (fAlterWinIni) {
03135             swprintf(szTemp, pwszd, (wParam == 1));
03136             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03137                     <a class="code" href="../../d4/d1/userk_8h.html#a715">PMAP_SHOWSOUNDS</a>,
03138                     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"On"</span>,
03139                     szTemp
03140                     );
03141 
03142             fWriteAllowed = fWinIniChanged;
03143         }
03144         <span class="keywordflow">if</span> (fWriteAllowed) {
03145             <a class="code" href="../../d4/d1/userk_8h.html#a655">SET_OR_CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a635">ACCF_SHOWSOUNDSON</a>, wParam == 1);
03146             <a class="code" href="../../d9/d3/access_8h.html#a49">SetAccessEnabledFlag</a>();
03147 
03148             <span class="comment">/*</span>
03149 <span class="comment">            * Bug 2079.  Update the System Metrics Info.</span>
03150 <span class="comment">            */</span>
03151             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(SHOWSOUNDS) = <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a635">ACCF_SHOWSOUNDSON</a>);
03152         }
03153         <span class="keywordflow">break</span>;
03154 
03155     <span class="keywordflow">case</span> SPI_GETSHOWSOUNDS: {
03156             <a class="code" href="../../d9/d5/ndismain_8h.html#a264">PINT</a> pint = (<span class="keywordtype">int</span> *)lParam;
03157 
03158             *pint = <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a635">ACCF_SHOWSOUNDSON</a>);
03159         }
03160         <span class="keywordflow">break</span>;
03161 
03162     <span class="keywordflow">case</span> SPI_GETKEYBOARDPREF:
03163         {
03164             PBOOL pfKeyboardPref = (PBOOL)lParam;
03165 
03166             *pfKeyboardPref = <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a637">ACCF_KEYBOARDPREF</a>);
03167         }
03168         <span class="keywordflow">break</span>;
03169 
03170     <span class="keywordflow">case</span> SPI_SETKEYBOARDPREF:
03171         {
03172             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fKeyboardPref = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)wParam;
03173 
03174             <span class="keywordflow">if</span> (fAlterWinIni) {
03175                 fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03176                         <a class="code" href="../../d4/d1/userk_8h.html#a722">PMAP_KEYBOARDPREF</a>,
03177                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"On"</span>,
03178                         (fKeyboardPref) ? <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"1"</span> : <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"0"</span>
03179                         );
03180 
03181                 fWriteAllowed = fWinIniChanged;
03182             }
03183             <span class="keywordflow">if</span> (fWriteAllowed)
03184             {
03185                 <a class="code" href="../../d4/d1/userk_8h.html#a655">SET_OR_CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a637">ACCF_KEYBOARDPREF</a>, wParam);
03186             }
03187         }
03188         <span class="keywordflow">break</span>;
03189 
03190     <span class="keywordflow">case</span> SPI_GETSCREENREADER:
03191         {
03192             PBOOL pfScreenReader = (PBOOL)lParam;
03193 
03194             *pfScreenReader = <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a638">ACCF_SCREENREADER</a>);
03195         }
03196         <span class="keywordflow">break</span>;
03197 
03198     <span class="keywordflow">case</span> SPI_SETSCREENREADER:
03199         {
03200             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fScreenReader = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)wParam;
03201 
03202             <span class="keywordflow">if</span> (fAlterWinIni) {
03203                 fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03204                     <a class="code" href="../../d4/d1/userk_8h.html#a723">PMAP_SCREENREADER</a>,
03205                     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"On"</span>,
03206                     (fScreenReader) ? <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"1"</span> : <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"0"</span>
03207                     );
03208                 fWriteAllowed = fWinIniChanged;
03209             }
03210             <span class="keywordflow">if</span> (fWriteAllowed)
03211             {
03212                 <a class="code" href="../../d4/d1/userk_8h.html#a655">SET_OR_CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a638">ACCF_SCREENREADER</a>, wParam);
03213             }
03214         }
03215         <span class="keywordflow">break</span>;
03216 
03217     <span class="keywordflow">case</span> SPI_GETSOUNDSENTRY:
03218         {
03219             LPSOUNDSENTRY pSS = (LPSOUNDSENTRY)lParam;
03220             <span class="keywordtype">int</span> cbSkip = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a37">gSoundSentry</a>.cbSize);
03221 
03222             <span class="keywordflow">if</span> ((wParam != 0) &amp;&amp; (wParam != <span class="keyword">sizeof</span>(SOUNDSENTRY))) {
03223                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03224             }
03225             <span class="keywordflow">if</span> (!pSS || (pSS-&gt;cbSize != <span class="keyword">sizeof</span>(SOUNDSENTRY))) {
03226                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03227             }
03228             <span class="comment">/*</span>
03229 <span class="comment">             * In the future we may support multiple sizes of this data structure.  Don't</span>
03230 <span class="comment">             * change the cbSize field of the data structure passed in.</span>
03231 <span class="comment">             */</span>
03232             RtlCopyMemory((<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)((LPBYTE)pSS + cbSkip),
03233                           (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)((LPBYTE)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a37">gSoundSentry</a> + cbSkip),
03234                           pSS-&gt;cbSize - cbSkip);
03235         }
03236         <span class="keywordflow">break</span>;
03237 
03238     <span class="keywordflow">case</span> SPI_SETSOUNDSENTRY:
03239         {
03240             LPSOUNDSENTRY pSS = (LPSOUNDSENTRY)lParam;
03241 
03242             <span class="keywordflow">if</span> ((wParam != 0) &amp;&amp; (wParam != <span class="keyword">sizeof</span>(SOUNDSENTRY))) {
03243                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03244             }
03245             <span class="keywordflow">if</span> (!pSS || (pSS-&gt;cbSize != <span class="keyword">sizeof</span>(SOUNDSENTRY)))
03246                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03247 
03248             <span class="comment">/*</span>
03249 <span class="comment">             * Do some parameter validation.  We will fail on unsupported and</span>
03250 <span class="comment">             * undefined bits being set.</span>
03251 <span class="comment">             */</span>
03252             <span class="keywordflow">if</span> ((pSS-&gt;dwFlags &amp; SSF_VALID) != pSS-&gt;dwFlags) {
03253                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03254             }
03255             <span class="comment">/*</span>
03256 <span class="comment">             * We don't support SSWF_CUSTOM.</span>
03257 <span class="comment">             */</span>
03258             <span class="keywordflow">if</span> (pSS-&gt;iWindowsEffect &gt; SSWF_DISPLAY) {
03259                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03260             }
03261             <span class="comment">/*</span>
03262 <span class="comment">             * No support for non-windows apps.</span>
03263 <span class="comment">             */</span>
03264             <span class="keywordflow">if</span> (pSS-&gt;iFSTextEffect != SSTF_NONE) {
03265                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03266             }
03267             <span class="keywordflow">if</span> (pSS-&gt;iFSGrafEffect != SSGF_NONE) {
03268                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03269             }
03270             <span class="comment">/*</span>
03271 <span class="comment">             * SSF_AVAILABLE can't be set via API.  Use registry value.</span>
03272 <span class="comment">             */</span>
03273             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(SoundSentry, SSF_AVAILABLE)) {
03274                 pSS-&gt;dwFlags |= SSF_AVAILABLE;
03275             } <span class="keywordflow">else</span> {
03276                 pSS-&gt;dwFlags &amp;= ~SSF_AVAILABLE;
03277             }
03278 
03279             <span class="keywordflow">if</span> (fAlterWinIni) {
03280                 pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
03281                 fWinIniChanged = <a class="code" href="../../d4/d5/rare_8c.html#a29">SetSoundSentry</a>(pProfileUserName, pSS);
03282                 fWriteAllowed = fWinIniChanged;
03283                 <span class="keywordflow">if</span> (!fWinIniChanged) {
03284 
03285                     <span class="comment">/*</span>
03286 <span class="comment">                     * Back out any changes to win.ini</span>
03287 <span class="comment">                     */</span>
03288                     <a class="code" href="../../d4/d5/rare_8c.html#a29">SetSoundSentry</a>(pProfileUserName, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a37">gSoundSentry</a>);
03289                 }
03290                 <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
03291             }
03292             <span class="keywordflow">if</span> (fWriteAllowed) {
03293                 RtlCopyMemory(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a37">gSoundSentry</a>, pSS, pSS-&gt;cbSize);
03294 
03295                 <span class="comment">/*</span>
03296 <span class="comment">                 * Don't allow user to change cbSize field</span>
03297 <span class="comment">                 */</span>
03298                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a37">gSoundSentry</a>.cbSize = <span class="keyword">sizeof</span>(SOUNDSENTRY);
03299 
03300                 <a class="code" href="../../d9/d3/access_8h.html#a49">SetAccessEnabledFlag</a>();
03301             }
03302         }
03303         <span class="keywordflow">break</span>;
03304 
03305     <span class="keywordflow">case</span> SPI_SETCURSORS:
03306             pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
03307             <a class="code" href="../../d4/d1/userk_8h.html#a1840">xxxUpdateSystemCursorsFromRegistry</a>(pProfileUserName);
03308             <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
03309 
03310             <span class="keywordflow">break</span>;
03311 
03312     <span class="keywordflow">case</span> SPI_SETICONS:
03313             pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
03314             <a class="code" href="../../d4/d1/userk_8h.html#a1841">xxxUpdateSystemIconsFromRegistry</a>(pProfileUserName);
03315             <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
03316 
03317             <span class="keywordflow">break</span>;
03318 
03319     <span class="keywordflow">case</span> SPI_GETMOUSEHOVERWIDTH:
03320         *((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> *)lParam) = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a102">gcxMouseHover</a>;
03321         <span class="keywordflow">break</span>;
03322 
03323     <span class="keywordflow">case</span> SPI_SETMOUSEHOVERWIDTH:
03324         <span class="keywordflow">if</span> (fAlterWinIni) {
03325             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_MOUSEHOVERWIDTH, wParam);
03326             fWriteAllowed = fWinIniChanged;
03327         }
03328         <span class="keywordflow">if</span> (fWriteAllowed) {
03329             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a102">gcxMouseHover</a> = wParam;
03330         }
03331         <span class="keywordflow">break</span>;
03332 
03333     <span class="keywordflow">case</span> SPI_GETMOUSEHOVERHEIGHT:
03334         *((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> *)lParam) = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a103">gcyMouseHover</a>;
03335         <span class="keywordflow">break</span>;
03336 
03337     <span class="keywordflow">case</span> SPI_SETMOUSEHOVERHEIGHT:
03338         <span class="keywordflow">if</span> (fAlterWinIni) {
03339             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_MOUSEHOVERHEIGHT, wParam);
03340             fWriteAllowed = fWinIniChanged;
03341         }
03342         <span class="keywordflow">if</span> (fWriteAllowed) {
03343             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a103">gcyMouseHover</a> = wParam;
03344         }
03345         <span class="keywordflow">break</span>;
03346 
03347     <span class="keywordflow">case</span> SPI_GETMOUSEHOVERTIME:
03348         *((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> *)lParam) = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a104">gdtMouseHover</a>;
03349         <span class="keywordflow">break</span>;
03350 
03351     <span class="keywordflow">case</span> SPI_SETMOUSEHOVERTIME:
03352         <span class="keywordflow">if</span> (fAlterWinIni) {
03353             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_MOUSEHOVERTIME, wParam);
03354             fWriteAllowed = fWinIniChanged;
03355         }
03356         <span class="keywordflow">if</span> (fWriteAllowed) {
03357             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a104">gdtMouseHover</a> = wParam;
03358         }
03359         <span class="keywordflow">break</span>;
03360 
03361     <span class="keywordflow">case</span> SPI_GETWHEELSCROLLLINES:
03362         (*(LPDWORD)lParam) = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ucWheelScrollLines;
03363         <span class="keywordflow">break</span>;
03364 
03365     <span class="keywordflow">case</span> SPI_SETWHEELSCROLLLINES:
03366         <span class="keywordflow">if</span> (fAlterWinIni) {
03367             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, STR_WHEELSCROLLLINES, wParam);
03368             fWriteAllowed = fWinIniChanged;
03369         }
03370 
03371         <span class="keywordflow">if</span> (fWriteAllowed)
03372             <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ucWheelScrollLines = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam;
03373         <span class="keywordflow">break</span>;
03374 
03375     <span class="keywordflow">case</span> SPI_GETMENUSHOWDELAY:
03376         (*(LPDWORD)lParam) = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a94">gdtMNDropDown</a>;
03377         <span class="keywordflow">break</span>;
03378 
03379     <span class="keywordflow">case</span> SPI_SETMENUSHOWDELAY:
03380         <span class="keywordflow">if</span> (fAlterWinIni) {
03381             fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a1861">UpdateWinIniInt</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, STR_MENUSHOWDELAY, wParam);
03382             fWriteAllowed = fWinIniChanged;
03383         }
03384         <span class="keywordflow">if</span> (fWriteAllowed)
03385             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a94">gdtMNDropDown</a> = wParam;
03386         <span class="keywordflow">break</span>;
03387 
03388     <span class="keywordflow">case</span> SPI_GETSCREENSAVERRUNNING:
03389         (*(LPBOOL)lParam) = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03390         <span class="keywordflow">break</span>;
03391 
03392     <span class="keywordflow">case</span> SPI_SETSHOWIMEUI:
03393         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a2060">xxxSetIMEShowStatus</a>(!!wParam);
03394 
03395     <span class="keywordflow">case</span> SPI_GETSHOWIMEUI:
03396         (*(LPBOOL)lParam) = <a class="code" href="../../d4/d1/userk_8h.html#a1133">_GetIMEShowStatus</a>();
03397         <span class="keywordflow">break</span>;
03398 
03399     <span class="keywordflow">default</span>:
03400 
03401 <span class="preprocessor">#define ppvi (UPDWORDPointer(wFlag))</span>
03402 <span class="preprocessor"></span><span class="preprocessor">#define uDataRead ((UINT)fWinIniChanged)</span>
03403 <span class="preprocessor"></span>
03404         <span class="keywordflow">if</span> (wFlag &lt; SPI_MAX) {
03405             RIPERR1(ERROR_INVALID_SPI_VALUE, RIP_WARNING, <span class="stringliteral">"xxxSystemParamtersInfo: Invalid SPI_:%#lx"</span>, wFlag);
03406             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03407         }
03408 
03409         UserAssert(wFlag &amp; SPIF_RANGETYPEMASK);
03410 
03411         <span class="keywordflow">if</span> (!(wFlag &amp; SPIF_SET)) {
03412 
03413             <span class="keywordflow">if</span> ((wFlag &amp; SPIF_RANGETYPEMASK) == SPIF_BOOL) {
03414                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDisable, fDisableValue;
03415 
03416                 UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a556">UPIsBOOLRange</a>(wFlag));
03417                 <span class="comment">/*</span>
03418 <span class="comment">                 * Handle settings that can be disabled by additional conditions.</span>
03419 <span class="comment">                 */</span>
03420                 fDisable = fDisableValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03421                 <span class="keywordflow">if</span> (wFlag &lt; SPI_GETUIEFFECTS) {
03422                     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a563">TestUP</a>(UIEFFECTS)) {
03423                         <span class="keywordflow">switch</span> (wFlag) {
03424                         <span class="keywordflow">case</span> SPI_GETACTIVEWNDTRKZORDER:
03425                         <span class="keywordflow">case</span> SPI_GETACTIVEWINDOWTRACKING:
03426                             <span class="keywordflow">break</span>;
03427 
03428                         <span class="keywordflow">case</span> SPI_GETKEYBOARDCUES:
03429                             fDisableValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03430                             <span class="comment">/* Fall Through */</span>
03431 
03432                         <span class="keywordflow">default</span>:
03433                             fDisable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03434                             <span class="keywordflow">break</span>;
03435                         }
03436                     } <span class="keywordflow">else</span> { <span class="comment">/* if (!TestUP(UIEFFECTS) */</span>
03437                         <span class="keywordflow">switch</span> (wFlag) {
03438                         <span class="keywordflow">case</span> SPI_GETKEYBOARDCUES:
03439                             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a637">ACCF_KEYBOARDPREF</a>)) {
03440                                 fDisableValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03441                                 fDisable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03442                             }
03443                             <span class="keywordflow">break</span>;
03444 
03445                         <span class="keywordflow">case</span> SPI_GETGRADIENTCAPTIONS:
03446                         <span class="keywordflow">case</span> SPI_GETSELECTIONFADE:
03447                         <span class="keywordflow">case</span> SPI_GETMENUFADE:
03448                         <span class="keywordflow">case</span> SPI_GETTOOLTIPFADE:
03449                         <span class="keywordflow">case</span> SPI_GETCURSORSHADOW:
03450                             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a252">gbDisableAlpha</a>) {
03451                                 fDisable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03452                             }
03453                             <span class="keywordflow">break</span>;
03454                         }
03455                     }
03456                 } <span class="comment">/* if (wFlag &lt; SPI_GETUIEFFECTS) */</span>
03457                 <span class="comment">/*</span>
03458 <span class="comment">                 * Give them the disabled value or read the actual one</span>
03459 <span class="comment">                 */</span>
03460                 <span class="keywordflow">if</span> (fDisable) {
03461                     *((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> *)lParam) = fDisableValue;
03462                 } <span class="keywordflow">else</span> {
03463                     *((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> *)lParam) = !!<a class="code" href="../../d4/d1/userk_8h.html#a560">TestUPBOOL</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a150">gpdwCPUserPreferencesMask</a>, wFlag);
03464                 }
03465             } <span class="keywordflow">else</span> {
03466                 UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a554">UPIsDWORDRange</a>(wFlag));
03467                 *((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)lParam) = <a class="code" href="../../d4/d1/userk_8h.html#a2029">UPDWORDValue</a>(wFlag);
03468             }
03469 
03470         } <span class="keywordflow">else</span> { <span class="comment">/* if (!(wFlag &amp; SPIF_SET)) */</span>
03471             pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
03472 
03473             <span class="keywordflow">if</span> ((wFlag &amp; SPIF_RANGETYPEMASK) == SPIF_BOOL) {
03474                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> pdwValue [SPI_BOOLMASKDWORDSIZE];
03475 
03476                 UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a556">UPIsBOOLRange</a>(wFlag));
03477                 UserAssert(<span class="keyword">sizeof</span>(pdwValue) == <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a150">gpdwCPUserPreferencesMask</a>));
03478 
03479                 <span class="keywordflow">if</span> (fAlterWinIni) {
03480                     <span class="comment">/*</span>
03481 <span class="comment">                     * We only need to set/clear the bit passed in, however, we write the whole</span>
03482 <span class="comment">                     *  bit mask to the registry. Since the info in gpdwCPUserPreferencesMask</span>
03483 <span class="comment">                     *  might not match what it is in the registry, we need to read the registry before</span>
03484 <span class="comment">                     *  we write to it.</span>
03485 <span class="comment">                     */</span>
03486                     <a class="code" href="../../d4/d5/rare_8c.html#a7">uDataRead</a> = <a class="code" href="../../d4/d1/userk_8h.html#a2013">FastGetProfileValue</a>(pProfileUserName,
03487                             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a151">gpviCPUserPreferences</a>-&gt;<a class="code" href="../../d9/d3/structtagPROFILEVALUEINFO.html#o1">uSection</a>,
03488                             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a151">gpviCPUserPreferences</a>-&gt;<a class="code" href="../../d9/d3/structtagPROFILEVALUEINFO.html#o2">pwszKeyName</a>,
03489                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03490                             (LPBYTE)pdwValue,
03491                             <span class="keyword">sizeof</span>(pdwValue)
03492                             );
03493 
03494                     <span class="comment">/*</span>
03495 <span class="comment">                     * If some bits are not in the registry, get them from gpdwCPUserPreferencesMask</span>
03496 <span class="comment">                     */</span>
03497                     UserAssert(<a class="code" href="../../d4/d5/rare_8c.html#a7">uDataRead</a> &lt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a150">gpdwCPUserPreferencesMask</a>));
03498                     RtlCopyMemory(pdwValue + <a class="code" href="../../d4/d5/rare_8c.html#a7">uDataRead</a>,
03499                                   <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a150">gpdwCPUserPreferencesMask</a> + <a class="code" href="../../d4/d5/rare_8c.html#a7">uDataRead</a>,
03500                                   <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a150">gpdwCPUserPreferencesMask</a>) - <a class="code" href="../../d4/d5/rare_8c.html#a7">uDataRead</a>);
03501 
03502                     <span class="comment">/*</span>
03503 <span class="comment">                     * Set/Clear the new state and write it</span>
03504 <span class="comment">                     */</span>
03505                     <span class="keywordflow">if</span> (lParam) {
03506                         <a class="code" href="../../d4/d1/userk_8h.html#a561">SetUPBOOL</a>(pdwValue, wFlag);
03507                     } <span class="keywordflow">else</span> {
03508                         <a class="code" href="../../d4/d1/userk_8h.html#a562">ClearUPBOOL</a>(pdwValue, wFlag);
03509                     }
03510 
03511                     fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2012">FastWriteProfileValue</a>(pProfileUserName,
03512                             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a151">gpviCPUserPreferences</a>-&gt;<a class="code" href="../../d9/d3/structtagPROFILEVALUEINFO.html#o1">uSection</a>,
03513                             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a151">gpviCPUserPreferences</a>-&gt;<a class="code" href="../../d9/d3/structtagPROFILEVALUEINFO.html#o2">pwszKeyName</a>,
03514                             REG_BINARY,
03515                             (LPBYTE)pdwValue,
03516                             <span class="keyword">sizeof</span>(pdwValue)
03517                             );
03518 
03519                     fWriteAllowed = fWinIniChanged;
03520                 }
03521 
03522                 <span class="keywordflow">if</span> (fWriteAllowed) {
03523                     <span class="keywordflow">if</span> (lParam) {
03524                         <a class="code" href="../../d4/d1/userk_8h.html#a561">SetUPBOOL</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a150">gpdwCPUserPreferencesMask</a>, wFlag);
03525                     } <span class="keywordflow">else</span> {
03526                         <a class="code" href="../../d4/d1/userk_8h.html#a562">ClearUPBOOL</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a150">gpdwCPUserPreferencesMask</a>, wFlag);
03527                     }
03528 
03529                     <span class="comment">/*</span>
03530 <span class="comment">                     * Propagate gpsi flags</span>
03531 <span class="comment">                     */</span>
03532                     <span class="keywordflow">switch</span> (wFlag) {
03533                     <span class="keywordflow">case</span> SPI_SETUIEFFECTS:
03534                         <a class="code" href="../../d4/d1/userk_8h.html#a569">PropagetUPBOOLTogpsi</a>(UIEFFECTS);
03535                         <a class="code" href="../../d4/d1/userk_8h.html#a1790">SetPointer</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03536                         <span class="comment">/*</span>
03537 <span class="comment">                         * Fall through</span>
03538 <span class="comment">                         */</span>
03539 
03540                     <span class="keywordflow">case</span> SPI_SETGRADIENTCAPTIONS:
03541                         <a class="code" href="../../d4/d1/userk_8h.html#a1860">CreateBitmapStrip</a>();
03542                         <a class="code" href="../../d4/d1/userk_8h.html#a470">xxxRedrawScreen</a>();
03543                         <span class="keywordflow">break</span>;
03544 
03545                     <span class="keywordflow">case</span> SPI_SETCOMBOBOXANIMATION:
03546                         <a class="code" href="../../d4/d1/userk_8h.html#a569">PropagetUPBOOLTogpsi</a>(COMBOBOXANIMATION);
03547                         <span class="keywordflow">break</span>;
03548 
03549                     <span class="keywordflow">case</span> SPI_SETLISTBOXSMOOTHSCROLLING:
03550                         <a class="code" href="../../d4/d1/userk_8h.html#a569">PropagetUPBOOLTogpsi</a>(LISTBOXSMOOTHSCROLLING);
03551                         <span class="keywordflow">break</span>;
03552 
03553                     <span class="keywordflow">case</span> SPI_SETKEYBOARDCUES:
03554                         <a class="code" href="../../d4/d1/userk_8h.html#a569">PropagetUPBOOLTogpsi</a>(KEYBOARDCUES);
03555                         <span class="keywordflow">break</span>;
03556 
03557                     <span class="keywordflow">case</span> SPI_SETCURSORSHADOW:
03558                         <a class="code" href="../../d4/d1/userk_8h.html#a1790">SetPointer</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03559                         <span class="keywordflow">break</span>;
03560 
03561                     } <span class="comment">/* switch (wFlag) */</span>
03562 
03563                 } <span class="comment">/* if (fWriteAllowed) */</span>
03564 
03565             } <span class="keywordflow">else</span> { <span class="comment">/* if ((wFlag &amp; SPIF_RANGETYPEMASK) == SPIF_BOOL) */</span>
03566 
03567                 UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a554">UPIsDWORDRange</a>(wFlag));
03568 
03569                 <span class="keywordflow">if</span> (fAlterWinIni) {
03570                     fWinIniChanged = <a class="code" href="../../d4/d1/userk_8h.html#a2012">FastWriteProfileValue</a>(pProfileUserName,
03571                             <a class="code" href="../../d4/d5/rare_8c.html#a6">ppvi</a>-&gt;uSection,
03572                             <a class="code" href="../../d4/d5/rare_8c.html#a6">ppvi</a>-&gt;pwszKeyName,
03573                             REG_DWORD,
03574                             (LPBYTE)&amp;lParam,
03575                             <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)
03576                             );
03577 
03578                     fWriteAllowed = fWinIniChanged;
03579                 }
03580 
03581                 <span class="keywordflow">if</span> (fWriteAllowed) {
03582 
03583                     <a class="code" href="../../d4/d5/rare_8c.html#a6">ppvi</a>-&gt;dwValue = PtrToUlong(lParam);
03584 
03585                     <span class="keywordflow">switch</span>(wFlag) {
03586                     <span class="keywordflow">case</span> SPI_SETCARETWIDTH:
03587                         <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;uCaretWidth = <a class="code" href="../../d4/d5/rare_8c.html#a6">ppvi</a>-&gt;dwValue;
03588                         <span class="keywordflow">break</span>;
03589                     <span class="keywordflow">default</span>:
03590                         <span class="keywordflow">break</span>;
03591                     }
03592                 }
03593 
03594             } <span class="comment">/* if ((wFlag &amp; SPIF_RANGETYPEMASK) == SPIF_BOOL) */</span>
03595 
03596             <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
03597         } <span class="comment">/* if (!(wFlag &amp; SPIF_SET)) */</span>
03598 
03599         <span class="keywordflow">break</span>;
03600 <span class="preprocessor">#undef ppvi</span>
03601 <span class="preprocessor"></span><span class="preprocessor">#undef uDataRead</span>
03602 <span class="preprocessor"></span>    } <span class="comment">/* switch (wFlag) */</span>
03603 
03604 
03605     <span class="keywordflow">if</span> (fWinIniChanged &amp;&amp; fSendWinIniChange) {
03606         ULONG_PTR dwResult;
03607 
03608         <span class="comment">/*</span>
03609 <span class="comment">         * dwResult is defined so that xxxSendMessageTimeout will really</span>
03610 <span class="comment">         * and truly do a timeout.  Yeah, I know, this is a hack, but,</span>
03611 <span class="comment">         * it is compatible.</span>
03612 <span class="comment">         */</span>
03613 
03614         <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>(&amp;strSection, szSection, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
03615         <a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(<a class="code" href="../../d4/d1/userk_8h.html#a457">PWND_BROADCAST</a>, WM_SETTINGCHANGE, wFlag, (LPARAM)&amp;strSection,
03616                 SMTO_NORMAL, 100, &amp;dwResult);
03617     }
03618 
03619     <span class="keywordflow">return</span> fWriteAllowed;
03620 }
03621 
03622 <span class="comment">/***************************************************************************\</span>
03623 <span class="comment">* _RegisterShellHookWindow</span>
03624 <span class="comment">*</span>
03625 <span class="comment">* History:</span>
03626 <span class="comment">\***************************************************************************/</span>
03627 
<a name="l03628"></a><a class="code" href="../../d4/d1/userk_8h.html#a1864">03628</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1864">_RegisterShellHookWindow</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd) {
03629     <a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">PDESKTOPINFO</a> pdeskinfo;
03630 
03631     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03632         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03633 
03634     pdeskinfo = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo;
03635 
03636     <span class="comment">/*</span>
03637 <span class="comment">     * Add pwnd to the desktop's Volatile Window Pointer List (VWPL) of</span>
03638 <span class="comment">     * ShellHook windows. If this call initializes the VWPL, set the</span>
03639 <span class="comment">     * (re)allocation threshhold to 2 PWNDs (we know we never have more than</span>
03640 <span class="comment">     * 2 windows in this list anyway)</span>
03641 <span class="comment">     */</span>
03642     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1870">VWPLAdd</a>(&amp;(pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o21">pvwplShellHook</a>), pwnd, 2)) {
03643         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a633">WFSHELLHOOKWND</a>);
03644         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03645     }
03646     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03647 }
03648 
03649 <span class="comment">/***************************************************************************\</span>
03650 <span class="comment">* _DeregisterShellHookWindow</span>
03651 <span class="comment">*</span>
03652 <span class="comment">* History:</span>
03653 <span class="comment">\***************************************************************************/</span>
03654 
<a name="l03655"></a><a class="code" href="../../d4/d1/userk_8h.html#a1865">03655</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1865">_DeregisterShellHookWindow</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd) {
03656     <a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">PDESKTOPINFO</a> pdeskinfo;
03657 
03658     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03659         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03660 
03661     pdeskinfo = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo;
03662 
03663     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1871">VWPLRemove</a>(&amp;(pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o21">pvwplShellHook</a>), pwnd)) {
03664         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a633">WFSHELLHOOKWND</a>);
03665     }
03666     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03667 }
03668 
03669 <span class="comment">/***************************************************************************\</span>
03670 <span class="comment">* xxxSendMinRectMessages</span>
03671 <span class="comment">*</span>
03672 <span class="comment">* History:</span>
03673 <span class="comment">\***************************************************************************/</span>
03674 
<a name="l03675"></a><a class="code" href="../../d4/d1/userk_8h.html#a1866">03675</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1866">xxxSendMinRectMessages</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, RECT *lpRect) {
03676     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03677     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
03678     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
03679     <a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">PDESKTOPINFO</a> pdeskinfo;
03680     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nPwndShellHook;
03681     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndShellHook;
03682 
03683     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(pti, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a523">WHF_SHELL</a>)) {
03684         <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_GETMINRECT, (WPARAM)hwnd,
03685             (LPARAM)lpRect, WH_SHELL);
03686         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03687     }
03688 
03689     pdeskinfo = <a class="code" href="../../d4/d1/userk_8h.html#a256">GETDESKINFO</a>(pti);
03690     <span class="keywordflow">if</span> (pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o21">pvwplShellHook</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03691         <span class="keywordflow">return</span> fRet;
03692 
03693     nPwndShellHook = 0;
03694     pwndShellHook = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03695     <span class="keywordflow">while</span> (pwndShellHook = <a class="code" href="../../d4/d1/userk_8h.html#a1872">VWPLNext</a>(pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o21">pvwplShellHook</a>, pwndShellHook, &amp;nPwndShellHook)) {
03696         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
03697         ULONG_PTR dwRes;
03698 
03699         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndShellHook, &amp;tlpwnd);
03700         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(pwndShellHook, WM_KLUDGEMINRECT, (WPARAM)(hwnd), (LPARAM)lpRect,
03701             SMTO_NORMAL, 100, &amp;dwRes))
03702             fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03703 
03704         <span class="comment">/*</span>
03705 <span class="comment">         * pdeskinfo-&gt;pvwplShellHook may have been realloced to a different</span>
03706 <span class="comment">         * location and size during the WM_KLUDGEMINRECT callback.</span>
03707 <span class="comment">         */</span>
03708         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
03709     }
03710     <span class="keywordflow">return</span> fRet;
03711 }
03712 
03713 <span class="comment">/***************************************************************************\</span>
03714 <span class="comment">* PostShellHookMessages</span>
03715 <span class="comment">*</span>
03716 <span class="comment">* History:</span>
03717 <span class="comment">\***************************************************************************/</span>
03718 
<a name="l03719"></a><a class="code" href="../../d4/d1/userk_8h.html#a1867">03719</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1867">PostShellHookMessages</a>(UINT message, LPARAM lParam) {
03720     <a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">PDESKTOPINFO</a> pdeskinfo = <a class="code" href="../../d4/d1/userk_8h.html#a256">GETDESKINFO</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
03721     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nPwndShellHook;
03722     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndShellHook;
03723 
03724     nPwndShellHook = 0;
03725     pwndShellHook = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03726 
03727     <span class="comment">/*</span>
03728 <span class="comment">     * Hack for WM_APPCOMMAND (bug 389210):</span>
03729 <span class="comment">     * We want to allow anyone who's listening for these wm_appcommand messages to be able to</span>
03730 <span class="comment">     * take the foreground. ie pressing mail will launch outlook AND bring it to the foreground</span>
03731 <span class="comment">     * We set the token to null so anyone can steal the foreground - else it isn't clear who should</span>
03732 <span class="comment">     * have the right to steal it - only one person gets the right. We let them fight it out to</span>
03733 <span class="comment">     * decide who gets foreground if more than one listener will try make a foreground change.</span>
03734 <span class="comment">     */</span>
03735     <span class="keywordflow">if</span> (HSHELL_APPCOMMAND == message) {
03736         TAGMSG0(DBGTAG_FOREGROUND, <span class="stringliteral">"PostShellHookMessages cleared last input token - open foreground."</span>);
03737 
03738         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03739     }
03740 
03741     <span class="comment">/*</span>
03742 <span class="comment">     * Loop through all the windows registered to listen for shell hooks and post the message</span>
03743 <span class="comment">     * to them</span>
03744 <span class="comment">     */</span>
03745     <span class="keywordflow">while</span> (pwndShellHook = <a class="code" href="../../d4/d1/userk_8h.html#a1872">VWPLNext</a>(pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o21">pvwplShellHook</a>, pwndShellHook, &amp;nPwndShellHook)) {
03746         <span class="keywordflow">if</span> (pwndShellHook == pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o9">spwndProgman</a>) {
03747             <span class="keywordflow">switch</span> (message) {
03748             <span class="keywordflow">case</span> HSHELL_WINDOWCREATED:
03749                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwndShellHook, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o15">uiShellMsg</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a294">guiOtherWindowCreated</a>, lParam);
03750                 <span class="keywordflow">break</span>;
03751             <span class="keywordflow">case</span> HSHELL_WINDOWDESTROYED:
03752                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwndShellHook, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o15">uiShellMsg</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a295">guiOtherWindowDestroyed</a>, lParam);
03753                 <span class="keywordflow">break</span>;
03754             }
03755         } <span class="keywordflow">else</span> {
03756             <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwndShellHook, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o15">uiShellMsg</a>, message, lParam);
03757         }
03758     }
03759 
03760 }
03761 
03762 <span class="comment">/***************************************************************************\</span>
03763 <span class="comment">* _ResetDblClk</span>
03764 <span class="comment">*</span>
03765 <span class="comment">* History:</span>
03766 <span class="comment">\***************************************************************************/</span>
03767 
<a name="l03768"></a><a class="code" href="../../d4/d1/userk_8h.html#a1868">03768</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1868">_ResetDblClk</a>(VOID)
03769 {
03770     <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;timeDblClk = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03771 }
03772 
03773 <span class="comment">/***************************************************************************\</span>
03774 <span class="comment">* SetMsgBox</span>
03775 <span class="comment">*</span>
03776 <span class="comment">* History:</span>
03777 <span class="comment">\***************************************************************************/</span>
03778 
<a name="l03779"></a><a class="code" href="../../d4/d1/userk_8h.html#a1863">03779</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1863">SetMsgBox</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
03780 {
03781     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo-&gt;cntMBox++;
03782     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a556">WFMSGBOX</a>);
03783     <span class="keywordflow">return</span>;
03784 }
03785 
03786 <span class="comment">/***************************************************************************\</span>
03787 <span class="comment">* xxxSimulateShiftF10</span>
03788 <span class="comment">*</span>
03789 <span class="comment">* This routine is called to convert a WM_CONTEXTHELP message back to a</span>
03790 <span class="comment">* SHIFT-F10 sequence for old applications.  It is called from the default</span>
03791 <span class="comment">* window procedure.</span>
03792 <span class="comment">*</span>
03793 <span class="comment">* History:</span>
03794 <span class="comment">* 22-Aug-95 BradG       Ported from Win95 (rare.asm)</span>
03795 <span class="comment">\***************************************************************************/</span>
03796 
<a name="l03797"></a><a class="code" href="../../d4/d1/userk_8h.html#a1869">03797</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1869">xxxSimulateShiftF10</a>( VOID )
03798 {
03799         <span class="comment">/*</span>
03800 <span class="comment">     *  VK_SHIFT down</span>
03801 <span class="comment">     */</span>
03802     <a class="code" href="../../d4/d1/userk_8h.html#a1039">xxxKeyEvent</a>(VK_LSHIFT, 0x2A | SCANCODE_SIMULATED, <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>(), 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03803 
03804     <span class="comment">/*</span>
03805 <span class="comment">     *  VK_F10 down</span>
03806 <span class="comment">     */</span>
03807     <a class="code" href="../../d4/d1/userk_8h.html#a1039">xxxKeyEvent</a>(VK_F10, 0x44 | SCANCODE_SIMULATED, <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>(), 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03808 
03809     <span class="comment">/*</span>
03810 <span class="comment">     *  VK_F10 up</span>
03811 <span class="comment">     */</span>
03812     <a class="code" href="../../d4/d1/userk_8h.html#a1039">xxxKeyEvent</a>(VK_F10 | KBDBREAK, 0x44 | SCANCODE_SIMULATED, <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>(), 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03813 
03814     <span class="comment">/*</span>
03815 <span class="comment">     *  VK_SHIFT up</span>
03816 <span class="comment">     */</span>
03817     <a class="code" href="../../d4/d1/userk_8h.html#a1039">xxxKeyEvent</a>(VK_LSHIFT | KBDBREAK, 0x2A | SCANCODE_SIMULATED, <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>(), 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03818 }
03819 
03820 <span class="comment">/*</span>
03821 <span class="comment"> * VWPL (Volatile Window Pointer List) Implementation details.</span>
03822 <span class="comment"> * ===========================================================</span>
03823 <span class="comment"> * Volatile Window Pointer Lists are used to keep a list of windows that we want</span>
03824 <span class="comment"> * to send messages to, where the list may get altered during each of those send</span>
03825 <span class="comment"> * message callbacks.</span>
03826 <span class="comment"> *</span>
03827 <span class="comment"> * The list is volatile in that it can change its size, contents and location</span>
03828 <span class="comment"> * while we continue to traverse the list.</span>
03829 <span class="comment"> *</span>
03830 <span class="comment"> * Examples of use:</span>
03831 <span class="comment"> * - hungapp redraw code in hungapp.c</span>
03832 <span class="comment"> * - xxxSendMinRectMessages stuff in rare.c</span>
03833 <span class="comment"> *</span>
03834 <span class="comment"> * Members of the VWPL struct:</span>
03835 <span class="comment"> * cPwnd</span>
03836 <span class="comment"> *   The number of pwnds in the list, not including NULLs</span>
03837 <span class="comment"> * cElem</span>
03838 <span class="comment"> *   The size of the list, including NULLs.</span>
03839 <span class="comment"> * cThreshhold</span>
03840 <span class="comment"> *   When growing, the number of extra spaces to add to the list.</span>
03841 <span class="comment"> *   When (cElem - cPwnd) &gt; cThreshhold, that's when we reallocate to shrink.</span>
03842 <span class="comment"> * apwnd[]</span>
03843 <span class="comment"> *   An array of pwnds.</span>
03844 <span class="comment"> *   The array may have some empty slots, but they will all be at the end.</span>
03845 <span class="comment"> *</span>
03846 <span class="comment"> * VWPL Internal Invariants:</span>
03847 <span class="comment"> * - no pwnd appears more than once.</span>
03848 <span class="comment"> * - cPwnd &lt;= cElem</span>
03849 <span class="comment"> * - number of unused slots (cElem - cPwnd) &lt; cThreshhold</span>
03850 <span class="comment"> * - all unused slots are at the end of the aPwnd[] array</span>
03851 <span class="comment"> *</span>
03852 <span class="comment"> * Restrictions on use of VWPLs:</span>
03853 <span class="comment"> * - NULL pwnd is not allowed (except in unused slots)</span>
03854 <span class="comment"> * - all pwnds in the list must be valid: pwnds must be explicitly removed from</span>
03855 <span class="comment"> *   the list in their xxxFreeWindow.</span>
03856 <span class="comment"> */</span>
03857 
03858 <span class="preprocessor">#if DBG_VWPL</span>
03859 <span class="preprocessor"></span><a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d5/rare_8c.html#a8">DbgCheckVWPL</a>(PVWPL pvwpl)
03860 {
03861     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ixPwnd;
03862 
03863     <span class="keywordflow">if</span> (!pvwpl) {
03864         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03865     }
03866 
03867     UserAssert(pvwpl-&gt;cElem &gt;= pvwpl-&gt;cPwnd);
03868     <span class="comment">// Low memory may have made a shrinking realloc fail, which doesn't</span>
03869     <span class="comment">// really bother us.</span>
03870     <span class="comment">// UserAssert((pvwpl-&gt;cElem - pvwpl-&gt;cPwnd) &lt; pvwpl-&gt;cThreshhold);</span>
03871 
03872     <span class="comment">// Check that cElem is not too big</span>
03873     UserAssert(pvwpl-&gt;cElem &lt; 1000);
03874 
03875     <span class="comment">// check that the pwnds are all in the first cPwnd slots.</span>
03876     <span class="keywordflow">for</span> (ixPwnd = 0; ixPwnd &lt; pvwpl-&gt;cPwnd; ixPwnd++) {
03877         UserAssert(pvwpl-&gt;aPwnd[ixPwnd] != NULL);
03878     }
03879 
03880 <span class="preprocessor">#if ZERO_INIT_VWPL</span>
03881 <span class="preprocessor"></span>    <span class="comment">// check that the NULLs are all in the last few slots.</span>
03882     <span class="keywordflow">for</span> (ixPwnd = pvwpl-&gt;cPwnd; ixPwnd &lt; pvwpl-&gt;cElem; ixPwnd++) {
03883         UserAssert(pvwpl-&gt;aPwnd[ixPwnd] == NULL);
03884     }
03885 <span class="preprocessor">#endif</span>
03886 <span class="preprocessor"></span>
03887 <span class="preprocessor">#if 0</span>
03888 <span class="preprocessor"></span>    <span class="comment">// check that all pwnds are valid?</span>
03889     <span class="keywordflow">for</span> (ixPwnd = 0; ixPwnd &lt; pvwpl-&gt;cPwnd; ixPwnd++) {
03890          <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = pvwpl-&gt;aPwnd[ixPwnd];
03891          UserAssert(<a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.h) == pwnd);
03892     }
03893 <span class="preprocessor">#endif</span>
03894 <span class="preprocessor"></span>
03895     <span class="comment">// check that no pwnds appears twice</span>
03896     <span class="keywordflow">for</span> (ixPwnd = 0; ixPwnd &lt; pvwpl-&gt;cPwnd; ixPwnd++) {
03897         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ix2;
03898         <span class="keywordflow">for</span> (ix2 = ixPwnd + 1; ix2 &lt; pvwpl-&gt;cPwnd; ix2++) {
03899             UserAssert(pvwpl-&gt;aPwnd[ixPwnd] != pvwpl-&gt;aPwnd[ix2]);
03900         }
03901     }
03902 }
03903 <span class="preprocessor">#else</span>
<a name="l03904"></a><a class="code" href="../../d4/d5/rare_8c.html#a8">03904</a> <span class="preprocessor"></span><span class="preprocessor">#define DbgCheckVWPL(foo)</span>
03905 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03906 <span class="preprocessor"></span>
03907 <span class="comment">/*****************************************************************************\</span>
03908 <span class="comment">* VWPLAdd</span>
03909 <span class="comment">*</span>
03910 <span class="comment">* Adds a pwnd to a VWPL (Volatile Window Pointer List).</span>
03911 <span class="comment">* Allocates or reallocates memory as required.</span>
03912 <span class="comment">*</span>
03913 <span class="comment">* History:</span>
03914 <span class="comment">* 98-01-30 IanJa   Created.</span>
03915 <span class="comment">\*****************************************************************************/</span>
<a name="l03916"></a><a class="code" href="../../d4/d1/userk_8h.html#a1870">03916</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1870">VWPLAdd</a>(
03917     PVWPL *ppvwpl,
03918     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
03919     DWORD dwThreshhold)
03920 {
03921     <a class="code" href="../../d1/d0/inc_2user_8h.html#a1031">PVWPL</a> pvwpl;
03922     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ixPwnd;
03923 
03924     TAGMSG2(DBGTAG_VWPL, <span class="stringliteral">"VWPL %#p + %#p"</span>, *ppvwpl, pwnd);
03925     UserAssert(pwnd);
03926 
03927     <span class="keywordflow">if</span> (*ppvwpl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03928         <span class="comment">/*</span>
03929 <span class="comment">         * Initialize the VWPL</span>
03930 <span class="comment">         */</span>
03931         UserAssert(dwThreshhold &gt;= 2); <span class="comment">// could be 1, but that would be silly</span>
03932         pvwpl = (<a class="code" href="../../d1/d0/inc_2user_8h.html#a1031">PVWPL</a>)UserAllocPool(
03933                 <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d2/structVWPL.html">VWPL</a>) + (<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>) * dwThreshhold), TAG_VWPL);
03934         <span class="keywordflow">if</span> (pvwpl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03935             RIPMSG1(RIP_WARNING,
03936                     <span class="stringliteral">"VWPLAdd fail to allocate initial %lx"</span>,
03937                     <span class="keyword">sizeof</span>(VWPL) + (<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a943">PWND</a>) * dwThreshhold));
03938             <a class="code" href="../../d4/d5/rare_8c.html#a8">DbgCheckVWPL</a>(*ppvwpl);
03939             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03940         }
03941         pvwpl-&gt;cElem = dwThreshhold;
03942         pvwpl-&gt;cThreshhold = dwThreshhold;
03943 <span class="preprocessor">#if ZERO_INIT_VWPL</span>
03944 <span class="preprocessor"></span>        RtlZeroMemory(&amp;(pvwpl-&gt;aPwnd[0]), (<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a943">PWND</a>) * dwThreshhold));
03945 <span class="preprocessor">#endif</span>
03946 <span class="preprocessor"></span>        pvwpl-&gt;cPwnd = 0;
03947         *ppvwpl = pvwpl;
03948         ixPwnd = 0;
03949         <span class="keywordflow">goto</span> AddPwnd;
03950     } <span class="keywordflow">else</span> {
03951         pvwpl = *ppvwpl;
03952         <span class="keywordflow">for</span> (ixPwnd = 0; ixPwnd &lt; pvwpl-&gt;cElem; ixPwnd++) {
03953             <span class="keywordflow">if</span> (pwnd == pvwpl-&gt;aPwnd[ixPwnd]) {
03954                 <a class="code" href="../../d4/d5/rare_8c.html#a8">DbgCheckVWPL</a>(*ppvwpl);
03955                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; <span class="comment">// callers require FALSE this case</span>
03956             }
03957         }
03958 
03959         <span class="keywordflow">if</span> (pvwpl-&gt;cPwnd &gt;= pvwpl-&gt;cElem ) {
03960             <span class="comment">/*</span>
03961 <span class="comment">             *  didn't find it already there, and no space so grow the VWPL</span>
03962 <span class="comment">             */</span>
03963             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;
03964             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSizeNew;
03965 
03966             dwSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d2/structVWPL.html">VWPL</a>) + (<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>) * pvwpl-&gt;cElem);
03967             dwSizeNew = dwSize + (<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>) * pvwpl-&gt;cThreshhold);
03968             pvwpl = (<a class="code" href="../../d1/d0/inc_2user_8h.html#a1031">PVWPL</a>)UserReAllocPool(pvwpl, dwSize, dwSizeNew, TAG_VWPL);
03969             <span class="keywordflow">if</span> (pvwpl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03970                 RIPMSG2(RIP_WARNING,
03971                         <span class="stringliteral">"VWPLAdd fail to reallocate %lx to %lx"</span>, dwSize, dwSizeNew);
03972                 <a class="code" href="../../d4/d5/rare_8c.html#a8">DbgCheckVWPL</a>(*ppvwpl);
03973                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03974             }
03975 <span class="preprocessor">#if ZERO_INIT_VWPL</span>
03976 <span class="preprocessor"></span>            RtlZeroMemory(&amp;(pvwpl-&gt;aPwnd[pvwpl-&gt;cPwnd]), (<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>) * dwThreshhold));
03977 <span class="preprocessor">#endif</span>
03978 <span class="preprocessor"></span>            pvwpl-&gt;cElem += pvwpl-&gt;cThreshhold;
03979             *ppvwpl = pvwpl;
03980         }
03981     }
03982 
03983 AddPwnd:
03984     ixPwnd = pvwpl-&gt;cPwnd;
03985     pvwpl-&gt;aPwnd[ixPwnd] = pwnd;
03986     pvwpl-&gt;cPwnd++;
03987     <a class="code" href="../../d4/d5/rare_8c.html#a8">DbgCheckVWPL</a>(*ppvwpl);
03988     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03989 }
03990 
03991 <span class="comment">/*****************************************************************************\</span>
03992 <span class="comment">* VWPLRemove</span>
03993 <span class="comment">*</span>
03994 <span class="comment">* Removes a pwnd from a VWPL list of pwnds.</span>
03995 <span class="comment">* Reallocates memory as required.</span>
03996 <span class="comment">*</span>
03997 <span class="comment">* Returns FALSE if the pwnd was not found</span>
03998 <span class="comment">*</span>
03999 <span class="comment">* History:</span>
04000 <span class="comment">* 98-01-30 IanJa   Created.</span>
04001 <span class="comment">\*****************************************************************************/</span>
<a name="l04002"></a><a class="code" href="../../d4/d1/userk_8h.html#a1871">04002</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1871">VWPLRemove</a>(
04003     PVWPL *ppvwpl,
04004     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
04005 {
04006     <a class="code" href="../../d1/d0/inc_2user_8h.html#a1031">PVWPL</a> pvwpl = *ppvwpl;
04007     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ixPwnd;
04008 
04009     TAGMSG2(DBGTAG_VWPL, <span class="stringliteral">"VWPL %#p - %#p"</span>, *ppvwpl, pwnd);
04010     UserAssert(pwnd);
04011 
04012     <span class="keywordflow">if</span> (!pvwpl) {
04013         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04014     }
04015     <span class="keywordflow">for</span> (ixPwnd = 0; ixPwnd &lt; pvwpl-&gt;cElem; ixPwnd++) {
04016         <span class="keywordflow">if</span> (pwnd == pvwpl-&gt;aPwnd[ixPwnd]) {
04017             <span class="keywordflow">goto</span> PwndIsFound;
04018         }
04019     }
04020     <a class="code" href="../../d4/d5/rare_8c.html#a8">DbgCheckVWPL</a>(*ppvwpl);
04021     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04022 
04023 PwndIsFound:
04024     pvwpl-&gt;aPwnd[ixPwnd] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04025     pvwpl-&gt;cPwnd--;
04026 
04027     <span class="keywordflow">if</span> (pvwpl-&gt;cPwnd == 0) {
04028         UserFreePool(pvwpl);
04029         *ppvwpl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04030         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04031     }
04032 
04033     <span class="comment">/*</span>
04034 <span class="comment">     * Compact the VWPL to keep all the empty slots at the end.</span>
04035 <span class="comment">     * If these free slots exceeds the threshhold, realloc to shrink.</span>
04036 <span class="comment">     * It doesn't matter that we change the order.</span>
04037 <span class="comment">     */</span>
04038     pvwpl-&gt;aPwnd[ixPwnd] = pvwpl-&gt;aPwnd[pvwpl-&gt;cPwnd];
04039 <span class="preprocessor">#if ZERO_INIT_VWPL</span>
04040 <span class="preprocessor"></span>    pvwpl-&gt;aPwnd[pvwpl-&gt;cPwnd] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04041 <span class="preprocessor">#endif</span>
04042 <span class="preprocessor"></span>
04043 
04044     <span class="keywordflow">if</span> ((pvwpl-&gt;cElem - pvwpl-&gt;cPwnd) &gt;= pvwpl-&gt;cThreshhold) {
04045         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;
04046         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSizeNew;
04047 
04048         <span class="comment">// Low memory may have made a shrinking realloc fail, which doesn't</span>
04049         <span class="comment">// really bother us.</span>
04050         <span class="comment">// UserAssert((pvwpl-&gt;cElem - pvwpl-&gt;cPwnd) == pvwpl-&gt;cThreshhold);</span>
04051 
04052         dwSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d2/structVWPL.html">VWPL</a>) + (<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>) * pvwpl-&gt;cElem);
04053         dwSizeNew = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d2/structVWPL.html">VWPL</a>) + (<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>) * pvwpl-&gt;cPwnd);
04054         pvwpl = (<a class="code" href="../../d1/d0/inc_2user_8h.html#a1031">PVWPL</a>)UserReAllocPool(pvwpl, dwSize, dwSizeNew, TAG_VWPL);
04055         <span class="keywordflow">if</span> (pvwpl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04056             RIPMSG2(RIP_WARNING,
04057                     <span class="stringliteral">"VWPLRemove fail to reallocate %lx to %lx"</span>,
04058                     dwSize, dwSizeNew);
04059             <a class="code" href="../../d4/d5/rare_8c.html#a8">DbgCheckVWPL</a>(*ppvwpl);
04060             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04061         }
04062         pvwpl-&gt;cElem = pvwpl-&gt;cPwnd;
04063         *ppvwpl = pvwpl;
04064     }
04065 
04066     <a class="code" href="../../d4/d5/rare_8c.html#a8">DbgCheckVWPL</a>(*ppvwpl);
04067     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04068 }
04069 
04070 <span class="comment">/*****************************************************************************\</span>
04071 <span class="comment">* VWPLNext</span>
04072 <span class="comment">*</span>
04073 <span class="comment">* Returns the next pwnd from a VWPL (Volatile Window Pointer List).</span>
04074 <span class="comment">*</span>
04075 <span class="comment">* Setting *pnPrev to 0 will return the first pwnd in the VWPL, and gets a new</span>
04076 <span class="comment">* value in *pnPrev which is to be used in a subsequent call to VWPLNext to</span>
04077 <span class="comment">* obtain the next pwnd.</span>
04078 <span class="comment">* Returns NULL when the last pwnd has been obtained, and sets *pnPrev back to 0</span>
04079 <span class="comment">*</span>
04080 <span class="comment">* History:</span>
04081 <span class="comment">* 98-01-30 IanJa   Created.</span>
04082 <span class="comment">\*****************************************************************************/</span>
<a name="l04083"></a><a class="code" href="../../d4/d1/userk_8h.html#a1872">04083</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1872">VWPLNext</a>(PVWPL pvwpl, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndPrev, DWORD *pnPrev)
04084 {
04085     <a class="code" href="../../d4/d5/rare_8c.html#a8">DbgCheckVWPL</a>(pvwpl);
04086 
04087     <span class="keywordflow">if</span> (!pvwpl) {
04088         TAGMSG1(DBGTAG_VWPL, <span class="stringliteral">"VWPL %#p =&gt; NULL (empty)"</span>, pvwpl);
04089         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04090     }
04091 
04092     <span class="keywordflow">if</span> (*pnPrev &gt;= pvwpl-&gt;cPwnd) {
04093         <span class="keywordflow">goto</span> NoMorePwnds;
04094     }
04095 
04096     <span class="comment">/*</span>
04097 <span class="comment">     * If our previous pwnd is still there, advance to the next slot</span>
04098 <span class="comment">     * (else it has gone, so return the one now occupying its slot)</span>
04099 <span class="comment">     */</span>
04100     <span class="keywordflow">if</span> (pvwpl-&gt;aPwnd[*pnPrev] == pwndPrev) {
04101         (*pnPrev)++;
04102     }
04103 
04104     <span class="keywordflow">if</span> (*pnPrev &lt; pvwpl-&gt;cPwnd) {
04105         UserAssert(pvwpl-&gt;aPwnd[*pnPrev] != pwndPrev);
04106         TAGMSG2(DBGTAG_VWPL, <span class="stringliteral">"VWPL %#p =&gt; %#p"</span>, pvwpl, pvwpl-&gt;aPwnd[*pnPrev]);
04107         <span class="keywordflow">return</span> pvwpl-&gt;aPwnd[*pnPrev];
04108     }
04109 
04110     <span class="comment">/*</span>
04111 <span class="comment">     * We came to the end</span>
04112 <span class="comment">     */</span>
04113 NoMorePwnds:
04114     TAGMSG1(DBGTAG_VWPL, <span class="stringliteral">"VWPL %#p =&gt; NULL (end)"</span>, pvwpl);
04115     *pnPrev = 0;
04116     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04117 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
