<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: prefxsup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>prefxsup.c File Reference</h1><code>#include "UdfProcs.h"</code><br>

<p>
<a href="../../d6/d3/prefxsup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/prefxsup_8c.html#a0">BugCheckFileId</a>&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_PREFXSUP)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/prefxsup_8c.html#a1">Dbg</a>&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_READ)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/prefxsup_8c.html#a2">UdfFindNameLink</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN PRTL_SPLAY_LINKS *RootNode, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/prefxsup_8c.html#a3">UdfInsertNameLink</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN PRTL_SPLAY_LINKS *RootNode, IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> NameLink)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/prefxsup_8c.html#a4">UdfInsertPrefix</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN BOOLEAN ShortNameMatch, IN BOOLEAN IgnoreCase, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> ParentFcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/prefxsup_8c.html#a5">UdfRemovePrefix</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/prefxsup_8c.html#a6">UdfFindPrefix</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *CurrentFcb, IN OUT PUNICODE_STRING RemainingName, IN BOOLEAN IgnoreCase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/prefxsup_8c.html#a7">UdfInitializeLcbFromDirContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb, IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="prefxsup.c::BugCheckFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BugCheckFileId&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_PREFXSUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00027">27</a> of file <a class="el" href="../../d6/d3/prefxsup_8c-source.html">prefxsup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="prefxsup.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_READ)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00033">33</a> of file <a class="el" href="../../d6/d3/prefxsup_8c-source.html">prefxsup.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="prefxsup.c::UdfFindNameLink" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> UdfFindNameLink           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PRTL_SPLAY_LINKS *&nbsp;</td>
          <td class="mdname" nowrap> <em>RootNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00557">557</a> of file <a class="el" href="../../d6/d3/prefxsup_8c-source.html">prefxsup.c</a>.
<p>
References <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00810">_LCB::FileName</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a70">FSRTL_COMPARISON_RESULT</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a89">LessThan</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00051">RtlSplay()</a>, and <a class="el" href="../../d6/d4/namesup_8c-source.html#l01274">UdfFullCompareNames()</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00324">UdfFindPrefix()</a>, and <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00064">UdfInsertPrefix()</a>.
<p>
<pre class="fragment"><div>00565                    :
00566 
00567     This routine searches through a splay link tree looking <span class="keywordflow">for</span> a match <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00568     input name.  If we find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding name we will rebalance <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00569     tree.
00570 
00571 Arguments:
00572 
00573     RootNode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent to search.
00574 
00575     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name to search <span class="keywordflow">for</span>.  Note <span class="keywordflow">if</span> we are doing a <span class="keywordflow">case</span>
00576         insensitive search <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name would have been upcased already.
00577 
00578 Return Value:
00579 
00580     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> - The name link found or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no match.
00581 
00582 --*/
00583 
00584 {
00585     <a class="code" href="../../d1/d8/fsrtl_8h.html#a70">FSRTL_COMPARISON_RESULT</a> Comparison;
00586     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Node;
00587     PRTL_SPLAY_LINKS Links;
00588 
00589     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00590 
00591     Links = *RootNode;
00592 
00593     <span class="keywordflow">while</span> (Links != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00594 
00595         Node = CONTAINING_RECORD( Links, <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a>, Links );
00596 
00597         <span class="comment">//</span>
00598         <span class="comment">//  Compare the prefix in the tree with the full name</span>
00599         <span class="comment">//</span>
00600 
00601         Comparison = <a class="code" href="../../d3/d8/udfprocs_8h.html#a185">UdfFullCompareNames</a>( IrpContext, &amp;Node-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o16">FileName</a>, Name );
00602 
00603         <span class="comment">//</span>
00604         <span class="comment">//  See if they don't match</span>
00605         <span class="comment">//</span>
00606 
00607         <span class="keywordflow">if</span> (Comparison == <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) {
00608 
00609             <span class="comment">//</span>
00610             <span class="comment">//  The prefix is greater than the full name</span>
00611             <span class="comment">//  so we go down the left child</span>
00612             <span class="comment">//</span>
00613 
00614             Links = RtlLeftChild( Links );
00615 
00616             <span class="comment">//</span>
00617             <span class="comment">//  And continue searching down this tree</span>
00618             <span class="comment">//</span>
00619 
00620         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Comparison == <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a89">LessThan</a>) {
00621 
00622             <span class="comment">//</span>
00623             <span class="comment">//  The prefix is less than the full name</span>
00624             <span class="comment">//  so we go down the right child</span>
00625             <span class="comment">//</span>
00626 
00627             Links = RtlRightChild( Links );
00628 
00629             <span class="comment">//</span>
00630             <span class="comment">//  And continue searching down this tree</span>
00631             <span class="comment">//</span>
00632 
00633         } <span class="keywordflow">else</span> {
00634 
00635             <span class="comment">//</span>
00636             <span class="comment">//  We found it.</span>
00637             <span class="comment">//</span>
00638             <span class="comment">//  Splay the tree and save the new root.</span>
00639             <span class="comment">//</span>
00640 
00641             *RootNode = <a class="code" href="../../d3/d4/splay_8c.html#a3">RtlSplay</a>( Links );
00642 
00643             <span class="keywordflow">return</span> Node;
00644         }
00645     }
00646 
00647     <span class="comment">//</span>
00648     <span class="comment">//  We didn't find the Link.</span>
00649     <span class="comment">//</span>
00650 
00651     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00652 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="prefxsup.c::UdfFindPrefix" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> UdfFindPrefix           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentFcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreCase</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00324">324</a> of file <a class="el" href="../../d6/d3/prefxsup_8c-source.html">prefxsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00367">ASSERT_EXCLUSIVE_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00338">ASSERT_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00063">SafeNodeType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01542">UdfAcquireFcbExclusive</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00096">UdfDissectName()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00557">UdfFindNameLink()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01548">UdfReleaseFcb</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00037">UDFS_NTC_FCB_INDEX</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>.
<p>
<pre class="fragment"><div>00333                    :
00334 
00335     This routine begins from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given CurrentFcb and walks through all of
00336     components of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name looking <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> longest match in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prefix
00337     splay trees.  The search <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relative to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting Fcb so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00338     full name may not begin with a <span class="charliteral">'\'</span>.  On <span class="keywordflow">return</span> <span class="keyword">this</span> routine will
00339     update Current Fcb with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest point <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> has travelled in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00340     tree.  It will also hold <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> that resource on <span class="keywordflow">return</span> and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must
00341     hold that resource.
00342 
00343 Arguments:
00344 
00345     CurrentFcb - Address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest Fcb we find on <span class="keyword">this</span> search.
00346         On <span class="keywordflow">return</span> we will have acquired <span class="keyword">this</span> Fcb.  On entry <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00347         Fcb to examine.
00348         
00349     RemainingName - Supplies a buffer to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exact <span class="keywordflow">case</span> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name being
00350         searched <span class="keywordflow">for</span>.  Initially will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d6/nlsboot_8c.html#a0">upcase</a> name based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00351         IgnoreCase flag.
00352 
00353     IgnoreCase - Indicates <span class="keywordflow">if</span> we are doing a <span class="keywordflow">case</span>-insensitive compare.
00354 
00355 Return Value:
00356 
00357     The Lcb used to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current Fcb, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> we didn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> find any prefix
00358     Fcbs.
00359 
00360 --*/
00361 
00362 {
00363     UNICODE_STRING LocalRemainingName;
00364     UNICODE_STRING FinalName;
00365 
00366     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> NameLink;
00367     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> CurrentLcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00368 
00369     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00370 
00371     <span class="comment">//</span>
00372     <span class="comment">//  Check inputs.</span>
00373     <span class="comment">//</span>
00374 
00375     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00376     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( *CurrentFcb );
00377     <a class="code" href="../../d1/d8/udfdata_8h.html#a43">ASSERT_EXCLUSIVE_FCB</a>( *CurrentFcb );
00378 
00379     <span class="comment">//</span>
00380     <span class="comment">//  Make a local copy of the input strings.</span>
00381     <span class="comment">//</span>
00382 
00383     LocalRemainingName = *RemainingName;
00384 
00385     <span class="comment">//</span>
00386     <span class="comment">//  Loop until we find the longest matching prefix.</span>
00387     <span class="comment">//</span>
00388 
00389     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00390 
00391         <span class="comment">//</span>
00392         <span class="comment">//  If there are no characters left or we are not at an IndexFcb then</span>
00393         <span class="comment">//  return immediately.</span>
00394         <span class="comment">//</span>
00395 
00396         <span class="keywordflow">if</span> ((LocalRemainingName.Length == 0) ||
00397             (<a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( *CurrentFcb ) != <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a3">UDFS_NTC_FCB_INDEX</a>)) {
00398 
00399             <span class="keywordflow">return</span> CurrentLcb;
00400         }
00401 
00402         <span class="comment">//</span>
00403         <span class="comment">//  Split off the next component from the name.</span>
00404         <span class="comment">//</span>
00405 
00406         <a class="code" href="../../d3/d8/udfprocs_8h.html#a177">UdfDissectName</a>( IrpContext,
00407                         &amp;LocalRemainingName,
00408                         &amp;FinalName );
00409 
00410         <span class="comment">//</span>
00411         <span class="comment">//  Check if this name is in the splay tree for this Scb.</span>
00412         <span class="comment">//</span>
00413 
00414         <span class="keywordflow">if</span> (IgnoreCase) {
00415 
00416             NameLink = <a class="code" href="../../d5/d4/prefxsup_8c.html#a2">UdfFindNameLink</a>( IrpContext,
00417                                         &amp;(*CurrentFcb)-&gt;IgnoreCaseRoot,
00418                                         &amp;FinalName );
00419 
00420         } <span class="keywordflow">else</span> {
00421 
00422             NameLink = <a class="code" href="../../d5/d4/prefxsup_8c.html#a2">UdfFindNameLink</a>( IrpContext,
00423                                         &amp;(*CurrentFcb)-&gt;ExactCaseRoot,
00424                                         &amp;FinalName );
00425         }
00426 
00427         <span class="comment">//</span>
00428         <span class="comment">//  If we didn't find a match then exit.</span>
00429         <span class="comment">//</span>
00430 
00431         <span class="keywordflow">if</span> (NameLink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) { 
00432 
00433             <span class="keywordflow">break</span>;
00434         }
00435 
00436         CurrentLcb = NameLink;
00437 
00438         <span class="comment">//</span>
00439         <span class="comment">//  If this is a case-insensitive match then copy the exact case of the name into</span>
00440         <span class="comment">//  the input buffer.</span>
00441         <span class="comment">//</span>
00442 
00443         <span class="keywordflow">if</span> (IgnoreCase) {
00444 
00445             RtlCopyMemory( FinalName.Buffer,
00446                            NameLink-&gt;FileName.Buffer,
00447                            NameLink-&gt;FileName.Length );
00448         }
00449 
00450         <span class="comment">//</span>
00451         <span class="comment">//  Update the caller's remaining name string to reflect the fact that we found</span>
00452         <span class="comment">//  a match.</span>
00453         <span class="comment">//</span>
00454 
00455         *RemainingName = LocalRemainingName;
00456 
00457         <span class="comment">//</span>
00458         <span class="comment">//  Move down to the next component in the tree.  Acquire without waiting.</span>
00459         <span class="comment">//  If this fails then lock the Fcb to reference this Fcb and then drop</span>
00460         <span class="comment">//  the parent and acquire the child.</span>
00461         <span class="comment">//</span>
00462 
00463         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( NameLink-&gt;ParentFcb == *CurrentFcb );
00464 
00465         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NameLink-&gt;ChildFcb, TRUE )) {
00466 
00467             <span class="comment">//</span>
00468             <span class="comment">//  If we can't wait then raise CANT_WAIT.</span>
00469             <span class="comment">//</span>
00470 
00471             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
00472 
00473                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
00474             }
00475 
00476             <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, IrpContext-&gt;Vcb );
00477             NameLink-&gt;ChildFcb-&gt;FcbReference += 1;
00478             NameLink-&gt;Reference += 1;
00479             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, IrpContext-&gt;Vcb );
00480 
00481             <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, *CurrentFcb );
00482             <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NameLink-&gt;ChildFcb, FALSE );
00483 
00484             <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, IrpContext-&gt;Vcb );
00485             NameLink-&gt;ChildFcb-&gt;FcbReference -= 1;
00486             NameLink-&gt;Reference -= 1;
00487             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, IrpContext-&gt;Vcb );
00488 
00489         } <span class="keywordflow">else</span> {
00490 
00491             <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, *CurrentFcb );
00492         }
00493 
00494         *CurrentFcb = NameLink-&gt;ChildFcb;
00495     }
00496 
00497     <span class="keywordflow">return</span> CurrentLcb;
00498 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="prefxsup.c::UdfInitializeLcbFromDirContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfInitializeLcbFromDirContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DirContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00503">503</a> of file <a class="el" href="../../d6/d3/prefxsup_8c-source.html">prefxsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00350">ASSERT_LCB</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00810">NSR_FID_F_HIDDEN</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a113">PDIR_ENUM_CONTEXT</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>.
<p>
<pre class="fragment"><div>00511                    :
00512 
00513     This routine performs common initialization of Lcbs from found directory
00514     entries.
00515 
00516 Arguments:
00517 
00518     Lcb - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lcb to initialize.
00519     
00520     DirContext - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory enumeration context, enumerated to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FID associated
00521         with <span class="keyword">this</span> Lcb.
00522     
00523 Return Value:
00524 
00525     None.
00526 
00527 --*/
00528 
00529 {
00530     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00531 
00532     <span class="comment">//</span>
00533     <span class="comment">//  Check inputs.</span>
00534     <span class="comment">//</span>
00535 
00536     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00537     <a class="code" href="../../d1/d8/udfdata_8h.html#a26">ASSERT_LCB</a>( Lcb );
00538 
00539     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( DirContext-&gt;Fid != NULL );
00540 
00541     <span class="comment">//</span>
00542     <span class="comment">//  This is falling down trivial now.  Simply update the hidden flag in the Lcb.</span>
00543     <span class="comment">//</span>
00544 
00545     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Fid-&gt;Flags, NSR_FID_F_HIDDEN )) {
00546 
00547         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lcb-&gt;FileAttributes, FILE_ATTRIBUTE_HIDDEN );
00548     }
00549 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="prefxsup.c::UdfInsertNameLink" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfInsertNameLink           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PRTL_SPLAY_LINKS *&nbsp;</td>
          <td class="mdname" nowrap> <em>RootNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NameLink</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00660">660</a> of file <a class="el" href="../../d6/d3/prefxsup_8c-source.html">prefxsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00810">_LCB::FileName</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a70">FSRTL_COMPARISON_RESULT</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00804">_LCB::Links</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d4/namesup_8c-source.html#l01274">UdfFullCompareNames()</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00064">UdfInsertPrefix()</a>.
<p>
<pre class="fragment"><div>00668                    :
00669 
00670     This routine will insert a name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> splay tree pointed to
00671     by RootNode.
00672 
00673 Arguments:
00674 
00675     RootNode - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table.
00676 
00677     NameLink - Contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> link to enter.
00678 
00679 Return Value:
00680 
00681     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> inserted, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00682 
00683 --*/
00684 
00685 {
00686     <a class="code" href="../../d1/d8/fsrtl_8h.html#a70">FSRTL_COMPARISON_RESULT</a> Comparison;
00687     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Node;
00688 
00689     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00690 
00691     <span class="comment">//</span>
00692     <span class="comment">//  Check inputs.</span>
00693     <span class="comment">//</span>
00694 
00695     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00696 
00697     RtlInitializeSplayLinks( &amp;NameLink-&gt;Links );
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">//  If we are the first entry in the tree, just become the root.</span>
00701     <span class="comment">//</span>
00702 
00703     <span class="keywordflow">if</span> (*RootNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00704 
00705         *RootNode = &amp;NameLink-&gt;Links;
00706 
00707         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00708     }
00709 
00710     Node = CONTAINING_RECORD( *RootNode, <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a>, Links );
00711 
00712     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00713 
00714         <span class="comment">//</span>
00715         <span class="comment">//  Compare the prefix in the tree with the prefix we want</span>
00716         <span class="comment">//  to insert.</span>
00717         <span class="comment">//</span>
00718 
00719         Comparison = <a class="code" href="../../d3/d8/udfprocs_8h.html#a185">UdfFullCompareNames</a>( IrpContext, &amp;Node-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o16">FileName</a>, &amp;NameLink-&gt;FileName );
00720 
00721         <span class="comment">//</span>
00722         <span class="comment">//  If we found the entry, return immediately.</span>
00723         <span class="comment">//</span>
00724 
00725         <span class="keywordflow">if</span> (Comparison == <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a>) { <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; }
00726 
00727         <span class="comment">//</span>
00728         <span class="comment">//  If the tree prefix is greater than the new prefix then</span>
00729         <span class="comment">//  we go down the left subtree</span>
00730         <span class="comment">//</span>
00731 
00732         <span class="keywordflow">if</span> (Comparison == <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) {
00733 
00734             <span class="comment">//</span>
00735             <span class="comment">//  We want to go down the left subtree, first check to see</span>
00736             <span class="comment">//  if we have a left subtree</span>
00737             <span class="comment">//</span>
00738 
00739             <span class="keywordflow">if</span> (RtlLeftChild( &amp;Node-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o15">Links</a> ) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00740 
00741                 <span class="comment">//</span>
00742                 <span class="comment">//  there isn't a left child so we insert ourselves as the</span>
00743                 <span class="comment">//  new left child</span>
00744                 <span class="comment">//</span>
00745 
00746                 RtlInsertAsLeftChild( &amp;Node-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o15">Links</a>, &amp;NameLink-&gt;Links );
00747 
00748                 <span class="comment">//</span>
00749                 <span class="comment">//  and exit the while loop</span>
00750                 <span class="comment">//</span>
00751 
00752                 <span class="keywordflow">break</span>;
00753 
00754             } <span class="keywordflow">else</span> {
00755 
00756                 <span class="comment">//</span>
00757                 <span class="comment">//  there is a left child so simply go down that path, and</span>
00758                 <span class="comment">//  go back to the top of the loop</span>
00759                 <span class="comment">//</span>
00760 
00761                 Node = CONTAINING_RECORD( RtlLeftChild( &amp;Node-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o15">Links</a> ),
00762                                           <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a>,
00763                                           Links );
00764             }
00765 
00766         } <span class="keywordflow">else</span> {
00767 
00768             <span class="comment">//</span>
00769             <span class="comment">//  The tree prefix is either less than or a proper prefix</span>
00770             <span class="comment">//  of the new string.  We treat both cases as less than when</span>
00771             <span class="comment">//  we do insert.  So we want to go down the right subtree,</span>
00772             <span class="comment">//  first check to see if we have a right subtree</span>
00773             <span class="comment">//</span>
00774 
00775             <span class="keywordflow">if</span> (RtlRightChild( &amp;Node-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o15">Links</a> ) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00776 
00777                 <span class="comment">//</span>
00778                 <span class="comment">//  These isn't a right child so we insert ourselves as the</span>
00779                 <span class="comment">//  new right child</span>
00780                 <span class="comment">//</span>
00781 
00782                 RtlInsertAsRightChild( &amp;Node-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o15">Links</a>, &amp;NameLink-&gt;Links );
00783 
00784                 <span class="comment">//</span>
00785                 <span class="comment">//  and exit the while loop</span>
00786                 <span class="comment">//</span>
00787 
00788                 <span class="keywordflow">break</span>;
00789 
00790             } <span class="keywordflow">else</span> {
00791 
00792                 <span class="comment">//</span>
00793                 <span class="comment">//  there is a right child so simply go down that path, and</span>
00794                 <span class="comment">//  go back to the top of the loop</span>
00795                 <span class="comment">//</span>
00796 
00797                 Node = CONTAINING_RECORD( RtlRightChild( &amp;Node-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o15">Links</a> ),
00798                                           <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a>,
00799                                           Links );
00800             }
00801         }
00802     }
00803 
00804     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00805 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="prefxsup.c::UdfInsertPrefix" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> UdfInsertPrefix           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ShortNameMatch</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreCase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentFcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00064">64</a> of file <a class="el" href="../../d6/d3/prefxsup_8c-source.html">prefxsup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00367">ASSERT_EXCLUSIVE_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00338">ASSERT_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00342">ASSERT_FCB_INDEX</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00778">_LCB::ChildFcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00777">_LCB::ChildFcbLinks</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00906">ExAllocateFromPagedLookasideList()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00798">_LCB::FileAttributes</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00810">_LCB::FileName</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00790">_LCB::Flags</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01101">FsRtlAllocatePoolWithTag</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00814">LCB_FLAG_IGNORE_CASE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00816">LCB_FLAG_POOL_ALLOCATED</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00815">LCB_FLAG_SHORT_NAME</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00762">_LCB::NodeByteSize</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00761">_LCB::NodeTypeCode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00770">_LCB::ParentFcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00769">_LCB::ParentFcbLinks</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00784">_LCB::Reference</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00063">SafeNodeType</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00822">SIZEOF_LOOKASIDE_LCB</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00171">TAG_LCB</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00557">UdfFindNameLink()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">UdfFreePool()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00660">UdfInsertNameLink()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00196">UdfLcbLookasideList</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00443">UdfPagedPool</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00037">UDFS_NTC_FCB_INDEX</a>, and <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00043">UDFS_NTC_LCB</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>.
<p>
<pre class="fragment"><div>00075                    :
00076 
00077     This routine inserts an Lcb linking <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two Fcbs together.
00078 
00079 Arguments:
00080 
00081     Fcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb whose name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being inserted into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree.
00082 
00083     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> component.
00084     
00085     ShortNameMatch - Indicates whether <span class="keyword">this</span> name was found on an <span class="keyword">explicit</span> 8.3 search
00086 
00087     IgnoreCase - Indicates <span class="keywordflow">if</span> we should insert into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span>-insensitive tree.
00088 
00089     ParentFcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ParentFcb.  The prefix tree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> attached to <span class="keyword">this</span>.
00090 
00091 Return Value:
00092 
00093     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lcb inserted.
00094 
00095 --*/
00096 
00097 {
00098     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb;
00099     PRTL_SPLAY_LINKS *TreeRoot;
00100     PLIST_ENTRY ListLinks;
00101     ULONG Flags;
00102 
00103     PWCHAR NameBuffer;
00104 
00105     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00106 
00107     <span class="comment">//</span>
00108     <span class="comment">//  Check inputs.</span>
00109     <span class="comment">//</span>
00110 
00111     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00112     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( Fcb );
00113 
00114     <a class="code" href="../../d1/d8/udfdata_8h.html#a43">ASSERT_EXCLUSIVE_FCB</a>( Fcb );
00115     <a class="code" href="../../d1/d8/udfdata_8h.html#a43">ASSERT_EXCLUSIVE_FCB</a>( ParentFcb );
00116     <a class="code" href="../../d1/d8/udfdata_8h.html#a18">ASSERT_FCB_INDEX</a>( ParentFcb );
00117 
00118     <span class="comment">//</span>
00119     <span class="comment">//  It must be the case that an index Fcb is only referenced by a single index.  Now</span>
00120     <span class="comment">//  we walk the child's Lcb queue to insure that if any prefixes have already been</span>
00121     <span class="comment">//  inserted, they all refer to the index Fcb we are linking to.  This is the only way</span>
00122     <span class="comment">//  we can detect directory cross-linkage.</span>
00123     <span class="comment">//</span>
00124 
00125     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( Fcb ) == <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a3">UDFS_NTC_FCB_INDEX</a>) {
00126 
00127         <span class="keywordflow">for</span> (ListLinks = Fcb-&gt;ParentLcbQueue.Flink;
00128              ListLinks != &amp;Fcb-&gt;ParentLcbQueue;
00129              ListLinks = ListLinks-&gt;Flink) {
00130 
00131             Lcb = CONTAINING_RECORD( ListLinks, <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a>, ChildFcbLinks );
00132 
00133             <span class="keywordflow">if</span> (Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o9">ParentFcb</a> != ParentFcb) {
00134 
00135                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_DISK_CORRUPT_ERROR );
00136             }
00137         }
00138     }
00139     
00140     <span class="comment">//</span>
00141     <span class="comment">//  Capture the separate cases.</span>
00142     <span class="comment">//</span>
00143 
00144     <span class="keywordflow">if</span> (IgnoreCase) {
00145 
00146         TreeRoot = &amp;ParentFcb-&gt;IgnoreCaseRoot;
00147         Flags = <a class="code" href="../../d6/d8/udfstruc_8h.html#a9">LCB_FLAG_IGNORE_CASE</a>;
00148 
00149     } <span class="keywordflow">else</span> {
00150 
00151         TreeRoot = &amp;ParentFcb-&gt;ExactCaseRoot;
00152         Flags = 0;
00153     }
00154 
00155     <span class="keywordflow">if</span> (ShortNameMatch) {
00156 
00157         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Flags, LCB_FLAG_SHORT_NAME );
00158     }
00159 
00160     <span class="comment">//</span>
00161     <span class="comment">//  Allocate space for the Lcb.</span>
00162     <span class="comment">//</span>
00163 
00164     <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ) + <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length &gt; <a class="code" href="../../d6/d8/udfstruc_8h.html#a12">SIZEOF_LOOKASIDE_LCB</a> ) {
00165     
00166         Lcb = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( UdfPagedPool,
00167                                         <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ) + <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length,
00168                                         TAG_LCB );
00169 
00170         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Flags, LCB_FLAG_POOL_ALLOCATED );
00171 
00172     } <span class="keywordflow">else</span> {
00173 
00174         Lcb = <a class="code" href="../../d5/d8/ex_8h.html#a252">ExAllocateFromPagedLookasideList</a>( &amp;UdfLcbLookasideList );
00175     }
00176 
00177     <span class="comment">//</span>
00178     <span class="comment">//  Set the type and size.</span>
00179     <span class="comment">//</span>
00180 
00181     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o0">NodeTypeCode</a> = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a9">UDFS_NTC_LCB</a>;
00182     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o1">NodeByteSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ) + <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length;
00183 
00184     <span class="comment">//</span>
00185     <span class="comment">//  Initialize the name-based file attributes.</span>
00186     <span class="comment">//</span>
00187     
00188     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o14">FileAttributes</a> = 0;
00189     
00190     <span class="comment">//</span>
00191     <span class="comment">//  Set up the filename in the Lcb.</span>
00192     <span class="comment">//</span>
00193 
00194     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o16">FileName</a>.Length =
00195     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o16">FileName</a>.MaximumLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length;
00196 
00197     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o16">FileName</a>.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lcb, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ), PWCHAR );
00198 
00199     RtlCopyMemory( Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o16">FileName</a>.Buffer,
00200                    <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer,
00201                    <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length );
00202     
00203     <span class="comment">//</span>
00204     <span class="comment">//  Insert the Lcb into the prefix tree.</span>
00205     <span class="comment">//</span>
00206     
00207     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o13">Flags</a> = Flags;
00208     
00209     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d4/prefxsup_8c.html#a3">UdfInsertNameLink</a>( IrpContext,
00210                             TreeRoot,
00211                             Lcb )) {
00212 
00213         <span class="comment">//</span>
00214         <span class="comment">//  This will very rarely occur.</span>
00215         <span class="comment">//</span>
00216 
00217         <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;Lcb );
00218 
00219         Lcb = <a class="code" href="../../d5/d4/prefxsup_8c.html#a2">UdfFindNameLink</a>( IrpContext,
00220                                TreeRoot,
00221                                Name );
00222 
00223         <span class="keywordflow">if</span> (Lcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00224 
00225             <span class="comment">//</span>
00226             <span class="comment">//  Even worse.</span>
00227             <span class="comment">//</span>
00228 
00229             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_DRIVER_INTERNAL_ERROR );
00230         }
00231 
00232         <span class="keywordflow">return</span> Lcb;
00233     }
00234 
00235     <span class="comment">//</span>
00236     <span class="comment">//  Link the Fcbs together through the Lcb.</span>
00237     <span class="comment">//</span>
00238 
00239     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o9">ParentFcb</a> = ParentFcb;
00240     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o11">ChildFcb</a> = Fcb;
00241 
00242     InsertHeadList( &amp;ParentFcb-&gt;ChildLcbQueue, &amp;Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o8">ParentFcbLinks</a> );
00243     InsertHeadList( &amp;Fcb-&gt;ParentLcbQueue, &amp;Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o10">ChildFcbLinks</a> );
00244 
00245     <span class="comment">//</span>
00246     <span class="comment">//  Initialize the reference count.</span>
00247     <span class="comment">//</span>
00248 
00249     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o12">Reference</a> = 0;
00250     
00251     <span class="keywordflow">return</span> Lcb;
00252 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="prefxsup.c::UdfRemovePrefix" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfRemovePrefix           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00256">256</a> of file <a class="el" href="../../d6/d3/prefxsup_8c-source.html">prefxsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00366">ASSERT_EXCLUSIVE_FCB_OR_VCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00350">ASSERT_LCB</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00947">ExFreeToPagedLookasideList()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00814">LCB_FLAG_IGNORE_CASE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00816">LCB_FLAG_POOL_ALLOCATED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00385">RtlDelete()</a>, and <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00196">UdfLcbLookasideList</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>.
<p>
<pre class="fragment"><div>00263                    :
00264 
00265     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to remove a given prefix of an Fcb.
00266 
00267 Arguments:
00268 
00269     Lcb - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prefix being removed.
00270 
00271 Return Value:
00272 
00273     None
00274 
00275 --*/
00276 
00277 {
00278     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00279 
00280     <span class="comment">//</span>
00281     <span class="comment">//  Check inputs.</span>
00282     <span class="comment">//</span>
00283 
00284     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00285     <a class="code" href="../../d1/d8/udfdata_8h.html#a26">ASSERT_LCB</a>( Lcb );
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">//  Check the acquisition of the two Fcbs.</span>
00289     <span class="comment">//</span>
00290 
00291     <a class="code" href="../../d1/d8/udfdata_8h.html#a42">ASSERT_EXCLUSIVE_FCB_OR_VCB</a>( Lcb-&gt;ParentFcb );
00292     <a class="code" href="../../d1/d8/udfdata_8h.html#a42">ASSERT_EXCLUSIVE_FCB_OR_VCB</a>( Lcb-&gt;ChildFcb );
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">//  Now remove the linkage and delete the Lcb.</span>
00296     <span class="comment">//</span>
00297     
00298     RemoveEntryList( &amp;Lcb-&gt;ParentFcbLinks );
00299     RemoveEntryList( &amp;Lcb-&gt;ChildFcbLinks );
00300 
00301     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lcb-&gt;Flags, LCB_FLAG_IGNORE_CASE )) {
00302 
00303         Lcb-&gt;ParentFcb-&gt;IgnoreCaseRoot = <a class="code" href="../../d3/d4/splay_8c.html#a4">RtlDelete</a>( &amp;Lcb-&gt;Links );
00304     
00305     } <span class="keywordflow">else</span> {
00306 
00307         Lcb-&gt;ParentFcb-&gt;ExactCaseRoot = <a class="code" href="../../d3/d4/splay_8c.html#a4">RtlDelete</a>( &amp;Lcb-&gt;Links );
00308     }
00309 
00310     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lcb-&gt;Flags, LCB_FLAG_POOL_ALLOCATED )) {
00311 
00312         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lcb );
00313 
00314     } <span class="keywordflow">else</span> {
00315 
00316         <a class="code" href="../../d5/d8/ex_8h.html#a253">ExFreeToPagedLookasideList</a>( &amp;UdfLcbLookasideList, Lcb );
00317     }
00318     
00319     <span class="keywordflow">return</span>;
00320 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:17 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
