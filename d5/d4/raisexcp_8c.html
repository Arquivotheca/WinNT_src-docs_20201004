<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: raisexcp.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>raisexcp.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d6/d3/raisexcp_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/raisexcp_8c.html#a0">KiContinuePreviousModeUser</a> (IN PCONTEXT ContextRecord, IN PKEXCEPTION_FRAME ExceptionFrame, IN PKTRAP_FRAME TrapFrame, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/raisexcp_8c.html#a1">KiContinue</a> (IN PCONTEXT ContextRecord, IN PKEXCEPTION_FRAME ExceptionFrame, IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/raisexcp_8c.html#a2">KiRaiseException</a> (IN PEXCEPTION_RECORD ExceptionRecord, IN PCONTEXT ContextRecord, IN PKEXCEPTION_FRAME ExceptionFrame, IN PKTRAP_FRAME TrapFrame, IN BOOLEAN FirstChance)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="raisexcp.c::KiContinue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KiContinue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/raisexcp_8c-source.html#l00099">99</a> of file <a class="el" href="../../d6/d3/raisexcp_8c-source.html">raisexcp.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00230">KeContextToKframes()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d3/raisexcp_8c-source.html#l00037">KiContinuePreviousModeUser()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00107                    :
00108 
00109     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to copy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context frame to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00110     specified exception and trap frames <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">continue</span> system service.
00111 
00112 Arguments:
00113 
00114     ContextRecord - Supplies a pointer to a context record.
00115 
00116     ExceptionFrame - Supplies a pointer to an exception frame.
00117 
00118     TrapFrame - Supplies a pointer to a trap frame.
00119 
00120 Return Value:
00121 
00122     STATUS_ACCESS_VIOLATION <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not readable
00123         from user mode.
00124 
00125     STATUS_DATATYPE_MISALIGNMENT <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00126         properly aligned.
00127 
00128     STATUS_SUCCESS <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> copied successfully
00129         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified exception and trap frames.
00130 
00131 --*/
00132 
00133 {
00134     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00135     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00136     KIRQL OldIrql;
00137     BOOLEAN IrqlChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00138 
00139     <span class="comment">//</span>
00140     <span class="comment">// Synchronize with other context operations.</span>
00141     <span class="comment">//</span>
00142 
00143     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00144     <span class="keywordflow">if</span> (KeGetCurrentIrql() &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
00145 
00146         <span class="comment">//</span>
00147         <span class="comment">// To support try-except and ExRaiseStatus in device driver code we</span>
00148         <span class="comment">// need to check if we are already at raised level.</span>
00149         <span class="comment">//</span>
00150 
00151         IrqlChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00152         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
00153     }
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">// Establish an exception handler and probe and capture the specified</span>
00157     <span class="comment">// context record if the previous mode is user. If the probe or copy</span>
00158     <span class="comment">// fails, then return the exception code as the function value. Else</span>
00159     <span class="comment">// copy the context record to the specified exception and trap frames,</span>
00160     <span class="comment">// and return success as the function value.</span>
00161     <span class="comment">//</span>
00162 
00163     <span class="keywordflow">try</span> {
00164 
00165         <span class="comment">//</span>
00166         <span class="comment">// Get the previous processor mode. If the previous processor mode is</span>
00167         <span class="comment">// user, then probe and copy the specified context record.</span>
00168         <span class="comment">//</span>
00169 
00170         PreviousMode = KeGetPreviousMode();
00171         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00172             <a class="code" href="../../d5/d4/raisexcp_8c.html#a0">KiContinuePreviousModeUser</a>(ContextRecord,
00173                                        ExceptionFrame,
00174                                        TrapFrame,
00175                                        PreviousMode);
00176         } <span class="keywordflow">else</span> {
00177 
00178             <span class="comment">//</span>
00179             <span class="comment">// Move information from the context record to the exception</span>
00180             <span class="comment">// and trap frames.</span>
00181             <span class="comment">//</span>
00182 
00183             <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame,
00184                                ExceptionFrame,
00185                                ContextRecord,
00186                                ContextRecord-&gt;ContextFlags,
00187                                PreviousMode);
00188         }
00189 
00190     <span class="comment">//</span>
00191     <span class="comment">// If an exception occurs during the probe or copy of the context</span>
00192     <span class="comment">// record, then always handle the exception and return the exception</span>
00193     <span class="comment">// code as the status value.</span>
00194     <span class="comment">//</span>
00195 
00196     } except(EXCEPTION_EXECUTE_HANDLER) {
00197         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00198     }
00199 
00200     <span class="keywordflow">if</span> (IrqlChanged) {
00201         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
00202     }
00203 
00204     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00205 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="raisexcp.c::KiContinuePreviousModeUser" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiContinuePreviousModeUser           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/raisexcp_8c-source.html#l00037">37</a> of file <a class="el" href="../../d6/d3/raisexcp_8c-source.html">raisexcp.c</a>.
<p>
References <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00230">KeContextToKframes()</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/raisexcp_8c-source.html#l00099">KiContinue()</a>.
<p>
<pre class="fragment"><div>00046                    :
00047 
00048     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called from <a class="code" href="../../d0/d0/ki_8h.html#a104">KiContinue</a> <span class="keywordflow">if</span> PreviousMode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00049     not <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>.   In <span class="keyword">this</span> <span class="keywordflow">case</span> a kernel mode copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 
00050     ContextRecord <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> before calling <a class="code" href="../../d4/d9/ke_8h.html#a370">KeContextToKframes</a>.
00051     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done in a seperate routine to save stack space <span class="keywordflow">for</span>
00052     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common <span class="keywordflow">case</span> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> PreviousMode == Kernel.
00053 
00054     N.B. This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called from within a <span class="keywordflow">try</span>/except block
00055     that will be used to handle errors like invalid context.
00056 
00057 Arguments:
00058 
00059 
00060     ContextRecord - Supplies a pointer to a context record.
00061 
00062     ExceptionFrame - Supplies a pointer to an exception frame.
00063 
00064     TrapFrame - Supplies a pointer to a trap frame.
00065 
00066     PreviousMode - Not <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>.
00067 
00068 Return Value:
00069 
00070     None.
00071 
00072 --*/
00073 
00074 {
00075     CONTEXT ContextRecord2;
00076 
00077     <span class="comment">//</span>
00078     <span class="comment">// Copy the context record to kernel mode space.</span>
00079     <span class="comment">//</span>
00080 
00081     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ContextRecord, <span class="keyword">sizeof</span>(CONTEXT), CONTEXT_ALIGN);
00082     RtlMoveMemory(&amp;ContextRecord2, ContextRecord, <span class="keyword">sizeof</span>(CONTEXT));
00083     ContextRecord = &amp;ContextRecord2;
00084 
00085     <span class="comment">//</span>
00086     <span class="comment">// Move information from the context record to the exception</span>
00087     <span class="comment">// and trap frames.</span>
00088     <span class="comment">//</span>
00089 
00090     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame,
00091                        ExceptionFrame,
00092                        &amp;ContextRecord2,
00093                        ContextRecord2.ContextFlags,
00094                        PreviousMode);
00095 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="raisexcp.c::KiRaiseException" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KiRaiseException           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FirstChance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/raisexcp_8c-source.html#l00208">208</a> of file <a class="el" href="../../d6/d3/raisexcp_8c-source.html">raisexcp.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00230">KeContextToKframes()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00373">KiDispatchException()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>.
<p>
<pre class="fragment"><div>00218                    :
00219 
00220     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to raise an exception. The exception can be
00221     raised as a first or second chance exception.
00222 
00223 Arguments:
00224 
00225     ExceptionRecord - Supplies a pointer to an exception record.
00226 
00227     ContextRecord - Supplies a pointer to a context record.
00228 
00229     ExceptionFrame - Supplies a pointer to an exception frame.
00230 
00231     TrapFrame - Supplies a pointer to a trap frame.
00232 
00233     FirstChance - Supplies a <span class="keywordtype">boolean</span> value that specifies whether <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00234         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first (TRUE) or second (FALSE) chance for the exception.
00235 
00236 Return Value:
00237 
00238     STATUS_ACCESS_VIOLATION is returned if either the exception or the context
00239         record is not readable from user mode.
00240 
00241     STATUS_DATATYPE_MISALIGNMENT is returned if the exception record or the
00242         context record are not properly aligned.
00243 
00244     STATUS_INVALID_PARAMETER is returned if the number of exception parameters
00245         is greater than the maximum allowable number of exception parameters.
00246 
00247     STATUS_SUCCESS is returned if the exception is dispatched and handled.
00248 
00249 --*/
00250 
00251 {
00252 
00253     CONTEXT ContextRecord2;
00254     EXCEPTION_RECORD ExceptionRecord2;
00255     ULONG Length;
00256     ULONG Params;
00257     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00258 
00259     <span class="comment">//</span>
00260     <span class="comment">// Establish an exception handler and probe the specified exception and</span>
00261     <span class="comment">// context records for read accessibility. If the probe fails, then</span>
00262     <span class="comment">// return the exception code as the service status. Else call the exception</span>
00263     <span class="comment">// dispatcher to dispatch the exception.</span>
00264     <span class="comment">//</span>
00265 
00266     <span class="keywordflow">try</span> {
00267 
00268         <span class="comment">//</span>
00269         <span class="comment">// Get the previous processor mode. If the previous processor mode</span>
00270         <span class="comment">// is user, then probe and copy the specified exception and context</span>
00271         <span class="comment">// records.</span>
00272         <span class="comment">//</span>
00273 
00274         PreviousMode = KeGetPreviousMode();
00275         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00276             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ContextRecord, <span class="keyword">sizeof</span>(CONTEXT), CONTEXT_ALIGN);
00277             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ExceptionRecord,
00278                          FIELD_OFFSET (EXCEPTION_RECORD, NumberParameters) +
00279                          <span class="keyword">sizeof</span> (ExceptionRecord-&gt;NumberParameters), <span class="keyword">sizeof</span>(ULONG));
00280             Params = ExceptionRecord-&gt;NumberParameters;
00281             <span class="keywordflow">if</span> (Params &gt; EXCEPTION_MAXIMUM_PARAMETERS) {
00282                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00283             }
00284 
00285             <span class="comment">//</span>
00286             <span class="comment">// The exception record structure is defined unlike others with trailing</span>
00287             <span class="comment">// information as being its maximum size rather than just a single trailing</span>
00288             <span class="comment">// element.</span>
00289             <span class="comment">//</span>
00290             Length = (<span class="keyword">sizeof</span>(EXCEPTION_RECORD) -
00291                      ((EXCEPTION_MAXIMUM_PARAMETERS - Params) *
00292                      <span class="keyword">sizeof</span>(ExceptionRecord-&gt;ExceptionInformation[0])));
00293 
00294             <span class="comment">//</span>
00295             <span class="comment">// The structure is currently less that 64k so we don't really need this probe.</span>
00296             <span class="comment">//</span>
00297             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ExceptionRecord, Length, <span class="keyword">sizeof</span>(ULONG));
00298 
00299             <span class="comment">//</span>
00300             <span class="comment">// Copy the exception and context record to local storage so an</span>
00301             <span class="comment">// access violation cannot occur during exception dispatching.</span>
00302             <span class="comment">//</span>
00303 
00304             RtlMoveMemory(&amp;ContextRecord2, ContextRecord, <span class="keyword">sizeof</span>(CONTEXT));
00305             RtlMoveMemory(&amp;ExceptionRecord2, ExceptionRecord, Length);
00306             ContextRecord = &amp;ContextRecord2;
00307             ExceptionRecord = &amp;ExceptionRecord2;
00308             <span class="comment">//</span>
00309             <span class="comment">// The number of parameters might have changed after we validated but before we</span>
00310             <span class="comment">// copied the structure. Fix this up as lower levels might not like this.</span>
00311             <span class="comment">//</span>
00312             ExceptionRecord-&gt;NumberParameters = Params;            
00313         }
00314 
00315     <span class="comment">//</span>
00316     <span class="comment">// If an exception occurs during the probe of the exception or context</span>
00317     <span class="comment">// record, then always handle the exception and return the exception code</span>
00318     <span class="comment">// as the status value.</span>
00319     <span class="comment">//</span>
00320 
00321     } except(EXCEPTION_EXECUTE_HANDLER) {
00322         <span class="keywordflow">return</span> GetExceptionCode();
00323     }
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">// Move information from the context record to the exception and</span>
00327     <span class="comment">// trap frames.</span>
00328     <span class="comment">//</span>
00329 
00330     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame,
00331                        ExceptionFrame,
00332                        ContextRecord,
00333                        ContextRecord-&gt;ContextFlags,
00334                        PreviousMode);
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">// Make sure the reserved bit is clear in the exception code and</span>
00338     <span class="comment">// perform exception dispatching.</span>
00339     <span class="comment">//</span>
00340     <span class="comment">// N.B. The reserved bit is used to differentiate internally gerarated</span>
00341     <span class="comment">//      codes from codes generated by application programs.</span>
00342     <span class="comment">//</span>
00343 
00344     ExceptionRecord-&gt;ExceptionCode &amp;= 0xefffffff;
00345     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a11">KiDispatchException</a>(ExceptionRecord,
00346                         ExceptionFrame,
00347                         TrapFrame,
00348                         PreviousMode,
00349                         FirstChance);
00350 
00351     <span class="keywordflow">return</span> STATUS_SUCCESS;
00352 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
