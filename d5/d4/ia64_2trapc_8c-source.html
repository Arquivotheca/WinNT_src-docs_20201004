<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: trapc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>trapc.c</h1><a href="../../d4/d5/ia64_2trapc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    trapc.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the specific exception handlers for EM</span>
00012 <span class="comment">    exceptions. Called by the KiGenericExceptionHandler.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Bernard Lint 4-Apr-96</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="../../d1/d9/ps_8h.html">ps.h</a>"</span>
00028 <span class="preprocessor">#include "..\..\mm\mi.h"</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="../../d0/d1/inbv_8h.html">inbv.h</a>&gt;</span>
00030 
<a name="l00031"></a><a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a0">00031</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a0">PsWatchEnabled</a>;
00032 <span class="keyword">extern</span> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a2">ExpInterlockedPopEntrySListResume</a>();
00033 
00034 <span class="preprocessor">#if DBG</span>
00035 <span class="preprocessor"></span>
00036 <span class="keyword">typedef</span> <span class="keyword">struct </span>_MMFAULT_HISTORY {
00037     ULONGLONG Iip;
00038     ULONGLONG Ifa;
00039     ULONGLONG Iipa;
00040     ULONGLONG TrapFrame;
00041 } MMFAULT_HISTORY; 
00042 
00043 ULONG MmHistoryIndx = 0; 
00044 
00045 MMFAULT_HISTORY MmFaultHistory[8];
00046 
00047 ULONGLONG MmUserInstMemoryFaultCount = 0;
00048 ULONGLONG MmUserDataMemoryFaultCount = 0;
00049 ULONGLONG MmKernInstMemoryFaultCount = 0;
00050 ULONGLONG MmKernDataMemoryFaultCount = 0;
00051 
00052 <span class="preprocessor">#endif</span>
00053 <span class="preprocessor"></span>
00054 
00055 BOOLEAN
<a name="l00056"></a><a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a3">00056</a> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a3">KiMemoryFault</a> (
00057     IN PKTRAP_FRAME TrapFrame
00058     )
00059 
00060 <span class="comment">/*++</span>
00061 <span class="comment"></span>
00062 <span class="comment">Routine Description:</span>
00063 <span class="comment"></span>
00064 <span class="comment">Arguments:</span>
00065 <span class="comment"></span>
00066 <span class="comment">    TrapFrame - Pointer to the trap frame.</span>
00067 <span class="comment"></span>
00068 <span class="comment">Return Value:</span>
00069 <span class="comment"></span>
00070 <span class="comment">    None</span>
00071 <span class="comment"></span>
00072 <span class="comment">--*/</span>
00073 
00074 {
00075     PEXCEPTION_RECORD ExceptionRecord;
00076     BOOLEAN StoreInstruction;
00077     PVOID VirtualAddress;
00078     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00079 
00080     <span class="comment">//</span>
00081     <span class="comment">// Indicate store or not</span>
00082     <span class="comment">//</span>
00083 
00084     <span class="keywordflow">if</span> (TrapFrame-&gt;StISR &amp; (1i64 &lt;&lt; ISR_W)) {
00085         StoreInstruction = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00086     } <span class="keywordflow">else</span> {
00087         StoreInstruction = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00088     }    
00089 
00090     VirtualAddress = (PVOID)TrapFrame-&gt;StIFA;
00091 
00092     <span class="keywordflow">if</span> (TrapFrame-&gt;StISR &amp; (1i64 &lt;&lt; ISR_X))  {
00093 
00094 <span class="preprocessor">#if _MERCED_A0_</span>
00095 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((TrapFrame-&gt;StIPSR &amp; (1i64 &lt;&lt; PSR_IS)) == 0) {
00096             VirtualAddress = (PVOID)TrapFrame-&gt;StIIP;
00097         }
00098 <span class="preprocessor">#endif</span>
00099 <span class="preprocessor"></span>        <span class="comment">//</span>
00100         <span class="comment">// Indicate execution fault or not</span>
00101         <span class="comment">//</span>
00102 
00103         StoreInstruction = 2;
00104     }
00105 
00106 
00107 <span class="preprocessor">#if DBG</span>
00108 <span class="preprocessor"></span>    
00109     _disable();
00110 
00111     <span class="keywordflow">if</span> (MmHistoryIndx &lt; 8) {
00112         MmFaultHistory[MmHistoryIndx].Iip = TrapFrame-&gt;StIIP;
00113         MmFaultHistory[MmHistoryIndx].Ifa = TrapFrame-&gt;StIFA;
00114         MmFaultHistory[MmHistoryIndx].Iipa = TrapFrame-&gt;StIIPA;
00115         MmFaultHistory[MmHistoryIndx].TrapFrame = (ULONGLONG)TrapFrame;
00116         MmHistoryIndx += 1;
00117     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (MmHistoryIndx == 8) {
00118         MmHistoryIndx = 0;
00119     } <span class="keywordflow">else</span> {
00120         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(MmHistoryIndx);
00121     }
00122     
00123     <span class="keywordflow">if</span> (VirtualAddress &lt; MM_SYSTEM_RANGE_START) {
00124 
00125         <span class="keywordflow">if</span> (StoreInstruction == 2) {
00126             MmUserInstMemoryFaultCount += 1;
00127         } <span class="keywordflow">else</span> {
00128             MmUserDataMemoryFaultCount += 1;
00129         }
00130 
00131     } <span class="keywordflow">else</span> {
00132         
00133         <span class="keywordflow">if</span> (StoreInstruction == 2) {
00134             MmKernInstMemoryFaultCount += 1;
00135         } <span class="keywordflow">else</span> {
00136             MmKernDataMemoryFaultCount += 1;
00137         }
00138     }
00139     
00140     _enable();
00141 
00142 <span class="preprocessor">#endif</span>
00143 <span class="preprocessor"></span>
00144 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00145 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (((ULONG_PTR)VirtualAddress &lt;= <a class="code" href="../../d2/d9/miia64_8h.html#a257">_MAX_WOW64_ADDRESS</a>) &amp;&amp; 
00146         (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00147 
00148         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/miia64_8h.html#a302">MmX86Fault</a>(StoreInstruction, VirtualAddress,
00149                            (<a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>)TrapFrame-&gt;PreviousMode, TrapFrame);
00150 
00151     } <span class="keywordflow">else</span> 
00152 <span class="preprocessor">#endif</span>
00153 <span class="preprocessor"></span>    {    
00154 
00155         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a>(StoreInstruction, VirtualAddress, 
00156                            (<a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>)TrapFrame-&gt;PreviousMode, TrapFrame);
00157     }
00158 
00159     <span class="comment">//</span>
00160     <span class="comment">// MmAccessFault() returns positive numbers if it is successful; returns</span>
00161     <span class="comment">// negative numbers if it fails.</span>
00162     <span class="comment">//</span>
00163     <span class="comment">// Check if working set watch is enabled.</span>
00164     <span class="comment">//</span>
00165 
00166     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &gt;= 0) {
00167 
00168         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a0">PsWatchEnabled</a>) {
00169             <a class="code" href="../../d9/d1/psquery_8c.html#a22">PsWatchWorkingSet</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, 
00170                               (PVOID)TrapFrame-&gt;StIIP, 
00171                               (PVOID)VirtualAddress);
00172         }
00173         
00174         <span class="comment">//</span>
00175         <span class="comment">// Check if debugger has any breakpoints that should be inserted</span>
00176         <span class="comment">//</span>
00177 
00178         <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a0">KdSetOwedBreakpoints</a>();
00179         
00180         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00181 
00182     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapFrame)) {
00183 
00184         TrapFrame-&gt;StIIP = ((PPLABEL_DESCRIPTOR)<a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a2">ExpInterlockedPopEntrySListResume</a>)-&gt;EntryPoint;
00185 
00186     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TrapFrame-&gt;StISR &amp; (1i64 &lt;&lt; ISR_SP)) {
00187 
00188         <span class="comment">//</span>
00189         <span class="comment">// Set IPSR.ed bit if it was a fault on a speculative load. </span>
00190         <span class="comment">//</span>
00191 
00192         TrapFrame-&gt;StIPSR |= (1i64 &lt;&lt; PSR_ED);
00193 
00194         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00195 
00196     }
00197 
00198     <span class="comment">//</span>
00199     <span class="comment">// Failure returned from MmAccessFault.</span>
00200     <span class="comment">// Initialize Exception record.</span>
00201     <span class="comment">//</span>
00202     
00203     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
00204     ExceptionRecord-&gt;ExceptionCode = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00205     ExceptionRecord-&gt;ExceptionAddress =
00206         (PVOID)RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP,
00207                    ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI));
00208     
00209     ExceptionRecord-&gt;ExceptionFlags = 0;
00210     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00211     
00212     ExceptionRecord-&gt;NumberParameters = 5;
00213     ExceptionRecord-&gt;ExceptionInformation[0] = (ULONG_PTR)StoreInstruction;
00214     ExceptionRecord-&gt;ExceptionInformation[1] = (ULONG_PTR)VirtualAddress;
00215     ExceptionRecord-&gt;ExceptionInformation[2] = (ULONG_PTR)<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00216     ExceptionRecord-&gt;ExceptionInformation[3] = (ULONG_PTR)TrapFrame-&gt;StIIPA;
00217     ExceptionRecord-&gt;ExceptionInformation[4] = (ULONG_PTR)TrapFrame-&gt;StISR;
00218         
00219     <span class="comment">//</span>
00220     <span class="comment">// Status = STATUS_IN_PAGE_ERROR | 0x10000000</span>
00221     <span class="comment">//      is a special status that indicates a page fault at Irql &gt; APC</span>
00222     <span class="comment">//</span>
00223     <span class="comment">// The following statuses can be forwarded:</span>
00224     <span class="comment">//      STATUS_ACCESS_VIOLATION</span>
00225     <span class="comment">//      STATUS_GUARD_PAGE_VIOLATION</span>
00226     <span class="comment">//      STATUS_STACK_OVERFLOW</span>
00227     <span class="comment">//</span>
00228     <span class="comment">// All other status will be set to:</span>
00229     <span class="comment">//      STATUS_IN_PAGE_ERROR</span>
00230     <span class="comment">//</span>
00231     
00232     <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00233         
00234     <span class="keywordflow">case</span> STATUS_ACCESS_VIOLATION:
00235     <span class="keywordflow">case</span> STATUS_GUARD_PAGE_VIOLATION:
00236     <span class="keywordflow">case</span> STATUS_STACK_OVERFLOW:
00237     <span class="keywordflow">case</span> STATUS_IN_PAGE_ERROR:
00238         
00239         <span class="keywordflow">break</span>;
00240 
00241     <span class="keywordflow">default</span>:
00242 
00243         ExceptionRecord-&gt;ExceptionCode = STATUS_IN_PAGE_ERROR;
00244         <span class="keywordflow">break</span>;
00245         
00246     <span class="keywordflow">case</span> STATUS_IN_PAGE_ERROR | 0x10000000:
00247         
00248         <span class="comment">//</span>
00249         <span class="comment">// Handle the special case status returned from MmAccessFault,</span>
00250         <span class="comment">// we have taken a page fault at Irql &gt; APC_LEVEL.</span>
00251         <span class="comment">//</span>
00252         
00253         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a12">IRQL_NOT_LESS_OR_EQUAL</a>,
00254                      (ULONG_PTR)VirtualAddress,
00255                      (ULONG_PTR)KeGetCurrentIrql(),
00256                      (ULONG_PTR)StoreInstruction,
00257                      (ULONG_PTR)TrapFrame-&gt;StIIP);
00258         <span class="comment">//</span>
00259         <span class="comment">// should not get here</span>
00260         <span class="comment">//</span>
00261         
00262         <span class="keywordflow">break</span>;
00263     }
00264     
00265     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00266 }
00267 
<a name="l00268"></a><a class="code" href="../../d0/d5/struct__BREAK__INST.html">00268</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d5/struct__BREAK__INST.html">_BREAK_INST</a> {
00269     <span class="keyword">union </span>{
00270         <span class="keyword">struct </span>{
<a name="l00271"></a><a class="code" href="../../d0/d5/struct__BREAK__INST.html#o0">00271</a>             ULONGLONG <a class="code" href="../../d0/d5/struct__BREAK__INST.html#o0">qp</a>:    6;
<a name="l00272"></a><a class="code" href="../../d0/d5/struct__BREAK__INST.html#o1">00272</a>             ULONGLONG <a class="code" href="../../d0/d5/struct__BREAK__INST.html#o1">imm20</a>: 20;
<a name="l00273"></a><a class="code" href="../../d0/d5/struct__BREAK__INST.html#o2">00273</a>             ULONGLONG <a class="code" href="../../d0/d5/struct__BREAK__INST.html#o2">x</a>:     1;
<a name="l00274"></a><a class="code" href="../../d0/d5/struct__BREAK__INST.html#o3">00274</a>             ULONGLONG <a class="code" href="../../d0/d5/struct__BREAK__INST.html#o3">x6</a>:    6;
<a name="l00275"></a><a class="code" href="../../d0/d5/struct__BREAK__INST.html#o4">00275</a>             ULONGLONG <a class="code" href="../../d0/d5/struct__BREAK__INST.html#o4">x3</a>:    3;
<a name="l00276"></a><a class="code" href="../../d0/d5/struct__BREAK__INST.html#o5">00276</a>             ULONGLONG <a class="code" href="../../d0/d5/struct__BREAK__INST.html#o5">i</a>:     1;
<a name="l00277"></a><a class="code" href="../../d0/d5/struct__BREAK__INST.html#o6">00277</a>             ULONGLONG <a class="code" href="../../d0/d5/struct__BREAK__INST.html#o6">Op</a>:    4;
<a name="l00278"></a><a class="code" href="../../d0/d5/struct__BREAK__INST.html#o7">00278</a>             ULONGLONG <a class="code" href="../../d0/d5/struct__BREAK__INST.html#o7">Rsv</a>:   23; 
00279         } i_field;
<a name="l00280"></a><a class="code" href="../../d0/d5/struct__BREAK__INST.html#o9">00280</a>         ULONGLONG <a class="code" href="../../d0/d5/struct__BREAK__INST.html#o9">Ulong64</a>;
00281     } u;
00282 } <a class="code" href="../../d0/d5/struct__BREAK__INST.html">BREAK_INST</a>;
00283 
00284 
00285 ULONG
<a name="l00286"></a><a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a4">00286</a> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a4">KiExtractImmediate</a> (
00287     IN ULONGLONG Iip,
00288     IN ULONG SlotNumber
00289     )
00290 
00291 <span class="comment">/*++</span>
00292 <span class="comment"></span>
00293 <span class="comment">Routine Description:</span>
00294 <span class="comment"></span>
00295 <span class="comment">    Extract immediate operand from break instruction.</span>
00296 <span class="comment"></span>
00297 <span class="comment">Arguments:</span>
00298 <span class="comment"></span>
00299 <span class="comment">    Iip - Bundle address of instruction</span>
00300 <span class="comment">    </span>
00301 <span class="comment">    SlotNumber - Slot of break instruction within bundle</span>
00302 <span class="comment"></span>
00303 <span class="comment">Return Value:</span>
00304 <span class="comment"></span>
00305 <span class="comment">    Value of immediate operand.</span>
00306 <span class="comment"></span>
00307 <span class="comment">--*/</span>
00308 
00309 {
00310     PULONGLONG BundleAddress;
00311     ULONGLONG BundleLow;
00312     ULONGLONG BundleHigh;
00313     <a class="code" href="../../d0/d5/struct__BREAK__INST.html">BREAK_INST</a> BreakInst;
00314     ULONG Imm21;
00315 
00316     BundleAddress = (PULONGLONG)Iip;
00317 
00318     BundleLow = *BundleAddress;
00319     BundleHigh = *(BundleAddress+1);
00320     
00321     <span class="comment">//</span>
00322     <span class="comment">// Align instruction</span>
00323     <span class="comment">//</span>
00324     
00325     <span class="keywordflow">switch</span> (SlotNumber) {
00326         <span class="keywordflow">case</span> 0:
00327             BreakInst.<a class="code" href="../../d0/d5/struct__BREAK__INST.html#o10">u</a>.Ulong64 = BundleLow &gt;&gt; 5;
00328             <span class="keywordflow">break</span>;
00329 
00330         <span class="keywordflow">case</span> 1:
00331             BreakInst.<a class="code" href="../../d0/d5/struct__BREAK__INST.html#o10">u</a>.Ulong64 = (BundleLow &gt;&gt; 46) | (BundleHigh &lt;&lt; 18);
00332             <span class="keywordflow">break</span>;
00333 
00334         <span class="keywordflow">case</span> 2:
00335             BreakInst.<a class="code" href="../../d0/d5/struct__BREAK__INST.html#o10">u</a>.Ulong64 = (BundleHigh &gt;&gt; 23);
00336             <span class="keywordflow">break</span>;
00337     }
00338     
00339     <span class="comment">//</span>
00340     <span class="comment">// Extract immediate value</span>
00341     <span class="comment">//</span>
00342 
00343     Imm21 = (ULONG)(BreakInst.<a class="code" href="../../d0/d5/struct__BREAK__INST.html#o10">u</a>.i_field.i&lt;&lt;20) | (ULONG)(BreakInst.<a class="code" href="../../d0/d5/struct__BREAK__INST.html#o10">u</a>.i_field.imm20);
00344 
00345     <span class="keywordflow">return</span> Imm21;
00346 }
00347 
00348 BOOLEAN
<a name="l00349"></a><a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a5">00349</a> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a5">KiOtherBreakException</a> (
00350     IN PKTRAP_FRAME TrapFrame
00351     )
00352 
00353 <span class="comment">/*++</span>
00354 <span class="comment"></span>
00355 <span class="comment">Routine Description:</span>
00356 <span class="comment"></span>
00357 <span class="comment">    Handler for break exception other than the ones for fast and</span>
00358 <span class="comment">    normal system calls. This includes debug break points.</span>
00359 <span class="comment"></span>
00360 <span class="comment">Arguments:</span>
00361 <span class="comment"></span>
00362 <span class="comment">    TrapFrame - Pointer to the trap frame.</span>
00363 <span class="comment"></span>
00364 <span class="comment">Return Value:</span>
00365 <span class="comment"></span>
00366 <span class="comment">    NT status code.</span>
00367 <span class="comment"></span>
00368 <span class="comment">--*/</span>
00369 
00370 {
00371     PEXCEPTION_RECORD ExceptionRecord;
00372     ULONG BreakImmediate;
00373     ISR Isr;
00374 
00375     BreakImmediate = (ULONG)(TrapFrame-&gt;StIIM);
00376 
00377     <span class="comment">//</span>
00378     <span class="comment">// Handle break.b case</span>
00379     <span class="comment">//</span>
00380     <span class="keywordflow">if</span> (BreakImmediate == 0) {
00381        Isr.ull = TrapFrame-&gt;StISR;
00382        BreakImmediate = <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a4">KiExtractImmediate</a>(TrapFrame-&gt;StIIP,
00383                                            (ULONG)Isr.sb.isr_ei);
00384        TrapFrame-&gt;StIIM = BreakImmediate;
00385     }
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">// Initialize exception record</span>
00389     <span class="comment">//</span>
00390 
00391     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
00392     ExceptionRecord-&gt;ExceptionAddress = 
00393         (PVOID) RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP,
00394                                  ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI));
00395  
00396     ExceptionRecord-&gt;ExceptionFlags = 0;
00397     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00398  
00399     ExceptionRecord-&gt;NumberParameters = 5;
00400     ExceptionRecord-&gt;ExceptionInformation[0] = 0;
00401     ExceptionRecord-&gt;ExceptionInformation[1] = 0;
00402     ExceptionRecord-&gt;ExceptionInformation[2] = 0;
00403     ExceptionRecord-&gt;ExceptionInformation[3] = TrapFrame-&gt;StIIPA;
00404     ExceptionRecord-&gt;ExceptionInformation[4] = TrapFrame-&gt;StISR;
00405  
00406     <span class="keywordflow">switch</span> (BreakImmediate) {
00407 
00408     <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a453">KERNEL_BREAKPOINT</a>:
00409     <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a452">USER_BREAKPOINT</a>:
00410     <span class="keywordflow">case</span> INTEGER_OVERFLOW_BREAKPOINT:
00411     <span class="keywordflow">case</span> DIVIDE_OVERFLOW_BREAKPOINT:
00412     <span class="keywordflow">case</span> DIVIDE_BY_ZERO_BREAKPOINT:
00413     <span class="keywordflow">case</span> RANGE_CHECK_BREAKPOINT:
00414     <span class="keywordflow">case</span> STACK_OVERFLOW_BREAKPOINT:
00415     <span class="keywordflow">case</span> MULTIPLY_OVERFLOW_BREAKPOINT:
00416     <span class="keywordflow">case</span> DEBUG_PRINT_BREAKPOINT:
00417     <span class="keywordflow">case</span> DEBUG_PROMPT_BREAKPOINT:
00418     <span class="keywordflow">case</span> DEBUG_STOP_BREAKPOINT:
00419     <span class="keywordflow">case</span> DEBUG_LOAD_SYMBOLS_BREAKPOINT:
00420     <span class="keywordflow">case</span> DEBUG_UNLOAD_SYMBOLS_BREAKPOINT:
00421     <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a454">BREAKIN_BREAKPOINT</a>:
00422         ExceptionRecord-&gt;ExceptionCode = STATUS_BREAKPOINT;
00423         ExceptionRecord-&gt;ExceptionInformation[0] = BreakImmediate;
00424         <span class="keywordflow">break</span>;
00425 
00426     <span class="keywordflow">default</span>:
00427 <span class="preprocessor">#if DBG</span>
00428 <span class="preprocessor"></span>        <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a> (<span class="stringliteral">"KiOtherBreakException: Unknown break code.\n"</span>);
00429 <span class="preprocessor">#endif // DBG</span>
00430 <span class="preprocessor"></span>        ExceptionRecord-&gt;ExceptionCode = STATUS_ILLEGAL_INSTRUCTION;
00431         <span class="keywordflow">break</span>;
00432     }
00433 
00434     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00435 }
00436 
00437 BOOLEAN
<a name="l00438"></a><a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a6">00438</a> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a6">KiGeneralExceptions</a> (
00439     IN PKTRAP_FRAME TrapFrame
00440     )
00441 
00442 <span class="comment">/*++</span>
00443 <span class="comment"></span>
00444 <span class="comment">Routine Description:</span>
00445 <span class="comment"></span>
00446 <span class="comment">    Handler for general exception faults: attempt to execute an illegal</span>
00447 <span class="comment">    operation, privileged instruction, access a privileged register,</span>
00448 <span class="comment">    unimplemented field, unimplemented register, or take an inter-ISA</span>
00449 <span class="comment">    branch when disabled.</span>
00450 <span class="comment"></span>
00451 <span class="comment">Arguments:</span>
00452 <span class="comment"></span>
00453 <span class="comment">    TrapFrame - Pointer to the trap frame.</span>
00454 <span class="comment"></span>
00455 <span class="comment">Return Value:</span>
00456 <span class="comment"></span>
00457 <span class="comment">    None.</span>
00458 <span class="comment"></span>
00459 <span class="comment">Notes:</span>
00460 <span class="comment"></span>
00461 <span class="comment">    ISR.ei bits indicate which instruction caused the exception.</span>
00462 <span class="comment"></span>
00463 <span class="comment">    ISR.code{3:0} Non-access instruction (ISR.na = 1)</span>
00464 <span class="comment">                  = 0 tpa</span>
00465 <span class="comment">                  = 1 fc</span>
00466 <span class="comment">                  = 2 probe</span>
00467 <span class="comment">                  = 3 tak</span>
00468 <span class="comment">                  = 4 lfetch</span>
00469 <span class="comment"></span>
00470 <span class="comment">    ISR.code{7:4} = 0: Illegal operation fault: All reported as STATUS_ILLEGAL_INSTRUCTION.</span>
00471 <span class="comment"></span>
00472 <span class="comment">            ISR.rs = 0: An attempt to execute an illegal operation:</span>
00473 <span class="comment">                 -- unassigned major opcodes</span>
00474 <span class="comment">                 -- unassigned sub-opcodes</span>
00475 <span class="comment">                 -- reserved instruction fields</span>
00476 <span class="comment">                 -- writing a read-only register</span>
00477 <span class="comment">                 -- accessing a reserved register</span>
00478 <span class="comment"></span>
00479 <span class="comment">            ISR.rs = 1:</span>
00480 <span class="comment">                 -- attempt to write outside the current register stack frame</span>
00481 <span class="comment">                 -- INVALRS operation with RCS.en = 1</span>
00482 <span class="comment">                 -- write to BSP with RCS.en = 1</span>
00483 <span class="comment">                 -- write to RNATRC with RCS.en = 1</span>
00484 <span class="comment">                 -- read from RNATRC with RCS.en = 1</span>
00485 <span class="comment"></span>
00486 <span class="comment">    ISR.code{7:4} = 1: Privileged operation fault: Reported as STATUS_PRIVILEGED_INSTRUCTION.</span>
00487 <span class="comment">    ISR.code{7:4} = 2: Privileged register fault: Reported as STATUS_PRIVILEGED_INSTRUCTION.</span>
00488 <span class="comment">    ISR.code{7:4} = 3: Reserved register fault: Reported as STATUS_ILLEGAL_INSTRUCTION.</span>
00489 <span class="comment">    ISR.code{7:4} = 4: Illegal ISA transition fault: Reported as STATUS_ILLEGAL_INSTRUCTION.</span>
00490 <span class="comment"></span>
00491 <span class="comment">--*/</span>
00492 
00493 {
00494     BOOLEAN StoreInstruction = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00495     ULONG IsrCode;
00496     PEXCEPTION_RECORD ExceptionRecord;
00497 
00498     <span class="comment">//</span>
00499     <span class="comment">// Initialize the exception record</span>
00500     <span class="comment">//</span>
00501 
00502     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
00503     ExceptionRecord-&gt;ExceptionAddress = 
00504            (PVOID) RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP,
00505                                  ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI));
00506 
00507     ExceptionRecord-&gt;ExceptionFlags = 0;
00508     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00509 
00510     ExceptionRecord-&gt;NumberParameters = 5;
00511     ExceptionRecord-&gt;ExceptionInformation[0] = 0;
00512     ExceptionRecord-&gt;ExceptionInformation[1] = 0;
00513     ExceptionRecord-&gt;ExceptionInformation[2] = 0;
00514     ExceptionRecord-&gt;ExceptionInformation[3] = TrapFrame-&gt;StIIPA;
00515     ExceptionRecord-&gt;ExceptionInformation[4] = TrapFrame-&gt;StISR;
00516 
00517     IsrCode = (LONG)((TrapFrame-&gt;StISR &gt;&gt; ISR_CODE) &amp; ISR_CODE_MASK);
00518 
00519     <span class="comment">//</span>
00520     <span class="comment">// Look at ISR code bits {7:4}</span>
00521     <span class="comment">//</span>
00522 
00523     <span class="keywordflow">switch</span> (IsrCode &gt;&gt; 4) {
00524 
00525     <span class="keywordflow">case</span> ISR_PRIV_OP:
00526     <span class="keywordflow">case</span> ISR_PRIV_REG:
00527 
00528         ExceptionRecord-&gt;ExceptionCode = STATUS_PRIVILEGED_INSTRUCTION;
00529         <span class="keywordflow">break</span>;
00530 
00531     <span class="keywordflow">case</span> ISR_RESVD_REG:
00532 
00533         <span class="comment">//</span>
00534         <span class="comment">// Indicate store or not</span>
00535         <span class="comment">//</span>
00536 
00537         <span class="keywordflow">if</span> (TrapFrame-&gt;StISR &amp; (1i64 &lt;&lt; ISR_W)) {
00538 
00539             StoreInstruction = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00540 
00541         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TrapFrame-&gt;StISR &amp; (1i64 &lt;&lt; ISR_X)) {
00542 
00543             <span class="comment">//</span>
00544             <span class="comment">// Indicate execution fault or not</span>
00545             <span class="comment">//</span>
00546 
00547             StoreInstruction = 2;
00548         }
00549 
00550         ExceptionRecord-&gt;ExceptionCode = STATUS_ACCESS_VIOLATION;
00551         ExceptionRecord-&gt;ExceptionInformation[0] = (ULONG_PTR)StoreInstruction;
00552         ExceptionRecord-&gt;ExceptionInformation[1] = (ULONG_PTR)TrapFrame-&gt;StIFA;
00553         ExceptionRecord-&gt;ExceptionInformation[2] = (ULONG_PTR)STATUS_ACCESS_VIOLATION;
00554         <span class="keywordflow">break</span>;
00555 
00556     <span class="keywordflow">case</span> ISR_ILLEGAL_OP:
00557     <span class="keywordflow">case</span> ISR_ILLEGAL_ISA:
00558 
00559         ExceptionRecord-&gt;ExceptionCode = STATUS_ILLEGAL_INSTRUCTION;
00560         <span class="keywordflow">break</span>;
00561 
00562     <span class="keywordflow">case</span> ISR_ILLEGAL_HAZARD:
00563 
00564         <span class="comment">//</span>
00565         <span class="comment">// a new status code will be introduced for hazard faults.</span>
00566         <span class="comment">//</span>
00567 
00568         ExceptionRecord-&gt;ExceptionCode = STATUS_ILLEGAL_INSTRUCTION;
00569         <span class="keywordflow">break</span>;
00570 
00571     <span class="keywordflow">default</span>:
00572 
00573         <span class="keywordflow">if</span> (TrapFrame-&gt;PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00574             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(0xFFFFFFFF,
00575                         (ULONG_PTR)TrapFrame-&gt;StISR,
00576                         (ULONG_PTR)TrapFrame-&gt;StIIP,
00577                         (ULONG_PTR)TrapFrame,
00578                         0
00579                         );
00580         }
00581 
00582         <span class="keywordflow">break</span>;
00583     }
00584 
00585     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00586 }
00587 
00588 
00589 BOOLEAN
<a name="l00590"></a><a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a7">00590</a> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a7">KiNatExceptions</a> (
00591     IN PKTRAP_FRAME TrapFrame
00592     )
00593 
00594 <span class="comment">/*++</span>
00595 <span class="comment"></span>
00596 <span class="comment">Routine Description:</span>
00597 <span class="comment"></span>
00598 <span class="comment">    Handler for NaT consumption exception faults</span>
00599 <span class="comment"></span>
00600 <span class="comment">Arguments:</span>
00601 <span class="comment"></span>
00602 <span class="comment">    TrapFrame - Pointer to the trap frame.</span>
00603 <span class="comment"></span>
00604 <span class="comment">Return Value:</span>
00605 <span class="comment"></span>
00606 <span class="comment">    None.</span>
00607 <span class="comment"></span>
00608 <span class="comment">Notes:</span>
00609 <span class="comment"></span>
00610 <span class="comment">    ISR.ei bits indicate which instruction caused the exception.</span>
00611 <span class="comment"></span>
00612 <span class="comment">    ISR.code{3:0} Non-access instruction (ISR.na = 1)</span>
00613 <span class="comment">                  = 0 tpa</span>
00614 <span class="comment">                  = 1 fc</span>
00615 <span class="comment">                  = 2 probe</span>
00616 <span class="comment">                  = 3 tak</span>
00617 <span class="comment">                  = 4 lfetch</span>
00618 <span class="comment"></span>
00619 <span class="comment">    ISR.code{7:4} = 1: Register NaT consumption fault</span>
00620 <span class="comment">    ISR.code{7:4} = 2: NaT page consumption fault</span>
00621 <span class="comment"></span>
00622 <span class="comment">--*/</span>
00623 
00624 {
00625     BOOLEAN StoreInstruction = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00626     ULONG IsrCode;
00627     PEXCEPTION_RECORD ExceptionRecord;
00628 
00629     <span class="comment">//</span>
00630     <span class="comment">// Initialize the exception record</span>
00631     <span class="comment">//</span>
00632 
00633     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
00634     ExceptionRecord-&gt;ExceptionAddress = 
00635            (PVOID) RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP,
00636                                  ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI));
00637 
00638     ExceptionRecord-&gt;ExceptionFlags = 0;
00639     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00640 
00641     ExceptionRecord-&gt;NumberParameters = 5;
00642     ExceptionRecord-&gt;ExceptionInformation[0] = 0;
00643     ExceptionRecord-&gt;ExceptionInformation[1] = 0;
00644     ExceptionRecord-&gt;ExceptionInformation[2] = 0;
00645     ExceptionRecord-&gt;ExceptionInformation[3] = TrapFrame-&gt;StIIPA;
00646     ExceptionRecord-&gt;ExceptionInformation[4] = TrapFrame-&gt;StISR;
00647 
00648     IsrCode = (LONG)((TrapFrame-&gt;StISR &gt;&gt; ISR_CODE) &amp; ISR_CODE_MASK);
00649 
00650     <span class="comment">//</span>
00651     <span class="comment">// Look at ISR code bits {7:4}</span>
00652     <span class="comment">//</span>
00653 
00654     <span class="keywordflow">switch</span> (IsrCode &gt;&gt; 4) {
00655 
00656     <span class="keywordflow">case</span> ISR_NAT_REG:
00657 
00658 <span class="preprocessor">#if 0</span>
00659 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (TrapFrame-&gt;PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00660 
00661             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"FATAL ERROR: Kernel hit a Nat Consumpation Fault!\n"</span>);
00662             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(0xFFFFFFFF,
00663                         (ULONG_PTR)TrapFrame-&gt;StISR,
00664                         (ULONG_PTR)TrapFrame-&gt;StIIP,
00665                         (ULONG_PTR)TrapFrame,
00666                         0
00667                         );
00668 
00669             <span class="comment">// Do not return from KeBugCheckEx</span>
00670         }
00671 <span class="preprocessor">#endif // 0</span>
00672 <span class="preprocessor"></span>
00673         ExceptionRecord-&gt;ExceptionCode = STATUS_REG_NAT_CONSUMPTION;
00674         <span class="keywordflow">break</span>;
00675 
00676     <span class="keywordflow">case</span> ISR_NAT_PAGE:
00677 
00678         <span class="comment">//</span>
00679         <span class="comment">// If we start using a NaT page, we should treat this as a page fault and </span>
00680         <span class="comment">// should call KiMemoryFault().</span>
00681         <span class="comment">//</span>
00682 
00683         ExceptionRecord-&gt;ExceptionCode = STATUS_ACCESS_VIOLATION;
00684         <span class="keywordflow">break</span>;
00685 
00686     <span class="keywordflow">default</span>:
00687 
00688         <span class="keywordflow">if</span> (TrapFrame-&gt;PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00689             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(0xFFFFFFFF,
00690                         (ULONG_PTR)TrapFrame-&gt;StISR,
00691                         (ULONG_PTR)TrapFrame-&gt;StIIP,
00692                         (ULONG_PTR)TrapFrame,
00693                         0
00694                         );
00695         }
00696 
00697         <span class="keywordflow">break</span>;
00698     }
00699 
00700     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00701 }
00702 
00703 
00704 BOOLEAN
<a name="l00705"></a><a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a8">00705</a> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a8">KiSingleStep</a> (
00706     IN PKTRAP_FRAME TrapFrame
00707     )
00708 
00709 <span class="comment">/*++</span>
00710 <span class="comment"></span>
00711 <span class="comment">Routine Description:</span>
00712 <span class="comment"></span>
00713 <span class="comment">    Handler for single step trap. An instruction was successfully</span>
00714 <span class="comment">    executed and the PSR.ss bit is 1.</span>
00715 <span class="comment"></span>
00716 <span class="comment">Arguments:</span>
00717 <span class="comment"></span>
00718 <span class="comment">    TrapFrame - Pointer to the trap frame.</span>
00719 <span class="comment"></span>
00720 <span class="comment">Return Value:</span>
00721 <span class="comment"></span>
00722 <span class="comment">    None.</span>
00723 <span class="comment"></span>
00724 <span class="comment">Notes:</span>
00725 <span class="comment"></span>
00726 <span class="comment">    ISR.ei bits indicate which instruction caused the exception.</span>
00727 <span class="comment"></span>
00728 <span class="comment">    ISR.code{3:0} = 1000</span>
00729 <span class="comment"></span>
00730 <span class="comment">--*/</span>
00731 
00732 {
00733     PEXCEPTION_RECORD ExceptionRecord;
00734     ULONG IpsrRi;
00735 
00736     <span class="comment">//</span>
00737     <span class="comment">// Initialize the exception record</span>
00738     <span class="comment">//</span>
00739 
00740     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
00741 
00742     <span class="comment">//</span>
00743     <span class="comment">// We only want the low order 2 bits so typecast to ULONG</span>
00744     <span class="comment">//</span>
00745     IpsrRi = (ULONG)(TrapFrame-&gt;StIPSR &gt;&gt; PSR_RI) &amp; 0x3;
00746 
00747     ExceptionRecord-&gt;ExceptionAddress =
00748            (PVOID) RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP, IpsrRi);
00749 
00750     ExceptionRecord-&gt;ExceptionFlags = 0;
00751     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00752 
00753     ExceptionRecord-&gt;NumberParameters = 5;
00754     ExceptionRecord-&gt;ExceptionInformation[0] = 0;
00755     ExceptionRecord-&gt;ExceptionInformation[1] = 0; <span class="comment">// 0 for traps</span>
00756     ExceptionRecord-&gt;ExceptionInformation[2] = 0;
00757     ExceptionRecord-&gt;ExceptionInformation[3] = TrapFrame-&gt;StIIPA;
00758     ExceptionRecord-&gt;ExceptionInformation[4] = TrapFrame-&gt;StISR;
00759 
00760     ExceptionRecord-&gt;ExceptionCode = STATUS_SINGLE_STEP;
00761 
00762     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00763 }
00764 
00765 BOOLEAN
<a name="l00766"></a><a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a9">00766</a> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a9">KiFloatFault</a> (
00767     IN PKTRAP_FRAME TrapFrame
00768     )
00769 
00770 <span class="comment">/*++</span>
00771 <span class="comment"></span>
00772 <span class="comment">Routine Description:</span>
00773 <span class="comment"></span>
00774 <span class="comment">    Handler for EM floating point fault.</span>
00775 <span class="comment"></span>
00776 <span class="comment">Arguments:</span>
00777 <span class="comment"></span>
00778 <span class="comment">    TrapFrame - Pointer to the trap frame.</span>
00779 <span class="comment"></span>
00780 <span class="comment">Return Value:</span>
00781 <span class="comment"></span>
00782 <span class="comment">    None.</span>
00783 <span class="comment"></span>
00784 <span class="comment">Notes:</span>
00785 <span class="comment"></span>
00786 <span class="comment">    IIP contains address of bundle causing the fault.</span>
00787 <span class="comment">    </span>
00788 <span class="comment">    ISR.ei bits indicate which instruction caused the exception.</span>
00789 <span class="comment"></span>
00790 <span class="comment">    ISR.code{7:0} =</span>
00791 <span class="comment">    </span>
00792 <span class="comment">      ISR.code{0} = 1: IEEE V (invalid) exception (Normal or SIMD-HI)</span>
00793 <span class="comment">      ISR.code{1} = 1: Denormal/Unnormal operand exception (Normal or SIMD-HI)</span>
00794 <span class="comment">      ISR.code{2} = 1: IEEE Z (divide by zero) exception (Normal or SIMD-HI)</span>
00795 <span class="comment">      ISR.code{3} = 1: Software assist (Normal or SIMD-HI)</span>
00796 <span class="comment">      ISR.code{4} = 1: IEEE V (invalid) exception (SIMD-LO)</span>
00797 <span class="comment">      ISR.code{5} = 1: Denormal/Unnormal operand exception (SIMD-LO)</span>
00798 <span class="comment">      ISR.code{6} = 1: IEEE Z (divide by zero) exception (SIMD-LO)</span>
00799 <span class="comment">      ISR.code{7} = 1: Software assist (SIMD-LO)</span>
00800 <span class="comment"></span>
00801 <span class="comment">--*/</span>
00802 
00803 {
00804     PEXCEPTION_RECORD ExceptionRecord;
00805 
00806     <span class="comment">//</span>
00807     <span class="comment">// Initialize the exception record</span>
00808     <span class="comment">//</span>
00809 
00810     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
00811     ExceptionRecord-&gt;ExceptionAddress = 
00812            (PVOID) RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP,
00813                                  ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI));
00814 
00815     ExceptionRecord-&gt;ExceptionFlags = 0;
00816     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00817 
00818     ExceptionRecord-&gt;NumberParameters = 5;
00819     ExceptionRecord-&gt;ExceptionInformation[0] = 0;
00820     ExceptionRecord-&gt;ExceptionInformation[1] = 0;
00821     ExceptionRecord-&gt;ExceptionInformation[2] = 0;
00822     ExceptionRecord-&gt;ExceptionInformation[3] = TrapFrame-&gt;StIIPA;
00823     ExceptionRecord-&gt;ExceptionInformation[4] = TrapFrame-&gt;StISR;
00824 
00825     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_MULTIPLE_FAULTS;
00826 
00827     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00828 }
00829 
00830 BOOLEAN
<a name="l00831"></a><a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a10">00831</a> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a10">KiFloatTrap</a> (
00832     IN PKTRAP_FRAME TrapFrame
00833     )
00834 
00835 <span class="comment">/*++</span>
00836 <span class="comment"></span>
00837 <span class="comment">Routine Description:</span>
00838 <span class="comment"></span>
00839 <span class="comment">    Handler for EM floating point trap.</span>
00840 <span class="comment"></span>
00841 <span class="comment">Arguments:</span>
00842 <span class="comment"></span>
00843 <span class="comment">    TrapFrame - Pointer to the trap frame.</span>
00844 <span class="comment"></span>
00845 <span class="comment">Return Value:</span>
00846 <span class="comment"></span>
00847 <span class="comment">    None.</span>
00848 <span class="comment"></span>
00849 <span class="comment">Notes:</span>
00850 <span class="comment"></span>
00851 <span class="comment">    IIP contains address of bundle with the instruction to be </span>
00852 <span class="comment">    executed next.</span>
00853 <span class="comment"></span>
00854 <span class="comment">    ISR.ei bits indicate which instruction caused the exception.</span>
00855 <span class="comment"></span>
00856 <span class="comment">    The fp trap may occur simultaneously with single-step traps. The</span>
00857 <span class="comment">    fp trap is reported by the hardware. The singel step trap must</span>
00858 <span class="comment">    be detected by software.</span>
00859 <span class="comment">    </span>
00860 <span class="comment">    ISR.code{3:0} = ss 0 0 1 (ss = single step)</span>
00861 <span class="comment"></span>
00862 <span class="comment">    ISR{15:7} = fp trap code.</span>
00863 <span class="comment">    </span>
00864 <span class="comment">--*/</span>
00865 
00866 {
00867     PEXCEPTION_RECORD ExceptionRecord;
00868     ULONGLONG SavedISR = TrapFrame-&gt;StISR;
00869 
00870     <span class="comment">//</span>
00871     <span class="comment">// Initialize the exception record</span>
00872     <span class="comment">//</span>
00873 
00874     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
00875     ExceptionRecord-&gt;ExceptionAddress = 
00876            (PVOID) RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP,
00877                                  ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI));
00878 
00879     ExceptionRecord-&gt;ExceptionFlags = 0;
00880     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00881 
00882     ExceptionRecord-&gt;NumberParameters = 5;
00883     ExceptionRecord-&gt;ExceptionInformation[0] = 0;
00884     ExceptionRecord-&gt;ExceptionInformation[1] = 0;
00885     ExceptionRecord-&gt;ExceptionInformation[2] = 0;
00886     ExceptionRecord-&gt;ExceptionInformation[3] = TrapFrame-&gt;StIIPA;
00887     ExceptionRecord-&gt;ExceptionInformation[4] = TrapFrame-&gt;StISR;
00888 
00889     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_MULTIPLE_TRAPS;
00890 
00891     <span class="comment">//</span>
00892     <span class="comment">// check for single-step trap</span>
00893     <span class="comment">//</span>
00894     
00895     <span class="keywordflow">if</span> (SavedISR &amp; (1i64 &lt;&lt; ISR_SS_TRAP)) {
00896         <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a8">KiSingleStep</a>(TrapFrame);
00897     }
00898 
00899     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00900 }
00901 
00902 
00903 <span class="preprocessor">#pragma warning( disable : 4715 ) // not all control paths return a value</span>
00904 <span class="preprocessor"></span>    
00905 EXCEPTION_DISPOSITION
<a name="l00906"></a><a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a11">00906</a> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a11">KiSystemServiceHandler</a> (
00907     IN PEXCEPTION_RECORD ExceptionRecord,
00908     IN FRAME_POINTERS EstablisherFrame,
00909     IN OUT PCONTEXT ContextRecord,
00910     IN OUT PDISPATCHER_CONTEXT DispatcherContext
00911     )
00912 
00913 <span class="comment">/*++</span>
00914 <span class="comment"></span>
00915 <span class="comment">Routine Description:</span>
00916 <span class="comment"></span>
00917 <span class="comment">    Control reaches here when a exception is raised in a system service</span>
00918 <span class="comment">    or the system service dispatcher, and for an unwind during a kernel</span>
00919 <span class="comment">    exception.</span>
00920 <span class="comment"></span>
00921 <span class="comment">    If an unwind is being performed and the system service dispatcher is</span>
00922 <span class="comment">    the target of the unwind, then an exception occured while attempting</span>
00923 <span class="comment">    to copy the user's in-memory argument list. Control is transfered to</span>
00924 <span class="comment">    the system service exit by return a continue execution disposition</span>
00925 <span class="comment">    value.</span>
00926 <span class="comment"></span>
00927 <span class="comment">    If an unwind is being performed and the previous mode is user, then</span>
00928 <span class="comment">    bug check is called to crash the system. It is not valid to unwind</span>
00929 <span class="comment">    out of a system service into user mode.</span>
00930 <span class="comment"></span>
00931 <span class="comment">    If an unwind is being performed, the previous mode is kernel, the</span>
00932 <span class="comment">    system service dispatcher is not the target of the unwind, and the</span>
00933 <span class="comment">    thread does not own any mutexes, then the previous mode field from</span>
00934 <span class="comment">    the trap frame is restored to the thread object. Otherwise, bug</span>
00935 <span class="comment">    check is called to crash the system. It is invalid to unwind out of</span>
00936 <span class="comment">    a system service while owning a mutex.</span>
00937 <span class="comment"></span>
00938 <span class="comment">    If an exception is being raised and the exception PC is within the</span>
00939 <span class="comment">    range of the system service dispatcher in-memory argument copy code,</span>
00940 <span class="comment">    then an unwind to the system service exit code is initiated.</span>
00941 <span class="comment"></span>
00942 <span class="comment">    If an exception is being raised and the exception PC is not within</span>
00943 <span class="comment">    the range of the system service dispatcher, and the previous mode is</span>
00944 <span class="comment">    not user, then a continue searh disposition value is returned. Otherwise,</span>
00945 <span class="comment">    a system service has failed to handle an exception and bug check is</span>
00946 <span class="comment">    called. It is invalid for a system service not to handle all exceptions</span>
00947 <span class="comment">    that can be raised in the service.</span>
00948 <span class="comment"></span>
00949 <span class="comment">Arguments:</span>
00950 <span class="comment"></span>
00951 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00952 <span class="comment"></span>
00953 <span class="comment">    EstablisherFrame - Supplies the frame pointer of the establisher</span>
00954 <span class="comment">        of this exception handler.</span>
00955 <span class="comment"></span>
00956 <span class="comment">        N.B. This is not actually the frame pointer of the establisher of</span>
00957 <span class="comment">             this handler. It is actually the stack pointer of the caller</span>
00958 <span class="comment">             of the system service. Therefore, the establisher frame pointer</span>
00959 <span class="comment">             is not used and the address of the trap frame is determined by</span>
00960 <span class="comment">             examining the saved s8 register in the context record.</span>
00961 <span class="comment"></span>
00962 <span class="comment">    ContextRecord - Supplies a pointer to a context record.</span>
00963 <span class="comment"></span>
00964 <span class="comment">    DispatcherContext - Supplies a pointer to  the dispatcher context</span>
00965 <span class="comment">        record.</span>
00966 <span class="comment"></span>
00967 <span class="comment">Return Value:</span>
00968 <span class="comment"></span>
00969 <span class="comment">    If bug check is called, there is no return from this routine and the</span>
00970 <span class="comment">    system is crashed. If an exception occured while attempting to copy</span>
00971 <span class="comment">    the user in-memory argument list, then there is no return from this</span>
00972 <span class="comment">    routine, and unwind is called. Otherwise, ExceptionContinueSearch is</span>
00973 <span class="comment">    returned as the function value.</span>
00974 <span class="comment"></span>
00975 <span class="comment">--*/</span>
00976 {
00977     CONTEXT Context;
00978     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00979     PKTRAP_FRAME TrapFrame;
00980     ULONG_PTR ExceptionAddress;
00981 
00982     <span class="keyword">extern</span> ULONG KiSystemServiceStartOffset;
00983     <span class="keyword">extern</span> ULONG KiSystemServiceEndOffset;
00984     <span class="keyword">extern</span> ULONG KiSystemServiceExitOffset;
00985 
00986     <span class="keywordflow">if</span> (IS_UNWINDING(ExceptionRecord-&gt;ExceptionFlags)) {
00987 
00988         <span class="comment">//</span>
00989         <span class="comment">// An unwind is in progress.</span>
00990         <span class="comment">// If a target unwind is being performed, then continue execution</span>
00991         <span class="comment">// is returned to transfer control to the system service exit</span>
00992         <span class="comment">// code.  Otherwise, restore the previous mode if the previous</span>
00993         <span class="comment">// mode is not user and there is no mutex owned by the current</span>
00994         <span class="comment">// thread.</span>
00995         <span class="comment">//</span>
00996 
00997         <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a30">EXCEPTION_TARGET_UNWIND</a>) {
00998             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a37">ExceptionContinueSearch</a>;
00999         } <span class="keywordflow">else</span> {
01000 
01001             Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
01002             <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o50">PreviousMode</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01003 
01004                 <span class="comment">//</span>
01005                 <span class="comment">// Previous mode is kernel and no mutex owned.</span>
01006                 <span class="comment">//</span>
01007                 <span class="comment">// N.B. System convention: unwinder puts the trap frame</span>
01008                 <span class="comment">//                         address in IntT0 field of</span>
01009                 <span class="comment">//                         context record when it </span>
01010                 <span class="comment">//                         encounters an interrupt region.</span>
01011                 <span class="comment">//</span>
01012 
01013                 TrapFrame = (PKTRAP_FRAME) ContextRecord-&gt;IntT0;
01014                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o50">PreviousMode</a> = (<a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>)TrapFrame-&gt;PreviousMode;
01015                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a37">ExceptionContinueSearch</a>;
01016 
01017             } <span class="keywordflow">else</span> {
01018 
01019                 <span class="comment">//</span>
01020                 <span class="comment">// Previous mode is user, call bug check.</span>
01021                 <span class="comment">//</span>
01022 
01023                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a21">SYSTEM_UNWIND_PREVIOUS_USER</a>);
01024             }
01025         }
01026     } <span class="keywordflow">else</span> {
01027 
01028         ULONG IsrCode;
01029 
01030         <span class="comment">//</span>
01031         <span class="comment">// An exception dispatching is in progress.</span>
01032         <span class="comment">// If the exception PC is within the in-memory argument copy code</span>
01033         <span class="comment">// of the system service dispatcher, then call unwind to transfer</span>
01034         <span class="comment">// control to the system service exit code.  Otherwise, check if</span>
01035         <span class="comment">// the previous mode is user or kernel mode.</span>
01036         <span class="comment">//</span>
01037 
01038         ExceptionAddress = (ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress;
01039         <span class="keywordflow">if</span> ((ExceptionAddress &lt; MM_EPC_VA+KiSystemServiceStartOffset) ||
01040             (ExceptionAddress &gt;= MM_EPC_VA+KiSystemServiceEndOffset))
01041         {
01042             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
01043 
01044                 <span class="comment">//</span>
01045                 <span class="comment">// Previous mode is user, call bug check.</span>
01046                 <span class="comment">//</span>
01047 
01048                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a20">SYSTEM_SERVICE_EXCEPTION</a>);
01049 
01050             } <span class="keywordflow">else</span> {
01051 
01052                 <span class="comment">//</span>
01053                 <span class="comment">// Previous mode is kernel, continue to search</span>
01054                 <span class="comment">//</span>
01055 
01056                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a37">ExceptionContinueSearch</a>;
01057             }
01058         } <span class="keywordflow">else</span> {
01059             IsrCode = (ULONG)((ExceptionRecord-&gt;ExceptionInformation[4] &gt;&gt; ISR_CODE) &amp; ISR_CODE_MASK) &gt;&gt; 4;
01060             <span class="keywordflow">if</span> ( (IsrCode == ISR_NAT_REG) || (IsrCode == ISR_NAT_PAGE) ) {
01061                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"WARNING: Kernel hit a Nat Consumpation Fault\n"</span>);
01062                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"WARNING: At %p\n"</span>, ExceptionRecord-&gt;ExceptionAddress);
01063             }
01064 <span class="preprocessor">#pragma warning( disable : 4312 ) // disabling warning on PVOID casting for the ExceptionCode</span>
01065 <span class="preprocessor"></span>            <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a12">RtlUnwind2</a>(EstablisherFrame, 
01066                        (PVOID)(MM_EPC_VA+KiSystemServiceExitOffset),
01067                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (PVOID)ExceptionRecord-&gt;ExceptionCode, &amp;Context);
01068 <span class="preprocessor">#pragma warning ( default: 4312 )</span>
01069 <span class="preprocessor"></span>        }
01070     }
01071 
01072 
01073 } <span class="comment">// KiSystemServiceHandler( )</span>
01074 
01075 <span class="preprocessor">#pragma warning( default : 4715 )</span>
01076 <span class="preprocessor"></span>
01077 
01078 BOOLEAN
<a name="l01079"></a><a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a12">01079</a> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a12">KiUnalignedFault</a> (
01080     IN PKTRAP_FRAME TrapFrame
01081     )
01082 <span class="comment">/*++</span>
01083 <span class="comment"></span>
01084 <span class="comment">Routine Description:</span>
01085 <span class="comment"></span>
01086 <span class="comment">    Handler for unaligned data reference. </span>
01087 <span class="comment"></span>
01088 <span class="comment">Arguments:</span>
01089 <span class="comment"></span>
01090 <span class="comment">    TrapFrame - Pointer to the trap frame.</span>
01091 <span class="comment"></span>
01092 <span class="comment">Return Value:</span>
01093 <span class="comment"></span>
01094 <span class="comment">    None.</span>
01095 <span class="comment"></span>
01096 <span class="comment">Notes:</span>
01097 <span class="comment"></span>
01098 <span class="comment">    ISR.ei bits indicate which instruction caused the exception.</span>
01099 <span class="comment"></span>
01100 <span class="comment">--*/</span>
01101 
01102 {
01103     PEXCEPTION_RECORD ExceptionRecord;
01104     PVOID VirtualAddress;
01105 
01106     VirtualAddress = (PVOID)TrapFrame-&gt;StIFA;
01107     
01108     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
01109     ExceptionRecord-&gt;ExceptionAddress =
01110         (PVOID)RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP,
01111                    ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI));
01112     
01113     ExceptionRecord-&gt;ExceptionFlags = 0;
01114     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01115     
01116     ExceptionRecord-&gt;NumberParameters = 5;
01117     ExceptionRecord-&gt;ExceptionInformation[0] = (ULONG_PTR)0;
01118     ExceptionRecord-&gt;ExceptionInformation[1] = (ULONG_PTR)VirtualAddress;
01119     ExceptionRecord-&gt;ExceptionInformation[2] = (ULONG_PTR)0;
01120     ExceptionRecord-&gt;ExceptionInformation[3] = (ULONG_PTR)TrapFrame-&gt;StIIPA;
01121     ExceptionRecord-&gt;ExceptionInformation[4] = (ULONG_PTR)TrapFrame-&gt;StISR;
01122 
01123     ExceptionRecord-&gt;ExceptionCode = STATUS_DATATYPE_MISALIGNMENT;
01124 
01125     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01126 }       
01127 
01128 
01129 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01130"></a><a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a13">01130</a> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a13">KiAdvanceInstPointer</a>(
01131     IN PKTRAP_FRAME TrapFrame
01132     )
01133 
01134 <span class="comment">/*++</span>
01135 <span class="comment"></span>
01136 <span class="comment">Routine Description:</span>
01137 <span class="comment"></span>
01138 <span class="comment">    This function is called to advance the instruction pointer in the trap frame. </span>
01139 <span class="comment"></span>
01140 <span class="comment">Arguments:</span>
01141 <span class="comment"></span>
01142 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
01143 <span class="comment"></span>
01144 <span class="comment">Return Value:</span>
01145 <span class="comment"></span>
01146 <span class="comment">    The intruction pointer in the trap frame has been advanced. </span>
01147 <span class="comment"></span>
01148 <span class="comment">--*/</span>
01149 
01150 {
01151 
01152     ULONGLONG PsrRi;
01153  
01154     PsrRi = ((TrapFrame-&gt;StIPSR &gt;&gt; PSR_RI) &amp; 3i64) + 1;
01155     
01156     <span class="keywordflow">if</span> (PsrRi == 3) {
01157         
01158         PsrRi = 0;
01159         TrapFrame-&gt;StIIP += 16;
01160             
01161     }
01162         
01163     TrapFrame-&gt;StIPSR &amp;= ~(3i64 &lt;&lt; PSR_RI); 
01164     TrapFrame-&gt;StIPSR |= (PsrRi &lt;&lt; PSR_RI);
01165 
01166     <span class="keywordflow">return</span>;
01167 }
01168 
01169 <span class="preprocessor">#if _MERCED_A0_</span>
01170 <span class="preprocessor"></span>
01171 <span class="keyword">typedef</span> <span class="keyword">struct </span>_CHECK_INST {
01172     <span class="keyword">union </span>{
01173         <span class="keyword">struct </span>{
01174             ULONGLONG qp:    6;
01175             ULONGLONG imm7:  7;
01176             ULONGLONG r2:    7;
01177             ULONGLONG imm13:13;
01178             ULONGLONG x3:    3;
01179             ULONGLONG s:     1;
01180             ULONGLONG Op:    4;
01181             ULONGLONG Rsv:   23; 
01182         } i;
01183         ULONGLONG Ulong64;
01184     } u;
01185 } CHECK_INST;
01186 
01187 BOOLEAN
01188 KiEmulateSpeculationFault(
01189     IN PKTRAP_FRAME TrapFrame
01190     )
01191 {
01192     PULONGLONG BundleAddress;
01193     ULONGLONG BundleLow;
01194     ULONGLONG BundleHigh;
01195     ULONG SlotNumber;
01196     CHECK_INST CheckInst;
01197     ISR Isr;
01198     ULONGLONG Imm24;
01199 
01200     BundleAddress = (PULONGLONG)TrapFrame-&gt;StIIP;
01201 
01202     BundleLow = *BundleAddress;
01203     BundleHigh = *(BundleAddress+1);
01204     
01205     Isr.ull = TrapFrame-&gt;StISR;
01206     SlotNumber = (ULONG)Isr.sb.isr_ei; 
01207 
01208     <span class="comment">//</span>
01209     <span class="comment">// Align instruction</span>
01210     <span class="comment">//</span>
01211     
01212     <span class="keywordflow">switch</span> (SlotNumber) {
01213         <span class="keywordflow">case</span> 0:
01214             CheckInst.u.Ulong64 = BundleLow &gt;&gt; 5;
01215             <span class="keywordflow">break</span>;
01216 
01217         <span class="keywordflow">case</span> 1:
01218             CheckInst.u.Ulong64 = (BundleLow &gt;&gt; 46) | (BundleHigh &lt;&lt; 18);
01219             <span class="keywordflow">break</span>;
01220 
01221         <span class="keywordflow">case</span> 2:
01222             CheckInst.u.Ulong64 = (BundleHigh &gt;&gt; 23);
01223             <span class="keywordflow">break</span>;
01224     }
01225     
01226     <span class="comment">//</span>
01227     <span class="comment">// Extract immediate value</span>
01228     <span class="comment">//</span>
01229 
01230     Imm24 = ((CheckInst.u.i.imm13 &lt;&lt; 7)|(CheckInst.u.i.imm7)) &lt;&lt; 4; 
01231 
01232     <span class="keywordflow">if</span> (CheckInst.u.i.s == 1) {
01233 
01234         Imm24 = 0xFFFFFFFFFF000000|Imm24;
01235 
01236     }
01237 
01238     TrapFrame-&gt;StIIP += Imm24;
01239 
01240     TrapFrame-&gt;StIPSR &amp;= ~(3i64 &lt;&lt; PSR_RI); 
01241 
01242     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01243 }
01244 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
