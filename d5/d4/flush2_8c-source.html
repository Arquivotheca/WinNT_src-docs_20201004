<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: flush2.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>flush2.c</h1><a href="../../d4/d5/flush2_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Module Name:</span>
00004 <span class="comment"></span>
00005 <span class="comment">    flush2.c</span>
00006 <span class="comment"></span>
00007 <span class="comment">Abstract:</span>
00008 <span class="comment"></span>
00009 <span class="comment">    This module implements IA64 version of KeFlushIoBuffers.</span>
00010 <span class="comment"></span>
00011 <span class="comment">    N.B. May be implemented as a macro.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    07-July-1998</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode only.</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00026 
00027 
00028 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00029"></a><a class="code" href="../../d4/d5/flush2_8c.html#a0">00029</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a9">KeFlushIoBuffers</a> (
00030     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
00031     IN BOOLEAN ReadOperation,
00032     IN BOOLEAN DmaOperation
00033     )
00034 <span class="comment">/*++</span>
00035 <span class="comment"></span>
00036 <span class="comment">Routine Description:</span>
00037 <span class="comment"></span>
00038 <span class="comment">   This function flushes the I/O buffer specified by the memory descriptor</span>
00039 <span class="comment">   list from the data cache on the processor which executes.</span>
00040 <span class="comment"></span>
00041 <span class="comment">Arugements:</span>
00042 <span class="comment"></span>
00043 <span class="comment">   Mdl - Supplies a pointer to a memory descriptor list that describes the</span>
00044 <span class="comment">       I/O buffer location.</span>
00045 <span class="comment"></span>
00046 <span class="comment">   ReadOperation - Supplies a boolean value that determines whether the I/O</span>
00047 <span class="comment">       operation is a read into memory.</span>
00048 <span class="comment"></span>
00049 <span class="comment">   DmaOperation - Supplies a boolean value that deternines whether the I/O</span>
00050 <span class="comment">       operation is a DMA operation.</span>
00051 <span class="comment"></span>
00052 <span class="comment">Return Value:</span>
00053 <span class="comment"></span>
00054 <span class="comment">   None.</span>
00055 <span class="comment"></span>
00056 <span class="comment">--*/</span>
00057 {
00058     KIRQL  OldIrql;
00059     ULONG  Length, PartialLength, <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00060     PFN_NUMBER  PageFrameIndex;
00061     PPFN_NUMBER Page;
00062     PVOID CurrentVAddress = 0;
00063 
00064     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;=  KiSynchIrql);
00065 
00066     <span class="comment">//</span>
00067     <span class="comment">// If the operation is a DMA operation, then check if the flush</span>
00068     <span class="comment">// can be avoided because the host system supports the right set</span>
00069     <span class="comment">// of cache coherency attributes. Otherwise, the flush can also</span>
00070     <span class="comment">// be avoided if the operation is a programmed I/O and not a page</span>
00071     <span class="comment">// read.</span>
00072     <span class="comment">//</span>
00073 
00074     <span class="keywordflow">if</span> (DmaOperation != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00075         <span class="keywordflow">if</span> (ReadOperation != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00076 
00077         <span class="comment">//</span>
00078         <span class="comment">// Yes, it is a DMA operation, and yes, it is a read. IA64</span>
00079         <span class="comment">// I-Caches DO snoop for DMA cycles.</span>
00080         <span class="comment">//</span>
00081             <span class="keywordflow">return</span>;
00082         } <span class="keywordflow">else</span> {
00083              <span class="comment">//</span>
00084              <span class="comment">// It is a DMA Write operation</span>
00085              <span class="comment">//</span>
00086              __mf();
00087              <span class="keywordflow">return</span>;
00088         }
00089 
00090     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Mdl-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a18">MDL_IO_PAGE_READ</a>) == 0) {
00091         <span class="comment">//</span>
00092         <span class="comment">// It is a PIO operation and it is not Page in operation</span>
00093         <span class="comment">//</span>
00094         <span class="keywordflow">return</span>;
00095     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReadOperation != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00096 
00097         <span class="comment">//</span>
00098         <span class="comment">// It is a PIO operation, it is Read operation and is Page in</span>
00099         <span class="comment">// operation.</span>
00100         <span class="comment">// We need to sweep the cache.</span>
00101         <span class="comment">// Sweeping the range covered by the mdl will be broadcast to the</span>
00102         <span class="comment">// other processors by the h/w coherency mechanism.</span>
00103         <span class="comment">//</span>
00104         <span class="comment">// Raise IRQL to synchronization level to prevent a context switch.</span>
00105         <span class="comment">//</span>
00106 
00107         OldIrql = KeRaiseIrqlToSynchLevel();
00108 
00109         <span class="comment">//</span>
00110         <span class="comment">// Compute the number of pages to flush and the starting MDL page</span>
00111         <span class="comment">// frame address.</span>
00112         <span class="comment">//</span>
00113 
00114         Length = Mdl-&gt;ByteCount;
00115 
00116         <span class="keywordflow">if</span> ( !Length ) {
00117             <span class="keywordflow">return</span>;
00118         }
00119         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = Mdl-&gt;ByteOffset;
00120         PartialLength = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00121         <span class="keywordflow">if</span> (PartialLength &gt; Length) {
00122             PartialLength = Length;
00123         }
00124 
00125         Page = (PPFN_NUMBER)(Mdl + 1);
00126         PageFrameIndex = *Page;
00127         CurrentVAddress = ((PVOID)(KSEG3_BASE
00128                           | ((ULONG_PTR)(PageFrameIndex) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)
00129                           | <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>));
00130 
00131         <span class="comment">//</span>
00132         <span class="comment">// Region 4 maps 1:1 Virtual address to physical address</span>
00133         <span class="comment">//</span>
00134 
00135         HalSweepIcacheRange (
00136             CurrentVAddress,
00137             PartialLength
00138             );
00139 
00140         Page++;
00141         Length -= PartialLength;
00142 
00143         <span class="keywordflow">if</span> (Length) {
00144             PartialLength = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00145             <span class="keywordflow">do</span> {
00146                 PageFrameIndex = *Page;
00147                 CurrentVAddress = ((PVOID)(KSEG3_BASE
00148                     | ((ULONG_PTR)(PageFrameIndex) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)
00149                     | <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>));
00150 
00151                 <span class="keywordflow">if</span> (PartialLength &gt; Length) {
00152                     PartialLength = Length;
00153                 }
00154 
00155                 HalSweepIcacheRange (
00156                     CurrentVAddress,
00157                     PartialLength
00158                     );
00159 
00160                 Page++;
00161 
00162                 Length -= PartialLength;
00163             } <span class="keywordflow">while</span> (Length != 0);
00164         }
00165 
00166     <span class="comment">//</span>
00167     <span class="comment">// Synchronize the Instruction Prefetch pipe in the local processor.</span>
00168     <span class="comment">//</span>
00169 
00170     __synci();
00171     __isrlz();
00172 
00173     <span class="comment">//</span>
00174     <span class="comment">// Lower IRQL to its previous level and return.</span>
00175     <span class="comment">//</span>
00176    
00177     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00178     <span class="keywordflow">return</span>;
00179     }
00180 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
