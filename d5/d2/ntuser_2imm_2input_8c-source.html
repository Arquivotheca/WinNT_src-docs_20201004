<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: input.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>input.c</h1><a href="../../d4/d3/ntuser_2imm_2input_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: input.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* IME key input management routines for imm32 dll</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 01-Apr-1996 takaok       split from hotkey.c</span>
00010 <span class="comment">\**************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/w32_2ntuser_2imm_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="preprocessor">#ifdef HIRO_DEBUG</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#define D(x)    x</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00018"></a><a class="code" href="../../d4/d3/ntuser_2imm_2input_8c.html#a0">00018</a> <span class="preprocessor"></span><span class="preprocessor">#define D(x)</span>
00019 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00020 <span class="preprocessor"></span>
00021 <span class="comment">/***************************************************************************\</span>
00022 <span class="comment">* ImmProcessKey (Callback from Win32K.SYS)</span>
00023 <span class="comment">*</span>
00024 <span class="comment">* Call ImeProcessKey and IME hotkey handler</span>
00025 <span class="comment">*</span>
00026 <span class="comment">* History:</span>
00027 <span class="comment">* 01-Mar-1996 TakaoK       Created</span>
00028 <span class="comment">\***************************************************************************/</span>
00029 
<a name="l00030"></a><a class="code" href="../../d9/d0/immuser_8h.html#a48">00030</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d9/d0/immuser_8h.html#a48">ImmProcessKey</a>(
00031     HWND    hWnd,
00032     HKL     hkl,
00033     UINT    uVKey,
00034     LPARAM  lParam,
00035     DWORD   dwHotKeyID)
00036 {
00037     HIMC hIMC = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a5">ImmGetContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00038     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a> pImeDpi = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(hkl);
00039     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwReturn = 0;
00040 <span class="preprocessor">#if DBG</span>
00041 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (dwHotKeyID &gt;= IME_KHOTKEY_FIRST &amp;&amp; dwHotKeyID &lt;= IME_KHOTKEY_LAST) {
00042         TAGMSG2(DBGTAG_IMM, <span class="stringliteral">"ImmProcessKey: Kor IME Hotkeys should not come here: dwHotKeyID=%x, uVKey=%x"</span>, dwHotKeyID, uVKey);
00043     }
00044 <span class="preprocessor">#endif</span>
00045 <span class="preprocessor"></span>
00046     <a class="code" href="../../d4/d0/immcli_8h.html#a2">ImmAssert</a>(dwHotKeyID != IME_KHOTKEY_ENGLISH &amp;&amp;
00047               dwHotKeyID != IME_KHOTKEY_SHAPE_TOGGLE &amp;&amp;
00048               dwHotKeyID != IME_KHOTKEY_HANJACONVERT);
00049 
00050     <span class="comment">//</span>
00051     <span class="comment">// call ImeProcessKey</span>
00052     <span class="comment">//</span>
00053     <span class="keywordflow">if</span> (pImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00054         PINPUTCONTEXT pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hIMC);
00055 
00056         <span class="keywordflow">if</span> (pInputContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00057             BOOLEAN fTruncateWideVK = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00058             BOOLEAN fCallIme = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00059             BOOLEAN fSkipThisKey = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00060 
00061 <span class="preprocessor">#ifdef LATER</span>
00062 <span class="preprocessor"></span>
00063             <span class="comment">//</span>
00064             <span class="comment">// if the current imc is not open and IME doesn't need</span>
00065             <span class="comment">// keys when being closed, we don't pass any keyboard</span>
00066             <span class="comment">// input to ime except hotkey and keys that change</span>
00067             <span class="comment">// the keyboard status.</span>
00068             <span class="comment">//</span>
00069             <span class="keywordflow">if</span> ((pImeDpi-&gt;fdwProperty &amp; IME_PROP_NO_KEYS_ON_CLOSE) &amp;&amp;
00070                     !pInputContext-&gt;fOpen &amp;&amp;
00071                     uVKey != VK_SHIFT &amp;&amp;
00072                     uVKey != VK_CONTROL &amp;&amp;
00073                     uVKey != VK_CAPITAL &amp;&amp;
00074                     uVKey != VK_KANA &amp;&amp;
00075                     uVKey != VK_NUMLOCK &amp;&amp;
00076                     uVKey != VK_SCROLL) {
00077                 <span class="comment">// Check if Korea Hanja conversion mode</span>
00078                 <span class="keywordflow">if</span>(!(pimc-&gt;fdwConvMode &amp; IME_CMODE_HANJACONVERT)) {
00079                     fCallIme = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00080                 }
00081             }
00082             <span class="keywordflow">else</span>
00083 <span class="preprocessor">#endif</span>
00084 <span class="preprocessor"></span>            <span class="comment">//</span>
00085             <span class="comment">// Protect IMEs which are unaware of wide virtual keys.</span>
00086             <span class="comment">//</span>
00087             <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)uVKey == VK_PACKET &amp;&amp;
00088                     (pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_ACCEPT_WIDE_VKEY) == 0) {
00089 
00090                 <span class="keywordflow">if</span> (pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_UNICODE) {
00091                     <span class="comment">//</span>
00092                     <span class="comment">// Since this IME is not ready to accept wide VKey, we should</span>
00093                     <span class="comment">// truncate it.</span>
00094                     <span class="comment">//</span>
00095                     fTruncateWideVK = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00096                 }
00097                 <span class="keywordflow">else</span> {
00098                     <span class="comment">//</span>
00099                     <span class="comment">// Hmm, this guy is ANSI IME, and does not declare Wide Vkey awareness.</span>
00100                     <span class="comment">// Let's guess this one is not ready to accept Wide Vkey, so let's not</span>
00101                     <span class="comment">// pass it to this guy.</span>
00102                     <span class="comment">// And if it is opened, we'd better skip this key for safety.</span>
00103                     <span class="comment">//</span>
00104                     fCallIme = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00105                     <span class="keywordflow">if</span> (pInputContext-&gt;fOpen) {
00106                         fSkipThisKey = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00107                     }
00108                 }
00109             }
00110 
00111             <span class="keywordflow">if</span> (fCallIme) {
00112                 <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pbKeyState = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, 256);
00113 
00114                 <a class="code" href="../../d4/d0/immcli_8h.html#a2">ImmAssert</a>(fSkipThisKey == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00115 
00116                 <span class="keywordflow">if</span> (pbKeyState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00117                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d0/user32_8def.html#a46">GetKeyboardState</a>(pbKeyState)) {
00118                         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uVKeyIme = uVKey;
00119                         <span class="keywordflow">if</span> (fTruncateWideVK) {
00120                             uVKeyIme &amp;= 0xffff;
00121                         }
00122                         <span class="keywordflow">if</span> ( (*pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o22">ImeProcessKey</a>)(hIMC, uVKeyIme, lParam, pbKeyState) ) {
00123                             <span class="comment">//</span>
00124                             <span class="comment">// if the return value of ImeProcessKey is TRUE,</span>
00125                             <span class="comment">// it means the key is the one that the ime is</span>
00126                             <span class="comment">// waiting for.</span>
00127                             <span class="comment">//</span>
00128                             pInputContext-&gt;fChgMsg = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00129                             pInputContext-&gt;uSavedVKey = uVKey;
00130                             dwReturn |= <a class="code" href="../../d4/d5/conimep_8h.html#a47">IPHK_PROCESSBYIME</a>;
00131                         }
00132                     }
00133                     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pbKeyState);
00134                 }
00135             }
00136             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fSkipThisKey) {
00137                 dwReturn |= IPHK_SKIPTHISKEY;
00138                 <a class="code" href="../../d4/d0/immcli_8h.html#a2">ImmAssert</a>((dwReturn &amp; (<a class="code" href="../../d4/d5/conimep_8h.html#a47">IPHK_PROCESSBYIME</a> | <a class="code" href="../../d4/d5/conimep_8h.html#a46">IPHK_HOTKEY</a>)) == 0);
00139             }
00140             <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hIMC);
00141         }
00142         <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00143     }
00144 
00145     <span class="comment">//</span>
00146     <span class="comment">// call hotkey handler</span>
00147     <span class="comment">//</span>
00148     <span class="keywordflow">if</span> (dwHotKeyID != IME_INVALID_HOTKEY &amp;&amp; <a class="code" href="../../d4/d0/immcli_8h.html#a105">HotKeyIDDispatcher</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hIMC, hkl, dwHotKeyID)) {
00149         <span class="comment">// Backward compat:</span>
00150         <span class="comment">// On Japanese system, some applications may want VK_KANJI.</span>
00151         <span class="keywordflow">if</span> ((uVKey != VK_KANJI) ||
00152                 (dwHotKeyID != IME_JHOTKEY_CLOSE_OPEN)) {
00153             dwReturn |= <a class="code" href="../../d4/d5/conimep_8h.html#a46">IPHK_HOTKEY</a>;
00154         }
00155     }
00156 
00157     <span class="comment">//</span>
00158     <span class="comment">// some 3.x application doesn't like to see</span>
00159     <span class="comment">// VK_PROCESSKEY.</span>
00160     <span class="comment">//</span>
00161     <span class="keywordflow">if</span> (dwReturn &amp; <a class="code" href="../../d4/d5/conimep_8h.html#a47">IPHK_PROCESSBYIME</a>) {
00162 
00163         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwImeCompat = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a34">ImmGetAppCompatFlags</a>(hIMC);
00164 
00165         <span class="keywordflow">if</span> (dwImeCompat &amp; IMECOMPAT_NOVKPROCESSKEY) {
00166 
00167             <span class="comment">// Korea 3.x application doesn't like to see dummy finalize VK_PROCESSKEY</span>
00168             <span class="comment">// and IME hot key.</span>
00169 
00170             <span class="keywordflow">if</span> ( PRIMARYLANGID(LANGIDFROMLCID(GetSystemDefaultLCID())) == LANG_KOREAN &amp;&amp;
00171                  ( (uVKey == VK_PROCESSKEY) || (dwReturn &amp; <a class="code" href="../../d4/d5/conimep_8h.html#a46">IPHK_HOTKEY</a>) ) ) {
00172                 <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hIMC);
00173                 <span class="keywordflow">return</span> dwReturn;
00174             }
00175 
00176             <a class="code" href="../../d9/d0/immuser_8h.html#a49">ImmTranslateMessage</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, WM_KEYDOWN, VK_PROCESSKEY, lParam);
00177             dwReturn &amp;= ~<a class="code" href="../../d4/d5/conimep_8h.html#a47">IPHK_PROCESSBYIME</a>;
00178             dwReturn |= IPHK_SKIPTHISKEY;
00179         }
00180     }
00181     <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hIMC);
00182 
00183     <span class="keywordflow">return</span> dwReturn;
00184 }
00185 
<a name="l00186"></a><a class="code" href="../../d4/d3/ntuser_2imm_2input_8c.html#a1">00186</a> <span class="preprocessor">#define TRANSMSGCOUNT 256</span>
00187 <span class="preprocessor"></span>
00188 <span class="comment">/***************************************************************************\</span>
00189 <span class="comment">* ImmTranslateMessage (Called from user\client\ntstubs.c\TranslateMessage())</span>
00190 <span class="comment">*</span>
00191 <span class="comment">* Call ImeToAsciiEx()</span>
00192 <span class="comment">*</span>
00193 <span class="comment">* History:</span>
00194 <span class="comment">* 01-Mar-1996 TakaoK       Created</span>
00195 <span class="comment">\***************************************************************************/</span>
<a name="l00196"></a><a class="code" href="../../d9/d0/immuser_8h.html#a49">00196</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d0/immuser_8h.html#a49">ImmTranslateMessage</a>(
00197     HWND        hwnd,
00198     UINT        message,
00199     WPARAM      wParam,
00200     LPARAM      lParam)
00201 {
00202     HIMC hImc;
00203     PINPUTCONTEXT pInputContext;
00204     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fReturn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00205     HKL  hkl;
00206     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a> pImeDpi = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00207     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pbKeyState;
00208     PTRANSMSG pTransMsg;
00209     PTRANSMSGLIST pTransMsgList;
00210     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;
00211     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uVKey;
00212     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> iNum;
00213 
00214     UNREFERENCED_PARAMETER(wParam);
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">// we're interested in only those keyboard messages.</span>
00218     <span class="comment">//</span>
00219     <span class="keywordflow">switch</span> (message) {
00220     <span class="keywordflow">case</span> WM_KEYDOWN:
00221     <span class="keywordflow">case</span> WM_KEYUP:
00222     <span class="keywordflow">case</span> WM_SYSKEYDOWN:
00223     <span class="keywordflow">case</span> WM_SYSKEYUP:
00224         <span class="keywordflow">break</span>;
00225     <span class="keywordflow">default</span>:
00226         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00227     }
00228 
00229     <span class="comment">//</span>
00230     <span class="comment">// input context is necessary for further handling</span>
00231     <span class="comment">//</span>
00232     hImc = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a5">ImmGetContext</a>(hwnd);
00233     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
00234     <span class="keywordflow">if</span> (pInputContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00235         <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>(hwnd, hImc);
00236         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00237     }
00238 
00239     <span class="comment">//</span>
00240     <span class="comment">// At first, handle VK_PROCESSKEY generated by IME.</span>
00241     <span class="comment">//</span>
00242     <span class="keywordflow">if</span> (!pInputContext-&gt;fChgMsg) {
00243 
00244         <span class="keywordflow">if</span> ((iNum=pInputContext-&gt;dwNumMsgBuf) != 0) {
00245 
00246             pTransMsg = (PTRANSMSG)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hMsgBuf);
00247             <span class="keywordflow">if</span> (pTransMsg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00248                 <a class="code" href="../../d4/d3/ntuser_2imm_2input_8c.html#a4">ImmPostMessages</a>(hwnd, hImc, iNum, pTransMsg);
00249                 <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hMsgBuf);
00250                 fReturn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00251             }
00252 
00253             pInputContext-&gt;dwNumMsgBuf = 0;
00254         }
00255         <span class="keywordflow">goto</span> ExitITM;
00256     }
00257 
00258     pInputContext-&gt;fChgMsg = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// retrieve the keyboard layout and IME entry points</span>
00262     <span class="comment">//</span>
00263     hkl = <a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>( <a class="code" href="../../d3/d8/winmgrc_8c.html#a18">GetWindowThreadProcessId</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) );
00264     pImeDpi = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(hkl);
00265     <span class="keywordflow">if</span> (pImeDpi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00266         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmTranslateMessage pImeDpi is NULL(hkl=%x)"</span>, hkl);
00267         <span class="keywordflow">goto</span> ExitITM;
00268     }
00269 
00270     pbKeyState = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, 256);
00271     <span class="keywordflow">if</span> ( pbKeyState == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00272         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmTranslateMessage out of memory"</span> );
00273         <span class="keywordflow">goto</span> ExitITM;
00274     }
00275 
00276     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d0/user32_8def.html#a46">GetKeyboardState</a>(pbKeyState)) {
00277         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmTranslateMessage GetKeyboardState() failed"</span> );
00278         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>( pbKeyState );
00279         <span class="keywordflow">goto</span> ExitITM;
00280     }
00281 
00282     <span class="comment">//</span>
00283     <span class="comment">// Translate the saved vkey into character code if needed</span>
00284     <span class="comment">//</span>
00285     uVKey = pInputContext-&gt;uSavedVKey;
00286 
00287     <span class="keywordflow">if</span> (pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_KBD_CHAR_FIRST) {
00288 
00289         <span class="keywordflow">if</span> (pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_UNICODE) {
00290             WCHAR wcTemp;
00291 
00292             iNum = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a24">ToUnicode</a>(pInputContext-&gt;uSavedVKey, <span class="comment">// virtual-key code</span>
00293                              HIWORD(lParam),            <span class="comment">// scan code</span>
00294                              pbKeyState,                <span class="comment">// key-state array</span>
00295                              &amp;wcTemp,                   <span class="comment">// buffer for translated key</span>
00296                              1,                         <span class="comment">// size of buffer</span>
00297                              0);
00298             <span class="keywordflow">if</span> (iNum == 1) {
00299                 <span class="comment">//</span>
00300                 <span class="comment">// hi word            : unicode character code</span>
00301                 <span class="comment">// hi byte of lo word : zero</span>
00302                 <span class="comment">// lo byte of lo word : virtual key</span>
00303                 <span class="comment">//</span>
00304                 uVKey = (uVKey &amp; 0x00ff) | ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wcTemp &lt;&lt; 16);
00305             }
00306 
00307         } <span class="keywordflow">else</span> {
00308             WORD wTemp = 0;
00309 
00310             iNum = <a class="code" href="../../d3/d8/client_8c.html#a47">ToAsciiEx</a>(pInputContext-&gt;uSavedVKey, <span class="comment">// virtual-key code</span>
00311                              HIWORD(lParam),            <span class="comment">// scan code</span>
00312                              pbKeyState,                <span class="comment">// key-state array</span>
00313                              &amp;wTemp,                    <span class="comment">// buffer for translated key</span>
00314                              0,                         <span class="comment">// active-menu flag</span>
00315                              hkl);
00316             <a class="code" href="../../d4/d0/immcli_8h.html#a2">ImmAssert</a>(iNum &lt;= 2);
00317             <span class="keywordflow">if</span> (iNum &gt; 0) {
00318                 <span class="comment">//</span>
00319                 <span class="comment">// hi word            : should be zero</span>
00320                 <span class="comment">// hi byte of lo word : character code</span>
00321                 <span class="comment">// lo byte of lo word : virtual key</span>
00322                 <span class="comment">//</span>
00323                 uVKey = (uVKey &amp; 0x00FF) | ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wTemp &lt;&lt; 8);
00324 
00325                 <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)uVKey == VK_PACKET) {
00326                     <span class="comment">//</span>
00327                     <span class="comment">// If ANSI IME is wide vkey aware, its ImeToAsciiEx will receive the uVKey</span>
00328                     <span class="comment">// as follows:</span>
00329                     <span class="comment">//</span>
00330                     <span class="comment">//  31            24 23                         16 15                8 7             0</span>
00331                     <span class="comment">// +----------------+-----------------------------+-------------------+---------------+</span>
00332                     <span class="comment">// | 24~31:reserved | 16~23:trailing byte(if any) | 8~15:leading byte | 0~7:VK_PACKET |</span>
00333                     <span class="comment">// +----------------+-----------------------------+-------------------+---------------+</span>
00334                     <span class="comment">//</span>
00335                     <a class="code" href="../../d4/d0/immcli_8h.html#a2">ImmAssert</a>(pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_ACCEPT_WIDE_VKEY);
00336                 }
00337                 <span class="keywordflow">else</span> {
00338                     uVKey &amp;= 0xffff;
00339                 }
00340             }
00341         }
00342     }
00343 
00344     dwSize = FIELD_OFFSET(TRANSMSGLIST, TransMsg)
00345            + <a class="code" href="../../d4/d3/ntuser_2imm_2input_8c.html#a1">TRANSMSGCOUNT</a> * <span class="keyword">sizeof</span>(TRANSMSG);
00346 
00347     pTransMsgList = (PTRANSMSGLIST)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwSize);
00348 
00349     <span class="keywordflow">if</span> (pTransMsgList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00350         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmTranslateMessage out of memory"</span> );
00351         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pbKeyState);
00352         <span class="keywordflow">goto</span> ExitITM;
00353     }
00354 
00355     pTransMsgList-&gt;uMsgCount = <a class="code" href="../../d4/d3/ntuser_2imm_2input_8c.html#a1">TRANSMSGCOUNT</a>;
00356     iNum = (*pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o25">ImeToAsciiEx</a>)(uVKey,
00357                                         HIWORD(lParam),
00358                                         pbKeyState,
00359                                         pTransMsgList,
00360                                         0,
00361                                         hImc);
00362 
00363     <span class="keywordflow">if</span> (iNum &gt; <a class="code" href="../../d4/d3/ntuser_2imm_2input_8c.html#a1">TRANSMSGCOUNT</a>) {
00364 
00365         <span class="comment">//</span>
00366         <span class="comment">// The message buffer is not big enough. IME put messages</span>
00367         <span class="comment">// into hMsgBuf in the input context.</span>
00368         <span class="comment">//</span>
00369 
00370         pTransMsg = (PTRANSMSG)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hMsgBuf);
00371         <span class="keywordflow">if</span> (pTransMsg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00372             <a class="code" href="../../d4/d3/ntuser_2imm_2input_8c.html#a4">ImmPostMessages</a>(hwnd, hImc, iNum, pTransMsg);
00373             <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hMsgBuf);
00374         }
00375 
00376 <span class="preprocessor">#ifdef LATER</span>
00377 <span class="preprocessor"></span>        <span class="comment">// Shouldn't we need this ?</span>
00378         fReturn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00379 <span class="preprocessor">#endif</span>
00380 <span class="preprocessor"></span>
00381     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iNum &gt; 0) {
00382         <a class="code" href="../../d4/d3/ntuser_2imm_2input_8c.html#a4">ImmPostMessages</a>(hwnd, hImc, iNum, &amp;pTransMsgList-&gt;TransMsg[0]);
00383         fReturn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00384     }
00385 
00386     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pbKeyState);
00387     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pTransMsgList);
00388 
00389 ExitITM:
00390     <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00391     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00392     <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>(hwnd, hImc);
00393 
00394     <span class="keywordflow">return</span> fReturn;
00395 }
00396 
00397 <span class="comment">/***************************************************************************\</span>
00398 <span class="comment">* ImmPostMessages(Called from ImmTranslateMessage() )</span>
00399 <span class="comment">*</span>
00400 <span class="comment">*  Post IME messages to application. If application is 3.x, messages</span>
00401 <span class="comment">*  are translated to old IME messages.</span>
00402 <span class="comment">*</span>
00403 <span class="comment">* History:</span>
00404 <span class="comment">* 01-Mar-1996 TakaoK       Created</span>
00405 <span class="comment">\***************************************************************************/</span>
00406 
00407 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00408"></a><a class="code" href="../../d4/d3/ntuser_2imm_2input_8c.html#a4">00408</a> <a class="code" href="../../d4/d3/ntuser_2imm_2input_8c.html#a4">ImmPostMessages</a>(
00409     HWND      hWnd,
00410     HIMC      hImc,
00411     INT       iNum,
00412     PTRANSMSG pTransMsg)
00413 {
00414     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
00415     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAnsiIME;
00416     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a> pClientImc;
00417     PTRANSMSG pTransMsgTemp, pTransMsgBuf = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00418 
00419     <span class="comment">//</span>
00420     <span class="comment">// Check if the IME is unicode or not.</span>
00421     <span class="comment">// The message buffer contains unicode messages</span>
00422     <span class="comment">// if the IME is unicode.</span>
00423     <span class="comment">//</span>
00424     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
00425     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00426         RIPMSG1(RIP_WARNING,
00427                 <span class="stringliteral">"ImmPostMessages: Invalid hImc %lx."</span>, hImc);
00428         <span class="keywordflow">return</span>;
00429     }
00430 
00431     fAnsiIME = ! <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>);
00432     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00433 
00434     <span class="comment">//</span>
00435     <span class="comment">// translate messages to 3.x format if the App's version is 3.x.</span>
00436     <span class="comment">//</span>
00437     pTransMsgTemp = pTransMsg;
00438     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwExpWinVer &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) {
00439         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLangId = PRIMARYLANGID(
00440                                       LANGIDFROMLCID(
00441                                                     GetSystemDefaultLCID()));
00442         <span class="keywordflow">if</span> ( (dwLangId == LANG_KOREAN &amp;&amp; <a class="code" href="../../d2/d5/transsub_8c.html#a25">TransGetLevel</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>) == 3) ||
00443              dwLangId == LANG_JAPANESE ) {
00444 
00445             pTransMsgBuf = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, iNum * <span class="keyword">sizeof</span>(TRANSMSG));
00446             <span class="keywordflow">if</span> (pTransMsgBuf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00447                 RtlCopyMemory(pTransMsgBuf, pTransMsg, iNum * <span class="keyword">sizeof</span>(TRANSMSG));
00448                 iNum = <a class="code" href="../../d4/d3/ntuser_2imm_2input_8c.html#a5">WINNLSTranslateMessage</a>(iNum,
00449                                               pTransMsgBuf,
00450                                               hImc,
00451                                               fAnsiIME,
00452                                               dwLangId );
00453                 pTransMsgTemp = pTransMsgBuf;
00454             }
00455         }
00456     }
00457 
00458     <span class="keywordflow">for</span> (i = 0; i &lt; iNum; i++) {
00459         <span class="keywordflow">if</span> (fAnsiIME) {
00460             PostMessageA(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,
00461                     pTransMsgTemp-&gt;message,
00462                     pTransMsgTemp-&gt;wParam,
00463                     pTransMsgTemp-&gt;lParam);
00464         } <span class="keywordflow">else</span> {
00465             PostMessageW(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,
00466                     pTransMsgTemp-&gt;message,
00467                     pTransMsgTemp-&gt;wParam,
00468                     pTransMsgTemp-&gt;lParam);
00469         }
00470         pTransMsgTemp++;
00471     }
00472 
00473     <span class="keywordflow">if</span> (pTransMsgBuf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00474         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pTransMsgBuf);
00475     }
00476 }
00477 
<a name="l00478"></a><a class="code" href="../../d4/d3/ntuser_2imm_2input_8c.html#a5">00478</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d3/ntuser_2imm_2input_8c.html#a5">WINNLSTranslateMessage</a>(
00479     INT       iNum,        <span class="comment">// number of messages in the source buffer</span>
00480     PTRANSMSG pTransMsg,   <span class="comment">// source buffer that contains 4.0 style messages</span>
00481     HIMC      hImc,        <span class="comment">// input context handle</span>
00482     BOOL      fAnsi,       <span class="comment">// TRUE if pdwt contains ANSI messages</span>
00483     DWORD     dwLangId )   <span class="comment">// language ID ( KOREAN or JAPANESE )</span>
00484 {
00485     LPINPUTCONTEXT      pInputContext;
00486     LPCOMPOSITIONSTRING pCompStr;
00487     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uiRet = 0;
00488 
00489     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
00490     <span class="keywordflow">if</span> (pInputContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00491         <span class="keywordflow">return</span> uiRet;
00492     }
00493 
00494     pCompStr = (LPCOMPOSITIONSTRING)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>( pInputContext-&gt;hCompStr );
00495 
00496     <span class="keywordflow">if</span> (dwLangId == LANG_KOREAN) {
00497         uiRet = <a class="code" href="../../d7/d0/ktranmsg_8c.html#a3">WINNLSTranslateMessageK</a>((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)iNum,
00498                                         pTransMsg,
00499                                         pInputContext,
00500                                         pCompStr,
00501                                         fAnsi );
00502     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( dwLangId == LANG_JAPANESE ) {
00503         uiRet = <a class="code" href="../../d4/d8/jtranmsg_8c.html#a18">WINNLSTranslateMessageJ</a>((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)iNum,
00504                                         pTransMsg,
00505                                         pInputContext,
00506                                         pCompStr,
00507                                         fAnsi );
00508     }
00509 
00510     <span class="keywordflow">if</span> (pCompStr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00511         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCompStr);
00512     }
00513     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00514 
00515     <span class="keywordflow">return</span> uiRet;
00516 }
00517 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:23 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
