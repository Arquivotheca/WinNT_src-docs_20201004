<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: oplock.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>oplock.c File Reference</h1><code>#include "FsRtlP.h"</code><br>

<p>
<a href="../../d6/d1/oplock_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">_NONOPAQUE_OPLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/struct__WAITING__IRP.html">_WAITING_IRP</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a0">Dbg</a>&nbsp;&nbsp;&nbsp;(0x08000000)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a1">FILTER_OPLOCK_VALID_FLAGS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a2">NO_OPLOCK</a>&nbsp;&nbsp;&nbsp;(0x00000001)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a3">LEVEL_I_OPLOCK</a>&nbsp;&nbsp;&nbsp;(0x00000002)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a4">BATCH_OPLOCK</a>&nbsp;&nbsp;&nbsp;(0x00000004)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a5">FILTER_OPLOCK</a>&nbsp;&nbsp;&nbsp;(0x00000008)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a6">LEVEL_II_OPLOCK</a>&nbsp;&nbsp;&nbsp;(0x00000010)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a7">OPLOCK_TYPE_MASK</a>&nbsp;&nbsp;&nbsp;(0x0000001f)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a8">EXCLUSIVE</a>&nbsp;&nbsp;&nbsp;(0x00000040)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a9">PENDING</a>&nbsp;&nbsp;&nbsp;(0x00000080)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a10">OPLOCK_HELD_MASK</a>&nbsp;&nbsp;&nbsp;(0x000000c0)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a11">BREAK_TO_II</a>&nbsp;&nbsp;&nbsp;(0x00000100)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a12">BREAK_TO_NONE</a>&nbsp;&nbsp;&nbsp;(0x00000200)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a13">BREAK_TO_II_TO_NONE</a>&nbsp;&nbsp;&nbsp;(0x00000400)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a14">CLOSE_PENDING</a>&nbsp;&nbsp;&nbsp;(0x00000800)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a15">OPLOCK_BREAK_MASK</a>&nbsp;&nbsp;&nbsp;(0x00000f00)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>&nbsp;&nbsp;&nbsp;(NO_OPLOCK)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a17">OplockIGranted</a>&nbsp;&nbsp;&nbsp;(LEVEL_I_OPLOCK | EXCLUSIVE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a18">OpBatchGranted</a>&nbsp;&nbsp;&nbsp;(BATCH_OPLOCK   | EXCLUSIVE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a19">OpFilterGranted</a>&nbsp;&nbsp;&nbsp;(FILTER_OPLOCK  | EXCLUSIVE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a20">OpFilterReqPending</a>&nbsp;&nbsp;&nbsp;(FILTER_OPLOCK  | EXCLUSIVE | PENDING )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a21">OplockBreakItoII</a>&nbsp;&nbsp;&nbsp;(LEVEL_I_OPLOCK | EXCLUSIVE | BREAK_TO_II)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a22">OpBatchBreaktoII</a>&nbsp;&nbsp;&nbsp;(BATCH_OPLOCK   | EXCLUSIVE | BREAK_TO_II)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a23">OpFilterBreaktoII</a>&nbsp;&nbsp;&nbsp;(FILTER_OPLOCK  | EXCLUSIVE | BREAK_TO_II)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a24">OplockBreakItoNone</a>&nbsp;&nbsp;&nbsp;(LEVEL_I_OPLOCK | EXCLUSIVE | BREAK_TO_NONE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a25">OpBatchBreaktoNone</a>&nbsp;&nbsp;&nbsp;(BATCH_OPLOCK   | EXCLUSIVE | BREAK_TO_NONE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a26">OpFilterBreaktoNone</a>&nbsp;&nbsp;&nbsp;(FILTER_OPLOCK  | EXCLUSIVE | BREAK_TO_NONE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a27">OplockBreakItoIItoNone</a>&nbsp;&nbsp;&nbsp;(LEVEL_I_OPLOCK | EXCLUSIVE | BREAK_TO_II_NONE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a28">OpBatchBreaktoIItoNone</a>&nbsp;&nbsp;&nbsp;(BATCH_OPLOCK   | EXCLUSIVE | BREAK_TO_II_NONE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a29">OpFilterBreaktoIItoNone</a>&nbsp;&nbsp;&nbsp;(FILTER_OPLOCK  | EXCLUSIVE | BREAK_TO_II_NONE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a30">OpBatchClosePending</a>&nbsp;&nbsp;&nbsp;(BATCH_OPLOCK   | EXCLUSIVE | CLOSE_PENDING)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a31">OpFilterClosePending</a>&nbsp;&nbsp;&nbsp;(FILTER_OPLOCK  | EXCLUSIVE | CLOSE_PENDING)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>&nbsp;&nbsp;&nbsp;(LEVEL_II_OPLOCK)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a33">MODULE_POOL_TAG</a>&nbsp;&nbsp;&nbsp;('orSF')</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a34">OPLOCK_STATE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">_NONOPAQUE_OPLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a35">NONOPAQUE_OPLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">_NONOPAQUE_OPLOCK</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d8/struct__WAITING__IRP.html">_WAITING_IRP</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a37">WAITING_IRP</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d8/struct__WAITING__IRP.html">_WAITING_IRP</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a39">FsRtlAllocateOplock</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a40">FsRtlRequestExclusiveOplock</a> (IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> *Oplock, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a> OPTIONAL, IN <a class="el" href="../../d5/d2/oplock_8c.html#a34">OPLOCK_STATE</a> NextOplockState)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a41">FsRtlRequestOplockII</a> (IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> *Oplock, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a42">FsRtlAcknowledgeOplockBreak</a> (IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> Oplock, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN BOOLEAN GrantLevelII)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a43">FsRtlOpBatchBreakClosePending</a> (IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> Oplock, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a44">FsRtlOplockBreakNotify</a> (IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> Oplock, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a45">FsRtlOplockCleanup</a> (IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> Oplock, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a46">FsRtlOplockBreakToII</a> (IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> Oplock, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a79">POPLOCK_WAIT_COMPLETE_ROUTINE</a> CompletionRoutine OPTIONAL, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a80">POPLOCK_FS_PREPOST_IRP</a> PostIrpRoutine OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a47">FsRtlOplockBreakToNone</a> (IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> Oplock, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a79">POPLOCK_WAIT_COMPLETE_ROUTINE</a> CompletionRoutine OPTIONAL, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a80">POPLOCK_FS_PREPOST_IRP</a> PostIrpRoutine OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a48">FsRtlRemoveAndCompleteIrp</a> (IN PLIST_ENTRY Link)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a49">FsRtlWaitOnIrp</a> (IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> Oplock, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a79">POPLOCK_WAIT_COMPLETE_ROUTINE</a> CompletionRoutine OPTIONAL, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a80">POPLOCK_FS_PREPOST_IRP</a> PostIrpRoutine OPTIONAL, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a50">FsRtlCompletionRoutinePriv</a> (IN PVOID Context, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a51">FsRtlCancelWaitIrp</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a52">FsRtlCancelOplockIIIrp</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a53">FsRtlCancelExclusiveIrp</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a> (IN <a class="el" href="../../d0/d8/struct__WAITING__IRP.html">PWAITING_IRP</a> WaitingIrp)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a55">FsRtlNotifyCompletion</a> (IN PVOID Context, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a56">FsRtlInitializeOplock</a> (IN OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a> Oplock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a57">FsRtlUninitializeOplock</a> (IN OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a> Oplock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a58">FsRtlOplockFsctrl</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a> Oplock, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN ULONG OpenCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a59">FsRtlCheckOplock</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a> Oplock, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a79">POPLOCK_WAIT_COMPLETE_ROUTINE</a> CompletionRoutine OPTIONAL, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a80">POPLOCK_FS_PREPOST_IRP</a> PostIrpRoutine OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a60">FsRtlOplockIsFastIoPossible</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a> Oplock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/oplock_8c.html#a61">FsRtlCurrentBatchOplock</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a> Oplock)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a4" doxytag="oplock.c::BATCH_OPLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BATCH_OPLOCK&nbsp;&nbsp;&nbsp;(0x00000004)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00078">78</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01169">FsRtlCurrentBatchOplock()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="oplock.c::BREAK_TO_II" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BREAK_TO_II&nbsp;&nbsp;&nbsp;(0x00000100)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00089">89</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01678">FsRtlAcknowledgeOplockBreak()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="oplock.c::BREAK_TO_II_TO_NONE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BREAK_TO_II_TO_NONE&nbsp;&nbsp;&nbsp;(0x00000400)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00091">91</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01678">FsRtlAcknowledgeOplockBreak()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="oplock.c::BREAK_TO_NONE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BREAK_TO_NONE&nbsp;&nbsp;&nbsp;(0x00000200)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00090">90</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01678">FsRtlAcknowledgeOplockBreak()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="oplock.c::CLOSE_PENDING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CLOSE_PENDING&nbsp;&nbsp;&nbsp;(0x00000800)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00092">92</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="oplock.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(0x08000000)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00050">50</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="oplock.c::EXCLUSIVE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define EXCLUSIVE&nbsp;&nbsp;&nbsp;(0x00000040)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00084">84</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">FsRtlOplockFsctrl()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="oplock.c::FILTER_OPLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FILTER_OPLOCK&nbsp;&nbsp;&nbsp;(0x00000008)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00079">79</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l01169">FsRtlCurrentBatchOplock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="oplock.c::FILTER_OPLOCK_VALID_FLAGS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FILTER_OPLOCK_VALID_FLAGS          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(     \
    FILE_READ_ATTRIBUTES            |   \
    FILE_WRITE_ATTRIBUTES           |   \
    FILE_READ_DATA                  |   \
    FILE_READ_EA                    |   \
    FILE_EXECUTE                    |   \
    SYNCHRONIZE                     |   \
    READ_CONTROL                        \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00057">57</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="oplock.c::LEVEL_I_OPLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LEVEL_I_OPLOCK&nbsp;&nbsp;&nbsp;(0x00000002)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00077">77</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">FsRtlOplockFsctrl()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="oplock.c::LEVEL_II_OPLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LEVEL_II_OPLOCK&nbsp;&nbsp;&nbsp;(0x00000010)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00080">80</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01116">FsRtlOplockIsFastIoPossible()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">FsRtlRequestExclusiveOplock()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l01514">FsRtlRequestOplockII()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="oplock.c::MODULE_POOL_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MODULE_POOL_TAG&nbsp;&nbsp;&nbsp;('orSF')          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00235">235</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="oplock.c::NO_OPLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NO_OPLOCK&nbsp;&nbsp;&nbsp;(0x00000001)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00076">76</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">FsRtlRequestExclusiveOplock()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l01514">FsRtlRequestOplockII()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="oplock.c::NoOplocksHeld" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NoOplocksHeld&nbsp;&nbsp;&nbsp;(NO_OPLOCK)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00100">100</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01678">FsRtlAcknowledgeOplockBreak()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01221">FsRtlAllocateOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03519">FsRtlCancelExclusiveIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03396">FsRtlCancelOplockIIIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02111">FsRtlOplockBreakNotify()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l02249">FsRtlOplockCleanup()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="oplock.c::OpBatchBreaktoII" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OpBatchBreaktoII&nbsp;&nbsp;&nbsp;(BATCH_OPLOCK   | EXCLUSIVE | BREAK_TO_II)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00108">108</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="oplock.c::OpBatchBreaktoIItoNone" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OpBatchBreaktoIItoNone&nbsp;&nbsp;&nbsp;(BATCH_OPLOCK   | EXCLUSIVE | BREAK_TO_II_NONE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00116">116</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="oplock.c::OpBatchBreaktoNone" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OpBatchBreaktoNone&nbsp;&nbsp;&nbsp;(BATCH_OPLOCK   | EXCLUSIVE | BREAK_TO_NONE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00112">112</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="oplock.c::OpBatchClosePending" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OpBatchClosePending&nbsp;&nbsp;&nbsp;(BATCH_OPLOCK   | EXCLUSIVE | CLOSE_PENDING)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00119">119</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="oplock.c::OpBatchGranted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OpBatchGranted&nbsp;&nbsp;&nbsp;(BATCH_OPLOCK   | EXCLUSIVE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00103">103</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="oplock.c::OpFilterBreaktoII" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OpFilterBreaktoII&nbsp;&nbsp;&nbsp;(FILTER_OPLOCK  | EXCLUSIVE | BREAK_TO_II)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00109">109</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="oplock.c::OpFilterBreaktoIItoNone" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OpFilterBreaktoIItoNone&nbsp;&nbsp;&nbsp;(FILTER_OPLOCK  | EXCLUSIVE | BREAK_TO_II_NONE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00117">117</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="oplock.c::OpFilterBreaktoNone" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OpFilterBreaktoNone&nbsp;&nbsp;&nbsp;(FILTER_OPLOCK  | EXCLUSIVE | BREAK_TO_NONE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00113">113</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="oplock.c::OpFilterClosePending" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OpFilterClosePending&nbsp;&nbsp;&nbsp;(FILTER_OPLOCK  | EXCLUSIVE | CLOSE_PENDING)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00120">120</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="oplock.c::OpFilterGranted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OpFilterGranted&nbsp;&nbsp;&nbsp;(FILTER_OPLOCK  | EXCLUSIVE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00104">104</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="oplock.c::OpFilterReqPending" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OpFilterReqPending&nbsp;&nbsp;&nbsp;(FILTER_OPLOCK  | EXCLUSIVE | PENDING )          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00105">105</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">FsRtlOplockFsctrl()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">FsRtlRequestExclusiveOplock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="oplock.c::OPLOCK_BREAK_MASK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OPLOCK_BREAK_MASK&nbsp;&nbsp;&nbsp;(0x00000f00)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00094">94</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02111">FsRtlOplockBreakNotify()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02249">FsRtlOplockCleanup()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l01116">FsRtlOplockIsFastIoPossible()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="oplock.c::OPLOCK_HELD_MASK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OPLOCK_HELD_MASK&nbsp;&nbsp;&nbsp;(0x000000c0)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00087">87</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="oplock.c::OPLOCK_TYPE_MASK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OPLOCK_TYPE_MASK&nbsp;&nbsp;&nbsp;(0x0000001f)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00082">82</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="oplock.c::OplockBreakItoII" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OplockBreakItoII&nbsp;&nbsp;&nbsp;(LEVEL_I_OPLOCK | EXCLUSIVE | BREAK_TO_II)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00107">107</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="oplock.c::OplockBreakItoIItoNone" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OplockBreakItoIItoNone&nbsp;&nbsp;&nbsp;(LEVEL_I_OPLOCK | EXCLUSIVE | BREAK_TO_II_NONE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00115">115</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="oplock.c::OplockBreakItoNone" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OplockBreakItoNone&nbsp;&nbsp;&nbsp;(LEVEL_I_OPLOCK | EXCLUSIVE | BREAK_TO_NONE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00111">111</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="oplock.c::OplockIGranted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OplockIGranted&nbsp;&nbsp;&nbsp;(LEVEL_I_OPLOCK | EXCLUSIVE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00102">102</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="oplock.c::OplockIIGranted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OplockIIGranted&nbsp;&nbsp;&nbsp;(LEVEL_II_OPLOCK)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00122">122</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01678">FsRtlAcknowledgeOplockBreak()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02249">FsRtlOplockCleanup()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">FsRtlRequestExclusiveOplock()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l01514">FsRtlRequestOplockII()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="oplock.c::PENDING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PENDING&nbsp;&nbsp;&nbsp;(0x00000080)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00085">85</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02111">FsRtlOplockBreakNotify()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02249">FsRtlOplockCleanup()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">FsRtlRequestExclusiveOplock()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a35" doxytag="oplock.c::NONOPAQUE_OPLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">_NONOPAQUE_OPLOCK</a>  <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">NONOPAQUE_OPLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01221">FsRtlAllocateOplock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="oplock.c::OPLOCK_STATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef ULONG <a class="el" href="../../d2/d8/fsrtllks_8h.html#a12">OPLOCK_STATE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00128">128</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">FsRtlOplockFsctrl()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l01116">FsRtlOplockIsFastIoPossible()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="oplock.c::PNONOPAQUE_OPLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">_NONOPAQUE_OPLOCK</a> * <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01221">FsRtlAllocateOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03519">FsRtlCancelExclusiveIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03396">FsRtlCancelOplockIIIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03288">FsRtlCancelWaitIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01169">FsRtlCurrentBatchOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">FsRtlOplockFsctrl()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01116">FsRtlOplockIsFastIoPossible()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">FsRtlRequestExclusiveOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01514">FsRtlRequestOplockII()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l00413">FsRtlUninitializeOplock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="oplock.c::PWAITING_IRP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d8/struct__WAITING__IRP.html">_WAITING_IRP</a> * <a class="el" href="../../d0/d8/struct__WAITING__IRP.html">PWAITING_IRP</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01678">FsRtlAcknowledgeOplockBreak()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03519">FsRtlCancelExclusiveIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03288">FsRtlCancelWaitIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02249">FsRtlOplockCleanup()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00413">FsRtlUninitializeOplock()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l03025">FsRtlWaitOnIrp()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="oplock.c::WAITING_IRP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d8/struct__WAITING__IRP.html">_WAITING_IRP</a>  <a class="el" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a42" doxytag="oplock.c::FsRtlAcknowledgeOplockBreak" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlAcknowledgeOplockBreak           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Oplock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantLevelII</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l01678">1678</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00089">BREAK_TO_II</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00091">BREAK_TO_II_TO_NONE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00090">BREAK_TO_NONE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03396">FsRtlCancelOplockIIIrp()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03623">FsRtlRemoveAndCompleteWaitIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00100">IoAcquireCancelSpinLock()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07615">IoIsOperationSynchronous()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00100">NoOplocksHeld</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00122">OplockIIGranted</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">FsRtlOplockFsctrl()</a>.
<p>
<pre class="fragment"><div>01687                    :
01688 
01689     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a user <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acknowledging an Oplock I
01690     <span class="keywordflow">break</span>.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> level 1 oplock was being broken to level 2, then
01691     a check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to insure that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> level 2 has not been broken
01692     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> meantime.
01693 
01694     If an oplock 1 <span class="keywordflow">break</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not in progress then <span class="keyword">this</span> will be treated
01695     as an asynchronous <span class="keywordflow">break</span> request.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an asynchronous <span class="keywordflow">break</span>
01696     request and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object owns an outstanding level 1 oplock, then
01697     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock will be broken at <span class="keyword">this</span> point.
01698 
01699     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> spurious <span class="keywordflow">break</span> request via a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object which does not (or did not)
01700     own <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> level 1 oplock will generate a warning but will not affect
01701     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock state.
01702 
01703     At <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of an Oplock I <span class="keywordflow">break</span>, all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> waiting irps are completed.
01704 
01705 Arguments:
01706 
01707     Oplock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-opaque oplock structure <span class="keywordflow">for</span>
01708              <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01709 
01710     IrpSp - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> stack location <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
01711 
01712     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which declares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
01713           operation.
01714 
01715     GrantLevelII - Indicates that <span class="keyword">this</span> caller wants a level II oplock left
01716         on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01717 
01718 Return Value:
01719 
01720     STATUS_SUCCESS <span class="keywordflow">if</span> we can complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation on exiting <span class="keyword">this</span> thread.
01721     STATUS_CANCELLED <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cancelled before we <span class="keywordflow">return</span>.
01722 
01723 --*/
01724 
01725 {
01726     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01727 
01728     BOOLEAN AcquiredMutex;
01729 
01730     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlAcknowledgeOplockBreak:  Entered\n"</span>, 0 );
01731     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
01732     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"IrpSp     -&gt; %08lx\n"</span>, IrpSp );
01733     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, Irp );
01734 
01735     <span class="comment">//</span>
01736     <span class="comment">//  If there is no oplock structure, we complete this with invalid</span>
01737     <span class="comment">//  oplock protocol.</span>
01738     <span class="comment">//</span>
01739 
01740     <span class="keywordflow">if</span> (Oplock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01741 
01742         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_INVALID_OPLOCK_PROTOCOL );
01743         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlAcknowledgeOplockBreak:  Exit -&gt; %08lx\n"</span>, STATUS_INVALID_OPLOCK_PROTOCOL );
01744         <span class="keywordflow">return</span> STATUS_INVALID_OPLOCK_PROTOCOL;
01745     }
01746 
01747     <span class="comment">//</span>
01748     <span class="comment">//  Grab the synchronization object for the oplock.</span>
01749     <span class="comment">//</span>
01750 
01751     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
01752     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01753 
01754     <span class="comment">//</span>
01755     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01756     <span class="comment">//</span>
01757 
01758     <span class="keywordflow">try</span> {
01759 
01760         BOOLEAN DereferenceFileObject = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01761 
01762         <span class="comment">//</span>
01763         <span class="comment">//  If a break is underway but this is not the owner of the</span>
01764         <span class="comment">//  level 1 oplock, we complete the request and return a</span>
01765         <span class="comment">//  warning.</span>
01766         <span class="comment">//</span>
01767 
01768         <span class="keywordflow">if</span> (Oplock-&gt;FileObject != IrpSp-&gt;FileObject) {
01769 
01770             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OPLOCK_PROTOCOL;
01771             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
01772                        Dbg,
01773                        <span class="stringliteral">"Not oplock owner -&gt; %08lx\n"</span>,
01774                        Status);
01775 
01776             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, Status );
01777             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status );
01778         }
01779 
01780         <span class="comment">//</span>
01781         <span class="comment">//  If the user would like a level II and we are breaking to level II</span>
01782         <span class="comment">//  then grant the oplock.</span>
01783         <span class="comment">//</span>
01784 
01785         <span class="keywordflow">if</span> (GrantLevelII &amp;&amp;
01786             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, BREAK_TO_II )) {
01787 
01788             <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> OplockFastMutex = Oplock-&gt;FastMutex;
01789 
01790             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"OplockItoII\n"</span>, 0);
01791 
01792             <span class="comment">//</span>
01793             <span class="comment">//  The acknowledgement should never be synchronous.</span>
01794             <span class="comment">//</span>
01795 
01796             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d4/d6/iosubs_8c.html#a83">IoIsOperationSynchronous</a>( Irp ));
01797 
01798             <span class="comment">//</span>
01799             <span class="comment">//  We need to add this Irp to the oplock II queue, change</span>
01800             <span class="comment">//  the oplock state to Oplock II granted and set the</span>
01801             <span class="comment">//  return value to STATUS_PENDING.</span>
01802             <span class="comment">//</span>
01803 
01804 
01805             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp );
01806 
01807             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_SUCCESS;
01808 
01809             InsertHeadList( &amp;Oplock-&gt;IrpOplocksII,
01810                             &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.ListEntry );
01811 
01812             DereferenceFileObject = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01813 
01814             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>;
01815 
01816             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = (ULONG_PTR) Oplock;
01817 
01818             <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01819 
01820             <span class="comment">//</span>
01821             <span class="comment">//  Now if the irp is cancelled then we'll call the cancel</span>
01822             <span class="comment">//  routine right now to do away with the irp, otherwise</span>
01823             <span class="comment">//  we set the cancel routine</span>
01824             <span class="comment">//</span>
01825 
01826             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
01827 
01828                 AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01829 
01830                 <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( OplockFastMutex );
01831 
01832                 <a class="code" href="../../d5/d2/oplock_8c.html#a52">FsRtlCancelOplockIIIrp</a>( NULL, Irp );
01833 
01834             } <span class="keywordflow">else</span> {
01835 
01836                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, FsRtlCancelOplockIIIrp );
01837                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01838             }
01839 
01840             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PENDING;
01841 
01842         <span class="comment">//</span>
01843         <span class="comment">//  We will break to none since this is the expected case for these</span>
01844         <span class="comment">//  cases.</span>
01845         <span class="comment">//</span>
01846 
01847         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, BREAK_TO_II | BREAK_TO_NONE )) {
01848 
01849             <span class="comment">//</span>
01850             <span class="comment">//  We need to complete this Irp and return STATUS_SUCCESS.</span>
01851             <span class="comment">//  We also set the oplock state to no oplocks held.</span>
01852             <span class="comment">//</span>
01853 
01854             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"OplockItoNone\n"</span>, 0);
01855 
01856             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01857             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, Status );
01858             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
01859 
01860         <span class="comment">//</span>
01861         <span class="comment">//  In this case the user expects to be at level II.  He is</span>
01862         <span class="comment">//  expecting this Irp to be completed when the LevelII Oplock</span>
01863         <span class="comment">//  is broken.</span>
01864         <span class="comment">//</span>
01865 
01866         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, BREAK_TO_II_TO_NONE )) {
01867 
01868             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"AcknowledgeOplockBreak:  OplockItoIItoNone\n"</span>, 0);
01869 
01870             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01871             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
01872             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, Status );
01873             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
01874 
01875         } <span class="keywordflow">else</span> {
01876 
01877             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OPLOCK_PROTOCOL;
01878             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
01879                        Dbg,
01880                        <span class="stringliteral">"No break underway -&gt; %08lx\n"</span>,
01881                        Status);
01882 
01883             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, Status );
01884             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status );
01885         }
01886 
01887         <span class="comment">//</span>
01888         <span class="comment">//  Complete the waiting Irps and cleanup the oplock structure.</span>
01889         <span class="comment">//</span>
01890 
01891         <span class="keywordflow">while</span> (!IsListEmpty( &amp;Oplock-&gt;WaitingIrps )) {
01892 
01893             <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">PWAITING_IRP</a> WaitingIrp;
01894 
01895             <span class="comment">//</span>
01896             <span class="comment">//  Remove the entry found and complete the Irp.</span>
01897             <span class="comment">//</span>
01898 
01899             WaitingIrp = CONTAINING_RECORD( Oplock-&gt;WaitingIrps.Flink,
01900                                             <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
01901                                             Links );
01902 
01903             <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a>( WaitingIrp );
01904         }
01905 
01906         <span class="keywordflow">if</span> (DereferenceFileObject) {
01907 
01908             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Oplock-&gt;FileObject );
01909         }
01910 
01911         Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01912 
01913     try_exit:  NOTHING;
01914     } finally {
01915 
01916         <span class="comment">//</span>
01917         <span class="comment">//  Give up the oplock synchronization object.</span>
01918         <span class="comment">//</span>
01919 
01920         <span class="keywordflow">if</span> (AcquiredMutex) {
01921 
01922             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
01923         }
01924 
01925         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlAcknowledgeOplockBreak:  Exit -&gt; %08x\n"</span>, Status );
01926     }
01927 
01928     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01929 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="oplock.c::FsRtlAllocateOplock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> FsRtlAllocateOplock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l01221">1221</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00243">_NONOPAQUE_OPLOCK::FastMutex</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00040">FsRtlpAllocatePool</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00224">_NONOPAQUE_OPLOCK::IrpOplocksII</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a35">NONOPAQUE_OPLOCK</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00100">NoOplocksHeld</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00237">_NONOPAQUE_OPLOCK::OplockState</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, and <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00231">_NONOPAQUE_OPLOCK::WaitingIrps</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">FsRtlRequestExclusiveOplock()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l01514">FsRtlRequestOplockII()</a>.
<p>
<pre class="fragment"><div>01226                    :
01227 
01228     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to initialize and allocate an opaque oplock
01229     structure.  After allocation, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two events are set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> signalled
01230     state.  The oplock state <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> other
01231     fields are filled with zeroes.
01232 
01233     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation fails, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised.
01234 
01235 Arguments:
01236 
01237     None.
01238 
01239 Return Value:
01240 
01241     <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated structure.
01242 
01243 --*/
01244 
01245 {
01246     <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> NewOplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01247 
01248     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01249 
01250     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlAllocateOplock:  Entered\n"</span>, 0);
01251 
01252     <span class="comment">//</span>
01253     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01254     <span class="comment">//</span>
01255 
01256     <span class="keywordflow">try</span> {
01257 
01258         <span class="comment">//</span>
01259         <span class="comment">//  Raise an error status if the allocation is unsuccessful.</span>
01260         <span class="comment">//  The structure is allocated out of non-paged pool.</span>
01261         <span class="comment">//</span>
01262 
01263         NewOplock = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">NONOPAQUE_OPLOCK</a> ));
01264 
01265         RtlZeroMemory( NewOplock, <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">NONOPAQUE_OPLOCK</a> ));
01266 
01267         NewOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( NonPagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> ));
01268 
01269         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( NewOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
01270 
01271         InitializeListHead( &amp;NewOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a> );
01272         InitializeListHead( &amp;NewOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a> );
01273 
01274         NewOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
01275 
01276     } finally {
01277 
01278         <span class="comment">//</span>
01279         <span class="comment">//  Cleanup the oplock if abnormal termination.</span>
01280         <span class="comment">//</span>
01281 
01282         <span class="keywordflow">if</span> (AbnormalTermination() &amp;&amp; NewOplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01283 
01284             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewOplock );
01285         }
01286 
01287         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"GetOplockStructure:  Exit -&gt; %08lx\n"</span>, NewOplock);
01288     }
01289 
01290     <span class="keywordflow">return</span> NewOplock;
01291 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="oplock.c::FsRtlCancelExclusiveIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlCancelExclusiveIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l03519">3519</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00243">_NONOPAQUE_OPLOCK::FastMutex</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00217">_NONOPAQUE_OPLOCK::FileObject</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03623">FsRtlRemoveAndCompleteWaitIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00210">_NONOPAQUE_OPLOCK::IrpExclusiveOplock</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00100">NoOplocksHeld</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00237">_NONOPAQUE_OPLOCK::OplockState</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a>, and <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00231">_NONOPAQUE_OPLOCK::WaitingIrps</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">FsRtlRequestExclusiveOplock()</a>.
<p>
<pre class="fragment"><div>03526                    :
03527 
03528     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> either an exclusive or oplock I <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
03529 
03530 Arguments:
03531 
03532     DeviceObject - Ignored.
03533 
03534     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> being cancelled.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03535           Oplock structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information
03536           field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>'s Iosb.
03537 
03538 Return Value:
03539 
03540     None.
03541 
03542 --*/
03543 
03544 {
03545     <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> Oplock;
03546 
03547     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlCancelExclusiveIrp:  Entered\n"</span>, 0 );
03548 
03549     Oplock = (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
03550 
03551     <span class="comment">//</span>
03552     <span class="comment">//  We now need to void the cancel routine and release the spinlock</span>
03553     <span class="comment">//</span>
03554 
03555     <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, NULL );
03556     <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03557 
03558     <span class="comment">//</span>
03559     <span class="comment">//  Grab the synchronization object for this oplock.</span>
03560     <span class="comment">//</span>
03561 
03562     ExAcquireFastMutex( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
03563 
03564     <span class="keywordflow">try</span> {
03565 
03566         <span class="comment">//</span>
03567         <span class="comment">//  We look for the exclusive Irp, if present and cancelled</span>
03568         <span class="comment">//  we complete it.</span>
03569         <span class="comment">//</span>
03570 
03571         <span class="keywordflow">if</span> ((Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03572             (Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>)) {
03573 
03574             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a>, STATUS_CANCELLED );
03575             Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03576 
03577             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a> );
03578             Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03579             Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
03580 
03581             <span class="comment">//</span>
03582             <span class="comment">//  Complete the waiting Irps.</span>
03583             <span class="comment">//</span>
03584 
03585             <span class="keywordflow">while</span> (!IsListEmpty( &amp;Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a> )) {
03586 
03587                 <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">PWAITING_IRP</a> WaitingIrp;
03588 
03589                 <span class="comment">//</span>
03590                 <span class="comment">//  Remove the entry found and complete the Irp.</span>
03591                 <span class="comment">//</span>
03592 
03593                 WaitingIrp = CONTAINING_RECORD( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a>.Flink,
03594                                                 <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
03595                                                 Links );
03596 
03597                 <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a>( WaitingIrp );
03598             }
03599         }
03600 
03601     } finally {
03602 
03603         <span class="comment">//</span>
03604         <span class="comment">//  No matter how we exit we release the mutex</span>
03605         <span class="comment">//</span>
03606 
03607         ExReleaseFastMutex( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
03608 
03609         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlCancelExclusiveIrp:  Exit\n"</span>, 0 );
03610     }
03611 
03612     <span class="keywordflow">return</span>;
03613 
03614     UNREFERENCED_PARAMETER( DeviceObject );
03615 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="oplock.c::FsRtlCancelOplockIIIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlCancelOplockIIIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l03396">3396</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00243">_NONOPAQUE_OPLOCK::FastMutex</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02952">FsRtlRemoveAndCompleteIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00224">_NONOPAQUE_OPLOCK::IrpOplocksII</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00100">NoOplocksHeld</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00237">_NONOPAQUE_OPLOCK::OplockState</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01678">FsRtlAcknowledgeOplockBreak()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l01514">FsRtlRequestOplockII()</a>.
<p>
<pre class="fragment"><div>03403                    :
03404 
03405     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Oplock II
03406     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> queue.  We remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Cancel routine from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> and
03407     then call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> <span class="keywordflow">for</span> all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cancelled Irps on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03408     queue.
03409 
03410 Arguments:
03411 
03412     DeviceObject - Ignored.
03413 
03414     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> being cancelled.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03415           Oplock structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information
03416           field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>'s Iosb.
03417 
03418 Return Value:
03419 
03420     None.
03421 
03422 --*/
03423 
03424 {
03425     <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> Oplock;
03426     BOOLEAN LevelIIIrps;
03427 
03428     PLIST_ENTRY Links;
03429 
03430     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlCancelOplockIIIrp:  Entered\n"</span>, 0 );
03431 
03432     Oplock = (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
03433 
03434     <span class="comment">//</span>
03435     <span class="comment">//  We now need to void the cancel routine and release the spinlock</span>
03436     <span class="comment">//</span>
03437 
03438     <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, NULL );
03439     <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03440 
03441     LevelIIIrps = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03442 
03443     <span class="comment">//</span>
03444     <span class="comment">//  Iterate through all of the level II oplocks looking for a canceled one</span>
03445     <span class="comment">//  We do this under the protection of the oplock mutex.</span>
03446     <span class="comment">//</span>
03447 
03448     ExAcquireFastMutex( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
03449 
03450     <span class="keywordflow">try</span> {
03451 
03452         <span class="keywordflow">for</span> (Links = Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>.Flink;
03453              Links != &amp;Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>;
03454              Links = Links-&gt;Flink ) {
03455 
03456             <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> OplockIIIrp;
03457 
03458             <span class="comment">//</span>
03459             <span class="comment">//  Get a pointer to the Irp record</span>
03460             <span class="comment">//</span>
03461 
03462             OplockIIIrp = CONTAINING_RECORD( Links, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Overlay.ListEntry );
03463 
03464             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlCancelOplockIIIrp, Loop top, Irp = %08lx\n"</span>, OplockIIIrp);
03465 
03466             <span class="comment">//</span>
03467             <span class="comment">//  Check if the irp has been cancelled</span>
03468             <span class="comment">//</span>
03469 
03470             <span class="keywordflow">if</span> (OplockIIIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
03471 
03472                 <span class="comment">//</span>
03473                 <span class="comment">//  Now we need to remove this waiter and call the</span>
03474                 <span class="comment">//  completion routine.  But we must not mess up our link</span>
03475                 <span class="comment">//  iteration so we need to back up link one step and</span>
03476                 <span class="comment">//  then the next iteration will go to our current flink.</span>
03477                 <span class="comment">//</span>
03478 
03479                 Links = Links-&gt;Blink;
03480 
03481                 <a class="code" href="../../d5/d2/oplock_8c.html#a48">FsRtlRemoveAndCompleteIrp</a>( Links-&gt;Flink );
03482 
03483                 LevelIIIrps = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03484             }
03485         }
03486 
03487         <span class="comment">//</span>
03488         <span class="comment">//  If the list is now empty, change the oplock status to</span>
03489         <span class="comment">//  no oplocks held.</span>
03490         <span class="comment">//</span>
03491 
03492         <span class="keywordflow">if</span> (LevelIIIrps &amp;&amp; IsListEmpty( &amp;Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a> )) {
03493 
03494             Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
03495         }
03496 
03497     } finally {
03498 
03499         <span class="comment">//</span>
03500         <span class="comment">//  No matter how we exit we release the mutex</span>
03501         <span class="comment">//</span>
03502 
03503         ExReleaseFastMutex( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
03504 
03505         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlCancelOplockIIIrp:  Exit\n"</span>, 0 );
03506     }
03507 
03508     <span class="keywordflow">return</span>;
03509 
03510     UNREFERENCED_PARAMETER( DeviceObject );
03511 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="oplock.c::FsRtlCancelWaitIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlCancelWaitIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l03288">3288</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00243">_NONOPAQUE_OPLOCK::FastMutex</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03623">FsRtlRemoveAndCompleteWaitIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00277">_WAITING_IRP::Irp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a>, and <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00231">_NONOPAQUE_OPLOCK::WaitingIrps</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l03025">FsRtlWaitOnIrp()</a>.
<p>
<pre class="fragment"><div>03295                    :
03296 
03297     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> waiting
03298     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> queue.  We remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Cancel routine from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> and
03299     then call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> <span class="keywordflow">for</span> all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cancelled Irps on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03300     queue.
03301 
03302 Arguments:
03303 
03304     DeviceObject - Ignored.
03305 
03306     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> being cancelled.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03307           Oplock structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information
03308           field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>'s Iosb.
03309 
03310 Return Value:
03311 
03312     None.
03313 
03314 --*/
03315 
03316 {
03317     <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> Oplock;
03318 
03319     PLIST_ENTRY Links;
03320 
03321     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlCancelWaitIrp:  Entered\n"</span>, 0 );
03322 
03323     Oplock = (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
03324 
03325     <span class="comment">//</span>
03326     <span class="comment">//  We now need to void the cancel routine and release the spinlock</span>
03327     <span class="comment">//</span>
03328 
03329     <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, NULL );
03330     <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03331 
03332     <span class="comment">//</span>
03333     <span class="comment">//  Iterate through all of the waiting locks looking for a canceled one</span>
03334     <span class="comment">//  We do this under the protection of the oplock mutex.</span>
03335     <span class="comment">//</span>
03336 
03337     ExAcquireFastMutex( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
03338 
03339     <span class="keywordflow">try</span> {
03340 
03341         <span class="keywordflow">for</span> (Links = Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a>.Flink;
03342              Links != &amp;Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a>;
03343              Links = Links-&gt;Flink ) {
03344 
03345             <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">PWAITING_IRP</a> WaitingIrp;
03346 
03347             <span class="comment">//</span>
03348             <span class="comment">//  Get a pointer to the waiting Irp record</span>
03349             <span class="comment">//</span>
03350 
03351             WaitingIrp = CONTAINING_RECORD( Links, <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>, Links );
03352 
03353             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlCancelWaitIrp, Loop top, WaitingIrp = %08lx\n"</span>, WaitingIrp);
03354 
03355             <span class="comment">//</span>
03356             <span class="comment">//  Check if the irp has been cancelled</span>
03357             <span class="comment">//</span>
03358 
03359             <span class="keywordflow">if</span> (WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o1">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
03360 
03361                 <span class="comment">//</span>
03362                 <span class="comment">//  Now we need to remove this waiter and call the</span>
03363                 <span class="comment">//  completion routine.  But we must not mess up our link</span>
03364                 <span class="comment">//  iteration so we need to back up link one step and</span>
03365                 <span class="comment">//  then the next iteration will go to our current flink.</span>
03366                 <span class="comment">//</span>
03367 
03368                 Links = Links-&gt;Blink;
03369 
03370                 <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a>( WaitingIrp );
03371             }
03372         }
03373 
03374     } finally {
03375 
03376         <span class="comment">//</span>
03377         <span class="comment">//  No matter how we exit we release the mutex</span>
03378         <span class="comment">//</span>
03379 
03380         ExReleaseFastMutex( Oplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
03381 
03382         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlCancelWaitIrp:  Exit\n"</span>, 0 );
03383     }
03384 
03385     <span class="keywordflow">return</span>;
03386 
03387     UNREFERENCED_PARAMETER( DeviceObject );
03388 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="oplock.c::FsRtlCheckOplock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlCheckOplock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Oplock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a79">POPLOCK_WAIT_COMPLETE_ROUTINE</a> CompletionRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a80">POPLOCK_FS_PREPOST_IRP</a> PostIrpRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">823</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d6/d1/oplock_8c-source.html#l00078">BATCH_OPLOCK</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00217">_NONOPAQUE_OPLOCK::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00079">FILTER_OPLOCK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00057">FILTER_OPLOCK_VALID_FLAGS</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02249">FsRtlOplockCleanup()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00073">IRP_MJ_CLEANUP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00064">IRP_MJ_FLUSH_BUFFERS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00072">IRP_MJ_LOCK_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00058">IRP_MJ_READ</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00061">IRP_MJ_SET_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00059">IRP_MJ_WRITE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01550">IRP_PAGING_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00100">NoOplocksHeld</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00128">OPLOCK_STATE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00122">OplockIIGranted</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00237">_NONOPAQUE_OPLOCK::OplockState</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, and <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>.
<p>
<pre class="fragment"><div>00833                    :
00834 
00835     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called as a support routine from a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system.
00836     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to synchronize I/O requests with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current Oplock
00837     state of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O operation will cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Oplock to
00838     <span class="keywordflow">break</span>, that action <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initiated.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation cannot <span class="keywordflow">continue</span>
00839     until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Oplock <span class="keywordflow">break</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete, STATUS_PENDING <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned and
00840     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller supplied routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00841 
00842 Arguments:
00843 
00844     Oplock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-opaque oplock structure <span class="keywordflow">for</span>
00845              <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00846 
00847     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which declares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
00848           operation.
00849 
00850     Context - This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed as a parameter to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion routine.
00851 
00852     CompletionRoutine - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">if</span> <span class="keyword">this</span>
00853                         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> must wait <span class="keywordflow">for</span> an Oplock to <span class="keywordflow">break</span>.  This
00854                         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a synchronous operation <span class="keywordflow">if</span> not specified
00855                         and we block in <span class="keyword">this</span> thread waiting on
00856                         an event.
00857 
00858     PostIrpRoutine - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine to call before we put anything
00859                      on our waiting <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> queue.
00860 
00861 Return Value:
00862 
00863     STATUS_SUCCESS <span class="keywordflow">if</span> we can complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation on exiting <span class="keyword">this</span> thread.
00864     STATUS_PENDING <span class="keywordflow">if</span> we <span class="keywordflow">return</span> here but hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
00865     STATUS_CANCELLED <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cancelled before we <span class="keywordflow">return</span>.
00866 
00867 --*/
00868 
00869 {
00870     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00871     <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> ThisOplock = *Oplock;
00872 
00873     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00874 
00875     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlCheckOplock:  Entered\n"</span>, 0 );
00876     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
00877     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, Irp );
00878 
00879     <span class="comment">//</span>
00880     <span class="comment">//  If there is no oplock structure or this is system I/O, we allow</span>
00881     <span class="comment">//  the operation to continue.  Otherwise we check the major function code.</span>
00882     <span class="comment">//</span>
00883 
00884     <span class="keywordflow">if</span> ((ThisOplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00885         !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, IRP_PAGING_IO )) {
00886 
00887         <a class="code" href="../../d5/d2/oplock_8c.html#a34">OPLOCK_STATE</a> OplockState;
00888         <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> OplockFileObject;
00889 
00890         BOOLEAN BreakToII;
00891         BOOLEAN BreakToNone;
00892 
00893         ULONG CreateDisposition;
00894 
00895         <span class="comment">//</span>
00896         <span class="comment">//  Capture the file object first and then the oplock state to perform</span>
00897         <span class="comment">//  the unsafe checks below.  We capture the file object first in case</span>
00898         <span class="comment">//  there is an exclusive oplock break in progress.  Otherwise the oplock</span>
00899         <span class="comment">//  state may indicate break in progress but it could complete by</span>
00900         <span class="comment">//  the time we snap the file object.</span>
00901         <span class="comment">//</span>
00902 
00903         OplockFileObject = ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a>;
00904         OplockState = ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a>;
00905 
00906         <span class="comment">//</span>
00907         <span class="comment">//  Examine the Irp for the appropriate action provided there are</span>
00908         <span class="comment">//  current oplocks on the file.</span>
00909         <span class="comment">//</span>
00910 
00911         <span class="keywordflow">if</span> (OplockState != <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>) {
00912 
00913             BreakToII = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00914             BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00915 
00916             IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00917 
00918             <span class="comment">//</span>
00919             <span class="comment">//  Determine whether we are going to BreakToII or BreakToNone.</span>
00920             <span class="comment">//</span>
00921 
00922             <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a>) {
00923 
00924             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a> :
00925 
00926                 <span class="comment">//</span>
00927                 <span class="comment">//  If we are opening for attribute access only, we</span>
00928                 <span class="comment">//  return status success.  Always break the oplock if this caller</span>
00929                 <span class="comment">//  wants a filter oplock.</span>
00930                 <span class="comment">//</span>
00931 
00932                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.SecurityContext-&gt;DesiredAccess,
00933                              ~(FILE_READ_ATTRIBUTES | FILE_WRITE_ATTRIBUTES | SYNCHRONIZE) ) &amp;&amp;
00934                     !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_RESERVE_OPFILTER )) {
00935 
00936                     <span class="keywordflow">break</span>;
00937                 }
00938 
00939                 <span class="comment">//</span>
00940                 <span class="comment">//  If there is a filter oplock granted and this create iS reading</span>
00941                 <span class="comment">//  the file then don't break the oplock as long as we share</span>
00942                 <span class="comment">//  for reads.</span>
00943                 <span class="comment">//</span>
00944 
00945                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, FILTER_OPLOCK ) &amp;&amp;
00946                     !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.SecurityContext-&gt;DesiredAccess,
00947                              ~FILTER_OPLOCK_VALID_FLAGS ) &amp;&amp;
00948                     <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess, FILE_SHARE_READ )) {
00949 
00950                     <span class="keywordflow">break</span>;
00951                 }
00952 
00953                 <span class="comment">//</span>
00954                 <span class="comment">//  We we are superseding or overwriting, then break to none.</span>
00955                 <span class="comment">//</span>
00956 
00957                 CreateDisposition = (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options &gt;&gt; 24) &amp; 0x000000ff;
00958 
00959                 <span class="keywordflow">if</span> ((CreateDisposition == FILE_SUPERSEDE) ||
00960                     (CreateDisposition == FILE_OVERWRITE) ||
00961                     (CreateDisposition == FILE_OVERWRITE_IF) ||
00962                     <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_RESERVE_OPFILTER )) {
00963 
00964                     BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00965 
00966                 } <span class="keywordflow">else</span> {
00967 
00968                     BreakToII = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00969                 }
00970 
00971                 <span class="keywordflow">break</span>;
00972 
00973             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a> :
00974 
00975                 <span class="comment">//</span>
00976                 <span class="comment">//  If a filter oplock has been granted then do nothing.</span>
00977                 <span class="comment">//  We will assume the oplock will have been broken</span>
00978                 <span class="comment">//  if this create needed to do that.</span>
00979                 <span class="comment">//</span>
00980 
00981                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, FILTER_OPLOCK )) {
00982 
00983                     BreakToII = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00984                 }
00985 
00986                 <span class="keywordflow">break</span>;
00987 
00988             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a22">IRP_MJ_FLUSH_BUFFERS</a> :
00989 
00990                 BreakToII = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00991                 <span class="keywordflow">break</span>;
00992 
00993             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a31">IRP_MJ_CLEANUP</a> :
00994 
00995                 <a class="code" href="../../d5/d2/oplock_8c.html#a45">FsRtlOplockCleanup</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock,
00996                                     IrpSp );
00997 
00998                 <span class="keywordflow">break</span>;
00999 
01000             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a30">IRP_MJ_LOCK_CONTROL</a> :
01001 
01002                 <span class="comment">//</span>
01003                 <span class="comment">//  If a filter oplock has been granted then do nothing.</span>
01004                 <span class="comment">//  We will assume the oplock will have been broken</span>
01005                 <span class="comment">//  if this create needed to do that.</span>
01006                 <span class="comment">//</span>
01007 
01008                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, FILTER_OPLOCK )) {
01009 
01010                     <span class="keywordflow">break</span>;
01011                 }
01012 
01013             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a17">IRP_MJ_WRITE</a> :
01014 
01015                 BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01016                 <span class="keywordflow">break</span>;
01017 
01018             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a19">IRP_MJ_SET_INFORMATION</a> :
01019 
01020                 <span class="comment">//</span>
01021                 <span class="comment">//  We are only interested in calls that shrink the file size</span>
01022                 <span class="comment">//  or breaking batch oplocks for the rename case.</span>
01023                 <span class="comment">//</span>
01024 
01025                 <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.FileInformationClass) {
01026 
01027                 <span class="keywordflow">case</span> FileEndOfFileInformation :
01028 
01029                     <span class="comment">//</span>
01030                     <span class="comment">//  Break immediately if this is the lazy writer callback.</span>
01031                     <span class="comment">//</span>
01032 
01033                     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.AdvanceOnly) {
01034 
01035                         <span class="keywordflow">break</span>;
01036                     }
01037 
01038                 <span class="keywordflow">case</span> FileAllocationInformation :
01039 
01040                     BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01041                     <span class="keywordflow">break</span>;
01042 
01043                 <span class="keywordflow">case</span> FileRenameInformation :
01044                 <span class="keywordflow">case</span> FileLinkInformation :
01045 
01046                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, BATCH_OPLOCK | FILTER_OPLOCK )) {
01047 
01048                         BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01049                     }
01050 
01051                     <span class="keywordflow">break</span>;
01052                 }
01053 
01054             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a> :
01055 
01056                 <span class="comment">//</span>
01057                 <span class="comment">//  We need to break to none if this is a zeroing operation.</span>
01058                 <span class="comment">//</span>
01059 
01060                 <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.FileSystemControl.FsControlCode == FSCTL_SET_ZERO_DATA) {
01061 
01062                     BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01063                 }
01064             }
01065 
01066             <span class="keywordflow">if</span> (BreakToII) {
01067 
01068                 <span class="comment">//</span>
01069                 <span class="comment">//  If there are no outstanding oplocks or level II oplocks are held,</span>
01070                 <span class="comment">//  we can return immediately.  If the first two tests fail then there</span>
01071                 <span class="comment">//  is an exclusive oplock.  If the file objects match we allow the</span>
01072                 <span class="comment">//  operation to continue.</span>
01073                 <span class="comment">//</span>
01074 
01075                 <span class="keywordflow">if</span> ((OplockState != <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>) &amp;&amp;
01076                     (OplockFileObject != IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>)) {
01077 
01078                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a46">FsRtlOplockBreakToII</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock,
01079                                                     IrpSp,
01080                                                     Irp,
01081                                                     Context,
01082                                                     CompletionRoutine,
01083                                                     PostIrpRoutine );
01084                 }
01085 
01086             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (BreakToNone) {
01087 
01088                 <span class="comment">//</span>
01089                 <span class="comment">//  If there are no oplocks, we can return immediately.</span>
01090                 <span class="comment">//  Otherwise if there is no level 2 oplock and this file</span>
01091                 <span class="comment">//  object matches the owning file object then this write is</span>
01092                 <span class="comment">//  on behalf of the owner of the oplock.</span>
01093                 <span class="comment">//</span>
01094 
01095                 <span class="keywordflow">if</span> ((OplockState == <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>) ||
01096                     (OplockFileObject != IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>)) {
01097 
01098                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a47">FsRtlOplockBreakToNone</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock,
01099                                                       IrpSp,
01100                                                       Irp,
01101                                                       Context,
01102                                                       CompletionRoutine,
01103                                                       PostIrpRoutine );
01104                 }
01105             }
01106         }
01107     }
01108 
01109     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlCheckOplock:  Exit -&gt; %08lx\n"</span>, Status );
01110 
01111     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01112 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="oplock.c::FsRtlCompletionRoutinePriv" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlCompletionRoutinePriv           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l03241">3241</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l03025">FsRtlWaitOnIrp()</a>.
<p>
<pre class="fragment"><div>03248                    :
03249 
03250     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when an operation must be synchronous with
03251     respect to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock package.  This routine will simply set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03252     event in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Signalled state, allowing some other thread to resume
03253     execution.
03254 
03255 Arguments:
03256 
03257     Context - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event to signal.
03258 
03259     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which declares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
03260           operation.
03261 
03262 Return Value:
03263 
03264     None.
03265 
03266 --*/
03267 
03268 {
03269     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03270 
03271     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlCompletionRoutinePriv:  Entered\n"</span>, 0 );
03272 
03273     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)Context, 0, FALSE );
03274 
03275     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlCompletionRoutinePriv:  Exit\n"</span>, 0 );
03276 
03277     <span class="keywordflow">return</span>;
03278 
03279     UNREFERENCED_PARAMETER( Irp );
03280 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="oplock.c::FsRtlCurrentBatchOplock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlCurrentBatchOplock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Oplock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l01169">1169</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d6/d1/oplock_8c-source.html#l00078">BATCH_OPLOCK</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00079">FILTER_OPLOCK</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>.
<p>
<pre class="fragment"><div>01175                    :
01176 
01177     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> indicates whether there are current outstanding
01178     batch oplocks.
01179 
01180 Arguments:
01181 
01182     OpLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock being queried
01183 
01184 Return Value:
01185 
01186     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> there are outstanding batch oplocks and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
01187 
01188 --*/
01189 
01190 {
01191     BOOLEAN BatchOplocks = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01192 
01193     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01194 
01195     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlCurrentBatchOplock: Oplock -&gt; %08lx\n"</span>, *Oplock);
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">//  There are not any current oplocks if the variable is null or</span>
01199     <span class="comment">//  the state is no oplocks held.  We check whether there are batch</span>
01200     <span class="comment">//  oplocks or filter oplocks which have not been broken.</span>
01201     <span class="comment">//</span>
01202 
01203     <span class="keywordflow">if</span> ((*Oplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01204         <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ((<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock)-&gt;OplockState,
01205                 BATCH_OPLOCK | FILTER_OPLOCK )) {
01206 
01207         BatchOplocks = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01208     }
01209 
01210     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCurrentBatchOplock: Exit -&gt; %08lx\n"</span>, BatchOplocks);
01211 
01212     <span class="keywordflow">return</span> BatchOplocks;
01213 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="oplock.c::FsRtlInitializeOplock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlInitializeOplock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Oplock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00373">373</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00379                    :
00380 
00381     This routine initializes a <span class="keyword">new</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a> structure.  This call must
00382     precede any other call to <span class="keyword">this</span> entry point with <span class="keyword">this</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a>
00383     structure.  In addition, <span class="keyword">this</span> routine will have exclusive access
00384     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Oplock structure.
00385 
00386 Arguments:
00387 
00388     Oplock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of an opaque <a class="code" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a> structure.
00389 
00390 Return Value:
00391 
00392     None.
00393 
00394 --*/
00395 
00396 {
00397     UNREFERENCED_PARAMETER( Oplock );
00398 
00399     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00400 
00401     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlInitializeOplock:  Oplock -&gt; %08lx\n"</span>, *Oplock );
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">//  No action is taken at this time.</span>
00405     <span class="comment">//</span>
00406 
00407     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlInitializeOplock:  Exit\n"</span>, 0);
00408     <span class="keywordflow">return</span>;
00409 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="oplock.c::FsRtlNotifyCompletion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlNotifyCompletion           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l03698">3698</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l02111">FsRtlOplockBreakNotify()</a>.
<p>
<pre class="fragment"><div>03705                    :
03706 
03707     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion routine called when a <span class="keywordflow">break</span> notify <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
03708     be completed.  We simply call FsRtlComplete request to dispose of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03709     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
03710 
03711 Arguments:
03712 
03713     Context - Ignored.
03714 
03715     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> used to request <span class="keywordflow">break</span> notify.
03716 
03717 Return Value:
03718 
03719     None.
03720 
03721 --*/
03722 
03723 {
03724     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03725 
03726     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyCompletion:  Entered\n"</span>, 0 );
03727 
03728     <span class="comment">//</span>
03729     <span class="comment">//  Call FsRtlCompleteRequest using the value in the Irp.</span>
03730     <span class="comment">//</span>
03731 
03732     <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status );
03733 
03734     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyCompletion:  Exit\n"</span>, 0 );
03735 
03736     <span class="keywordflow">return</span>;
03737 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="oplock.c::FsRtlOpBatchBreakClosePending" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlOpBatchBreakClosePending           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Oplock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">1937</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d6/d1/oplock_8c-source.html#l00089">BREAK_TO_II</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00091">BREAK_TO_II_TO_NONE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00090">BREAK_TO_NONE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00092">CLOSE_PENDING</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03623">FsRtlRemoveAndCompleteWaitIrp()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00077">LEVEL_I_OPLOCK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00100">NoOplocksHeld</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00094">OPLOCK_BREAK_MASK</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00085">PENDING</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">FsRtlOplockFsctrl()</a>.
<p>
<pre class="fragment"><div>01945                    :
01946 
01947     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a user <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acknowledging a batch oplock
01948     <span class="keywordflow">break</span> or Level I oplock <span class="keywordflow">break</span>.  In <span class="keyword">this</span> <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> planning
01949     to close <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> as well and doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> need a level II oplock.
01950 
01951 Arguments:
01952 
01953     Oplock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-opaque oplock structure <span class="keywordflow">for</span>
01954              <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01955 
01956     IrpSp - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> stack location <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
01957 
01958     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which declares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
01959           operation.
01960 
01961 Return Value:
01962 
01963     STATUS_SUCCESS <span class="keywordflow">if</span> we can complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation on exiting <span class="keyword">this</span> thread.
01964     STATUS_CANCELLED <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cancelled before we <span class="keywordflow">return</span>.
01965 
01966 --*/
01967 
01968 {
01969     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01970 
01971     BOOLEAN AcquiredMutex;
01972 
01973     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01974 
01975     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlOpBatchBreakClosePending:  Entered\n"</span>, 0 );
01976     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
01977     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"IrpSp     -&gt; %08lx\n"</span>, IrpSp );
01978     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, Irp );
01979 
01980     <span class="comment">//</span>
01981     <span class="comment">//  If there is no oplock structure, we complete this with invalid</span>
01982     <span class="comment">//  oplock protocol.</span>
01983     <span class="comment">//</span>
01984 
01985     <span class="keywordflow">if</span> (Oplock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01986 
01987         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_INVALID_OPLOCK_PROTOCOL );
01988         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlOpBatchClosePending:  Exit -&gt; %08lx\n"</span>, STATUS_INVALID_OPLOCK_PROTOCOL );
01989         <span class="keywordflow">return</span> STATUS_INVALID_OPLOCK_PROTOCOL;
01990     }
01991 
01992     <span class="comment">//</span>
01993     <span class="comment">//  Grab the synchronization object for the oplock.</span>
01994     <span class="comment">//</span>
01995 
01996     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
01997     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01998 
01999     <span class="comment">//</span>
02000     <span class="comment">//  Use a try_finally to facilitate cleanup.</span>
02001     <span class="comment">//</span>
02002 
02003     <span class="keywordflow">try</span> {
02004 
02005         <span class="comment">//</span>
02006         <span class="comment">//  If a break is underway but this is not the owner of the</span>
02007         <span class="comment">//  level 1 oplock, we complete the request and return a</span>
02008         <span class="comment">//  warning.</span>
02009         <span class="comment">//</span>
02010 
02011         <span class="keywordflow">if</span> (Oplock-&gt;FileObject != IrpSp-&gt;FileObject) {
02012 
02013             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OPLOCK_PROTOCOL;
02014             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02015                        Dbg,
02016                        <span class="stringliteral">"Not oplock owner -&gt; %08lx\n"</span>,
02017                        Status);
02018 
02019         } <span class="keywordflow">else</span> {
02020 
02021             <span class="comment">//</span>
02022             <span class="comment">//  If this is an opbatch operation we want to note that a</span>
02023             <span class="comment">//  close is pending.  For an exclusive oplock we set the state to</span>
02024             <span class="comment">//  no oplocsk held.  There must be a break in progress to</span>
02025             <span class="comment">//  process however.</span>
02026             <span class="comment">//</span>
02027 
02028             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState,
02029                         BREAK_TO_II | BREAK_TO_NONE | BREAK_TO_II_TO_NONE )) {
02030 
02031                 <span class="comment">//</span>
02032                 <span class="comment">//  Break all oplocks for an exclusive oplock.</span>
02033                 <span class="comment">//</span>
02034 
02035                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, LEVEL_I_OPLOCK | PENDING )) {
02036 
02037                     <span class="comment">//</span>
02038                     <span class="comment">//  Clean up the oplock structure and complete all waiting Irps.</span>
02039                     <span class="comment">//</span>
02040 
02041                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, LEVEL_I_OPLOCK )) {
02042 
02043                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Oplock-&gt;FileObject );
02044                     }
02045 
02046                     Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02047                     Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02048 
02049                     <span class="keywordflow">while</span> (!IsListEmpty( &amp;Oplock-&gt;WaitingIrps )) {
02050 
02051                         <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">PWAITING_IRP</a> WaitingIrp;
02052 
02053                         <span class="comment">//</span>
02054                         <span class="comment">//  Remove the entry found and complete the Irp.</span>
02055                         <span class="comment">//</span>
02056 
02057                         WaitingIrp = CONTAINING_RECORD( Oplock-&gt;WaitingIrps.Flink,
02058                                                         <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
02059                                                         Links );
02060 
02061                         <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a>( WaitingIrp );
02062                     }
02063 
02064                 <span class="comment">//</span>
02065                 <span class="comment">//  Set the state to close pending for batch and filter</span>
02066                 <span class="comment">//  oplocks.</span>
02067                 <span class="comment">//</span>
02068 
02069                 } <span class="keywordflow">else</span> {
02070 
02071                     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Oplock-&gt;OplockState, OPLOCK_BREAK_MASK );
02072                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Oplock-&gt;OplockState, CLOSE_PENDING );
02073                 }
02074 
02075             } <span class="keywordflow">else</span> {
02076 
02077                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OPLOCK_PROTOCOL;
02078                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02079                            Dbg,
02080                            <span class="stringliteral">"No break underway -&gt; %08lx\n"</span>,
02081                            Status);
02082             }
02083         }
02084 
02085         <span class="comment">//</span>
02086         <span class="comment">//  We simply complete this request.</span>
02087         <span class="comment">//</span>
02088 
02089         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, Status );
02090 
02091     } finally {
02092 
02093         <span class="comment">//</span>
02094         <span class="comment">//  Release the synchronization object.</span>
02095         <span class="comment">//</span>
02096 
02097         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02098 
02099         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlOpBatchBreakClosePending:  Exit -&gt; %08lx\n"</span>, Status);
02100     }
02101 
02102     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02103 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="oplock.c::FsRtlOplockBreakNotify" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlOplockBreakNotify           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Oplock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l02111">2111</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03698">FsRtlNotifyCompletion()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03025">FsRtlWaitOnIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00100">NoOplocksHeld</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00094">OPLOCK_BREAK_MASK</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00085">PENDING</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">FsRtlOplockFsctrl()</a>.
<p>
<pre class="fragment"><div>02119                    :
02120 
02121     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> refers <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user request to
02122     be notified when there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no level 1 oplock <span class="keywordflow">break</span> in progress.
02123     Under any other condition <span class="keyword">this</span> routine completes immediately with
02124     STATUS_SUCCESS.  Otherwise we simply add <span class="keyword">this</span> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list
02125     of <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>'s waiting <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">break</span> to complete.
02126 
02127 Arguments:
02128 
02129     Oplock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-opaque oplock structure <span class="keywordflow">for</span>
02130              <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02131 
02132     IrpSp - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> stack location <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
02133 
02134     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which declares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
02135           operation.
02136 
02137 Return Value:
02138 
02139     STATUS_SUCCESS <span class="keywordflow">if</span> we can complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation on exiting <span class="keyword">this</span> thread.
02140     STATUS_PENDING <span class="keywordflow">if</span> we <span class="keywordflow">return</span> here but hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
02141     STATUS_CANCELLED <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cancelled before we <span class="keywordflow">return</span>.
02142 
02143 --*/
02144 
02145 {
02146     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02147 
02148     BOOLEAN AcquiredMutex;
02149 
02150     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02151 
02152     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlOplockBreakNotify:  Entered\n"</span>, 0 );
02153     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
02154     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"IrpSp     -&gt; %08lx\n"</span>, IrpSp );
02155     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, Irp );
02156 
02157     <span class="comment">//</span>
02158     <span class="comment">//  If there is no oplock structure, we complete this with status success.</span>
02159     <span class="comment">//</span>
02160 
02161     <span class="keywordflow">if</span> (Oplock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02162 
02163         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_SUCCESS );
02164         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlOpBatchClosePending:  Exit -&gt; %08lx\n"</span>, STATUS_SUCCESS );
02165         <span class="keywordflow">return</span> STATUS_SUCCESS;
02166     }
02167 
02168     <span class="comment">//</span>
02169     <span class="comment">//  Grap the synchronization object.</span>
02170     <span class="comment">//</span>
02171 
02172     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02173     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02174 
02175     <span class="comment">//</span>
02176     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
02177     <span class="comment">//</span>
02178 
02179     <span class="keywordflow">try</span> {
02180 
02181         <span class="comment">//</span>
02182         <span class="comment">//  If there are no outstanding level 1 oplocks breaks underway</span>
02183         <span class="comment">//  or batch oplock breaks underway we complete immediately.</span>
02184         <span class="comment">//</span>
02185 
02186         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, OPLOCK_BREAK_MASK )) {
02187 
02188             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02189                        Dbg,
02190                        <span class="stringliteral">"No exclusive oplock break underway\n"</span>,
02191                        0);
02192 
02193             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_SUCCESS );
02194             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status = STATUS_SUCCESS );
02195 
02196         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, PENDING )) {
02197 
02198             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02199             Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02200 
02201             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_SUCCESS );
02202             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status = STATUS_SUCCESS );
02203         }
02204 
02205         <span class="comment">//</span>
02206         <span class="comment">//  Otherwise we need to add this Irp to the list of Irp's waiting</span>
02207         <span class="comment">//  for the oplock break to complete.</span>
02208         <span class="comment">//</span>
02209 
02210         AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02211 
02212         <span class="comment">//</span>
02213         <span class="comment">//  Initialize the return value to status success.</span>
02214         <span class="comment">//</span>
02215 
02216         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_SUCCESS;
02217 
02218         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a49">FsRtlWaitOnIrp</a>( Oplock,
02219                                  Irp,
02220                                  NULL,
02221                                  FsRtlNotifyCompletion,
02222                                  NULL,
02223                                  NULL );
02224 
02225     try_exit:  NOTHING;
02226     } finally {
02227 
02228         <span class="comment">//</span>
02229         <span class="comment">//  Give up the synchronization event if we haven't done so.</span>
02230         <span class="comment">//</span>
02231 
02232         <span class="keywordflow">if</span> (AcquiredMutex) {
02233 
02234             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02235         }
02236 
02237         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlOplockBreakNotify:  Exit -&gt; %08lx\n"</span>, Status );
02238     }
02239 
02240     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02241 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="oplock.c::FsRtlOplockBreakToII" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlOplockBreakToII           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Oplock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a79">POPLOCK_WAIT_COMPLETE_ROUTINE</a> CompletionRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a80">POPLOCK_FS_PREPOST_IRP</a> PostIrpRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">2454</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d6/d1/oplock_8c-source.html#l00078">BATCH_OPLOCK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00089">BREAK_TO_II</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00090">BREAK_TO_NONE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00084">EXCLUSIVE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03623">FsRtlRemoveAndCompleteWaitIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03025">FsRtlWaitOnIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00100">IoAcquireCancelSpinLock()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00077">LEVEL_I_OPLOCK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00100">NoOplocksHeld</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00094">OPLOCK_BREAK_MASK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00085">PENDING</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>.
<p>
<pre class="fragment"><div>02465                    :
02466 
02467     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a generic worker routine which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when an
02468     operation will cause all oplocks to be broken to level II before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02469     operation can proceed.
02470 
02471 Arguments:
02472 
02473     Oplock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-opaque oplock structure <span class="keywordflow">for</span>
02474              <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02475 
02476     IrpSp - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> stack location <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
02477 
02478     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which declares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
02479           operation.
02480 
02481     Context - This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed as a parameter to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion routine.
02482 
02483     CompletionRoutine - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">if</span> <span class="keyword">this</span>
02484                         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> must wait <span class="keywordflow">for</span> an Oplock to <span class="keywordflow">break</span>.  This
02485                         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a synchronous operation <span class="keywordflow">if</span> not specified
02486                         and we block in <span class="keyword">this</span> thread waiting on
02487                         an event.
02488 
02489     PostIrpRoutine - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine to call before we put anything
02490                      on our waiting <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> queue.
02491 
02492 Return Value:
02493 
02494     STATUS_SUCCESS <span class="keywordflow">if</span> we can complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation on exiting <span class="keyword">this</span> thread.
02495     STATUS_PENDING <span class="keywordflow">if</span> we <span class="keywordflow">return</span> here but hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
02496     STATUS_CANCELLED <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cancelled before we <span class="keywordflow">return</span>.
02497 
02498 --*/
02499 
02500 {
02501     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
02502     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02503 
02504     BOOLEAN AcquiredMutex;
02505 
02506     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"CheckOplockBreakToII:  Entered\n"</span>, 0 );
02507     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
02508     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"IrpSp     -&gt; %08lx\n"</span>, IrpSp );
02509     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, Irp );
02510 
02511     <span class="comment">//</span>
02512     <span class="comment">//  Grap the synchronization object.</span>
02513     <span class="comment">//</span>
02514 
02515     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02516     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02517 
02518     <span class="comment">//</span>
02519     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
02520     <span class="comment">//</span>
02521 
02522     <span class="keywordflow">try</span> {
02523 
02524         <span class="comment">//</span>
02525         <span class="comment">//  If there are no outstanding oplocks or level II oplocks are held,</span>
02526         <span class="comment">//  we can return immediately.</span>
02527         <span class="comment">//</span>
02528 
02529         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, EXCLUSIVE )) {
02530 
02531             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02532                        Dbg,
02533                        <span class="stringliteral">"No oplocks or level II oplocks on file\n"</span>,
02534                        0);
02535 
02536             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status = STATUS_SUCCESS );
02537         }
02538 
02539         <span class="comment">//</span>
02540         <span class="comment">//  At this point there is an exclusive oplock break in progress.</span>
02541         <span class="comment">//  If this file object owns that oplock, we allow the operation</span>
02542         <span class="comment">//  to continue.</span>
02543         <span class="comment">//</span>
02544 
02545         <span class="keywordflow">if</span> (Oplock-&gt;FileObject == IrpSp-&gt;FileObject) {
02546 
02547             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02548                        Dbg,
02549                        <span class="stringliteral">"Handle owns level 1 oplock\n"</span>,
02550                        0);
02551 
02552             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status = STATUS_SUCCESS );
02553         }
02554 
02555         <span class="comment">//</span>
02556         <span class="comment">//  If there is currently an exclusive oplock held then complete</span>
02557         <span class="comment">//  the exclusive irp.</span>
02558         <span class="comment">//</span>
02559 
02560         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, PENDING | OPLOCK_BREAK_MASK )) {
02561 
02562             <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> IrpExclusive = Oplock-&gt;IrpExclusiveOplock;
02563 
02564             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02565                        Dbg,
02566                        <span class="stringliteral">"Breaking exclusive oplock\n"</span>,
02567                        0);
02568 
02569             <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
02570             <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( IrpExclusive, NULL );
02571             <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
02572 
02573             <span class="comment">//</span>
02574             <span class="comment">//  If the Irp has been cancelled, we complete the Irp with</span>
02575             <span class="comment">//  status cancelled and break the oplock completely.</span>
02576             <span class="comment">//</span>
02577 
02578             <span class="keywordflow">if</span> (IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
02579 
02580                 IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
02581                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( IrpExclusive, STATUS_CANCELLED );
02582                 Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02583                 Oplock-&gt;IrpExclusiveOplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02584 
02585                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Oplock-&gt;FileObject );
02586                 Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02587 
02588                 <span class="comment">//</span>
02589                 <span class="comment">//  Release any waiting irps.</span>
02590                 <span class="comment">//</span>
02591 
02592                 <span class="keywordflow">while</span> (!IsListEmpty( &amp;Oplock-&gt;WaitingIrps )) {
02593 
02594                     <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">PWAITING_IRP</a> WaitingIrp;
02595 
02596                     WaitingIrp = CONTAINING_RECORD( Oplock-&gt;WaitingIrps.Flink,
02597                                                     <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
02598                                                     Links );
02599 
02600                     <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a>( WaitingIrp );
02601                 }
02602 
02603                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status = STATUS_SUCCESS );
02604 
02605             } <span class="keywordflow">else</span> {
02606 
02607                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> CompletionStatus;
02608 
02609                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, LEVEL_I_OPLOCK | BATCH_OPLOCK )) {
02610 
02611                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Oplock-&gt;OplockState, BREAK_TO_II );
02612                     CompletionStatus = FILE_OPLOCK_BROKEN_TO_LEVEL_2;
02613 
02614                 } <span class="keywordflow">else</span> {
02615 
02616                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Oplock-&gt;OplockState, BREAK_TO_NONE );
02617                     CompletionStatus = FILE_OPLOCK_BROKEN_TO_NONE;
02618                 }
02619 
02620                 Oplock-&gt;IrpExclusiveOplock-&gt;IoStatus.Information = CompletionStatus;
02621                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Oplock-&gt;IrpExclusiveOplock, STATUS_SUCCESS );
02622                 Oplock-&gt;IrpExclusiveOplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02623             }
02624 
02625         <span class="comment">//</span>
02626         <span class="comment">//  If there is a pending opfilter request then clear the request.</span>
02627         <span class="comment">//</span>
02628 
02629         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, PENDING )) {
02630 
02631             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02632             Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02633 
02634             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status = STATUS_SUCCESS );
02635         }
02636 
02637         <span class="comment">//</span>
02638         <span class="comment">//  If this is an open operation and the user doesn't want to</span>
02639         <span class="comment">//  block, we will complete the operation now.</span>
02640         <span class="comment">//</span>
02641 
02642         <span class="keywordflow">if</span> ((IrpSp-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>) &amp;&amp;
02643             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;Parameters.Create.Options, FILE_COMPLETE_IF_OPLOCKED )) {
02644 
02645             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Don't block open\n"</span>, 0 );
02646 
02647             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status = STATUS_OPLOCK_BREAK_IN_PROGRESS );
02648         }
02649 
02650         <span class="comment">//</span>
02651         <span class="comment">//  If we get here that means that this operation can't continue</span>
02652         <span class="comment">//  until the oplock break is complete.</span>
02653         <span class="comment">//</span>
02654         <span class="comment">//  FsRtlWaitOnIrp will release the mutex.</span>
02655         <span class="comment">//</span>
02656 
02657         AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02658 
02659         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a49">FsRtlWaitOnIrp</a>( Oplock,
02660                                  Irp,
02661                                  Context,
02662                                  CompletionRoutine,
02663                                  PostIrpRoutine,
02664                                  &amp;Event );
02665 
02666     try_exit:  NOTHING;
02667     } finally {
02668 
02669         <span class="comment">//</span>
02670         <span class="comment">//  Give up the synchronization event if we haven't done so.</span>
02671         <span class="comment">//</span>
02672 
02673         <span class="keywordflow">if</span> (AcquiredMutex) {
02674 
02675             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02676         }
02677 
02678         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlOplockBreakToII:  Exit -&gt; %08lx\n"</span>, Status );
02679     }
02680 
02681     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02682 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="oplock.c::FsRtlOplockBreakToNone" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlOplockBreakToNone           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Oplock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a79">POPLOCK_WAIT_COMPLETE_ROUTINE</a> CompletionRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a80">POPLOCK_FS_PREPOST_IRP</a> PostIrpRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">2690</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d6/d1/oplock_8c-source.html#l00089">BREAK_TO_II</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00091">BREAK_TO_II_TO_NONE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00090">BREAK_TO_NONE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02952">FsRtlRemoveAndCompleteIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03623">FsRtlRemoveAndCompleteWaitIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03025">FsRtlWaitOnIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00100">IoAcquireCancelSpinLock()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00080">LEVEL_II_OPLOCK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00100">NoOplocksHeld</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00094">OPLOCK_BREAK_MASK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00122">OplockIIGranted</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00085">PENDING</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>.
<p>
<pre class="fragment"><div>02701                    :
02702 
02703     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a generic worker routine which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when an
02704     operation will cause all oplocks to be broken before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation can
02705     proceed.
02706 
02707 Arguments:
02708 
02709     Oplock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-opaque oplock structure <span class="keywordflow">for</span>
02710              <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02711 
02712     IrpSp - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> stack location <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
02713 
02714     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which declares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
02715           operation.
02716 
02717     Context - This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed as a parameter to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion routine.
02718 
02719     CompletionRoutine - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">if</span> <span class="keyword">this</span>
02720                         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> must wait <span class="keywordflow">for</span> an Oplock to <span class="keywordflow">break</span>.  This
02721                         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a synchronous operation <span class="keywordflow">if</span> not specified
02722                         and we block in <span class="keyword">this</span> thread waiting on
02723                         an event.
02724 
02725     PostIrpRoutine - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine to call before we put anything
02726                      on our waiting <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> queue.
02727 
02728 Return Value:
02729 
02730     STATUS_SUCCESS <span class="keywordflow">if</span> we can complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation on exiting <span class="keyword">this</span> thread.
02731     STATUS_PENDING <span class="keywordflow">if</span> we <span class="keywordflow">return</span> here but hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
02732     STATUS_CANCELLED <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cancelled before we <span class="keywordflow">return</span>.
02733 
02734 --*/
02735 
02736 {
02737     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
02738     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02739 
02740     BOOLEAN AcquiredMutex;
02741 
02742     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"CheckOplockBreakToNone:  Entered\n"</span>, 0 );
02743     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
02744     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"IrpSp     -&gt; %08lx\n"</span>, IrpSp );
02745     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, Irp );
02746 
02747     <span class="comment">//</span>
02748     <span class="comment">//  Grap the synchronization object.</span>
02749     <span class="comment">//</span>
02750 
02751     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02752     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02753 
02754     <span class="comment">//</span>
02755     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
02756     <span class="comment">//</span>
02757 
02758     <span class="keywordflow">try</span> {
02759 
02760         <span class="comment">//</span>
02761         <span class="comment">//  If there are no outstanding oplocks, we can return immediately.</span>
02762         <span class="comment">//</span>
02763 
02764         <span class="keywordflow">if</span> (Oplock-&gt;OplockState == <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>) {
02765 
02766             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02767                        Dbg,
02768                        <span class="stringliteral">"No oplocks on file\n"</span>,
02769                        0);
02770 
02771             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status = STATUS_SUCCESS );
02772         }
02773 
02774         <span class="comment">//</span>
02775         <span class="comment">//  If there is an exclusive oplock held, we begin the break to none.</span>
02776         <span class="comment">//</span>
02777 
02778         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState,
02779                      LEVEL_II_OPLOCK | PENDING | OPLOCK_BREAK_MASK )) {
02780 
02781             <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> IrpExclusive = Oplock-&gt;IrpExclusiveOplock;
02782 
02783             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02784                        Dbg,
02785                        <span class="stringliteral">"Breaking exclusive oplock\n"</span>,
02786                        0);
02787 
02788             <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
02789             <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( IrpExclusive, NULL );
02790             <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
02791 
02792             <span class="comment">//</span>
02793             <span class="comment">//  If the Irp has been cancelled, we complete the Irp with</span>
02794             <span class="comment">//  status cancelled and break the oplock completely.</span>
02795             <span class="comment">//</span>
02796 
02797             <span class="keywordflow">if</span> (IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
02798 
02799                 IrpExclusive-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
02800                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( IrpExclusive, STATUS_CANCELLED );
02801                 Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02802                 Oplock-&gt;IrpExclusiveOplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02803 
02804                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Oplock-&gt;FileObject );
02805                 Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02806 
02807                 <span class="comment">//</span>
02808                 <span class="comment">//  Release any waiting irps.</span>
02809                 <span class="comment">//</span>
02810 
02811                 <span class="keywordflow">while</span> (!IsListEmpty( &amp;Oplock-&gt;WaitingIrps )) {
02812 
02813                     <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">PWAITING_IRP</a> WaitingIrp;
02814 
02815                     WaitingIrp = CONTAINING_RECORD( Oplock-&gt;WaitingIrps.Flink,
02816                                                     <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
02817                                                     Links );
02818 
02819                     <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a>( WaitingIrp );
02820                 }
02821 
02822                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status = STATUS_SUCCESS );
02823 
02824             } <span class="keywordflow">else</span> {
02825 
02826                 Oplock-&gt;IrpExclusiveOplock-&gt;IoStatus.Information = FILE_OPLOCK_BROKEN_TO_NONE;
02827                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Oplock-&gt;IrpExclusiveOplock, STATUS_SUCCESS );
02828                 Oplock-&gt;IrpExclusiveOplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02829 
02830                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Oplock-&gt;OplockState, BREAK_TO_NONE );
02831             }
02832 
02833         <span class="comment">//</span>
02834         <span class="comment">//  If there are level II oplocks, this will break all of them.</span>
02835         <span class="comment">//</span>
02836 
02837         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Oplock-&gt;OplockState == <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>) {
02838 
02839             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02840                        Dbg,
02841                        <span class="stringliteral">"Breaking all level 2 oplocks\n"</span>,
02842                        0);
02843 
02844             <span class="keywordflow">while</span> (!IsListEmpty( &amp;Oplock-&gt;IrpOplocksII )) {
02845 
02846                 <span class="comment">//</span>
02847                 <span class="comment">//  Remove and complete this Irp with STATUS_SUCCESS.</span>
02848                 <span class="comment">//</span>
02849 
02850                 <a class="code" href="../../d5/d2/oplock_8c.html#a48">FsRtlRemoveAndCompleteIrp</a>( Oplock-&gt;IrpOplocksII.Flink );
02851             }
02852 
02853             <span class="comment">//</span>
02854             <span class="comment">//  Set the oplock state to no oplocks held.</span>
02855             <span class="comment">//</span>
02856 
02857             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02858 
02859             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status = STATUS_SUCCESS );
02860 
02861         <span class="comment">//</span>
02862         <span class="comment">//  If we are currently breaking to level II then change that</span>
02863         <span class="comment">//  to BreakToIIToNone.</span>
02864         <span class="comment">//</span>
02865 
02866         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, BREAK_TO_II )) {
02867 
02868             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Oplock-&gt;OplockState, BREAK_TO_II );
02869             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Oplock-&gt;OplockState, BREAK_TO_II_TO_NONE );
02870 
02871         <span class="comment">//</span>
02872         <span class="comment">//  If there is a pending opfilter request then clear that request.</span>
02873         <span class="comment">//</span>
02874 
02875         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, PENDING )) {
02876 
02877             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02878             Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02879 
02880             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status = STATUS_SUCCESS );
02881         }
02882 
02883         <span class="comment">//</span>
02884         <span class="comment">//  At this point there is already an exclusive oplock break in progress.</span>
02885         <span class="comment">//  If this file object owns that oplock, we allow the operation</span>
02886         <span class="comment">//  to continue.</span>
02887         <span class="comment">//</span>
02888 
02889         <span class="keywordflow">if</span> (Oplock-&gt;FileObject == IrpSp-&gt;FileObject) {
02890 
02891             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02892                        Dbg,
02893                        <span class="stringliteral">"Handle owns level 1 oplock\n"</span>,
02894                        0);
02895 
02896             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status = STATUS_SUCCESS );
02897         }
02898 
02899         <span class="comment">//</span>
02900         <span class="comment">//  If this is an open operation and the user doesn't want to</span>
02901         <span class="comment">//  block, we will complete the operation now.</span>
02902         <span class="comment">//</span>
02903 
02904         <span class="keywordflow">if</span> ((IrpSp-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>) &amp;&amp;
02905             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;Parameters.Create.Options, FILE_COMPLETE_IF_OPLOCKED )) {
02906 
02907             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Don't block open\n"</span>, 0 );
02908 
02909             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Status = STATUS_OPLOCK_BREAK_IN_PROGRESS );
02910         }
02911 
02912         <span class="comment">//</span>
02913         <span class="comment">//  If we get here that means that this operation can't continue</span>
02914         <span class="comment">//  until the oplock break is complete.</span>
02915         <span class="comment">//</span>
02916         <span class="comment">//  FsRtlWaitOnIrp will release the mutex.</span>
02917         <span class="comment">//</span>
02918 
02919         AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02920 
02921         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a49">FsRtlWaitOnIrp</a>( Oplock,
02922                                  Irp,
02923                                  Context,
02924                                  CompletionRoutine,
02925                                  PostIrpRoutine,
02926                                  &amp;Event );
02927 
02928     try_exit:  NOTHING;
02929     } finally {
02930 
02931         <span class="comment">//</span>
02932         <span class="comment">//  Give up the synchronization event if we haven't done so.</span>
02933         <span class="comment">//</span>
02934 
02935         <span class="keywordflow">if</span> (AcquiredMutex) {
02936 
02937             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02938         }
02939 
02940         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"CheckOplockBreakToNone:  Exit -&gt; %08lx\n"</span>, Status );
02941     }
02942 
02943     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02944 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="oplock.c::FsRtlOplockCleanup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlOplockCleanup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Oplock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l02249">2249</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02952">FsRtlRemoveAndCompleteIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03623">FsRtlRemoveAndCompleteWaitIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00100">IoAcquireCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00100">NoOplocksHeld</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00094">OPLOCK_BREAK_MASK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00122">OplockIIGranted</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00085">PENDING</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>.
<p>
<pre class="fragment"><div>02256                    :
02257 
02258     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to coordinate a cleanup operation with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02259     oplock state <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no level 1 oplock <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02260     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, then there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no action to take.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object in <span class="keyword">this</span>
02261     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> matches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object used in granting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> level 1 oplock,
02262     then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> close operation will terminate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock.  If <span class="keyword">this</span>
02263     cleanup refers to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object which has a level II oplock, then
02264     that <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> completed and removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of level II
02265     oplocked Irps.
02266 
02267 
02268 Arguments:
02269 
02270     Oplock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-opaque oplock structure <span class="keywordflow">for</span>
02271              <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02272 
02273     IrpSp - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> stack location <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
02274 
02275 Return Value:
02276 
02277     None.
02278 
02279 --*/
02280 
02281 {
02282     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlOplockCleanup:  Entered\n"</span>, 0 );
02283     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
02284     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"IrpSp     -&gt; %08lx\n"</span>, IrpSp );
02285 
02286     <span class="comment">//</span>
02287     <span class="comment">//  Grab the synchronization object for the oplock.</span>
02288     <span class="comment">//</span>
02289 
02290     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02291 
02292     <span class="comment">//</span>
02293     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
02294     <span class="comment">//</span>
02295 
02296     <span class="keywordflow">try</span> {
02297 
02298         <span class="comment">//</span>
02299         <span class="comment">//  If the oplock has no oplock held we return immediately.</span>
02300         <span class="comment">//</span>
02301 
02302         <span class="keywordflow">if</span> (Oplock-&gt;OplockState == <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>) {
02303 
02304             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02305                        Dbg,
02306                        <span class="stringliteral">"No oplocks on file\n"</span>,
02307                        0);
02308 
02309             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
02310         }
02311 
02312         <span class="comment">//</span>
02313         <span class="comment">//  If level II oplocks are held, check if this matches any of them.</span>
02314         <span class="comment">//</span>
02315 
02316         <span class="keywordflow">if</span> (Oplock-&gt;OplockState == <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>) {
02317 
02318             PLIST_ENTRY Link;
02319             <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
02320             <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> NextIrpSp;
02321 
02322             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02323                        Dbg,
02324                        <span class="stringliteral">"File has level 2 oplocks\n"</span>,
02325                        0);
02326 
02327             <span class="keywordflow">for</span> (Link = Oplock-&gt;IrpOplocksII.Flink;
02328                  Link != &amp;Oplock-&gt;IrpOplocksII;
02329                  Link = Link-&gt;Flink) {
02330 
02331                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = CONTAINING_RECORD( Link, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Overlay.ListEntry );
02332 
02333                 NextIrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
02334 
02335                 <span class="comment">//</span>
02336                 <span class="comment">//  If the file objects match, then emove the entry found and complete the Irp.</span>
02337                 <span class="comment">//</span>
02338 
02339                 <span class="keywordflow">if</span> (IrpSp-&gt;FileObject == NextIrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>) {
02340 
02341                     <span class="comment">//</span>
02342                     <span class="comment">//  Back up to remember this link.</span>
02343                     <span class="comment">//</span>
02344 
02345                     Link = Link-&gt;Blink;
02346 
02347                     <span class="comment">//</span>
02348                     <span class="comment">//</span>
02349 
02350                     <a class="code" href="../../d5/d2/oplock_8c.html#a48">FsRtlRemoveAndCompleteIrp</a>( Link-&gt;Flink );
02351                 }
02352             }
02353 
02354             <span class="comment">//</span>
02355             <span class="comment">//  If all the level II oplocks are gone, then the state is</span>
02356             <span class="comment">//  no oplocks held.</span>
02357             <span class="comment">//</span>
02358 
02359             <span class="keywordflow">if</span> (IsListEmpty( &amp;Oplock-&gt;IrpOplocksII )) {
02360 
02361                 Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02362             }
02363 
02364             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
02365         }
02366 
02367         <span class="comment">//</span>
02368         <span class="comment">//  If this file object matches that used to request an exclusive</span>
02369         <span class="comment">//  oplock, we completely close the oplock break.</span>
02370         <span class="comment">//</span>
02371 
02372         <span class="keywordflow">if</span> (IrpSp-&gt;FileObject == Oplock-&gt;FileObject) {
02373 
02374             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02375                        Dbg,
02376                        <span class="stringliteral">"Handle owns level 1 oplock\n"</span>,
02377                        0);
02378 
02379             <span class="comment">//</span>
02380             <span class="comment">//  If an oplock break is not in progress, we initiate one and</span>
02381             <span class="comment">//  complete the exclusive Irp immediately.</span>
02382             <span class="comment">//</span>
02383 
02384             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, OPLOCK_BREAK_MASK | PENDING )) {
02385 
02386                 <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> ExclusiveIrp = Oplock-&gt;IrpExclusiveOplock;
02387 
02388                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0,
02389                            Dbg,
02390                            <span class="stringliteral">"Initiate oplock break\n"</span>,
02391                            0);
02392 
02393                 <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;ExclusiveIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
02394 
02395                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( ExclusiveIrp, NULL );
02396                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( ExclusiveIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
02397 
02398                 ExclusiveIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
02399 
02400                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Oplock-&gt;IrpExclusiveOplock, STATUS_SUCCESS );
02401 
02402                 Oplock-&gt;IrpExclusiveOplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02403             }
02404 
02405             <span class="comment">//</span>
02406             <span class="comment">//  Clean up the oplock structure and complete all waiting Irps.</span>
02407             <span class="comment">//  Don't do this if this is a pending opfilter request.</span>
02408             <span class="comment">//</span>
02409 
02410             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Oplock-&gt;OplockState, PENDING )) {
02411 
02412                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( IrpSp-&gt;FileObject );
02413             }
02414 
02415             Oplock-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02416             Oplock-&gt;OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>;
02417 
02418             <span class="keywordflow">while</span> (!IsListEmpty( &amp;Oplock-&gt;WaitingIrps )) {
02419 
02420                 <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">PWAITING_IRP</a> WaitingIrp;
02421 
02422                 <span class="comment">//</span>
02423                 <span class="comment">//  Remove the entry found and complete the Irp.</span>
02424                 <span class="comment">//</span>
02425 
02426                 WaitingIrp = CONTAINING_RECORD( Oplock-&gt;WaitingIrps.Flink,
02427                                                 <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
02428                                                 Links );
02429 
02430                 <a class="code" href="../../d5/d2/oplock_8c.html#a54">FsRtlRemoveAndCompleteWaitIrp</a>( WaitingIrp );
02431             }
02432         }
02433 
02434     try_exit:  NOTHING;
02435     } finally {
02436 
02437         <span class="comment">//</span>
02438         <span class="comment">//  Give up the oplock synchronization object.</span>
02439         <span class="comment">//</span>
02440 
02441         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
02442         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlOplockCleanup:  Exit\n"</span>, 0 );
02443     }
02444 
02445     <span class="keywordflow">return</span>;
02446 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="oplock.c::FsRtlOplockFsctrl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlOplockFsctrl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Oplock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">581</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00084">EXCLUSIVE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01504">FO_CLEANUP_COMPLETE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01678">FsRtlAcknowledgeOplockBreak()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02111">FsRtlOplockBreakNotify()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">FsRtlRequestExclusiveOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01514">FsRtlRequestOplockII()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07615">IoIsOperationSynchronous()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00077">LEVEL_I_OPLOCK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00105">OpFilterReqPending</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00128">OPLOCK_STATE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>.
<p>
<pre class="fragment"><div>00589                    :
00590 
00591     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filesystems <span class="keywordflow">for</span> Fsctl calls, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> handles
00592     oplock requests, <span class="keywordflow">break</span> acknowledgement and <span class="keywordflow">break</span> notify.
00593 
00594 Arguments:
00595 
00596     Oplock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> opaque <a class="code" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a> structure.
00597 
00598     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which declares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
00599           operation.
00600 
00601     OpenCount - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of user handles on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">if</span> we are requsting
00602         an exclusive oplock.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> non-zero value <span class="keywordflow">for</span> a level II request indicates
00603         that there are locks on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00604 
00605 Return Value:
00606 
00607     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <span class="keyword">this</span> operation.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an Oplock
00608                request which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> granted, then STATUS_PENDING <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00609                If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Oplock isn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> granted then STATUS_OPLOCK_NOT_GRANTED
00610                <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an Oplock I <span class="keywordflow">break</span> to no oplock,
00611                then STATUS_SUCCESS.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an Oplock I <span class="keywordflow">break</span> to
00612                Oplock II then STATUS_PENDING <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.  Other
00613                error codes returned depend on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> nature of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error.
00614 
00615                STATUS_CANCELLED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cancelled during
00616                <span class="keyword">this</span> operation.
00617 
00618                STATUS_SUCCESS <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a create asking <span class="keywordflow">for</span>
00619                a filter oplock.
00620 
00621 --*/
00622 
00623 {
00624     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00625     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00626     <a class="code" href="../../d5/d2/oplock_8c.html#a34">OPLOCK_STATE</a> OplockState;
00627 
00628     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00629 
00630     <span class="comment">//</span>
00631     <span class="comment">//  Get the current IRP stack location</span>
00632     <span class="comment">//</span>
00633 
00634     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00635 
00636     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlOplockFsctrl:  Entered\n"</span>, 0);
00637     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"FsRtlOplockFsctrl:  Oplock      -&gt; %08lx\n"</span>, *Oplock );
00638     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"FsRtlOplockFsctrl:  Irp         -&gt; %08lx\n"</span>, Irp );
00639 
00640     <span class="comment">//</span>
00641     <span class="comment">//  Check if this is the create case where the user is requesting a pending</span>
00642     <span class="comment">//  filter oplock.</span>
00643     <span class="comment">//</span>
00644 
00645     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>) {
00646 
00647         <span class="comment">//</span>
00648         <span class="comment">//  Check that all the conditions hold to grant this oplock.</span>
00649         <span class="comment">//  The conditions that must hold are:</span>
00650         <span class="comment">//</span>
00651         <span class="comment">//      - This is the only opener of the file.</span>
00652         <span class="comment">//      - Desired Access must be exactly FILE_READ_ATTRIBUTES.</span>
00653         <span class="comment">//          This will insure an asynch open since the SYNCHRONIZE</span>
00654         <span class="comment">//          flag can't be set.</span>
00655         <span class="comment">//      - Share access is precisely</span>
00656         <span class="comment">//          (FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE)</span>
00657         <span class="comment">//</span>
00658 
00659         <span class="keywordflow">if</span> ((OpenCount != 1) ||
00660             (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.SecurityContext-&gt;DesiredAccess,
00661                      ~(FILE_READ_ATTRIBUTES))) ||
00662             ((IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess &amp;
00663               (FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE)) !=
00664              (FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE))) {
00665 
00666             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_NOT_GRANTED;
00667 
00668         } <span class="keywordflow">else</span> {
00669 
00670             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a40">FsRtlRequestExclusiveOplock</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> *) Oplock,
00671                                                   IrpSp,
00672                                                   NULL,
00673                                                   OpFilterReqPending );
00674         }
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">//  Case on the FsControlFile code control code.</span>
00678     <span class="comment">//</span>
00679 
00680     } <span class="keywordflow">else</span> {
00681 
00682         <span class="comment">//</span>
00683         <span class="comment">//  Assume this is an OplockLevel I.</span>
00684         <span class="comment">//</span>
00685         <span class="comment">//  NOTE - This code depends on the defined bits for these oplock types.</span>
00686         <span class="comment">//      FILTER_OPLOCK = 4 * LEVEL_I_OPLOCK</span>
00687         <span class="comment">//      BATCH_OPLOCK = 2 * LEVEL_I_OPLOCK</span>
00688         <span class="comment">//</span>
00689 
00690         OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a3">LEVEL_I_OPLOCK</a>;
00691 
00692         <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.FileSystemControl.FsControlCode) {
00693 
00694         <span class="keywordflow">case</span> FSCTL_REQUEST_FILTER_OPLOCK :
00695 
00696             OplockState *= 2;
00697 
00698         <span class="keywordflow">case</span> FSCTL_REQUEST_BATCH_OPLOCK :
00699 
00700             OplockState *= 2;
00701 
00702         <span class="keywordflow">case</span> FSCTL_REQUEST_OPLOCK_LEVEL_1 :
00703 
00704             <span class="comment">//</span>
00705             <span class="comment">//  Set the other flags for an exclusive oplock.</span>
00706             <span class="comment">//</span>
00707 
00708             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( OplockState, EXCLUSIVE );
00709 
00710             <span class="comment">//</span>
00711             <span class="comment">//  We short circuit the request if this request is treated</span>
00712             <span class="comment">//  synchronously or the open count is not 1.  Otherwise the Io system</span>
00713             <span class="comment">//  will hold the return code until the Irp is completed.</span>
00714             <span class="comment">//</span>
00715             <span class="comment">//  Also fail this if the flag is set which indicates that</span>
00716             <span class="comment">//  the IO system should copy data back to a user's buffer.</span>
00717             <span class="comment">//</span>
00718             <span class="comment">//  If cleanup has occurrred on this file, then we refuse</span>
00719             <span class="comment">//  the oplock request.</span>
00720             <span class="comment">//</span>
00721 
00722             <span class="keywordflow">if</span> ((OpenCount != 1) ||
00723                 <a class="code" href="../../d4/d6/iosubs_8c.html#a83">IoIsOperationSynchronous</a>( Irp ) ||
00724                 <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, IRP_INPUT_OPERATION ) ||
00725                 <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_CLEANUP_COMPLETE )) {
00726 
00727                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_OPLOCK_NOT_GRANTED );
00728                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_NOT_GRANTED;
00729 
00730             } <span class="keywordflow">else</span> {
00731 
00732                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a40">FsRtlRequestExclusiveOplock</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> *) Oplock,
00733                                                       IrpSp,
00734                                                       Irp,
00735                                                       OplockState );
00736             }
00737 
00738             <span class="keywordflow">break</span>;
00739 
00740         <span class="keywordflow">case</span> FSCTL_REQUEST_OPLOCK_LEVEL_2 :
00741 
00742             <span class="comment">//</span>
00743             <span class="comment">//  We short circuit the request if this request is treated</span>
00744             <span class="comment">//  synchronously.  Otherwise the Io system will hold the return</span>
00745             <span class="comment">//  code until the Irp is completed.</span>
00746             <span class="comment">//</span>
00747             <span class="comment">//  If cleanup has occurrred on this file, then we refuse</span>
00748             <span class="comment">//  the oplock request.</span>
00749             <span class="comment">//</span>
00750             <span class="comment">//  Also fail this if the flag is set which indicates that</span>
00751             <span class="comment">//  the IO system should copy data back to a user's buffer.</span>
00752             <span class="comment">//</span>
00753             <span class="comment">//  A non-zero open count in this case indicates that there are</span>
00754             <span class="comment">//  file locks on the file.  We will also fail the request in</span>
00755             <span class="comment">//  this case.</span>
00756             <span class="comment">//</span>
00757 
00758             <span class="keywordflow">if</span> ((OpenCount != 0) ||
00759                 <a class="code" href="../../d4/d6/iosubs_8c.html#a83">IoIsOperationSynchronous</a>( Irp ) ||
00760                 <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, IRP_INPUT_OPERATION ) ||
00761                 <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_CLEANUP_COMPLETE )) {
00762 
00763                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_OPLOCK_NOT_GRANTED );
00764                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_NOT_GRANTED;
00765 
00766             } <span class="keywordflow">else</span> {
00767 
00768                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a41">FsRtlRequestOplockII</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> *) Oplock,
00769                                                IrpSp,
00770                                                Irp );
00771             }
00772 
00773             <span class="keywordflow">break</span>;
00774 
00775         <span class="keywordflow">case</span> FSCTL_OPLOCK_BREAK_ACKNOWLEDGE :
00776 
00777             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a42">FsRtlAcknowledgeOplockBreak</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock,
00778                                                   IrpSp,
00779                                                   Irp,
00780                                                   TRUE );
00781             <span class="keywordflow">break</span>;
00782 
00783         <span class="keywordflow">case</span> FSCTL_OPLOCK_BREAK_ACK_NO_2 :
00784 
00785             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a42">FsRtlAcknowledgeOplockBreak</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock,
00786                                                   IrpSp,
00787                                                   Irp,
00788                                                   FALSE );
00789             <span class="keywordflow">break</span>;
00790 
00791         <span class="keywordflow">case</span> FSCTL_OPBATCH_ACK_CLOSE_PENDING :
00792 
00793             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a43">FsRtlOpBatchBreakClosePending</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock,
00794                                                     IrpSp,
00795                                                     Irp );
00796             <span class="keywordflow">break</span>;
00797 
00798         <span class="keywordflow">case</span> FSCTL_OPLOCK_BREAK_NOTIFY :
00799 
00800             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a44">FsRtlOplockBreakNotify</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock,
00801                                              IrpSp,
00802                                              Irp );
00803             <span class="keywordflow">break</span>;
00804 
00805         <span class="keywordflow">default</span> :
00806 
00807             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0,
00808                         Dbg,
00809                         <span class="stringliteral">"Invalid Control Code\n"</span>,
00810                         0);
00811 
00812             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_INVALID_PARAMETER );
00813             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00814         }
00815     }
00816 
00817     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlOplockFsctrl:  Exit -&gt; %08lx\n"</span>, Status );
00818     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00819 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="oplock.c::FsRtlOplockIsFastIoPossible" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlOplockIsFastIoPossible           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Oplock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l01116">1116</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00080">LEVEL_II_OPLOCK</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00094">OPLOCK_BREAK_MASK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00128">OPLOCK_STATE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">UdfFastLock()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>, and <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>.
<p>
<pre class="fragment"><div>01122                    :
01123 
01124     This routine indicates to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller where there are any outstanding
01125     oplocks which prevent fast Io from happening.
01126 
01127 Arguments:
01128 
01129     OpLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock being queried
01130 
01131 Return Value:
01132 
01133     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> there are outstanding oplocks and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
01134 
01135 --*/
01136 
01137 {
01138     BOOLEAN FastIoPossible = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01139 
01140     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01141 
01142     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlOplockIsFastIoPossible: Oplock -&gt; %08lx\n"</span>, *Oplock);
01143 
01144     <span class="comment">//</span>
01145     <span class="comment">//  There are not any current oplocks if the variable is null or</span>
01146     <span class="comment">//  the state is no oplocks held.  If an exclusive oplock was granted</span>
01147     <span class="comment">//  but no break is in progress then allow the Fast IO.</span>
01148     <span class="comment">//</span>
01149 
01150     <span class="keywordflow">if</span> (*Oplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01151 
01152         <a class="code" href="../../d5/d2/oplock_8c.html#a34">OPLOCK_STATE</a> OplockState;
01153 
01154         OplockState = ((<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock)-&gt;OplockState;
01155 
01156         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, LEVEL_II_OPLOCK | OPLOCK_BREAK_MASK )) {
01157 
01158             FastIoPossible = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01159         }
01160     }
01161 
01162     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlOplockIsFastIoPossible: Exit -&gt; %08lx\n"</span>, FastIoPossible);
01163 
01164     <span class="keywordflow">return</span> FastIoPossible;
01165 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="oplock.c::FsRtlRemoveAndCompleteIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlRemoveAndCompleteIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Link</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l02952">2952</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00100">IoAcquireCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l03396">FsRtlCancelOplockIIIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02249">FsRtlOplockCleanup()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">FsRtlRequestExclusiveOplock()</a>.
<p>
<pre class="fragment"><div>02958                    :
02959 
02960     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to remove an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> from a list of Irps linked
02961     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Tail.ListEntry field and complete them with STATUS_CANCELLED
02962     <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> has been cancelled, STATUS_SUCCESS otherwise.
02963 
02964 Arguments:
02965 
02966     Link - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry to remove from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
02967 
02968 Return Value:
02969 
02970     None.
02971 
02972 --*/
02973 
02974 {
02975     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
02976     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> OplockIIIrpSp;
02977 
02978     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlRemoveAndCompleteIrp:  Entered\n"</span>, 0 );
02979 
02980     <span class="comment">//</span>
02981     <span class="comment">//  Reference the Irp.</span>
02982     <span class="comment">//</span>
02983 
02984     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = CONTAINING_RECORD( Link, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Overlay.ListEntry );
02985 
02986     <span class="comment">//</span>
02987     <span class="comment">//  Get the stack location and dereference the file object.</span>
02988     <span class="comment">//</span>
02989 
02990     OplockIIIrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
02991     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( OplockIIIrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> );
02992 
02993     <span class="comment">//</span>
02994     <span class="comment">//  Clear the cancel routine in the irp.</span>
02995     <span class="comment">//</span>
02996 
02997     <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
02998 
02999     <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, NULL );
03000     <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03001 
03002     <span class="comment">//</span>
03003     <span class="comment">// Remove this from the list.</span>
03004     <span class="comment">//</span>
03005 
03006     RemoveEntryList( Link );
03007 
03008     <span class="comment">//</span>
03009     <span class="comment">//  Complete the oplock Irp.</span>
03010     <span class="comment">//</span>
03011 
03012     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
03013 
03014     <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a> ? STATUS_CANCELLED : STATUS_SUCCESS );
03015 
03016     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlRemoveAndCompleteIrp:  Exit\n"</span>, 0 );
03017 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="oplock.c::FsRtlRemoveAndCompleteWaitIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlRemoveAndCompleteWaitIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d8/struct__WAITING__IRP.html">PWAITING_IRP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>WaitingIrp</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l03623">3623</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00100">IoAcquireCancelSpinLock()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01678">FsRtlAcknowledgeOplockBreak()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03519">FsRtlCancelExclusiveIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03288">FsRtlCancelWaitIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l02249">FsRtlOplockCleanup()</a>.
<p>
<pre class="fragment"><div>03629                    :
03630 
03631     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to remove and perform any neccessary cleanup
03632     <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> stored on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> waiting <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> list in an oplock structure.
03633 
03634 Arguments:
03635 
03636     WaitingIrp - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> auxilary structure attached to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>
03637                  being completed.
03638 
03639 Return Value:
03640 
03641     None.
03642 
03643 --*/
03644 
03645 {
03646     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
03647 
03648     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03649 
03650     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlRemoveAndCompleteWaitIrp:  Entered\n"</span>, 0 );
03651 
03652     <span class="comment">//</span>
03653     <span class="comment">//  Remove the Irp from the queue.</span>
03654     <span class="comment">//</span>
03655 
03656     RemoveEntryList( &amp;WaitingIrp-&gt;Links );
03657 
03658     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = WaitingIrp-&gt;Irp;
03659 
03660     <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03661 
03662     <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, NULL );
03663     <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03664 
03665     <span class="comment">//</span>
03666     <span class="comment">//  Restore the information field.</span>
03667     <span class="comment">//</span>
03668 
03669     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = WaitingIrp-&gt;Information;
03670 
03671     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>
03672                             ? STATUS_CANCELLED
03673                             : STATUS_SUCCESS);
03674 
03675     <span class="comment">//</span>
03676     <span class="comment">//  Call the completion routine in the Waiting Irp.</span>
03677     <span class="comment">//</span>
03678 
03679     WaitingIrp-&gt;CompletionRoutine( WaitingIrp-&gt;Context, Irp );
03680 
03681     <span class="comment">//</span>
03682     <span class="comment">//  And free up pool</span>
03683     <span class="comment">//</span>
03684 
03685     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( WaitingIrp );
03686 
03687     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlRemoveAndCompleteWaitIrp:  Exit\n"</span>, 0 );
03688 
03689     <span class="keywordflow">return</span>;
03690 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="oplock.c::FsRtlRequestExclusiveOplock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlRequestExclusiveOplock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Oplock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d8/fsrtllks_8h.html#a12">OPLOCK_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NextOplockState</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">1299</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00243">_NONOPAQUE_OPLOCK::FastMutex</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00217">_NONOPAQUE_OPLOCK::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01221">FsRtlAllocateOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03519">FsRtlCancelExclusiveIrp()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02952">FsRtlRemoveAndCompleteIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00100">IoAcquireCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00210">_NONOPAQUE_OPLOCK::IrpExclusiveOplock</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00224">_NONOPAQUE_OPLOCK::IrpOplocksII</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00080">LEVEL_II_OPLOCK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00076">NO_OPLOCK</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00105">OpFilterReqPending</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00122">OplockIIGranted</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00237">_NONOPAQUE_OPLOCK::OplockState</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00085">PENDING</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">FsRtlOplockFsctrl()</a>.
<p>
<pre class="fragment"><div>01308                    :
01309 
01310     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called whenever a user <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> requesting either a batch/filter
01311     oplock or a level I oplock.  The request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> granted <span class="keywordflow">if</span> there are currently
01312     no oplocks on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or we are completing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter oplock request.
01313 
01314     NOTE - We already know that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open count on <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> exactly one.
01315         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> requesting a PendingFilter Oplock then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state
01316         must be NoOplockHeld.
01317 
01318 Arguments:
01319 
01320     Oplock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-opaque oplock structure <span class="keywordflow">for</span>
01321              <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01322 
01323     IrpSp - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> stack location <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
01324 
01325     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which declares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
01326           operation.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified <span class="keywordflow">if</span> we are granting a pending
01327           filter oplock (during a create).
01328 
01329     NextOplockState - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of oplock being requested.
01330 
01331 Return Value:
01332 
01333     STATUS_PENDING <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> granted (although it may be immediately cancelled).
01334     STATUS_SUCCESS <span class="keywordflow">if</span> a pending filter oplock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> requested and tentatively granted.
01335     STATUS_OPLOCK_NOT_GRANTED <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> denied.
01336 
01337 --*/
01338 
01339 {
01340     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01341 
01342     <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> ThisOplock;
01343 
01344     BOOLEAN AcquiredMutex;
01345     BOOLEAN BreakOpFilter = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01346 
01347     PLIST_ENTRY Link;
01348 
01349     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlRequestExclusiveOplock:  Entered\n"</span>, 0 );
01350     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Oplock        -&gt; %08lx\n"</span>, Oplock );
01351     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"IrpSp         -&gt; %08lx\n"</span>, IrpSp );
01352     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Irp           -&gt; %08lx\n"</span>, Irp );
01353     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"BatchOplock   -&gt; %01x\n"</span>,  BatchOplock );
01354 
01355     <span class="comment">//</span>
01356     <span class="comment">//  We can grant the oplock if no one else owns a level I or level II</span>
01357     <span class="comment">//  oplock on this file.  If the oplock pointer is NULL then there</span>
01358     <span class="comment">//  are no oplocks on the file.  Otherwise we need to check the</span>
01359     <span class="comment">//  oplock state in an existing oplock structure.</span>
01360     <span class="comment">//</span>
01361 
01362     <span class="keywordflow">if</span> (*Oplock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01363 
01364         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0,
01365                     Dbg,
01366                     <span class="stringliteral">"Oplock currently not allocated\n"</span>,
01367                     0);
01368 
01369         ThisOplock = <a class="code" href="../../d5/d2/oplock_8c.html#a39">FsRtlAllocateOplock</a>();
01370         *Oplock = ThisOplock;
01371 
01372     } <span class="keywordflow">else</span> {
01373 
01374         ThisOplock = *Oplock;
01375     }
01376 
01377     <span class="comment">//</span>
01378     <span class="comment">//  Grab the synchronization object for the oplock.</span>
01379     <span class="comment">//</span>
01380 
01381     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
01382 
01383     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01384 
01385     <span class="comment">//</span>
01386     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01387     <span class="comment">//</span>
01388 
01389     <span class="keywordflow">try</span> {
01390 
01391         <span class="comment">//</span>
01392         <span class="comment">//  If we are requesting a PendingFilter Oplock then it must be</span>
01393         <span class="comment">//  safe to grant.  There is only one open handle and we are in</span>
01394         <span class="comment">//  the process of opening it.</span>
01395         <span class="comment">//</span>
01396 
01397         <span class="keywordflow">if</span> (NextOplockState == <a class="code" href="../../d5/d2/oplock_8c.html#a20">OpFilterReqPending</a>) {
01398 
01399             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a>, NO_OPLOCK | PENDING ));
01400 
01401             ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
01402             ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a> = IrpSp-&gt;FileObject;
01403 
01404             ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a20">OpFilterReqPending</a>;
01405             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01406 
01407         <span class="comment">//</span>
01408         <span class="comment">//  If the current oplock state is no oplocks held then we</span>
01409         <span class="comment">//  will grant the oplock to this requestor.  If the state is</span>
01410         <span class="comment">//  either of the OpFilter states then also grant the request.</span>
01411         <span class="comment">//  We won't check for a matching file object because there can</span>
01412         <span class="comment">//  only be one file object.  Grant the request anyway.</span>
01413         <span class="comment">//</span>
01414         <span class="comment">//  If the current state is OplockII granted then it must</span>
01415         <span class="comment">//  be owned by this request.  Break the oplock II and grant</span>
01416         <span class="comment">//  the exclusive lock.</span>
01417         <span class="comment">//</span>
01418 
01419         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a>,
01420                            LEVEL_II_OPLOCK | NO_OPLOCK | PENDING )) {
01421 
01422             <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> OplockFastMutex;
01423 
01424             <span class="keywordflow">if</span> (ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a> == <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>) {
01425 
01426                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>.Flink == ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>.Blink );
01427 
01428                 <a class="code" href="../../d5/d2/oplock_8c.html#a48">FsRtlRemoveAndCompleteIrp</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>.Flink );
01429             }
01430 
01431             <span class="comment">//</span>
01432             <span class="comment">//  Put the address of the fast mutex on the stack.</span>
01433             <span class="comment">//</span>
01434 
01435             OplockFastMutex = ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a>;
01436 
01437             <span class="comment">//</span>
01438             <span class="comment">//  We store this Irp in the Oplocks structure.</span>
01439             <span class="comment">//  We set the oplock state to the correct exclusive oplock.</span>
01440             <span class="comment">//</span>
01441 
01442             ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
01443             ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a> = IrpSp-&gt;FileObject;
01444             ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a> = NextOplockState;
01445 
01446             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp );
01447 
01448             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( IrpSp-&gt;FileObject );
01449 
01450             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = (ULONG_PTR) ThisOplock;
01451 
01452             <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01453 
01454             <span class="comment">//</span>
01455             <span class="comment">//  Now if the irp is cancelled then we'll call the cancel</span>
01456             <span class="comment">//  routine right now to do away with the irp, otherwise</span>
01457             <span class="comment">//  we set the cancel routine</span>
01458             <span class="comment">//</span>
01459 
01460             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
01461 
01462                 AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01463 
01464                 <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( OplockFastMutex );
01465 
01466                 <a class="code" href="../../d5/d2/oplock_8c.html#a53">FsRtlCancelExclusiveIrp</a>( NULL, Irp );
01467 
01468             } <span class="keywordflow">else</span> {
01469 
01470                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, FsRtlCancelExclusiveIrp );
01471                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01472             }
01473 
01474             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PENDING;
01475 
01476         } <span class="keywordflow">else</span> {
01477 
01478             <span class="comment">//</span>
01479             <span class="comment">//  We'll complete the Irp with the Oplock not granted message</span>
01480             <span class="comment">//  and return that value as a status.</span>
01481             <span class="comment">//</span>
01482 
01483             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Irp )) {
01484 
01485                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_OPLOCK_NOT_GRANTED );
01486             }
01487 
01488             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_NOT_GRANTED;
01489         }
01490 
01491     } finally {
01492 
01493         <span class="comment">//</span>
01494         <span class="comment">//  Give up the oplock synchronization object.</span>
01495         <span class="comment">//</span>
01496 
01497         <span class="keywordflow">if</span> (AcquiredMutex) {
01498 
01499             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
01500         }
01501 
01502         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlRequestExclusiveOplock:  Exit\n"</span>, 0 );
01503     }
01504 
01505     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01506 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="oplock.c::FsRtlRequestOplockII" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlRequestOplockII           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Oplock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l01514">1514</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00243">_NONOPAQUE_OPLOCK::FastMutex</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01221">FsRtlAllocateOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03396">FsRtlCancelOplockIIIrp()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00100">IoAcquireCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00224">_NONOPAQUE_OPLOCK::IrpOplocksII</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00080">LEVEL_II_OPLOCK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00076">NO_OPLOCK</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00122">OplockIIGranted</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00237">_NONOPAQUE_OPLOCK::OplockState</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">FsRtlOplockFsctrl()</a>.
<p>
<pre class="fragment"><div>01522                    :
01523 
01524     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a user <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> requesting an Oplock II on an
01525     open <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  The request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> granted <span class="keywordflow">if</span> there are currently no
01526     level 1 oplocks on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and an oplock <span class="keywordflow">break</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not in progress.
01527 
01528 Arguments:
01529 
01530     Oplock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-opaque oplock structure <span class="keywordflow">for</span>
01531              <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01532 
01533     IrpSp - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> stack location <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
01534 
01535     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which declares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
01536           operation.
01537 
01538 Return Value:
01539 
01540     STATUS_PENDING <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> granted.
01541     STATUS_OPLOCK_NOT_GRANTED <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> denied.
01542 
01543 --*/
01544 
01545 {
01546     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01547 
01548     <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> ThisOplock;
01549 
01550     BOOLEAN AcquiredMutex;
01551 
01552     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlRequestOplockII:  Entered\n"</span>, 0 );
01553     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
01554     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"IrpSp     -&gt; %08lx\n"</span>, IrpSp );
01555     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, Irp );
01556 
01557     <span class="comment">//</span>
01558     <span class="comment">//  We can grant the oplock if no one else owns a level I</span>
01559     <span class="comment">//  oplock on this file.  If the oplock pointer is NULL then there</span>
01560     <span class="comment">//  are no oplocks on the file.  Otherwise we need to check the</span>
01561     <span class="comment">//  oplock state in an existing oplock structure.</span>
01562     <span class="comment">//</span>
01563 
01564     <span class="keywordflow">if</span> (*Oplock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01565 
01566         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0,
01567                     Dbg,
01568                     <span class="stringliteral">"Oplock currently not allocated\n"</span>,
01569                     0);
01570 
01571         ThisOplock = <a class="code" href="../../d5/d2/oplock_8c.html#a39">FsRtlAllocateOplock</a>();
01572         *Oplock = ThisOplock;
01573 
01574     } <span class="keywordflow">else</span> {
01575 
01576         ThisOplock = *Oplock;
01577     }
01578 
01579     <span class="comment">//</span>
01580     <span class="comment">//  Grab the synchronization object for the oplock.</span>
01581     <span class="comment">//</span>
01582 
01583     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
01584 
01585     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01586 
01587     <span class="comment">//</span>
01588     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01589     <span class="comment">//</span>
01590 
01591     <span class="keywordflow">try</span> {
01592 
01593         <span class="comment">//</span>
01594         <span class="comment">//  If the current oplock state is no oplocks held or OplockIIGranted</span>
01595         <span class="comment">//  then we will grant the oplock to this requestor.</span>
01596         <span class="comment">//</span>
01597 
01598         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a>, NO_OPLOCK | LEVEL_II_OPLOCK )) {
01599 
01600             <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> OplockFastMutex = ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a>;
01601 
01602             <span class="comment">//</span>
01603             <span class="comment">//  We store this Irp in the Oplocks structure.</span>
01604             <span class="comment">//  We set the oplock state to 'OplockIIGranted'.</span>
01605             <span class="comment">//</span>
01606 
01607             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp );
01608 
01609             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_SUCCESS;
01610 
01611             InsertHeadList( &amp;ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>,
01612                             &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.ListEntry );
01613 
01614             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = (ULONG_PTR) ThisOplock;
01615 
01616             ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>;
01617 
01618             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( IrpSp-&gt;FileObject );
01619 
01620             <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01621 
01622             <span class="comment">//</span>
01623             <span class="comment">//  Now if the irp is cancelled then we'll call the cancel</span>
01624             <span class="comment">//  routine right now to do away with the irp, otherwise</span>
01625             <span class="comment">//  we set the cancel routine</span>
01626             <span class="comment">//</span>
01627 
01628             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
01629 
01630                 AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01631 
01632                 <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( OplockFastMutex );
01633 
01634                 <a class="code" href="../../d5/d2/oplock_8c.html#a52">FsRtlCancelOplockIIIrp</a>( NULL, Irp );
01635 
01636             } <span class="keywordflow">else</span> {
01637 
01638                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, FsRtlCancelOplockIIIrp );
01639                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01640             }
01641 
01642             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PENDING;
01643 
01644         } <span class="keywordflow">else</span> {
01645 
01646             <span class="comment">//</span>
01647             <span class="comment">//  We'll complete the Irp with the Oplock not granted message</span>
01648             <span class="comment">//  and return that value as a status.</span>
01649             <span class="comment">//</span>
01650 
01651             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_OPLOCK_NOT_GRANTED );
01652             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_NOT_GRANTED;
01653         }
01654 
01655     } finally {
01656 
01657         <span class="comment">//</span>
01658         <span class="comment">//  Give up the oplock synchronization object.</span>
01659         <span class="comment">//</span>
01660 
01661         <span class="keywordflow">if</span> (AcquiredMutex) {
01662 
01663             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
01664         }
01665 
01666         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlRequestOplockII:  Exit\n"</span>, 0 );
01667     }
01668 
01669     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01670 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="oplock.c::FsRtlUninitializeOplock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlUninitializeOplock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Oplock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00413">413</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00284">_WAITING_IRP::CompletionRoutine</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00290">_WAITING_IRP::Context</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00243">_NONOPAQUE_OPLOCK::FastMutex</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00217">_NONOPAQUE_OPLOCK::FileObject</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00100">IoAcquireCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00277">_WAITING_IRP::Irp</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00210">_NONOPAQUE_OPLOCK::IrpExclusiveOplock</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00224">_NONOPAQUE_OPLOCK::IrpOplocksII</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a>, and <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00231">_NONOPAQUE_OPLOCK::WaitingIrps</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02178">UdfDeleteFcb()</a>.
<p>
<pre class="fragment"><div>00419                    :
00420 
00421     This routine uninitializes an <a class="code" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a> structure.  After calling <span class="keyword">this</span>
00422     routine, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a> structure must be reinitialized before being
00423     used again.
00424 
00425 Arguments:
00426 
00427     Oplock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of an opaque <a class="code" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a> structure.
00428 
00429 Return Value:
00430 
00431     None.
00432 
00433 --*/
00434 
00435 
00436 {
00437     <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> ThisOplock;
00438 
00439     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlUninitializeOplock:  Oplock -&gt; %08lx\n"</span>, *Oplock );
00440 
00441     <span class="comment">//</span>
00442     <span class="comment">//  If the Oplock structure has not been allocated, there is no action</span>
00443     <span class="comment">//  to take.</span>
00444     <span class="comment">//</span>
00445 
00446     <span class="keywordflow">if</span> (*Oplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00447 
00448         <span class="comment">//</span>
00449         <span class="comment">//  Remove this from the user's structure.</span>
00450         <span class="comment">//</span>
00451 
00452         ThisOplock = (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock;
00453 
00454         *Oplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00455 
00456         <span class="comment">//</span>
00457         <span class="comment">//  Grab the waiting lock queue mutex to exclude anyone from messing</span>
00458         <span class="comment">//  with the queue while we're using it</span>
00459         <span class="comment">//</span>
00460 
00461         <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
00462 
00463         <span class="keywordflow">try</span> {
00464 
00465             <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00466 
00467             <span class="comment">//</span>
00468             <span class="comment">//  Release any waiting Irps held.</span>
00469             <span class="comment">//</span>
00470 
00471             <span class="keywordflow">while</span> (!IsListEmpty( &amp;ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a> )) {
00472 
00473                 <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">PWAITING_IRP</a> WaitingIrp;
00474                 <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> ThisIrp;
00475 
00476                 WaitingIrp = CONTAINING_RECORD( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a>.Flink,
00477                                                 <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
00478                                                 Links );
00479 
00480                 RemoveHeadList( &amp;ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a> );
00481 
00482                 ThisIrp = WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o1">Irp</a>;
00483 
00484                 <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;ThisIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00485 
00486                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( ThisIrp, NULL );
00487                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( ThisIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00488 
00489                 ThisIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
00490 
00491                 <span class="comment">//</span>
00492                 <span class="comment">//  Call the completion routine in the Waiting Irp.</span>
00493                 <span class="comment">//</span>
00494 
00495                 WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o2">CompletionRoutine</a>( WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o3">Context</a>,
00496                                                WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o1">Irp</a> );
00497 
00498                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( WaitingIrp );
00499             }
00500 
00501             <span class="comment">//</span>
00502             <span class="comment">//  Release any oplock II irps held.</span>
00503             <span class="comment">//</span>
00504 
00505             <span class="keywordflow">while</span> (!IsListEmpty( &amp;ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a> )) {
00506 
00507                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = CONTAINING_RECORD( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>.Flink,
00508                                          <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>,
00509                                          Tail.Overlay.ListEntry );
00510 
00511                 RemoveHeadList( &amp;ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a> );
00512 
00513                 <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00514 
00515                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, NULL );
00516                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00517 
00518                 <span class="comment">//</span>
00519                 <span class="comment">//  Complete the oplock II Irp.</span>
00520                 <span class="comment">//</span>
00521 
00522                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp )-&gt;FileObject );
00523 
00524                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
00525                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_SUCCESS );
00526             }
00527 
00528             <span class="comment">//</span>
00529             <span class="comment">//  Release any exclusive oplock held.</span>
00530             <span class="comment">//</span>
00531 
00532             <span class="keywordflow">if</span> (ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00533 
00534                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a>;
00535 
00536                 <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00537 
00538                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, NULL );
00539                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00540 
00541                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
00542                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_SUCCESS );
00543 
00544                 ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00545 
00546                 <span class="keywordflow">if</span> (ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00547 
00548                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a> );
00549                 }
00550             }
00551 
00552         } finally {
00553 
00554             <span class="comment">//</span>
00555             <span class="comment">//  No matter how we complete the preceding statements we will</span>
00556             <span class="comment">//  now release the waiting lock queue mutex</span>
00557             <span class="comment">//</span>
00558 
00559             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
00560         }
00561 
00562         <span class="comment">//</span>
00563         <span class="comment">//  Deallocate the mutex.</span>
00564         <span class="comment">//</span>
00565 
00566         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
00567 
00568         <span class="comment">//</span>
00569         <span class="comment">//  Deallocate the Oplock structure.</span>
00570         <span class="comment">//</span>
00571 
00572         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ThisOplock );
00573     }
00574 
00575     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlUninitializeOplock:  Exit\n"</span>, 0 );
00576     <span class="keywordflow">return</span>;
00577 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="oplock.c::FsRtlWaitOnIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlWaitOnIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Oplock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a79">POPLOCK_WAIT_COMPLETE_ROUTINE</a> CompletionRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a80">POPLOCK_FS_PREPOST_IRP</a> PostIrpRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Event</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l03025">3025</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00284">_WAITING_IRP::CompletionRoutine</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00290">_WAITING_IRP::Context</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03288">FsRtlCancelWaitIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03241">FsRtlCompletionRoutinePriv()</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00040">FsRtlpAllocatePool</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00305">_WAITING_IRP::Information</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00100">IoAcquireCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00277">_WAITING_IRP::Irp</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00271">_WAITING_IRP::Links</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l02111">FsRtlOplockBreakNotify()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>.
<p>
<pre class="fragment"><div>03036                    :
03037 
03038     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to create a Wait <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> structure and attach <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
03039     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.  The <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> then added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of Irps waiting
03040     <span class="keywordflow">for</span> an oplock <span class="keywordflow">break</span>.  We check <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> has been cancelled and <span class="keywordflow">if</span>
03041     so we call our cancel routine to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work.
03042 
03043     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mutex <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock on entry and
03044     must give <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> up on <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>.
03045 
03046 Arguments:
03047 
03048     Oplock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-opaque oplock structure <span class="keywordflow">for</span>
03049              <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
03050 
03051     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which declares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
03052           operation.
03053 
03054     Context - This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed as a parameter to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion routine.
03055 
03056     CompletionRoutine - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">if</span> <span class="keyword">this</span>
03057                         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> must wait <span class="keywordflow">for</span> an Oplock to <span class="keywordflow">break</span>.  This
03058                         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a synchronous operation <span class="keywordflow">if</span> not specified
03059                         and we block in <span class="keyword">this</span> thread waiting on
03060                         an event.
03061 
03062     PostIrpRoutine - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine to call before we put anything
03063                      on our waiting <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> queue.
03064 
03065     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no user completion routine, <span class="keyword">this</span> thread will
03066             block <span class="keyword">using</span> <span class="keyword">this</span> event.
03067 
03068 Return Value:
03069 
03070     STATUS_SUCCESS <span class="keywordflow">if</span> we can complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation on exiting <span class="keyword">this</span> thread.
03071     STATUS_PENDING <span class="keywordflow">if</span> we <span class="keywordflow">return</span> here but hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
03072     STATUS_CANCELLED <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cancelled before we <span class="keywordflow">return</span>.
03073 
03074 --*/
03075 
03076 {
03077     BOOLEAN AcquiredMutex;
03078     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03079 
03080     <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">PWAITING_IRP</a> WaitingIrp;
03081 
03082     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlWaitOnIrp:   Entered\n"</span>, 0 );
03083 
03084     <span class="comment">//</span>
03085     <span class="comment">//  Remember that we have the mutex.</span>
03086     <span class="comment">//</span>
03087 
03088     AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03089 
03090     <span class="comment">//</span>
03091     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
03092     <span class="comment">//</span>
03093 
03094     <span class="keywordflow">try</span> {
03095 
03096         <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> OplockFastMutex = Oplock-&gt;FastMutex;
03097 
03098         <span class="comment">//</span>
03099         <span class="comment">//  Allocate and initialize the Wait Irp structure.</span>
03100         <span class="comment">//</span>
03101 
03102         WaitingIrp = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a> ));
03103 
03104         WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o1">Irp</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
03105 
03106         WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o3">Context</a> = Context;
03107         WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o5">Information</a> = (ULONG) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
03108 
03109         <span class="comment">//</span>
03110         <span class="comment">//  Take appropriate action if depending on the value of the</span>
03111         <span class="comment">//  completion routine.</span>
03112         <span class="comment">//</span>
03113 
03114         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( CompletionRoutine )) {
03115 
03116             WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o2">CompletionRoutine</a> = CompletionRoutine;
03117             WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o3">Context</a> = Context;
03118 
03119         } <span class="keywordflow">else</span> {
03120 
03121             WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o2">CompletionRoutine</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a50">FsRtlCompletionRoutinePriv</a>;
03122             WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o3">Context</a> = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
03123 
03124             <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( Event, NotificationEvent, FALSE );
03125         }
03126 
03127         <span class="comment">//</span>
03128         <span class="comment">//  Call the file system's post Irp code.</span>
03129         <span class="comment">//</span>
03130 
03131         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( PostIrpRoutine )) {
03132 
03133             PostIrpRoutine( Context, Irp );
03134         }
03135 
03136         <span class="comment">//</span>
03137         <span class="comment">//  Initialize the return value to status success.</span>
03138         <span class="comment">//</span>
03139 
03140         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_SUCCESS;
03141 
03142         <span class="comment">//</span>
03143         <span class="comment">//  We put this into the Waiting Irp queue.</span>
03144         <span class="comment">//</span>
03145 
03146         InsertTailList( &amp;Oplock-&gt;WaitingIrps, &amp;WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o0">Links</a> );
03147 
03148         <span class="comment">//</span>
03149         <span class="comment">//  We grab the cancel spinlock and store the address of the oplock.</span>
03150         <span class="comment">//</span>
03151 
03152         <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03153         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = (ULONG_PTR) Oplock;
03154 
03155         <span class="comment">//</span>
03156         <span class="comment">//  If the Irp is cancelled then we'll call the cancel routine</span>
03157         <span class="comment">//  right now to do away with the Waiting Irp structure.</span>
03158         <span class="comment">//</span>
03159 
03160         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
03161 
03162             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( OplockFastMutex );
03163             AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03164 
03165             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( CompletionRoutine )) {
03166 
03167                 <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp );
03168                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PENDING;
03169 
03170             } <span class="keywordflow">else</span> {
03171 
03172                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CANCELLED;
03173             }
03174 
03175             <a class="code" href="../../d5/d2/oplock_8c.html#a51">FsRtlCancelWaitIrp</a>( NULL, Irp );
03176 
03177         <span class="comment">//</span>
03178         <span class="comment">//  Otherwise, we set the cancel routine and decide whether we</span>
03179         <span class="comment">//  are going to wait on our local event.</span>
03180         <span class="comment">//</span>
03181 
03182         } <span class="keywordflow">else</span> {
03183 
03184             <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, FsRtlCancelWaitIrp );
03185             <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
03186 
03187             <span class="comment">//</span>
03188             <span class="comment">//  If we wait on the event, we pull the return code out of</span>
03189             <span class="comment">//  the Irp.</span>
03190             <span class="comment">//</span>
03191 
03192             <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( CompletionRoutine )) {
03193 
03194                 AcquiredMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03195 
03196                 <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
03197 
03198                 <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( Event,
03199                                        Executive,
03200                                        KernelMode,
03201                                        FALSE,
03202                                        NULL );
03203 
03204                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
03205 
03206             <span class="comment">//</span>
03207             <span class="comment">//  Otherwise, we return STATUS_PENDING.</span>
03208             <span class="comment">//</span>
03209 
03210             } <span class="keywordflow">else</span> {
03211 
03212                 <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp );
03213 
03214                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PENDING;
03215             }
03216         }
03217 
03218     } finally {
03219 
03220         <span class="comment">//</span>
03221         <span class="comment">//  Release the Mutex if we have not done so.</span>
03222         <span class="comment">//</span>
03223 
03224         <span class="keywordflow">if</span> (AcquiredMutex) {
03225 
03226             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( Oplock-&gt;FastMutex );
03227         }
03228 
03229         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlWaitOnIrp:   Exit\n"</span>, 0 );
03230     }
03231 
03232     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03233 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:00 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
