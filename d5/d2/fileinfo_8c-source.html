<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fileinfo.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fileinfo.c</h1><a href="../../d4/d3/fileinfo_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    FileInfo.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the File Information routines for Udfs called by</span>
00012 <span class="comment">    the Fsd/Fsp dispatch drivers.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Dan Lovinger    [DanLo]     16-Jan-1997</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "UdfProcs.h"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">//  The Bug check file id for this module</span>
00026 <span class="comment">//</span>
00027 
<a name="l00028"></a><a class="code" href="../../d4/d3/fileinfo_8c.html#a0">00028</a> <span class="preprocessor">#define BugCheckFileId                   (UDFS_BUG_CHECK_FILEINFO)</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">//</span>
00031 <span class="comment">//  The local debug trace level</span>
00032 <span class="comment">//</span>
00033 
<a name="l00034"></a><a class="code" href="../../d4/d3/fileinfo_8c.html#a1">00034</a> <span class="preprocessor">#define Dbg                              (UDFS_DEBUG_LEVEL_FILEINFO)</span>
00035 <span class="preprocessor"></span>
00036 <span class="comment">//</span>
00037 <span class="comment">//  Local macros</span>
00038 <span class="comment">//</span>
00039 
00040 <a class="code" href="../../d5/d3/filelock_8c.html#a1">INLINE</a>
00041 ULONG
<a name="l00042"></a><a class="code" href="../../d4/d3/fileinfo_8c.html#a2">00042</a> <a class="code" href="../../d4/d3/fileinfo_8c.html#a2">UdfGetExtraFileAttributes</a> (
00043     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb
00044     )
00045 
00046 <span class="comment">/*++</span>
00047 <span class="comment"></span>
00048 <span class="comment">Routine Description:</span>
00049 <span class="comment"></span>
00050 <span class="comment">    Safely figure out extra name-based file attributes given a context block.</span>
00051 <span class="comment"></span>
00052 <span class="comment">Arguments:</span>
00053 <span class="comment"></span>
00054 <span class="comment">    Ccb - a context block to examine.</span>
00055 <span class="comment"></span>
00056 <span class="comment">Return Value:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    ULONG - file attributes for a file based on how it was opened (seperate from</span>
00059 <span class="comment">        those based on the object that was opened).</span>
00060 <span class="comment"></span>
00061 <span class="comment">--*/</span>
00062 
00063 {
00064     <span class="keywordflow">return</span> ( Ccb-&gt;Lcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>? Ccb-&gt;Lcb-&gt;FileAttributes : 0 );
00065 }
00066 
00067 <span class="comment">//</span>
00068 <span class="comment">//  Local support routines</span>
00069 <span class="comment">//</span>
00070 
00071 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00072 <a class="code" href="../../d4/d3/fileinfo_8c.html#a3">UdfQueryBasicInfo</a> (
00073     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00074     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00075     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb,
00076     IN OUT PFILE_BASIC_INFORMATION Buffer,
00077     IN OUT PULONG Length
00078     );
00079 
00080 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00081 <a class="code" href="../../d4/d3/fileinfo_8c.html#a4">UdfQueryStandardInfo</a> (
00082     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00083     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00084     IN OUT PFILE_STANDARD_INFORMATION Buffer,
00085     IN OUT PULONG Length
00086     );
00087 
00088 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00089 <a class="code" href="../../d4/d3/fileinfo_8c.html#a5">UdfQueryInternalInfo</a> (
00090     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00091     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00092     IN OUT PFILE_INTERNAL_INFORMATION Buffer,
00093     IN OUT PULONG Length
00094     );
00095 
00096 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00097 <a class="code" href="../../d4/d3/fileinfo_8c.html#a6">UdfQueryEaInfo</a> (
00098     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00099     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00100     IN OUT PFILE_EA_INFORMATION Buffer,
00101     IN OUT PULONG Length
00102     );
00103 
00104 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00105 <a class="code" href="../../d4/d3/fileinfo_8c.html#a7">UdfQueryPositionInfo</a> (
00106     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00107     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
00108     IN OUT PFILE_POSITION_INFORMATION Buffer,
00109     IN OUT PULONG Length
00110     );
00111 
00112 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00113 <a class="code" href="../../d4/d3/fileinfo_8c.html#a8">UdfQueryNameInfo</a> (
00114     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00115     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
00116     IN OUT PFILE_NAME_INFORMATION Buffer,
00117     IN OUT PULONG Length
00118     );
00119 
00120 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00121 <a class="code" href="../../d4/d3/fileinfo_8c.html#a9">UdfQueryAlternateNameInfo</a> (
00122     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00123     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00124     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb,
00125     IN OUT PFILE_NAME_INFORMATION Buffer,
00126     IN OUT PULONG Length
00127     );
00128 
00129 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00130 <a class="code" href="../../d4/d3/fileinfo_8c.html#a10">UdfQueryNetworkInfo</a> (
00131     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00132     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00133     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb,
00134     IN OUT PFILE_NETWORK_OPEN_INFORMATION Buffer,
00135     IN OUT PULONG Length
00136     );
00137 
00138 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00139 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfCommonQueryInfo)</span>
00140 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfCommonSetInfo)</span>
00141 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfFastQueryBasicInfo)</span>
00142 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfFastQueryStdInfo)</span>
00143 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfFastQueryNetworkInfo)</span>
00144 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfQueryAlternateNameInfo)</span>
00145 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfQueryBasicInfo)</span>
00146 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfQueryEaInfo)</span>
00147 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfQueryInternalInfo)</span>
00148 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfQueryNameInfo)</span>
00149 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfQueryNetworkInfo)</span>
00150 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfQueryPositionInfo)</span>
00151 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfQueryStandardInfo)</span>
00152 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00153 <span class="preprocessor"></span>
00154 
00155 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00156"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a259">00156</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a259">UdfCommonQueryInfo</a> (
00157     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00158     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00159     )
00160 
00161 <span class="comment">/*++</span>
00162 <span class="comment"></span>
00163 <span class="comment">Routine Description:</span>
00164 <span class="comment"></span>
00165 <span class="comment">    This is the common routine for query file information called by both the</span>
00166 <span class="comment">    fsd and fsp threads.</span>
00167 <span class="comment"></span>
00168 <span class="comment">Arguments:</span>
00169 <span class="comment"></span>
00170 <span class="comment">    Irp - Supplies the Irp to process.</span>
00171 <span class="comment"></span>
00172 <span class="comment">Return Value:</span>
00173 <span class="comment"></span>
00174 <span class="comment">    NTSTATUS - The return status for this operation.</span>
00175 <span class="comment"></span>
00176 <span class="comment">--*/</span>
00177 
00178 {
00179     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00180     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00181 
00182     ULONG Length;
00183     FILE_INFORMATION_CLASS FileInformationClass;
00184     PFILE_ALL_INFORMATION <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00185 
00186     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00187     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00188     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00189 
00190     BOOLEAN ReleaseFcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00191 
00192     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00193 
00194     <span class="comment">//</span>
00195     <span class="comment">//  Reference our input parameters to make things easier</span>
00196     <span class="comment">//</span>
00197 
00198     Length = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryFile.Length;
00199     FileInformationClass = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryFile.FileInformationClass;
00200     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
00201 
00202     <span class="comment">//</span>
00203     <span class="comment">//  Decode the file object</span>
00204     <span class="comment">//</span>
00205 
00206     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;Fcb, &amp;Ccb );
00207 
00208     <span class="comment">//</span>
00209     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00210     <span class="comment">//</span>
00211 
00212     <span class="keywordflow">try</span> {
00213 
00214         <span class="comment">//</span>
00215         <span class="comment">//  We only support query on file and directory handles.</span>
00216         <span class="comment">//</span>
00217 
00218         <span class="keywordflow">switch</span> (TypeOfOpen) {
00219 
00220         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a> :
00221         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a> :
00222 
00223             <span class="comment">//</span>
00224             <span class="comment">//  Acquire shared access to this file.</span>
00225             <span class="comment">//</span>
00226 
00227             <a class="code" href="../../d3/d8/udfprocs_8h.html#a80">UdfAcquireFileShared</a>( IrpContext, Fcb );
00228             ReleaseFcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00229 
00230             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o10">FcbState</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a13">FCB_STATE_INITIALIZED</a> ));
00231             
00232             <span class="comment">//</span>
00233             <span class="comment">//  Make sure the Fcb is in a usable condition.  This will raise</span>
00234             <span class="comment">//  an error condition if the volume is unusable</span>
00235             <span class="comment">//</span>
00236 
00237             <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( IrpContext, Fcb );
00238 
00239             <span class="comment">//</span>
00240             <span class="comment">//  Based on the information class we'll do different</span>
00241             <span class="comment">//  actions.  Each of hte procedures that we're calling fills</span>
00242             <span class="comment">//  up the output buffer, if possible.  They will raise the</span>
00243             <span class="comment">//  status STATUS_BUFFER_OVERFLOW for an insufficient buffer.</span>
00244             <span class="comment">//  This is considered a somewhat unusual case and is handled</span>
00245             <span class="comment">//  more cleanly with the exception mechanism rather than</span>
00246             <span class="comment">//  testing a return status value for each call.</span>
00247             <span class="comment">//</span>
00248 
00249             <span class="keywordflow">switch</span> (FileInformationClass) {
00250 
00251             <span class="keywordflow">case</span> FileAllInformation:
00252 
00253                 <span class="comment">//</span>
00254                 <span class="comment">//  We don't allow this operation on a file opened by file Id.</span>
00255                 <span class="comment">//</span>
00256 
00257                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o2">Flags</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a20">CCB_FLAG_OPEN_BY_ID</a> )) {
00258 
00259                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00260                     <span class="keywordflow">break</span>;
00261                 }
00262 
00263                 <span class="comment">//</span>
00264                 <span class="comment">//  In this case go ahead and call the individual routines to</span>
00265                 <span class="comment">//  fill in the buffer.  Only the name routine will</span>
00266                 <span class="comment">//  pointer to the output buffer and then call the</span>
00267                 <span class="comment">//  individual routines to fill in the buffer.</span>
00268                 <span class="comment">//</span>
00269 
00270                 Length -= (<span class="keyword">sizeof</span>( FILE_ACCESS_INFORMATION ) +
00271                            <span class="keyword">sizeof</span>( FILE_MODE_INFORMATION ) +
00272                            <span class="keyword">sizeof</span>( FILE_ALIGNMENT_INFORMATION ));
00273 
00274                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a3">UdfQueryBasicInfo</a>( IrpContext, Fcb, Ccb, &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;BasicInformation, &amp;Length );
00275                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a4">UdfQueryStandardInfo</a>( IrpContext, Fcb, &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;StandardInformation, &amp;Length );
00276                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a5">UdfQueryInternalInfo</a>( IrpContext, Fcb, &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;InternalInformation, &amp;Length );
00277                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a6">UdfQueryEaInfo</a>( IrpContext, Fcb, &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EaInformation, &amp;Length );
00278                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a7">UdfQueryPositionInfo</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;PositionInformation, &amp;Length );
00279                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/fileinfo_8c.html#a8">UdfQueryNameInfo</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;NameInformation, &amp;Length );
00280 
00281                 <span class="keywordflow">break</span>;
00282 
00283             <span class="keywordflow">case</span> FileBasicInformation:
00284 
00285                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a3">UdfQueryBasicInfo</a>( IrpContext, Fcb, Ccb, (PFILE_BASIC_INFORMATION) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, &amp;Length );
00286                 <span class="keywordflow">break</span>;
00287 
00288             <span class="keywordflow">case</span> FileStandardInformation:
00289 
00290                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a4">UdfQueryStandardInfo</a>( IrpContext, Fcb, (PFILE_STANDARD_INFORMATION) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, &amp;Length );
00291                 <span class="keywordflow">break</span>;
00292 
00293             <span class="keywordflow">case</span> FileInternalInformation:
00294 
00295                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a5">UdfQueryInternalInfo</a>( IrpContext, Fcb, (PFILE_INTERNAL_INFORMATION) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, &amp;Length );
00296                 <span class="keywordflow">break</span>;
00297 
00298             <span class="keywordflow">case</span> FileEaInformation:
00299 
00300                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a6">UdfQueryEaInfo</a>( IrpContext, Fcb, (PFILE_EA_INFORMATION) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, &amp;Length );
00301                 <span class="keywordflow">break</span>;
00302 
00303             <span class="keywordflow">case</span> FilePositionInformation:
00304 
00305                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a7">UdfQueryPositionInfo</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, (PFILE_POSITION_INFORMATION) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, &amp;Length );
00306                 <span class="keywordflow">break</span>;
00307 
00308             <span class="keywordflow">case</span> FileNameInformation:
00309 
00310                 <span class="comment">//</span>
00311                 <span class="comment">//  We don't allow this operation on a file opened by file Id.</span>
00312                 <span class="comment">//</span>
00313 
00314                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o2">Flags</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a20">CCB_FLAG_OPEN_BY_ID</a> )) {
00315 
00316                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/fileinfo_8c.html#a8">UdfQueryNameInfo</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, (PFILE_NAME_INFORMATION) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, &amp;Length );
00317 
00318                 } <span class="keywordflow">else</span> {
00319 
00320                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00321                 }
00322 
00323                 <span class="keywordflow">break</span>;
00324 
00325             <span class="keywordflow">case</span> FileAlternateNameInformation:
00326 
00327                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o2">Flags</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a20">CCB_FLAG_OPEN_BY_ID</a> )) {
00328 
00329                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/fileinfo_8c.html#a9">UdfQueryAlternateNameInfo</a>( IrpContext, Fcb, Ccb, (PFILE_NAME_INFORMATION) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, &amp;Length );
00330 
00331                 } <span class="keywordflow">else</span> {
00332 
00333                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00334                 }
00335 
00336                 <span class="keywordflow">break</span>;
00337 
00338             <span class="keywordflow">case</span> FileNetworkOpenInformation:
00339 
00340                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a10">UdfQueryNetworkInfo</a>( IrpContext, Fcb, Ccb, (PFILE_NETWORK_OPEN_INFORMATION) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, &amp;Length );
00341                 <span class="keywordflow">break</span>;
00342 
00343             <span class="keywordflow">default</span> :
00344 
00345                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00346             }
00347 
00348             <span class="keywordflow">break</span>;
00349 
00350         <span class="keywordflow">default</span> :
00351 
00352             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00353         }
00354 
00355         <span class="comment">//</span>
00356         <span class="comment">//  Set the information field to the number of bytes actually filled in</span>
00357         <span class="comment">//  and then complete the request</span>
00358         <span class="comment">//</span>
00359 
00360         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryFile.Length - Length;
00361 
00362     } finally {
00363 
00364         <span class="comment">//</span>
00365         <span class="comment">//  Release the file.</span>
00366         <span class="comment">//</span>
00367 
00368         <span class="keywordflow">if</span> (ReleaseFcb) {
00369 
00370             <a class="code" href="../../d3/d8/udfprocs_8h.html#a82">UdfReleaseFile</a>( IrpContext, Fcb );
00371         }
00372     }
00373 
00374     <span class="comment">//</span>
00375     <span class="comment">//  Complete the request if we didn't raise.</span>
00376     <span class="comment">//</span>
00377 
00378     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00379 
00380     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00381 }
00382 
00383 
00384 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00385"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a262">00385</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a262">UdfCommonSetInfo</a> (
00386     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00387     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00388     )
00389 
00390 <span class="comment">/*++</span>
00391 <span class="comment"></span>
00392 <span class="comment">Routine Description:</span>
00393 <span class="comment"></span>
00394 <span class="comment">    This is the common routine for set file information called by both the</span>
00395 <span class="comment">    fsd and fsp threads.  We only support operations which set the file position.</span>
00396 <span class="comment"></span>
00397 <span class="comment">Arguments:</span>
00398 <span class="comment"></span>
00399 <span class="comment">    Irp - Supplies the Irp to process.</span>
00400 <span class="comment"></span>
00401 <span class="comment">Return Value:</span>
00402 <span class="comment"></span>
00403 <span class="comment">    NTSTATUS - The return status for this operation.</span>
00404 <span class="comment"></span>
00405 <span class="comment">--*/</span>
00406 
00407 {
00408     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00409 
00410     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00411     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00412     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00413 
00414     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00415 
00416     PFILE_POSITION_INFORMATION <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00417 
00418     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00419 
00420     <span class="comment">//</span>
00421     <span class="comment">//  Decode the file object</span>
00422     <span class="comment">//</span>
00423 
00424     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;Fcb, &amp;Ccb );
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">//  We only support a SetPositionInformation on a user file.</span>
00428     <span class="comment">//</span>
00429 
00430     <span class="keywordflow">if</span> ((TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) ||
00431         (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryFile.FileInformationClass != FilePositionInformation)) {
00432 
00433         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00434         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00435     }
00436 
00437     <span class="comment">//</span>
00438     <span class="comment">//  Acquire shared access to this file.</span>
00439     <span class="comment">//</span>
00440 
00441     <a class="code" href="../../d3/d8/udfprocs_8h.html#a80">UdfAcquireFileShared</a>( IrpContext, Fcb );
00442 
00443     <span class="keywordflow">try</span> {
00444 
00445         <span class="comment">//</span>
00446         <span class="comment">//  Make sure the Fcb is in a usable condition.  This</span>
00447         <span class="comment">//  will raise an error condition if the fcb is unusable</span>
00448         <span class="comment">//</span>
00449 
00450         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( IrpContext, Fcb );
00451 
00452         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
00453 
00454         <span class="comment">//</span>
00455         <span class="comment">//  Check if the file does not use intermediate buffering.  If it</span>
00456         <span class="comment">//  does not use intermediate buffering then the new position we're</span>
00457         <span class="comment">//  supplied must be aligned properly for the device</span>
00458         <span class="comment">//</span>
00459 
00460         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a153">FO_NO_INTERMEDIATE_BUFFERING</a> ) &amp;&amp;
00461             ((<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CurrentByteOffset.LowPart &amp; IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o17">AlignmentRequirement</a>) != 0)) {
00462 
00463             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00464         }
00465 
00466         <span class="comment">//</span>
00467         <span class="comment">//  The input parameter is fine so set the current byte offset and</span>
00468         <span class="comment">//  complete the request</span>
00469         <span class="comment">//</span>
00470 
00471         <span class="comment">//</span>
00472         <span class="comment">//  Lock the Fcb to provide synchronization.</span>
00473         <span class="comment">//</span>
00474 
00475         <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00476         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o20">CurrentByteOffset</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CurrentByteOffset;
00477         <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00478 
00479         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00480 
00481     } finally {
00482 
00483         <a class="code" href="../../d3/d8/udfprocs_8h.html#a82">UdfReleaseFile</a>( IrpContext, Fcb );
00484     }
00485 
00486     <span class="comment">//</span>
00487     <span class="comment">//  Complete the request if there was no raise.</span>
00488     <span class="comment">//</span>
00489 
00490     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00491     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00492 }
00493 
00494 
00495 BOOLEAN
<a name="l00496"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a137">00496</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a137">UdfFastQueryBasicInfo</a> (
00497     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
00498     IN BOOLEAN Wait,
00499     IN OUT PFILE_BASIC_INFORMATION Buffer,
00500     OUT PIO_STATUS_BLOCK IoStatus,
00501     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
00502     )
00503 
00504 <span class="comment">/*++</span>
00505 <span class="comment"></span>
00506 <span class="comment">Routine Description:</span>
00507 <span class="comment"></span>
00508 <span class="comment">    This routine is for the fast query call for basic file information.</span>
00509 <span class="comment"></span>
00510 <span class="comment">Arguments:</span>
00511 <span class="comment"></span>
00512 <span class="comment">    FileObject - Supplies the file object used in this operation</span>
00513 <span class="comment"></span>
00514 <span class="comment">    Wait - Indicates if we are allowed to wait for the information</span>
00515 <span class="comment"></span>
00516 <span class="comment">    Buffer - Supplies the output buffer to receive the basic information</span>
00517 <span class="comment"></span>
00518 <span class="comment">    IoStatus - Receives the final status of the operation</span>
00519 <span class="comment"></span>
00520 <span class="comment">Return Value:</span>
00521 <span class="comment"></span>
00522 <span class="comment">    BOOLEAN - TRUE if the operation succeeded and FALSE if the caller</span>
00523 <span class="comment">        needs to take the long route.</span>
00524 <span class="comment"></span>
00525 <span class="comment">--*/</span>
00526 
00527 {
00528     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00529     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00530 
00531     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00532     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00533 
00534     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00535 
00536     <a class="code" href="../../d1/d8/udfdata_8h.html#a34">ASSERT_FILE_OBJECT</a>( FileObject );
00537 
00538     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00539 
00540     <span class="comment">//</span>
00541     <span class="comment">//  Decode the file object to find the type of open and the data</span>
00542     <span class="comment">//  structures.</span>
00543     <span class="comment">//</span>
00544 
00545     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( FileObject, &amp;Fcb, &amp;Ccb );
00546 
00547     <span class="comment">//</span>
00548     <span class="comment">//  We only support this request on user file or directory objects.</span>
00549     <span class="comment">//</span>
00550 
00551     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o10">FcbState</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a13">FCB_STATE_INITIALIZED</a> ));
00552     
00553     <span class="keywordflow">if</span> (TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a> &amp;&amp; TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>) {
00554 
00555         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00556         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00557     }
00558 
00559     <span class="comment">//</span>
00560     <span class="comment">//  Acquire the file shared to access the Fcb.</span>
00561     <span class="comment">//</span>
00562 
00563     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( Fcb-&gt;Resource, Wait )) {
00564 
00565         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00566         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00567     }
00568 
00569     <span class="comment">//</span>
00570     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00571     <span class="comment">//</span>
00572 
00573     <span class="keywordflow">try</span> {
00574 
00575         <span class="comment">//</span>
00576         <span class="comment">//  Only deal with 'good' Fcb's.</span>
00577         <span class="comment">//</span>
00578 
00579         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, Fcb )) {
00580 
00581             <span class="comment">//</span>
00582             <span class="comment">//  Fill in the input buffer from the Fcb fields.</span>
00583             <span class="comment">//</span>
00584 
00585             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CreationTime = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o19">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o0">CreationTime</a>;
00586             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;LastWriteTime =
00587             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ChangeTime =  Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o19">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o2">ModificationTime</a>;
00588             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;LastAccessTime = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o19">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o1">AccessTime</a>;
00589 
00590             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileAttributes = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o11">FileAttributes</a> | <a class="code" href="../../d4/d3/fileinfo_8c.html#a2">UdfGetExtraFileAttributes</a>( Ccb );
00591 
00592             <span class="comment">//</span>
00593             <span class="comment">//  Update the IoStatus block with the size of this data.</span>
00594             <span class="comment">//</span>
00595 
00596             IoStatus-&gt;Status = STATUS_SUCCESS;
00597             IoStatus-&gt;Information = <span class="keyword">sizeof</span>( FILE_BASIC_INFORMATION );
00598 
00599             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00600         }
00601 
00602     } finally {
00603 
00604         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( Fcb-&gt;Resource );
00605 
00606         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00607     }
00608 
00609     <span class="keywordflow">return</span> Result;
00610 }
00611 
00612 
00613 BOOLEAN
<a name="l00614"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a141">00614</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a141">UdfFastQueryStdInfo</a> (
00615     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
00616     IN BOOLEAN Wait,
00617     IN OUT PFILE_STANDARD_INFORMATION Buffer,
00618     OUT PIO_STATUS_BLOCK IoStatus,
00619     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
00620     )
00621 
00622 <span class="comment">/*++</span>
00623 <span class="comment"></span>
00624 <span class="comment">Routine Description:</span>
00625 <span class="comment"></span>
00626 <span class="comment">    This routine is for the fast query call for standard file information.</span>
00627 <span class="comment"></span>
00628 <span class="comment">Arguments:</span>
00629 <span class="comment"></span>
00630 <span class="comment">    FileObject - Supplies the file object used in this operation</span>
00631 <span class="comment"></span>
00632 <span class="comment">    Wait - Indicates if we are allowed to wait for the information</span>
00633 <span class="comment"></span>
00634 <span class="comment">    Buffer - Supplies the output buffer to receive the basic information</span>
00635 <span class="comment"></span>
00636 <span class="comment">    IoStatus - Receives the final status of the operation</span>
00637 <span class="comment"></span>
00638 <span class="comment">Return Value:</span>
00639 <span class="comment"></span>
00640 <span class="comment">    BOOLEAN - TRUE if the operation succeeded and FALSE if the caller</span>
00641 <span class="comment">        needs to take the long route.</span>
00642 <span class="comment"></span>
00643 <span class="comment">--*/</span>
00644 
00645 {
00646     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00647     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00648 
00649     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00650 
00651     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00652 
00653     <a class="code" href="../../d1/d8/udfdata_8h.html#a34">ASSERT_FILE_OBJECT</a>( FileObject );
00654 
00655     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00656 
00657     <span class="comment">//</span>
00658     <span class="comment">//  Decode the file object to find the type of open and the data</span>
00659     <span class="comment">//  structures.</span>
00660     <span class="comment">//</span>
00661 
00662     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a175">UdfFastDecodeFileObject</a>( FileObject, &amp;Fcb );
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">//  We only support this request on initialized user file or directory objects.</span>
00666     <span class="comment">//</span>
00667 
00668     <span class="keywordflow">if</span> (TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a> &amp;&amp; TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>) {
00669 
00670         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00671         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00672     }
00673 
00674     <span class="comment">//</span>
00675     <span class="comment">//  Acquire the file shared to access the Fcb.</span>
00676     <span class="comment">//</span>
00677 
00678     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( Fcb-&gt;Resource, Wait )) {
00679 
00680         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00681         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00682     }
00683 
00684     <span class="comment">//</span>
00685     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00686     <span class="comment">//</span>
00687 
00688     <span class="keywordflow">try</span> {
00689 
00690         <span class="comment">//</span>
00691         <span class="comment">//  Only deal with 'good' Fcb's.</span>
00692         <span class="comment">//</span>
00693 
00694         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, Fcb )) {
00695 
00696             <span class="comment">//</span>
00697             <span class="comment">//  Check whether this is a directory.</span>
00698             <span class="comment">//</span>
00699 
00700             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o11">FileAttributes</a>, FILE_ATTRIBUTE_DIRECTORY )) {
00701 
00702                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;AllocationSize.QuadPart =
00703                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EndOfFile.QuadPart = 0;
00704 
00705                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Directory = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00706 
00707             } <span class="keywordflow">else</span> {
00708 
00709                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;AllocationSize.QuadPart = Fcb-&gt;AllocationSize.QuadPart;
00710                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EndOfFile.QuadPart = Fcb-&gt;FileSize.QuadPart;
00711 
00712                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Directory = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00713             }
00714 
00715             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;NumberOfLinks = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o20">LinkCount</a>;
00716             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;DeletePending = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00717 
00718             <span class="comment">//</span>
00719             <span class="comment">//  Update the IoStatus block with the size of this data.</span>
00720             <span class="comment">//</span>
00721 
00722             IoStatus-&gt;Status = STATUS_SUCCESS;
00723             IoStatus-&gt;Information = <span class="keyword">sizeof</span>( FILE_STANDARD_INFORMATION );
00724 
00725             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00726         }
00727 
00728     } finally {
00729 
00730         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( Fcb-&gt;Resource );
00731 
00732         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00733     }
00734 
00735     <span class="keywordflow">return</span> Result;
00736 }
00737 
00738 
00739 BOOLEAN
<a name="l00740"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a140">00740</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a140">UdfFastQueryNetworkInfo</a> (
00741     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
00742     IN BOOLEAN Wait,
00743     OUT PFILE_NETWORK_OPEN_INFORMATION Buffer,
00744     OUT PIO_STATUS_BLOCK IoStatus,
00745     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
00746     )
00747 
00748 <span class="comment">/*++</span>
00749 <span class="comment"></span>
00750 <span class="comment">Routine Description:</span>
00751 <span class="comment"></span>
00752 <span class="comment">    This routine is for the fast query call for network file information.</span>
00753 <span class="comment"></span>
00754 <span class="comment">Arguments:</span>
00755 <span class="comment"></span>
00756 <span class="comment">    FileObject - Supplies the file object used in this operation</span>
00757 <span class="comment"></span>
00758 <span class="comment">    Wait - Indicates if we are allowed to wait for the information</span>
00759 <span class="comment"></span>
00760 <span class="comment">    Buffer - Supplies the output buffer to receive the basic information</span>
00761 <span class="comment"></span>
00762 <span class="comment">    IoStatus - Receives the final status of the operation</span>
00763 <span class="comment"></span>
00764 <span class="comment">Return Value:</span>
00765 <span class="comment"></span>
00766 <span class="comment">    BOOLEAN - TRUE if the operation succeeded and FALSE if the caller</span>
00767 <span class="comment">        needs to take the long route.</span>
00768 <span class="comment"></span>
00769 <span class="comment">--*/</span>
00770 
00771 {
00772     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00773     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00774 
00775     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00776     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00777 
00778     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00779 
00780     <a class="code" href="../../d1/d8/udfdata_8h.html#a34">ASSERT_FILE_OBJECT</a>( FileObject );
00781 
00782     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00783 
00784     <span class="comment">//</span>
00785     <span class="comment">//  Decode the file object to find the type of open and the data</span>
00786     <span class="comment">//  structures.</span>
00787     <span class="comment">//</span>
00788 
00789     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( FileObject, &amp;Fcb, &amp;Ccb );
00790 
00791     <span class="comment">//</span>
00792     <span class="comment">//  We only support this request on user file or directory objects.</span>
00793     <span class="comment">//</span>
00794 
00795     <span class="keywordflow">if</span> (TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a> &amp;&amp; TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>) {
00796 
00797         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00798         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00799     }
00800 
00801     <span class="comment">//</span>
00802     <span class="comment">//  Acquire the file shared to access the Fcb.</span>
00803     <span class="comment">//</span>
00804 
00805     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( Fcb-&gt;Resource, Wait )) {
00806 
00807         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00808         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00809     }
00810 
00811     <span class="comment">//</span>
00812     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00813     <span class="comment">//</span>
00814 
00815     <span class="keywordflow">try</span> {
00816 
00817         <span class="comment">//</span>
00818         <span class="comment">//  Only deal with 'good' Fcb's.</span>
00819         <span class="comment">//</span>
00820 
00821         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, Fcb )) {
00822 
00823             <span class="comment">//</span>
00824             <span class="comment">//  Fill in the input buffer from the Fcb fields.</span>
00825             <span class="comment">//</span>
00826 
00827             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CreationTime = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o19">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o0">CreationTime</a>;
00828             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;LastWriteTime =
00829             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ChangeTime =  Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o19">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o2">ModificationTime</a>;
00830             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;LastAccessTime = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o19">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o1">AccessTime</a>;
00831 
00832             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileAttributes = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o11">FileAttributes</a> | <a class="code" href="../../d4/d3/fileinfo_8c.html#a2">UdfGetExtraFileAttributes</a>( Ccb );
00833 
00834             <span class="comment">//</span>
00835             <span class="comment">//  Check whether this is a directory.</span>
00836             <span class="comment">//</span>
00837 
00838             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o11">FileAttributes</a>, FILE_ATTRIBUTE_DIRECTORY )) {
00839 
00840                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;AllocationSize.QuadPart =
00841                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EndOfFile.QuadPart = 0;
00842 
00843             } <span class="keywordflow">else</span> {
00844 
00845                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;AllocationSize.QuadPart = Fcb-&gt;AllocationSize.QuadPart;
00846                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EndOfFile.QuadPart = Fcb-&gt;FileSize.QuadPart;
00847             }
00848 
00849             <span class="comment">//</span>
00850             <span class="comment">//  Update the IoStatus block with the size of this data.</span>
00851             <span class="comment">//</span>
00852 
00853             IoStatus-&gt;Status = STATUS_SUCCESS;
00854             IoStatus-&gt;Information = <span class="keyword">sizeof</span>( FILE_NETWORK_OPEN_INFORMATION );
00855 
00856             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00857         }
00858 
00859     } finally {
00860 
00861         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( Fcb-&gt;Resource );
00862 
00863         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00864     }
00865 
00866     <span class="keywordflow">return</span> Result;
00867 }
00868 
00869 
00870 <span class="comment">//</span>
00871 <span class="comment">//  Local support routine</span>
00872 <span class="comment">//</span>
00873 
00874 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00875"></a><a class="code" href="../../d4/d3/fileinfo_8c.html#a3">00875</a> <a class="code" href="../../d4/d3/fileinfo_8c.html#a3">UdfQueryBasicInfo</a> (
00876     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00877     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00878     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb,
00879     IN OUT PFILE_BASIC_INFORMATION Buffer,
00880     IN OUT PULONG Length
00881     )
00882 
00883 <span class="comment">/*++</span>
00884 <span class="comment"></span>
00885 <span class="comment"> Description:</span>
00886 <span class="comment"></span>
00887 <span class="comment">    This routine performs the query basic information function for Udfs</span>
00888 <span class="comment"></span>
00889 <span class="comment">Arguments:</span>
00890 <span class="comment"></span>
00891 <span class="comment">    Fcb - Supplies the Fcb being queried, it has been verified</span>
00892 <span class="comment">    </span>
00893 <span class="comment">    Ccb - Supplies the Ccb associated with the fileobject being queried</span>
00894 <span class="comment"></span>
00895 <span class="comment">    Buffer - Supplies a pointer to the buffer where the information is to</span>
00896 <span class="comment">        be returned</span>
00897 <span class="comment"></span>
00898 <span class="comment">    Length - Supplies the length of the buffer in bytes, and receives the</span>
00899 <span class="comment">        remaining bytes free in the buffer upon return.</span>
00900 <span class="comment"></span>
00901 <span class="comment">Return Value:</span>
00902 <span class="comment"></span>
00903 <span class="comment">    None</span>
00904 <span class="comment"></span>
00905 <span class="comment">--*/</span>
00906 
00907 {
00908     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00909 
00910     <span class="comment">//</span>
00911     <span class="comment">//  We support all times on Udfs.</span>
00912     <span class="comment">//</span>
00913 
00914     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CreationTime = Fcb-&gt;Timestamps.CreationTime;
00915     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;LastWriteTime =
00916     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ChangeTime =  Fcb-&gt;Timestamps.ModificationTime;
00917     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;LastAccessTime = Fcb-&gt;Timestamps.AccessTime;
00918 
00919     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileAttributes = Fcb-&gt;FileAttributes | <a class="code" href="../../d4/d3/fileinfo_8c.html#a2">UdfGetExtraFileAttributes</a>( Ccb );
00920 
00921     <span class="comment">//</span>
00922     <span class="comment">//  Update the length and status output variables</span>
00923     <span class="comment">//</span>
00924 
00925     *Length -= <span class="keyword">sizeof</span>( FILE_BASIC_INFORMATION );
00926 
00927     <span class="keywordflow">return</span>;
00928 }
00929 
00930 
00931 <span class="comment">//</span>
00932 <span class="comment">//  Local support routine</span>
00933 <span class="comment">//</span>
00934 
00935 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00936"></a><a class="code" href="../../d4/d3/fileinfo_8c.html#a4">00936</a> <a class="code" href="../../d4/d3/fileinfo_8c.html#a4">UdfQueryStandardInfo</a> (
00937     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00938     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00939     IN OUT PFILE_STANDARD_INFORMATION Buffer,
00940     IN OUT PULONG Length
00941     )
00942 <span class="comment">/*++</span>
00943 <span class="comment"></span>
00944 <span class="comment">Routine Description:</span>
00945 <span class="comment"></span>
00946 <span class="comment">    This routine performs the query standard information function for Udfs.</span>
00947 <span class="comment"></span>
00948 <span class="comment">Arguments:</span>
00949 <span class="comment"></span>
00950 <span class="comment">    Fcb - Supplies the Fcb being queried, it has been verified</span>
00951 <span class="comment"></span>
00952 <span class="comment">    Buffer - Supplies a pointer to the buffer where the information is to</span>
00953 <span class="comment">        be returned</span>
00954 <span class="comment"></span>
00955 <span class="comment">    Length - Supplies the length of the buffer in bytes, and receives the</span>
00956 <span class="comment">        remaining bytes free in the buffer upon return.</span>
00957 <span class="comment"></span>
00958 <span class="comment">Return Value:</span>
00959 <span class="comment"></span>
00960 <span class="comment">    None</span>
00961 <span class="comment"></span>
00962 <span class="comment">--*/</span>
00963 
00964 {
00965     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00966 
00967     <span class="comment">//</span>
00968     <span class="comment">//  Delete is never pending on a readonly file.</span>
00969     <span class="comment">//</span>
00970 
00971     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;NumberOfLinks = Fcb-&gt;LinkCount;
00972     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;DeletePending = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00973 
00974     <span class="comment">//</span>
00975     <span class="comment">//  We get the sizes from the header.  Return a size of zero</span>
00976     <span class="comment">//  for all directories.</span>
00977     <span class="comment">//</span>
00978 
00979     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;FileAttributes, FILE_ATTRIBUTE_DIRECTORY )) {
00980 
00981         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;AllocationSize.QuadPart =
00982         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EndOfFile.QuadPart = 0;
00983 
00984         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Directory = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00985 
00986     } <span class="keywordflow">else</span> {
00987 
00988         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;AllocationSize.QuadPart = Fcb-&gt;AllocationSize.QuadPart;
00989         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EndOfFile.QuadPart = Fcb-&gt;FileSize.QuadPart;
00990 
00991         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Directory = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00992     }
00993 
00994     <span class="comment">//</span>
00995     <span class="comment">//  Update the length and status output variables</span>
00996     <span class="comment">//</span>
00997 
00998     *Length -= <span class="keyword">sizeof</span>( FILE_STANDARD_INFORMATION );
00999 
01000     <span class="keywordflow">return</span>;
01001 }
01002 
01003 
01004 <span class="comment">//</span>
01005 <span class="comment">//  Local support routine</span>
01006 <span class="comment">//</span>
01007 
01008 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01009"></a><a class="code" href="../../d4/d3/fileinfo_8c.html#a5">01009</a> <a class="code" href="../../d4/d3/fileinfo_8c.html#a5">UdfQueryInternalInfo</a> (
01010     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01011     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
01012     IN OUT PFILE_INTERNAL_INFORMATION Buffer,
01013     IN OUT PULONG Length
01014     )
01015 
01016 <span class="comment">/*++</span>
01017 <span class="comment"></span>
01018 <span class="comment">Routine Description:</span>
01019 <span class="comment"></span>
01020 <span class="comment">    This routine performs the query internal information function for Udfs.</span>
01021 <span class="comment"></span>
01022 <span class="comment">Arguments:</span>
01023 <span class="comment"></span>
01024 <span class="comment">    Fcb - Supplies the Fcb being queried, it has been verified</span>
01025 <span class="comment"></span>
01026 <span class="comment">    Buffer - Supplies a pointer to the buffer where the information is to</span>
01027 <span class="comment">        be returned</span>
01028 <span class="comment"></span>
01029 <span class="comment">    Length - Supplies the length of the buffer in bytes, and receives the</span>
01030 <span class="comment">        remaining bytes free in the buffer upon return.</span>
01031 <span class="comment"></span>
01032 <span class="comment">Return Value:</span>
01033 <span class="comment"></span>
01034 <span class="comment">    None</span>
01035 <span class="comment"></span>
01036 <span class="comment">--*/</span>
01037 
01038 {
01039     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01040 
01041     <span class="comment">//</span>
01042     <span class="comment">//  Index number is the file Id number in the Fcb.</span>
01043     <span class="comment">//</span>
01044 
01045     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;IndexNumber = Fcb-&gt;FileId;
01046     *Length -= <span class="keyword">sizeof</span>( FILE_INTERNAL_INFORMATION );
01047 
01048     <span class="keywordflow">return</span>;
01049 }
01050 
01051 
01052 <span class="comment">//</span>
01053 <span class="comment">//  Local support routine</span>
01054 <span class="comment">//</span>
01055 
01056 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01057"></a><a class="code" href="../../d4/d3/fileinfo_8c.html#a6">01057</a> <a class="code" href="../../d4/d3/fileinfo_8c.html#a6">UdfQueryEaInfo</a> (
01058     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01059     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
01060     IN OUT PFILE_EA_INFORMATION Buffer,
01061     IN OUT PULONG Length
01062     )
01063 
01064 <span class="comment">/*++</span>
01065 <span class="comment"></span>
01066 <span class="comment">Routine Description:</span>
01067 <span class="comment"></span>
01068 <span class="comment">    This routine performs the query Ea information function for Udfs.</span>
01069 <span class="comment"></span>
01070 <span class="comment">Arguments:</span>
01071 <span class="comment"></span>
01072 <span class="comment">    Fcb - Supplies the Fcb being queried, it has been verified</span>
01073 <span class="comment"></span>
01074 <span class="comment">    Buffer - Supplies a pointer to the buffer where the information is to</span>
01075 <span class="comment">        be returned</span>
01076 <span class="comment"></span>
01077 <span class="comment">    Length - Supplies the length of the buffer in bytes, and receives the</span>
01078 <span class="comment">        remaining bytes free in the buffer upon return.</span>
01079 <span class="comment"></span>
01080 <span class="comment">Return Value:</span>
01081 <span class="comment"></span>
01082 <span class="comment">    None</span>
01083 <span class="comment"></span>
01084 <span class="comment">--*/</span>
01085 
01086 {
01087     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01088 
01089     <span class="comment">//</span>
01090     <span class="comment">//  No Ea's on Udfs volumes.  At least not that our EA support would understand.</span>
01091     <span class="comment">//</span>
01092 
01093     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EaSize = 0;
01094     *Length -= <span class="keyword">sizeof</span>( FILE_EA_INFORMATION );
01095 
01096     <span class="keywordflow">return</span>;
01097 }
01098 
01099 
01100 <span class="comment">//</span>
01101 <span class="comment">//  Local support routine</span>
01102 <span class="comment">//</span>
01103 
01104 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01105"></a><a class="code" href="../../d4/d3/fileinfo_8c.html#a7">01105</a> <a class="code" href="../../d4/d3/fileinfo_8c.html#a7">UdfQueryPositionInfo</a> (
01106     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01107     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
01108     IN OUT PFILE_POSITION_INFORMATION Buffer,
01109     IN OUT PULONG Length
01110     )
01111 
01112 <span class="comment">/*++</span>
01113 <span class="comment"></span>
01114 <span class="comment">Routine Description:</span>
01115 <span class="comment"></span>
01116 <span class="comment">    This routine performs the query position information function for Udfs.</span>
01117 <span class="comment"></span>
01118 <span class="comment">Arguments:</span>
01119 <span class="comment"></span>
01120 <span class="comment">    FileObject - Supplies the File object being queried</span>
01121 <span class="comment"></span>
01122 <span class="comment">    Buffer - Supplies a pointer to the buffer where the information is to</span>
01123 <span class="comment">        be returned</span>
01124 <span class="comment"></span>
01125 <span class="comment">    Length - Supplies the length of the buffer in bytes, and receives the</span>
01126 <span class="comment">        remaining bytes free in the buffer upon return.</span>
01127 <span class="comment"></span>
01128 <span class="comment">Return Value:</span>
01129 <span class="comment"></span>
01130 <span class="comment">    None</span>
01131 <span class="comment"></span>
01132 <span class="comment">--*/</span>
01133 
01134 {
01135     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01136 
01137     <span class="comment">//</span>
01138     <span class="comment">//  Get the current position found in the file object.</span>
01139     <span class="comment">//</span>
01140 
01141     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CurrentByteOffset = FileObject-&gt;CurrentByteOffset;
01142 
01143     <span class="comment">//</span>
01144     <span class="comment">//  Update the length and status output variables</span>
01145     <span class="comment">//</span>
01146 
01147     *Length -= <span class="keyword">sizeof</span>( FILE_POSITION_INFORMATION );
01148 
01149     <span class="keywordflow">return</span>;
01150 }
01151 
01152 
01153 <span class="comment">//</span>
01154 <span class="comment">//  Local support routine</span>
01155 <span class="comment">//</span>
01156 
01157 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01158"></a><a class="code" href="../../d4/d3/fileinfo_8c.html#a8">01158</a> <a class="code" href="../../d4/d3/fileinfo_8c.html#a8">UdfQueryNameInfo</a> (
01159     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01160     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
01161     IN OUT PFILE_NAME_INFORMATION Buffer,
01162     IN OUT PULONG Length
01163     )
01164 
01165 <span class="comment">/*++</span>
01166 <span class="comment"></span>
01167 <span class="comment">Routine Description:</span>
01168 <span class="comment"></span>
01169 <span class="comment">    This routine performs the query name information function for Udfs.</span>
01170 <span class="comment"></span>
01171 <span class="comment">Arguments:</span>
01172 <span class="comment"></span>
01173 <span class="comment">    FileObject - Supplies the file object containing the name.</span>
01174 <span class="comment"></span>
01175 <span class="comment">    Buffer - Supplies a pointer to the buffer where the information is to</span>
01176 <span class="comment">        be returned</span>
01177 <span class="comment"></span>
01178 <span class="comment">    Length - Supplies the length of the buffer in bytes, and receives the</span>
01179 <span class="comment">        remaining bytes free in the buffer upon return.</span>
01180 <span class="comment"></span>
01181 <span class="comment">Return Value:</span>
01182 <span class="comment"></span>
01183 <span class="comment">    NTSTATUS - STATUS_BUFFER_OVERFLOW if the entire name can't be copied.</span>
01184 <span class="comment"></span>
01185 <span class="comment">--*/</span>
01186 
01187 {
01188     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01189     ULONG LengthToCopy;
01190 
01191     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01192 
01193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*Length &gt;= <span class="keyword">sizeof</span>(ULONG));
01194     
01195     <span class="comment">//</span>
01196     <span class="comment">//  Simply copy the name in the file object to the user's buffer.</span>
01197     <span class="comment">//</span>
01198 
01199     <span class="comment">//</span>
01200     <span class="comment">//  Place the size of the filename in the user's buffer and reduce the remaining</span>
01201     <span class="comment">//  size to match.</span>
01202     <span class="comment">//</span>
01203 
01204     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileNameLength = LengthToCopy = FileObject-&gt;FileName.Length;
01205     *Length -= <span class="keyword">sizeof</span>(ULONG);
01206 
01207     <span class="keywordflow">if</span> (LengthToCopy &gt; *Length) {
01208 
01209         LengthToCopy = *Length;
01210         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_OVERFLOW;
01211     }
01212 
01213     RtlCopyMemory( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileName, FileObject-&gt;FileName.Buffer, LengthToCopy );
01214 
01215     <span class="comment">//</span>
01216     <span class="comment">//  Reduce the available bytes by the amount stored into this buffer.  In the overflow</span>
01217     <span class="comment">//  case, this simply drops to zero.  The returned filenamelength will indicate to the</span>
01218     <span class="comment">//  caller how much space is required.</span>
01219     <span class="comment">//</span>
01220 
01221     *Length -= LengthToCopy;
01222 
01223     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01224 }
01225 
01226 
01227 <span class="comment">//</span>
01228 <span class="comment">//  Local support routine</span>
01229 <span class="comment">//</span>
01230 
01231 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01232"></a><a class="code" href="../../d4/d3/fileinfo_8c.html#a9">01232</a> <a class="code" href="../../d4/d3/fileinfo_8c.html#a9">UdfQueryAlternateNameInfo</a> (
01233     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01234     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
01235     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb,
01236     IN OUT PFILE_NAME_INFORMATION Buffer,
01237     IN OUT PULONG Length
01238     )
01239 
01240 <span class="comment">/*++</span>
01241 <span class="comment"></span>
01242 <span class="comment">Routine Description:</span>
01243 <span class="comment"></span>
01244 <span class="comment">    This routine performs the query alternate name information function.</span>
01245 <span class="comment">    We lookup the dirent for this file and then check if there is a</span>
01246 <span class="comment">    short name.</span>
01247 <span class="comment"></span>
01248 <span class="comment">Arguments:</span>
01249 <span class="comment"></span>
01250 <span class="comment">    Fcb - Supplies the Fcb being queried, it has been verified.</span>
01251 <span class="comment"></span>
01252 <span class="comment">    Ccb - Ccb for this open handle.</span>
01253 <span class="comment"></span>
01254 <span class="comment">    Buffer - Supplies a pointer to the buffer where the information is to</span>
01255 <span class="comment">        be returned.</span>
01256 <span class="comment"></span>
01257 <span class="comment">    Length - Supplies the length of the buffer in bytes, and receives the</span>
01258 <span class="comment">        remaining bytes free in the buffer upon return.</span>
01259 <span class="comment"></span>
01260 <span class="comment">Return Value:</span>
01261 <span class="comment"></span>
01262 <span class="comment">    NTSTATUS - STATUS_SUCCESS if the whole name would fit into the user buffer,</span>
01263 <span class="comment">               STATUS_OBJECT_NAME_NOT_FOUND if we can't return the name,</span>
01264 <span class="comment">               STATUS_BUFFER_OVERFLOW otherwise.</span>
01265 <span class="comment"></span>
01266 <span class="comment">--*/</span>
01267 
01268 {
01269     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01270 
01271     <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">DIR_ENUM_CONTEXT</a> DirContext;
01272 
01273     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb;
01274     
01275     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> ParentFcb;
01276     BOOLEAN ReleaseParentFcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01277 
01278     BOOLEAN CleanupDirContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01279     BOOLEAN Result;
01280 
01281     PUNICODE_STRING ShortName;
01282 
01283     UNICODE_STRING LocalShortName;
01284     WCHAR LocalShortNameBuffer[ <a class="code" href="../../d9/d7/udf_8h.html#a11">BYTE_COUNT_8_DOT_3</a> / <span class="keyword">sizeof</span>(WCHAR) ];
01285     
01286     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01287 
01288     <span class="comment">//</span>
01289     <span class="comment">//  Initialize the buffer length to zero.</span>
01290     <span class="comment">//</span>
01291 
01292     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileNameLength = 0;
01293 
01294     <span class="comment">//</span>
01295     <span class="comment">//  If there was no associated Lcb then there is no short name.</span>
01296     <span class="comment">//</span>
01297 
01298     Lcb = Ccb-&gt;Lcb;
01299     
01300     <span class="keywordflow">if</span> (Lcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01301 
01302         <span class="keywordflow">return</span> STATUS_OBJECT_NAME_NOT_FOUND;
01303     }
01304 
01305     <span class="comment">//</span>
01306     <span class="comment">//  Use a try-finally to cleanup the structures.</span>
01307     <span class="comment">//</span>
01308 
01309     <span class="keywordflow">try</span> {
01310 
01311         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o13">Flags</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a10">LCB_FLAG_SHORT_NAME</a> )) {
01312 
01313             <span class="comment">//</span>
01314             <span class="comment">//  This caller opened the file by a generated short name, so simply hand it back.</span>
01315             <span class="comment">//</span>
01316 
01317             ShortName = &amp;Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o16">FileName</a>;
01318         
01319         } <span class="keywordflow">else</span> {
01320 
01321             <span class="comment">//</span>
01322             <span class="comment">//  The open occured by a regular name.  Now, if this name is already 8.3 legal then</span>
01323             <span class="comment">//  there is no short name.</span>
01324             <span class="comment">//</span>
01325 
01326             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a178">UdfIs8dot3Name</a>( IrpContext, Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o16">FileName</a> )) {
01327 
01328                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND );
01329             }
01330 
01331             <span class="comment">//</span>
01332             <span class="comment">//  This name has a generated short name.  In order to calculate this name we have to</span>
01333             <span class="comment">//  retrieve the FID for this file, since UDF specifies that a short name is uniquified</span>
01334             <span class="comment">//  with a CRC of the original in-FID byte representation of the filename.</span>
01335             <span class="comment">//</span>
01336             <span class="comment">//  N.B.: if this is a common operation, we may wish to cache the CRC in the Lcb.</span>
01337             <span class="comment">//</span>
01338 
01339             ParentFcb = Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o9">ParentFcb</a>;
01340             <a class="code" href="../../d3/d8/udfprocs_8h.html#a80">UdfAcquireFileShared</a>( IrpContext, ParentFcb );
01341             ReleaseParentFcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01342 
01343             <span class="comment">//</span>
01344             <span class="comment">//  Now go find the FID for this filename in the parent.</span>
01345             <span class="comment">//</span>
01346 
01347             <a class="code" href="../../d3/d8/udfprocs_8h.html#a167">UdfInitializeDirContext</a>( IrpContext, &amp;DirContext );
01348             CleanupDirContext = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01349 
01350             Result = <a class="code" href="../../d3/d8/udfprocs_8h.html#a172">UdfFindDirEntry</a>( IrpContext,
01351                                       ParentFcb,
01352                                       &amp;Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o16">FileName</a>,
01353                                       <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o13">Flags</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a9">LCB_FLAG_IGNORE_CASE</a> ),
01354                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01355                                       &amp;DirContext );
01356             
01357             <span class="comment">//</span>
01358             <span class="comment">//  We should always be able to find this entry, but don't bugcheck because</span>
01359             <span class="comment">//  we screwed this up.</span>
01360             <span class="comment">//</span>
01361             
01362             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Result );
01363             
01364             <span class="keywordflow">if</span> (!Result) {
01365                 
01366                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND );
01367             }
01368 
01369             <span class="comment">//</span>
01370             <span class="comment">//  Build the local unicode string to use and fill it in.</span>
01371             <span class="comment">//</span>
01372 
01373             ShortName = &amp;LocalShortName;
01374 
01375             LocalShortName.Buffer = LocalShortNameBuffer;
01376             LocalShortName.Length = 0;
01377             LocalShortName.MaximumLength = <span class="keyword">sizeof</span>( LocalShortNameBuffer );
01378 
01379             <a class="code" href="../../d3/d8/udfprocs_8h.html#a180">UdfGenerate8dot3Name</a>( IrpContext,
01380                                   &amp;DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o9">CaseObjectName</a>,
01381                                   ShortName );
01382         }
01383         
01384         <span class="comment">//</span>
01385         <span class="comment">//  We now have the short name.  We have left it in Unicode form so copy it directly.</span>
01386         <span class="comment">//</span>
01387 
01388         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileNameLength = ShortName-&gt;Length;
01389 
01390         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileNameLength + <span class="keyword">sizeof</span>( ULONG ) &gt; *Length) {
01391 
01392             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileNameLength = *Length - <span class="keyword">sizeof</span>( ULONG );
01393             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_OVERFLOW;
01394         }
01395 
01396         RtlCopyMemory( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileName, ShortName-&gt;Buffer, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileNameLength );
01397 
01398     } finally {
01399 
01400         <span class="keywordflow">if</span> (CleanupDirContext) {
01401 
01402             <a class="code" href="../../d3/d8/udfprocs_8h.html#a168">UdfCleanupDirContext</a>( IrpContext, &amp;DirContext );
01403         }
01404 
01405         <span class="keywordflow">if</span> (ReleaseParentFcb) {
01406 
01407             <a class="code" href="../../d3/d8/udfprocs_8h.html#a82">UdfReleaseFile</a>( IrpContext, ParentFcb );
01408         }
01409     }
01410 
01411     <span class="comment">//</span>
01412     <span class="comment">//  Reduce the available bytes by the amount stored into this buffer.</span>
01413     <span class="comment">//</span>
01414 
01415     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_OBJECT_NAME_NOT_FOUND) {
01416 
01417         *Length -= <span class="keyword">sizeof</span>( ULONG ) + <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileNameLength;
01418     }
01419 
01420     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01421 }
01422 
01423 
01424 <span class="comment">//</span>
01425 <span class="comment">//  Local support routine</span>
01426 <span class="comment">//</span>
01427 
01428 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01429"></a><a class="code" href="../../d4/d3/fileinfo_8c.html#a10">01429</a> <a class="code" href="../../d4/d3/fileinfo_8c.html#a10">UdfQueryNetworkInfo</a> (
01430     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01431     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
01432     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb,
01433     IN OUT PFILE_NETWORK_OPEN_INFORMATION Buffer,
01434     IN OUT PULONG Length
01435     )
01436 
01437 <span class="comment">/*++</span>
01438 <span class="comment"></span>
01439 <span class="comment"> Description:</span>
01440 <span class="comment"></span>
01441 <span class="comment">    This routine performs the query network open information function for Udfs.</span>
01442 <span class="comment"></span>
01443 <span class="comment">Arguments:</span>
01444 <span class="comment"></span>
01445 <span class="comment">    Fcb - Supplies the Fcb being queried, it has been verified</span>
01446 <span class="comment"></span>
01447 <span class="comment">    Buffer - Supplies a pointer to the buffer where the information is to</span>
01448 <span class="comment">        be returned</span>
01449 <span class="comment"></span>
01450 <span class="comment">    Length - Supplies the length of the buffer in bytes, and receives the</span>
01451 <span class="comment">        remaining bytes free in the buffer upon return.</span>
01452 <span class="comment"></span>
01453 <span class="comment">Return Value:</span>
01454 <span class="comment"></span>
01455 <span class="comment">    None</span>
01456 <span class="comment"></span>
01457 <span class="comment">--*/</span>
01458 
01459 {
01460     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01461 
01462     <span class="comment">//</span>
01463     <span class="comment">//  We support all times on Udfs.</span>
01464     <span class="comment">//</span>
01465 
01466     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CreationTime = Fcb-&gt;Timestamps.CreationTime;
01467     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;LastWriteTime =
01468     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ChangeTime =  Fcb-&gt;Timestamps.ModificationTime;
01469     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;LastAccessTime = Fcb-&gt;Timestamps.AccessTime;
01470 
01471     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileAttributes = Fcb-&gt;FileAttributes | <a class="code" href="../../d4/d3/fileinfo_8c.html#a2">UdfGetExtraFileAttributes</a>( Ccb );
01472 
01473     <span class="comment">//</span>
01474     <span class="comment">//  We get the sizes from the header.  Return a size of zero</span>
01475     <span class="comment">//  for all directories.</span>
01476     <span class="comment">//</span>
01477 
01478     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;FileAttributes, FILE_ATTRIBUTE_DIRECTORY )) {
01479 
01480         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;AllocationSize.QuadPart =
01481         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EndOfFile.QuadPart = 0;
01482 
01483     } <span class="keywordflow">else</span> {
01484 
01485         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;AllocationSize.QuadPart = Fcb-&gt;AllocationSize.QuadPart;
01486         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EndOfFile.QuadPart = Fcb-&gt;FileSize.QuadPart;
01487     }
01488 
01489     <span class="comment">//</span>
01490     <span class="comment">//  Update the length and status output variables</span>
01491     <span class="comment">//</span>
01492 
01493     *Length -= <span class="keyword">sizeof</span>( FILE_NETWORK_OPEN_INFORMATION );
01494 
01495     <span class="keywordflow">return</span>;
01496 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:00 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
