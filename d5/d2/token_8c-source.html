<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: token.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>token.c</h1><a href="../../d4/d3/token_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    token.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">   This module implements the initialization, open, duplicate and other</span>
00012 <span class="comment">   services of the executive token object.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Jim Kelly (JimK) 5-April-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">    v15: robertre</span>
00025 <span class="comment">         updated ACL_REVISION</span>
00026 <span class="comment"></span>
00027 <span class="comment">--*/</span>
00028 
00029 
00030 <span class="preprocessor">#include "<a class="code" href="../../d6/d6/sep_8h.html">sep.h</a>"</span>
00031 <span class="preprocessor">#include "sertlp.h"</span>
00032 <span class="preprocessor">#include &lt;zwapi.h&gt;</span>
00033 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/tokenp_8h.html">tokenp.h</a>"</span>
00034 
00035 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,SepTokenInitialization)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,SeMakeSystemToken)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,SeMakeAnonymousToken)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeTokenType)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeTokenIsAdmin)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepCreateToken)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeTokenImpersonationLevel)</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeAssignPrimaryToken)</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeDeassignPrimaryToken)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeExchangePrimaryToken)</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeGetTokenControlInformation)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeSubProcessToken)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtCreateToken)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepTokenDeleteMethod)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepIdAssignableAsOwner)</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeIsChildToken)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeIsChildTokenByPointer)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtImpersonateAnonymousToken)</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00055 <span class="preprocessor"></span>
00056 
00058 <span class="comment">//                                                                    //</span>
00059 <span class="comment">//           Global Variables                                         //</span>
00060 <span class="comment">//                                                                    //</span>
00062 <span class="comment"></span>
00063 <span class="comment">//</span>
00064 <span class="comment">// Generic mapping of access types</span>
00065 <span class="comment">//</span>
00066 
<a name="l00067"></a><a class="code" href="../../d4/d3/token_8c.html#a0">00067</a> GENERIC_MAPPING <a class="code" href="../../d4/d3/token_8c.html#a0">SepTokenMapping</a> = { TOKEN_READ,
00068                                     TOKEN_WRITE,
00069                                     TOKEN_EXECUTE,
00070                                     TOKEN_ALL_ACCESS
00071                                   };
00072 
00073 <span class="comment">//</span>
00074 <span class="comment">// Address of token object type descriptor.</span>
00075 <span class="comment">//</span>
00076 
<a name="l00077"></a><a class="code" href="../../d4/d3/token_8c.html#a1">00077</a> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>;
00078 
00079 
00080 <span class="comment">//</span>
00081 <span class="comment">// Used to track whether or not a system token has been created or not.</span>
00082 <span class="comment">//</span>
00083 
00084 <span class="preprocessor">#if DBG</span>
00085 <span class="preprocessor"></span>BOOLEAN SystemTokenCreated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00086 <span class="preprocessor">#endif //DBG</span>
00087 <span class="preprocessor"></span>
00088 
00089 <span class="comment">//</span>
00090 <span class="comment">// Token lock</span>
00091 <span class="comment">//</span>
00092 
<a name="l00093"></a><a class="code" href="../../d4/d3/token_8c.html#a2">00093</a> <a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>    <a class="code" href="../../d4/d3/token_8c.html#a2">SepTokenLock</a>;
00094 
00095 
00096 
00097 
00098 <span class="comment">//</span>
00099 <span class="comment">// Used to control the active token diagnostic support provided</span>
00100 <span class="comment">//</span>
00101 
00102 <span class="preprocessor">#ifdef    TOKEN_DIAGNOSTICS_ENABLED</span>
00103 <span class="preprocessor"></span>ULONG TokenGlobalFlag = 0;
00104 <span class="preprocessor">#endif // TOKEN_DIAGNOSTICS_ENABLED</span>
00105 <span class="preprocessor"></span>
00106 
00107 
00109 <span class="comment">//                                                                    //</span>
00110 <span class="comment">//           Token Object Routines &amp; Methods                          //</span>
00111 <span class="comment">//                                                                    //</span>
00113 <span class="comment"></span>
00114 
00115 
00116 
00117 TOKEN_TYPE
<a name="l00118"></a><a class="code" href="../../d4/d3/token_8c.html#a3">00118</a> <a class="code" href="../../d4/d3/token_8c.html#a3">SeTokenType</a>(
00119     IN PACCESS_TOKEN Token
00120     )
00121 
00122 <span class="comment">/*++</span>
00123 <span class="comment"></span>
00124 <span class="comment">Routine Description:</span>
00125 <span class="comment"></span>
00126 <span class="comment">    This function returns the type of an instance of a token (TokenPrimary,</span>
00127 <span class="comment">    or TokenImpersonation).</span>
00128 <span class="comment"></span>
00129 <span class="comment"></span>
00130 <span class="comment">Arguments:</span>
00131 <span class="comment"></span>
00132 <span class="comment">    Token - Points to the token whose type is to be returned.</span>
00133 <span class="comment"></span>
00134 <span class="comment">Return Value:</span>
00135 <span class="comment"></span>
00136 <span class="comment">    The token's type.</span>
00137 <span class="comment"></span>
00138 <span class="comment">--*/</span>
00139 
00140 {
00141     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00142 
00143     <span class="keywordflow">return</span> (((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;TokenType);
00144 }
00145 
00146 
00147 
00148 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
00149 BOOLEAN
<a name="l00150"></a><a class="code" href="../../d4/d3/token_8c.html#a4">00150</a> <a class="code" href="../../d4/d3/token_8c.html#a4">SeTokenIsAdmin</a>(
00151     IN PACCESS_TOKEN Token
00152     )
00153 
00154 <span class="comment">/*++</span>
00155 <span class="comment"></span>
00156 <span class="comment">Routine Description:</span>
00157 <span class="comment"></span>
00158 <span class="comment">    Returns if the token is a member of the local admin group.</span>
00159 <span class="comment"></span>
00160 <span class="comment">Arguments:</span>
00161 <span class="comment"></span>
00162 <span class="comment">    Token - Points to the token.</span>
00163 <span class="comment"></span>
00164 <span class="comment">Return Value:</span>
00165 <span class="comment"></span>
00166 <span class="comment">    TRUE - Token contains the local admin group</span>
00167 <span class="comment">    FALSE - no admin.</span>
00168 <span class="comment"></span>
00169 <span class="comment">--*/</span>
00170 
00171 {
00172     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00173 
00174     <span class="keywordflow">return</span> ((((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;TokenFlags &amp; <a class="code" href="../../d0/d5/se_8h.html#a4">TOKEN_HAS_ADMIN_GROUP</a>) != 0 );
00175 }
00176 
00177 
00178 
00179 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
00180 BOOLEAN
<a name="l00181"></a><a class="code" href="../../d4/d3/token_8c.html#a5">00181</a> <a class="code" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a>(
00182     IN PACCESS_TOKEN Token
00183     )
00184 
00185 <span class="comment">/*++</span>
00186 <span class="comment"></span>
00187 <span class="comment">Routine Description:</span>
00188 <span class="comment"></span>
00189 <span class="comment">    Returns if the token is a restricted token.</span>
00190 <span class="comment"></span>
00191 <span class="comment">Arguments:</span>
00192 <span class="comment"></span>
00193 <span class="comment">    Token - Points to the token.</span>
00194 <span class="comment"></span>
00195 <span class="comment">Return Value:</span>
00196 <span class="comment"></span>
00197 <span class="comment">    TRUE - Token contains restricted sids</span>
00198 <span class="comment">    FALSE - no admin.</span>
00199 <span class="comment"></span>
00200 <span class="comment">--*/</span>
00201 
00202 {
00203     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00204 
00205     <span class="keywordflow">return</span> ((((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;TokenFlags &amp; <a class="code" href="../../d0/d5/se_8h.html#a5">TOKEN_IS_RESTRICTED</a>) != 0 );
00206 }
00207 
00208 
00209 
00210 SECURITY_IMPERSONATION_LEVEL
<a name="l00211"></a><a class="code" href="../../d4/d3/token_8c.html#a6">00211</a> <a class="code" href="../../d4/d3/token_8c.html#a6">SeTokenImpersonationLevel</a>(
00212     IN PACCESS_TOKEN Token
00213     )
00214 
00215 <span class="comment">/*++</span>
00216 <span class="comment"></span>
00217 <span class="comment">Routine Description:</span>
00218 <span class="comment"></span>
00219 <span class="comment">    This function returns the impersonation level of a token.  The token</span>
00220 <span class="comment">    is assumed to be a TokenImpersonation type token.</span>
00221 <span class="comment"></span>
00222 <span class="comment"></span>
00223 <span class="comment">Arguments:</span>
00224 <span class="comment"></span>
00225 <span class="comment">    Token - Points to the token whose impersonation level is to be returned.</span>
00226 <span class="comment"></span>
00227 <span class="comment">Return Value:</span>
00228 <span class="comment"></span>
00229 <span class="comment">    The token's impersonation level.</span>
00230 <span class="comment"></span>
00231 <span class="comment">--*/</span>
00232 
00233 {
00234     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00235 
00236     <span class="keywordflow">return</span> ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;ImpersonationLevel;
00237 }
00238 
00239 
00240 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00241"></a><a class="code" href="../../d4/d3/token_8c.html#a7">00241</a> <a class="code" href="../../d4/d3/token_8c.html#a7">SeAssignPrimaryToken</a>(
00242     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00243     IN PACCESS_TOKEN Token
00244     )
00245 
00246 
00247 <span class="comment">/*++</span>
00248 <span class="comment"></span>
00249 <span class="comment">Routine Description:</span>
00250 <span class="comment"></span>
00251 <span class="comment">    This function establishes a primary token for a process.</span>
00252 <span class="comment"></span>
00253 <span class="comment">Arguments:</span>
00254 <span class="comment"></span>
00255 <span class="comment">    Token - Points to the new primary token.</span>
00256 <span class="comment"></span>
00257 <span class="comment">Return Value:</span>
00258 <span class="comment"></span>
00259 <span class="comment">    None.</span>
00260 <span class="comment"></span>
00261 <span class="comment">--*/</span>
00262 
00263 {
00264 
00265     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00266         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00267 
00268     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>
00269         NewToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00270 
00271     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00272 
00273     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NewToken-&gt;TokenType == TokenPrimary);
00274     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !NewToken-&gt;TokenInUse );
00275 
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">// Dereference the old token if there is one.</span>
00279     <span class="comment">//</span>
00280     <span class="comment">// Processes typically already have a token that must be</span>
00281     <span class="comment">// dereferenced.  There are two cases where this may not</span>
00282     <span class="comment">// be the situation.  First, during phase 0 system initialization,</span>
00283     <span class="comment">// the initial system process starts out without a token.  Second,</span>
00284     <span class="comment">// if an error occurs during process creation, we may be cleaning</span>
00285     <span class="comment">// up a process that hasn't yet had a primary token assigned.</span>
00286     <span class="comment">//</span>
00287 
00288     <span class="keywordflow">if</span> (Process-&gt;Token != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00289         <a class="code" href="../../d4/d3/token_8c.html#a8">SeDeassignPrimaryToken</a>( Process );
00290     }
00291 
00292 
00293     Process-&gt;Token=<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00294     NewToken-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00295     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(NewToken);
00296     <span class="keywordflow">return</span>;
00297 }
00298 
00299 
00300 
00301 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00302"></a><a class="code" href="../../d4/d3/token_8c.html#a8">00302</a> <a class="code" href="../../d4/d3/token_8c.html#a8">SeDeassignPrimaryToken</a>(
00303     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00304     )
00305 
00306 
00307 <span class="comment">/*++</span>
00308 <span class="comment"></span>
00309 <span class="comment">Routine Description:</span>
00310 <span class="comment"></span>
00311 <span class="comment">    This function causes a process reference to a token to be</span>
00312 <span class="comment">    dropped.</span>
00313 <span class="comment"></span>
00314 <span class="comment">Arguments:</span>
00315 <span class="comment"></span>
00316 <span class="comment">    Process - Points to the process whose primary token is no longer needed.</span>
00317 <span class="comment">        This is probably only the case at process deletion or when</span>
00318 <span class="comment">        a primary token is being replaced.</span>
00319 <span class="comment"></span>
00320 <span class="comment">Return Value:</span>
00321 <span class="comment"></span>
00322 <span class="comment">    None.</span>
00323 <span class="comment"></span>
00324 <span class="comment">--*/</span>
00325 
00326 {
00327 
00328     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>
00329         OldToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)(Process-&gt;Token);
00330 
00331     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00332 
00333     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OldToken-&gt;TokenType == TokenPrimary);
00334     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OldToken-&gt;TokenInUse);
00335 
00336     OldToken-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00337     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( OldToken );
00338 
00339 
00340     <span class="keywordflow">return</span>;
00341 }
00342 
00343 
00344 
00345 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00346"></a><a class="code" href="../../d4/d3/token_8c.html#a9">00346</a> <a class="code" href="../../d4/d3/token_8c.html#a9">SeExchangePrimaryToken</a>(
00347     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00348     IN PACCESS_TOKEN NewAccessToken,
00349     OUT PACCESS_TOKEN *OldAccessToken
00350     )
00351 
00352 
00353 <span class="comment">/*++</span>
00354 <span class="comment"></span>
00355 <span class="comment">Routine Description:</span>
00356 <span class="comment"></span>
00357 <span class="comment">    This function is used to perform the portions of changing a primary</span>
00358 <span class="comment">    token that reference the internals of token structures.</span>
00359 <span class="comment"></span>
00360 <span class="comment">    The new token is checked to make sure it is not already in use.</span>
00361 <span class="comment"></span>
00362 <span class="comment">    The</span>
00363 <span class="comment"></span>
00364 <span class="comment"></span>
00365 <span class="comment">    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
00366 <span class="comment">    !!!!!!!!       WARNING     WARNING     WARNING        !!!!!!!!</span>
00367 <span class="comment">    !!!!!!!!                                              !!!!!!!!</span>
00368 <span class="comment">    !!!!!!!!  THIS ROUTINE MUST BE CALLED WITH THE GOBAL  !!!!!!!!</span>
00369 <span class="comment">    !!!!!!!!  PROCESS SECURITY FIELDS LOCK HELD           !!!!!!!!</span>
00370 <span class="comment">    !!!!!!!!                                              !!!!!!!!</span>
00371 <span class="comment">    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
00372 <span class="comment"></span>
00373 <span class="comment">Arguments:</span>
00374 <span class="comment"></span>
00375 <span class="comment">    Process - Points to the process whose primary token is being exchanged.</span>
00376 <span class="comment"></span>
00377 <span class="comment">    NewAccessToken - Points to the process's new primary token.</span>
00378 <span class="comment"></span>
00379 <span class="comment">    OldAccessToken - Receives a pointer to the process's current token.</span>
00380 <span class="comment">        The caller is responsible for dereferencing this token when</span>
00381 <span class="comment">        it is no longer needed.  This can't be done while the process</span>
00382 <span class="comment">        security locks are held.</span>
00383 <span class="comment"></span>
00384 <span class="comment"></span>
00385 <span class="comment">Return Value:</span>
00386 <span class="comment"></span>
00387 <span class="comment">    STATUS_SUCCESS - Everything has been updated.</span>
00388 <span class="comment"></span>
00389 <span class="comment">    STATUS_TOKEN_ALREADY_IN_USE - A primary token can only be used by a</span>
00390 <span class="comment">        single process.  That is, each process must have its own primary</span>
00391 <span class="comment">        token.  The token passed to  be assigned as the primary token is</span>
00392 <span class="comment">        already in use as a primary token.</span>
00393 <span class="comment"></span>
00394 <span class="comment">    STATUS_BAD_TOKEN_TYPE - The new token is not a primary token.</span>
00395 <span class="comment"></span>
00396 <span class="comment"></span>
00397 <span class="comment">--*/</span>
00398 
00399 {
00400     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00401         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00402 
00403     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>
00404         OldToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)(Process-&gt;Token);
00405 
00406     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>
00407         NewToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)NewAccessToken;
00408 
00409     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00410 
00411 
00412     <span class="comment">//</span>
00413     <span class="comment">// We need to access the security fields of both tokens.</span>
00414     <span class="comment">// Access to these fields is guarded by the global Process Security</span>
00415     <span class="comment">// fields lock.</span>
00416     <span class="comment">//</span>
00417 
00418     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OldToken-&gt;TokenType == TokenPrimary);
00419     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OldToken-&gt;TokenInUse);
00420 
00421 
00422     <span class="comment">//</span>
00423     <span class="comment">// Make sure the new token is a primary token...</span>
00424     <span class="comment">//</span>
00425 
00426     <span class="keywordflow">if</span> ( NewToken-&gt;TokenType != TokenPrimary ) {
00427         <span class="keywordflow">return</span>(STATUS_BAD_TOKEN_TYPE);
00428     }
00429 
00430     <span class="comment">//</span>
00431     <span class="comment">// and that it is not already in use...</span>
00432     <span class="comment">//</span>
00433 
00434     <span class="keywordflow">if</span> (NewToken-&gt;TokenInUse) {
00435         <span class="keywordflow">return</span>(STATUS_TOKEN_ALREADY_IN_USE);
00436     }
00437 
00438     <span class="comment">//</span>
00439     <span class="comment">// Ensure SessionId consistent for hydra</span>
00440     <span class="comment">//</span>
00441 
00442     NewToken-&gt;SessionId = OldToken-&gt;SessionId ;
00443 
00444 
00445 
00446     <span class="comment">//</span>
00447     <span class="comment">// Switch the tokens</span>
00448     <span class="comment">//</span>
00449 
00450     Process-&gt;Token=NewAccessToken;
00451     NewToken-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00452     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(NewToken);
00453 
00454     <span class="comment">//</span>
00455     <span class="comment">// Mark the token as "NOT USED"</span>
00456     <span class="comment">//</span>
00457 
00458     OldToken-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">// Return the pointer to the old token.  The caller</span>
00462     <span class="comment">// is responsible for dereferencing it if they don't need it.</span>
00463     <span class="comment">//</span>
00464 
00465     (*OldAccessToken) = OldToken;
00466 
00467     <span class="keywordflow">return</span> (STATUS_SUCCESS);
00468 }
00469 
00470 
00471 
00472 
00473 
00474 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00475"></a><a class="code" href="../../d4/d3/token_8c.html#a10">00475</a> <a class="code" href="../../d4/d3/token_8c.html#a10">SeGetTokenControlInformation</a> (
00476     IN PACCESS_TOKEN Token,
00477     OUT PTOKEN_CONTROL TokenControl
00478     )
00479 
00480 <span class="comment">/*++</span>
00481 <span class="comment"></span>
00482 <span class="comment">Routine Description:</span>
00483 <span class="comment"></span>
00484 <span class="comment">    This routine is provided for communication session layers, or</span>
00485 <span class="comment">    any other executive component that needs to keep track of</span>
00486 <span class="comment">    whether a caller's security context has changed between calls.</span>
00487 <span class="comment">    Communication session layers will need to check this, for some</span>
00488 <span class="comment">    security quality of service modes, to determine whether or not</span>
00489 <span class="comment">    a server's security context needs to be updated to reflect</span>
00490 <span class="comment">    changes in the client's security context.</span>
00491 <span class="comment"></span>
00492 <span class="comment">    This routine will also be useful to communications subsystems</span>
00493 <span class="comment">    that need to retrieve client' authentication information from</span>
00494 <span class="comment">    the local security authority in order to perform a remote</span>
00495 <span class="comment">    authentication.</span>
00496 <span class="comment"></span>
00497 <span class="comment"></span>
00498 <span class="comment">Parameters:</span>
00499 <span class="comment"></span>
00500 <span class="comment">    Token - Points to the token whose information is to be retrieved.</span>
00501 <span class="comment"></span>
00502 <span class="comment">    TokenControl - Points to the buffer to receive the token control</span>
00503 <span class="comment">        information.</span>
00504 <span class="comment"></span>
00505 <span class="comment">Return Value:</span>
00506 <span class="comment"></span>
00507 <span class="comment">    None.</span>
00508 <span class="comment"></span>
00509 <span class="comment">--*/</span>
00510 
00511 {
00512     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00513 
00514     <span class="comment">//</span>
00515     <span class="comment">//  acquire exclusive access to the token</span>
00516     <span class="comment">//</span>
00517 
00518     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00519 
00520     <span class="comment">//</span>
00521     <span class="comment">//  Grab the data  and  run</span>
00522     <span class="comment">//</span>
00523 
00524     TokenControl-&gt;TokenId = ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;TokenId;
00525     TokenControl-&gt;AuthenticationId = ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;AuthenticationId;
00526     TokenControl-&gt;ModifiedId = ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;ModifiedId;
00527     TokenControl-&gt;TokenSource = ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;TokenSource;
00528 
00529     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00530 
00531     <span class="keywordflow">return</span>;
00532 
00533 }
00534 
00535 PACCESS_TOKEN
<a name="l00536"></a><a class="code" href="../../d4/d3/token_8c.html#a11">00536</a> <a class="code" href="../../d0/d5/se_8h.html#a153">SeMakeSystemToken</a> ()
00537 
00538 <span class="comment">/*++</span>
00539 <span class="comment"></span>
00540 <span class="comment">Routine Description:</span>
00541 <span class="comment"></span>
00542 <span class="comment">    This routine is provided for use by executive components</span>
00543 <span class="comment">    DURING SYSTEM INITIALIZATION ONLY.  It creates a token for</span>
00544 <span class="comment">    use by system components.</span>
00545 <span class="comment"></span>
00546 <span class="comment">    A system token has the following characteristics:</span>
00547 <span class="comment"></span>
00548 <span class="comment">         - It has LOCAL_SYSTEM as its user ID</span>
00549 <span class="comment"></span>
00550 <span class="comment">         - It has the following groups with the corresponding</span>
00551 <span class="comment">           attributes:</span>
00552 <span class="comment"></span>
00553 <span class="comment">               ADMINS_ALIAS      EnabledByDefault |</span>
00554 <span class="comment">                                 Enabled          |</span>
00555 <span class="comment">                                 Owner</span>
00556 <span class="comment"></span>
00557 <span class="comment">               WORLD             EnabledByDefault |</span>
00558 <span class="comment">                                 Enabled          |</span>
00559 <span class="comment">                                 Mandatory</span>
00560 <span class="comment"></span>
00561 <span class="comment">               ADMINISTRATORS (alias)  Owner   (disabled)</span>
00562 <span class="comment"></span>
00563 <span class="comment">               AUTHENTICATED_USER</span>
00564 <span class="comment">                                EnabledByDefault  |</span>
00565 <span class="comment">                                Enabled           |</span>
00566 <span class="comment">                                Mandatory</span>
00567 <span class="comment"></span>
00568 <span class="comment"></span>
00569 <span class="comment">         - It has LOCAL_SYSTEM as its primary group.</span>
00570 <span class="comment"></span>
00571 <span class="comment">         - It has the privileges shown in comments below.</span>
00572 <span class="comment"></span>
00573 <span class="comment"></span>
00574 <span class="comment">         - It has protection that provides TOKEN_ALL_ACCESS to</span>
00575 <span class="comment">           the LOCAL_SYSTEM ID.</span>
00576 <span class="comment"></span>
00577 <span class="comment"></span>
00578 <span class="comment">         - It has a default ACL that grants GENERIC_ALL access</span>
00579 <span class="comment">           to LOCAL_SYSTEM and GENERIC_EXECUTE to WORLD.</span>
00580 <span class="comment"></span>
00581 <span class="comment"></span>
00582 <span class="comment">Parameters:</span>
00583 <span class="comment"></span>
00584 <span class="comment">    None.</span>
00585 <span class="comment"></span>
00586 <span class="comment">Return Value:</span>
00587 <span class="comment"></span>
00588 <span class="comment">    Pointer to a system token.</span>
00589 <span class="comment"></span>
00590 <span class="comment">--*/</span>
00591 
00592 {
00593     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00594 
00595     PVOID <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00596 
00597     SID_AND_ATTRIBUTES UserId;
00598     TOKEN_PRIMARY_GROUP PrimaryGroup;
00599     PSID_AND_ATTRIBUTES GroupIds;
00600     ULONG GroupIdsLength;
00601     LUID_AND_ATTRIBUTES Privileges[30];
00602     PACL TokenAcl;
00603     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
00604     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00605     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00606     ULONG Length;
00607     OBJECT_ATTRIBUTES TokenObjectAttributes;
00608     PSECURITY_DESCRIPTOR TokenSecurityDescriptor;
00609     ULONG BufferLength;
00610     PVOID <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00611 
00612     ULONG_PTR GroupIdsBuffer[128 * <span class="keyword">sizeof</span>(ULONG) / <span class="keyword">sizeof</span>(ULONG_PTR)];
00613 
00614     TIME_FIELDS <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>;
00615     LARGE_INTEGER <a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>;
00616 
00617     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00618 
00619 
00620     <span class="comment">//</span>
00621     <span class="comment">// Make sure only one system token gets created.</span>
00622     <span class="comment">//</span>
00623 
00624 <span class="preprocessor">#if DBG</span>
00625 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !SystemTokenCreated );
00626     SystemTokenCreated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00627 <span class="preprocessor">#endif //DBG</span>
00628 <span class="preprocessor"></span>
00629 
00630     <span class="comment">//</span>
00631     <span class="comment">// Set up expiration times</span>
00632     <span class="comment">//</span>
00633 
00634     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Year = 3000;
00635     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Month = 1;
00636     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Day = 1;
00637     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Hour = 1;
00638     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Minute = 1;
00639     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Second = 1;
00640     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Milliseconds = 1;
00641     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Weekday = 1;
00642 
00643     <a class="code" href="../../d1/d2/time_8c.html#a28">RtlTimeFieldsToTime</a>( &amp;<a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>, &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a> );
00644 
00645 
00646 <span class="comment">//    //</span>
00647 <span class="comment">//    //  The amount of memory used in the following is gross overkill, but</span>
00648 <span class="comment">//    //  it is freed up immediately after creating the token.</span>
00649 <span class="comment">//    //</span>
00650 <span class="comment">//</span>
00651 <span class="comment">//    GroupIds = (PSID_AND_ATTRIBUTES)ExAllocatePool( NonPagedPool, 512 );</span>
00652 
00653     GroupIds = (PSID_AND_ATTRIBUTES)GroupIdsBuffer;
00654 
00655 
00656     <span class="comment">//</span>
00657     <span class="comment">// Set up the attributes to be assigned to groups</span>
00658     <span class="comment">//</span>
00659 
00660     <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a> =    (SE_GROUP_MANDATORY          |
00661                                 SE_GROUP_ENABLED_BY_DEFAULT |
00662                                 SE_GROUP_ENABLED
00663                                 );
00664 
00665     <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>  =    (SE_GROUP_ENABLED_BY_DEFAULT |
00666                                 SE_GROUP_ENABLED            |
00667                                 SE_GROUP_OWNER
00668                                 );
00669 
00670     <span class="comment">//</span>
00671     <span class="comment">// Set up the user ID</span>
00672     <span class="comment">//</span>
00673 
00674     UserId.Sid = <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a>;
00675     UserId.Attributes = 0;
00676 
00677     <span class="comment">//</span>
00678     <span class="comment">// Set up the groups</span>
00679     <span class="comment">//</span>
00680 
00681 
00682     GroupIds-&gt;Sid  = <a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a>;
00683     (GroupIds+1)-&gt;Sid  = <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a>;
00684     (GroupIds+2)-&gt;Sid  = <a class="code" href="../../d0/d5/se_8h.html#a55">SeAuthenticatedUsersSid</a>;
00685 
00686     GroupIds-&gt;Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00687     (GroupIds+1)-&gt;Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00688     (GroupIds+2)-&gt;Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00689 
00690     GroupIdsLength = (ULONG)LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(GroupIds-&gt;Sid)) +
00691                      (ULONG)LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>((GroupIds+1)-&gt;Sid)) +
00692                      (ULONG)LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>((GroupIds+2)-&gt;Sid)) +
00693                      <span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES);
00694 
00695     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( GroupIdsLength &lt;= 128 * <span class="keyword">sizeof</span>(ULONG) );
00696 
00697 
00698     <span class="comment">//</span>
00699     <span class="comment">// Privileges</span>
00700     <span class="comment">//</span>
00701 
00702     <span class="comment">//</span>
00703     <span class="comment">// The privileges in the system token are as follows:</span>
00704     <span class="comment">//</span>
00705     <span class="comment">//    Privilege Name                           Attributes</span>
00706     <span class="comment">//    --------------                           ----------</span>
00707     <span class="comment">//</span>
00708     <span class="comment">// SeTcbPrivilege                        enabled/enabled by default</span>
00709     <span class="comment">// SeCreateTokenPrivilege                DISabled/NOT enabled by default</span>
00710     <span class="comment">// SeTakeOwnershipPrivilege              DISabled/NOT enabled by default</span>
00711     <span class="comment">// SeCreatePagefilePrivilege             enabled/enabled by default</span>
00712     <span class="comment">// SeLockMemoryPrivilege                 enabled/enabled by default</span>
00713     <span class="comment">// SeAssignPrimaryTokenPrivilege         DISabled/NOT enabled by default</span>
00714     <span class="comment">// SeIncreaseQuotaPrivilege              DISabled/NOT enabled by default</span>
00715     <span class="comment">// SeIncreaseBasePriorityPrivilege       enabled/enabled by default</span>
00716     <span class="comment">// SeCreatePermanentPrivilege            enabled/enabled by default</span>
00717     <span class="comment">// SeDebugPrivilege                      enabled/enabled by default</span>
00718     <span class="comment">// SeAuditPrivilege                      enabled/enabled by default</span>
00719     <span class="comment">// SeSecurityPrivilege                   DISabled/NOT enabled by default</span>
00720     <span class="comment">// SeSystemEnvironmentPrivilege          DISabled/NOT enabled by default</span>
00721     <span class="comment">// SeChangeNotifyPrivilege               enabled/enabled by default</span>
00722     <span class="comment">// SeBackupPrivilege                     DISabled/NOT enabled by default</span>
00723     <span class="comment">// SeRestorePrivilege                    DISabled/NOT enabled by default</span>
00724     <span class="comment">// SeShutdownPrivilege                   DISabled/NOT enabled by default</span>
00725     <span class="comment">// SeLoadDriverPrivilege                 DISabled/NOT enabled by default</span>
00726     <span class="comment">// SeProfileSingleProcessPrivilege       enabled/enabled by default</span>
00727     <span class="comment">// SeSystemtimePrivilege                 DISabled/NOT enabled by default</span>
00728     <span class="comment">// SeUndockPrivilege                     DISabled/NOT enabled by default</span>
00729     <span class="comment">//</span>
00730     <span class="comment">// The following privileges are not present, and should never be present in</span>
00731     <span class="comment">// the local system token:</span>
00732     <span class="comment">//</span>
00733     <span class="comment">// SeRemoteShutdownPrivilege             no one can come in as local system</span>
00734     <span class="comment">// SeSyncAgentPrivilege                  only users specified by the admin can</span>
00735     <span class="comment">//                                       be sync agents</span>
00736     <span class="comment">// SeEnableDelegationPrivilege           only users specified by the admin can</span>
00737     <span class="comment">//                                       enable delegation on accounts.</span>
00738     <span class="comment">//</span>
00739 
00740     Privileges[0].Luid = <a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a>;
00741     Privileges[0].Attributes =
00742         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00743          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00744 
00745     Privileges[1].Luid = <a class="code" href="../../d0/d5/se_8h.html#a79">SeCreateTokenPrivilege</a>;
00746     Privileges[1].Attributes = 0;     <span class="comment">// Only the LSA should enable this.</span>
00747 
00748     Privileges[2].Luid = <a class="code" href="../../d0/d5/se_8h.html#a86">SeTakeOwnershipPrivilege</a>;
00749     Privileges[2].Attributes = 0;
00750 
00751     Privileges[3].Luid = <a class="code" href="../../d0/d5/se_8h.html#a88">SeCreatePagefilePrivilege</a>;
00752     Privileges[3].Attributes =
00753         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00754          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00755 
00756     Privileges[4].Luid = <a class="code" href="../../d0/d5/se_8h.html#a81">SeLockMemoryPrivilege</a>;
00757     Privileges[4].Attributes =
00758         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00759          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00760 
00761     Privileges[5].Luid = <a class="code" href="../../d0/d5/se_8h.html#a80">SeAssignPrimaryTokenPrivilege</a>;
00762     Privileges[5].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00763 
00764     Privileges[6].Luid = <a class="code" href="../../d0/d5/se_8h.html#a82">SeIncreaseQuotaPrivilege</a>;
00765     Privileges[6].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00766 
00767     Privileges[7].Luid = <a class="code" href="../../d0/d5/se_8h.html#a89">SeIncreaseBasePriorityPrivilege</a>;
00768     Privileges[7].Attributes =
00769         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00770          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00771 
00772     Privileges[8].Luid = <a class="code" href="../../d0/d5/se_8h.html#a93">SeCreatePermanentPrivilege</a>;
00773     Privileges[8].Attributes =
00774         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00775          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00776 
00777     Privileges[9].Luid = <a class="code" href="../../d0/d5/se_8h.html#a97">SeDebugPrivilege</a>;
00778     Privileges[9].Attributes =
00779         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |   <span class="comment">// Enabled by default</span>
00780          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00781 
00782     Privileges[10].Luid = <a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a>;
00783     Privileges[10].Attributes =
00784         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00785          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00786 
00787     Privileges[11].Luid = <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a>;
00788     Privileges[11].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00789 
00790     Privileges[12].Luid = <a class="code" href="../../d0/d5/se_8h.html#a99">SeSystemEnvironmentPrivilege</a>;
00791     Privileges[12].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00792 
00793     Privileges[13].Luid = <a class="code" href="../../d0/d5/se_8h.html#a100">SeChangeNotifyPrivilege</a>;
00794     Privileges[13].Attributes =
00795         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00796          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00797 
00798 
00799     Privileges[14].Luid = <a class="code" href="../../d0/d5/se_8h.html#a94">SeBackupPrivilege</a>;
00800     Privileges[14].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00801 
00802     Privileges[15].Luid = <a class="code" href="../../d0/d5/se_8h.html#a95">SeRestorePrivilege</a>;
00803     Privileges[15].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00804 
00805     Privileges[16].Luid = <a class="code" href="../../d0/d5/se_8h.html#a96">SeShutdownPrivilege</a>;
00806     Privileges[16].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00807 
00808     Privileges[17].Luid = <a class="code" href="../../d0/d5/se_8h.html#a87">SeLoadDriverPrivilege</a>;
00809     Privileges[17].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00810 
00811     Privileges[18].Luid = <a class="code" href="../../d0/d5/se_8h.html#a92">SeProfileSingleProcessPrivilege</a>;
00812     Privileges[18].Attributes =
00813         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00814          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00815 
00816     Privileges[19].Luid = <a class="code" href="../../d0/d5/se_8h.html#a91">SeSystemtimePrivilege</a>;
00817     Privileges[19].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00818 
00819     Privileges[20].Luid = <a class="code" href="../../d0/d5/se_8h.html#a102">SeUndockPrivilege</a> ;
00820     Privileges[20].Attributes = 0 ;   <span class="comment">// disabled, not enabled by default</span>
00821 
00822     <span class="comment">//BEFORE ADDING ANOTHER PRIVILEGE ^^ HERE ^^ CHECK THE ARRAY BOUND</span>
00823     <span class="comment">//ALSO INCREMENT THE PRIVILEGE COUNT IN THE SepCreateToken() call</span>
00824 
00825 
00826     <span class="comment">//</span>
00827     <span class="comment">// Establish the primary group and default owner</span>
00828     <span class="comment">//</span>
00829 
00830     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a>;  <span class="comment">// Primary group</span>
00831     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = <a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a>;                      <span class="comment">// Default owner</span>
00832 
00833 
00834 
00835 
00836 
00837     <span class="comment">//</span>
00838     <span class="comment">// Set up an ACL to protect token as well ...</span>
00839     <span class="comment">// give system full reign of terror.  This includes user-mode components</span>
00840     <span class="comment">// running as part of the system.</span>
00841     <span class="comment">//</span>
00842 
00843     Length = (ULONG)<span class="keyword">sizeof</span>(ACL) +
00844              ((ULONG)<span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE) - <span class="keyword">sizeof</span>(ULONG)) +
00845              <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a> ) ;
00846 
00847     TokenAcl = (PACL)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, Length, 'cAeS');
00848 
00849     <span class="keywordflow">if</span> ( TokenAcl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00850 
00851         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00852     }
00853 
00854     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( TokenAcl, Length, ACL_REVISION2);
00855     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00856 
00857     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
00858                  TokenAcl,
00859                  ACL_REVISION2,
00860                  TOKEN_ALL_ACCESS,
00861                  <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a>
00862                  );
00863     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00864 
00865     TokenSecurityDescriptor =
00866     (PSECURITY_DESCRIPTOR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00867                               <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00868                               <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR),
00869                               'dSeS'
00870                               );
00871 
00872     <span class="keywordflow">if</span> ( TokenSecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00873 
00874         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TokenAcl );
00875 
00876         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00877     }
00878 
00879     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(
00880                  TokenSecurityDescriptor,
00881                  SECURITY_DESCRIPTOR_REVISION
00882                  );
00883     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00884 
00885     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a> (
00886                  TokenSecurityDescriptor,
00887                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00888                  TokenAcl,
00889                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00890                  );
00891     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00892 
00893 
00894     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a64">RtlSetOwnerSecurityDescriptor</a> (
00895                  TokenSecurityDescriptor,
00896                  <a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a>,
00897                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="comment">// Owner defaulted</span>
00898                  );
00899     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00900 
00901     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a66">RtlSetGroupSecurityDescriptor</a> (
00902                  TokenSecurityDescriptor,
00903                  <a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a>,
00904                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="comment">// Group defaulted</span>
00905                  );
00906     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00907 
00908 
00909     <span class="comment">//</span>
00910     <span class="comment">// Create the system token</span>
00911     <span class="comment">//</span>
00912 
00913 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
00914 <span class="preprocessor"></span>
00915 <span class="comment">//</span>
00916 <span class="comment">// Debug</span>
00917     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n Creating system token...\n"</span>);
00918 <span class="comment">// Debug</span>
00919 <span class="comment">//</span>
00921 <span class="comment"></span><span class="preprocessor">#endif //TOKEN_DEBUG</span>
00922 <span class="preprocessor"></span>
00923     InitializeObjectAttributes(
00924         &amp;TokenObjectAttributes,
00925         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00926         0,
00927         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00928         TokenSecurityDescriptor
00929         );
00930 
00931 
00932 
00933     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d0/d5/se_8h.html#a77">SeSystemDefaultDacl</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00934     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a17">SepCreateToken</a>(
00935                  (PHANDLE)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00936                  <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00937                  0,               <span class="comment">// No handle created for system token</span>
00938                  &amp;TokenObjectAttributes,
00939                  TokenPrimary,
00940                  (SECURITY_IMPERSONATION_LEVEL)0,
00941                  &amp;<a class="code" href="../../d0/d5/se_8h.html#a38">SeSystemAuthenticationId</a>,
00942                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,
00943                  &amp;UserId,
00944                  3,                         <span class="comment">// GroupCount</span>
00945                  GroupIds,
00946                  GroupIdsLength,
00947                  21,                        <span class="comment">// privileges</span>
00948                  Privileges,
00949                  <span class="keyword">sizeof</span>(Privileges),
00950                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,
00951                  PrimaryGroup.PrimaryGroup,
00952                  <a class="code" href="../../d0/d5/se_8h.html#a77">SeSystemDefaultDacl</a>,
00953                  &amp;<a class="code" href="../../d0/d5/se_8h.html#a40">SeSystemTokenSource</a>,
00954                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                        <span class="comment">// System token</span>
00955                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00956                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00957                  );
00958 
00959      <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00960 
00961     <span class="comment">//</span>
00962     <span class="comment">// Assign the security descriptor here, since we don't do it</span>
00963     <span class="comment">// in SepCreateToken for the System Token.</span>
00964     <span class="comment">//</span>
00965 
00966     BufferLength = Length +
00967                    <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE) +
00968                    2 * <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(<a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a>);
00969 
00970     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> =  (PSECURITY_DESCRIPTOR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00971                                                            BufferLength,
00972                                                            'dSeS'
00973                                                            );
00974 
00975     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> ) {
00976 
00977         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  <a class="code" href="../../d7/d1/rtlassig_8c.html#a4">RtlAbsoluteToSelfRelativeSD</a>( TokenSecurityDescriptor,
00978                                                <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00979                                                &amp;BufferLength
00980                                                );
00981         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00982 
00983         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  <a class="code" href="../../d9/d1/obse_8c.html#a7">ObAssignObjectSecurityDescriptor</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00984                                                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00985                                                     <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>
00986                                                     );
00987         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00988 
00989     } <span class="keywordflow">else</span> {
00990 
00991         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00992 
00993         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00994 
00995     }
00996 
00997     <span class="comment">//</span>
00998     <span class="comment">// We can free the old one now.</span>
00999     <span class="comment">//</span>
01000 
01001     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TokenAcl );
01002     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TokenSecurityDescriptor );
01003 
01004     <span class="keywordflow">return</span>  (PACCESS_TOKEN)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
01005 
01006 }
01007 
01008 
01009 PACCESS_TOKEN
<a name="l01010"></a><a class="code" href="../../d4/d3/token_8c.html#a12">01010</a> <a class="code" href="../../d0/d5/se_8h.html#a154">SeMakeAnonymousLogonToken</a> (
01011     VOID
01012     )
01013 
01014 <span class="comment">/*++</span>
01015 <span class="comment"></span>
01016 <span class="comment">Routine Description:</span>
01017 <span class="comment"></span>
01018 <span class="comment">    This routine is provided for use by executive components</span>
01019 <span class="comment">    DURING SYSTEM INITIALIZATION ONLY.  It creates a token for</span>
01020 <span class="comment">    use by system components.</span>
01021 <span class="comment"></span>
01022 <span class="comment">    A system token has the following characteristics:</span>
01023 <span class="comment"></span>
01024 <span class="comment">         - It has ANONYMOUS_LOGON as its user ID</span>
01025 <span class="comment"></span>
01026 <span class="comment">         - It has the following groups with the corresponding</span>
01027 <span class="comment">           attributes:</span>
01028 <span class="comment"></span>
01029 <span class="comment"></span>
01030 <span class="comment">               WORLD             EnabledByDefault |</span>
01031 <span class="comment">                                 Enabled          |</span>
01032 <span class="comment">                                 Mandatory</span>
01033 <span class="comment"></span>
01034 <span class="comment"></span>
01035 <span class="comment">         - It has WORLD as its primary group.</span>
01036 <span class="comment"></span>
01037 <span class="comment">         - It has no privileges/</span>
01038 <span class="comment"></span>
01039 <span class="comment"></span>
01040 <span class="comment">         - It has protection that provides TOKEN_ALL_ACCESS to</span>
01041 <span class="comment">           the WORLD ID.</span>
01042 <span class="comment"></span>
01043 <span class="comment"></span>
01044 <span class="comment">         - It has a default ACL that grants GENERIC_ALL access</span>
01045 <span class="comment">           to WORLD.</span>
01046 <span class="comment"></span>
01047 <span class="comment"></span>
01048 <span class="comment">Parameters:</span>
01049 <span class="comment"></span>
01050 <span class="comment">    None.</span>
01051 <span class="comment"></span>
01052 <span class="comment">Return Value:</span>
01053 <span class="comment"></span>
01054 <span class="comment">    Pointer to a system token.</span>
01055 <span class="comment"></span>
01056 <span class="comment">--*/</span>
01057 
01058 {
01059     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01060 
01061     PVOID <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
01062 
01063     SID_AND_ATTRIBUTES UserId;
01064     PSID_AND_ATTRIBUTES GroupIds;
01065     TOKEN_PRIMARY_GROUP PrimaryGroup;
01066     ULONG GroupIdsLength;
01067     PACL TokenAcl;
01068     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
01069     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
01070     ULONG Length;
01071     OBJECT_ATTRIBUTES TokenObjectAttributes;
01072     PSECURITY_DESCRIPTOR TokenSecurityDescriptor;
01073     ULONG BufferLength;
01074     PVOID <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01075 
01076     ULONG_PTR GroupIdsBuffer[128 * <span class="keyword">sizeof</span>(ULONG) / <span class="keyword">sizeof</span>(ULONG_PTR)];
01077 
01078     TIME_FIELDS <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>;
01079     LARGE_INTEGER <a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>;
01080 
01081     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01082 
01083 
01084 
01085     <span class="comment">//</span>
01086     <span class="comment">// Set up expiration times</span>
01087     <span class="comment">//</span>
01088 
01089     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Year = 3000;
01090     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Month = 1;
01091     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Day = 1;
01092     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Hour = 1;
01093     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Minute = 1;
01094     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Second = 1;
01095     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Milliseconds = 1;
01096     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Weekday = 1;
01097 
01098     <a class="code" href="../../d1/d2/time_8c.html#a28">RtlTimeFieldsToTime</a>( &amp;<a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>, &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a> );
01099 
01100 
01101 
01102     GroupIds = (PSID_AND_ATTRIBUTES)GroupIdsBuffer;
01103 
01104 
01105     <span class="comment">//</span>
01106     <span class="comment">// Set up the attributes to be assigned to groups</span>
01107     <span class="comment">//</span>
01108 
01109     <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a> =    (SE_GROUP_MANDATORY          |
01110                                 SE_GROUP_ENABLED_BY_DEFAULT |
01111                                 SE_GROUP_ENABLED
01112                                 );
01113 
01114 
01115     <span class="comment">//</span>
01116     <span class="comment">// Set up the user ID</span>
01117     <span class="comment">//</span>
01118 
01119     UserId.Sid = <a class="code" href="../../d0/d5/se_8h.html#a58">SeAnonymousLogonSid</a>;
01120     UserId.Attributes = 0;
01121 
01122     <span class="comment">//</span>
01123     <span class="comment">// Set up the groups</span>
01124     <span class="comment">//</span>
01125 
01126 
01127     GroupIds-&gt;Sid  = <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a>;
01128     GroupIds-&gt;Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
01129 
01130 
01131     GroupIdsLength = (ULONG)LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(GroupIds-&gt;Sid)) +
01132                                                     <span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES);
01133 
01134     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( GroupIdsLength &lt;= 128 * <span class="keyword">sizeof</span>(ULONG) );
01135 
01136 
01137     <span class="comment">//</span>
01138     <span class="comment">// Privileges</span>
01139     <span class="comment">//</span>
01140 
01141 
01142     <span class="comment">//</span>
01143     <span class="comment">// Establish the primary group and default owner</span>
01144     <span class="comment">//</span>
01145 
01146     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d0/d5/se_8h.html#a58">SeAnonymousLogonSid</a>;  <span class="comment">// Primary group</span>
01147 
01148 
01149 
01150 
01151 
01152     <span class="comment">//</span>
01153     <span class="comment">// Set up an ACL to protect token as well ...</span>
01154     <span class="comment">// give system full reign of terror.  This includes user-mode components</span>
01155     <span class="comment">// running as part of the system.</span>
01156     <span class="comment">//</span>
01157 
01158     Length = (ULONG)<span class="keyword">sizeof</span>(ACL) +
01159              (ULONG)<span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE) +
01160              <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a> ) +
01161              8; <span class="comment">// The 8 is just for good measure</span>
01162     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Length &lt; 200 );
01163 
01164     TokenAcl = (PACL)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 200, 'cAeS');
01165 
01166     <span class="keywordflow">if</span> ( !TokenAcl ) {
01167 
01168         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01169     }
01170 
01171     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( TokenAcl, Length, ACL_REVISION2);
01172     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01173 
01174     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
01175                  TokenAcl,
01176                  ACL_REVISION2,
01177                  TOKEN_ALL_ACCESS,
01178                  <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a>
01179                  );
01180     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01181 
01182     TokenSecurityDescriptor =
01183     (PSECURITY_DESCRIPTOR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
01184                               <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01185                               SECURITY_DESCRIPTOR_MIN_LENGTH,
01186                               'dSeS'
01187                               );
01188 
01189     <span class="keywordflow">if</span> ( !TokenSecurityDescriptor ) {
01190 
01191         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TokenAcl );
01192 
01193         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01194     }
01195 
01196 
01197     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(
01198                  TokenSecurityDescriptor,
01199                  SECURITY_DESCRIPTOR_REVISION
01200                  );
01201     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01202 
01203     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a> (
01204                  TokenSecurityDescriptor,
01205                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01206                  TokenAcl,
01207                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01208                  );
01209     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01210 
01211 
01212     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a64">RtlSetOwnerSecurityDescriptor</a> (
01213                  TokenSecurityDescriptor,
01214                  <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a>,
01215                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="comment">// Owner defaulted</span>
01216                  );
01217     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01218 
01219     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a66">RtlSetGroupSecurityDescriptor</a> (
01220                  TokenSecurityDescriptor,
01221                  <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a>,
01222                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="comment">// Group defaulted</span>
01223                  );
01224     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01225 
01226 
01227     <span class="comment">//</span>
01228     <span class="comment">// Create the system token</span>
01229     <span class="comment">//</span>
01230 
01231 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01232 <span class="preprocessor"></span>
01233 <span class="comment">//</span>
01234 <span class="comment">// Debug</span>
01235     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n Creating system token...\n"</span>);
01236 <span class="comment">// Debug</span>
01237 <span class="comment">//</span>
01239 <span class="comment"></span><span class="preprocessor">#endif //TOKEN_DEBUG</span>
01240 <span class="preprocessor"></span>
01241     InitializeObjectAttributes(
01242         &amp;TokenObjectAttributes,
01243         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01244         0,
01245         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01246         TokenSecurityDescriptor
01247         );
01248 
01249 
01250 
01251     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a17">SepCreateToken</a>(
01252                  (PHANDLE)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
01253                  <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01254                  0,               <span class="comment">// No handle created for system token</span>
01255                  &amp;TokenObjectAttributes,
01256                  TokenPrimary,
01257                  (SECURITY_IMPERSONATION_LEVEL)0,
01258                  &amp;<a class="code" href="../../d0/d5/se_8h.html#a39">SeAnonymousAuthenticationId</a>,
01259                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,
01260                  &amp;UserId,
01261                  1,                         <span class="comment">// GroupCount</span>
01262                  GroupIds,
01263                  GroupIdsLength,
01264                  0,                         <span class="comment">// no privileges</span>
01265                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                      <span class="comment">// no Privileges,</span>
01266                  0,                         <span class="comment">// no privileges</span>
01267                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01268                  PrimaryGroup.PrimaryGroup,
01269                  TokenAcl,
01270                  &amp;<a class="code" href="../../d0/d5/se_8h.html#a40">SeSystemTokenSource</a>,
01271                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                        <span class="comment">// System token</span>
01272                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01273                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01274                  );
01275 
01276      <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01277 
01278     <span class="comment">//</span>
01279     <span class="comment">// Assign the security descriptor here, since we don't do it</span>
01280     <span class="comment">// in SepCreateToken for the System Token.</span>
01281     <span class="comment">//</span>
01282 
01283     BufferLength = Length +
01284                    <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR) +
01285                    2 * <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(<a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a>);
01286 
01287     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> =  (PSECURITY_DESCRIPTOR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01288                                                            BufferLength,
01289                                                            'dSeS'
01290                                                            );
01291 
01292     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> ) {
01293 
01294         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  <a class="code" href="../../d7/d1/rtlassig_8c.html#a4">RtlAbsoluteToSelfRelativeSD</a>( TokenSecurityDescriptor,
01295                                                <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01296                                                &amp;BufferLength
01297                                                );
01298         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01299 
01300         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  <a class="code" href="../../d9/d1/obse_8c.html#a7">ObAssignObjectSecurityDescriptor</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
01301                                                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01302                                                     <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>
01303                                                     );
01304         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01305 
01306     } <span class="keywordflow">else</span> {
01307 
01308         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
01309 
01310         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01311     }
01312 
01313 
01314     <span class="comment">//</span>
01315     <span class="comment">// We can free the old one now.</span>
01316     <span class="comment">//</span>
01317 
01318     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TokenAcl );
01319     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TokenSecurityDescriptor );
01320 
01321     <span class="keywordflow">return</span>  (PACCESS_TOKEN)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
01322 
01323 }
01324 
01325 
01326 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01327"></a><a class="code" href="../../d4/d3/token_8c.html#a13">01327</a> <a class="code" href="../../d4/d3/token_8c.html#a13">SeSubProcessToken</a> (
01328     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ParentProcess,
01329     OUT PACCESS_TOKEN *ChildToken
01330     )
01331 
01332 <span class="comment">/*++</span>
01333 <span class="comment"></span>
01334 <span class="comment">Routine Description:</span>
01335 <span class="comment"></span>
01336 <span class="comment">    This routine makes a token for a sub-process that is a duplicate</span>
01337 <span class="comment">    of the parent process's token.</span>
01338 <span class="comment"></span>
01339 <span class="comment"></span>
01340 <span class="comment"></span>
01341 <span class="comment">Parameters:</span>
01342 <span class="comment"></span>
01343 <span class="comment">    ParentProcess - Pointer to the parent process object.  This is used</span>
01344 <span class="comment">        to locate the parent process's primary token, and for logging</span>
01345 <span class="comment">        purposes.</span>
01346 <span class="comment"></span>
01347 <span class="comment">    ChildToken - Receives a pointer to the child process's token.</span>
01348 <span class="comment"></span>
01349 <span class="comment">Return Value:</span>
01350 <span class="comment"></span>
01351 <span class="comment">    STATUS_SUCCESS - Indicates the sub-process's token has been created</span>
01352 <span class="comment">        successfully.</span>
01353 <span class="comment"></span>
01354 <span class="comment">    Other status values may be returned from memory allocation or object</span>
01355 <span class="comment">    creation services used and typically indicate insufficient resources</span>
01356 <span class="comment">    or quota on the requestor's part.</span>
01357 <span class="comment"></span>
01358 <span class="comment"></span>
01359 <span class="comment"></span>
01360 <span class="comment">--*/</span>
01361 
01362 {
01363 
01364     <span class="comment">//</span>
01365     <span class="comment">//  NOTE:  THIS ROUTINE CAN BE MADE MUCH MORE EFFICIENT.</span>
01366     <span class="comment">//         IT IS DONE IN A BRUTE FORCE FASHION FOR THE LARGE_INTEGER</span>
01367     <span class="comment">//         BEING TO GET THINGS UP AND RUNNING.</span>
01368     <span class="comment">//</span>
01369     <span class="comment">//         THE PERFORMANCE OF THIS ROUTINE DIRECTLY IMPACTS</span>
01370     <span class="comment">//         THE PERFORMANCE OF SUB-PROCESS CREATION.</span>
01371     <span class="comment">//</span>
01372 
01373 
01374     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01375     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> ParentToken;
01376     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> NewToken;
01377     HANDLE NewTokenHandle;
01378     OBJECT_ATTRIBUTES <a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>;
01379 
01380     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> InsertedToken;
01381 
01382     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01383     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> IgnoreStatus;
01384 
01385     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01386 
01387     PreviousMode = KeGetPreviousMode();
01388 
01389     InitializeObjectAttributes(
01390         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>,
01391         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01392         0,
01393         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01394         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01395         );
01396 
01397 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01398 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\nCreating sub-process token...\n"</span>);
01399     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Parent token address = 0x%lx\n"</span>, ParentProcess-&gt;Token);
01400 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01401 <span class="preprocessor"></span>
01402     ParentToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>( ParentProcess );
01403 
01404     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a27">SepDuplicateToken</a>(
01405                 ParentToken,                         <span class="comment">// ExistingToken</span>
01406                 &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>,             <span class="comment">// ObjectAttributes</span>
01407                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                               <span class="comment">// EffectiveOnly</span>
01408                 TokenPrimary,                        <span class="comment">// TokenType</span>
01409                 (SECURITY_IMPERSONATION_LEVEL)0,     <span class="comment">// ImpersonationLevel</span>
01410                 <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,                          <span class="comment">// RequestorMode</span>
01411                 &amp;NewToken                            <span class="comment">// NewToken</span>
01412                 );
01413 
01414     <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>( (PACCESS_TOKEN)ParentToken );
01415 
01416     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01417 
01418         <span class="comment">//</span>
01419         <span class="comment">// Insert the new token object, up its ref count, and then</span>
01420         <span class="comment">// delete the new handle.</span>
01421         <span class="comment">//</span>
01422 
01423         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(
01424                      NewToken,
01425                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01426                      0,
01427                      1,             <span class="comment">// ObjectPointerBias</span>
01428                      (PVOID *)&amp;InsertedToken,
01429                      &amp;NewTokenHandle
01430                      );
01431 
01432         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01433 
01434             *ChildToken = InsertedToken;
01435             InsertedToken-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01436             IgnoreStatus = ZwClose( NewTokenHandle );
01437 
01438             <span class="comment">//</span>
01439             <span class="comment">// At this point, either the token has a reference</span>
01440             <span class="comment">// outstanding (and no handles), or the reference</span>
01441             <span class="comment">// failed.  If the reference failed, the status will</span>
01442             <span class="comment">// be returned indicating why.</span>
01443             <span class="comment">//</span>
01444 
01445         } <span class="keywordflow">else</span> {
01446 
01447             <span class="comment">//</span>
01448             <span class="comment">// ObInsertObject dereferences the passed object if it</span>
01449             <span class="comment">// fails, so we don't have to do any cleanup on NewToken</span>
01450             <span class="comment">// here.</span>
01451             <span class="comment">//</span>
01452         }
01453     }
01454 
01455     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01456 }
01457 
01458 
01459 BOOLEAN
<a name="l01460"></a><a class="code" href="../../d8/d3/tokenp_8h.html#a35">01460</a> <a class="code" href="../../d8/d3/tokenp_8h.html#a35">SepTokenInitialization</a> ( VOID )
01461 
01462 <span class="comment">/*++</span>
01463 <span class="comment"></span>
01464 <span class="comment">Routine Description:</span>
01465 <span class="comment"></span>
01466 <span class="comment">    This function creates the token object type descriptor at system</span>
01467 <span class="comment">    initialization and stores the address of the object type descriptor</span>
01468 <span class="comment">    in global storage.  It also created token related global variables.</span>
01469 <span class="comment"></span>
01470 <span class="comment">    Furthermore, some number of pseudo tokens are created during system</span>
01471 <span class="comment">    initialization.  These tokens are tracked down and replaced with</span>
01472 <span class="comment">    real tokens.</span>
01473 <span class="comment"></span>
01474 <span class="comment">Arguments:</span>
01475 <span class="comment"></span>
01476 <span class="comment">    None.</span>
01477 <span class="comment"></span>
01478 <span class="comment">Return Value:</span>
01479 <span class="comment"></span>
01480 <span class="comment">    A value of TRUE is returned if the object type descriptor is</span>
01481 <span class="comment">    successfully initialized. Otherwise a value of FALSE is returned.</span>
01482 <span class="comment"></span>
01483 <span class="comment">--*/</span>
01484 
01485 {
01486 
01487     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
01488     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01489     UNICODE_STRING TypeName;
01490 
01491     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01492 
01493     <span class="comment">//</span>
01494     <span class="comment">// Initialize string descriptor.</span>
01495     <span class="comment">//</span>
01496 
01497     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;TypeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Token"</span>);
01498 
01499 
01500     <span class="comment">//</span>
01501     <span class="comment">// Create the global token lock</span>
01502     <span class="comment">//</span>
01503 
01504     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>(&amp;<a class="code" href="../../d4/d3/token_8c.html#a2">SepTokenLock</a>);
01505 
01506 
01507 <span class="preprocessor">#if 0</span>
01508 <span class="preprocessor"></span>BUG, BUG   Need to get system <span class="keywordflow">default</span> ACL to protect token object
01509 <span class="preprocessor">#endif</span>
01510 <span class="preprocessor"></span>
01511     <span class="comment">//</span>
01512     <span class="comment">// Create object type descriptor.</span>
01513     <span class="comment">//</span>
01514 
01515     RtlZeroMemory(&amp;ObjectTypeInitializer,<span class="keyword">sizeof</span>(ObjectTypeInitializer));
01516     ObjectTypeInitializer.Length = <span class="keyword">sizeof</span>(ObjectTypeInitializer);
01517     ObjectTypeInitializer.InvalidAttributes = OBJ_OPENLINK;
01518     ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d4/d3/token_8c.html#a0">SepTokenMapping</a>;
01519     ObjectTypeInitializer.SecurityRequired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01520     ObjectTypeInitializer.UseDefaultObject = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01521     ObjectTypeInitializer.PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
01522     ObjectTypeInitializer.ValidAccessMask = TOKEN_ALL_ACCESS;
01523     ObjectTypeInitializer.DeleteProcedure = <a class="code" href="../../d4/d3/token_8c.html#a16">SepTokenDeleteMethod</a>;
01524 
01525     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;TypeName,
01526                                 &amp;ObjectTypeInitializer,
01527                                 (PSECURITY_DESCRIPTOR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// BUG, BUG assign real protection</span>
01528                                 &amp;<a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>
01529                                 );
01530 
01531 
01532 <span class="preprocessor">#if 0</span>
01533 <span class="preprocessor"></span>BUG, BUG   Now track down all pseudo tokens used during system initialization
01534 BUG, BUG   and replace them with real ones.
01535 #endif
01536 
01537     <span class="comment">//</span>
01538     <span class="comment">// If the object type descriptor was successfully created, then</span>
01539     <span class="comment">// return a value of TRUE. Otherwise return a value of FALSE.</span>
01540     <span class="comment">//</span>
01541 
01542     <span class="keywordflow">return</span> (BOOLEAN)<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01543 }
01544 
01546 <span class="comment">//                                                                      //</span>
01547 <span class="comment">//          Temporary, for Debug only                                   //</span>
01548 <span class="comment">//                                                                      //</span>
01550 <span class="comment"></span><span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01551 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01552 SepDumpToken(
01553     IN PTOKEN T
01554     )
01555 
01556 {
01557     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01558 
01559     <span class="comment">//</span>
01560     <span class="comment">// Dump a token</span>
01561     <span class="comment">//</span>
01562 
01563     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01564 
01565     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                        address: 0x%lx \n"</span>, ((ULONG)T) );
01566 
01567     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                        TokenId: (0x%lx, 0x%lx) \n"</span>,
01568                                      T-&gt;TokenId.HighPart, T-&gt;TokenId.LowPart );
01569 
01570     <span class="keywordflow">if</span> ( (T-&gt;AuthenticationId.Data[0] == <a class="code" href="../../d0/d5/se_8h.html#a38">SeSystemAuthenticationId</a>.Data[0]) &amp;&amp;
01571          (T-&gt;AuthenticationId.Data[1] == <a class="code" href="../../d0/d5/se_8h.html#a38">SeSystemAuthenticationId</a>.Data[1]) &amp;&amp;
01572          (T-&gt;AuthenticationId.Data[2] == <a class="code" href="../../d0/d5/se_8h.html#a38">SeSystemAuthenticationId</a>.Data[2]) &amp;&amp;
01573          (T-&gt;AuthenticationId.Data[3] == <a class="code" href="../../d0/d5/se_8h.html#a38">SeSystemAuthenticationId</a>.Data[3]) ) {
01574 
01575         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"               AuthenticationId: SeSystemAuthenticationId \n"</span>);
01576 
01577     } <span class="keywordflow">else</span> {
01578 
01579         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"               AuthenticationId: (0x%lx, 0x%lx, 0x%lx, 0x%lx) \n"</span>,
01580                                          T-&gt;AuthenticationId.Data[0],
01581                                          T-&gt;AuthenticationId.Data[1],
01582                                          T-&gt;AuthenticationId.Data[2],
01583                                          T-&gt;AuthenticationId.Data[3] );
01584     }
01585 
01586     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                 ExpirationTime: 0x%lx, 0x%lx \n"</span>,
01587                                      T-&gt;ExpirationTime.HighPart,
01588                                      T-&gt;ExpirationTime.LowPart );
01589 
01590     <span class="keywordflow">if</span> (T-&gt;TokenType == TokenPrimary) {
01591         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                      TokenType: Primary \n"</span>);
01592     } <span class="keywordflow">else</span> {
01593         <span class="keywordflow">if</span> (T-&gt;TokenType == TokenImpersonation) {
01594             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                      TokenType: Impersonation \n"</span>);
01595         } <span class="keywordflow">else</span> {
01596             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                      TokenType: (Unknown type, value = 0x%lx) \n"</span>,
01597                                              ((ULONG)T-TokenType) );
01598         }
01599     }
01600 
01601     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"             ImpersonationLevel: 0x%lx \n"</span>,
01602                                      ((ULONG)T-&gt;ImpersonationLevel) );
01603 
01604     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                    TokenSource: (not yet provided) \n"</span>);
01605     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                 DynamicCharged: 0x%lx \n"</span>, T-&gt;DynamicCharged);
01606     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"              UserAndGroupCount: 0x%lx \n"</span>, T-&gt;UserAndGroupCount);
01607     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                 PrivilegeCount: 0x%lx \n"</span>, T-&gt;PrivilegeCount);
01608     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                 VariableLength: 0x%lx \n"</span>, T-&gt;VariableLength);
01609 
01610 
01611     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                  ModifiedId: (0x%lx, 0x%lx) \n"</span>,
01612                                      T-&gt;ModifiedId.HighPart,
01613                                      T-&gt;ModifiedId.LowPart );
01614     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"               DynamicAvailable: 0x%lx \n"</span>, T-&gt;DynamicAvailable);
01615     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"              DefaultOwnerIndex: 0x%lx \n"</span>, T-&gt;DefaultOwnerIndex);
01616 
01617 
01618     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"         Address of DynamicPart: 0x%lx \n"</span>,
01619                                      (* (PULONG)((PVOID)(&amp;(T-&gt;DynamicPart)))) );
01620     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        Address of Default DACL: 0x%lx \n"</span>,
01621                                      (* (PULONG)((PVOID)(&amp;(T-&gt;DefaultDacl)))) );
01622 
01623     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       Address Of Variable Part: 0x%lx \n"</span>,
01624                                      &amp;(T-&gt;VariablePart) );
01625 
01626     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01627     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                   PrimaryGroup:\n"</span>);
01628     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                                         Address: 0x%lx \n"</span>,
01629                                      (* (PULONG)((PVOID)(&amp;(T-&gt;PrimaryGroup)))) );
01630     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                                          Length: 0x%lx \n"</span>,
01631                                      <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>((T-&gt;PrimaryGroup)) );
01632     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01633     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                  UserAndGroups: 0x%lx \n"</span>,
01634                                      (* (PULONG)((PVOID)(&amp;(T-&gt;UserAndGroups)))) );
01635     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                               User ID - \n"</span>);
01636     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                                Address: 0x%lx \n"</span>,
01637                                      (* (PULONG)((PVOID)(&amp;(T-&gt;UserAndGroups[0].Sid)))) );
01638     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                             Attributes: 0x%lx \n"</span>,
01639                                      (T-&gt;UserAndGroups[0].Attributes) );
01640     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                                 Length: 0x%lx \n"</span>,
01641                                      <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>((T-&gt;UserAndGroups[0].Sid)) );
01642     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;
01643     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; T-&gt;UserAndGroupCount) {
01644         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                           Group 0x%lx - \n"</span>, Index );
01645         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                                Address: 0x%lx \n"</span>,
01646                                          (* (PULONG)((PVOID)(&amp;(T-&gt;UserAndGroups[Index].Sid)))) );
01647         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                             Attributes: 0x%lx \n"</span>,
01648                                          (T-&gt;UserAndGroups[Index].Attributes) );
01649         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                                 Length: 0x%lx \n"</span>,
01650                                          <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>((T-&gt;UserAndGroups[Index].Sid)) );
01651         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01652     }
01653 
01654     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
01655     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; T-&gt;RestrictedSidCount) {
01656         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                           Sid 0x%lx - \n"</span>, Index );
01657         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                                Address: 0x%lx \n"</span>,
01658                                          (* (PULONG)((PVOID)(&amp;(T-&gt;RestrictedSids[Index].Sid)))) );
01659         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                             Attributes: 0x%lx \n"</span>,
01660                                          (T-&gt;RestrictedSids[Index].Attributes) );
01661         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                                 Length: 0x%lx \n"</span>,
01662                                          <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>((T-&gt;RestrictedSids[Index].Sid)) );
01663         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01664     }
01665 
01666 
01667     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01668     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                     Privileges: 0x%lx\n"</span>,
01669                                      (* (PULONG)((PVOID)(&amp;(T-&gt;Privileges)))) );
01670     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
01671     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; T-&gt;PrivilegeCount) {
01672         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                       Privilege 0x%lx - \n"</span>, Index );
01673         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                                Address: 0x%lx \n"</span>,
01674                                          (&amp;(T-&gt;Privileges[Index])) );
01675         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                                   LUID: (0x%lx, 0x%lx) \n"</span>,
01676                                          T-&gt;Privileges[Index].Luid.HighPart,
01677                                          T-&gt;Privileges[Index].Luid.LowPart );
01678         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                             Attributes: 0x%lx \n"</span>,
01679                                          T-&gt;Privileges[Index].Attributes );
01680 
01681         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01682     }
01683 
01684     <span class="keywordflow">return</span>;
01685 
01686 }
01687 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01688 <span class="preprocessor"></span>
01689 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01690"></a><a class="code" href="../../d4/d3/token_8c.html#a15">01690</a> <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>(
01691     OUT PHANDLE TokenHandle,
01692     IN ACCESS_MASK DesiredAccess,
01693     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
01694     IN TOKEN_TYPE TokenType,
01695     IN PLUID AuthenticationId,
01696     IN PLARGE_INTEGER ExpirationTime,
01697     IN PTOKEN_USER User,
01698     IN PTOKEN_GROUPS Groups,
01699     IN PTOKEN_PRIVILEGES Privileges,
01700     IN PTOKEN_OWNER Owner OPTIONAL,
01701     IN PTOKEN_PRIMARY_GROUP PrimaryGroup,
01702     IN PTOKEN_DEFAULT_DACL DefaultDacl OPTIONAL,
01703     IN PTOKEN_SOURCE TokenSource
01704     )
01705 
01706 <span class="comment">/*++</span>
01707 <span class="comment"></span>
01708 <span class="comment">Routine Description:</span>
01709 <span class="comment"></span>
01710 <span class="comment">    Create a token object and return a handle opened for access to</span>
01711 <span class="comment">    that token.  This API requires SeCreateTokenPrivilege privilege.</span>
01712 <span class="comment"></span>
01713 <span class="comment">Arguments:</span>
01714 <span class="comment"></span>
01715 <span class="comment">    TokenHandle - Receives the handle of the newly created token.</span>
01716 <span class="comment"></span>
01717 <span class="comment">    DesiredAccess - Is an access mask indicating which access types</span>
01718 <span class="comment">        the handle is to provide to the new object.</span>
01719 <span class="comment"></span>
01720 <span class="comment">    ObjectAttributes - Points to the standard object attributes data</span>
01721 <span class="comment">        structure.  Refer to the NT Object Management</span>
01722 <span class="comment">        Specification for a description of this data structure.</span>
01723 <span class="comment"></span>
01724 <span class="comment">        If the token type is TokenImpersonation, then this parameter</span>
01725 <span class="comment">        must specify the impersonation level of the token.</span>
01726 <span class="comment"></span>
01727 <span class="comment">    TokenType - Type of token to be created.  Privilege is required</span>
01728 <span class="comment">        to create any type of token.</span>
01729 <span class="comment"></span>
01730 <span class="comment">    AuthenticationId - Points to a LUID (or LUID) providing a unique</span>
01731 <span class="comment">        identifier associated with the authentication.  This is used</span>
01732 <span class="comment">        within security only, for audit purposes.</span>
01733 <span class="comment"></span>
01734 <span class="comment">    ExpirationTime - Time at which the token becomes invalid.  If this</span>
01735 <span class="comment">        value is specified as zero, then the token has no expiration</span>
01736 <span class="comment">        time.</span>
01737 <span class="comment"></span>
01738 <span class="comment">    User - Is the user SID to place in the token.</span>
01739 <span class="comment"></span>
01740 <span class="comment">    Groups - Are the group SIDs to place in the token.</span>
01741 <span class="comment"></span>
01742 <span class="comment">    Privileges - Are the privileges to place in the token.</span>
01743 <span class="comment"></span>
01744 <span class="comment">    Owner - (Optionally) identifies an identifier that is to be used</span>
01745 <span class="comment">        as the default owner for the token.  If not provided, the</span>
01746 <span class="comment">        user ID is made the default owner.</span>
01747 <span class="comment"></span>
01748 <span class="comment">    PrimaryGroup - Identifies which of the group IDs is to be the</span>
01749 <span class="comment">        primary group of the token.</span>
01750 <span class="comment"></span>
01751 <span class="comment">    DefaultDacl - (optionally) establishes an ACL to be used as the</span>
01752 <span class="comment">        default discretionary access protection for the token.</span>
01753 <span class="comment"></span>
01754 <span class="comment">    TokenSource - Identifies the token source name string and</span>
01755 <span class="comment">        identifier to be assigned to the token.</span>
01756 <span class="comment"></span>
01757 <span class="comment">Return Value:</span>
01758 <span class="comment"></span>
01759 <span class="comment">    STATUS_SUCCESS - Indicates the operation was successful.</span>
01760 <span class="comment"></span>
01761 <span class="comment">    STATUS_INVALID_OWNER - Indicates the ID provided to be assigned</span>
01762 <span class="comment">        as the default owner of the token does not have an attribute</span>
01763 <span class="comment">        indicating it may be assigned as an owner.</span>
01764 <span class="comment"></span>
01765 <span class="comment">    STATUS_INVALID_PRIMARY_GROUP - Indicates the group ID provided</span>
01766 <span class="comment">        via the PrimaryGroup parameter was not among those assigned</span>
01767 <span class="comment">        to the token in the Groups parameter.</span>
01768 <span class="comment"></span>
01769 <span class="comment">    STATUS_BAD_IMPERSONATION_LEVEL - Indicates no impersonation level</span>
01770 <span class="comment">        was provided when attempting to create a token of type</span>
01771 <span class="comment">        TokenImpersonation.</span>
01772 <span class="comment"></span>
01773 <span class="comment">--*/</span>
01774 
01775 {
01776 
01777     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01778     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01779     ULONG Ignore;
01780 
01781 
01782     HANDLE LocalHandle;
01783 
01784     BOOLEAN SecurityQosPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01785     SECURITY_ADVANCED_QUALITY_OF_SERVICE CapturedSecurityQos;
01786 
01787     LUID CapturedAuthenticationId;
01788     LARGE_INTEGER CapturedExpirationTime;
01789 
01790     PSID_AND_ATTRIBUTES CapturedUser = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01791     ULONG CapturedUserLength;
01792 
01793     ULONG CapturedGroupCount;
01794     PSID_AND_ATTRIBUTES CapturedGroups = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01795     ULONG CapturedGroupsLength;
01796 
01797     ULONG CapturedPrivilegeCount;
01798     PLUID_AND_ATTRIBUTES CapturedPrivileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01799     ULONG CapturedPrivilegesLength;
01800 
01801     PSID CapturedOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01802 
01803     PSID CapturedPrimaryGroup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01804 
01805     PACL CapturedDefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01806 
01807     TOKEN_SOURCE CapturedTokenSource;
01808 
01809     PVOID CapturedAddress;
01810 
01811     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01812 
01813     PreviousMode = KeGetPreviousMode();
01814 
01815     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01816 
01817         <span class="comment">//</span>
01818         <span class="comment">// Probe everything necessary for input to the capture subroutines.</span>
01819         <span class="comment">//</span>
01820 
01821         <span class="keywordflow">try</span> {
01822 
01823             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(TokenHandle);
01824 
01825 
01826             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( ExpirationTime, <span class="keyword">sizeof</span>(LARGE_INTEGER), <span class="keyword">sizeof</span>(ULONG) );
01827             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( Groups, <span class="keyword">sizeof</span>(TOKEN_GROUPS), <span class="keyword">sizeof</span>(ULONG) );
01828             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( Privileges, <span class="keyword">sizeof</span>(TOKEN_PRIVILEGES), <span class="keyword">sizeof</span>(ULONG) );
01829             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( TokenSource, <span class="keyword">sizeof</span>(TOKEN_SOURCE), <span class="keyword">sizeof</span>(ULONG) );
01830 
01831 
01832             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>) ) {
01833                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>, <span class="keyword">sizeof</span>(TOKEN_OWNER), <span class="keyword">sizeof</span>(ULONG) );
01834             }
01835 
01836 
01837             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
01838                 PrimaryGroup,
01839                 <span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP),
01840                 <span class="keyword">sizeof</span>(ULONG)
01841                 );
01842 
01843 
01844             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(DefaultDacl) ) {
01845                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
01846                     DefaultDacl,
01847                     <span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL),
01848                     <span class="keyword">sizeof</span>(ULONG)
01849                     );
01850              }
01851 
01852             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
01853                 AuthenticationId,
01854                 <span class="keyword">sizeof</span>(LUID),
01855                 <span class="keyword">sizeof</span>(ULONG)
01856                 );
01857 
01858         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01859             <span class="keywordflow">return</span> GetExceptionCode();
01860         }  <span class="comment">// end_try</span>
01861 
01862     } <span class="comment">//end_if</span>
01863 
01864     <span class="comment">//</span>
01865     <span class="comment">//  Capture the security quality of service.</span>
01866     <span class="comment">//  This capture routine necessarily does some probing of its own.</span>
01867     <span class="comment">//</span>
01868 
01869     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a7">SeCaptureSecurityQos</a>(
01870                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01871                  PreviousMode,
01872                  &amp;SecurityQosPresent,
01873                  &amp;CapturedSecurityQos
01874                  );
01875 
01876     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01877         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01878     }
01879 
01880     <span class="keywordflow">if</span> (TokenType == TokenImpersonation) {
01881 
01882         <span class="keywordflow">if</span> (!SecurityQosPresent) {
01883             <span class="keywordflow">return</span> STATUS_BAD_IMPERSONATION_LEVEL;
01884         } <span class="comment">// endif</span>
01885 
01886     } <span class="comment">// endif</span>
01887 
01888 
01889     <span class="comment">//</span>
01890     <span class="comment">//  Capture the rest of the arguments.</span>
01891     <span class="comment">//  These arguments have already been probed.</span>
01892     <span class="comment">//</span>
01893 
01894     <span class="keywordflow">try</span> {
01895 
01896         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01897 
01898         <span class="comment">//</span>
01899         <span class="comment">//  Capture and validate AuthenticationID</span>
01900         <span class="comment">//</span>
01901 
01902         <a class="code" href="../../d8/d6/sertl_8c.html#a51">RtlCopyLuid</a>( &amp;CapturedAuthenticationId, AuthenticationId );
01903 
01904         <span class="comment">//</span>
01905         <span class="comment">//  Capture ExpirationTime</span>
01906         <span class="comment">//</span>
01907 
01908         CapturedExpirationTime = (*ExpirationTime);
01909 
01910         <span class="comment">//</span>
01911         <span class="comment">//  Capture User</span>
01912         <span class="comment">//</span>
01913 
01914         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01915             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a14">SeCaptureSidAndAttributesArray</a>(
01916                          &amp;(User-&gt;User),
01917                          1,
01918                          PreviousMode,
01919                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
01920                          <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01921                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01922                          &amp;CapturedUser,
01923                          &amp;CapturedUserLength
01924                          );
01925         }
01926 
01927 
01928         <span class="comment">//</span>
01929         <span class="comment">//  Capture Groups</span>
01930         <span class="comment">//</span>
01931 
01932         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01933             CapturedGroupCount = Groups-&gt;GroupCount;
01934             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a14">SeCaptureSidAndAttributesArray</a>(
01935                          (Groups-&gt;Groups),
01936                          CapturedGroupCount,
01937                          PreviousMode,
01938                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
01939                          <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01940                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01941                          &amp;CapturedGroups,
01942                          &amp;CapturedGroupsLength
01943                          );
01944         }
01945 
01946 
01947         <span class="comment">//</span>
01948         <span class="comment">//  Capture Privileges</span>
01949         <span class="comment">//</span>
01950 
01951         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01952             CapturedPrivilegeCount = Privileges-&gt;PrivilegeCount;
01953             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a12">SeCaptureLuidAndAttributesArray</a>(
01954                          (Privileges-&gt;Privileges),
01955                          CapturedPrivilegeCount,
01956                          PreviousMode,
01957                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
01958                          <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01959                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01960                          &amp;CapturedPrivileges,
01961                          &amp;CapturedPrivilegesLength
01962                          );
01963         }
01964 
01965 
01966         <span class="comment">//</span>
01967         <span class="comment">//  Capture Owner</span>
01968         <span class="comment">//</span>
01969 
01970         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>) &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01971             CapturedAddress = <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;Owner;
01972             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a8">SeCaptureSid</a>(
01973                          (PSID)CapturedAddress,
01974                          PreviousMode,
01975                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
01976                          <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01977                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01978                          &amp;CapturedOwner
01979                          );
01980         }
01981 
01982 
01983         <span class="comment">//</span>
01984         <span class="comment">//  Capture PrimaryGroup</span>
01985         <span class="comment">//</span>
01986         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01987             CapturedAddress = PrimaryGroup-&gt;PrimaryGroup;
01988             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a8">SeCaptureSid</a>(
01989                          (PSID)CapturedAddress,
01990                          PreviousMode,
01991                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
01992                          <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01993                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01994                          &amp;CapturedPrimaryGroup
01995                          );
01996         }
01997 
01998 
01999         <span class="comment">//</span>
02000         <span class="comment">//  Capture DefaultDacl</span>
02001         <span class="comment">//</span>
02002 
02003         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(DefaultDacl) &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
02004             CapturedAddress = DefaultDacl-&gt;DefaultDacl;
02005             <span class="keywordflow">if</span> (CapturedAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02006                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a10">SeCaptureAcl</a>(
02007                              (PACL)CapturedAddress,
02008                              PreviousMode,
02009                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
02010                              <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02011                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02012                              &amp;CapturedDefaultDacl,
02013                              &amp;Ignore
02014                              );
02015             }
02016         }
02017 
02018         <span class="comment">//</span>
02019         <span class="comment">//  Capture TokenSource</span>
02020         <span class="comment">//</span>
02021 
02022         CapturedTokenSource = (*TokenSource);
02023 
02024 
02025     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02026 
02027         <span class="keywordflow">if</span> (CapturedUser != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02028             <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>(
02029                 CapturedUser,
02030                 PreviousMode,
02031                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02032                 );
02033         }
02034 
02035         <span class="keywordflow">if</span> (CapturedGroups != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02036             <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>(
02037                 CapturedGroups,
02038                 PreviousMode,
02039                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02040                 );
02041         }
02042 
02043         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02044             <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>(
02045                 CapturedPrivileges,
02046                 PreviousMode,
02047                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02048                 );
02049         }
02050 
02051         <span class="keywordflow">if</span> (CapturedOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02052             <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedOwner, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02053         }
02054 
02055         <span class="keywordflow">if</span> (CapturedPrimaryGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02056             <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedPrimaryGroup, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02057         }
02058 
02059         <span class="keywordflow">if</span> (CapturedDefaultDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02060             <a class="code" href="../../d2/d5/se_2capture_8c.html#a11">SeReleaseAcl</a>( CapturedDefaultDacl, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02061         }
02062 
02063         <span class="keywordflow">if</span> (SecurityQosPresent == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02064             <a class="code" href="../../d2/d5/se_2capture_8c.html#a6">SeFreeCapturedSecurityQos</a>( &amp;CapturedSecurityQos );
02065         }
02066 
02067         <span class="keywordflow">return</span> GetExceptionCode();
02068 
02069     }  <span class="comment">// end_try{}</span>
02070 
02071     <span class="comment">//</span>
02072     <span class="comment">//  Create the token</span>
02073     <span class="comment">//</span>
02074 
02075     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02076         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a17">SepCreateToken</a>(
02077                                 &amp;LocalHandle,
02078                                 PreviousMode,
02079                                 DesiredAccess,
02080                                 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02081                                 TokenType,
02082                                 CapturedSecurityQos.ImpersonationLevel,
02083                                 &amp;CapturedAuthenticationId,
02084                                 &amp;CapturedExpirationTime,
02085                                 CapturedUser,
02086                                 CapturedGroupCount,
02087                                 CapturedGroups,
02088                                 CapturedGroupsLength,
02089                                 CapturedPrivilegeCount,
02090                                 CapturedPrivileges,
02091                                 CapturedPrivilegesLength,
02092                                 CapturedOwner,
02093                                 CapturedPrimaryGroup,
02094                                 CapturedDefaultDacl,
02095                                 &amp;CapturedTokenSource,
02096                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                       <span class="comment">// Not a system token</span>
02097                                 SecurityQosPresent ? CapturedSecurityQos.ProxyData : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02098                                 SecurityQosPresent ? CapturedSecurityQos.AuditData : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02099                                 );
02100     }
02101 
02102     <span class="comment">//</span>
02103     <span class="comment">//  Clean up the temporary capture buffers</span>
02104     <span class="comment">//</span>
02105 
02106     <span class="keywordflow">if</span> (CapturedUser != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02107         <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>( CapturedUser, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02108     }
02109     <span class="keywordflow">if</span> (CapturedGroups != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02110         <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>( CapturedGroups, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02111     }
02112 
02113     <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02114         <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>( CapturedPrivileges, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02115     }
02116 
02117     <span class="keywordflow">if</span> (CapturedOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02118         <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedOwner, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02119     }
02120 
02121     <span class="keywordflow">if</span> (CapturedPrimaryGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02122         <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedPrimaryGroup, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02123     }
02124 
02125     <span class="keywordflow">if</span> (CapturedDefaultDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02126         <a class="code" href="../../d2/d5/se_2capture_8c.html#a11">SeReleaseAcl</a>( CapturedDefaultDacl, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02127     }
02128 
02129     <span class="keywordflow">if</span> (SecurityQosPresent == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02130         <a class="code" href="../../d2/d5/se_2capture_8c.html#a6">SeFreeCapturedSecurityQos</a>( &amp;CapturedSecurityQos );
02131     }
02132 
02133     <span class="comment">//</span>
02134     <span class="comment">//  Return the handle to this new token</span>
02135     <span class="comment">//</span>
02136 
02137     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02138         <span class="keywordflow">try</span> { *TokenHandle = LocalHandle; }
02139             except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) { <span class="keywordflow">return</span> GetExceptionCode(); }
02140     }
02141 
02142     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02143 
02144 }
02145 
02146 
02147 
02149 <span class="comment">//                                                                    //</span>
02150 <span class="comment">//           Token Private Routines                                   //</span>
02151 <span class="comment">//                                                                    //</span>
02153 <span class="comment"></span>
02154 
02155 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02156"></a><a class="code" href="../../d8/d3/tokenp_8h.html#a36">02156</a> <a class="code" href="../../d8/d3/tokenp_8h.html#a36">SepTokenDeleteMethod</a> (
02157     IN PVOID Token
02158     )
02159 
02160 <span class="comment">/*++</span>
02161 <span class="comment"></span>
02162 <span class="comment">Routine Description:</span>
02163 <span class="comment"></span>
02164 <span class="comment">    This function is the token object type-specific delete method.</span>
02165 <span class="comment">    It is needed to ensure that all memory allocated for the token</span>
02166 <span class="comment">    gets deallocated.</span>
02167 <span class="comment"></span>
02168 <span class="comment">Arguments:</span>
02169 <span class="comment"></span>
02170 <span class="comment">    Token - Points to the token object being deleted.</span>
02171 <span class="comment"></span>
02172 <span class="comment">Return Value:</span>
02173 <span class="comment"></span>
02174 <span class="comment">    None.</span>
02175 <span class="comment"></span>
02176 <span class="comment">--*/</span>
02177 
02178 {
02179     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02180 
02181     <span class="comment">//</span>
02182     <span class="comment">// De-reference the logon session referenced by this token object</span>
02183     <span class="comment">//</span>
02184 
02185     <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;AuthenticationId) );
02186 
02187 
02188     <span class="comment">//</span>
02189     <span class="comment">// If the token has an associated Dynamic part, deallocate it.</span>
02190     <span class="comment">//</span>
02191 
02192     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;DynamicPart)) {
02193         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;DynamicPart );
02194     }
02195 
02196     <span class="comment">//</span>
02197     <span class="comment">// Free the Proxy and Global audit structures if present.</span>
02198     <span class="comment">//</span>
02199 
02200     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *) <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;ProxyData)) {
02201         <a class="code" href="../../d6/d6/sep_8h.html#a74">SepFreeProxyData</a>( ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;ProxyData );
02202     }
02203 
02204     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;AuditData )) {
02205         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( (((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;AuditData) );
02206     }
02207 
02208 
02209     <span class="keywordflow">return</span>;
02210 }
02211 
02212 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02213"></a><a class="code" href="../../d4/d3/token_8c.html#a17">02213</a> <a class="code" href="../../d4/d3/token_8c.html#a17">SepCreateToken</a>(
02214     OUT PHANDLE TokenHandle,
02215     IN KPROCESSOR_MODE RequestorMode,
02216     IN ACCESS_MASK DesiredAccess,
02217     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
02218     IN TOKEN_TYPE TokenType,
02219     IN SECURITY_IMPERSONATION_LEVEL ImpersonationLevel OPTIONAL,
02220     IN PLUID AuthenticationId,
02221     IN PLARGE_INTEGER ExpirationTime,
02222     IN PSID_AND_ATTRIBUTES User,
02223     IN ULONG GroupCount,
02224     IN PSID_AND_ATTRIBUTES Groups,
02225     IN ULONG GroupsLength,
02226     IN ULONG PrivilegeCount,
02227     IN PLUID_AND_ATTRIBUTES Privileges,
02228     IN ULONG PrivilegesLength,
02229     IN PSID Owner OPTIONAL,
02230     IN PSID PrimaryGroup,
02231     IN PACL DefaultDacl OPTIONAL,
02232     IN PTOKEN_SOURCE TokenSource,
02233     IN BOOLEAN SystemToken,
02234     IN PSECURITY_TOKEN_PROXY_DATA ProxyData OPTIONAL,
02235     IN PSECURITY_TOKEN_AUDIT_DATA AuditData OPTIONAL
02236     )
02237 
02238 <span class="comment">/*++</span>
02239 <span class="comment"></span>
02240 <span class="comment">Routine Description:</span>
02241 <span class="comment"></span>
02242 <span class="comment">    Create a token object and return a handle opened for access to</span>
02243 <span class="comment">    that token.  This API implements the bulk of the work needed</span>
02244 <span class="comment">    for NtCreateToken.</span>
02245 <span class="comment"></span>
02246 <span class="comment">    All parameters except DesiredAccess and ObjectAttributes are assumed</span>
02247 <span class="comment">    to have been probed and captured.</span>
02248 <span class="comment"></span>
02249 <span class="comment">    The output parameter (TokenHandle) is expected to be returned to a</span>
02250 <span class="comment">    safe address, rather than to a user mode address that may cause an</span>
02251 <span class="comment">    exception.</span>
02252 <span class="comment"></span>
02253 <span class="comment">    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
02254 <span class="comment">    NOTE: This routine is also used to create the initial system token.</span>
02255 <span class="comment">          In that case, the SystemToken parameter is TRUE and no handle</span>
02256 <span class="comment">          is established to the token.  Instead, a pointer to the token</span>
02257 <span class="comment">          is returned via the TokenHandle parameter.</span>
02258 <span class="comment">    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
02259 <span class="comment"></span>
02260 <span class="comment"></span>
02261 <span class="comment">Arguments:</span>
02262 <span class="comment"></span>
02263 <span class="comment">    TokenHandle - Receives the handle of the newly created token.  If the</span>
02264 <span class="comment">        SystemToken parameter is specified is true, then this parameter</span>
02265 <span class="comment">        receives a pointer to the token instead of a handle to the token.</span>
02266 <span class="comment"></span>
02267 <span class="comment">    RequestorMode - The mode of the caller on whose behalf the token</span>
02268 <span class="comment">        is being created.</span>
02269 <span class="comment"></span>
02270 <span class="comment">    DesiredAccess - Is an access mask indicating which access types</span>
02271 <span class="comment">        the handle is to provide to the new object.</span>
02272 <span class="comment"></span>
02273 <span class="comment">    ObjectAttributes - Points to the standard object attributes data</span>
02274 <span class="comment">        structure.  Refer to the NT Object Management</span>
02275 <span class="comment">        Specification for a description of this data structure.</span>
02276 <span class="comment"></span>
02277 <span class="comment">    TokenType - Type of token to be created.  Privilege is required</span>
02278 <span class="comment">        to create any type of token.</span>
02279 <span class="comment"></span>
02280 <span class="comment">    ImpersonationLevel - If the token type is TokenImpersonation, then</span>
02281 <span class="comment">        this parameter is used to specify the impersonation level of</span>
02282 <span class="comment">        the token.</span>
02283 <span class="comment"></span>
02284 <span class="comment">    AuthenticationId - Points to a LUID (or LUID) providing a unique</span>
02285 <span class="comment">        identifier associated with the authentication.  This is used</span>
02286 <span class="comment">        within security only, for audit purposes.</span>
02287 <span class="comment"></span>
02288 <span class="comment">    ExpirationTime - Time at which the token becomes invalid.  If this</span>
02289 <span class="comment">        value is specified as zero, then the token has no expiration</span>
02290 <span class="comment">        time.</span>
02291 <span class="comment"></span>
02292 <span class="comment">    User - Is the user SID to place in the token.</span>
02293 <span class="comment"></span>
02294 <span class="comment">    GroupCount - Indicates the number of groups in the 'Groups' parameter.</span>
02295 <span class="comment">        This value may be zero, in which case the 'Groups' parameter is</span>
02296 <span class="comment">        ignored.</span>
02297 <span class="comment"></span>
02298 <span class="comment">    Groups - Are the group SIDs, and their corresponding attributes,</span>
02299 <span class="comment">        to place in the token.</span>
02300 <span class="comment"></span>
02301 <span class="comment">    GroupsLength - Indicates the length, in bytes, of the array of groups</span>
02302 <span class="comment">        to place in the token.</span>
02303 <span class="comment"></span>
02304 <span class="comment">    PrivilegeCount - Indicates the number of privileges in the 'Privileges'</span>
02305 <span class="comment">        parameter.  This value may be zero, in which case the 'Privileges'</span>
02306 <span class="comment">        parameter is ignored.</span>
02307 <span class="comment"></span>
02308 <span class="comment">    Privileges - Are the privilege LUIDs, and their corresponding attributes,</span>
02309 <span class="comment">        to place in the token.</span>
02310 <span class="comment"></span>
02311 <span class="comment">    PrivilegesLength - Indicates the length, in bytes, of the array of</span>
02312 <span class="comment">        privileges to place in the token.</span>
02313 <span class="comment"></span>
02314 <span class="comment">    Owner - (Optionally) identifies an identifier that is to be used</span>
02315 <span class="comment">        as the default owner for the token.  If not provided, the</span>
02316 <span class="comment">        user ID is made the default owner.</span>
02317 <span class="comment"></span>
02318 <span class="comment">    PrimaryGroup - Identifies which of the group IDs is to be the</span>
02319 <span class="comment">        primary group of the token.</span>
02320 <span class="comment"></span>
02321 <span class="comment">    DefaultDacl - (optionally) establishes an ACL to be used as the</span>
02322 <span class="comment">        default discretionary access protection for the token.</span>
02323 <span class="comment"></span>
02324 <span class="comment">    TokenSource - Identifies the token source name string and</span>
02325 <span class="comment">        identifier to be assigned to the token.</span>
02326 <span class="comment"></span>
02327 <span class="comment">Return Value:</span>
02328 <span class="comment"></span>
02329 <span class="comment">    STATUS_SUCCESS - Indicates the operation was successful.</span>
02330 <span class="comment"></span>
02331 <span class="comment">    STATUS_INVALID_OWNER - Indicates the ID provided to be assigned</span>
02332 <span class="comment">        as the default owner of the token does not have an attribute</span>
02333 <span class="comment">        indicating it may be assigned as an owner.</span>
02334 <span class="comment"></span>
02335 <span class="comment">    STATUS_INVALID_PRIMARY_GROUP - Indicates the group ID provided</span>
02336 <span class="comment">        via the PrimaryGroup parameter was not among those assigned</span>
02337 <span class="comment">        to the token in the Groups parameter.</span>
02338 <span class="comment"></span>
02339 <span class="comment">    STATUS_INVALID_PARAMETER - Indicates that a required parameter,</span>
02340 <span class="comment">        such as User or PrimaryGroup, was not provided with a legitimate</span>
02341 <span class="comment">        value.</span>
02342 <span class="comment"></span>
02343 <span class="comment">--*/</span>
02344 
02345 {
02346 
02347     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
02348     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02349 
02350     ULONG PagedPoolSize;
02351 
02352     ULONG PrimaryGroupLength;
02353 
02354     ULONG TokenBodyLength;
02355     ULONG VariableLength;
02356 
02357     ULONG DefaultOwnerIndex;
02358     PUCHAR Where ;
02359     ULONG ComputedPrivLength ;
02360 
02361     <span class="comment">//ULONG_PTR NextFree;</span>
02362     PSID NextSidFree;
02363 
02364     ULONG DynamicLength = <a class="code" href="../../d8/d3/tokenp_8h.html#a3">TOKEN_DEFAULT_DYNAMIC_CHARGE</a>;
02365     ULONG DynamicLengthUsed;
02366 
02367     ULONG SubAuthorityCount;
02368     ULONG GroupIndex;
02369     ULONG PrivilegeIndex;
02370     BOOLEAN OwnerFound;
02371 
02372     UCHAR TokenFlags = 0;
02373 
02374     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> AccessState;
02375     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">AUX_ACCESS_DATA</a> AuxData;
02376     LUID NewModifiedId;
02377 
02378     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02379 
02380     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(SECURITY_IMPERSONATION_LEVEL) &lt;= <span class="keyword">sizeof</span>(ULONG) );
02381 
02382     <span class="comment">//</span>
02383     <span class="comment">// Make sure the Enabled and Enabled-by-default bits are set on every</span>
02384     <span class="comment">// mandatory group.</span>
02385     <span class="comment">//</span>
02386     <span class="comment">// Also, check to see if the local administrators alias is present.</span>
02387     <span class="comment">// if so, turn on the flag so that we can do restrictions later</span>
02388     <span class="comment">//</span>
02389 
02390     <span class="keywordflow">for</span> (GroupIndex=0; GroupIndex &lt; GroupCount; GroupIndex++) {
02391         <span class="keywordflow">if</span> (Groups[GroupIndex].Attributes &amp; SE_GROUP_MANDATORY) {
02392             Groups[GroupIndex].Attributes |= (SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT);
02393         }
02394         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a>, Groups[GroupIndex].Sid ) )
02395         {
02396             TokenFlags |= <a class="code" href="../../d0/d5/se_8h.html#a4">TOKEN_HAS_ADMIN_GROUP</a> ;
02397         }
02398     }
02399 
02400     <span class="comment">//</span>
02401     <span class="comment">// Check to see if the token being created is going to be granted</span>
02402     <span class="comment">// SeChangeNotifyPrivilege.  If so, set a flag in the TokenFlags field</span>
02403     <span class="comment">// so we can find this out quickly.</span>
02404     <span class="comment">//</span>
02405 
02406     <span class="keywordflow">for</span> (PrivilegeIndex = 0; PrivilegeIndex &lt; PrivilegeCount; PrivilegeIndex++) {
02407 
02408         <span class="keywordflow">if</span> (((<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;Privileges[PrivilegeIndex].Luid,&amp;<a class="code" href="../../d0/d5/se_8h.html#a100">SeChangeNotifyPrivilege</a>))
02409                 &amp;&amp;
02410             (Privileges[PrivilegeIndex].Attributes &amp; SE_PRIVILEGE_ENABLED))) {
02411 
02412             TokenFlags |= <a class="code" href="../../d0/d5/se_8h.html#a1">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>;
02413             <span class="keywordflow">break</span>;
02414         }
02415     }
02416 
02417 
02418     <span class="comment">//</span>
02419     <span class="comment">// Get a ModifiedId to use</span>
02420     <span class="comment">//</span>
02421 
02422     <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;NewModifiedId );
02423 
02424     <span class="comment">//</span>
02425     <span class="comment">// Validate the owner ID, if provided and establish the default</span>
02426     <span class="comment">// owner index.</span>
02427     <span class="comment">//</span>
02428 
02429     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>)) {
02430 
02431         DefaultOwnerIndex = 0;
02432 
02433     } <span class="keywordflow">else</span> {
02434 
02435 
02436         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>, User-&gt;Sid )  ) {
02437 
02438             DefaultOwnerIndex = 0;
02439 
02440         } <span class="keywordflow">else</span> {
02441 
02442             GroupIndex = 0;
02443             OwnerFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02444 
02445             <span class="keywordflow">while</span> ((GroupIndex &lt; GroupCount) &amp;&amp; (!OwnerFound)) {
02446 
02447                 <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>, (Groups[GroupIndex].Sid) )  ) {
02448 
02449                     <span class="comment">//</span>
02450                     <span class="comment">// Found a match - make sure it is assignable as owner.</span>
02451                     <span class="comment">//</span>
02452 
02453                     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a12">SepArrayGroupAttributes</a>( Groups, GroupIndex ) &amp;
02454                          SE_GROUP_OWNER ) {
02455 
02456                         DefaultOwnerIndex = GroupIndex + 1;
02457                         OwnerFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02458 
02459                     } <span class="keywordflow">else</span> {
02460 
02461                         <span class="keywordflow">return</span> STATUS_INVALID_OWNER;
02462 
02463                     } <span class="comment">// endif Owner attribute set</span>
02464 
02465                 } <span class="comment">// endif owner = group</span>
02466 
02467                 GroupIndex += 1;
02468 
02469             }  <span class="comment">// endwhile</span>
02470 
02471             <span class="keywordflow">if</span> (!OwnerFound) {
02472 
02473                 <span class="keywordflow">return</span> STATUS_INVALID_OWNER;
02474 
02475             } <span class="comment">// endif !OwnerFound</span>
02476         } <span class="comment">// endif owner = user</span>
02477     } <span class="comment">// endif owner specified</span>
02478 
02479 
02480 
02481     <span class="comment">//</span>
02482     <span class="comment">// Increment the reference count for this logon session</span>
02483     <span class="comment">// (fail if there is no corresponding logon session.)</span>
02484     <span class="comment">//</span>
02485 
02486     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/sep_8h.html#a40">SepReferenceLogonSession</a>( AuthenticationId );
02487     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
02488         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02489     }
02490 
02491 
02492 
02493 
02494     <span class="comment">//</span>
02495     <span class="comment">//  Calculate the length needed for the variable portion of the token</span>
02496     <span class="comment">//  This includes the User ID, Group IDs, and Privileges</span>
02497     <span class="comment">//</span>
02498     <span class="comment">//</span>
02499     <span class="comment">// Align the privilege chunk by pointer alignment so that the SIDs will</span>
02500     <span class="comment">// be correctly aligned.  Align the Groups Length so that the SID_AND_ATTR</span>
02501     <span class="comment">// array (which is</span>
02502     <span class="comment">//</span>
02503 
02504     ComputedPrivLength = PrivilegeCount * <span class="keyword">sizeof</span>( LUID_AND_ATTRIBUTES ) ;
02505 
02506     ComputedPrivLength = <a class="code" href="../../d0/d9/ntosdef_8h.html#a4">ALIGN_UP</a>( ComputedPrivLength, PVOID );
02507 
02508     GroupsLength = <a class="code" href="../../d0/d9/ntosdef_8h.html#a4">ALIGN_UP</a>( GroupsLength, PVOID );
02509 
02510 
02511     VariableLength  = GroupsLength + ComputedPrivLength +
02512                        <a class="code" href="../../d0/d9/ntosdef_8h.html#a4">ALIGN_UP</a>( (GroupCount * <span class="keyword">sizeof</span>( SID_AND_ATTRIBUTES )), PVOID ) ;
02513 
02514     SubAuthorityCount = ((SID *)(User-&gt;Sid))-&gt;SubAuthorityCount;
02515     VariableLength += <span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES) +
02516                       (ULONG)LongAlignSize(<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( SubAuthorityCount ));
02517 
02518 
02519 
02520     <span class="comment">//</span>
02521     <span class="comment">//  Calculate the length needed for the dynamic portion of the token</span>
02522     <span class="comment">//  This includes the default Dacl and the primary group.</span>
02523     <span class="comment">//</span>
02524 
02525     SubAuthorityCount = ((SID *)PrimaryGroup)-&gt;SubAuthorityCount;
02526     DynamicLengthUsed = (ULONG)LongAlignSize(<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( SubAuthorityCount ));
02527 
02528     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DefaultDacl)) {
02529         DynamicLengthUsed += (ULONG)LongAlignSize(DefaultDacl-&gt;AclSize);
02530     }
02531 
02532     <span class="keywordflow">if</span> (DynamicLengthUsed &gt; DynamicLength) {
02533         DynamicLength = DynamicLengthUsed;
02534     }
02535 
02536     <span class="comment">//</span>
02537     <span class="comment">// Now create the token body</span>
02538     <span class="comment">//</span>
02539 
02540     TokenBodyLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a>) + VariableLength;
02541     PagedPoolSize = TokenBodyLength + DynamicLength;
02542 
02543 
02544     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(
02545                  RequestorMode,      <span class="comment">// ProbeMode</span>
02546                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>, <span class="comment">// ObjectType</span>
02547                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,   <span class="comment">// ObjectAttributes</span>
02548                  <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,           <span class="comment">// OwnershipMode</span>
02549                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,               <span class="comment">// ParseContext</span>
02550                  TokenBodyLength,    <span class="comment">// ObjectBodySize</span>
02551                  PagedPoolSize,      <span class="comment">// PagedPoolCharge</span>
02552                  0,                  <span class="comment">// NonPagedPoolCharge</span>
02553                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>     <span class="comment">// Return pointer to object</span>
02554                  );
02555 
02556     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02557         <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( AuthenticationId );
02558         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02559     }
02560 
02561     <span class="comment">//</span>
02562     <span class="comment">// After this point, we rely on token deletion to clean up the referenced</span>
02563     <span class="comment">// logon session if the creation fails.</span>
02564     <span class="comment">//</span>
02565 
02566 
02567     <span class="comment">//</span>
02568     <span class="comment">// Main Body initialization</span>
02569     <span class="comment">//</span>
02570 
02571 
02572     <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenId) );
02573     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ParentTokenId = RtlConvertLongToLuid(0);
02574     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuthenticationId = (*AuthenticationId);
02575     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02576     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ModifiedId = NewModifiedId;
02577     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ExpirationTime = (*ExpirationTime);
02578     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType = TokenType;
02579     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel = ImpersonationLevel;
02580     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenSource = (*TokenSource);
02581 
02582     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags = TokenFlags;
02583     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;SessionId = 0;
02584 
02585     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicCharged  = DynamicLength;
02586     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable = DynamicLength - DynamicLengthUsed;
02587 
02588     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex = DefaultOwnerIndex;
02589     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02590 
02591     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;VariableLength = VariableLength;
02592 
02593     <span class="comment">// Ensure SepTokenDeleteMethod knows the buffers aren't allocated yet.</span>
02594     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ProxyData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02595     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02596     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02597 
02598     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ProxyData )) {
02599 
02600         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/sep_8h.html#a73">SepCopyProxyData</a>(
02601                     &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ProxyData,
02602                     ProxyData
02603                     );
02604 
02605         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02606             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
02607             <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
02608         }
02609 
02610     } <span class="keywordflow">else</span> {
02611 
02612         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ProxyData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02613     }
02614 
02615     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AuditData )) {
02616 
02617         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>( SECURITY_TOKEN_AUDIT_DATA ));
02618 
02619         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02620             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
02621             <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
02622         }
02623 
02624         *(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData) = *AuditData;
02625 
02626     } <span class="keywordflow">else</span> {
02627 
02628         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02629     }
02630 
02631 
02632     <span class="comment">//</span>
02633     <span class="comment">//  Variable part initialization</span>
02634     <span class="comment">//  Data is in the following order:</span>
02635     <span class="comment">//</span>
02636     <span class="comment">//               Privileges array</span>
02637     <span class="comment">//               User (SID_AND_ATTRIBUTES)</span>
02638     <span class="comment">//               Groups (SID_AND_ATTRIBUTES)</span>
02639     <span class="comment">//               Restricted Sids (SID_AND_ATTRIBUTES)</span>
02640     <span class="comment">//               SIDs</span>
02641     <span class="comment">//</span>
02642 
02643     Where = (PUCHAR) &amp; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;VariablePart ;
02644 
02645     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges = (PLUID_AND_ATTRIBUTES) Where ;
02646     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount = PrivilegeCount ;
02647 
02648     RtlCopyMemory(
02649         Where,
02650         Privileges,
02651         PrivilegeCount * <span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES) );
02652 
02653     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ComputedPrivLength &gt;= PrivilegeCount * <span class="keyword">sizeof</span>( LUID_AND_ATTRIBUTES ) );
02654 
02655     Where += ComputedPrivLength ;
02656     VariableLength -= ComputedPrivLength ;
02657 
02658     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (((ULONG_PTR) Where ) &amp; (<span class="keyword">sizeof</span>(PVOID) - 1)) == 0 );
02659 
02660     <span class="comment">//</span>
02661     <span class="comment">// Now, copy the sid and attributes arrays.</span>
02662     <span class="comment">//</span>
02663 
02664     NextSidFree = (PSID) (Where + (<span class="keyword">sizeof</span>( SID_AND_ATTRIBUTES ) *
02665                                    (GroupCount + 1) ) );
02666 
02667     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups = (PSID_AND_ATTRIBUTES) Where ;
02668     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount = GroupCount + 1 ;
02669 
02670 
02671     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(VariableLength &gt;= ((GroupCount + 1) * (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES)));
02672 
02673     VariableLength -= ((GroupCount + 1) * (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES));
02674     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
02675                  1,
02676                  User,
02677                  VariableLength,
02678                  (PSID_AND_ATTRIBUTES)Where,
02679                  NextSidFree,
02680                  &amp;NextSidFree,
02681                  &amp;VariableLength
02682                  );
02683 
02684     Where += <span class="keyword">sizeof</span>( SID_AND_ATTRIBUTES );
02685 
02686     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (((ULONG_PTR) Where ) &amp; (<span class="keyword">sizeof</span>(PVOID) - 1)) == 0 );
02687 
02688     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
02689                  GroupCount,
02690                  Groups,
02691                  VariableLength,
02692                  (PSID_AND_ATTRIBUTES)Where,
02693                  NextSidFree,
02694                  &amp;NextSidFree,
02695                  &amp;VariableLength
02696                  );
02697 
02698 
02699     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02700 
02701 
02702     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSids = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02703     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSidCount = 0;
02704 
02705 
02706     <span class="comment">//</span>
02707     <span class="comment">//  Dynamic part initialization</span>
02708     <span class="comment">//  Data is in the following order:</span>
02709     <span class="comment">//</span>
02710     <span class="comment">//                  PrimaryGroup (SID)</span>
02711     <span class="comment">//                  Default Discreationary Acl (ACL)</span>
02712     <span class="comment">//</span>
02713 
02714     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart = (PULONG)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, DynamicLength, 'dTeS' );
02715 
02716     <span class="comment">//</span>
02717     <span class="comment">// The attempt to allocate the DynamicPart of the token may have</span>
02718     <span class="comment">// failed.  Dereference the created object and exit with an error.</span>
02719     <span class="comment">//</span>
02720 
02721     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02722         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
02723         <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
02724     }
02725 
02726 
02727     Where = (PUCHAR) <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart;
02728 
02729     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup = (PSID) Where;
02730     PrimaryGroupLength = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( ((SID *)PrimaryGroup)-&gt;SubAuthorityCount );
02731     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( PrimaryGroupLength, (PSID)Where, PrimaryGroup );
02732     Where += (ULONG)LongAlignSize(PrimaryGroupLength);
02733 
02734     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DefaultDacl)) {
02735         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl = (PACL)Where;
02736 
02737         RtlCopyMemory( (PVOID)Where,
02738                       (PVOID)DefaultDacl,
02739                       DefaultDacl-&gt;AclSize
02740                       );
02741     }
02742 
02743 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02744 <span class="preprocessor"></span>
02745 <span class="comment">//</span>
02746 <span class="comment">// Debug</span>
02747     SepDumpToken( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
02748 <span class="comment">// Debug</span>
02749 <span class="comment">//</span>
02751 <span class="comment"></span><span class="preprocessor">#endif //TOKEN_DEBUG</span>
02752 <span class="preprocessor"></span>
02753 
02754     <span class="comment">//</span>
02755     <span class="comment">//  Insert the token unless it is a system token.</span>
02756     <span class="comment">//</span>
02757 
02758     <span class="keywordflow">if</span> (!SystemToken) {
02759 
02760         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a2">SeCreateAccessState</a>(
02761                      &amp;AccessState,
02762                      &amp;AuxData,
02763                      DesiredAccess,
02764                      &amp;<a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>
02765                      );
02766 
02767         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
02768             BOOLEAN PrivilegeHeld;
02769 
02770             PrivilegeHeld = <a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(
02771                             <a class="code" href="../../d0/d5/se_8h.html#a79">SeCreateTokenPrivilege</a>,
02772                             KeGetPreviousMode()
02773                             );
02774 
02775             <span class="keywordflow">if</span> (PrivilegeHeld) {
02776 
02777                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
02778                                          &amp;AccessState,
02779                                          0,
02780                                          0,
02781                                          (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02782                                          TokenHandle
02783                                          );
02784 
02785             } <span class="keywordflow">else</span> {
02786 
02787                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
02788                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
02789             }
02790 
02791             <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>( &amp;AccessState );
02792 
02793         } <span class="keywordflow">else</span> {
02794 
02795             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
02796         }
02797     } <span class="keywordflow">else</span> {
02798 
02799         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
02800         <a class="code" href="../../d6/d0/obcreate_8c.html#a10">ObDeleteCapturedInsertInfo</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>);
02801         <span class="comment">//</span>
02802         <span class="comment">// Return pointer instead of handle.</span>
02803         <span class="comment">//</span>
02804 
02805         (*TokenHandle) = (HANDLE)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
02806     }
02807 
02808     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02809 
02810 }
02811 
02812 BOOLEAN
<a name="l02813"></a><a class="code" href="../../d8/d3/tokenp_8h.html#a33">02813</a> <a class="code" href="../../d8/d3/tokenp_8h.html#a33">SepIdAssignableAsOwner</a>(
02814     IN PTOKEN Token,
02815     IN ULONG Index
02816     )
02817 
02818 <span class="comment">/*++</span>
02819 <span class="comment"></span>
02820 <span class="comment"></span>
02821 <span class="comment">Routine Description:</span>
02822 <span class="comment"></span>
02823 <span class="comment">    This routine returns a boolean value indicating whether the user</span>
02824 <span class="comment">    or group ID in the specified token with the specified index is</span>
02825 <span class="comment">    assignable as the owner of an object.</span>
02826 <span class="comment"></span>
02827 <span class="comment">    If the index is 0, which is always the USER ID, then the ID is</span>
02828 <span class="comment">    assignable as owner.  Otherwise, the ID is that of a group, and</span>
02829 <span class="comment">    it must have the "Owner" attribute set to be assignable.</span>
02830 <span class="comment"></span>
02831 <span class="comment"></span>
02832 <span class="comment"></span>
02833 <span class="comment">Arguments:</span>
02834 <span class="comment"></span>
02835 <span class="comment">    Token - Pointer to a locked Token to use.</span>
02836 <span class="comment"></span>
02837 <span class="comment">    Index - Index into the Token's UserAndGroupsArray.  This value</span>
02838 <span class="comment">        is assumed to be valid.</span>
02839 <span class="comment"></span>
02840 <span class="comment">Return Value:</span>
02841 <span class="comment"></span>
02842 <span class="comment">    TRUE  - Indicates the index corresponds to an ID that may be assigned</span>
02843 <span class="comment">            as the owner of objects.</span>
02844 <span class="comment"></span>
02845 <span class="comment">    FALSE - Indicates the index does not correspond to an ID that may be</span>
02846 <span class="comment">            assigned as the owner of objects.</span>
02847 <span class="comment"></span>
02848 <span class="comment">--*/</span>
02849 {
02850     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02851 
02852     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == 0) {
02853 
02854         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02855 
02856     } <span class="keywordflow">else</span> {
02857 
02858         <span class="keywordflow">return</span> (BOOLEAN)
02859                    ( (<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) &amp; SE_GROUP_OWNER)
02860                      != 0
02861                    );
02862     }
02863 }
02864 
02865 
02866 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02867"></a><a class="code" href="../../d4/d3/token_8c.html#a19">02867</a> <a class="code" href="../../d4/d3/token_8c.html#a19">SeIsChildToken</a>(
02868     IN HANDLE Token,
02869     OUT PBOOLEAN IsChild
02870     )
02871 <span class="comment">/*++</span>
02872 <span class="comment"></span>
02873 <span class="comment">Routine Description:</span>
02874 <span class="comment"></span>
02875 <span class="comment">    This routine returns TRUE if the supplied token is a child of the caller's</span>
02876 <span class="comment">    process token. This is done by comparing the ParentTokenId field of the</span>
02877 <span class="comment">    supplied token to the TokenId field of the token from the current subject</span>
02878 <span class="comment">    context.</span>
02879 <span class="comment"></span>
02880 <span class="comment">Arguments:</span>
02881 <span class="comment"></span>
02882 <span class="comment">    Token - Token to check for childhood</span>
02883 <span class="comment"></span>
02884 <span class="comment">    IsChild - Contains results of comparison.</span>
02885 <span class="comment"></span>
02886 <span class="comment">        TRUE - The supplied token is a child of the caller's token</span>
02887 <span class="comment">        FALSE- The supplied token is not a child of the caller's token</span>
02888 <span class="comment"></span>
02889 <span class="comment">Returns:</span>
02890 <span class="comment"></span>
02891 <span class="comment">    Status codes from any NT services called.</span>
02892 <span class="comment"></span>
02893 <span class="comment">--*/</span>
02894 {
02895     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> CallerToken;
02896     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> SuppliedToken;
02897     LUID CallerTokenId;
02898     LUID SuppliedParentTokenId;
02899     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02900 
02901     *<a class="code" href="../../d3/d9/client_2wow_8c.html#a18">IsChild</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02902 
02903     <span class="comment">//</span>
02904     <span class="comment">// Capture the caller's token and get the token id</span>
02905     <span class="comment">//</span>
02906 
02907     CallerToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>) <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>());
02908 
02909 
02910     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( CallerToken );
02911 
02912     CallerTokenId = CallerToken-&gt;TokenId;
02913 
02914     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( CallerToken );
02915 
02916     <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>(CallerToken);
02917 
02918     <span class="comment">//</span>
02919     <span class="comment">// Reference the supplied token and get the parent token id.</span>
02920     <span class="comment">//</span>
02921 
02922     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02923                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                   <span class="comment">// Handle</span>
02924                 0,                       <span class="comment">// DesiredAccess</span>
02925                 <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,      <span class="comment">// ObjectType</span>
02926                 KeGetPreviousMode(),     <span class="comment">// AccessMode</span>
02927                 (PVOID *)&amp;SuppliedToken, <span class="comment">// Object</span>
02928                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                     <span class="comment">// GrantedAccess</span>
02929                 );
02930 
02931     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
02932     {
02933         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( SuppliedToken );
02934 
02935         SuppliedParentTokenId = SuppliedToken-&gt;ParentTokenId;
02936 
02937         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( SuppliedToken );
02938 
02939         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SuppliedToken);
02940 
02941         <span class="comment">//</span>
02942         <span class="comment">// Check to see if the supplied token's parent ID is the ID</span>
02943         <span class="comment">// of the caller.</span>
02944         <span class="comment">//</span>
02945 
02946         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(
02947                 &amp;SuppliedParentTokenId,
02948                 &amp;CallerTokenId
02949                 )) {
02950 
02951             *<a class="code" href="../../d3/d9/client_2wow_8c.html#a18">IsChild</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02952         }
02953 
02954     }
02955     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02956 }
02957 
02958 
02959 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02960"></a><a class="code" href="../../d4/d3/token_8c.html#a20">02960</a> <a class="code" href="../../d4/d3/token_8c.html#a20">SeIsChildTokenByPointer</a>(
02961     IN PACCESS_TOKEN Token,
02962     OUT PBOOLEAN IsChild
02963     )
02964 <span class="comment">/*++</span>
02965 <span class="comment"></span>
02966 <span class="comment">Routine Description:</span>
02967 <span class="comment"></span>
02968 <span class="comment">    This routine returns TRUE if the supplied token is a child of the caller's</span>
02969 <span class="comment">    token. This is done by comparing the ParentTokenId field of the supplied</span>
02970 <span class="comment">    token to the TokenId field of the token from the current subject context.</span>
02971 <span class="comment"></span>
02972 <span class="comment">Arguments:</span>
02973 <span class="comment"></span>
02974 <span class="comment">    Token - Token to check for childhood</span>
02975 <span class="comment"></span>
02976 <span class="comment">    IsChild - Contains results of comparison.</span>
02977 <span class="comment"></span>
02978 <span class="comment">        TRUE - The supplied token is a child of the caller's token</span>
02979 <span class="comment">        FALSE- The supplied token is not a child of the caller's token</span>
02980 <span class="comment"></span>
02981 <span class="comment">Returns:</span>
02982 <span class="comment"></span>
02983 <span class="comment">    Status codes from any NT services called.</span>
02984 <span class="comment"></span>
02985 <span class="comment">--*/</span>
02986 {
02987     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
02988     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> CallerToken;
02989     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> SuppliedToken;
02990     LUID CallerTokenId;
02991     LUID SuppliedParentTokenId;
02992     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02993 
02994     *<a class="code" href="../../d3/d9/client_2wow_8c.html#a18">IsChild</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02995 
02996     <span class="comment">//</span>
02997     <span class="comment">// Capture the caller's token and get the token id</span>
02998     <span class="comment">//</span>
02999 
03000     CallerToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>) <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>());
03001 
03002 
03003     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( CallerToken );
03004 
03005     CallerTokenId = CallerToken-&gt;TokenId;
03006 
03007     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( CallerToken );
03008 
03009     <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>(CallerToken);
03010 
03011     SuppliedToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>) <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> ;
03012 
03013     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( SuppliedToken );
03014 
03015     SuppliedParentTokenId = SuppliedToken-&gt;ParentTokenId;
03016 
03017     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( SuppliedToken );
03018 
03019     <span class="comment">//</span>
03020     <span class="comment">// Check to see if the supplied token's parent ID is the ID</span>
03021     <span class="comment">// of the caller.</span>
03022     <span class="comment">//</span>
03023 
03024     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(
03025             &amp;SuppliedParentTokenId,
03026             &amp;CallerTokenId
03027             )) {
03028 
03029         *<a class="code" href="../../d3/d9/client_2wow_8c.html#a18">IsChild</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03030     }
03031 
03032 
03033 
03034     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03035 }
03036 
03037 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03038"></a><a class="code" href="../../d4/d3/token_8c.html#a21">03038</a> <a class="code" href="../../d4/d3/token_8c.html#a21">NtImpersonateAnonymousToken</a>(
03039     IN HANDLE ThreadHandle
03040     )
03041 
03042 <span class="comment">/*++</span>
03043 <span class="comment"></span>
03044 <span class="comment">Routine Description:</span>
03045 <span class="comment"></span>
03046 <span class="comment">    Impersonates the system's anonymous logon token on this thread.</span>
03047 <span class="comment"></span>
03048 <span class="comment">Arguments:</span>
03049 <span class="comment"></span>
03050 <span class="comment">    ThreadHandle - Handle to the thread to do the impersonation.</span>
03051 <span class="comment"></span>
03052 <span class="comment">Return Value:</span>
03053 <span class="comment"></span>
03054 <span class="comment">    STATUS_SUCCESS - Indicates the operation was successful.</span>
03055 <span class="comment"></span>
03056 <span class="comment">    STATUS_INVALID_HANDLE - the thread handle is invalid.</span>
03057 <span class="comment"></span>
03058 <span class="comment">    STATUS_ACCESS_DENIED - The thread handle is not open for impersonation</span>
03059 <span class="comment">        access.</span>
03060 <span class="comment">--*/</span>
03061 {
03062     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CallerThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03063     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03064 
03065     <span class="comment">//</span>
03066     <span class="comment">// Reference the caller's thread to make sure we can impersonate</span>
03067     <span class="comment">//</span>
03068 
03069     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03070                  <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
03071                  THREAD_IMPERSONATE,
03072                  <a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
03073                  KeGetPreviousMode(),
03074                  (PVOID *)&amp;CallerThread,
03075                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03076                  );
03077     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03078         <span class="keywordflow">goto</span> Cleanup;
03079     }
03080 
03081     <span class="comment">//</span>
03082     <span class="comment">// Reference the impersonation token to make sure we are allowed to</span>
03083     <span class="comment">// impersonate it.</span>
03084     <span class="comment">//</span>
03085 
03086     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>(
03087                 <a class="code" href="../../d0/d5/se_8h.html#a66">SeAnonymousLogonToken</a>,
03088                 TOKEN_IMPERSONATE,
03089                 <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,
03090                 KeGetPreviousMode()
03091                 );
03092     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
03093     {
03094         <span class="keywordflow">goto</span> Cleanup;
03095     }
03096 
03097     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(<a class="code" href="../../d0/d5/se_8h.html#a66">SeAnonymousLogonToken</a>);
03098 
03099     <span class="comment">//</span>
03100     <span class="comment">// Do the impersonation. We want copy on open so the caller can't</span>
03101     <span class="comment">// actually modify this system's copy of this token.</span>
03102     <span class="comment">//</span>
03103 
03104     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a6">PsImpersonateClient</a>(
03105                 CallerThread,
03106                 <a class="code" href="../../d0/d5/se_8h.html#a66">SeAnonymousLogonToken</a>,
03107                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                   <span class="comment">// copy on open</span>
03108                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                  <span class="comment">// no effective only</span>
03109                 SecurityImpersonation
03110                 );
03111 Cleanup:
03112 
03113     <span class="keywordflow">if</span> (CallerThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03114         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(CallerThread);
03115     }
03116     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03117 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:01 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
