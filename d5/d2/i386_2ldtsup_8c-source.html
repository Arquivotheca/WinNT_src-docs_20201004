<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ldtsup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ldtsup.c</h1><a href="../../d4/d3/i386_2ldtsup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    ldtsup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements interfaces that support manipulation of i386 Ldts.</span>
00012 <span class="comment">    These entry points only exist on i386 machines.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Bryan M. Willman (bryanwi) 14-May-1991</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00027 
00028 <span class="comment">//</span>
00029 <span class="comment">// Low level assembler support procedures</span>
00030 <span class="comment">//</span>
00031 
00032 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00033 <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a0">KiLoadLdtr</a>(
00034     VOID
00035     );
00036 
00037 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00038 <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a1">KiFlushDescriptors</a>(
00039     VOID
00040     );
00041 
00042 <span class="comment">//</span>
00043 <span class="comment">// Local service procedures</span>
00044 <span class="comment">//</span>
00045 
00046 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00047 <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a2">Ki386LoadTargetLdtr</a> (
00048     IN PKIPI_CONTEXT SignalDone,
00049     IN PVOID Parameter1,
00050     IN PVOID Parameter2,
00051     IN PVOID Parameter3
00052     );
00053 
00054 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00055 <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a3">Ki386FlushTargetDescriptors</a> (
00056     IN PKIPI_CONTEXT SignalDone,
00057     IN PVOID Parameter1,
00058     IN PVOID Parameter2,
00059     IN PVOID Parameter3
00060     );
00061 
00062 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00063"></a><a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a4">00063</a> <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a4">Ke386SetLdtProcess</a> (
00064     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process,
00065     IN PLDT_ENTRY Ldt,
00066     IN ULONG Limit
00067     )
00068 <span class="comment">/*++</span>
00069 <span class="comment"></span>
00070 <span class="comment">Routine Description:</span>
00071 <span class="comment"></span>
00072 <span class="comment">    The specified LDT (which may be null) will be made the active Ldt of</span>
00073 <span class="comment">    the specified process, for all threads thereof, on whichever</span>
00074 <span class="comment">    processors they are running.  The change will take effect before the</span>
00075 <span class="comment">    call returns.</span>
00076 <span class="comment"></span>
00077 <span class="comment">    An Ldt address of NULL or a Limit of 0 will cause the process to</span>
00078 <span class="comment">    receive the NULL Ldt.</span>
00079 <span class="comment"></span>
00080 <span class="comment">    This function only exists on i386 and i386 compatible processors.</span>
00081 <span class="comment"></span>
00082 <span class="comment">    No checking is done on the validity of Ldt entries.</span>
00083 <span class="comment"></span>
00084 <span class="comment"></span>
00085 <span class="comment">    N.B.</span>
00086 <span class="comment"></span>
00087 <span class="comment">    While a single Ldt structure can be shared amoung processes, any</span>
00088 <span class="comment">    edits to the Ldt of one of those processes will only be synchronized</span>
00089 <span class="comment">    for that process.  Thus, processes other than the one the change is</span>
00090 <span class="comment">    applied to may not see the change correctly.</span>
00091 <span class="comment"></span>
00092 <span class="comment">Arguments:</span>
00093 <span class="comment"></span>
00094 <span class="comment">    Process - Pointer to KPROCESS object describing the process for</span>
00095 <span class="comment">        which the Ldt is to be set.</span>
00096 <span class="comment"></span>
00097 <span class="comment">    Ldt - Pointer to an array of LDT_ENTRYs (that is, a pointer to an</span>
00098 <span class="comment">        Ldt.)</span>
00099 <span class="comment"></span>
00100 <span class="comment">    Limit - Ldt limit (must be 0 mod 8)</span>
00101 <span class="comment"></span>
00102 <span class="comment">Return Value:</span>
00103 <span class="comment"></span>
00104 <span class="comment">    None.</span>
00105 <span class="comment"></span>
00106 <span class="comment">--*/</span>
00107 
00108 {
00109 
00110     KGDTENTRY LdtDescriptor;
00111     BOOLEAN LocalProcessor;
00112     KIRQL OldIrql;
00113     PKPRCB Prcb;
00114     KAFFINITY TargetProcessors;
00115 
00116     <span class="comment">//</span>
00117     <span class="comment">// Compute the contents of the Ldt descriptor</span>
00118     <span class="comment">//</span>
00119 
00120     <span class="keywordflow">if</span> ((Ldt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (Limit == 0)) {
00121 
00122         <span class="comment">//</span>
00123         <span class="comment">//  Set up an empty descriptor</span>
00124         <span class="comment">//</span>
00125 
00126         LdtDescriptor.LimitLow = 0;
00127         LdtDescriptor.BaseLow = 0;
00128         LdtDescriptor.HighWord.Bytes.BaseMid = 0;
00129         LdtDescriptor.HighWord.Bytes.Flags1 = 0;
00130         LdtDescriptor.HighWord.Bytes.Flags2 = 0;
00131         LdtDescriptor.HighWord.Bytes.BaseHi = 0;
00132 
00133     } <span class="keywordflow">else</span> {
00134 
00135         <span class="comment">//</span>
00136         <span class="comment">// Insure that the unfilled fields of the selector are zero</span>
00137         <span class="comment">// N.B.  If this is not done, random values appear in the high</span>
00138         <span class="comment">//       portion of the Ldt limit.</span>
00139         <span class="comment">//</span>
00140 
00141         LdtDescriptor.HighWord.Bytes.Flags1 = 0;
00142         LdtDescriptor.HighWord.Bytes.Flags2 = 0;
00143 
00144         <span class="comment">//</span>
00145         <span class="comment">//  Set the limit and base</span>
00146         <span class="comment">//</span>
00147 
00148         LdtDescriptor.LimitLow = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((ULONG) Limit - 1);
00149         LdtDescriptor.BaseLow = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)  ((ULONG) Ldt &amp; 0xffff);
00150         LdtDescriptor.HighWord.Bytes.BaseMid = (UCHAR) (((ULONG)Ldt &amp; 0xff0000) &gt;&gt; 16);
00151         LdtDescriptor.HighWord.Bytes.BaseHi =  (UCHAR) (((ULONG)Ldt &amp; 0xff000000) &gt;&gt; 24);
00152 
00153         <span class="comment">//</span>
00154         <span class="comment">//  Type is LDT, DPL = 0</span>
00155         <span class="comment">//</span>
00156 
00157         LdtDescriptor.HighWord.Bits.Type = TYPE_LDT;
00158         LdtDescriptor.HighWord.Bits.Dpl = DPL_SYSTEM;
00159 
00160         <span class="comment">//</span>
00161         <span class="comment">// Make it present</span>
00162         <span class="comment">//</span>
00163 
00164         LdtDescriptor.HighWord.Bits.Pres = 1;
00165 
00166     }
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">// Acquire the context swap lock so a context switch cannot occur.</span>
00170     <span class="comment">//</span>
00171 
00172     <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
00173 
00174     <span class="comment">//</span>
00175     <span class="comment">// Set the Ldt fields in the process object.</span>
00176     <span class="comment">//</span>
00177 
00178     Process-&gt;LdtDescriptor = LdtDescriptor;
00179 
00180     <span class="comment">//</span>
00181     <span class="comment">// Tell all processors active for this process to reload their LDTs</span>
00182     <span class="comment">//</span>
00183 
00184 <span class="preprocessor">#ifdef NT_UP</span>
00185 <span class="preprocessor"></span>
00186     <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a0">KiLoadLdtr</a>();
00187 
00188 <span class="preprocessor">#else</span>
00189 <span class="preprocessor"></span>
00190     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00191     TargetProcessors = Process-&gt;ActiveProcessors &amp; ~Prcb-&gt;SetMember;
00192     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00193         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00194                         <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a2">Ki386LoadTargetLdtr</a>,
00195                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00196                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00197                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00198     }
00199 
00200     <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a0">KiLoadLdtr</a>();
00201     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00202 
00203         <span class="comment">//</span>
00204         <span class="comment">//  Stall until target processor(s) release us</span>
00205         <span class="comment">//</span>
00206 
00207         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00208     }
00209 
00210 <span class="preprocessor">#endif</span>
00211 <span class="preprocessor"></span>
00212     <span class="comment">//</span>
00213     <span class="comment">// Restore IRQL and release the context swap lock.</span>
00214     <span class="comment">//</span>
00215 
00216     <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
00217     <span class="keywordflow">return</span>;
00218 }
00219 
00220 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00221"></a><a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a2">00221</a> <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a2">Ki386LoadTargetLdtr</a> (
00222     IN PKIPI_CONTEXT SignalDone,
00223     IN PVOID Parameter1,
00224     IN PVOID Parameter2,
00225     IN PVOID Parameter3
00226     )
00227 <span class="comment">/*++</span>
00228 <span class="comment"></span>
00229 <span class="comment">Routine Description:</span>
00230 <span class="comment"></span>
00231 <span class="comment">    Reload local Ldt register and clear signal bit in TargetProcessor mask</span>
00232 <span class="comment"></span>
00233 <span class="comment">Arguments:</span>
00234 <span class="comment"></span>
00235 <span class="comment">    Argument - pointer to a ipi packet structure.</span>
00236 <span class="comment">    ReadyFlag - Pointer to flag to be set once LDTR has been reloaded</span>
00237 <span class="comment"></span>
00238 <span class="comment">Return Value:</span>
00239 <span class="comment"></span>
00240 <span class="comment">    none.</span>
00241 <span class="comment"></span>
00242 <span class="comment">--*/</span>
00243 {
00244 
00245     <span class="comment">//</span>
00246     <span class="comment">// Reload the LDTR register from currently active process object</span>
00247     <span class="comment">//</span>
00248 
00249     <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a0">KiLoadLdtr</a>();
00250     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00251     <span class="keywordflow">return</span>;
00252 }
00253 
00254 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00255"></a><a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a5">00255</a> <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a5">Ke386SetDescriptorProcess</a> (
00256     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process,
00257     IN ULONG Offset,
00258     IN LDT_ENTRY LdtEntry
00259     )
00260 <span class="comment">/*++</span>
00261 <span class="comment"></span>
00262 <span class="comment">Routine Description:</span>
00263 <span class="comment"></span>
00264 <span class="comment">    The specified LdtEntry (which could be 0, not present, etc) will be</span>
00265 <span class="comment">    edited into the specified Offset in the Ldt of the specified Process.</span>
00266 <span class="comment">    This will be synchronzied accross all the processors executing the</span>
00267 <span class="comment">    process.  The edit will take affect on all processors before the call</span>
00268 <span class="comment">    returns.</span>
00269 <span class="comment"></span>
00270 <span class="comment">    N.B.</span>
00271 <span class="comment"></span>
00272 <span class="comment">    Editing an Ldt descriptor requires stalling all processors active</span>
00273 <span class="comment">    for the process, to prevent accidental loading of descriptors in</span>
00274 <span class="comment">    an inconsistent state.</span>
00275 <span class="comment"></span>
00276 <span class="comment">Arguments:</span>
00277 <span class="comment"></span>
00278 <span class="comment">    Process - Pointer to KPROCESS object describing the process for</span>
00279 <span class="comment">        which the descriptor edit is to be performed.</span>
00280 <span class="comment"></span>
00281 <span class="comment">    Offset - Byte offset into the Ldt of the descriptor to edit.</span>
00282 <span class="comment">        Must be 0 mod 8.</span>
00283 <span class="comment"></span>
00284 <span class="comment">    LdtEntry - Value to edit into the descriptor in hardware format.</span>
00285 <span class="comment">        No checking is done on the validity of this item.</span>
00286 <span class="comment"></span>
00287 <span class="comment">Return Value:</span>
00288 <span class="comment"></span>
00289 <span class="comment">    none.</span>
00290 <span class="comment"></span>
00291 <span class="comment">--*/</span>
00292 
00293 {
00294 
00295     PLDT_ENTRY Ldt;
00296     KIRQL OldIrql;
00297     PKPRCB Prcb;
00298     KAFFINITY TargetProcessors;
00299 
00300     <span class="comment">//</span>
00301     <span class="comment">// Compute address of descriptor to edit.</span>
00302     <span class="comment">//</span>
00303 
00304     Ldt =
00305         (PLDT_ENTRY)
00306          ((Process-&gt;LdtDescriptor.HighWord.Bytes.BaseHi &lt;&lt; 24) |
00307          ((Process-&gt;LdtDescriptor.HighWord.Bytes.BaseMid &lt;&lt; 16) &amp; 0xff0000) |
00308          (Process-&gt;LdtDescriptor.BaseLow &amp; 0xffff));
00309     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> / 8;
00310     <a class="code" href="../../d5/d6/iosup_8c.html#a87">MmLockPagedPool</a>(&amp;Ldt[<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>], <span class="keyword">sizeof</span>(LDT_ENTRY));
00311     <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
00312 
00313 <span class="preprocessor">#ifdef NT_UP</span>
00314 <span class="preprocessor"></span>
00315     <span class="comment">//</span>
00316     <span class="comment">// Edit the Ldt.</span>
00317     <span class="comment">//</span>
00318 
00319     Ldt[<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>] = LdtEntry;
00320 
00321 <span class="preprocessor">#else</span>
00322 <span class="preprocessor"></span>
00323     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00324     TargetProcessors = Process-&gt;ActiveProcessors &amp; ~Prcb-&gt;SetMember;
00325     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00326         KiIpiSendSynchronousPacket(
00327             Prcb,
00328             TargetProcessors,
00329             <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a3">Ki386FlushTargetDescriptors</a>,
00330             (PVOID)&amp;Prcb-&gt;ReverseStall,
00331             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00332             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00333 
00334         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00335     }
00336 
00337     <span class="comment">//</span>
00338     <span class="comment">// All target processors have flushed the segment descriptors and</span>
00339     <span class="comment">// are waiting to proceed. Edit the ldt on the current processor,</span>
00340     <span class="comment">// then continue the execution of target processors.</span>
00341     <span class="comment">//</span>
00342 
00343     Ldt[<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>] = LdtEntry;
00344     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00345         Prcb-&gt;ReverseStall += 1;
00346     }
00347 
00348 <span class="preprocessor">#endif</span>
00349 <span class="preprocessor"></span>
00350     <span class="comment">//</span>
00351     <span class="comment">// Restore IRQL and release the context swap lock.</span>
00352     <span class="comment">//</span>
00353 
00354     <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
00355     <a class="code" href="../../d5/d6/iosup_8c.html#a88">MmUnlockPagedPool</a>(&amp;Ldt[<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>], <span class="keyword">sizeof</span>(LDT_ENTRY));
00356     <span class="keywordflow">return</span>;
00357 }
00358 
00359 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00360"></a><a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a3">00360</a> <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a3">Ki386FlushTargetDescriptors</a> (
00361     IN PKIPI_CONTEXT SignalDone,
00362     IN PVOID Proceed,
00363     IN PVOID Parameter2,
00364     IN PVOID Parameter3
00365     )
00366 
00367 <span class="comment">/*++</span>
00368 <span class="comment"></span>
00369 <span class="comment">Routine Description:</span>
00370 <span class="comment"></span>
00371 <span class="comment">    This function flushes the segment descriptors on the current processor.</span>
00372 <span class="comment"></span>
00373 <span class="comment">Arguments:</span>
00374 <span class="comment"></span>
00375 <span class="comment">    Argument - pointer to a _KIPI_FLUSH_DESCRIPTOR structure.</span>
00376 <span class="comment"></span>
00377 <span class="comment">    ReadyFlag - pointer to flag to syncroize with</span>
00378 <span class="comment"></span>
00379 <span class="comment">Return Value:</span>
00380 <span class="comment"></span>
00381 <span class="comment">    none.</span>
00382 <span class="comment"></span>
00383 <span class="comment">--*/</span>
00384 
00385 {
00386     <span class="comment">//</span>
00387     <span class="comment">// Flush the segment descriptors on the current processor and signal that</span>
00388     <span class="comment">// the descriptors have been flushed.</span>
00389     <span class="comment">//</span>
00390 
00391     <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a1">KiFlushDescriptors</a>();
00392     KiIpiSignalPacketDoneAndStall (SignalDone, Proceed);
00393     <span class="keywordflow">return</span>;
00394 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
