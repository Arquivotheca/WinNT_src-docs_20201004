<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mnstate.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mnstate.c</h1><a href="../../d4/d3/mnstate_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: mnstate.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Menu State Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">*  10-10-90 JimA      Cleanup.</span>
00010 <span class="comment">*  03-18-91 IanJa     Windowrevalidation added</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> <a class="code" href="../../d4/d3/mnstate_8c.html#a0">xxxGetInitMenuParam</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndMenu, BOOL * lpfSystem);
00017 <span class="comment">/***************************************************************************\</span>
00018 <span class="comment">* void PositionSysMenu(pwnd, hSysMenu)</span>
00019 <span class="comment">*</span>
00020 <span class="comment">*</span>
00021 <span class="comment">* History:</span>
00022 <span class="comment">* 4-25-91 Mikehar Port for 3.1 merge</span>
00023 <span class="comment">\***************************************************************************/</span>
00024 
<a name="l00025"></a><a class="code" href="../../d4/d1/userk_8h.html#a1387">00025</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1387">MNPositionSysMenu</a>(
00026     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00027     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenusys)
00028 {
00029     RECT rc;
00030     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
00031 
00032     <span class="keywordflow">if</span> (pmenusys == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00033         RIPERR0(ERROR_INVALID_HANDLE,
00034                 RIP_WARNING,
00035                 <span class="stringliteral">"Invalid menu handle pmenusys (NULL) to MNPositionSysMenu"</span>);
00036 
00037         <span class="keywordflow">return</span>;
00038     }
00039 
00040     <span class="comment">/*</span>
00041 <span class="comment">     * Whoever positions the menu becomes the owner</span>
00042 <span class="comment">     */</span>
00043     <span class="keywordflow">if</span> (pwnd != pmenusys-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>) {
00044         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pmenusys-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>, pwnd);
00045     }
00046 
00047     <span class="comment">/*</span>
00048 <span class="comment">     * Setup the SysMenu hit rectangle.</span>
00049 <span class="comment">     */</span>
00050     rc.top = rc.left = 0;
00051 
00052     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>)) {
00053         rc.right = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSMSIZE);
00054         rc.bottom = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSMSIZE);
00055     } <span class="keywordflow">else</span> {
00056         rc.right = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSIZE);
00057         rc.bottom = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSIZE);
00058     }
00059 
00060     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00061         <span class="keywordtype">int</span> cBorders;
00062 
00063         cBorders = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a7">GetWindowBorders</a>(pwnd-&gt;style, pwnd-&gt;ExStyle, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00064         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rc, cBorders*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER), cBorders*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER));
00065     }
00066 
00067     <span class="comment">/*</span>
00068 <span class="comment">     * Offset the System popup menu.</span>
00069 <span class="comment">     */</span>
00070     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pmenusys, MF_POPUP) &amp;&amp; (pmenusys-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> &gt; 0)) {
00071         pItem = pmenusys-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>;
00072         <span class="keywordflow">if</span> (pItem) {
00073             pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a> = rc.top;
00074             pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> = rc.left;
00075             pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a> = rc.bottom - rc.top;
00076             pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a> = rc.right - rc.left;
00077         }
00078     }
00079     <span class="keywordflow">else</span>
00080         <span class="comment">// BOGUS -- MF_POPUP should never be set on a MENU -- only a MENU ITEM</span>
00081         UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00082 }
00083 
00084 <span class="comment">/***************************************************************************\</span>
00085 <span class="comment">* MNFlushDestroyedPopups</span>
00086 <span class="comment">*</span>
00087 <span class="comment">* Walk the ppmDelayedFree list freeing those marked as destroyed.</span>
00088 <span class="comment">*</span>
00089 <span class="comment">* 05-14-96 GerardoB  Created</span>
00090 <span class="comment">\***************************************************************************/</span>
<a name="l00091"></a><a class="code" href="../../d4/d1/userk_8h.html#a1346">00091</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1346">MNFlushDestroyedPopups</a> (<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu, BOOL fUnlock)
00092 {
00093     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppmDestroyed, ppmFree;
00094 
00095     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a1318">IsRootPopupMenu</a>(ppopupmenu));
00096 
00097     <span class="comment">/*</span>
00098 <span class="comment">     * Walk ppmDelayedFree</span>
00099 <span class="comment">     */</span>
00100     ppmDestroyed = ppopupmenu;
00101     <span class="keywordflow">while</span> (ppmDestroyed-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00102         <span class="comment">/*</span>
00103 <span class="comment">         * If it's marked as destroyed, unlink it and free it</span>
00104 <span class="comment">         */</span>
00105         <span class="keywordflow">if</span> (ppmDestroyed-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o15">fDestroyed</a>) {
00106             ppmFree = ppmDestroyed-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a>;
00107             ppmDestroyed-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a> = ppmFree-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a>;
00108             UserAssert(ppmFree != ppmFree-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>);
00109             <a class="code" href="../../d4/d1/userk_8h.html#a1394">MNFreePopup</a>(ppmFree);
00110         } <span class="keywordflow">else</span> {
00111             <span class="comment">/*</span>
00112 <span class="comment">             * fUnlock is TRUE if the root popup is being destroyed; if</span>
00113 <span class="comment">             *  so, reset fDelayedFree and unlink it</span>
00114 <span class="comment">             */</span>
00115             <span class="keywordflow">if</span> (fUnlock) {
00116                 <span class="comment">/*</span>
00117 <span class="comment">                 * This means that the root popup is going away before</span>
00118 <span class="comment">                 *  some of the hierarchical popups have been destroyed.</span>
00119 <span class="comment">                 * This can happen if someone destroys one of the menu</span>
00120 <span class="comment">                 *  windows breaking the spwndNextPopup chain.</span>
00121 <span class="comment">                 */</span>
00122                 ppmDestroyed-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o16">fDelayedFree</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00123                 <span class="comment">/*</span>
00124 <span class="comment">                 * Stop here so we can figure how this happened.</span>
00125 <span class="comment">                 */</span>
00126                 UserAssert(ppmDestroyed-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o16">fDelayedFree</a>);
00127                 ppmDestroyed-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a> = ppmDestroyed-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a>;
00128             } <span class="keywordflow">else</span> {
00129                 <span class="comment">/*</span>
00130 <span class="comment">                 * Not fDestroyed so move to the next one.</span>
00131 <span class="comment">                 */</span>
00132                 ppmDestroyed = ppmDestroyed-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a>;
00133             } <span class="comment">/* fUnlock */</span>
00134         } <span class="comment">/* fDestroyed */</span>
00135     } <span class="comment">/* while ppmDelayedFree */</span>
00136 
00137 }
00138 
00139 <span class="comment">/***************************************************************************\</span>
00140 <span class="comment">* MNAllocPopup</span>
00141 <span class="comment">*</span>
00142 <span class="comment">\***************************************************************************/</span>
<a name="l00143"></a><a class="code" href="../../d4/d1/userk_8h.html#a1393">00143</a> <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> <a class="code" href="../../d4/d1/userk_8h.html#a1393">MNAllocPopup</a>(BOOL fForceAlloc)
00144 {
00145     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppm;
00146     <span class="keywordflow">if</span> (!fForceAlloc &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a644">PUDF_POPUPINUSE</a>)) {
00147         <a class="code" href="../../d4/d1/userk_8h.html#a659">SET_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a644">PUDF_POPUPINUSE</a>);
00148 
00149         ppm = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a145">gpopupMenu</a>;
00150     } <span class="keywordflow">else</span> {
00151         ppm = (<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>)UserAllocPoolWithQuota(<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">POPUPMENU</a>), TAG_POPUPMENU);
00152     }
00153 
00154     <span class="keywordflow">if</span> (ppm) {
00155         RtlZeroMemory(ppm, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">POPUPMENU</a>));
00156     }
00157 
00158     <span class="keywordflow">return</span> (ppm);
00159 }
00160 
00161 <span class="comment">/***************************************************************************\</span>
00162 <span class="comment">* MNFreePopup</span>
00163 <span class="comment">*</span>
00164 <span class="comment">\***************************************************************************/</span>
<a name="l00165"></a><a class="code" href="../../d4/d1/userk_8h.html#a1394">00165</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1394">MNFreePopup</a>(
00166     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu)
00167 {
00168 
00169     <a class="code" href="../../d4/d1/userk_8h.html#a549">Validateppopupmenu</a>(ppopupmenu);
00170 
00171     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1318">IsRootPopupMenu</a>(ppopupmenu)) {
00172         <a class="code" href="../../d4/d1/userk_8h.html#a1346">MNFlushDestroyedPopups</a> (ppopupmenu, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00173     }
00174 <span class="preprocessor">#if DBG</span>
00175 <span class="preprocessor"></span>    <span class="comment">/*</span>
00176 <span class="comment">     * If this is not a cached menu and it corresponds to a menu window,</span>
00177 <span class="comment">     *  then the reference to the popup must be cleared at this point since</span>
00178 <span class="comment">     *  we're going to free this popup</span>
00179 <span class="comment">     */</span>
00180     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00181         <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o23">fDesktopMenu</a> &amp;&amp; !ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
00182             UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a195">FNID_MENU</a>);
00183             UserAssert(((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>)-&gt;ppopupmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00184         }
00185     }
00186 <span class="preprocessor">#endif    </span>
00187 <span class="preprocessor"></span>    <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>);
00188     <span class="comment">/*</span>
00189 <span class="comment">     * if spwndNextPopup is not NULL, we're breaking the chain and spwndNext won't</span>
00190 <span class="comment">     *  get closed. I won't remove the unlock since it has</span>
00191 <span class="comment">     *  always been there.</span>
00192 <span class="comment">     */</span>
00193     UserAssert(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00194     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>);
00195 
00196     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a>);
00197     <a class="code" href="../../d4/d1/userk_8h.html#a1361">UnlockPopupMenu</a>(ppopupmenu, &amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>);
00198     <a class="code" href="../../d4/d1/userk_8h.html#a1361">UnlockPopupMenu</a>(ppopupmenu, &amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>);
00199     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
00200     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>);
00201 
00202 <span class="preprocessor">#if DBG</span>
00203 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o23">fDesktopMenu</a>) {
00204        ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o18">fFreed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00205    } <span class="keywordflow">else</span> {
00206        <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk;
00207        UserAssert(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a296">DF_MENUINUSE</a>);
00208        UserAssert(((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>)-&gt;ppopupmenu == ppopupmenu);
00209    }
00210 <span class="preprocessor">#endif</span>
00211 <span class="preprocessor"></span>
00212     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o23">fDesktopMenu</a>) {
00213         <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk-&gt;dwDTFlags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a296">DF_MENUINUSE</a>;
00214         <span class="comment">/* The desktop menu window points to this popup so don't leave bogus stuff in it */</span>
00215         ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00216     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ppopupmenu == &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a145">gpopupMenu</a>) {
00217         UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a644">PUDF_POPUPINUSE</a>));
00218         <a class="code" href="../../d4/d1/userk_8h.html#a660">CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a644">PUDF_POPUPINUSE</a>);
00219     } <span class="keywordflow">else</span> {
00220         UserFreePool(ppopupmenu);
00221     }
00222 }
00223 <span class="comment">/***************************************************************************\</span>
00224 <span class="comment">* MNEndMenuStateNotify</span>
00225 <span class="comment">*</span>
00226 <span class="comment">* spwndNotify might have been created by a thread other than the one</span>
00227 <span class="comment">*  the menu mode is running on. If this is the case, this function</span>
00228 <span class="comment">*  NULLs out pMenuState for the thread that owns spwndNotify.</span>
00229 <span class="comment">* It returns TRUE if the menu state owner doesn't own the notification</span>
00230 <span class="comment">*  window (multiple threads involved)</span>
00231 <span class="comment">*</span>
00232 <span class="comment">* 05-21-96 GerardoB Created</span>
00233 <span class="comment">\***************************************************************************/</span>
<a name="l00234"></a><a class="code" href="../../d4/d1/userk_8h.html#a1345">00234</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1345">MNEndMenuStateNotify</a> (<a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState)
00235 {
00236     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiNotify;
00237 
00238     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00239         ptiNotify = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
00240         <span class="keywordflow">if</span> (ptiNotify != pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o24">ptiMenuStateOwner</a>) {
00241             <span class="comment">/*</span>
00242 <span class="comment">             * Later5.0 GerardoB. xxxMNStartMenuState no longer allows this.</span>
00243 <span class="comment">             *  This is dead code that I'll remove eventually</span>
00244 <span class="comment">             */</span>
00245             UserAssert(ptiNotify == pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o24">ptiMenuStateOwner</a>);
00246 
00247             UserAssert(ptiNotify-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> == pMenuState);
00248             UserAssert(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o26">pmnsPrev</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00249             ptiNotify-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00250             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00251         }
00252     }
00253 
00254     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00255 }
00256 <span class="comment">/***************************************************************************\</span>
00257 <span class="comment">* xxxMNEndMenuState</span>
00258 <span class="comment">*</span>
00259 <span class="comment">* This funtion must be called to clean up pMenuState after getting out</span>
00260 <span class="comment">*  of menu mode. It must be called by the same thread that initialized</span>
00261 <span class="comment">*  pMenuState either manually or by calling xxxMNStartMenuState.</span>
00262 <span class="comment">*</span>
00263 <span class="comment">* 05-20-96 GerardoB Created</span>
00264 <span class="comment">\***************************************************************************/</span>
<a name="l00265"></a><a class="code" href="../../d4/d1/userk_8h.html#a1344">00265</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1344">xxxMNEndMenuState</a> (BOOL fFreePopup)
00266 {
00267     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00268     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState;
00269     pMenuState = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>;
00270     UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00271     UserAssert(ptiCurrent == pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o24">ptiMenuStateOwner</a>);
00272 
00273     <span class="comment">/*</span>
00274 <span class="comment">     * If the menu is locked, someone doesn't want it to go just yet.</span>
00275 <span class="comment">     */</span>
00276     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o25">dwLockCount</a> != 0) {
00277         RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxMNEndMenuState Locked:%#p"</span>, pMenuState);
00278         <span class="keywordflow">return</span>;
00279     }
00280 
00281     <a class="code" href="../../d4/d1/userk_8h.html#a1345">MNEndMenuStateNotify</a>(pMenuState);
00282 
00283     <span class="comment">/*</span>
00284 <span class="comment">     * pMenuState-&gt;pGlobalPopupMenu could be NULL if xxxMNAllocMenuState failed</span>
00285 <span class="comment">     */</span>
00286     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00287         <span class="keywordflow">if</span> (fFreePopup) {
00288             UserAssert(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> || pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o15">fDestroyed</a>);
00289 
00290             <a class="code" href="../../d4/d1/userk_8h.html#a1394">MNFreePopup</a>(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>);
00291         } <span class="keywordflow">else</span> {
00292             <span class="comment">/*</span>
00293 <span class="comment">             * This means that we're ending the menustate but the popup menu</span>
00294 <span class="comment">             *  window is still around. This can happen when called from</span>
00295 <span class="comment">             *  xxxDestroyThreadInfo.</span>
00296 <span class="comment">             */</span>
00297             UserAssert(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o3">fIsTrackPopup</a>);
00298             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o16">fDelayedFree</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00299         }
00300     }
00301 
00302     <span class="comment">/*</span>
00303 <span class="comment">     * Unlock MFMWFP windows.</span>
00304 <span class="comment">     */</span>
00305     <a class="code" href="../../d4/d1/userk_8h.html#a1377">UnlockMFMWFPWindow</a>(&amp;pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o28">uButtonDownHitArea</a>);
00306     <a class="code" href="../../d4/d1/userk_8h.html#a1377">UnlockMFMWFPWindow</a>(&amp;pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o31">uDraggingHitArea</a>);
00307 
00308     <span class="comment">/*</span>
00309 <span class="comment">     * Restore the previous state, if any</span>
00310 <span class="comment">     */</span>
00311     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> = pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o26">pmnsPrev</a>;
00312 
00313    <span class="comment">/*</span>
00314 <span class="comment">    * This (modal) menu mode is off</span>
00315 <span class="comment">    */</span>
00316    <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
00317        <a class="code" href="../../d4/d1/userk_8h.html#a2028">DecSFWLockCount</a>();
00318        <a class="code" href="../../d4/d1/userk_8h.html#a742">DBGDecModalMenuCount</a>();
00319    }
00320 
00321     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o40">hbmAni</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00322         <a class="code" href="../../d4/d1/userk_8h.html#a1349">MNDestroyAnimationBitmap</a>(pMenuState);
00323     }
00324 
00325     <span class="comment">/*</span>
00326 <span class="comment">     * Free the menu state</span>
00327 <span class="comment">     */</span>
00328     <span class="keywordflow">if</span> (pMenuState == &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a146">gMenuState</a>) {
00329         UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a645">PUDF_MENUSTATEINUSE</a>));
00330         <a class="code" href="../../d4/d1/userk_8h.html#a660">CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a645">PUDF_MENUSTATEINUSE</a>);
00331         GreSetDCOwner(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a146">gMenuState</a>.hdcAni, OBJECT_OWNER_PUBLIC);
00332     } <span class="keywordflow">else</span> {
00333         <span class="keywordflow">if</span> (pMenuState-&gt;hdcAni != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00334             GreDeleteDC(pMenuState-&gt;hdcAni);
00335         }
00336         UserFreePool(pMenuState);
00337     }
00338 
00339     <span class="comment">/*</span>
00340 <span class="comment">     * If returning to a modeless menu, make sure have activation</span>
00341 <span class="comment">     * If returning to a modal menu, make sure we have capture</span>
00342 <span class="comment">     */</span>
00343    <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00344        <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
00345            <a class="code" href="../../d4/d1/userk_8h.html#a1229">xxxActivateThisWindow</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>,
00346                                  0, 0);
00347        } <span class="keywordflow">else</span> {
00348            <a class="code" href="../../d4/d1/userk_8h.html#a1356">xxxMNSetCapture</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>);
00349        }
00350    }
00351 
00352 <span class="preprocessor">#if DBG</span>
00353 <span class="preprocessor"></span>    <span class="comment">/*</span>
00354 <span class="comment">     * If this thread is not in menu mode anymore, it must not be using</span>
00355 <span class="comment">     *  the desktop menu</span>
00356 <span class="comment">     */</span>
00357     <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00358         UserAssert(ptiCurrent != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>));
00359     }
00360     <span class="comment">/*</span>
00361 <span class="comment">     * If someone is using the menu window, it must be in menu mode</span>
00362 <span class="comment">     */</span>
00363     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a296">DF_MENUINUSE</a>) {
00364         UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a1320">GetpMenuState</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00365     }
00366     <span class="comment">/*</span>
00367 <span class="comment">     * No pti should point to this pMenuState anymore</span>
00368 <span class="comment">     * If guModalMenuStateCount is zero, all pMenuState must be NULL or modeless</span>
00369 <span class="comment">     */</span>
00370 {
00371     PLIST_ENTRY pHead, pEntry;
00372     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
00373 
00374     pHead = &amp;(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>);
00375     <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
00376        ptiT = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
00377        UserAssert(ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> != pMenuState);
00378        <span class="keywordflow">if</span> (guModalMenuStateCount == 0) {
00379            UserAssert(ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>);
00380        }
00381    }
00382 }
00383 <span class="preprocessor">#endif</span>
00384 <span class="preprocessor"></span>}
00385 <span class="comment">/***************************************************************************\</span>
00386 <span class="comment">* MNCreateAnimationBitmap</span>
00387 <span class="comment">*</span>
00388 <span class="comment">\***************************************************************************/</span>
<a name="l00389"></a><a class="code" href="../../d4/d1/userk_8h.html#a1348">00389</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1348">MNCreateAnimationBitmap</a>(<a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState, UINT cx, UINT cy)
00390 {
00391     HBITMAP hbm = GreCreateCompatibleBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
00392     <span class="keywordflow">if</span> (hbm == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00393         RIPMSG0(RIP_WARNING, <span class="stringliteral">"MNSetupAnimationBitmap: Failed to create hbmAni"</span>);
00394         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00395     }
00396 
00397 <span class="preprocessor">#if DBG</span>
00398 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pMenuState-&gt;hdcAni == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00399         RIPMSG0(RIP_WARNING, <span class="stringliteral">"MNCreateAnimationBitmap: hdcAni is NULL"</span>);
00400     }
00401     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o40">hbmAni</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00402         RIPMSG0(RIP_WARNING, <span class="stringliteral">"MNCreateAnimationBitmap: hbmAni already exists"</span>);
00403     }
00404 <span class="preprocessor">#endif</span>
00405 <span class="preprocessor"></span>
00406     GreSelectBitmap(pMenuState-&gt;hdcAni, hbm);
00407     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o40">hbmAni</a> = hbm;
00408     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00409 }
00410 <span class="comment">/***************************************************************************\</span>
00411 <span class="comment">* MNDestroyAnimationBitmap</span>
00412 <span class="comment">*</span>
00413 <span class="comment">\***************************************************************************/</span>
<a name="l00414"></a><a class="code" href="../../d4/d1/userk_8h.html#a1349">00414</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1349">MNDestroyAnimationBitmap</a>(<a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState)
00415 {
00416     GreSelectBitmap(pMenuState-&gt;hdcAni, GreGetStockObject(PRIV_STOCK_BITMAP));
00417     UserVerify(GreDeleteObject(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o40">hbmAni</a>));
00418     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o40">hbmAni</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00419 }
00420 <span class="comment">/***************************************************************************\</span>
00421 <span class="comment">* MNSetupAnimationDC</span>
00422 <span class="comment">*</span>
00423 <span class="comment">* 9/20/96 GerardoB      Created</span>
00424 <span class="comment">\***************************************************************************/</span>
<a name="l00425"></a><a class="code" href="../../d4/d1/userk_8h.html#a1347">00425</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1347">MNSetupAnimationDC</a> (<a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState)
00426 {
00427     pMenuState-&gt;hdcAni = GreCreateCompatibleDC(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>);
00428     <span class="keywordflow">if</span> (pMenuState-&gt;hdcAni == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00429         RIPMSG0(RIP_WARNING, <span class="stringliteral">"MNSetupAnimationDC: Failed to create hdcAnimate"</span>);
00430         UserAssert(pMenuState != &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a146">gMenuState</a>);
00431         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00432     }
00433     GreSelectFont(pMenuState-&gt;hdcAni, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a137">ghMenuFont</a>);
00434     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00435 }
00436 <span class="comment">/***************************************************************************\</span>
00437 <span class="comment">* xxxUnlockMenuState</span>
00438 <span class="comment">*</span>
00439 <span class="comment">* 11/24/96 GerardoB      Created</span>
00440 <span class="comment">\***************************************************************************/</span>
<a name="l00441"></a><a class="code" href="../../d4/d1/userk_8h.html#a1352">00441</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1352">xxxUnlockMenuState</a> (<a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState)
00442 {
00443     UserAssert(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o25">dwLockCount</a> != 0);
00444     (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o25">dwLockCount</a>)--;
00445     <span class="keywordflow">if</span> ((pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o25">dwLockCount</a> == 0) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a>(pMenuState, pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>)) {
00446         <a class="code" href="../../d4/d1/userk_8h.html#a1344">xxxMNEndMenuState</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00447         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00448     }
00449     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00450 }
00451 <span class="comment">/***************************************************************************\</span>
00452 <span class="comment">* xxxMNAllocMenuState</span>
00453 <span class="comment">*</span>
00454 <span class="comment">* Allocates and initializes a pMenuState</span>
00455 <span class="comment">*</span>
00456 <span class="comment">* 5-21-96 GerardoB      Created</span>
00457 <span class="comment">\***************************************************************************/</span>
<a name="l00458"></a><a class="code" href="../../d4/d1/userk_8h.html#a1343">00458</a> <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> <a class="code" href="../../d4/d1/userk_8h.html#a1343">xxxMNAllocMenuState</a>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiNotify, <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenuRoot)
00459 {
00460     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAllocate;
00461     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState;
00462 
00463     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() == ptiCurrent);
00464     UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == ptiNotify-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>);
00465 
00466     <span class="comment">/*</span>
00467 <span class="comment">     * If gMenuState is already taken, allocate one.</span>
00468 <span class="comment">     */</span>
00469     fAllocate = <a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a645">PUDF_MENUSTATEINUSE</a>);
00470     <span class="keywordflow">if</span> (fAllocate) {
00471         pMenuState = (<a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a>)UserAllocPoolWithQuota(<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/structtagMENUSTATE.html">MENUSTATE</a>), TAG_MENUSTATE);
00472         <span class="keywordflow">if</span> (pMenuState == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00473             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00474         }
00475     } <span class="keywordflow">else</span> {
00476         <span class="comment">/*</span>
00477 <span class="comment">         * Use chache global which already has the animation DC setup</span>
00478 <span class="comment">         */</span>
00479         <a class="code" href="../../d4/d1/userk_8h.html#a659">SET_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a645">PUDF_MENUSTATEINUSE</a>);
00480         pMenuState = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a146">gMenuState</a>;
00481         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a146">gMenuState</a>.hdcAni != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00482         GreSetDCOwner(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a146">gMenuState</a>.hdcAni, OBJECT_OWNER_CURRENT);
00483     }
00484 
00485     <span class="comment">/*</span>
00486 <span class="comment">     * Prevent anyone from changing the foreground while this menu is active</span>
00487 <span class="comment">     */</span>
00488     <a class="code" href="../../d4/d1/userk_8h.html#a2027">IncSFWLockCount</a>();
00489     <a class="code" href="../../d4/d1/userk_8h.html#a741">DBGIncModalMenuCount</a>();
00490 
00491     <span class="comment">/*</span>
00492 <span class="comment">     * Initialize pMenuState.</span>
00493 <span class="comment">     * Animation DC stuff is already setup so don't zero init it.</span>
00494 <span class="comment">     */</span>
00495     RtlZeroMemory(pMenuState, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/structtagMENUSTATE.html">MENUSTATE</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d1/structtagMENUANIDC.html">MENUANIDC</a>));
00496     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a> = ppopupmenuRoot;
00497     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o24">ptiMenuStateOwner</a> = ptiCurrent;
00498 
00499     <span class="comment">/*</span>
00500 <span class="comment">     * Save previous state, if any. Then set new state</span>
00501 <span class="comment">     */</span>
00502     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o26">pmnsPrev</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>;
00503     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> = pMenuState;
00504 
00505     <span class="keywordflow">if</span> (ptiNotify != ptiCurrent) {
00506         UserAssert(ptiNotify-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00507         ptiNotify-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> = pMenuState;
00508     }
00509 
00510     <span class="comment">/*</span>
00511 <span class="comment">     * If the menustate was allocated, set up animation stuff.</span>
00512 <span class="comment">     * This is done here because in case of failure, MNEndMenuState</span>
00513 <span class="comment">     * will find ptiCurrent-&gt;pMenuState properly.</span>
00514 <span class="comment">     */</span>
00515     <span class="keywordflow">if</span> (fAllocate) {
00516         RtlZeroMemory((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pMenuState + <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/userk_8h.html#a866">MENUSTATE</a>) -
00517                 <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/userk_8h.html#a865">MENUANIDC</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/userk_8h.html#a865">MENUANIDC</a>));
00518         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1347">MNSetupAnimationDC</a>(pMenuState)) {
00519             <a class="code" href="../../d4/d1/userk_8h.html#a1344">xxxMNEndMenuState</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00520             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00521         }
00522     }
00523 
00524     <span class="keywordflow">return</span> pMenuState;
00525 }
00526 <span class="comment">/***************************************************************************\</span>
00527 <span class="comment">* xxxMNStartMenuState</span>
00528 <span class="comment">*</span>
00529 <span class="comment">* This function is called when the menu bar is about to be activated (the</span>
00530 <span class="comment">*  app's main menu). It makes sure that the threads involved are not in</span>
00531 <span class="comment">*  menu mode already, finds the owner/notification window, initializes</span>
00532 <span class="comment">*  pMenuState and sends the WM_ENTERMENULOOP message.</span>
00533 <span class="comment">* It successful, it returns a pointer to a pMenuState. If so, the caller</span>
00534 <span class="comment">*  must call MNEndMenuState when done.</span>
00535 <span class="comment">*</span>
00536 <span class="comment">* History:</span>
00537 <span class="comment">* 4-25-91 Mikehar       Port for 3.1 merge</span>
00538 <span class="comment">* 5-20-96 GerardoB      Renamed and changed (Old name: xxxMNGetPopup)</span>
00539 <span class="comment">\***************************************************************************/</span>
<a name="l00540"></a><a class="code" href="../../d4/d1/userk_8h.html#a1350">00540</a> <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> <a class="code" href="../../d4/d1/userk_8h.html#a1350">xxxMNStartMenuState</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, DWORD cmd, LPARAM lParam)
00541 {
00542     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu;
00543     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent, ptiNotify;
00544     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState;
00545     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00546     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00547 
00548     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00549 
00550     <span class="comment">/*</span>
00551 <span class="comment">     * Bail if the current thread is already in menu mode</span>
00552 <span class="comment">     */</span>
00553     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00554     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00555         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00556     }
00557 
00558     <span class="comment">/*</span>
00559 <span class="comment">     * If pwnd is not owned by ptiCurrent, the _PostMessage call below might</span>
00560 <span class="comment">     *  send us in a loop</span>
00561 <span class="comment">     */</span>
00562     UserAssert(ptiCurrent == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd));
00563 
00564     <span class="comment">/*</span>
00565 <span class="comment">     * If this is not a child window, use the active window on its queue</span>
00566 <span class="comment">     */</span>
00567     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)) {
00568         pwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq-&gt;spwndActive;
00569     } <span class="keywordflow">else</span> {
00570         <span class="comment">/*</span>
00571 <span class="comment">         * Search up the parents for a window with a System Menu.</span>
00572 <span class="comment">         */</span>
00573         <span class="keywordflow">while</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)) {
00574             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a639">WFSYSMENU</a>)) {
00575                 <span class="keywordflow">break</span>;
00576             }
00577             pwnd = pwnd-&gt;spwndParent;
00578         }
00579     }
00580 
00581     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00582         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00583     }
00584 
00585     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd) &amp;&amp; (pwnd-&gt;spmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00586         <span class="keywordflow">goto</span> hasmenu;
00587     }
00588 
00589     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a639">WFSYSMENU</a>)) {
00590         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00591     }
00592 
00593 hasmenu:
00594 
00595     <span class="comment">/*</span>
00596 <span class="comment">     * If the owner/notification window was created by another thread,</span>
00597 <span class="comment">     *  make sure that it's not in menu mode already</span>
00598 <span class="comment">     * This can happen if PtiCurrent() is attached to other threads, one of</span>
00599 <span class="comment">     *  which created pwnd.</span>
00600 <span class="comment">     */</span>
00601     ptiNotify = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
00602     <span class="keywordflow">if</span> (ptiNotify-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00603         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00604     }
00605 
00606     <span class="comment">/*</span>
00607 <span class="comment">     * If the notification window is owned by another thread,</span>
00608 <span class="comment">     *   then the menu loop wouldn't get any keyboard or mouse</span>
00609 <span class="comment">     *   messages because we set capture to the notification window.</span>
00610 <span class="comment">     * So we pass the WM_SYSCOMMAND to that thread and bail</span>
00611 <span class="comment">     */</span>
00612     <span class="keywordflow">if</span> (ptiNotify != ptiCurrent) {
00613         RIPMSG2(RIP_WARNING, <span class="stringliteral">"Passing WM_SYSCOMMAND SC_*MENU from thread %#p to %#p"</span>, ptiCurrent, ptiNotify);
00614         <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, WM_SYSCOMMAND, cmd, lParam);
00615         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00616     }
00617 
00618     <span class="comment">/*</span>
00619 <span class="comment">     * Allocate ppoupmenu and pMenuState</span>
00620 <span class="comment">     */</span>
00621     ppopupmenu = <a class="code" href="../../d4/d1/userk_8h.html#a1393">MNAllocPopup</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00622     <span class="keywordflow">if</span> (ppopupmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00623         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00624     }
00625 
00626     pMenuState = <a class="code" href="../../d4/d1/userk_8h.html#a1343">xxxMNAllocMenuState</a>(ptiCurrent, ptiNotify, ppopupmenu);
00627     <span class="keywordflow">if</span> (pMenuState == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00628         <a class="code" href="../../d4/d1/userk_8h.html#a1394">MNFreePopup</a>(ppopupmenu);
00629         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00630     }
00631 
00632     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00633     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o1">fHasMenuBar</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00634     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>), pwnd);
00635     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>;
00636     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>), pwnd);
00637     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a> = ppopupmenu;
00638 
00639     pwndT = pwnd;
00640     <span class="keywordflow">while</span>( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwndT) )
00641         pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00642 
00643     <span class="keywordflow">if</span> (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>)
00644         ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o22">fRtoL</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a147">MFRTL</a>) ?<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>:<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00645     <span class="keywordflow">else</span> {
00646         <span class="comment">//</span>
00647         <span class="comment">// no way to know, no menu, but there is a system menu. Thus arrow</span>
00648         <span class="comment">// keys are really not important. however lets take the next best</span>
00649         <span class="comment">// thing just to be safe</span>
00650         <span class="comment">//</span>
00651         ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o22">fRtoL</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a625">WEFRTLREADING</a>) ?<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> :<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00652     }
00653     <span class="comment">/*</span>
00654 <span class="comment">     * Notify the app we are entering menu mode.  wParam is always 0 since this</span>
00655 <span class="comment">     * procedure will only be called for menu bar menus not TrackPopupMenu</span>
00656 <span class="comment">     * menus.</span>
00657 <span class="comment">     */</span>
00658     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
00659     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_ENTERMENULOOP, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00660     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00661 
00662     <span class="keywordflow">return</span> pMenuState;
00663 }
00664 
00665 
00666 <span class="comment">/***************************************************************************\</span>
00667 <span class="comment">* xxxStartMenu</span>
00668 <span class="comment">*</span>
00669 <span class="comment">* Note that this function calls back many times so we might be forced</span>
00670 <span class="comment">*  out of menu mode at any time. We don't want to check this after</span>
00671 <span class="comment">*  each callback so we lock what we need and go on. Be careful.</span>
00672 <span class="comment">*</span>
00673 <span class="comment">* History:</span>
00674 <span class="comment">* 4-25-91 Mikehar Port for 3.1 merge</span>
00675 <span class="comment">\***************************************************************************/</span>
00676 
<a name="l00677"></a><a class="code" href="../../d4/d1/userk_8h.html#a1386">00677</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1386">xxxMNStartMenu</a>(
00678     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu,
00679     <span class="keywordtype">int</span> mn)
00680 {
00681     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndMenu;
00682     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu;
00683     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState;
00684     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndMenu;
00685     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
00686 
00687     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a1318">IsRootPopupMenu</a>(ppopupmenu));
00688 
00689     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o15">fDestroyed</a>) {
00690         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00691     }
00692 
00693     pwndMenu = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>;
00694     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndMenu, &amp;tlpwndMenu);
00695 
00696     pMenuState = <a class="code" href="../../d4/d1/userk_8h.html#a1320">GetpMenuState</a>(pwndMenu);
00697     <span class="keywordflow">if</span> (pMenuState == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00698         RIPMSG0(RIP_ERROR, <span class="stringliteral">"xxxMNStartMenu: pMenuState == NULL"</span>);
00699         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndMenu);
00700         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00701     }
00702     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o22">mnFocus</a> = mn;
00703     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o1">fMenuStarted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00704     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a> =
00705     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o7">fButtonAlwaysDown</a> = ((<a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_LBUTTON) &amp; 0x8000) != 0);
00706 
00707     <a class="code" href="../../d4/d1/userk_8h.html#a1356">xxxMNSetCapture</a>(ppopupmenu);
00708 
00709     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndMenu, WM_SETCURSOR, (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndMenu),
00710             MAKELONG(MSGF_MENU, 0));
00711 
00712     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
00713         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fSystemMenu;
00714 
00715 
00716         pMenu = <a class="code" href="../../d4/d3/mnstate_8c.html#a0">xxxGetInitMenuParam</a>(pwndMenu, &amp;fSystemMenu);
00717 
00718         <span class="keywordflow">if</span> (pMenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00719             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o1">fMenuStarted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00720             <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a6">xxxMNReleaseCapture</a>();
00721             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndMenu);
00722             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00723         }
00724 
00725         <a class="code" href="../../d4/d1/userk_8h.html#a1360">LockPopupMenu</a>(ppopupmenu, &amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, pMenu);
00726 
00727         ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> = (fSystemMenu != 0);
00728         <span class="keywordflow">if</span> (!fSystemMenu) {
00729             pMenu = <a class="code" href="../../d4/d1/userk_8h.html#a1404">xxxGetSysMenu</a>(pwndMenu, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00730             <a class="code" href="../../d4/d1/userk_8h.html#a1360">LockPopupMenu</a>(ppopupmenu, &amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>, pMenu);
00731         }
00732     }
00733 
00734     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o2">fIsSysMenu</a> = (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> != 0);
00735 
00736     <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o11">fNoNotify</a>) {
00737 
00738         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o3">fIsTrackPopup</a> &amp;&amp; ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a>) {
00739             pMenu = <a class="code" href="../../d4/d3/mnstate_8c.html#a0">xxxGetInitMenuParam</a>(pwndMenu, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00740         } <span class="keywordflow">else</span> {
00741             pMenu = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>;
00742         }
00743 
00744         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndMenu, WM_INITMENU, (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pMenu), 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00745     }
00746 
00747     <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o3">fIsTrackPopup</a>) {
00748         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a>) {
00749             <a class="code" href="../../d4/d1/userk_8h.html#a1387">MNPositionSysMenu</a>(pwndMenu, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>);
00750         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
00751             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, &amp;tlpmenu);
00752             <a class="code" href="../../d4/d1/userk_8h.html#a1382">xxxMNRecomputeBarIfNeeded</a>(pwndMenu, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>);
00753             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
00754             <a class="code" href="../../d4/d1/userk_8h.html#a1387">MNPositionSysMenu</a>(pwndMenu, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>);
00755         }
00756     }
00757 
00758     <span class="comment">/*</span>
00759 <span class="comment">     * If returning TRUE, set menu style in pMenuState</span>
00760 <span class="comment">     */</span>
00761     <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o15">fDestroyed</a>) {
00762         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, MNS_MODELESS)) {
00763             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00764         }
00765 
00766         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, MNS_DRAGDROP)) {
00767             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d7/menudd_8c.html#a0">xxxClientLoadOLE</a>())) {
00768                 pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o11">fDragAndDrop</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00769             }
00770         }
00771 
00772         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, MNS_AUTODISMISS)) {
00773             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o12">fAutoDismiss</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00774         }
00775 
00776         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, MNS_NOTIFYBYPOS)) {
00777             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o18">fNotifyByPos</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00778         }
00779 
00780     }
00781 
00782     <span class="comment">/*</span>
00783 <span class="comment">     * Bogus!  We don't always know that this is the system menu.  We</span>
00784 <span class="comment">     * will frequently pass on an OBJID_MENU even when you hit Alt+Space.</span>
00785 <span class="comment">     *</span>
00786 <span class="comment">     * Hence, MNSwitchToAlternate will send a EVENT_SYSTEM_MENUEND for the</span>
00787 <span class="comment">     * menu bar and an EVENT_SYSTEM_MENUSTART for the sysmenu when we "switch".</span>
00788 <span class="comment">     */</span>
00789     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00790         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_MENUSTART, pwndMenu,
00791                 (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> ? OBJID_SYSMENU : (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> ? OBJID_MENU : OBJID_WINDOW)),
00792                 INDEXID_CONTAINER, 0);
00793     }
00794 
00795     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndMenu);
00796 
00797     <span class="keywordflow">return</span> !ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o15">fDestroyed</a>;
00798 }
00799 
00800 <span class="comment">// --------------------------------------------------------------------------</span>
00801 <span class="comment">//</span>
00802 <span class="comment">//  GetInitMenuParam()</span>
00803 <span class="comment">//</span>
00804 <span class="comment">//  Gets the HMENU sent as the wParam of WM_INITMENU, and for menu bars, is</span>
00805 <span class="comment">//  the actual menu to be interacted with.</span>
00806 <span class="comment">//</span>
00807 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00808"></a><a class="code" href="../../d4/d3/mnstate_8c.html#a0">00808</a> <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> <a class="code" href="../../d4/d3/mnstate_8c.html#a0">xxxGetInitMenuParam</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndMenu, BOOL * lpfSystem)
00809 {
00810     <span class="comment">//</span>
00811     <span class="comment">// Find out what menu we should be sending in WM_INITMENU:</span>
00812     <span class="comment">//      If minimized/child/empty menubar, use system menu</span>
00813     <span class="comment">//</span>
00814     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndMenu);
00815 
00816     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) ||
00817         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwndMenu) ||
00818         (pwndMenu-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00819         !pwndMenu-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>)
00820     {
00821         <span class="keywordflow">if</span> (lpfSystem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00822             *lpfSystem = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00823 
00824         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d1/userk_8h.html#a1404">xxxGetSysMenu</a>(pwndMenu, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>));
00825     }
00826     <span class="keywordflow">else</span>
00827     {
00828         <span class="keywordflow">if</span> (lpfSystem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00829             *lpfSystem = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00830 
00831         <span class="keywordflow">return</span>(pwndMenu-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>);
00832     }
00833 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:52 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
