<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fekbdcom.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fekbdcom.c File Reference</h1><code>#include &lt;nt.h&gt;</code><br>
<code>#include &lt;ntrtl.h&gt;</code><br>
<code>#include &lt;nturtl.h&gt;</code><br>
<code>#include &lt;windows.h&gt;</code><br>
<code>#include &lt;kbd.h&gt;</code><br>

<p>
<a href="../../d6/d1/fekbdcom_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/fekbdcom_8c.html#a0">TRACE</a>(x)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/fekbdcom_8c.html#a1">MAXBUF_CSIZE</a>&nbsp;&nbsp;&nbsp;(256)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>__inline LPWSTR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/fekbdcom_8c.html#a2">MakeString</a> (PKEY_VALUE_FULL_INFORMATION pKey, size_t limit)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/fekbdcom_8c.html#a3">GetRealDllFileNameWorker</a> (CONST WCHAR *pwszKeyName, WCHAR *RealDllName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/fekbdcom_8c.html#a4">KbdLayerRealDllFileNT4</a> (WCHAR *RealDllName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/fekbdcom_8c.html#a5">KbdLayerRealDllFileForWBT</a> (HKL hkl, WCHAR *realDllName, PCLIENTKEYBOARDTYPE pClientKbdType, <a class="el" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> reserve)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>__inline WCHAR *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/fekbdcom_8c.html#a6">wszcpy</a> (WCHAR *target, CONST WCHAR *src)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/fekbdcom_8c.html#a7">KbdLayerRealDllFile</a> (HKL hkl, WCHAR *realDllName, PCLIENTKEYBOARDTYPE pClientKbdType, <a class="el" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> reserve)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="fekbdcom.c::MAXBUF_CSIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAXBUF_CSIZE&nbsp;&nbsp;&nbsp;(256)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00060">60</a> of file <a class="el" href="../../d6/d1/fekbdcom_8c-source.html">fekbdcom.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00118">GetRealDllFileNameWorker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="fekbdcom.c::TRACE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TRACE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">x&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00054">54</a> of file <a class="el" href="../../d6/d1/fekbdcom_8c-source.html">fekbdcom.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="fekbdcom.c::GetRealDllFileNameWorker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL GetRealDllFileNameWorker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">CONST WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pwszKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>RealDllName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00118">118</a> of file <a class="el" href="../../d6/d1/fekbdcom_8c-source.html">fekbdcom.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00068">MakeString()</a>, <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00060">MAXBUF_CSIZE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d8/d4/ntuser_2client_2nt6_2debug_8h-source.html#l00014">TRACE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00364">KbdLayerRealDllFile()</a>, and <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00187">KbdLayerRealDllFileNT4()</a>.
<p>
<pre class="fragment"><div>00119 {
00120     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00121     HANDLE              handleService;
00122     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00123     UNICODE_STRING      servicePath;
00124     OBJECT_ATTRIBUTES   servicePathObjectAttributes;
00125     WCHAR               serviceRegistryPath[<a class="code" href="../../d5/d2/fekbdcom_8c.html#a1">MAXBUF_CSIZE</a>];
00126 
00127     servicePath.Buffer = serviceRegistryPath;
00128     servicePath.Length = 0;
00129     servicePath.MaximumLength = <span class="keyword">sizeof</span> serviceRegistryPath; <span class="comment">// byte count !</span>
00130 
00131     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;servicePath,
00132                              L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\i8042prt\\Parameters"</span>);
00133 
00134     InitializeObjectAttributes(&amp;servicePathObjectAttributes,
00135                                &amp;servicePath,
00136                                OBJ_CASE_INSENSITIVE,
00137                                NULL,
00138                                NULL);
00139 
00140     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"Open -&gt; '%ws'\n"</span>,servicePath.Buffer));
00141 
00142     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;handleService, KEY_READ, &amp;servicePathObjectAttributes);
00143 
00144     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00145 
00146         UNICODE_STRING layerName;
00147         WCHAR LayerDllName[<a class="code" href="../../d5/d2/fekbdcom_8c.html#a1">MAXBUF_CSIZE</a>];
00148         ULONG cbStringSize;
00149 
00150         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;layerName, pwszKeyName);
00151         <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"Entry name -&gt; '%ws'\n"</span>, layerName.Buffer));
00152 
00153         <span class="comment">/*</span>
00154 <span class="comment">         * Get the name of the DLL based on the device name.</span>
00155 <span class="comment">         */</span>
00156         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(handleService,
00157                                  &amp;layerName,
00158                                  KeyValueFullInformation,
00159                                  LayerDllName,
00160                                  <span class="keyword">sizeof</span> LayerDllName - <span class="keyword">sizeof</span>(WCHAR),    <span class="comment">// reserves room for L'\0'</span>
00161                                  &amp;cbStringSize);
00162 
00163         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00164             LPWSTR pwszStr = <a class="code" href="../../d5/d2/fekbdcom_8c.html#a2">MakeString</a>((PKEY_VALUE_FULL_INFORMATION)LayerDllName,
00165                                         <span class="keyword">sizeof</span> LayerDllName);
00166 
00167             wcscpy(RealDllName, pwszStr);
00168 
00169             <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"Real Dll name -&gt; '%ws'\n"</span>, RealDllName));
00170 
00171             <span class="comment">//</span>
00172             <span class="comment">// everything went fine.</span>
00173             <span class="comment">//</span>
00174             fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00175         }
00176         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handleService);
00177     }
00178 
00179     <span class="keywordflow">return</span> fRet;
00180 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="fekbdcom.c::KbdLayerRealDllFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL KbdLayerRealDllFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hkl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>realDllName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PCLIENTKEYBOARDTYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>pClientKbdType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>reserve</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00364">364</a> of file <a class="el" href="../../d6/d1/fekbdcom_8c-source.html">fekbdcom.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00118">GetRealDllFileNameWorker()</a>, <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00199">KbdLayerRealDllFileForWBT()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d4/ntuser_2client_2nt6_2debug_8h-source.html#l00014">TRACE</a>, and <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00350">wszcpy()</a>.
<p>
<pre class="fragment"><div>00365 {
00366     WCHAR pwszBuff[32];
00367     WCHAR* pwszTail;
00368     LPCWSTR pwsz;
00369 
00370     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PRIMARYLANGID(LOWORD(hkl)) == LANG_JAPANESE ||
00371            PRIMARYLANGID(LOWORD(hkl)) == LANG_KOREAN);
00372 
00373     <span class="keywordflow">if</span> (pClientKbdType != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00374         <span class="comment">//</span>
00375         <span class="comment">// HYDRA case</span>
00376         <span class="comment">//</span>
00377         <span class="keywordflow">return</span> <a class="code" href="../../d5/d2/fekbdcom_8c.html#a5">KbdLayerRealDllFileForWBT</a>(hkl, realDllName, pClientKbdType, reserve);
00378     }
00379 
00380     <span class="keywordflow">if</span> (PRIMARYLANGID(LOWORD(hkl)) == LANG_JAPANESE) {
00381         pwsz = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">" JPN"</span>;
00382     }
00383     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PRIMARYLANGID(LOWORD(hkl)) == LANG_KOREAN) {
00384         pwsz = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">" KOR"</span>;
00385     }
00386     <span class="keywordflow">else</span> {
00387         pwsz = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
00388     }
00389 
00390     pwszTail = <a class="code" href="../../d5/d2/fekbdcom_8c.html#a6">wszcpy</a>(pwszBuff, L<span class="stringliteral">"LayerDriver"</span>);
00391     <span class="keywordflow">if</span> (*pwsz) {
00392         <a class="code" href="../../d5/d2/fekbdcom_8c.html#a6">wszcpy</a>(pwszTail, pwsz);
00393     }
00394 
00395     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"KbdLayerRealDllFileEx: fetching '%S'\n"</span>, pwszBuff));
00396 
00397     <span class="keywordflow">return</span> <a class="code" href="../../d5/d2/fekbdcom_8c.html#a3">GetRealDllFileNameWorker</a>(pwszBuff, realDllName);
00398 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="fekbdcom.c::KbdLayerRealDllFileForWBT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL KbdLayerRealDllFileForWBT           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hkl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>realDllName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PCLIENTKEYBOARDTYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>pClientKbdType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>reserve</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00199">199</a> of file <a class="el" href="../../d6/d1/fekbdcom_8c-source.html">fekbdcom.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01763">RtlCopyUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d0/d3/cnvint_8c-source.html#l00040">RtlIntegerToChar()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00364">KbdLayerRealDllFile()</a>.
<p>
<pre class="fragment"><div>00200 {
00201     HANDLE hkRegistry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00202     UNICODE_STRING    deviceMapPath;
00203     OBJECT_ATTRIBUTES deviceMapObjectAttributes;
00204     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00205     HANDLE            handleMap;
00206     HANDLE            handleService;
00207     ULONG             cbStringSize;
00208     PWCHAR            pwszReg;
00209 
00210     UNREFERENCED_PARAMETER(reserve);
00211 
00212     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pClientKbdType != NULL);
00213     <span class="comment">/*</span>
00214 <span class="comment">     * Set default keyboard layout for error cases.</span>
00215 <span class="comment">     */</span>
00216     <span class="keywordflow">if</span> (PRIMARYLANGID(LOWORD(hkl)) == LANG_JAPANESE) {
00217         wcscpy(realDllName, L<span class="stringliteral">"kbd101.dll"</span>);
00218         pwszReg = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Terminal Server\\KeyboardType Mapping\\JPN"</span>;
00219     }
00220     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PRIMARYLANGID(LOWORD(hkl)) == LANG_KOREAN) {
00221         wcscpy(realDllName, L<span class="stringliteral">"kbd101a.dll"</span>);
00222         pwszReg = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Terminal Server\\KeyboardType Mapping\\KOR"</span>;
00223     }
00224     <span class="keywordflow">else</span> {
00225         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00226     }
00227 
00228 
00229     <span class="comment">/*</span>
00230 <span class="comment">     * Start by opening the registry for keyboard type mapping table.</span>
00231 <span class="comment">     */</span>
00232     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;deviceMapPath, pwszReg);
00233 
00234     InitializeObjectAttributes(&amp;deviceMapObjectAttributes,
00235                                &amp;deviceMapPath,
00236                                OBJ_CASE_INSENSITIVE,
00237                                NULL,
00238                                NULL);
00239 
00240     <span class="comment">// DbgPrint("Open -&gt; %ws\n",deviceMapPath.Buffer);</span>
00241 
00242     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;handleMap, KEY_READ, &amp;deviceMapObjectAttributes);
00243 
00244     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00245         WCHAR SubKbdBuffer[16];
00246         WCHAR FuncKeyBuffer[16];
00247         WCHAR SubKbdAndFuncKeyBuffer[32];
00248         UNICODE_STRING SubKbd = {
00249             0, <span class="keyword">sizeof</span> SubKbdBuffer, SubKbdBuffer,
00250         };
00251         UNICODE_STRING FuncKbd = {
00252             0, <span class="keyword">sizeof</span> FuncKeyBuffer, FuncKeyBuffer,
00253         };
00254         UNICODE_STRING SubKbdAndFuncKey = {
00255             0, <span class="keyword">sizeof</span> SubKbdAndFuncKeyBuffer, SubKbdAndFuncKeyBuffer,
00256         };
00257         UCHAR AnsiBuffer[16];
00258         ANSI_STRING AnsiString;
00259         WCHAR LayerDriverName[256];
00260 
00261         <span class="comment">/*</span>
00262 <span class="comment">         * Convert the sub keyboard type to the Ansi string buffer.</span>
00263 <span class="comment">         */</span>
00264         RtlZeroMemory(AnsiBuffer, <span class="keyword">sizeof</span>(AnsiBuffer));
00265         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/cnvint_8c.html#a2">RtlIntegerToChar</a>(pClientKbdType-&gt;SubType, 16L,
00266                                   -8, <span class="comment">// length of buffer, but negative means 0 padding</span>
00267                                   AnsiBuffer);
00268         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00269             <span class="comment">/*</span>
00270 <span class="comment">             * Convert the Ansi string buffer to Unicode string buffer.</span>
00271 <span class="comment">             */</span>
00272             AnsiString.Buffer = AnsiBuffer;
00273             AnsiString.MaximumLength = <span class="keyword">sizeof</span> AnsiBuffer;
00274             AnsiString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(AnsiBuffer);
00275             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;SubKbd, &amp;AnsiString, FALSE);
00276         }
00277         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));     <span class="comment">// Make sure the number is not bad</span>
00278 
00279         <span class="comment">/*</span>
00280 <span class="comment">         * Convert the number of function key to the Ansi string buffer.</span>
00281 <span class="comment">         */</span>
00282         RtlZeroMemory(AnsiBuffer, <span class="keyword">sizeof</span>(AnsiBuffer));
00283         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/cnvint_8c.html#a2">RtlIntegerToChar</a>(pClientKbdType-&gt;FunctionKey, 10L,
00284                                   -4, <span class="comment">// length of buffer, but negative means 0 padding</span>
00285                                   AnsiBuffer);
00286         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00287             <span class="comment">/*</span>
00288 <span class="comment">             * Convert the Ansi string buffer to Unicode string buffer.</span>
00289 <span class="comment">             */</span>
00290             AnsiString.Buffer = AnsiBuffer;
00291             AnsiString.MaximumLength = <span class="keyword">sizeof</span> AnsiBuffer;
00292             AnsiString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(AnsiBuffer);
00293             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;FuncKbd, &amp;AnsiString, FALSE);
00294         }
00295         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));  <span class="comment">// Make sure the number is not bad</span>
00296 
00297 
00298         <span class="comment">/*</span>
00299 <span class="comment">         * Get the sub kbd + function key layout name</span>
00300 <span class="comment">         */</span>
00301         <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;SubKbdAndFuncKey, &amp;SubKbd);
00302         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;SubKbdAndFuncKey, &amp;FuncKbd);
00303         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(handleMap,
00304                                  &amp;SubKbdAndFuncKey,
00305                                  KeyValueFullInformation,
00306                                  LayerDriverName,
00307                                  <span class="keyword">sizeof</span>(LayerDriverName),
00308                                  &amp;cbStringSize);
00309 
00310         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00311 
00312             LayerDriverName[cbStringSize / <span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00313 
00314             wcscpy(realDllName,
00315                    (LPWSTR)((PUCHAR)LayerDriverName +
00316                             ((PKEY_VALUE_FULL_INFORMATION)LayerDriverName)-&gt;DataOffset));
00317 
00318             <span class="comment">// DbgPrint("Real driver name -&gt; %ws\n",realDllName);</span>
00319         }
00320         <span class="keywordflow">else</span> {
00321             <span class="comment">/*</span>
00322 <span class="comment">             * Get the sub kbd layout name</span>
00323 <span class="comment">             */</span>
00324             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(handleMap,
00325                                      &amp;SubKbd,
00326                                      KeyValueFullInformation,
00327                                      LayerDriverName,
00328                                      <span class="keyword">sizeof</span>(LayerDriverName),
00329                                      &amp;cbStringSize);
00330 
00331             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00332 
00333                 LayerDriverName[cbStringSize / <span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00334 
00335                 wcscpy(realDllName,
00336                        (LPWSTR)((PUCHAR)LayerDriverName +
00337                                 ((PKEY_VALUE_FULL_INFORMATION)LayerDriverName)-&gt;DataOffset));
00338 
00339                 <span class="comment">// DbgPrint("Real driver name -&gt; %ws\n",realDllName);</span>
00340             }
00341         }
00342 
00343         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handleMap);
00344     }
00345 
00346     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00347 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="fekbdcom.c::KbdLayerRealDllFileNT4" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL KbdLayerRealDllFileNT4           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">WCHAR *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>RealDllName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00187">187</a> of file <a class="el" href="../../d6/d1/fekbdcom_8c-source.html">fekbdcom.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00118">GetRealDllFileNameWorker()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, and <a class="el" href="../../d8/d4/ntuser_2client_2nt6_2debug_8h-source.html#l00014">TRACE</a>.
<p>
<pre class="fragment"><div>00188 {
00189     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"KbdLayerRealDllFile():\n"</span>));
00190     <span class="keywordflow">return</span> <a class="code" href="../../d5/d2/fekbdcom_8c.html#a3">GetRealDllFileNameWorker</a>(L<span class="stringliteral">"LayerDriver"</span>, RealDllName);
00191 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="fekbdcom.c::MakeString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> __inline LPWSTR MakeString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PKEY_VALUE_FULL_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>pKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>size_t&nbsp;</td>
          <td class="mdname" nowrap> <em>limit</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00068">68</a> of file <a class="el" href="../../d6/d1/fekbdcom_8c-source.html">fekbdcom.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, and <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00118">GetRealDllFileNameWorker()</a>.
<p>
<pre class="fragment"><div>00069 {
00070     LPWSTR pwszHead = (LPWSTR)((LPBYTE)pKey + pKey-&gt;DataOffset);
00071     LPWSTR pwszTail = (LPWSTR)((LPBYTE)pwszHead + pKey-&gt;DataLength);
00072 
00073     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((LPBYTE)pwszTail - (LPBYTE)pKey &lt; (<span class="keywordtype">int</span>)limit );
00074     *pwszTail = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00075 
00076     UNREFERENCED_PARAMETER(limit);  <span class="comment">// just in case</span>
00077 
00078     <span class="keywordflow">return</span> pwszHead;
00079 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="fekbdcom.c::wszcpy" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> __inline WCHAR* wszcpy           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>target</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>CONST WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>src</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00350">350</a> of file <a class="el" href="../../d6/d1/fekbdcom_8c-source.html">fekbdcom.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00364">KbdLayerRealDllFile()</a>.
<p>
<pre class="fragment"><div>00351 {
00352     <span class="keywordflow">while</span> (*target++ = *src++);
00353     <span class="keywordflow">return</span> target - 1;
00354 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
